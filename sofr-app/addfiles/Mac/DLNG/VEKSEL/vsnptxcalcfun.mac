/*
$Name:        vsnptxcalcfun.mac
$Module:      Векселя банка
$Description: Создание объектов НДР 
Simanov => Добавил пользовательские виды операции
*/
/* */
import "nptxcalcfun.mac", nptxcalcfun, PTInter, "nutxfun.mac", "dlutils.mac", "vsconv.mac", "vsnptxspec.mac", "vs4each.mac";

const OBJ_FIZ_KND = 1,
      OBJ_JUR_KND = 2;

macro FilterMakeNDRObj(client)
  var party = TBFile("party.dbt");
  var partyRec;
  if (ValType(client)==V_INTEGER)
    party.rec.partyid = client;
    if (party.GetEQ())
      partyRec = party.rec;
    end;
  elif(ValType(client) == V_GENOBJ)
    partyRec = client.rec;
    else
    partyRec = client;
    end;
    
  if (partyRec)
    if (partyRec.legalform == PTLEGF_PERSN)
      return OBJ_FIZ_KND;
    elif ((partyRec.legalform == PTLEGF_INST) and (partyRec.NotResident == SET_CHAR))
      return OBJ_JUR_KND;
    end;
  end;
  return 0;
end;

macro NotCreateAlien(client, CurKind)
  var objKind = FilterMakeNDRObj(client);
  return objKind != CurKind;
end;

macro IsNoNDLFOpr(CONTRACTID)
  var note = ReadNoteForObject(OBJTYPE_VSREPAY, L_Z(CONTRACTID, 10), 1);
  return note == SET_CHAR;
end;

private macro ПолучитьВидАналитики1_ПоДоговору(order)
  
  var documentId, docKind;

  var taxObj = 0;

  if(ValType(order) == V_GENOBJ)
    docKind = order.rec.docKind;
  else
    docKind = order.docKind;
  end;
                   
  VS_MakeDocumentID(order, documentId, docKind);

  var opr = TBfile("oprkoper");

  var oprOper = TBFile("oproper.dbt", "R", 1);
  oprOper.rec.DocKind = docKind;
  oprOper.rec.DocumentId = documentId; //Получаем операцию а затем её вид

  if (oprOper.GetEQ())
    opr.rec.Kind_Operation = oprOper.rec.Kind_Operation;
    if (opr.GetEQ())
      if (docKind == DL_VEKSELDRAWORDER)
        if ((StrBrk(opr.rec.SysTypes, "С") > 0) and (StrBrk(opr.rec.SysTypes, "В") > 0)) //выкуп собственных
          taxObj = TXOBJ_KIND1115;
        elif ((opr.rec.SysTypes == "С") or (opr.rec.SysTypes == "Ф") or (opr.rec.SysTypes == "Ч")) //прочие погашения
          taxObj = TXOBJ_KIND1130;
        end;
      elif (docKind == DL_VSINTERCHANGE)
        taxObj = TXOBJ_KIND1125;
      elif (docKind == DL_VSBARTERORDER)
        taxObj = TXOBJ_KIND1120;
      end;
    end;
  end;

  return taxObj;
end;

private macro ПолучитьВидАналитики1_ПоВидуОперации(KindOpr:integer)
//Simanov=>
  if   ( (KindOpr == 4918) or (KindOpr == 14918) )//выкуп
    return TXOBJ_KIND1115;
  elif ( (KindOpr == 4904) or (KindOpr == 4930) or (KindOpr == 4933) or (KindOpr == 14904) or (KindOpr == 14933) )//погашение
    return TXOBJ_KIND1130;
  elif ( (KindOpr == 4907) or (KindOpr == 14907))//мена
    return TXOBJ_KIND1120;
  elif ( KindOpr == 4915)//зачет взаимных требований
    return TXOBJ_KIND1125;
  elif ( KindOpr == 0   )//не ясно
    return 0;
  end;
//Simanov<=  
end;

PRIVATE MACRO InsertTaxObjectTmp(Date, 
                                 Client,
                                 Direction,
                                 Level, 
                                 User,
                                 Kind,
                                 Sum,
                                 Cur,
                                 AnaliticKind1,
                                 Analitic1,
                                 AnaliticKind2,
                                 Analitic2,
                                 AnaliticKind3,
                                 Analitic3,
                                 AnaliticKind4,
                                 Analitic4,
                                 AnaliticKind5,
                                 Analitic5,
                                 AnaliticKind6,
                                 Analitic6,
                                 Comment,
                                 DocID,
                                 Step
                                )
                     
  var objKind = FilterMakeNDRObj(Client);
  var method = "DL_NPTX_InsertTaxObject";
  var stat = 0;

  if (objKind == 0)
    return 0;
  end;
   
  if (objKind == OBJ_FIZ_KND)
   stat = DL_NPTX_InsertTaxObject(   Date         
                           , Client       
                           , Direction    
                           , Level        
                           , UNSET_CHAR
                           , Kind         
                           , Sum          
                           , Cur          
                           , AnaliticKind1
                           , Analitic1    
                           , AnaliticKind2
                           , Analitic2    
                           , AnaliticKind3
                           , Analitic3    
                           , AnaliticKind4
                           , Analitic4    
                           , AnaliticKind5
                           , Analitic5    
                           , AnaliticKind6
                           , Analitic6    
                           , Comment      
                           , DocID        
                           , Step    
                           , 1         // Признак вызова не из операции расчета НОБ
                           , false );  // НЕ откат
   
  elif (objKind == OBJ_JUR_KND)
      stat = DL_NUTX_InsertTaxObjectOnStep( Date
                                            ,Client
                                            ,GetFactReceiverForNUTX(Client)
                                            ,Direction
                                            ,Level
                                            ,UNSET_CHAR
                                            ,Kind
                                            ,Sum
                                            ,Cur
                                            ,AnaliticKind1
                                            ,Analitic1    
                                            ,AnaliticKind2
                                            ,Analitic2    
                                            ,AnaliticKind3
                                            ,Analitic3    
                                            ,AnaliticKind4
                                            ,Analitic4    
                                            ,AnaliticKind5
                                            ,Analitic5    
                                            ,AnaliticKind6
                                            ,Analitic6    
                                            ,"" );
  end;

  return stat;
END;

macro СоздатьНДР_PaidBill(Date, pt_cntr, СуммаНалога, order, VS_CurrIDOperation, VS_CurrIDStep, Cur  )

  if ((NotCreateAlien(pt_cntr, OBJ_FIZ_KND)) or (IsUseNewNOB(Date)))
    return 0;
  end;

  var otype = ValType(order), pContract, stat, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);

  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                           ,pt_cntr.rec.PartyID   // Клиент
                           ,TXOBJ_DIR_OUT         // Направление
                           ,TXOBJ_LEVEL8          // Уровень
                           ,UNSET_CHAR            // Признак "Пользовательский"
                           ,TXOBJ_PAIDBILL        // Вид НДР
                           ,СуммаНалога           // Сумма дохода/расхода
                           ,Cur                   // Валюта дохода/расхода
                           ,AnaliticKind1         // Вид аналитики 1
                           ,Contract              // Аналитика 1
                           ,0                     // Вид аналитики 2
                           ,-1                    // Аналитика 2
                           ,0                     // Вид аналитики 3
                           ,-1                    // Аналитика 3
                           ,0                     // Вид аналитики 4
                           ,-1                    // Аналитика 4
                           ,0                     // Вид аналитики 5
                           ,-1                    // Аналитика 5
                           ,0                     // Вид аналитики 6
                           ,-1                    // Аналитика 6
                           ," "                   // Комментарий
                           ,VS_CurrIDOperation    // ID операции
                           ,VS_CurrIDStep         // ID шага операции
                           ,1 );                  // Признак вызова не из операции расчета НОБ
                           //,true //UseOPRDOCS_ForBackout
  return stat;                                   
end;

macro СоздатьНДР_ProcBill(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep, leg, bnr )

  if (NotCreateAlien(pt_cntr, OBJ_FIZ_KND))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1, FIID;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  if( ValType(bnr) == V_GENOBJ)
    FIID  = bnr.rec.FIID;
  else
    FIID  = bnr.FIID;
  end;
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
  
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL1          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_PROCBILL        // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1 - операция погашения
                            ,Contract              // Аналитика 1     - ID этой операции
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,TXOBJ_KIND3010        // Вид аналитики 3 - ЦБ
                            ,FIID                  // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4 - категория ФИ(хм.. что это)
                            ,NPTX_FI_NOCIRCULATE   // Аналитика 4     - необращающаяся (ну логично... вексель же погасили)
                            ,TXOBJ_KIND5010        // Вид аналитики 5 - налоговая группа
                            ,TXGROUP_60            // Аналитика 5     - вексель
                            ,0                     // Вид аналитики 6 - договор обслуживания (совпадает с номером поручения)???
                            ,-1                    // Аналитика 6     - 
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;
/**/
macro СоздатьНДР_PlusG_2800(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if (NotCreateAlien(pt_cntr, OBJ_FIZ_KND))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL5          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_PLUSG_2800      // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1
                            ,Contract              // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0                     // Вид аналитики 3
                            ,-1                    // Аналитика 3
                            ,0                     // Вид аналитики 4
                            ,-1                    // Аналитика 4
                            ,0                     // Вид аналитики 5
                            ,-1                    // Аналитика 5
                            ,0                     // Вид аналитики 6
                            ,-1                    // Аналитика 6
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

macro СоздатьНДР_BaseBill(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if (NotCreateAlien(pt_cntr, OBJ_FIZ_KND))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
    
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL7          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_BASEBILL        // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1
                            ,Contract              // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0                     // Вид аналитики 3
                            ,-1                    // Аналитика 3
                            ,0                     // Вид аналитики 4
                            ,-1                    // Аналитика 4
                            ,0                     // Вид аналитики 5
                            ,-1                    // Аналитика 5
                            ,0                     // Вид аналитики 6
                            ,-1                    // Аналитика 6
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

macro CreateНДР_ProcBill(bnr, leg, emi, order, numOrd, lnk, params)
  var pt_cntr  = TRecHandler ("party");
  ПолучитьСубъекта(order.Contractor, pt_cntr);
  if (NotCreateAlien(pt_cntr, OBJ_FIZ_KND))
    return 0;
  end;
  var taxBase = VS_Convert(lnk.rec.TaxBaseAmount, lnk.rec.InterestChargeDate, lnk.rec.BCCFI, NATCUR);
  params[0] = params[0] + taxBase;
  return СоздатьНДР_ProcBill(params[1], pt_cntr, taxBase, order, params[2] , params[3] , leg, bnr );
end;


macro СоздатьНДР_DueTax(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep, Cur )

  if (NotCreateAlien(pt_cntr, OBJ_JUR_KND))
    return 0;
  end;

  var stat = 0, Contract, AnaliticKind1, FIID;
  if( ValType(order) == V_GENOBJ)
    Contract  = order.rec.ContractID;
  else
    Contract  = order.ContractID;
  end;
  //Генерируется общий НДР поэтому узнать какой фин.инструмент по всем векселям невозможно
  /*if( ValType(bnr) == V_GENOBJ)
    FIID  = bnr.rec.FIID;
  else
    FIID  = bnr.FIID;
  end;*/
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
  
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_OUT         // Направление
                            ,TXOBJ_LEVEL5          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,NUTXOBJ_DUETAX        // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,Cur                   // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1 - операция погашения
                            ,Contract              // Аналитика 1     - ID этой операции
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0//,TXOBJ_KIND3010        // Вид аналитики 3 - ЦБ
                            ,-1//,FIID                  // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4 - категория ФИ(хм.. что это)
                            ,NPTX_FI_NOCIRCULATE   // Аналитика 4     - необращающаяся 
                            ,TXOBJ_KIND5010        // Вид аналитики 5 - налоговая группа
                            ,NUTAXGROUP_70         // Аналитика 5     - вексель
                            ,0                     // Вид аналитики 6 - договор обслуживания 
                            ,-1                    // Аналитика 6     - 
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;
end;

macro СоздатьНДР_PaidTax(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep, Cur )

  if (NotCreateAlien(pt_cntr, OBJ_JUR_KND))
    return 0;
  end;

  var stat = 0, Contract, AnaliticKind1, FIID;
  if( ValType(order) == V_GENOBJ)
    Contract  = order.rec.ContractID;
  else
    Contract  = order.ContractID;
  end;
  //Генерируется общий НДР поэтому узнать какой фин.инструмент по всем векселям невозможно
  /*if( ValType(bnr) == V_GENOBJ)
    FIID  = bnr.rec.FIID;
  else
    FIID  = bnr.FIID;
  end;*/
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
  
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_OUT         // Направление
                            ,TXOBJ_LEVEL5          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,NUTXOBJ_PAIDTAX       // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,Cur                   // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1 - операция погашения
                            ,Contract              // Аналитика 1     - ID этой операции
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0//,TXOBJ_KIND3010        // Вид аналитики 3 - ЦБ
                            ,-1//,FIID                  // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4 - категория ФИ(хм.. что это)
                            ,NPTX_FI_NOCIRCULATE   // Аналитика 4     - необращающаяся 
                            ,TXOBJ_KIND5010        // Вид аналитики 5 - налоговая группа
                            ,NUTAXGROUP_70         // Аналитика 5     - вексель
                            ,0                     // Вид аналитики 6 - договор обслуживания 
                            ,-1                    // Аналитика 6     - 
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;
end;

macro СоздатьНДР_Plus_11(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep, Cur )

  if (NotCreateAlien(pt_cntr, OBJ_JUR_KND))
    return 0;
  end;

  var stat = 0, Contract, AnaliticKind1, FIID;
  if( ValType(order) == V_GENOBJ)
    Contract  = order.rec.ContractID;
  else
    Contract  = order.ContractID;
  end;
  //Генерируется общий НДР поэтому узнать какой фин.инструмент по всем векселям невозможно
  /*if( ValType(bnr) == V_GENOBJ)
    FIID  = bnr.rec.FIID;
  else
    FIID  = bnr.FIID;
  end;*/
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
  
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL4          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,NUTXOBJ_PLUS_11       // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,Cur                   // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1 - операция погашения
                            ,Contract              // Аналитика 1     - ID этой операции
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0//,TXOBJ_KIND3010        // Вид аналитики 3 - ЦБ
                            ,-1//,FIID                  // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4 - категория ФИ(хм.. что это)
                            ,NPTX_FI_NOCIRCULATE   // Аналитика 4     - необращающаяся 
                            ,TXOBJ_KIND5010        // Вид аналитики 5 - налоговая группа
                            ,NUTAXGROUP_70         // Аналитика 5     - вексель
                            ,0                     // Вид аналитики 6 - договор обслуживания 
                            ,-1                    // Аналитика 6     - 
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;
end;

/**/
macro СоздатьНДР_PaidGeneral_15_9(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if ((NotCreateAlien(pt_cntr, OBJ_FIZ_KND)) or (IsUseNewNOB(Date)))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                   // Дата НДР
                            ,pt_cntr.rec.PartyID    // Клиент
                            ,TXOBJ_DIR_OUT          // Направление
                            ,TXOBJ_LEVEL8           // Уровень
                            ,UNSET_CHAR             // Признак "Пользовательский"
                            ,TXOBJ_PAIDGENERAL_15_9 // Вид НДР
                            ,СуммаДоходаРасхода     // Сумма дохода/расхода
                            ,NATCUR                 // Валюта дохода/расхода
                            ,AnaliticKind1          // Вид аналитики 1
                            ,Contract               // Аналитика 1
                            ,0                      // Вид аналитики 2
                            ,-1                     // Аналитика 2
                            ,0                      // Вид аналитики 3
                            ,-1                     // Аналитика 3
                            ,0                      // Вид аналитики 4
                            ,-1                     // Аналитика 4
                            ,0                      // Вид аналитики 5
                            ,-1                     // Аналитика 5
                            ,0                      // Вид аналитики 6
                            ,-1                     // Аналитика 6
                            ," "                    // Комментарий
                            ,VS_CurrIDOperation     // ID операции
                            ,VS_CurrIDStep          // ID шага операции
                            ,1 );                   // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

macro GetKBKCodeByDateAndTaxRate(IsResident, OperDate, TaxRate)
  var query =
    " SELECT DISTINCT LIM.T_CODEKBK AS KBK "
   +"   FROM DNPTXSNOBLIMIT_DBT LIM "
   +"  WHERE     LIM.T_ISRESIDENT = :IsRes "
   +"        AND :OperDate BETWEEN lim.T_BEGDATESCALE AND lim.T_ENDDATESCALE "
   +"        AND T_TYPESNOB IN (SELECT T_TYPESNOB FROM DNPTXLINKSKINDSNOB_DBT "
   +"                           WHERE T_TAXBASETYPE = " + STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, OperDate)
   +"                            AND :OperDate2 BETWEEN T_BEGDATETYPESNOB AND T_ENDDATETYPESNOB) "
   +"        AND LIM.T_TAXRATE = :TaxRate ";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("IsRes", IIF(IsResident,SET_CHAR,UNSET_CHAR)),
                                  SQLParam("OperDate", OperDate),
                                  SQLParam("OperDate2", OperDate),
                                  SQLParam("TaxRate", TaxRate)
                               )
                         );
  if (rs.MoveNext())
    return SQL_ConvTypeInteger(rs.value("KBK"));
  end;
  //если не нашли, по умолчанию основной
  return "201";
end;

macro GetRateLimitByDateAndTaxRate(IsResident, OperDate, TaxRate)
  var query =
    " SELECT DISTINCT LIM.T_LIMITSNOB AS LIMIT "
   +"   FROM DNPTXSNOBLIMIT_DBT LIM "
   +"  WHERE     LIM.T_ISRESIDENT = :IsRes "
   +"        AND :OperDate BETWEEN lim.T_BEGDATESCALE AND lim.T_ENDDATESCALE "
   +"        AND T_TYPESNOB IN (SELECT T_TYPESNOB FROM DNPTXLINKSKINDSNOB_DBT "
   +"                           WHERE T_TAXBASETYPE = " + STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, OperDate)
   +"                            AND :OperDate2 BETWEEN T_BEGDATETYPESNOB AND T_ENDDATETYPESNOB) "
   +"        AND LIM.T_TAXRATE = :TaxRate ";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("IsRes", IIF(IsResident,SET_CHAR,UNSET_CHAR)),
                                  SQLParam("OperDate", OperDate),
                                  SQLParam("OperDate2", OperDate),
                                  SQLParam("TaxRate", TaxRate)
                               )
                         );
  if (rs.MoveNext())
    return SQL_ConvTypeSum(rs.value("LIMIT"));
  end;
  return $0;
end;

macro GetKBKCodeFromLongName(longName)
  var query =
    " select T_CODE as KBK from DLLVALUES_DBT where T_LIST = 3522 and t_name = ?";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("longName", longName)
                               )
                         );
  if (rs.MoveNext())
    return SQL_ConvTypeStr(rs.value("KBK"));
  end;
  //если не нашли, по умолчанию основной
  return "201";
end;

/**
  @brief Процедура определения налогового статуса клиента (ПОНСК)
  @param[in] ClientID - Идентификатор клиента
  @param[in] Date - На дату
  @return 1 - статус относится к резиденту
  @return 0 - статус не относится к резиденту
*/
macro IsResidentStatusPONSK(ClientID, Date)
  var cmd = DL_RSDCommand("select RSI_NPTX.STB_IsResidentStatus(?,?) RS from dual");
      cmd.AddParam(ClientID);
      cmd.AddParam(Date);
  var DataSet = cmd.execute();

  if(DataSet.moveNext())
    return DataSet.RS;
  end;
  return 0;
end; 

macro GetVSTotalTax(ClientID, TaxPeriod, TaxBase, TotalSnob, Rate, KBK, CalcDate, TaxCalc:@money, TaxHold:@money)
  TaxCalc = $0;
  TaxHold = $0;
  var conn = CreateSeparateRsdConnection();
  var SpecialTag = GetSpecialTagByOper(NULL, STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, CalcDate), DL_VEKSELDRAWORDER);
  var cmd = RSDCommand(conn, "CALL RSI_NPTX.CalcHoldTaxByRanges(?,?,?,?,?,?,?)");
  cmd.addParam( "", RSDBP_IN, ClientID );
  cmd.addParam( "", RSDBP_IN, TaxPeriod );
  cmd.addParam( "", RSDBP_IN, STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, CalcDate) );
  cmd.addParam( "", RSDBP_IN, TaxBase );
  cmd.addParam( "", RSDBP_IN, TotalSnob );
  cmd.addParam( "", RSDBP_IN, CalcDate );
  cmd.addParam( "", RSDBP_IN, SpecialTag );
  cmd.execute();

  var query = " select T_TAXCALC, T_TAXHOLD from dnptxtaxbaseranges_tmp where t_taxrate = :rate and t_kbk = :kbk";
  var rs = execSQLselectSepCon(query, 
                               conn,
                               makeArray(
                                 SQLParam("rate", Rate),
                                 SQLParam("kbk", KBK)
                               ), true );
  if (rs.moveNext())
    TaxCalc = SQL_ConvTypeSum(rs.value("T_TAXCALC"));
    TaxHold = SQL_ConvTypeSum(rs.value("T_TAXHOLD"));
  end;
end;

macro GetNextRateByDateAndTaxRate(IsResident, OperDate, TaxRate)
  var query =
    " SELECT NVL(MIN(LIM.T_TAXRATE),0) AS NEXTRATE "
   +"   FROM DNPTXSNOBLIMIT_DBT LIM "
   +"  WHERE     LIM.T_ISRESIDENT = :IsRes "
   +"        AND :OperDate BETWEEN lim.T_BEGDATESCALE AND lim.T_ENDDATESCALE "
   +"        AND T_TYPESNOB IN (SELECT T_TYPESNOB FROM DNPTXLINKSKINDSNOB_DBT "
   +"                           WHERE T_TAXBASETYPE = " + STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, OperDate)
   +"                            AND :OperDate2 BETWEEN T_BEGDATETYPESNOB AND T_ENDDATETYPESNOB) "
   +"        AND LIM.T_TAXRATE > :TaxRate ";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("IsRes", IIF(IsResident,SET_CHAR,UNSET_CHAR)),
                                  SQLParam("OperDate", OperDate),
                                  SQLParam("OperDate2", OperDate),
                                  SQLParam("TaxRate", TaxRate)
                               )
                         );
  if (rs.MoveNext())
    return SQL_ConvTypeInteger(rs.value("NEXTRATE"));
  end;
  return $0;
end;

macro GetKBKListForVekselByRate(IsResident, OperDate, Rate)
  var retList = Tarray();
  var taxBaseKind = STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, OperDate);
  var specTag = GetSpecialTagByOper(NULL, taxBaseKind, DL_VEKSELDRAWORDER);
  var query =
    " SELECT llv.T_NAME AS T_KBK, LIM.T_TAXRATE"
   +"   FROM DNPTXSNOBLIMIT_DBT LIM, dllvalues_dbt llv, "
   +"        DNPTXPRIORITYNDFL_DBT ord "
   +"  WHERE     llv.T_LIST = 3522 AND llv.T_ELEMENT = TO_CHAR(LIM.T_CODEKBK) "
   +"        AND ord.T_RATE = LIM.T_TAXRATE "
   +"        AND ord.T_TYPENOB = ? "
   +"        AND ord.T_KBK = TO_CHAR(LIM.T_CODEKBK) "
   +"        AND ord.T_SPECIALTAG = " + GetSQLChar(specTag)
   +"        AND LIM.T_TAXRATE = ? "
   +"        AND LIM.T_ISRESIDENT = ? "
   +"        AND ? BETWEEN lim.T_BEGDATESCALE AND lim.T_ENDDATESCALE "
   +"        AND T_TYPESNOB IN (SELECT T_TYPESNOB FROM DNPTXLINKSKINDSNOB_DBT "
   +"                           WHERE T_TAXBASETYPE = ? "
   +"                            AND :OperDate BETWEEN T_BEGDATETYPESNOB AND T_ENDDATETYPESNOB) ";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("taxBaseKind", taxBaseKind),
                                  SQLParam("TaxRate", Rate),
                                  SQLParam("IsRes", IIF(IsResident,SET_CHAR,UNSET_CHAR)),
                                  SQLParam("opDate2", OperDate),
                                  SQLParam("taxBaseKind2", taxBaseKind),
                                  SQLParam("opDate3", OperDate)
                               )
                         );
  while (rs.MoveNext())
    retList[retList.size] = SQL_ConvTypeStr(rs.value("T_KBK"));
  end;
  return retList;
end;

macro GetIncrKBKListForVeksel(IsResident, OperDate)
  var retList = Tarray();
  var taxBaseKind = STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, OperDate);
  var specTag = GetSpecialTagByOper(NULL, taxBaseKind, DL_VEKSELDRAWORDER);
  var query =
    " SELECT llv.T_NAME AS T_KBK, LIM.T_TAXRATE"
   +"   FROM DNPTXSNOBLIMIT_DBT LIM, dllvalues_dbt llv, "
   +"        DNPTXPRIORITYNDFL_DBT ord "
   +"  WHERE     llv.T_LIST = 3522 AND llv.T_ELEMENT = TO_CHAR(LIM.T_CODEKBK) "
   +"        AND ord.T_RATE = LIM.T_TAXRATE "
   +"        AND ord.T_TYPENOB = ? "
   +"        AND ord.T_KBK = TO_CHAR(LIM.T_CODEKBK) "
   +"        AND ord.T_SPECIALTAG = " + GetSQLChar(specTag)
   +"        AND LIM.T_ISRESIDENT = ? "
   +"        AND ? BETWEEN lim.T_BEGDATESCALE AND lim.T_ENDDATESCALE "
   +"        AND T_TYPESNOB IN (SELECT T_TYPESNOB FROM DNPTXLINKSKINDSNOB_DBT "
   +"                           WHERE T_TAXBASETYPE = ? "
   +"                            AND :OperDate BETWEEN T_BEGDATETYPESNOB AND T_ENDDATETYPESNOB) "
   +"        AND LIM.T_CODEKBK <> 201 ";
  var rs = ExecSQLSelect(query,MakeArray(
                                  SQLParam("taxBaseKind", taxBaseKind),
                                  SQLParam("IsRes", IIF(IsResident,SET_CHAR,UNSET_CHAR)),
                                  SQLParam("opDate2", OperDate),
                                  SQLParam("taxBaseKind2", taxBaseKind),
                                  SQLParam("opDate3", OperDate)
                               )
                         );
  while (rs.MoveNext())
    retList[retList.size] = DL_KeyPair(SQL_ConvTypeStr(rs.value("T_KBK")), SQL_ConvTypeInteger(rs.value("T_TAXRATE")));
  end;
  return retList;
end;

macro GetKBKByDateAndTaxRate(IsResident, OperDate, TaxRate)
  var query = 
    " select llv.T_NAME " 
   +" from dllvalues_dbt llv " 
   +" where llv.T_LIST = 3522 " 
   +" and llv.T_ELEMENT = :ELEMENT ";
  var rs = execSQLselect( query, makeArray( SQLParam( "ELEMENT", GetKBKCodeByDateAndTaxRate(IsResident, OperDate, TaxRate) ) ));
  if( rs.moveNext() )
    return SQL_ConvTypeStr( rs.value("t_name") );
  end;
  return "";
end;

macro СоздатьНДР_PaidGeneral_ByRate(Date, rate, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if (NotCreateAlien(pt_cntr, OBJ_FIZ_KND) or (IsUseNewNOB(Date)))
    return 0;
  end;

  var otype = ValType(order), stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
  else
    Contract  = order.ContractID;
  end;
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                                            // Дата НДР
                            ,pt_cntr.rec.PartyID                             // Клиент
                            ,TXOBJ_DIR_OUT                                   // Направление
                            ,TXOBJ_LEVEL8                                    // Уровень
                            ,UNSET_CHAR                                      // Признак "Пользовательский"
                            ,ExecExp("TXOBJ_PAIDGENERAL_"+string(rate)+"_9") // Вид НДР
                            ,СуммаДоходаРасхода                              // Сумма дохода/расхода
                            ,NATCUR                                          // Валюта дохода/расхода
                            ,AnaliticKind1                                   // Вид аналитики 1
                            ,Contract                                        // Аналитика 1
                            ,TXOBJ_KIND2040                                  // Вид аналитики 2
                            ,GetKBKCodeByDateAndTaxRate(true, Date, rate)    // Аналитика 2
                            ,0                                               // Вид аналитики 3
                            ,-1                                              // Аналитика 3
                            ,0                                               // Вид аналитики 4
                            ,-1                                              // Аналитика 4
                            ,0                                               // Вид аналитики 5
                            ,-1                                              // Аналитика 5
                            ,0                                               // Вид аналитики 6
                            ,-1                                              // Аналитика 6
                            ," "                                             // Комментарий
                            ,VS_CurrIDOperation                              // ID операции
                            ,VS_CurrIDStep                                   // ID шага операции
                            ,1 );                                            // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

/**/
macro СоздатьНДР_PaidGeneral_15(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if ((NotCreateAlien(pt_cntr, OBJ_FIZ_KND)) or (IsUseNewNOB(Date)))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                   // Дата НДР
                            ,pt_cntr.rec.PartyID    // Клиент
                            ,TXOBJ_DIR_OUT          // Направление
                            ,TXOBJ_LEVEL8           // Уровень
                            ,UNSET_CHAR             // Признак "Пользовательский"
                            ,TXOBJ_PAIDGENERAL_15   // Вид НДР
                            ,СуммаДоходаРасхода     // Сумма дохода/расхода
                            ,NATCUR                 // Валюта дохода/расхода
                            ,AnaliticKind1          // Вид аналитики 1
                            ,Contract               // Аналитика 1
                            ,0                      // Вид аналитики 2
                            ,-1                     // Аналитика 2
                            ,0                      // Вид аналитики 3
                            ,-1                     // Аналитика 3
                            ,0                      // Вид аналитики 4
                            ,-1                     // Аналитика 4
                            ,0                      // Вид аналитики 5
                            ,-1                     // Аналитика 5
                            ,0                      // Вид аналитики 6
                            ,-1                     // Аналитика 6
                            ," "                    // Комментарий
                            ,VS_CurrIDOperation     // ID операции
                            ,VS_CurrIDStep          // ID шага операции
                            ,1 );                   // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

CLASS TaxForDraw(taxe_, taxe15_, НОБ_опер_, НОБ_30_, НОБ_13_, НОБ_15_, Year_, AmountSNOB_, NotChangeBnr_)
  var taxe = taxe_, taxe15 = taxe15_, НОБ_опер = НОБ_опер_, НОБ_30 = НОБ_30_, НОБ_13 = НОБ_13_, НОБ_15 = НОБ_15_, Year = Year_, AmountSNOB = AmountSNOB_, NotChangeBnr = NotChangeBnr_;
END;


//классы наследники DL_Equatable, т.е. все содержащие метод проверки эквивалентности с другим аналогичным объектом
class (DL_Equatable) TaxByBnr(_Rate, _Bnr, _Sum, _BCCFI)
  var Rate = _Rate;
  var Bnr = _Bnr;
  var Sum = _Sum;
  var BCCFI = _BCCFI;

  macro equals(o:variant)
    return equals(o) and (Rate == o.Rate) and (Bnr == o.Bnr);
  end;
end;

class (DL_Equatable) TaxByKbk(_Rate, _KBK, _Sum)
  var Rate = _Rate;
  var KBK = _KBK;
  var Sum = _Sum;

  macro equals(o:variant)
    return equals(o) and (Rate == o.Rate) and (KBK == o.KBK);
  end;
end;

class (DL_Equatable) TaxHoldDiffByKbk(_KBK, _Sum)
  var KBK = _KBK;
  var Sum = _Sum;

  macro equals(o:variant)
    return equals(o) and (KBK == o.KBK);
  end;
end;

CLASS TaxForDrawPRGS(НОБ_опер_, Year_, AmountSNOB_, OperDate_, IsResident_)
  var taxArrByBnr = TArray();
  var taxArrByKBK = TArray();
  var НОБ_опер = НОБ_опер_, Year = Year_, AmountSNOB = AmountSNOB_, OperDate = OperDate_, IsResident = IsResident_;
  var TaxHoldArr = TArray ();
  var taxHoldDiffArrByKbk = TArray();

  private macro GetArrByObj(Obj)
    if (IsEqClass( "TaxByBnr", Obj ))
      return taxArrByBnr;
    elif (IsEqClass( "TaxByKbk", Obj ))
      return taxArrByKBK;
    elif (IsEqClass( "TaxHoldDiffByKbk", Obj ))
      return taxHoldDiffArrByKbk;
    else
      RunError("Wrong obj");
    end;
  end;

  //ищем эквивалентный объект и суммируем по полю SUM
  //остальные функции примерно аналогичны
  macro AddTax(Obj)
    var Arr = GetArrByObj(Obj);
    var idx = DL_FindEquatableInArr(Arr, Obj);
    if (idx >= 0)
      Arr[idx].Sum = Arr[idx].Sum + Obj.Sum;
    else
      Arr[Arr.size] = Obj;
    end;
  end;

  macro SetTax(Obj)
    var Arr = GetArrByObj(Obj);
    var idx = DL_FindEquatableInArr(Arr, Obj);
    if (idx == -1)
      idx = Arr.size;
    end;
    Arr[idx] = Obj;
  end;

  macro GetTax(Obj)
    var Arr = GetArrByObj(Obj);
    var idx = DL_FindEquatableInArr(Arr, Obj);
    if (idx >= 0)
      return Arr[idx].Sum;
    end;
    return $0;
  end;

  //получить все уникальные КБК из хранилища taxArrByKBK
  macro GetKBKList()
    var retList = TArray();
    for (var cur, taxArrByKBK)
      var isFound = false;
      for (var lst, retList)
        if (lst == cur.KBK)
          isFound = true;
          break;
        end;
      end;
      if (not isFound)
        retList[retList.size] = cur.KBK;
      end;
    end;
    return retList;
  end;

  //посчитать сумму КБК по записям taxArrByKBK
  macro CalcTotalByKBK(KBK)
    var total = $0;
    for (var cur, taxArrByKBK)
      if (cur.KBK == KBK)
        total = total + cur.Sum;
      end;
    end;
    return total;
  end;

  //посчитать сумму КБК по записям STB_TaxRateParm
  macro CalcTotalByKBKFromTaxHold(KBK)
    var total = $0;
    for (var cur, TaxHoldArr)
      if (cur.КБК == KBK)
        total = total + cur.Налог;
      end;
    end;
    return total;
  end;

  //посчитать разницу по КБК межу STB_TaxRateParm и taxArrByKBK и сохранить в taxHoldDiffArrByKbk
  macro FillKBKDiff()
    for (var curKBK, GetKBKList())
      AddTax(TaxHoldDiffByKbk(curKBK, CalcTotalByKBKFromTaxHold(curKBK) - CalcTotalByKBK(curKBK) ));
    end;
  end;

  //получить разницу по КБК между STB_TaxRateParm и taxArrByKBK, декрементировать полученное значение(с лимитом суммы для отрицательной корректировки)
  macro GetAndDecrKBKDiffWithLimitSum(KBK, LimitSum)
    var objToFind = TaxHoldDiffByKbk(KBK, $0);
    var Arr = GetArrByObj(objToFind);
    var idx = DL_FindEquatableInArr(Arr, objToFind);
    if (idx < 0)
      return $0;
    else
      var sumToTake = $0;
      if (Arr[idx].Sum < $0)
        sumToTake = min(LimitSum, ABS(Arr[idx].Sum));
        Arr[idx].Sum = Arr[idx].Sum + sumToTake;
        return -sumToTake;
      elif (Arr[idx].Sum > $0)
        sumToTake = Arr[idx].Sum;
        Arr[idx].Sum = Arr[idx].Sum - sumToTake;
        return sumToTake;
      else
        return $0;
      end;
    end;
  end;

  //заполнить на векселях значения посчитанного налога включая расчёты по разнице КБК
  macro FillBnrData()
    var stat = 0;
    var i = taxArrByBnr.size - 1;
    if (i >= 0)
      FillKBKDiff();
    end;
    while ((i >= 0) and (stat == 0))
      var curTaxHold = taxArrByBnr[i].Sum;
      var kbkList = GetKBKListForVekselByRate(IsResident, OperDate, taxArrByBnr[i].Rate);
      for (var curKbk, kbkList)
        curTaxHold = curTaxHold + GetAndDecrKBKDiffWithLimitSum(curKbk, curTaxHold);
      end;
      if(curTaxHold > $0)
        var ratePostfix = "";
        if ((taxArrByBnr[i].Rate != int(100*NPTXGENTAXRATE_NOTRESIDENT)) and (taxArrByBnr[i].Rate != int(100*NPTXGENTAXRATE_RESIDENT)))
          ratePostfix = string(taxArrByBnr[i].Rate);
        end;
        if(not ИзменитьВексель(taxArrByBnr[i].Bnr, OperDate, "taxamount"+ratePostfix, VS_Convert(curTaxHold, OperDate, NATCUR, taxArrByBnr[i].BCCFI) ));
          stat = 1;
        end;
        if((not stat) and (not ИзменитьВексель(taxArrByBnr[i].Bnr, OperDate, "taxamount"+ratePostfix+"_natcur", curTaxHold)));
          stat = 1;
        end;
      end;
      i=i-1;
    end;
    return stat;
  end;
END;

PRIVATE MACRO IsPartyResident(PartyID)
  var party = TBFile("party");
  party.KeyNum = 0;
  party.rec.PartyID = PartyID;
  if (GetEQ(party))
    if (party.rec.NotResident)
      return false;
    else
      return true;
    end;
  end;
END;

PRIVATE MACRO GetNDRForVekselDRAW (Contractor, NDRKind, OnDate)
  var EndDate = OnDate;
  var Year;
  DateSplit(EndDate, NULL, NULL, Year);
  var BegDate = date(1, 1, Year);
  var Summ = $0;
  var SumQuery =  "select " +
                  "   (" +
                  "      SELECT nvl(sum(nptxobjSum.t_Sum0), 0)" +
                  "  FROM dnptxobj_dbt nptxobjSum" +
                  " WHERE     nptxobjSum.t_Kind = " + string(NDRKind) +
                  "       AND nptxobjSum.t_Client = party.t_PartyID" +
                  "       AND nptxobjSum.t_Date BETWEEN ? " +
                  "                                  AND ? " +
                  "       AND (   EXISTS" +
                  "                  (SELECT ordlnk.*" +
                  "                     FROM dvsordlnk_dbt ordlnk" +
                  "                    WHERE     ORDLNK.T_CONTRACTID = nptxobjSum.T_ANALITIC1" +
                  "                          AND ORDLNK.T_LINKKIND = 1)" +
                  "            OR (    nptxobjSum.T_ANALITIC1 = -1" +
                  "                AND EXISTS" +
                  "                       (SELECT *" +
                  "                          FROM dnptxobdc_dbt obdc, DNPTXOP_DBT op" +
                  "                         WHERE     obdc.t_ObjID = nptxobjSum.t_ObjID" +
                  "                               AND op.t_ID = obdc.t_DocID" +
                  "                               AND (   op.t_Kind_Operation = 2035" +       // расчет ноб
                  "                                    OR op.t_Kind_Operation = 2038))))" +   // удержание ндфл
                  "   ) as t_Summ " +
                  "from dparty_dbt party " +
                  "where party.t_PartyID = ?";
  var SumSelect = DL_RSDCommand(SumQuery);
  SumSelect.AddParam(BegDate);
  SumSelect.AddParam(EndDate);
  SumSelect.AddParam(Contractor);

  var SumDS = SumSelect.Execute();
  if(SumDS.MoveNext())
    Summ = SumDS.Summ;
  end;

  return Summ;
END;

PRIVATE MACRO GetTax(bnr, leg, emi, order, numOrd, lnk, Taxes:@variant)
  var  НОБ_опер = $0, НОБ_опер_ост = $0,
  НОБ_30   = $0, 
  НОБ_13   = $0, 
  НОБ_15   = $0,
  taxe     = $0, 
  taxe15   = $0;
  var СНОБ = $0, STBDate = date(0,0,0), STBTime = time(0);
  var stat = 0;
  var DocKind = 0, ContractID = 0, Contractor = 0, SignDate = date(0,0,0);
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var Year;

  if(valType(order) == V_GENOBJ)
    DocKind     = order.rec.DocKind;
    ContractID  = order.rec.ContractID;
    Contractor  = order.rec.Contractor;
    SignDate    = order.rec.SignDate;
  else
    DocKind     = order.DocKind;
    ContractID  = order.ContractID;
    Contractor  = order.Contractor;
    SignDate    = order.SignDate;
  end;

  DateSplit(SignDate, NULL, NULL, Year);
  var BegDate = date(1, 1, Year);

  if(Taxes.AmountSNOB != NULL)
    СНОБ = Taxes.AmountSNOB;
  else
    GetLastOpSTBVal(DocKind, ContractID, NPTXVAL_KIND_STB, @СНОБ, @STBDate, @STBTime);
  end;

  НОБ_опер_ост = НОБ_опер = VS_Convert(lnk.rec.TaxBaseAmount, lnk.rec.InterestChargeDate, lnk.rec.BCCFI, NATCUR);
  Taxes.НОБ_опер = Taxes.НОБ_опер + НОБ_опер;

  if(not IsPartyResident(Contractor))
    НОБ_30 = Taxes.НОБ_опер;
    Taxes.НОБ_30 = НОБ_30;
  else
    НОБ_13 = MAX(0, MIN((СНОБ + Taxes.НОБ_опер), NPTX_LIMINCOME_MAX15) - СНОБ);
    Taxes.НОБ_13 = НОБ_13;

    НОБ_15 = Taxes.НОБ_опер - НОБ_13;
    Taxes.НОБ_15 = НОБ_15;
  end;

  if(not IsPartyResident(Contractor))
    taxe   = NPTXGENTAXRATE_NOTRESIDENT * (  STB_GetSumTaxBaseCurrPay(Contractor, NPTXTOTALBASE_TAXBASEKIND_ONB, Taxes.Year, int(NPTXGENTAXRATE_NOTRESIDENT*100))
                                           + НОБ_30) - GetP(Contractor, 0, TXOBJ_PAIDBILL+","+TXOBJ_PAIDCOMP, BegDate, SignDate, AddWhereNotOut) - Taxes.taxe;
  else
    taxe   = NPTXGENTAXRATE_RESIDENT * ( STB_GetSumTaxBaseCurrPay(Contractor, NPTXTOTALBASE_TAXBASEKIND_ONB, Taxes.Year, int(NPTXGENTAXRATE_RESIDENT*100))
                                        + НОБ_13) - GetP(Contractor,0 , TXOBJ_PAIDBILL+","+TXOBJ_PAIDCOMP, BegDate, SignDate, AddWhereNotOut) - Taxes.taxe;
    taxe15 = NPTXGENTAXRATE_RESIDENT_15 * (  STB_GetSumTaxBaseCurrPay(Contractor, NPTXTOTALBASE_TAXBASEKIND_ONB, Taxes.Year, int(NPTXGENTAXRATE_RESIDENT_15*100))
                                           + НОБ_15) - GetP(Contractor, 0, TXOBJ_PAIDGENERAL_15_9+","+TXOBJ_PAIDCOMP_15, BegDate, SignDate, AddWhereNotOut) - Taxes.taxe15;
  end;

  taxe   = MAX(Round(taxe,0), $0);  
  taxe15 = MAX(Round(taxe15,0), $0);

  if(taxe >= 0)
    taxe = min(НОБ_опер_ост, taxe);
    НОБ_опер_ост = НОБ_опер_ост - taxe;
  end;
  Taxes.taxe = Taxes.taxe + taxe;

  if(taxe15 >= 0)
    taxe15 = min(НОБ_опер_ост, taxe15);
    НОБ_опер_ост = НОБ_опер_ост - taxe15;
  end;
  Taxes.taxe15 = Taxes.taxe15 + taxe15;

  if(Taxes.NotChangeBnr == false)
    if(not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount", VS_Convert(taxe, SignDate, NATCUR, lnk.rec.BCCFI) ));
      stat = 1;
    end;
    if((not stat) and (not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount_natcur", taxe)));
      stat = 1;
    end;
    if((not stat) and (not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount15", VS_Convert(taxe15, SignDate, NATCUR, lnk.rec.BCCFI) )));
      stat = 1;
    end;
    if((not stat) and (not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount15_natcur", taxe15)));
      stat = 1;
    end;
  end;

  return stat;
END;

macro СоздатьНДР_PaidBill_NewNob(Date, Contractor, СуммаНалога, order, LongKBK )
 
  var locPtCntr = TRecHandler ("party");
  if(ПолучитьСубъекта(Contractor, locPtCntr))
    return Ошибка("Не найден контрагент по договору");
  end;

  if (NotCreateAlien(locPtCntr, OBJ_FIZ_KND) or (not (IsUseNewNOB(Date))))
    return 0;
  end;

  var otype = ValType(order), pContract, stat, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);

  stat = InsertTaxObjectTmp( Date                              /// Дата НДР
                           ,Contractor                         // Клиент
                           ,TXOBJ_DIR_OUT                      // Направление
                           ,TXOBJ_LEVEL8                       // Уровень
                           ,UNSET_CHAR                         // Признак "Пользовательский"
                           ,TXOBJ_PAIDBILL                     // Вид НДР
                           ,СуммаНалога                        // Сумма дохода/расхода
                           ,NATCUR                             // Валюта дохода/расхода
                           ,AnaliticKind1                      // Вид аналитики 1
                           ,Contract                           // Аналитика 1
                           ,TXOBJ_KIND2040                     // Вид аналитики 2
                           ,GetKBKCodeFromLongName(LongKBK)    // Аналитика 2
                           ,0                                  // Вид аналитики 3
                           ,-1                                 // Аналитика 3
                           ,0                                  // Вид аналитики 4
                           ,-1                                 // Аналитика 4
                           ,0                                  // Вид аналитики 5
                           ,-1                                 // Аналитика 5
                           ,0                                  // Вид аналитики 6
                           ,-1                                 // Аналитика 6
                           ," "                                // Комментарий
                           ,VS_CurrIDOperation                 // ID операции
                           ,VS_CurrIDStep                      // ID шага операции
                           ,1 );                               // Признак вызова не из операции расчета НОБ
                           //,true //UseOPRDOCS_ForBackout
  return stat;                                   
end;

macro ClearVekselFormValues(bnr, leg, emi, order, numOrd, lnk)
  private var RatesArr = makeArray("","15","18","20","22");
  var stat = 0;
  var DocKind = 0, ContractID = 0, Contractor = 0, SignDate = date(0,0,0);
  if(valType(order) == V_GENOBJ)
    DocKind     = order.rec.DocKind;
    ContractID  = order.rec.ContractID;
    Contractor  = order.rec.Contractor;
    SignDate    = order.rec.SignDate;
  else
    DocKind     = order.DocKind;
    ContractID  = order.ContractID;
    Contractor  = order.Contractor;
    SignDate    = order.SignDate;
  end;
  for (var curRatePostfix, RatesArr)
    if(not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount"+curRatePostfix, $0 ));
      stat = 1;
    end;
    if((not stat) and (not ИзменитьВексель(bnr.rec.BCID, SignDate, "taxamount"+curRatePostfix+"_natcur", $0)));
      stat = 1;
    end;
  end;
  return stat;
end;

PRIVATE MACRO GetTaxPRGS(bnr, leg, emi, order, numOrd, lnk, Taxes:@variant)
  var  НОБ_опер = $0, НОБ_опер_ост = $0,
  НОБ_30   = $0, 
  НОБ_13   = $0, 
  НОБ_15   = $0,
  taxe     = $0, 
  taxe15   = $0;
  var СНОБ = $0, STBDate = date(0,0,0), STBTime = time(0);
  var stat = 0;
  var DocKind = 0, ContractID = 0, Contractor = 0, SignDate = date(0,0,0);
  var Year;
  var SpecialTag = "";

  if(valType(order) == V_GENOBJ)
    DocKind     = order.rec.DocKind;
    ContractID  = order.rec.ContractID;
    Contractor  = order.rec.Contractor;
    SignDate    = order.rec.SignDate;
  else
    DocKind     = order.DocKind;
    ContractID  = order.ContractID;
    Contractor  = order.Contractor;
    SignDate    = order.SignDate;
  end;

  DateSplit(SignDate, NULL, NULL, Year);

  if(Taxes.AmountSNOB != NULL)
    СНОБ = Taxes.AmountSNOB;
  else
    GetLastOpSTBVal(DocKind, ContractID, NPTXVAL_KIND_STB, @СНОБ, @STBDate, @STBTime);
  end;

  SpecialTag = GetSpecialTagByOper(NULL, STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, SignDate), DL_VEKSELDRAWORDER);

  НОБ_опер_ост = НОБ_опер = VS_Convert(lnk.rec.TaxBaseAmount, lnk.rec.InterestChargeDate, lnk.rec.BCCFI, NATCUR);
  
  CalcHoldTaxByRanges(Contractor,
                      Year,
                      STB_GetTaxBaseKindByDocKind(DL_VEKSELDRAWORDER, false, SignDate),
                      НОБ_опер,
                      СНОБ + Taxes.НОБ_опер,
                      SignDate,
                      SpecialTag
                     );

  Taxes.НОБ_опер = Taxes.НОБ_опер + НОБ_опер;

  var query = " select * from dnptxtaxbaseranges_tmp order by t_range asc ";
  var cmd = DL_RSDCommand(query);
  var DataSet = cmd.Execute();
  while(DataSet.moveNext())
    var TaxHold = money(DataSet.TaxHold);
    
    if(DataSet.TaxHold >= 0)
      TaxHold = min(НОБ_опер_ост, money(DataSet.TaxHold));

      НОБ_опер_ост = НОБ_опер_ост - TaxHold;
    end;

    var curRate = int(DataSet.TaxRate);
    var curKBK = DataSet.KBK;

    if((TaxHold > 0) or ((TaxHold <= 0) and (DataSet.BaseSum > 0)))
      Taxes.AddTax(TaxByBnr(curRate, bnr.rec.BCID, TaxHold, lnk.rec.BCCFI));
      Taxes.AddTax(TaxByKbk(curRate, curKBK, TaxHold));
    end;

    var taxCalc = money(DataSet.TaxCalc);
    if ((taxCalc != $0) and (TaxHold != $0))
      var totalTaxCalc, totalTaxHold;
      //получаем значения налога для ставки без изменения СНОБ при расчете по нескольким векселям. (в отдельном соединении)
      //Если есть отличия, значит где то расползлось среди векселей и ставок, и делаем корректировку
      GetVSTotalTax(Contractor, Year, Taxes.НОБ_опер, СНОБ, curRate, curKBK, SignDate, @totalTaxCalc, @totalTaxHold);
      var curHoldTax = Taxes.GetTax(TaxByKbk(curRate, curKBK, $0));

      if (curHoldTax != totalTaxHold)
        var diffTax = totalTaxHold - curHoldTax;
        if (diffTax != $0)
          TaxHold = TaxHold + diffTax;
          taxCalc = taxCalc + diffTax;
          Taxes.AddTax(TaxByBnr(curRate, bnr.rec.BCID, diffTax, lnk.rec.BCCFI));
          Taxes.AddTax(TaxByKbk(curRate, curKBK, diffTax));
        end;
      end;
    end;

    if((TaxHold > 0) or ((TaxHold <= 0) and (DataSet.BaseSum > 0)))
      Taxes.TaxHoldArr[Taxes.TaxHoldArr.size] = STB_TaxRateParm(int(DataSet.TaxRate),
                                                    money(DataSet.BaseSum),
                                                    TaxHold,
                                                    DataSet.KBK,
                                                    DataSet.TaxBaseType,
                                                    false,
                                                    NULL,
                                                    0,
                                                    taxCalc,
                                                    NULL,
                                                    NULL,
                                                    DataSet.SpecialTag
                                                    );
    end;
  end;

  return stat;
END;

MACRO CalcTaxSTB_Veksel(dl_order, НОБ_опер:@money, НОБ_30:@money, НОБ_13:@money, НОБ_15:@money, taxe:@money, taxe15:@money, AmountSNOB, NotChangeBnr)
  var Year = 0;

  НОБ_опер = $0; 
  НОБ_30   = $0; 
  НОБ_13   = $0; 
  НОБ_15   = $0;
  taxe     = $0; 
  taxe15   = $0;

  if(NotChangeBnr == NULL)
    NotChangeBnr = false;
  end;

  DateSplit(dl_order.SignDate, null, null, Year);
  var Taxes = TaxForDraw(taxe, taxe15, НОБ_опер, НОБ_30, НОБ_13, НОБ_15, Year, AmountSNOB, NotChangeBnr);

  ДляКаждогоВекселя(dl_order, @GetTax, VSORDLNK_K_DRAW, @Taxes, null);

  НОБ_опер = Taxes.НОБ_опер; 
  НОБ_30   = Taxes.НОБ_30;
  НОБ_13   = Taxes.НОБ_13;
  НОБ_15   = Taxes.НОБ_15;
  taxe     = Taxes.taxe;
  taxe15   = Taxes.taxe15;
END;

MACRO CalcTaxSTB_VekselPRGS_AndGetTaxHold(dl_order, AmountSNOB)
  var Year = 0;

  DateSplit(dl_order.SignDate, null, null, Year);
  var Taxes = TaxForDrawPRGS($0, Year, AmountSNOB, dl_order.SignDate, IsResidentStatusPONSK(dl_order.Contractor, dl_order.SignDate) == 1);

  ДляКаждогоВекселя(dl_order, @GetTaxPRGS, VSORDLNK_K_DRAW, @Taxes, null);

  return Taxes;
  
END;

macro CalcAndInsertNDR_VekselPRGS(dl_order)
  var Year = 0;
  var query, cmd, DataSet;
  var stat = 0;

  DateSplit(dl_order.SignDate, null, null, Year);

  cmd = DL_RSDCommand();

  query =   " select T_HOLDPITAX as t_NDR_Sum, T_BCCHOLDPITAX as t_NDR_KBK "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type in (1,3) "
          + "    and t_Symbol <> 'C' "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and T_SPECIALTAG = 'ВЕКС'";
          
  cmd.AddParam(dl_order.DocKind);
  cmd.AddParam(dl_order.ContractID);
  cmd.AddParam(dl_order.Contractor);
  
  DataSet = cmd.Execute(query);
  while (DataSet.moveNext() and (stat == 0))
    stat = СоздатьНДР_PaidBill_NewNob(dl_order.SignDate, dl_order.Contractor, money(DataSet.NDR_Sum), dl_order, DataSet.NDR_KBK);
  end;
  return stat;
end;



MACRO GetSumCorrBalInOpWithRate(DocKind:integer, DocID:integer, ClientID:integer, KBK:string, IIS:bool, ExcludeOpTaxBaseKind:bool, Rate)
  var OpTaxBaseKind;
  var query, cmd, DataSet;
  var Sum = $0;

  if(IIS == NULL)
    IIS = false;
  end;

  OpTaxBaseKind = STB_GetTaxBaseKindByDocKind(DocKind, IIS);

  cmd = DL_RSDCommand();

  query =   " select NVL(SUM(t_HoldPITax), 0) as SumCorrBal "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_TaxBaseCurrPay = 0 "
          + "    and t_CalcPITax = 0 "
          + "    and t_rateholdpitax = ?"
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type IN (2,3) "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and instr(UPPER(t_Description), UPPER('Диасофт')) = 0";

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ClientID);
  cmd.AddParam(Rate);

  if(ExcludeOpTaxBaseKind == true)
    query = query + "    and t_TaxBaseKind <> ? ";
    cmd.AddParam(OpTaxBaseKind);
  end;

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    Sum = money(DataSet.SumCorrBal);
  end;
  
  return Sum;
END;

MACRO GetSumCorrBalInOpForVS(DocKind:integer, DocID:integer, ClientID:integer, KBK:string, ExcludeOpTaxBaseKind:bool, OperDate:date)
  var OpTaxBaseKind;
  var query, cmd, DataSet;
  var Sum = $0;

  OpTaxBaseKind = STB_GetTaxBaseKindByDocKind(DocKind, false, OperDate);

  cmd = DL_RSDCommand();

  query =   " select NVL(SUM(t_HoldPITax), 0) as SumCorrBal "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_TaxBaseCurrPay = 0 "
          + "    and t_CalcPITax = 0 "
          + "    and t_BCCHoldPITax = ?"
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type IN (1,2,3) "
          + "    and t_Symbol = 'C' "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and instr(UPPER(t_Description), UPPER('Диасофт')) = 0";

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ClientID);
  cmd.AddParam(KBK);

  if(ExcludeOpTaxBaseKind == true)
    query = query + "    and t_TaxBaseKind <> ? ";
    cmd.AddParam(OpTaxBaseKind);
  end;

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    Sum = money(DataSet.SumCorrBal);
  end;
  
  return Sum;
END;

MACRO GetSumCorrBalInOpForVSAll(DocKind:integer, DocID:integer, ClientID:integer, ExcludeOpTaxBaseKind:bool, OperDate:date, SumCorrBalArr:@TArray)
  var OpTaxBaseKind;
  var query, cmd, DataSet;
  var Sum = $0;

  SumCorrBalArr.size = 0;

  OpTaxBaseKind = STB_GetTaxBaseKindByDocKind(DocKind, false, OperDate);

  cmd = DL_RSDCommand();

  query =   " select NVL(SUM(t_HoldPITax), 0) as SumCorrBal, t_BCCHoldPITax, t_RateHoldPITax "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type IN (1,2,3) "
          + "    and t_Symbol = 'C' "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and instr(UPPER(t_Description), UPPER('Диасофт')) = 0"
          + " group by t_BCCHoldPITax, t_RateHoldPITax"
          + " order by t_RateHoldPITax ASC";

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ClientID);

  if(ExcludeOpTaxBaseKind == true)
    query = query + "    and t_TaxBaseKind <> ? ";
    cmd.AddParam(OpTaxBaseKind);
  end;

  DataSet = cmd.Execute(query);
  while(DataSet.moveNext())
    var sz = SumCorrBalArr.size;

    SumCorrBalArr[sz] = STB_TaxRateParm(int(DataSet.RateHoldPITax),
                                        $0, 
                                        money(DataSet.SumCorrBal),
                                        DataSet.BCCHoldPITax
                                       );
  end;
  
  return Sum;
END;

//Рассчитать НОБ для векселей.
MACRO VSCalcNOBByClient(ClientID, OperDate, НОБ_опер:@money)
  var Oper = TRecHandler("nptxop.dbt");
  var Year = 0;
  var НОБ_тек = $0;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var TaxBaseKind;
  //векселей не бывает по ИИС, поэтому тут всегда false
  var pIIS = 0;

  НОБ_опер = $0;

  DateSplit(OperDate, null, null, Year);
  var pBeg = date(1, 1, Year);
  var pEnd = date(31, 12, Year);

  TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_BROK;

  if(IsResidentStatusPONSK(ClientID, OperDate))
    НОБ_тек = GetRubSumByClient(ClientID, string(TXOBJ_BASEG2), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    НОБ_тек = НОБ_тек + GetRubSumByClient(ClientID, string(TXOBJ_BASEG3), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
  else
    НОБ_тек =  GetRubSumByClient(ClientID, string(TXOBJ_BASEGENERAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut)
             + GetRubSumByClient(ClientID, string(TXOBJ_BASEMATERIAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
  end;

  НОБ_опер = НОБ_тек - STB_GetSumTaxBaseCurrPay(ClientID, TaxBaseKind, IIF(pIIS, NULL, Year), NULL, NULL, NULL, NULL, "");
END;

macro СоздатьНДР_BaseG2_NewNob(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if ((NotCreateAlien(pt_cntr, OBJ_FIZ_KND)) or (not (IsUseNewNOB(Date))))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
    
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL7          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_BASEG2          // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1
                            ,Contract              // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0                     // Вид аналитики 3
                            ,-1                    // Аналитика 3
                            ,0                     // Вид аналитики 4
                            ,-1                    // Аналитика 4
                            ,0                     // Вид аналитики 5
                            ,-1                    // Аналитика 5
                            ,0                     // Вид аналитики 6
                            ,-1                    // Аналитика 6
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;

macro СоздатьНДР_BaseGeneral_NewNob(Date, pt_cntr, СуммаДоходаРасхода, order, VS_CurrIDOperation, VS_CurrIDStep  )

  if ((NotCreateAlien(pt_cntr, OBJ_FIZ_KND)) or (not (IsUseNewNOB(Date))))
    return 0;
  end;

  var otype = ValType(order), pContract, stat = 0, Contract, AnaliticKind1;
  if(otype == V_GENOBJ)
    Contract  = order.rec.ContractID;
    pContract = order.rec.OrderNumber;
  else
    pContract = order.OrderNumber;
    Contract  = order.ContractID;
  end;
    
  AnaliticKind1 = ПолучитьВидАналитики1_ПоДоговору(order);
                                   
  stat = InsertTaxObjectTmp( Date                  // Дата НДР
                            ,pt_cntr.rec.PartyID   // Клиент
                            ,TXOBJ_DIR_IN          // Направление
                            ,TXOBJ_LEVEL7          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_BASEGENERAL     // Вид НДР
                            ,СуммаДоходаРасхода    // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,AnaliticKind1         // Вид аналитики 1
                            ,Contract              // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,0                     // Вид аналитики 3
                            ,-1                    // Аналитика 3
                            ,0                     // Вид аналитики 4
                            ,-1                    // Аналитика 4
                            ,0                     // Вид аналитики 5
                            ,-1                    // Аналитика 5
                            ,0                     // Вид аналитики 6
                            ,-1                    // Аналитика 6
                            ," "                   // Комментарий
                            ,VS_CurrIDOperation    // ID операции
                            ,VS_CurrIDStep         // ID шага операции
                            ,1 );                  // Признак вызова не из операции расчета НОБ     
  return stat;                                 
end;