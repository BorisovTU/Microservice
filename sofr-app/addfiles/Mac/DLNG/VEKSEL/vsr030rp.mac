/*
$Name:         vsr030rp.mac
$Module:       Собственные векселя
$Description:  Шаг "Погашение векселя" операции "Погашение векселя"
*/

IMPORT OprInter, vscateg, vsrep, vsrepay7, vsdates;


/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order, DocKind, ID_Operation, ID_Step)
var
    StepDate, stat = 0;

    record order( dl_order );
    SetBuff( order, dl_order );

    VS_CurrIDOperation = ID_Operation;
    VS_CurrIDStep      = ID_Step;
    
    if(not VS_TestStepDate(DATE_REP_DOC, @StepDate, order.SignDate))
       return 1;
    end;

    if (not DoRepayStep(order, StepDate))
       stat = 1;
    end;

    if (not stat)
        var StartSTBDate = GetStartSTBDate();
        if ((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (StepDate >= GetStartSTBDate()) and (FilterMakeNDRObj(order.Contractor) == OBJ_FIZ_KND) and (IsNoNDLFOpr(order.ContractID) == false))
            var CurrYear = 0;

            datesplit(StepDate, NULL, NULL, CurrYear);
            
            if(STB_ClientNeedRecalc(order.Contractor, CurrYear))
              if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_RECALC, VS_OPERSTATUS_VSDEALS_ENDED_RUN)) //Пересчет СНОБ = Выполнить
                  msgBox( "Ошибка при установке статуса вида \"Пересчет СНОБ\" операции" );
                  return 1;
              end;
              /*Принудительная вставка блока по символу*/
              Opr_InsertBranch("R", OPRBR_PARALLEL, true);
            elif(NeedNptxNettOp(order.Contractor, CurrYear, order.SignDate))
              if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_NPTXNETT, VS_OPERSTATUS_VSDEALS_ENDED_RUN)) //Зачет удержанного НДФЛ = Выполнить
                  msgBox( "Ошибка при установке статуса вида \"Зачет удержанного НДФЛ\" операции" );
                  return 1;
              end;
              /*Принудительная вставка блока по символу*/
              Opr_InsertBranch("N", OPRBR_PARALLEL, true);
            else
              if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_SNOB, VS_OPERSTATUS_VSDEALS_ENDED_RUN)) //Запрос СНОБ = Выполнить
                  msgBox( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );
                  return 1;
              end;
              /*Принудительная вставка блока по символу*/
              Opr_InsertBranch("S", OPRBR_PARALLEL, true);
            end;
        else
            if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_RECALC, VS_OPERSTATUS_VSDEALS_ENDED_COMPLETE)) //Пересчет СНОБ = Завершить
                msgBox( "Ошибка при установке статуса вида \"Пересчет СНОБ\" операции" );
                return 1;
            end;
            if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_NPTXNETT, VS_OPERSTATUS_VSDEALS_ENDED_COMPLETE)) //Зачет удержанного НДФЛ = Выполнить
                msgBox( "Ошибка при установке статуса вида \"Зачет удержанного НДФЛ\" операции" );
                return 1;
            end;
            if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_SNOB, VS_OPERSTATUS_VSDEALS_ENDED_COMPLETE)) //Запрос СНОБ = Завершить
                msgBox( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );
                return 1;
            end;
            if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_ZPHR, VS_OPERSTATUS_VSDEALS_ENDED_COMPLETE)) //Формирование и передача записи в хран. = Завершить
                msgBox( "Ошибка при установке статуса вида \"Формирование и передача записи в хран.\" операции" );
                return 1;
            end;
            if( not InsertOprStatus(1104, 1)) //Завершение шагов операции = Выполнить
                msgBox( "Ошибка при установке статуса вида \"Завершение шагов операции\" операции" );
                return 1;
            end;
            /*Принудительная вставка блока по символу*/
            Opr_InsertBranch("E", OPRBR_PARALLEL, true);
        end;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

/*ak - Генерация SWIFT-сообщения*/
    ExecMacroFile("paymswift_va", "PostStepSWIFT", CommitOrRollback, errTrn, FirstDoc, ID_Operation, Num_Step, Kind_Operation, KindDoc, KindStep, ID_Step);
/*~ak*/

    VS_CurrIDOperation = 0;
    VS_CurrIDStep      = 0;
    

    if (errTrn OR (CommitOrRollback==2)) 
    
        
        /* Произошла ошибка или происходит откат */
        ///* То в любом случае удаляем объекты НДР */
        var cmd2 = RSDCommand("BEGIN RSI_NPTO.RecoilInsertTaxObject(?,?); END;"); 
        cmd2.addParam( "", RSDBP_IN, ID_Operation ); 
        cmd2.addParam( "", RSDBP_IN, ID_Step      ); 
        cmd2.execute();
             //
        return;
    end;

    var sql;
    record order( dl_order );
    SetBuff( order, FirstDoc );

    //Simanov костыль для автоматической выгрузки платежа
    sql = "update dpmpaym_dbt set t_userfield3 = 1 where t_dockind = :dockind and t_documentid = :docid";
    sql = ExecSql(sql, MakeArray(SqlParam("dockind", KindDoc), SqlParam("docid", order.ContractID)), false);
    if (sql == null)
      MsgBox("Ошибка при обновлении платежа!|Платеж не будет автоматически выгружен в БИС");
    end;


    /* распоряжение на открытие счетов */
    /* распоряжение на выполнение проводок */
    /* МО по выдаче */
    /* распоряжение на банковский валютный платеж */
    /* распоряжение на клиентский валютный платеж */
    /* распоряжение на перечисление средств */
    Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПОБКS");

    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

/* Пример использования внешнего массива с назначением платежей.
   Смотри ф. RPS() в файле vsprint.mac
  var PurposeExt=TArray;
      PurposeExt[0] = PM_PURP_VEKSELDRAW;
      PurposeExt[1] = PM_PURP_PAY_DEBT;
      PurposeExt[2] = PM_PURP_TAXINCOME_NJ;
*/
    /* распоряжение на открытие счетов */
    /* распоряжение на выполнение проводок */
    /* МО по выдаче */
    /* распоряжение на банковский валютный платеж */
    /* распоряжение на клиентский валютный платеж */
    /* распоряжение на перечисление средств */
    if(not Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПОБКS"))
      msgbox("Нет документов для печати");
      exit(1);
    end;

    return 1;
END;


