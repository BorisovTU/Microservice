/*
$Name:         vsw030cl.mac
$Module:       Векселя банка
$Description:  Списание ранее выкупленных/не предъявленных векселей. Завершение операции

            vs-вексель
             w-операция списание ранее выкупленных векселей (write off)
           060-номер (соответствующий шагу)
            cl-закрытие (close)
*/

import "vsaccclose.mac";

// Запуск шага
//
MACRO ExecuteStep(Buffer, fmo_buf)
    var stat = 0;
    record fmo(vsfrmord);

    SetBuff(fmo, fmo_buf);

    if(not ЗакрытьСчетаВекселя(fmo, fmo.Signed)) 
        stat = 1;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;
    record order( dl_order );
    SetBuff( order, FirstDoc );

    var Kind = RSDCommand( "select party_read.is_legal_entity(?) NeedSend from dual" );
    Kind.addParam( "", RSDBP_IN, Order.Contractor );
    Kind.execute();
    var DataSet = TRsbDataSet(Kind);
    if(DataSet.moveNext() and (DataSet.NeedSend == 1))
        /*BOSS-5356 Отправка договора со статусом 20-закрыт в ДБО ЮЛ "Свой бизнес"*/
        var SendBillDeal = RSDCommand( "BEGIN IT_NDBOLE.send_bill_deal_json(?, ?); END;" );
        SendBillDeal.addParam( "", RSDBP_IN, Order.ContractID );
        SendBillDeal.addParam( "", RSDBP_IN, 20 /*закрыт*/);
        SendBillDeal.execute();
    end;
 
    return 1;
END;