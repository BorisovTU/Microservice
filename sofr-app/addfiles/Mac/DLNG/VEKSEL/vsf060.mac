/*
$Name:         vsf060.mac
$Module:       Собственные векселя
$Description:  Шаг "Завершение операции" операции "Погашение собственных векселей банка, выданных другим филиалом"
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vsf050.mac
  Programmer  : Велигжанин А.В.
  Операция    : Погашение собственных векселей банка, выданных другим филиалом
  Шаг         : Завершение операции
└───────────────────────────────────────────────────────────────────────────*/
IMPORT vsdates, vsaccclose, dlclose;


/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order, DocKind, ID_Operation, ID_Step)
var
    StepDate, stat = 0;

    record order( dl_order );
    SetBuff( order, dl_order );

    if(not VS_TestStepDate(DATE_REP_DOC, @StepDate, order.SignDate))
       return 1;
    end;

    if  (not DL_TestAllSteps(ID_Operation, ID_Step))
       stat = Ошибка("Не все шаги операции выполнены.|Выполните все шаги операции.");
    elif(not ЗакрытьСчетаВекселя(order, StepDate)) 
       stat = 1;
    end;

    if( not InsertOprStatus(1104, 2)) //Завершить операцию = Завершить
      msgBox( "Ошибка при установке статуса вида \"Завершение шагов операции\" операции" );
      return 1;
    end;

    return stat;
END;

/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;
   record order( dl_order );
   SetBuff( order, FirstDoc );

   var Kind = RSDCommand( "select party_read.is_legal_entity(?) NeedSend from dual" );
   Kind.addParam( "", RSDBP_IN, Order.Contractor );
   Kind.execute();
   var DataSet = TRsbDataSet(Kind);
   if(DataSet.moveNext() and (DataSet.NeedSend == 1))
      /*BOSS-5356 Отправка договора со статусом 20-закрыт в ДБО ЮЛ "Свой бизнес"*/
      var SendBillDeal = RSDCommand( "BEGIN IT_NDBOLE.send_bill_deal_json(?, ?); END;" );
      SendBillDeal.addParam( "", RSDBP_IN, Order.ContractID );
      SendBillDeal.addParam( "", RSDBP_IN, 20 /*закрыт*/);
      SendBillDeal.execute();
   end;
 
   return 1;
END;