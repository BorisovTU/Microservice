/*
$Name:         vsw020wo.mac
$Module:       Векселя банка
$Description:  Списание ранее выкупленных/не предъявленных векселей. Списание векселей/на доход

            vs-вексель
             w-операция списание ранее выкупленных векселей (write off)
           020-номер (соответствующий шагу)
            wo-списание (write off)
*/

import "vscateg.mac", "vsrepay2.mac", "vsrep.mac";

private const VS_OPTYPE_WRITEOFF_INC_BNR = 11;

private macro ВыполнитьПроводкуПоСписаниюВыкупленных(bnr, leg, StepDate)
    var ВексПД = VSBannerFD(bnr, leg), at = VS_AccTrans(), stat = 0;
    return (stat == 0); //Simanov
    at.date_carry    = StepDate;
    at.PrimaryDoc    = ВексПД;

    at.FDPayer       = ВексПД;
    at.CatPayer      = "ВнебалСчетКорресп";
    at.FiRolePayer   = FIROLE_CORACC_ACTIVE;
    at.FIIDPayer     = NATCUR;

    at.FDReceiver    = ВексПД;
    at.CatReceiver   = "Выкупленный вексель";
    at.FIIDReceiver  = leg.rec.PFI; // Валюта номинала
    at.SumReceiver   = leg.rec.Principal;

    at.Ground        = String("Списание выкупленного векселя сер. ", bnr.rec.BCSeries, " № ", trim(bnr.rec.BCNumber));
    at.Chapter       = 3;

    if(not at.carry())
        stat = Ошибка("Ошибка при выполнении",
                      "|проводки по списанию выкупленного векселя");
    end;

    return (stat == 0);
end;

private macro ВыполнитьПроводкуПоСписаниюНеПредъявленных(bnr, leg, StepDate)
    var ВексПД = VSBannerFD(bnr, leg), at = VS_AccTrans(), stat = 0, sumSeparate = false;

    

    sumSeparate = VS_IsSumSeparation();
    if ( sumSeparate == true ) //если включено "Перенос "к исп 

      var atPrimary = VS_AccTrans(); //первая проводка: списание номинальной стоимости или фактической цены размещения
      var atSecondary = VS_AccTrans(); //вторая проводка: списание дисконта или процентов
      var isPercent = ВексельПроцентный(leg);
      var isDiscount = ВексельДисконтный(leg);
      var baseSum = $0;

      atPrimary.date_carry    = StepDate;
      atPrimary.PrimaryDoc    = ВексПД;
      atPrimary.Chapter       = 1;

      atPrimary.FDPayer       = ВексПД;
      atPrimary.CatPayer      = "СВексель к исполнению";
      atPrimary.FIIDPayer     = ВексПД.ОпределитьВалютуУчета();

      ПолучитьОстаток(atPrimary.SumPayer, atPrimary.GetPayerAccount(), atPrimary.FIIDPayer, atPrimary.date_carry, atPrimary.Chapter);

      atPrimary.FDReceiver    = ВексПД;
      atPrimary.CatReceiver   = "+Доход, списание СВ";
      atPrimary.FIIDReceiver  = NATCUR;

      atPrimary.Ground        = String("Списание номинальной стоимости/фактической цены размещения векселя сер. ", bnr.rec.BCSeries, " № ", trim(bnr.rec.BCNumber));
      atPrimary.Shifr_Oper    = "09";

      atSecondary.date_carry    = StepDate;
      atSecondary.PrimaryDoc    = ВексПД;
      atSecondary.Chapter       = 1;

      atSecondary.FDPayer       = ВексПД;
      atSecondary.CatPayer      = IIF(isPercent, "Обяз%, СВексель к исп.", "Дисконт, СВексель к исп.");
      atSecondary.FIIDPayer     = ВексПД.ОпределитьВалютуУчета();

      ПолучитьОстаток(atSecondary.SumPayer, atSecondary.GetPayerAccount(), atSecondary.FIIDPayer, atSecondary.date_carry, atSecondary.Chapter);

      atSecondary.FDReceiver    = ВексПД;
      atSecondary.CatReceiver   = "+Доход, списание СВ";
      atSecondary.FIIDReceiver  = NATCUR;

      atSecondary.Ground        = String("Списание дисконта/процентов векселя сер. ", bnr.rec.BCSeries, " № ", trim(bnr.rec.BCNumber));
      atSecondary.Shifr_Oper    = "09";

    else
      at.date_carry    = StepDate;
      at.PrimaryDoc    = ВексПД;
      at.Chapter       = 1;

      at.FDPayer       = ВексПД;
      at.CatPayer      = "СВексель к исполнению";
      at.FIIDPayer     = ВексПД.ОпределитьВалютуУчета();
      ПолучитьОстаток(at.SumPayer, at.GetPayerAccount(), at.FIIDPayer, at.date_carry, at.Chapter);

      at.FDReceiver    = ВексПД;
      at.CatReceiver   = "+Доход, списание СВ";
      at.FIIDReceiver  = NATCUR;

      at.Ground        = String("Списание не предъявленного векселя " + bnr.rec.IssuerName + " сер. ", bnr.rec.BCSeries, " № ", trim(bnr.rec.BCNumber) + " на доходы");
      at.Shifr_Oper    = "09";

      if(not at.carry())
          stat = Ошибка("Ошибка при выполнении",
                        "|проводки по списанию номинальной стоимости/фактической цены размещения векселя");
      end;

    end;

    return (stat == 0);
end;

// Осуществляет перевод текущего векселя в состяние - погашенный
//
private macro СписаниеВекселя(bnr, leg, emi, order, numOrd, lnk, ЗакрывашкаДЭ:@variant, emiLnk)
  var stat = 0, ДатаСписания = ЗакрывашкаДЭ.ДатаДействия, rmState = "", newState = "";

  //Simanov if(lnk.rec.IsPartycular == "X")
  /*Simanov
  if(order.OperType != VS_OPTYPE_WRITEOFF_INC_BNR)
    if(not ВыполнитьПроводкуПоСписаниюВыкупленных(bnr, leg, ДатаСписания))
      stat = 1;
    end;

    rmState = "Л";
    newState = "Д";
  else
    if(not ВыполнитьПроводкуПоСписаниюНеПредъявленных(bnr, leg, ДатаСписания))
      stat = 1;
    end;

    rmState = "Щ";
    newState = "Г";
  end;
*/

  if (order.OperType == VS_OPTYPE_WRITEOFF_INC_BNR) 
    if(not ВыполнитьПроводкуПоСписаниюНеПредъявленных(bnr, leg, ДатаСписания))
      stat = 1;
    end;

    rmState = "Щ";
    newState = "Г";
  end;


  if ( (stat = 0) and  (Index( bnr.rec.BCState, "Ч" ) !=0) )
    if((stat == 0) and not ИзменитьВексель(bnr.rec.BCID, ДатаСписания,
                                           "rmbcstate", "Ч"))
      stat = Ошибка("Ошибка при снятии признака",
                    "|состояния векселя",
                    "|", GetTypeAc(170, "Ч"), ".");
    end;
  end;


  if((stat == 0) and not ИзменитьВексель(bnr.rec.BCID, ДатаСписания,
                                         "rmbcstate", rmState))
    stat = Ошибка("Ошибка при снятии признака",
                  "|состояния векселя",
                  "|", GetTypeAc(170, rmState), ".");
  end;

  if((stat == 0) and not ИзменитьВексель(bnr.rec.BCID, ДатаСписания,
                                         "addbcstate", newState,
                                         "repaymentdate", ДатаСписания,
                                         "bcstatus", VSBANNER_STATUS_ENDED))
      stat = Ошибка("Ошибка при изменении векселя");
  end;

  if((stat == 0) and not VS_AutoRunStep(VS_BANNER, bnr.rec.BCID, "З"))
      stat = Ошибка("Ошибка при закрытии операции сопровождения векселя");
  end;

  if((      stat == 0)
       and (bnr.rec.Department == {OperDprt}) // вексель нашего филиала
       and (Valtype(emi) != V_UNDEF) // есть договор эмиссии
       and ЗакрывашкаДЭ.ВексельПоследний(emi) // больше нет непогашенных векселей по договору эмисии
       and (emiLnk.rec.DocKind != DL_VEKSELACCOUNTED)) // вексель эмитирован не в сделке мены в УВ

      ЗакрывашкаДЭ.ЗапомнитьДЭ(emi); // установить признак закрытия договора эмиссии
  end;
  //Simanov end;

  return stat;
end;

private macro СписатьВекселя(fmo, ЗакрывашкаДЭ)
    var stat = 0;

    stat = ДляКаждогоВекселя(fmo, @СписаниеВекселя, null, @ЗакрывашкаДЭ);

    return (stat == 0);
end;

private macro СписаниеВекселей(fmo, ДатаСписания)
    var stat = 0, ЗакрывашкаДЭ = VSRepayHelper(fmo, ДатаСписания);

    if(ЗакрывашкаДЭ == null)
        stat = 1;
    end;

    if((stat == 0) and not СписатьВекселя(fmo, ЗакрывашкаДЭ))
        stat = 1;
    end;

    if((stat == 0) and not ЗакрывашкаДЭ.ЗакрытьДЭ())
        stat = 1;
    end;

    return stat;
end;

// Запуск шага
//
macro ExecuteStep(Buffer, fmo_buf)
    var stat = 0;
    record fmo(vsfrmord);
    record order(dl_order);
    SetBuff(fmo, fmo_buf);
    //SetBuff(order, Buffer);

    stat = СписаниеВекселей(fmo, fmo.Signed);

    return stat;
end;

// Макрос постобработки
//
macro PostStep(
    CommitOrRollback, // 1-выполнение шага, 2-отакат шага
    errTrn,           // Статус выполнения шага: !0 - произошла ошибка
    FirstDoc,         // Указатель на первичный документ
    ID_Operation,     // Номер экземпляра операции
    Num_Step,         // Номер шага операции(из настроек)
    Kind_Operation,   // Вид операции
    KindDoc,          // Вид первичного документа
    KindStep,         // Вид шага операции
    ID_Step)          // Номер шага операции

    if(errTrn or (CommitOrRollback == 2))
        // Произошла ошибка или происходит откат
        return;
    end;

    //Simanov Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "П"); // Проводки

    return 1;
end;

// Макрос печати
//
macro PrintStepDocs(
    ID_Operation,   // Номер экземпляра операции
    ID_Step,        // Номер шага операции
    Kind_Operation, // Вид операции
    KindStep)       // Вид шага операции

    if(not Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "П")) // Проводки
        MsgBox("Нет документов для печати");
        Exit(1);
    end;

    return 1;
end;

