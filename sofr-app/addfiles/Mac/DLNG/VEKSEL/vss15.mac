/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vss15.mac
                                vs-вексель
                                 s-операция хранения (storage)
                                15-номер (соответствующий шагу)
  Операция    : Хранение векселя
  Шаг         : Подготовка выдачи векселя с хранения.
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT InsCarryDoc, vsdates;

/*  АЛГОРИТМ ШАГА:
     1. Запросить системную дату "Выдача с хранения векселей" у пользователя 
           в панели диалога для ввода даты выдачи векселя с хранения. 
        Сообщение в панели: "Введите дату выдачи векселя с хранения". 
        Поле дата необходимо проинициализировать датой сдачи на хранения векселя + 1 день. 
        При вводе осуществить проверку "Сдача на хранение векселей" <= ДатеВыдачи.
     2. Завершить шаг.
*/

/* Запуск шага
*/
MACRO ExecuteCaseStep(OperationKind, StepNumber, Document, DocKind)
var stat=0, SignDate, NewDate,
    day, month, year, Ok = false,
    err_msg = "Дата выдачи векселя с хранения должна быть|больше или равна";

    record order("dl_order.dbt");
    SetBuff( order, Document );
    SignDate = order.SignDate;
    NewDate = SignDate+1;

    if( SignDate > {curdate} )
       MsgBox ("Преждевременное выполнение шага запрещено.");
       return 1;
    end;

    while( not Ok )
       Ok = false;
       if ( not GetDate( NewDate, "Введите дату выдачи векселя с хранения" ) )
          stat = 1; Ok = true;
       elif(SignDate > NewDate)
          DateSplit(SignDate, day, month, year);
          msgbox(string(err_msg, " ", day:2:o, ".", month:2:o, ".", year:4));
          NewDate = SignDate+1;
       else
          DefineOprDate( DATE_STOR_FROMDEPOSIT, NewDate );    // Дата выдачи с хранения
          Ok = true;
       end;
    end;

    if(stat == 0)
       return "20";
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;


