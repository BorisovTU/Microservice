/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vsa010ab.mac
                                vs-вексель
                                 a-уничтожение списанных бланков 
                               010-номер (соответствующий шагу)
                                ab- ... blanks (уничтожение списанных)
  Programmer  : Свириденко А.И.
  Операция    : Уничтожение списанных бланков
  Шаг         : Уничтожение списанных бланков
  Comment     :
  => Simanov. Убрал проводку и открытие счетов по внебалансу
└───────────────────────────────────────────────────────────────────────────*/
IMPORT FIInter, VSInter,RsbDataSet,
       vsdates, vsfmofd, vscateg, vsprord, vsprlib, vsrep;
       
// 94772 Проврека хронлогии событий (чтобы операция уничтожения проходила для всех бланков ПОЗЖЕ их списания)
MACRO ПроверитьХрнологиюДат(fmo, StepDate)
VAR FormID,stat = 0, DataSet, sqltext, UniObjID, day, month, year;

   UniObjID = UniID(fmo,0,DL_VSFRMORD); //fmo.FrmOrdId

   sqltext ="SELECT frm.T_SERIES, frm.T_NUMBER, frm.T_STATUSDATE FROM DVSFORM_DBT frm,"
            " (select SUBSTRC(t.T_ATTRID,0,INSTRC(t.T_ATTRID,' ')-1) t_ser_str,"
            " SUBSTRC(t.T_ATTRID,INSTRC (t.T_ATTRID,' ')+1) t_num_str"
            " FROM DOBJLINK_DBT t"
            " WHERE"
            " t.T_OBJECTTYPE = 667 AND t.T_GroupID = 1 AND t.T_ATTRTYPE = 1 AND" // 667 - OBJTYPE_VSFRMORD 1 - OBJGROUP_VSFRMORD 1 - OBJATTR_VSFRMORD_BLANKS 
            " t.T_OBJECTID = '"+UniObjID+ "')atr_ser "
            " WHERE frm.T_SERIES = atr_ser.t_ser_str AND frm.T_NUMBER = atr_ser.t_num_str";
   DataSet = TRsbDataSet(sqltext);
   stat = DataSet.MoveNext();

   while(stat)
	if (DataSet.rec.T_STATUSDATE > StepDate)
	   DateSplit(StepDate, day, month, year);
		msgbox(string("Нарушена хронология операций| C бланком серия ",DataSet.rec.T_SERIES," N ",
	               trim(DataSet.rec.T_NUMBER)," eсть операции позже ",day:2:o, ".", month:2:o, ".", year:4:o));
	    return 0;
	end;
	stat = DataSet.MoveNext();
   end;
   
   return (stat == 0);
END;

/* Выполняет проводку "Списание испорченных бланков"
*/
PRIVATE MACRO ПроводкаУдаление(fmo, StepDate)
VAR
    Дебет, Кредит,
    Сумма = 0,
    Purpose,
    EnumStr,
    fd,
    stat = 0;
// => Simanov
    return (stat == 0);
// =< Simanov
    EnumStr = VS_GetBlanksEnumStr(fmo.FrmOrdId, Сумма);

    Purpose = String("Уничтожить бланки векселей ",
                     EnumStr,
                     " (в кол-ве ", Сумма, " шт.)");

    if((fd = VSFrmOrdFd(fmo)) == null)
       stat = 1;
    elif(not ПолучитьСчетВекселя("ВнебалСчетКорресп", fd, Дебет, MC_OPENACC_CREATE, NATCUR, null, StepDate, FIROLE_CORACC_ACTIVE))
       stat = 1;
    elif(not ПолучитьСчетВекселя("БланкиДляУничт.,Сц/б", fd, Кредит, MC_OPENACC_CREATE, null, null, StepDate))
       stat = 1;
    elif (Проводка(Дебет, Кредит, Сумма, Purpose, 0, 0, NATCUR, 3, null, StepDate) != 0)
        msgbox ("Ошибка при выполнении проводки",
                "|по списанию испорченных бланков");
        return false;
    end;

    return (stat == 0);
END;


/* Запуск шага
*/
MACRO ExecuteStep(Buffer, fmo_buf)
var
    StepDate, 
    stat = 0;

    record fmo( vsfrmord );
    SetBuff( fmo, fmo_buf );

    if(not VS_TestStepDate(DATE_BLNK_DOC, @StepDate, fmo.Signed, " даты распоряжения "))
       return 1;
    end;
    
    if (not ПроверитьХрнологиюДат(fmo, StepDate))
       return 1;	
    end;

    if(not ПроводкаУдаление(fmo, StepDate))
       stat = 1;
    else
       VS_SetStatusToBlanks(fmo.FrmOrdId, VSFORM_STATUS_DELETED, -1, StepDate);
    end;

    return stat;
END;


/* Макрос постобработки
*/
MACRO PostStep (
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2))
        /* Произошла ошибка или происходит откат */
        return;
    end;

    Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, МемОрдера */

    return 1;
END;


/* Макрос печати
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, МемОрдера */

    return 1;
END;


