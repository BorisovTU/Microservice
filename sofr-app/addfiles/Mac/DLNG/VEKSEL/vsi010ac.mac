/*
$Name:         vsi010ac.mac
$Module:       Векселя банка
$Description:  Эмиссия собственного векселя. А.актуализация вексельных счетов

            vs-вексель
             i-операция эмиссии векселя (issue)
           010-номер (соответствующий шагу)
            ac-актуализация
*/

IMPORT vscateg, vs4each, vsrep, vsordchk, vsrcvacc, vslib;
import oralib, likepy;

PRIVATE VAR OrderDate = date(0, 0, 0), firstbnr, ВалНомВекс = -1;
/* Действия шага актуализации.
     1.Получить номер и параметры векс.счета.
     2.Открыть векс.счет.
   При выполнении макроса предполагается, что vsbanner спозиционирован на
   нужном векселе.
   ВНИМАНИЕ:
     "Наш вексель" актуализируется в функции VS_DefReceiverAccount(),
     которая явлается общим кодом для определения счета получателя
*/
PRIVATE MACRO ШагАктуализации(bnr, leg, emi, order, numOrd, lnk)
var
   Счет,
   fd = VSBannerFD(bnr, leg),
   isPc = ВексельПроцентный(leg),
   isDisc = ВексельДисконтный(leg),
   isBonus = ВексельсПремией(leg),
   stat = 0;

   //Simanov - Счёт "к исполнению" открывается только при необходимости
   //if(not ПолучитьСчетВекселя("СВексель к исполнению", fd, Счет, MC_OPENACC_CREATE, NULL, NULL, OrderDate))

   if (isPc and not ПолучитьСчетВекселя("Обяз%,СВексель", fd, Счет, MC_OPENACC_CREATE, NULL, NULL, OrderDate))
     stat = 1;
   elif(ВалНомВекс == -1)
      ВалНомВекс = leg.rec.PFI;
   end;

   if(stat == 0)
   /*SImanov
     if(isPc)
        if(not ПолучитьСчетВекселя("-Эмиссия, СВ", fd, Счет, MC_OPENACC_CREATE, null, null, OrderDate, FIROLE_PERCENT))
           stat = 1;
        end;
     end;
*/
     if(isDisc)
        if(not ПолучитьСчетВекселя("Дисконт, Свексель", fd, Счет, MC_OPENACC_CREATE, NULL, null, OrderDate, FIROLE_DISCOUNT))
           stat = 1;
        //Simanovelif(not ПолучитьСчетВекселя("-Эмиссия, СВ", fd, Счет, MC_OPENACC_CREATE, null, null, OrderDate, FIROLE_DISCOUNT))
           stat = 1;
        end;
     end;
     
     if (isBonus)
       if(not ПолучитьСчетВекселя("Премия, Свексель", fd, Счет, MC_OPENACC_CREATE, NULL, null, OrderDate, FIROLE_DISCOUNT))
         stat = 1;
       end;
     end;
   end;

   if(stat == 0)
     stat = ОпрСчетПолучДляЭмиссии(fd, leg, OrderDate, MC_OPENACC_CREATE, @firstbnr);
   end;

   return stat;
END;

/* Актуализирует счета договора:
     "Разн.цен. и док. подотчет"
   ВНИМАНИЕ:
     "-Расчеты" в валюте платежа актуализируется в функции VS_DefReceiverAccount(),
     которая явлается общим кодом для определения счета получателя
*/
PRIVATE MACRO СчетаДоговора(order)
var Счет, fd, stat = 0;

   if((fd = VSOrderFD(order)) == null)
     stat = Ошибка("Ошибка при определении первичного документа договора");
//   elif(not ПолучитьСчетВекселя("Разн.цен. и док. подотчет", fd, Счет, MC_OPENACC_CREATE, NATCUR, NULL, OrderDate))
     stat = 1;
   end;

   return (stat == 0);
END;

/* Актуализирует счета векселей
*/
PRIVATE MACRO СчетаВекселей(order)
var
    stat;

    firstbnr = true;

    stat = ДляКаждогоВекселя(order, @ШагАктуализации, VSORDLNK_K_EMISSION);
    return (stat == 0);
END;

/* Запуск шага
     Удобнее сначала актуализировать счета для векселей
     (можно заодно узнать валюту), затем для договора.
*/
MACRO ExecuteStep(Buffer, dl_order)
var
    paym, stat = 0;

    record order( dl_order );
    SetBuff( order, dl_order );

    OrderDate = order.SignDate;

    if( OrderDate > {curdate} )
       return Ошибка("Преждевременное выполнение шага запрещено.");
    end;

    if(not СчетаВекселей(order))
       stat = 1;
    elif(not СчетаДоговора(order))
       stat = 1;
    elif(not НайтиПлатежПоДоговору(@paym, order, -1))
       stat = 1;
    elif(not VS_DefReceiverAccount(MC_OPENACC_CREATE, order, paym, OrderDate))
       stat = 1;
    end;

    return stat;
END;

/* Макрос постобработки
*/
MACRO PostStep (
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */


    if (errTrn OR (CommitOrRollback==2))
        /* Произошла ошибка или происходит откат */
        return;
    end;
    record order( dl_order );
    SetBuff( order, FirstDoc );
    //Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "С"); /* Счета */
    var Kind = RSDCommand( "select party_read.is_legal_entity(?) NeedSend from dual" );
    Kind.addParam( "", RSDBP_IN, Order.Contractor );
    Kind.execute();
    var DataSet = TRsbDataSet(Kind);
    if(DataSet.moveNext() and (DataSet.NeedSend == 1))
      /*BOSS-5356 Отправка договора со статусом 10-открыт в ДБО ЮЛ "Свой бизнес"*/
      var SendBillDeal = RSDCommand( "BEGIN IT_NDBOLE.send_bill_deal_json(?, ?); END;" );
      SendBillDeal.addParam( "", RSDBP_IN, Order.ContractID );
      SendBillDeal.addParam( "", RSDBP_IN, 10 /*закрыт*/);
      SendBillDeal.execute();
    end;
    
    return 1;
END;

/* Макрос печати
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    if(not Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "С")) /* Счета */
      msgbox("Нет документов для печати");
      exit(1);
    end;

    return 1;
END;

