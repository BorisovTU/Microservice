/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vsr100mv.mac
                                vs-вексель
                                 r-операция погашения векселя (Repayment)
                               100-номер (соответствующий шагу)
                                mv-перевод (move)
  Programmer  : Велигжанин А.В.
  Операция    : Погашение векселя
  Шаг         : И.перевод на счет к исполнению.
  Comment     : Используется общий код для операций погашения и мены
└───────────────────────────────────────────────────────────────────────────*/
IMPORT OprInter, vsdates, vsmove, vsrep, vs4each;

// 93802 Начальны значение: мы верим что все веселя уже перенесены количесво этих векселй 0
var AllBannersAlredyMoved = 1,BannersCount = 0,BannerSeriesAndNum = "";

PRIVATE MACRO CheckDepartment(bnr, leg, emi, order, numOrd, lnk, Дата:@variant)

    if (bnr.rec.Department != {OperDprt})
        return Ошибка("Вексель серия ",bnr.rec.BCSeries, " N ", trim(bnr.rec.BCNumber), 
                      ", выпущен другим филиалом|",
                     "перенос на счет к \"исполнению\" не может быть выполнен");
    else
        /* Проверка на то, что в списке векселей есть не перенесенные */
        if (Index(bnr.rec.BCState, "И") == 0)
         AllBannersAlredyMoved = 0;
        end;
        BannersCount = BannersCount + 1;
        BannerSeriesAndNum = "серия "+bnr.rec.BCSeries+" N "+trim(bnr.rec.BCNumber);
 
        return 0;
    end;

END;    

/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order, DocKind, ID_Operation, ID_Step)
var StepDate, stat = 0;

    record order( dl_order );
    SetBuff( order, dl_order );

    VS_CurrIDOperation = ID_Operation;
    VS_CurrIDStep      = ID_Step;
/*Simanov. Весь бух учет в ГО. Проверка на филиал выдачи не нужна
    if (ДляКаждогоВекселя(order, @CheckDepartment, VSORDLNK_K_DRAW, null, "B"))
       return 1;
    end;
*/
/*Simanov. В дальнейшем есть проверка на каждый вексель, перенесён ли он к исполнению.
Вполне возможна ситуация, когда часть векселей (или все) уже перенесены

    if (AllBannersAlredyMoved == 1)      // 93802
      if (BannersCount == 1)
        Ошибка("Вексель ", BannerSeriesAndNum,
                    " уже перенесен на счет счет к \"исполнению\" ");
        return 1;
      else
        Ошибка("Все векселя по операции уже находятся на счете к \"исполнению\" ");
        return 1;
      end;
    end;
*/

    if(not ПереводВекселейКИспол(order, StepDate))
       stat = 1;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    VS_CurrIDOperation = 0;
    VS_CurrIDStep      = 0;

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СП"); /* Счета, Проводки */

    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    if(not Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СП")) /* Счета, Проводки */
      msgbox("Нет документов для печати");
      exit(1);
    end;

    return 1;
END;


