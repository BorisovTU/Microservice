/**
 @file 		vsbnrattr_own.mac
 @brief 	Отчет "Собственные векселя"

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |29.12.2023 |Велигжанин А.В.|DEF-56486                                       |Оптимизация. Выражение GetGE() неэффективно без addFilter()
*/
IMPORT "DLReport_h.mac", vsbnrattr_own_form, vslib, vsbnrfd, vsacc, dlmisc, vspmfutu;


PRIVATE CLASS ( DL_CReportTemplate ) VS_BnrAttr_Own()
    VAR
    m_BeginDate:DATE,
    m_EndDate:DATE,
    m_Date:DATE,

    m_Prep:STRING,
    m_Repay:STRING,
    m_DataQuery:STRING,
    m_RS,
    m_NRecs:INTEGER,
    m_Num:INTEGER,
    m_CurrSheetName:STRING,
    m_A12,
    m_A13,
    m_A22,
    m_A23,
    m_A42,
    m_A43,
    m_PawnHolder;

    PRIVATE MACRO A1():INTEGER // 
        return m_Rs.t_bcid;
    END;

    PRIVATE MACRO A2():STRING //
      if(m_Rs.Branch_CODE == "0000")
        return "Головной";
      elif(m_Rs.Branch_CODE == "7900")
        return "ЦКБ";
      elif(m_Rs.Branch_CODE == "6300")
        return "ЦРМБ";
      end;
      return m_Rs.Branch_Name;
    END;
    
    PRIVATE MACRO A2_1(): STRING // Код ВСП
      return m_Rs.VSP_Code;
    END;

    PRIVATE MACRO A3():STRING //
        return m_Rs.HOLDERNAME;
    END;

    PRIVATE MACRO A4():STRING //
        return m_RS.INN;
    END;

    PRIVATE MACRO A5():STRING // 
        return m_RS.OGRN;
    END;

    PRIVATE MACRO A6():STRING // 
        return m_RS.OKSM;
    END;

    PRIVATE MACRO A7():STRING // 
        var S = "";
        if (m_RS.HOLDER_RES == SET_CHAR)
            S = "Нерезидент";
        else
            S = "Резидент";
        end;
        return S;
    END;

    PRIVATE MACRO A8():STRING // 
        var S = "";
        var Kind;
        var DataSet;
        if (m_Rs.HOLDER_LEGALFORM == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, m_RS.HOLDER );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, m_RS.HOLDER );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
        return S;
    END;

    PRIVATE MACRO A9():STRING // 
        return m_RS.TIN;
    END;

    PRIVATE MACRO A10():STRING // 
        return m_RS.T_BCSERIES;
    END;

    PRIVATE MACRO A11():STRING // 
        return trim(m_RS.T_BCNUMBER);
    END;

    PRIVATE MACRO A12_13()// 
      var ord = TBfile ("dl_order");
      m_A12 = "";
      m_A13 = date(0,0,0);
      if (ПоискДоговораЭмиссииВекселя(m_Rs.T_BCID, null, null, null, @ord))
          m_A12 = ord.rec.OrderNumber + " от " + date_as_string( 1,  ord.rec.SignDate, false );
          m_A13 = ord.rec.SignDate;
      end;
    END;

    PRIVATE MACRO A14():STRING // 
        return m_RS.T_ISSUEPLACE;
    END;

    PRIVATE MACRO A15():DATE // 
        return SQL_ConvTypeDate( m_RS.T_ISSUEDATE );
    END;

    PRIVATE MACRO A16():MONEY // 
        return m_RS.T_PRINCIPAL;
    END;

    PRIVATE MACRO A17():MONEY // Цена продажи
        VAR M = $0;
        if (m_RS.T_PFI == NATCUR)
          M = m_RS.T_PRINCIPAL;
        else
          ConvSum (M, money(m_RS.T_PRINCIPAL), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
        end;
        return M;
    END;

    PRIVATE MACRO A18():STRING // 
        return m_RS.CURRENCY;
    END;

    PRIVATE MACRO A19():MONEY // 
        return m_RS.BCCOST_PFI;
    END;

    PRIVATE MACRO A20():MONEY // 
      VAR M = $0;
      if (m_RS.T_PFI == NATCUR)
          M = m_RS.BCCOST_PFI;
      else
        ConvSum (M, money(m_RS.BCCOST_PFI), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    PRIVATE MACRO A21():STRING // 
        return m_RS.CURRENCY;
    END;

    private macro СостояниеВекселяНаДату(BCID, RepDate, Symbol)
      var DataSet, Select;

      Select = DL_RSDCommand( "select instr(rsb_bill.GetVABnrStateOnDate(? /*1*/, ? /*2*/), ? /*3*/) as sympos from dual" );

      Select.AddParam(BCID );     /*1*/
      Select.AddParam(RepDate );  /*2*/
      Select.AddParam(Symbol );   /*3*/

      DataSet = Select.Execute();

      if(DataSet.moveNext())
        return DataSet.sympos;
      end;
      return 0;
    end;

    private macro СтатусВекселяНаДату(BCID, RepDate, Status)
      var DataSet, Select;

      Select = DL_RSDCommand( "select rsb_bill.GetVSBnrStatusOnDate(? /*1*/, ? /*2*/) as status from dual" );

      Select.AddParam(BCID );     /*1*/
      Select.AddParam(RepDate );  /*2*/

      DataSet = Select.Execute();

      if(DataSet.moveNext())
        return IIF(DataSet.status == VSBANNER_STATUS_PAWN, true, false);
      end;
      return false;
    end;

    PRIVATE MACRO ПоискДоговораЗалога(BCID, LinkKind, DateB, DateE, retEmi)
      var ContractID = 0 /* идентификатор найденного договора */;
      var Select, query, DataSet;
      query = "SELECT contractid from (SELECT ord.t_contractid contractid" 
        + "                                FROM dvsordlnk_dbt ordlnk, DDL_ORDER_DBT ord "
        + "                               WHERE     ordlnk.t_bcid = ? " 
        + "                                 AND ordlnk.t_linkkind = ? " 
        + "                                 and ord.T_CONTRACTID = ordlnk.T_CONTRACTID " 
        + "                                 AND ord.T_SIGNDATE <= ? "
        + "                                 AND ord.T_KIND_OPERATION IN "
        + "                                                             (SELECT oper.T_KIND_OPERATION "
        + "                                                                FROM DOPRKOPER_DBT oper "
        + "                                                               WHERE     oper.T_DOCKIND = " + DL_VEKSELPAWNORDER
        + "                                                                 AND  INSTR (oper.t_systypes, 'П') > 0 ) "
        + "                            ORDER BY ord.T_SIGNDATE DESC, ord.t_contractid DESC) WHERE rownum = 1 ";
        
      Select = DL_RSDCommand(query);
      Select.AddParam(BCID ); 
      Select.AddParam(VSORDLNK_K_PAWN );
      Select.AddParam(DateE ); 
       
      DataSet = Select.Execute();

      if(DataSet.moveNext())
        ContractID = DataSet.contractid;
      end;

      if(ContractID == 0)    /* Не нашли */
        return false;
      elif(ValType(retEmi) == V_UNDEF) /* Сам договор эмиссии не нужен, важен только факт наличия*/
        return true;
      elif(not ПоискДоговора(retEmi, ContractID))
        return false; /* ошибка */
      end;

      return true;
    END;

    PRIVATE MACRO Find_PawnHolder()// 
      var ord = TBfile ("dl_order");
      m_PawnHolder = null;
      m_PawnHolder = TRecHandler( "party.dbt" );
      if(m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_SENDED)
        var isPawn = СтатусВекселяНаДату(m_Rs.T_BCID, m_Date, VSBANNER_STATUS_PAWN);
        if(isPawn)
          if (ПоискДоговораЗалога(m_Rs.T_BCID, VSORDLNK_K_PAWN, m_BeginDate, m_Date, @ord))
              ПолучитьСубъекта( ord.rec.Contractor, m_PawnHolder );
          end;
        end;
      end;
    END;

    PRIVATE MACRO A35():MONEY // Сумма дисконта
      if ( m_RS.INCOMETYPE == "Д" )
        return m_RS.T_PRINCIPAL - m_RS.T_RECEIPTAMOUNT;
      end;
      return 0;
    END;

    PRIVATE MACRO A39():MONEY 
        VAR Дисконт = $0;
        var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
        if(  m_RS.INCOMETYPE == "Д" )
          if((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) AND (not isВыкуплен))
            Дисконт = A35();
          else
            Дисконт = ПолучитьСуммуДисконтаНаДату( SQL_ConvTypeDate( m_Date ), FD.GetBnr(), FD.GetLeg() );
          end;
        end;
        return abs(Дисконт);
    END;

    PRIVATE MACRO A41():MONEY
        VAR ОсткБСчПр = 0.0, Скн = 0.0, Error = "", dl_leg = TrecHandler( "dl_leg.dbt" );
        var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
        var Prc = 0.0;
        var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
        if( ( m_RS.T_FORMULA == 0 ) or ( m_RS.T_PRICE <= 0.0 ) ) // вексель дисконтный или ставка процентов нулевая
            return 0.0;
        end;
        if( FindDL_LEG( LEG_KIND_VSBANNER, m_RS.T_DEALID, 0, dl_leg ) == 0 )
            if((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) AND (not isВыкуплен))
              ПолучитьСуммуКНачисл_В( fd.GetBnr(), fd.GetLeg(), SQL_ConvTypeDate( m_Date ), @Скн, @ОсткБСчПр );
              Prc = Скн + ОсткБСчПр;
            else
              Prc = ПолучитьСуммуПроцетовНаДату( SQL_ConvTypeDate( m_Date ), m_RS.t_BCID, dl_leg, @Error );
            end;
            if( Error != "" )
                MsgBox( Error );
                return 0.0;
            end;
        else
            MsgBox( "Не найдены ценовые условия векселя " + m_RS.t_BCSeries + " N " + m_RS.t_BCNumber );
        end;
        return Prc;
    END;

    PRIVATE MACRO A22_23_42_43() // 
      m_A22 = $0;
      m_A23 = "";
      m_A42 = m_A43 = "";
      var cmd;
      var ds;
      var isКИсполнению = 0;
      var Account = "";
      var ok;
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
      var rest = $0;
      var fi = TRecHandler("fininstr");

      isКИсполнению = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"И");

      var RestDate  = IIF(((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED)), m_Date - 1, m_Date);

      if(isКИсполнению)
        ok = ПолучитьСчетВекселя("СВексель к исполнению", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(RestDate));
      else
        ok = ПолучитьСчетВекселя("Наш вексель", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(RestDate));
      end;
      if(ok and (Account != NULL))
        rest = abs(IIF(fd.ОпределитьВалютуУчета(),RestAC(Account,fd.ОпределитьВалютуУчета(),RestDate),RestA(Account,RestDate)));
      else
        rest = 0;
      end;
      /*Костыль на случай, когда выполнили перенос к исполнению и погашение в один день. Остаток в таком случае нулевой, только так удалось получить*/
      if((rest == 0) and isКИсполнению and ok and (Account != NULL))
        cmd = DL_RSDCommand(" select rest.t_debet  from drestdate_dbt rest, daccount_dbt acc where acc.t_account = ? and rest.t_accountid = acc.t_accountid and rest.t_restdate = ? and rest.t_restcurrency = ?");
        cmd.AddpAram(Account);
        cmd.AddpAram(m_Date);
        cmd.AddpAram(fd.ОпределитьВалютуУчета());
        ds = cmd.Execute();
        if (ds.moveNext())
          rest = ds.debet;
          RestDate = m_Date;
        end;
      end;
      if ((Account != NULL))
        if (not isКИсполнению)
          rest = rest + A39() + A41();
        end;
        if(fd.ОпределитьВалютуУчета() == NATCUR)
          m_A22 = rest;
        else
          ConvSum (m_A22, money(rest), SQL_ConvTypeDate( RestDate ), fd.ОпределитьВалютуУчета(), NATCUR);
        end;
        if(not ПолучитьФинИн(fd.ОпределитьВалютуУчета(), fi))
          m_A23 = fi.rec.ccy;
        end;
        m_A42 = Account;
        m_A43  = SubStr(Account, 1, 5);
      end;
    END;

    PRIVATE MACRO A24():STRING // Срок платежа
        VAR S = "";
        if( ( m_RS.t_BCTermFormula == VS_TERMF_FIXEDDAY ) // на опред.день
         or ( m_RS.t_BCTermFormula == VS_TERMF_INATIME ) ) // во столько-то времени от составления
            S = date_as_string( 1, SQL_ConvTypeDate( m_RS.t_Maturity ), false );
        elif( m_RS.t_BCTermFormula == VS_TERMF_ATSIGHT ) // по предъявлении
          if((SQL_ConvTypeDate( m_RS.t_Expiry) < SQL_ConvTypeDate( m_RS.t_Start)) and (SQL_ConvTypeDate( m_RS.t_Maturity) >= SQL_ConvTypeDate( m_RS.t_Start)))
            S   = "По предъявлении, но не ранее " +  date_as_string( 1, SQL_ConvTypeDate( m_RS.t_Maturity ), false );
          elif((SQL_ConvTypeDate( m_RS.t_Expiry) >= SQL_ConvTypeDate( m_RS.t_Start)) and (SQL_ConvTypeDate( m_RS.t_Maturity) < SQL_ConvTypeDate( m_RS.t_Start)))
            S   = "По предъявлении, но не позднее " + date_as_string( 1, SQL_ConvTypeDate( m_RS.t_Expiry ), false );
          else
            S   = "По предъявлении, но не ранее " + date_as_string( 1, SQL_ConvTypeDate( m_RS.t_Maturity ), false ) + " и не позднее " + date_as_string( 1, SQL_ConvTypeDate( m_RS.t_Expiry ), false );
          end;
        end;
        return S;
    END;

    PRIVATE MACRO A25():STRING // 
        return "Простой";
    END;

    PRIVATE MACRO A26():DATE // 
        var RepaymentDate = date(0,0,0);
        if((m_RS.t_BCTermFormula == VS_TERMF_FIXEDDAY) OR (m_RS.t_BCTermFormula == VS_TERMF_INATIME) OR // срочные
            ((m_RS.t_BCTermFormula == VS_TERMF_ATSIGHT) and (SQL_ConvTypeDate(m_RS.t_Maturity) >= SQL_ConvTypeDate(m_RS.t_Start)))) // По предъявлении, но не ранее
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_Maturity);
        elif((m_RS.t_BCTermFormula == VS_TERMF_DURING) and (SQL_ConvTypeDate(m_RS.t_BCPresentationDate) > date(0,0,0))) // от предъявления, уже предъявленные
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_BCPresentationDate) + int(m_RS.t_Diff);
        else
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_Start) + DaysInYearByBasis(m_RS.t_Basis,SQL_ConvTypeDate(m_RS.t_Start), true);
        end;
        return RepaymentDate;
    END;

    PRIVATE MACRO A27():DATE // 
        if(m_RS.t_BCTermFormula == VS_TERMF_ATSIGHT)
            if( ( SQL_ConvTypeDate( m_RS.t_Expiry ) < SQL_ConvTypeDate( m_RS.t_Start ) ) and 
                ( SQL_ConvTypeDate( m_RS.t_Maturity ) >= SQL_ConvTypeDate( m_RS.t_Start ) ) )
                    return date(0,0,0);
            elif( ( SQL_ConvTypeDate( m_RS.t_Expiry ) >= SQL_ConvTypeDate( m_RS.t_Start ) ) and // По предъявлении, но не позднее 
                  ( SQL_ConvTypeDate( m_RS.t_Maturity ) < SQL_ConvTypeDate( m_RS.t_Start ) ) )
                    return SQL_ConvTypeDate( m_RS.t_Expiry );
            else // По предъявлении, но не ранее и не позднее
                return SQL_ConvTypeDate( m_RS.t_Expiry );
            end;
        end;
        return date(0,0,0);
    END;

    PRIVATE MACRO A28():DATE //
        if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
          return SQL_ConvTypeDate(m_Rs.T_CHANGEDATE);
        end;
        return A26();
    END;

    PRIVATE MACRO A29():STRING // 
        return m_RS.INCOMETYPE;
    END;

    PRIVATE MACRO A30():MONEY // 
        return m_RS.RATE;
    END;

    PRIVATE MACRO A31():INTEGER // 
        return m_RS.T_DURATION;
    END;

    PRIVATE MACRO A32():INTEGER // Срок обращения векселя
        VAR D = 0, FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        if( FD != null )
            D = VS_GetTermCircDate( FD.GetBnr(), FD.GetLeg() );
        end;
        return D;
    END;

    PRIVATE MACRO A33():MONEY // 
      if ( m_RS.INCOMETYPE == "П" )
        return A30();
      elif ( m_RS.INCOMETYPE == "Д" )
        var c365:double = 0, c366:double = 0;

        GetDaysCoef(SQL_ConvTypeDate(m_Rs.T_ISSUEDATE), A26, @c365, @c366);

        if ((m_Rs.T_RECEIPTAMOUNT < 0) or ((c365+c366) == 0))
          return 0;
        else
          return (m_RS.T_PRINCIPAL - m_Rs.T_RECEIPTAMOUNT) / m_Rs.T_RECEIPTAMOUNT / (c365+c366) * 100;
        end;
      end;
      return 0;
    END;

    PRIVATE MACRO A34():STRING // 
        var r_ficert = TRecHandler("ficert.dbt");
        var ObjectID;
        var cmd = DL_RSDCommand(" SELECT ficert.* FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin "+
                          " WHERE  bnr.t_BCID = ? " +
                          "   and fin.t_FIID = bnr.t_FIID" +
                          "   and ficert.t_CertID = bnr.t_BCID" +
                          "   and ficert.t_AvoirKind = fin.t_AvoirKind");
        cmd.AddpAram(m_Rs.T_BCID);
        var DataSet = cmd.Execute();

        if (DataSet.moveNext())
            DataSet.GetRecord().CopyTO(r_ficert.rec);

            ObjectID = UniID(r_ficert, OBJTYPE_FICERT);
            return string(readNoteForObject(OBJTYPE_FICERT, ObjectID, 23));
        end;
        return "";
    END;


    PRIVATE MACRO A36():MONEY // Сумма дисконта
      VAR M = $0;
      if(m_RS.T_PFI == NATCUR)
        M = A35();
      else
        ConvSum (M, money(A35()), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    PRIVATE MACRO A37():MONEY // 
      var c365:double = 0, c366:double = 0;
      if ( m_RS.INCOMETYPE == "Д" )

        GetDaysCoef(SQL_ConvTypeDate(m_Rs.T_ISSUEDATE), A26, @c365, @c366);

        if((m_Rs.T_RECEIPTAMOUNT > 0) and ((c365+c366) != 0))
          return (m_RS.T_PRINCIPAL - m_Rs.T_RECEIPTAMOUNT) / m_Rs.T_RECEIPTAMOUNT / (c365+c366)  * 100;
        end;
      end;

      return 0;
    END;

    PRIVATE MACRO A38():MONEY 
        VAR Дисконт = $0;
        VAR M = $0;
        var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
        if(  m_RS.INCOMETYPE == "Д" )
          if((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) AND (not isВыкуплен))
            Дисконт = A35();
          else
            Дисконт = ПолучитьСуммуДисконтаНаДату( SQL_ConvTypeDate( m_Date ), FD.GetBnr(), FD.GetLeg() );
          end;
        end;
        if(m_RS.T_PFI == NATCUR)
          M = Дисконт;
        else
          ConvSum (M, money(Дисконт), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
        end;
        return abs(M);
    END;

    

    PRIVATE MACRO A40():MONEY 
        VAR ОсткБСчПр = 0.0, Скн = 0.0, Error = "", dl_leg = TrecHandler( "dl_leg.dbt" );
        VAR M = $0;
        VAR Prc = 0.0;
        var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);

        var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
        if( ( m_RS.T_FORMULA == 0 ) or ( m_RS.T_PRICE <= 0.0 ) ) // вексель дисконтный или ставка процентов нулевая
            return 0.0;
        end;

        if( FindDL_LEG( LEG_KIND_VSBANNER, m_RS.T_DEALID, 0, dl_leg ) == 0 )
            if((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) AND (not isВыкуплен))
              ПолучитьСуммуКНачисл_В( fd.GetBnr(), fd.GetLeg(), SQL_ConvTypeDate( m_Date ), @Скн, @ОсткБСчПр );
              Prc = Скн + ОсткБСчПр;
            else
              Prc = ПолучитьСуммуПроцетовНаДату( SQL_ConvTypeDate( m_Date ), m_RS.t_BCID, dl_leg, @Error );
            end;
            if( Error != "" )
                MsgBox( Error );
                return 0.0;
            end;
        else
            MsgBox( "Не найдены ценовые условия векселя " + m_RS.t_BCSeries + " N " + m_RS.t_BCNumber );
        end;
        if(m_RS.T_PFI == NATCUR)
          M = Prc;
        else
          ConvSum (M, money(Prc), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
        end;
        return M;
    END;

    

    PRIVATE MACRO A44():STRING // 
      if (A29() != "П")
        return "";
      end;
      var cmd;
      var ds;
      var isКИсполнению = 0;
      var Account = "";
      var ok;
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);

      isКИсполнению = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"И");

      if(isКИсполнению)
        ok = ПолучитьСчетВекселя("СВексель к исполнению", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(m_Date));
      else
        ok = ПолучитьСчетВекселя("Обяз%,СВексель", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(m_Date));
      end;
      if (ok and (Account != NULL))
        return Account;
      end;
      return "";
    END;

    PRIVATE MACRO A45():STRING // 
      if (A29() != "Д")
        return "";
      end;
      var cmd;
      var ds;
      var isКИсполнению = 0;
      var Account = "";
      var ok;
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);

      isКИсполнению = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"И");

      if(isКИсполнению)
        ok = ПолучитьСчетВекселя("СВексель к исполнению", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(m_Date));
      else
        ok = ПолучитьСчетВекселя("Дисконт, Свексель", fd, Account, VS_FNDACC, fd.ОпределитьВалютуУчета(), NULL, SQL_ConvTypeDate(m_Date));
      end;
      if (ok and (Account != NULL))
        return Account;
      end;
      return "";
    END;

    PRIVATE MACRO A46():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return "В банке";
      end;
      return "У клиента";
    END;

    PRIVATE MACRO A47():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return "В залоге";
      end;
      return "В обращении";
    END;

    PRIVATE MACRO A48():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return m_PawnHolder.rec.ShortName;
      end;
      return "";
    END;

    PRIVATE MACRO A49():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return ПолучитьКодСубъекта( m_PawnHolder.rec.PartyID, PTCK_INN );
      end;
      return "";
    END;

    PRIVATE MACRO A50():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return ПолучитьКодСубъекта( m_PawnHolder.rec.PartyID, PTCK_OGRN );
      end;
      return "";
    END;

    PRIVATE MACRO A51():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        if( (m_PawnHolder.rec.NRCOUNTRY != "") AND (m_PawnHolder.rec.NRCOUNTRY != NULL))
        var cmd = RsdCommand( "SELECT t_codenum3 FROM dcountry_dbt WHERE t_codelat3 = ?" );
        cmd.addParam( "", RSDBP_IN, m_PawnHolder.rec.NRCOUNTRY );
        cmd.execute();
        var rs = RsdRecordset( cmd );
        if ( rs.moveNext )
            return rs.value( "t_codenum3" );
        end;
        end;
      end;
      return "";
    END;

    PRIVATE MACRO A52():STRING // 
      var S = "";
      if (m_PawnHolder.rec.PartyID > 0)
        if (m_PawnHolder.rec.NotResident == SET_CHAR)
          S = "Нерезидент";
        else
          S = "Резидент";
        end;
      end;
      return S;
    END;

    PRIVATE MACRO A53():STRING // 
      var S = "";
      var Kind;
      var DataSet;
      if (m_PawnHolder.rec.PartyID > 0)
        if (m_PawnHolder.rec.LegalForm == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, m_PawnHolder.rec.PartyID );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, m_PawnHolder.rec.PartyID );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
      end;
      return S;
    END;

    PRIVATE MACRO A54():STRING // 
      if (m_PawnHolder.rec.PartyID > 0)
        return ПолучитьКодСубъекта( m_PawnHolder.rec.PartyID, PTCK_FOREIGN_INN );
      end;
      return "";
    END;

    PRIVATE MACRO A55():STRING // 
      return "";
    END;

    PRIVATE MACRO B1():DATE // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
          return SQL_ConvTypeDate(m_Rs.T_CHANGEDATE);
      elif (SQL_ConvTypeDate(m_RS.T_CLOSED) != date(0,0,0))
        return SQL_ConvTypeDate(m_Rs.T_CLOSED);
      end;
      return date(0,0,0);
    END;

    PRIVATE MACRO B2():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if(m_Rs.DEP_CODE == "0000")
          return "Головной";
        elif(m_Rs.DEP_CODE == "7900")
          return "ЦКБ";
        elif(m_Rs.DEP_CODE == "6300")
          return "ЦРМБ";
        end;
        return m_Rs.DEP_NAME;
      end;
      return "";
    END;

    PRIVATE MACRO B3():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return m_Rs.T_ORDERNUMBER + " от " + date_as_string( 1, SQL_ConvTypeDate(m_Rs.T_CREATEDATE), false );
      end;
      return "";
    END;

    PRIVATE MACRO B6():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return m_Rs.MORTAGE_NAME;
      end;
      return "";
    END;

    PRIVATE MACRO B7():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return m_RS.MORTAGE_INN;
      end;
      return "";
    END;

    PRIVATE MACRO B8():STRING //
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED)) 
        return m_RS.MORTAGE_OGRN;
      end;
      return "";
    END;

    PRIVATE MACRO B9():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return m_RS.MORTAGE_OKSM;
      end;
      return "";
    END;

    PRIVATE MACRO B10():STRING // 
      var S = "";
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if (m_RS.MORTAGE_RES == SET_CHAR)
            S = "Нерезидент";
        else
            S = "Резидент";
        end;
      end;

      return S;
    END;

    PRIVATE MACRO B11():STRING // 
      var S = "";
      var Kind;
      var DataSet;
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if (m_Rs.MORTAGE_LEGALFORM == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, m_RS.MORTAGEID );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, m_RS.MORTAGEID );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
      end;

      return S;
    END;

    PRIVATE MACRO B12():STRING // 
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return m_RS.MORTAGE_TIN;
      end;
      return "";
    END;

    PRIVATE MACRO B13():MONEY // 
      var M = 0.0;
      var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if(  m_RS.INCOMETYPE == "Д" )
          M = 0.0;
        elif(  m_RS.INCOMETYPE == "П" )
          if (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED and (not isВыкуплен))
            M = m_Rs.T_TAXBASEAMOUNT - m_Rs.T_TAXAMOUNT;
          else
            M = m_Rs.T_BCCOST - m_Rs.T_PRINCIPAL - m_Rs.T_TAXAMOUNT;
            M = IIF(M > 0, M, 0);
          end;
        end;
      end;
      return M;
    END;

    PRIVATE MACRO B14():MONEY // 
      var M = 0.0;
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
var      Скн = 0,  ОсткБСчПр = 0;
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if(  m_RS.INCOMETYPE == "П" )
          if(not ПолучитьСуммуКНачисл_В( fd.GetBnr(), fd.GetLeg(), SQL_ConvTypeDate( m_Date ), @Скн, @ОсткБСчПр ))
            M = 0.0;
          else
            M = Скн + ОсткБСчПр;
          end;
        end;
      end;
      return M;
    END;

    PRIVATE MACRO B15():MONEY // 
      var M = 0.0;
      if(m_RS.T_PFI == NATCUR)
        M = B14();
      else
        ConvSum (M, money(B14()), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    PRIVATE MACRO B16():MONEY // 
      var M = 0.0;
      if(m_RS.T_PFI == NATCUR)
        M = B13();
      else
        ConvSum (M, money(B13()), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    PRIVATE MACRO B17():MONEY // 
      var M = 0.0;
      var НачПр = 0.0;
      var KНачПр = 0.0;
      RECORD prccontract (prccontract);
      var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if (isВыкуплен)
          M = m_RS.BCCOST_PFI;
          if(m_RS.INCOMETYPE == "Д")
            M = M +  A39();
          elif(m_RS.INCOMETYPE == "П")
            M = M +  A41();
          end;
        else
          M = m_Rs.T_PRINCIPAL;

          if(НайтиСчетПроцВекселя(prccontract, m_Rs.t_BCID, null, VS_FINDPC_ACTUAL) )
            if( not СуммаНачисленныхПроцентовПоПДВекселя(prccontract.ContractID, prccontract.BeginDate, SQL_ConvTypeDate(m_Date), НачПр) )
            elif(not ПроцентыКНачислениюПоПДВекселя(prccontract.ContractID, VS_GetRightPcDate(prccontract, SQL_ConvTypeDate(m_Date)), KНачПр))
            end;
          end;
          M = M + НачПр + KНачПр;
        end;
      end;
      return M;
    end;

    PRIVATE MACRO B18():MONEY // 
      var M = 0.0;
      var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");

      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        if(  m_RS.INCOMETYPE == "Д" )
          if (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED and (not isВыкуплен))
            M = m_Rs.T_PRINCIPAL - m_Rs.T_TAXAMOUNT;
          else
            M = m_Rs.T_BCCOST - m_Rs.T_TAXAMOUNT;
          end;
        elif(  m_RS.INCOMETYPE == "П" )
          if (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED and (not isВыкуплен))
            M = m_Rs.T_PRINCIPAL + m_Rs.T_TAXBASEAMOUNT - m_Rs.T_TAXAMOUNT;
          else
            M = m_Rs.T_BCCOST - m_Rs.T_TAXAMOUNT;
          end;
        else
          M = m_Rs.T_PRINCIPAL;
        end;
      end;
      return M;
    END;


    PRIVATE MACRO B19():STRING //
      var paym;
      var S = "";
      var bankPaym = TRecHandler( "party.dbt" );
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        paym = MyRsbPayment(m_Rs.t_DocKind, m_Rs.t_ContractId, PM_PURP_VEKSELDRAW, 0);
        if (m_Rs.MORTAGEID == paym.PAYER)
          S = "р/с " + paym.PAYERACCOUNT;
          S = S + " к/с " + paym.GetDEBET().rec.CorrAcc;
          S = S + " БИК " + paym.GetDEBET().rec.BANKCODE;

          if( ПолучитьСубъекта( paym.PAYERBANKID, bankPaym ) == 0 )
            S = S + " " + bankPaym.rec.ShortName;
          end;
        else
          S = "р/с " + paym.RECEIVERACCOUNT;
          S = S + " к/с " + paym.GetCREDIT().rec.CorrAcc;
          S = S + " БИК " + paym.GetCREDIT().rec.BANKCODE;

          if( ПолучитьСубъекта( paym.RECEIVERBANKID, bankPaym ) == 0 )
            S = S + " " + bankPaym.rec.ShortName;
          end;
        end;
      end;
      return S;
    END;

    PRIVATE MACRO B20():INTEGER
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        return SQL_ConvTypeDate(m_Rs.T_CHANGEDATE) - SQL_ConvTypeDate( m_RS.T_ISSUEDATE );
      end;
      return "";
    END;

    PRIVATE MACRO B21():STRING
      var isВыкуплен = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Л");
      if ((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED) OR isВыкуплен)        
        var c365:double = 0, c366:double = 0;
        var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        var Скн = $0, ОсткБСчПр = $0;

        GetDaysCoef(SQL_ConvTypeDate(m_Rs.T_CHANGEDATE),A26(), @c365, @c366);
        if ((c365+c366) == 0)
          return 0;
        end;
        if ( m_RS.INCOMETYPE == "П" )
          ПолучитьСуммуКНачисл_В( FD.GetBnr(), FD.GetLeg(), A26(), @Скн, @ОсткБСчПр );
        end;

        return (((A16() + Скн + ОсткБСчПр)/m_Rs.T_BCCOST - 1)/(c365 + c366)) * 100;
      end;
      return "";
    END;
    
    PRIVATE MACRO PrintMode():INTEGER
        return DL_OUTREPORT_EXCEL;
    END;

    PRIVATE MACRO CReport_DataExist()
        return m_NRecs > 0;
    END;

    PRIVATE MACRO CReport_NoDataMsg()
        msgbox( "Нет данных для формирования отчета" );
    END;

    PRIVATE MACRO GetViewName( Name ) // возвращает имя представления
        return StrUpr( String( "v", {oper}, Name ) );
    END;

    PRIVATE MACRO DropViewIfExist( Name )
        VAR ViewName = GetViewName( Name );
        SQL_Drop( " DROP VIEW " + ViewName + " " );
        return ViewName;
    END;

    PRIVATE MACRO CreateView_OnPeriod( Name:STRING )
        VAR ViewName = DropViewIfExist( Name );
        var Cond = "";
        var Cond2 = "";
        

        if (m_BeginDate < m_EndDate)
           Cond =" AND " + IIF((m_Repay == SET_CHAR), "(t_NewABCStatus in ( " + VSBANNER_STATUS_PRESENTED +" , "
             + VSBANNER_STATUS_REDEEMED  + " , " + VSBANNER_STATUS_ENDED
             + " )", " ") 
             + IIF(((m_Prep == SET_CHAR) and (m_Repay == SET_CHAR)), " OR " , IIF((m_Repay == SET_CHAR), " ) ", " ( ")) 
             + IIF((m_Prep == SET_CHAR), " (t_NewABCStatus = " + VSBANNER_STATUS_SENDED + " AND t_OldABCStatus <> " + VSBANNER_STATUS_PAWN + " )) " , " ") ;
          Cond = Cond + " AND t_ChangeDate >= " + GetSQLDate( m_BeginDate ) 
                      + " AND t_ChangeDate <= " + GetSQLDate( m_EndDate );
        elif (m_BeginDate == m_EndDate)
          Cond = " AND (t_NewABCStatus in ( " + VSBANNER_STATUS_PRESENTED +" , "
             + VSBANNER_STATUS_REDEEMED  + " , " + VSBANNER_STATUS_ENDED
             + " )" + " OR (t_NewABCStatus = " + VSBANNER_STATUS_SENDED + " AND t_OldABCStatus <> " + VSBANNER_STATUS_PAWN + " )) " 
             + " AND t_ChangeDate <= " + GetSQLDate( m_BeginDate );
          Cond2 = " AND vsbnrbck.t_NewABCStatus in ( " + VSBANNER_STATUS_SENDED+" )";
        end;


        SQL_Execute(  "CREATE VIEW " + ViewName
                    + " AS "
                    + "   SELECT vsbnrbck.t_ID, "
                    + "          vsbnrbck.t_BCID, "
                    + "          vsbnrbck.t_ChangeDate, "
                    + "          vsbnrbck.t_OldABCStatus, "
                    + "          vsbnrbck.t_NewABCStatus "
                    + "     FROM dvsbnrbck_dbt vsbnrbck "
                    + "    WHERE vsbnrbck.t_id = "
                    + "             (SELECT * "
                    + "                FROM (  SELECT t_ID "
                    + "                          FROM dvsbnrbck_dbt "
                    + "                         WHERE     t_bcid = vsbnrbck.t_bcid "
                    + "                               AND t_BCStatus = 'X' "
                    + "                               AND t_OldABCStatus <> t_NewABCStatus "
                    +                                 Cond
                    + "                      ORDER BY t_ChangeDate DESC, t_id DESC) "
                    + "               WHERE ROWNUM = 1) "
                    + Cond2);


        return ViewName;
    END;

    PRIVATE MACRO GetDataQuery()
        VAR Q;

        Q = CreateView_OnPeriod("vsb_attr_own"); 
        

        m_DataQuery = "SELECT A.T_BCID, "
        + "       C1.T_PARTYID HOLDER, "
        + "NVL ( (SELECT T_SHORTNAME "
        + "                FROM DPARTY_DBT PAR "
        + "               WHERE     PAR.T_PARTYID = B.T_ISSUER ), "
        + "            '') "
        + "          BRANCH_NAME, "
        + "NVL ( (SELECT T_NAME "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.T_PARTYID = B.T_ISSUER ), "
        + "            '') "
        + "          BRANCH_CODE, "
        + "       '0' || SUBSTR((  SELECT T_NAME "
        + "                        FROM DDP_DEP_DBT "
        + "                       WHERE T_CODE = B.T_DEPARTMENT), 1, 2) || '-' || lpad(B.T_BRANCH, 3, '0') "
        + "          VSP_CODE, "
        + "       C1.T_SHORTNAME HOLDERNAME, "
        + "       (CASE "
        + "           WHEN C1.T_NOTRESIDENT <> 'X' "
        + "           THEN "
        + "              RSI_RSBPARTY.GETPARTYCODE (C1.T_PARTYID, 16) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "       INN, "
        + "       RSI_RSBPARTY.GETPARTYCODE (B.T_HOLDER, 27) OGRN, "
        + "       C1.T_NOTRESIDENT HOLDER_RES, "
        + "       (CASE "
        + "           WHEN C1.T_NRCOUNTRY <> CHR (0) AND C1.T_NRCOUNTRY IS NOT NULL "
        + "           THEN "
        + "              (SELECT T_CODENUM3 "
        + "                 FROM DCOUNTRY_DBT DC "
        + "                WHERE DC.T_CODELAT3 = C1.T_NRCOUNTRY) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "          OKSM, "
        + "       C1.T_LEGALFORM HOLDER_LEGALFORM, "
        + "       (CASE "
        + "           WHEN C1.T_NOTRESIDENT = 'X' "
        + "           THEN "
        + "              RSI_RSBPARTY.GETPARTYCODE (C1.T_PARTYID, 62) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "          TIN, "
        + "       B.T_BRANCH, "
        + "       B.T_BCSERIES, "
        + "       B.T_BCNUMBER, "
        + "       B.T_ISSUEPLACE, "
        + "       B.T_ISSUEDATE, "
        + "       (CASE "
        + "          WHEN H.T_DOCKIND = " + DL_ORDER_VSINTERCHANGE 
        + "                                 AND H.T_LINKKIND = " + VSORDLNK_K_EMISSION
        + "           THEN "
        + "              H.T_BCCOST "
        + "           ELSE "
        + "              (SELECT VSORDLNK.T_BCCOST "
        + "                 FROM DVSORDLNK_DBT VSORDLNK "
        + "                WHERE     T_BCID = B.T_BCID "
        + "                      AND VSORDLNK.T_DOCKIND = " + DL_ORDER_VSINTERCHANGE
        + "                      AND T_LINKKIND = " + VSORDLNK_K_EMISSION
        + "                                        ) "
        + "        END) "
        + "          BCCOST_PFI, "
        + "       B.T_BCTERMFORMULA, "
        + "       B.T_BCPRESENTATIONDATE, "
        + "       D.T_MATURITY, "
        + "       D.T_START, "
        + "       D.T_DIFF, "
        + "       D.T_BASIS, "
        + "       D.T_EXPIRY, "
        + "       D.T_PRINCIPAL, "
        + "       D.T_RECEIPTAMOUNT, "
        + "       D.T_FORMULA, "
        + "       D.T_PRICE, "
        + "       D.T_DEALID, "
        + "       D.T_CLOSED, "
        + "       H.T_BCCOST, "
        + "       H.T_TAXBASEAMOUNT, "
        + "       H.T_TAXAMOUNT, "
        + "       D.T_PFI, "
        + "       (SELECT T_CCY "
        + "          FROM DFININSTR_DBT "
        + "         WHERE T_FIID = D.T_PFI) "
        + "          CURRENCY, "
        + "       CASE "
        + "          WHEN D.T_FORMULA = 1 "
        + "          THEN "
        + "             'П' "
        + "          WHEN D.T_FORMULA = 0 AND D.T_PRINCIPAL - D.T_RECEIPTAMOUNT <> 0 "
        + "          THEN "
        + "             'Д' "
        + "          ELSE "
        + "             'Б' "
        + "       END "
        + "          INCOMETYPE, "
        + "       D.T_DURATION, "
        + "       C2.T_SHORTNAME MORTAGE_NAME, "
        + "       (CASE "
        + "           WHEN C2.T_NOTRESIDENT <> 'X' "
        + "           THEN "
        + "              RSI_RSBPARTY.GETPARTYCODE (C2.T_PARTYID, 16) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "       MORTAGE_INN, "
        + "       RSI_RSBPARTY.GETPARTYCODE (G.T_CONTRACTOR, 27) MORTAGE_OGRN, "
        + "       (CASE "
        + "           WHEN C2.T_NRCOUNTRY <> CHR (0) AND C2.T_NRCOUNTRY IS NOT NULL "
        + "           THEN "
        + "              (SELECT T_CODENUM3 "
        + "                 FROM DCOUNTRY_DBT DC "
        + "                WHERE DC.T_CODELAT3 = C2.T_NRCOUNTRY) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "          MORTAGE_OKSM, "
        + "       C2.T_NOTRESIDENT MORTAGE_RES, "
        + "       C2.T_LEGALFORM MORTAGE_LEGALFORM, "
        + "       (CASE "
        + "           WHEN C2.T_NOTRESIDENT = 'X' "
        + "           THEN "
        + "              RSI_RSBPARTY.GETPARTYCODE (C2.T_PARTYID, 62) "
        + "           ELSE "
        + "              '' "
        + "        END) "
        + "          MORTAGE_TIN, "
        + "       (CASE "
        + "           WHEN D.T_FORMULA IN ( " + VS_IN_S_PC
        + "                                 , " + VS_IN_M_PC
        + "                                    , " + VS_IN_DISC_PC
        + "                                       ) AND D.T_PRICE > 0 "
        + "           THEN "
        + "              D.T_PRICE / POWER (10, D.T_POINT) "
        + "           ELSE "
        + "              0 "
        + "        END) "
        + "          RATE, "
        + "       A.T_NEWABCSTATUS, "
        + "       A.T_OLDABCSTATUS, "
        + "       A.T_CHANGEDATE, "
        + "       G.T_ORDERNUMBER, "
        + "       G.T_CREATEDATE, "
        + "       G.T_DOCKIND , "
        + "       G.T_CONTRACTID , "
        + "       C2.T_PARTYID MORTAGEID, "
        + "        NVL((SELECT t_shortname "
        + "           FROM dparty_dbt dp "
        + "          WHERE dp.t_partyid = (SELECT t_partyid "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.T_CODE = G.T_DEPARTMENT )), '') "
        + "           DEP_NAME, "
        + "NVL ( (SELECT T_NAME "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.t_CODE = G.T_DEPARTMENT ), "
        + "            '') "
        + "          DEP_CODE, "
        + "       (SELECT SPGR.T_XLD "
        + "          FROM DSPGROUND_DBT SPGR "
        + "         WHERE SPGR.T_SPGROUNDID = G.T_GROUND) "
        + "          GROUNDCODE, "
        + "       F.T_KIND_OPERATION "
        + "  FROM " + Q + " A, "
        + "       DVSBANNER_DBT B, "
        + "       DPARTY_DBT C1, "
        + "       DPARTY_DBT C2, "
        + "       DDL_LEG_DBT D, "
        + "       DOPRDOCS_DBT E, "
        + "       DOPROPER_DBT F, "
        + "       DDL_ORDER_DBT G, "
        + "       DVSORDLNK_DBT H "
        + " WHERE     LPAD (A.T_ID, 10, '0') = E.T_DOCUMENTID "
        + "       AND E.T_DOCKIND = " + DL_VSBNRBCK 
        + "       AND E.T_ID_OPERATION = F.T_ID_OPERATION "
        + "       AND F.T_DOCKIND in (" + DL_VEKSELDRAWORDER + " , " + DL_VEKSELORDER + ", " + DL_VSBARTERORDER +" ) "
        + "       AND F.T_DOCUMENTID = LPAD (G.T_CONTRACTID, 10, '0') "
        + "       AND A.T_BCID = B.T_BCID "
        + "       AND B.T_BCID = D.T_DEALID "
        + "       AND D.T_LEGKIND = " + LEG_KIND_VSBANNER 
        + "       AND G.T_CONTRACTID = H.T_CONTRACTID "
        + "       AND A.T_BCID = H.T_BCID "
        + "       AND C1.T_PARTYID = B.T_HOLDER "
        + "       AND C2.T_PARTYID = G.T_CONTRACTOR ";
    END;

    PRIVATE MACRO ClearDataQuery()
        DropViewIfExist( "vsb_attr_pawn" );
    END;

    PRIVATE MACRO BeginReport( NumCopy:INTEGER )
        Dl_CallInsertStat( PrintMode() );

        m_BeginDate = m_Form.GetFieldValue( PNFLD_REGBNR_BEGINDATE );
        m_EndDate   = m_Form.GetFieldValue( PNFLD_REGBNR_ENDDATE );
        m_Prep   = m_Form.GetFieldValue( PNFLD_REGBNR_PREP );
        m_Repay  = m_Form.GetFieldValue( PNFLD_REGBNR_REPAY );

        GetDataQuery();
        m_NRecs = SQL_GetNRecs( m_DataQuery );

        if( CReport_DataExist() )
            SetActiveSheet( "Собственные векселя" );
            CreateTotalBook();
        end;
    END;

    PRIVATE MACRO PrintLine(  )
      m_Date = m_EndDate;
      if((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED))
        m_Date = m_Rs.T_CHANGEDATE;
      end;
      A12_13();
      A22_23_42_43();
      Find_PawnHolder();
      
      PrintTableLine(  "N1_A1", A1(), null,
                    "N1_A2", A2(), null,
                    "N1_A2_1", A2_1(), null,
                    "N1_A3", A3(), null,
                    "N1_A4", A4(), null,
                    "N1_A5", A5(), null,
                    "N1_A6", A6(), null,
                    "N1_A7", A7(), null,
                    "N1_A8", A8(), null,
                    "N1_A10", A10(), null,
                    "N1_A11", A11(), null,
                    "N1_A12", m_A12, null,
                    "N1_A13", String(Date(m_A13):f), null,
                    "N1_A14", A14(), null,
                    "N1_A15", String(Date(A15()):f), null,
                    "N1_A16", A16(), null,
                    "N1_A17", A17(), null,
                    "N1_A18", A18(), null,
                    "N1_A19", A19(), null,
                    "N1_A20", A20(), null,
                    "N1_A21", A21(), null,
                    "N1_A22", m_A22, null,
                    "N1_A23", m_A23, null,
                    "N1_A24", A24(), null,
                    "N1_A25", A25(), null,
                    "N1_A26", String(Date(A26()):f), null,
                    "N1_A27", String(Date(A27()):f), null,
                    "N1_A28", String(Date(A28()):f), null,
                    "N1_A29", A29(), null,
                    "N1_A30", A30(), null,
                    "N1_A31", A31(), null,
                    "N1_A32", A32(), null,
                    "N1_A33", A33(), null,
                    "N1_A34", A34(), null,
                    "N1_A35", A35(), null,
                    "N1_A36", A36(), null,
                    "N1_A37", A37(), null,
                    "N1_A38", A38(), null,
                    "N1_A39", A39(), null,
                    "N1_A40", A40(), null,
                    "N1_A41", A41(), null,
                    "N1_A42", m_A42, null,
                    "N1_A43", m_A43, null,
                    "N1_A44", A44(), null,
                    "N1_A45", A45(), null,
                    "N1_A46", A46(), null,
                    "N1_A47", A47(), null,
                    "N1_A48", A48(), null,
                    "N1_A49", A49(), null,
                    "N1_A50", A50(), null,
                    "N1_A51", A51(), null,
                    "N1_A52", A52(), null,
                    "N1_A53", A53(), null,
                    "N1_A54", A54(), null,
                    "N1_A55", A55(), null,
                    "N1_B1",  String(Date(B1()):f), null,
                    "N1_B2",  B2(), null,
                    "N1_B3",  B3(), null,
                    "N1_B4",  iif((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED), m_A42,""), null,
                    "N1_B5",  iif((m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_ENDED) OR (m_Rs.T_NEWABCSTATUS == VSBANNER_STATUS_REDEEMED), m_A43,""), null,
                    "N1_B6",  B6(), null,
                    "N1_B7",  B7(), null,
                    "N1_B8",  B8(), null,
                    "N1_B9",  B9(), null,
                    "N1_B10", B10(), null,
                    "N1_B11", B11(), null,
                    "N1_B12", B12(), null,
                    "N1_B13", B13(), null,
                    "N1_B14", B14(), null,
                    "N1_B15", B15(), null,
                    "N1_B16", B16(), null,
                    "N1_B17", B17(), null,
                    "N1_B18", B18(), null,
                    "N1_B19", B19(), null,
                    "N1_B20", B20(), null,
                    "N1_B21", B21(), null
                     );

    END;

    PRIVATE MACRO Create( NumCopy:INTEGER )
        VAR RecordCount = 0;

        if( CReport_DataExist() )
            InitProgress( m_NRecs, "Идет формирование отчета", "Собственные векселя" );

            m_RS = TRsbDataSet( m_DataQuery );
            while( m_RS.MoveNext() )
                if( RecordCount == 0 )
                    CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_TableHeader", 0, m_CurrSheetName, true );
                    RegisterTable( "N1_TableData", null,
                                   "N1_A1", "N1_A2", "N1_A2_1", "N1_A3", "N1_A4", "N1_A5", "N1_A6", "N1_A7", "N1_A8", "N1_A9",
                                   "N1_A10", "N1_A11", "N1_A12", "N1_A13", "N1_A14", "N1_A15",
                                   "N1_A16", "N1_A17", "N1_A18", "N1_A19", "N1_A20", "N1_A21", "N1_A22", "N1_A23",
                                   "N1_A24", "N1_A25", "N1_A26", "N1_A27", "N1_A28", "N1_A29", "N1_A30", "N1_A31", "N1_A32", "N1_A33", 
                                   "N1_A34", "N1_A35", "N1_A36", "N1_A37", "N1_A38", "N1_A39", "N1_A40", "N1_A41", "N1_A42", "N1_A43", "N1_A44",
                                   "N1_A45", "N1_A46", "N1_A47", "N1_A48", "N1_A49", "N1_A50", "N1_A51", "N1_A52", "N1_A53", "N1_A54", "N1_A55",
                                   "N1_B1",  "N1_B2",  "N1_B3",  "N1_B4",  "N1_B5",  "N1_B6",  "N1_B7",  "N1_B8",  "N1_B9",  "N1_B10", "N1_B11", 
                                   "N1_B12", "N1_B13", "N1_B14", "N1_B15", "N1_B16", "N1_B17", "N1_B18", "N1_B19", "N1_B20", "N1_B21");
                end;

                PrintLine();
                UseProgress( RecordCount = RecordCount + 1 );
            end;

            EndTable();
            CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );

            RemProgress();
        end;
    END;

    PRIVATE MACRO EndReport( NumCopy:INTEGER )
        if( CReport_DataExist() )
            SaveTotalBook();
        end;
        ClearDataQuery();
    END;

    initDL_CReportTemplate( VS_BnrAttr_Own_Panel(), "report_attr_own.xls" );
END;

VS_BnrAttr_Own().Run();
exit( 1 );
