/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vsi155pr.mac
                                vs-вексель
                                 i-операция эмиссии векселей (issue)
                               155-номер (соответствующий шагу)
                                pr-prepare
  Операция    : Эмиссия векселя
  Шаг         : Подготовка выдачи векселя с хранения.
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT InsCarryDoc, OprInter, vsdates;

/*  АЛГОРИТМ ШАГА:
     1. Запросить системную дату "Выдача с хранения векселей" у пользователя 
           в панели диалога для ввода даты выдачи векселя с хранения. 
        Сообщение в панели: "Введите дату выдачи векселя с хранения". 
        Поле дата необходимо проинициализировать датой сдачи на хранения векселя + 1 день. 
        При вводе осуществить проверку "Сдача на хранение векселей" <= ДатеВыдачи.
     2. Завершить шаг.
*/

/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order)
var stat=0, ToDepositDate, NewDate,
    day, month, year, Ok = false,
    err_msg = "Дата выдачи векселя с хранения должна быть|больше или равна";

    GetOprDate( DATE_EMI_TODEPOSIT, @ToDepositDate );
    NewDate = DateAfterWorkDays( ToDepositDate, 1 );

    if( ToDepositDate > {curdate} )
       MsgBox ("Преждевременное выполнение шага запрещено.");
       return 1;
    end;

    while( not Ok )
       Ok = false;
       if ( not GetDate( NewDate, "Введите дату выдачи векселя с хранения" ) )
          stat = 1; Ok = true;
       elif(ToDepositDate > NewDate)
          DateSplit(ToDepositDate, day, month, year);
          msgbox(string(err_msg, " ", day:2:o, ".", month:2:o, ".", year:4));
          NewDate = DateAfterWorkDays( ToDepositDate, 1 );
       elif(not IsWorkDay(NewDate))
          msgbox("Дата выдачи векселя с хранения должна быть рабочим днем");
          NewDate = DateAfterWorkDays( NewDate, 0 );
       else
          if(OprReplanStepPlanDates( DATE_EMI_FROMDEPOSIT, NewDate ) == false) // Дата выдачи с хранения
             stat = 1;
          end;
//          DefineOprDate( DATE_EMI_FROMDEPOSIT, NewDate );  /* Дата выдачи с хранения */
          Ok = true;
       end;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

//    Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, мем.Ордера */
 
    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

//    Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, мем.Ордера */

    return 1;
END;


