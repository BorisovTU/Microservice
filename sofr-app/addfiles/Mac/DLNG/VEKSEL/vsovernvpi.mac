/*
$Name:         vsovernvpi.mac
$Module:       Векселя банка
$Description:  Переоценка счетов учета по векселю, связанная с применением НВПИ
*/
IMPORT VSInter, Проценты, vscateg, vsrep, vsconv;

PRIVATE MACRO Проводка_А(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("-ПереоценкаА", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("Наш вексель", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, Сумма,
        String("Расход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               1 /*дебет в нац.вал.*/)
      )
    return false;
  end;

  return true;
END;


PRIVATE MACRO Проводка_Б(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("Наш вексель", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("+ПереоценкаА", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, abs(Сумма),
        String("Доход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               2 /*дебет в ВУ*/)
      )
    return false;
  end;

  return true;
END;


PRIVATE MACRO Проводка_В(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("-ПереоценкаА", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("Обяз%,СВексель", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, Сумма,
        String("Расход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               1 /*дебет в нац.вал.*/)
      )
    return false;
  end;

  return true;
END;


PRIVATE MACRO Проводка_Г(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("Обяз%,СВексель", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("+ПереоценкаА", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, abs(Сумма),
        String("Доход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               2 /*дебет в ВУ*/)
      )
    return false;
  end;

  return true;
END;


PRIVATE MACRO Проводка_Д(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("-ПереоценкаА", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("Дисконт, Свексель", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, abs(Сумма),
        String("Расход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               1 /*дебет в нац.вал.*/)
      )
    return false;
  end;

  return true;
END;


PRIVATE MACRO Проводка_Е(fd, EDate, vDate, Сумма, ВалУч)
var 
  СчетДебет,
  СчетКредит;

  if (not ПолучитьСчетВекселя ("Дисконт, Свексель", fd, СчетДебет, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (not ПолучитьСчетВекселя ("+ПереоценкаА", fd, СчетКредит, MC_OPENACC_CREATE, null, null, vDate))
    return false;
  end;

  if (Проводка(СчетДебет, СчетКредит, abs(Сумма),
        String("Доход от применения НВПИ по векселю ", НашБанк(),
               " сер. ", fd.GetBnr().rec.BCSeries,
               " N ", trim(fd.GetBnr().rec.BCNumber),
               ", выданного ",fd.GetBnr().rec.HolderName,
               ", за ", vDate),
               null, null,
               ВалУч, null, null,
               EDate, null, 
               2 /*дебет в ВУ*/)
      )
    return false;
  end;

  return true;
END;


/* Выполнить переоценкц счетов учета по векселю, связанная с применением НВПИ
*/
MACRO ВыполнитьПереоценкуНВПИ( BCID, VDate, EDate, ВалУч, fd )
var 
  err = true,
  НомерСчета, ДатаНачислДиск,
  СпереоцНом, СновНом, СстНом,
  СуммаПроцентов, СпереоцПрц, СновПрц, СстПрц, КонвОстПрц,
  СчетДисконта, СпереоцДиск, СновДиск, СстДиск, КонвОстДиск;
  
  RECORD prccontract (prccontract);

  if( (ValType(fd) == V_UNDEF) or (fd == null) )
    fd = VSBannerFD (DL_VSBANNER, BCID);

    if (fd == null)
      msgbox ("Ошибка при определении счета");
      return false;
    end;
  end;

  if( ВалУч == fd.GetParametr(MC_TYPE_PARAMETR_CURRENCY) )
    return true; /* *переоценка не требуется */
  end;

  /* 1. Выполним переоценку номинала. */
  if(not ПолучитьСчетВекселя("Наш вексель", fd, НомерСчета, NULL, NULL, NULL, VDate))
    return false;
  elif(not ПолучитьОстаток(СстНом, НомерСчета, ВалУч, VDate))
    return false;
  end;

  СновНом     = VS_Convert( fd.GetLeg().rec.Principal, VDate, fd.GetParametr(MC_TYPE_PARAMETR_CURRENCY), ВалУч );
  СпереоцНом  = СновНом - СстНом;

  if  ( СпереоцНом > 0.0 )
    err = Проводка_А(fd, EDate, VDate, СпереоцНом, ВалУч);
  elif( СпереоцНом < 0.0 )
    err = Проводка_Б(fd, EDate, VDate, СпереоцНом, ВалУч);
  end;

  /* 2. Если вексель процентный или процентно-дисконтный, выполним переоценку процентов */
  if( err )
    if( ВексельПроцентный( fd.GetLeg()) )
      if(not ПолучитьСчетВекселя("Обяз%,СВексель", fd, НомерСчета, NULL, NULL, NULL, VDate))
        return false;
      elif(not ПолучитьОстаток(СстПрц, НомерСчета, ВалУч, VDate))
        return false;
      end;
        
      if(НайтиСчетПроцВекселя(prccontract, BCID) )
        if( not СуммаНачисленныхПроцентовПоПДВекселя(prccontract.ContractID, prccontract.BeginDate, VDate, СуммаПроцентов) )
            msgbox ( "Ошибка при вычислении суммы к начислению." );
            return false;
        end;
      else
        СуммаПроцентов = 0.0;
      end;
       
      //конвертируем остаток в ВУ по курсу на текущую дату
      СновПрц = VS_Convert( СуммаПроцентов, VDate, fd.GetParametr(MC_TYPE_PARAMETR_CURRENCY), ВалУч );
      СпереоцПрц = СновПрц - СстПрц;
      
      if  ( СновПрц > СстПрц )
        err = Проводка_В(fd, EDate, VDate, СпереоцПрц, ВалУч);
      elif( СновПрц < СстПрц )
        err = Проводка_Г(fd, EDate, VDate, СпереоцПрц, ВалУч);
      end;
    end;
  end;

  
  /* 3. Если вексель дисконтный или процентно-дисконтный, выполним переоценку дисконта */
  if( err )
    if( ВексельДисконтный( fd.GetLeg()) )
      if(not ПолучитьСчетВекселя("Дисконт, Свексель", fd, СчетДисконта, NULL, NULL, NULL, VDate))
         return false;
      elif(not ПолучитьОстаток(СстДиск, СчетДисконта, ВалУч, VDate))
         return false;
      end;

      /*конвертируем остаток в рубли по курсу на дату последней переоценки*/
      if( not ПолучитьДатуПоследПроводки(ДатаНачислДиск, СчетДисконта, ВалУч) )
        ДатаНачислДиск = ПолучитьДатуПоследОперацииПоВекселю( fd.GetBnr().rec, fd.GetLeg().rec, VDate );
      end;

      КонвОстДиск = VS_Convert( СстДиск, ДатаНачислДиск, ВалУч, fd.GetParametr(MC_TYPE_PARAMETR_CURRENCY) );
      /*конвертируем остаток в ВУ по курсу на текущую дату */
      СновДиск = VS_Convert( КонвОстДиск, VDate, fd.GetParametr(MC_TYPE_PARAMETR_CURRENCY), ВалУч );
      СпереоцДиск = СновДиск - СстДиск;
      
      if  ( abs(СновДиск) > abs(СстДиск) )
        err = Проводка_Е(fd, EDate, VDate, СпереоцДиск, ВалУч);
      elif( abs(СновДиск) < abs(СстДиск) )
        err = Проводка_Д(fd, EDate, VDate, СпереоцДиск, ВалУч);
      end;
    end;
  end;

  return true;
END;
