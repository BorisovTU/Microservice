/*
$Name:         vsaccclose.mac
$Module:       Векселя банка
$Description:  Закрытие счетов
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vsaccclose.mac
  Programmer  : Кастелин А.Н.
  Шаг         : Закрытие счетов
└───────────────────────────────────────────────────────────────────────────*/

IMPORT Vsbnrfd, vs4each, vsmulty, vslib;
import oralib, likepy, BankInter;

//Остаток счета в национальной валюте
private macro Rest_account_natcur (account, code_currency, chapter, restdate):money
  var rest:money = $0;
  var sql = ExecSqlSelect("select rsb_account.restall ( :acc, :chapter, :code_currency, :dt, 0) t_rest from dual",
                          MakeArray(SqlParam("acc", account), SqlParam("chapter", chapter), SqlParam("code_currency", code_currency), SqlParam("dt", restdate)));
  if (sql.MoveNext() ) 
    rest = sql.value("t_rest");
  end;
  return rest;
End;

/*CHVA*/
PRIVATE MACRO open_accounts(nameacc,account)
   var open_acc="";
   var cmd =DL_RSDCommand("select t_account, t_open_date from daccount_dbt where t_account like '%"+substr(account,15,20)+"' and t_balance like '523%' and t_account <>'"+account+"'and t_nameaccount like '"+nameacc+"%' order by t_balance asc");
   
   var DataSet = cmd.execute();
   while (DataSet.moveNext())
      open_acc = DataSet.t_account; 
   end;
   return open_acc;
END;
/*CHVA 528138*/
private macro ВыполнитьПереоценкуПоСчету (Account, currency, closedate)
  var rest = $0;
  if (currency != NATCUR)
    rest = Rest_account_natcur(account, currency, 1, closedate);
    if (rest != $0)
      OverValueAccount(Account, currency, 1, closedate);
    end;
  end;
End;

PRIVATE MACRO DoCloseAcc(fd, categ, fi, closeDate, firole)
/*CHVA 528138*/
var exists_open_acc = "";
var err="";
var nameaccount ="";

var acc,
    stat = true;

    if ((acc = MC_GetExistAccount(categ, fd.kind, fd.id, FIROLE_UNDEF, fi, closeDate)) != "")
        if (RestAMulty(acc, fi) == $0)
            ВыполнитьПереоценкуПоСчету(acc, fi, closeDate); //Simanov. если рублевый остаток не нулевой, выполняется переоценка
            if (MC_FindAndCloseAccount(categ, fd, closeDate, firole/*Simanov*/, fi, MC_ACC_CLOSE_INDIVIDUAL) != 0)
                stat = false;
            end;   
/*CHVA 528138*/ 
            if ((categ == "Наш вексель" ) or (categ == "Дисконт, Свексель"))     //при погашении для категорий Наш вексель и Дисконт, Свексель необходимо закрывать все счета открытые до счета "До восстребования" 52307-52301
             if (categ == "Наш вексель" )
               nameaccount = "Вексель";
             else
               nameaccount = "Дисконт. Вексель";
             end;
             exists_open_acc = open_accounts(nameaccount,acc);
               if ((exists_open_acc != "") and (RestAMulty(exists_open_acc, fi) == $0)) /*PNV 531287*/
                ВыполнитьПереоценкуПоСчету(exists_open_acc, fi,GetDateAfterWorkDays(closeDate,-1)); 
                if(CB_CloseAccount (1, fi, exists_open_acc, closeDate,err));
                  MsgBox("Невозможно закрыть счет " + exists_open_acc+". " +err);
                  stat = false;
                end;
               end;
            end;
/********/
        end;
    end;

    return stat;
END;

PRIVATE MACRO CloseBillAccount(bnr, leg, emi, document, i, lnk, closeDate)
var bnr_fd,
    acc,
    stat = true;

    if ((bnr.rec.AccCode != "") and (bnr.rec.bcstatus == VSBANNER_STATUS_ENDED))
        bnr_fd = VSBannerFD(bnr, leg);
        if (
            (not DoCloseAcc(bnr_fd, "Наш вексель",              ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate)) or
            (not DoCloseAcc(bnr_fd, "СВексель к исполнению",    ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate)) or

            (not DoCloseAcc(bnr_fd, "Дисконт, СВексель к исп.", ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate)) or
            (not DoCloseAcc(bnr_fd, "Обяз%, СВексель к исп.",   ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate)) or

            (not DoCloseAcc(bnr_fd, "К погашению, Сц/б",        ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate)) or
            //Simanov
            (not DoCloseAcc(bnr_fd, "-Корр, Свексель",          NATCUR, closeDate)) or
            (not DoCloseAcc(bnr_fd, "+Корр, Свексель",          NATCUR, closeDate)) or
            (not DoCloseAcc(bnr_fd, "Дисконт, Свексель",        ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate, 43)) or

            (not DoCloseAcc(bnr_fd, "Обяз%,СВексель",           ОпределитьВалютуУчетаВекселя(bnr.rec.PayFIID, leg.rec.PFI), closeDate))
           )
            stat = false;
        end;
    end;

    if (stat)
        return 0;
    else
        return 1;
    end;
END;

PRIVATE MACRO CloseAccounts(document, closeDate)
var stat = true;

    if (ДляКаждогоВекселя(document, @CloseBillAccount, VSORDLNK_K_DRAW, closeDate, "BL", true /* IsParticular */) != 0)
        stat = false;
    end;

    return stat;
END;

MACRO ЗакрытьСчетаВекселя(document, closeDate)
var close = false,
    stat = true;

    if (stat = VS_GetRegistryValue("ВЕКСЕЛЯ БАНКА\\РЕЖИМ РАБОТЫ\\АВТОМАТИЧЕСКОЕ ЗАКРЫТИЕ ЛС", V_BOOL, @close))
        if (close)
            stat = CloseAccounts(document, closeDate);
        end;
    end;

    return stat;
END;

