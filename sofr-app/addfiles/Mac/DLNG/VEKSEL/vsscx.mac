/**
 @file 		vsscx.mac
 @brief 	договор хранения

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |29.12.2023 |Велигжанин А.В.|DEF-56486                                       |Оптимизация. Выражение GetGE() неэффективно без addFilter()
 |27.08.2001 |Азаренок Ю.    |                                                |CREATED
*/
Import BankInter, DealsInter, vslib, SFInter, vsordnum, vs4each, vsordchk;

RECORD ДоговорХранения (dl_order);
RECORD СтарыйДоговорХранения (dl_order);

MACRO ФункцияПользователя_ДоговорХранения (Режим)
    msgbox(String("Выполняется макрофункция с именем|",
                  "ФункцияПользователя,|",
                  "которая определена в файле|",
                  "vsscx.mac|",
                  "договор хранения"));
    return 0;
END;

MACRO Новый_ДоговорХранения ()
    return 0;
END;


PRIVATE MACRO ПроверитьСчетПлательщика()
 var ctr = TBfile("sfcontr.dbt"),
     bnr = TBfile ("vsbanner"),
     leg = TBfile ("dl_leg"),
     lnk = TBfile ("vsordlnk"),
     stat=0,Ok,DocID,BCID;

  VS_MakeDocumentID(ДоговорХранения,DocID,DL_VSSTORAGEORDER );

  lnk.keyNum=1;   /* Индекс ContractID+BCID*/
  lnk.rec.DocKind    = ДоговорХранения.DocKind;
  lnk.rec.ContractID = ДоговорХранения.ContractID;
  lnk.rec.Issuer = {OurBank};
  lnk.rec.BCID=0;
  lnk.addFilter("t_DocKind = " + string(ДоговорХранения.DocKind) + " and t_ContractID = " + string(ДоговорХранения.ContractID)); // DEF-56486, без добавления фильтра SELECT неэффективен
  Ok=lnk.GetGE;
  if (Ok)
    BCID=lnk.rec.BCID;
    if(not ПоискВекселя(bnr, BCID))
      return Ошибка("Не найден вексель ", BCID);
    elif (not ПоискЦеновыхУсловийВекселя(leg, BCID))
      return Ошибка("Не найдены ценовые условия векселя ",BCID);
    else 
      ctr.KeyNum = 1;
      ctr.rec.FIID = 0;              /* нац.валюта*/
      ctr.rec.objectType = SF_VSSTOR;
      ctr.rec.object = DocID;
      ctr.rec.ServKind = 8;          /* PTSK_SVO */
      Ok = ctr.GetEQ;

      if(not Ok)
        stat = Ошибка("Не найден договор обслуживания");
/*      elif (ctr.rec.AccountPayer == "")
        stat = Ошибка("Не указан счет плательщика");*/
      end;

    end;
  end;
  lnk.dropFilter(); // DEF-56486

 return stat;
END;


MACRO Проверить_ДоговорХранения (Режим)
 var stat=0;
  if ( Режим == OBJ_DELETE )    
    return 0;
  elif ( Режим == OBJ_UPDATE)
    if ( ПроверитьНомерДоговора(ДоговорХранения))
      return 1;
    elif ( ВажнИзмДог(СтарыйДоговорХранения, ДоговорХранения) )  
      return 1;
    end;
  elif ( Режим == OBJ_DELETEOPR)
    return 0;
  elif ( Режим == OBJ_INSNOTOPR)
    return ПроверитьНомерДоговора(ДоговорХранения);
  elif ( Режим == OBJ_STARTOPR)
    if(VS_CheckOrderStartOpr(ДоговорХранения) != 0)
       stat = 1;
    elif ( ПроверитьСчетПлательщика())
       stat = 1;
    else
       // Проверяет, был ли у векселя статус "оформлен" или "выдан" на дату подписания договора
       return ПроверитьСтатусВекселейНаДату( ДоговорХранения, VSBANNER_STATUS_FORMED, VSORDLNK_K_STORAGE );
    end;
  elif ( Режим == OBJ_COMPLETE)
    return 0; /* Возвращаемое значение не важно. Обработано не будет. */
  elif ( Режим == OBJ_NOTCOMPLETE)
    return 0; /* Возвращаемое значение не важно. Обработано не будет. */
  elif ( Режим == OBJ_AFTERINSERT)
    return VS_CheckOrderAfterInsert(ДоговорХранения);
  elif ( Режим == OBJ_AFTERUPDATE)
    return VS_CheckOrderAfterUpdate(ДоговорХранения);
  end;

    return stat;
END;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string

  //ScrolStatus
  //ORDER_CONTRACT_STATUS_ALL       = -1,      // любой
  //ORDER_CONTRACT_STATUS_PREP      = 0,       // отложенные
  //ORDER_CONTRACT_STATUS_OPENED    = 10,      // открытые
  //ORDER_CONTRACT_STATUS_CLOSED    = 20      // закрытые

  //пример
  if(TableName == "ddl_order_dbt")
    //return "/*+FIRST_ROWS LEADING(t) INDEX(t ddl_order_dbt_idx0)*/";
  end;

  return DefaultHint;

END;