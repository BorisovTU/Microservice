/*
$Name:         vssflib.mac
$Module:       Векселя банка
$Description:  Стандартные алгоритмы взимания комиссии
*/

Import SfInter, vs4each, vslib, VSInter;

private const SF_BASETYPE_SUM     = 1;      /* Сумма*/
private const SF_BASETYPE_QUONT   = 2;      /* Количество*/

record sfbassum( "sfbassum.str" );

PRIVATE var 
            Договор;

/* Определение базы начисления
*/
PRIVATE MACRO alg_1(bnr, leg, emi, order, i, lnk)
var
   stat = 0;

   if((leg.rec.Maturity - leg.rec.Start <= 15) and lnk.rec.IsPartycular) 

      ClearRecord(sfbassum);
      sfbassum.baseType = SF_BASETYPE_SUM;
      sfbassum.baseSum  = leg.rec.Principal;
      sfbassum.FIID_baseSum = leg.rec.PFI;
      sfbassum.baseType2 = SF_BASETYPE_SUM;   
      sfbassum.baseSum2  = leg.rec.Principal;
      sfbassum.FIID_baseSum2 = leg.rec.PFI;   
      stat = InsertSumList(sfbassum);
      if(stat != 0)
        MsgBox("Ошибка при вставке базовой суммы");
      end;
   end;                              
   
   return stat;
END;


/* Определение базы начисления
*/
PRIVATE MACRO alg_2(bnr, leg, emi, order, i, lnk)
var
   stat = 0;

   if((leg.rec.Maturity - leg.rec.Start > 15) and lnk.rec.IsPartycular) 
      ClearRecord(sfbassum);
      sfbassum.baseType = SF_BASETYPE_SUM;
      sfbassum.baseSum  = leg.rec.Principal;
      sfbassum.FIID_baseSum = leg.rec.PFI;
      sfbassum.baseType2 = SF_BASETYPE_SUM;
      sfbassum.baseSum2  = leg.rec.Principal;
      sfbassum.FIID_baseSum2 = leg.rec.PFI;
      stat = InsertSumList(sfbassum);
      if( stat != 0)
        MsgBox("Ошибка при вставке базовой суммы");
      end;
   end;
   
   return stat;
END;


/* Определение базы начисления
*/
PRIVATE MACRO alg_3(bnr, leg)
var
   HandingDate, otype,
   base = 0, stat = 0;

   if((otype = ValType(Договор)) == V_UNDEF)
     HandingDate     = {curdate};
   elif(otype == V_GENOBJ)
     HandingDate     = Договор.rec.HandingDate;
   else
     HandingDate     = Договор.HandingDate;
   end;

   if(VS_GetComBase (Договор, leg, HandingDate, base))
      if(base > 0)
         ClearRecord(sfbassum);
         sfbassum.baseType = SF_BASETYPE_SUM;
         sfbassum.baseSum  = base;
         sfbassum.FIID_baseSum = leg.rec.PFI;
         sfbassum.baseType2 = SF_BASETYPE_SUM;
         sfbassum.baseSum2  = base;
         sfbassum.FIID_baseSum2 = leg.rec.PFI;
         stat = InsertSumList(sfbassum);
         if( stat != 0)
           MsgBox("Ошибка при вставке базовой суммы");
         end;
      end;
   end;
   
   return stat;
END;


/* Определение базы начисления на основе:
     суммы досрочного погашения векселя (цена векселя по договору).
*/
PRIVATE MACRO alg_c(bnr, leg, emi, order, i, lnk)
var
   stat = 0;

   if(lnk.rec.BCCost != 0)
      ClearRecord(sfbassum);
      sfbassum.baseType = SF_BASETYPE_SUM;
      sfbassum.baseSum  = lnk.rec.BCCost;
      sfbassum.FIID_baseSum = leg.rec.PFI;
      sfbassum.baseType2 = SF_BASETYPE_SUM;
      sfbassum.baseSum2  = lnk.rec.BCCost;
      sfbassum.FIID_baseSum2 = leg.rec.PFI;
      stat = InsertSumList(sfbassum);
      if( stat != 0)
        MsgBox("Ошибка при вставке базовой суммы");
      end;
   end;

   return stat;
END;


/* Определение базы начисления на основе:
     размера дисконта.
*/
PRIVATE MACRO alg_d(bnr, leg, emi, order, i, lnk)
var
   stat = 0;

   if(ВексельДисконтный(leg))
      ClearRecord(sfbassum);
      sfbassum.baseType = SF_BASETYPE_SUM;
      sfbassum.baseSum  = leg.rec.Principal-leg.rec.ReceiptAmount;
      sfbassum.FIID_baseSum = leg.rec.PFI;
      sfbassum.baseType2 = SF_BASETYPE_SUM;
      sfbassum.baseSum2  = leg.rec.Principal-leg.rec.ReceiptAmount;
      sfbassum.FIID_baseSum2 = leg.rec.PFI;
      stat = InsertSumList(sfbassum);
      if( stat != 0)
        MsgBox("Ошибка при вставке базовой суммы");
      end;
   end;

   return stat;
END;


/* Определение базы начисления на основе:
     номинала.
*/
PRIVATE MACRO alg_n(bnr, leg, emi, order, i, lnk)
var
   stat = 0;

   if(leg.rec.Principal != 0)
      ClearRecord(sfbassum);
      sfbassum.baseType = SF_BASETYPE_SUM;
      sfbassum.baseSum  = leg.rec.Principal;
      sfbassum.FIID_baseSum = leg.rec.PFI;
      sfbassum.baseType2 = SF_BASETYPE_SUM;
      sfbassum.baseSum2  = leg.rec.Principal;
      sfbassum.FIID_baseSum2 = leg.rec.PFI;
      stat = InsertSumList(sfbassum);
      if( stat != 0)
        MsgBox("Ошибка при вставке базовой суммы");
      end;
   end;

   return stat;
END;


/* Определение базы начисления на основе:
     суммы начисленных %% по векселю.
*/
PRIVATE MACRO alg_p(bnr, leg, emi, order, i, lnk)
var
   base = 0, stat = 0;

   if(ВексельПроцентный(leg))
      if(not ПолучитьСуммуКНачисл_В(bnr, leg, lnk.rec.InterestChargeDate, @base))
         stat=1;
      elif(base != 0)
         ClearRecord(sfbassum);
         sfbassum.baseType = SF_BASETYPE_SUM;
         sfbassum.baseSum  = base;
         sfbassum.FIID_baseSum = leg.rec.PFI;
         sfbassum.baseType2 = SF_BASETYPE_SUM;
         sfbassum.baseSum2  = base;
         sfbassum.FIID_baseSum2 = leg.rec.PFI;
         stat = InsertSumList(sfbassum);
         if( stat != 0)
           MsgBox("Ошибка при вставке базовой суммы");
         end;
      end;
   end;

   return stat;
END;


/* Алгоритм 1
*/
MACRO vssf_1(ord)
   Договор = ord;
   ДляКаждогоВекселя(ord, @alg_1, VSORDLNK_K_EMISSION, null, "BL");
END;


/* Алгоритм 2
*/
MACRO vssf_2(ord)
   Договор = ord;
   ДляКаждогоВекселя(ord, @alg_2, VSORDLNK_K_EMISSION, null, "BL");
END;


/* Алгоритм 3
*/
MACRO vssf_3(ord)
   Договор = ord;
   ДляКаждогоВекселя(ord, @alg_3, VSORDLNK_K_ALL, null, "BL");
END;


/* Алгоритм 4
*/
MACRO vssf_4(ord, basis, role)
   Договор = ord;

   if(basis == "c")
      ДляКаждогоВекселя(ord, @alg_c, role, null, "L");
   elif(basis == "d")
      ДляКаждогоВекселя(ord, @alg_d, role, null, "L");
   elif(basis == "n")
      ДляКаждогоВекселя(ord, @alg_n, role, null, "L");
   elif(basis == "p")
      ДляКаждогоВекселя(ord, @alg_p, role, null, "BL");
   end;

END;
