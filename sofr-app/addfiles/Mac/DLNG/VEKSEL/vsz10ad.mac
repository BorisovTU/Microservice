/*
     $Name: vsz10ad.mac
     $Module: СВ
     $Description: Прием векселей в залог в другом филиале
*/

IMPORT OprInter, vsdates, vszlib;

PRIVATE VAR ОперацияЗалога = "";
PRIVATE record ord("dl_order");
PRIVATE VAR StepDate;

/* Принимает вексель в залог.
*/
PRIVATE MACRO ПриемВекселяВЗалогВДругФилиал(bnr, leg, emi, order, i, lnk, data:@variant, emiLnk)
var
    stat = 0;

    if ((stat == 0) and (data == false))
        if(bnr.rec.BCStatus != VSBANNER_STATUS_PAWN)
          if(not ИзменитьВексель(bnr.rec.BCID, StepDate,
                               "bcstatus", VSBANNER_STATUS_PAWN))
              stat = Ошибка("Ошибка при изменении векселя");
          end;
        end;
    end;

    return stat;
END;

/* Запуск шага
*/
MACRO ExecuteStep(docbuf, ordbuf)
var
    stat = 0, CABS = false;

    if(not VS_GetRegistryValue("ВЕКСЕЛЯ БАНКА\\РЕЖИМ РАБОТЫ\\CABS", V_BOOL, @CABS))
        CABS = false;
    end;

    SetBuff( ord, ordbuf );

    if(not VS_TestStepDate(DATE_PAWN_DOC, @StepDate, ord.SignDate))
        stat = 1;
    end;

    if(stat == 0)
        if(StepDate > {curdate})
            stat = Ошибка("Преждевременное выполнение шага запрещено");
        end;
    end;

    if(stat == 0)
        stat = ДляКаждогоВекселя(ord, @ПриемВекселяВЗалогВДругФилиал, null, @CABS, "BL");
    end;

    return stat;
END;


