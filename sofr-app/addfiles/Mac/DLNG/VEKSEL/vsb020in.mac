/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vsb020in.mac
                                vs-вексель
                                 b-операция мены векселей (barter)
                               020-номер (соответствующий шагу)
                                in-в настоящее время ничего не обозначает (осталось исторически)
  Programmer  : Велигжанин А.В.
  Операция    : Мена векселей
  Шаг         : Принять векселя в кассу?
└───────────────────────────────────────────────────────────────────────────*/
IMPORT VSInter, vscateg, vs4each;


/* Если встретился вексель для погашения (роль покупка и установлен "особая связь"),
     то останавливаем процесс.
*/
PRIVATE MACRO Test1(bnr, leg, emi, order, numOrd, lnk, yes:@variant)

   if (lnk.rec.IsPartycular == "X")
     yes = true;
     return 1;
   end;

   return 0;
END;


/* True, если у договора есть векселя для погашения
*/
PRIVATE MACRO ЕстьДляПогашения(order)
var
  yes = false;
  ДляКаждогоВекселя(order, @Test1, VSORDLNK_K_BUY, @yes, null);
  return yes;
END;


/* Если встретился вексель для выкупа (роль покупка и сброшен "особая связь"),
     то останавливаем процесс.      
*/
PRIVATE MACRO Test2(bnr, leg, emi, order, numOrd, lnk, no:@variant)

   if (lnk.rec.IsPartycular == "")
     no = false;
     return 1;
   end;

   return 0;
END;


/* True, если у договора нет векселей для выкупа
*/
PRIVATE MACRO НетДляВыкупа(order)
var
  no = true;
  ДляКаждогоВекселя(order, @Test2, VSORDLNK_K_BUY, @no, null);
  return no;
END;


/* Запуск шага
*/
MACRO ExecuteCaseStep(OperationKind, StepNumber, dl_order)

   record order(dl_order);
   SetBuff( order, dl_order );

   if(ЕстьДляПогашения(order))
     if(GetTrue(true, "Оформить прием погашаемых векселей в кассу ?"))
       return "37";   /* прием векселей в кассу */
     elif(НетДляВыкупа(order))
       return "40";   /* Оформление мены */
     end;
   end;

   return "30";   /* прием выкупаемых векселей в кассу */
END;


