/*
  vsnotes.mac
*/
import BankInter, globals, oralib;

class VSNotes(bnrID:integer)
  private var notes;

  private const storageNoteKind:integer = 23;

  private macro GetDocId(bnrID:integer):integer
    var query = "select f.t_ficertid "
              + "  from dficert_dbt f "
              + " where f.t_certid = :bcid";
    var sql = execSQLselectPrmDyn(query, bnrID);
    if (sql.MoveNext())
      return sql.value("t_ficertid");
    end;
    return 0;
  end;

  private macro Init(bnrID:integer)
    var docID = GetDocId(bnrID);
    notes = RsbObjNotes(24, string(docID:10:o));
  end;

  private macro Save(noteKind:integer, noteValue:string, dt:date):bool
    var error;
    error = notes.AddNote(noteKind, noteValue, dt);
    if(error == 0)
      error = notes.Save();
    end;

    return error == 0;
  end;

  private macro Delete(noteKind:integer):bool
    var error;
    error = notes.DelNote(noteKind);
    if(error == 0)
      error = notes.Save();
    end;

    return error == 0;
  end;

  macro SaveStorage(value:string):bool
    return Save(storageNoteKind, value, {curdate});
  end;

  macro ClearStorage():bool
    return Delete(storageNoteKind);
  end;

  Init(bnrID);
end;