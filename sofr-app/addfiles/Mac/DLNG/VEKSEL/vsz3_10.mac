/*
$Name:         vsz3_10.mac
$Module:       Векселя банка
$Description:  Залог векселей. Снятие векселей c залога. Снятие векселя с залога
*/

IMPORT OprInter, vsdates, vszlib;

PRIVATE record ord("dl_order");

PRIVATE VAR StepDate;

PRIVATE MACRO ВыдатьСнятыйВексель(bnr, leg)
var
    stat = 0;

    if(not VSZLIB_ПроводкаЗалога("выдача снятого", ord, bnr, leg, StepDate))
        stat = 1;
    end;

    if(stat == 0)
        if(not ИзменитьВексель(bnr.rec.BCID, StepDate,
                              "bcstatus", VSBANNER_STATUS_SENDED))
            stat = Ошибка("Ошибка при изменении векселя");
        end;
    end;

    return stat;
END;

PRIVATE MACRO Снять_вексель (bnr, leg)
    if(bnr.rec.BCStatus != VSBANNER_STATUS_PAWN)
        Ошибка("Вексель " + VSZLIB_СерияНомерВекселя(bnr) + "| не в залоге");
        return 1;
    end;

    if (not VSZLIB_ПроводкаЗалога("снятие", ord, bnr, leg, StepDate))
        return 1;
    end;

    return 0;
END;

MACRO ExecuteStep(docbuf, ordbuf)
    var stat = 0;

    SetBuff( ord, ordbuf );

    if(not VS_TestStepDate(DATE_PAWN_DOC, @StepDate, ord.SignDate))
       stat = 1;
    end;

    if (stat == 0)
        stat = ДляКаждогоВекселя(ord, @Снять_вексель, null, null, "BL");
    end;

    if(stat == 0)
        stat = ДляКаждогоВекселя(ord, @ВыдатьСнятыйВексель, null, null, "BL");
    end;

    return stat;
END;
