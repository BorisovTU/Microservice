/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vsfmofd.mac
  Comment     : Š« áá ¤®ªã¬¥­â®¢ "à á¯®àï¦¥­¨ï ¯® ¡« ­ª ¬ ¢¥ªá¥«¥©"
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
IMPORT FIInter, CTInter, OprInter, DealsInter, PTInter, VSInter, globals, mctplprm;

MACRO GetPerson( OperID )
    var person = TBfile("person.dbt");
    person.KeyNum = 0;
    person.Clear();
    person.rec.Oper = OperID;
    if ( not person.GetEQ() )
      MsgBox("¥ ¬®£ã ­ ©â¨ ®¯¥à â®à  á ­®¬¥à®¬: ", OperID );
      return -1;
    end;
    return person.rec.PartyID;
END;


/*Š« áá ¤®ªã¬¥­â®¢ "‚¥ªá¥«ì­ë¥ ¤®£®¢®à "
*/
CLASS VSFrmOrdFD (fmo_prm1, fmo_prm2)
    PRIVATE VAR
        ParmA = TArray,
        fmo = TBfile("vsfrmord.dbt"),
        FIRoleBArray = TArray;
    VAR
        /*á­®¢­ë¥ á¢®©áâ¢ */
        Error = 0, kind, id;

    PRIVATE MACRO InitParmArray
        ParmA[MC_TYPE_PARAMETR_DOCKIND] = DL_VSFRMORD;
        ParmA[MC_TYPE_PARAMETR_DOCID] = fmo.rec.FrmOrdId;
        ParmA[MC_TYPE_PARAMETR_OWNER] = fmo.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_PARTY] = fmo.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_CONTRACTOR] = fmo.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_PLACE] = 0;
        ParmA[MC_TYPE_PARAMETR_BEGDATE] = fmo.rec.Signed;
        ParmA[MC_TYPE_PARAMETR_FINDATE] = date (0,0,0);
        ParmA[MC_TYPE_PARAMETR_VALDATE] = fmo.rec.Signed;
        ParmA[MC_TYPE_PARAMETR_ISSUER] = {OurBank};
        ParmA[MC_TYPE_PARAMETR_FIID] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_CURRENCY] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_NUMBER] = fmo.rec.DocNumber;
        ParmA[MC_TYPE_PARAMETR_SENIORNUMBER] = "";
        ParmA[MC_TYPE_PARAMETR_DEPARTMENT] = fmo.rec.Department;
        FIRoleBArray[0] = FIROLE_FIDOC;
        FIRoleBArray[1] = FIROLE_CORACC_PASSIVE;
        FIRoleBArray[2] = FIROLE_CORACC_ACTIVE;
    END;

    /*®«ãç¨âì ¯ à ¬¥âàë*/
    MACRO GetParametr (ParmKind, OperDate, CatCode, FIRole)
        VAR 
            Parametr = ParmA[ParmKind];

        if (Parametr==null) 
            Parametr = -1;
        end;

        if(ParmKind == MC_TYPE_PARAMETR_CENTR)
            if ( CatCode == "« ­ª¨„«ï á¯à.,‘æ/¡" )
              Parametr = GetPerson( fmo.rec.Oper );  // PartyID ¯®¤®âç¥â­®£® «¨æ 
            else
              Parametr = fmo.rec.ResponsPerson;  // PartyID ¯®¤®âç¥â­®£® «¨æ 
            end;

            if(Parametr == -1)
               Parametr = {OurBank};
            end;
             
        end;
        
        return Parametr;
    END;

    /* ãáâ ­®¢¨âì ¯ à ¬¥âà */
    MACRO SetParametr (ParmKind, value)
    var
       old = -1;

       if( (ParmKind >= 0) and (ParmKind < ParmA.size) )
           old = ParmA[ParmKind];
           ParmA[ParmKind] = value;
       end;

       return old;
    END;

    MACRO GetParametrTemplate
    ( 
        ObjectID,       /* ¯ à ¬¥âà - ­®¬¥à á¯à ¢®ç­¨ª  */
        Classificator,  /* ª« áá¨ä¨ª â®à - ­®¬¥à ª« áá¨ä¨ª â®à , ¥á«¨ ®­ § ¤ ­ */
        OperDate,
        FIRole
    )

        if (ObjectID == OBJTYPE_VALUETYPE)              /*1111 - ¢¨¤ æ¥­­®áâ¨ */
            if (Classificator == LLCLASS_VALUE_CLS_SAVE)               // 155 - ¢¨¤ æ¥­­®áâ¨ § ªà. åà ­¥­¨ï
               return 1; /* à®áâ®© ¢¥ªá¥«ì */
            end;

        elif (ObjectID == OBJTYPE_SIDEBALANCE)          /*1000 - á¯à ¢®ç­¨ª áâ®à®­ ¡ « ­á */
            if (Classificator == LLCLASS_SIDEBALANCE_CORACCKIND)       // 1622 - ‚¨¤ ª®àà¥á¯®­¤¨àãîé¥£® áç¥â 

               if(FIRole == FIROLE_CORACC_PASSIVE)
                  return 2; //  áá¨¢­ë©
               elif(FIRole == FIROLE_CORACC_ACTIVE)
                  return 1; // €ªâ¨¢­ë©
               end;

            end;
        end;

        return -1;
    END;

    MACRO GetBasisFIRole(FIRole)
      var i = 0;
      if (FIRole == FIROLE_UNDEF)
        return FIROLE_FIDOC;
      end;
      while (i < FIRoleBArray.Size)
        if (FIRoleBArray[i] == FIRole)
          return FIRole;
        end;
        i = i + 1;
      end;
      Error = 1;
      return FIROLE_UNDEF;
    END;

    MACRO GetFIRoleBArray()
      return FIRoleBArray;
    END;

    /*Œ ªà®á ª®àà¥ªâ¨à®¢ª¨ ®âªàë¢ ¥¬®£® áç¥â . Account, accblnc, ORScheme ¬®¦­® ¬¥­ïâì*/
    MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
      return true;
    END;

    if ((valtype(fmo_prm1) == v_integer) and (valtype(fmo_prm2) == v_integer))
        //ª®­áâàãªâ®à ¯® ID à á¯®àï¦¥­¨ï
        if (fmo_prm1 != DL_VSFRMORD)
            RunError ("­¥¢¥à­ë© ¯¥à¢¨ç­ë© ¤®ªã¬¥­â");
        end;

        fmo.KeyNum = 0;
        fmo.Clear();
        fmo.rec.FrmOrdId = fmo_prm2;
        if (not fmo.GetEQ())
            RunError ("­¥ ­ ©¤¥­® à á¯®àï¦¥­¨¥ ¯® ¡« ­ª ¬ ID = " + fmo_prm2);
        end;
    else
        //ª®­áâàãªâ®à ¯® ®¡ê¥ªâã à á¯®àï¦¥­¨ï
        if (not copy(fmo, fmo_prm1))
            RunError ("­¥¢¥à­ë© ¢ë§®¢ ª®­áâàãªâ®à ");
        end;
    end;

    InitParmArray ();

    Kind = ParmA[MC_TYPE_PARAMETR_DOCKIND];
    Id = ParmA[MC_TYPE_PARAMETR_DOCID];
END;
