/*
$Name:         vsscm.mac
$Module:       Векселя банка
$Description:  Пользовательский макрос скроллинга договора Мены
*/

Import BankInter, DealsInter, vsordnum, vslib, vs4each, vsordchk;

RECORD ДоговорМены (dl_order);
RECORD СтарыйДоговорМены (dl_order);

MACRO ФункцияПользователя_ДоговорМены (Режим)
    msgbox(String("Выполняется макрофункция с именем|",
                  "ФункцияПользователя,|",
                  "которая определена в файле|",
                  "vsscm.mac|",
                  "договор мены"));
    return 0;
END;

MACRO Новый_ДоговорМены ()
    return 0;
END;

PRIVATE VAR
    err_bcnumber,
    err_bcseries;

PRIVATE MACRO ПроверитьКорректностьЦеныВекселя(bnr, leg)
var stat = 0;
    // Проверка вынесенная из С (о том что цена проджи не больше номинала) #92908
    if (leg.rec.RECEIPTAMOUNT > leg.rec.PRINCIPAL)
      stat = 1;
    end;

    if (stat)
        err_bcnumber    = bnr.rec.BCNumber;
        err_bcseries    = bnr.rec.BCSeries;
    end;
    return stat;
END;

PRIVATE MACRO ПроверитьКорректностьЦеныВекселей(order)
var stat = 0;
    stat = ДляКаждогоВекселя(order, @ПроверитьКорректностьЦеныВекселя, VSORDLNK_K_EMISSION, null, "BL");
    if (stat)
       msgbox(string("Некорректная цена продажи. |Цена продажи векселя серия ",
                      err_bcseries," N ",trim(err_bcnumber), "  больше номинала."));
    end;
    return stat;
END;

MACRO Проверить_ДоговорМены(Режим)
var stat=0;

  if ( Режим == OBJ_DELETE )
    return 0;
  elif ( Режим == OBJ_UPDATE)
    if ( ПроверитьНомерДоговора(ДоговорМены))
      return 1;
    elif ( ВажнИзмДог(СтарыйДоговорМены, ДоговорМены) )
      return 1;
    end;
  elif ( Режим == OBJ_DELETEOPR)
    return 0;
  elif ( Режим == OBJ_INSNOTOPR)
    return ПроверитьНомерДоговора(ДоговорМены);
  elif ( Режим == OBJ_STARTOPR)
    if(VS_CheckOrderStartOpr(ДоговорМены) != 0)
       return 1;
    elif(not VS_CheckBadBCState(ДоговорМены, VSORDLNK_K_DRAW, "Х"))
       // проверка, чтобы погашаемые векселя не были на хранении
       stat = 1;
     elif (ПроверитьКорректностьЦеныВекселей(ДоговорМены))
       return 1;
    else
       // Проверяет, был ли у векселя статус "оформлен" или "выдан" на дату подписания договора
       stat = ПроверитьСтатусВекселейНаДату( ДоговорМены, VSBANNER_STATUS_FORMED, VSORDLNK_K_DRAW );
    end;
  elif ( Режим == OBJ_COMPLETE)
    return 0;/* Возвращаемое значение не важно. Обработано не будет. */
  elif ( Режим == OBJ_NOTCOMPLETE)
    return 0;/* Возвращаемое значение не важно. Обработано не будет. */
  elif ( Режим == OBJ_AFTERINSERT)
    return VS_CheckOrderAfterInsert(ДоговорМены);
  elif ( Режим == OBJ_AFTERUPDATE)
    return VS_CheckOrderAfterUpdate(ДоговорМены);
  end;

  return stat;
END;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string

  //ScrolStatus
  //ORDER_CONTRACT_STATUS_ALL       = -1,      // любой
  //ORDER_CONTRACT_STATUS_PREP      = 0,       // отложенные
  //ORDER_CONTRACT_STATUS_OPENED    = 10,      // открытые
  //ORDER_CONTRACT_STATUS_CLOSED    = 20      // закрытые

  //пример
  if(TableName == "ddl_order_dbt")
    //return "/*+FIRST_ROWS LEADING(t) INDEX(t ddl_order_dbt_idx0)*/";
  end;

  return DefaultHint;

END;
