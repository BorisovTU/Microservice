/*
$Name:         vsrepay8.mac
$Module:       Векселя банка
$Description:  Списание с подотчета погашенных векселей. Вытащены из vsrepay2.mac
Simanov убраны лишние проводки
*/

IMPORT vsbnrfd, vscateg, vs4each, vslib;

PRIVATE VAR Договор, ДогПД, ContractorName;

/* Проводка по выдаче ценностей под отчет
*/
PRIVATE MACRO СписаниеВекселяСПодотчета(bnr, leg, emi, order, numOrd, lnk, ДатаСписания:@variant)
var
    СчетДебет, СчетКредит, СчетПодОтчет, stat = 0,
    ВексПД = VSBannerFD(bnr, leg),
    at = VS_AccTrans,
    ВалУч = ВексПД.ОпределитьВалютуУчета();

    ВексПД.SetParametr(MC_TYPE_PARAMETR_DEPARTMENT, Договор.Department);

    return stat; //Simanov

    if (lnk.rec.IsPartycular == "X")

        at.date_carry   = ДатаСписания;
        at.FDPayer      = ВексПД;
        at.FDReceiver   = ДогПД;
        at.PrimaryDoc   = ДогПД; // ???
        //at.CatPayer     = "ВнебалСчетКорресп";
        at.CatPayer     = "Разн.ценности и документы";
        at.CatReceiver  = "Разн.цен. и док. подотчет";
        //at.FiRolePayer  = FIROLE_CORACC_ACTIVE;
        at.FIIDPayer    = NATCUR;
        at.FIIDReceiver = NATCUR;
        at.SumReceiver  = $1.0;
        at.Ground       = String("Снять с подотчета ", ИмяОператора({oper}),
                          " вексель ", НашБанк(),
                          " сер. ", bnr.rec.BCSeries,
                          " № ", trim(bnr.rec.BCNumber),
                          ", выданный ", ContractorName,
                          " в связи с погашением.");
        at.Chapter      = 3;
        if ((FileName(order) == "dl_order.dbt") and (order.DocKind == DL_VSBARTERORDER) ) // СВ, мена
           at.Shifr_Oper     = "18";
        end;


        if (not at.carry())
            stat = Ошибка("Ошибка при выполнении",
                          "|проводки по списанию векселя",
                          "|с подотчета");
        end;

        if (not stat)
          if(not ПолучитьСчетВекселя("ВнебалСчетКорресп", ДогПД, СчетДебет, MC_OPENACC_CREATE, null, null, ДатаСписания, FIROLE_CORACC_ACTIVE))
              stat=1;
          elif(not ПолучитьСчетВекселя("К погашению, Сц/б", ВексПД, СчетКредит, MC_OPENACC_CREATE, ВалУч, null, ДатаСписания))
              stat=1;
          elif(not ПолучитьСчетВекселя("Разн.ценности и документы", ВексПД, СчетПодОтчет, MC_OPENACC_CREATE, ВалУч, null, ДатаСписания))
              stat=1;
          elif(Проводка(  СчетДебет,
                          СчетКредит,
                          VS_Convert( leg.rec.Principal, ДатаСписания, leg.rec.PFI, ВалУч ),
                          String("Вексель ", НашБанк(),
                                  " сер. ", bnr.rec.BCSeries,
                                  " № ", trim(bnr.rec.BCNumber),
                                  ", выданного ", ContractorName,
                                  ". Получил ", ИмяОператора({oper})),
                          0,                             /* Платеж                 */
                          0,
                          ВалУч,                         /* Валюта проводки        */
                          3,                             /* Глава: внебаланс       */
                          null,
                          ДатаСписания,
                          null,
                          1,                             /*дебет в нац.вал.*/
                          null,
                          null,
                          ""
          ) != 0)
              stat = Ошибка("Ошибка при выполнении",
                              "|проводки по выдаче ценностей",
                              "|под отчет");
          elif(Проводка(  СчетДебет,
                          СчетПодОтчет,
                          $1.0,
                          String("Вексель ", НашБанк(),
                                  " сер. ", bnr.rec.BCSeries,
                                  " № ", trim(bnr.rec.BCNumber),
                                  ", списание ранее выданного. "),
                          0,
                          0,
                          NATCUR,
                          3,
                          null,
                          ДатаСписания,
                          null,
                          1,
                          null,
                          null,
                          ""
          ) != 0)
              stat = Ошибка("Ошибка при выполнении",
                              "|проводки по списанию");
          end;
        end;
    end;
    return stat;
END;

/*  Производит проводку по каждому векселю
    списание векселя с подотчета
    При вызове из УВ в ПД и ContrName передаются первичный док-т "Сделка с УВ" и имя к-агента.
*/
MACRO СписаниеПогашенныхВекселей(order, Дата, ПД, ContrName)
var stat = 0;

   ПоУмолчанию(Дата, {curdate});

   if(ValType(ПД) == V_UNDEF)
      ПД = VSOrderFD(order);
   end;
   ДогПД = ПД;
   Договор = order;

   if(ValType(ContrName) == V_UNDEF)
      ContrName = order.ContractorName;
   end;
   ContractorName = ContrName;

   stat = ДляКаждогоВекселя(order, @СписаниеВекселяСПодотчета, VSORDLNK_K_DRAW, @Дата, "BL");

   return (stat == 0);
END;
