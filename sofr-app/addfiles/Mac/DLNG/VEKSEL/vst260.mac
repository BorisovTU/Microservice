/*
$Name:          vst260.mac
$Module:        Векселя банка
$Description:   Сопровождение векселя. б.Вывод векселя из Стоп-листа

                vs-вексель
                 t-операция сопровождения векселя
               260-номер (соответствующий шагу)
*/

IMPORT OprInter, VSInter, vscateg;

VAR srvdoc = 0; /* В эту переменную будет передан сервисный документ начисления
               (TRecHandler, структура vssrvdoc) */

PRIVATE RECORD bnr(vsbanner);

//getBCStateCh(srvdoc)
//hasBCStateBlocked(bnr)

MACRO ExecuteStep(Buffer, FirstDoc)
var
    stat = 0;

    SetBuff(bnr, FirstDoc);

//    if(Index(bnr.BCState, "Б") == 0)
      if( hasBCStateBlocked(bnr.BCState) == false )
        stat = Ошибка("Вексель не заблокирован");
    end;

    if(stat == 0)
        var bcstat = "Б";
          hasBCStateBlocked(bnr.BCState,@bcstat);

        if(not ИзменитьВексель(bnr.BCID, srvdoc.rec.ValueDate,
                                 "rmbcstate", bcstat))
            stat = Ошибка("Ошибка при снятии признака",
                          "|состояния векселя",
                            "|", GetTypeAc(170, bcstat), ".");
        end;
    end;

    if(stat == 0)
        if(not ИзменитьВексель(bnr.BCID, srvdoc.rec.ValueDate,
                               "addbcstate", "Щ"))
            stat = Ошибка("Ошибка при установке признака",
                          "|состояния векселя",
                          "|", GetTypeAc(170, "Щ"), ".");
        end;
    end;

    return stat;
END;

/* Макрос печати
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;
