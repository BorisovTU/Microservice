/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vsdates.mac
  Операция    :
  Comment     : Константы для операции
└───────────────────────────────────────────────────────────────────────────*/
IMPORT OprInter, Календарь, globals; // см. #68582

/* системные номера видов дат в операциях эмиссии, погашения, продажи,
   зачета требований
*/
CONST 
   DATE_EMI_PAY         = 1, /* Дата оплаты */
   DATE_EMI_HANDOVER    = 2, /* Дата выдачи векселей */
   DATE_EMI_TODEPOSIT   = 3, /* Дата сдачи на хранение */
   DATE_EMI_FROMDEPOSIT = 4, /* Дата выдачи с хранения */
   DATE_EMI_DOC         = 5; /* Дата проводки документов */

/* системные номера видов дат в операции зачета требований
*/
CONST 
   DATE_ORD_PAY         = 1, /* Дата оплаты */
   DATE_ORD_DOC         = 2; /* Дата проводки документов */

/* системные номера видов дат в операции хранения */
CONST 
   DATE_STOR_FROMDEPOSIT = 1, /* Дата выдачи с хранения */
   DATE_STOR_DOC         = 2; /* Дата проводки документа */

/* системные номера видов дат в операции мены 
   (все как в эмиссии, но есть лишняя дата - получение векселя) 
*/
CONST 
   DATE_BART_PAY         = 1, /* Платеж по векселю */
   DATE_BART_HANDOVER    = 2, /* Вручение векселей */
   DATE_BART_TODEPOSIT   = 3, /* Дата сдачи на хранение */
   DATE_BART_FROMDEPOSIT = 4, /* Дата выдачи с хранения */
   DATE_BART_GET         = 5, /* Получение векселей */
   DATE_BART_DOC         = 6; /* Дата проводки документов */


/* Погашение
*/
CONST
   DATE_REP_PAY         = 1, /* Выполнение платежа */
   DATE_REP_DOC         = 2; /* Дата проводки документа */

/* Выкуп
*/
CONST
   DATE_RED_DOC         = 2; /* Дата проводки документа */

/* Залог
*/
CONST
   DATE_PAWN_DOC        = 1; /* Дата проводки документа */

/* Продажа
*/
CONST
   DATE_SALE_DOC        = 5; /* Дата проводки документа */

/* Зачет требований
*/
CONST
   DATE_IC_DOC          = 2; /* Дата проводки документа */

/* Погашение векселя в другом филиале
*/
CONST
   DATE_RPP_DOC         = 1; /* Дата проводки документа */

/* Операции с бланками векселей
*/
CONST
   DATE_BLNK_DOC         = 1; /* Дата проводки документа */


/* Получает дату шага и корректирует ее с учетом выходных дней
*/
MACRO VS_GetWorkOprDate(NumberKD)
VAR
  d;

  GetOprDate( NumberKD, @d );
  return GetDateAfterWorkDays(d, 0);
END;

/* Тестирует дату шага
*/
MACRO VS_TestStepDate(NumberKD, StepDate:@date, SignDate, str)

 var day, month, year, s_day, s_month, s_year;

   StepDate = VS_GetWorkOprDate(NumberKD);

   if({curdate} < StepDate)
      msgbox("Преждевременное выполнение шага запрещено.");
      return false;
   end;

   if(ValType(SignDate) != V_DATE)
      /* дата не передана, больше проверок нет */
      return true;
   end;

   /* а если дата передана, проверяем также, чтобы шаг не выполнялся прежде даты подписания договора */
   if(StepDate < SignDate)
      if(ValType(str) != V_STRING)
        str = " даты подписания договора ";
      end;
      DateSplit(SignDate, day, month, year);
      DateSplit(StepDate, s_day, s_month, s_year);
      msgbox(string("Дата шага ", s_day:2:o, ".", s_month:2:o, ".", s_year:4:o, 
                    "|раньше", str, day:2:o, ".", month:2:o, ".", year:4:o));
      return false;
   end;

   return true;
END;

