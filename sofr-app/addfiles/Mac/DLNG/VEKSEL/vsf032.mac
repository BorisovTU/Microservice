/*
$Name:         vsf032.mac
$Module:       Собственные векселя
$Description:  Шаг "Расчет налога" операции "Погашение собственных векселей банка, выданных другим филиалом"
*/

IMPORT OprInter, vscateg, vsrep, vsrepay7, vsdates, "vsnptxcalcfun.mac";

PRIVATE MACRO IsPartyResident(PartyID)
  var party = TBFile("party");
  party.KeyNum = 0;
  party.rec.PartyID = PartyID;
  if (GetEQ(party))
    if (party.rec.NotResident)
      return false;
    else
      return true;
    end;
  end;
END;


/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order, DocKind, ID_Operation, ID_Step)
var
    StepDate, stat = 0,
    ErrStr = "";
    var НОБ_опер = $0, НОБ_30 = $0, НОБ_13 = $0, НОБ_15 = $0, taxe = $0, taxe15 = $0;
    var Year;
    var TxArr = TArray();
    var CorrTxArr = TArray();
    var specTag = null;

    record order( dl_order );
    SetBuff( order, dl_order );

    VS_CurrIDOperation = ID_Operation;
    VS_CurrIDStep      = ID_Step;

    if (IsUseNewNOB(order.SignDate))
      specTag = "ВЕКС";
    end;

    DateSplit(order.SignDate, null, null, Year);

    if (IsUseProgressScale(order.Signdate))
      var retData = CalcTaxSTB_VekselPRGS_AndGetTaxHold(order);

      TxArr = retData.TaxHoldArr;
      НОБ_опер = retData.НОБ_опер;
      
      STB_ExecuteCorrOnStepPRGS(order.Contractor, Year, false, TxArr, order.DocKind, order.ContractID, order.Signdate, НОБ_опер, НОБ_опер, @CorrTxArr, null, null, null, null, specTag, "C");

      ДляКаждогоВекселя(order, @ClearVekselFormValues, VSORDLNK_K_DRAW, null, null);  
      retData.FillBnrData();
    else
      CalcTaxSTB_Veksel(order, @НОБ_опер, @НОБ_30, @НОБ_13, @НОБ_15, @taxe, @taxe15);
  
      STB_ExecuteCorrOnStep(НОБ_опер, НОБ_опер, НОБ_30, НОБ_13, НОБ_15, @taxe, @taxe15, order.DocKind, order.ContractID, order.Signdate, false, order.Contractor, Year, @CorrTxArr);
  
      if(IsPartyResident(order.Contractor))
        TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT*100),
                                          НОБ_13, 
                                          taxe);
  
        TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                          НОБ_15, 
                                          taxe15);
      else
        TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_NOTRESIDENT*100),
                                          НОБ_30, 
                                          taxe);
      end;
    end;

    if((not stat) and (CorrTxArr.size))

      stat = STB_ExecuteCreateSTBOnStep(CorrTxArr,
                                        $0, 
                                        order.DocKind, 
                                        order.ContractID, 
                                        order.Contractor, 
                                        order.Signdate, 
                                        false, 
                                        Year, 
                                        ID_Operation, 
                                        ID_Step, 
                                        @ErrStr,
                                        NULL,
                                        NULL,
                                        $0,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        NULL,
                                        specTag);
      if(ErrStr)
        msgbox(ErrStr);
      end;
    end;
  
    stat = STB_ExecuteCreateSTBOnStep(TxArr,
                                      НОБ_опер,
                                      order.DocKind, 
                                      order.ContractID, 
                                      order.Contractor, 
                                      order.Signdate, 
                                      false, 
                                      Year, 
                                      ID_Operation, 
                                      ID_Step, 
                                      @ErrStr,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      specTag
                                      );


    if(stat)
      if(ErrStr)
        msgBox(ErrStr);
      end;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */


    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;


