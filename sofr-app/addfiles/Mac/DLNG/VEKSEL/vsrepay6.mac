/*
$Name:         vsrepay6.mac
$Module:       Векселя банка
$Description:  Погашение векселя. Общая часть по погашению векселей, выполняемая в операциях погашения и мены
*/

IMPORT vs4each, vslib;

/* Устанавливает для векселя признак, что он находится на погашении или на выкупе
*/
MACRO УстПризнакНаПогаш(bnr, lnk, Дата)
    var stat = 0, rmState = bnr.rec.BCState, newState = "";

    rmState = StrSubst(rmState, "И", "");
    rmState = StrSubst(rmState, "С", "");

    if(not ИзменитьВексель(bnr.rec.BCID, Дата,
                           "rmbcstate", rmState))
        stat = Ошибка("Ошибка при изменении векселя");
    end;

    if(stat == 0)
        if(lnk.rec.IsPartycular == "X")
            newState = "П";
        else
            newState = "В";
        end;

        if(not ИзменитьВексель(bnr.rec.BCID, Дата,
                               "addbcstate", newState))
            stat = Ошибка("Ошибка при установке признака",
                          "|состояния векселя",
                          "|", GetTypeAc(170, newState), ".");
        end;
    end;

    return stat;
END;

/* Устанавливает для векселя признак, что он находится на погашении или на выкупе
*/
PRIVATE MACRO УстПризнакДляВекселя(bnr, leg, emi, order, numOrd, lnk, Дата:@date)
    var stat = 0;

    stat = УстПризнакНаПогаш(bnr, lnk, Дата);

    return stat;
END;

/* Устанавливает для векселей признак, что они находится на погашении или на выкупе
*/
MACRO ИнициализацияПогашения(order, Дата)
    var stat = 0;

    stat = ДляКаждогоВекселя(order, @УстПризнакДляВекселя, VSORDLNK_K_DRAW, @Дата, "B");

    return (stat == 0);
END;
