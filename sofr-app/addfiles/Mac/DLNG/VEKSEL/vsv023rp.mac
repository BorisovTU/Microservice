/*
$Name:         vsv023rp.mac
$Module:       Собственные векселя
$Description:  Шаг "Передача записи для хранилища" операции "Выкуп собственных векселей банка"
*/

IMPORT OprInter, vscateg, vsrep, vsrepay7, vsdates;

/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_order, DocKind, ID_Operation, ID_Step)
var
    StepDate, stat = 0,
    ErrStr = "";
    var NeedLoopStep = false;

    record order( dl_order );
    SetBuff( order, dl_order );

    VS_CurrIDOperation = ID_Operation;
    VS_CurrIDStep      = ID_Step;

    stat = STB_ExecuteSendToStorOnStep(order.DocKind, order.ContractID, ID_Operation, ID_Step, @NeedLoopStep, @ErrStr);

    if(stat)
      if(ErrStr)
        msgBox(ErrStr);
      end;
    end;

    if(not stat)
      stat = DL_NPTX_SaveTbMes();
      if(not stat)
        if((NeedLoopStep == true))
          if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_ZPHR, VS_OPERSTATUS_VSDEALS_ENDED_RUN)) //Формирование и передача записи в хран. = Выполнить
            msgBox( "Ошибка при установке статуса вида \"Формирование и передача записи в хран.\" операции" );
            return 1;
          end;
          /*Принудительная вставка блока по символу*/
          Opr_InsertBranch("F", OPRBR_PARALLEL, true);
        else
          if( not InsertOprStatus(VS_OPERSTATUS_VSDEALS_ENDED_ZPHR, VS_OPERSTATUS_VSDEALS_ENDED_COMPLETE)) //Формирование и передача записи в хран. = Завершить
            msgBox( "Ошибка при установке статуса вида \"Формирование и передача записи в хран.\" операции" );
            return 1;
          end;
          if( not InsertOprStatus(1104, 1)) //Завершение шагов операции = Выполнить
            msgBox( "Ошибка при установке статуса вида \"Завершение шагов операции\" операции" );
            return 1;
          end;
          /*Принудительная вставка блока по символу*/
          Opr_InsertBranch("E", OPRBR_PARALLEL, true);
        end;
      end;
    end;

  return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */
  record order(dl_order);
  var ErrStr = "";
  var err = 0;

  SetBuff( order, FirstDoc );

  if(CommitOrRollback == 2)
    err = STB_RollbackSendToStorOnStep(order.DocKind, order.ContractID, ID_Operation, ID_Step, @ErrStr);
    if(ErrStr != "")
      msgbox(ErrStr);
    end;
  end;

    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;


