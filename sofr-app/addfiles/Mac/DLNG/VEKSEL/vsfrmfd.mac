/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vsfrmfd.mac
  Comment     : Š« áá ¤®ªã¬¥­â®¢ "¡« ­ª ¢¥ªá¥«ï"
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
IMPORT FIInter, CTInter, OprInter, DealsInter, PTInter, VSInter, globals, mctplprm;


PRIVATE MACRO GetPerson( OperID )
    var person = TBfile("person.dbt");
    person.KeyNum = 0;
    person.Clear();
    person.rec.Oper = OperID;
    if ( not person.GetEQ() )
      MsgBox("¥ ¬®£ã ­ ©â¨ ®¯¥à â®à  á ­®¬¥à®¬: ", OperID );
      return -1;
    end;
    
    return person.rec.PartyID;
END;


/*Š« áá ¤®ªã¬¥­â®¢ "« ­ª ‚¥ªá¥«ï"
*/
CLASS VSFrormFD (Series, Number, fmord)
    PRIVATE VAR
        ParmA = TArray,
        form = TBfile("vsform.dbt","r",0),
        fmo,
        FIRoleBArray = TArray;
    VAR
        /*á­®¢­ë¥ á¢®©áâ¢ */
        Error = 0, kind, id;

    PRIVATE MACRO InitParmArray
        ParmA[MC_TYPE_PARAMETR_DOCKIND] = DL_VSFORM;
        ParmA[MC_TYPE_PARAMETR_DOCID] = fmo.FrmOrdId;
        ParmA[MC_TYPE_PARAMETR_OWNER] = form.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_PARTY] = form.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_CONTRACTOR] = form.rec.ResponsPerson;
        ParmA[MC_TYPE_PARAMETR_PLACE] = 0;
        ParmA[MC_TYPE_PARAMETR_BEGDATE] = form.rec.StatusDate;
        ParmA[MC_TYPE_PARAMETR_FINDATE] = date (0,0,0);
        ParmA[MC_TYPE_PARAMETR_VALDATE] = form.rec.StatusDate;
        ParmA[MC_TYPE_PARAMETR_ISSUER] = {OurBank};
        ParmA[MC_TYPE_PARAMETR_FIID] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_CURRENCY] = NATCUR;
        ParmA[MC_TYPE_PARAMETR_NUMBER] = form.rec.Series+" "+form.rec.Number;
        ParmA[MC_TYPE_PARAMETR_SENIORNUMBER] = "";
        ParmA[MC_TYPE_PARAMETR_DEPARTMENT] = form.rec.Department;
        FIRoleBArray[0] = FIROLE_FIDOC;
    END;

    /*®«ãç¨âì ¯ à ¬¥âàë*/
    MACRO GetParametr (ParmKind, OperDate, CatCode, FIRole)
        VAR 
            Parametr = ParmA[ParmKind];

        if (Parametr==null) 
            Parametr = -1;
        end;

        if(ParmKind == MC_TYPE_PARAMETR_CENTR)
            if ( CatCode == "« ­ª¨„«ï á¯à.,‘æ/¡" )
              Parametr = GetPerson( fmo.Oper );  // PartyID ¯®¤®âç¥â­®£® «¨æ 
            else
              Parametr = form.rec.ResponsPerson;  // PartyID ¯®¤®âç¥â­®£® «¨æ 
            end;
            
            if(Parametr == -1)
                Parametr = {OurBank};
            end;
        end;

        return Parametr;
    END;

    /* ãáâ ­®¢¨âì ¯ à ¬¥âà */
    MACRO SetParametr (ParmKind, value)
    var
       old = -1;

       if( (ParmKind >= 0) and (ParmKind < ParmA.size) )
           old = ParmA[ParmKind];
           ParmA[ParmKind] = value;
       end;

       return old;
    END;

    MACRO GetParametrTemplate
    ( 
        ObjectID,       /* ¯ à ¬¥âà - ­®¬¥à á¯à ¢®ç­¨ª  */
        Classificator,  /* ª« áá¨ä¨ª â®à - ­®¬¥à ª« áá¨ä¨ª â®à , ¥á«¨ ®­ § ¤ ­ */
        OperDate,
        FIRole
    )

        if (ObjectID == OBJTYPE_VALUETYPE)              /*1111 - ¢¨¤ æ¥­­®áâ¨ */
            if (Classificator == LLCLASS_VALUE_CLS_SAVE)               // 155 - ¢¨¤ æ¥­­®áâ¨ § ªà. åà ­¥­¨ï
               return 1; /* à®áâ®© ¢¥ªá¥«ì */
            end;
        end;

        return -1;
    END;

    MACRO GetBasisFIRole(FIRole)
      var i = 0;
      if (FIRole == FIROLE_UNDEF)
        return FIROLE_FIDOC;
      end;

      return FIROLE_UNDEF;
    END;

    MACRO GetFIRoleBArray()
      return FIRoleBArray;
    END;

    /*Œ ªà®á ª®àà¥ªâ¨à®¢ª¨ ®âªàë¢ ¥¬®£® áç¥â . Account, accblnc, ORScheme ¬®¦­® ¬¥­ïâì*/
    MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
      return true;
    END;

    // Š®¤ ª®­áâàãªâ®à  
    fmo = fmord;
    if (( valtype(Series) == V_String ) and (valtype(Number) == V_String ) and 
        ( (ValType(fmord) == V_STRUC) OR (ValType(fmord) == V_FILE) OR (ValType(fmord) == V_GENOBJ) ) )
        form.Clear();
        form.rec.Series = Series;
        form.rec.Number = Number;
        
        if ( not form.GetEQ() )
            RunError ("­¥ ­ ©¤¥­­ ¡« ­ª: ‘¥à¨ï "+Series+" N "+Trim(Number));
        end;
    else
        RunError ("­¥¢¥à­ë© ¢ë§®¢ ª®­áâàãªâ®à ");
    end;

    InitParmArray();

    Kind = ParmA[MC_TYPE_PARAMETR_DOCKIND];
    Id = ParmA[MC_TYPE_PARAMETR_DOCID];
END;
