/*
$Name:         vsz4_10.mac
$Module:       Векселя банка
$Description:  Залог векселей. Возврат для погашения векселей из залога. Выдача векселей для погашения
*/

IMPORT OprInter, vsdates, vszlib;

PRIVATE record ord("dl_order");

PRIVATE VAR StepDate;

PRIVATE MACRO ВыдачаВекселяДляПогашения (bnr, leg)
    var rmState = "";
    if(bnr.rec.BCStatus != VSBANNER_STATUS_PAWN)
        Ошибка("Вексель " + VSZLIB_СерияНомерВекселя(bnr) + "| не в залоге");
        return 1;
    end;

    rmState = bnr.rec.BCState;
    rmState = StrSubst(rmState, "И", "");
    rmState = StrSubst(rmState, "С", "");

    if(not ИзменитьВексель(bnr.rec.BCID, StepDate,
                            "rmbcstate", rmState))
        Ошибка("Ошибка при изменении векселя");
        return 1;
    end;

    if(not ИзменитьВексель(bnr.rec.BCID, StepDate,
                            "repaymentdate", StepDate,
                            "addbcstate", "К",
                            "bcstatus", VSBANNER_STATUS_ENDED))
        Ошибка("Ошибка при изменении векселя");
        return 1;
    end;

    if (not VSZLIB_ПроводкаЗалога("выдача для погашения", ord, bnr, leg, StepDate))
        return 1;
    end;

    return 0;
END;

MACRO ExecuteStep(docbuf, ordbuf)
    SetBuff( ord, ordbuf );

    if(not VS_TestStepDate(DATE_PAWN_DOC, @StepDate, ord.SignDate))
       return 1;
    end;

    return ДляКаждогоВекселя(ord, @ВыдачаВекселяДляПогашения, null, null, "BL")
END;
