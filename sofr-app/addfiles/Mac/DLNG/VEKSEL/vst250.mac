/*
$Name:          vst250.mac
$Module:        Векселя банка
$Description:   Сопровождение векселя. Б.Ввод векселя в Стоп-лист

                vs-вексель
                 t-операция сопровождения векселя
               250-номер (соответствующий шагу)
*/

IMPORT OprInter, VSInter, vscateg;

VAR srvdoc = 0; /* В эту переменную будет передан сервисный документ начисления
                   (TRecHandler, структура vssrvdoc) */
PRIVATE RECORD bnr(vsbanner);

//getBCStateCh(srvdoc)
//hasBCStateBlocked(bnr)


MACRO ExecuteStep(Buffer, FirstDoc)
var
    stat = 0,
    rmState = "",
    blockedState = "Б";
    if ( srvdoc.rec.dockind == 172 ) //если из сервисной операции операции "Ввод/вывод в стоп-лист"
      blockedState = getBCStateCh(srvdoc);
    end;

    SetBuff(bnr, FirstDoc);

//    if(Index(bnr.BCState, "Б") != 0)
      if ( hasBCStateBlocked(bnr.BCState) == true )
        stat = Ошибка("Вексель уже заблокирован");
    end;

    if(stat == 0)
        rmState = bnr.BCState;
        rmState = StrSubst(rmState, "И", "");
        rmState = StrSubst(rmState, "С", "");

        if(not ИзменитьВексель(bnr.BCID, srvdoc.rec.ValueDate,
                               "rmbcstate", rmState))
            stat = Ошибка("Ошибка при изменении векселя");
        end;
    end;

    if(stat == 0)
        if(not ИзменитьВексель(bnr.BCID, srvdoc.rec.ValueDate,
                               "addbcstate", blockedState))
            stat = Ошибка("Ошибка при установке признака",
                          "|состояния векселя",
                          "|", GetTypeAc(170, blockedState), ".");
        end;
    end;

    return stat;
END;

/* Макрос печати
*/
MACRO PrintStepDocs(
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    return 1;
END;
