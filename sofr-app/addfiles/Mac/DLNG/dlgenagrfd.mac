/*
$Name:        dlgenagrfd.mac
$Module:      Dealing
$Description: Первичный документ по ген. соглашению для работы со счетами
*/
IMPORT mmcateg, fxcateg, "dv_class.mac";

/*********************************************************************************/
/* базовый класс - первичные документы для работы с категориями учета            */ 
/*********************************************************************************/
CLASS DLGenAgrFD(parm1, parm2)
    private var 
        realFD = NULL;

    private var 
        FIRoleBArray = TArray(); /* массив базисных ролей ФИ */

    var
       Error = 0,       /* Номер ошибки. Используется для анализа ошибок в ф-ях категорий*/
       Kind  = 0,       /* вид первичного документа*/
       ID    = 0;       /* ID первичного документа*/

///////////////////////////////////////////////////////////////////////////////
    MACRO ReInit()
        realFD.ReInit(false);
    END;

    MACRO GetParametr(_ParmKind, _OperDate, _CatCode, _FIRole)
        return realFD.GetParametr(_ParmKind, _OperDate, _CatCode, _FIRole);
    END;

    MACRO SetParametr(_ParmKind, _Val)
       realFD.SetParametr(_ParmKind, _Val);
    END;

    MACRO GetUsParametr(_ParmKind)
        return realFD.GetUsParametr(_ParmKind);
    END;

    MACRO SetUsParametr(_ParmKind, _Val)
       realFD.SetUsParametr(_ParmKind, _Val);
    END;

    MACRO GetFIRoleByCategory(Categ, FIID, FIRole_def)
        return realFD.GetFIRoleByCategory(Categ, FIID, FIRole_def);
    END;

    /*инициализация массива ролей ФИ, в классах наследниках может переопределяться*/
    MACRO InitFIRoleBArray()
        FIRoleBArray = realFD.GetFIRoleBArray();
    END;

    MACRO GetFIRoleBArray()
        return FIRoleBArray;
    END;

    MACRO GetBasisFIRole(_FIRole)
        return realFD.GetBasisFIRole(_FIRole);
    END;

    /*Получить параметры шаблона*/
    MACRO GetParametrTemplate(_ObjectID, _Classificator, _OperDate, _FIRole)
        return realFD.GetParametrTemplate(_ObjectID, _Classificator, _OperDate, _FIRole);
    END;

    /*Макрос корректировки открываемого счета. Account, accblnc, ORScheme можно менять*/
    MACRO CorrectAccount(_account_, _accblnc_, _ORScheme_, _categ, _templ, _accdoc,  _OperDate)
        var 
            retVal = realFD.CorrectAccount(_account_, _accblnc_, _ORScheme_, _categ, _templ, _accdoc,  _OperDate);

        SetParm(1, _account_);
        SetParm(2, _accblnc_);
        SetParm(3, _ORScheme_);
         return retVal;
    END;

    /*актуализация счета (без открытия)*/  
    MACRO ActualAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = realFD.ActualAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;

    /*Актуализация с проверкой срочности*/  
    MACRO ActualCheckPeriod(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = realFD.ActualCheckPeriod(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;  

    /*открытие и актуализация счета*/  
    MACRO OpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = realFD.OpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;  

    /*переоткрытие и актуализация счета - если счет нашли, его все равно пересоздать*/  
    MACRO ReOpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = realFD.ReOpenAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;

    /*аннулирование счета по категории*/
    MACRO CloseAccount(_CatCode, _ActionDate, _FIRole, _FIID, _NoErrMes)
        var 
            retVal = realFD.CloseAccount(_CatCode, _ActionDate, _FIRole, _FIID, _NoErrMes);

        return retVal;
    END;

    /*проверка на существование счета*/  
    MACRO IsExistAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = realFD.IsExistAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);;

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;  

    /*проверка на актуализацию счета*/  
    MACRO IsActAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID)
        var 
            retVal = IsActAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, AccBuf_, _ActionDate, _FIID);

        SetParm(2, FindAccount_);
        SetParm(5, AccBuf_);
        return retVal;
    END;  

    /*получить - найти или сформировать номер счета (без открытия)*/  
    MACRO FindNumberAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, _FIID)
        var 
            retVal = realFD.FindNumberAccount(_CatCode, FindAccount_, _NoErrMes, _FIRole, _FIID);

        SetParm(2, FindAccount_);
        return retVal;
    END;

// Constructor
    if ((ValType(parm1) == V_INTEGER) and
        (ValType(parm2) == V_INTEGER) and
        (parm1 == 4610))
        //Конструктор из DocKind, DocID
        realFd = FXFirstDoc(parm1, parm2);
    elif ((ValType(parm1) == V_INTEGER) and
        (ValType(parm2) == V_INTEGER) and
        (parm1 == 4611))
        //Конструктор из DocKind, DocID
        realFD = MMFirstDoc(parm1, parm2);
    elif( (ValType(parm1) == V_INTEGER) and
          (ValType(parm2) == V_INTEGER) and
          (parm1 == DL_GENAGRDVDOC)
        )
        //Конструктор из DocKind, DocID
        realFD = DVFirstGenAgr(parm1, parm2);
    else
        return NULL
    end;

    ReInit();
    InitFIRoleBArray();
	
    Kind = GetParametr(MC_TYPE_PARAMETR_DOCKIND);
    Id   = GetParametr(MC_TYPE_PARAMETR_DOCID);
END;

