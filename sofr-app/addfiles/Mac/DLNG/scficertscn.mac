/*
$Name:        scficertscn.mac
$Module:      Ядро Securities
$Description: Массовое выполнение действий над сертификатами док. ц/б
*/

IMPORT FIInter, DealsInter;   
 
PRIVATE VAR ficert = TRecHandler( "v_ficert.dbt" );
PRIVATE VAR avrk = TBFile("avrkinds.dbt");


PRIVATE CONST ERROR_EXEC = 0,
              PRINT_HEADER = 1,
              PRINT_FOOTER = 2;

PRIVATE MACRO PrintHead( Head:STRING )
[
                   #
┌──────────────────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────┐
│       Параметры ц/б      │  №   │                      Сообщение                                                                    │
│                          │ошибки│                                                                                                   │
├──────────────────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────┤](Head);
END;


PRIVATE MACRO PrintFooter()
[└──────────────────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────┘
];

END;

PRIVATE MACRO PrintLine( ErrStatus:INTEGER, ErrMessage:STRING )
var parmfistr = avrk.rec.Name + "\n"+ficert.rec.Series + " " + trim(ficert.rec.Number);

[│##########################│######│###################################################################################################│]
( parmfistr:w, ErrStatus, ErrMessage:w );
END;


PRIVATE MACRO DeleteFICERT( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом удалении неэмиссионных ц/б." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Неэмиссионная ц/б удалена успешно.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

PRIVATE MACRO SetUserLotFICERT( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом назначении партии неэмиссионным ц/б." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Номер партии успешно назначен.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

PRIVATE MACRO RollBackServOpFICERT( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом откате сервисных операций." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Откат произведен успешно.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

PRIVATE MACRO EnterFrBnrVal( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом вводе справедливой стоимости." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Выполнено успешно.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

/*   Action = 3 - удаление (F8 из скроллинга )
*/
MACRO Печать_ОтчетСканирования( NumExec:INTEGER, FDoc:VARIANT, ErrStatus:INTEGER, ErrMessage:STRING, Action:INTEGER )

  ficert.SetRecordAddr( FDoc );

  avrk.Clear();
  avrk.rec.FI_Kind = FIKIND_AVOIRISS;
  avrk.rec.AvoirKind = ficert.rec.AvoirKind;
  avrk.GetEQ;

  if( Action == 1 ) //Удаление
     DeleteFICERT( NumExec, ErrStatus, ErrMessage );
  elif( Action == 2 ) //Назначить номер партии
     SetUserLotFICERT( NumExec, ErrStatus, ErrMessage );
  elif( Action == 5 ) //откат в сервисной операции
     RollBackServOpFICERT( NumExec, ErrStatus, ErrMessage );
  elif( Action == 6 ) //ввод справедливой стоимости
     EnterFrBnrVal( NumExec, ErrStatus, ErrMessage );
  end;

END;
