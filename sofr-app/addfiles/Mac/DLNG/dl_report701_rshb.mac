/*                                                                                                                                                    0
$Name: dl_report701_RSHB.mac
$Module: Ядро Securities + ФИССиКО
$Description: <Отчеты> / <РСХБ> / <Форма 701 РСХБ)>  
2020-12-18 SA BIQ-5191
2020-12-30 SA исправлена ошибка при формировании кода валюты (теряется лидирующий 0 в 036) и буквы в коде центрального контрагента (3466-ЦК)
	- 1212: E1060 ГРАФА 4 - КОД ВАЛЮТЫ НЕ СООТВЕТСТВУЕТ СПРАВОЧНОМУ ДЛЯ ДАТЫ ОПЕРАЦИИ <18.12.2020> - <36>
	- 1: E2210 ГРАФА 9_1 - КОД НЕ СООТВЕТСТВУЕТ СПРАВОЧНОМУ ДЛЯ ДАТЫ ОПЕРАЦИИ <18.12.2020> - <3466-ЦК>
*/
import "dl_report701_form.mac", "mctplprm.mac", "dlquery.mac", "dldlngfun.mac";

private const
   OUTASTEXT = "OUTASTEXT";

private const
   OUTASVOID = "OUTASVOID";

private const SHEET_CNV = "Конверсионные операции";
private const SHEET_MBK = "Операции на ДР";

PRIVATE CONST POI_MODE = FALSE;

PRIVATE VAR Dl_Rep701_Form;

PRIVATE MACRO DL_GetISOCode_701( FIID:integer ):string
   var sql = RSDCommand("select t_ISO_Number from dfininstr_dbt where t_FIID = ? " );

   sql.addParam( "", RSDBP_IN, FIID );
   sql.execute();

   var fininstr = TRsbDataSet(sql);

   if( fininstr.MoveNext )
      return fininstr.ISO_Number;
   end;

   return "000";
END;


PRIVATE CLASS (DL_CReportTemplate) Dl_Rep701_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )

   PRIVATE VAR m_Date = Date(0,0,0), 
               m_BySC_Own = false,
               m_BySC_Client = false,
               m_ByDV_DerivOwn = false,
               m_ByDV_DerivClient = false,
               m_ByDV_CurOwn = false,
               m_ByDV_CurClient = false,
               m_ByDV_Other = false,
               m_ByMBK = false,
               m_ALLBank = false,
               m_OnlyHead = false,
               m_OnlyFilial = false,
               m_FilialCode = -1,
               m_InExcel = false,
               m_InKliko = false,
               m_IsExistsData_CNV = false,
               m_IsExistsData_MBK = false,
               m_FIID_840 = -1,
               m_Intermediate = 0;
               
   PRIVATE VAR m_RS;
   PRIVATE VAR m_NumStr1 = 30;
   PRIVATE VAR m_NumStr2 = 30;

   PRIVATE VAR m_HeadBankCode = 0;

   PRIVATE MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;

   PRIVATE MACRO BeginReport( NumCopy:INTEGER) // , Sheet:String )
      m_Date = Dl_Rep701_Form.GetFieldValue(PNFLD_701_DATE);
      m_BySC_Own = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_SC_OWN) == SET_CHAR, true, false );
      m_BySC_Client = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_SC_CLIENT) == SET_CHAR, true, false );
      m_ByDV_DerivOwn = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_DERIV_OWN) == SET_CHAR, true, false );
      m_ByDV_DerivClient = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_DERIV_CLIENT) == SET_CHAR, true, false );
      m_ByDV_CurOwn = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_CUR_OWN) == SET_CHAR, true, false );
      m_ByDV_CurClient = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_CUR_CLIENT) == SET_CHAR, true, false );
      m_ByDV_Other = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_OTHER) == SET_CHAR, true, false );
      m_ByMBK = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_MBK) == SET_CHAR, true, false );
      m_ALLBank = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ALL_BANK) == SET_CHAR, true, false );
      m_OnlyHead = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ONLY_HEAD) == SET_CHAR, true, false );
      m_OnlyFilial = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ONLY_FILIAL) == SET_CHAR, true, false );
      m_FilialCode = Dl_Rep701_Form.GetFieldValue(PNFLD_701_FILIAL_CODE);
      m_InExcel = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_IN_EXCEL) == SET_CHAR, true, false );
      m_InKliko = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_IN_KLIKO) == SET_CHAR, true, false );
      m_Intermediate = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_INTERMEDIATE) == SET_CHAR, 1, 0 );
   END;

   private macro Bank_PartyID( _BankCode )                                               
     var ret = _BankCode;                                                                
     var cmd, rs;                                                                        
     cmd = RsdCommand( "select D.T_PARTYID as idp from ddp_dep_dbt d where d.t_code=?" );
     cmd.addParam( "brn", RSDBP_IN );                                                    
     cmd.value( "brn" ) = _BankCode;                                                     
     cmd.execute;                                                                        
     rs = RsdRecordset( cmd );                                                           
     if ( rs.moveNext )                                                                  
       ret = Int( rs.value( "idp" ) );                                                   
     end;                                                                                
     return ret;                                                                         
   end;                                                                                  


   PRIVATE MACRO PrintReportHead_CNV()
     record RecAddress("adress.dbt");
     var recBank = TRecHandler("party.dbt");
     if( not m_IsExistsData_CNV )
        var BankID = Bank_PartyID(iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, {HeadBankID}));
        if( ПолучитьСубъекта(BankID, recBank) != 0 )
           msgbox("Не найдена анкета субъекта с ID = "+string(BankID));
           return;
        end;
	SetActiveSheet( SHEET_CNV );
        PrintFormatString( "",
                           "N1_ОКАТО",   DL_GetOkatoCode(recBank, m_Date),
                           "N1_ОКПО",    recBank.rec.OKPO,
                           "N1_РегНом",  ПолучитьКодСубъекта(BankID, PTCK_BANKREGNUM),
                           "N1_H1",      DL_DateToStr(m_Date,true),
                           "N1_H2",      recBank.rec.ShortName,
                           "N1_H3",      DL_GetRealAddress(BankID)
                         );
	        RegisterTable( "N1_MainTable", "#",
                       "N1_A1", 
                       "N1_A2", 
                       "N1_A3", 
                       "N1_A4", 
                       "N1_A5", 
                       "N1_A6", 
                       "N1_A7", 
                       "N1_A8", 
                       "N1_A9", 
                       "N1_A10", 
                       "N1_A11", 
                       "N1_A12", 
                       "N1_A13", 
                       "N1_A14",
                       "N1_A15",
                       "N1_A16",
                       "N1_A17",
                       "N1_A18",
                       "N1_A19",
                       "N1_A20",
                       "N1_A21",
                       "N1_A22",
                       "N1_A23"
                     );
     end;
   END;

   PRIVATE MACRO PrintReportHead_MBK()
     record RecAddress("adress.dbt");
     var recBank = TRecHandler("party.dbt");
     if( not m_IsExistsData_MBK )
        var BankID = Bank_PartyID(iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, {HeadBankID}));
        if( ПолучитьСубъекта(BankID, recBank) != 0 )
           msgbox("Не найдена анкета субъекта с ID = "+string(BankID));
           return;
        end;
	SetActiveSheet( SHEET_MBK );
        PrintFormatString( "",
                           "N2_ОКАТО",   DL_GetOkatoCode(recBank, m_Date),
                           "N2_ОКПО",    recBank.rec.OKPO,
                           "N2_РегНом",  ПолучитьКодСубъекта(BankID, PTCK_BANKREGNUM),
                           "N2_H1",      DL_DateToStr(m_Date,true),
                           "N2_H2",      recBank.rec.ShortName,
                           "N2_H3",      DL_GetRealAddress(BankID)
                         );
	        RegisterTable( "N2_MainTable", "#",
                       "N2_A1", 
                       "N2_A2", 
                       "N2_A3", 
                       "N2_A4", 
                       "N2_A5", 
                       "N2_A6", 
                       "N2_A7", 
                       "N2_A8", 
                       "N2_A9", 
                       "N2_A10", 
                       "N2_A11", 
                       "N2_A12", 
                       "N2_A13", 
                       "N2_A14",
                       "N2_A15",
                       "N2_A16",
                       "N2_A17",
                       "N2_A18",
                       "N2_A19",
                       "N2_A20",
                       "N2_A21",
                       "N2_A22",
                       "N2_A23",
                       "N2_A24"
                     );
     end;
   END;

   PRIVATE MACRO PrintTableLine_CNV()
      // MsgBox("m_NumStr = ",m_NumStr1);
      PrintTableLine( "N1_A1", OUTASTEXT+string(m_NumStr1-29), null,
                      "N1_A2", SQL_ConvTypeDate(m_RS.DealDate), null, 
                      "N1_A3", SQL_ConvTypeDate(m_RS.CalcDate), null, 
                      "N1_A4", iif(m_RS.ReqFIID==-1,OUTASVOID,DL_GetISOCode_701(SQL_ConvTypeInteger(m_RS.ReqFIID))), null, 
                      "N1_A5", iif(m_RS.ReqFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ReqSum,3)), null,
                      "N1_A6", iif(m_RS.ComFIID==-1,OUTASVOID,DL_GetISOCode_701(SQL_ConvTypeInteger(m_RS.ComFIID))), null,
                      "N1_A7", iif(m_RS.ComFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ComSum,3)), null,
                      "N1_A8", m_RS.ISRESIDENT, null,
                      "N1_A9", iif(StrLen(m_RS.T_BANKCONTRAGENT) < 8,StrSubst(m_RS.T_BANKCONTRAGENT,"-ЦК",""),OUTASTEXT), null,  
                      "N1_A10", iif(StrLen(m_RS.T_BANKCONTRAGENT) > 8,SubStr(m_RS.T_BANKCONTRAGENT,1,8),OUTASTEXT), null,  
                      "N1_A11", iif(StrLen(m_RS.T_BANKCONTRAGENT) > 8,SubStr(m_RS.T_BANKCONTRAGENT,9),OUTASTEXT), null,  
                      "N1_A12", iif(m_RS.t_nrcountry=="",OUTASTEXT,m_RS.t_nrcountry), null,
                      "N1_A13", OUTASTEXT, null ,/* m_RS.ReqSum, null, */
                      "N1_A14", iif(m_RS.T_MARKETCONTRAGENT=="MMVB","1","2"), null, 
                      "N1_A15", iif(m_RS.T_MARKETCONTRAGENT=="",OUTASTEXT,m_RS.T_MARKETCONTRAGENT), null, 
		      "N1_A16",iif(m_RS.T_OTHER=="",OUTASTEXT,m_RS.T_OTHER), null, /*11 графа старого отчета*/
                      "N1_A17",iif(m_RS.T_DEALADDINFO=="",OUTASTEXT,m_RS.T_DEALADDINFO), null, /*12 графа старого отчета*/
                      "N1_A18", OUTASTEXT, null,
                      "N1_A19", OUTASTEXT, null,
                      "N1_A20", OUTASTEXT, null, // m_RS.ReqFIID, null,
                      "N1_A21", OUTASTEXT, null, // m_RS.ComFIID, null,
		      "N1_A22", iif(m_RS.T_DEALSIDE==UNSET_CHAR,OUTASVOID,m_RS.T_DEALSIDE), null, 
		      "N1_A23", iif(m_RS.T_METHODADDINFO=="","DE",m_RS.T_METHODADDINFO), null
//		      "N1_A23", iif(m_RS.T_METHODADDINFO=="",OUTASVOID,m_RS.T_METHODADDINFO), null
                    );
      m_NumStr1 = m_NumStr1 + 1;
   END;

   PRIVATE MACRO PrintTableLine_MBK()
      // MsgBox("m_NumStr = ",m_NumStr2);
      PrintTableLine( "N2_A1", OUTASTEXT+string(m_NumStr2-29), null,
                      "N2_A2", SQL_ConvTypeDate(m_RS.DealDate), null, 
                      "N2_A3", SQL_ConvTypeDate(m_RS.CalcDate), null, 
                      "N2_A4", iif(m_RS.ReqFIID==-1,OUTASVOID,DL_GetISOCode_701(SQL_ConvTypeInteger(m_RS.ReqFIID))), null, 
                      "N2_A5", iif(m_RS.ReqFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ReqSum,3)), null,
                      "N2_A6", iif(m_RS.ComFIID==-1,OUTASVOID,DL_GetISOCode_701(SQL_ConvTypeInteger(m_RS.ComFIID))), null,
                      "N2_A7", iif(m_RS.ComFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ComSum,3)), null,
                      "N2_A8", m_RS.ISRESIDENT, null,
//                      "N2_A9", iif(StrLen(m_RS.T_BANKCONTRAGENT) < 8,StrSubst(m_RS.T_BANKCONTRAGENT,"-ЦК",""),OUTASTEXT), null,  
//				iif(m_RS.T_BANKCONTRAGENT=="",OUTASVOID,m_RS.T_BANKCONTRAGENT), null,  
                      "N2_A9", iif(StrLen(m_RS.T_BANKCONTRAGENT) < 8,m_RS.T_BANKCONTRAGENT,OUTASVOID), null,  
                      "N2_A10", iif(StrLen(m_RS.T_BANKCONTRAGENT) > 8,SubStr(m_RS.T_BANKCONTRAGENT,1,8),OUTASVOID), null,  
                      "N2_A11", iif(StrLen(m_RS.T_BANKCONTRAGENT) > 8,SubStr(m_RS.T_BANKCONTRAGENT,9),OUTASVOID), null,  
                      "N2_A12", iif(m_RS.t_nrcountry=="",OUTASVOID,m_RS.t_nrcountry), null,
                      "N2_A13", OUTASTEXT, null, /* iif(m_RS.T_PARTYID=="",OUTASVOID,m_RS.T_PARTYID), null, */
                      "N2_A14", iif(m_RS.T_MARKETCONTRAGENT=="MMVB","1","2"), null, 
                      "N2_A15", iif(m_RS.T_MARKETCONTRAGENT=="",OUTASVOID,m_RS.T_MARKETCONTRAGENT), null, 
                      "N2_A16", iif(m_RS.T_OTHER=="",OUTASVOID,m_RS.T_OTHER), null, //,iif(m_RS.T_DEALADDINFO=="",OUTASVOID,m_RS.T_DEALADDINFO), null, 
                      "N2_A17", OUTASTEXT, null,
                      "N2_A18", OUTASTEXT, null,
                      "N2_A19", OUTASTEXT, null,
                      "N2_A20", OUTASTEXT, null,
                      "N2_A21",iif(m_RS.T_TYPEADDINFO=="",OUTASVOID,m_RS.T_TYPEADDINFO), null,
                      "N2_A22",iif(((m_RS.T_RATEADDINFO==$0) AND (m_RS.T_TYPEADDINFO != "REPO")),OUTASVOID,m_RS.T_RATEADDINFO), iif((m_RS.dlkind==5)or(m_RS.dlkind==6),3,4),
		      "N2_A23", iif(m_RS.T_DEALSIDE==UNSET_CHAR,OUTASVOID,m_RS.T_DEALSIDE), null, 
		      "N2_A24", iif(m_RS.T_METHODADDINFO=="","DE",m_RS.T_METHODADDINFO), null
//		      "N2_A24", iif(m_RS.T_METHODADDINFO=="",OUTASVOID,m_RS.T_METHODADDINFO), null
                    );
      m_NumStr2 = m_NumStr2 + 1;
   END;

   MACRO GetHeadBank()
     var cmd, rs;                                                                        
     cmd = RsdCommand( "select t_Code from ddp_dep_dbt where t_PartyID = " + {HeadBankID} + " order by t_code" );
     cmd.execute();
     rs = TRsbDataSet(cmd);                                                                        
     if ( rs.moveNext() )                                                                  
       m_HeadBankCode = Int(rs.Code);                                                   
     end;                                                                                                                                                         
   END;

   MACRO CreateData_SC( CodeType:INTEGER )
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"", "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701_RSHB.CreateData_SC(?,?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, CodeType);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CreateData_DV( MarketKind:INTEGER, CodeType:INTEGER)
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"ФИССиКО\"", "Подготовка данных по сделкам модуля \"ФИССиКО\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701_RSHB.CreateData_DV(?,?,?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, MarketKind);
      exec.AddParam( "", RSDBP_IN, CodeType);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CreateData_MBK()
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"Межбанк. кредиты\"", "Подготовка данных по сделкам модуля \"Межбанк. кредиты\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701_RSHB.CreateData_MBK(?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CorrectData()
      var sql, exec;
      InitProgress(-1, "Корректировка отобранных данных", "Корректировка отобранных данных");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701_RSHB.CorrectData; "
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.execute();

      RemProgress();
   END;

   MACRO PrintData_CNV()
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      query = "select tmp.* from ddlrep701_RSHB_tmp tmp where tmp.T_DLKind not in (1,2,9)"
             +"  order by case when tmp.T_DLKind = 1 then 0 "
             +"                when tmp.T_DLKind = 2 then 1 "
             +"                when tmp.T_DLKind = 9 then 3 "
             +"                else 2 end, "
             +"           tmp.T_IsMarket desc, tmp.T_DLKind, "
             +"           case when tmp.T_DLKind in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end, "
             +"           tmp.T_DEALID, TMP.T_OTHER, tmp.T_DEALPART, " /*PNV*/
             +"           case when tmp.T_DLKind not in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end";
                                                                                 
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод данных CNV в отчет", "Вывод данных CNV в отчет");
         PrintReportHead_CNV();
         m_IsExistsData_CNV = true;
         m_RS = cmd.execute(query);
     
         while( m_RS.MoveNext() )
            PrintTableLine_CNV();
            ProgressIndicator.Use;
         end;
     
         ProgressIndicator.Remove;
      end;

   END;

   MACRO PrintData_MBK()
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      query = "select tmp.* from ddlrep701_RSHB_tmp tmp where tmp.T_DLKind in (1,2,9)"
             +"  order by case when tmp.T_DLKind = 1 then 0 "
             +"                when tmp.T_DLKind = 2 then 1 "
             +"                when tmp.T_DLKind = 9 then 3 "
             +"                else 2 end, "
             +"           tmp.T_IsMarket desc, tmp.T_DLKind, "
             +"           case when tmp.T_DLKind in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end, "
             +"           tmp.T_DEALID, TMP.T_OTHER, tmp.T_DEALPART, " /*PNV*/
             +"           case when tmp.T_DLKind not in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end";

      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод данных MBK в отчет", "Вывод данных MBK в отчет");
         PrintReportHead_MBK();
         m_IsExistsData_MBK = true;
         m_RS = cmd.execute(query);
     
         while( m_RS.MoveNext() )
	    PrintTableLine_MBK();
            ProgressIndicator.Use;
         end;
     
         ProgressIndicator.Remove;
      end;

   END;

   MACRO EndReport_CNV()
      if( m_IsExistsData_CNV )
         EndTable();
         AddStandardFooter( "N1_" );
         ReplaceAndCalculate( OUTASTEXT, " " );/*добавляем пробел - тогда сможем вывести номера строк в строковые ячейки как текст с точкой-разделителем.*/
         ReplaceAndCalculate( OUTASVOID, "" );/*для того, чтобы в 14 ячейке в случае отсутствия заполнения инструмент автоматом не заполнял пробелами*/
         ReplaceFormulaAndCalculate();
      else
         msgbox("Нет данных CNV для формирования отчета.");
      end;
   END;

   MACRO EndReport_MBK()
      if( m_IsExistsData_MBK )
         EndTable();
         AddStandardFooter( "N2_" );
         ReplaceAndCalculate( OUTASTEXT, " " );/*добавляем пробел - тогда сможем вывести номера строк в строковые ячейки как текст с точкой-разделителем.*/
         ReplaceAndCalculate( OUTASVOID, "" );/*для того, чтобы в 14 ячейке в случае отсутствия заполнения инструмент автоматом не заполнял пробелами*/
         ReplaceFormulaAndCalculate();
      else
         msgbox("Нет данных MBK для формирования отчета.");
      end;
   END;

   MACRO Create()
      var fin = TRecHandler("fininstr.dbt");
      m_IsExistsData_CNV = false;
      m_IsExistsData_MBK = false;
      SQL_Truncate( "DDLREP701_RSHB_TMP" );
      if( ПолучитьФинИн("840", fin, null, null, null, FICK_ISONUMBER) == 0 )
         m_FIID_840 = fin.rec.FIID;
      else
         msgbox("Не найден финансовый инструмент по коду ISO: \"840\"");
         return;
      end;
      if( m_OnlyHead )
         GetHeadBank();
      end;

      if( m_BySC_Own )
         CreateData_SC( DL_EXTCODETYPE_OWN );
      end;
      if( m_BySC_Client )
         CreateData_SC( DL_EXTCODETYPE_CLIENT );
      end;

      if( m_ByDV_DerivOwn )
         CreateData_DV( DV_MARKETKIND_DERIV, DL_EXTCODETYPE_OWN );
      end;
      if( m_ByDV_DerivClient )
         CreateData_DV( DV_MARKETKIND_DERIV, DL_EXTCODETYPE_CLIENT );
      end;
      if( m_ByDV_CurOwn )
         CreateData_DV( DV_MARKETKIND_CURRENCY, DL_EXTCODETYPE_OWN );
      end;
      if( m_ByDV_CurClient )
         CreateData_DV( DV_MARKETKIND_CURRENCY, DL_EXTCODETYPE_CLIENT );
      end;
      if( m_ByDV_Other )
         CreateData_DV( -1, 0 );  
      end;

      if( m_ByMBK )
         CreateData_MBK();
      end;

      CorrectData();

      if( m_ByDV_DerivOwn or m_ByDV_DerivClient or m_ByDV_CurOwn or m_ByDV_CurClient or m_ByDV_Other )
         PrintData_CNV();
         EndReport_CNV();
      end;
      m_NumStr2 = m_NumStr1;
      if( m_BySC_Own or m_BySC_Client or m_ByMBK)
         PrintData_MBK();
         EndReport_MBK();
      end;

   END;

   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );  

END;

MACRO RunReport()

  var stat = true;

  Dl_Rep701_Form = DL_REP701_Panel();

  while(stat)
     stat = Dl_Rep701_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
     if (not stat)
        break;
     end;
   
     if( stat )
        var Dl_Rep701 = Dl_Rep701_Report( null, "Report_701_RSHB.xls", null, null, null, POI_MODE );      
        Dl_Rep701.Run();
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
     end;
  end;

END;

RunReport();
exit(1); 