/**                                                                                                             
 @file onceMessageDBO.mac                                                                                       
 @brief Скрипт для отправки уведомлений на биржу.
                                                                                                                                                                                                                                                                                                                            
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2025.26.02 |Шестаков Д.В.  |BOSS-5689           |Создание макроса                                                                                                                                                                                                                                                                                         
*/ 

import "dlQuery.mac","dlcontrmsg.mac";


/*
@brief Инсерт данных в таблицу DDLCONTRGENMSG_TMP, требуется для отправки сообщений 
@param[in] dlcontrID  ID договора
*/
private macro insertDlContrGenMsg(dlContrID)

    var sql            :String, 
        cmd            :Object;

    SQL_Execute("TRUNCATE TABLE DDLCONTRGENMSG_TMP");    

    sql =    
      "  INSERT INTO DDLCONTRGENMSG_TMP(t_kind, t_mpid, t_marketid) " +
      "  SELECT DISTINCT 7 dlContrMsgType, d.t_id  MPID, d.t_marketid " +
      "   FROM ddlcontrmp_dbt d JOIN dsfcontr_dbt sf on d.t_sfcontrid = sf.t_id " +
      "  WHERE d.t_dlcontrid = :dlContrID " +
      "    AND d.t_marketid > 0 " +
      "    AND d.t_marketid in (2,151337) " +
      "    AND sf.t_dateclose = to_date('01010001','ddmmyyyy') " +
      "    AND (exists (SELECT 1 " +
      "                   FROM ddlcontrmsg_dbt dm " +
      "                  WHERE dm.t_dlcontrid = d.t_dlcontrid " +
      "                    AND dm.t_marketid = d.t_marketid " +
      "                    AND dm.t_mpcode  = d.t_mpcode " +
      "                    AND dm.t_kind = 2 " +
      "                    AND d.t_marketid = 151337 " +
      "          ) OR d.t_marketid = 2) ";

    cmd = RSDCommand(sql);
    cmd.AddParam("dlContrID", RSDBP_IN, dlContrID);
    cmd.Execute();



end;

/**
   @brief отправка уведомления на биржу
**/ 
MACRO SendMessageDBO()
    var sql            :String, 
        cmd            :Object, 
        DataSet        :Object, 
        statMes        :String,
        i              :Integer = 0;

    debugbreak;
		
	
    //Удаление категорий
    SQL_Execute("DELETE FROM DOBJATCOR_DBT WHERE T_OBJECTTYPE = 207 AND T_GROUPID = 140");
      
    //Создание таблицы dscqinv_dbt
    sql = 
   " DECLARE " +
   "  l_text VARCHAR2(1028); " +
   "l_cnt NUMBER; " +
   " BEGIN " +
   "    select count(*) into l_cnt from dba_tables where table_name = 'dscqinv_dbt';  " +   
   "    IF(l_cnt = 0) THEN" +
   "      l_text := 'CREATE TABLE user_dscqinv_dbt AS SELECT * FROM dscqinv_dbt'; " +
   "      EXECUTE IMMEDIATE l_text; " +
   "    END IF;    " +
   " END; ";
    SQL_Execute(sql); 

    //Зануление поля договор
    SQL_Execute("update dscqinv_dbt set t_sfcontrid = 0");

     
   //Отправка сообщений на биржу
    sql =                                                                                                                                             
     "  SELECT dl.t_dlcontrid " +
     "    FROM dsfcontr_dbt sf JOIN user_dscqinv_dbt uinv ON uinv.t_partyid = sf.t_partyid  " +
     "                                                    AND sf.t_id != uinv.t_sfcontrid  " +
     "                                                    AND sf.t_servkind = 0   " +
     "                          JOIN ddlcontr_dbt dl ON dl.t_sfcontrid = sf.t_id " +
     "                          JOIN dparty_dbt pr   ON pr.t_partyid = uinv.t_partyid " +
     "    WHERE sf.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') " +
     "      AND NOT EXISTS (SELECT 1  " +
     "                        FROM dpartyown_dbt  " +
     "                      WHERE t_partyid = uinv.t_partyid  " +
     "                        AND t_partykind =65) ";

    cmd = DL_RSDCommand();

    var cnt = cmd.GetCount(sql);

    RemProgress();

    if(cnt > 0)
        InitProgress(cnt, "Выполнение мероприятий по отправке ежегодных уведомлений", "Отправка уведомлений");
        DataSet = cmd.Execute(sql);
        while(DataSet.moveNext())

            insertDlContrGenMsg(DataSet.t_dlcontrid);
            СформироватьВсеСообщенияДБО(DataSet.t_dlcontrid);  
            UseProgress(i = i + 1);         
        end;
        RemProgress();
    end;

onerror(er)
    RemProgress();
    statMes =  "onError: " + er.message + " (модуль " + er.module + ", строка " + er.line + ")";
end;

SendMessageDBO();
