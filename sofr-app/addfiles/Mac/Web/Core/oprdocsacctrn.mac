/*
$Name:        oprdocsacctrn.mac
$Module:      Главная книга
$Description: Макрос списка проводок операции/шага операции
*/

import "ws_partycommon.mac";

class TWebOprDocsAccTrnGridItem
		var AccTrnID;
		var Status;
		var Numb_Document;
		var Date_Carry;
		var Account_From;
		var FICode_From;
		var Amount_From;
		var Account_To;
		var FICode_To;
		var Amount_To;
		var Oper;
		var ID_Step;
		var Ground;
end;

macro WebCore_GetWebOprDocsAccTrnGridItemList(ID_Operation, ID_Step)

  var cmd, rs;

  var Arr = TArray;

  var query = "   SELECT t.T_ACCTRNID AccTrnID,                                                  " +
              "          (SELECT acts.T_STATENAME                                                " + 
              "             FROM DACCTRN_STATE_DBT acts                                          " + 
              "            WHERE acts.T_STATE = acctrn.t_State)                                  " +
              "             Status,                                                              " +
              "          acctrn.T_NUMB_DOCUMENT Numb_Document,                                   " +
              "          ACCTRN.T_DATE_CARRY Date_Carry,                                         " +
              "          ACCTRN.T_ACCOUNT_PAYER Account_From,                                    " +
              "          (SELECT FI.T_FI_CODE                                                    " +
              "             FROM DFININSTR_DBT fi                                                " +
              "            WHERE FI.T_FIID = acctrn.T_FIID_PAYER)                                " +
              "             FICode_From,                                                         " +
              "          acctrn.T_SUM_PAYER Amount_From,                                         " +
              "          acctrn.T_ACCOUNT_RECEIVER Account_To,                                   " +
              "          (SELECT FI.T_FI_CODE                                                    " +
              "             FROM DFININSTR_DBT fi                                                " +
              "            WHERE FI.T_FIID = acctrn.T_FIID_RECEIVER)                             " +
              "             FICode_To,                                                           " +
              "          acctrn.T_SUM_RECEIVER Amount_To,                                        " +
              "          acctrn.T_OPER Oper,                                                     " +
              "          T.T_ID_STEP ID_Step,                                                    " +
              "          acctrn.T_GROUND Ground                                                  " +
              "     FROM DOPRDOCS_DBT t, dacctrn_dbt acctrn                                      " +
              "    WHERE     T.T_DOCKIND = ?                                                     " +
              "          AND t.T_ID_OPERATION = ?                                                ";
              
              
  if(ID_Step > 0)   
  query = query +            
              "          AND t.T_ID_STEP = ?                                                     ";
  end;
              
  query = query +               
              "          AND t.t_AccTrnID = acctrn.t_AccTrnID                                    "
              "          AND ( (acctrn.t_State = 1 OR acctrn.t_State = 2) OR acctrn.t_State = 3) "
              " ORDER BY t.t_id_operation, t.t_id_step, t.t_autokey                              ";
  
  cmd = RsdCommand(query);
  
  cmd.addParam( "DOCKIND", RSDBP_IN, 1 ); // DLDOC_CARRY    = 1 проводка в Центральной Бухгалтерии
  cmd.addParam( "ID_OPERATION", RSDBP_IN, ID_Operation );
  
  if(ID_Step > 0)   
    cmd.addParam( "ID_STEP", RSDBP_IN, ID_Step );
  end;
  
  cmd.NullConversion = true;
  
  rs = RsdRecordset(cmd);
  
  while(rs.movenext)

    var obj = TWebOprDocsAccTrnGridItem;

    obj.AccTrnID        = SQL_ConvType(rs.value("AccTrnID"));
    obj.Status          = SQL_ConvType(rs.value("Status"));
    obj.Numb_Document   = SQL_ConvType(rs.value("Numb_Document"));
    obj.Date_Carry      = SQL_ConvType(rs.value("Date_Carry"));
    obj.Account_From    = SQL_ConvType(rs.value("Account_From"));
    obj.FICode_From     = SQL_ConvType(rs.value("FICode_From"));
    obj.Amount_From     = SQL_ConvType(rs.value("Amount_From"));
    obj.Account_To      = SQL_ConvType(rs.value("Account_To"));
    obj.FICode_To       = SQL_ConvType(rs.value("FICode_To"));
    obj.Amount_To       = SQL_ConvType(rs.value("Amount_To"));
    obj.Oper            = SQL_ConvType(rs.value("Oper"));
    obj.ID_Step         = SQL_ConvType(rs.value("ID_Step"));
    obj.Ground          = SQL_ConvType(rs.value("Ground"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;