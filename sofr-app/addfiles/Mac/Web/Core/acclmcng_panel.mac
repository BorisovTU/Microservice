 /*
 $Name: acclmcng_panel.mac
 $Module: Главная книга
 $Description: Документ, изменяющий претензию
 */

import RsbDataSet, globals, oralib, likepy;
import BankInter;
import "ws_partycommon.mac";
import "ws_validation.mac";
import "account_scroll.mac";
import "ws_person.mac";
import "ws_datafilter.mac";
import "ws_llvalues.mac";
import "ws_partyclasses.mac";
import "ws_file.mac";
import "pmlib.mac";
import "acclmcng_scroll.mac";




class TWebAcClmCngObject

  var ChangeDocID   : integer; 
  
  var ClaimID       : integer;  
  
  var ClaimKind     : integer; 
  
  var RestKind      : integer;
  
  var ClaimIsAuto   : bool;  
  
  var Status        ;//TWebNameKind
  
  var SysDate       : Date;
  
  var DocDate       : Date;
  
  var DocNumber     : string ;
  
  var Initiator     ; //TWebAcClaimInit
  
  var FiscOrgParty  ; //TWsPartyEx
  
  var ChangeKind    ; //TWebNameKind
  
  var StartDate     : Date;
  
  var FinishDate    : Date;
  
  var Delta         : money;
  
  var Priority      : integer;   
  
  var MaxPriority   : integer;   
  
  var Comment       : string ;
    
  var Oper          ;// TWsPerson
  
  var Version       : integer;  

end;


Record  AcClmCngOldBuff  ("acclmcng.dbt");
  
Record  AcClmCngNewBuff ("acclmcng.dbt");

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;


macro GetNewAcClmCngObject(ChangeDocID):TWebAcClmCngObject

  var AcClmCngObject = TWebAcClmCngObject();

  var cmd, rs;
	
   var query = " SELECT *                    "
				
			  " FROM dacclmcng_dbt acclmcng "  
				
			  " WHERE acclmcng.T_CHANGEDOCID = ? " ;
    
  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);
  
  cmd.addParam( "", RSDBP_IN, ChangeDocID );

  if(rs.movenext)
  
    AcClmCngObject.ClaimID = SQL_ConvType(rs.value("T_CLAIMID" ));
	
	AcClmCngObject.SysDate = SQL_ConvType(rs.value("T_SYSDATE" ));
	
    AcClmCngObject.DocDate = SQL_ConvType(rs.value("T_DOCDATE" ));
	
	AcClmCngObject.StartDate = SQL_ConvType(rs.value("T_STARTDATE" ));
	
	AcClmCngObject.ChangeDocID = SQL_ConvType(rs.value("T_CHANGEDOCID" ));
	
	var query_inside1 = " SELECT *                   "
						" FROM dacclaim_dbt acclaim  "
						" WHERE acclaim.T_CLAIMID  = ? ";
	
	var  cmd_inside1 = RsdCommand(query_inside1);
	
	cmd_inside1.addParam( "", RSDBP_IN, AcClmCngObject.ClaimID );
		 
    var rs_inside1 = RsdRecordset(cmd_inside1);

	if(rs_inside1.movenext)
	
	  AcClmCngObject.ClaimKind = SQL_ConvType(rs_inside1.value("T_CLAIMKIND" ));
	  
	  AcClmCngObject.RestKind = SQL_ConvType(rs_inside1.value("T_RESTKIND" ));
	  
	  
	  if(SQL_ConvType(rs_inside1.value("T_AUTO" ))=="X")
	  
	    AcClmCngObject.ClaimIsAuto = true;
		 
	  else
		 
	    AcClmCngObject.ClaimIsAuto = false;
		  
	  end;
 
	  var query_inside2 = " SELECT acs.T_STATE AS T_ID "
						" FROM dacclmcngstate_dbt acs "
						" WHERE acs.T_CHANGEDOCID = " + AcClmCngObject.ChangeDocID +
						" AND acs.T_STATEDATE <= to_date('" + {curdate} + "', 'dd.mm.yyyy' )"
						" ORDER BY acs.T_STATEDATE DESC ";
	
	  var  cmd_inside2 = RsdCommand(query_inside2);
	  
	  cmd_inside2.NullConversion = true;
	  
	  //cmd_inside2.addParam( "", RSDBP_IN, AcClmCngObject.ChangeDocID );
	
	 // cmd_inside2.addParam( "", RSDBP_IN, {curdate} );
	 
      var rs_inside2 = RsdRecordset(cmd_inside2);

	  if(rs_inside2.movenext)

	    AcClmCngObject.Status  =  TWebNameKind();

		AcClmCngObject.Status.ID = SQL_ConvType(rs_inside2.value("T_ID" ));
		
		if(AcClmCngObject.Status.ID!=4)

		  if(({curdate} < SQL_ConvType(rs.value("T_STARTDATE"))) OR (((SQL_ConvType(rs.value("T_FINISHDATE")))!= date(0,0,0)) AND ((SQL_ConvType(rs.value("T_FINISHDATE"))) < {curdate} )))
		  
		    AcClmCngObject.Status.ID=5;
		  
		  end;
		  
		end;

		query_inside2 =  "SELECT  llv.t_Name      "
						 " FROM dllvalues_dbt llv "
						 " WHERE llv.T_ELEMENT =? "
						 " AND llv.T_LIST = 2528 ";
		
		cmd_inside2 = RsdCommand(query_inside2);
		
		cmd_inside2.addParam( "", RSDBP_IN, AcClmCngObject.Status.ID );
				 
		rs_inside2 = RsdRecordset(cmd_inside2);
		
		if(rs_inside2.movenext)
		
		  AcClmCngObject.Status.Name = SQL_ConvType(rs_inside2 .value("T_NAME"))
		
		end;
		
	  end;
	  
	  AcClmCngObject.DocNumber = SQL_ConvType(rs.value("T_DOCNUMBER" ));
	  
	  AcClmCngObject.Initiator = TWebAcClaimInit();
		
	  query_inside2 =  "SELECT aci.T_INITIATORID, aci.T_GROUP, aci.T_NAME "
						 " FROM dacclaiminit_dbt aci "
						 " WHERE aci.T_INITIATORID = ? ";

		
	  cmd_inside2 = RsdCommand(query_inside2);
		
	  cmd_inside2.addParam( "", RSDBP_IN, SQL_ConvType(rs.value("T_INITIATOR" )));
				 
	  rs_inside2 = RsdRecordset(cmd_inside2);
		
	  if(rs_inside2.movenext)
		
	    AcClmCngObject.Initiator.InitiatorID = SQL_ConvType(rs_inside2 .value("T_INITIATORID"));
		  
		AcClmCngObject.Initiator.Group = SQL_ConvType(rs_inside2 .value("T_GROUP"));
		  
		AcClmCngObject.Initiator.Name = SQL_ConvType(rs_inside2 .value("T_NAME"));
		
	  end;
		
	  AcClmCngObject.FiscOrgParty = TWsPartyEx();
		
	  query_inside2 =   " SELECT pt.T_PARTYID As partyid, pt.T_NAME As partyname, pcode.T_CODE As code "
						"  FROM dparty_dbt pt, dpartcode_dbt pcode    "
						"  WHERE pcode.T_CODE = ?                     "
						"  AND pcode.T_CODEKIND = 28                  "
						"  AND pt.T_PARTYID = pcode.T_PARTYID         ";

		
	  cmd_inside2 = RsdCommand(query_inside2);
		
	  cmd_inside2.addParam( "", RSDBP_IN, SQL_ConvType(rs.value("T_FISCORGCODE" )));
				 
	  rs_inside2 = RsdRecordset(cmd_inside2);

	  if(rs_inside2.movenext)
		
		AcClmCngObject.FiscOrgParty.partyid = SQL_ConvType(rs_inside2 .value("partyid"));
		  
		AcClmCngObject.FiscOrgParty.partyname = SQL_ConvType(rs_inside2 .value("partyname"));
		  
		AcClmCngObject.FiscOrgParty.code = SQL_ConvType(rs_inside2 .value("code"));
		
	  end;
		
		
	  AcClmCngObject.ChangeKind =  TWsLlvalues();
		
	  var query_inside3 = "  SELECT llv.T_ELEMENT AS t_ID, llv.T_NAME AS t_Name "
							" FROM dllvalues_dbt llv  "  
							" WHERE llv.T_ELEMENT = ? "
							" AND llv.T_LIST = 2524 ";
			
	  var cmd_inside3 = RsdCommand(query_inside3);
			
	  cmd_inside3.addParam( "", RSDBP_IN,SQL_ConvType(rs.value("T_CHANGEKIND")));
					 
	  var rs_inside3 = RsdRecordset(cmd_inside3);

	  if(rs_inside3.movenext)
			
		AcClmCngObject.ChangeKind.Element = SQL_ConvType(rs_inside3.value("T_ID"));
		  
		AcClmCngObject.ChangeKind.Name = SQL_ConvType(rs_inside3.value("T_NAME"));

	  end;
		
	  if(SQL_ConvType(rs.value("T_FINISHDATE"))!= Date("00.00.0000"))

		AcClmCngObject.FinishDate = SQL_ConvType(rs.value("T_FINISHDATE"));
		
	  else
		
		AcClmCngObject.FinishDate=null;
		
	  end;
		
	  if(SQL_ConvType(rs.value("T_DELTA"))!= 0)
		
		AcClmCngObject.Delta = SQL_ConvType(rs.value("T_DELTA"));
		
	  else
		
		AcClmCngObject.Delta=0;
		
	  end;
		
		AcClmCngObject.Priority = SQL_ConvType(rs.value("T_PRIORITY"));

		AcClmCngObject.MaxPriority = PM_DefaultMaxPriority();
		
		AcClmCngObject.Oper = FindPersonByNumber(SQL_ConvType(rs.value("T_OPER")));
		
		AcClmCngObject.Version = SQL_ConvType(rs.value("T_VERSION"));		
	
	end;
		
  end;
  
  return AcClmCngObject;

end;


macro WebCore_GetNewAcClmCngObject(ClaimID):TWebAcClmCngObject

  var AcClmCngObject = TWebAcClmCngObject();

  var query = " SELECT * "
				
			  " FROM dacclaim_dbt acclaim "  
				
			  " WHERE acclaim.T_CLAIMID = " + ClaimID + " ";
			  
  var cmd = RsdCommand(query);
  
  var  rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    AcClmCngObject.ClaimKind = SQL_ConvType(rs.value("T_CLAIMKIND" ));
	  
	AcClmCngObject.RestKind = SQL_ConvType(rs.value("T_RESTKIND" ));
	  	  
	if(SQL_ConvType(rs.value("T_AUTO" ))=="X")
	  
	  AcClmCngObject.ClaimIsAuto = true;
		 
	else
		 
	  AcClmCngObject.ClaimIsAuto = false;
		  
	end;
   	
	AcClmCngObject.Initiator = TWebAcClaimInit();
		
	var  query_inside =  "SELECT aci.t_InitiatorID, aci.t_Group, aci.t_Name "
						 " FROM dacclaiminit_dbt aci "
						 " WHERE aci.t_InitiatorID = ? ";

		
	var  cmd_inside = RsdCommand(query_inside);
		
	cmd_inside.addParam( "", RSDBP_IN, SQL_ConvType(rs.value("T_INITIATOR" )));
				 
	var  rs_inside = RsdRecordset(cmd_inside);

	if(rs_inside.movenext)
		
	  AcClmCngObject.Initiator.InitiatorID = SQL_ConvType(rs_inside.value("T_INITIATORID"));
		  
      AcClmCngObject.Initiator.Group = SQL_ConvType(rs_inside.value("T_GROUP"));
		  
	  AcClmCngObject.Initiator.Name = SQL_ConvType(rs_inside.value("T_NAME"));
		
	end;	  
	
	AcClmCngObject.Oper = FindPersonByNumber(SQL_ConvType(rs.value("T_OPER")));
	
	if(SQL_ConvType(rs.value("T_CLAIMKIND")) == ACCLAIM_KIND_SPECIAL )
	
	  AcClmCngObject.ChangeKind =  TWebNameKind();
		
	  query_inside = "  SELECT llv.t_Element AS t_ID, llv.t_Name AS t_Name "
							" FROM dllvalues_dbt llv  "  
							" WHERE llv.t_Element = ? "
							" AND llv.t_List = 2524 ";
			
	  cmd_inside = RsdCommand(query_inside);
			
	  cmd_inside.addParam( "", RSDBP_IN,ACCLAIM_KIND_SPECIAL);
					 
	  rs_inside = RsdRecordset(cmd_inside);
			
	  if(rs_inside.movenext)
			
		AcClmCngObject.ChangeKind.ID = SQL_ConvType(rs_inside.value("T_ID"));
		  
		AcClmCngObject.ChangeKind.Name = SQL_ConvType(rs_inside.value("T_NAME"));
			
	  end;
	
	end;
	
  end;
  
  AcClmCngObject.MaxPriority = PM_DefaultMaxPriority();
  
  AcClmCngObject.ClaimID = ClaimID;
  
  AcClmCngObject.SysDate = {curdate};
 	
  AcClmCngObject.DocDate = {curdate};
	
  AcClmCngObject.StartDate = {curdate};
	
  return AcClmCngObject;
		
end;
	

	
	
macro WebCore_GetAcClmCngObject(ChangeDocID)
	
  var AcClmCngObject;

  AcClmCngObject = GetNewAcClmCngObject(ChangeDocID);
  
  if(AcClmCngObject == null)
  		
	return null;
	
  else
  
    return AcClmCngObject;
	
  end;

end;


macro GetAcClmCngRecord(AcClmCng,AcClmCngBuff)
 
  AcClmCngBuff.CHANGEDOCID = AcClmCng.ChangeDocID;
  
  AcClmCngBuff.CLAIMID = AcClmCng.ClaimID;
  
  if(AcClmCng.DocNumber != null)
  
    AcClmCngBuff.DOCNUMBER = AcClmCng.DocNumber;
  
  end;
  
  AcClmCngBuff.DOCDATE = AcClmCng.DocDate;
  
  AcClmCngBuff.SYSDATE = AcClmCng.SysDate;

  if(AcClmCng.Initiator != null)
  
    AcClmCngBuff.INITIATOR = AcClmCng.Initiator.InitiatorID;
  
  end;
  
  if(AcClmCng.ChangeKind != null)
  
    AcClmCngBuff.CHANGEKIND = AcClmCng.ChangeKind.Element;
  
  end;

  AcClmCngBuff.DELTA = AcClmCng.Delta;
  
  AcClmCngBuff.OLDSTATE = 0;
  
  AcClmCngBuff.STARTDATE = AcClmCng.StartDate;
  
  AcClmCngBuff.FINISHDATE = AcClmCng.FinishDate;
  
  if(AcClmCng.FiscOrgParty != null)
  
    AcClmCngBuff.FISCORGCODE = AcClmCng.FiscOrgParty.code;
  
  end;
  
  AcClmCngBuff.PRIORITY = AcClmCng.Priority;
  
  if(AcClmCng.Comment != null)
  
    AcClmCngBuff.COMMENT = AcClmCng.Comment;
  
  end;
  
  if(AcClmCng.OPER != null)
	
    AcClmCngBuff.OPER = AcClmCng.Oper.Number;
  
  end;
  
   if(AcClmCng.ClaimIsAuto == true)
	  
	    AcClmCngBuff.AUTO = "X";
		 
  else
		 
	    AcClmCngBuff.AUTO = "";
		  
  end;
   
end;


macro WebCore_CheckInsUpdAcClmCng(AcClmCngOld , AcClmCngNew , CheckOnly  ): WebResponseBuilder

  var ChandeDocID=0;
 
  GetAcClmCngRecord(AcClmCngOld,AcClmCngOldBuff);
  
  GetAcClmCngRecord(AcClmCngNew,AcClmCngNewBuff );

  var res ;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  res = CB_CheckInsUpdAcClmCng(AcClmCngOldBuff, AcClmCngNewBuff,CheckOnly,ChandeDocID);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  if((res == true) AND (CheckOnly == false))
  
    responseBuilder.SetUserObject(ChandeDocID); 
  end;
  
   if((res != true) AND (CheckOnly == true))
  
    responseBuilder.SetUserObject(0); 
  end;
  
  return responseBuilder.Result;
  
end;

macro WebCore_GetAcClaimPriority(ClaimID, OnDate)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var cmd, rs;
	
  var query = " SELECT  acs.t_Priority "
			  " FROM dacclaimstate_dbt acs "
			  " WHERE acs.t_ClaimID = ? "
			  " AND acs.t_StateDate <= ? "
			  " ORDER BY acs.t_StateDate DESC " ;
 
  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, ClaimID );

  cmd.addParam( "", RSDBP_IN, OnDate );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    responseBuilder.SetUserObject(SQL_ConvType(rs.value("T_PRIORITY")));
  		
  else
  
	 responseBuilder.SetUserObject(0); 
	 
  end;
  
   return responseBuilder.Result;
 
end;


