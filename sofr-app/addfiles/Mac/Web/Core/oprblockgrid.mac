/*
$Name:        oprblockgrid.mac
$Module:      Главная книга
$Description: Cервисы  получения списка блоков шагов
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebOprBlockGridItem 
 
  var BlockID          	: integer ; 
  
  var Name     			: String ; 
  
  var DocKind         	: integer ; 
  
  var DocKindName       : String ; 
  
  var Parent       		: integer ; 
   
  var Upgrade       	: bool ; 
  
  var Version       	: String ; 
       
end;




PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if(CurValue == "X")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro WebCore_GetOprBlockGridItem (PageSize, PageNum): TArray

  var result = TArray();

  var cmd, rs;
	
  var query = "  SELECT t.t_blockid, t.t_name, t.t_dockind,		"
			  "		(SELECT okd.t_name							"
			  "		FROM DOPRKDOC_DBT okd						"
			  "		WHERE okd.t_dockind = t.t_dockind)			"
			  "		AS dockindname,								"
			  "		t.t_parent, t.t_upgrade, t.t_version		"
			  "  FROM doprblock_dbt t							"
			  "  ORDER BY t.t_blockid							";
 
  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;
  
  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var obj = TWebOprBlockGridItem();
	
	obj.BlockID = SQL_ConvType(rs.value("t_blockid"));
	
	obj.Name = SQL_ConvType(rs.value("t_name"));
	
	obj.DocKind = SQL_ConvType(rs.value("t_dockind"));
	
	obj.DocKindName = SQL_ConvType(rs.value("dockindname"));
	
	obj.Parent = SQL_ConvType(rs.value("t_parent"));
	
	obj.Upgrade = ConvertCharToBool(SQL_ConvType(rs.value("t_upgrade")));
	
	obj.Version = SQL_ConvType(rs.value("t_version"));
	
	result[result.size] = obj;
	  	  
  end;

  return result;
  
end;

macro WebCore_GetOprBlockGridItemCount():integer

  var cmd, rs;

  var res : integer = 0;
  
  var query = "  SELECT count(*)	c	"
			  "  FROM doprblock_dbt t	"
			  "  ORDER BY t.t_blockid	";
    
  cmd = RsdCommand(query);


  rs = RsdRecordset(cmd);

  if(rs.movenext)

    res = rs.value("c");

  end;

  return res;

end;

macro WebCore_DeleteOprBlock(BlockID):WebResponseBuilder

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_DeleteOprBlock(BlockID);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
  
end;

