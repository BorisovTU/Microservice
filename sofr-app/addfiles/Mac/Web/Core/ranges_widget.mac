/*
$Name:        Ranges_widget.mac
$Module:      Главная книга
$Description: сервисы для виджета выбора КУ
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";

class TWebMcPeriodListerItem 
 
  var Number        : integer ; 
  
  var Name          : String ; 
    
  var LowBound      : integer ; 
  
  var LowBoundUnit  : integer ;  
  
  var IsLowInclude  : bool ; 
  
  var HighBound     : integer ;
  
  var HighBoundUnit : integer;
  
  var IsHighInclude : integer ;   
    
end;

class TWebMcPeriod 
 
  var Number   : integer ; 
  
  var Name     : String ; 
    
end;



PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro WebCore_GetMcPeriodListerItemList(GroupNum, Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DMCPERIOD_DBT MCPERIOD ";
	
  var query_cond =" WHERE 1 = 1 ";
   
  if(GroupNum != 0)
  
    query_cond = query_cond + " AND MCPERIOD.T_GROUPNUM = " + GroupNum ;
	  	  
  end;
	  	  
  if(Str != null)
  
    query_cond = query_cond +" AND LOWER(T_NAME) LIKE LOWER ('%' || ? || '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY MCPERIOD.T_NUMBER ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebMcPeriodListerItem;
	
	obj.Number = rs.value("T_NUMBER");
	
    obj.Name = rs.value("T_NAME");
	
    obj.LowBound =  rs.value("T_LOWBOUND");
	
	obj.LowBoundUnit = rs.value("T_LOWBOUNDUNIT");
	
    obj.IsLowInclude = rs.value("T_ISLOWINCLUDE");
	
    obj.HighBound =  rs.value("T_HIGHBOUND");
	
	obj.HighBoundUnit = rs.value("T_HIGHBOUNDUNIT");
	
    obj.IsHighInclude = rs.value("T_ISHIGHINCLUDE");
		
	result[result.size] = obj;

  end; 

  return result;
  
end;


macro WebCore_GetTWebMcPeriodListerItemObj(GroupNum)

  var obj;

  var cmd, rs;

  var query = " SELECT * FROM DMCPERIOD_DBT MCPERIOD WHERE MCPERIOD.T_NUMBER = ? ";
  
  cmd = RsdCommand(query);
 
  cmd.addParam( "", RSDBP_IN, GroupNum );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebMcPeriodListerItem;
	
	obj.Number = rs.value("T_NUMBER");
	
    obj.Name = rs.value("T_NAME");
	
    obj.LowBound =  rs.value("T_LOWBOUND");
	
	obj.LowBoundUnit = rs.value("T_LOWBOUNDUNIT");
	
    obj.IsLowInclude = rs.value("T_ISLOWINCLUDE");
	
    obj.HighBound =  rs.value("T_HIGHBOUND");
	
	obj.HighBoundUnit = rs.value("T_HIGHBOUNDUNIT");
	
    obj.IsHighInclude = rs.value("T_ISHIGHINCLUDE");

  end;

  return obj;

end;
