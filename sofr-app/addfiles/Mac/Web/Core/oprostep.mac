/*
$Name:        oprostep.mac
$Module:      Главная книга
$Description: сервисы для виджета выбора шагов операции.
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";


class TWebOprOStepListerItem 
 
  var BlockID     	: integer ;

  var Number_Step  	: integer ;  
  
  var Symbol     	: String ;

  var Name  		: String ;  
  
    
end;

class TWebOprOStep  
 
  var BlockID     	: integer ;

  var Number_Step  	: integer ;  
  
  var Symbol     	: String ;

  var Name  		: String ;  
  
    
end;



PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro WebCore_GetOprOStepListerItem(BlockID, Str) : TArray

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT  OPR.T_BLOCKID, OPR.T_NUMBER_STEP,	"
			  " OPR.T_SYMBOL, OPR.T_NAME					"
			  "	FROM DOPROSTEP_DBT OPR						"
			  " WHERE OPR.T_BLOCKID= ? 						";
			  
  if(Str != "")
  
    query = query +" AND LOWER(T_SYMBOL) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;

  query = query + " ORDER BY OPR.T_NUMBER_STEP   ";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, BlockID );
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebOprOStepListerItem;
	
    obj.BlockID = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.Number_Step  = SQL_ConvType(rs.value("T_NUMBER_STEP"));
	
	obj.Symbol  = SQL_ConvType(rs.value("T_SYMBOL"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

    Arr[Arr.size] = obj;

  end;

  return Arr;
  
end;

macro GetOprOStepFromBD (BlockID, Number_Step) 

  var obj = TWebOprOStep();

  var cmd, rs;

  var query = " SELECT  OPR.T_BLOCKID, OPR.T_NUMBER_STEP,				"
			  " OPR.T_SYMBOL, OPR.T_NAME								"
			  "	FROM DOPROSTEP_DBT OPR									"
			  " WHERE OPR.T_BLOCKID = ? AND OPR.T_NUMBER_STEP = ?	   	";

  cmd = RsdCommand(query);

  cmd.addParam( "BlockID", RSDBP_IN, BlockID );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.BlockID = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.Number_Step  = SQL_ConvType(rs.value("T_NUMBER_STEP"));
	
	obj.Symbol  = SQL_ConvType(rs.value("T_SYMBOL"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

  end;

  return obj;

end;

macro GetFirstOprOStepFromBD (BlockID) 

  var obj = TWebOprOStep();

  var cmd, rs;

  var query =" SELECT  OPR.T_BLOCKID, OPR.T_NUMBER_STEP,				"
			  " OPR.T_SYMBOL, OPR.T_NAME								"
			  "	FROM DOPROSTEP_DBT OPR									"
			  " WHERE OPR.T_BLOCKID = ? AND OPR.T_FIRSTSTEP = CHR(88)	";

  cmd = RsdCommand(query);

  cmd.addParam( "BlockID", RSDBP_IN, BlockID );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.BlockID = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.Number_Step  = SQL_ConvType(rs.value("T_NUMBER_STEP"));
	
	obj.Symbol  = SQL_ConvType(rs.value("T_SYMBOL"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

  end;

  return obj;

end;


