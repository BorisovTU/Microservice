 /*
 $Name: confirmtypes.mac
 $Module: Главная книга
 $Description: Макрос списка типов подтверждений
 */

import BankInter;
import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";


class TWebOprrcptpGridItem

  var  ReceiptType  : integer;   
   
  var  Desc  		: string ;
  
  var  ShortDesc  	: string ;
  
  var  Version  	: integer;

end;

class TWebOprrcptpPanel

  var  Is_New		: bool;   

  var  ReceiptType  : integer;   
   
  var  Desc  		: string  = "";
  
  var  ShortDesc  	: string = "";
  
  var  Version  	: integer;

end;



PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_GetOprrcptpGridItem (): TArray

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT  t.*					"
			  "	FROM doprrcptp_dbt t		"
			  "	ORDER BY t.t_receipttype    ";

  

  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebOprrcptpGridItem;
	
    obj.ReceiptType = SQL_ConvType(rs.value("T_RECEIPTTYPE"));
	
    obj.Desc  = SQL_ConvType(rs.value("T_DESC"));
	
	obj.ShortDesc  = SQL_ConvType(rs.value("T_SHORTDESC"));
	
	obj.Version  = SQL_ConvType(rs.value("T_VERSION"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;  

macro WebCore_DeleteOprrcptp (ReceiptType):WebResponseBuilder

  var res ;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_DeleteOprrcptp(ReceiptType);

  if(res != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;    

macro WebCore_InitOprrcptp() 
          
  var cmd, rs;

  var obj = TWebOprrcptpPanel;

  var query = " SELECT Max(t.t_receipttype) RECEIPTTYPE "
			  "	FROM  doprrcptp_dbt t	      			";

  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    obj.Is_New = true;
	
	obj.Version = 0;
	
	if(SQL_ConvType(rs.value("RECEIPTTYPE")) > 10000)
	
	   obj.ReceiptType = SQL_ConvType(rs.value("RECEIPTTYPE"))+1;
	
	else
	
	  obj.ReceiptType = 10001
	
	end;

  end;

  return obj;
  
end;

macro WebCore_InsUpdOprrcptp(OprrcptpPanel):WebResponseBuilder

  var res;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var oprrcptpRec  = TRecHandler("oprrcptp");

  oprrcptpRec.rec.ReceiptType = OprrcptpPanel.ReceiptType;
  
  oprrcptpRec.rec.Desc =  OprrcptpPanel.Desc;
  
  oprrcptpRec.rec.ShortDesc =  OprrcptpPanel.ShortDesc;
  
  oprrcptpRec.rec.Version =  OprrcptpPanel.Version;

   res = CB_InsertUpdateOprrcptp(oprrcptpRec, OprrcptpPanel.Is_New);

  if(res != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;
