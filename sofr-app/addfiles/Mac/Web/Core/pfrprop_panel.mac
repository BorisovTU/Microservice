 /*
 $Name: pfrprop_panel.mac
 $Module: Главная книга
 $Description: Макрос реквизитов ПФР
 */

import PTInter;
import "ws_validation.mac";
import "ws_datafilter.mac";


class TWebPTPFPropPanel 
  var ID : Integer;        // Ид. записи реквизитов ПФР
  var RegNumber : String;  // Регистрационный номер ПФР
  var RegionCode : String; // Код района ПФР
  var SynchDate : bool;    // Данные синхронизированы с ПФР

end;

macro CheckRestriction0030() 
  return CheckActionRestriction(30)== true;
end;

macro WebCore_GetPTPFPropPanel(PersonID) //: WebServiceResponse<TWebPTPFPropPanel>
  
var rb = WebResponseBuilder();
  
  var PartyObj = RsbParty(PersonID);
  var PFProp = PartyObj.PartyPFProp();
  
  if(not PFProp.First())
    rb.SetUserObject(null);    
  else
    var obj = TWebPTPFPropPanel();
    
    obj.ID = PFProp.RecID;
    obj.RegNumber = PFProp.REGNUMBER;
    obj.RegionCode = PFProp.REGIONCODE;
    obj.SynchDate = PFProp.SYNCHDATE;
    
    rb.SetUserObject(obj);
  end;
  
  return rb.Result;
end;

macro WebCore_DeletePTPFProp(PersonID, PFPropID) :WebServiceResponse

  var rb = WebResponseBuilder();
  
  var PartyObj = RsbParty(PersonID);
  var PFProp = PartyObj.PartyPFProp();
  var stat = PFProp.GetByRecID(PFPropID);
  
  if( stat == 0 )   
    stat = PFProp.Delete();
  end;  
  
  var stat2 = true;
  if( stat == 0 )     
    stat2 = PartyObj.Update();
  end;   
  
  if((stat != 0) or (stat2 == false))
    var objErr = AL_GetErrorInfo();
    rb.AddErrorEx(objErr.stat, MessageSeverity.RuntimeError, objerr.message);
  end;
  
  rb.SetUserObject((stat == 0) AND (stat2) );
  return rb.Result();
end;

macro WebCore_UpdPTPFProp(PersonID, PTPFPropPanel) : WebServiceResponse

  var rb = WebResponseBuilder();
  
  var PartyObj = RsbParty(PersonID);
  var PFProp = PartyObj.PartyPFProp();
  var stat = PFProp.GetByRecID(PTPFPropPanel.ID);

  var stat2 = true;
  if(stat == 0)
  
    PFProp.RegNumber = PTPFPropPanel.RegNumber;
    PFProp.RegionCode   = PTPFPropPanel.RegionCode;
    PFProp.SynchDate = PTPFPropPanel.SynchDate;

    stat2 = PartyObj.Update();
  end;
  
  
  if((stat != 0) or (stat2 == false))
    var objErr = AL_GetErrorInfo();
    rb.AddErrorEx(objErr.stat, MessageSeverity.RuntimeError, objerr.message);
  end;
  
  rb.SetUserObject((stat == 0) AND (stat2) );
  
  return rb.Result();
end;


