/*
$Name:        account_anl_sub.mac
$Module:      Главная книга
$Description: Макрос субсчета
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";

class TWebAccSubObject 
 
  var AccanaliticsID  : integer ; 
  
  var SubAccountID    : Integer ; 
  
  var ParentID        : integer ; 
  
  var SubAccountCode  : String ;  
  
  var SpecialType     : integer ; 
  
  var Status          : integer ;
  
  var Rest            : Money;
  
  var Debet           : Money ;   
  
  var Credit          : Money;  
  
  var Analiticsid     : integer; 
  
end;

class TWebAccSubDCGridItem 
 
  var SubCarryId          : integer ; 
  
  var SubAccoyntPayer     : String ; 
  
  var SubAccountReceiver  : String ; 
  
  var Date_Carry          : Date ;  
  
  var Sum                 : Money ; 
  
end;

class TWebAccSubDCComboBoxItem 
 
  var SubAccountId       : integer ; 
  
  var SubAccountCode     : String ; 
   
end;


class TWebAccSubDCPanelObject 
 
  var SubCarryId         : integer ; 
  
  var AccAnaliticsId     : integer ; 
  
  var Status             : integer ; 
  
  var SubAccoyntPayer    ;//TWebAccSubDCComboBoxItem
  
  var SubAccountReceiver ;//TWebAccSubDCComboBoxItem
  
  var Date_Carry         : Date ;  
  
  var Sum                : Money ; 
  
end;

class TWebAccSubRDGridItem 
 
  var Date_Carry : Date ; 
  
  var Rest       : Money ; 
  
  var Debet      : Money ; 
  
  var Credit     : Money ; 
    
end;

class TWebAccSubRPGridItem 
 
  var PeriodNum  : integer ; 
  
  var Rest       : Money ; 
  
  var Debet      : Money ; 
  
  var Credit     : Money ; 
    
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro WebCore_GetTWebAccSubObject(AnaliticsID, SubAccountID, Input ) : TWebAccSubObject
  
  var obj;

  var cmd, rs;
  
  var query;
  
  if(Input == true)
  
    if((AnaliticsID!=0) AND (SubAccountID!=0))
  
    query = " SELECT * 				   				"
				
		    " FROM daccsub_dbt accsub  				"  
				
			" WHERE accsub.T_ACCANALITICSID = ? AND " 
			  
			" accsub.T_SUBACCOUNTID = ? 			" ;

    cmd = RsdCommand(query);

    cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
    cmd.addParam( "", RSDBP_IN, SubAccountID );

    rs = RsdRecordset(cmd);

    if(rs.movenext)

      obj = TWebAccSubObject();

      obj.AccanaliticsID = AnaliticsID;
	
      obj.SubAccountID   = SubAccountID;
	
      obj.ParentID       = SubAccountID;
	
      obj.SubAccountCode = "";
	
	  obj.Analiticsid    = rs.value("T_ANALITICSID");

    end;
	
  end;
  
   if((AnaliticsID!=0) AND (SubAccountID==0))
  
    query = " SELECT vanl.T_ANALITICSID       "
				
			" FROM DACCVANL_DBT vanl          "  
				
			" WHERE vanl.T_ACCANALITICSID = ? " ;

    cmd = RsdCommand(query);

    cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
    cmd.addParam( "", RSDBP_IN, SubAccountID );

    rs = RsdRecordset(cmd);

    if(rs.movenext)

      obj = TWebAccSubObject();

      obj.AccanaliticsID = AnaliticsID;
	
      obj.SubAccountID   = SubAccountID;
	  
	  obj.SubAccountCode = "";
	  
	  obj.ParentID = 0;
	
	  obj.Analiticsid    = rs.value("T_ANALITICSID");

    end;
  end;
  
  else
  
      query =  " SELECT                                        " ;
      query = query + "   T_PARENTID,                                 " ;
      query = query + "   T_SUBACCOUNTCODE,                                 " ;
      query = query + "   T_SPECIALTYPE,                                 " ;
      query = query + "   T_STATUS,                                 " ;
      query = query + "   T_ANALITICSID,                                 " ;
      query = query + "   NVL(rsb_account.restsa(T_ACCANALITICSID, T_SUBACCOUNTID, " ;
      query = query + "       DECODE(NVL(RsbSessionData.DprtCurDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY'), TRUNC(SYSDATE), RsbSessionData.DprtCurDate), " ;
      query = query + "        1), 0) T_REST,                                 " ;
      query = query + "   CAST(rsb_account.debetsa " ;
      query = query + "       (                                         " ;
      query = query + "         T_ACCANALITICSID, T_SUBACCOUNTID, " ;
      query = query + "         ADD_MONTHS(TO_DATE('01.' || TO_CHAR(DECODE(NVL(RsbSessionData.DprtCurDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY'), TRUNC(SYSDATE), RsbSessionData.DprtCurDate), 'MM.YYYY'), 'DD.MM.YYYY'), 0), " ;
      query = query + "         ADD_MONTHS(TO_DATE('01.' || TO_CHAR(DECODE(NVL(RsbSessionData.DprtCurDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY'), TRUNC(SYSDATE), RsbSessionData.DprtCurDate), 'MM.YYYY'), 'DD.MM.YYYY') - 1, 1) " ;
      query = query + "       ) AS NUMBER(32,12)) T_DEBET,                                " ;
      query = query + "   CAST(rsb_account.creditsa " ;
      query = query + "       (                                         " ;
      query = query + "         T_ACCANALITICSID, T_SUBACCOUNTID, " ;
      query = query + "         ADD_MONTHS(TO_DATE('01.' || TO_CHAR(DECODE(NVL(RsbSessionData.DprtCurDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY'), TRUNC(SYSDATE), RsbSessionData.DprtCurDate), 'MM.YYYY'), 'DD.MM.YYYY'), 0), " ;
      query = query + "         ADD_MONTHS(TO_DATE('01.' || TO_CHAR(DECODE(NVL(RsbSessionData.DprtCurDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY'), TRUNC(SYSDATE), RsbSessionData.DprtCurDate), 'MM.YYYY'), 'DD.MM.YYYY') - 1, 1) " ;
      query = query + "       ) AS NUMBER(32,12)) T_CREDIT                                " ;
      query = query + " FROM daccsub_dbt accsub                       " ; 
      query = query + " WHERE accsub.T_ACCANALITICSID = ? AND " ;
      query = query + " accsub.T_SUBACCOUNTID = ?                     " ;

    cmd = RsdCommand(query);

    cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
    cmd.addParam( "", RSDBP_IN, SubAccountID );

    rs = RsdRecordset(cmd);

    if(rs.movenext)

      obj = TWebAccSubObject();

      obj.AccanaliticsID = AnaliticsID;
	
      obj.SubAccountID   = SubAccountID;
	
      obj.ParentID       = rs.value("T_PARENTID");
	
      obj.SubAccountCode = rs.value("T_SUBACCOUNTCODE");
	
      obj.SpecialType    = rs.value("T_SPECIALTYPE");
	
	  obj.Status         = rs.value("T_STATUS");
	
	  obj.Rest           = rs.value("T_REST");
	
      obj.Debet          = rs.value("T_DEBET");
	
      obj.Credit         = rs.value("T_CREDIT");
	
	  obj.Analiticsid    = rs.value("T_ANALITICSID");

    end;
  
  end;
  
  return obj;
  
end;


macro WebCore_Ins_vanl(AnaliticsID, Chapter, Code_Currency, Account) : WebResponseBuilder
   
  var responseBuilder = WebResponseBuilder();
    
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var res;
  
  res = InsertAnaliticSubAcc(AnaliticsID, Code_Currency, Chapter, Account );
  	
  if(res != 0)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;
  
end;

macro WebCore_CB_InsertUpdateSubAccount (AccSubObject, AccSubObjectSave, Input) : WebResponseBuilder

  Record  accsubRec ("accsub.dbt");
  
  Record  accsubOldRec  ("accsub.dbt");
  
  Record  accvanlRec ("accvanl.dbt");
  
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var res;
  
  var rs, query, cmd;
  
  if(Input == true)
  
    accsubRec.AccAnaliticsID = AccSubObject.AccAnaliticsID;
	
	accsubRec.SubAccountID = AccSubObject.SubAccountID;
	
	accsubRec.SubAccountCode = AccSubObject.SubAccountCode;
	
	accsubRec.ParentID = AccSubObject.SubAccountID;
	
	accsubRec.HaveChild = "X";
	
	accsubRec.SpecialType = AccSubObject.SpecialType;
	
	accsubRec.Status = AccSubObject.Status;
	
	accsubRec.AnaliticsID = AccSubObject.Analiticsid;
	
   
  end;
  
  if(Input == false)
  
    query = " SELECT *  FROM DACCSUB_DBT  accsub   "
			  " WHERE accsub.T_ACCANALITICSID = ? AND T_SUBACCOUNTID = ? ";
    
    cmd = RsdCommand(query);
  
    cmd.addParam( "", RSDBP_IN, AccSubObject.AccanaliticsID);
  
    cmd.addParam( "", RSDBP_IN, AccSubObject.SubAccountID);
   
    rs = RsdRecordset(cmd);

    if(rs.movenext)

      accsubRec.AccAnaliticsID = AccSubObject.AccAnaliticsID;
	
	  accsubRec.SubAccountID = AccSubObject.SubAccountID;
	
	  accsubRec.SubAccountCode = AccSubObject.SubAccountCode;
	
	  accsubRec.ParentID = AccSubObject.SubAccountID;
	
	  accsubRec.HaveChild = "X";
	
	  accsubRec.SpecialType = AccSubObject.SpecialType;
	
	  accsubRec.Status = AccSubObject.Status;

	  accsubRec.AnaliticsID = rs.value("T_ANALITICSID");
	
  
    end;
  
    query = " SELECT *  FROM DACCSUB_DBT  accsub   "
			" WHERE accsub.T_ACCANALITICSID = ? AND T_SUBACCOUNTID = ? ";
    
    cmd = RsdCommand(query);
  
    cmd.addParam( "", RSDBP_IN, AccSubObjectSave.AccAnaliticsID);
  
    cmd.addParam( "", RSDBP_IN, AccSubObjectSave.SubAccountID);
   
    rs = RsdRecordset(cmd);

    if(rs.movenext)
  
      accsubOldRec.AccAnaliticsID = AccSubObjectSave.AccAnaliticsID;
	
	  accsubOldRec.SubAccountID = AccSubObjectSave.SubAccountID;
	
	  accsubOldRec.SubAccountCode = AccSubObjectSave.SubAccountCode;
	
	  accsubOldRec.ParentID = AccSubObjectSave.ParentID;
	
	  accsubOldRec.HaveChild = rs.value("T_HAVECHILD");
	
	  accsubOldRec.SpecialType = AccSubObjectSave.SpecialType;
	
	  accsubOldRec.Status = AccSubObjectSave.Status;

	  accsubOldRec.AnaliticsID = rs.value("T_ANALITICSID");
	
  
    end;
  
  end;
  
  query = " SELECT *  FROM DACCVANL_DBT  accvanl   "
		  "	WHERE accvanl.T_ACCANALITICSID = ?     ";
    
  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AccSubObject.AccanaliticsID );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    accvanlRec.ACCANALITICSID = rs.value("T_ACCANALITICSID");
	
	accvanlRec.ANALITICSID = rs.value("T_ANALITICSID");
	
	accvanlRec.CHAPTER = rs.value("T_CHAPTER");
	
	accvanlRec.FIID = rs.value("T_FIID");
	
	accvanlRec.ACCOUNT = rs.value("T_ACCOUNT");
	
  end;
  
  if(Input == true)
  
    if((accsubRec != null) AND (accvanlRec != null) )

      res = CB_InsertSubAccount(accvanlRec, accsubRec);
  
    end;
  
  else
  
   if((accsubRec != null) AND (accvanlRec != null) )
  
      res = CB_UpdateSubAccount(accsubRec, accsubOldRec);
  
    end;
  
  end;
     
  if(res != 0)

    AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(accsubRec.SubAccountID);
  
  return responseBuilder.Result;

end;

macro WebCore_GetAccSubDCGridItemList(PageSize, PageNum, AnaliticsID, Status, SubAccountID, FromDate, ToDate)

  var result = TArray();
   
  var query = " SELECT acsdc.T_SUBCARRYID SUBCARRYID,                                  "
              "  (SELECT ACS.T_SUBACCOUNTCODE                                          "
              "   FROM DACCSUB_DBT acs                                                 "
              "   WHERE     ACS.T_SUBACCOUNTID = acsdc.T_SUBACCOUNTPAYERID             "
              "   AND ACS.T_ACCANALITICSID = acsdc.T_ACCANALITICSID)                   "
              "   PAYER, acsdc.T_SUBACCOUNTPAYERID,                                    "
              " (SELECT ACS.T_SUBACCOUNTCODE                                           "
              "  FROM DACCSUB_DBT acs                                                  "
              "  WHERE     ACS.T_SUBACCOUNTID = acsdc.T_SUBACCOUNTRECEIVERID           "
              "  AND ACS.T_ACCANALITICSID = acsdc.T_ACCANALITICSID)                    "
              " RECEIVER, acsdc.T_DATE_CARRY DATE_CARRY ,acsdc.T_SUM SUM               "
              " FROM DACCSUB_DBT acs, DACCSUBDC_DBT acsdc                              "
              " WHERE     ACS.T_ACCANALITICSID = acsdc.T_ACCANALITICSID                "
			  " AND (ACSDC.T_SUBACCOUNTPAYERID = ACS.T_SUBACCOUNTID OR                 "
			  " ACSDC.T_SUBACCOUNTRECEIVERID = ACS.T_SUBACCOUNTID)                     "
              " AND ACS.T_ACCANALITICSID = :AnaliticsID                                "
              " AND ACSDC.T_STATUS = :Status                                           "
              " AND ACS.T_SUBACCOUNTID = :SubAccountID                                 ";
    
  
  
  if((FromDate!= null) AND (FromDate!= Date("00.00.0000")))
   
    query = query + " AND ACSDC.T_DATE_CARRY >= :FromDate " ;   
   
  end;
  
  if((ToDate!= null) AND (ToDate!= Date("00.00.0000")))
   
    query = query + " AND ACSDC.T_DATE_CARRY <= :ToDate " ; 
   
  end;
  
  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;
 
  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
  cmd.addParam( "", RSDBP_IN, Status );
  
  cmd.addParam( "", RSDBP_IN, SubAccountID );
  
  
  if((FromDate!= null) AND (FromDate!= Date("00.00.0000")))
   
    cmd.addParam( "", RSDBP_IN, FromDate );    
   
  end;
  
  if((ToDate!= null) AND (ToDate!= Date("00.00.0000")))
   
    cmd.addParam( "", RSDBP_IN, ToDate );
   
  end;
  
  var rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var obj =  TWebAccSubDCGridItem();
	
    obj.SubCarryId =  rs.value("SUBCARRYID");
  
    obj.SubAccoyntPayer = rs.value("PAYER");
  
    obj.SubAccountReceiver = rs.value("RECEIVER");
  
    obj.Date_Carry = rs.value("DATE_CARRY");
  
    obj.Sum = rs.value("SUM");
  
    result[result.size]=obj;
  
  end;
  
  return result;

end;

macro WebCore_GetAccSubDCGridItemCount( AnaliticsID, Status, SubAccountID,  FromDate, ToDate):integer

  var count;

  var query = " SELECT count(*)	c									     "
              " FROM DACCSUB_DBT acs, DACCSUBDC_DBT acsdc                "
              " WHERE     ACS.T_ACCANALITICSID = acsdc.T_ACCANALITICSID  "
			  " AND (ACSDC.T_SUBACCOUNTPAYERID = ACS.T_SUBACCOUNTID OR   "
			  " ACSDC.T_SUBACCOUNTRECEIVERID = ACS.T_SUBACCOUNTID)       "
              " AND ACS.T_ACCANALITICSID = :AnaliticsID                  "
              " AND ACSDC.T_STATUS = :Status                             "
              " AND ACS.T_SUBACCOUNTID = :SubAccountID                   ";
    
  
  
  if((FromDate!= null) AND (FromDate!= Date("00.00.0000")))
   
    query = query + " AND ACSDC.T_DATE_CARRY >= :FromDate " ;   
   
  end;
  
  if((ToDate!= null) AND (ToDate!= Date("00.00.0000")))
   
    query = query + " AND ACSDC.T_DATE_CARRY <= :ToDate " ; 
   
  end;

  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
  cmd.addParam( "", RSDBP_IN, Status );
  
  cmd.addParam( "", RSDBP_IN, SubAccountID );
  
  if((FromDate!= null) AND (FromDate!= Date("00.00.0000")))
   
    cmd.addParam( "", RSDBP_IN, FromDate );    
   
  end;
  
  if((ToDate!= null) AND (ToDate!= Date("00.00.0000")))
   
    cmd.addParam( "", RSDBP_IN, ToDate );
   
  end;
  
  var rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    count =  rs.value("c");
  
  end;
  
  return count;

end;

macro WebCore_DeleteAccSubDC(SubCarryID):WebResponseBuilder

  responseBuilder =WebResponseBuilder();
    
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var res = CB_DeleteAccSubDC(SubCarryID);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;

end;

macro WebCore_GetAccSubDCPanelObject(SubCarryId):TWebAccSubDCPanelObject

  var obj = TWebAccSubDCPanelObject();
   
  var query = " SELECT acsdc.T_SUBCARRYID SUBCARRYID,  									   "
              " acsdc.T_ACCANALITICSID ACCANALITICSID, acsdc.T_DATE_CARRY DATE_CARRY,      "
			  " acsdc.T_SUM SUM, acsdc.T_SUBACCOUNTPAYERID SUBACCOUNTPAYERID,              "
			  " acsdc.T_SUBACCOUNTRECEIVERID SUBACCOUNTRECEIVERID, acsdc.T_STATUS STATUS,  "			  
			   "(SELECT ASUB.T_SUBACCOUNTCODE											   "
			   " FROM DACCSUB_DBT asub                																		  "
			   " WHERE ASUB.T_SUBACCOUNTID = acsdc.T_SUBACCOUNTPAYERID AND ASUB.T_ACCANALITICSID = acsdc.T_ACCANALITICSID  )  "
			   "SUBACCOUNTCODEPAYER, 																						  "
			   "(SELECT ASUB.T_SUBACCOUNTCODE																				  "
               " FROM DACCSUB_DBT asub																						  "
               " WHERE ASUB.T_SUBACCOUNTID = acsdc.T_SUBACCOUNTRECEIVERID AND ASUB.T_ACCANALITICSID = acsdc.T_ACCANALITICSID )"
               "SUBACCOUNTCODERECEIVER																						  "
              " FROM  DACCSUBDC_DBT acsdc                              					   "
              " WHERE   ACSDC.T_SUBCARRYID = :SubCarryId          						   ";
	  
  var  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, SubCarryId );
  
  var rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    obj.SubCarryId =  rs.value("SUBCARRYID");
	
	obj.AccAnaliticsId =  rs.value("ACCANALITICSID");
	 
	obj.Status =  rs.value("STATUS");
	  
	obj.SubAccoyntPayer = TWebAccSubDCComboBoxItem();
	
	obj.SubAccoyntPayer.SubAccountId = rs.value("SUBACCOUNTPAYERID");
		   
	obj.SubAccountReceiver = TWebAccSubDCComboBoxItem();
	
	obj.SubAccountReceiver.SubAccountId = rs.value("SUBACCOUNTRECEIVERID");
			
	obj.Date_Carry = rs.value("DATE_CARRY");
	
	obj.Sum =  rs.value("SUM");
  
  end;
    
  return obj;
  
end;

macro WebCore_GetAccSubDCComboBoxItemList(AccAnaliticsID)

  var result = TArray();
  
  var query = " SELECT ASUB.T_SUBACCOUNTID SUBACCOUNTID,          " 
			  " ASUB.T_SUBACCOUNTCODE  SUBACCOUNTCODE             "             
			  " FROM DACCSUB_DBT asub							  "
			  " WHERE ASUB.T_ACCANALITICSID = :AccAnaliticsID     ";
			  
  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AccAnaliticsID );
  
  var rs = RsdRecordset(cmd);
  
  while(rs.movenext)
  
    var obj = TWebAccSubDCComboBoxItem();
	
	obj.SubAccountId = rs.value("SUBACCOUNTID");
	
	obj.SubAccountCode = rs.value("SUBACCOUNTCODE");
	
	result[result.size]=obj;
  
  end;
  
  return result;
  
end;

macro WebCore_InsertUpdateAccSubDC(AccSubDCPanelObject, Input ):WebResponseBuilder

  responseBuilder =WebResponseBuilder();
  
  var res;
    
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  Record  accsubdc ("accsubdc.dbt");
    
  accsubdc.SubCarryId = AccSubDCPanelObject.SubCarryId;
	
  accsubdc.AccAnaliticsId = AccSubDCPanelObject.AccAnaliticsId;
	
  accsubdc.Status = AccSubDCPanelObject.Status;
	
  accsubdc.SUBACCOUNTPAYERID = AccSubDCPanelObject.SubAccoyntPayer.SubAccountId;
  
  accsubdc.SUBACCOUNTRECEIVERID = AccSubDCPanelObject.SubAccountReceiver.SubAccountId;
	
  accsubdc.Date_Carry = AccSubDCPanelObject.Date_Carry;
	
  accsubdc.Sum = AccSubDCPanelObject.Sum;
   	
  if(Input)
  
    res = CB_InsertAccSubDC(accsubdc);
     
    if(res != true)
   
      AddErrorMessage(@ErrorMessage);
  
    end;
  
  else
   
    res = CB_UpdateAccSubDC(accsubdc);
     
    if(res != true)
   
      AddErrorMessage(@ErrorMessage);
  
    end; 
    
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;

end;

macro WebCore_GetAccSubRDGridItemList( AccAnaliticsID, SubAccountID)

  var result = TArray();
   
  var query = " SELECT ACCSUBRD.T_DATE_CARRY DATE_CARRY, ACCSUBRD.T_REST REST, "
	          " ACCSUBRD.T_DEBET DEBET, ACCSUBRD.T_CREDIT CREDIT               "
              " FROM DACCSUBRD_DBT ACCSUBRD                                    "
              " WHERE     ACCSUBRD.T_ACCANALITICSID = :AccAnaliticsID          "
              " AND ACCSUBRD.T_SUBACCOUNTID = :SubAccountID                    "
			  " ORDER BY DATE_CARRY DESC                                       ";
    
  

  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AccAnaliticsID );
  
  cmd.addParam( "", RSDBP_IN, SubAccountID );
  
  var rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var obj =  TWebAccSubRDGridItem();
	
    obj.Date_Carry =  rs.value("DATE_CARRY");
  
    obj.Rest = rs.value("REST");
  
    obj.Debet = rs.value("DEBET");
  
    obj.Credit = rs.value("CREDIT");
  
    result[result.size]=obj;
  
  end;
  
  return result;

end;


macro WebCore_GetAccCurDate(Account ,Chapter, Code_Currency )

  var Department;
   
  var query = " SELECT ACCOUNT.T_DEPARTMENT DEPARTMENT 	     "
              " FROM DACCOUNT_DBT ACCOUNT                    "
              " WHERE  ACCOUNT.T_ACCOUNT = :Account   		 "
              " AND ACCOUNT.T_CHAPTER = :Chapter       		 "
			  " AND ACCOUNT.T_CODE_CURRENCY = :Code_Currency ";
  
  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Account );
  
  cmd.addParam( "", RSDBP_IN, Chapter );
  
  cmd.addParam( "", RSDBP_IN, Code_Currency );

  var rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    Department =  rs.value("DEPARTMENT");
	 
  end;
  
  return CB_GetCurDate(Department);

end;

macro WebCore_GetAccSubRPGridItemList(AccAnaliticsID, SubAccountID, PeriodType)
 
  var result = TArray();
   
  var query = " SELECT ACCSUBRP.T_PERIODNUM PERIODNUM, ACCSUBRP.T_REST REST, "
	          " ACCSUBRP.T_DEBET DEBET, ACCSUBRP.T_CREDIT CREDIT             "
              " FROM DACCSUBRP_DBT ACCSUBRP                                  "
              " WHERE     ACCSUBRP.T_ACCANALITICSID = :AccAnaliticsID        "
              " AND ACCSUBRP.T_SUBACCOUNTID = :SubAccountID                  "
			  " AND ACCSUBRP.T_PERIODTYPE = :PeriodType                      ";
    
  var  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, AccAnaliticsID );
  
  cmd.addParam( "", RSDBP_IN, SubAccountID );
  
  cmd.addParam( "", RSDBP_IN, PeriodType );
     
  var rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var obj =  TWebAccSubRPGridItem();
	
    obj.PeriodNum =  rs.value("PERIODNUM");
  
    obj.Rest = rs.value("REST");
  
    obj.Debet = rs.value("DEBET");
  
    obj.Credit = rs.value("CREDIT");
  
    result[result.size]=obj;
  
  end;
  
  return result;

end;
