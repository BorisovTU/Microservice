/*
$Name:        payments_common.mac
$Module:      Главная книга
$Description: сервисы получения списка статусов платежа для RsAutoCompleteBox и листалки
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";

class TWebPmPurpListerItem 
 
  var Purpose        : integer ; 
  
  var ShortName      : String ; 
    
end;

class TWebPmStatusListerItem 
 
  var Paymstatus     : integer ; 
  
  var ShortName      : String ; 
    
end;

class TWebPmPopKndListerItem 
 
  var PaymentKind : String ; 
  
  var Name        : String ; 
    
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro WebCore_GetPmPurpListerItem(Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DPMPURP_DBT PMPURP ";
	
  var query_cond =" WHERE 1 = 1 ";
   	  	  
  if(Str != null)
  
    query_cond = query_cond +" AND LOWER(PMPURP.T_PURPOSE) LIKE LOWER ('%' || ? || '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY PMPURP.T_PURPOSE ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebPmPurpListerItem;
	
	obj.Purpose = rs.value("T_PURPOSE");
	
    obj.ShortName = rs.value("T_SHORTNAME");
			
	result[result.size] = obj;

  end; 

  return result;
  
end;

macro WebCore_GetPmStatusListerItem (Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DPMSTATUS_DBT PMSTATUS ";
	
  var query_cond =" WHERE 1 = 1 ";
   	  	  
  if(Str != null)
  
    query_cond = query_cond +" AND LOWER(PMSTATUS.T_PAYMSTATUS) LIKE LOWER ('%' || ? || '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY PMSTATUS.T_PAYMSTATUS ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebPmStatusListerItem;
	
	obj.Paymstatus = rs.value("T_PAYMSTATUS");
	
    obj.ShortName = rs.value("T_SHORTNAME");
			
	result[result.size] = obj;

  end; 

  return result;
  
end;

macro WebCore_GetPmPopKndListerItem (Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DPMPOPKND_DBT PMPOPKND ";
	
  var query_cond =" WHERE 1 = 1 ";
   	  	  
  if(Str != null)
  
    query_cond = query_cond +" AND LOWER(PMPOPKND.T_PAYMENTKIND) LIKE LOWER ('%' || ? || '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY PMPOPKND.T_PAYMENTKIND ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebPmPopKndListerItem;
	
	obj.PaymentKind = rs.value("T_PAYMENTKIND");
	
    obj.Name = rs.value("T_NAME");
			
	result[result.size] = obj;

  end; 

  return result;
  
end;