/*
$Name:        usertype_scroll.mac
$Module:      Главная книга
$Description: Макрос скроллинга типов проводок
*/

IMPORT  BankInter;
import "ws_file.mac";
import "ws_validation.mac";

class TWebUserTypeGridItem

  var OldTypeSymbol  	: string ;
  
  var iNumType		    : integer ;
  
  var TypeSymbol		: string ;
  
  var TypeName			: string ;
  
  var Description		: string ;
  
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro CovertBool(CurValue :bool ) : string

  if(CurValue==true)
    
	return "X";
	
  else
  
    return "";
	
  end;
  
end;

private macro CovertCharToBool(CurValue : string ) : bool

  if(CurValue == "X")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_GetUserTypeGridItemList(iNumType, PageSize, PageNum) : TArray

  var result = TArray();
  
  var query, cmd, rs, odj;
  
  query = " SELECT *							"
          " FROM dtypeac_dbt typeac			"
          " WHERE typeac.T_INUMTYPE = :iNumType	"
		  " ORDER BY typeac.T_TYPE_ACCOUNT		";
		  
  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, iNumType );
  
  rs = RsdRecordset(cmd);
  
  while(rs.MoveNext())
    
	odj = TWebUserTypeGridItem();
		
	odj.iNumType = rs.value("T_INUMTYPE");
	
	odj.TypeSymbol = rs.value("T_TYPE_ACCOUNT");
	
	odj.TypeName = rs.value("T_NAME_TYPE");
	
	odj.OldTypeSymbol = odj.TypeSymbol;
	
	odj.Description = rs.value("T_CONTENS");
	   
    result[result.size] = odj;

  end;

  return result;

end;

macro WebCore_GetUserTypeGridItemCount(iNumType) : integer

  var count : integer = 0;

  var cmd, rs, query;

  query = " SELECT count(*)	c					"
          " FROM dtypeac_dbt typeac			    "
          " WHERE typeac.T_INUMTYPE = :iNumType	";

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, iNumType );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    count = rs.value("c");

  end;

  return count;

end;

macro WebCore_DeleteUserType(iNumType, OldTypeSymbol) : WebResponseBuilder

  responseBuilder =WebResponseBuilder();
     
  file typeacFile("typeac.dbt") key 0 write;;
  
  var stat : bool;

  typeacFile.Inumtype = iNumType;
  
  typeacFile.Type_account = OldTypeSymbol;

  stat = GetEQ( typeacFile );
  
  if( stat )
  
    stat = Delete( typeacFile);
	
  end;
  
  responseBuilder.SetUserObject(stat);
  
  return responseBuilder.Result;

end;

macro WebCore_InsertUpdateUserType(iNumType, UserType, IsNewRec)

  responseBuilder =WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  if((UserType.TypeSymbol == "") OR (UserType.TypeSymbol == null) )

    AddErrorMessageExt(@ErrorMessage,"Введите обозначение пользовательского типа");
  
  end;
  
  if((UserType.TypeName == "") OR (UserType.TypeName == null) )

    AddErrorMessageExt(@ErrorMessage,"Введите название пользовательского типа");
  
  end;
   
  file typeacFile("typeac.dbt") key 0 write;;
  
  var stat : bool;

  typeacFile.Inumtype = iNumType;
  
  if(IsNewRec)
  
    typeacFile.Type_account = UserType.TypeSymbol;
  
  else
  
    typeacFile.Type_account = UserType.OldTypeSymbol;
  
  end;
  
  stat = GetEQ( typeacFile );

  if((stat != true) AND (IsNewRec == true) )
  
	typeacFile.Name_type = UserType.TypeName;
	
	typeacFile.Contens = UserType.Description;

    stat = Insert( typeacFile);
	
  end;
  
  if( stat AND (IsNewRec !=true) )
  
  	typeacFile.Name_type = UserType.TypeName;
	
	typeacFile.Contens = UserType.Description;
  
    stat = Update( typeacFile);
	
  end;
  
  responseBuilder.SetUserObject(stat);
  
  return responseBuilder.Result;

end;





