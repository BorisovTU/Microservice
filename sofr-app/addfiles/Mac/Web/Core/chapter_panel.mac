/*
$Name:        chapter_panel.mac
$Module:      Главная книга
$Description: Макрос панели главы счетов
*/


import "ws_partycommon.mac";
import "balaccount_widget.mac";
import "mccateg_widget.mac";
import "ws_validation.mac";

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

class TWebChapterObject
  var Chapter : integer;
  var ChapterName : string;
  var ShortName : string;
  var Symbol : string;
  var Excluded : bool;
  var Closed : bool;
  var IgnorePhase : bool;
  var AccountKey : integer;
  var ContrBalA_Object;
  var ContrBalP_Object;
  var ContrBalNumPlan : integer;
  var SkipUpgrade : bool;
  var UnrealizedCatCodePlus_Object;
  var UnrealizedCatCodeMinus_Object;
  var PairSign : bool;
  var SeparateCateg : bool;
  var RealizedCatCodePlus_Object;
  var RealizedCatCodeMinus_Object;
  var NVPI_CatPlus_Object;
  var NVPI_CatMinus_Object;
  var Template : string;
  var AcntLen : integer;
  var StartPos : integer;
  var CheckFIID : bool;
  var CheckBalance : bool;
  var CheckBWPInclude : bool;
  var Version : integer;

  var ContrBalA : string;
  var ContrBalP : string;
  var UNrealizedCatNumPlus : integer;
  var UnrealizedCatNumMinus : integer;
  var PairCatID_Plus : integer;
  var PairCatID_Minus : integer;
  var RealizedCatNumPlus : integer;
  var RealizedCatNumMinus : integer;
  var NVPI_CatPlus : integer;
  var NVPI_CatMinus : integer;

end;

macro WebCore_GetChapterObject(Chapter)

  var cmd, rs;

  var obj = TWebChapterObject;

  obj.PairCatID_Plus  = 0;
  obj.PairCatID_Minus = 0;

  var query = " SELECT * FROM dobchaptr_dbt WHERE t_chapter = ? ";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, Chapter );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.Chapter               = SQL_ConvType(rs.value("T_CHAPTER"));
    obj.ChapterName           = SQL_ConvType(rs.value("T_NAME"));
    obj.ShortName             = SQL_ConvType(rs.value("T_SHORTNAME"));
    obj.Symbol                = SQL_ConvType(rs.value("T_SYMBOL"));
    obj.Excluded              = SQL_ConvTypeBool(rs.value("T_EXCLUDEFROMFORMALACNT"));
    obj.Closed                = SQL_ConvTypeBool(rs.value("T_LOCKED"));
    obj.IgnorePhase           = SQL_ConvTypeBool(rs.value("T_IGNOREPHASE"));
    obj.AccountKey            = SQL_ConvType(rs.value("T_ACCOUNTKEY"));
    obj.ContrBalNumPlan       = SQL_ConvType(rs.value("T_CONTRBALNUMPLAN"));
    obj.SkipUpgrade           = SQL_ConvTypeBool(rs.value("T_SKIPUPGRADE"));
    obj.SeparateCateg         = SQL_ConvTypeBool(rs.value("T_SEPARATECATEG"));
    obj.Template              = SQL_ConvType(rs.value("T_TEMPLATE"));
    obj.AcntLen               = SQL_ConvType(rs.value("T_ACNTLEN"));
    obj.StartPos              = SQL_ConvType(rs.value("T_STARTPOS"));
    obj.CheckFIID             = SQL_ConvTypeBool(rs.value("T_CHECKFIID"));
    obj.CheckBalance          = SQL_ConvTypeBool(rs.value("T_CHECKBALANCE"));
    obj.CheckBWPInclude       = SQL_ConvTypeBool(rs.value("T_CHECKBWPINCLUDE"));
    obj.Version               = SQL_ConvType(rs.value("T_VERSION"));

    obj.ContrBalA             = SQL_ConvType(rs.value("T_CONTRBALA"));
    obj.ContrBalP             = SQL_ConvType(rs.value("T_CONTRBALP"));
    obj.UNrealizedCatNumPlus  = SQL_ConvType(rs.value("T_UNREALIZEDCATNUMPLUS"));
    obj.UnrealizedCatNumMinus = SQL_ConvType(rs.value("T_UNREALIZEDCATNUMMINUS"));
    obj.RealizedCatNumPlus    = SQL_ConvType(rs.value("T_REALIZEDCATNUMPLUS"));
    obj.RealizedCatNumMinus   = SQL_ConvType(rs.value("T_REALIZEDCATNUMMINUS"));
    obj.NVPI_CatPlus          = SQL_ConvType(rs.value("T_NVPI_CATPLUS"));
    obj.NVPI_CatMinus         = SQL_ConvType(rs.value("T_NVPI_CATMINUS"));

  end;

  query = " SELECT t_chapter, t_inumplan, t_balance, t_id, t_name_part FROM dbalance_dbt "
          "          WHERE t_chapter = ? AND t_inumplan = ? AND t_balance = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.Chapter );
  cmd.addParam( "", RSDBP_IN, obj.ContrBalNumPlan );
  cmd.addParam( "", RSDBP_IN, obj.ContrBalA );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.ContrBalA_Object = TWebBalAccount;

    obj.ContrBalA_Object.ID       = SQL_ConvType(rs.value("T_ID"));
    obj.ContrBalA_Object.iNumPlan = SQL_ConvType(rs.value("T_INUMPLAN"));
    obj.ContrBalA_Object.Balance  = SQL_ConvType(rs.value("T_BALANCE"));
    obj.ContrBalA_Object.Chapter  = SQL_ConvType(rs.value("T_CHAPTER"));
    obj.ContrBalA_Object.Name_Part  = SQL_ConvType(rs.value("T_NAME_PART"));

  end;

  query = " SELECT t_chapter, t_inumplan, t_balance, t_id, t_name_part FROM dbalance_dbt "
          "          WHERE t_chapter = ? AND t_inumplan = ? AND t_balance = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.Chapter );
  cmd.addParam( "", RSDBP_IN, obj.ContrBalNumPlan );
  cmd.addParam( "", RSDBP_IN, obj.ContrBalP );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.ContrBalP_Object = TWebBalAccount;

    obj.ContrBalP_Object.ID       = SQL_ConvType(rs.value("T_ID"));
    obj.ContrBalP_Object.iNumPlan = SQL_ConvType(rs.value("T_INUMPLAN"));
    obj.ContrBalP_Object.Balance  = SQL_ConvType(rs.value("T_BALANCE"));
    obj.ContrBalP_Object.Chapter  = SQL_ConvType(rs.value("T_CHAPTER"));
    obj.ContrBalP_Object.Name_Part  = SQL_ConvType(rs.value("T_NAME_PART"));

  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code, t_paircatid FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.UNrealizedCatNumPlus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.UnrealizedCatCodePlus_Object = TWebMCCateg;

    obj.UnrealizedCatCodePlus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.UnrealizedCatCodePlus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.UnrealizedCatCodePlus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.UnrealizedCatCodePlus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));
    obj.PairCatID_Plus                          = SQL_ConvType(rs.value("T_PAIRCATID"));

  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code, t_paircatid FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.UnrealizedCatNumMinus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.UnrealizedCatCodeMinus_Object = TWebMCCateg;

    obj.UnrealizedCatCodeMinus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.UnrealizedCatCodeMinus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.UnrealizedCatCodeMinus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.UnrealizedCatCodeMinus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));
    obj.PairCatID_Minus                          = SQL_ConvType(rs.value("T_PAIRCATID"));

  end;

  obj.PairSign = false;

  if( obj.PairCatID_Plus != 0 )
    if( obj.PairCatID_Minus == obj.UnrealizedCatCodePlus_Object.ID )
      obj.PairSign = true;
    end;
  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.RealizedCatNumPlus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.RealizedCatCodePlus_Object = TWebMCCateg;

    obj.RealizedCatCodePlus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.RealizedCatCodePlus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.RealizedCatCodePlus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.RealizedCatCodePlus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));

  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.RealizedCatNumMinus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.RealizedCatCodeMinus_Object = TWebMCCateg;

    obj.RealizedCatCodeMinus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.RealizedCatCodeMinus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.RealizedCatCodeMinus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.RealizedCatCodeMinus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));

  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.NVPI_CatPlus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.NVPI_CatPlus_Object = TWebMCCateg;

    obj.NVPI_CatPlus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.NVPI_CatPlus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.NVPI_CatPlus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.NVPI_CatPlus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));

  end;

  query = " SELECT t_leveltype, t_number, t_id, t_code FROM dmccateg_dbt "
          "        WHERE t_leveltype = 1 AND t_number = ?";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, obj.NVPI_CatMinus );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.NVPI_CatMinus_Object = TWebMCCateg;

    obj.NVPI_CatMinus_Object.ID         = SQL_ConvType(rs.value("T_ID"));
    obj.NVPI_CatMinus_Object.Number     = SQL_ConvType(rs.value("T_NUMBER"));
    obj.NVPI_CatMinus_Object.Code       = SQL_ConvType(rs.value("T_CODE"));
    obj.NVPI_CatMinus_Object.LevelType  = SQL_ConvType(rs.value("T_LEVELTYPE"));

  end;

  return obj;

end;

private macro SetChapterObject(p, ChapterObject)

  p.chapter               = ChapterObject.Chapter;
  p.name                  = ChapterObject.ChapterName;
  p.shortname             = ChapterObject.ShortName;
  p.symbol                = ChapterObject.Symbol;

  if(ChapterObject.Excluded == true)
    p.excludefromformalacnt = "X";
  else
    p.excludefromformalacnt = "";
  end;

  if(ChapterObject.Closed == true)
    p.locked = "X";
  else
    p.locked = "";
  end;

  if(ChapterObject.IgnorePhase == true)
    p.ignorephase = "X";
  else
    p.ignorephase = "";
  end;

  p.accountkey            = ChapterObject.AccountKey;
  p.contrbalnumplan       = ChapterObject.ContrBalNumPlan;

  if(ChapterObject.SkipUpgrade == true)
    p.skipupgrade = "X";
  else
    p.skipupgrade = "";
  end;

  if(ChapterObject.SeparateCateg == true)
    p.separatecateg = "X";
  else
    p.separatecateg = "";
  end;

  p.template              = ChapterObject.Template;
  p.acntlen               = ChapterObject.AcntLen;
  p.startpos              = ChapterObject.StartPos;
  
  if(ChapterObject.CheckFIID == true)
    p.checkfiid = "X";
  else
    p.checkfiid = "";
  end;  
  
  if(ChapterObject.CheckBalance == true)
    p.checkbalance = "X";
  else
    p.checkbalance = "";
  end;  
  
  if(ChapterObject.CheckBWPInclude == true)
    p.checkbwpinclude = "X";
  else
    p.checkbwpinclude = "";
  end;
  
  p.version              = ChapterObject.Version;
  
  if(ChapterObject.ContrBalA_Object != null)
    p.contrbala = ChapterObject.ContrBalA_Object.Balance;
  else
    p.contrbala = "";
  end;
  if(ChapterObject.ContrBalP_Object != null)
    p.contrbalp = ChapterObject.ContrBalP_Object.Balance;
  else
    p.contrbalp = "";
  end;
  if(ChapterObject.UnrealizedCatCodePlus_Object != null)
    p.unrealizedcatnumplus = ChapterObject.UnrealizedCatCodePlus_Object.Number;
  end;
  if(ChapterObject.UnrealizedCatCodeMinus_Object != null)
    p.unrealizedcatnumminus = ChapterObject.UnrealizedCatCodeMinus_Object.Number;
  end;
  if(ChapterObject.RealizedCatCodePlus_Object != null)
    p.realizedcatnumplus = ChapterObject.RealizedCatCodePlus_Object.Number;
  end;
  if(ChapterObject.RealizedCatCodeMinus_Object != null)
    p.realizedcatnumminus = ChapterObject.RealizedCatCodeMinus_Object.Number;
  end;
  if(ChapterObject.NVPI_CatPlus_Object != null)
    p.nvpi_catplus = ChapterObject.NVPI_CatPlus_Object.Number;
  end;
  if(ChapterObject.NVPI_CatMinus_Object != null)
    p.nvpi_catminus = ChapterObject.NVPI_CatMinus_Object.Number;
  end;
  
end;

macro WebCore_InsertChapter(ChapterObject)

  file p("obchaptr.dbt");

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  SetChapterObject(p, ChapterObject);

  res = CB_InsertChapter(p);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WebCore_UpdateChapter(ChapterObject)

  file p("obchaptr.dbt");

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  SetChapterObject(p, ChapterObject);

  res = CB_UpdateChapter(p);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
  
end;

macro WebCore_IsPairExpAccounts(ChapterObject)

  file p("obchaptr.dbt");

  var IsPair = false;

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  SetChapterObject(p, ChapterObject);

  res = CB_IsPairExpAccounts(@IsPair, p);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(IsPair);

  return responseBuilder.Result;

end;