 /*
 $Name: acclaim_scroll.mac
 $Module: Главная книга
 $Description: Макрос Список претензий
 */

import RsbDataSet, globals, oralib, likepy;
import BankInter;
import "ws_partycommon.mac";
import "ws_validation.mac";
import "account_scroll.mac";
import "ws_person.mac";
import "ws_datafilter.mac";
import "ws_llvalues.mac";
import "ws_partyclasses.mac";
import "ws_file.mac";

class TWebAcClaimGridParam
  var Review;
  var Title;
  var IsAccountFieldVisible;
  var IsPaymentButtonEnabled;
end;

class TWebNameKind
  var ID;
  var Name;
end;

class TWebAcClaimGridItem
  var ClaimID;
  var Account;
  var Status;
  var SysDate;
  var DocDate;
  var DocNumber;
  var Initiator;
  var ClaimKind;
  var RestKind;
  var BeneficiaryName;
  var CurrentAmount;
  var CurrentPriority;
  var Comment;
  var IsAuto;
  var Oper;
  var StartDate;
  var FinishDate;
end;

class TWebAcClmSttGridItem
  var StateName;
  var StateDate;
  var CurrentAmount;
  var Priority;
end;

class TWebAcClaimInit
  var InitiatorID;
  var Group;
  var Name;
end;

class TWebAcClaimObject
  var EditingIsEnabled;
  var ClaimID;
  var FIID;
  var Chapter;
  var Account;
  var BeneficiaryName;
  var Status;
  var Oper;
  var HasChanges;
  var SysDate;
  var DocDate;
  var DocNumber;
  var ClaimKind;
  var RestKind;
  var IsIncremental;
  var Initiator;
  var FiscOrgParty;
  var FiscOrgCode;
  var FiscOrgName;
  var FiscOrgINN;
  var FiscOrderNum;
  var StartAmount;
  var Priority;
  var MaxPriority;
  var StartDate;
  var FinishDate;
  var Comment;
  var ClaimCancelObj;
  var Version;
end;

class TWebAcClaimObj
  var ClaimID;
  var DocNumber;
end;

private const FILTERITEM_CLAIMKIND   = 0;   // Вид
private const FILTERITEM_RESTKIND    = 1;   // Тип
private const FILTERITEM_STATE       = 2;   // Статус
private const FILTERITEM_SYSDATE     = 3;   // Дата регистрации
private const FILTERITEM_DOCDATE     = 4;   // Дата претензии
private const FILTERITEM_STARTDATE   = 5;   // Действует с
private const FILTERITEM_FINISHDATE  = 6;   // Действует по
private const FILTERITEM_DOCNUMBER   = 7;   // Номер
private const FILTERITEM_STARTAMOUNT = 8;   // Первоначальная сумма претензии
private const FILTERITEM_PRIORITY    = 9;   // Первоначальная очередность
private const FILTERITEM_AUTO        = 10;  // Происхождение претензии

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
  if( condition )
    return value_true;
  else
    return value_false;
  end;
end;

private macro acclaim_GetSortStr( OrderItems,            /* Параметры сортировки */
                                  Table:string           /* Название таблицы c . */
                                ):String

  var SortStr:string = "";

  SortStr = " " + Table + "t_" + OrderItems[0].Column + " " + PT_IIF(OrderItems[0].Direction == 0, "asc", "desc");
  var i:integer = 1;
  while( i < OrderItems.size() )
    SortStr = SortStr + ", " + Table + "t_" + OrderItems[i].Column + " " + PT_IIF(OrderItems[i].Direction == 0, "asc", "desc");
    i = i + 1;
  end;
  SortStr = SortStr + " ";

  return SortStr;

end;

private macro GetAddWhereCondition(
  FilterItems/*:TArray of FilterCondItem*/
):String

  var condition = "";
  var conditionNOT = "";

  var FilterItemsCount = 0;
  var ValueCount = 0;

  while( FilterItemsCount < FilterItems.Size )

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_CLAIMKIND ) // Вид

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;

      if(FilterItems[FilterItemsCount].Value.Size > 0)

        var ClaimKindStr = "";

        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

            ClaimKindStr = ClaimKindStr + "1,"; //Арест

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

            ClaimKindStr = ClaimKindStr + "2,"; //Целевое использование

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 3);

            ClaimKindStr = ClaimKindStr + "3,"; //Резервирование

          end;

          ValueCount = ValueCount + 1;

        end;

        ClaimKindStr = SubStr(ClaimKindStr, 1, StrLen(ClaimKindStr) - 1);

        if(ClaimKindStr != "")

          condition = condition + " AND t_ClaimKind " + conditionNOT + " IN ( " + string(ClaimKindStr) + " ) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_RESTKIND ) // Тип

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;

      if(FilterItems[FilterItemsCount].Value.Size > 0)

        var RestKindStr = "";

        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

            RestKindStr = RestKindStr + "1,"; //полный

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

            RestKindStr = RestKindStr + "2,"; //частичный

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 3);

            RestKindStr = RestKindStr + "3,"; //на сумму

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 4);

            RestKindStr = RestKindStr + "4,"; //обеспечительный

          end;

          ValueCount = ValueCount + 1;

        end;

        RestKindStr = SubStr(RestKindStr, 1, StrLen(RestKindStr) - 1);

        if(RestKindStr != "")

          condition = condition + " AND t_RestKind  " + conditionNOT + " IN ( " + string(RestKindStr) + " ) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_STATE ) // Статус

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;

      if(FilterItems[FilterItemsCount].Value.Size > 0)

        var StateStr = "";

        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

            StateStr = StateStr + "1,"; //Активна

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

            StateStr = StateStr + "2,"; //Изменена

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 3);

            StateStr = StateStr + "3,"; //Приостановлена

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 4);

            StateStr = StateStr + "4,"; //Отменена

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 5);

            StateStr = StateStr + "5,"; //Закрыта

          end;

          ValueCount = ValueCount + 1;

        end;

        StateStr = SubStr(StateStr, 1, StrLen(StateStr) - 1);

        if(StateStr != "")

          condition = condition + " AND t_ClaimID " + conditionNOT + " IN (SELECT acs1.t_ClaimID "
                                  "                FROM dacclaimstate_dbt acs1 "
                                  "               WHERE acs1.t_StateDate = "
                                  "                            (SELECT MAX (acs2.t_StateDate) "
                                  "                               FROM dacclaimstate_dbt acs2 "
                                  "                              WHERE     acs2.t_ClaimID = acc.t_ClaimID "
                                  "                                    AND acs2.t_StateDate <= " + To_SQLData({curdate}) + " ) "
                                  "                     AND acs1.t_State IN ( " + string(StateStr) + " )) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_SYSDATE ) // Дата регистрации

      condition = condition + " AND " + GetFilterDateSQLCondition( FilterItems[FilterItemsCount], "T_SYSDATE" );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_DOCDATE ) // Дата претензии

      condition = condition + " AND " + GetFilterDateSQLCondition( FilterItems[FilterItemsCount], "T_DOCDATE" );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_STARTDATE ) // Действует с

      condition = condition + " AND " + GetFilterDateSQLCondition( FilterItems[FilterItemsCount], "T_STARTDATE" );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_FINISHDATE ) // Действует по

      condition = condition + " AND " + GetFilterDateSQLCondition( FilterItems[FilterItemsCount], "T_FINISHDATE" );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_DOCNUMBER ) // Номер

      condition = condition + " AND " + GetFilterStringSQLCondition( FilterItems[FilterItemsCount], "T_DOCNUMBER", true, false );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_STARTAMOUNT ) // Первоначальная сумма претензии

      condition = condition + " AND " + GetFilterMoneySQLCondition( FilterItems[FilterItemsCount], "T_STARTAMOUNT" );

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_PRIORITY ) // Первоначальная очередность

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;

      if(FilterItems[FilterItemsCount].Value.Size > 0)

        var PriorityStr = "";

        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 0);

            PriorityStr = PriorityStr + "0,"; //0

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

            PriorityStr = PriorityStr + "1,"; //1

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

            PriorityStr = PriorityStr + "2,"; //2

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 3);

            PriorityStr = PriorityStr + "3,"; //3

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 4);

            PriorityStr = PriorityStr + "4,"; //4

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 5);

            PriorityStr = PriorityStr + "5,"; //5

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 6);

            PriorityStr = PriorityStr + "6,"; //6

          end;

          ValueCount = ValueCount + 1;

        end;

        PriorityStr = SubStr(PriorityStr, 1, StrLen(PriorityStr) - 1);

        if(PriorityStr != "")

          condition = condition + " AND t_Priority " + conditionNOT + " IN ( " + string(PriorityStr) + " ) ";

        end;

      end;

    end;

    if( FilterItems[FilterItemsCount].Id == FILTERITEM_AUTO ) // Происхождение претензии

      if( FilterItems[FilterItemsCount].IsNot )
        conditionNOT = " NOT ";
      else
        conditionNOT = " ";
      end;

      if(FilterItems[FilterItemsCount].Value.Size > 0)

        var AutoStr = "";

        ValueCount = 0;

        while( ValueCount < FilterItems[FilterItemsCount].Value.Size )

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 1);

            AutoStr = AutoStr + "CHR(0),"; // введена вручную

          end;

          if(FilterItems[FilterItemsCount].Value[ValueCount] == 2);

            AutoStr = AutoStr + "'X',"; // автоматически по сообщению

          end;

          ValueCount = ValueCount + 1;

        end;

        AutoStr = SubStr(AutoStr, 1, StrLen(AutoStr) - 1);

        if(AutoStr != "")

          condition = condition + " AND t_Auto " + conditionNOT + " IN ( " + string(AutoStr) + " ) ";

        end;

      end;

    end;

    FilterItemsCount = FilterItemsCount + 1;

  end;

  return condition;

end;

macro WebCore_BeforeShowAcClaimGrid(Review, AccountID)

  var res = false;

  var kind_account, type_account, account;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var query = "select * from daccount_dbt where t_accountid = " + string(AccountID);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    kind_account = ds.KIND_ACCOUNT;
    type_account = ds.TYPE_ACCOUNT;
    account      = ds.ACCOUNT;

  end;

  if(AccountID != 0)

    if(kind_account != "П")

      res = false;

      CreateErrMsg(21441);
      AddErrorMessage(@ErrorMessage);

    end;

    if(type_account == "Э")

      res = false;

      CreateErrMsg(21475);
      AddErrorMessage(@ErrorMessage);

    end;

  end;

  var result = TWebAcClaimGridParam();

  if({cTypePerson} == TP_BOSS)

    result.Review = true

  end;

  result.IsPaymentButtonEnabled = true;

  if(Review == true)

    result.Review = true;

  end;

  if(AccountID != 0)

    result.Title = "Лицевой счет " + string(account) + ". Претензии";
    result.IsAccountFieldVisible = false;

  end;

  responseBuilder.SetUserObject(result);

  return responseBuilder.Result;

end;

private macro GetStatusExt(claimid, startdate);

  var p;

  var query = " SELECT "
              "   acst.t_State AS t_ID, "
              "   llv.t_Name AS t_Name "
              " FROM dacclaimstate_dbt acst, "
              "       dllvalues_dbt llv "
              " WHERE llv.t_Element = acst.t_State "
              " AND llv.t_List = 2521 " /*OBJTYPE_ACCLAIM_STATE*/
              " AND acst.t_ClaimID = " + string(claimid) +
              " AND acst.t_StateDate <= " + To_SQLData(IIF(startdate > {curdate}, startdate, {curdate})) +
              " ORDER BY acst.t_StateDate DESC ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    p = TWebNameKind();

    p.ID   = ds.ID;
    p.NAME = ds.NAME;

  end;

  return p;

end;

private macro GetStatus(claimid, startdate);

  var p;

  if(startdate > {curdate})

    p = null;

  else

    p = GetStatusExt(claimid, startdate);

  end;

  return p;

end;

macro GetInitiator_TWebNameKind(InitiatorID)

    var query = " SELECT aci.t_InitiatorID AS t_ID, aci.t_Name AS t_Name "
                "   FROM dacclaiminit_dbt aci "
                " WHERE aci.t_InitiatorID = " + string(InitiatorID);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      var p = TWebNameKind();

      p.ID   = ds.ID;
      p.NAME = ds.NAME;

    end;

    return p;

end;

private macro GetInitiator_TWebAcClaimInit(InitiatorID)

  var query = " SELECT "
              "   aci.t_InitiatorID, "
              "   aci.t_Group, "
              "   aci.t_Name "
              " FROM dacclaiminit_dbt aci "
              " WHERE aci.t_InitiatorID = " + string(InitiatorID);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if(ds.MoveNext())

    var p = TWebAcClaimInit();
    
    p.InitiatorID = ds.InitiatorID;
    p.Group       = ds.Group;
    p.Name        = ds.Name;

  end;
  
  return p;

end;

private macro GetClaimKind_TWebNameKind(ClaimKindID)

  var query = " SELECT "
              "    llv.t_Element AS t_ID, "
              "    llv.t_Name AS t_Name "
              " FROM dllvalues_dbt llv "
              "  WHERE llv.t_Element = " + string(ClaimKindID) +
              "   AND llv.t_List = 2520 "; /*OBJTYPE_ACCLAIM_KIND*/

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    var p = TWebNameKind();

    p.ID   = ds.ID;
    p.NAME = ds.NAME;

  end;

  return p;

end;

private macro GetClaimKind_TWsLlvalues(ClaimKindID)

  var Arr = TArray;

  var query = " SELECT "
              "  llv.t_Code AS t_Code, "
              "  llv.t_Element AS t_Element, "
              "  llv.t_Name AS t_Name, "
              "  llv.t_List AS t_List "
              " FROM dllvalues_dbt llv "
              "  WHERE 1=1 ";

  if(ClaimKindID != null)
    
    query = query + " AND llv.t_Element = " + string(ClaimKindID);
    
  end;

  query = query + " AND llv.t_List = 2520 "; /*OBJTYPE_ACCLAIM_KIND*/

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  
  while(ds.MoveNext())

    var p = TWsLlvalues(ds.Element, ds.Code, ds.Name, ds.List);
    
    Arr[Arr.size] = p;

  end;

  return Arr;

end;

private macro GetRestKind_TWebNameKind(RestKindID)

  var query = " SELECT "
              "    llv.t_Element AS t_ID, "
              "    llv.t_Name AS t_Name "
              "    FROM dllvalues_dbt llv "
              "  WHERE llv.t_Element = " + string(RestKindID) +
              "  AND llv.t_List = 2522 "; /*OBJTYPE_ACCLAIM_TYPE*/

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    var p = TWebNameKind();

    p.ID   = ds.ID;
    p.NAME = ds.NAME;

  end;

  return p;

end;

private macro GetRestKind_TWsLlvalues(RestKindID)

  var Arr = TArray;

  var query = " SELECT "
              "  llv.t_Code AS t_Code, "
              "  llv.t_Element AS t_Element, "
              "  llv.t_Name AS t_Name, "
              "  llv.t_List AS t_List "
              "    FROM dllvalues_dbt llv "
              "  WHERE 1=1 ";
              
  if(RestKindID != null)
    
    query = query + " AND llv.t_Element = " + string(RestKindID);
    
  end;

  query = query + " AND llv.t_List = 2522 "; /*OBJTYPE_ACCLAIM_TYPE*/                

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while(ds.MoveNext())

    var p = TWsLlvalues(ds.Element, ds.Code, ds.Name, ds.List);
    
    Arr[Arr.size] = p;

  end;

  return Arr;

end;

private macro GetBeneficiaryName(chapter, fiid, account)

  var NAME = "";

  var query = " SELECT pt.t_Name "
              "   FROM dparty_dbt pt, daccount_dbt ac "
              "  WHERE ac.t_Code_Currency = " + string(fiid) +
              "    AND ac.t_Chapter = " + string(chapter) +
              "   AND ac.t_Account = '" + string(account) + "' " +
              "    AND pt.t_PartyID = ac.t_BeneficiaryID ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    NAME = ds.NAME;

  end;

  return NAME;

end;

private macro GetCurrentAmount(claimid, startdate, restkind);

  var p;

  if((restkind == 3 /*на сумму*/) OR (restkind == 4 /*обеспечительный*/))

    var query = " SELECT "
                "   acst.t_CurrentAmount AS t_CurrentAmount "
                " FROM dacclaimstate_dbt acst, "
                "       dllvalues_dbt llv "
                " WHERE llv.t_Element = acst.t_State "
                " AND llv.t_List = 2521 " /*OBJTYPE_ACCLAIM_STATE*/
                " AND acst.t_ClaimID = " + string(claimid) +
                " AND acst.t_StateDate <= " + To_SQLData(IIF(startdate > {curdate}, startdate, {curdate})) +
                " ORDER BY acst.t_StateDate DESC ";


    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if (ds.MoveNext())

      p = ds.CurrentAmount;

    end;

  else

    p = null;

  end;

  return p;

end;

private macro GetCurrentPriority(claimid, startdate);

  var p;

  var query = " SELECT "
              "   acst.t_Priority AS t_CurrentPriority "
              " FROM dacclaimstate_dbt acst, "
              "       dllvalues_dbt llv "
              " WHERE llv.t_Element = acst.t_State "
              " AND llv.t_List = 2521 " /*OBJTYPE_ACCLAIM_STATE*/
              " AND acst.t_ClaimID = " + string(claimid) +
              " AND acst.t_StateDate <= " + To_SQLData(IIF(startdate > {curdate}, startdate, {curdate})) +
              " ORDER BY acst.t_StateDate DESC ";


  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if (ds.MoveNext())

    p = ds.t_CurrentPriority;

  end;

  return p;

end;

macro WebCore_GetAcClaimGridItemList(
                                      PageSize,
                                      PageNum,
                                      Account,
                                      FilterItems,
                                      Orderitems)

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT t.* FROM ( SELECT rownum RN, tt.* FROM ( ";

  query = query + " SELECT T_CLAIMID, T_ACCOUNT, T_SYSDATE, T_DOCDATE, T_DOCNUMBER, T_INITIATOR, T_CLAIMKIND, T_RESTKIND, T_CHAPTER, T_FIID, T_COMMENT, T_AUTO, T_OPER, T_STARTDATE, T_FINISHDATE "
                  "   FROM DACCLAIM_DBT acc WHERE 1 = 1 ";

  if(Account != null)

    query = query + " AND T_CHAPTER = " + string(Account.Chapter);
    query = query + " AND T_FIID = " + string(Account.Currency.Fiid);
    query = query + " AND T_ACCOUNT = '" + string(Account.Account) + "' ";

  end;

  var strAddWhere = GetAddWhereCondition( FilterItems );

  if( strAddWhere != "" )

    query = query + strAddWhere;

  end;

  if( (Orderitems != null) AND (Orderitems.Size() > 0) )

    query = query + " ORDER BY " + acclaim_GetSortStr(Orderitems, "");

  else

    query = query + " ORDER BY T_SysDate asc ";

  end;

  if( PageSize > 0 )
    query = query + " ) tt WHERE ROWNUM <= " + string(PageSize*(PageNum + 1)) + " ) t WHERE t.RN >= " + string(PageSize*(PageNum) + 1) + " ";
  else
    query = query + " ) tt ) t ";
  end;

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebAcClaimGridItem;

    obj.ClaimID         = SQL_ConvType(rs.value("T_CLAIMID"));
    obj.Account         = SQL_ConvType(rs.value("T_ACCOUNT"));
    obj.Status          = GetStatus(SQL_ConvType(rs.value("T_CLAIMID")), SQL_ConvType(rs.value("T_STARTDATE")));
    obj.SysDate         = SQL_ConvType(rs.value("T_SYSDATE"));
    obj.DocDate         = SQL_ConvType(rs.value("T_DOCDATE"));
    obj.DocNumber       = SQL_ConvType(rs.value("T_DOCNUMBER"));
    obj.Initiator       = GetInitiator_TWebNameKind(SQL_ConvType(rs.value("T_INITIATOR")));
    obj.ClaimKind       = GetClaimKind_TWebNameKind(SQL_ConvType(rs.value("T_CLAIMKIND")));
    obj.RestKind        = GetRestKind_TWebNameKind(SQL_ConvType(rs.value("T_RESTKIND")));
    obj.BeneficiaryName = GetBeneficiaryName(SQL_ConvType(rs.value("T_CHAPTER")), SQL_ConvType(rs.value("T_FIID")), SQL_ConvType(rs.value("T_ACCOUNT")));
    obj.CurrentAmount   = GetCurrentAmount(SQL_ConvType(rs.value("T_CLAIMID")), SQL_ConvType(rs.value("T_STARTDATE")), SQL_ConvType(rs.value("T_RESTKIND")));
    obj.CurrentPriority = GetCurrentPriority(SQL_ConvType(rs.value("T_CLAIMID")), SQL_ConvType(rs.value("T_STARTDATE")));
    obj.Comment         = SQL_ConvType(rs.value("T_COMMENT"));
    obj.IsAuto          = SQL_ConvTypeBool(rs.value("T_AUTO"));

    var OperNum     = SQL_ConvType(rs.value("T_OPER"));

    if(OperNum != 0)
      obj.Oper      = FindPersonByNumber(OperNum);
    else
      obj.Oper = TWsPerson();
      obj.Oper.Number = 0;
    end;

    obj.StartDate = SQL_ConvType(rs.value("T_STARTDATE"));
    obj.FinishDate = SQL_ConvType(rs.value("T_FINISHDATE"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;

macro WebCore_GetAcClaimGridItemCount(
                                      Account,
                                      FilterItems)

  var cmd, rs;

  var res : integer;
  res = 0;

  var query = " SELECT count(1) c "
              "   FROM DACCLAIM_DBT acc WHERE 1 = 1 ";

  if(Account != null)

    query = query + " AND T_CHAPTER = " + string(Account.Chapter);
    query = query + " AND T_FIID = " + string(Account.Currency.Fiid);
    query = query + " AND T_ACCOUNT = '" + string(Account.Account) + "' ";

  end;

  var strAddWhere = GetAddWhereCondition( FilterItems );

  if( strAddWhere != "" )

    query = query + strAddWhere;

  end;

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    res  = rs.value("c");

  end;

  return res;

end;

macro WebCore_DeleteAcClaim(ClaimID)

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_DeleteAcClaim(ClaimID);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

private macro GetHasChanges(ClaimID)

  var res = false;

  var cmd, rs;

  var query = " SELECT 1 FROM dacclmcng_dbt WHERE t_claimid = " + string(ClaimID);

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    res = true;

  end;

  return res;

end;

private macro GetFiscOrgParty(FiscOrgCode)

  var p;
  
  if((FiscOrgCode != null) AND (FiscOrgCode != ""))

    var query = " SELECT pt.t_PartyID As partyid, "
                "   pt.t_Name As partyname, "
                "   pcode.t_Code As code"
                "  FROM dparty_dbt pt, dpartcode_dbt pcode "
                "  WHERE pcode.t_Code = " + string(FiscOrgCode) + 
                "    AND pcode.t_CodeKind = 28 "
                "    AND pt.t_PartyID = pcode.t_PartyID ";

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      p = TWsPartyEx();

      p.partyid   = ds.partyid;
      p.partyname = ds.partyname;
      p.code      = ds.code;

    end;
  
  end;

  return p;

end;

private macro GetStateName(State)

  var Name = "";

  var query = " SELECT "
              "  llv.t_Name AS t_Name "
              " FROM dllvalues_dbt llv "
              "  WHERE llv.t_Element = " + string(State) +
              "   AND llv.t_List = 2521 ";/*OBJTYPE_ACCLAIM_STATE*/

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  
  if(ds.MoveNext())

    Name = ds.Name;

  end;

  return Name;

end;

macro GetMaxPriority()

  var result = 0;
  var error = 0;

  GetRegistryValue( "CB\\PAYMENTS\\MAXPRIORITY", V_INTEGER, result, error );

  if(error != 0)
    RunError("Ошибка при чтении настройки реестра!");
  end;

  return result;

end;

private macro GetClaimCancelObj(ClaimCancel)

    var query = " SELECT t_ClaimID, t_DocNumber "
                "   FROM dacclaim_dbt "
                " WHERE t_ClaimID = " + string(ClaimCancel);

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if(ds.MoveNext())

      var p = TWebAcClaimObj();

      p.ClaimID   = ds.ClaimID;
      p.DocNumber = ds.DocNumber;

    end;

    return p;

end;

macro WebCore_GetAcClmSttGridItemList(ClaimID)

  var Arr = TArray;

  var query = " SELECT "
              "  acst.t_State, "
              "  acst.t_StateDate, "
              "  acst.t_CurrentAmount, "
              "  acst.t_Priority "
              " FROM DACCLAIMSTATE_DBT acst "
              " WHERE acst.T_CLAIMID = " + string(ClaimID) +
              " ORDER BY acst.t_StateDate ";
              
  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while(ds.MoveNext())

    var p = TWebAcClmSttGridItem();
    
    p.StateName     = GetStateName(ds.State);
    p.StateDate     = ds.StateDate;
    p.CurrentAmount = ds.CurrentAmount;
    p.Priority      = ds.Priority;
    
    Arr[Arr.size] = p;

  end;
  
  return Arr;
  
end;

macro WebCore_GetAcClaimObject(ClaimID)

  var obj;

  var cmd, rs;

  var query = " SELECT T_STARTDATE, T_CLAIMID, T_FIID, T_CHAPTER, T_ACCOUNT, T_OPER, T_SYSDATE, T_DOCDATE, "
			  " T_DOCNUMBER, T_CLAIMKIND, T_RESTKIND, T_INCREMENTAL, T_INITIATOR, T_FISCORGCODE, "
			  "	T_STARTAMOUNT, T_PRIORITY, T_FINISHDATE, T_COMMENT, T_CLAIM_CANCEL, T_VERSION, 				"
			  "	T_FISCORGNAME, T_FISCORGINN, T_FISCORDERNUM"
              "   FROM DACCLAIM_DBT WHERE T_CLAIMID = " + string(ClaimID);

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebAcClaimObject();

    obj.EditingIsEnabled = IIF({BranchCurDate} < SQL_ConvType(rs.value("T_STARTDATE")), true, false);
    obj.ClaimID          = SQL_ConvType(rs.value("T_CLAIMID"));
    obj.FIID             = SQL_ConvType(rs.value("T_FIID"));
    obj.Chapter          = SQL_ConvType(rs.value("T_CHAPTER"));
    obj.Account          = SQL_ConvType(rs.value("T_ACCOUNT"));
    obj.BeneficiaryName  = GetBeneficiaryName(SQL_ConvType(rs.value("T_CHAPTER")), SQL_ConvType(rs.value("T_FIID")), SQL_ConvType(rs.value("T_ACCOUNT")));
    obj.Status           = GetStatusExt(SQL_ConvType(rs.value("T_CLAIMID")), SQL_ConvType(rs.value("T_STARTDATE")));

    var OperNum          = SQL_ConvType(rs.value("T_OPER"));

    if(OperNum != 0)
      obj.Oper           = FindPersonByNumber(OperNum);
    else
      obj.Oper = TWsPerson();
      obj.Oper.Number    = 0;
    end;

    obj.HasChanges       = GetHasChanges(ClaimID);
    obj.SysDate          = SQL_ConvType(rs.value("T_SYSDATE"));
    obj.DocDate          = SQL_ConvType(rs.value("T_DOCDATE"));
    obj.DocNumber        = SQL_ConvType(rs.value("T_DOCNUMBER"));
    obj.ClaimKind        = GetClaimKind_TWsLlvalues(SQL_ConvType(rs.value("T_CLAIMKIND")))[0];
    obj.RestKind         = GetRestKind_TWsLlvalues(SQL_ConvType(rs.value("T_RESTKIND")))[0];
    obj.IsIncremental    = SQL_ConvTypeBool(rs.value("T_INCREMENTAL"));
    obj.Initiator        = GetInitiator_TWebAcClaimInit(SQL_ConvType(rs.value("T_INITIATOR")));
    obj.FiscOrgParty     = GetFiscOrgParty(SQL_ConvType(rs.value("T_FISCORGCODE")));
	obj.FiscOrgCode = SQL_ConvType(rs.value("T_FISCORGCODE"));
	obj.FiscOrgName = SQL_ConvType(rs.value("T_FISCORGNAME"));
	obj.FiscOrgINN = SQL_ConvType(rs.value("T_FISCORGINN"));
	obj.FiscOrderNum = SQL_ConvType(rs.value("T_FISCORDERNUM"));	
    obj.StartAmount      = SQL_ConvType(rs.value("T_STARTAMOUNT"));
    obj.Priority         = SQL_ConvType(rs.value("T_PRIORITY"));
    obj.MaxPriority = GetMaxPriority();  
    obj.StartDate        = SQL_ConvType(rs.value("T_STARTDATE"));
    obj.FinishDate       = SQL_ConvType(rs.value("T_FINISHDATE"));
    obj.Comment          = SQL_ConvType(rs.value("T_COMMENT"));
    obj.ClaimCancelObj   = GetClaimCancelObj(SQL_ConvType(rs.value("T_CLAIM_CANCEL")));
    obj.Version          = SQL_ConvType(rs.value("T_VERSION"));

  end;

  return obj;

end;

macro WebCore_AcClaimObjReport(ClaimObj)

  var ToFileName = GetTxtFileName("AcClaim_" + ClaimObj.ClaimID);
  
  setoutput(ToFileName);
  
  //*********************//
  print("Отчет");
  //*********************//
  
  setoutput(null, true);

  var fc = null;
  
  if(ToFileName != "")

    fc = ConvertTxt2Html(ToFileName);
    
    fc = GetTextFile(fc);

  end;

  ResponseBuilder = WebResponseBuilder();

  ResponseBuilder.SetUserObject(fc);
  
  return ResponseBuilder.Result;
  
end;

macro WebCore_AcClaimReport(ClaimID)

  var ClaimObj = WebCore_GetAcClaimObject(ClaimID);
  
  return WebCore_AcClaimObjReport(ClaimObj);

end;

macro WebCore_PaymentFromClaim(ClaimID)

  var paymentid = 0;

  var cmd, rs;

  var query = 	" WITH acclmdoctb AS (						"+
				" SELECT acclmdoc.T_DOCUMENTID DOCUMENTID,	"+
				" acclmdoc.T_DOCKIND DOCKIND				"+
				" FROM dacclmdoc_dbt  acclmdoc				"+
				" WHERE acclmdoc.T_CLAIMID = ?)				"+
				" SELECT pmpaym.T_PAYMENTID  				"+
				" FROM dpmpaym_dbt pmpaym, acclmdoctb 		"+
				" WHERE pmpaym.T_DOCUMENTID = 				"+			  
				" DOCUMENTID  AND	 						"+
				" pmpaym.T_DOCKIND =  DOCKIND   			";

  cmd = RsdCommand(query);
 
  cmd.addParam( "", RSDBP_IN, ClaimID);
  
  rs = RsdRecordset(cmd);

  if (rs.movenext)
  
    paymentid = rs.value("T_PAYMENTID"); 
  
  end;

  return paymentid;

end;