/*
$Name:        bt_tx_widget.mac
$Module:      Главная книга
$Description: сервисы для виджета кодов КБК.
*/

IMPORT BankInter;
IMPORT OprInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebBt_TxListerItem 
 
  var ID       		: integer ;
  
  var Taxonomy    	: integer ;
    
  var Code   		: String ;
     
  var Note   		: String ;
  
  var Superior    	: integer;
        
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if(CurValue == "CHR (88)")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro WebCore_GetBt_TxListerItem (Str, Taxonomy, ModeChildOnly, IncludeZeroRecord) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;
  
  var query ;
  
  if(IncludeZeroRecord == true)
  
  obj = TWebBt_TxListerItem;

  obj.ID        = 0;
  obj.Taxonomy  = 0;
  obj.Code      = "0";
  obj.Note      = "0";
  obj.Superior  = 0;
  
  result[result.size] = obj;
  
  end;
  
  if(ModeChildOnly == true)
  
    query =     "  SELECT BT_TX.T_ID ID, BT_TX.T_TAXONOMY TAXONOMY,	"+
				"  BT_TX.T_CODE CODE, BT_TX.T_NOTE NOTE,			"+
				"  BT_TX.T_SUPERIOR SUPERIOR 						"+
				"  FROM DBT_TX_DBT BT_TX	 						"+
				"  WHERE T_TAXONOMY = ?	AND CONNECT_BY_ISLEAF = 1	";
				
    if(Str != "")
  
      query = query + " AND LOWER(T_CODE) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
    end;
	
	query = query + " START WITH BT_TX.T_SUPERIOR = 0					"+
                    " CONNECT BY PRIOR BT_TX.T_ID = BT_TX.T_SUPERIOR	"+
					" ORDER BY BT_TX.T_CODE 							";
  
  else
  
    query =     "  SELECT BT_TX.T_ID ID, BT_TX.T_TAXONOMY TAXONOMY,	"+
				"  BT_TX.T_CODE CODE, BT_TX.T_NOTE NOTE,			"+
				"  BT_TX.T_SUPERIOR SUPERIOR 						"+
				"  FROM DBT_TX_DBT BT_TX	 						"+
				"  WHERE T_TAXONOMY = ?								";
				
    if(Str != "")
  
      query = query + " AND LOWER(T_CODE) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
    end;
	
	query = query + " ORDER BY BT_TX.T_CODE ";
  
  end;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Taxonomy);

  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebBt_TxListerItem;

	obj.ID  = SQL_ConvType(rs.value("ID"));
    obj.Taxonomy  = SQL_ConvType(rs.value("TAXONOMY"));
    obj.Code   = SQL_ConvType(rs.value("CODE"));
	obj.Note  = SQL_ConvType(rs.value("NOTE"));
    obj.Superior   = SQL_ConvType(rs.value("SUPERIOR"));
		
	result[result.size] = obj;

  end; 

  return result;
  
end;



