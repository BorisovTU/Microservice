/*
$Name:        accountplanbal_scroll.mac
$Module:      Главная книга
$Description: Макрос панели проводок
*/

IMPORT FIInter, CurrInter, BankInter, PTInter;
import "ws_partycommon.mac";
import "ws_fiunilist.mac";
import "ws_dprt.mac";
import "ws_partyclasses.mac";
import "ws_partylist.mac";
import "balaccount_widget.mac";
import "ws_validation.mac";
import "ws_datafilter.mac";
import "pr_party_lib.mac";
import "ws_file.mac";
import "account_widget.mac";
import "ws_partycommon.mac";
import "ws_ficlass.mac";
import "ws_dprt.mac";
import "ws_person.mac";
import "ws_partyclasses.mac";
import "ws_fiunilist.mac";
import "ws_validation.mac";
import "ws_datafilter.mac";
import "pr_party_lib.mac";
import "multymtd_widget.mac";
import "cipher_widget.mac";


class AccountProperty
  var Currency ;
  var Balance0;
end;


class TWebAccountPlanBalGridItem
  var Account ;
  var Currency ;
  var Chapter ;
  var Balance0;
  var BalanceN; 
end;

/*class accblncRec 
  var T_ACCOUNTID ;
  var T_ACCOUNT ;
  var T_CODE_CURRENCY ;
  var T_CHAPTER;
  var T_BALANCE0;
  var T_BALANCE1;
  var T_BALANCE2;
  var T_BALANCE3;
  var T_BALANCE4;
  var T_BALANCE5;
  var T_BALANCE6;
  var T_BALANCE7;
  var T_BALANCE8;
  var T_BALANCE9;
  var T_BALANCE10;
  var T_BALANCE11;  
end;*/



PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_GetAccountPlanBalGridItemList(PageSize, PageNum, iNumPlan, Chapter, Balance):TArray

  var result = TArray();
  
  var query = " SELECT * "+" FROM daccblnc_dbt accblnc"+" WHERE accblnc.T_CHAPTER = "+ Chapter;
  
  if(Balance!=null)
  
    query=query+" AND accblnc.T_BALANCE"+ iNumPlan +" LIKE '" +Balance + "%' ";
    
  end;
  
  query = query + " ORDER BY T_ACCOUNT,T_CODE_CURRENCY";
  
  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;
  
  query = query + ";";
  
  var  cmd = RsdCommand(query);
  
  var rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var BalGridItem = TWebAccountPlanBalGridItem();
    
    var Account = TWebAccount();

    Account.AccountID    = SQL_ConvType(rs.value("T_ACCOUNTID"    ));
    
    Account.Account      = SQL_ConvType(rs.value("T_ACCOUNT"      ));
    
    Account.Currency     = SQL_ConvType(rs.value("T_CODE_CURRENCY"));
    
    Account.Chapter      = SQL_ConvType(rs.value("T_CHAPTER"      ));
    
    BalGridItem.Account = Account;
      
    var query_TWsFinInstr =   " SELECT T_FIID As Fiid, "+
							  "        T_FI_CODE As CodeWidget,      "+
							  "        T_FI_CODE As CodeList,        "+
							  "        T_FI_KIND As Kind,            "+
							  "        T_NAME As Name                "+
							  "        FROM dfininstr_dbt            "+
							  "        WHERE T_FIID = "+ Account.Currency +";";
        
    var cmd_TWsFinInstr = RsdCommand(query_TWsFinInstr);
  
    
    var rs_TWsFinInstr = RsdRecordset(cmd_TWsFinInstr);
    
    if(rs_TWsFinInstr.movenext)
    
      var Currency = TWsFinInstr();
      
      Currency.Fiid          = SQL_ConvType(rs_TWsFinInstr.value("Fiid"));
      
      Currency.CodeWidget    = SQL_ConvType(rs_TWsFinInstr.value("CodeWidget"));
      
      Currency.CodeList      = SQL_ConvType(rs_TWsFinInstr.value("CodeList"));
      
      Currency.Kind          = SQL_ConvType(rs_TWsFinInstr.value("Kind"));
      
      Currency.Name          = SQL_ConvType(rs_TWsFinInstr.value("Name"));
      
      BalGridItem.Currency = Currency;
      
    end;

    BalGridItem.Chapter = SQL_ConvType(rs.value("T_CHAPTER" ));
    
    BalGridItem.Balance0 = SQL_ConvType(rs.value("T_BALANCE0"));
	
	var bufstring = "T_BALANCE"+iNumPlan;
	
	var buf = SQL_ConvType(rs.value(bufstring));
	
    var query_TWebBalAccount =  " SELECT T_ID As ID,         " +
								"  T_INUMPLAN As iNumPlan,   " +
								"  T_BALANCE As Balance,     " +
								"  T_CHAPTER As Chapter,     " +
								"  T_NAME_PART As Name_Part  " +
								"  FROM dbalance_dbt         " +
								"  WHERE T_CHAPTER = "+ Account.Chapter +
								"  AND T_INUMPLAN =  " + iNumPlan +
								"  AND T_BALANCE   LIKE '"+ BalGridItem.Balance0 +"' ;";

    var cmd_TWebBalAccount = RsdCommand(query_TWebBalAccount); 
    
    var  rs_TWebBalAccount = RsdRecordset(cmd_TWebBalAccount);

    if(rs_TWebBalAccount.movenext)
    
      var BalanceN = TWebBalAccount();
      
      BalanceN.ID          = SQL_ConvType(rs_TWebBalAccount.value("ID"));
      
      BalanceN.iNumPlan    = SQL_ConvType(rs_TWebBalAccount.value("iNumPlan"));
      
      BalanceN.Balance     = SQL_ConvType(rs_TWebBalAccount.value("Balance"));
      
      BalanceN.Chapter     = SQL_ConvType(rs_TWebBalAccount.value("Chapter"));
      
      BalanceN.Name_Part   = SQL_ConvType(rs_TWebBalAccount.value("Name_Part"));
      
      BalGridItem.BalanceN = BalanceN;
      
    end;
   
     result[result.size] = BalGridItem;
     
     BalGridItem = null;
     
  end;

  return result;
  
end;


macro WebCore_GetAccountProperty( CodeCurrency ): AccountProperty


  var BalGridItem = AccountProperty();
 
  var Currency =GetTWsFinInstrByID(CodeCurrency, FICK_USERCODE);
  
  BalGridItem.Currency = Currency;
  
  var query =   " SELECT * "+
				" FROM daccount_dbt "+
				" WHERE T_CODE_CURRENCY = "+ CodeCurrency +";";
        
  var cmd = RsdCommand(query);

  var rs = RsdRecordset(cmd);

  if(rs.movenext)

    var Balance  = SQL_ConvType(rs.value("T_BALANCE"));
	
    BalGridItem.Balance0 = Balance;
           
  end;
    
  return BalGridItem;
	   
end;


macro WebCore_GetAccountPlanBalGridItemCount(iNumPlan, Chapter, Balance):integer

  var  count = 0;
  
  var query = " SELECT * "+" FROM daccblnc_dbt accblnc"+" WHERE accblnc.T_CHAPTER = " + Chapter;
  
  if(Balance!=null)
  
    query=query+" AND accblnc.T_BALANCE"+ iNumPlan +" LIKE '"  +Balance+"%'";
    
  end;
  
  query = query + " ORDER BY T_ACCOUNT,T_CODE_CURRENCY ;";

  var cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Balance );
  
  var  rs = RsdRecordset(cmd);
  
  while(rs.movenext)
  
    count=count+1;
  
  end;

  return count;
end;
  
  
  
macro WebCore_InsUpdAccountPlanBal(AccountPlanBal, iNumPlan, IsInsert) : WebResponseBuilder

  var responseBuilder =WebResponseBuilder();
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage(); 
  
  RECORD accblncRec ("ACCBLNC"); 

  var res;
  
  if(IsInsert==true)
  
    accblncRec.ACCOUNTID = AccountPlanBal.Account.AccountID;
	
    accblncRec.ACCOUNT = AccountPlanBal.Account.Account;

    accblncRec.CODE_CURRENCY = AccountPlanBal.Currency.Fiid;
    
    accblncRec.CHAPTER = AccountPlanBal.Chapter;
    
    if ( iNumPlan==0 )
      accblncRec.BALANCE0=AccountPlanBal.BalanceN.Balance;

    elif ( iNumPlan==1 )
      accblncRec.BALANCE1=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==2 )
      accblncRec.BALANCE2=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==3 )
      accblncRec.BALANCE3=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==4 )
      accblncRec.BALANCE4=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==5 )
      accblncRec.BALANCE5=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==6 )
      accblncRec.BALANCE6=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==7 )
      accblncRec.BALANCE7=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==8 )
      accblncRec.BALANCE8=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==9 )
      accblncRec.BALANCE9=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==10 )
      accblncRec.BALANCE10=AccountPlanBal.BalanceN.Balance;
      
    elif ( iNumPlan==11 )
      accblncRec.BALANCE11=AccountPlanBal.BalanceN.Balance;
	       
    end;
	
	
	
    res = CB_InsUpdAccblnc(accblncRec, iNumPlan,IsInsert);
	
	if(res != true)
   
      AddErrorMessage(@ErrorMessage);	  
  
    end;
     
	responseBuilder.SetUserObject(res);
     
    
  else

      var query = " SELECT * "+" FROM daccblnc_dbt accblnc"+" WHERE accblnc.T_ACCOUNTID = "+ AccountPlanBal.Account.AccountID +";";
       
      var cmd = RsdCommand(query);
  
  
      var  rs = RsdRecordset(cmd);
  
      if(rs.movenext)
  
        accblncRec.ACCOUNTID = AccountPlanBal.Account.AccountID;
    
		accblncRec.ACCOUNT = AccountPlanBal.Account.Account;
    
		accblncRec.CODE_CURRENCY = AccountPlanBal.Currency.Fiid;
    
		accblncRec.CHAPTER = AccountPlanBal.Chapter;

		if ( iNumPlan==0 )
          accblncRec.BALANCE0=AccountPlanBal.BalanceN.Balance;

        elif ( iNumPlan==1 )
          accblncRec.BALANCE1=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==2 )
          accblncRec.BALANCE2=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==3 )
          accblncRec.BALANCE3=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==4 )
          accblncRec.BALANCE4=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==5 )
          accblncRec.BALANCE5=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==6 )
          accblncRec.BALANCE6=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==7 )
          accblncRec.BALANCE7=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==8 )
          accblncRec.BALANCE8=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==9 )
          accblncRec.BALANCE9=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==10 )
          accblncRec.BALANCE10=AccountPlanBal.BalanceN.Balance;
          
        elif ( iNumPlan==11 )
          accblncRec.BALANCE11=AccountPlanBal.BalanceN.Balance;        
                 
      end;
      
      else
      
		 
         ErrorMessage.Code     = 5101;
  
         ErrorMessage.Message  = "Не найдена запись";
         
         ErrorMessage.Severity = MessageSeverity.RuntimeError;
         
         responseBuilder.AddMessage( ErrorMessage );
		 
	     return responseBuilder.Result;
		        
      end;
	  
	
    res = CB_InsUpdAccblnc(accblncRec, iNumPlan,IsInsert);
	
    if(res != true)
   
      AddErrorMessage(@ErrorMessage);
	  
  
    end;
     
    responseBuilder.SetUserObject(res);
     
    return responseBuilder.Result;
       
  end;
  
end;


macro WebCore_DelAccountPlanBal(AccountPlanBal) : WebResponseBuilder

  RECORD accblncRec ("ACCBLNC"); 

  responseBuilder =WebResponseBuilder();
    
  accblncRec.ACCOUNTID = AccountPlanBal.Account.AccountID;

  accblncRec.ACCOUNT = AccountPlanBal.Account.Account;

  accblncRec.CODE_CURRENCY = AccountPlanBal.Account.Currency;

  accblncRec.CHAPTER = AccountPlanBal.Chapter;

  accblncRec.BALANCE0 = AccountPlanBal.Balance0;
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var res = CB_DeleteAccblnc(accblncRec);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;

end;





















