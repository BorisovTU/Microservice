 /*
 $Name: ws_corrturn.mac
 $Module: Главная книга
 $Description: Макрос исправительного документа
 */

import globals;
IMPORT  BankInter;
IMPORT OprInter;
import "ws_validation.mac";
import "ws_file.mac";
import "ws_datafilter.mac";
import "acctrn_panel.mac";
import "ws_category.mac";


class TWebCorrDocObjPanel

  var CorrDocType				; //TWebNameKind
  
  var CorrDocTypeList			; //List<TWebNameKind>
  
  var AccTrnID					: integer ;
  
  var DateRate					: Date;
  
  var InitDateRateCorrDoc		: Date;
  
  var InitDateRateNewCorrDoc	: Date;
  
  var CorrDocNumber				; //TWebNameKind 
  
  var CorrDocNumberList			; //List<TWebNameKind>
  
  var ShowAddInfo				: bool ;
  
  var AccTrnTab					; //TWebCorrDocAccTrnObjTab
  
  var AddInfoTab				; //TWebCorrDocAddInfoObjTab
  
  var DateRateVisible			: bool ;

end;

class TWebCorrDocAccTrnObjTab

  var AccTrnObj		; //TWebAccTrnObject
  
  var CorrDocID		: integer ;
  
  var OrderNo		: integer ;	

end;

class TWebCorrDocAddInfoObjTab

  var AddCatogory			; //TWsCategoryAttribute
  
  var AddCatogoryList		; //List<TWsCategoryAttribute>
  

end;

class TWebNameKind

  var ID;
  
  var Name;
  
end;


private macro SettingParm(): bool

  var err=0;
  
  var ProcValue;
  
  GetRegistryValue( "COMMON\\ИСПР_ОБОРОТ\\УСТАНОВКА_КОДА_ПРИЧИНЫ", V_BOOL, ProcValue, err);

  if(err == 0)
    
    return ProcValue;
	 
  else

    return false;
	
  end;
 
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;


private macro ConvertBool(CurValue :bool ) : string

  if(CurValue==true)
    
	return "X";
	
  else
  
    return "";
	
  end;
  
end;

private macro GetAcctrn(  AcctrnObject , accTrn)
 
  accTrn.Chapter             = AcctrnObject.Chapter.Chapter;
  
  accTrn.Date_Carry          = AcctrnObject.Date_Carry;
  
  if(AcctrnObject.Debet.FI != null)
  
    accTrn.FIID_Payer           = AcctrnObject.Debet.FI.FIID;
	
  end;

  if(AcctrnObject.Debet.AccObj != null)
  
    accTrn.Account_Payer        = AcctrnObject.Debet.AccObj.Account;
	
  end;

  accTrn.Sum_Payer            = AcctrnObject.Debet.Sum;

  if(AcctrnObject.Credit.FI != null)
  
    accTrn.FIID_Receiver        = AcctrnObject.Credit.FI.FIID;
	
  end;

  if(AcctrnObject.Credit.AccObj != null)
  
    accTrn.Account_Receiver     = AcctrnObject.Credit.AccObj.Account;
	
  end;

  accTrn.Sum_Receiver         = AcctrnObject.Credit.Sum;

  if( (AcctrnObject.Sum_NatCur != null) and (AcctrnObject.Sum_NatCur != 0) )
  
    accTrn.Sum_NatCur  = AcctrnObject.Sum_NatCur;
	
  end;

  if(AcctrnObject.Ground != null)
  
    accTrn.Ground              = AcctrnObject.Ground;
	
  end;

  accTrn.Numb_Document       = AcctrnObject.Numb_Document;
  
  accTrn.Number_Pack         = AcctrnObject.Number_Pack;

  if(AcctrnObject.Cipher != null)
  
    accTrn.Shifr_Oper          = AcctrnObject.Cipher.Shifr_Oper;
	
  end;

  if(AcctrnObject.Kind_Oper != null)
  
    accTrn.Kind_Oper           = AcctrnObject.Kind_Oper;
	
  end;

  if(AcctrnObject.Department != null)
  
    accTrn.Department          = AcctrnObject.Department.Code;
	
  end;

  if(AcctrnObject.Branch != null)
  
    accTrn.Branch              = AcctrnObject.Branch.Code;
	
  end;

  if(AcctrnObject.TypeAc != null)
  
    accTrn.TypeDocument        = AcctrnObject.TypeAc;
	
  end;

  if(AcctrnObject.UserTypeAc != null)
  
    accTrn.UserTypeDocument    = AcctrnObject.UserTypeAc;
	
  end;

  accTrn.SkipRestEqChange    = ConvertBool(AcctrnObject.SkipRestEqChange);
  
  accTrn.SumEq_Payer          = AcctrnObject.Debet.SumEq;
  
  accTrn.SumEq_Receiver       = AcctrnObject.Credit.SumEq;

  if(AcctrnObject.MultyMtd != null)
  
    accTrn.MethodID            = AcctrnObject.MultyMtd.MethodID;
	
  end;

  accTrn.Rate                = AcctrnObject.RateObj.Rate;
  
  accTrn.Scale               = AcctrnObject.RateObj.Scale;
  
  accTrn.Point               = AcctrnObject.RateObj.Point;

  if(AcctrnObject.RateObj.Rate_IsKtDt == true)
  
    accTrn.IsInverse = "";
	
  else
  
    accTrn.IsInverse = "X";
	
  end;

  accTrn.UserField1          = AcctrnObject.UserField1;
  
  accTrn.UserField2          = AcctrnObject.UserField2;
  
  accTrn.UserField3          = AcctrnObject.UserField3;
  
  accTrn.UserField4          = AcctrnObject.UserField4;
  
  accTrn.SideTransaction     = AcctrnObject.SideTransaction;
  
  accTrn.ExRateExtra         = AcctrnObject.ExRateExtra;
  
  return accTrn;

end;





macro WebCore_InitCorrDocObjPanel( AccTrnID )

  var result  = TWebCorrDocObjPanel();
  
  responseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();  
     
  file acctrnFile("acctrn.dbt") key 0 write;
  
  var stat : bool;

  acctrnFile.AccTrnID = AccTrnID;

  stat = GetEQ( acctrnFile );

  if(stat != true )
 
    AddErrorMessageExt(@ErrorMessage,0,"Проводка не найдена");
	
  else
  
	result.AccTrnID = AccTrnID;
	
	result.InitDateRateCorrDoc = acctrnFile.Date_Carry;
		
	if(acctrnFile.Result_Carry == DELTARATE_MCD)
	
	  acctrnFile.ExRateAccTrnID  = AccTrnID;
	  
	  stat = GetEQ( acctrnFile );
	  
	  if(stat != true )
 
        AddErrorMessageExt(@ErrorMessage,0,"Проводка не найдена");
	
      else
	  
	    result.AccTrnID = acctrnFile.AccTrnID;

		result.InitDateRateCorrDoc = acctrnFile.Date_Carry;
	  
	  end;
	
	end;

	var strMsg;
    
	if(acctrnFile.State  != 1)
    
      CreateErrMsg (12004); 
      
      strMsg = GetErrMsg();
	
	  AddErrorMessageExt(@ErrorMessage,12004,strMsg);
	
	end;

	if(acctrnFile.Result_Carry == PAIRREGCARRY)
    
      CreateErrMsg (12006); 
      
      strMsg = GetErrMsg();
	
	  AddErrorMessageExt(@ErrorMessage,12006 , strMsg);
	
	end;
	
	result.InitDateRateNewCorrDoc ={curdate};
	
	result.CorrDocTypeList = TArray();
	
	var obj1 = TWebNameKind();
	
	obj1.ID = TURN_STORNO;
	
	obj1.Name =  "Сторнирующий";
	
	result.CorrDocTypeList[result.CorrDocTypeList.size] = obj1;
	
	var  obj2 = TWebNameKind();
	
	obj2.ID = TURN_ISPR;
	
	obj2.Name =  "Исправительный";
	
    result.CorrDocTypeList[result.CorrDocTypeList.size] = obj2;
	
	var  obj3 = TWebNameKind();
	
	obj3.ID = TURN_CORRECT;
	
	obj3.Name =  "Корректирующий";
	
    result.CorrDocTypeList[result.CorrDocTypeList.size] = obj3;
	
	var  obj4 = TWebNameKind();
	
	obj4.ID = TURN_NCORRECT;
	
	obj4.Name =  "Новый корректирующий";
	
    result.CorrDocTypeList[result.CorrDocTypeList.size] = obj4;
			
	result.CorrDocNumberList = TArray();
	
    var	CorrDocID = TArray();

    var	CorrDocNumber = TArray();
	
	var i = 0;

	var count = CB_GetCorrDocNumbers(@CorrDocID, @CorrDocNumber);

	while ( i < count )
	
        if(CorrDocNumber[i] != "")
	  var obj = TWebNameKind();
	  
	  obj.ID = CorrDocID[i];
	  
	  obj.Name  = CorrDocNumber[i];
	
	  result.CorrDocNumberList[result.CorrDocNumberList.size]=obj;
        end;
	  
	  i=i+1;
	
	end;
	
	if(SettingParm()==true)
	
	  result.ShowAddInfo = true;
	
	else
	
	  result.ShowAddInfo = false;
	
	end;
	
  end;
  
  responseBuilder.SetUserObject(result);

  return responseBuilder.Result;

end;

macro WebCore_InitCorrDocAccTrnObjTab(AccTrnID, CorrDocType, CorrDocID,CorrDocNumber, RateDate)

  Record  acctrnRec ("acctrn.dbt"); 
  
  Record  accisprRec ("accispr.dbt"); 
  
  var result  = TWebCorrDocAccTrnObjTab(); 

  responseBuilder = WebResponseBuilder();  

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var res = CB_InitCorrectDoc(CorrDocType , AccTrnID, CorrDocID, CorrDocNumber, RateDate, @acctrnRec, @accisprRec);

  if(res ==0)

    result.AccTrnObj = GetAccTrnObj(acctrnRec);
	
	result.CorrDocID = accisprRec.CorrDocID;
	
	result.OrderNo = accisprRec.OrderNo;
	
  else

    AddErrorMessage(@ErrorMessage);
  
  end;
 
  responseBuilder.SetUserObject(result);

  return responseBuilder.Result;
  
end;


macro WebCore_InitCorrDocAddInfoObjTab(CorrDocType, AccTrnObj)

  Record  accTrn ("acctrn.dbt"); 

  var result  = TWebCorrDocAddInfoObjTab(); 



  GetAcctrn(  AccTrnObj, @accTrn );
  
  var res = CB_GetDocKindCorrectDoc(CorrDocType, accTrn);
  
  var cmd, rs, query;
  
  result.AddCatogoryList = TArray();

  var obj;
   
  if(res == DLDOC_BANKORDER)

    query = " SELECT *  						"+
			" FROM dobjattr_dbt objattr			"+
			" WHERE objattr.T_OBJECTTYPE  = ?	"+
			" AND objattr.T_GROUPID  = ?	    "+
			" ORDER BY objattr.T_GROUPID		";

    cmd = RsdCommand(query);
 
    cmd.addParam( "", RSDBP_IN, OBJTYPE_BANKORDER);
	
	cmd.addParam( "", RSDBP_IN, CORRTURN_REASON_CODE_BANKORDER);
 
    rs = RsdRecordset(cmd);

	while(rs.movenext)
	
	  obj = TWsCategoryAttribute();
	  
	  obj.GroupID = rs.value("T_GROUPID"); 
	  
	  obj.AttrID = rs.value("T_ATTRID"); 
	  
	  obj.NumInList = rs.value("T_NUMINLIST"); 
	  
	  obj.CodeList = rs.value("T_CODELIST"); 
	  
	  obj.Name = rs.value("T_NAME"); 
	  
	  obj.FullName = rs.value("T_FULLNAME"); 
	  	  
	  result.AddCatogoryList[result.AddCatogoryList.size] = obj; 
	  
	end;
  
  end;
  
  if(res == DLDOC_MEMORIALORDER)
  
    query = " SELECT *  						"+
			" FROM dobjattr_dbt objattr			"+
			" WHERE objattr.T_OBJECTTYPE  = ?	"+
			" AND objattr.T_GROUPID  = ?	    "+
			" ORDER BY objattr.T_GROUPID		";

    cmd = RsdCommand(query);

    cmd.addParam( "", RSDBP_IN, OBJTYPE_MEMORIALORDER);
	
	cmd.addParam( "", RSDBP_IN, CORRTURN_REASON_CODE_MEMORIALORDER);
  
    rs = RsdRecordset(cmd);

	while(rs.movenext)
	  
	  obj = TWsCategoryAttribute();
	  
	  obj.GroupID = rs.value("T_GROUPID"); 
	  
	  obj.AttrID = rs.value("T_ATTRID"); 
	  
	  obj.NumInList = rs.value("T_NUMINLIST"); 
	  
	  obj.CodeList = rs.value("T_CODELIST"); 
	  
	  obj.Name = rs.value("T_NAME"); 
	  
	  obj.FullName = rs.value("T_FULLNAME"); 
	  	  
	  result.AddCatogoryList[result.AddCatogoryList.size] = obj; 
	  
	end;
  
  end;
  
  if(res == CB_MULTYDOC)
  
    query = " SELECT *  						"+
			" FROM dobjattr_dbt objattr			"+
			" WHERE objattr.T_OBJECTTYPE  = ?	"+
			" AND objattr.T_GROUPID  = ?	    "+
			" ORDER BY objattr.T_GROUPID		";

    cmd = RsdCommand(query);
 
    cmd.addParam( "", RSDBP_IN, OBJTYPE_MULTYDOC);
	
	cmd.addParam( "", RSDBP_IN, CORRTURN_REASON_CODE_MULTYDOC);
	
	cmd.NullConversion = true;
  
    rs = RsdRecordset(cmd);

	while(rs.movenext)
	  
	  obj = TWsCategoryAttribute();
	  
	  obj.GroupID = rs.value("T_GROUPID"); 
	  
	  obj.AttrID = rs.value("T_ATTRID"); 
	  
	  obj.NumInList = rs.value("T_NUMINLIST"); 
	  
	  obj.CodeList = rs.value("T_CODELIST"); 
	  
	  obj.Name = rs.value("T_NAME"); 
	  
	  obj.FullName = rs.value("T_FULLNAME"); 
	  	  
	  result.AddCatogoryList[result.AddCatogoryList.size] = obj; 
	  
	end;
  
  end;
  
  return result;
  
end;

macro WebCore_InsertCorrDoc(CorrDocType, AccTrnObj, CorrDocID, OrderNo, AddCategory)

  Record  acctrnVar  ("acctrn.dbt"); 
  
  Record  accisprVar ("accispr.dbt"); 
  
  Record  objattrVar ("objattr.dbt"); 
  
  ResponseBuilder = WebResponseBuilder();
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  GetAcctrn(  AccTrnObj, @acctrnVar );

  var cmd, rs;

  var query = 	" SELECT *					 	"+
				" FROM daccispr_dbt accispr		"+
				" WHERE accispr.T_CORRDOCID = ?	"+
				" AND accispr.T_ORDERNO  = ?	";

  cmd = RsdCommand(query);
 
  cmd.addParam( "", RSDBP_IN, CorrDocID);
  
  cmd.addParam( "", RSDBP_IN, OrderNo);
  
  rs = RsdRecordset(cmd);

  if (rs.movenext)
  
    accisprVar.DOCKIND = rs.value("T_DOCKIND"); 
	
	accisprVar.DOCUMENTID = rs.value("T_DOCUMENTID"); 
	
	accisprVar.SRCDOCKIND = rs.value("T_SRCDOCKIND"); 
	
	accisprVar.SRCDOCUMENTID = rs.value("T_SRCDOCUMENTID"); 
	
	accisprVar.CORRDOCNUMBER = rs.value("T_CORRDOCNUMBER"); 
	
	accisprVar.CORRDOCID = rs.value("T_CORRDOCID"); 
	
	accisprVar.ORDERNO = rs.value("T_ORDERNO"); 
	
	accisprVar.RATEDATE = rs.value("T_RATEDATE"); 
	
	accisprVar.ACCTRNID = rs.value("T_ACCTRNID"); 
  
  end;

  if((ValType(AddCategory) != 0) OR (AddCategory!= null) )
  
    objattrVar.GroupID = AddCategory.GroupID;
  
    objattrVar.AttrID = AddCategory.AttrID;
  
    objattrVar.NumInList = AddCategory.NumInList;
  
    objattrVar.CodeList = AddCategory.CodeList;
  
    objattrVar.Name = AddCategory.Name;
  
    objattrVar.FullName = AddCategory.FullName;
  
  end;
  
  var res = CB_CreateCorrectDoc(CorrDocType, acctrnVar, accisprVar, objattrVar);
  
  if(res != 0)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
  
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;
  
end;

macro WebCore_CancelCorrDoc( CorrDocType, CorrDocID, OrderNo )
 
  Record  accisprVar ("accispr.dbt"); 
  
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var cmd, rs;

  var query = 	" SELECT *					 	"+
				" FROM daccispr_dbt accispr		"+
				" WHERE accispr.T_CORRDOCID = ?	"+
				" AND accispr.T_ORDERNO  = ?	";

  cmd = RsdCommand(query);
 
  cmd.addParam( "", RSDBP_IN, CorrDocID);
  
  cmd.addParam( "", RSDBP_IN, OrderNo);
  
  rs = RsdRecordset(cmd);

  if (rs.movenext)
  
    accisprVar.DOCKIND = rs.value("T_DOCKIND"); 
	
	accisprVar.DOCUMENTID = rs.value("T_DOCUMENTID"); 
	
	accisprVar.SRCDOCKIND = rs.value("T_SRCDOCKIND"); 
	
	accisprVar.SRCDOCUMENTID = rs.value("T_SRCDOCUMENTID"); 
	
	accisprVar.CORRDOCNUMBER = rs.value("T_CORRDOCNUMBER"); 
	
	accisprVar.CORRDOCID = rs.value("T_CORRDOCID"); 
	
	accisprVar.ORDERNO = rs.value("T_ORDERNO"); 
	
	accisprVar.RATEDATE = rs.value("T_RATEDATE"); 
	
	accisprVar.ACCTRNID = rs.value("T_ACCTRNID"); 
  
  end;
  
  var res = CB_CancelCorrectDoc(CorrDocType, accisprVar);

  if(res != 0)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
  
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;

end;

