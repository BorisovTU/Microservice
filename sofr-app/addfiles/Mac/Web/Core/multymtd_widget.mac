/*
$Name:          multymtd_widget.mac
$Module:        WEB-Главная книга
$Description:   Макрос виджета выбора метода выполнения МВП
*/
Import RSD;
class TWebMultyMtd
  var MethodID;
  var ShortName;
  var Name;
end;

class TWebMultyMtdListerItem
  var MethodID;
  var ShortName;
  var Name;
end;

macro WebCore_GetMultyMtdListerItemList(UserMethod, sub, listLen)
  
  var cmd,rs;

  var Arr = TArray;

  var query = "SELECT m.* "
              "FROM DMULTYMTD_DBT m "
              "WHERE 1=1";        
 
  if (UserMethod!=null)

    var addthis = "";

    if (UserMethod == true) addthis = " AND m.t_methodid > 0 ";
        else addthis = " AND m.t_methodid < 0 ";
    end;

    if (addthis != "") 
        query = query + addthis;
    end;

  end;

  if ((sub != "") AND (sub != null))
    query = query + " AND LOWER(T_SHORT_NAME) LIKE LOWER ('%' || ? || '%') " ;
  end;

  if ((listLen != 0) AND (listLen != null))
    query = query + " AND ROWNUM < " + string(listLen);
  end;

  query = query + " ORDER BY T_SHORT_NAME";

  cmd = RsdCommand(query);

  if ((sub != "") AND (sub != null))
     cmd.addParam( "", RSDBP_IN, sub );
  end;

  rs = RsdRecordset(cmd);

  while (rs.movenext)
      
      var obj = TWebMultyMtdListerItem;
      
      obj.MethodID  = rs.value("t_methodid");
      obj.ShortName = rs.value("t_short_name");
      obj.Name      = rs.value("t_name");

      Arr[Arr.size] = obj;

  end;

  return Arr;

end;

macro WebCore_GetMultyMtdItemByID(MethodID)

  var obj;

  var cmd, rs;

  var query = " SELECT m.* FROM DMULTYMTD_DBT m WHERE m.t_methodid =  " + MethodID ;

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  if (rs.movenext)

     obj =  TWebMultyMtd;

     obj.MethodID  = rs.value("t_methodid");
     obj.ShortName = rs.value("t_short_name");
     obj.Name      = rs.value("t_name");

  end;

  return obj;

end;               

macro WebCore_CreateTWebMultyMtd(MethodID, ShortName, Name)

  var obj = TWebMultyMtd;

  obj.MethodID   = MethodID;
  obj.ShortName  = ShortName;
  obj.Name       = Name;
    
  return obj;

end;

var wtf = WebCore_GetMultyMtdListerItemList;
print(wtf.size);