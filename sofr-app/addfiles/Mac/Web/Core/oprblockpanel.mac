/*
$Name:        oprblockpanel.mac
$Module:      Главная книга
$Description: Cервисы  панели блока шагов
*/

IMPORT BankInter;
import CTInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";
import "oralib.mac";
import "dockind_widget.mac";
import "oprostep.mac";
import "oprblockwidget.mac";

class TWebOprBlockPanelCommon 
 
  var BlockID          	: integer ; 
  
  var Name     			: String ; 
  
  var DocKind         	; //TWebOprKDoc
  
  var FirstStep         ; //TWebOprOStep
  
  var IsSystem       	: bool ; 
  
  var UpdFromDst       	: bool ; 
   
  var Info       		: String ; 
  
  var VersionWeb        : integer ; 
 
  var Version          	: integer ; 
       
end;

class TWebOprSBlckGridItem 
 
  var BlockID          	: integer ; 
  
  var StatusKindID      : integer ; 
  
  var StatusKindCode    ; String ;
  
  var StatusKindName    ; String;
  
  var NumValue       	: integer ; 
  
  var NumValueName      : String ; 
   
  var Default       	: bool ; 
       
end;

class TWebOprSBlckPanel 
 
  var BlockID          	: integer ; 
  
  var BlockName      	: String ; 
  
  var OprStKnd         	; //TWebOprStKnd
  
  var OprStVal         	; //TWebOprStVal
   
  var Default       	: bool ; 
       
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;
const SYSTEMRECORDS = 1000000;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertBool(CurValue :bool ) : string

  if(CurValue==true)
    
	return "X";
	
  else
  
    return "";
	
  end;
  
end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if(CurValue == "X")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro GetNextBlockId()
  var id : integer = 0;
  var rs = ExecSQLSelect("select max(b.t_blockid) id from doprblock_dbt b");
  if(rs.MoveNext())
    id = SQL_ConvTypeInteger(rs.value("id"));
    if(id < SYSTEMRECORDS)
      id = SYSTEMRECORDS;
    else 
      id = id +1;
    end;
  end;
  
  return id;
end;

macro WebCore_GetOprBlockPanel(BlockID)

  var result = TArray();

  var cmd, rs;
	
  var OprBlockObject = TWebOprBlockPanelCommon();
	
  file oprblockRec ("oprblock.dbt") key 0 write;
  
  var stat : bool;

  oprblockRec.BlockID  = BlockID;

  stat = GetEQ( oprblockRec );

  if(stat != true )
 
    // OprBlockObject= null;
    // Создание нового блока
    OprBlockObject.BlockID = GetNextBlockId();
    OprBlockObject.DocKind = GetTWebOprKDocFromBD( 1 ); // обязательный атрибут
    OprBlockObject.FirstStep = GetFirstOprOStepFromBD(BlockID);
	
  else
	
	OprBlockObject = TWebOprBlockPanelCommon();
	
	OprBlockObject.BlockID = BlockID;
	
	OprBlockObject.Name = oprblockRec.Name;
	
	OprBlockObject.DocKind = GetTWebOprKDocFromBD( oprblockRec.DocKind );
	
	OprBlockObject.FirstStep = GetFirstOprOStepFromBD(BlockID);
	
	var query = "  SELECT INF.T_ISSYSTEM ISSYSTEM,						"
				"  INF.T_UPDFROMDST UPDFROMDST,							"
				"  RSB_STRUCT.GETSTRING (inf.T_FMTBLOBDATA_XXXX) INFO	"
				"  FROM DOPRINFO_DBT INF								"
				"  WHERE INF.T_OBJECTTYPE = " + String (BlockID:12:o) + " AND INF.T_OBJECTID = ?		";
 
  
    cmd = RsdCommand(query);
	
	cmd.addParam( "T_OBJECTID", RSDBP_IN, OBJTYPE_OPRBLOCK );
  
    rs = RsdRecordset(cmd);

    if(rs.movenext)
	
	  OprBlockObject.IsSystem = ConvertCharToBool(SQL_ConvType(rs.value("ISSYSTEM")));
	  
	  OprBlockObject.UpdFromDst = ConvertCharToBool(SQL_ConvType(rs.value("UPDFROMDST")));
	  
	  OprBlockObject.Info = SQL_ConvType(rs.value("INFO"));
	
	end;

	OprBlockObject.VersionWeb = oprblockRec.VersionWeb;
	
	OprBlockObject.Version = oprblockRec.Version;
	
  end;
  
  return OprBlockObject;
 
end;

macro GetOprFromOprBlockPanelCommon(oprblock, oprinfo, OprBlockPanel )

  oprblock.rec.BlockID = OprBlockPanel.BlockID;
  
  oprblock.rec.Name = OprBlockPanel.Name;
  
  oprblock.rec.DocKind = OprBlockPanel.DocKind.DocKind;
  
  oprblock.rec.VersionWeb = OprBlockPanel.VersionWeb;
  
  oprinfo.rec.IsSystem = ConvertBool(OprBlockPanel.IsSystem);
  
  oprinfo.rec.UpdFromDst = ConvertBool(OprBlockPanel.UpdFromDst);

  oprinfo.rec.OBJECTTYPE = OBJTYPE_OPRBLOCK;
  
  oprinfo.rec.OBJECTID = String (OprBlockPanel.BlockID:12:o);
  
  oprinfo.rec.VERSION = OprBlockPanel.Version;;

end;

macro WebCore_InsUpdOprBlockPanel(OprBlockPanelOld, OprBlockPanel): WebResponseBuilder

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var oprblockOld = TRecHandler("oprblock");
  var oprinfoOld  = TRecHandler("oprinfo");
  var oprblock    = TRecHandler("oprblock");
  var oprinfo     = TRecHandler("oprinfo");
  
  if(OprBlockPanelOld == null)
    oprblockOld = null;
    oprinfoOld  = null;
  else
    GetOprFromOprBlockPanelCommon(@oprblockOld, @oprinfoOld, OprBlockPanelOld);
  end;
  
  GetOprFromOprBlockPanelCommon(@oprblock, @oprinfo, OprBlockPanel);
  
  var res :bool= WEB_CB_InsertUpdateOprBlockPanel(oprblockOld, oprinfoOld, oprblock, oprinfo);
  
  if(res == false)

    AddErrorMessage(@ErrorMessage);

  end;
  
  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;   

macro WebCore_GetOprSBlckGridItem(BlockID): TArray

  var result  = TArray;
  
  var cmd, rs, obj;
  
  var query ;

  query =    "  SELECT  T.T_BLOCKID, T.T_STATUSKINDID,  		"+
			 "	(	SELECT OS.T_CODE  							"+
			 "		FROM DOPRSTKND_DBT OS 						"+
			 "		WHERE OS.T_STATUSKINDID = T.T_STATUSKINDID 	"+
			 "	) AS STATUSKINDCODE, 							"+
			 "	( 												"+
			 "		SELECT OS.T_NAME 							"+
			 "		FROM DOPRSTKND_DBT OS 						"+
			 "		WHERE OS.T_STATUSKINDID = T.T_STATUSKINDID 	"+
			 "	) AS STATUSKINDNAME, 							"+
			 "	T.T_NUMVALUE, 									"+
			 "	( 												"+
			 "		SELECT OSV.T_NAME 							"+
			 "		FROM DOPRSTVAL_DBT OSV 						"+
			 "		WHERE OSV.T_STATUSKINDID = T.T_STATUSKINDID "+
			 "		AND OSV.T_NUMVALUE = T.T_NUMVALUE 			"+
			 "	) AS NUMVALUENAME,  T.T_DEFAULT 				"+
			 "	FROM DOPRSBLCK_DBT T 							"+
			 "	WHERE T.T_BLOCKID = ?							"+
			 "	ORDER BY T.T_STATUSKINDID, T.T_NUMVALUE			";
				


  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, BlockID);

  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebOprSBlckGridItem();

	obj.BlockID  = SQL_ConvType(rs.value("T_BLOCKID"));
    obj.StatusKindID  = SQL_ConvType(rs.value("T_STATUSKINDID"));
    obj.StatusKindCode   = SQL_ConvType(rs.value("STATUSKINDCODE"));
	obj.StatusKindName  = SQL_ConvType(rs.value("STATUSKINDNAME"));
    obj.NumValue   = SQL_ConvType(rs.value("T_NUMVALUE"));
	obj.NumValueName  = SQL_ConvType(rs.value("NUMVALUENAME"));
    obj.Default  = SQL_ConvType(rs.value("T_DEFAULT"));		
	result[result.size] = obj;

  end; 

  return result;

end;

macro WebCore_Delete_OprSBlck(BlockID, StatusKindID, NumValue):WebResponseBuilder

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_DeleteOprSblck(BlockID, StatusKindID, NumValue);
  
  if(stat != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(stat == 0);

  return responseBuilder.Result;  

end;

macro WebCore_GetOprSBlckPanel(OprSBlckGridItem)
  
  var cmd, rs, obj;
  
  var query ;

  query =    "  SELECT  T.T_BLOCKID, T.T_STATUSKINDID,  		"+
			 "  (												"+
			 "  	SELECT OB.T_NAME  							"+
			 "  	FROM DOPRBLOCK_DBT OB						"+
			 "  	WHERE OB.T_BLOCKID=T.T_BLOCKID				"+
			 "  ) T_NAME , 										"+
			 "  T.T_NUMVALUE, T.T_DEFAULT						"+
			 "	FROM DOPRSBLCK_DBT T 							"+
			 "	WHERE T.T_BLOCKID = ? AND T.T_STATUSKINDID = ?	"+
			 "	AND T.T_NUMVALUE = ? 							";
				


  cmd = RsdCommand(query);
  
  cmd.addParam( "BlockID", RSDBP_IN, OprSBlckGridItem.BlockID);
  
  cmd.addParam( "StatusKindID ", RSDBP_IN, OprSBlckGridItem.StatusKindID);
  
  cmd.addParam( "NumValue ", RSDBP_IN, OprSBlckGridItem.NumValue);

  rs = RsdRecordset(cmd);

  if (rs.movenext)

    obj = TWebOprSBlckPanel();

	obj.BlockID  = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.BlockName  = SQL_ConvType(rs.value("T_NAME"));
	
    obj.OprStKnd   = GetOprStKndFromBD(SQL_ConvType(rs.value("T_STATUSKINDID")));
	
	obj.OprStVal  = GetOprStValFromBD(SQL_ConvType(rs.value("T_STATUSKINDID")), SQL_ConvType(rs.value("T_NUMVALUE")) );
	
    obj.Default  = SQL_ConvType(rs.value("T_DEFAULT"));		

  end; 

  return obj;

end;

macro GetOprsblckFromOprSBlckPanel(oprsblck,  OprSBlckPanel )

  oprsblck.rec.BLOCKID = OprSBlckPanel.BlockID;
  
  oprsblck.rec.STATUSKINDID = OprSBlckPanel.OprStKnd.StatusKindID;
  
  oprsblck.rec.NUMVALUE = OprSBlckPanel.OprStVal.NumValue;
  
  oprsblck.rec.DEFAULT = ConvertBool(OprSBlckPanel.Default);

end;


macro WebCore_InsUpdOprSBlckPanel(OprSBlckPanelOld, OprSBlckPanel): WebResponseBuilder


  var oprsblckOld = TRecHandler("oprsblck");
  
  var oprsblck  = TRecHandler("oprsblck");
  
  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  GetOprsblckFromOprSBlckPanel(oprsblckOld, OprSBlckPanelOld);
  
  GetOprsblckFromOprSBlckPanel(oprsblck, OprSBlckPanel);

  var stat = CB_InsUpdOprSblck(oprsblckOld, oprsblck);
  
  if(stat != true)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(stat);

  return responseBuilder.Result;


end;
