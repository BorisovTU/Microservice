 /*
 $Name: operday_open_backout.mac
 $Module: Главная книга
 $Description: Макрос Панель <Отмена открытия операционного дня>
 */

import globals;
import "ws_validation.mac";
import "ws_dprt.mac";
import "ws_file.mac";

class TWebOperdayOpenBackoutDateObject
  var LastCurDate;
  var DeleteCurDate;
  var Department;
  var OperCanExecServProcHead;
  var IsAllDprtSelected;
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_BeforeShowOperdayOpenDateBackoutPanel()

  var res = false;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  if(({cTypePerson} != TP_BOSS) AND (CheckActionRestriction(143) == true))

    res = true;

  end;

  if(res != true)

    CreateErrMsg(22166);
    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WebCore_InitOperdayOpenDateBackoutPanel()

  var res;

  var OperdayOpenBackoutDateObject = TWebOperdayOpenBackoutDateObject();

  OperdayOpenBackoutDateObject.Department = GetTWsDepartmentByCode({OperDprt});

  var err;

  GetRegistryValue( "COMMON\\СЕРВИСНЫЕ ПРОЦЕДУРЫ\\ЗАПУСК СЕРВИСНЫХ ПРОЦЕДУР", V_BOOL, res, err );

  if(err == 0)

    if((res == true) AND ({OperDprt} == {NumDprt}))
      OperdayOpenBackoutDateObject.OperCanExecServProcHead = true;
    else
      OperdayOpenBackoutDateObject.OperCanExecServProcHead = false;
    end;

  else
    RunError("Ошибка при чтении настройки реестра!");
  end;

  var LastCurDate = date(0,0,0);

  CB_GetLastOpenCurDateForDprt({OperDprt}, LastCurDate, null);

  if(LastCurDate == date(0,0,0))

    LastCurDate = null;

  end;

  OperdayOpenBackoutDateObject.LastCurDate = LastCurDate;

  return OperdayOpenBackoutDateObject;

end;

macro WebCore_GetOperdayOpenDatesBackoutPanel(Department, IsAllDprtSelected)

  var OperdayOpenBackoutDateObject = TWebOperdayOpenBackoutDateObject();

  if(IsAllDprtSelected == true)

    CB_GetLastOpenCurDateForDprt(0, OperdayOpenBackoutDateObject.LastCurDate, null);

  else

    if(Department != null)

      CB_GetLastOpenCurDateForDprt(Department.Code, OperdayOpenBackoutDateObject.LastCurDate, null);

    end;

  end;

  return OperdayOpenBackoutDateObject;

end;

macro WebCore_ExecOperdayOpenDateBackout(DprtID, DeleteDate)

  var fc = null;

  var res = false;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  if((DprtID !=0) AND (DprtID != {OperDprt}))

    var err;

    GetRegistryValue( "COMMON\\СЕРВИСНЫЕ ПРОЦЕДУРЫ\\ЗАПУСК СЕРВИСНЫХ ПРОЦЕДУР", V_BOOL, res, err );

    if(err == 0)

      if((res != true) OR ({OperDprt} != {NumDprt}))

        AddErrorMessageExt(@ErrorMessage, GetErrorMsg( 22166 ));

        res = false;

      end;

    else
      RunError("Ошибка при чтении настройки реестра!");
    end;

  end;

  var LogName : string = "";

  res = CB_BackoutOpenDay(DprtID, DeleteDate, @LogName);

  if(LogName != "")

    fc = GetTxtFileName(LogName);
    
    fc = ConvertTxt2Html(fc); 
    
    fc = GetTextFile(fc);

  end;

  if(res != true)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(fc);

  return responseBuilder.Result;

end;