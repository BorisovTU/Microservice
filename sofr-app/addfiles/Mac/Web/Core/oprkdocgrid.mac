/*
$Name:        oprkdocgrid.mac
$Module:      Главная книга
$Description: Cервисы  скролинга видов первичных документов
*/

IMPORT BankInter;
IMPORT OprInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebOprKDocGridItem 
 
  var DocKind          	: integer ; 
  
  var ParentDocKind     : integer ; 
  
  var Name         		: String ; 
  
  var Type       		: String ; 
  
  var Children  		; //List<TWebOprKDocGridItem>
       
end;




PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if((CurValue == "X") OR (CurValue == "I"))
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro WebCore_GetOprKDocGridItem()

  var innerquery  = "  SELECT LEVEL,												"+
					"	XMLELEMENT (OPRKDOC,										"+
					"				XMLELEMENT (DOCKIND, okd.T_DOCKIND),			"+
					"				XMLELEMENT (PARENTDOCKIND, okd.T_PARENTDOCKIND),"+
					"				XMLELEMENT (TYPE, 								"+
					"		  		CASE											"+
					"          		 WHEN okd.T_DOCKIND >= 5000 THEN	''П''		"+
					"          		 ELSE 	'' ''									"+
					"		  		END ),											"+
					"				XMLELEMENT (NAME, okd.T_NAME))					"+
					"	FROM DOPRKDOC_DBT okd										"+
					"	WHERE okd.t_primary = ''X''									"+
					"	START WITH okd.t_ParentDocKind = 0							"+
					"	CONNECT BY PRIOR okd.T_DOCKIND = okd.T_PARENTDOCKIND		"+
					"	ORDER SIBLINGS BY okd.t_dockind								";

  var outerquery=   " SELECT 1, 													"+
					" XMLELEMENT(oprkdoc_list, 										"+ 
					"(SELECT DBMS_XMLGEN.GETXMLTYPE 								"+
					"(DBMS_XMLGEN.NEWCONTEXTFROMHIERARCHY  ( '" + innerquery + "') )"+
					" FROM DUAL)).GETCLOBVAL() XMLDOC  FROM DUAL 					";
			
  var ds = TRsbDataSet(outerquery );

  var result;

  if( ds.MoveNext() )
  
    result = ds.XMLDOC;
	
  else
	
	result="";
	
  end;

  return result;

end; 

macro WebCore_DeleteOprKDoc (DocKindList):WebResponseBuilder

  var res, item ;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  for (item, DocKindList)
  
     var result = WEB_CB_DeleteOprKDoc(item);

    if(result != true)
	
	  res = result;

      AddErrorMessage(@ErrorMessage);

    end;
  
  end;
 
  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;


