/*
$Name:        opdphaseaccgroup_panel.mac
$Module:      Главная книга   
$Description: 
*/

IMPORT FIInter, CurrInter, BankInter, PTInter;
import RsbDataSet, globals, oralib, likepy;
import "cb_sql.mac", "web_scroll_lib.mac";
import "ws_dprt.mac";
import "ws_validation.mac";
import "ws_person.mac";
import "ws_llvalues.mac";
import "switch_phase.mac";
import "ws_fiunilist.mac";
import "ws_getparty.mac";
import "acctrn_panel.mac";
import "operdayphase_panel.mac";



class TWebOpdPhaseAccGroupPanelObject 

  var GroupID            : integer;   
  var GroupName          : string ;
  var Phase              ;//TWebPhase 
  var Department      	 ;//TWsDepartment 
  var SwitchBySheduler   : bool ;
  var SwitchTime         : time;   
  var ShedulerID         : integer ;
  var Branch             ;//TWsDepartment 
  var Oper               ;//TwsPerson
  var Currency           ;//TwsFinInst
  var AccountType        ;//TwsLlvalues
  var AccountTypeList    ;//List<TWsLlvalues>
  var ServiceKind        : integer ;
  var ServKindCollection ;//List<TWsServKind>
  var SysType            : string ;
  var Chapter            ;//TwebChapter 
  var Balance            : string ;
  var Account            : string;   
  var Version            : integer ;
  var GroupOwnerList     ;//List <TWebOpdPhaseAccGroupOwnerGridItem>
  var PhaseOwnerList     ;//List <TwebOpdPhaseOwnerGridItem> 
  var IsAllSelected      : bool ;
end;

class TWebOpdPhaseAccGroupOwnerGridItem

  var GroupID            : integer;  
  var Owner               ;//TwsPerson  

end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro ConvertBool(CurValue :bool ) : string

  if(CurValue==true)
    
	return "X";
	
  else
  
    return "";
	
  end;
  
end;

macro WebCore_GetOpdPhaseAccGroupPanelObject ( GroupID ) : TWebOpdPhaseAccGroupPanelObject

  var panelObj = TWebOpdPhaseAccGroupPanelObject();
  
  if(GroupID==0)
  
    panelObj.GroupID =0 ;  
	
    panelObj.GroupName = "";
	
	panelObj.Phase =  TWebPhase();
	
    var Department = TWsDepartment();
	
	panelObj.Department = GetTWsDepartmentByCode({OperDprt});
	
	panelObj.SwitchBySheduler = false ;
	
	panelObj.SwitchTime = Time("00:00:00");  
	
	panelObj.ShedulerID = 0;
	
	panelObj.Branch  = GetTWsDepartmentByCode({OperDprt});
	
	panelObj.Oper = FindPersonByNumber({oper});

	panelObj.Currency = TWsFinInstr ();
	
	panelObj.AccountTypeList = null ;
	
	panelObj.AccountType = TWsLlvalues();
	
	panelObj.ServiceKind = 0;
	
	panelObj.ServKindCollection = GetServKindList();
	
	panelObj.SysType = "";
	
	panelObj.Chapter = TWebChapter ();
	
	panelObj.Balance = "";
	
	panelObj.Account = "";
	
	panelObj.Version = 0;
	
    panelObj.IsAllSelected = true;
	
	panelObj.GroupOwnerList = null;
	
	panelObj.PhaseOwnerList = null;

  else

    var query = " SELECT opdgroup.*,TO_CHAR( T_SWITCHTIME,'HH24:MI:SS') as T_SWITCHTIME "
				
				" FROM DOPDGROUP_DBT opdgroup "  
				
				" WHERE T_GroupID  = "+ GroupID;
				
	var  cmd = RsdCommand(query);
  
    var rs = RsdRecordset(cmd);

    while(rs.movenext) 

      panelObj.GroupID  = SQL_ConvType(rs.value("T_GROUPID" ));
	
	  panelObj.GroupName  = SQL_ConvType(rs.value("T_NAME" ));
	  
	  panelObj.GroupID =GroupID ;  
	
      panelObj.GroupName = SQL_ConvType(rs.value("T_NAME" ));
	
	  panelObj.Phase =  TWebPhase();
	  
	  panelObj.Phase.Phase = SQL_ConvType(rs.value("T_PHASE" ));
	
	  panelObj.Department = GetTWsDepartmentByCode(SQL_ConvType(rs.value("T_DEPARTMENT" )));
	
	  panelObj.SwitchBySheduler = SQL_ConvType(rs.value("T_SWITCHBYSHEDULER" ));
	  
	  var  str = SQL_ConvType(rs.value("T_SWITCHTIME" ));
	
	  panelObj.SwitchTime  =Time ( SQL_ConvType(rs.value("T_SWITCHTIME" ))); 
	
	  panelObj.ShedulerID = SQL_ConvType(rs.value("T_SHEDULERID" ));
	
	  panelObj.Branch  = GetTWsDepartmentByCode(SQL_ConvType(rs.value("T_BRANCH" )));
	
	  panelObj.Oper = FindPersonByNumber(SQL_ConvType(rs.value("T_OPER" )));
	
	  panelObj.Currency = GetTWsFinInstrByID(SQL_ConvType(rs.value("T_CURRENCY" )));
	
	  panelObj.AccountTypeList = TArray();
	  
	  if(SQL_ConvType(rs.value("T_ACCOUNTTYPE" ))!=0)
	  
		  panelObj.AccountTypeList[panelObj.AccountTypeList.size]=CreateLLValueFromAppServ(2552, SQL_ConvType(rs.value("T_ACCOUNTTYPE" )));

		  var count=0;
		  
		  while( count<panelObj.AccountTypeList.size)
			  
			if( panelObj.AccountTypeList[count].Element==SQL_ConvType(rs.value("T_ACCOUNTTYPE" )))
			  
			  panelObj.AccountType=panelObj.AccountTypeList[count];
			  
			 end;
			 
			count=count+1;  
		  end;
		  
	  else
	    
		panelObj.AccountTypeList = null ;
	
	    panelObj.AccountType = TWsLlvalues();
	  
	  end;
	  
	  
	
	  panelObj.ServiceKind = SQL_ConvType(rs.value("T_SERVICEKIND" ));
	
	  panelObj.ServKindCollection = GetServKindList();
	
	  panelObj.SysType = "";
	  
	  var Chapter = TWebChapter();
	  
	  var query_inside1 = "SELECT * FROM DOBCHAPTR_DBT WHERE T_CHAPTER = " + SQL_ConvType(rs.value("T_CHAPTER" ));
	
	  var  cmd_inside1 = RsdCommand(query_inside1);
  
      var rs_inside1 = RsdRecordset(cmd_inside1);
	
	  if(rs_inside1.movenext)
	
	    Chapter.Chapter = SQL_ConvType(rs_inside1.value("T_CHAPTER" ));
		
		Chapter.Name = SQL_ConvType(rs_inside1.value("T_NAME" ));
		
		Chapter.ShortName = SQL_ConvType(rs_inside1.value("T_SHORTNAME" ));
		
		Chapter.Symbol = SQL_ConvType(rs_inside1.value("T_SYMBOL" ));
	
	  end;
	
	  panelObj.Chapter = Chapter;
	
	  panelObj.Balance = SQL_ConvType(rs.value("T_BALANCE" ));
	
	  panelObj.Account = SQL_ConvType(rs.value("T_ACCOUNT" ));
	
	  panelObj.Version = SQL_ConvType(rs.value("T_VERSION" ));
	  
	  panelObj.GroupOwnerList = TArray();
	  
	  var query_inside2 = " SELECT * FROM DOPDOWNER_DBT own  WHERE T_GROUPID = " + GroupID;
	
	  var  cmd_inside2 = RsdCommand(query_inside2);
  
      var rs_inside2 = RsdRecordset(cmd_inside2);
	
	  while(rs_inside2.movenext)

	    var GroupOwnerGrid = TwebOpdPhaseAccGroupOwnerGridItem();
		
		GroupOwnerGrid.GroupID = SQL_ConvType(rs_inside2.value("T_GROUPID" ));

		GroupOwnerGrid.Owner = FindPersonByNumber(SQL_ConvType(rs_inside2.value("T_OPER" )));
		
		panelObj.GroupOwnerList[panelObj.GroupOwnerList.size] = GroupOwnerGrid;
		
		GroupOwnerGrid = null;
			  
	  end;

	  panelObj.PhaseOwnerList = TArray();
	    
      var query_inside3 = " SELECT t.T_PHASE, t.T_OPER, pt.T_SHORTNAME, p.T_NAME personName, p.T_CODEDEPART, pt.T_NAME partyName"
						  " FROM DOPDPHASEOWNER_DBT t   "
						  " INNER JOIN DPERSON_DBT p ON p.T_OPER = t.T_OPER"
						  " INNER JOIN DDP_DEP_DBT d ON d.T_CODE = t.T_DEPARTMENT"
						  " INNER JOIN DPARTY_DBT pt ON pt.T_PARTYID = d.T_PARTYID"
						  " WHERE T_PHASE = " + SQL_ConvType(rs.value("T_PHASE" ));


      var  cmd_inside3 = RsdCommand(query_inside3);

      var rs_inside3 = RsdRecordset(cmd_inside3);

      while(rs_inside3.movenext)

        var phaseOwner  = TWebOpdPhaseOwnerGridItem ();

        phaseOwner.Phase = SQL_ConvType(rs_inside3.value("T_PHASE"));
	  
		phaseOwner.DprtShortName = SQL_ConvType(rs_inside3.value("T_SHORTNAME"));
	  
		phaseOwner.Owner =TWsPerson();
	  
		phaseOwner.Owner.Number=SQL_ConvType(rs_inside3.value("T_OPER"));
	  
		phaseOwner.Owner.Name_=SQL_ConvType(rs_inside3.value("personName"));
	  
		phaseOwner.Owner.DprtNode=SQL_ConvType(rs_inside3.value("T_CODEDEPART"));
	  
		phaseOwner.Owner.DprtName=SQL_ConvType(rs_inside3.value("partyName"));
		
		panelObj.PhaseOwnerList[panelObj.PhaseOwnerList.size]= phaseOwner;
		
		phaseOwner = null;
	  
      end;
  
    end;
	
  end;

  return panelObj;
  
end;

macro WebCore_InsertOpdPhaseAccGroup( GroupParam):WebResponseBuilder

  responseBuilder =WebResponseBuilder();

  Record  opdgroupRec ("opdgroup.dbt");
  
  Record  opdownerRec ("opdowner.dbt");

  opdgroupRec.GroupID = GroupParam.GroupID;
  
  opdgroupRec.NAME = GroupParam.GroupName;
  
  opdgroupRec.Phase = GroupParam.Phase.Phase;

  opdgroupRec.Department = GroupParam.Department.Code;
  
  opdgroupRec.SwitchBySheduler = ConvertBool(GroupParam.SwitchBySheduler);
  
  opdgroupRec.SwitchTime = GroupParam.SwitchTime;
  
  opdgroupRec.ShedulerID = GroupParam.ShedulerID;
  
  opdgroupRec.Branch = GroupParam.Branch.Code;

  opdgroupRec.Oper = GroupParam.Oper.Number;
  
  opdgroupRec.Currency = GroupParam.Currency.Fiid;
  if(GroupParam.IsAllSelected==true)
	  
    opdgroupRec.AccountType = 0;

  else

	opdgroupRec.AccountType =  GroupParam.AccountTypeList[0].Element;

  end;
  
  opdgroupRec.ServiceKind = GroupParam.ServiceKind;
  
  opdgroupRec.SysType = GroupParam.SysType;
  
  opdgroupRec.Chapter = GroupParam.Chapter.Chapter;
  
  opdgroupRec.Balance = GroupParam.Balance;
  
  opdgroupRec.Account = GroupParam.Account;
  
  var opdownerArray =  TArray();
  
  var j = 0;

  while (j <  GroupParam.GroupOwnerList.size())
	
	  opdownerRec.GroupID = GroupParam.GroupID;
	  
	  opdownerRec.Oper = GroupParam.GroupOwnerList[j].Owner.Number;
	  
	  opdownerArray[j] = opdownerRec;
	  
	  j=j+1;
	  
  end;
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var res = CB_InsertOpdPhaseAccGroup(opdgroupRec,opdownerArray);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;
  
end;


macro WebCore_UpdateOpdPhaseAccGroup(GroupParam, InitGroupOwnerList ):WebResponseBuilder

  responseBuilder =WebResponseBuilder();
  
  Record  opdgroupRec ("opdgroup.dbt");
  
  Record  opdownerRec ("opdowner.dbt");
  
  opdgroupRec.GroupID = GroupParam.GroupID;
  
 opdgroupRec.NAME = GroupParam.GroupName;
  
  opdgroupRec.Phase = GroupParam.Phase.Phase;

  opdgroupRec.Department = GroupParam.Department.Code;
  
  opdgroupRec.SwitchBySheduler = ConvertBool(GroupParam.SwitchBySheduler);
  
  opdgroupRec.SwitchTime = GroupParam.SwitchTime;
  
  opdgroupRec.ShedulerID = GroupParam.ShedulerID;

  opdgroupRec.Branch = GroupParam.Branch.Code;
  
  opdgroupRec.Oper = GroupParam.Oper.Number;
  
  opdgroupRec.Currency = GroupParam.Currency.Fiid;
  
  if(GroupParam.IsAllSelected==true)
	  
    opdgroupRec.AccountType = 0;

  else

	opdgroupRec.AccountType =  GroupParam.AccountTypeList[0].Element;

  end;
   
  opdgroupRec.ServiceKind = GroupParam.ServiceKind;
  
  opdgroupRec.SysType = GroupParam.SysType;
  
  opdgroupRec.Chapter = GroupParam.Chapter.Chapter;
  
  opdgroupRec.Balance = GroupParam.Balance;
  
  opdgroupRec.Account = GroupParam.Account;
  
  opdgroupRec.Version = GroupParam.Version;
  
  var todelgroupownerArray = TArray();
  
  var j = 0;
  
  var flag;

  while (j <  InitGroupOwnerList.size())
  
    var initrec = InitGroupOwnerList[j];
  
    flag = false;
	
	var i = 0;
	
	while (i <  GroupParam.GroupOwnerList.size())
	
	  if((GroupParam.GroupOwnerList[i].GroupID == initrec.GroupID) and (GroupParam.GroupOwnerList[i].Owner.Number == initrec.Owner.Number))
	  
	    flag=true;
		
	  end;
	  
	i=i+1;
	  
	end;
	
	if(flag==false)
	
	  opdownerRec.GroupID = initrec.GroupID;
	  
	  opdownerRec.Oper = initrec.Owner.Number;
	  
	  todelgroupownerArray[todelgroupownerArray.size]=opdownerRec;
	  
	end;
	
	j=j+1;
	
  end;

  var newgroupownerArray = TArray();
  
  j = 0;
  
  while (j <  GroupParam.GroupOwnerList.size())
  
    var newrec  = GroupParam.GroupOwnerList[j];
  
      flag = false;
	
	  i = 0;
	
	while (i <  InitGroupOwnerList .size())
	
	  if((InitGroupOwnerList[i].GroupID == newrec.GroupID) and (InitGroupOwnerList[i].Owner.Number == newrec.Owner.Number))
	  
	    flag=true;
				
	  end;
	  
	i=i+1;
	  
	end;
	
	if(flag==false)
	
	  opdownerRec.GroupID = newrec.GroupID;
	  
	  opdownerRec.Oper = newrec.Owner.Number;
	  
	  newgroupownerArray[newgroupownerArray.size]=opdownerRec;
	  
	end;
	
	j=j+1;
	
  end;
  
  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var res = CB_UpdateOpdPhaseAccGroup(opdgroupRec,todelgroupownerArray,newgroupownerArray);
     
  if(res != true)
   
     AddErrorMessage(@ErrorMessage);
  
  end;
    
  responseBuilder.SetUserObject(res);
  
  return responseBuilder.Result;

end
    






















