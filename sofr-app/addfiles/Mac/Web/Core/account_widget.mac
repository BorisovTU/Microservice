/*
$Name:        account_widget.mac
$Module:      É´†¢≠†Ô ™≠®£†
$Description: å†™‡Æ· ¢®§¶•‚† ¢Î°Æ‡† ´®Ê•¢Æ£Æ ·Á•‚†
*/

IMPORT FIInter, CurrInter;
import "ws_partycommon.mac";
import "account_scroll.mac";
import "ws_validation.mac";

class TWebAccountListerItem
  var AccountID;
  var Account;
  var AccountName;
  var Currency;
  var CurrencyCode;
  var Chapter;
  var Client;
  var ClientName;
  var Balance;
  var DepartmentName;
  var BranchName;
  var KindAccount;
  var RestNat;
  var RestCur;
  var Oper;
end;

class TWebAccount
  var AccountID;
  var Account;
  var AccountName;
  var Currency;
  var Chapter;
  var Client;
end;

class TWebAccountParam
  var Status;
  var Chapter;
  var Currency;
  var PrivID;
  var Client;
  var IsListInBranch;
  var DepartmentList;
  var ChapterList;
  var FIList;
  var Account;
  var AccountMask;
  var Balance;
  var SysTypes;
  var Oper;
  var DepoAcc;
  var IsWideView;
end;

class TWebAccAnl

  var AnaliticsID : integer;   
  var ShortName   : string ;
  
end;

class TWebAccAnlListerItem

  var AnaliticsID : integer; 
  var ShortName   : string ;
  var Name        : string ;
  
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetQuery(Param)

  var where_str : string, from_str : string;

  var ConvertMask : string;

  var query = " SELECT * "
              "  FROM DACCOUNT_DBT account";

  var query_where = " WHERE 1 = 1 ";

  if(Param.Status == 0)

    query_where = query_where + " AND account.T_OPEN_CLOSE      = CHR(0) ";

  else

    if(Param.Status == 1)

      query_where = query_where + " AND account.T_OPEN_CLOSE    = 'á' ";

    else

      query_where = query_where + " AND (account.T_OPEN_CLOSE   = CHR(0) OR account.T_OPEN_CLOSE        = 'á') ";

    end;

  end;

  if(Param.Chapter > 0)

    query_where = query_where + " AND account.T_CHAPTER = " + string(Param.Chapter);

  end;

  if(Param.Currency >= 0)

    query_where = query_where + " AND account.T_CODE_CURRENCY   = " + string(Param.Currency);

  else

    if(Param.Currency == -2)

      query_where = query_where + " AND account.T_CODE_CURRENCY <> " + string(NATCUR);

    end;

  end;

  if( GetObjectRestriction(where_str, Param.PrivID, NULL, "account", NULL, "account.dbt", @from_str, true) == true )

    if(from_str != "")
      query = query + ", " + from_str + " ";
    end;

    if(where_str != "")
      query_where = query_where + "AND " + where_str + " ";
    end;

  end;

  if(Param.Client > 0)

    query_where = query_where + " AND account.T_CLIENT  = " + string(Param.Client);

  end;

  if( (Param.DepartmentList != NULL) AND (Param.DepartmentList.size() > 0) AND (Param.DepartmentList[0] > 0) )

    var DepartmentListStr = Param.DepartmentList[0];

    var i = 1;

    while(i < Param.DepartmentList.size)

      DepartmentListStr = DepartmentListStr + ", " + Param.DepartmentList[i];

      i = i + 1;

    end;

    if(Param.IsListInBranch == true)

      query_where = query_where + " AND account.T_BRANCH        IN ( " + string(DepartmentListStr) + " ) ";

    else

      query_where = query_where + " AND account.T_DEPARTMENT IN ( " + string(DepartmentListStr) + " ) ";

    end;

  end;

  if( (Param.ChapterList != NULL) AND (Param.ChapterList.size() > 0))

    var ChapterListStr = Param.ChapterList[0].Chapter;

    var ii = 1;

    while(ii < Param.ChapterList.size)

      ChapterListStr = ChapterListStr + ", " + Param.ChapterList[ii].Chapter;

      ii = ii + 1;

    end;

    query_where = query_where + " AND account.T_CHAPTER IN ( " + string(ChapterListStr) + " ) ";

  end;
  
  if( (Param.FIList != NULL) AND (Param.FIList.size() > 0))

    var FIListStr = Param.FIList[0].Fiid;

    var iii = 1;

    while(iii < Param.FIList.size)

      FIListStr = FIListStr + ", " + Param.FIList[iii].Fiid;

      iii = iii + 1;

    end;

    query_where = query_where + " AND account.T_CODE_CURRENCY IN ( " + string(FIListStr) + " ) ";

  end;

  if( (Index(Param.Account, "*") != 0) OR (Index(Param.Account, "?") != 0) )

    ConvertMask = "";

    ConvertMask = ConvertMaskToSQLFormat( Param.Account, "account.T_ACCOUNT" );

    if( ConvertMask == "" )
      ConvertMask = "1 = 1";
    end;

    query_where = query_where + " AND (" + ConvertMask + ") ";

  end;

  if( (Param.AccountMask != NULL) AND (Param.AccountMask != "") )

    ConvertMask = "";

    ConvertMask = ConvertMaskToSQLFormat( Param.AccountMask, "account.T_ACCOUNT" );

    if( ConvertMask == "" )
      ConvertMask = "1 = 1";
    end;

    query_where = query_where + " AND (" + ConvertMask + ") ";

  end;

  if( (Param.Balance != NULL) AND (Param.Balance != "") )

    ConvertMask = "";

    ConvertMask = ConvertMaskToSQLFormat( Param.Balance, "account.T_BALANCE" );

    if( ConvertMask == "" )
      ConvertMask = "1 = 1";
    end;

    query_where = query_where + " AND (" + ConvertMask + ") ";

  end;


  if( (Param.SysTypes != NULL) AND (Param.SysTypes != "") )

    query_where = query_where + " AND (account.T_TYPE_ACCOUNT LIKE '%' || '" + string(SubStr(Param.SysTypes, 1, 1)) + "' || '%' ";

    var n = 2;

    while( n < StrLen(Param.SysTypes) )

      query_where = query_where + " OR account.T_TYPE_ACCOUNT LIKE '%' || " + string(SubStr(Param.SysTypes, n, 1)) + " || '%') ";

      n = n + 1;
    end;

    query_where = query_where + " ) ";

  end;

  if(Param.Oper > 0)

    query_where = query_where + " AND account.T_OPER    = " + string(Param.Oper);

  end;

  if(Param.DepoAcc > 0)

    query_where = query_where + " AND account.T_DEPOACC = " + string(Param.DepoAcc );

  end;

  var res, err;

  GetRegistryValue( "BANK_INI\\éÅôàÖ èÄêÄåÖíêõ\\Ñéëíìè\\ãàñÖÇõÖ ëóÖíÄ ÑêìÉàï îàãàÄãéÇ", V_INTEGER, res, err );

  if(err == 0)

    if(res == 0)

      query_where = query_where + " AND account.T_DEPARTMENT    = " + string({OperDprt});

    end;

    if(res == 1)

      query_where = query_where + " AND account.T_DEPARTMENT IN (SELECT t_Code FROM ddp_dep_dbt START WITH t_Code = " + string({OperDprt}) + " CONNECT BY PRIOR t_Code = t_ParentCode) " ;

    end;

  end;
  
  query = query + query_where;
  
  return query;
  
end;

macro WebCore_GetAccountListerItemList(PageSize, PageNum, Param, sub, listLen, filteritems, orderitems)

  if(Param == NULL)

    Param = TWebAccountParam();

    Param.Status          = 0;
    Param.Chapter         = 0;
    Param.Currency        = -1;
    Param.PrivID          = 11;
    Param.IsListInBranch  = false;
    Param.Oper            = {oper};
    Param.IsWideView      = false;

  end;

  var cmd, rs;

  var Arr = TArray;
  
  var query = " SELECT t.* FROM ( SELECT rownum RN, tt.* FROM ( ";

  query = query + GetQuery(Param);

  if(filteritems != null)
  
    var strAddWhere = GetAddWhereCondition( filteritems );

    if( strAddWhere != "" )

       query = query + strAddWhere;

    end;     
  
  end;

  if(sub != "")

    query = query + " AND LOWER(account.T_ACCOUNT) LIKE LOWER ('%' || ? || '%') ";

  end;

  if( listLen != 0 )

    query = query + " AND ROWNUM < " + string(listLen);

  end;

  query = query + " ORDER BY account.T_SORT, account.T_ACCOUNTID ";
  
  if( PageSize > 0 )
    query = query + " ) tt WHERE ROWNUM <= " + string(PageSize*(PageNum + 1)) + " ) t WHERE t.RN >= " + string(PageSize*(PageNum) + 1) + " ";
  else
    query = query + " ) tt ) t ";
  end;

  cmd = RsdCommand(query);

  if(sub != "")

    cmd.addParam( "", RSDBP_IN, sub );

  end;

  rs = RsdRecordset(cmd);
  
  while(rs.movenext)

    var obj = TWebAccountListerItem;

    obj.AccountID         = rs.value("T_ACCOUNTID");
    obj.Account           = rs.value("T_ACCOUNT");
    obj.AccountName       = rs.value("T_NAMEACCOUNT");
    obj.Currency          = rs.value("T_CODE_CURRENCY");
    obj.CurrencyCode      = GetCurrency(rs.value("T_CODE_CURRENCY")).CodeWidget;
    obj.Chapter           = rs.value("T_CHAPTER");
    obj.Client            = rs.value("T_CLIENT");
    obj.ClientName        = GetClient(rs.value("T_CLIENT")).name;
    obj.Balance           = rs.value("T_BALANCE");
    obj.DepartmentName    = string(rs.value("T_DEPARTMENT"));
    obj.BranchName        = string(rs.value("T_BRANCH"));
    obj.KindAccount       = rs.value("T_KIND_ACCOUNT");

    if(Param.IsWideView == true)

      obj.RestNat = RestA(obj.Account, {curdate}, NULL, obj.Chapter, obj.Currency , NATCUR);

      if(obj.Currency == NATCUR)

        obj.RestCur = obj.RestNat;

      else

        obj.RestCur = RestAC(obj.Account, obj.Currency , {curdate}, NULL, obj.Chapter);

      end;

    end;

    obj.Oper              = rs.value("T_OPER");

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;

macro WebCore_GetAccountListerItemCount(Param, filteritems)

  var res : integer = 0;
  
  var cmd, rs;

  if(Param == NULL)

    Param = TWebAccountParam();

    Param.Status          = 0;
    Param.Chapter         = 0;
    Param.Currency        = -1;
    Param.PrivID          = 11;
    Param.IsListInBranch  = false;
    Param.Oper            = {oper};
    Param.IsWideView      = false;

  end;
  
  var query = " SELECT count(*) c FROM ( ";

  query = query + GetQuery(Param);

  if(filteritems != null)
  
    var strAddWhere = GetAddWhereCondition( filteritems );
    
    if( strAddWhere != "" )

       query = query + strAddWhere;

    end;    
  
  end;

  query = query +  " ) ";
  
  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    res = rs.value("c");

  end;

  return res;

end;

macro WebCore_GetAccountRowNum(Param, Account)

  var result : integer;

  result = 1;

  var cmd, rs;

  if(Account != NULL)

    if(Param == NULL)

      Param = TWebAccountParam();

      Param.Status          = 0;
      Param.Chapter         = 0;
      Param.Currency        = -1;
      Param.PrivID          = 11;
      Param.IsListInBranch  = false;
      Param.Oper            = {oper};
      Param.IsWideView      = false;

    end;
    
    var query = " SELECT * FROM (SELECT rownum RN, tt.* FROM ( ";

    query = query + GetQuery(Param) + " ORDER BY account.T_SORT, account.T_ACCOUNTID ) tt ) t ";
    
    query = query + " WHERE t.T_ACCOUNT = '" + string(Account.Account) + "'";

    cmd = RsdCommand(query);

    rs = RsdRecordset(cmd);

    if(rs.movenext)
    
      result = rs.value("RN");

    end;
  
  end;

  return result;

end;

macro WebCore_GetDenyWideViewAccountList()

  var res, err;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  GetRegistryValue( "BANK_INI\\éÅôàÖ èÄêÄåÖíêõ\\Ñéëíìè\\êÄáÇÖêçìíõâ ëèàëéä", V_BOOL, res, err, false, {oper} );

  if(err != 0)

    res = False;

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WebCore_CreateTWebAccountFromBD0(Chapter, Account, Currency)

  var obj;

  var cmd, rs;

  var query = " SELECT * FROM DACCOUNT_DBT WHERE T_CHAPTER = ? AND T_ACCOUNT = ? AND T_CODE_CURRENCY = ? ";
  
  cmd = RsdCommand(query);

  cmd.nullConversion = true;
  
  cmd.addParam( "", RSDBP_IN, Chapter );
  cmd.addParam( "", RSDBP_IN, Account );
  cmd.addParam( "", RSDBP_IN, Currency );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebAccount;

    obj.AccountID   = rs.value("T_ACCOUNTID");
    obj.Account     = rs.value("T_ACCOUNT");
    obj.AccountName = rs.value("T_NAMEACCOUNT");
    obj.Currency    = rs.value("T_CODE_CURRENCY");
    obj.Chapter     = rs.value("T_CHAPTER");
    obj.Client      = rs.value("T_CLIENT");

  end;

  return obj;

end;

macro WebCore_CreateTWebAccountFromBD1(AccountID)

  var obj;

  var cmd, rs;

  var query = " SELECT * FROM DACCOUNT_DBT WHERE T_ACCOUNTID = ? ";
  
  cmd = RsdCommand(query);

  cmd.nullConversion = true;
  
  cmd.addParam( "", RSDBP_IN, AccountID );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebAccount;

    obj.AccountID   = rs.value("T_ACCOUNTID");
    obj.Account     = rs.value("T_ACCOUNT");
    obj.AccountName = rs.value("T_NAMEACCOUNT");
    obj.Currency    = rs.value("T_CODE_CURRENCY");
    obj.Chapter     = rs.value("T_CHAPTER");
    obj.Client      = rs.value("T_CLIENT");

  end;

  return obj;

end;

macro WebCore_CreateTWebAccountFromBD2(Account)



  var obj;

  var cmd, rs;

  var query = " SELECT * FROM DACCOUNT_DBT WHERE T_ACCOUNT = ? ";
  
  cmd = RsdCommand(query);

  cmd.nullConversion = true;
  
  cmd.addParam( "", RSDBP_IN, Account );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebAccount;

    obj.AccountID   = rs.value("T_ACCOUNTID");
    obj.Account     = rs.value("T_ACCOUNT");
    obj.AccountName = rs.value("T_NAMEACCOUNT");
    obj.Currency    = rs.value("T_CODE_CURRENCY");
    obj.Chapter     = rs.value("T_CHAPTER");
    obj.Client      = rs.value("T_CLIENT");

  end;

  return obj;

end;


macro WebCore_CreateTWebAccount(AccountID, Account, AccountName, Currency, Chapter, Client)

  var obj = TWebAccount;
  
  obj.AccountID   = AccountID;
  obj.Account     = Account;
  obj.AccountName = AccountName;
  obj.Currency    = Currency;
  obj.Chapter     = Chapter;
  obj.Client      = Client;

  return obj;

end;

macro WebCore_GetAccAnlListerItemList(ExceptAnaliticsId, Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DACCANL_DBT accanl";
        
  var query_cond =" WHERE 1 = 1 ";
  
  if(ExceptAnaliticsId != null)
                
        var i = 0;
        
        while(i < ExceptAnaliticsId.size())
  
      query_cond = query_cond + " AND accanl.T_ANALITICSID != " + ExceptAnaliticsId[i] ;
                  
          i = i + 1;
        
        end;
  
  end;
  
  if(Str != null)
  
    query_cond = query_cond +"AND LOWER(T_SHORTNAME) LIKE LOWER ('%' || ? || '%')";
  
  end;
  
  query_cond = query_cond + " ORDER BY accanl.T_ANALITICSID ";
  
  query= query + query_cond;
  
  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);
  
  while (rs.movenext)

    obj = TWebAccAnlListerItem;
        
        obj.AnaliticsID = rs.value("T_ANALITICSID");
        
    obj.ShortName = rs.value("T_SHORTNAME");
        
    obj.Name =  rs.value("T_NAME");
        
        result[result.size] = obj;

  end;

  return result;  

end;

macro WebCore_GetAccAnlObj(AnaliticsID)

  var obj;

  var cmd, rs;

  var query = " SELECT * FROM DACCANL_DBT accanl WHERE accanl.T_ANALITICSID = ? ";
  
  cmd = RsdCommand(query);

  cmd.nullConversion = true;
  
  cmd.addParam( "", RSDBP_IN, AnaliticsID );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebAccAnl;
    obj.AnaliticsID   = rs.value("T_ANALITICSID");
    obj.ShortName     = rs.value("T_SHORTNAME");

  end;

  return obj;

end;