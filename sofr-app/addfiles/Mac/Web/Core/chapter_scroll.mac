/*
$Name:        chapter_scroll.mac
$Module:      Главная книга
$Description: Макрос списка глав счетов
*/

import "ws_partycommon.mac";
import "ws_validation.mac";
import BankInter;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_GetChapterGridItemList(iNumPlan)

  var cmd, rs;

  var Rec = TRecHandler("obchaptr");
  var Arr = TArray;

  var query = "select c.* from DOBCHAPTR_DBT c";
  
  if(iNumPlan != null)
  
    query = query + ", DNAMEPLAN_CHAPTR_DBT nc where c.T_CHAPTER = nc.T_CHAPTER and nc.T_INUMPLAN = " + string(iNumPlan);
    
  end;
  
  query = query + " ORDER BY c.T_CHAPTER ";

  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("obchaptr");
    copy(p, Rec);

    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro WebCore_GetChapterList(ExceptChapterNumsString,Chapter)

  var cmd, rs;

  var Rec = TRecHandler("obchaptr");
  var Arr = TArray;

  var query = "select * from DOBCHAPTR_DBT";
  
  if((ExceptChapterNumsString != null) AND (ExceptChapterNumsString != ""))
  
    query = query + " WHERE T_CHAPTER NOT IN ( " + string(ExceptChapterNumsString) + " )";
  elif((Chapter != null) AND (Chapter != ""))

    query = query + " WHERE to_char(T_CHAPTER) LIKE '%" + string(Chapter) + "%' ";  
  end;
  
  cmd = RsdCommand(query);
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    _CopyRecordsetToRecHandler(rs, Rec);

    var p = TRecHandler("obchaptr");
    copy(p, Rec);
   
    Arr[Arr.size] = p.rec;

  end;

  return Arr;

end;

macro WebCore_InsertNamePlan_Chapter(iNumPlan, Chapter)

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_InsertNamePlan_Chapter(iNumPlan, Chapter);
  
  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;  

end;

macro WebCore_DeleteNamePlan_Chapter(iNumPlan, Chapter)

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_DeleteNamePlan_Chapter(iNumPlan, Chapter);
  
  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;  

end;

macro WebCore_CloseChapter(Chapter)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_CloseChapter(Chapter);
  
  if(stat != 0)

    CreateErrMsg(stat);

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(stat == 0);

  return responseBuilder.Result;  

end;

macro WebCore_OpenChapter(Chapter)

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_OpenChapter(Chapter);
  
  if(stat != 0)

    CreateErrMsg(stat);

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(stat == 0);

  return responseBuilder.Result;  

end;

macro WebCore_DeleteChapter(Chapter)

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  var stat = CB_DeleteChapter(Chapter);
  
  if(stat != 0)

    CreateErrMsg(stat);

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(stat == 0);

  return responseBuilder.Result;  

end;
