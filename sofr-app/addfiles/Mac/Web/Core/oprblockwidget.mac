/*
$Name:        oprblockwidget.mac
$Module:      Главная книга
$Description: сервисы для виджета блоков шагов операции.
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";


class TWebOprBlockListerItem 
 
  var BlockID          	: integer ; 
  
  var Name     			: String ; 
  
  var DocKind         	: integer ;
       
end;

class TWebOprBlock  
 
  var BlockID          	: integer ; 
  
  var Name     			: String ; 
  
  var DocKind         	: integer ; 
   
end;

class TWebOprStValListerItem 
 
  var StatusKindID  : integer ; 
  
  var NumValue      : integer ; 
  
  var Name         	: String ;
       
end;

class TWebOprStVal 
 
  var StatusKindID  : integer ; 
  
  var NumValue      : integer ; 
  
  var Name         	: String ;
       
end;

class TWebOprStKndListerItem 
 
  var StatusKindID  : integer ; 
  
  var Code      	: String ; 
  
  var Name         	: String ;
  
  var DocKind  		: integer ; 
       
end;

class TWebOprStKnd 
 
  var StatusKindID  : integer ; 
  
  var Code      	: String ; 
  
  var Name         	: String ;
  
  var DocKind  		: integer ; 
       
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

macro WebCore_GetOprBlockListerItem(DocKind , Str) : TArray

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT  OPRB.T_BLOCKID, OPRB.T_DOCKIND, OPRB.T_NAME	"
			  "	FROM DOPRBLOCK_DBT OPRB								"
			  " WHERE 1=1											";
			  
  if(DocKind != 0)
  
    query = query + " AND OPRB.T_DOCKIND= " + DocKind;
  
  end;
  
  if(Str != "")
  
    query = query + " AND LOWER(T_BLOCKID) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;

  query = query + " ORDER BY OPRB.T_BLOCKID   ";

  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebOprBlockListerItem;
	
    obj.BlockID = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.DocKind  = SQL_ConvType(rs.value("T_DOCKIND"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;

macro GetOprBlockFromBD(BlockID) 

  var obj;

  var cmd, rs;

  var query = " SELECT  OPRB.T_BLOCKID, OPRB.T_DOCKIND, OPR.T_NAME	"
			  "	FROM DOPRBLOCK_DBT OPRB								"
			  " WHERE  OPRB.T_BLOCKID= ? 							";

  cmd = RsdCommand(query);

  cmd.addParam( "BlockID", RSDBP_IN, BlockID );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebOprBlock;
	
    obj.BlockID = SQL_ConvType(rs.value("T_BLOCKID"));
	
    obj.DocKind  = SQL_ConvType(rs.value("T_DOCKIND"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

  end;

  return obj;

end;

macro WebCore_GetOprStValListerItem(StatusKindID, Str) : TArray

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT  OPRSTVAL.T_STATUSKINDID, OPRSTVAL.T_NUMVALUE, OPRSTVAL.T_NAME	"
			  "	FROM DOPRSTVAL_DBT OPRSTVAL												"
			  " WHERE 1=1																";
			  
  if(StatusKindID != 0)
  
    query = query + " AND OPRSTVAL.T_STATUSKINDID = " + StatusKindID;
  
  end;
  
  if(Str != "")
  
    query = query + " AND LOWER(T_NUMVALUE) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;

  query = query + " ORDER BY OPRSTVAL.T_STATUSKINDID, OPRSTVAL.T_NUMVALUE  ";

  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebOprStValListerItem;
	
    obj.StatusKindID = SQL_ConvType(rs.value("T_STATUSKINDID"));
	
    obj.NumValue  = SQL_ConvType(rs.value("T_NUMVALUE"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;


macro GetOprStVal(StatusKindID, NumValue, Name) 

  var obj = TWebOprStVal ;
	
  obj.StatusKindID = StatusKindID;
	
  obj.NumValue  = NumValue;
	
  obj.Name  = Name;

  return obj;

end;


macro GetOprStValFromBD(StatusKindID, NumValue) 

  var obj;

  var cmd, rs;

  var query = " SELECT  OPRSTVAL.T_STATUSKINDID, OPRSTVAL.T_NUMVALUE, OPRSTVAL.T_NAME	"
			  "	FROM DOPRSTVAL_DBT OPRSTVAL												"
			  " WHERE OPRSTVAL.T_STATUSKINDID = ? AND OPRSTVAL.T_NUMVALUE =	?			";

  cmd = RsdCommand(query);

  cmd.addParam( "StatusKindID", RSDBP_IN, StatusKindID );
  
  cmd.addParam( "NumValue", RSDBP_IN, NumValue );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebOprStVal;
	
    obj.StatusKindID = SQL_ConvType(rs.value("T_STATUSKINDID"));
	
    obj.NumValue  = SQL_ConvType(rs.value("T_NUMVALUE"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));

  end;

  return obj;

end;


macro WebCore_GetOprStKndListerItem(DocKind, Str) : TArray

  var cmd, rs;

  var Arr = TArray;

  var query = " SELECT  OPRSTKND.T_STATUSKINDID, OPRSTKND.T_CODE, 	"
			  " OPRSTKND.T_NAME, OPRSTKND.T_DOCKIND					"
			  "	FROM DOPRSTKND_DBT OPRSTKND							"
			  " WHERE 1=1											";
			  
  if(DocKind != 0)
  
    query = query + " AND T_DOCKIND IN (    SELECT t_DocKind FROM doprkdoc_dbt START WITH t_DocKind = " + DocKind + "CONNECT BY PRIOR t_ParentDocKind = t_DocKind) ";
  
  end;
  
  if(Str != "")
  
    query = query + " AND LOWER(T_CODE) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;

  query = query + " ORDER BY OPRSTKND.T_SORT, OPRSTKND.T_STATUSKINDID  ";

  cmd = RsdCommand(query);
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)

    var obj = TWebOprStKndListerItem;
	
    obj.StatusKindID = SQL_ConvType(rs.value("T_STATUSKINDID"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));
	
	obj.DocKind  = SQL_ConvType(rs.value("T_DOCKIND"));

    Arr[Arr.size] = obj;

  end;

  return Arr;

end;


macro GetOprStKnd (StatusKindID, Code, Name, DocKind) 

  var obj = TWebOprStKnd ;
	
  obj.StatusKindID = StatusKindID;
	
  obj.Code  = Code;
	
  obj.Name  = Name;
  
  obj.DocKind  = DocKind;

  return obj;

end;


macro GetOprStKndFromBD(StatusKindID) 

  var obj;

  var cmd, rs;

  var query = " SELECT  OPRSTKND.T_STATUSKINDID, OPRSTKND.T_CODE, 	"
			  " OPRSTKND.T_NAME, OPRSTKND.T_DOCKIND					"
			  "	FROM DOPRSTKND_DBT OPRSTKND							"
			  " WHERE OPRSTKND.T_STATUSKINDID = ? 					";

  cmd = RsdCommand(query);

  cmd.addParam( "StatusKindID", RSDBP_IN, StatusKindID );

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj = TWebOprStKnd;
	
    obj.StatusKindID = SQL_ConvType(rs.value("T_STATUSKINDID"));
	
    obj.Code  = SQL_ConvType(rs.value("T_CODE"));
	
	obj.Name  = SQL_ConvType(rs.value("T_NAME"));
	
	obj.DocKind  = SQL_ConvType(rs.value("T_DOCKIND"));

  end;

  return obj;

end;
