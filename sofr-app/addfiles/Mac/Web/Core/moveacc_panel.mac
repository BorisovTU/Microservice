/*
$Name:        moveacc_panel.mac
$Module:      Web - Главная книга
$Description: Функции для работы панели "Смена номера счета"
*/

import FIInter,BankInter,RSD,CarryDoc;
import "cb_sql.mac", "web_scroll_lib.mac";
import "ws_dprt.mac";
import "ws_validation.mac";
import "ws_person.mac";
import "ws_llvalues.mac";
import "switch_phase.mac";
import "ws_fiunilist.mac";
import "ws_getparty.mac";
import "acctrn_panel.mac";
import "operdayphase_panel.mac";
import "balaccount_widget.mac";


class  TWebMoveAccObject

  var Chapter     ; //TWebChapter
  var FI          ; //TWsFinInstr
  var OldAccount  ; //TWebAccount
  var NewAccount  :String;
  var OldBalance  ; //TWebBalAccount
  var NewBalance  ; //TWebBalAccount
  
end;

PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;
  ResponseBuilder.AddMessage( ErrorMessage );

end;


  
macro WebCore_BeforeShowMoveAccPanel()

  var res = false;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  if( CheckActionRestriction(16) == true)

    res = true;

  end;

  if(res != true)

    CreateErrMsg(256);
    AddErrorMessage(@ErrorMessage);

  end;
   
  return ResponseBuilder.Result;

end;

macro WebCore_InitMoveAccPanel():TWebMoveAccObject

  var MoveAccObj = TWebMoveAccObject();
  
  var query = "SELECT t_Chapter, t_Name, t_SHortName, t_Symbol FROM dobchaptr_dbt WHERE t_Chapter = 1";
  
  var  cmd = RsdCommand(query);
  
  var rs = RsdRecordset(cmd);

  if(rs.movenext)
  
    MoveAccObj.Chapter = TWebChapter;
	
    MoveAccObj.Chapter.Chapter   = SQL_ConvType(rs.value("t_Chapter"));   
	
    MoveAccObj.Chapter.Name      = SQL_ConvType(rs.value("t_Name"));
	
    MoveAccObj.Chapter.ShortName = SQL_ConvType(rs.value("t_ShortName"));
	
    MoveAccObj.Chapter.Symbol    = SQL_ConvType(rs.value("t_Symbol"));
	
  end;
   
  MoveAccObj.FI =  GetTWsFinInstrByID(NATCUR);
  
  return MoveAccObj;

end;

macro WebCore_ExecMoveAcc(PanelObj) : WebResponseBuilder

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();
  
  var par = true;

  var res = MoveAccount (PanelObj.OldAccount.Chapter, PanelObj.OldAccount.Account, PanelObj.NewAccount, PanelObj.OldAccount.Currency,PanelObj.NewBalance.Balance);

  if( res != 0)
  
    par=false;

    AddErrorMessage(@ErrorMessage);

  end;

  ResponseBuilder.SetUserObject(par);
  
  return ResponseBuilder.Result;

end;

macro WebCore_GetTWebBalAccountByAccountID (AccountID) : TWebBalAccount

  var BalAccount;

  var query = " SELECT * "
				
			    " FROM daccount_dbt account "  
				
			    " WHERE account.T_ACCOUNTID = ? " ;
  
  var cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, AccountID );
  
  var rs = RsdRecordset(cmd);

  if(rs.movenext)
	
	BalAccount = WebCore_CreateTWebBalAccountFromBD(SQL_ConvType(rs.value("T_BALANCE")),SQL_ConvType(rs.value("T_CHAPTER")),0 );
	
  end;
  
  return BalAccount;

end;



