/*
$Name:        balaccount_panel.mac
$Module:      Главная книга
$Description:  Сервисы панели балансовых счетов
*/

import "ws_validation.mac";
import "balaccount_widget.mac";

class TWebBalAccountObject
  var ID              : integer;
  var iNumPlan        : integer;
  var Balance         : string;
  var Chapter         : integer;           
  var Kind_Account    : string;
  var Name_Part       : string;
  var Part            : integer;
  var Type_Balance    : string;
  var ExtraType       : string;
  var cBlncUsedBWP    : bool;
  var IsPorR          : bool;
  var IsPaired        : bool;
  var IsReducible     : bool;
  var PairBalance     ; //: TWebBalAccount;
  var IsContrAcc      : bool;
  var NotAllowSPOD    : bool;
  var bdincludeBWP    : date;
  var bdExcludeBWP    : date;
  var SkipUpgrade     : bool;
  var FIAll           : bool;
  var FINational      : bool;
  var FIForeign       : bool;
  var FIMetall        : bool;
  var FISecurity      : bool;
  var NoteText        : string;
  var Version         : integer;
/*
  var ContrBalA : string;
  var ContrBalP : string;
  var UNrealizedCatNumPlus : integer;
  var UnrealizedCatNumMinus : integer;
  var PairCatID_Plus : integer;
  var PairCatID_Minus : integer;
  var RealizedCatNumPlus : integer;
  var RealizedCatNumMinus : integer;
  var NVPI_CatPlus : integer;
  var NVPI_CatMinus : integer;
*/
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

macro WebCore_GetBalAccObject(Chapter, NumPlan, Balance)


  var cmd, rs;

  var obj = TWebBalAccountObject;

  var query = " SELECT * FROM dbalance_dbt WHERE t_chapter = ? AND t_iNumPlan = ? AND t_Balance = ? ";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, Chapter );
  cmd.addParam( "", RSDBP_IN, NumPlan );
  cmd.addParam( "", RSDBP_IN, Balance );

  rs = RsdRecordset(cmd);

  var PairBalance = "";
  var IsReducible = false;

  if(rs.movenext)

    obj.ID                    = SQL_ConvType(rs.value("t_ID"));
    obj.iNumPlan              = SQL_ConvType(rs.value("t_iNumPlan"));
    obj.Balance               = SQL_ConvType(rs.value("t_Balance"));
    obj.Chapter               = SQL_ConvType(rs.value("t_Chapter"));
    obj.Kind_Account          = SQL_ConvType(rs.value("t_Kind_Account"));
    obj.Name_Part             = SQL_ConvType(rs.value("t_Name_Part"));
    obj.Part                  = SQL_ConvType(rs.value("t_Part"));
    obj.Type_Balance          = SQL_ConvType(rs.value("t_Type_Balance"));
    obj.ExtraType             = SQL_ConvType(rs.value("t_ExtraType"));
    obj.cBlncUsedBWP          = SQL_ConvTypeBool(rs.value("t_cBlncUsedBWP"));
    obj.IsContrAcc            = SQL_ConvTypeBool(rs.value("t_IsContrAcc"));
    obj.NotAllowSPOD          = SQL_ConvTypeBool(rs.value("t_NotAllowSPOD"));
    obj.bdincludeBWP          = SQL_ConvTypeDate(rs.value("t_bdincludeBWP"));
    obj.bdExcludeBWP          = SQL_ConvTypeDate(rs.value("t_bdExcludeBWP"));
    obj.SkipUpgrade           = SQL_ConvTypeBool(rs.value("t_SkipUpgrade"));
    obj.FIAll                 = SQL_ConvTypeBool(rs.value("t_FIAll"));
    obj.FINational            = SQL_ConvTypeBool(rs.value("t_FINational"));
    obj.FIForeign             = SQL_ConvTypeBool(rs.value("t_FIForeign"));
    obj.FIMetall              = SQL_ConvTypeBool(rs.value("t_FIMetall"));
    obj.FISecurity            = SQL_ConvTypeBool(rs.value("t_FISecurity"));
    obj.Version               = SQL_ConvType(rs.value("t_Version"));

    // Add 
    PairBalance = SQL_ConvType(rs.value("t_PairBalance"));
    IsReducible = SQL_ConvTypeBool(rs.value("t_IsReducible"));
  end;

  obj.IsPorR                = true;

  if(PairBalance != "")
    obj.PairBalance = WebCore_CreateTWebBalAccountFromBD(PairBalance, Chapter, NumPlan );
    if(obj.PairBalance != NULL)
      if(IsReducible == true)
        obj.IsPorR                = false;
        obj.IsPaired              = false;
        obj.IsReducible           = true;
      else
        obj.IsPorR      = false;
        obj.IsPaired    = true;
        obj.IsReducible = false;
      end;
    else
      obj.IsPorR                = true;
      obj.IsPaired              = false;
      obj.IsReducible           = false;
    end;
  else
    obj.IsPorR                = true;
    obj.IsPaired              = false;
    obj.IsReducible           = false;
  end;

  query = "SELECT t_szNoteText FROM dblnote_dbt WHERE T_BALANCE = ? AND t_Chapter = ? AND t_iNumPlan = ?";

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Balance );
  cmd.addParam( "", RSDBP_IN, Chapter );
  cmd.addParam( "", RSDBP_IN, NumPlan );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)
    obj.NoteText = SQL_ConvType(rs.value("t_szNoteText"));
  end;

  return obj;
end;

private macro ConvTypeBool(boolVal)
  if(boolVal != NULL)
    if(boolVal == true)
      return "X";
    else
      return "";
    end;
  else
    return ""
  end;
end;

private macro SetBalAccObject(Balance, NoteText:@string, BalAccObject, IsReducible)
  ClearRecord(Balance);

  if(BalAccObject.ID           != NULL) Balance.ID             =  BalAccObject.ID          ; end;
  if(BalAccObject.iNumPlan     != NULL) Balance.iNumPlan       =  BalAccObject.iNumPlan    ; end;
  if(BalAccObject.Balance      != NULL) Balance.Balance        =  BalAccObject.Balance     ; end;
  if(BalAccObject.Chapter      != NULL) Balance.Chapter        =  BalAccObject.Chapter     ; end;
  if(BalAccObject.Kind_Account != NULL) Balance.Kind_Account   =  BalAccObject.Kind_Account; end;
  if(BalAccObject.Name_Part    != NULL) Balance.Name_Part      =  BalAccObject.Name_Part   ; end;
  if(BalAccObject.Part         != NULL) Balance.Part           =  BalAccObject.Part        ; end;
  if(BalAccObject.Type_Balance != NULL) Balance.Type_Balance   =  BalAccObject.Type_Balance; end;
  if(BalAccObject.ExtraType    != NULL) Balance.ExtraType      =  BalAccObject.ExtraType   ; end;
  if(BalAccObject.cBlncUsedBWP != NULL) Balance.cBlncUsedBWP   =  ConvTypeBool(BalAccObject.cBlncUsedBWP); end;
  if(BalAccObject.IsContrAcc   != NULL) Balance.IsContrAcc     =  ConvTypeBool(BalAccObject.IsContrAcc  ); end;
  if(BalAccObject.NotAllowSPOD != NULL) Balance.NotAllowSPOD   =  ConvTypeBool(BalAccObject.NotAllowSPOD); end;
  if(BalAccObject.bdincludeBWP != NULL) Balance.bdincludeBWP   =  BalAccObject.bdincludeBWP; end;
  if(BalAccObject.bdExcludeBWP != NULL) Balance.bdExcludeBWP   =  BalAccObject.bdExcludeBWP; end;
  if(BalAccObject.SkipUpgrade != NULL) Balance.SkipUpgrade    =  ConvTypeBool(BalAccObject.SkipUpgrade ); end;
  if(BalAccObject.FIAll       != NULL) Balance.FIAll          =  ConvTypeBool(BalAccObject.FIAll       ); end;
  if(BalAccObject.FINational  != NULL) Balance.FINational     =  ConvTypeBool(BalAccObject.FINational  ); end;
  if(BalAccObject.FIForeign   != NULL) Balance.FIForeign      =  ConvTypeBool(BalAccObject.FIForeign   ); end;
  if(BalAccObject.FIMetall    != NULL) Balance.FIMetall       =  ConvTypeBool(BalAccObject.FIMetall    ); end;
  if(BalAccObject.FISecurity  != NULL) Balance.FISecurity     =  ConvTypeBool(BalAccObject.FISecurity  ); end;
  if(BalAccObject.Version     != NULL) Balance.Version        =  BalAccObject.Version; end;

  if(BalAccObject.PairBalance != NULL)
    Balance.PairBalance =  BalAccObject.PairBalance.Balance;
  end;

  if(BalAccObject.NoteText != NULL)
    NoteText = BalAccObject.NoteText;
  end;

  if(IsReducible == true)
    Balance.IsReducible = "X";
  end;
end;

macro WebCore_InsertBalAccount(BalAccObject) // : WebResponseBuilder

  file Balance("balance.dbt");
  var NoteText = "";

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  SetBalAccObject(Balance, NoteText, BalAccObject, BalAccObject.IsReducible);

  res = CB_InsertBalAccount(Balance, NoteText, BalAccObject.IsPaired, BalAccObject.IsReducible);

  if(res != True)
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
end;

macro WebCore_UpdateBalAccount(BalAccObject, BalAccObjectSave) // : WebResponseBuilder

  file Balance("balance.dbt");
  file Balance_save("balance.dbt");
  var NoteText = "";
  var NoteTextSave = "";
  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  SetBalAccObject(Balance, @NoteText, BalAccObject, BalAccObject.IsReducible);
  SetBalAccObject(Balance_save, @NoteTextSave, BalAccObjectSave, null);

  res = CB_UpdateBalAccount(Balance, Balance_save, NoteText, NoteTextSave, BalAccObject.IsPaired, BalAccObject.IsReducible);

  if(res != True)
    AddErrorMessage(@ErrorMessage);
  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
end;