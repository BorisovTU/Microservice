/*
$Name:        selectunit.mac
$Module:      Главная книга
$Description: сервисы единиц измерения 
*/

IMPORT BankInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebMeasureListerItem 
 
  var MeasureCode 	: integer ; 
  
  var Name      	: String ; 
  
  var Definition    : String ; 
  
  var CNM      		: String ; 
    
end;

class TWebMeasureGridItem 
 
  var MeasureCode 	: integer ; 
  
  var Name      	: String ; 
  
  var Definition    : String ; 
  
  var CNM      		: String ; 
    
end;



PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;


macro WebCore_GetMeasureListerItem (Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DMEASURE_DBT MEASURE ";
	
  var query_cond =" WHERE 1 = 1 ";
   	  	  
  if(Str != null)
  
    query_cond = query_cond +" AND LOWER(MEASURE.T_NAME) LIKE LOWER ('%' ||' ? '|| '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY MEASURE.T_MEASURECODE ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);
  
  cmd.addParam( "", RSDBP_IN, Str );
  
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebMeasureListerItem;
	
	obj.MeasureCode = SQL_ConvType(rs.value("T_MEASURECODE"));
	
    obj.Name = SQL_ConvType(rs.value("T_NAME"));
	
	obj.Definition = SQL_ConvType(rs.value("T_DEFINITION"));
	
    obj.CNM = SQL_ConvType(rs.value("T_CNM"));
			
	result[result.size] = obj;

  end; 

  return result;
  
end;


macro WebCore_GetWebMeasureGridItemList () : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = " SELECT * FROM DMEASURE_DBT MEASURE ";
	
  cmd = RsdCommand(query);
    
  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebMeasureListerItem;
	
	obj.MeasureCode = SQL_ConvType(rs.value("T_MEASURECODE"));
	
    obj.Name = SQL_ConvType(rs.value("T_NAME"));
	
	obj.Definition = SQL_ConvType(rs.value("T_DEFINITION"));
	
    obj.CNM = SQL_ConvType(rs.value("T_CNM"));
			
	result[result.size] = obj;

  end; 

  return result;
  
end;


macro WebCore_DeleteMeasure (MeasureCode):WebResponseBuilder

  file measure("measure.dbt") key 0 write;

  var res ;

  ResponseBuilder = WebResponseBuilder();

  measure.MeasureCode = MeasureCode;
  
  res = GetEQ( measure );

  if(res == true)

    res = Delete(measure);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WebCore_InsUpdMeasure (Measure, oldMeasureCode, isInsert):WebResponseBuilder

  var res ;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  file measurerec("measure.dbt") key 0 write;

  ClearRecord(measurerec);

  if(isInsert == true) /*Create*/

    measurerec.MeasureCode    = Measure.MeasureCode;
    measurerec.Name           = Measure.Name;
	  measurerec.Definition     = Measure.Definition;
    measurerec.CNM            = Measure.CNM;

    res = GetEQ( measurerec );
    
    if(res == true) // такая запись уже есть

      res = false;

      AddErrorMessageExt(@ErrorMessage, 0, "Такая запись уже есть");

    else

      res = Insert(measurerec);

    end;  

  else

    measurerec.MeasureCode    = oldMeasureCode;
    
    res = GetEQ( measurerec );
    
    if(res == true)
    	
      measurerec.MeasureCode   = Measure.MeasureCode;
      measurerec.Name          = Measure.Name;
      measurerec.Definition    = Measure.Definition;
      measurerec.CNM           = Measure.CNM;

      res = UpDate(measurerec);

    else
    
      AddErrorMessageExt(@ErrorMessage, 0, "Ошибка обновления");
    
    end;  
  
  end; 

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;  

end;
