/*
$Name:        bt_txy_widget.mac
$Module:      Главная книга
$Description: сервисы для виджета кодов КБК.
*/

IMPORT BankInter;
IMPORT OprInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebBt_TxyListerItem 
 
  var ID       	: integer = 0 ;
  
  var Tag    	: String = "" ;
    
  var Caption   : String = "" ;
        
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if(CurValue == "CHR (88)")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro WebCore_GetBt_TxyListerItem (Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = 	"  SELECT BT_TXY.T_ID ID,  							"+
				"  BT_TXY.T_TAG TAG,  								"+
				"  BT_TXY.T_CAPTION CAPTION  						"+
				"  FROM DBT_TXY_DBT BT_TXY	 						";
	
  var query_cond =" WHERE 1 = 1 ";
	  
  if(Str != "")
  
    query_cond = query_cond +" AND LOWER(T_TAG) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;
  
  query_cond = query_cond + " ORDER BY ID ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebBt_TxyListerItem;

	obj.ID  = SQL_ConvType(rs.value("ID"));
  
    obj.Tag  = SQL_ConvType(rs.value("TAG"));
    
    obj.Caption   = SQL_ConvType(rs.value("CAPTION"));
		
	result[result.size] = obj;

  end; 

  return result;
  
end;



