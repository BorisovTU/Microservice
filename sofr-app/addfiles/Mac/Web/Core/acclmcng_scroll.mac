 /*
 $Name: acclmcng_scroll.mac
 $Module: Главная книга
 $Description: Макрос Список претензий
 */

import RsbDataSet, globals, oralib, likepy;
import BankInter;
import "ws_partycommon.mac";
import "ws_validation.mac";
import "account_scroll.mac";
import "ws_person.mac";
import "ws_datafilter.mac";
import "ws_llvalues.mac";
import "ws_partyclasses.mac";
import "ws_file.mac";

class TWebAcClaimGridParam
  var Review;
  var Title;
  var IsAccountFieldVisible;
  var IsPaymentButtonEnabled;
end;

class TWebNameKind
  var ID   : integer;  
  var Name : string ;
end;

class TWebAcClaimGridItem
  var ClaimID;
  var Account;
  var Status;
  var SysDate;
  var DocDate;
  var DocNumber;
  var Initiator;
  var ClaimKind;
  var RestKind;
  var BeneficiaryName;
  var CurrentAmount;
  var CurrentPriority;
  var Comment;
  var IsAuto;
  var Oper;
  var StartDate;
  var FinishDate;
end;

class TWebAcClmSttGridItem
  var StateName;
  var StateDate;
  var CurrentAmount;
  var Priority;
end;

class TWebAcClaimInit
  var InitiatorID;
  var Group;
  var Name;
end;

class TWebAcClaimObject
  var EditingIsEnabled;
  var ClaimID;
  var FIID;
  var Chapter;
  var Account;
  var BeneficiaryName;
  var Status;
  var Oper;
  var HasChanges;
  var SysDate;
  var DocDate;
  var DocNumber;
  var ClaimKind;
  var RestKind;
  var IsIncremental;
  var Initiator;
  var FiscOrgParty;
  var StartAmount;
  var Priority;
  var MaxPriority;
  var StartDate;
  var FinishDate;
  var Comment;
  var ClaimCancelObj;
  var Version;
end;



class TWebAcClmCngGridItem

  var ChangeDocID   : integer;   
  
  var Status        ;//TWebNameKind
  
  var SysDate       : Date;
  
  var DocDate       : Date;
  
  var DocNumber     : string ;
  
  var Initiator     ; //TWebNameKind
  
  var ChangeKind    ; //TWebNameKind
  
  var StartDate     : Date;
  
  var FinishDate    : Date;
  
  var Delta         : money;
  
  var Priority      : integer;   
  
  var Comment       : string ;
  
  var IsAuto        : bool;  
  
  var Oper          ;// TWsPerson

end;

class TWebAcClaimObj

  var  ClaimID    : integer;   
   
  var  DocNumber  : string ;

end;

class TWebAcClmCngGridParam

  var Review : bool;  

  var Title  : string ;

end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;



macro WebCore_GetAcClmCngGridItemList(PageSize,PageNum,ClaimID)

  var result = TArray();

  var cmd, rs;
	
  var query = " SELECT * "
				
			  " FROM dacclmcng_dbt acclmcng "  
				
			  " WHERE acclmcng.T_CLAIMID = ? " ;
 
  if(PageSize != 0)
  
    query = SQL_WrapSelect( query, PageNum, PageSize);
    
  end;
  
  query = query + " ORDER BY T_SysDate asc ";
  
  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, ClaimID );
  
  rs = RsdRecordset(cmd);

  while(rs.movenext)
  
    var ClmCngGridItem =TWebAcClmCngGridItem();

	ClmCngGridItem.ChangeDocID = SQL_ConvType(rs.value("T_CHANGEDOCID"));
	
	var query_inside1 = " SELECT acs.t_State AS T_ID "
						" FROM dacclmcngstate_dbt acs "
						" WHERE acs.t_ChangeDocID = ? "
						" AND acs.t_StateDate <=? "
						" ORDER BY acs.t_StateDate DESC ";
	
	var  cmd_inside1 = RsdCommand(query_inside1);
	
    cmd_inside1.NullConversion = true;
		  
	cmd_inside1.addParam( "", RSDBP_IN, ClmCngGridItem.ChangeDocID );
	
	cmd_inside1.addParam( "", RSDBP_IN, {curdate} );
	 
    var rs_inside1 = RsdRecordset(cmd_inside1);

	if(rs_inside1.movenext)

	    ClmCngGridItem.Status  =  TWebNameKind();

		ClmCngGridItem.Status.ID = SQL_ConvType(rs_inside1.value("T_ID" ));
		
		if(ClmCngGridItem.Status.ID!=4)

		   if(({curdate} < SQL_ConvType(rs.value("T_STARTDATE"))) OR (((SQL_ConvType(rs.value("T_FINISHDATE")))!= date(0,0,0)) AND ((SQL_ConvType(rs.value("T_FINISHDATE"))) < {curdate} )))
		  
		    ClmCngGridItem.Status.ID=5;
		  
		  end;
		  
		end;
				
	    query_inside1 = " SELECT llv.t_Code AS T_CODE "
						" FROM dllvalues_dbt llv "
						"  WHERE llv.t_Element = ? "
						"  AND llv.t_List = 2528 ";
		
		cmd_inside1 = RsdCommand(query_inside1);
		
		cmd_inside1.addParam( "", RSDBP_IN, ClmCngGridItem.Status.ID );
				 
		rs_inside1 = RsdRecordset(cmd_inside1);
		
		if(rs_inside1.movenext)
		
		  ClmCngGridItem.Status.Name = SQL_ConvType(rs_inside1.value("T_CODE"))
		
		end;
		
	end;
	 
	ClmCngGridItem.SysDate = SQL_ConvType(rs.value("T_SYSDATE"));
	 
	ClmCngGridItem.DocDate = SQL_ConvType(rs.value("T_DOCDATE"));
	
	ClmCngGridItem.DocNumber = SQL_ConvType(rs.value("T_DOCNUMBER"));
	
	ClmCngGridItem.Initiator =  TWebNameKind();
	  		
	var query_inside2 = " SELECT  aci.t_InitiatorID AS T_ID, aci.t_Name AS T_NAME "
					" FROM dacclaiminit_dbt aci "
					" WHERE aci.t_InitiatorID = ? ";
		
	var cmd_inside2 = RsdCommand(query_inside2);
		
	cmd_inside2.addParam( "", RSDBP_IN,SQL_ConvType(rs.value("T_INITIATOR")));
				 
	var rs_inside2 = RsdRecordset(cmd_inside2);
		
	if(rs_inside2.movenext)

	  ClmCngGridItem.Initiator.ID = SQL_ConvType(rs_inside2.value("T_ID"));
	  
	  ClmCngGridItem.Initiator.Name = SQL_ConvType(rs_inside2.value("T_NAME"));
		
	end;
	
	ClmCngGridItem.ChangeKind =  TWebNameKind();
	
	var query_inside3 = "  SELECT llv.t_Element AS t_ID, llv.t_Name AS t_Name "
					" FROM dllvalues_dbt llv  "  
					" WHERE llv.t_Element = ? "
					" AND llv.t_List = 2524 ";
		
	var cmd_inside3 = RsdCommand(query_inside3);
		
	cmd_inside3.addParam( "", RSDBP_IN,SQL_ConvType(rs.value("T_CHANGEKIND")));
				 
	var rs_inside3 = RsdRecordset(cmd_inside3);
		
	if(rs_inside3.movenext)
		
	  ClmCngGridItem.ChangeKind.ID = SQL_ConvType(rs_inside3.value("T_ID"));
	  
	  ClmCngGridItem.ChangeKind.Name = SQL_ConvType(rs_inside3.value("T_NAME"));
		
	end;

	ClmCngGridItem.StartDate = 	SQL_ConvType(rs.value("T_STARTDATE"));
	
	if(SQL_ConvType(rs.value("T_FINISHDATE"))!= Date("00.00.0000"))
	  ClmCngGridItem.FinishDate = SQL_ConvType(rs.value("T_FINISHDATE"));
	
	else
	
	  ClmCngGridItem.FinishDate=null;
	
	end;
	
	if(SQL_ConvType(rs.value("T_DELTA"))!= 0)
	
	  ClmCngGridItem.Delta = SQL_ConvType(rs.value("T_DELTA"));
	
	else
	
	  ClmCngGridItem.Delta=0;
	
	end;
	
    ClmCngGridItem.Priority = SQL_ConvType(rs.value("T_PRIORITY"));
	
	ClmCngGridItem.Comment = SQL_ConvType(rs.value("T_COMMENT"));

	if(SQL_ConvType(rs.value("T_AUTO"))=="X")
	
	  ClmCngGridItem.IsAuto =true;
	
	else
	
	  ClmCngGridItem.IsAuto =false;
		
	end;
	
	ClmCngGridItem.Oper = TWsPerson();
				
	ClmCngGridItem.Oper = FindPersonByNumber(SQL_ConvType(rs.value("T_OPER")));
	
	result[result.size] = ClmCngGridItem;
	  	  
  end;
  return result;
  
end;

macro WebCore_GetAcClmCngGridItemCount(ClaimID):integer

  var cmd, rs;

  var res : integer = 0;
  
  var query = " SELECT count(*) c FROM ( "
			  " SELECT * 	"
			  " FROM dacclmcng_dbt acclmcng  " 
			  " WHERE acclmcng.T_CLAIMID = ? )" ;
    
  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, ClaimID );
  
  rs = RsdRecordset(cmd);

  if(rs.movenext)

    res = rs.value("c");

  end;

  return res;

end;

macro WebCore_CheckDeleteAcClmCng(ChangeDocID, CheckOnly): WebResponseBuilder

  var res = True;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = CB_CheckDeleteAcClmCng(ChangeDocID,CheckOnly);

  if(res != True)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;
  
end;


macro WebCore_BeforeShowAcClmCngGrid(Review,ClaimID) :TWebAcClmCngGridParam

  
  if(ClaimID != null)
  
    var query = " SELECT * "
				
			    " FROM dacclaim_dbt acclaim "  
				
			    " WHERE acclaim.T_CLAIMID = ? " ;
 
  
  
  
    var cmd = RsdCommand(query);

    cmd.addParam( "", RSDBP_IN, ClaimID );
  
    var rs = RsdRecordset(cmd);

    if(rs.movenext)
  
      var result = TWebAcClmCngGridParam();
	
	  result.Title= "Лицевой счет " + SQL_ConvType(rs.value("T_ACCOUNT")) +". Документы, изменяющие претензию " + SQL_ConvType(rs.value("T_DOCNUMBER"))+ ".";
	
	  if(Review == true)
	
	    result.Review = true;
	
	  end;
	
  
    end;
  
    return result;

 end;

end;