/*
$Name:        stepschain.mac
$Module:      Главная книга
$Description: сервисы для виджета выбора КУ
*/

IMPORT BankInter;
IMPORT OprInter;

import "ws_file.mac";
import "ws_validation.mac";
import "cb_sql.mac";

class TWebOproBlckListerItem 
 
  var OperBlockID       	: integer ; 
  
  var Kind_Operation    	: String ; 
    
  var BlockID      			: integer ; 
  
  var Sort  				: integer ;  
  
  var NotInUse  			: bool ; 
  
  var NoInsert    			: bool ;
  
  var NoReplace 			: bool;
  
  var NoCloseInsert 		: bool ;  

  var IsManual 	  			: bool ;  

  var SymbolsForInsertion 	: String ; 

  var Symbol    			: String ; 

  var Name    				: String = "" ;   
    
end;


PRIVATE VAR ResponseBuilder : WebResponseBuilder;

private macro AddErrorMessage(ErrorMessage : @WsErrorMessage)

  var objErr = AL_GetErrorInfo();

  ErrorMessage.Code     = objErr.stat;
  ErrorMessage.Message  = objErr.message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro AddErrorMessageExt(ErrorMessage : @WsErrorMessage, stat, message)

  ErrorMessage.Code     = stat;
  ErrorMessage.Message  = message;
  ErrorMessage.Severity = MessageSeverity.RuntimeError;

  ResponseBuilder.AddMessage( ErrorMessage );

end;

private macro GetErrorMessage(ErrorCode : @integer, ErrorMessage : @string)

  var objErr = AL_GetErrorInfo();

  ErrorCode     = objErr.stat;
  ErrorMessage  = objErr.message;

  InitError();

end;

private macro ConvertCharToBool(CurValue :string ) : bool

  if(CurValue == "CHR (88)")
    
	return true;
	
  else
  
    return false;
	
  end;
  
end;

macro WebCore_GetOproBlckListerItem(Kind_Operation,NotInUse, Str) : TArray

  var result  = TArray;
  
  var cmd, rs, obj;

  var query = 	"  SELECT OPROBLCK.T_OPERBLOCKID,  					"+
				"  OPROBLCK.T_KIND_OPERATION,  						"+
				"  OPROBLCK.T_BLOCKID,  							"+
				"  OPROBLCK.T_SORT,  								"+
				"  OPROBLCK.T_NOTINUSE,  							"+
				"  OPROBLCK.T_NOINSERT,  							"+
				"  OPROBLCK.T_NOREPLACE,  							"+
				"  OPROBLCK.T_NOCLOSEINSERT,  						"+
				"  OPROBLCK.T_ISMANUAL,  							"+
				"  OPROBLCK.T_SYMBOLSFORINSERTION,					"+
				"  OPROBLCK.T_SYMBOL,  								"+
				" (													"+
				"	SELECT OB.T_NAME 								"+
				"	FROM DOPRBLOCK_DBT OB 							"+
				"	WHERE  OB.T_BLOCKID = OPROBLCK.T_BLOCKID 		"+
				" )	NAME											"+
				"FROM DOPROBLCK_DBT OPROBLCK 						";
	
  var query_cond =" WHERE OPROBLCK.T_ISMANUAL = 'X' ";
   
  if(Kind_Operation != 0)
  
    query_cond = query_cond + " AND OPROBLCK.T_KIND_OPERATION = " + Kind_Operation ;
	  	  
  end;
	  
  if(Str != "")
  
    query_cond = query_cond +" AND LOWER(T_SYMBOL) LIKE LOWER ('%' ||'"+ Str +"'|| '%') ";
  
  end;
  
  if(NotInUse == true)
  
    query_cond = query_cond + " AND OPROBLCK.T_NotInUse = 'X' ";
	
  else
	
    query_cond = query_cond + " AND OPROBLCK.T_NotInUse = CHR(0) ";
	  	  
  end;
  
  query_cond = query_cond + " ORDER BY OPROBLCK.T_SORT ";
  
  query= query + query_cond;

  cmd = RsdCommand(query);

  rs = RsdRecordset(cmd);

  while (rs.movenext)

    obj = TWebOproBlckListerItem;

	obj.OperBlockID  = SQL_ConvType(rs.value("T_OPERBLOCKID"));
  
    obj.Kind_Operation  = SQL_ConvType(rs.value("T_KIND_OPERATION"));
    
    obj.BlockID   = SQL_ConvType(rs.value("T_BLOCKID"));
  
    obj.Sort  = SQL_ConvType(rs.value("T_SORT"));
  
    obj.NotInUse  = ConvertCharToBool(SQL_ConvType(rs.value("T_NOTINUSE")));
  
    obj.NoInsert  = ConvertCharToBool(SQL_ConvType(rs.value("T_NOINSERT")));
  
    obj.NoReplace  = ConvertCharToBool(SQL_ConvType(rs.value("T_NOREPLACE")));
  
    obj.NoCloseInsert  = ConvertCharToBool(SQL_ConvType(rs.value("T_NOCLOSEINSERT")));

    obj.IsManual = ConvertCharToBool(SQL_ConvType(rs.value("T_ISMANUAL")));

    obj.SymbolsForInsertion  = SQL_ConvType(rs.value("T_SYMBOLSFORINSERTION"));

    obj.Symbol = SQL_ConvType(rs.value("T_SYMBOL"));

    obj.Name  = SQL_ConvType(rs.value("NAME"));
		
	result[result.size] = obj;

  end; 

  return result;
  
end;

macro WebCore_Opr_InsertAndExecuteBranchFromOpr(ID_Operation, ID_Step, Mode, OproBlck):WebResponseBuilder

  var res = 0;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  if(Mode ==0)
  
    res = Opr_InsertAndExecuteBranch(ID_Operation, OproBlck.Symbol,OPRBR_INSERT, ID_Step);
   
  end;
  
  if(Mode ==1)
  
    res = Opr_InsertAndExecuteBranch(ID_Operation, OproBlck.Symbol,OPRBR_REMOVE, ID_Step);
  
  end;
  
  if(Mode ==2)
  
    res = Opr_InsertAndExecuteBranch(ID_Operation, OproBlck.Symbol,OPRBR_AFTER_CLOSE, null);
  
  end;

  if(res != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

macro WebCore_Opr_UnConnectFreeBranch(ID_Operation, ID_Step):WebResponseBuilder

  var res = 0;

  ResponseBuilder = WebResponseBuilder();

  var ErrorMessage : WsErrorMessage = WsErrorMessage();

  res = Opr_UnConnectBranch(ID_Operation, ID_Step);

  if(res != 0)

    AddErrorMessage(@ErrorMessage);

  end;

  responseBuilder.SetUserObject(res);

  return responseBuilder.Result;

end;

