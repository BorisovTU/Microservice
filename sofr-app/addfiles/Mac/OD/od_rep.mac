
/*
**  Опердневник ф.24. Вывод результатов
**
09.01.2004 KIN добавлена пустая строка после обработки каждой операции
09.01.2004 KIN добавлены 3 пустые строки после каждого дневника
*/

macro printCommonHeader( oper )

  var
    branchName;

  getBranchParams( branch, branchName );

  if ( not isCur )
    [ ];
    [ ];
    [ ];
    [ ];
    [Филиал № #                                                                                                            ф.№ 24]
    ( branchName ); 
  else
    [ ];
    [ ];
    [ ];
    [Филиал № #                                                                                                             ф.№ 24-в]
    ( branchName ); 
  end;
  [ ];

  incLineCounter( 2 );

  if ( oper == 0 )
    [                                                  Сводный операционный дневник      ];
    [ ];
    incLineCounter( 2 );
  end; 
end;

macro printCommonFooter

  checkNewPage( 4 );
  [ ];
  [ Ст. контролер(контролер) ________________________________________________      Кассир _____________________________________________ ];
  [ ];
  [ Отчет проверил "___" ________________ _______ г.                               Бухгалтер __________________________________________ ];
  [ ];
  [ ];
  incLineCounter;
end;

macro printOperName( oper )

  var
    name;

  if ( findPerson( oper ) )
    name = person.rec.Name;
  else
    name = "* Не найден! *";     
  end;
  printLn( "Контролер " + oper + " " + name );
  incLineCounter( 1 );
end;

macro printBrigadeDesc

  var
    name;

  printLn( group.rec.Desc );
  incLineCounter( 1 );
end;

macro printCurrencyInfo

  var
    suffix;

  if ( rateScale )
    suffix = " руб./" + rateScale + " " + currency.rec.Short_Name;
  else
    suffix = " руб./"+ currency.rec.Short_Name;
  end; 

  [                                                                                                  Вид валюты:                     # ]
  ( currency.rec.Name_Currency:r );
  [                                                                                                  Курс покупки:                   # ]
  ( ( string( buyRate * rateScale ) + suffix ):r );
  [                                                                                                  Курс продажи:                   # ]
  ( ( string( sellRate * rateScale ) + suffix ):r );
  [                                                                                                  Курс ЦБ:                        # ]
  ( ( string( cbRate * rateScale ) + suffix ):r );
  incLineCounter( 4 );
end;

class TReporter( _oper )

  var
    oper = _oper,
    isOperReporter = true; /* детализированный дневник */

  macro print
  end;

  if ( oper == null )
    oper = 0;
  end;
end;

class ( TReporter) TDiaryReporter( _oper )

  macro printCurr
  end;

  macro print

    var i = 0;

    message( "Печать операционного дневника..." );

    isCur = 0;
    currency.clear;
    currency.rec.Code_Currency = NATIONAL_CURR;
    if ( currency.getEQ )
      printCurr; 
    end;
    
    isCur = 1;
/*    currency.rewind;
    while ( currency.next )
      if (  ( currency.rec.Code_Currency != ANY_CURR      )
        and ( currency.rec.Code_Currency != NATIONAL_CURR )
        and ( currency.rec.CrDifrRate                     )
         )
        getRate;  
        printCurr; 
      end;
    end;*/
    while (i < currencyList.size)
      currency.clear;
      currency.rec.Code_Currency = currencyList(i);
      if ( currency.getEQ )
        getRate;  
        printCurr; 
      end;
      i = i + 1;
    end;

    message( "" );
  end;

  initTReporter( _oper );
end;

class ( TReporter ) TSec_Operations( _oper )

  var
    pageTotals = TSubTotals( _oper ), 
    headerPrinted = false,
    isHeaderPrinted = false; /* для печати всех отчетов под одним заголовком */

  macro printHeader( isTail )

    if ( ( isTail != null ) and isTail )
      printLn( "(Продолжение со стр. " + string( pageCounter - 1 ) + ")" );
      incLineCounter( 1 );
    end;

    if ( ( oper != null ) and oper and ( oper <= maxOper ) ) 
      printOperName( oper );
    elif ( operBrigade )
      printBrigadeDesc;
    end;

    if ( not isCur )
      [ ];
      [----------------------+------------------------------+-------------------------+-------------------------+-------------------------+];
      [   Номер л\счета      |        Краткое содержание    |     Наличные деньги     |   Мемориальные обороты  | Ценности и расч. док-ты |];
      [    или док-та        |            операции          |  Приход    |   Расход   |  Зачислено |  Списано   |  Приход    |  Расход    |];
      [----------------------+------------------------------+------------+------------+------------+------------+------------+------------+];
      incLineCounter( 4 );
    else
      [ ];
      [------------+--------------------+-----------------------------------------------+---------------------------------------+---------+];
      [ № л\счетов |     Содержание     |                  В  рублях                    |           В иностранной валюте        | Ценности|];
      [      и     |      операции      |     Наличные деньги   |  Мемориальные обороты |  Наличные деньги  |Мемориальные оборот|    |    |];
      [ документов |                    |  Приход   |   Расход  |Зачисление |  Списание |  Приход | Расход  |Зачислено| Списано |Прих|Расх|];
      [------------+--------------------+-----------+-----------+-----------+-----------+---------+---------+---------+---------+----+----+];
      incLineCounter( 5 );
    end;
    headerPrinted = true;
  end;

  macro printSubTotalRaw( desc, 
                          credit, debet, memCredit, memDebet, 
                          creditR, debetR, memCreditR, memDebetR, 
                          valCredit, valDebet, valCreditCV, valDebetCV, 
                          dontPrintIfNull, checkPage );
    var
      a, i;

    if ( ( dontPrintIfNull != null ) and dontPrintIfNull )
      if ( ( credit == $0 ) and ( debet == $0 ) and ( memCredit == $0 ) and ( memDebet == $0 )
        and ( creditR == $0 ) and ( debetR == $0 ) and ( memCreditR == $0 ) and ( memDebetR == $0 )
        and ( valCredit == $0 ) and ( valDebet == $0 ) and ( valCreditCV == $0 ) and ( valDebetCV == $0 ) )
        return;
      end;
    end; 

    if ( not isCur )
      if ( ( checkPage == null ) or checkPage )
        checkNewPage( 2 );
      end;
      [----------------------+------------------------------+------------+------------+------------+------------+------------+------------+];
      [##################################################### ############ ############ ############ ############ ############ ############ ]
      ( desc:w, 
        credit:r, 
        debet:r, 
        memCredit:r, 
        memDebet:r, 
        ( valCredit + valCreditCV ):r, 
        ( valDebet + valDebetCV ):r );
      [----------------------+------------------------------+------------+------------+------------+------------+------------+------------+];
    else
      if ( ( checkPage == null ) or checkPage )
        checkNewPage( 1 + max( 2, getSublines( desc, 33, a ) ) );
      end;

      if ( a[0] == null )
        a[0] = "";
      end;
 
      [---------------------------------+-----------+-----------+-----------+-----------+---------+---------+---------+---------+----+----+];
      [################################# ########### ####################### ##################### ################### ###############      ]
      ( a[0], 
        creditR:r, 
        memCreditR:r, 
        credit:r, 
        memCredit:r, 
        ( valCredit + valCreditCV ):r );

      if ( a[1] == null )
        a[1] = "";
      end;

      [################################# ####################### ####################### ################### ################### #########]
      ( a[1], 
        debetR:r, 
        memDebetR:r, 
        debet:r, 
        memDebet:r, 
        ( valDebet + valDebetCV ):r );

      i = 2;
      while ( i < a.size ) 
        [#################################] ( a[i] );
        i = i + 1; 
      end; 
      [---------------------------------+-----------+-----------+-----------+-----------+---------+---------+---------+---------+----+----+];
    end;
    incLineCounter;
  end;

  macro printSubTotal( desc, dontPrintIfNull )

    var
      v = TRecHandler( "od_data.1" );

    if( not isOperReporter )
      return; /* не чепятаем под{ы|и}тоги */
    end;

    v.setRecordAddr( odData );
    printSubTotalRaw( desc, 
                      v.rec.Credit, v.rec.Debet, v.rec.MemCredit, v.rec.MemDebet, 
                      v.rec.CreditR, v.rec.DebetR, v.rec.MemCreditR, v.rec.MemDebetR, 
                      v.rec.ValCredit, v.rec.ValDebet, v.rec.ValCreditCV, v.rec.ValDebetCV, 
                      dontPrintIfNull );
  end;

  macro printPageTotals

    printSubTotalRaw( "Итого по странице " + pageCounter, 
                      pageTotals.credit, pageTotals.debet, pageTotals.memCredit, pageTotals.memDebet, 
                      pageTotals.creditR, pageTotals.debetR, pageTotals.memCreditR, pageTotals.memDebetR, 
                      pageTotals.valCredit, pageTotals.valDebet, pageTotals.valCreditCV, pageTotals.valDebetCV, 
                      true, false );
  end;

  macro printLineRaw( desc, 
                      credit, debet, memCredit, memDebet, 
                      creditR, debetR, memCreditR, memDebetR, 
                      valCredit, valDebet )

    var
      a, i, 
      nLines = 0, 
      printCred = false, printDeb = false;

    if ( not isCur )
      if ( checkNewPage( getSublines( desc, 53 ), false ) )
        printPageTotals;
        newPage;
        printHeader( true );
      end;
      [##################################################### ############ ############ ############ ############ ############ ############ ]
      ( desc:w, 
        credit:12:2:r:z, 
        debet:12:2:r:z,  
        memCredit:12:2:r:z, 
        memDebet:12:2:r:z, 
        valCredit:12:2:r:z, 
        valDebet:12:2:r:z );
    else
      if ( ( creditR != $0 ) or ( memCreditR != $0 ) 
        or ( credit != $0 ) or ( memCredit != $0 ) 
        or ( valCredit != $0 ) )
        nLines = nLines + 1;
        printCred = true; 
      end;

      if ( ( debetR != $0 ) or ( memDebetR != $0 ) 
        or ( debet != $0 ) or ( memDebet != $0 ) 
        or ( valDebet != $0 ) )
        nLines = nLines + 1;
        printDeb = true; 
      end;

      if ( checkNewPage( max( nLines, getSublines( desc, 33, a ) ) ) )
        printHeader( true );
      end;

      i = 0;
      while ( i < nLines )
        if ( a[i] == null )
          a[i] = "";
        end;
        i = i + 1;
      end;    

      i = 0;
      if ( printCred )
        [################################# ########### ####################### ##################### ################### ##############      ]
        ( a[i], 
          creditR:12:2:r:z, 
          memCreditR:12:2:r:z, 
          credit:12:2:r:z, 
          memCredit:12:2:r:z, 
          valCredit:12:2:r:z ); 
        i = i + 1;
      end;

      if ( printDeb )
        [################################# ####################### ####################### ################### ################### #########]
        ( a[i], 
          debetR:12:2:r:z, 
          memDebetR:12:2:r:z, 
          debet:12:2:r:z, 
          memDebet:12:2:r:z, 
          valDebet:12:2:r:z );
        i = i + 1;
      end;

      while ( i < a.size ) 
        [#################################] ( a[i] );
        i = i + 1; 
      end; 
    end;
    /* 09.01.2004 KIN пустая строка после обработки каждой операции */
       [ ];
    incLineCounter;
  end;

  macro printLine

    var
      v = TRecHandler( "od_data.1" );

    var
      delim, 
      desc;

    v.setRecordAddr( odData );

    if ( not headerPrinted )
      printHeader;
    end;

    desc = v.rec.Ground;
    if ( ( odData.rec.Time != time( 0, 0, 0 ) ) and ( odData.rec.Time != maxTime ) )
      desc = odData.rec.time + " " + desc;
    end;
    if ( v.rec.Account != "" )
      if ( odData.rec.CurrCode != NATIONAL_CURR )
        delim = " ";
      else
/*        delim = "\n";*/
        /*LAA убран перенос строки для печати документа между счетом и временем с основанием*/
        delim = " ";
      end;  
      desc = v.rec.Account + delim + desc;
    end;

    if ( oper )
      printLineRaw( desc, 
                    v.rec.Credit, v.rec.Debet, v.rec.MemCredit, v.rec.MemDebet, 
                    v.rec.CreditR, v.rec.DebetR, v.rec.MemCreditR, v.rec.MemDebetR, 
                    v.rec.ValCredit, v.rec.ValDebet );
  
      if ( v.rec.ValDebetCV != $0 )
        printLineRaw( "Испорчен бланк", 
                      $0, $0, $0, $0, 
                      $0, $0, $0, $0, 
                      $0, v.rec.ValDebetCV );
      end;
      if ( v.rec.ValCreditCV != $0 )
        printLineRaw( "Приход испорченного", 
                      $0, $0, $0, $0, 
                      $0, $0, $0, $0, 
                      v.rec.ValCreditCV, $0 );
      end;
    else
      printLineRaw( desc, 
                    v.rec.Credit, v.rec.Debet, v.rec.MemCredit, v.rec.MemDebet, 
                    v.rec.CreditR, v.rec.DebetR, v.rec.MemCreditR, v.rec.MemDebetR, 
                    v.rec.ValCredit + v.rec.ValCreditCV, v.rec.ValDebet + v.rec.ValDebetCV );
    end;

    /* RA 10-09-02 (SCR 9795)
    if ( currency.rec.Code_Currency == NATIONAL_CURR ) 
      if ( ( v.CreditRDiff != $0 ) or ( v.DebetRDiff != $0 )
        or ( v.MemCreditRDiff != $0 ) or ( v.MemDebetRDiff != $0 ) ) 
        printLineRaw( "Курсовая разница", 
                      v.CreditRDiff, v.DebetRDiff, v.MemCreditRDiff, v.MemDebetRDiff, 
                      $0, $0, $0, $0, $0, $0 );
      end; 
    end;
    */

    if ( not noPages )
      pageTotals.credit = pageTotals.credit + v.rec.Credit/* SCR9795 + v.CreditRDiff */;
      pageTotals.debet = pageTotals.debet + v.rec.Debet/* SCR9795 + v.DebetRDiff*/;
      pageTotals.memCredit = pageTotals.memCredit + v.rec.MemCredit/* SCR9795 + v.MemCreditRDiff*/;
      pageTotals.memDebet = pageTotals.memDebet + v.rec.MemDebet/* SCR9795 + v.MemDebetRDiff*/;
      pageTotals.creditR = pageTotals.creditR + v.rec.CreditR;
      pageTotals.debetR = pageTotals.debetR + v.rec.DebetR;
      pageTotals.memCreditR = pageTotals.memCreditR + v.rec.MemCreditR;
      pageTotals.memDebetR = pageTotals.memDebetR + v.rec.MemDebetR;
      pageTotals.valCredit = pageTotals.valCredit + v.rec.ValCredit;
      pageTotals.valDebet = pageTotals.valDebet + v.rec.ValDebet;
      pageTotals.valCreditCV = pageTotals.valCreditCV + v.rec.ValCreditCV;
      pageTotals.valDebetCV = pageTotals.valDebetCV + v.rec.ValDebetCV;
    end;

    opsForCurrReported = true;
  end;

  macro print

    newPage;
  end;

  macro printOpsOfSubType( subType )

    var
      recFound;

    odData.keyNum = 0;
    odData.clear;
    odData.rec.Date = {curdate};
    odData.rec.Brigade = operBrigade;
    odData.rec.Mode = mode;
    odData.rec.Oper = oper;
    odData.rec.Type = ODT_OPERATION;
    odData.rec.CurrCode = currency.rec.Code_Currency;
    odData.rec.SubType = subType;

    odData.addFilter( "t.t_Date = " + sqlDateToStr( {curdate} ) +
                      " and t.t_Brigade = " + string( operBrigade ) +
                      " and t.t_Mode = " + string( mode ) +
                      " and t.t_Oper = " + string( oper ) +
                      " and t.t_Type = " + string( ODT_OPERATION ) +
                      " and t.t_CurrCode = " + string( currency.rec.Code_Currency ) +
                      " and t.t_SubType = " + string( subType ) );

    recFound = odData.getGE;
    while ( recFound  
      and ( odData.rec.Date == {curdate} )
      and ( odData.rec.Brigade == operBrigade )
      and ( odData.rec.Mode == mode )
      and ( odData.rec.Oper == oper )
      and ( odData.rec.Type == ODT_OPERATION )
      and ( odData.rec.CurrCode == currency.rec.Code_Currency )
      and ( odData.rec.SubType == subType ) )
      printLine;
      recFound = odData.next;
    end;

    odData.dropFilter;
  end;

  macro printOpsOfSubTypes( minSubType, maxSubType )

    var
      recFound;

    odData.keyNum = 0;
    odData.clear;
    odData.rec.Date = {curdate};
    odData.rec.Brigade = operBrigade;
    odData.rec.Mode = mode;
    odData.rec.Oper = oper;
    odData.rec.Type = ODT_OPERATION;
    odData.rec.CurrCode = currency.rec.Code_Currency;
    odData.rec.SubType = minSubType;

    odData.addFilter( "t.t_Date = " + sqlDateToStr( {curdate} ) +
                      " and t.t_Brigade = " + string( operBrigade ) +
                      " and t.t_Mode = " + string( mode ) +
                      " and t.t_Oper = " + string( oper ) +
                      " and t.t_Type = " + string( ODT_OPERATION ) +
                      " and t.t_CurrCode = " + string( currency.rec.Code_Currency ) +
                      " and t.t_SubType between " + string( minSubType ) + " and " + string( maxSubType ) );

    recFound = odData.getGE;
    while ( recFound  
      and ( odData.rec.Date == {curdate} )
      and ( odData.rec.Brigade == operBrigade )
      and ( odData.rec.Mode == mode )
      and ( odData.rec.Oper == oper )
      and ( odData.rec.Type == ODT_OPERATION )
      and ( odData.rec.CurrCode == currency.rec.Code_Currency )
      and ( odData.rec.SubType <= maxSubType ) )
      printLine;
      recFound = odData.next;
    end;
    odData.dropFilter;
  end;

  InitTReporter( _oper );
end;

class ( TSec_Operations ) TSec_DepOps( _oper )

  macro printHeader( isTail )

    if( isHeaderPrinted ) headerPrinted = true; return; end;

    printCommonHeader( oper );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                         Операционный дневник № ### за #            ]
        ( diaryNumber, {curdate}:m );
        [                                                           Вклады                   ];
        [ ];
        incLineCounter( 3 );
      else
        [             Операционный  дневник         ];
        [           по валютным операциям № ### за #          ]
        ( diaryNumber, {curdate}:m );
        [                 Вклады              ];
        [ ];
        incLineCounter( 4 );
      end; 
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro print( _isHeaderPrinted )

    isHeaderPrinted = _isHeaderPrinted;

    if( not isHeaderPrinted ) print; end;

    printOpsOfSubType( ODSTO_DEP_OP );

    if ( headerPrinted )
      getDataRec( ODT_OPERATION, ODSTO_DEP_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по вкладам:" );
      _isHeaderPrinted = true;
    end;

    return _isHeaderPrinted;

  end; 
  
  InitTSec_Operations( _oper );
end;

class ( TSec_Operations ) TSec_OtherOps( _oper )

  macro printHeader( isTail )

    if( isHeaderPrinted ) headerPrinted = true; return; end;

    printCommonHeader( oper );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                         Операционный дневник № ### за #            ]
        ( diaryNumber, {curdate}:m );
        [                                                       Прочие операции              ];
        [ ];
        incLineCounter( 3 );
      else
        [             Операционный  дневник         ];
        [           по валютным операциям № ### за #          ]
        ( diaryNumber, {curdate}:m );
        [                   Прочие операции                                   ];
        [ ];
        incLineCounter( 4 );
      end; 
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro printCISubTotals

    var recFound;
    
    odData.keyNum = 0;

    odData.clear;
    odData.rec.Date = {curdate};
    odData.rec.Brigade = operBrigade;
    odData.rec.Mode = mode;
    odData.rec.Oper = oper;
    odData.rec.Type = ODT_OPERATION;
    odData.rec.CurrCode = currency.rec.Code_Currency;
    odData.rec.SubType = ODSTO_CI_TOT_BASE + 1;

    odData.addFilter( "t.t_Date = " + sqlDateToStr( {curdate} ) +
                      " and t.t_Brigade = " + string( operBrigade ) +
                      " and t.t_Mode = " + string( mode ) +
                      " and t.t_Oper = " + string( oper ) +
                      " and t.t_Type = " + string( ODT_OPERATION ) +
                      " and t.t_CurrCode = " + string( currency.rec.Code_Currency ) +
                      " and t.t_SubType between " + string( ODSTO_CI_TOT_BASE + 1 ) + " and " + string( ODSTO_CI_TOT_BASE + 80 ) );

    recFound = odData.getGE;
    while ( recFound  
      and ( odData.rec.Date == {curdate} )
      and ( odData.rec.Brigade == operBrigade )
      and ( odData.rec.Mode == mode )
      and ( odData.rec.Oper == oper )
      and ( odData.rec.Type == ODT_OPERATION )
      and ( odData.rec.CurrCode == currency.rec.Code_Currency )
      and ( odData.rec.SubType < ODSTO_CI_TOT_BASE + 80 ) )
      findCapIssueType( odData.rec.SubType - ODSTO_CI_TOT_BASE ); 
      printSubTotal( "Итого - " + ci.rec.Name + ":" );
      recFound = odData.next;
    end;

    odData.dropFilter;
  end;

  macro print( _isHeaderPrinted )

    var
      recFound;

    isHeaderPrinted = _isHeaderPrinted;

    if( not isHeaderPrinted ) print; end;

    printOpsOfSubType( ODSTO_OTHER_OP );

    if ( headerPrinted )
      /* Подитоги по ценным бумагам */
      if ( not isCur )
        printCISubTotals;
      end;
      getDataRec( ODT_OPERATION, ODSTO_OTHEROTHER_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по прочим кассовым операциям:", true );
      getDataRec( ODT_OPERATION, ODSTO_OTHER_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по прочим операциям:" );
      _isHeaderPrinted = true;
    end;

    return _isHeaderPrinted;

  end; 
  
  InitTSec_Operations( _oper );
end;

class ( TSec_Operations ) TSec_ExchOps( _oper )

  macro printHeader( isTail )

    if( isHeaderPrinted ) headerPrinted = true; return; end;

    printCommonHeader( oper );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                         Операционный дневник № ### за #            ]
        ( diaryNumber, {curdate}:m );
        [                                                    Валютообменные операции         ];
        [ ];
        incLineCounter( 3 );
      else
        [             Операционный  дневник         ];
        [           по валютным операциям № ### за #          ]
        ( diaryNumber, {curdate}:m );
        [                Валютообменные операции                  ];
        [ ];
        incLineCounter( 4 );
      end; 
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro print( _isHeaderPrinted )

    isHeaderPrinted = _isHeaderPrinted;
    
    if( not isHeaderPrinted ) print; end;

    printOpsOfSubType( ODSTO_EXCHANGE_OP );

    if ( headerPrinted )
      getDataRec( ODT_OPERATION, ODSTO_EXCHANGE_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по в/о операциям:" );
      _isHeaderPrinted = true;
    end;

    return _isHeaderPrinted;

  end; 
  
  InitTSec_Operations( _oper );
end;

class ( TSec_Operations ) TSec_ConvOps( _oper )

  macro printHeader( isTail )

    if( isHeaderPrinted ) headerPrinted = true; return; end;
    
    printCommonHeader( oper );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                         Операционный дневник № ### за #            ]
        ( diaryNumber, {curdate}:m );
        [                                                    Операции конвертации            ];
        [ ];
        incLineCounter( 3 );
      else
        [             Операционный  дневник         ];
        [           по валютным операциям № ### за #          ]
        ( diaryNumber, {curdate}:m );
        [                Операции конвертации           ];
        [ ];
        incLineCounter( 4 );
      end;
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro print( _isHeaderPrinted )

    var
      recFound;

    if ( isCur )
      return;
    end;

    isHeaderPrinted = _isHeaderPrinted;
    
    if( not isHeaderPrinted ) print; end;

    printOpsOfSubType( ODSTO_CONV_OP );

    if ( headerPrinted )
      getDataRec( ODT_OPERATION, ODSTO_CONV_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по операциям конвертации:" );
      _isHeaderPrinted = true;
    end;

    return _isHeaderPrinted;

  end; 
  
  InitTSec_Operations( _oper );
end;

class ( TSec_Operations ) TSec_FBDepOps( _oper )

  macro printHeader( isTail )

    if( isHeaderPrinted ) headerPrinted = true; return; end;
    
    printCommonHeader( oper );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                         Операционный дневник № ### за #            ]
        ( diaryNumber, {curdate}:m );
        [                                   Вклады. Выполнение операций за другие филиалы    ];
        [ ];
        incLineCounter( 3 );
      else
        [             Операционный  дневник         ];
        [           по валютным операциям № ### за #          ]
        ( diaryNumber, {curdate}:m );
        [           Вклады. Выполнение операций за другие филиалы    ];
        [ ];
        incLineCounter( 4 );
      end; 
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro print( _isHeaderPrinted )

    isHeaderPrinted = _isHeaderPrinted;
    
    if( not isHeaderPrinted ) print; end;

    printOpsOfSubType( ODSTO_FBDEP_OP );

    if ( headerPrinted )
      getDataRec( ODT_OPERATION, ODSTO_FBDEP_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого по др. филиалам:" );
      printOpsOfSubTypes( ODSTO_FBDEP_BR_TOT_BASE, ODSTO_FBDEP_BR_TOT_BASE + 999 );
      _isHeaderPrinted = true;
    end;

    return _isHeaderPrinted;

  end; 
  
  InitTSec_Operations( _oper );
end;

class ( TSec_Operations ) TSec_FBIDepOps

  macro printHeader( isTail )

    var
      branchName;

    newPage;
  
    getBranchParams( branch, branchName );
  
    if ( not isCur )
      [Филиал № #                                                                                                            ф.№ 24]
      ( branchName ); 
    else
      [Филиал № #                                                                                                             ф.№ 24-в]
      ( branchName ); 
    end;
    [ ];
  
    incLineCounter( 2 );

    if( isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      if ( not isCur )
        [                                   Вклады. Выполнение операций другими филиалами    ];
        [                                             за #                                   ]
        ( {curdate}:m );
        [ ];
        incLineCounter( 3 );
      else
        [                               Вклады. Выполнение валютных операций другими филиалами    ];
        [                                             за #                                        ]
        ( {curdate}:m );
        [ ];
        incLineCounter( 3 );
      end; 
    end;
    if( isCur )         /* SCR 10128 */
      printCurrencyInfo();
    end;
    printHeader( isTail );
  end;

  macro print

    printOpsOfSubType( ODSTO_FBID_OP );

    if ( headerPrinted )
      getDataRec( ODT_OPERATION, ODSTO_FBID_TOT, currency.rec.Code_Currency, oper );
      printSubTotal( "Итого:" );
      printOpsOfSubTypes( ODSTO_FBID_BR_TOT_BASE, ODSTO_FBID_BR_TOT_BASE + 999 );
    end;
  end; 
  
  InitTSec_Operations( noOper2 );
end;

class ( TReporter ) TSec_MoneyTotals( _oper, _showRests )

  var
    showRests = _showRests;

  macro print

    var
      v = TRecHandler( "od_data.2" );

    var
      balance = $0, balanceR = $0, 
      prevRest = $0, rest = $0, prevCoinRest = $0, coinRest = $0, credit = $0, debet = $0, memCredit = $0, memDebet = $0, 
      depDebet = $0, depCredit = $0, depMemDebet = $0, depMemCredit = $0, 
      otherDebet = $0, otherCredit = $0, otherMemDebet = $0, otherMemCredit = $0, 
      exDebet = $0, exCredit = $0, exMemDebet = $0, exMemCredit = $0, 
      convDebet = $0, convCredit = $0, convMemDebet = $0, convMemCredit = $0, 
      fbDepDebet = $0, fbDepCredit = $0, fbDepMemDebet = $0, fbDepMemCredit = $0, 
      prevRestR = $0, restR = $0, creditR = $0, debetR = $0, memCreditR = $0, memDebetR = $0, 
      depDebetR = $0, depCreditR = $0, depMemDebetR = $0, depMemCreditR = $0, 
      otherDebetR = $0, otherCreditR = $0, otherMemDebetR = $0, otherMemCreditR = $0, 
      exDebetR = $0, exCreditR = $0, exMemDebetR = $0, exMemCreditR = $0, 
      convDebetR = $0, convCreditR = $0, convMemDebetR = $0, convMemCreditR = $0, 
      fbDepDebetR = $0, fbDepCreditR = $0, fbDepMemDebetR = $0, fbDepMemCreditR = $0, 
      prevRestU = $0, restU = $0, creditU = $0, debetU = $0, 
      depCreditU = $0, depDebetU = $0, 
      otherCreditU = $0, otherDebetU = $0,  
      exCreditU = $0, exDebetU = $0,  
      convCreditU = $0, convDebetU = $0,  
      fbDepCreditU = $0, fbDepDebetU = $0,  
      prevRestUR = $0, restUR = $0, creditUR = $0, debetUR = $0, 
      depCreditUR = $0, depDebetUR = $0, 
      otherCreditUR = $0, otherDebetUR = $0,  
      exCreditUR = $0, exDebetUR = $0,  
      convCreditUR = $0, convDebetUR = $0, 
      fbDepCreditUR = $0, fbDepDebetUR = $0;

    v.setRecordAddr( odData );

    if ( getDataRec( ODT_TOTAL, ODSTT_PREV_REST, currency.rec.Code_Currency, oper ) )
      prevRest = v.rec.Credit; 
      prevRestR = v.rec.CreditR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_PREV_REST, currency.rec.Code_Currency, oper ) )
      prevRestU = v.rec.Credit; 
      prevRestUR = v.rec.CreditR; 
    end;

    if ( not isCur )
      if ( getDataRec( ODT_TOTAL, ODSTT_PREV_COIN_REST, currency.rec.Code_Currency, oper ) )
        prevCoinRest = v.rec.Credit; 
      end;
      if ( getDataRec( ODT_TOTAL, ODSTT_COIN_REST, currency.rec.Code_Currency, oper ) )
        coinRest = v.rec.Credit; 
      end;
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_REST, currency.rec.Code_Currency, oper ) )
      rest = v.rec.Credit; 
      restR = v.rec.CreditR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_REST, currency.rec.Code_Currency, oper ) )
      restU = v.rec.Credit; 
      restUR = v.rec.CreditR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_TOTAL, currency.rec.Code_Currency, oper ) )
      credit = v.rec.Credit; 
      creditR = v.rec.CreditR; 
      debet = v.rec.Debet; 
      debetR = v.rec.DebetR; 
      memCredit = v.rec.MemCredit; 
      memCreditR = v.rec.MemCreditR; 
      memDebet = v.rec.MemDebet; 
      memDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_TOTAL, currency.rec.Code_Currency, oper ) )
      creditU = v.rec.Credit; 
      creditUR = v.rec.CreditR; 
      debetU = v.rec.Debet; 
      debetUR = v.rec.DebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_DEP, currency.rec.Code_Currency, oper ) )
      depCredit = v.rec.Credit; 
      depCreditR = v.rec.CreditR; 
      depDebet = v.rec.Debet; 
      depDebetR = v.rec.DebetR; 
      depMemCredit = v.rec.MemCredit; 
      depMemCreditR = v.rec.MemCreditR; 
      depMemDebet = v.rec.MemDebet; 
      depMemDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_DEP, currency.rec.Code_Currency, oper ) )
      depCreditU = v.rec.Credit; 
      depCreditUR = v.rec.CreditR; 
      depDebetU = v.rec.Debet; 
      depDebetUR = v.rec.DebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_OTHER, currency.rec.Code_Currency, oper ) )
      otherCredit = v.rec.Credit; 
      otherCreditR = v.rec.CreditR; 
      otherDebet = v.rec.Debet; 
      otherDebetR = v.rec.DebetR; 
      otherMemCredit = v.rec.MemCredit; 
      otherMemCreditR = v.rec.MemCreditR; 
      otherMemDebet = v.rec.MemDebet; 
      otherMemDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_OTHER, currency.rec.Code_Currency, oper ) )
      otherCreditU = v.rec.Credit; 
      otherCreditUR = v.rec.CreditR; 
      otherDebetU = v.rec.Debet; 
      otherDebetUR = v.rec.DebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_EXCHANGE, currency.rec.Code_Currency, oper ) )
      exCredit = v.rec.Credit; 
      exCreditR = v.rec.CreditR; 
      exDebet = v.rec.Debet; 
      exDebetR = v.rec.DebetR; 
      exMemCredit = v.rec.MemCredit; 
      exMemCreditR = v.rec.MemCreditR; 
      exMemDebet = v.rec.MemDebet; 
      exMemDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_EXCHANGE, currency.rec.Code_Currency, oper ) )
      exCreditU = v.rec.Credit; 
      exCreditUR = v.rec.CreditR; 
      exDebetU = v.rec.Debet; 
      exDebetUR = v.rec.DebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_CONV, currency.rec.Code_Currency, oper ) )
      convCredit = v.rec.Credit; 
      convCreditR = v.rec.CreditR; 
      convDebet = v.rec.Debet; 
      convDebetR = v.rec.DebetR; 
      convMemCredit = v.rec.MemCredit; 
      convMemCreditR = v.rec.MemCreditR; 
      convMemDebet = v.rec.MemDebet; 
      convMemDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_CONV, currency.rec.Code_Currency, oper ) )
      convCreditU = v.rec.Credit; 
      convCreditUR = v.rec.CreditR; 
      convDebetU = v.rec.Debet; 
      convDebetUR = v.rec.DebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_TURNS_FBDEP, currency.rec.Code_Currency, oper ) )
      fbDepCredit = v.rec.Credit; 
      fbDepCreditR = v.rec.CreditR; 
      fbDepDebet = v.rec.Debet; 
      fbDepDebetR = v.rec.DebetR; 
      fbDepMemCredit = v.rec.MemCredit; 
      fbDepMemCreditR = v.rec.MemCreditR; 
      fbDepMemDebet = v.rec.MemDebet; 
      fbDepMemDebetR = v.rec.MemDebetR; 
    end;

    if ( getDataRec( ODT_TOTAL, ODSTT_UNPAY_OFFS + ODSTT_TURNS_FBDEP, currency.rec.Code_Currency, oper ) )
      fbDepCreditU = v.rec.Credit; 
      fbDepCreditUR = v.rec.CreditR; 
      fbDepDebetU = v.rec.Debet; 
      fbDepDebetUR = v.rec.DebetR; 
    end;

    if ( not showRests )
      prevRest = rest = prevRestR = restR = prevRestU = restU = prevRestUR = restUR = prevCoinRest = coinRest
        = "--"; 
    else
      balance = rest - ( prevRest + credit - debet );
      balanceR = restR - ( prevRestR + creditR - debetR );
    end;

    if ( not opsForCurrReported )
      if ( ( prevRest == $0 ) and ( rest == $0 ) 
        and ( prevCoinRest == $0 ) and ( coinRest == $0 )
        and ( credit == $0 ) and ( debet == $0 )
        and ( memCredit == $0 ) and ( memDebet == $0 )
        and ( depDebet == $0 ) and ( depCredit == $0 )
        and ( depMemDebet == $0 ) and ( depMemCredit == $0 ) 
        and ( otherDebet == $0 ) and ( otherCredit == $0 )
        and ( otherMemDebet == $0 ) and ( otherMemCredit == $0 ) 
        and ( exDebet == $0 ) and ( exCredit == $0 )
        and ( exMemDebet == $0 ) and ( exMemCredit == $0 ) 
        and ( convDebet == $0 ) and ( convCredit == $0 )
        and ( convMemDebet == $0 ) and ( convMemCredit == $0 ) 
        and ( fbDepDebet == $0 ) and ( fbDepCredit == $0 )
        and ( fbDepMemDebet == $0 ) and ( fbDepMemCredit == $0 ) 
        and ( prevRestR == $0 ) and ( restR == $0 ) 
        and ( creditR == $0 ) and ( debetR == $0 )
        and ( memCreditR == $0 ) and ( memDebetR == $0 ) 
        and ( depDebetR == $0 ) and ( depCreditR == $0 )
        and ( depMemDebetR == $0 ) and ( depMemCreditR == $0 )
        and ( otherDebetR == $0 ) and ( otherCreditR == $0 )
        and ( otherMemDebetR == $0 ) and ( otherMemCreditR == $0 ) 
        and ( exDebetR == $0 ) and ( exCreditR == $0 )
        and ( exMemDebetR == $0 ) and ( exMemCreditR == $0 )
        and ( convDebetR == $0 ) and ( convCreditR == $0 )
        and ( convMemDebetR == $0 ) and ( convMemCreditR == $0 ) 
        and ( fbDepDebetR == $0 ) and ( fbDepCreditR == $0 )
        and ( fbDepMemDebetR == $0 ) and ( fbDepMemCreditR == $0 ) 
        and ( prevRestU == $0 ) and ( restU == $0 )
        and ( creditU == $0 ) and ( debetU == $0 ) 
        and ( depCreditU == $0 ) and ( depDebetU == $0 )
        and ( otherCreditU == $0 ) and ( otherDebetU == $0 )
        and ( exCreditU == $0 ) and ( exDebetU == $0 )  
        and ( convCreditU == $0 ) and ( convDebetU == $0 )  
        and ( fbDepCreditU == $0 ) and ( fbDepDebetU == $0 )  
        and ( prevRestUR == $0 ) and ( restUR == $0 )
        and ( creditUR == $0 ) and ( debetUR == $0 )
        and ( depCreditUR == $0 ) and ( depDebetUR == $0 ) 
        and ( otherCreditUR == $0 ) and ( otherDebetUR == $0 )
        and ( exCreditUR == $0 ) and ( exDebetUR == $0 )  
        and ( convCreditUR == $0 ) and ( convDebetUR == $0 )
        and ( fbDepCreditUR == $0 ) and ( fbDepDebetUR == $0 ) )
        return;
      end;
    end; 

    newPage;
    
    printCommonHeader( oper );

    if ( isCur )
      [                                  Итоги валютного операционного дневника № #    за #                                                ]
      ( diaryNumber, {curdate} );
      [                                                                                                                                   #]
      ( currency.rec.Name_Currency : r );
      [---------------------------+-------------------------+---------------------+---------------------+-------------------+-------------+];
      [                           |    Наличные в рублях    |Безналичные в рублях |       Наличные      |    Безналичные    |    Ценности |];
      [                           |  Приход    |   Расход   |Зачислено | Списано  |  Приход  |  Расход  |Зачислен.|Списаниe |Приход|Расход|];
      [---------------------------+------------+------------+----------+----------+----------+----------+---------+---------+------+------+];
      [Остаток на нач дня (платежные)############                                  ##########                                             ]
      ( prevRestR:r, prevRest:r );
      [Итого по операциям за день                                                                                                       ];
      [         - Вклады           ############ ############ ########## ########## ########## ########## ######### #########                ]
      ( depCreditR:12:2:r:z, depDebetR:12:2:r:z, depMemCreditR:12:2:r:z, depMemDebetR:12:2:r:z, depCredit:12:2:r:z, depDebet:12:2:r:z, depMemCredit:12:2:r:z, depMemDebet:12:2:r:z );
      [         - Прочие операции  ############ ############ ########## ########## ########## ########## ######### #########                ]
      ( otherCreditR:12:2:r:z, otherDebetR:12:2:r:z, otherMemCreditR:12:2:r:z, otherMemDebetR:12:2:r:z, otherCredit:12:2:r:z, otherDebet:12:2:r:z, otherMemCredit:12:2:r:z, otherMemDebet:12:2:r:z );
      if( not isOperReporter ) /* RA 10-09-02 (SCR 9795) */
      /* KIN 13.05.2004 - устранена ситуация непопадания рублевого эквивалента
                          продажи дорожных чеков за рубли    */
         if(exCreditR != cur2rub(exCredit))
           exCreditR = cur2rub(exCredit);
           CreditR = cur2rub(Credit);
           balanceR  = $0;
         end;
       /* END correct  */

        [         - Обмен валюты     ############ ############ ########## ########## ########## ########## ######### #########                ]
        ( exCreditR:12:2:r:z, exDebetR:12:2:r:z, exMemCreditR:12:2:r:z, exMemDebetR:12:2:r:z, exCredit:12:2:r:z, exDebet:12:2:r:z, exMemCredit:12:2:r:z, exMemDebet:12:2:r:z );
      end;
//      [         - Конвертация      ############ ############ ########## ########## ######### ######### ######## ########                ]
//      ( convCreditR:12:2:r:z, convDebetR:12:2:r:z, convMemCreditR:12:2:r:z, convMemDebetR:12:2:r:z, convCredit:12:2:r:z, convDebet:12:2:r:z, convMemCredit:12:2:r:z, convMemDebet:12:2:r:z );
      [         - За др. филиалы   ############ ############ ########## ########## ########## ########## ######### #########                ]
      ( fbDepCreditR:12:2:r:z, fbDepDebetR:12:2:r:z, fbDepMemCreditR:12:2:r:z, fbDepMemDebetR:12:2:r:z, fbDepCredit:12:2:r:z, fbDepDebet:12:2:r:z, fbDepMemCredit:12:2:r:z, fbDepMemDebet:12:2:r:z );
      [         - Всего            ############ ############ ########## ########## ########## ########## ######### #########                ]
      ( creditR:12:2:r:z, debetR:12:2:r:z, memCreditR:12:2:r:z, memDebetR:12:2:r:z, credit:12:2:r:z, debet:12:2:r:z, memCredit:12:2:r:z, memDebet:12:2:r:z );
      [Остаток на конец дня (платежные)         ############                                  ##########                                    ]
      ( restR:r, rest:r );                                                                            
      if ( ( oper == null ) or ( oper == 0 ) )
        if ( group.rec.Mode != GRM_IMMEDIATE )
          [Баланс                            ############                              ##########                                               ]
          ( balanceR:r, balance:r );
          if ( balance )
            [ВНИМАНИЕ!!!! ОСТАТОК НА КОНЕЦ ДНЯ НЕ СОВПАДАЕТ С ОСТАТКОМ КАССЫ];
          end;
        end;
      end;                         
      [---------------------------+------------+------------+----------+----------+----------+----------+---------+---------+------+------+];
      [Остаток на нач дня (неплатежные) ##########                                 ##########                                              ]
      ( prevRestUR:r, prevRestU:r );
      [Итого по операциям за день                                                                                                          ];
      [         - Вклады           ############ ############                       ########## ##########                                   ]
      ( depCreditUR:12:2:r:z, depDebetUR:12:2:r:z, depCreditU:12:2:r:z, depDebetU:12:2:r:z );
      [         - Прочие операции  ############ ############                       ########## ##########                                   ]
      ( otherCreditUR:12:2:r:z, otherDebetUR:12:2:r:z, otherCreditU:12:2:r:z, otherDebetU:12:2:r:z );
      if( not isOperReporter ) /* RA 10-09-02 (SCR 9795) */
        [         - Обмен валюты     ############ ############                       ########## ##########                                   ]
        ( exCreditUR:12:2:r:z, exDebetUR:12:2:r:z, exCreditU:12:2:r:z, exDebetU:12:2:r:z );
      end;
      [         - Конвертация      ############ ############                       ########## ##########                                   ]
      ( convCreditUR:12:2:r:z, convDebetUR:12:2:r:z, convCreditU:12:2:r:z, convDebetU:12:2:r:z );
      [         - За др. филиалы   ############ ############                       ########## ##########                                   ]
      ( fbDepCreditUR:12:2:r:z, fbDepDebetUR:12:2:r:z, fbDepCreditU:12:2:r:z, fbDepDebetU:12:2:r:z );
      [         - Всего            ############ ############                       ########## ##########                                   ]
      ( creditUR:12:2:r:z, debetUR:12:2:r:z, creditU:12:2:r:z, debetU:12:2:r:z );
      [Остаток на конец дня (неплатежные)       ############                                  ##########                                   ]
      ( restUR:r, restU:r );
      [---------------------------+------------+------------+----------+----------+----------+----------+---------+---------+------+------+];
    else
      [                 Итоги операционного дневника № #   за #                                                      ]
      ( diaryNumber, {curdate} );
      [                                                                                                                             #]
      ( currency.rec.Name_Currency : r );
      [--------------------------------------------------------+--------------------------+-------------------------+---------------------+];
      [                                                        |         Наличные         |      Безналичные        |      Ценности       |];
      [                                                        |   Приход    |   Расход   | Зачислено  |  Списано   |  Приход  |   Расход |];
      [--------------------------------------------------------+-------------+------------+------------+------------+----------+----------+];

      [Остаток на начало дня (платежные)                        ############                                                               ]
      ( prevRest:r );
      [В том числе монеты                                       ############                                                               ]
      ( prevCoinRest:r );
      [Итого по операциям за день - Вклады                      ############ ############ ############ ############                        ]
      ( depCredit:12:2:r:z, depDebet:12:2:r:z, depMemCredit:12:2:r:z, depMemDebet:12:2:r:z );
      [Итого по операциям за день - Прочие операции             ############ ############ ############ ############                        ]
      ( otherCredit:12:2:r:z, otherDebet:12:2:r:z, otherMemCredit:12:2:r:z, otherMemDebet:12:2:r:z );
      if( not isOperReporter ) /* RA 10-09-02 (SCR 9795) */
        [Итого по операциям за день - Обмен валюты                ############ ############ ############ ############                        ]
        ( exCredit:12:2:r:z, exDebet:12:2:r:z, exMemCredit:12:2:r:z, exMemDebet:12:2:r:z );
      end;
      [Итого по операциям за день - Операции конвертации        ############ ############ ############ ############                        ]
      ( convCredit:12:2:r:z, convDebet:12:2:r:z, convMemCredit:12:2:r:z, convMemDebet:12:2:r:z );
      [Итого по операциям за день - За др. филиалы              ############ ############ ############ ############                        ]
      ( fbDepCredit:12:2:r:z, fbDepDebet:12:2:r:z, fbDepMemCredit:12:2:r:z, fbDepMemDebet:12:2:r:z );
      [Итого по операциям за день - Всего                       ############ ############ ############ ############                        ]
      ( credit:12:2:r:z, debet:12:2:r:z, memCredit:12:2:r:z, memDebet:12:2:r:z );
      [Остаток на конец дня (платежные)                                      ############                                                  ]
      ( rest:r );
      [В том числе монеты                                                    ############                                                  ]
      ( coinRest:r );
      if ( ( oper == null ) or ( oper == 0 ) )
        if ( group.rec.Mode != GRM_IMMEDIATE )
          [Баланс                                                   ############                                                               ]
          ( balance:r );
          if ( balance )
            [ВНИМАНИЕ!!!! ОСТАТОК НА КОНЕЦ ДНЯ НЕ СОВПАДАЕТ С ОСТАТКОМ КАССЫ];
          end;
        end; 
      end;
      [--------------------------------------------------------+-------------+------------+------------+------------+----------+----------+];
      [Остаток на начало дня (неплатежные)                      ############                                                               ]
      ( prevRestU:r );
      [Итого по операциям за день - Вклады                      ############ ############                                                  ]
      ( depCreditU:12:2:r:z, depDebetU:12:2:r:z );
      [Итого по операциям за день - Прочие операции             ############ ############                                                  ]
      ( otherCreditU:12:2:r:z, otherDebetU:12:2:r:z );
      if( not isOperReporter ) /* RA 10-09-02 (SCR 9795) */
        [Итого по операциям за день - Обмен валюты                ############ ############                                                  ]
        ( exCreditU:12:2:r:z, exDebetU:12:2:r:z );
      end;
      [Итого по операциям за день - Операции конвертации        ############ ############                                                  ]
      ( convCreditU:12:2:r:z, convDebetU:12:2:r:z );
      [Итого по операциям за день - За др. филиалы              ############ ############                                                  ]
      ( fbDepCreditU:12:2:r:z, fbDepDebetU:12:2:r:z );
      [Итого по операциям за день - Всего                       ############ ############                                                  ]
      ( creditU:12:2:r:z, debetU:12:2:r:z );
      [Остаток на конец дня (неплатежные)                                    ############                                                  ]
      ( restU:r );
      [--------------------------------------------------------+-------------+------------+------------+------------+----------+----------+];
    end;
    printCommonFooter;
  end;

  initTReporter( _oper );
  if ( showRests == null )
    if ( oper == 0 )
      showRests = true;
    else
      showRests = false;
    end;
  end;
end;

class ( TReporter ) TSec_ValTotals( _oper, _showRests )

  var
    showRests = _showRests;

  macro print

    var
      v = TRecHandler( "od_data.3" );

    var
      prevRest = $0, rest = $0, 
      depDebet = $0, depCredit = $0, 
      otherDebet = $0, otherCredit = $0, 
      exDebet = $0, exCredit = $0, 
      convDebet = $0, convCredit = $0, 
      fbDepDebet = $0, fbDepCredit = $0, 
      debet = $0, credit = $0;


    v.setRecordAddr( odData );

    if ( not showRests )
      prevRest = "--";
    else
      if ( getDataRec( ODT_VAL_TOTAL, ODSTT_PREV_REST ) )
        prevRest = v.rec.Credit; 
      end;
    end;

    if ( not showRests  )
      rest = "--";
    else
      if ( getDataRec( ODT_VAL_TOTAL, ODSTT_REST ) )
        rest = v.rec.Credit; 
      end;
    end;
    
    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_DEP, 0, oper ) )
      depCredit = v.rec.Credit; 
      depDebet  = v.rec.Debet; 
    end;

    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_OTHER, 0, oper ) )
      otherCredit = v.rec.Credit; 
      otherDebet  = v.rec.Debet; 
    end;

    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_EXCHANGE, 0, oper ) )
      exCredit = v.rec.Credit; 
      exDebet  = v.rec.Debet; 
    end;

    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_CONV, 0, oper ) )
      convCredit = v.rec.Credit; 
      convDebet  = v.rec.Debet; 
    end;

    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_FBDEP, 0, oper ) )
      fbDepCredit = v.rec.Credit; 
      fbDepDebet  = v.rec.Debet; 
    end;

    if ( getDataRec( ODT_VAL_TOTAL, ODSTT_TURNS_TOTAL, 0, oper ) )
      credit = v.rec.Credit; 
      debet  = v.rec.Debet; 
    end;

    newPage;

    printCommonHeader( oper );

    printLn( "          Итоги операционного дневника № ", diaryNumber );
    printLn( "             за ", {curdate}, " по ценностям" );  
                                                             
    [ ];
    [---------------------------+-------------------------+];
    [                           |         Ценности        |];
    [                           |   Приход   |   Расход   |];
    [---------------------------+------------+------------+];
  
    [Остаток на начало дня       ############
    (ценности)]
    ( prevRest:r ) ;
    [Итого по операциям за день];
    [         - Вклады           ############ ############ ]
    ( depCredit:12:2:z:r, depDebet:12:2:z:r);
    [         - Прочие операции  ############ ############ ]
    ( otherCredit:12:2:z:r, otherDebet:12:2:z:r );
    if( not isOperReporter ) /* RA 10-09-02 (SCR 9795) */
    [         - Обмен валюты     ############ ############ ]
    ( exCredit:12:2:z:r, exDebet:12:2:z:r);
    end;
    if ( ( convCredit!= $0 ) or ( convDebet != $0 ) )
      [         - Конвертации      ############ ############ ]
      ( convCredit:12:2:z:r, convDebet:12:2:z:r );
    end;
    [         - За др. филиалы   ############ ############ ]
    ( fbDepCredit:12:2:z:r, fbDepDebet:12:2:z:r);
    [         - Итого            ############ ############ ]
    ( credit:z:r, debet:z:r );
    [Остаток на конец дня                     ############
    (ценности)]
    ( rest:r );
    if ( ( oper == null ) or ( oper == 0 ) )
      if ( group.rec.Mode != GRM_IMMEDIATE )
        if ( rest != prevRest + credit - debet )
          [ВНИМАНИЕ!!!! ОСТАТОК НА КОНЕЦ ДНЯ НЕ СОВПАДАЕТ С ОСТАТКОМ КАССЫ];
        end;
      end;
    end;
    [------------------------------------------------------];
    printCommonFooter;
  end;

  initTReporter( _oper );
  if ( showRests == null )
    if ( oper == 0 )
      showRests = true;
    else
      showRests = false;
    end;
  end;
end;

class ( TReporter ) TSec_ValuesOnAccount( _oper )

  macro printHeader( isTail )

    printCommonHeader( oper );

    [          Контроль подотчетных ресурсов контролера #### за # ]
    ( oper, {curdate}:m ); 
    [ ];                    
    incLineCounter( 2 );

    if ( ( isTail != null ) and isTail )
      printLn( "(Продолжение со стр. " + string( pageCounter - 1 ) + ")" );
      incLineCounter( 1 );
    end;

    [--------------------------------+--------------+--------------+----------------------+];
    [     Наименование ресурса       |    Приход    |     Расход   | Остаток на конец дня |];
    [--------------------------------+--------------+--------------+----------------------+];
    incLineCounter( 3 );
  end;

  macro printLine 

    var
      v = TRecHandler( "od_data.4" );

    v.setRecordAddr( odData ); 

    if ( checkNewPage( getSublines( v.rec.ValName, 32 ) ) )
      printHeader( true );
    end;

    [############################### ############## ############## ###################### ]
    ( v.rec.ValName:w, v.rec.Credit:12:2:z:r, v.rec.Debet:12:2:z:r, v.rec.Rest:12:2:r ); 

    incLineCounter;
  end;

  macro print

    var
      recFound;

    newPage; 
    printHeader; 

    odData.keyNum = 0;
    odData.clear;
    odData.rec.Date = {curdate};
    odData.rec.Brigade = operBrigade;
    odData.rec.Mode = mode;
    odData.rec.Oper = oper;
    odData.rec.Type = ODT_ON_ACC;

    odData.addFilter( "t.t_Date = " + sqlDateToStr( {curdate} ) +
                      " and t.t_Brigade = " + string( operBrigade ) +
                      " and t.t_Mode = " + string( mode ) +
                      " and t.t_Oper = " + string( oper ) +
                      " and t.t_Type = " + string( ODT_ON_ACC ) );

    recFound = odData.getGE;
    while ( recFound  
      and ( odData.rec.Date == {curdate} )
      and ( odData.rec.Brigade == operBrigade )
      and ( odData.rec.Mode == mode )
      and ( odData.rec.Oper == oper )
      and ( odData.rec.Type == ODT_ON_ACC ) )
      printLine;
      recFound = odData.next;
    end;

    odData.dropFilter;
  end;

  InitTReporter( _oper );
end;

class ( TDiaryReporter ) TOperReporter( _oper, _showRests )

  var
    showRests = _showRests;

  macro printCurr

    var
      moneyTotals = TSec_MoneyTotals( oper, showRests ), 
      depOps = TSec_DepOps( oper ), 
      otherOps = TSec_OtherOps( oper ), 
      exchOps = TSec_ExchOps( oper ),
      convOps = TSec_ConvOps( oper ), 
      fbDepOps = TSec_FBDepOps( oper );
        
    opsForCurrReported = false;

    depOps.print;
    otherOps.print;
    exchOps.print;
    convOps.print;
    fbDepOps.print;
    if ( opsForCurrReported )
      moneyTotals.print;
      opsForOperReported = true;
    end;
  end;

  macro print
    
    var
      valTotals = TSec_ValTotals( oper, showRests ),
      valsOnAcc; 

    opsForOperReported = false;
    print;
    if (not EXPANDED_BRIGADE_REPORT or opsForOperReported)
      valTotals.print;
    end;
    if ( ( group.rec.Mode == GRM_IMMEDIATE ) and ( mode == 0 ) )
      valsOnAcc = TSec_ValuesOnAccount( oper );
      valsOnAcc.print;
    end;
  end;

  initTDiaryReporter( _oper );
end;

class ( TDiaryReporter ) TBrigadeReporter

  macro printCurr

    var
      depOps = TSec_DepOps, 
      otherOps = TSec_OtherOps, 
      exchOps = TSec_ExchOps, 
      convOps = TSec_ConvOps, 
      fbDepOps = TSec_FBDepOps( oper ), 
      moneyTotals = TSec_MoneyTotals;

    depOps.isOperReporter = otherOps.isOperReporter = exchOps.isOperReporter = 
    convOps.isOperReporter = fbDepOps.isOperReporter = moneyTotals.isOperReporter = 
    false;

    opsForCurrReported = false;

    fbDepOps.print(
    convOps.print(
    exchOps.print(
    otherOps.print(
    depOps.print()))));
    if( not IsCur  )
      [----------------------------------------------------------------------------------------------------------------------------];
    else
      [-------------------------------------------------------------------------------------------------------------------------------];
    end;
    moneyTotals.print;
  end;

  macro print

    var
      valTotals = TSec_ValTotals;

    valTotals.isOperReporter = false;
    print;
    valTotals.print;
  end;

  initTDiaryReporter( 0 );
end;

class ( TDiaryReporter ) TFBIDepReporter

  macro printCurr

    var
      depOps = TSec_FBIDepOps;

    opsForCurrReported = false;

    depOps.print;
  end;

  initTDiaryReporter( noOper2 );
end;
