/*
  $Name:        lc009_40.mac
  $Module:      Документарные аккредитивы
  $Description: Макрос шага
*/

// --------------------------------------------------------------------
//         Автоматизированная банковская система RS-Bank v6.0
//                 Copyright (c) R-Style Software Lab
//
//  Назначение  : Макрос шага
//
//  Описание    : Операция - 3411   - "Аккредитив"
//                Блок     - 341009 - "Открытие сделки МБК RS-Dealing"
//                Шаг      - 40     - "Учет привлеченных средств по МБК"
//
//  Программист : Чукина Т.А.
//
//  Создан      : 12.07.2013
//
// --------------------------------------------------------------------

IMPORT LCInter;

var LCDocObj:RsbLetterOfCredit;

MACRO ExecuteStep()
  var RecLcpay : TRecHandler = TRecHandler("lcpay");

  var IsFoundPay : bool = ( LCDocObj.Pays().First(RecLcpay) == 0 );

  while(IsFoundPay)
    if( (RecLcpay.rec.State == LCPAY_COMPENSATION_STATUS_TRANSFERRED) // Перечислено
        and
        (RecLcpay.rec.DealID != 0)
      )
      // реализуется во вторую очередь
      /*
      В сделке МБК фиксируется, что привлечение средств уже произведено - 
      планируемый платеж по выдаче, созданный в момент появления сделки МБК, 
      квитуется с платежом по возмещению lcpay.PaymentID, который в данном 
      случае является как бы внешним платежом по предоставлению средств.
      */
    end;

    IsFoundPay = ( LCDocObj.Pays().Next(RecLcpay) == 0 );
  end;

  return 0;
END;
