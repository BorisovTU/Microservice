/*
  $Name:        lc009_20.mac
  $Module:      Документарные аккредитивы
  $Description: Макрос шага
*/

// --------------------------------------------------------------------
//         Автоматизированная банковская система RS-Bank v6.0
//                 Copyright (c) R-Style Software Lab
//
//  Назначение  : Макрос шага
//
//  Описание    : Операция - 3411   - "Аккредитив"
//                Блок     - 341009 - "Сделка МБК RS-Dealing"
//                Шаг      - 20     - "Перечисление возмещения"
//
//  Программист : Чукина Т.А.
//
//  Создан      : 12.07.2013
//
// --------------------------------------------------------------------

IMPORT LCInter, lc_common, "mm_api_banking.mac";

var LCDocObj:RsbLetterOfCredit;

MACRO ExecuteStep()
  var RecLcpay : TRecHandler = TRecHandler("lcpay"),
      Pays : RsbLCPay = LCDocObj.Pays(),
      DealID : integer = 0;

  var IsFoundPay : bool = (Pays.First(RecLcpay) == 0);
  while(IsFoundPay)

    if(RecLcpay.rec.State == LCPAY_COMPENSATION_STATUS_NOTPROC) // Не обработана
      if(RecLcpay.rec.DealID > 0)
        DealID = RecLcpay.rec.DealID;
      elif(LCDocObj.DealID > 0)
        DealID = LCDocObj.DealID;
      else
        msgbox("Не задана сделка МБК, за счет которой перечисляется возмещение по выплате. Укажите сделку в закладке выплаты \"Возмещение\" или условиях финансирования аккредитива");
        return 1;
      end;

      var err : integer = MM_API_CheckDeals(DealID, RecLcpay.rec.ClaimAmount, RecLcpay.rec.FIID);
      if(err)
        MemoryError(err);
        msgbox( GetErrMsg() );
        return 1;
      else
        RecLcpay.rec.State = LCPAY_COMPENSATION_STATUS_TOTRANSFER; // К перечислению

        if( Pays.Update(RecLcpay) != 0 )
          msgbox("Ошибка при установке статуса возмещения в выплате");
          return 1;
        end;
      end;
    end;

    IsFoundPay = ( Pays.Next(RecLcpay) == 0 );
  end;

  return 0;
END;
