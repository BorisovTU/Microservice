import "ws_msg_transform_sec.mac"; /* Инструментарий для преобразования сообщений */
import "ws_party.mac";             /* Сервис */
import rcw;
import "func_lib.mac";
import "PersonGetXref.mac";
import DealsInter;
import "rshb_lib.mac";
import SFInter, dlcontrfunc;
import "global_classes.mac";
import "sp_car.mac";

private macro iscurdate(dt)
var res = Dt;
var cmd;
if (ValType(res) == v_date)
   cmd = trsbdataset("select * from dcurdate_dbt where t_curdate = " + GetSqlDate(dt)+ " and t_branch = 1");
   if (cmd.movenext())
return true;
end;
return false;
end;



end;

private macro isopendate(dt)
var res = Dt;
var cmd;
if (ValType(res) == v_date)
   cmd = trsbdataset("select * from dcurdate_dbt where t_curdate = " + GetSqlDate(dt)+ " and t_branch = 1 and t_isclosed = chr(0)");
   if (cmd.movenext())
return true;
end;
return false;
end;



end;


PRIVATE MACRO gETcURDATE(DT)
var sql = "";
var res = false;
if ((ValType(dt) == V_DATE)
 and (IsCurDate(dt) == false ))


   sql = " Insert into DCURDATE_DBT "
   "   (T_CURDATE, T_POINT, T_BRANCH, T_PHASE, T_MINPHASE, T_MAXPHASE, T_ISCLOSED, T_ISBALANCE, T_ISMAIN) "
   "  Values                                                                                               "
   "   (TO_DATE('"+dt+"', 'DD.MM.YYYY'), 0, 1, 1, 1,                                                        "
   "    1, Chr(0), 'X', chr(0));";
   SQL_Execute(sql);

//   res = true;
elif ((ValType(dt) == V_DATE) and (isopendate(dt) == false))
   sql = " update DCURDATE_DBT set t_isclosed = chr(0) where t_curdate = " + getsqldate(dt);
   SQL_Execute(sql);


end;

return isopendate(dt);


end;

PRIVATE MACRO closecURDATE(DT)
var sql = "";
var res = false;

if ((ValType(dt) == V_DATE) and (isopendate(dt)))
   sql = " update DCURDATE_DBT set t_isclosed = chr(88) where t_phase = 9999 and t_curdate = " + getsqldate(dt);
   SQL_Execute(sql);

   res = true;
end;
return res;


end;



// Найти, существует ли такой счет 
private macro FindAcc(currency, accnumber, accrec)
   var accfile = TBFile("account.dbt", "r", 0);

   accfile.rec.chapter = 1;
   accfile.rec.account = accnumber;
   accfile.rec.code_currency = currency;

   if (accfile.getEQ())
     copy(accrec, accfile);
   else
     accrec.rec.account = accnumber;
     accrec.rec.code_currency = currency;
   end;
end;


// Открыть счет для субдоговора 
private macro usrIntgr_ОткрытьСубсчетДляСубдоговора(category:string, SubContrID:integer, Currency:integer, AccAddr, ErrStr, _dateED)
   var FD = SPFirstDocContract( DL_STOCKCONTR, SubContrID );
       FD.SetParametr( MC_TYPE_PARAMETR_FIID, currency );

//  var FD = DL_SubContrFD(SubContrID);
  record ClientAcc( account );
  var accrec = TRecHandler("account.dbt");
  var err = 0;
  var datesub;

  //datesub = FD.GetSubContr().rec.DateBegin;
  datesub = {curdate};
  //gtv: дата открытия счета = дате открытия ЕД
  if (ValType(_dateED) == V_DATE)
     datesub = _dateED;
  end;

  ClearRecord(ClientAcc);
  //copy(ClientAcc, AccAddr);


//  if(false == FD.OpenAccount( category, NULL, NULL, ClientAcc, datesub, Currency, _dateED ))
  if(false == FD.OpenAccount( category, null, null, null, ClientAcc, _dateED, currency ) )

    ErrStr = "Ошибка при открытии счета по категории " + category;
    err = 1;
  end;
  println(clientacc.account);
  if(not err)
    var cmd, DataSet;

    cmd = DL_RSDCommand(  "select * from daccount_dbt"
                        + " where t_Account = ? "
                        + "   and t_Code_Currency = ? "
                        + "   and t_Chapter = ?"
                       ); 
    cmd.AddParam(ClientAcc.Account);
    cmd.AddParam(ClientAcc.Code_Currency);
    cmd.AddParam(ClientAcc.Chapter);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( accrec.rec );
      SetParm(3, accrec);
    else
      err = 1;
    end;
  end;

  SetParm(4, ErrStr);
  return err;
end;

// Открыть и привязать счет к договору
private macro OpenAccAndBindToContract(category, contractid, currency, accnumber, error, _dateED):integer
   var stat, errstr;
   var accrec = TRecHandler("account.dbt");

   // поиск и заполнение структуры
   FindAcc(currency, accnumber, accrec);

   //открытие счета
   stat = usrIntgr_ОткрытьСубсчетДляСубдоговора(category, contractid, currency, accrec, errstr, _dateED);

   if (stat != 0)
      SetParm(4,errstr);
      return stat;
   end;

   return stat;
end;

private macro OpenAllAccounts(_sub_id, _fiid_sub, _AgreementDate)
   private var stat, err_txt;
   private var v_AgreementDate = _AgreementDate;


/*   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_COM, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;*/
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;
   stat = OpenAccAndBindToContract(CATEG_SUBCONTRACT_VU_CALC, _sub_id, _fiid_sub, "", err_txt, v_AgreementDate);
   if(stat != 0)
      RunError(err_txt, c_err_obj(err_txt, ERR_CODE_TECH_ERROR));
   end;

end;

var sql = 
"SELECT a.t_account, " +
"       t_currency, " +
"       t_clientcontrid, " +
"       SF.T_DATEBEGIN, sf.t_acccode " +
"  FROM dmcaccdoc_dbt a, dsfcontr_dbt sf " +
" WHERE t_catnum = 201 AND sf.t_id = a.t_clientcontrid " +
"       AND NOT EXISTS " +
"                  (SELECT 1 " +
"                     FROM dmcaccdoc_dbt " +
"                    WHERE     t_clientcontrid = a.t_clientcontrid " +
"                          AND t_currency = a.t_currency " +
"                          AND t_chapter = 21) " ;
var DT = TRsbDataSet(sql);

var i = sql_getnrecs(sql), refval;
initprogress(i,"","");
i = 0;
while (Dt.movenext())

   if (dt.acccode == "0")
      GenerateReference(127, refval);
      sql = "update dsfcontr_dbt set t_acccode = '"+string(refval)+"' where t_id = "+string(dt.clientcontrid);
      SQL_Execute(sql);
   end;

   if (gETcURDATE(sql_convtypedate(DT.datebegin)))
       OpenAllAccounts(dt.clientcontrid, dt.currency, sql_convtypedate(dt.datebegin));
   end;
   if ( not closecURDATE(sql_convtypedate(DT.datebegin)))
      println("error closedate");
   end;
   useprogress(i=i+1);
end;
remprogress;
