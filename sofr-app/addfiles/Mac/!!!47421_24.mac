IMPORT "or_rep_h.mac", dv_fun, "dv_categ.mac", "dl_car.mac", "dv_car.mac";

private var Rep, Repp;
private var delim = GetLocaleInfo(0, LOCALE_SDECIMAL, false);

/* Первый вызов макроса для вывода заголовка и задания начальных настроек */
macro f(s,string)
  return strsubst(strsubst(s,".",delim),",",delim);
end;

MACRO First_Call()

  var StrHeader:string =
                                                                                                                              
"┌────────────────────────┬──────────┬─────────────┬──────────────────────────┬─────────────────┬──────────────────┐\n"+
"│ Новый счет             │ ID валюты│  код валюты │Старый счет               │Изменение остатка│ Контрагент       │\n"+
"├────────────────────────┼──────────┼─────────────┼──────────────────────────┼─────────────────┼──────────────────┤";

  /* Создадим объект класса CMakeReport */
  Rep = CMakeReport(StrHeader);

END; /* First_Call */


/* Циклический вызов макроса, для формирования таблицы с данными */
MACRO PrintLine_Alg(acc1, fiid, codecur, account, R, contractor)

  Rep.AddPrintCell(acc1);
  Rep.AddPrintCell(fiid);
  Rep.AddPrintCell(codecur);
  Rep.AddPrintCell(account);
  Rep.AddPrintCell(R);
  Rep.AddPrintCell(contractor);
  Rep.AddStr();

END;


/* Последний вызов макроса для печати и визуализации отчета */
MACRO Last_Call()

  /* Печатаем, только если есть хоть одна запись */
  if(Rep.IsDataExist())
     Rep.PrintRep();
     /* Печатаем отчет в Excel */
     Rep.PrintWinRep(1, "Sheet"); 
     /* Делаем окно с Excel активным */
     Rep.ShowWinRep();   
  end;
END;


var Sql, Dt, sql2, Dt2, query3, sql3, Dt3;
var AccPlus = TRecHandler("account");
var AccMinus = TRecHandler("account");
var Счетдеб = TRecHandler("account");
var СчетКред = TRecHandler("account");
var FD;

var Query = " SELECT NVL((SELECT distinct t_account  " +
            "    FROM DMCACCDOC_DBT " +
            "         WHERE     t_catnum = (case when Substr(ts.account ,1,5) = '47421' then 5072 else 5073 end) " +
            "               AND t_fiid = ts.t_fiid " +
            "               AND t_contractor = ts.t_contractor),'0') " +
            "          acc1, " +
            "       ts.*, (select t_shortname from dparty_dbt where t_partyid = ts.t_contractor) conrtname, " +
            "     (select max(deal.t_id) from DDVNDEAL_DBT deal, DDVNFI_DBT fi where fi.t_dealid = deal.t_id and deal.t_contractor = ts.t_contractor and fi.t_fiid = ts.t_fiid and deal.t_dockind = 4813) as dealid, "
            "     (case when Substr(ts.account ,1,5) = '47421' then 5072 else 5073 end) as catnum" +
            "  FROM (  SELECT F.T_FIID, " +
            "                 (SELECT I.T_CCY " +
            "                    FROM dfininstr_dbt i " +
            "                   WHERE I.T_FIID = F.T_FIID) " +
            "                    codecur,                      " +
            "                 T.T_ACCOUNT_PAYER account, " +
            "                 (NVL (SUM (T.T_SUM_PAYER), 0) " +
            "                  - NVL ( " +
            "                       (SELECT sum_receiver " +
            "                          FROM (  SELECT Fr.T_FIID fiid, " +
            "                                         Tr.T_ACCOUNT_receiver " +
            "                                            ACCOUNT_receiver, " +
            "                                         SUM (Tr.T_SUM_receiver) sum_receiver " +
            "                                    FROM dacctrn_dbt tr, " +
            "                                         doprdocs_dbt dr, " +
            "                                         doproper_dbt rr, " +
            "                                         ddvnfi_dbt fr " +
            "                                   WHERE Dr.T_ACCTRNID = Tr.T_ACCTRNID " +
            "                                         AND rr.T_ID_OPERATION = " +
            "                                                Dr.T_ID_OPERATION " +
            "                                         AND Fr.T_DEALID = " +
            "                                                TO_NUMBER (rr.T_DOCUMENTID) " +
            "                                GROUP BY Fr.T_FIID, Tr.T_ACCOUNT_receiver) " +
            "                         WHERE FIID = F.T_FIID " +
            "                               AND ACCOUNT_receiver = T.T_ACCOUNT_PAYER), " +
            "                       0)) " +
            "                    r, " +
            "                 deal.t_contractor AS t_contractor " +
            "            FROM dacctrn_dbt t, " +
            "                 doprdocs_dbt d, " +
            "                 doproper_dbt o, " +
            "                 ddvnfi_dbt f, " +
            "                 DDVNDEAL_DBT deal " +
            "           WHERE D.T_ACCTRNID = T.T_ACCTRNID " +
            "                 AND T.T_ACCOUNT_PAYER IN " +
            "                        (SELECT A.T_ACCOUNT " +
            "                           FROM daccount_dbt a " +
            "                          WHERE ( (A.T_ACCOUNT LIKE '47421%' " +
            "                                   OR A.T_ACCOUNT LIKE '47424%')) " +
            "                                AND A.T_OPEN_DATE > " +
            "                                       TO_DATE ('01012019', 'ddmmyyyy') " +
            //"                                AND INSTR (A.T_USERTYPEACCOUNT, 'Ы') <> 0 " +
            "                                                        AND  (SELECT count(t_account) " +
            "                                                      FROM DMCACCDOC_DBT "
            "                                                     WHERE t_account =  a.t_account and t_fiid = -1) > 0 "
            "                                ) " +
            "                 AND O.T_ID_OPERATION = D.T_ID_OPERATION " +
            "                 AND F.T_DEALID = TO_NUMBER (O.T_DOCUMENTID) " +
            "                 AND deal.t_id = f.t_dealid /*and DEAL.T_CONTRACTOR = 115139 */" +
            "        GROUP BY F.T_FIID, T.T_ACCOUNT_PAYER, deal.t_contractor " +
            "        ORDER BY T.T_ACCOUNT_PAYER, F.T_FIID) ts " +
            "        where ts.r <> 0  " ;


  sql = RsdCommand(Query);
  Dt = TRsbDataSet(sql);
  First_Call();
  while (Dt.movenext())
         FD = DVFirstDocFXDeal(DL_DVFXDEAL, int(Dt.DealID));
         ClearRecord(AccPlus);
         ClearRecord(AccMinus);
         ClearRecord(СчетКред);
         ClearRecord(СчетДеб);
         if( not FD.ReOpenAccount("+Переоц.,поставка0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, {Curdate}, NATCUR, null, /*2*/null) )
             Msgbox( "Ошибка при определении счета по категории +Переоц.,поставка0 в проводке.");
         end;
         if( not FD.ReOpenAccount("-Переоц.,поставка0", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, {Curdate}, NATCUR, null, /*2*/null) )
             Msgbox( "Ошибка при определении счета по категории +Переоц.,поставка0 в проводке.");
         end;

         if (Dt.catnum == 5072)/*+*/
             DL_GetAccount(1, NATCUR, Dt.Account, СчетКред);
             if (Dt.R > 0)
                 if( not ПроводкаПоКатегориямУчета( FD,
                                           AccPlus, СчетКред,
                                           {Curdate},
                                           1,
                                           NATCUR, Abs(Dt.R),
                                           doc,
                                           INPCARRY, "", "",
                                           "перенос остатка со счета " +string(СчетКред.rec.Account)+" на счет "+string(AccPlus.rec.Account)
                                         )
                    )
                    return 1;
                 end;
             else
                 if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетКред, AccPlus,
                                           {Curdate},
                                           1,
                                           NATCUR, Abs(Dt.R),
                                           doc,
                                           INPCARRY, "", "",
                                           "перенос остатка со счета " +string(СчетКред.rec.Account)+" на счет "+string(AccPlus.rec.Account)
                                         )
                    )
                    return 1;
                 end;
             end;
             PrintLine_Alg(AccPlus.rec.Account, Dt.t_fiid, Dt.codecur, Dt.Account, Dt.R, Dt.conrtname);  
         else /*-*/
            DL_GetAccount(1, NATCUR, Dt.Account, СчетДеб);
            if (Dt.R > 0)
                if( not ПроводкаПоКатегориямУчета( FD,
                                           AccMinus, СчетДеб,
                                           {Curdate},
                                           1,
                                           NATCUR, Abs(Dt.R),
                                           doc,
                                           INPCARRY, "", "",
                                           "перенос остатка со счета " +string(СчетДеб.rec.Account)+" на счет "+string(AccMinus.rec.Account)
                                         )
                   )
                   return 1;
                end;
            else
                if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетДеб, AccMinus,
                                           {Curdate},
                                           1,
                                           NATCUR, Abs(Dt.R),
                                           doc,
                                           INPCARRY, "", "",
                                           "перенос остатка со счета " +string(СчетДеб.rec.Account)+" на счет "+string(AccMinus.rec.Account)
                                         )
                   )
                   return 1;
                end;
            end;
            PrintLine_Alg(AccMinus.rec.Account, Dt.t_fiid, Dt.codecur, Dt.Account, Dt.R, Dt.conrtname);  
         end; 
  end;
  Last_Call();
end;
