/****************************************************************************
   RS-Bank        Обменный пункт
   sbr_odn.mac - макрос формирует операционные дневники ОП для отчетности СБ
   Copyright 1998 (c) R-Style Software Lab.
   Создание:  7-09-98 by AV
    История:
      AV 28-09-98 добавил печать строк с остатками ценностей сотрудника
      DZ 04-11-98 изменил формирование строки по авансу БСО на общую
                  сумму справок
      DZ 05-11-98 Курс для 24 формы брался текущий, а не соответсвовал
                  истории. Исправлено.
      DZ 05-11-98 Курс в поле Operat.CurCB для операций аванса выставляется
                  неверно. Обошел, используя историю курсов.
      RA 25-03-99 Добавил отражение операций "Покупка неплатежеспособной валюты",
                  "Прием на экспертизу", "Прием на инкассо",
                  "Продажа ПД за валюту", "Оплата ПД валютой".
      RA  2-04-99 Переделал обработку комиссии
      RA 13-08-99 Добавил отражение курсовой разницы

   ОперационныйДневник_2() - стандартное название функции, формирующей
                             дневники (ОД) Форма N24

  31.10.2000 VS Вставлено различие ПД, купленных за валюту и за рубли. 
****************************************************************************
   !!!!! По образцу от уфимского СБ !!!!!
****************************************************************************/

FILE      Rates( "cur_rate.dbt", "exchange.def" ) key 1;
FILE   Ratechng( "ratechng.dbt", "exchange.def" ) key 1;
FILE RateChAuto( "ratechng.dbt", "exchange.def" ) key 0;
FILE   Treasure( "treasure.dbt", "exchange.def" ) key 0; /*смена-сотрудник-валюта-ценность-ПД */

/*AV 13-10-98  - глобальные значения*/

var ФиксКомисРуб = 0;
var ПроцКомисРуб = 0;
var ОбщКолАвансБСО = 0;
var ОбщКолАвансF31 = 0;

/* установка ключа и поиск первой подходящей под ключ записи            */
/* в файле treasure.dbt                                                 */
MACRO InitTrsKey( CodeTrs, CodeCurr, NumEmp, Sess )
   ClearRecord( Treasure );
   Treasure.Sess_Ref = Sess;
   Treasure.Emp_Ref  = NumEmp;
   Treasure.Curr_Ref = CodeCurr;
   Treasure.Trs_Ref  = CodeTrs;
   Treasure.PayDoc_Ref = 0;
   if( getGE( Treasure ) )
     if(
             (Treasure.Sess_Ref == Sess    )
         AND (Treasure.Emp_Ref  == NumEmp  )
       )
      return True;
     end;
   end;
   return False;
END;

/****************************************************************************/
/* Процедура возвращает текущие курсы для указанной валюты, через параметры */
/****************************************************************************/
MACRO ПолучитьКурсы( КодВалюты, КурсЦБ, КурсПокупки, КурсПродажи )
   var RatechngID, Loop = True;

 if( КодВалюты == ANY_CURR )
      SetParm( 1, 0 );
      SetParm( 2, 0 );
      SetParm( 3, 0 );
      return false;
 else
   ReWind(RateChAuto);
   Prev(RateChAuto);
   if( Session.StopDate != Date(0,0,0) ) /* RA 20-06-00 */
     while ( ( RateChAuto.StartDate > Session.StopDate ) AND 
             ( Prev( RateChAuto ) )                          
           )                                                 
     end;                                                    
     while ( ( RateChAuto.StartDate == Session.StopDate ) AND
             ( RateChAuto.StartTime >  Session.StopTime ) AND
             ( Prev( RateChAuto ) )                          
           )                                                 
     end;                                                    
   end;                                                      
   RatechngID = RateChAuto.ID;
   While( Loop AND (RateChAuto.Kind_Ref != MAINRATEKIND) ) /*пока не основной вид курсов*/
     Loop = Prev( RateChAuto );
     if( Loop AND (RateChAuto.Kind_Ref == MAINRATEKIND) ) /*основной вид*/
        RatechngID = RateChAuto.ID;
        Loop = False;
     end;
     if( Loop AND (RateChAuto.StartDate != Session.StartDate) )/*вышли из текущей даты*/
        Loop = False;
     end;
   end;

   Rates.Change_Ref = RatechngID;
   Rates.Curr_Ref   = КодВалюты;
   if( GetEQ( Rates ) )
      SetParm( 1, Rates.CBRate   / Rates.ChangeNom );
      SetParm( 2, Rates.BuyRate  / Rates.ChangeNom );
      SetParm( 3, Rates.SellRate / Rates.ChangeNom );
      return true;
   else
      MsgBox("Не найден курс для валюты:" + GetISOCurr( КодВалюты ) );
      return false;
   end;
 end;
END;
/****************************************************************************/
/* Процедура получает номер элемента в массиве                              */
/* Смещение = N (проверять каждый N-ый элемент)                             */
/****************************************************************************/
MACRO НомерЭлементаВМассиве( Элемент, Массив, Смещение )
 var Номер = -1;
 var i = 0;
 var Loop = True;
 While( (Loop == True) AND (i < TotalNumCurr) )
    if( Массив( i * Смещение ) == Элемент )
       Номер = i * Смещение;
       Loop = False;
    else
       i = i + 1;
    end;
 end;
 return Номер;
END;
/****************************************************************************/
/*  Процедура инициализирует массивы с суммами конверсий                    */
/****************************************************************************/
macro ИнициализацияМассивовКонверсий()
   var i = 0;
   While( i < TotalNumCurr )
      ConvIncSum( i*2 ) = DiffCurr(i);
      ConvIncSum( i*2 + 1 ) = 0;
      ConvOutSum( i*2 ) = DiffCurr(i);
      ConvOutSum( i*2 + 1 ) = 0;
      i = i + 1;
   end;
end;

/****************************************************************************/
/* Процедура заполняет массив с итогами по всем ОД для разных валют         */
/****************************************************************************/
macro ЗаполнениеИтоговПоВалютам_НОД( КодВалюты )
   var Cмещение = НомерВалюты * КоличествоЭлементов;
   ИтогиПоВалютам( Cмещение     ) = КодВалюты;
   ИтогиПоВалютам( Cмещение + 1 ) = ИтогКолонки( 2 );/*3-я графа*/
   ИтогиПоВалютам( Cмещение + 2 ) = ИтогКолонки( 3 );/*4-я графа*/
   ИтогиПоВалютам( Cмещение + 3 ) = ИтогКолонки( 4 );/*5-я графа*/
   ИтогиПоВалютам( Cмещение + 4 ) = ИтогКолонки( 5 );/*6-я графа*/
end;     
/****************************************************************************/
/* Процедура заполняет массивы с разными номерами смен курсов и валют       */
/****************************************************************************/          

MACRO ЗаполнитьМассивы_НОД()
 var j = 0;
 var BreakLoop;

 if( Session.Number != {SessionNumber} ) /* не текущая смена */
   asize(DiffCurr, 0);
   asize(ConvIncSum, 0);/*массив для полученных сумм по конверсии валют*/
   asize(ConvOutSum, 0);/*массив для выданных сумм по конверсии валют*/
   /*по реестрам о/п*/        
   ClearRecord( Reestr );
   Reestr.ExchangeNumber = office.ID;
   Reestr.Emp_Ref        = Session.Emp_Ref;
   Reestr.Sess_Ref       = Session.Number;
   BreakLoop = GetGE( Reestr );
   /*цикл по реестрам*/       
   While( BreakLoop AND (Reestr.Emp_Ref == Session.Emp_Ref ) AND (Reestr.Sess_Ref== Session.Number) )
      PutNumberInArray(    DiffCurr,    Reestr.OutCurr_Ref, j );
      PutNumberInArray(    DiffCurr, Reestr.IncomeCurr_Ref, j );
      BreakLoop = Next( Reestr );
   end;
   /*по операциям аванса*/    
   Operat.OutCurr_Ref    = ANY_CURR;
   Operat.IncomeCurr_Ref = ANY_CURR;
   Operat.Emp_Ref        = Session.Emp_Ref;
   Operat.Sess_Ref       = Session.Number;
   Operat.Oper_Ref       = CDF_OperAvance;    /*операция аванса*/
   Operat.State_Ref      = CDF_OperCompleted; /* завершена     */
   Operat.Rate_Ref       = 0;
                              
   BreakLoop = GetGE( Operat );
   While( BreakLoop == True AND
          (Operat.Emp_Ref        == Session.Emp_Ref)         AND
          (Operat.Sess_Ref       == Session.Number)          AND
          ( (Operat.State_Ref    == CDF_OperCompleted) OR
            (Operat.State_Ref    == CDF_OperInReestr )  )    AND
          (Operat.Rate_Ref       == 0)                       AND
          (Operat.Oper_Ref       == CDF_OperAvance)
        )
      if( Operat.IncomeCurr_Ref != ANY_CURR )
         PutNumberInArray( DiffCurr,   Operat.IncomeCurr_Ref, j );
      end;
      BreakLoop = Next( Operat );
   end;

   /*по операциям инкассации*/
   Operat.OutCurr_Ref    = ANY_CURR;
   Operat.IncomeCurr_Ref = ANY_CURR;
   Operat.Emp_Ref        = Session.Emp_Ref;
   Operat.Sess_Ref       = Session.Number;
   Operat.Oper_Ref       = CDF_OperCashOut;   /*операция инкассации*/
   Operat.State_Ref      = CDF_OperCompleted; /* завершена         */
   Operat.Rate_Ref       = 0;

   BreakLoop = GetGE( Operat );
   While( BreakLoop == True AND
          (Operat.Emp_Ref        == Session.Emp_Ref)         AND
          (Operat.Sess_Ref       == Session.Number)          AND
          ( (Operat.State_Ref    == CDF_OperCompleted) OR
            (Operat.State_Ref    == CDF_OperInReestr )  )    AND
          (Operat.Rate_Ref       == 0)                       AND
          (Operat.Oper_Ref       == CDF_OperCashOut)
        )
      if( Operat.OutCurr_Ref != ANY_CURR )
         PutNumberInArray( DiffCurr,   Operat.OutCurr_Ref, j );
      end;
      BreakLoop = Next( Operat );
   end;

   /*по операциям передачи*/
   Operat.OutCurr_Ref    = ANY_CURR;
   Operat.IncomeCurr_Ref = ANY_CURR;
   Operat.Emp_Ref        = Session.Emp_Ref;
   Operat.Sess_Ref       = Session.Number;
   Operat.Oper_Ref       = CDF_OperTransfer;  /*операция передачи*/
   Operat.State_Ref      = CDF_OperCompleted; /* завершена       */
   Operat.Rate_Ref       = 0;

   BreakLoop = GetGE( Operat );
   While( BreakLoop == True AND
          (Operat.Emp_Ref        == Session.Emp_Ref)         AND
          (Operat.Sess_Ref       == Session.Number)          AND
          ( (Operat.State_Ref    == CDF_OperCompleted) OR
            (Operat.State_Ref    == CDF_OperInReestr )  )    AND
          (Operat.Rate_Ref       == 0)                       AND
          (Operat.Oper_Ref       == CDF_OperTransfer)
        )
      if( Operat.OutCurr_Ref != ANY_CURR )
         PutNumberInArray( DiffCurr,   Operat.OutCurr_Ref, j );
      end;
      BreakLoop = Next( Operat );
   end;
                    
   TotalNumCurr = j;          

 else
   asize(DiffCurr, 0);
   asize(ConvIncSum, 0);/*массив для полученных сумм по конверсии валют*/
   asize(ConvOutSum, 0);/*массив для выданных сумм по конверсии валют*/
  
   Treasure.Sess_Ref   = Session.Number;
   Treasure.Emp_Ref    = Session.Emp_Ref;  
   Treasure.Curr_Ref   = ANY_CURR; 
   Treasure.Trs_Ref    = 0;  
   Treasure.PayDoc_Ref = 0;
                    
   BreakLoop = GetGE( Treasure );
   While( BreakLoop == True AND
          ( Treasure.Sess_Ref   == Session.Number  ) AND
          ( Treasure.Emp_Ref    == Session.Emp_Ref ) 
        )
     if( Treasure.Curr_Ref != ANY_CURR )
       PutNumberInArray( DiffCurr, Treasure.Curr_Ref, j );
     end;
     BreakLoop = Next( Treasure );
   end;
   TotalNumCurr = j;
 end;

END;

/*RA 3-08-99*****************************************************************/
/* Процедура заполняет массивы с разными номерами смен курсов и валют       */
/* для проверки на подлинность (операция не из реестра)                     */
/****************************************************************************/
/*             закомментировал, т.к. не используется                        */
/*     ( ордер для пров. на подл. печатается по валютам операций )          */
/*
MACRO ЗаполнитьМассивы_ПровНаПодл( ArrCurr, ArrFixCommSum, Size )
 asize( ArrCurr, 0 );
 asize( ArrFixCommSum, 0 ); /* массив для сумм фиксированных комиссий */
 var j = 0, BreakLoop = False;

 /* по операциям проверки на подлинность */
 Operat.OutCurr_Ref    = ANY_CURR;
 Operat.IncomeCurr_Ref = ANY_CURR;
 Operat.Emp_Ref        = Session.Emp_Ref;
 Operat.Sess_Ref       = Session.Number;
 Operat.Oper_Ref       = CDF_OperCheck;     /*операция проверки на подлинность*/
 Operat.State_Ref      = CDF_OperCompleted; /* завершена */
 Operat.Rate_Ref       = 0;

 BreakLoop = GetGE( Operat );
 While( BreakLoop == True AND
        (Operat.Emp_Ref        == Session.Emp_Ref)         AND
        (Operat.Sess_Ref       == Session.Number)          AND
        (Operat.State_Ref      == CDF_OperCompleted)       AND
        (Operat.Rate_Ref       == 0)                       AND
        (Operat.Oper_Ref       == CDF_OperCheck)
      )

    if( GetTurnoper( CDF_TurnFix ) ) /* найти оборот по фикс. комиссии */
       if( Turnoper.Curr_Ref != ANY_CURR )
          PutNumberInArray( ArrCurr, Turnoper.Curr_Ref, j ); /*занести валюту*/
          ArrFixCommSum( j ) = money(0);
       end;
    end;
    BreakLoop = Next( Operat );
 end;
 Size = j;
 SetParm( 0, ArrCurr );
 SetParm( 1, ArrFixCommSum );
 SetParm( 2, Size );
END;
*/

/***************************************************************************/
/*  Процедура получает строку-штамп с инфой об обменном пункте             */
/***************************************************************************/
MACRO MakeStrStamp1( )
   [########################################################
    ########################################################
    ########################################################
    ########################################################
   ]
   (
    Trim( Office.Name ):w,
    "Код ОКПО " + Trim( Office.OKPO ):w,
    "Регистрационный номер N " + Trim( Office.RegNumb ):w,
    Trim( Office.Address ):w
    );
END;

MACRO ПечатьСтрокКурсов()
   var i = 0, КурсЦБ, КурсПокупки, КурсПродажи;
   
[                            +----------------------+--------------+--------------+--------------+
                             |        Валюта        |    Курс ЦБ   | Курс покупки | Курс продажи |
                             +----------------------+--------------+--------------+--------------+
];

   While( i < TotalNumCurr )
      if( DiffCurr(i) != {NationalCur} )
         if( ПолучитьКурсы( DiffCurr(i), КурсЦБ, КурсПокупки, КурсПродажи ) )
[                            | #################### |  ##########  |  ##########  |  ##########  |
]        (                                                                                              
         GetNameCurr( DiffCurr(i) ),
         КурсЦБ:r,
         КурсПокупки:r,
         КурсПродажи:r
         );

         end;
      end;
      i = i + 1;
   end;
[                            +----------------------+--------------+--------------+--------------+

];

END;

/****************************************************************************/
/* Новый ОД - по образцу от Уфимского СБ                                    */
/****************************************************************************/
MACRO ШапкаОперационногоДневника_НОД()
   PrintDate_n_Time();
   MakeStrStamp1();
   ПечатьСтрокКурсов();
[                                          ОПЕРАЦИОННЫЙ ДНЕВНИК ПО ВАЛЮТНЫМ ОПЕРАЦИЯМ ЗА #########################                                                            Форма N24
 ---+----------------------------------------------------+-------------------------------------------------------+-------------------------------------------------------+---------------------------+
  N |                                                    |                        В рублях                       |                 В иностранной валюте                  |                           |
  п |                                                    +---------------------------+---------------------------+---------------------------+---------------------------+          Ценности         |
  п |            Краткое содержание операций             |     Наличные деньги       |   Мемориальные обороты    |         Наличные          |   Мемориальные обороты    |                           |
    |                                                    +-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
    |                                                    |   Приход    |   Расход    |  Зачислено  |   Списано   |   Приход    |  Расход     |  Зачислено  |   Списано   |    Приход   |    Расход   |
 ---+----------------------------------------------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
]
( StrAddZeroDate( Session.StartDate )
);
END;

MACRO РазделительСтрок_НОД()
return
"---+----------------------------------------------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+";
END;

MACRO ДноОперационногоДневника_НОД()
[---+----------------------------------------------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
              Кассир___________ ##########################    Проверил бухгалтер________________                                                                                                     |
]
( GetFIOEmployee( Session.Emp_Ref ) );
END;

MACRO  Строка_НомерСтрокиОД()
   return AddZero( НомерСтрокиОД, 3, " " ) + "|";
END;

/****************************************************************************/
/* Секция процедур печатающих конкретные строки в ОД                        */
/****************************************************************************/
/* -------------СТРОКИ ПО ВАЛЮТНО-ОБМЕННЫМ ОПЕРАЦИЯМ-------------- */
macro СтрокаПокупкиВалюты( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Покупка ", КодВалюты, КурсОперации ), 4, РасходРуб, 5, СписаноЦБ, 7, ПриходЦБ/*, 11, ПриходВал*/ ) );               /*СписаноЦБ 10->5*/
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПокупкиНеплВалюты( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Покупка неплат. вал.", КодВалюты, КурсОперации), 4, РасходРуб, 5, СписаноЦБ, 7, ПриходЦБ, 11, Количество ) );            /*СписаноЦБ 10->5*/
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПродажиВалюты( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Продажа ", КодВалюты, КурсОперации), 3, ПриходРуб, 5, ПрибыльРуб, 8, РасходЦБ/*, 12, РасходВал*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПокупкиПД( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Покупка ПД (" + GetISOCurr(КодВалюты) + ")", "empty",КурсОперации), 4, РасходРуб, 5, СписаноЦБ, 7, ПриходЦБ, 11, Количество ) ); /*СписаноЦБ 10->5*/
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПродажиПД( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Продажа ПД (" + GetISOCurr(КодВалюты) + ")", "empty",КурсОперации), 3, ПриходРуб, 5, ПрибыльРуб, 8, РасходЦБ, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПродажиПДЗаВал( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Продажа ПД за валюту (" + GetISOCurr(КодВалюты) + ")", "empty",КурсОперации), 7, РасходЦБ, 8, РасходВал/*, 11, ПриходРуб*/, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОплатыПДВал( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Оплата ПД валютой (" + GetISOCurr(КодВалюты) + ")", "empty",КурсОперации), 7, РасходЦБ, 8, РасходВал, 11, Количество/*, 12, ПрибыльРуб*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПроверкаНаПодлинность( КодВалюты, ПолученоРуб, ВыданоРуб, ПриходВал, РасходВал );
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Проверка на подлинность (" + GetISOCurr(КодВалюты) + ")"), 7, ПолученоРуб, 8,  ВыданоРуб/*, 11, ПриходВал*//*, 12, РасходВал*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаЗаменыНеплатВал( КодВалюты, Приход, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Замена неплатеж. валюты (" + GetISOCurr(КодВалюты) + ")"), 7, Приход, 8,  Расход, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
/* ------------СТРОКИ НАЛОГОВ--------------- */
macro СтрокаНалогаНаПродажуВалюты( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Налог с продажи ", КодВалюты), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаНалогаНаПродажуПД( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Налог с продажи ПД (" + GetISOCurr(КодВалюты) + ")"), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПодохНалогаНаПродажуВалюты( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Подоходный налог с продажи ", КодВалюты), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПодохНалогаНаПокупкуВалюты( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Подоходный налог с покупки ", КодВалюты), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПодохНалогаНаПродажуПД( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Подоходный налог с продажи ПД (" + GetISOCurr(КодВалюты) + ")"), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПодохНалогаНаПокупкуПД( КодВалюты, Налог )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Подоходный налог с покупки ПД (" + GetISOCurr(КодВалюты) + ")"), 3, Налог ) );
    println( РазделительСтрок_НОД() );
end;
/* ------------СТРОКИ КОМИССИЙ--------------- */
macro СтрокаПроцКомиссииВал( КодВалюты, ПриходЦБ, ПроцКомиссия )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" % комиссия " + "(" + GetNameCurr(КодВалюты) + ")" ), 7, ПриходЦБ/*, 11, ПроцКомиссия*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПроцКомиссииРуб( ПроцКомиссияРуб )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" % комиссия " + "(" + GetNameCurr({NationalCur}) + ")" ), 3, ПроцКомиссияРуб ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаФиксКомисВал( КодВалюты, ПриходЦБ, ФиксКомиссия )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Фикс.комиссия " + "(" + GetNameCurr(КодВалюты) + ")" ), 7, ПриходЦБ/*, 11, ФиксКомиссия*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаФиксКомисРуб( ФиксКомиссия )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Фикс.комиссия в рублях" ), 3, ФиксКомиссия ) );
    println( РазделительСтрок_НОД() );
end;
/* --------------------СТРОКИ БЕЗНАЛИЧНОЙ КОНВЕРСИИ------------------------- */
macro СтрокаБезналКонв( РублеваяСумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Б\\Н конверсия валютной мелочи" ), 4, РублеваяСумма ) );
    println( РазделительСтрок_НОД() );
end;
/* --------------------СТРОКИ РАЗНИЦЫ КУРСОВ-------------------- RA 13-08-99 */
macro СтрокаРазницыКпок_ОК( Разница )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Разница между курсом покупки и курсом ЦБ" ), 10, Разница ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаРазницыКпрод_ОК( Разница )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Разница между курсом продажи и курсом ЦБ" ), 5, Разница ) );
    println( РазделительСтрок_НОД() );
end;
/* ------------СТРОКИ ПРИХОДОВ/РАСХОДОВ ЦЕННОСТЕЙ--------------- */
macro СтрокаАвансВалюты( Код, ПриходРуб, Приход, КодЦенности )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено ", Код, "", КодЦенности), 7, ПриходРуб/*, 11, Приход*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаАвансВалютыПД( Код, ПриходРуб, Приход, PayDoc_Ref, КодЦенности, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено ПД:" + GetNamePayDoc( PayDoc_Ref ), "", "", КодЦенности), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаАвансБланковПД( Код, ПриходРуб, Приход, PayDoc_Ref, КодЦенности, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено бланков ПД:" + GetNameValForm( PayDoc_Ref ), "", "", КодЦенности), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПолученоНаКартыВал( Код, ПриходРуб, Приход, КурсОперации )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием на карты ", Код, КурсОперации), 7, ПриходРуб/*, 11, Приход*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПолученоНаКартыРуб( Код, ПриходРуб, Приход, КурсОперации )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием на карты ", Код, КурсОперации), 3, ПриходРуб/*, 11, Приход*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаКонверсияПриходВалюты( Код, ПриходРуб, ПриходВал )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Конверсия: прих. ", Код), 7, ПриходРуб/*, 11, ПриходВал*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаАвансРублевый( Приход, КодЦенности )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено наличных денег ", "", "", КодЦенности), 3, Приход ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаАвансРублевыйПД( Приход, PayDoc_Ref, КодЦенности, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено ПД:" + GetNamePayDoc( PayDoc_Ref ), "", "", КодЦенности ), 3, Приход, 11, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПереданоВалюты( Код, РасходРуб, Расход, КодЦенности )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Сдано ", Код, "", КодЦенности), 8, РасходРуб/*, 12, Расход*/ ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПереданоВалютыПД( Код, РасходРуб, Расход, PayDoc_Ref, КодЦенности, Количество )
 var StrPlus = "";              /* !!! На случай совместносго импорта с sprvfunc.mac не задаю константими. */
 if  ( КодЦенности == TrsCheckRub ) StrPlus = "(оплач.руб.)";
 elif( КодЦенности == TrsCheckCur ) StrPlus = "(оплач.вал.)";
 end;
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Сдано ПД:" + GetNamePayDoc( PayDoc_Ref ) + StrPlus, "", "", КодЦенности), 8, РасходРуб, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПереданоБланковПД( Код, РасходРуб, Расход, PayDoc_Ref, КодЦенности, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Сдано бланков ПД:" + GetNameValForm( PayDoc_Ref ) , "", "", КодЦенности), 8, РасходРуб, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаСнятоСКартВал( Код, РасходРуб, Расход, КурсОперации )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выдача по картам ", Код, КурсОперации), 8, РасходРуб/*, 12, Расход*/ ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаСнятоСКартРуб( Код, РасходРуб, Расход, КурсОперации )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выдача по картам ", Код, КурсОперации), 4, РасходРуб/*, 12, Расход*/ ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаКонверсияРасходВалюты( Код, РасходРуб, РасходВал )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Конверсия: расх. ", Код), 8, РасходРуб/*, 12, РасходВал*/ ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПередачаРублевая( Расход, КодЦенности )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Сдано наличных денег ", "", "", КодЦенности), 4, Расход ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПередачаРублеваяПД( Расход, PayDoc_Ref, КодЦенности, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Сдано ПД:" + GetNamePayDoc( PayDoc_Ref ), "", "", КодЦенности), 4, Расход, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПолученоСправок( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено справок 0406007 "), 11, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПереданоСправок( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Передано справок 0406007 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаИзрасходованоСправок( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Израсходовано справок 0406007 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвращеноСправок( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возвращено справок 0406007 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПолученоСправок31( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Получено справок ф.31 "), 11, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаПереданоСправок31( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Передано справок ф.31 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаИзрасходованоСправок31( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Израсходовано справок ф.31 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвращеноСправок31( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возвращено справок ф.31 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
/* -----СТРОКИ ПРИХОДОВ/РАСХОДОВ ПО ИНКАССО И ЭКСПЕРТИЗЕ----- */
macro СтрокаПриемНаЭкспертизу( Код, ПриходРуб, Приход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием ин. вал. на экспертизу ", Код), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПриемНаИнкассо( Код, ПриходРуб, Приход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием ин. вал. на инкассо ", Код), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПриемПДНаЭкспертизу( Код, ПриходРуб, Приход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием ПД на экспертизу ", Код), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаПриемПДНаИнкассо( Код, ПриходРуб, Приход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Прием ПД на инкассо ", Код), 7, ПриходРуб, 11, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратСЭкспертизы( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ин. вал. с экспертизы ", Код), 8, РасходРуб, 12 , Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратСЭкспертизыРуб( Код, РасходРуб, Расход )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат с экспертизы наличных ", Код), 4, РасходРуб/*, 12, Расход*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратСИнкассо( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ин. вал. с инкассо ", Код), 8, РасходРуб, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратСИнкассоРуб( Код, РасходРуб, Расход )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат с инкассо наличных ", Код), 4, РасходРуб/*, 12, Расход*/ ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратПДСЭкспертизы( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ПД с экспертизы ", Код), 8, РасходРуб, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратПДСЭкспертизыРуб( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ПД с экспертизы ", Код), 4, РасходРуб, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратПДСИнкассо( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ПД с инкассо ", Код), 8, РасходРуб, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозвратПДСИнкассоРуб( Код, РасходРуб, Расход, Количество )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возврат ПД с инкассо ", Код), 4, РасходРуб, 12, Количество ) );
    println( РазделительСтрок_НОД() );
end;
/* --------СТРОКИ НЕДОСТАЧИ И ИЗЛИШКОВ---------- */
/*                 (валютные)                    */
macro СтрокаОбнаруженыИзлишкиВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружены излишки ин. вал. ", Код), 7, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженыИзлишкиПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружены излишки ПД ", Код), 7, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВыданыИзлишкиВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выданы излишки ин. вал. ", Код), 8, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВыданыИзлишкиПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выданы излишки ПД ", Код), 8, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженаНедостачаВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружена недостача ин. вал. ", Код), 8, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженаНедостачаПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружена недостача ПД ", Код), 8, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозмещенаНедостачаВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возмещена недостача ин. вал. ", Код), 7, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозмещенаНедостачаПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возмещена недостача ПД ", Код), 7, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
/*                 (рублевые)                    */
macro СтрокаОбнаруженыИзлишкиНацВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружены излишки наличных денег "), 3, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженыИзлишкиНацПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружены излишки ПД ", Код), 3, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВыданыИзлишкиНацВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выданы излишки наличных денег "), 4, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВыданыИзлишкиНацПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Выданы излишки ПД ", Код), 4, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженаНедостачаНацВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружена недостача наличных денег "), 4, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаОбнаруженаНедостачаНацПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Обнаружена недостача ПД ", Код), 4, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозмещенаНедостачаНацВал( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возмещена недостача наличных денег "), 3, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
macro СтрокаВозмещенаНедостачаНацПД( Код, Сумма )
    println( Строка_НомерСтрокиОД + СтрокаОД( Название(" Возмещена недостача ПД ", Код), 3, Сумма ) );
    println( РазделительСтрок_НОД() );
end;
/* -------------СТРОКИ ОСТАТКОВ----------------- */
macro СтрокаОстатокВалюты( Валюта, Сумма )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! ", Валюта), 8, Сумма) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокВалюты_Кол( Валюта, Сумма, КодЦенности, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! ", Валюта, "", КодЦенности), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНацВалюты( Валюта, Сумма )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! ", Валюта), 4, Сумма) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокВалютныхПД( СсылкаНаПД, Валюта, Сумма, КодЦенности, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! " + GetNamePayDoc(СсылкаНаПД) + " " + GetISOCurr( Валюта), "", "", КодЦенности ), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокБланковПД( СсылкаНаПД, Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! " + GetNameValForm(СсылкаНаПД) + " " + GetISOCurr( Валюта) ), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокВалютныхТраттов( Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Тратты " + GetISOCurr( Валюта) ), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНацВалПД( СсылкаНаПД, Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! " + GetNamePayDoc(СсылкаНаПД) + " " + GetISOCurr( Валюта) ), 4, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНацВалТраттов( Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Тратты " + GetISOCurr( Валюта) ), 4, Сумма, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокСправок( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! справки 0406007 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокСправок31( Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! справки ф.31 "), 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
/* -----------СТРОКИ НЕПЛ. ОСТАТКОВ--------------- */
macro СтрокаОстатокНеплатежВалюты( Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. ", Валюта), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНеплВалютныхПД( СсылкаНаПД, Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. " + GetNamePayDoc(СсылкаНаПД) + " " + GetISOCurr( Валюта) ), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНеплБланковПД( СсылкаНаПД, Валюта, Сумма )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. " + GetNameValForm(СсылкаНаПД) + " " + GetISOCurr( Валюта) ), 8, Сумма ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНеплВалютныхТраттов( Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. тратты " + GetISOCurr( Валюта) ), 8, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНеплНацВалПД( СсылкаНаПД, Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. " + GetNamePayDoc(СсылкаНаПД) + " " + GetISOCurr( Валюта) ), 4, Сумма, 12, Количество) );
 println( РазделительСтрок_НОД() );
end;
macro СтрокаОстатокНеплНацВалТраттов( Валюта, Сумма, Количество )
 println( Строка_НомерСтрокиОД + СтрокаОД( Название(" ОСТАТОК! Неплатеж. тратты " + GetISOCurr( Валюта) ), 4, Сумма, 12, Количество ) );
 println( РазделительСтрок_НОД() );
end;

/****************************************************************************/
/* Завершение секции процедур печатающих конкретные строки в ОД             */
/****************************************************************************/

/****************************************************************************/
/*   Процедура выводит в ОД все строки по конверсии валют                   */
/****************************************************************************/
MACRO ПечатьСуммКонверсий()
   var i = 0, КодВалюты, СуммаПрихода, СуммаРасхода;
   var КурсЦБ, КурсПокупки, КурсПродажи;
   While( i < TotalNumCurr )
      КодВалюты    = DiffCurr(i);
      СуммаПрихода = ConvIncSum( i*2 + 1 );
      СуммаРасхода = ConvOutSum( i*2 + 1 );
      ПолучитьКурсы( КодВалюты, КурсЦБ, КурсПокупки, КурсПродажи );
      if( СуммаПрихода )
         СтрокаКонверсияПриходВалюты( КодВалюты, money(СуммаПрихода * КурсЦБ), СуммаПрихода );
      end;
      if( СуммаРасхода )
         СтрокаКонверсияРасходВалюты( КодВалюты, money(СуммаРасхода * КурсЦБ), СуммаРасхода );
      end;
      i = i + 1;
   end;
END;

/****************************************************************************/
/* Процедура получает общие суммы для определенного вида операции           */
/****************************************************************************/
MACRO СуммыПокупкиПродажи( KindOper, КодВалюты, Сумма0, Сумма1, Сумма2, Сумма3, Сумма4, Сумма5, Сумма6, Сумма7, Сумма8, Сумма9, Сумма10, Empty, ПодохНалог, Количество, БезналКонв )
 var FindCurr   = ANY_CURR; /*для операций с неизвестной второй валютой*/
 var РасходЦБ, ПриходЦБ, Расход, Приход;
 var ПроцентнаяКомиссия, ПроцКомиссияВал=0, НомВал;
 var ФиксКомиссияРуб, ФиксКомиссияВал, ФиксКомиссияЦБ, НеКассовая = "";

 /* суммы ПРОДАЖИ валюты и ПД********************************************/
 if( (KindOper == CDF_OperCurrSale) OR (KindOper == CDF_OperPayDocSale) )
    /*РасходЦБ при продаже( по ЦБ-курсу )*/
    РасходЦБ = money( Reestr.CBRate * Reestr.OutSum );
    Сумма2   = Сумма2 + РасходЦБ;

    /*Приход при продаже (по курсу продажи)*/
    /*Приход   = money( Reestr.Rate * Reestr.OutSum );*/
    Приход   = Reestr.IncomeSum - Reestr.TaxSum - Reestr.IncTaxSum;

    Сумма0   = Сумма0 + Приход;

    /*Прибыль - разница между суммами продажи пересчитанными в разных курсах*/
    Сумма1   = Сумма1 + money( Abs( Приход - РасходЦБ ));
    /*РасходВал - расход валюты при продаже*/
    Сумма3   = Сумма3 + Reestr.OutSum;
    /*Налог - налог на продажу*/
    Сумма4   = Сумма4 + Reestr.TaxSum;
    ПодохНалог = ПодохНалог + Reestr.IncTaxSum;
    Количество = Количество + Reestr.OutQuantum;
  /*       /*ПроцентнаяКомиссия при продаже валюты*/
    Тип = ""; ПроцентнаяКомиссия = 0;
    Комиссия( ПроцентнаяКомиссия, Тип );
    if( Тип == "ОтВыданнойСуммы" )
       /*валютная процентная комиссия в валюте*/
       Сумма7 = Сумма7 + abs(ПроцентнаяКомиссия);
       ПроцКомиссияЦБ = abs(money( ПроцентнаяКомиссия * Reestr.CBRate ));
       /*валютная процентная комиссия в рублях по курсу ЦБ*/
       Сумма8 = Сумма8  + abs(ПроцКомиссияЦБ);
    end;
  */
 /* суммы ПОКУПКИ валюты и ПД*****************************************/
 elif( (KindOper == CDF_OperCurrBuy) OR (KindOper == CDF_OperPayDocBuy)
    OR (KindOper == CDF_OperUnpayCurrBuy) )
    /*ПроцентнаяКомиссия при покупке валюты*/
  /*       Тип = ""; ПроцентнаяКомиссия = 0;
    Комиссия( ПроцентнаяКомиссия, Тип );
    if( Тип == "ОтПолученнойСуммы" )
       /*на процентную комиссию рубли не тратятся!*/
       Reestr.IncomeSum = Reestr.IncomeSum - ПроцентнаяКомиссия;
       /*валютная процентная комиссия в валюте*/
       Сумма7 = Сумма7 + ПроцентнаяКомиссия;
       ПроцКомиссияЦБ = money( ПроцентнаяКомиссия * Reestr.CBRate );
       /*валютная процентная комиссия в рублях по курсу ЦБ*/
       Сумма8 = Сумма8 + ПроцКомиссияЦБ;
    end;
  */
    /*ПриходЦБ  (по ЦБ-курсу)*/
    ПриходЦБ = money( Reestr.CBRate * Reestr.IncomeSum );
    Сумма1   = Сумма1 + ПриходЦБ;

    /*Расход при покупке (по курсу покупки)*/
    /*Расход   = money( Reestr.Rate * Reestr.IncomeSum );*/
    Расход   = Reestr.OutSum + Reestr.IncTaxSum;

    Сумма0   = Сумма0 + Расход;
    /*СписаноЦБ (по ЦБ-курсу) - разница между суммами покупки пересчитанными в разных курсах*/
    Сумма2   = Сумма2 + money( Abs( ПриходЦБ - Расход ));
    /*ПриходВал - приход валюты при покупке*/
    Сумма3 = Сумма3 + Reestr.IncomeSum;
    ПодохНалог = ПодохНалог + Reestr.IncTaxSum;
    Количество = Количество + Reestr.IncomeQuantum;

 /* суммы КОНВЕРСИИ валюты************************************************/
 elif( (KindOper == CDF_OperCurrConversion) )
    /*Рублевая процентная комиссия при конверсии валюты*/
    if( (Reestr.IncomeCurr_Ref != {NationalCur}) AND
        (Reestr.OutCurr_Ref != {NationalCur})        )
       ПроцентнаяКомиссия = 0;
       ПолучитьПроцентнуюКомиссию( ANY_CURR, ПроцентнаяКомиссия, ПроцКомиссияВал );
       if( ПроцентнаяКомиссия )
          /*рублевая процентная комиссия*/
          Сумма7 = Сумма7 + ПроцентнаяКомиссия;
       end;
    end;
    /*Расход валюты при конверсии*/
    if( (НомВал = НомерЭлементаВМассиве( Reestr.OutCurr_Ref, ConvOutSum, 2 )) != -1 )
       /*увеличение валютной суммы для этой валюты*/
       ConvOutSum( НомВал + 1 ) = ConvOutSum( НомВал + 1 ) + Reestr.OutSum;
    else
       MsgBox("Неизвестная валюта в реестре конверсии!")
    end;
    /*Приход валюты при конверсии*/
    if( (НомВал = НомерЭлементаВМассиве( Reestr.IncomeCurr_Ref, ConvIncSum, 2 )) != -1 )
       /*увеличение валютной суммы для этой валюты*/
       ConvIncSum( НомВал + 1 ) = ConvIncSum( НомВал + 1 ) + Reestr.IncomeSum;
    else
       MsgBox("Неизвестная валюта в реестре конверсии!")
    end;
 /* ПОЛУЧЕННЫЕ валютные суммы по пластиковым картам ********************/
 /* ВЫДАННЫЕ валютные суммы по пластиковым картам **********************/
 /* ПОКУПКА/ПРОДАЖА ПД в валюте за валюту **************************************/
 elif( (KindOper == CDF_OperCardTake)       OR (KindOper == CDF_OperCardGive) OR
       (KindOper == CDF_OperPayDocSaleCurr) OR (KindOper == CDF_OperPayDocBuyCurr) )
     /*приход валюты*/
     Сумма0 = Сумма0 + Reestr.IncomeSum;
     Сумма2 = Сумма2 + money( Reestr.CBRate * Reestr.IncomeSum );
     /*расход валюты*/
     Сумма1 = Сумма1 + Reestr.OutSum;
     Сумма3 = Сумма3 + money( Reestr.CBRate * Reestr.OutSum );

     ПроцентнаяКомиссия = 0;
     ПолучитьПроцентнуюКомиссию( ANY_CURR, ПроцентнаяКомиссия, ПроцКомиссияВал, НеКассовая );
     if( ПроцентнаяКомиссия )
     /*рублевая процентная комиссия*/
        Сумма7 = Сумма7 + ПроцентнаяКомиссия;
        if(   (KindOper == CDF_OperCardTake)           AND
              (Reestr.IncomeCurr_Ref == {NationalCur}) AND
              (НеКассовая != "" ) )
          Сумма0 = Сумма0 - ПроцентнаяКомиссия;
          Сумма2 = Сумма2 - money( Reestr.CBRate * ПроцентнаяКомиссия );
        elif( (KindOper == CDF_OperCardGive)           AND
              (Reestr.OutCurr_Ref == {NationalCur})    AND
              (НеКассовая != "" ) )
          Сумма1 = Сумма1 + ПроцентнаяКомиссия;
          Сумма3 = Сумма3 + money( Reestr.CBRate * ПроцентнаяКомиссия );
        end;
     end;
     if(   KindOper == CDF_OperPayDocBuyCurr  )
       Количество = Количество + Reestr.IncomeQuantum;
     elif( KindOper == CDF_OperPayDocSaleCurr )
       Количество = Количество + Reestr.OutQuantum;
     end;

 /* Замена неплатежной валюты ******************************************/
 elif( KindOper == CDF_OperChange )
      /*приход валюты*/
     Сумма0 = Сумма0 + Reestr.IncomeSum;
     Сумма2 = Сумма2 + money( Reestr.CBRate * Reestr.IncomeSum );
     /*расход валюты*/
     Сумма1 = Сумма1 + Reestr.OutSum;
     Сумма3 = Сумма3 + money( Reestr.CBRate * Reestr.OutSum );

     ПроцентнаяКомиссия = 0;
     ПолучитьПроцентнуюКомиссию( КодВалюты, ПроцентнаяКомиссия, ПроцКомиссияВал );
     if( ПроцентнаяКомиссия )
     /*рублевая процентная комиссия*/
        Сумма7 = Сумма7 + ПроцентнаяКомиссия;
     end;
     /*валютная процентная комиссия*/
     if( ПроцКомиссияВал )
        Сумма10 = Сумма10 + ПроцКомиссияВал;
        Сумма0  = Сумма0  - ПроцКомиссияВал;
        Сумма2  = Сумма2  - money(ПроцКомиссияВал*Operat.CBRate);
     end;
     Количество = Количество + Reestr.IncomeQuantum;
 end;

 /* Фиксированная комиссия */
 ФиксКомиссияРуб = 0; ФиксКомиссияВал = 0;
 ПолучитьФиксированнуюКомиссию( КодВалюты, ФиксКомиссияРуб, ФиксКомиссияВал );
 /*Сумма5 = Сумма5 + ФиксКомиссияВал;*/
 ФиксКомиссияЦБ = money( ФиксКомиссияВал * Reestr.CBRate );
 /*Сумма6 = Сумма6 + ФиксКомиссияЦБ;*/
 Сумма9 = Сумма9 + ФиксКомиссияРуб;

 /* Рубли от безналичной конверсии */
 БезналКонв = БезналКонв + ПолучитьБезналКонв();

 SetParm( 2, Сумма0 ); SetParm( 3, Сумма1 );
 SetParm( 4, Сумма2 ); SetParm( 5, Сумма3 );
 SetParm( 6, Сумма4 );/*налог - только для продажи*/
 SetParm( 7, Сумма5 );/*валютная фиксированная комиссия*/
 SetParm( 8, Сумма6 );/*валютная фиксированная комиссия по курсу ЦБ*/
 SetParm( 9, Сумма7 );/*рублевая процентная комиссия*/
 SetParm(10, Сумма8 );/*валютная процентная комиссия по курсу ЦБ*/
 SetParm(11, Сумма9 );/*рублевая фиксированная комиссия*/
 SetParm(12, Сумма10);/*валютная процентная комиссия*/
 SetParm(13, ANY_CURR);/*не используется - нужно для однообразия параметров*/
 SetParm(14, ПодохНалог);/*подоходный налог*/
 SetParm(15, Количество);/*количество ценностей*/
 SetParm(16, БезналКонв);/*рублевая сумма по безналичной конверсии части выданной ценности*/

 return FindCurr; /*для операций с неизвестной второй валютой*/

END;

/****************************************************************************/
/* Процедура получает общие суммы для определенного вида операции,          */
/* НЕ ВХОДЯЩЕЙ в реестр                                                     */
/****************************************************************************/
MACRO СуммыОперацийВнеРеестров( KindOper, КодВалюты, Сумма0, Сумма1, Сумма2, Сумма3, Сумма4, Сумма5, Сумма6, Сумма7, Сумма8, Сумма9, Сумма10, Сумма11, Empty, Количество, БезналКонв )
 var FindCurr   = ANY_CURR; /*для операций с неизвестной второй валютой*/
 var OutCurr, IncCurr, Loop, РасходЦБ, ПриходЦБ, Расход, Приход, Колич = 0;
 var ПроцентнаяКомиссия=0, ПроцКомиссияВал=0, НомВал;
 var ФиксКомиссияРуб, ФиксКомиссияВал, ФиксКомиссияЦБ, ВалютаФиксКомиссии = ANY_CURR;

 ClearRecord(Operat);
 Operat.Emp_Ref        = Session.Emp_Ref;
 Operat.Sess_Ref       = Session.Number;
 Operat.Oper_Ref       = KindOper;
 Operat.State_Ref      = CDF_OperCompleted;/* завершена */
 Operat.Rate_Ref       = 0;

 /* принятие на инкассо и экспертизу */
 if( ( KindOper == CDF_OperExpert        ) OR
     ( KindOper == CDF_OperIncasso       ) OR
     ( KindOper == CDF_OperPayDocExpert  ) OR
     ( KindOper == CDF_OperPayDocIncasso ) )
    Operat.OutCurr_Ref    = OutCurr = ANY_CURR;
    Operat.IncomeCurr_Ref = IncCurr = КодВалюты;
 /* возврат с инкассо и экспертизы */
 elif( ( KindOper == CDF_OperReturnExpert      ) OR
     ( KindOper == CDF_OperReturnIncasso       ) OR
     ( KindOper == CDF_OperPayDocReturnExpert  ) OR
     ( KindOper == CDF_OperPayDocReturnIncasso ) )
    Operat.OutCurr_Ref    = OutCurr = КодВалюты;
    Operat.IncomeCurr_Ref = IncCurr = ANY_CURR;
 /* проверка на подлинность */
 elif( KindOper == CDF_OperCheck )
    Operat.OutCurr_Ref    = OutCurr = КодВалюты;
    Operat.IncomeCurr_Ref = IncCurr = КодВалюты;
 end;

 Loop = GetGE( Operat );

 While( ( Loop == True ) AND
        (Operat.Emp_Ref        == Session.Emp_Ref)         AND
        (Operat.Sess_Ref       == Session.Number)          AND
        ( ( Operat.State_Ref   == CDF_OperCompleted )  OR
          ( Operat.State_Ref   == CDF_OperInReestr  ) )    AND /*почему-то так случается*/
        (Operat.Oper_Ref       == KindOper)
      )

    if( (
          ( (OutCurr != ANY_CURR) AND (Operat.OutCurr_Ref == OutCurr) )  OR
          ( OutCurr == ANY_CURR )
        )
         AND
        (
          ( (IncCurr != ANY_CURR) AND (Operat.IncomeCurr_Ref == IncCurr) ) OR
          ( IncCurr == ANY_CURR )
        )
     )

      /* суммы при принятии на инкассо и экспертизу *************************/
      if( (KindOper == CDF_OperExpert       ) OR (KindOper == CDF_OperIncasso ) OR
          (KindOper == CDF_OperPayDocExpert ) OR (KindOper == CDF_OperPayDocIncasso ) )
          /* приход валюты */
          Сумма0 = Сумма0 + Operat.IncomeAmount;
          Сумма2 = Сумма2 + money( Operat.CBRate * Operat.IncomeAmount );
          /* расход валюты */
          Сумма1 = Сумма1 + Operat.OutAmount;
          Сумма3 = Сумма3 + money( Operat.CBRate * Operat.OutAmount );

          ПроцентнаяКомиссия = 0;
          ПолучитьПроцентнуюКомиссиюПоОперации( IncCurr, ПроцентнаяКомиссия, ПроцКомиссияВал );
          if( ПроцентнаяКомиссия )
          /* рублевая процентная комиссия */
             Сумма7 = Сумма7 + ПроцентнаяКомиссия;
          end;
          /* валютная процентная комиссия */
          if( ПроцКомиссияВал )
             Сумма10 = Сумма10 + ПроцКомиссияВал;
             Сумма0  = Сумма0  - ПроцКомиссияВал;
             Сумма2  = Сумма2  - money(ПроцКомиссияВал*Operat.CBRate);
          end;
          /* !!! Вообще-то нужен только приход */
          ПолучитьСтрокуСерийНомеровПД_2( Operat.ID, Колич );
          Количество = Количество + Колич;
      
      /* суммы при возврате с инкассо и экспертизы *************************/
      elif( (KindOper == CDF_OperReturnExpert       ) OR (KindOper == CDF_OperReturnIncasso ) OR
            (KindOper == CDF_OperPayDocReturnExpert ) OR (KindOper == CDF_OperPayDocReturnIncasso ) )
          /* приход валюты */
          Сумма0 = Сумма0 + Operat.IncomeAmount;
          Сумма2 = Сумма2 + money( Operat.CBRate * Operat.IncomeAmount );
          /* расход валюты */
          Сумма1 = Сумма1 + Operat.OutAmount;
          Сумма3 = Сумма3 + money( Operat.CBRate * Operat.OutAmount );

          ПроцентнаяКомиссия = 0;
          ПолучитьПроцентнуюКомиссиюПоОперации( OutCurr, ПроцентнаяКомиссия, ПроцКомиссияВал );
          if( ПроцентнаяКомиссия )
          /* рублевая процентная комиссия */
             Сумма7 = Сумма7 + ПроцентнаяКомиссия;
          end;
          /* валютная процентная комиссия */
          if( ПроцКомиссияВал )
             Сумма10 = Сумма10 + ПроцКомиссияВал;
             Сумма0  = Сумма0  - ПроцКомиссияВал;
             Сумма2  = Сумма2  - money(ПроцКомиссияВал*Operat.CBRate);
          end;
          /* !!! Вообще-то нужен только расход */
          ПолучитьСтрокуСерийНомеровПД_2( Operat.ID, Колич );
          Количество = Количество + Колич;

      /* Проверка на подлинность ******************************************/
      elif( KindOper == CDF_OperCheck )
          /* приход валюты */
          Сумма0 = Сумма0 + Operat.IncomeAmount;
          Сумма2 = Сумма2 + money( Operat.CBRate * Operat.IncomeAmount );
          /* расход валюты */
          Сумма1 = Сумма1 + Operat.OutAmount;
          Сумма3 = Сумма3 + money( Operat.CBRate * Operat.OutAmount );

          ПроцентнаяКомиссия = 0;
          ПолучитьПроцентнуюКомиссиюПоОперации( КодВалюты, ПроцентнаяКомиссия, ПроцКомиссияВал );
          if( ПроцентнаяКомиссия )
          /* рублевая процентная комиссия */
             Сумма7 = Сумма7 + ПроцентнаяКомиссия;
          end;
          /* валютная процентная комиссия */
          if( ПроцКомиссияВал )
             Сумма10 = Сумма10 + ПроцКомиссияВал;
             Сумма0  = Сумма0  - ПроцКомиссияВал;
             Сумма2  = Сумма2  - money(ПроцКомиссияВал*Operat.CBRate);
          end;
      end;


      /* Фиксированная комиссия */
      ФиксКомиссияРуб = 0; ФиксКомиссияВал = 0;
      ПолучитьФиксированнуюКомиссиюПоОперации( ВалютаФиксКомиссии, ФиксКомиссияРуб, ФиксКомиссияВал );
      /*Сумма5 = Сумма5 + ФиксКомиссияВал;*/
      ФиксКомиссияЦБ = money( ФиксКомиссияВал * Operat.CBRate );
      /*Сумма6 = Сумма6 + ФиксКомиссияЦБ;*/
      Сумма9 = Сумма9 + ФиксКомиссияРуб;

      /* Рубли от безналичной конверсии */
      БезналКонв = БезналКонв + ПолучитьБезналКонвПоОперации();

    end;

    Loop = Next( Operat );

 end;

 SetParm( 2, Сумма0 );/* полученная сумма в валюте */
 SetParm( 3, Сумма1 );/* выданная сумма в валюте   */
 SetParm( 4, Сумма2 );/* полученная сумма в рублях по курсу ЦБ */
 SetParm( 5, Сумма3 );/* выданная   сумма в рублях по курсу ЦБ */
 SetParm( 6, Сумма4 );/* налог - только для продажи */
 SetParm( 7, Сумма5 );/* валютная фиксированная комиссия */
 SetParm( 8, Сумма6 );/* валютная фиксированная комиссия по курсу ЦБ */
 SetParm( 9, Сумма7 );/* рублевая процентная комиссия */
 SetParm(10, Сумма8 );/* валютная процентная комиссия по курсу ЦБ */
 SetParm(11, Сумма9 );/* рублевая фиксированная комиссия */
 SetParm(12, Сумма10);/* валютная процентная комиссия */
 SetParm(13, ВалютаФиксКомиссии );
 SetParm(14, 0      );/* не используется - нужно для однообразия параметров*/
 SetParm(15, Количество);/* количество ценностей*/
 SetParm(16, БезналКонв);/*рублевая сумма по безналичной конверсии части выданной ценности*/

 return FindCurr; /* для операций с неизвестной второй валютой */

END;

/*RA 26-08-99****************************************************************/
/* Процедура выводит строки с итогами по покупке\продаже валют из реестров  */
/****************************************************************************/
MACRO ПокупкаПродажаВалютИзРеестров( OperType, КодВалюты, ПечататьКурс )

 var ПроцКомисЦБ,     ПроцКомисВал, ФиксКомисВал, ФиксКомисЦБ, Empty;
 var ПолученоНаКарты, СнятоСКарт,   ПолученоРуб,  СнятоРуб,    ВыданоРуб;
 var РасходРуб,       ПриходЦБ,     СписаноЦБ,    ПриходВал,   Количество;
 var ПриходРуб,       ПрибыльРуб,   РасходЦБ,     РасходВал,   Налог,    ПодохНалог;
 var БезналКонв;
 var КодВалФиксКомис = ANY_CURR, КурсОперации = 0;

 ПроцКомисЦБ     = 0; ПроцКомисВал = 0; ФиксКомисВал = 0; ФиксКомисЦБ = 0;
 ПолученоНаКарты = 0; СнятоСКарт   = 0; ПолученоРуб  = 0; СнятоРуб    = 0; ВыданоРуб = 0;
 Empty = 0;/* для заполнения ненужных параметров в вызове СуммыПокупкиПродажи */
 /* суммы операции покупки */
 РасходРуб = 0; ПриходЦБ   = 0; СписаноЦБ = 0; ПриходВал = 0;
 /* суммы операции продажи */
 ПриходРуб = 0; ПрибыльРуб = 0; РасходЦБ  = 0; РасходВал = 0; Налог = 0;
 /* при покупке и продаже */
 ПодохНалог = 0;
 /* кол-во ценностей */
 Количество = 0;
 /* рублевая сумма по безналичной конверсии части выданной ценности */
 БезналКонв = 0;

 if( ПечататьКурс )
    КурсОперации = Reestr.Rate;
 end;

 /* продажа ************************************************************/
 if( OperType == CDF_OperCurrSale )
    СуммыПокупкиПродажи( CDF_OperCurrSale,   КодВалюты, 
                                             ПриходРуб,    ПрибыльРуб,  РасходЦБ,     РасходВал,  Налог, 
                                             ФиксКомисВал, ФиксКомисЦБ, ПроцКомисВал, ПроцКомисЦБ, 
                                             ФиксКомисРуб, Empty,       Empty,        ПодохНалог, Количество,
                                             БезналКонв );
 elif( OperType == CDF_OperPayDocSale )
    СуммыПокупкиПродажи( CDF_OperPayDocSale, КодВалюты, 
                                             ПриходРуб,    ПрибыльРуб,  РасходЦБ,     РасходВал,   Налог,
                                             ФиксКомисВал, ФиксКомисЦБ, ПроцКомисВал, ПроцКомисЦБ,
                                             ФиксКомисРуб, Empty,       Empty,        ПодохНалог, Количество,
                                             БезналКонв );
 end;
 if( (РасходВал != 0) AND (OperType == CDF_OperCurrSale) )
    СтрокаПродажиВалюты( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации );
 end;
 if( (РасходВал != 0) AND (OperType == CDF_OperPayDocSale) )
    СтрокаПродажиПД( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество );
 end;
 /*
 if( ПрибыльРуб != 0 )
    СтрокаРазницыКпрод_ОК( ПрибыльРуб );
 end;
 */
 if( (Налог != 0) AND (OperType == CDF_OperCurrSale) )
    СтрокаНалогаНаПродажуВалюты( КодВалюты, Налог );
 end;
 if( (Налог != 0) AND (OperType == CDF_OperPayDocSale) )
    СтрокаНалогаНаПродажуПД( КодВалюты, Налог );
 end;
 if( (ПодохНалог != 0) AND (OperType == CDF_OperCurrSale) )
    СтрокаПодохНалогаНаПродажуВалюты( КодВалюты, ПодохНалог );
 end;
 if( (ПодохНалог != 0) AND (OperType == CDF_OperPayDocSale) )
    СтрокаПодохНалогаНаПродажуПД( КодВалюты, ПодохНалог );
 end;
 /*********************************************************************/

 /* покупка ***********************************************************/
 if( OperType == CDF_OperCurrBuy )
    СуммыПокупкиПродажи( CDF_OperCurrBuy,      КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, Налог, ФиксКомисВал, ФиксКомисЦБ, ПроцКомисВал, ПроцКомисЦБ, ФиксКомисРуб, Empty, Empty, ПодохНалог, Количество, БезналКонв );
 elif( OperType == CDF_OperUnpayCurrBuy )
    СуммыПокупкиПродажи( CDF_OperUnpayCurrBuy, КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, Налог, ФиксКомисВал, ФиксКомисЦБ, ПроцКомисВал, ПроцКомисЦБ, ФиксКомисРуб, Empty, Empty, ПодохНалог, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocBuy )
    СуммыПокупкиПродажи( CDF_OperPayDocBuy,    КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, Налог, ФиксКомисВал, ФиксКомисЦБ, ПроцКомисВал, ПроцКомисЦБ, ФиксКомисРуб, Empty, Empty, ПодохНалог, Количество, БезналКонв );
 end;
 if( (ПриходВал != 0) AND (OperType == CDF_OperCurrBuy) )
    СтрокаПокупкиВалюты( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации );
 end;
 if( (ПриходВал != 0) AND (OperType == CDF_OperUnpayCurrBuy) )
    СтрокаПокупкиНеплВалюты( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации, Количество );
 end;
 if( (ПриходВал != 0) AND (OperType == CDF_OperPayDocBuy) )
    СтрокаПокупкиПД( КодВалюты, РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, КурсОперации, Количество );
 end;
 /*
 if( СписаноЦБ != 0 )
    СтрокаРазницыКпок_ОК( СписаноЦБ );
 end;
 */
 if( (ПодохНалог != 0) AND (OperType == CDF_OperCurrBuy) )
    СтрокаПодохНалогаНаПокупкуВалюты( КодВалюты, ПодохНалог );
 end;
 if( (ПодохНалог != 0) AND (OperType == CDF_OperPayDocBuy) )
    СтрокаПодохНалогаНаПокупкуПД( КодВалюты, ПодохНалог );
 end;
 /********************************************************************/

 /* конверсия ********************************************************/
 if( OperType == CDF_OperCurrConversion )
    СуммыПокупкиПродажи( CDF_OperCurrConversion, КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, Налог,  ФиксКомисВал, ФиксКомисЦБ, ПроцКомисРуб, ПроцКомисЦБ, ФиксКомисРуб, Empty, Empty, Empty, Empty, БезналКонв );
 end;
 /*********************************************************************/

 /* снятие и принятие на пластиковые карточки *************************/
 if( OperType == CDF_OperCardTake )
    СуммыПокупкиПродажи( CDF_OperCardTake, КодВалюты, ПолученоНаКарты, Empty, ПолученоРуб, Empty, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, Empty, Empty, Empty, Empty, БезналКонв );
 elif( OperType == CDF_OperCardGive )
    СуммыПокупкиПродажи( CDF_OperCardGive, КодВалюты, Empty, СнятоСКарт, Empty, СнятоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, Empty, Empty, Empty, Empty, БезналКонв );
 end;
 if( ПолученоНаКарты )
    if( КодВалюты != {NationalCur} )
       СтрокаПолученоНаКартыВал( КодВалюты, ПолученоРуб, ПолученоНаКарты, КурсОперации );
    else
       СтрокаПолученоНаКартыРуб( КодВалюты, ПолученоРуб, ПолученоНаКарты, КурсОперации );
    end;
 end;
 if( СнятоСКарт )
    if( КодВалюты != {NationalCur} )
       СтрокаСнятоСКартВал( КодВалюты, СнятоРуб, СнятоСКарт, КурсОперации );
    else
       СтрокаСнятоСКартРуб( КодВалюты, СнятоРуб, СнятоСКарт, КурсОперации );
    end;
 end;
 /**********************************************************************/

 /* покупка и продажа ПД в ин. валюте за валюту ***********************/
 if( OperType == CDF_OperPayDocSaleCurr )
    СуммыПокупкиПродажи( CDF_OperPayDocSaleCurr, КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, Empty, Empty, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocBuyCurr )
    СуммыПокупкиПродажи( CDF_OperPayDocBuyCurr,  КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, Empty, Empty, Empty, Количество, БезналКонв );
 end;
 if( ( ПриходРуб ) AND ( OperType == CDF_OperPayDocSaleCurr ) )
    СтрокаПродажиПДЗаВал( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество );
 end;
 if( ( ПриходРуб ) AND ( OperType == CDF_OperPayDocBuyCurr ) )
    СтрокаОплатыПДВал( КодВалюты, ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, КурсОперации, Количество );
 end;
 /**********************************************************************/

 /* замена неплатежной валюты ******************************************/
 if( OperType == CDF_OperChange )
    СуммыПокупкиПродажи( CDF_OperChange, КодВалюты, ПриходВал, РасходВал, ПриходЦБ, РасходЦБ, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, Empty, Empty, Количество, БезналКонв );
 end;
 if( ( ПриходВал ) AND ( OperType == CDF_OperChange ) )
    СтрокаЗаменыНеплатВал( КодВалюты, ПриходЦБ, РасходЦБ, Количество );
 end;
 /**********************************************************************/

 if( ПроцКомисВал )
    СтрокаПроцКомиссииВал( КодВалюты, ПроцКомисЦБ, ПроцКомисВал );
 end;
 if( БезналКонв )
    СтрокаБезналКонв( БезналКонв );
 end;
 /* RA  1-04-99 теперь фиксированная комиссия считается отдельно - */
 /*             по валютам комиссии, а не по валютам операции
 if( ФиксКомисВал )
    СтрокаФиксКомисВал( КодВалФиксКомис, ФиксКомисЦБ, ФиксКомисВал );
 end;
 */

END;

/*RA 26-08-99****************************************************************/
/* Процедура выводит строки с итогами по покупке\продаже валют вне реестров */
/****************************************************************************/
MACRO ПокупкаПродажаВалютВнеРеестров( OperType, КодВалюты )

 var ПроцКомисЦБ, ПроцКомисВал, ФиксКомисВал, ФиксКомисЦБ, Empty;
 var ПолученоНаКарты, СнятоСКарт, ПолученоРуб, СнятоРуб, ВыданоРуб;
 var РасходРуб, ПриходЦБ, СписаноЦБ, ПриходВал, Количество;
 var ПриходРуб, ПрибыльРуб, РасходЦБ, РасходВал, Налог, ПодохНалог, БезналКонв;
 var КодВалФиксКомис = ANY_CURR;

 ПроцКомисЦБ = 0; ПроцКомисВал = 0; ФиксКомисВал = 0; ФиксКомисЦБ = 0;
 ПолученоНаКарты = 0; СнятоСКарт = 0; ПолученоРуб = 0; СнятоРуб = 0; ВыданоРуб = 0;
 Empty = 0;/* для заполнения ненужных параметров в вызове СуммыПокупкиПродажи */
 /* суммы операции покупки */
 РасходРуб = 0; ПриходЦБ   = 0; СписаноЦБ = 0; ПриходВал = 0;
 /* суммы операции продажи */
 ПриходРуб = 0; ПрибыльРуб = 0; РасходЦБ   = 0; РасходВал = 0; Налог = 0;
 /* при покупке и продаже */
 ПодохНалог = 0;
 /* кол-во ценностей */
 Количество = 0;
 /* рублевая сумма по безналичной конверсии части выданной ценности */
 БезналКонв = 0;

 /* прием на инкассо и экспертизу **************************************/
 if( OperType == CDF_OperExpert )
    СуммыОперацийВнеРеестров( CDF_OperExpert,        КодВалюты, ПриходВал, Empty, ПолученоРуб, Empty, Empty, Empty, Empty, ПроцКомисРуб, ПроцКомисЦБ, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocExpert )
    СуммыОперацийВнеРеестров( CDF_OperPayDocExpert,  КодВалюты, ПриходВал, Empty, ПолученоРуб, Empty, Empty, Empty, Empty, ПроцКомисРуб, ПроцКомисЦБ, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperIncasso )
    СуммыОперацийВнеРеестров( CDF_OperIncasso,       КодВалюты, ПриходВал, Empty, ПолученоРуб, Empty, Empty, Empty, Empty, ПроцКомисРуб, ПроцКомисЦБ, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocIncasso )
    СуммыОперацийВнеРеестров( CDF_OperPayDocIncasso, КодВалюты, ПриходВал, Empty, ПолученоРуб, Empty, Empty, Empty, Empty, ПроцКомисРуб, ПроцКомисЦБ, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 end;
 if( ( ПриходВал != 0 ) AND ( OperType == CDF_OperExpert ) )
    СтрокаПриемНаЭкспертизу( КодВалюты, ПолученоРуб, ПриходВал, Количество );
 end;
 if( ( ПриходВал != 0 ) AND ( OperType == CDF_OperPayDocExpert ) )
    СтрокаПриемПДНаЭкспертизу( КодВалюты, ПолученоРуб, ПриходВал, Количество );
 end;
 if( ( ПриходВал != 0 ) AND ( OperType == CDF_OperIncasso ) )
    СтрокаПриемНаИнкассо( КодВалюты, ПолученоРуб, ПриходВал, Количество );
 end;
 if( ( ПриходВал != 0 ) AND ( OperType == CDF_OperPayDocIncasso ) )
    СтрокаПриемПДНаИнкассо( КодВалюты, ПолученоРуб, ПриходВал, Количество );
 end;
 /**********************************************************************/

 /* возврат с инкассо и экспертизы *************************************/
 if( OperType == CDF_OperReturnExpert )
    СуммыОперацийВнеРеестров( CDF_OperReturnExpert,        КодВалюты, Empty, РасходВал, Empty, ВыданоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocReturnExpert )
    СуммыОперацийВнеРеестров( CDF_OperPayDocReturnExpert,  КодВалюты, Empty, РасходВал, Empty, ВыданоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperReturnIncasso )
    СуммыОперацийВнеРеестров( CDF_OperReturnIncasso,       КодВалюты, Empty, РасходВал, Empty, ВыданоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 elif( OperType == CDF_OperPayDocReturnIncasso )
    СуммыОперацийВнеРеестров( CDF_OperPayDocReturnIncasso, КодВалюты, Empty, РасходВал, Empty, ВыданоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 end;
 if( ( РасходВал != 0 ) AND ( OperType == CDF_OperReturnExpert ) )
    if( КодВалюты != {NationalCur} )
      СтрокаВозвратСЭкспертизы( КодВалюты, ВыданоРуб, РасходВал, Количество );
    else
      СтрокаВозвратСЭкспертизыРуб( КодВалюты, ВыданоРуб, РасходВал );
    end;
 end;
 if( ( РасходВал != 0 ) AND ( OperType == CDF_OperPayDocReturnExpert ) )
    if( КодВалюты != {NationalCur} )
      СтрокаВозвратПДСЭкспертизы( КодВалюты, ВыданоРуб, РасходВал, Количество );
    else
      СтрокаВозвратПДСЭкспертизыРуб( КодВалюты, ВыданоРуб, РасходВал, Количество );
    end;
 end;
 if( ( РасходВал != 0 ) AND ( OperType == CDF_OperReturnIncasso ) )
    if( КодВалюты != {NationalCur} )
      СтрокаВозвратСИнкассо( КодВалюты, ВыданоРуб, РасходВал, Количество );
    else
      СтрокаВозвратСИнкассоРуб( КодВалюты, ВыданоРуб, РасходВал );
    end;
 end;
 if( ( РасходВал != 0 ) AND ( OperType == CDF_OperPayDocReturnIncasso ) )
    if( КодВалюты != {NationalCur} )
      СтрокаВозвратПДСИнкассо( КодВалюты, ВыданоРуб, РасходВал, Количество );
    else
      СтрокаВозвратПДСИнкассоРуб( КодВалюты, ВыданоРуб, РасходВал, Количество );
    end;
 end;
 /**********************************************************************/

 /* проверка на подлинность ********************************************/
 if( OperType == CDF_OperCheck )
   СуммыОперацийВнеРеестров( CDF_OperCheck, КодВалюты, ПриходВал, РасходВал, ПолученоРуб, ВыданоРуб, Empty, Empty, Empty, ПроцКомисРуб, Empty, ФиксКомисРуб, ПроцКомисВал, КодВалФиксКомис, Empty, Количество, БезналКонв );
 end;
 if( ( ПриходВал != 0 ) AND ( OperType == CDF_OperCheck ) )
   СтрокаПроверкаНаПодлинность( КодВалюты, ПолученоРуб, ВыданоРуб, ПриходВал, РасходВал );
 end;
 /**********************************************************************/

 if( ПроцКомисВал )
    СтрокаПроцКомиссииВал( КодВалюты, ПроцКомисЦБ, ПроцКомисВал );
 end;

 if( БезналКонв )
    СтрокаБезналКонв( БезналКонв );
 end;

END;

MACRO Фильтр( TypeReestr, IncCurr, OutCurr )
 if( (Reestr.ExchangeNumber  == office.ID)               AND
     (Reestr.Emp_Ref         == Session.Emp_Ref)         AND
     (Reestr.Sess_Ref        == Session.Number )         AND
     ( Reestr.Type_Ref       == TypeReestr )             AND
     (
        ( (OutCurr != ANY_CURR) AND (Reestr.OutCurr_Ref == OutCurr) )  OR
        ( OutCurr == ANY_CURR )
     )
       AND
     (
        ( (IncCurr != ANY_CURR) AND (Reestr.IncomeCurr_Ref == IncCurr) ) OR
        ( IncCurr == ANY_CURR )
     )
 )
   return TRUE;
 else
   return FALSE;
 end;
END;

/****************************************************************************/
/* Процедура выводит строки с итогами по покупке\продаже валют              */
/****************************************************************************/
MACRO ПокупкаПродажаВалют( KindOper, КодВалюты )

 var TypeReestr = GetTypeReestr(KindOper);
 var OutCurr, IncCurr, Loop, ПечататьКурс = False;
 if( ( (КодВалюты != {NationalCur}) OR
     (KindOper == CDF_OperCardGive) OR
     (KindOper == CDF_OperCardTake) OR
     (KindOper == CDF_OperReturnIncasso) OR
     (KindOper == CDF_OperPayDocExpert ) OR
     (KindOper == CDF_OperPayDocReturnIncasso) OR
     (KindOper == CDF_OperPayDocReturnExpert ) )
     AND (КодВалюты != ANY_CURR) )

    ПокупкаПродажаВалютВнеРеестров( KindOper, КодВалюты );

    /* А теперь по реестрам */

    ClearRecord( Reestr );
    Reestr.ExchangeNumber = office.ID;
    Reestr.Emp_Ref        = Session.Emp_Ref;
    Reestr.Sess_Ref       = Session.Number;
    Reestr.Type_Ref       = TypeReestr;

    /* покупка валюты, ПД и неплатежеспособной валюты */
    if( (KindOper == CDF_OperCurrBuy) OR (KindOper == CDF_OperPayDocBuy) OR
        (KindOper == CDF_OperUnpayCurrBuy) )
       Reestr.OutCurr_Ref    = OutCurr = {NationalCur};
       Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
    /* продажа валюты и ПД за рубли */
    elif( (KindOper == CDF_OperCurrSale) OR (KindOper == CDF_OperPayDocSale) )
       Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
       Reestr.IncomeCurr_Ref = IncCurr = {NationalCur};
    /* покупка/продажа ПД за валюту */
    elif( ( KindOper == CDF_OperPayDocSaleCurr ) OR ( KindOper == CDF_OperPayDocBuyCurr ) )
       Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
       Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
    /* конверсия */
    elif( KindOper == CDF_OperCurrConversion )
       Reestr.OutCurr_Ref    = OutCurr = ANY_CURR;
       Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
    /* выдача по пластиковым картам */
    elif( KindOper == CDF_OperCardGive )
       Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
       Reestr.IncomeCurr_Ref = IncCurr = ANY_CURR;
    /* получение по пластиковым картам */
    elif( KindOper == CDF_OperCardTake )
       Reestr.OutCurr_Ref    = OutCurr = ANY_CURR;
       Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
    /* замена неплатежной валюты */
    elif( KindOper == CDF_OperChange )
       Reestr.OutCurr_Ref    = OutCurr = КодВалюты;
       Reestr.IncomeCurr_Ref = IncCurr = КодВалюты;
    end;
   
    Reestr.Rate_Ref       = 0;
   
    Loop = GetGE( Reestr );

    if( Loop == True )
      GetPos( Reestr );
      if( Next( Reestr ) AND Фильтр( TypeReestr, IncCurr, OutCurr ) )
          ПечататьКурс = True;
      end;
      GetDirect( Reestr );
    end;

    While( (Loop == True) )
      if( Фильтр( TypeReestr, IncCurr, OutCurr ) )
        /*УчетНекассовыхОборотов( "По реестру", Reestr.IncomeSum, Reestr.OutSum );*/
        ПокупкаПродажаВалютИзРеестров( KindOper, КодВалюты, ПечататьКурс );
      end;
      Loop = Next( Reestr );
    end;

 end;
END;

/****************************************************************************/
/* Процедура печатает строки по авансу/передаче/возврату ценностей          */
/****************************************************************************/
MACRO Суммы_Передач( КодВалюты, тип, СуммаРуб, Сумма, ПризнакПечати )
  var OutCurr_Ref, IncomeCurr_Ref, TypeOperation, Loop, PayDoc_Ref;
  var КурсЦБ, КурсПокупки, КурсПродажи, СуммуРуб, Количество;
  if( тип == "Аванс" )
     OutCurr_Ref    = ANY_CURR;
     IncomeCurr_Ref = КодВалюты;
     TypeOperation = CDF_OperAvance;
  elif( тип == "Передача" )
     OutCurr_Ref    = КодВалюты;
     IncomeCurr_Ref = ANY_CURR;
     TypeOperation = CDF_OperTransfer;
  elif( тип == "Возврат" )
     OutCurr_Ref    = КодВалюты;
     IncomeCurr_Ref = ANY_CURR;
     TypeOperation = CDF_OperCashOut;
  end;
  Operat.OutCurr_Ref    = OutCurr_Ref;
  Operat.IncomeCurr_Ref = IncomeCurr_Ref;
  Operat.Emp_Ref        = Session.Emp_Ref;
  Operat.Sess_Ref       = Session.Number;;
  Operat.Oper_Ref       = TypeOperation;
  Operat.State_Ref      = CDF_OperCompleted;/* завершена     */
  Operat.Rate_Ref       = 0;

  Loop = GetEQ( Operat );
  While( (Loop == True) AND
         (Operat.Emp_Ref        == Session.Emp_Ref)         AND
         (Operat.Sess_Ref       == Session.Number)          AND
         ( (Operat.State_Ref    == CDF_OperCompleted) OR
           (Operat.State_Ref    == CDF_OperInReestr)   )    AND
         (Operat.Rate_Ref       == 0)                       AND
         (Operat.OutCurr_Ref    == OutCurr_Ref)             AND
         (Operat.IncomeCurr_Ref == IncomeCurr_Ref)          AND
         (Operat.Oper_Ref       == TypeOperation)
       )
     /* наложение структуры avanceop на поле Oper.ExtInfo */
     SetRecordAddr( avanceop, Operat, 0, FldOffset( Operat,"ExtInfo"),True);
     PayDoc_Ref = avanceop.PayDoc_Ref;
     ПолучитьСтрокуСерийНомеровПД_2( Operat.ID, Количество );
     if( тип == "Аванс" )
        СуммаРуб = /*СуммаРуб + */Money(Operat.IncomeAmount * Operat.CBRate);
        Сумма    = /*Сумма    + */Operat.IncomeAmount;
        if( ПризнакПечати == True )
           if( (КодВалюты == {NationalCur}) AND (Сумма != 0) )
               if( (Operat.IncomeTrs_Ref == TrsCash       ) OR
                   (Operat.IncomeTrs_Ref == TrsMonet      ) OR
                   (Operat.IncomeTrs_Ref == TrsIncassCash ) OR
                   (Operat.IncomeTrs_Ref == TrsIncassMonet) OR
                   (Operat.IncomeTrs_Ref == TrsExpertCash ) OR
                   (Operat.IncomeTrs_Ref == TrsExpertMonet)
                 )
                  СтрокаАвансРублевый( Сумма, Operat.IncomeTrs_Ref );
               elif( ( Operat.IncomeTrs_Ref == TrsValForm ) AND
                     ( PayDoc_Ref != 0 )
                   )
                  СтрокаАвансБланковПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.IncomeTrs_Ref, Количество );
               else
                  СтрокаАвансРублевыйПД( Сумма, PayDoc_Ref, Operat.IncomeTrs_Ref, Количество );
               end;
           elif( (Сумма != 0) AND (СуммаРуб != 0) )
               if( (Operat.IncomeTrs_Ref == TrsCash       ) OR
                   (Operat.IncomeTrs_Ref == TrsMonet      ) OR
                   (Operat.IncomeTrs_Ref == TrsIncassCash ) OR
                   (Operat.IncomeTrs_Ref == TrsIncassMonet) OR
                   (Operat.IncomeTrs_Ref == TrsExpertCash ) OR
                   (Operat.IncomeTrs_Ref == TrsExpertMonet)
                 )
                  СтрокаАвансВалюты( КодВалюты, СуммаРуб, Сумма, Operat.IncomeTrs_Ref );
               elif( ( Operat.IncomeTrs_Ref == TrsValForm ) AND
                     ( PayDoc_Ref != 0 )
                   )
                  СтрокаАвансБланковПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.IncomeTrs_Ref, Количество );
               else
                  СтрокаАвансВалютыПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.IncomeTrs_Ref, Количество );
               end;
           end;
        end;
     elif( (тип == "Передача") OR (тип == "Возврат") )
        СуммаРуб = /*СуммаРуб + */Money(Operat.OutAmount * Operat.CBRate);
        Сумма    = /*Сумма    + */Operat.OutAmount;
        if( ПризнакПечати == True )
           if( (КодВалюты == {NationalCur}) AND (Сумма) )
              if( (Operat.OutTrs_Ref == TrsCash       ) OR
                  (Operat.OutTrs_Ref == TrsMonet      ) OR
                  (Operat.OutTrs_Ref == TrsIncassCash ) OR
                  (Operat.OutTrs_Ref == TrsIncassMonet) OR
                  (Operat.OutTrs_Ref == TrsExpertCash ) OR
                  (Operat.OutTrs_Ref == TrsExpertMonet)
                )
                 СтрокаПередачаРублевая( Сумма, Operat.OutTrs_Ref );
              elif( ( Operat.OutTrs_Ref == TrsValForm ) AND
                     ( PayDoc_Ref != 0 )
                   )              
                 СтрокаПереданоБланковПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.OutTrs_Ref, Количество );
              else
                 СтрокаПередачаРублеваяПД( Сумма, PayDoc_Ref, Operat.OutTrs_Ref, Количество );
              end;
           elif( (Сумма) AND (СуммаРуб) )
              if( (Operat.OutTrs_Ref == TrsCash       ) OR
                  (Operat.OutTrs_Ref == TrsMonet      ) OR
                  (Operat.OutTrs_Ref == TrsIncassCash ) OR
                  (Operat.OutTrs_Ref == TrsIncassMonet) OR
                  (Operat.OutTrs_Ref == TrsExpertCash ) OR
                  (Operat.OutTrs_Ref == TrsExpertMonet)
                )
                 СтрокаПереданоВалюты( КодВалюты, СуммаРуб, Сумма, Operat.OutTrs_Ref );
               elif( ( Operat.OutTrs_Ref == TrsValForm ) AND
                     ( PayDoc_Ref != 0 )
                   )              
                 СтрокаПереданоБланковПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.OutTrs_Ref, Количество );
              else
                 СтрокаПереданоВалютыПД( КодВалюты, СуммаРуб, Сумма, PayDoc_Ref, Operat.OutTrs_Ref, Количество );
              end;
           end;
        end;
     end;
     /* смотрим операции только в пределах одной рабочей смены */
     if( Operat.Sess_Ref == Session.Number )
        Loop = Next( Operat );
     else
        Loop = False;
     end;
  end;
  SetParm( 2, СуммаРуб );
  SetParm( 3, Сумма );
END;
/****************************************************************************/
/* Процедура печатает строки по авансу/передаче/возврату справок БСО        */
/****************************************************************************/
MACRO Суммы_ПередачСправокБСО( тип )
  var OutCurr_Ref    = ANY_CURR, TypeOperation, Loop, Количество;
  var IncomeCurr_Ref = ANY_CURR;
  if( тип == "Аванс" )
     TypeOperation  = CDF_OperAvance;
  elif( тип == "Передача" )
     TypeOperation = CDF_OperTransfer;
  elif( тип == "Возврат" )
     TypeOperation = CDF_OperCashOut;
  end;
  Operat.OutCurr_Ref    = OutCurr_Ref;
  Operat.IncomeCurr_Ref = IncomeCurr_Ref;
  Operat.Emp_Ref        = Session.Emp_Ref;
  Operat.Sess_Ref       = Session.Number;
  Operat.Oper_Ref       = TypeOperation;
  Operat.State_Ref      = CDF_OperCompleted;/* завершена */
  Operat.Rate_Ref       = 0;

  Loop = GetEQ( Operat );
  While( (Loop == True) AND
         (Operat.Emp_Ref        == Session.Emp_Ref)         AND
         (Operat.Sess_Ref       == Session.Number)          AND
         ( (Operat.State_Ref    == CDF_OperCompleted) OR
           (Operat.State_Ref    == CDF_OperInReestr)   )    AND
         (Operat.Rate_Ref       == 0)                       AND
         (Operat.OutCurr_Ref    == OutCurr_Ref)             AND
         (Operat.IncomeCurr_Ref == IncomeCurr_Ref)          AND
         (Operat.Oper_Ref       == TypeOperation)
       )
     /* наложение структуры avanceop на поле Oper.ExtInfo */
     SetRecordAddr( avanceop, Operat, 0, FldOffset( Operat,"ExtInfo"),True);
     Количество = avanceop.SprAmountIn;
     /*для корректного суммирования столбцов ОД*/
     /*Количество = money( Количество * 100 );*//* теперь суммируется количество ценностей  RA 20-05-00 */
     if( Количество )
        if  ( тип == "Аванс"    )
             ОбщКолАвансБСО = ОбщКолАвансБСО + Количество;
        elif( тип == "Передача" )
             СтрокаПереданоСправок( Количество );
        elif( тип == "Возврат"  )
             СтрокаВозвращеноСправок( Количество );
        end;
     end;
     /*смотрим операции только в пределах одной рабочей смены*/
     if( Operat.Sess_Ref == Session.Number )
        Loop = Next( Operat );
     else
        Loop = False;
     end;
  end;
END;
/****************************************************************************/
/* Процедура печатает строки по авансу/передаче/возврату справок F31        */
/****************************************************************************/
MACRO Суммы_ПередачСправокF31( тип )
  var OutCurr_Ref    = ANY_CURR, TypeOperation, Loop, Количество;
  var IncomeCurr_Ref = ANY_CURR;
  if( тип == "Аванс" )
     TypeOperation  = CDF_OperAvance;
  elif( тип == "Передача" )
     TypeOperation = CDF_OperTransfer;
  elif( тип == "Возврат" )
     TypeOperation = CDF_OperCashOut;
  end;
  Operat.OutCurr_Ref    = OutCurr_Ref;
  Operat.IncomeCurr_Ref = IncomeCurr_Ref;
  Operat.Emp_Ref        = Session.Emp_Ref;
  Operat.Sess_Ref       = Session.Number;
  Operat.Oper_Ref       = TypeOperation;
  Operat.State_Ref      = CDF_OperCompleted;/* завершена */
  Operat.Rate_Ref       = 0;

  Loop = GetEQ( Operat );
  While( (Loop == True) AND
         (Operat.Emp_Ref        == Session.Emp_Ref)         AND
         (Operat.Sess_Ref       == Session.Number)          AND
         ( (Operat.State_Ref    == CDF_OperCompleted) OR
           (Operat.State_Ref    == CDF_OperInReestr)   )    AND
         (Operat.Rate_Ref       == 0)                       AND
         (Operat.OutCurr_Ref    == OutCurr_Ref)             AND
         (Operat.IncomeCurr_Ref == IncomeCurr_Ref)          AND
         (Operat.Oper_Ref       == TypeOperation)
       )
     /* наложение структуры avanceop на поле Oper.ExtInfo */
     SetRecordAddr( avanceop, Operat, 0, FldOffset( Operat,"ExtInfo"),True);
     Количество = avanceop.Spr31AmountIn;
     /*для корректного суммирования столбцов ОД*/
     /*Количество = money( Количество * 100 );*//* теперь суммируется количество ценностей  RA 20-05-00 */
     if( Количество )
        if  ( тип == "Аванс"    )
             ОбщКолАвансF31 = ОбщКолАвансF31 + Количество;
        elif( тип == "Передача" )
             СтрокаПереданоСправок31( Количество );
        elif( тип == "Возврат"  )
             СтрокаВозвращеноСправок31( Количество );
        end;
     end;
     /*смотрим операции только в пределах одной рабочей смены*/
     if( Operat.Sess_Ref == Session.Number )
        Loop = Next( Operat );
     else
        Loop = False;
     end;
  end;
END;

/****************************************************************************/
/*Процедура печатает строку с общими суммами по операциям передачи ценностей*/
/****************************************************************************/
MACRO СтрокаПоПередачеЦенностей( тип, КодВалюты )
   var СуммаРуб, Сумма;
   if( тип == "Аванс" )
      СуммаРуб = 0; Сумма = 0;
      Суммы_Передач( КодВалюты, "Аванс",  СуммаРуб, Сумма, True );
      /*if( (КодВалюты == {NationalCur}) AND (Сумма != 0) )*/
      /*      СтрокаАвансРублевый( Сумма );                */
      /*elif( (Сумма != 0) AND (СуммаРуб != 0) )           */
      /*   СтрокаАвансВалюты( КодВалюты, СуммаРуб, Сумма );*/
      /*end;                                               */
   else
      СуммаРуб = 0; Сумма = 0;
      Суммы_Передач( КодВалюты, "Передача", СуммаРуб, Сумма, True );
      СуммаРуб = 0; Сумма = 0;
      Суммы_Передач( КодВалюты, "Возврат",  СуммаРуб, Сумма, True );
      /*if( (КодВалюты == {NationalCur}) AND (Сумма) )        */
      /*   СтрокаПередачаРублевая( Сумма );                   */
      /*elif( (Сумма) AND (СуммаРуб) )                        */
      /*   СтрокаПереданоВалюты( КодВалюты, СуммаРуб, Сумма );*/
      /*end;                                                  */
   end;
END;
/****************************************************************************/
/* Процедура выводит строки с итогами операций учета недостачи и излишков   */
/****************************************************************************/
MACRO Недостачи_и_Излишки( тип, КодВалюты )

  var IncomeCurr_Ref = ANY_CURR,
      OutCurr_Ref    = ANY_CURR,
      TrsGroup,
      Loop,
      Amount,
      CurrAmount   = 0, /* всего наличных по данной валюте */
      PayDocAmount = 0; /* всего пл. док. по данной валюте */

  if(   ( тип == CDF_OperDetectOverplus  ) OR ( тип == CDF_OperCompensateDeficit ) )
    IncomeCurr_Ref = КодВалюты;
  elif( ( тип == CDF_OperGiveOutOverplus ) OR ( тип == CDF_OperDetectDeficit  ) )
    OutCurr_Ref    = КодВалюты;
  end;

  Operat.Emp_Ref        = Session.Emp_Ref;
  Operat.Sess_Ref       = Session.Number;
  Operat.Oper_Ref       = тип;
  Operat.State_Ref      = CDF_OperCompleted;/* завершена */
  Operat.Rate_Ref       = 0;
  Operat.OutCurr_Ref    = OutCurr_Ref;
  Operat.IncomeCurr_Ref = IncomeCurr_Ref;

  Loop = GetGE( Operat );
  While( (Loop == True) AND
         (Operat.Emp_Ref        == Session.Emp_Ref)         AND
         (Operat.Sess_Ref       == Session.Number)          AND
         (Operat.Oper_Ref       == тип)                     AND
         ( (Operat.State_Ref    == CDF_OperCompleted) OR
           (Operat.State_Ref    == CDF_OperInReestr)   )    
       )
       
    if ( (Operat.OutCurr_Ref    == OutCurr_Ref)             AND
         (Operat.IncomeCurr_Ref == IncomeCurr_Ref)         
       )

      /* наложение структуры deficit на поле Oper.ExtInfo */
      SetRecordAddr( deficitop, Operat, 0, FldOffset( Operat,"ExtInfo"),True);
      TrsGroup = deficitop.TrsGroup;

      if(   ( тип == CDF_OperDetectOverplus  ) OR ( тип == CDF_OperCompensateDeficit ) )
        Amount = Operat.IncomeAmount;
      elif( ( тип == CDF_OperGiveOutOverplus ) OR ( тип == CDF_OperDetectDeficit  ) )
        Amount = Operat.OutAmount;
      end;

      if( ( TrsGroup == TrsNoteGrp       ) OR
          ( TrsGroup == TrsIncassNoteGrp ) OR
          ( TrsGroup == TrsExpertNoteGrp ) )
        CurrAmount   = CurrAmount   + Amount;
      elif( ( TrsGroup == TrsPayDoc       ) OR ( TrsGroup == TrsTratt       ) OR
            ( TrsGroup == TrsIncassPayDoc ) OR ( TrsGroup == TrsIncassTratt ) OR
            ( TrsGroup == TrsExpertPayDoc ) OR ( TrsGroup == TrsExpertTratt )  )
        PayDocAmount = PayDocAmount + Amount;
      end;

    end;

    Loop = Next( Operat );
  end;

  /* печать строк дневника для нац. валюты */
  if( КодВалюты == {NationalCur} )     
    if( тип == CDF_OperDetectOverplus )
      if( CurrAmount   != 0 ) СтрокаОбнаруженыИзлишкиНацВал(   КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаОбнаруженыИзлишкиНацПД(    КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperGiveOutOverplus )
      if( CurrAmount   != 0 ) СтрокаВыданыИзлишкиНацВал(       КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаВыданыИзлишкиНацПД(        КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperDetectDeficit )                                  
      if( CurrAmount   != 0 ) СтрокаОбнаруженаНедостачаНацВал( КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаОбнаруженаНедостачаНацПД(  КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperCompensateDeficit )
      if( CurrAmount   != 0 ) СтрокаВозмещенаНедостачаНацВал(  КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаВозмещенаНедостачаНацПД(   КодВалюты, PayDocAmount ); end;
    end;

  /* печать строк дневника для ин. валюты */
  else
    CurrAmount   = money(CurrAmount   * Operat.CBRate);
    PayDocAmount = money(PayDocAmount * Operat.CBRate);

    if( тип == CDF_OperDetectOverplus )
      if( CurrAmount   != 0 ) СтрокаОбнаруженыИзлишкиВал(   КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаОбнаруженыИзлишкиПД(    КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperGiveOutOverplus )
      if( CurrAmount   != 0 ) СтрокаВыданыИзлишкиВал(       КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаВыданыИзлишкиПД(        КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperDetectDeficit )                                  
      if( CurrAmount   != 0 ) СтрокаОбнаруженаНедостачаВал( КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаОбнаруженаНедостачаПД(  КодВалюты, PayDocAmount ); end;
    elif( тип == CDF_OperCompensateDeficit )
      if( CurrAmount   != 0 ) СтрокаВозмещенаНедостачаВал(  КодВалюты, CurrAmount   ); end;
      if( PayDocAmount != 0 ) СтрокаВозмещенаНедостачаПД(   КодВалюты, PayDocAmount ); end;
    end;

  end;

END;
/****************************************************************************/
/*процедура формирует строку об остатке справок БСО для ОД                  */
/*  параметром принимает кол-во израсходованных справок                     */
/****************************************************************************/
MACRO ОстатокСправокБСО( NumDebetSprv )
  var NumAvanceSprv   = Int(CalcTransferBSO(Session.Emp_Ref,Session.Number,CDF_OperAvance));
  var NumTransferSprv = Int(CalcTransferBSO(Session.Emp_Ref,Session.Number,CDF_OperTransfer));
  var NumReturnSprv   = Int(CalcTransferBSO(Session.Emp_Ref,Session.Number,CDF_OperCashOut));
 /*
 /*остаток справок*/
 var NumRestSprv = Double(NumAvanceSprv - NumReturnSprv - NumTransferSprv) - Double(NumDebetSprv);
 /*для корректного суммирования*/
 NumRestSprv  = money(NumRestSprv * 100.);
 */
 /* теперь суммируется количество ценностей  RA 20-05-00 */
 var NumRestSprv = (NumAvanceSprv - NumReturnSprv - NumTransferSprv) - (NumDebetSprv);
 /*печать результатов в ОД*/
 if( NumRestSprv )
    СтрокаОстатокСправок( NumRestSprv );
 end;
END;
/****************************************************************************/
/*процедура формирует строку об остатке справок F31 для ОД                  */
/*  параметром принимает кол-во израсходованных справок                     */
/****************************************************************************/
MACRO ОстатокСправокF31( NumDebetSprv )
  var NumAvanceSprv   = Int(CalcTransferF31(Session.Emp_Ref,Session.Number,CDF_OperAvance));
  var NumTransferSprv = Int(CalcTransferF31(Session.Emp_Ref,Session.Number,CDF_OperTransfer));
  var NumReturnSprv   = Int(CalcTransferF31(Session.Emp_Ref,Session.Number,CDF_OperCashOut));
 /*
 /*остаток справок*/
 var NumRestSprv = Double(NumAvanceSprv - NumReturnSprv - NumTransferSprv) - Double(NumDebetSprv);
 /*для корректного суммирования*/
 NumRestSprv  = money(NumRestSprv * 100.);
 */
 /* теперь суммируется количество ценностей  RA 20-05-00 */
 var NumRestSprv = (NumAvanceSprv - NumReturnSprv - NumTransferSprv) - (NumDebetSprv);
 /*печать результатов в ОД*/
 if( NumRestSprv )
    СтрокаОстатокСправок31( NumRestSprv );
 end;
END;
/****************************************************************************/
/* процедура формирует строку о расходе/остатке справок БСО для ОД          */
/****************************************************************************/
MACRO СправкиБСО( тип )
 var TotalDebetSprv = 0;
 var BreakLoop = TRUE;
 /* поиск и запись операций текущего кассира текущей смены */
 ClearRecord( Operat );
 Operat.Emp_Ref  = Session.Emp_Ref;
 Operat.Sess_Ref = Session.Number;
 if( GetGE( Operat ) )
  While( BreakLoop
         AND (Operat.Emp_Ref == Session.Emp_Ref )
         AND (Operat.Sess_Ref== Session.Number) )
      TotalDebetSprv = TotalDebetSprv
                       + CalcSprv( Operat.ID, CDF_SprvGetOut )
                       + CalcSprv( Operat.ID, CDF_SprvKill   );

      BreakLoop = Next( Operat );
  end;
  if( тип == "Аванс" )
       СтрокаПолученоСправок( ОбщКолАвансБСО );
  end;
  if( (тип == "Расход") AND TotalDebetSprv )
     /*TotalDebetSprv = money( TotalDebetSprv * 100 );*/
     /* теперь суммируется количество ценностей  RA 20-05-00 */
     СтрокаИзрасходованоСправок( TotalDebetSprv );
  end;
  if( тип == "Остаток" )
     ОстатокСправокБСО( TotalDebetSprv );
  end;
 end;
END;
/****************************************************************************/
/* процедура формирует строку о расходе/остатке справок F31 для ОД          */
/****************************************************************************/
MACRO СправкиF31( тип )
 var TotalDebetSprv = 0;
 var BreakLoop = TRUE;
 /* поиск и запись операций текущего кассира текущей смены */
 ClearRecord( Operat );
 Operat.Emp_Ref  = Session.Emp_Ref;
 Operat.Sess_Ref = Session.Number;
 if( GetGE( Operat ) )
  While( BreakLoop
         AND (Operat.Emp_Ref == Session.Emp_Ref )
         AND (Operat.Sess_Ref== Session.Number) )
      TotalDebetSprv = TotalDebetSprv
                       + CalcSprv31( Operat.ID, CDF_SprvGetOut )
                       + CalcSprv31( Operat.ID, CDF_SprvKill   );

      BreakLoop = Next( Operat );
  end;
  if( тип == "Аванс" )
       СтрокаПолученоСправок31( ОбщКолАвансF31 );
  end;
  if( (тип == "Расход") AND TotalDebetSprv )
     /*TotalDebetSprv = money( TotalDebetSprv * 100 );*/
     /* теперь суммируется количество ценностей  RA 20-05-00 */
     СтрокаИзрасходованоСправок31( TotalDebetSprv );
  end;
  if( тип == "Остаток" )
     ОстатокСправокF31( TotalDebetSprv );
  end;
 end;
END;

/****************************************************************************/
/*  Процедура формирует строки об текущих остатках по ценностям сотрудника  */
/****************************************************************************/
MACRO ОстаткиЦенностей( тип, Code_Curr )
 var Loop, КурсЦБ = 0, КурсПокупки, КурсПродажи;
 if( Loop = InitTrsKey( 0 , ANY_CURR, Session.Emp_Ref, Session.Number ))

    ПолучитьКурсы( Code_Curr, КурсЦБ, КурсПокупки, КурсПродажи );

    While( Loop )
       if( (Treasure.Sess_Ref != Session.Number ) OR
           (Treasure.Emp_Ref  != Session.Emp_Ref) )
          Loop = False;
       end;
       if( Loop AND (Treasure.Curr_Ref == Code_Curr) )
          /*Банкноты и Монеты*/
          if( TrsToNormal(Treasure.TrsGroup) == TrsNoteGrp )
             if( Treasure.NomSum - Treasure.InsolventSum )
                if( Treasure.Curr_Ref != {NationalCur} )
                   if( TrsIsNormal( Treasure.Trs_Ref ) )
                     СтрокаОстатокВалюты( Treasure.Curr_Ref, money( КурсЦБ*(Treasure.NomSum - Treasure.InsolventSum) ) );
                   else /* с указанием кол-ва */
                     СтрокаОстатокВалюты_Кол( Treasure.Curr_Ref, money( КурсЦБ*(Treasure.NomSum - Treasure.InsolventSum) ), Treasure.Trs_Ref, Treasure.QuantAmount );
                   end;
                else
                   СтрокаОстатокНацВалюты( {NationalCur}, Treasure.NomSum - Treasure.InsolventSum );
                end;
             end;
             if( Treasure.InsolventSum ) /* неплатежные */
                СтрокаОстатокНеплатежВалюты( Treasure.Curr_Ref, money( КурсЦБ*Treasure.InsolventSum ), Treasure.QuantAmount );
             end;
          /*Платежные документы и Тратты*/
          elif( (Treasure.TrsGroup == TrsRoot) OR (TrsToNormal(Treasure.TrsGroup) == TrsPayDoc) )
             if( Treasure.NomSum - Treasure.InsolventSum )
                /*бланки ПД в инвалюте*/
                if( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsValForm) )
                   СтрокаОстатокБланковПД( Treasure.PayDoc_Ref, Treasure.Curr_Ref, money( КурсЦБ*(Treasure.NomSum - Treasure.InsolventSum) ), Treasure.QuantAmount );
                /*ПД в инвалюте*/
                elif( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) != TrsTratt) )
                   СтрокаОстатокВалютныхПД( Treasure.PayDoc_Ref, Treasure.Curr_Ref, money( КурсЦБ*(Treasure.NomSum - Treasure.InsolventSum) ), Treasure.Trs_Ref, Treasure.QuantAmount );
                /*тратты в инвалюте*/
                elif( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsTratt) )
                   СтрокаОстатокВалютныхТраттов( Treasure.Curr_Ref, money( КурсЦБ*(Treasure.NomSum - Treasure.InsolventSum) ), Treasure.QuantAmount );
                /*бланки ПД в рублях*/
                elif( (Treasure.Curr_Ref == {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsValForm) )
                   СтрокаОстатокБланковПД( Treasure.PayDoc_Ref, {NationalCur}, Treasure.NomSum - Treasure.InsolventSum, Treasure.QuantAmount );
                /*ПД в рублях*/
                elif( Treasure.Curr_Ref == {NationalCur} AND (TrsToNormal(Treasure.Trs_Ref) != TrsTratt) )
                   СтрокаОстатокНацВалПД( Treasure.PayDoc_Ref, {NationalCur}, Treasure.NomSum - Treasure.InsolventSum, Treasure.QuantAmount );
                /*тратты в рублях*/
                elif( (Treasure.Curr_Ref == {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsTratt) )
                   СтрокаОстатокНацВалТраттов( Treasure.Curr_Ref, Treasure.NomSum - Treasure.InsolventSum, Treasure.QuantAmount );
                end;
             end;
             if( Treasure.InsolventSum ) /* неплатежные */
                /*бланки ПД в инвалюте*/
                if( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsValForm) )
                   СтрокаОстатокНеплБланковПД( Treasure.PayDoc_Ref, Treasure.Curr_Ref, money( КурсЦБ*Treasure.InsolventSum ) );
                /*ПД в инвалюте*/
                elif( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) != TrsTratt) )
                   СтрокаОстатокНеплВалютныхПД( Treasure.PayDoc_Ref, Treasure.Curr_Ref, money( КурсЦБ*Treasure.InsolventSum ), Treasure.QuantAmount );
                /*тратты в инвалюте*/
                elif( (Treasure.Curr_Ref != {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsTratt) )
                   СтрокаОстатокНеплВалютныхТраттов( Treasure.Curr_Ref, money( КурсЦБ*Treasure.InsolventSum ), Treasure.QuantAmount );
                /*бланки ПД в рублях*/
                elif( (Treasure.Curr_Ref == {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsValForm) )
                   СтрокаОстатокНеплБланковПД( Treasure.PayDoc_Ref, {NationalCur}, Treasure.InsolventSum );
                /*ПД в рублях*/
                elif( Treasure.Curr_Ref == {NationalCur} AND (TrsToNormal(Treasure.Trs_Ref) != TrsTratt) )
                   СтрокаОстатокНеплНацВалПД( Treasure.PayDoc_Ref, {NationalCur}, Treasure.InsolventSum, Treasure.QuantAmount );
                /*тратты в рублях*/
                elif( (Treasure.Curr_Ref == {NationalCur}) AND (TrsToNormal(Treasure.Trs_Ref) == TrsTratt) )
                   СтрокаОстатокНеплНацВалТраттов( Treasure.Curr_Ref, Treasure.InsolventSum, Treasure.QuantAmount );
                end;
             end;
          end;
       end;
       Loop = Next( Treasure );
    end;
 end;
END;

MACRO СтрокаИтогов_НОД()
 var Строка = "   |                         ИТОГО:                     |";
 var i = НачальнаяКолонка;
 While( i <= МаксимумКолонок )
   /*добавление пустых колонок*/
   if( ИтогКолонки(i-1) )
      Строка = Строка + Число_Строка( ИтогКолонки(i-1) ) + "|";
   else
      Строка = Строка + ПустаяГрафа();
   end;
   i = i + 1;
 end;
 println( Строка );
END;

/*RA 31-03-99***************************************************************/
/* Получает курс для валюты из смены курсов, соответствующей операции      */
/***************************************************************************/
MACRO GetCBRate( Oper_Ref, Curr_Ref )
   File   OperID   ("operat.dbt",   "exchange.def") key 0;/* ID */

   OperID.ID = Oper_Ref;
   if( GetEQ( OperID ) )
      Rates.Change_Ref = OperID.Rate_Ref;
      Rates.Curr_Ref   = Curr_Ref;
      if ( GetEQ( Rates ) )
         return Rates.CBRate;
      end;
   end;
END;

/*RA 31-03-99***************************************************************/
/* Определяет суммы фиксированной комиссии по оборотам для данной валюты   */
/***************************************************************************/
MACRO СуммаВалютнойФиксКомм( Type, КодВалюты )
   var Loop, SumВал = $0.0, SumРуб = $0.0, Курс = $0.0;

   ClearRecord( TurnOper );
   TurnOper.Emp_Ref    = Session.Emp_Ref;
   TurnOper.Sess_Ref   = Session.Number;

   Loop = GetGE( TurnOper );

   While( ( Loop == True ) AND
          ( TurnOper.Emp_Ref     == Session.Emp_Ref ) AND
          ( TurnOper.Sess_Ref    == Session.Number  )   )

      if( ( TurnOper.Cash        == SET_CHAR   ) AND
          ( TurnOper.Curr_Ref    == КодВалюты  ) AND
          ( TurnOper.Type        == Type       ) AND
          ( TurnOper.Insolvent   == UNSET_CHAR ) AND
          ( TurnOper.Noncompleted== UNSET_CHAR )   )

         Курс = GetCBRate( TurnOper.Oper_Ref, КодВалюты );
         SumВал = SumВал + TurnOper.Sum;
         SumРуб = SumРуб + money( Курс * TurnOper.Sum );
      end;

      Loop = Next( TurnOper );
   end;

   if( SumВал )
     СтрокаФиксКомисВал( КодВалюты, SumРуб, SumВал );
   end;
END;

/***************************************************************************/
/* Процедура печатает часть ОД для всех валют ( возможен доп. параметр )   */
/*  для нац. валюты не печатаем !                                          */
/***************************************************************************/
MACRO ЗаписиОДпоОперации( МакроПроцедураПечати, Parm )
   НомерВалюты         = 0;
   /* Формирование операционного дневника */
   While( НомерВалюты < TotalNumCurr )
      if( (DiffCurr(НомерВалюты) != {NationalCur}) OR
          (Parm == CDF_OperCardGive) OR
          (Parm == CDF_OperCardTake) OR
          (Parm == CDF_OperReturnIncasso) OR
          (Parm == CDF_OperPayDocExpert ) OR
          (Parm == CDF_OperPayDocReturnIncasso) OR
          (Parm == CDF_OperPayDocReturnExpert ) 
        )
            ExecMacro( МакроПроцедураПечати, Parm, DiffCurr(НомерВалюты) );
      end;
      НомерВалюты = НомерВалюты + 1;
   end;
END;

/****************************************************************************/
/* Формирование ОД по образцу от уфимского СБ                               */
/****************************************************************************/
MACRO ОперационныйДневник_2()
   /* инициализация глобализмов */
   НомерСтрокиОД       = 1;
   КоличествоЭлементов = 5;    /* количество элементов для каждой валюты */
   ОбщаяКомиссия       = $0.00;/* Общая сумма комиссии для ОД */
   TotalNumCurr        = 0;
   ОбщКолАвансБСО      = 0;
   ОбщКолАвансF31      = 0;
   ФиксКомисРуб        = 0;
   ПроцКомисРуб        = 0;

/* Настройки для формирования операционных дневников ************************/
/*  !!!!! шапка и дно дневника переделываются вручную                       */
  ШиринаКолонок    = 13; /* ширина колонок в операционном дневнике          */
  МаксимумКолонок  = 12; /* максимальное количество колонок                 */
  НачальнаяКолонка = 3;  /* начальная колонка для вывода чисел              */
  ШиринаНазвания   = 52; /* ширина графы для названия операции              */
/****************************************************************************/

   /* создаем и открываем файл отчета */
   MakeReportFile( ReportFile, "sbr_f24n" );

   ОбнулениеИтоговОД();       

   /* заполняем массив валют: DiffCurr */
   ЗаполнитьМассивы_НОД();
   /* базовую валюту(доллары) перенести на первое место */
   MoveElementArray( DiffCurr, {BaseCur}, 0, TotalNumCurr );

   ИнициализацияМассивовКонверсий();

   ШапкаОперационногоДневника_НОД();

   /* Справки0406007_НОД(); */
   Суммы_ПередачСправокБСО("Аванс");/* аванс не печатается - только считается */
   Суммы_ПередачСправокF31("Аванс");
   СправкиБСО( "Аванс"  );/* напечатать аванс  справок БСО */
   СправкиБСО( "Расход" );/* напечатать расход справок БСО */
   Суммы_ПередачСправокБСО("Передача");
   Суммы_ПередачСправокБСО("Возврат");

   СправкиF31( "Аванс"  );/* напечатать аванс  справок БСО */
   СправкиF31( "Расход" );/* напечатать расход справок БСО */
   Суммы_ПередачСправокF31("Передача");
   Суммы_ПередачСправокF31("Возврат");

   /* авансы по всем валютам */
   ЗаписиОДпоОперации( "СтрокаПоПередачеЦенностей", "Аванс" );

   /* общие операции по всем валютам */
   /* операции продажи */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCurrSale       );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocSale     );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocSaleCurr );
   /* операции покупки */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCurrBuy        );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocBuy      );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocBuyCurr  );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperUnpayCurrBuy   );
   /* конверсия */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCurrConversion );
   /* проверка на подлинность */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCheck          );
   /* снятие и принятие на пластиковые карточки */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCardTake       );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperCardGive       );
   /* прием на инкассо и экспертизу */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperExpert         );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperIncasso        );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocExpert   );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocIncasso  );
   /* возврат с инкассо и экспертизы */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperReturnExpert        );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperReturnIncasso       );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocReturnExpert  );
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperPayDocReturnIncasso );
   /* замена неплатежной валюты */
   ЗаписиОДпоОперации( "ПокупкаПродажаВалют", CDF_OperChange         );
   /* строки с суммами конверсий */
   ПечатьСуммКонверсий();
   /* строки с суммами рублевых комиссий */
   if( ПроцКомисРуб )
      СтрокаПроцКомиссииРуб( ПроцКомисРуб );
   end;
   if( ФиксКомисРуб )
      СтрокаФиксКомисРуб( ФиксКомисРуб );
   end;
   /* валютная фиксированная комиссия по всем операциям */
   ЗаписиОДпоОперации( "СуммаВалютнойФиксКомм", CDF_TurnFix );

   /* передачи/возвраты по всем валютам */
   ЗаписиОДпоОперации( "СтрокаПоПередачеЦенностей", "Передача" );

   /* авансы/передачи/возвраты для нац. валюты */
   СтрокаПоПередачеЦенностей( "Аванс",    {NationalCur}  );
   СтрокаПоПередачеЦенностей( "Передача", {NationalCur}  );

   /* операции учета излишков и недостачи */
   ЗаписиОДпоОперации( "Недостачи_и_Излишки", CDF_OperDetectOverplus    );
   ЗаписиОДпоОперации( "Недостачи_и_Излишки", CDF_OperDetectDeficit     );
   ЗаписиОДпоОперации( "Недостачи_и_Излишки", CDF_OperGiveOutOverplus   );
   ЗаписиОДпоОперации( "Недостачи_и_Излишки", CDF_OperCompensateDeficit );
   
   Недостачи_и_Излишки( CDF_OperDetectOverplus   , {NationalCur} );
   Недостачи_и_Излишки( CDF_OperDetectDeficit    , {NationalCur} );
   Недостачи_и_Излишки( CDF_OperGiveOutOverplus  , {NationalCur} );
   Недостачи_и_Излишки( CDF_OperCompensateDeficit, {NationalCur} );

   /* остатки справок БСО */
   СправкиБСО("Остаток");
   /* остатки справок F31 */
   СправкиF31("Остаток");
   /* остатки по всем валютам (возможны только, если смена еще не завершена!) */
   ЗаписиОДпоОперации( "ОстаткиЦенностей", "Остатки" );
   /* остатки по нац.валюте */
   ОстаткиЦенностей( "Остатки", {NationalCur} );


   СтрокаИтогов_НОД();
   ДноОперационногоДневника_НОД();
   /* смотрим файл отчета */
   SetOutPut( 0 );
   ViewFile( ReportFile );
   Close( ReportFile );
END;
