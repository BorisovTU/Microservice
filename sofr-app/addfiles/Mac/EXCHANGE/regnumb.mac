/*-RSL---------------------------------------- R-Style Software Lab --
  RS-Bank      подсистема Обменный пункт            VD  03.06.97     
 --------------- Генерация учетного номера реестра ------------------
  Вариант формирования ПОЛЬЗОВАТЕЛЬСКОГО номера реестра.             
  Вызывается при закрытии реестра при формировании шапки для новой   
  пары валют.                                                        
  Системный пункт № 10103, работает только в контексте программы.    
                                                                     
  15.08.2000 VS Добавлен № эмитента, убраны "лишние" разделители.    
  17.11.2000 VS Добавлены также № ПД или карты.                      
   2.04.2001 VS Длина номера увеличена до 32-х символов, формирование
                  адаптировано под RS-Retail.                          
*/
import ExchangeInter, CommonInter, "office.mac", "string.mac";

file   Reestr0 ( "reestr.dbt", "exchange.def" ) key 0 write;
record r_buf   ( "reestr.dbt", "exchange.def" ); /*  буфер */

/* Вычисляет UserRegNumb */
MACRO CalcRegNumb( Reestr )

  var CountValue : DOUBLEL;

  /* Приведение даты 28-02-2001 к виду 28-02-01 */
  macro DateToStr( dat )
    var str = string( dat );
    /* XX-XX-XXXX */
    /* 1234567890 */
    str = substr( str, 1, 6 ) + substr( str, 9 );
    return str;
  end;

  if  ( ValType(Reestr) == V_MEMADDR )
    SetBuff( r_buf, Reestr );
  elif( ValType(Reestr) == V_FILE )
    SetRecordAddr( r_buf, Reestr, 0, 0, True );
  elif( ValType(Reestr) == V_STRUC )
    SetRecordAddr( r_buf, Reestr, 0, 0, True );
  else
    msgbox("Неверный тип аргумента для CalcRegNumb()");
    return;
  end;

/* Длина UserRegNumb 32 символа. № можно сформировать например так:

/*         10        20        30   */
/* 12345678901234567890123456789012 */
/* FF/28-02-01/11.840.810.999999999
    │     │     │  │   │      │
    └─────┼─────┼──┼───┼──────┼────── № филиала
          └─────┼──┼───┼──────┼────── дата опердня формирования реестра
                └──┼───┼──────┼────── вид валютно-обменных операций в реестре
                   └───┼──────┼────── валюта ценности прихода
                       └──────┼────── валюта ценности прихода
                              └────── уникальный ID реестра филиала
*/

  r_buf.UserRegNumb =
       string                                  ( r_buf.Branch:2:r     ) + "\/" +
       DateToStr                               ( r_buf.Date           ) + "\/" +
       string                                  ( r_buf.Kind_Oper:2:r  ) + "."  +
       GetCurrNumericalCode( FindCodCurByRefVal( r_buf.IncomeRefVal ) ) + "."  +
       GetCurrNumericalCode( FindCodCurByRefVal( r_buf.OutRefVal    ) ) + "."  +
       string                                  ( r_buf.ID:9:r         ) ;

  ChangeSymbol( r_buf.UserRegNumb, " ", "0" );
*/

/* Другой вариант формирования номера реестра: */
  if ( Office.BankStandart == 0 )
    r_buf.UserRegNumb = 0;                 /* Сбербанк России */
  else
     if ( GetCountValue( 3, r_buf.Branch, CountValue ) )
       r_buf.UserRegNumb = string( int(CountValue) );  /* Коммерческие банки */
     end;
  end;


END;

/* Заполняет UserRegNumb */
MACRO SetRegNumb( Reestr )

  ClearRecord( Reestr0 );
  Reestr0.Branch = Reestr.Branch;
  Reestr0.ID     = Reestr.ID;

  if(     ( Office.MakeUserRegNumber == SET_CHAR )
      AND ( GetEQ( Reestr0 )                     ) 
      AND ( Reestr0.UserRegNumb      == ""       ) 
    )
    CalcRegNumb( Reestr0 );
    Reestr.UserRegNumb = Reestr0.UserRegNumb;
    Update( Reestr0 );
  end;

END;

