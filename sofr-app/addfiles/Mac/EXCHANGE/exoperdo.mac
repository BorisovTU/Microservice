/*
   ************************************************************************
   Обменный пункт
   Copyright 2001 (c) R-Style Software Lab.
   exoperdo.mac - Макрос выполнения операции.

   CompleteOper - стандартное название функции, вызываемой после заполнения
                  полей панели ввода операции
   OperAddr     - адрес буфера с данными об операции

   Переход к завершению операции осуществится после успешного выхода из макроса
   (возврат TRUE).
   Запрет продолжения операции происходит при возврате значения FALSE.

   Создание: 09.02.2001 VS
   ************************************************************************
*/
import ExchangeInter, DeprIntr;

private const CDF_OperUnpayCurrBuy = 1;  // Покупка неплатежеспособной валюты за рубли.
private const CDF_OperPayRFNalToAcc = 43; // Прием нал. валюты РФ для зачисл. на счета ф/л

private record Oper( exoperat, "exchange.def" );

private file fOper( exoperat, "exchange.def" );

// ====================================================
//      Проверка: целое х целиком делится на y.
// ====================================================
private macro isDivision( x, y )
  var vQuot;
  var ret = FALSE;
  if ( ( y > 0 )  AND  ( x >= y ) )
    vQuot = Int( x / y );
    if ( ( vQuot * y ) == x )
      ret = TRUE;
    end;
  end;
  return ret;
end;

/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro CompleteOper( OperAddr )

  record currop ( "curr_op.str", "exchange.def" );

  SetBuff( Oper, OperAddr ); /* Oper указывает на текущую запись об операции */

  if ( (Oper.Kind_Oper == CDF_OperUnpayCurrBuy) or (Oper.Kind_Oper == CDF_OperPayRFNalToAcc) )  // Покупка поврежденной валюты за рубли.
    Copy( fOper, Oper );  // SetRecordAddr() правильно работает только для FILE.
    SetRecordAddr( currop, fOper, 0, FldOffset( fOper, "ExtInfo" ), True );
    if ( (Oper.Kind_Oper == CDF_OperUnpayCurrBuy) and (NOT isDivision( Oper.IncomeAmount, currop.IncomeNominal )) )
      MsgBox( "Введите номинал неплатежных банкнот" );
      return FALSE;
    end;
  end;

  return TRUE; 
end;


/**************************************************************************\
|                                                                          |
\**************************************************************************/
macro SetAccounts ( OperAddr )

  var userAttrs    = getDocUserAttrPool();
  var varUserAttrs = userAttrs.overlayRecord( "cvodbacc.rec", 0, false );

  SetBuff( Oper, OperAddr );

  userAttrs.rewind( );
  userAttrs.clear( );
  userAttrs.KeyNum = 0;
  userAttrs.rec.iApplicationKind = Oper.ApplicationKind;
  userAttrs.rec.ApplicationKey   = Oper.ApplicationKey;
  userAttrs.rec.AttrID           = "ODB_ACCOUNTS";

  if ( userAttrs.getEQ( ) )
    // MsgBox( varUserAttrs.rec.NumItems, " ", varUserAttrs.rec.Nominal );
    ; // Здесь можно обновлять запись
    // varUserAttrs.rec.Account1 = "20206810100022000010";
    // userAttrs.update( GetRecordSize( varUserAttrs ) );
  end;

  return true;

end;
