/*-RSL---------------------------------------- R-Style Software Lab --*/
/*---------------   Печать отчета по реестрам ОП    ------------------*/
/* RS-Bank      подсистема Обменный пункт            AV  20.05.97     */
/*!!!!!!!!!!!!  отчет формируется для текущего сотрудника AV 10.06.97 */

IMPORT ExchangeInter, "define.mac";

   record  s ("rep_rstr.str","exchange.def");
   file  r ("reestr.dbt","exchange.def")key 4;

macro Init( TypeReestr )
   r.Emp_Ref       =   {exoper};
   r.Type_Ref      =   TypeReestr;/* Тип реестра       */
   r.OpenClose     =   0;        /* Состояние реестра */
   getGE( r );
    if( TypeReestr != "" ) if( r.Type_Ref != TypeReestr ) return False; end;
    end;
    if( r.Type_Ref >= TypeReestr )  return True;
    else return False;
    end;
end;

/*  для подстановки нужных фильтров */
macro Filter( TypeReestr , IncomeCurr , OutCurr , StartDate , FinishDate)
end;
/* определенные валюты */
macro Filter0( TypeReestr , IncomeCurr , OutCurr , StartDate , FinishDate)
   if( TypeReestr != "" )  if(r.Type_Ref != TypeReestr) return False; end;
   end;
   if( (r.Emp_Ref        == {exoper}  ) AND
       (r.Type_Ref       >= TypeReestr) AND
       (r.IncomeCurr_Ref == IncomeCurr) AND
       (r.Date           >= StartDate ) AND
       (r.Date           <= FinishDate) AND
       (r.OutCurr_Ref    == OutCurr   ) )  return True;
   else return False;
   end;
end;
/* любые валюты */
macro Filter1( TypeReestr , IncomeCurr , OutCurr , StartDate , FinishDate)
   if( TypeReestr != "" )  if(r.Type_Ref != TypeReestr) return False; end;
   end;
   if( (r.Emp_Ref        == {exoper}  ) AND
       (r.Type_Ref       >= TypeReestr) AND
       (r.IncomeCurr_Ref >= IncomeCurr) AND
       (r.Date           >= StartDate ) AND
       (r.Date           <= FinishDate) AND
       (r.OutCurr_Ref    >= OutCurr   ) )  return True;
   else return False;
   end;
end;
/* любые входящие валюты */
macro Filter2( TypeReestr , IncomeCurr , OutCurr , StartDate , FinishDate)
   if( TypeReestr != "" )  if(r.Type_Ref != TypeReestr) return False; end;
   end;
   if( (r.Emp_Ref        == {exoper}  ) AND
       (r.Type_Ref       >= TypeReestr) AND
       (r.IncomeCurr_Ref >= IncomeCurr) AND
       (r.Date           >= StartDate ) AND
       (r.Date           <= FinishDate) AND
       (r.OutCurr_Ref    == OutCurr   ) )  return True;
   else return False;
   end;
end;
/* любые выходящие валюты */
macro Filter3( TypeReestr , IncomeCurr , OutCurr , StartDate , FinishDate)
   if( TypeReestr != "" )  if(r.Type_Ref != TypeReestr) return False; end;
   end;
   if( (r.Emp_Ref        == {exoper}  ) AND
       (r.Type_Ref       >= TypeReestr) AND
       (r.IncomeCurr_Ref == IncomeCurr) AND
       (r.Date           >= StartDate ) AND
       (r.Date           <= FinishDate) AND
       (r.OutCurr_Ref    >= OutCurr   ) )  return True;
   else return False;
   end;
end;


macro ПечатьОтчетаПоРеестрам( a )
  setbuff( s , a );
  var FullName, Loop;
/* для корректного поиска в reestr.dbt файле */
  if( s.TypeReestr =="0")  s.TypeReestr = ""; end;

  if( ( s.IncomeCurr_Ref == ANY_CURR ) AND ( s.OutCurr_Ref == ANY_CURR ) )
                                ReplaceMacro( "Filter" ,"Filter1");
  elif( s.IncomeCurr_Ref == ANY_CURR ) ReplaceMacro( "Filter" ,"Filter2");
  elif( s.OutCurr_Ref    == ANY_CURR ) ReplaceMacro( "Filter" ,"Filter3");
  else                          ReplaceMacro( "Filter" ,"Filter0");
  end;

  FullName ={ExAddress} + "  " + {ExRegNumber};

  PrintDate_n_Time();
[                                              ОТЧЕТ ПО РЕЕСТРАМ

                     #########################################################################
                     -------------------------------------------------------------------------
                     (адрес обменного пункта и его регистрационный  номер, если обменный пункт
                                       зарегистрирован  в установленном порядке)

+------------------------+--------------------------------------+-----------+----------+------------------+--------+------------------+
|       N Реестра        |   Название реестра                   | Дата и    |Полученная|    Полученная    |Выданная|   Выданная       |
|                        |                                      | время     |  валюта  |      сумма       | валюта |    сумма         |
|                        |                                      |составления|          |                  |        |                  |
+------------------------+--------------------------------------+-----------+----------+------------------+--------+------------------+
]( FullName:c:w );

 Loop = True;
 if( Init( s.TypeReestr ))
   while( Loop )
     if ( Filter( s.TypeReestr, s.IncomeCurr_Ref, s.OutCurr_Ref,
                                s.StartDate,      s.FinishDate  ) )

[|########################|######################################|###########|##########|##################|########|##################|
]
       (
        r.UserRegNumb,
        GetNameReestr( r.Type_Ref):w,
        StrAddZeroDate_Short( r.Date ) + " " + string(r.Time):w,
        MakeCodeCurr( r.IncomeCurr_Ref ):c,
        r.IncomeSum,
        MakeCodeCurr( r.OutCurr_Ref ):c,
        r.OutSum,
        r.Time
   );
     end;
   Loop = next(r);
   end;
 end;
[+------------------------+--------------------------------------+-----------+----------+------------------+--------+------------------+];
end;



