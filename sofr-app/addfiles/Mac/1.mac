import "spserv.mac", "scincfun.mac", "DealsInter";
var cmd2, ds2;
    var Dразм = ZeroDate, SumComisRub = $0, SumNDSRub = $0, Зсвып_начисл_пр = $0, НДСЗСвып_начисл_пр = $0,
        Dначисл = ZeroDate, Dпг = ZeroDate, ЗСвып_начисл = $0, SдоначЗСвып = $0, НДСЗСвып_начисл = $0,
        SдоначНДСЗСвып = $0, SСЗ_вып = $0, SндсЗС_вып = $0, Doffer = ZeroDate;
    var Month1, Month2;
    var SдоначAmort = $0, SдоначНДСAmort = $0;
    var query = "", DataSet;

 ПолучитьСуммуЗатратПоЦБ(8438, @SumComisRub, @SumNDSRub, false);

    Dразм = ПолучитьДатуНачальногоРазмещенияОЭБ(8438);

    // Определим сумму ранее списанных затрат по ц/б
    cmd2 = DL_RSDCommand("SELECT NVL(SUM(T_SUM), 0) as SumComSum, NVL(SUM(T_NDS), 0) as SumComNDS FROM DDLSUM_DBT WHERE T_DOCKIND = ? AND T_DOCID = ? AND T_KIND = ? ");
    cmd2.AddParam(DLDOC_ISSUE);
    cmd2.AddParam(8438);
    cmd2.AddParam(DLSUM_KIND_OWNAVR_OUTLAY);
    ds2 = cmd2.Execute();

    if(ds2.moveNext())
      Зсвып_начисл_пр    = ds2.SumComSum;
      НДСЗСвып_начисл_пр = ds2.SumComNDS;
    end;

if((SumComisRub-Зсвып_начисл_пр)> 0 )

 if(SumComisRub > 0)
      Dначисл      = {curdate};
      Dпг          = {curdate};
      if( ОЭБ_АМОРТИЗАЦИЯ_ДО_ОФЕРТЫ() == 1 )
      //  Doffer = ПолучитьБлижайшуюДатуОферты(FD.fininstr.rec.FIID, Dразм);
      Doffer = ПолучитьБлижайшуюДатуОферты(8438, {CurDate});
        if( Doffer != ZeroDate )
          Dпг = Doffer;
        end;
      end;

      ЗСвып_начисл = round((SumComisRub * (Dначисл - Dразм) / (Dпг - Dразм)), 2);
      SдоначЗСвып  = ЗСвып_начисл - Зсвып_начисл_пр;

      if(SumNDSRub > 0)
        НДСЗСвып_начисл = round((SumNDSRub * (Dначисл - Dразм) / (Dпг - Dначисл)), 2);
        SдоначНДСЗСвып  = НДСЗСвып_начисл - НДСЗСвып_начисл_пр;
      end;
  end;

 else
   SдоначЗСвып = 0;
 end;

