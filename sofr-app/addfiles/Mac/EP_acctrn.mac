import "sp_car.mac", "scservop.mac";

var FIIDDebet, FIIDCredit, Sum, FiRoleCred, FiRoleDeb, Ground, CatDeb, CatCred, DebAccNumber = "", CredAccNumber = "", FD,
    Group, Bpp = false, GroupBank;
var debug = false; //true;

Import cb_sql;

  var epdate = {curdate};
  var AccEPRub = TRecHandler("account");
  var AccEPUSD = TRecHandler("account");
  var AccEPEUR = TRecHandler("account");
  var AccTPLUSRub = TRecHandler("account");
  var AccTPLUSUSD = TRecHandler("account");
  var AccTPLUSEUR = TRecHandler("account");
  var sql, cmd, TemplNum, AccountNumber, Result;

  record attrs(mcaccdoc);


var ExcelApp;

var ind = 1;

Var Amount = 0, Portf = 0, Summa = $0, StrCatDeb = "", StrCatCred = "", DocNum = "", tr;
const bonusdate = date(31,12,2019);
const convdate = date(31,12,2019);


GetAccount( 1, 0, "30424810000000000104", AccTPLUSRub, false );
GetAccount( 1, 7, "30424840300000000104", AccTPLUSUSD, false );
GetAccount( 1, 8, "30424978900000000104", AccTPLUSEUR, false );
/*
sql = "select "+
" (select sum(RSB_ACCOUNT.RESTAC(account, code_currency, " + getsqldate(epdate) + " , 1, 0))  from UserNotEPAccounts_dbt where code_currency = 0) RestacRUB,  "+
" (select sum(RSB_ACCOUNT.RESTAC(account, code_currency, " + getsqldate(epdate) + " , 1, 0))  from UserNotEPAccounts_dbt where code_currency = 7) RestacUSD,   "+
" (select sum(RSB_ACCOUNT.RESTAC(account, code_currency, " + getsqldate(epdate) + " , 1, 0)) from UserNotEPAccounts_dbt where code_currency = 8) RestacEUR,   "+
" (select RSB_ACCOUNT.RESTAC('30424810000000000104', 0, " + getsqldate(epdate) + " , 1, 0)  from dual) RestacTPlusRUB,   "+
" (select RSB_ACCOUNT.RESTAC('30424840300000000104', 7, " + getsqldate(epdate) + " , 1, 0)  from dual ) RestacTPlusUSD,   "+
" (select RSB_ACCOUNT.RESTAC('30424978900000000104', 8, " + getsqldate(epdate) + " , 1, 0)  from dual ) RestacTPlusEUR    "+
" from dual  ";

cmd = TrsbDataSet(sql);
*/
//If(cmd.movenext())
        TemplNum = 2;
        attrs.marketplaceid = 4;
        attrs.marketplaceofficeid = 17; // Единый пул для клиентов
        //по рублям
        ClearRecord(AccEPRub);
        AccountNumber = MC_FindAndOpenCommonAcc("Клиринговый счет", epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, 0, null, null, AccEPRub, Result, null, MC_PAIRACCMODE_AUTO);

   Getdouble(sum, "Введите рублевую сумму остстка по счету 30420810*06263 из файла ССХ99");//abs(cmd.RestacTPlusRUB) - abs(cmd.RestacRUB);
   Ground = "ФР.Перенос остатка на новый клиринговый счет в связи с переходом на единый пул";
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = epdate;
                 tr.Numb_Document   = "1";
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = 0;
                 tr.FIIDReceiver    = 0;
                 tr.AccountPayer    = AccEPRub.rec.account;
                 tr.AccountReceiver = AccTPLUSRub.rec.account;
                 tr.SumPayer        = ABS(Sum);
                 tr.SumReceiver     = ABS(Sum); 

                 tr.Userfield2    = "1";
   
                 if( not tr.Carry() )
                     return Msgbox("Ошибка при выполнении проводки");
                 end;
                 println(AccEPRub.rec.account, "|", AccTPLUSRub.rec.account, "|", Sum); 
        //по долларам
        ClearRecord(AccEPUSD);
        TemplNum = 4;
        AccountNumber = MC_FindAndOpenCommonAcc("+Обеспечение", epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, 7, null, null, AccEPUsd, Result, null, MC_PAIRACCMODE_AUTO);
        

//   sum = abs(cmd.RestacTPlusUSD) - abs(cmd.RestacUSD);
   Getdouble(sum, "Введите долларовую сумму остстка по счету 30420840*06263 из файла ССХ99");//abs(cmd.RestacTPlusRUB) - abs(cmd.RestacRUB);

   Ground = "ФР.Перенос остатка на новый счет обеспечения в связи с переходом на единый пул";
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = epdate;
                 tr.Numb_Document   = "1";
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = 7;
                 tr.FIIDReceiver    = 7;
                 tr.AccountPayer    = AccEPUSD.rec.account;
                 tr.AccountReceiver = AccTPLUSUSD.rec.account;
                 tr.SumPayer        = ABS(Sum);
                 tr.SumReceiver     = ABS(Sum); 

                 tr.Userfield2    = "1";
   
                 if( not tr.Carry() )
                     return Msgbox("Ошибка при выполнении проводки");
                 end;
                 println(AccEPUSD.rec.account, "|", AccTPLUSUSD.rec.account, "|", Sum); 

        //по евро
        ClearRecord(AccEPEUR);
        TemplNum = 4;
        AccountNumber = MC_FindAndOpenCommonAcc("+Обеспечение", epdate, MC_OPENACC_CREATE, TemplNum, attrs, null, 8, null, null, AccEPEUR, Result, null, MC_PAIRACCMODE_AUTO);
        

//   sum = abs(cmd.RestacTPlusEUR) - abs(cmd.RestacEUR);
   Getdouble(sum, "Введите евровую сумму остатка по счету 30420978*06263 из файла ССХ99");//abs(cmd.RestacTPlusRUB) - abs(cmd.RestacRUB);

   Ground = "ФР.Перенос остатка на новый счет обеспечения в связи с переходом на единый пул";
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = "09"; // стираем, потом заполним правильно
                 tr.Chapter         = 1;
                 tr.Date_Carry      = epdate;
                 tr.Numb_Document   = "1";
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = " 1";
                 tr.Ground          = Ground;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = 8;
                 tr.FIIDReceiver    = 8;
                 tr.AccountPayer    = AccEPEUR.rec.account;
                 tr.AccountReceiver = AccTPLUSEUR.rec.account;
                 tr.SumPayer        = ABS(Sum);
                 tr.SumReceiver     = ABS(Sum); 

                 tr.Userfield2    = "1";
   
                 if( not tr.Carry() )
                     return Msgbox("Ошибка при выполнении проводки");
                 end;
                 println(AccEPEUR.rec.account, "|", AccTPLUSEUR.rec.account, "|", Sum); 

//end;


