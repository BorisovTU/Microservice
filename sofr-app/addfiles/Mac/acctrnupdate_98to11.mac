import rsd, BankInter;


private class c_Account
   var id       : integer; 
   var isclosed : integer;
   var isftype  : integer;
   var prevtype  : string;
end;


  var sql :string = "",
    cmd, rs;
  var sqlacc :string = "",
    cmdacc, rsacc;
  var sqlaccu :string = "",
    cmdaccu, rsaccu;
  var sqlev :string = "",
    cmdev, rsev;
  var accTrn;
  var er;
  var accounts, acctoreopen, acc;

  var v_acc : c_Account;

SetDialogFlag(0);

/*****************/
/*  от 09 за 08  */
/*****************/

  sql =       "  select * from dacctrn_dbt where 1=1 ";
  sql = sql + "  and t_systemdate=to_date('09.01.2021','dd.mm.yyyy') ";
  sql = sql + "  and t_date_carry=to_date('08.01.2021','dd.mm.yyyy') ";
  sql = sql + "  order by t_date_carry, t_acctrnid desc ";


  cmd = RSDCommand(sql);
  rs = RSDRecordSet(cmd);

  while (rs.movenext) // цикл по всем проводкам
    sqlacc =          " select ascii(a.t_open_close) as isclosed, (INSTR(a.t_type_account, chr(148))) as isftype, ";
    sqlacc = sqlacc + " a.t_type_account as prevtype, a.* from daccount_dbt a where t_account in (:accp, :accr) ";
    cmdacc = RSDCommand(sqlacc);
    cmdacc.AddParam("accp", RSDBP_IN, rs.value("t_account_payer"));
    cmdacc.AddParam("accr", RSDBP_IN, rs.value("t_account_receiver"));
    rsacc = RSDRecordSet(cmdacc);

    accounts = TArray;
    while (rsacc.movenext) // цикл по счетам и их запоминание
      v_acc = null;
      v_acc.id       = rsacc.value("t_accountid");
      v_acc.isclosed = rsacc.value("isclosed");
      v_acc.isftype  = rsacc.value("isftype");
      v_acc.prevtype  = rsacc.value("prevtype");
      accounts[accounts.size] = v_acc;
    end;
    for (acctoreopen, accounts) // открытие закрытых счетов
      if (acctoreopen.isclosed == 135)
        sqlaccu = " update daccount_dbt set t_open_close = chr(0) where t_accountid = :accid ";
        cmdaccu = RSDCommand(sqlaccu);
        cmdaccu.AddParam("accid", RSDBP_IN, acctoreopen.id);
        cmdaccu.execute();
      end;
    end;


    // Обновление проводки
    accTrn = RsbAccTransaction;
    er = accTrn.Find(rs.value("t_acctrnid"));
    if(er == 0)
      accTrn.Date_Carry = "11.01.2021";
      er = accTrn.Update();
      if (er == false) //предполжительно, оталось только "Нельзя изменить старый остаток", ставим безлимит на оба счета, если они уже не безлимитные, и пробуем еще раз
        for (acc, accounts) // цикл по счетам проводки
          if (acc.isftype == 0) // ставим безлимитный, если счет не таков
            sqlaccu = " update daccount_dbt set t_type_account = :newtype where t_accountid = :accid ";
            cmdaccu = RSDCommand(sqlaccu);
            cmdaccu.AddParam("newtype", RSDBP_IN, acc.prevtype + "Ф");
            cmdaccu.AddParam("accid", RSDBP_IN, acc.id);
            cmdaccu.execute();
          end;
        end;
        er = accTrn.Update(); // еще раз Пробуем изменить
        if (er == false) // совсем не работает
          println ("Ошибка обновления проводки " + rs.value(0));
        end;
        //возвращаем тип счетов
        for (acc, accounts) // цикл по счетам проводки
          if (acc.isftype == 0) // если не был безлимитным - значит, изменялся, значит - возвращаем предыдещее значение типа
            sqlaccu = " update daccount_dbt set t_type_account = :newtype where t_accountid = :accid ";
            cmdaccu = RSDCommand(sqlaccu);
            cmdaccu.AddParam("newtype", RSDBP_IN, acc.prevtype);
            cmdaccu.AddParam("accid", RSDBP_IN, acc.id);
            cmdaccu.execute();
          end;
        end;
      end;
    end;

    //Закрытие счетов обратно
    for (acctoreopen, accounts)
      if (acctoreopen.isclosed == 135)
        sqlaccu = " update daccount_dbt set t_open_close = chr(135) where t_accountid = :accid ";
        cmdaccu = RSDCommand(sqlaccu);
        cmdaccu.AddParam("accid", RSDBP_IN, acctoreopen.id);
        cmdaccu.execute();
      end;

    // удаляем события изменения и закрытия счетов из этого макроса за текущую дату
      sqlev =         " delete from utableprocessevent_dbt where 1=1 ";
      sqlev = sqlev + " and t_objecttype = 4 ";
      sqlev = sqlev + " and t_type in (2, 3) ";
      sqlev = sqlev + " and t_timestamp between trunc(sysdate) and sysdate ";
      sqlev = sqlev + " and t_objectid = :accid ";

      cmdev = RSDCommand(sqlev);
      cmdev.AddParam("accid", RSDBP_IN, rsacc.value("t_accountid"));
      cmdev.execute();

    end;

  end;

SetDialogFlag(1);
