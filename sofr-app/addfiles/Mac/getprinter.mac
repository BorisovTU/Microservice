import rcw, or_tools;

macro getparm1(parm)
      var wsp = CreateObject("rsax", "TRsAxServer", "RsAxServer", isStandalone()).CreateComObject("WScript.Network", false);

      var sc:object = ActiveX("MSScriptControl.ScriptControl.1");
          sc.Language = "vbscript";
          sc.aDDcODE( 
" Function GetDefaultPrinter()                                                                                                     \n" +
"           GetDefaultPrinter=vbNullString                                                                                    \n" +
"           Set objWMIService=GetObject(\"winmgmts:{impersonationLevel=impersonate}!\\\\.\\root\\cimv2\")                      \n" +
"            Set colInstalledPrinters=objWMIService.ExecQuery(\"Select * from Win32_Printer\")                        \n" +
"           For Each objPrinter in colInstalledPrinters                              \n" +
"           If objPrinter.Attributes and 4 Then                                 \n" +
"           GetDefaultPrinter=objPrinter."+parm+"                              \n" +
"           Exit For                    \n" +                                   
"           End If                 \n" +                                        
"           Next              \n" +                                                   
"           End Function \n" 
);
    
     return (sc.run("GetDefaultPrinter") +"   " +wsp.ComputerName);
onerror
return "Error";
end;

macro getparm2(parm)
      var wsp = CreateObject("rsax", "TRsAxServer", "RsAxServer", isStandalone()).CreateComObject("WScript.Network", false);

//      var sc:object = ActiveX("MSScriptControl.ScriptControl.1");
      var sc:object = CreateObject("rsax", "TRsAxServer", "RsAxServer", isStandalone()).CreateComObject("MSScriptControl.ScriptControl.1", false);
          sc.Language = "vbscript";
          sc.aDDcODE( 
" Function GetDefaultPrinter()                                                                                                     \n" +
"           GetDefaultPrinter=vbNullString                                                                                    \n" +
"           Set objWMIService=GetObject(\"winmgmts:{impersonationLevel=impersonate}!\\\\.\\root\\cimv2\")                      \n" +
"            Set colInstalledPrinters=objWMIService.ExecQuery(\"Select * from Win32_Printer\")                        \n" +
"           For Each objPrinter in colInstalledPrinters                              \n" +
"           If objPrinter.Attributes and 4 Then                                 \n" +
"           GetDefaultPrinter=objPrinter."+parm+"                              \n" +
"           Exit For                    \n" +                                   
"           End If                 \n" +                                        
"           Next              \n" +                                                   
"           End Function \n" 
);
    
     return (sc.run("GetDefaultPrinter") +"   " +wsp.ComputerName);
onerror
return "Error";
end;


macro GetPrinter(ActvPrinter)
   var wsp = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("WScript.Network", false);
   var printers = wsp.EnumPrinterConnections;
   var c = 0;
   var port = "", RetVal = "";
   for (var i, printers)
      if (mod(c,2)==0) port = i;end;
      if ((index(i,"Microsoft XPS Document Writer") > 0) and 
          (index(i,"redirected") == 0))
         RetVal = i;
      end;
      c = c + 1;
   end;
   var reg;
/*   if( WR_CheckExistsRegKey("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows NT\\CurrentVersion\\PrinterPorts\\Microsoft XPS Document Writer", NULL, false) )
      reg = (WR_RegRead("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows NT\\CurrentVersion\\PrinterPorts\\Microsoft XPS Document Writer"));
   end;*/
   var reg_o = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("WScript.Shell", false);
   reg = reg_o.RegRead("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows NT\\CurrentVersion\\PrinterPorts\\Microsoft XPS Document Writer");
   return RetVal + " ("+(Substr(reg,index(reg,",")+1,StrLEn(reg)-index(reg,",",index(reg,",")+1)))+")";

end;

msgbox(GetPrinter("NULL")+"|"+getparm1("PortName") +"|"+getparm2("PortName"));