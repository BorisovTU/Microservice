import InsCarryDoc, "sp_car2.mac", "SCPeriodComm.mac", "dlquery.mac";

const METHOD_CALC   = 1,/*расчет*/
      METHOD_RECALC = 2,/*пересчет*/
      METHOD_DEL    = 3;/*удаление*/

private file TempFile( "SCCOMMCALC.TMP" ) write;

private macro InsComis(rDLComis)

    var ins = RSDCommand("INSERT INTO DDLCOMIS_LOST_DBT (t_ID, t_DocKind, t_DocID, t_Contract, t_FeeType, t_ComNumber, t_Sum, t_NDS, t_Date, t_PlanPayDate, t_InputMedium, t_ServOperID, t_IsBack, t_ComType, t_Version, t_ReceiverID) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
  
    ins.addParam("", RSDBP_IN, rDLComis.rec.ID);
    ins.addParam("", RSDBP_IN, rDLComis.rec.DocKind);
    ins.addParam("", RSDBP_IN, rDLComis.rec.DocID);
    ins.addParam("", RSDBP_IN, rDLComis.rec.Contract);
    ins.addParam("", RSDBP_IN, rDLComis.rec.FeeType);
    ins.addParam("", RSDBP_IN, rDLComis.rec.ComNumber);
    ins.addParam("", RSDBP_IN, rDLComis.rec.Sum);
    ins.addParam("", RSDBP_IN, rDLComis.rec.NDS);
    ins.addParam("", RSDBP_IN, rDLComis.rec.Date);
    ins.addParam("", RSDBP_IN, rDLComis.rec.PlanPayDate);
    ins.addParam("", RSDBP_IN, rDLComis.rec.InputMedium);
    ins.addParam("", RSDBP_IN, rDLComis.rec.ServOperID);
    ins.addParam("", RSDBP_IN, rDLComis.rec.IsBack);
    ins.addParam("", RSDBP_IN, rDLComis.rec.ComType);
    ins.addParam("", RSDBP_IN, 1);
    ins.addParam("", RSDBP_IN, 0);
  
    ins.execute();
end;

private macro RunCalculation_BrkCur(OperDate:date, Method:integer)
  var rComiss  = TRecHandler( "sfcomiss.dbt" );
  var rDLComis = TRecHandler( "dlcomis.dbt" );
  var sqls, rsdc, rsds;
  var Num  = -1, errMes = "", IsDataExists = false, ErrMsg = "", stat = 0;
  VAR ArrComSums = TArray(), i = 0, r_com, IsBack = false, PLANPAYDATE;
  var dtset = null;/*CHVA*/
  var _kind=0;/*CHVA*/

  sqls = String( 
                 "SELECT Cms.t_Feetype Cms_Tp   \n"
                ,"      ,Cms.t_Number Cms_Nm   \n"
                ,"      ,Cms.t_Code Cms_Cd   \n"
                ,"      ,Cms.t_Fiid_Comm Cms_Fi   \n"
                ,"      ,Cms.t_ReceiverID   \n"
                ,"      ,Sfcc.t_Id Cms_Cntr_Id   \n"
                ,"      ,Sfc.t_Id Cntr_Id   \n"
                ,"      ,Sfc.t_Number Cntr_Nm   \n"
                ,"      ,Sfc.t_Partyid Cntr_Pt   \n"
                ,"      ,COUNT(1) Deal_Cnt   \n"  
                ,"      ,COUNT(1) OVER() Cnt_All   \n"
                ,"  FROM Ddvndeal_Dbt Dl   \n"
                ," INNER JOIN Ddvnfi_Dbt Dli   \n"
                ,"    ON (Dli.t_Dealid = Dl.t_Id)   \n"
                ," INNER JOIN Dsfcontr_Dbt Sfc   \n"
                ,"    ON (Sfc.t_Id = Dl.t_Clientcontr AND Sfc.t_Servkind = :p_srv_kd AND Sfc.t_Servkindsub = :p_srv_sb)   \n"
                ," INNER JOIN Dsfconcom_Dbt Sfcc   \n"
                ,"    ON (Sfcc.t_Objecttype = :p_obj_sf AND Sfcc.t_Objectid = Dl.t_Clientcontr AND Sfcc.t_Feetype = :p_fee_tp AND Sfcc.t_Calcperiodtype = :p_prd_tp)   \n"
                ," INNER JOIN Dsfcomiss_Dbt Cms   \n"
                ,"    ON (Cms.t_Feetype = Sfcc.t_Feetype AND Cms.t_Number = Sfcc.t_Commnumber AND Cms.t_Fiid_Comm = Dli.t_Pricefiid)   \n"
                ," WHERE Dl.t_Date >= :p_Date   \n"
                ,"   AND Dli.t_Type = :p_dl_prt   \n"
                ,"   AND Sfc.t_Dateconc <= Dl.t_Date   \n"
                ,"   AND Sfcc.t_Status = 0   \n"
                ,"   AND Sfcc.t_Datebegin <= Dl.t_Date   \n"
                ,"   AND Cms.t_Formalg != :p_alg_fm   \n"
                ,"   AND CASE   \n"
                ,"          WHEN Sfcc.t_Dateend = To_Date('01010001', 'DDMMYYYY') THEN   \n"
                ,"           To_Date('31129999', 'DDMMYYYY')   \n"
                ,"          WHEN Sfcc.t_Dateend IS NULL THEN   \n"
                ,"           To_Date('31129999', 'DDMMYYYY')   \n"
                ,"          ELSE   \n"
                ,"           Sfcc.t_Dateend   \n"
                ,"       END > Dl.t_Date   \n"
               );
  rsdc = rsdcommand(sqls);
  rsdc.AddParam("p_srv_kd", RSDBP_IN, 21);
  rsdc.AddParam("p_srv_sb", RSDBP_IN, 8);
  rsdc.AddParam("p_obj_sf", RSDBP_IN, OBJTYPE_SFCONTR);      
  rsdc.AddParam("p_fee_tp", RSDBP_IN, SF_FEE_TYPE_PERIOD);
  rsdc.AddParam("p_prd_tp", RSDBP_IN, SF_TYPE_PERIOD_DAY);
  rsdc.AddParam("p_date",   RSDBP_IN, OperDate);
  rsdc.AddParam("p_dl_prt", RSDBP_IN, 0);
  rsdc.AddParam("p_alg_fm", RSDBP_IN, SFCOMISS_FORMALG_MANUAL);

  sqls = string(sqls," GROUP BY Sfc.t_Id, Cms.t_Feetype, Cms.t_Number, Cms.t_Code, Cms.t_Fiid_Comm, Cms.t_ReceiverID, Sfcc.t_Id, Sfc.t_Partyid, Sfc.t_Number   \n" );
  rsdc.CmdText = sqls;
  rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
  rsds.Open();
  while (rsds.MoveNext)
     if (Num < 0)
        Num = int(rsds.Value("Cnt_All"));
     end;
     rComiss.Clear();
     if (SfGetComiss(int(rsds.Value("Cms_Tp")), int(rsds.Value("Cms_Nm")), rComiss ) == false)
        MsgBox("Не найдена периодическая комиссия с номером <" + int(rsds.Value("Cms_Nm")) + "> ");  
        continue;
     end;   
     if (ПроверитьКатегориюКомиссии( rComiss, "DC", OBJGROUP_SFCOM_CALCBYBO ) == false)
        continue;
     end;                                
     SetGlobalDealIDForCalc(0);

     ArrComSums.Size = 0;
     if (CalcPeriodCommByContr_TMP( int(rsds.Value("Cntr_Id")), int(rsds.Value("Cms_Cntr_Id")), OperDate, errMes, ArrComSums ) != 0)
        MsgBox("Ошибка расчета сумм периодической комиссии с номером " + int(rsds.Value("Cms_Nm")) + ".\n" + errMes);
        continue;
     end; 
     SetGlobalDealIDForCalc(0);
     i = 0;                 
     // из полученного расчета выбрать нужное
     while (i < ArrComSums.Size)
        r_com = ArrComSums[i];
        i = i + 1;

        /*CHVA 515379*/
         dtset = TRsbDataSet("select t_kind from ddvndeal_dbt where t_id =" + r_com.rec.BaseObjectId);
        if (dtset.movenext())
          _kind = dtset.kind;
        end;    
        /*CHVA 515379*/   
         if(_kind == 32715)
        // в массиве комиссий выбрать только совпадающие с комиссией валюты
           if (r_com.rec.baseamountfiid != int(rsds.Value("Cms_Fi")))
             continue;
           end;
        else
        if (r_com.rec.docfiid != int(rsds.Value("Cms_Fi")))
           continue;
        end;
        end;

        // найти запись о комиссии в сделке
        PLANPAYDATE = OperDate;
        rDLComis.Clear;
       
        if (DL_FindDLCOMIS(r_com.rec.BaseObjectType, r_com.rec.BaseObjectId, int(rsds.Value("Cntr_Id")), int(rsds.Value("Cms_Tp")), int(rsds.Value("Cms_Nm")), PLANPAYDATE, IsBack, 0, "", rDLComis) != 0)
           rDLComis.Clear;
        end;
        // расчет
        if (Method == METHOD_CALC)
           // комиссия уже есть
           if (rDLComis.rec.ID > 0)
              continue;
           end;
        end;
        rDLComis.Clear();
        rDLComis.rec.ID          = 0;
        rDLComis.rec.DOCKIND     = r_com.rec.BaseObjectType;
        rDLComis.rec.DOCID       = r_com.rec.BaseObjectId;
        rDLComis.rec.CONTRACT    = int(rsds.Value("Cntr_Id"));
        rDLComis.rec.FEETYPE     = int(rsds.Value("Cms_Tp"));
        rDLComis.rec.COMNUMBER   = int(rsds.Value("Cms_Nm"));
        rDLComis.rec.SUM         = r_com.rec.CommSum + r_com.rec.NDSSum;
        rDLComis.rec.NDS         = r_com.rec.NDSSum;
        rDLComis.rec.DATE        = OperDate;
        rDLComis.rec.PLANPAYDATE = PLANPAYDATE;
        rDLComis.rec.INPUTMEDIUM = GetInputMedium(INPUTMEDIUM_CALC);
        rDLComis.rec.ServOperID  = 0;
        rDLComis.rec.IsBack      = IIF(IsBack, SET_CHAR, UNSET_CHAR);
        rDLComis.rec.Comtype     = 0;
        
        if (InsComis(rDLComis))
           ErrMsg = GetErrMsg();
           MsgBox("Ошибка вставки комиссии с номером \""+  int(rsds.Value("Cms_Nm")) + "\" по сделке с ID = " + r_com.rec.BaseObjectId + ": " + ErrMsg);
           continue;
        end;
     end;
  end;
  return 0;
end;

macro RunLostComCalc(StartDate:date, EndDate:date)
   var OperDate = StartDate;
   //SQL_Truncate("DDLCOMIS_LOST_DBT");

   while( OperDate <= EndDate )
      ClearGlobalTmp( "DSCCOMMCALC_TMP" );
      RunCalculation_BrkCur(OperDate, METHOD_CALC);
      OperDate = OperDate + 1;
   end;

   return 0;
end;

RunLostComCalc( date(22,11,2021), date(10,01,2022) );
exit;