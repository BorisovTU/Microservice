/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank 6.0                                      R-Style Software Lab Ltd
   Файл подсистемы "Регламентируемая отчетность"

   Общие классы и константы для экспорта значений переменных Формы 664 в текстовый файл для программы 
   kliko.exe согласно 1747-У

   CREATED : 18.04.2007 Малахова

   MODIFICATIONS:    
   NOTES: 

└────────────────────────────────────────────────────────────────────────── */
import RsbDataSet;

import cb_sql;

import RcbCoreInter;

import ReptcbInter;

import calc_f664pre_b1747u;
import repException;

const COMMON_VARIABLE_NAME         = "Всего";
const IN_REST_VARIABLE_NAME        = "Остатки на начало отчетного периода";
const OUT_REST_VARIABLE_NAME       = "Остатки на конец отчетного периода";
const OPERATION_KIND_CODE          = "Код вида операции";
const NUMERIC_ISO_CODE_OF_CURRENCY = "Цифровой ISO-код валюты";
const DIRECTION                    = "Направление";
const SUMM                         = "Сумма";
const COUNTRY_CODE                 = "Код страны";
const COUNTRY_NAME                 = "Наименование страны";

/*Класс с набором полей записи временной таблицы*/
CLASS TTemporaryTableRecord()              
    var m_currencyCode;
    var m_currencyName;                 
    var m_currencyNumber;
    var m_commonDebit;                   
    var m_commonCredit;                 
    var m_restIn;                             
    var m_restOut;                           
    var m_operationKind;               
    var m_debit;                               
    var m_credit;                             
    var m_countryCode;                   
    var m_countryName;                   
    var m_issueNumber;                   
    var m_issueSubsectionNumber; 
    var m_levelNumber;                  
    var m_direction;
    var m_restKind;

    MACRO getCurrencyCode()
        return m_currencyCode;
    END;

    MACRO setCurrencyCode(currencyCode)
        m_currencyCode = currencyCode;
    END;

    MACRO getCurrencyNumber()
        return m_currencyNumber;
    END;

    MACRO setCurrencyNumber(currencyNumber)
        m_currencyNumber = currencyNumber;
    END;

    MACRO getCurrencyName()
        return m_currencyName;
    END;

    MACRO setCurrencyName(currencyName)
        m_currencyName = currencyName;
    END;

    MACRO getCommonDebit()
        return m_commonDebit;
    END;

    MACRO setCommonDebit(commonDebit)
        m_commonDebit = commonDebit;
    END;

    MACRO getCommonCredit()
        return m_commonCredit;
    END;

    MACRO setCommonCredit(commonCredit)
        m_commonCredit = commonCredit;
    END;  

    MACRO getRestIn()
        return m_restIn;
    END;

    MACRO setRestIn(restIn)
        m_restIn = restIn;
    END;

    MACRO getRestOut()
        return m_restOut;
    END;

    MACRO setRestOut(restOut)
        m_restOut = restOut;
    END;

    MACRO getOperationKind()
        return m_operationKind;
    END;

    MACRO setOperationKind(operationKind)
        m_operationKind = operationKind;
    END;

    MACRO getDebit()
        return m_debit;
    END;

    MACRO setDebit(debit)
        m_debit = debit;
    END;

    MACRO getCredit()
        return m_credit;
    END;

    MACRO setCredit(credit)
        m_credit = credit; 
    END;

    MACRO getCountryCode()
        return m_countryCode;
    END;

    MACRO setCountryCode(countryCode)
        m_countryCode = countryCode;
    END;

    MACRO getCountryName()
        return m_countryName;
    END;

    MACRO setCountryName(countryName)
        m_countryName = countryName;
    END;

    MACRO getIssueNumber()
        return m_issueNumber;
    END;

    MACRO setIssueNumber(issueNumber)
        m_issueNumber = issueNumber;
    END;

    MACRO getIssueSubsectionNumber()
        return m_issueSubsectionNumber;
    END;

    MACRO setIssueSubsectionNumber(issueSubsectionNumber)
        m_issueSubsectionNumber = issueSubsectionNumber;
    END;
    
    MACRO getLevelNumber()
        return m_levelNumber;
    END;               

    MACRO setLevelNumber(levelNumber)
        m_levelNumber = levelNumber;
    END;               

    MACRO getDirection()
        return m_direction;
    END;               

    MACRO setDirection(direction)
        m_direction = direction;
    END;               

    MACRO getRestKind()
        return m_restKind;
    END;               

    MACRO setRestKind(restKind)
        m_restKind = restKind;
    END;               
END;

private CLASS (TException) TInsertTempTableException()
    initTException("Ошибка вставки записи во временную таблицу");
END;
                     
/*Класс временной таблицы*/
CLASS TTemporaryTable (tableName)
    private const m_tableName = "df664exp_tmp";
    
    private var m_inserter = TRsbDataSet("SELECT *"
                                + "\n" + "  FROM " + m_tableName
                                + "\n" + " WHERE 0 = 1", RSDVAL_CLIENT, RSDVAL_STATIC);
                             
    macro truncate()
        SQL_Truncate(m_tableName);
    end;

    macro getTableName()
        return m_tableName;
    end;

    macro insert(dataSource : TTemporaryTableRecord)

        m_inserter.addNew();

        m_inserter.currencyCode          = dataSource.getCurrencyCode();
        m_inserter.currencyName          = dataSource.getCurrencyName();
        m_inserter.currencyNumber        = dataSource.getCurrencyNumber();
        m_inserter.commonDebit           = dataSource.getCommonDebit();
        m_inserter.commonCredit          = dataSource.getCommonCredit();
        m_inserter.restIn                = dataSource.getRestIn();
        m_inserter.restOut               = dataSource.getRestOut();
        m_inserter.operationKind         = dataSource.getOperationKind();
        m_inserter.debit                 = dataSource.getDebit();
        m_inserter.credit                = dataSource.getCredit();
        m_inserter.countryCode           = dataSource.getCountryCode();
        m_inserter.countryName           = dataSource.getCountryName();
        m_inserter.issueNumber           = dataSource.getIssueNumber();
        m_inserter.issueSubsectionNumber = dataSource.getIssueSubsectionNumber();
        m_inserter.levelNumber           = dataSource.getLevelNumber();
        m_inserter.direction             = dataSource.getDirection();
        m_inserter.restKind              = dataSource.getRestKind();

        if (m_inserter.Update() != true)
            throw(TInsertTempTableException());
        end;

    end;
END;

/*Класс буфера строки, которая будет помещаться в файл экспорта*/
CLASS TExportString(issueNumber, exportFile, isHeader)

    private var m_word:TArray;
    private var m_issueNumber;
    private var m_exportFile;
    private var m_isHeader;

    
    local MACRO constructor(issueNumber, exportFile, isHeader)
        var i = 0;
        var stringSize;

        m_issueNumber = issueNumber;

        if (IssueNumber == 1)
            stringSize = 10;    
        elif (IssueNumber == 2)
            stringSize = 7;
        elif (IssueNumber == 3)
            stringSize = 8;
        end;

        m_word = TArray(stringSize);

        while (i < stringSize)
            m_word[i] = "";
            i = i + 1;
        end; 

        m_exportFile = exportFile;

        m_isHeader = isHeader;

    END;

    MACRO setWord(i, word)
        m_word[i] = word;
    END;

    MACRO getWord(i)
        return m_word[i]; 
    END;

    MACRO putStringToExportFile()
        var stringForExport = "";
        var parameter;
        var i = 1;  /*Не берем нулевой параметр, так как там лежит указатель на this*/

        while(GetParm(i, parameter))
            if(ValType(parameter) != V_STRING)
                parameter = string(parameter:0:3 );
            end;
            if (m_isHeader)
                stringForExport = stringForExport + "," + parameter + "";
            else
                stringForExport = stringForExport + ",\"" + parameter + "\"";
            end;
            i = i + 1;
        end;

        stringForExport = SubStr(stringForExport, 2);

        insert(m_exportFile, stringForExport);

    END;

    MACRO exportEmptyIssue()

        if (m_issueNumber == 1)

            putStringToExportFile("", "Данные отсутствуют", "", "", "", "", "", "1", "1", "");

        elif (m_issueNumber == 2)

            putStringToExportFile("", "Данные отсутствуют", "", "", "1", "1", "");

        elif (m_issueNumber == 3)

            putStringToExportFile("", "Данные отсутствуют", "", "", "", "1", "1", "");

        end;

    END;

    MACRO putStringFromBufferToFile()
        
        if (m_issueNumber == 1)

            putStringToExportFile(m_word[0],
                                  m_word[1],
                                  m_word[2],
                                  m_word[3],
                                  m_word[4],
                                  m_word[5],
                                  m_word[6],
                                  m_word[7],
                                  m_word[8],
                                  m_word[9]);

       elif (m_issueNumber == 2)

            putStringToExportFile(m_word[0],
                                  m_word[1],
                                  m_word[2],
                                  m_word[3],
                                  m_word[4],
                                  m_word[5],
                                  m_word[6]);

       elif (m_issueNumber == 3)

            putStringToExportFile(m_word[0],
                                  m_word[1],
                                  m_word[2],
                                  m_word[3],
                                  m_word[4],
                                  m_word[5],
                                  m_word[6],
                                  m_word[7]);

       end;

    END;

    constructor(issueNumber, exportFile, isHeader);

END;

/*Базовый класс экспорта одного раздела (или подраздела)*/  
CLASS TExportIssue(exportIssueName, rootAttributeName)
    private var m_exportIssueName;         /*имя раздела экспорта*/
    private var m_rootAttributeName;        /*имя переменной, отвечающей за раздел*/
    private var m_temporaryTable:TTemporaryTable;

    local MACRO constructor(exportIssueName, rootAttributeName)
        m_exportIssueName  = exportIssueName; 
        m_rootAttributeName = rootAttributeName;
    END;

    private MACRO putDataToTemporaryTable()
          throw(TPureVirtualMethodCallException("TExportIssue::putDataToTemporaryTable"));
    END;

    private  MACRO exportIssue()
        throw(TPureVirtualMethodCallException("TExportIssue::exportIssue"));
    END;

    constructor(exportIssueName, rootAttributeName);

END;
