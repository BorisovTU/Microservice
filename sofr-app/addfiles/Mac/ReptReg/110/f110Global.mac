/*
$Name:          f110Global.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 110. Глобальные константы и переменные для формы
*/
/**
 * Форма 110. Глобальные переменные для формы.
 *
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import RcbGlobal;
import globals;

//вид резерва л/с
const RESERVE_KIND_RVP  = "'1'";
const RESERVE_KIND_RVPS = "'2'";

const BIS_EXPORT_IN_THOUSANDS_MODE = 1;
const BIS_EXPORT_IN_ROUBLE_MODE    = 2;

const DEAL_KIND_ATTRACTION = "'Привлечение'";
const DEAL_KIND_PLACEMENT  = "'Размещение '";

const BO_NAME_GK       = "ГК";
const BO_NAME_BOIBC    = "МБК";
const BO_NAME_LOANS    = "Кредитование";
const BO_NAME_DEPOSITS = "Депозиты";
const BO_NAME_RETAIL   = "Ритейл";

const PCN_ROW_NUMBER = "Номер строки";
const PCN_DECODE = "Расшифровка";
const PCN_BACK_OFFICE = "Бэк-офис";
const PCN_ACCOUNT = "Номер лицевого счета";
const PCN_ACC_ROUBLE_REST = "Остаток счета в рублевом эквиваленте";
const PCN_CONTRACT_DEALS_NUMBER = "Номер договора/сделки МБК";
const PCN_CONTRACT_DEALS_DATE = "Дата договора/сделки МБК";
const PCN_RVPS_MAIN_REST_ACCOUNT = "Счет резерва ОД";
const PCN_RVPS_SUM = "Сумма РВПС по ОД";
const PCN_RVPS_DELAYED_MAIN_REST_ACC = "Счет РВПС по просроченному ОД";
const PCN_RVPS_DELAYED_SUM = "Сумма РВПС по просроченному ОД";
const PCN_PERC_RVP_SUM = "Сумма РВП по процентам";
const PCN_RVP_DELAYED_PERCENT = "Сумма РВП по просроченным процентам";
const PCN_COMMISSION_RVP_SUM = "Сумма РВП по комиссиям";
const PCN_RVP_PENALTY_SUM = "Сумма РВП по неустойкам";
const PCN_INC_ADJ_MAIN_DEBT_RESERVE_ACC = "Счет корректировки, увеличивающей резерв по ОД";
const PCN_INC_ADJ_MAIN_DEBT_RESERVE  = "Сумма корректировки, увеличивающей резерв по ОД";
const PCN_DEC_ADJ_MAIN_DEBT_RESERVE  = "Сумма корректировки, уменьшающей резерв по ОД";
const PCN_DEC_ADJ_MAIN_DEBT_RESERVE_ACC = "Счет коррекировки, уменьшающей резерв по ОД";
const PCN_INC_ADJ_DEL_DEBT_RESERVE_ACC = "Счет корректировки, увеличивающей резерв по просроченному ОД";
const PCN_INC_ADJ_DEL_DEBT_RESERVE = "Сумма корректировки, увеличивающей резерв по просроченному ОД";
const PCN_DEC_ADJ_DEL_DEBT_RESERVE_ACC = "Счет коррекировки, уменьшающей резерв по просроченному ОД";
const PCN_DEC_ADJ_DEL_DEBT_RESERVE = "Сумма корректировки, уменьшающей резерв по просроченному ОД";
const PCN_MAIN_REST_AMOUNT = "Остаток ОД";
const PCN_DELAYD_MAIN_REST_AMOUNT = "Остаток просроченного ОД";
const PCN_ACCRUED_INTEREST_AMOUNT = "Сумма начисленных %";
const PCN_DELAYD_PERCENT_AMOUNT = "Сумма просроченных %";
const PCN_COMISS_AMOUNT = "Сумма начисленных комиссий";
const PCN_DELAYD_COMISS_AMOUNT = "Сумма начисленных и просроченных комиссий";
const PCN_REGISTER = "Номер регистра";
const PCN_REGISTER_DATE = "Дата изменения регистра";
const PCN_REGISTER_SUM = "Сумма прихода по регистру регистра";
const PCN_DOC_NUMBER = "Номер документа";
const PCN_DOC_DATE = "Дата документа";
const PCN_DEBET = "Счет Дебет";
const PCN_CREDIT = "Счет Кредит";
const PCN_DOC_SUM = "Сумма документа в национальной валюте";
const PCN_CURRENCY = "Валюта счета/договора";
const PCN_CONTRAGENT = "Контрагент";
const PCN_ACC_CURRENCY_REST = "Остаток в валюте счета";
const PCN_REGISTER_ROUBLE_REST = "Остаток регистра в рублях";
const PCN_REGISTER_CURRENCY_REST = "Остаток регистра в валюте";

private var m_global = null;

class (TGlobalBase) TGlobal
    private var m_calculateMmData         : bool;
    private var m_calculateSecuritiesData : bool;
    /**
     * Получить дату начала года.
     * необходимо для вычисления большинства показателей отчета
     */
    macro getBeginYearDate(report : RcbReport)
       defaultParm(report, rcbApplication().currentReport);

       var year;

       dateSplit(report.context.period.endDate, NULL, NULL, year);

       return date(1, 1, year);
    end;

    //дата приходится на последний день месяца?
    macro isDateFallsOnLastDayInMonth(_date : Date) : Bool
        var d, m, y;

        DateSplit(_date, d, m, y);

        if (_date == (Date(1, ternary(m == 12, 1, m + 1), ternary(m == 12, y + 1, y)) - 1))
            return true;
        else
            return false;
        end;
    end;

    /**
     * Определение режима экспорта для kliko и ПТК ПСД
     */
    macro getExportMode()
        var currentMonth : Integer = 0;
        var reportPeriod : Object = RcbApplication().currentReport.context.period;

        RcbApplication().TransactionManager().commit();
        var m_isNeedPart_2_3 = RcbApplication().currentReport.attributeValue("Принудит_расчет_разд_2_и_3").scaled;

        dateSplit(reportPeriod.endDate, null, currentMonth, null);

        //регламентируемый период = "месяц"
        if (    isDateFallsOnLastDayInMonth(reportPeriod.endDate)
            and (mod(currentMonth, 3) != 0)
            and (m_isNeedPart_2_3 != 1))
            return 1;
        end;

        //на внутримесячную (внутриквартальную) дату
        if (    isDateFallsOnLastDayInMonth(reportPeriod.endDate)
            and (mod(currentMonth, 3) != 0)
            and (m_isNeedPart_2_3 == 1))
            return 2;
        end;

        //регламентируемый период = "месяц"
        if (    isDateFallsOnLastDayInMonth(reportPeriod.endDate)
            and (mod(currentMonth, 3) == 0))
            return 3;
        end;

        //на внутримесячную (внутриквартальную) дату
        if (not isDateFallsOnLastDayInMonth(reportPeriod.endDate))
            return 4;
        end;

        return -1;
    end;

    macro isCalculatedMmData()
        return m_calculateMmData;
    end;

    macro isCalculatedSecuritiesData()
        return m_calculateSecuritiesData;
    end;

    private macro setCalculatedMmData()
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 110/ДАННЫЕ МБК", V_BOOL, m_calculateMmData, NULL);
    end;

    private macro setCalculatedSecuritiesData()
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 110/ДАННЫЕ SECURITIES", V_BOOL, m_calculateSecuritiesData, NULL);
    end;

    /**
     * Инициализация пакета с датами периода и пакета с символами ОПУ.
     *
     */
    macro initializePackages(report : RcbReport)
        defaultParm(report, rcbApplication.currentReport);

        initializeRepDataPackage(report);

        var number = null;
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 102/ЧИСЛО ЗНАКОВ СИМВОЛА В СЧЕТЕ", V_INTEGER, number, null);
        sql_execute("CALL rcb_opu.setSymbolDefinitionKind(" + nvl(number, 0) + ")");

        getRegistryValue("REPTREG/REP_GROUPS/COMMON/УЧЁТ ИСПРАВИТЕЛЬНЫХ ОБОРОТОВ", V_BOOL, number, null);
        sql_execute("CALL rep_data.initCorrectDocumentParameters("+ternary(number, 1, 0) + ","
                                                                  +getSqlDate(getBeginYearDate())+ ","
                                                                  +getSqlDate(rcbApplication().currentReport.context.period.endDate)+")");

        var m_topSelfId;
        var dataSet = TRsbDataSet("SELECT rsb_rep_pt.get_top_superior_id(" + {OurBank} + ") t_topSelfId FROM DUAL");
        if (dataSet.next())
            m_topSelfId = dataSet.topSelfId;
            sql_truncate("dfforourbank_tmp");
            sql_execute("INSERT INTO dfforourbank_tmp"
                +"\n" + "    SELECT t_partyid"
                +"\n" + "      FROM dparty_dbt party"
                +"\n" + "     WHERE rsb_rep_pt.is_our_bank(party.t_partyId, " + m_topSelfId + ") = 1");

        end;

        setCalculatedMmData();
        setCalculatedSecuritiesData();
    end;
end;

macro global() : TGlobal
    if (m_global == null)
        m_global = TGlobal();
    end;

    return m_global;
end;