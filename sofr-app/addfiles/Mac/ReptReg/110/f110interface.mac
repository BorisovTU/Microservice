/*
$Name:          f110interface.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 110. интерфейс доступа к операциям формы
*/

/**
 * Форма 110. Доступ к операциям формы.
 *
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import ReptCBInter;
import RcbCoreInter;
import ReportNormalizer;
import testLib;
import or_rep_h;

import f110CalculationController;
import f110CalculationController_4927;
import f110PrintController;
import f110CalculationProtocolView;
import f110KlikoExportController;
import f110KlikoView;
import f110DataSource;
import f110TuneTable;
import f110Report;
import f110ReportView;
import f110PtkPsdExportController;
import f110Normalizer;
import f110NormalizationController;
import f110NormalizationProtocolView;

import f110ObjectFactory;
import f110Global;

import f110BiscuitExportController;
import f110BiscuitView;

/**
 *  Запуск операции расчета отчета
 */
macro executeCalculationOperation()
    /*
    var profiler = TSQLProfiler(getTxtFileName("!F110CalculateProfile"));
    profiler.clear();
    profiler.on();
    */
     if (rcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE)
         RepErrorsQueue().add(0, "Выпуск отчета возможен только за период, дата окончания которого больше или равна" + RCB_I2055_DATE);
         msgbox("Выпуск отчета возможен только за период, дата окончания которого больше или равна " + RCB_I2055_DATE);
         установитьФлагВозврата(STOP_PROC_FLG);
         exit(1);
     end;
     global.initializePackages();
     objectFactoryInstance.createCalculationController().calculateReport();
end;

/**
 *  Запуск операции нормализации
 */
macro executeNormalizationOperation()
    objectFactoryInstance.createNormalizationController().execute();
end;

/**
 *  Запуск операции печати отчета
 */
macro executePrintOperation()
    objectFactoryInstance.createPrintController().execute();
end;

/**
 *  Запуск операции печати отчета в Excel
 */
macro executePrintExcelOperation()
    objectFactoryInstance.createPrintController(WINREP_FORMAT_XLSX).execute();
end;

/**
 *  Запуск операции экспорта в kliko.exe
 */
macro executeKlikoExportOperation()
    var mes;

    if (not rcbApplication().currentReport.isCalculated)
        TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko").checkCalculateReport("kliko.exe");
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;

    if (global.isDateFallsOnLastDayInMonth(RcbApplication().currentReport.context.period.endDate) == false)
        mes = "Отчетный период с " + RcbApplication().currentReport.context.period.beginDate + " по " +  RcbApplication().currentReport.context.period.endDate
            + " не соответствует периоду <месяц>, выберите операцию \"Экспорт в kliko.exe на вн.мес.д\".";

        msgbox(mes);
        RepErrorsQueue().add(0, mes);
    else
        objectFactoryInstance.createKlikoExportController().execute();
    end;
end;

/**
 *  Запуск операции экспорта в kliko.exe на внутримесячную дату по требованию
 */
macro executeKlikoExportOperationForDay()
    var mes;

	if (not rcbApplication().currentReport.isCalculated)
        TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko").checkCalculateReport("kliko.exe");
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;

    if (global.isDateFallsOnLastDayInMonth(RcbApplication().currentReport.context.period.endDate) == true)
        mes = "Дата окончания отчетного периода равна последнему календарному дню месяца, для экспорта отчета за месяц выберите операцию \"Экспорт в kliko.exe.\".";

        msgbox(mes);
        RepErrorsQueue().add(0, mes);
    else
        objectFactoryInstance.createKlikoExportController().execute();
    end;
end;

/**
 *  Запуск операции печати протокола экспорта в kliko.exe
 */
macro executePrintProtocolKlikoExportOperation()
    objectFactoryInstance.createKlikoExportController().printProtocol();
end;

/**
 *  Запуск операции экспорта в АС ПСД
 */
macro executePtkPsdExportOperation()
    if (not rcbApplication().currentReport.isCalculated)
        TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД").checkCalculateReport("АС ПСД");
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;

    if (rcbApplication().currentReport.context.period.endDate < RCB_I2742_DATE)
         RepErrorsQueue().add(0, "Экспорт отчета в АС ПСД возможен только за период, дата окончания которого больше или равна\n " + RCB_I2742_DATE);
         msgbox("Экспорт отчета в АС ПСД возможен только за период, дата окончания которого больше или равна " + RCB_I2742_DATE);
         установитьФлагВозврата(STOP_PROC_FLG);
         exit(1);
     end;
    objectFactoryInstance.createPtkPsdExportController().execute();
end;

/**
 *  Запуск операции экспорта в БИСквит
 */
macro executeBiscuitExportOperation()
    const MODE_LABEL   = "-mode:";

    var modeLabelIndex = index(cmdArgs, MODE_LABEL);
    var inThousands    = ternary(substr(cmdArgs, modeLabelIndex + strlen(MODE_LABEL), strlen("inThousands")) == "inThousands", BIS_EXPORT_IN_THOUSANDS_MODE, BIS_EXPORT_IN_ROUBLE_MODE);

    if (not rcbApplication().currentReport.isCalculated)
        TProtocolView("ПРОТОКОЛ ЭКСПОРТА В БИСквит").checkCalculateReport("БИСквит");
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;

    objectFactoryInstance.createBiscuitExportController(inThousands).execute();
end;

/**
 *  Запуск операции печати протокола экспорта в АС ПСД
 */
macro executePrintProtocolPtkPsdExportOperation()
    objectFactoryInstance.createPtkPsdExportController().printProtocol();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
