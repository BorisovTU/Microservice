/*
$Name:          f110DataSource.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 110. Источники данных для расчета атрибутов
*/

/**
 * Форма 110. Источники данных для расчета атрибутов.
 *
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import rcb_lib;
import RsbDataSet;

import f110DataSourceProtocols;
import f110DataSourceFilters;

import scf110_data;

CONST PLUS  = false;
CONST MINUS = true;

class TBoAccounts()
    private var m_accounts = TArray;

    macro clearAccounts()
        sql_execute("TRUNCATE TABLE df110BoAccounts_tmp");
        m_accounts = TArray;
    end;

    // Добавить счет
    macro addAccount(account : String)
        if (valType(account) == V_UNDEF)
            return;
        end;

        m_accounts[m_accounts.size] = account;
    end;

    // Вставка в таблицу из массива
    macro insertAccounts()
        var query = "INSERT INTO df110BoAccounts_tmp (t_account) VALUES (?)";

        var inserter = RsbSqlInsert(query, 1, m_accounts.size);

        inserter.addParam(V_STRING, m_accounts, 27);
        inserter.insert();

        sql_execute("COMMIT");
    end;
end;

/**
 * Базовый класс источников данных.
 *
 */
class TDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol)

    private macro RcbDataSet(text)

        if (not protocolIsOn())
           var cmd = RsdCommand("{ ? = CALL rep_utl.excludeFromQueryDetailedRows(?) }");
           cmd.AddParam( "newText",  RSDBP_RETVAL, V_STRING, 32000);
           cmd.addParam( "",         RSDBP_IN,     text );

           cmd.execute;
           text  = cmd.value( "newText" );
           cmd.close();
        end;

        return TRsbDataSet(text);

        OnError(er);
            msgbox( cmd, "Ошибка.", er.message );
            RepErrorsQueue().add(0, string(er.message));
            return text;
    end;


    /**
     * Фильтр для источника данных.
     */
    private var m_filter : TDataSourceFilters;

    /**
     * Протокол источника данных.
     */
    private var m_protocol : TDataSourceProtocol;
    private var m_useBoAccounts = false;

    macro setUseBoAccounts(value : bool)
        m_useBoAccounts = value;
    end;

    macro isUseBoAccounts()
        return m_useBoAccounts;
    end;

    /**
     * Конструктор.
     */
    macro constructor(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
        m_filter   = filter;
        if (protocol != NULL)
            m_protocol = protocol;
        end;
    end;

    /**
     * Получить объект с фильтрами для источника данных.
     */
    macro getFilter() : TDataSourceFilters
        return  m_filter;
    end;

    /**
     * Удаление закешированных данных.
     */
    macro clear()
    end;

    /**
     * Кеширование данных.
     */
    macro cacheData()
    end;

    constructor(filter, protocol);
end;

/**
 * Источник данных по договорам Loans.
 *
 */
class (TDataSource) TDataSourceLoansCredit()

    macro constructor()
        initTDataSource(TDataSourceFilterLoansCredit(), TProtocolLoansCredit());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df110credit_tmp");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()
       var querySource =   "SELECT t_id   AS a_creditNumber,"
                  + "\n" + "       t_type AS a_type         "
                  + "\n" + "  FROM repLnsContract_vw        "
                  + "\n" + " WHERE (t_isOpened = 1          "
                  + "\n" + "        AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId") + ")";

       var command = RsdCommand(rslDefCon);

       command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
       command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
       command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
       command.addParam("DataSource", RSDBP_IN, querySource);

       command.execute();

       sql_execute(        "INSERT INTO df110credit_tmp (t_id,                                           "
                  + "\n" + "                             t_number,                                       "
                  + "\n" + "                             t_openDate,                                     "
                  + "\n" + "                             t_includeInCase,                                "
                  + "\n" + "                             t_type,                                         "
                  + "\n" + "                             t_rvpsSum,                                      "
                  + "\n" + "                             t_delayedRvpsSum,                               "
                  + "\n" + "                             t_percRvpSum,                                   "
                  + "\n" + "                             t_commissionRvpSum,                             "
                  + "\n" + "                             t_contragentId)                                 "
                  + "\n" + "SELECT contract.t_id,                                                                 "
                  + "\n" + "       contract.t_number,                                                             "
                  + "\n" + "       contract.t_openDate,                                                           "
                  + "\n" + "       CASE WHEN (  ((contract.t_briefCaseId = 0) OR (contract.t_briefCaseId IS NULL))         "
                  + "\n" + "                AND ((contract.t_portfolioDebtId) = 0 OR (contract.t_portfolioDebtId) IS NULL))"
                  + "\n" + "            THEN 0                                                           "
                  + "\n" + "            ELSE 1                                                           "
                  + "\n" + "       END t_includeInCase,                                                  "
                  + "\n" + "       contract.t_type,                                                               "
                  + "\n" + "       reserve.t_rvpsSum,                                                            "
                  + "\n" + "       reserve.t_delayedRvpsSum,                                                     "
                  + "\n" + "       reserve.t_percentRvpSum,                                                      "
                  + "\n" + "       reserve.t_commissionRvpSum,                                                   "
                  + "\n" + "       contract.t_contragentId                                                        "
                  + "\n" + "  FROM repLnsContract_vw contract, repLnsReserve_vw reserve                                                     "
                  + "\n" + " WHERE contract.t_id = reserve.t_objectNumber AND contract.t_type = reserve.t_objectTypeid");

       sql_execute(        "INSERT INTO df110creditsAccount_tmp ( t_creditId,                            "
                  + "\n" + "                                      t_chapter,                             "
                  + "\n" + "                                      t_fiId,                                "
                  + "\n" + "                                      t_account)                             "
                  + "\n" + "SELECT t_contractId,                                                         "
                  + "\n" + "       t_chapter,                                                            "
                  + "\n" + "       t_fiId,                                                               "
                  + "\n" + "       t_account                                                             "
                  + "\n" + "  FROM repLnsAccount_vw                                                      "
                  + "\n" + " WHERE (t_type IN ('С', 'З')                                                 "
                  + "\n" + "        AND EXISTS (SELECT 1 FROM df110credit_tmp WHERE t_id = t_contractId) "
                  + "\n" + "       ) ");

    end;

    private macro getData(select : String, filter : String)
        var credit = RcbDataSet( select
        + "\n" + "  FROM df110credit_tmp credit                                                "
        + "\n" + " WHERE 1 = 1                                                                 "
        + "\n" +          NVL(filter, " ")
        + "\n" + " GROUP BY ROLLUP ((credit.t_number,                                          "
        + "\n" + "                   credit.t_openDate,                                        "
        + "\n" + "                   credit.t_rvpsSum,                                         "
        + "\n" + "                   credit.t_delayedRvpsSum,                                  "
        + "\n" + "                   credit.t_percRvpSum,                                      "
        + "\n" + "                   credit.t_commissionRvpSum                                 "
        + "\n" + "                 ))                                                          "
        + "\n" + " ORDER BY GROUPING (credit.t_number) DESC, credit.t_openDate, credit.t_number");

        var hasData = credit.moveNext();
        var sum     = 0;

        if (hasData)
            sum = credit.sum;
        end;

        m_protocol.printProtocol(credit, hasData);

        return sum;
   end;

    /**
     * Сумма РВПС по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getRvpsSum(filter : String)
        var select =
                 "SELECT credit.t_number            t_number,          "
        + "\n" + "       credit.t_openDate          t_openDate,        "
        + "\n" + "       credit.t_rvpsSum           t_rvpsSum,         "
        + "\n" + "       'X'                        t_delayedRvpsSum,  "
        + "\n" + "       'X'                        t_percRvpSum,      "
        + "\n" + "       'X'                        t_commissionRvpSum,"
        + "\n" + "       SUM (credit.t_rvpsSum)     t_sum              ";

        filter = filter + "\n AND credit.t_rvpsSum != 0 ";
        return getData(select, filter);
    end;

    /**
     * Сумма РВПС_проср по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getBadRvpsSum(filter : String)
        var select =
          "\n" + " SELECT   credit.t_number               t_number,          "
        + "\n" + "          credit.t_openDate             t_openDate,        "
        + "\n" + "          'X'                           t_rvpsSum,         "
        + "\n" + "          credit.t_delayedRvpsSum       t_delayedRvpsSum,  "
        + "\n" + "          'X'                           t_percRvpSum,      "
        + "\n" + "          'X'                           t_commissionRvpSum,"
        + "\n" + "          SUM (credit.t_delayedRvpsSum) t_sum              ";

        filter = filter + "\n AND credit.t_delayedRvpsSum != 0 ";
        return getData(select, filter);
    end;

    /**
     * Сумма РВП_проц+РВП_комиссии по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getRvpSum(filter : String)
        var select =
        " SELECT   credit.t_number               t_number,                               "
        "          credit.t_openDate             t_openDate,                             "
        "          'X'                           t_rvpsSum,                              "
        "          'X'                           t_delayedRvpsSum,                       "
        "          credit.t_percRvpSum           t_percRvpSum,                           "
        "          credit.t_commissionRvpSum     t_commissionRvpSum,                     "
        "          SUM (credit.t_percRvpSum + credit.t_commissionRvpSum) t_sum           ";

        filter = filter + " AND (credit.t_percRvpSum + credit.t_commissionRvpSum) != 0   ";
        return getData(select, filter);
    end;

    constructor();
end;

/**
 * Источник данных по договорам Loans.
 *
 */
class (TDataSource) TDataSourceLoansCredit_4927()
    macro constructor()
        initTDataSource(TDataSourceFilterLoansCredit(), TProtocolLoansCredit_4927());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df110credit_tmp");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()
       var querySource =   "SELECT t_id   AS a_creditNumber,"
                  + "\n" + "       t_type AS a_type         "
                  + "\n" + "  FROM repLnsContract_vw        "
                  + "\n" + " WHERE (t_isOpened = 1          "
                  + "\n" + "        AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId") + ")";

       var command = RsdCommand(rslDefCon);

       command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
       command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
       command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
       command.addParam("DataSource", RSDBP_IN, querySource);

       command.execute();

       sql_execute(        "INSERT INTO df110credit_tmp (t_id,                                           "
                  + "\n" + "                             t_number,                                       "
                  + "\n" + "                             t_openDate,                                     "
                  + "\n" + "                             t_isOpened,                                     "
                  + "\n" + "                             t_isOpenedAtEndDate,                            "
                  + "\n" + "                             t_includeInCase,                                "
                  + "\n" + "                             t_type,                                         "
                  + "\n" + "                             t_rvpsSum,                                      "
                  + "\n" + "                             t_delayedRvpsSum,                               "
                  + "\n" + "                             t_percRvpSum,                                   "
                  + "\n" + "                             t_commissionRvpSum,                             "
                  + "\n" + "                             t_penaltiesReserveSum,                          "
                  + "\n" + "                             t_delaydComissAmount,                           "
                  + "\n" + "                             t_assessmentCategoryIfrs,                       "
                  + "\n" + "                             t_contragentId)                                 "
                  + "\n" + "SELECT contract.t_id,                                                                 "
                  + "\n" + "       contract.t_number,                                                             "
                  + "\n" + "       contract.t_openDate,                                                           "
                  + "\n" + "       contract.t_isOpened,                                                           "
                  + "\n" + "       contract.t_isOpenedAtEndDate,                                                           "
                  + "\n" + "       CASE WHEN (  ((contract.t_briefCaseId = 0) OR (contract.t_briefCaseId IS NULL))         "
                  + "\n" + "                AND ((contract.t_portfolioDebtId) = 0 OR (contract.t_portfolioDebtId) IS NULL))"
                  + "\n" + "            THEN 0                                                           "
                  + "\n" + "            ELSE 1                                                           "
                  + "\n" + "       END t_includeInCase,                                                  "
                  + "\n" + "       contract.t_type,                                                               "
                  + "\n" + "       reserve.t_rvpsSum,                                                             "
                  + "\n" + "       reserve.t_delayedRvpsSum,                                                      "
                  + "\n" + "       reserve.t_percentRvpSum,                                                       "
                  + "\n" + "       reserve.t_commissionRvpSum,                                                    "
                  + "\n" + "       reserve.t_penaltiesReserveSum,                                                 "
                  + "\n" + "       contract.t_delaydComissAmount,                                                 "
                  + "\n" + "       contract.t_assessmentCategoryIfrs,                                             "
                  + "\n" + "       contract.t_contragentId                                                        "
                  + "\n" + "  FROM repLnsContract_vw contract, repLnsReserve_vw reserve                           "
                  + "\n" + " WHERE contract.t_id = reserve.t_objectNumber AND contract.t_type = reserve.t_objectTypeid");

       sql_execute(        "INSERT INTO df110creditsAccount_tmp ( t_creditId,                            "
                  + "\n" + "                                      t_chapter,                             "
                  + "\n" + "                                      t_fiId,                                "
                  + "\n" + "                                      t_account,                             "
                  + "\n" + "                                      t_rest )                               "
                  + "\n" + "SELECT t_contractId,                                                         "
                  + "\n" + "       t_chapter,                                                            "
                  + "\n" + "       t_fiId,                                                               "
                  + "\n" + "       t_cbAccount,                                                          "
                  + "\n" + "       T_OUTREST                                                             "
                  + "\n" + "  FROM repLnsAccount_vw                                                      "
                  + "\n" + " WHERE (t_type IN ('С', 'З')                                                 "
                  + "\n" + "        AND EXISTS (SELECT 1 FROM df110credit_tmp WHERE t_id = t_contractId) "
                  + "\n" + "       ) ");

    end;

    private macro getDataFromAddTable(sourceTable : String, fieldsArray : RcbArray, creditFilter : String, accountMasks : String, protocolFieldsName : RcbArray, linkField : String, protocol, isMinus : bool)
        defaultParm(linkField, "t_contractId");
        defaultParm(isMinus, false);

        var fieldsAlias = ternary(sourceTable == "", "credit.", "addTable.");
        var where = "\n WHERE 1 = 1 " + creditFilter;
        var whereNonZero = "\n AND (";
        var select = "SELECT credit.t_number AS t_number,"
            + "\n" + "       credit.t_openDate AS t_openDate";
        var groupBy = "\n GROUP BY ROLLUP ((t_number, t_openDate";
        var orderBy = "\n ORDER BY (t_openDate) DESC";
        var isFirst = true;
        var totalSum = ",\n SUM(";
        var hasAccountFields = false;
        var accountsFields = TArray;

        fieldsArray.moveFirst();
        while (fieldsArray.moveNext())
            select = select + ", \n SUM (" + fieldsAlias + fieldsArray.getCurrentItem() + ") " + ternary(isMinus, " * (-1) ", "") + " AS " + fieldsArray.getCurrentItem();
            totalSum = totalSum + ternary(isFirst, "", " + ") + fieldsArray.getCurrentItem();
            whereNonZero = whereNonZero + ternary(isFirst, "", "\n OR ") + fieldsArray.getCurrentItem() + " != 0 ";
            fieldsArray.moveNext();
            if (fieldsArray.getCurrentItem() != "")
                hasAccountFields = true;
                select = select + ", \n " + fieldsAlias + fieldsArray.getCurrentItem() + " AS " + fieldsArray.getCurrentItem();
                groupBy = groupBy + ", " + fieldsArray.getCurrentItem();
                orderBy = orderBy + ", " + fieldsArray.getCurrentItem();

                where = where + ternary(isFirst, "\n AND (", "\n  OR ");
                where = where + getFilter().isSatisfiesToMasks( + fieldsAlias + fieldsArray.getCurrentItem(), accountMasks);

                accountsFields[accountsFields.size] = fieldsArray.getCurrentItem();
            end;
            isFirst = false;
        end;

        if (hasAccountFields)
            where = where + ")";
        end;

        whereNonZero = whereNonZero + ")";
        groupBy = groupBy + "))";
        totalSum = totalSum + ") " + ternary(isMinus, " * (-1) ", "") + " AS t_totalSum";
        select = select + totalSum;

        var from = "\n FROM df110credit_tmp credit";

        if (sourceTable != "")
            from = from + ", " + sourceTable + " addTable";
            where = where + "\n AND credit.t_id = addTable." + linkField;
        end;

        var query = select + from + where + whereNonZero + groupBy + orderBy;
        var dataSet = RcbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("t_openDate", V_DATE);

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.totalSum;

            if (isUseBoAccounts())
                var boAcc = TBoAccounts();

                while (dataSet.moveNext())
                    var field;
                    for (field, accountsFields)
                        boAcc.addAccount(dataSet.value(field));
                    end;
                end;
                boAcc.insertAccounts();
                dataSet.moveFirst();
            end;
        end;

        if (protocolFieldsname.size > 0)
            if (protocol != null)
                fieldsArray.push_back("t_number");
                fieldsArray.push_back("t_openDate");
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_NUMBER);
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_DATE);

                protocol.printData(dataSet, hasData, protocolFieldsName, fieldsArray, BO_NAME_LOANS);
            end;
        end;

        return sum;
   end;

    /**
     * Сумма РВПС по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getRvpsSum(filter : String, protocol)
        var credit = RcbDataSet(" SELECT credit.t_number        t_number,   "
         + "\n" + "                      credit.t_openDate      t_openDate, "
         + "\n" + "                      acc.t_account          t_account,  "
         + "\n" + "                      credit.t_rvpsSum       t_rvpsSum,  "
         + "\n" + "                      SUM (credit.t_rvpsSum) t_sum       "
         + "\n" + "                 FROM df110credit_tmp credit,            "
         + "\n" + "                      df110creditsAccount_tmp acc        "
         + "\n" + "                WHERE credit.t_id = acc.t_creditId       "
         + "\n" + "                  AND credit.t_rvpsSum != 0              "
         + "\n" +                        NVL(filter, " ")
         + "\n" + " GROUP BY ROLLUP ((credit.t_number,                      "
         + "\n" + "                   credit.t_openDate,                    "
         + "\n" + "                   acc.t_account,                        "
         + "\n" + "                   credit.t_rvpsSum                      "
         + "\n" + "                 ))                                      "
         + "\n" + " ORDER BY GROUPING (credit.t_number) DESC, acc.t_account, credit.t_openDate, credit.t_number"
                                , RSDVAL_CLIENT, RSDVAL_STATIC);

        credit.SetFieldType("t_openDate", V_DATE);

        var hasData = credit.moveNext();
        var sum     = 0;

        if (hasData)
            sum = credit.sum;

            protocol.printData(credit, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                      PCN_CONTRACT_DEALS_NUMBER,
                                                                      PCN_CONTRACT_DEALS_DATE,
                                                                      PCN_RVPS_SUM
                                                                      ),
                                                   RcbArray().initialize("t_account",
                                                                         "t_number",
                                                                         "t_openDate",
                                                                         "t_rvpsSum"
                                                                         ),
                             BO_NAME_LOANS
                            );

        end;

        if (protocol != null)
            protocol.printData(credit, hasData);
        end;

        return sum;
    end;

    /**
     * Сумма РВПС_проср по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getBadRvpsSum(filter : String, protocol)
        var credit = RcbDataSet(" SELECT credit.t_number        t_number,   "
         + "\n" + "                      credit.t_openDate      t_openDate, "
         + "\n" + "                      acc.t_account          t_account,  "
         + "\n" + "                      credit.t_delayedRvpsSum t_delayedRvpsSum,  "
         + "\n" + "                      SUM (credit.t_rvpsSum) t_sum       "
         + "\n" + "                 FROM df110credit_tmp credit,            "
         + "\n" + "                      df110creditsAccount_tmp acc        "
         + "\n" + "                WHERE credit.t_id = acc.t_creditId       "
         + "\n" + "                  AND credit.t_delayedRvpsSum != 0       "
         + "\n" +                        NVL(filter, " ")
         + "\n" + " GROUP BY ROLLUP ((credit.t_number,                      "
         + "\n" + "                   credit.t_openDate,                    "
         + "\n" + "                   acc.t_account,                        "
         + "\n" + "                   credit.t_delayedRvpsSum               "
         + "\n" + "                 ))                                      "
         + "\n" + " ORDER BY GROUPING (credit.t_number) DESC, acc.t_account, credit.t_openDate, credit.t_number"
                                , RSDVAL_CLIENT, RSDVAL_STATIC);

        credit.SetFieldType("t_openDate", V_DATE);

        var hasData = credit.moveNext();
        var sum     = 0;

        if (hasData)
            sum = credit.sum;

            protocol.printData(credit, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                      PCN_CONTRACT_DEALS_NUMBER,
                                                                      PCN_CONTRACT_DEALS_DATE,
                                                                      PCN_RVPS_DELAYED_SUM
                                                                      ),
                                                   RcbArray().initialize("t_account",
                                                                         "t_number",
                                                                         "t_openDate",
                                                                         "t_delayedRvpsSum"
                                                                         ),
                             BO_NAME_LOANS
                            );

        end;

        if (protocol != null)
            protocol.printData(credit, hasData);
        end;

        return sum;
    end;

    /**
     * Сумма РВП_проц+РВП_комиссии по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getRvpSum(filter : String, protocol)
        var credit = RcbDataSet(" SELECT credit.t_number t_number,  "
         + "\n" + "                      credit.t_openDate             t_openDate,    "
         + "\n" + "                      credit.t_percRvpSum           t_percRvpSum,                           "
         + "\n" + "                      credit.t_commissionRvpSum     t_commissionRvpSum,                     "
         + "\n" + "                      credit.t_penaltiesReserveSum  t_penaltiesReserveSum,                  "
         + "\n" + "                      SUM (credit.t_percRvpSum + credit.t_commissionRvpSum + credit.t_penaltiesReserveSum) t_sum           "
         + "\n" + "                 FROM df110credit_tmp credit                                                "
         + "\n" + "                WHERE (credit.t_percRvpSum + credit.t_commissionRvpSum + credit.t_penaltiesReserveSum) != 0   "
         + "\n" +                        NVL(filter, " ")
         + "\n" + " GROUP BY ROLLUP ((credit.t_number,                                          "
         + "\n" + "                   credit.t_openDate,                                        "
         + "\n" + "                   credit.t_percRvpSum,                                      "
         + "\n" + "                   credit.t_commissionRvpSum,                                "
         + "\n" + "                   credit.t_penaltiesReserveSum                              "
         + "\n" + "                 ))                                                          "
         + "\n" + " ORDER BY GROUPING (credit.t_number) DESC, credit.t_openDate, credit.t_number"
                                , RSDVAL_CLIENT, RSDVAL_STATIC);

        credit.SetFieldType("t_openDate", V_DATE);

        var hasData = credit.moveNext();
        var sum     = 0;

        if (hasData)
            sum = credit.sum;

            protocol.printData(credit, hasData, RcbArray().initialize(PCN_CONTRACT_DEALS_NUMBER,
                                                                      PCN_CONTRACT_DEALS_DATE,
                                                                      PCN_PERC_RVP_SUM,
                                                                      PCN_COMMISSION_RVP_SUM,
                                                                      PCN_RVP_PENALTY_SUM
                                                                      ),
                                                   RcbArray().initialize("t_number",
                                                                         "t_openDate",
                                                                         "t_percRvpSum",
                                                                         "t_commissionRvpSum",
                                                                         "t_penaltiesReserveSum"
                                                                         ),
                             BO_NAME_LOANS
                            );

        end;

        if (protocol != null)
            protocol.printData(credit, hasData);
        end;

        return sum;
    end;

    macro getCorrectIncReserveSum(accountMask : String, creditFilter : String, dataProtocol)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                   RcbArray.initialize("t_correctIncReserveSum", //Сумма корректировки, увеличивающей резерв по ОД
                                                       "t_correctIncReserveAccount", // Счет корректировки, увеличивающей резерв по ОД
                                                       "t_correctIncResOverdueSum", //Сумма корректировки, увеличивающей резерв по просроченому ОД
                                                       "t_correctIncResOverdueAccount"), //Счет корректировки, увеличивающей резерв по просроченому ОД
                                   creditFilter,
                                   accountMask,
                                   RcbArray.initialize(PCN_INC_ADJ_MAIN_DEBT_RESERVE,
                                                       PCN_INC_ADJ_MAIN_DEBT_RESERVE_ACC,
                                                       PCN_INC_ADJ_DEL_DEBT_RESERVE,
                                                       PCN_INC_ADJ_DEL_DEBT_RESERVE_ACC
                                                      ),
                                   null,
                                   dataProtocol
                                  );
        return value;
    end;

    macro getCorrectDecReserveSum(accountMask : String, creditFilter : String, dataProtocol, isMinus : bool)
        return getDataFromAddTable("repLnsIfrsEntities_vw",
                                   RcbArray.initialize("t_correctDecReserveSum", //Сумма корректировки, уменьшающей резерв по ОД
                                                       "t_correctDecReserveAcc", // Счет корректировки, уменьшающей резерв по ОД
                                                       "t_correctDecResOverdueSum", //Сумма корректировки, уменьшающей резерв по просроченому ОД
                                                       "t_correctDecResOverdueAcc"), //Счет корректировки, уменьшающей резерв по просроченому ОД
                                   creditFilter,
                                   accountMask,
                                   RcbArray.initialize(PCN_DEC_ADJ_MAIN_DEBT_RESERVE,
                                                       PCN_DEC_ADJ_MAIN_DEBT_RESERVE_ACC,
                                                       PCN_DEC_ADJ_DEL_DEBT_RESERVE,
                                                       PCN_DEC_ADJ_DEL_DEBT_RESERVE_ACC
                                                      ),
                                   null,
                                   dataProtocol,
                                   isMinus
                                  );
    end;

    macro getPaymentsSum(accountMask : String, creditFilter : String, dataProtocol, isMinus : bool)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                        RcbArray.initialize("t_costCalculationSum", //Сумма расчетов по затратам под договору
                                                            "t_costCalculationAccount" // Счет расчетов по затратам под договору
                                                            ),
                                        creditFilter,
                                        accountMask,
                                        RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                            PCN_ACCOUNT
                                                           ),
                                        null,
                                        dataProtocol,
                                        isMinus
                                       );

        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_expensesCessionSum", //Сумма расчетов по расходам по приобретенным правам тербования по договору
                                                                "t_expensesCessionAccount"), //Счет расчетов по расходам по приобретенным правам тербования по договору
                                            creditFilter,
                                            accountMask,
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol,
                                            isMinus
                                           );
        return value;
    end;

    macro getCostsSum(accountMask : String, creditFilter : String, dataProtocol)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                         RcbArray.initialize("t_postedCostsSum",      //Сумма учтенных затрат по договору
                                                             "t_postedCostsAccount"), //Счет затрат по приобретенным правам тербования по договору
                                         creditFilter,
                                         accountMask,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                            ),
                                         null,
                                         dataProtocol
                                  );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_costCessionSum",      //Сумма затрат по приобретенным правам тербования по договору
                                                                "t_costCessionAccount"), //Счет затрат по приобретенным правам тербования по договору
                                            creditFilter,
                                            accountMask,
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol
                                           );


        return value;
    end;

    macro getOtherIncomeSum(accountMask : String, creditFilter : String, dataProtocol, isMinus)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                        RcbArray.initialize("t_otherIncomePlaceSum",         //Сумма учета прочих доходов от размещенных средств
                                                            "t_otherIncomePlaceAccount"     // Счет учета прочих доходов от размещенных средств
                                                            ),
                                        creditFilter,
                                        accountMask,
                                        RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                            PCN_ACCOUNT
                                                           ),
                                        null,
                                        dataProtocol,
                                        isMinus
                                       );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_otherIncomeCessionSum",       //Сумма прочих доходов по операциям по приобретению прав требования
                                                                "t_otherIncomeCessionAccount"),  //Счет прочих доходов по операциям по приобретению прав требования
                                            creditFilter,
                                            accountMask,
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol,
                                            isMinus
                                           );
        return value;
    end;

    macro getCalcOtherIncomeSum(accountMask : String, creditFilter : String, dataProtocol)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                        RcbArray.initialize("t_calcOtherIncomePlaceSum",     //Сумма расчетов по прочим доходам от размещенных средств
                                                            "t_calcOtherIncomePlaceAccount"), //Счет расчетов по прочим доходам по операциям по приобретению прав требования
                                        creditFilter,
                                        accountMask,
                                        RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                            PCN_ACCOUNT
                                                           ),
                                        null,
                                        dataProtocol
                                       );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_calcOtherIncomeCessSum",      //Сумма расчетов по прочим доходам по операциям по приобретению прав требования
                                                                "t_calcOtherIncomeCessAccount"), //Счет расчетов по прочим доходам по операциям по приобретению прав требования
                                            creditFilter,
                                            accountMask,
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol
                                           );
        return value;
    end;

    macro getIncAdjPlacedFundsCost(accountMask : String, creditFilter : String, dataProtocol)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                         RcbArray.initialize("t_correctIncPlaceSum",          //Сумма корректировки, увеличивающей стоимость размещенных средств
                                                             "t_correctIncPlaceAccount"      // Счет корректировки, увеличивающей стоимость размещенных средств
                                                            ),
                                         creditFilter,
                                         accountMask,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                            ),
                                         null,
                                         dataProtocol
                                        );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_corIncCostCessionSum",        //Сумма корректировки, увеличивающей стоимость приобретенных прав требования
                                                                "t_corIncCostCessionAccount"),   //Счет корректировки, увеличивающей стоимость приобретенных прав требования
                                            creditFilter,
                                            accountMask,
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol
                                           );
        return value;
    end;

    macro getDecAdjPlacedFundsCost(accountMask : String, creditFilter : String, dataProtocol, isMinus : bool)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                         RcbArray.initialize("t_correctDecPlaceSum",      //Сумма корректировки, уменьшающей стоимость размещенных средств
                                                             "t_correctDecPlaceAccount",  // Счет корректировки, уменьшающей стоимость размещенных средств
                                                             "t_corDecCostCessionSum",    //Сумма корректировки, уменьшающей стоимость приобретенных прав требования
                                                             "t_corDecCostCessionAcc"),   //Счет корректировки, уменьшающей стоимость приобретенных прав требования
                                         creditFilter,
                                         accountMask,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                            ),
                                         null,
                                         dataProtocol,
                                         isMinus
                                        );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                             RcbArray.initialize("t_correctDecPlaceSum",      //Сумма корректировки, уменьшающей стоимость размещенных средств
                                                                 "t_correctDecPlaceAccount",  // Счет корректировки, уменьшающей стоимость размещенных средств
                                                                 "t_corDecCostCessionSum",    //Сумма корректировки, уменьшающей стоимость приобретенных прав требования
                                                                 "t_corDecCostCessionAcc"),   //Счет корректировки, уменьшающей стоимость приобретенных прав требования
                                             creditFilter,
                                             accountMask,
                                             RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                 PCN_ACCOUNT
                                                                ),
                                             null,
                                             dataProtocol,
                                             isMinus
                                            );
        return value;
    end;

    macro getDecAdjAttractedCost(accountMask : String, creditFilter : String, dataProtocol, isMinus : bool)
        return getDataFromAddTable("repLnsIfrsEntities_vw",
                                   RcbArray.initialize("t_correctDecBorrowSum",     //Сумма корректировки, уменьшающей стоим. привлеч. средств (Дата)
                                                       "t_correctDecBorrowAccount"  //Счет корректировки, уменьшающей стоим. привлеч. средств
                                                      ),
                                   creditFilter,
                                   accountMask,
                                   RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                       PCN_ACCOUNT
                                                      ),
                                   null,
                                   dataProtocol,
                                   isMinus
                                  );
    end;

    macro getIncAdjAttractedCost(accountMask : String, creditFilter : String, dataProtocol)
        return getDataFromAddTable("repLnsIfrsEntities_vw",
                                   RcbArray.initialize("t_correctIncBorrowSum",     //Сумма корректировки, увеличивающей стоим. привлеч. средств
                                                       "t_correctIncBorrowAccount"  //Счет корректировки, увеличивающей стоим. привлеч. средств
                                                      ),
                                   creditFilter,
                                   accountMask,
                                   RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                       PCN_ACCOUNT
                                                      ),
                                   null,
                                   dataProtocol
                                  );
    end;

    macro getCorrIncResPercComissPenSum(creditFilter : String, dataProtocol)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                        RcbArray.initialize("t_correctIncResPercSum",    //Сумма корректировки, увеличивающей резерв по процентам (Дата)
                                                            "t_correctIncResPercAccount"
                                                           ),
                                        creditFilter,
                                        "",
                                        RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                            PCN_ACCOUNT
                                                           ),
                                        null,
                                        dataProtocol
                                       );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                            RcbArray.initialize("t_correctIncResComissSum",  //Сумма корректировки, увеличивающей резерв по комиссиям
                                                                "t_correctIncResComissAccount"
                                                               ),
                                            creditFilter,
                                            "",
                                            RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                PCN_ACCOUNT
                                                               ),
                                            null,
                                            dataProtocol
                                           );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                             RcbArray.initialize("t_correctIncResPenaltySum", //Сумма корректировки, увеличивающей резерв по неустойкам
                                                                 "t_correctIncResPenaltyAccount"
                                                                ),
                                             creditFilter,
                                             "",
                                             RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                 PCN_ACCOUNT
                                                                ),
                                             null,
                                             dataProtocol
                                            );
        return value;
    end;

    macro getCorrDecResPercComissPenSum(creditFilter : String, dataProtocol, isMinus : bool)
        var value = getDataFromAddTable("repLnsIfrsEntities_vw",
                                         RcbArray.initialize("t_correctDecResPercSum",    //Сумма корректировки, уменьшающей резерв по процентам (Дата)
                                                             "t_correctDecResPercAcc"
                                                            ),
                                         creditFilter,
                                         "",
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                            ),
                                         null,
                                         dataProtocol,
                                         isMinus
                                        );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                             RcbArray.initialize("t_correctDecResComissSum",  //Сумма корректировки, увеличивающей резерв по комиссиям
                                                                 "t_correctDecResComissAcc"
                                                                ),
                                             creditFilter,
                                             "",
                                             RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                 PCN_ACCOUNT
                                                                ),
                                             null,
                                             dataProtocol,
                                             isMinus
                                            );
        value = value + getDataFromAddTable("repLnsIfrsEntities_vw",
                                             RcbArray.initialize("t_correctDecResPenaltySum", //Сумма корректировки, уменьшающей резерв по неустойкам
                                                                 "t_correctDecResPenaltyAcc"
                                                                ),
                                             creditFilter,
                                             "",
                                             RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                                 PCN_ACCOUNT
                                                                ),
                                             null,
                                             dataProtocol,
                                             isMinus
                                            );
        return value;
    end;

    macro getDelaydComissAmount(creditFilter : String, dataProtocol)
        return getDataFromAddTable("",
                                   RcbArray.initialize("t_delaydComissAmount", //Сумма просроченной комиссии
                                                       ""
                                                      ),
                                   creditFilter,
                                   "",
                                   RcbArray.initialize(PCN_DELAYD_COMISS_AMOUNT
                                                       ),
                                   null,
                                   dataProtocol
                                  );
    end;

    macro getAccountSum(accountMask : String, creditFilter : String, dataProtocol)
        return getDataFromAddTable("df110creditsAccount_tmp",
                                   RcbArray.initialize("t_rest", //Остаток счета
                                                       "t_account"
                                                      ),
                                   creditFilter,
                                   accountMask,
                                   RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                       PCN_ACCOUNT
                                                       ),
                                   "t_creditid",
                                   dataProtocol
                                  );
    end;

    constructor();
end;

/**
 * Источник данных по портфелям Loans.
 *
 */
class (TDataSource) TDataSourceLoansCase()
    macro constructor()
        initTDataSource(null, TProtocolLoansCase());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df110case_tmp");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()
        sql_execute("INSERT INTO df110case_tmp (t_number,              "
           + "\n" + "                           t_percRvpSum,          "
           + "\n" + "                           t_commissionRvpSum)    "
           + "\n" + "                    SELECT t_number,              "
           + "\n" + "                           t_percentReserveSum,   "
           + "\n" + "                           t_commissionReserveSum "
           + "\n" + "                      FROM repLnsCase_vw case     "
           + "\n" + "                      WHERE " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId"));
    end;

    /**
     * Сумма РВП_проц+РВП_комиссии по договорам.
     *
     * @param     accountMask   маски счетов, по которым открыты договора
     */
    macro getRvpSum(filter : String, protocol)

        var credit = RcbDataSet(
        " SELECT   case.t_number               t_number,                                 "
        "          case.t_percRvpSum           t_percRvpSum,                             "
        "          case.t_commissionRvpSum     t_commissionRvpSum,                       "
        "          SUM (case.t_percRvpSum + case.t_commissionRvpSum) t_sum               "
        "     FROM df110case_tmp case                                                    "
        "    WHERE 1 = 1                                                                 "
        +          NVL(filter, " ") +
        "      AND (case.t_percRvpSum + case.t_commissionRvpSum) != 0                    "
        "  GROUP BY ROLLUP ((case.t_number,                                              "
        "                    case.t_percRvpSum,                                          "
        "                    case.t_commissionRvpSum                                     "
        "                  ))                                                            "
        " ORDER BY GROUPING (case.t_number) DESC, case.t_number                          ");

        var hasData = credit.moveNext();
        var sum     = 0;

        if (hasData)
            sum = credit.sum;
        end;

        if (protocol != null)
            protocol.printData(credit, hasData);
        else
            m_protocol.printProtocol(credit, hasData);
        end;

        return sum;
    end;

    constructor();
end;

/**
 * Источник данных по истории изменения регистров Loans.
 *
 */
class (TDataSource) TDataSourceLoansRegChangeHistory()
    private macro constructor()
        initTDataSource(NULL, TProtocolLoansRegChangeHistory());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df110regChangeHistory_tmp");
    end;

    macro cacheData()
        sql_execute(" INSERT INTO df110regChangeHistory_tmp (t_regKind,       "
                  + "\n" + "                                 t_operationDate, "
                  + "\n" + "                                 t_roubleExpense, "
                  + "\n" + "                                 t_roubleReceipt) "
                  + "\n" + "SELECT t_regKind,                                 "
                  + "\n" + "       t_operationDate,                           "
                  + "\n" + "       t_roubleExpense,                           "
                  + "\n" + "       t_roubleReceipt                            "
                  + "\n" + "  FROM repLnsRegChangeHistory_vw                  "
                  + "\n" + " WHERE (t_operationDate >= " + getSqlString(global.getBeginYearDate()) + ")"
                  + "\n" + "   AND (t_operationDate <= " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + ")");
    end;

    /**
     * Сумма расхода.
     *
     * @param     filter
     */
    macro getExpenseSum(regKindMasks : String)
        var filter;

        if (regKindMasks == null)
            filter = "";
        elif((regKindMasks == "") OR (regKindMasks == "EMPTY_MASKS"))
            filter = " AND 1 = 0";
        else
            filter = " AND (" + ConvertMaskToSQLFormat(regKindMasks, "hist.t_regkind") + " ) ";
        end;

        var dataSet = RcbDataSet(
                 "SELECT hist.t_regkind,                                                        "
        + "\n" + "       hist.t_operationdate,                                                  "
        + "\n" + "       'X' t_roubleReceipt,                                                   "
        + "\n" + "       -SUM (hist.t_roubleexpense) t_roubleexpense                            "
        + "\n" + "  FROM df110regchangehistory_tmp hist                                         "
        + "\n" + " WHERE hist.t_roubleexpense != 0                                              "
        + "\n" + "       " + filter
        + "\n" + " GROUP BY ROLLUP ((hist.t_regkind,                                            "
        + "\n" + "                  hist.t_operationdate,                                       "
        + "\n" + "                  hist.t_roubleexpense                                        "
        + "\n" + "                 ))                                                           "
        + "\n" + " ORDER BY GROUPING (hist.t_regkind) DESC, hist.t_regkind, hist.t_operationdate");

        dataSet.SetFieldType("operationDate", V_DATE);

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.roubleExpense;
        end;

        m_protocol.printProtocol(dataSet, hasData);

        return sum;
    end;

    /**
     * Сумма прихода.
     *
     * @param     filter
     */
    macro getReceiptSum(regKindMasks : String)
        var filter;

        if (regKindMasks == null)
            filter = "";
        elif((regKindMasks == "") OR (regKindMasks == "EMPTY_MASKS"))
            filter = " AND 1 = 0";
        else
            filter = " AND ( " + ConvertMaskToSQLFormat(regKindMasks, "hist.t_regkind") + " ) ";
        end;

        var dataSet = RcbDataSet(
                 "SELECT hist.t_regkind,                                                        "
        + "\n" + "       hist.t_operationdate,                                                  "
        + "\n" + "       SUM (hist.t_roubleReceipt) t_roubleReceipt,                            "
        + "\n" + "       'X' t_roubleexpense                                                    "
        + "\n" + "  FROM df110regchangehistory_tmp hist                                         "
        + "\n" + " WHERE hist.t_roubleReceipt != 0                                              "
        + "\n" + "       " + filter
        + "\n" + " GROUP BY ROLLUP ((hist.t_regkind,                                            "
        + "\n" + "                  hist.t_operationdate,                                       "
        + "\n" + "                  hist.t_roubleReceipt                                        "
        + "\n" + "                 ))                                                           "
        + "\n" + " ORDER BY GROUPING (hist.t_regkind) DESC, hist.t_regkind, hist.t_operationdate");

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.roubleReceipt;
        end;

        m_protocol.printProtocol(dataSet, hasData);

        return sum;
    end;

    constructor();
end;

class (TDataSourceLoansRegChangeHistory) TDataSourceLoansRegChangeHistory4033()

    private macro constructor()
        constructor();
        m_protocol = TProtocolLoansRegChangeHistory4033();
    end;

    macro cacheData()
        sql_execute(" INSERT INTO df110regChangeHistory_tmp (t_contractNumber,"
           + "\n" + "                                        t_regKind,       "
           + "\n" + "                                        t_operationDate, "
           + "\n" + "                                        t_roubleExpense, "
           + "\n" + "                                        t_roubleReceipt) "
           + "\n" + " SELECT contract.t_number,                               "
           + "\n" + "        regHistory.t_regKind,                            "
           + "\n" + "        regHistory.t_operationDate,                      "
           + "\n" + "        regHistory.t_roubleExpense,                      "
           + "\n" + "        regHistory.t_roubleReceipt                       "
           + "\n" + "   FROM repLnsRegChangeHistory_vw regHistory,            "
           + "\n" + "        repLnsContract_vw         contract               "
           + "\n" + "  WHERE (regHistory.t_operationDate >= " + getSqlString(global.getBeginYearDate()) + ")"
           + "\n" + "    AND (regHistory.t_operationDate <= " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + ")"
           + "\n" + "    AND contract.t_id = regHistory.t_trancheNumber");
    end;

    /**
     * Сумма расхода.
     *
     * @param     filter
     */
    macro getExpenseSum(regKindMasks : String, protocol)
        var filter;

        if (regKindMasks == null)
            filter = "";
        elif((regKindMasks == "") OR (regKindMasks == "EMPTY_MASKS"))
            filter = " AND 1 = 0";
        else
            filter = " AND (" + ConvertMaskToSQLFormat(regKindMasks, "hist.t_regkind") + " ) ";
        end;

        var dataSet = RcbDataSet(
                 "SELECT hist.t_contractNumber,                                                                        "
        + "\n" + "       hist.t_regkind,                                                                               "
        + "\n" + "       hist.t_operationdate,                                                                         "
        + "\n" + "       'X' t_roubleReceipt,                                                                          "
        + "\n" + "       -SUM (hist.t_roubleexpense) t_roubleexpense                                                   "
        + "\n" + "  FROM df110regchangehistory_tmp hist                                                                "
        + "\n" + " WHERE hist.t_roubleexpense != 0                                                                     "
        + "\n" + "       " + filter
        + "\n" + " GROUP BY ROLLUP ((hist.t_contractNumber,                                                            "
        + "\n" + "                  hist.t_regkind,                                                                    "
        + "\n" + "                  hist.t_operationdate,                                                              "
        + "\n" + "                  hist.t_roubleexpense                                                               "
        + "\n" + "                 ))                                                                                  "
        + "\n" + " ORDER BY GROUPING (hist.t_regkind) DESC, hist.t_regkind, hist.t_operationdate, hist.t_contractNumber");

        dataSet.SetFieldType("operationDate", V_DATE);

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.roubleExpense;
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData);
        else
            m_protocol.printProtocol(dataSet, hasData);
        end;

        return sum;
    end;

    /**
     * Сумма прихода.
     *
     * @param     filter
     */
    macro getReceiptSum(regKindMasks : String)
        var filter;

        if (regKindMasks == null)
            filter = "";
        elif((regKindMasks == "") OR (regKindMasks == "EMPTY_MASKS"))
            filter = " AND 1 = 0";
        else
            filter = " AND ( " + ConvertMaskToSQLFormat(regKindMasks, "hist.t_regkind") + " ) ";
        end;

        var dataSet = RcbDataSet(
                 "SELECT hist.t_contractNumber,                                                                        "
        + "\n" + "       hist.t_regkind,                                                                               "
        + "\n" + "       hist.t_operationdate,                                                                         "
        + "\n" + "       SUM (hist.t_roubleReceipt) t_roubleReceipt,                                                   "
        + "\n" + "       'X' t_roubleexpense                                                                           "
        + "\n" + "  FROM df110regchangehistory_tmp hist                                                                "
        + "\n" + " WHERE hist.t_roubleReceipt != 0                                                                     "
        + "\n" + "       " + filter
        + "\n" + " GROUP BY ROLLUP ((hist.t_contractNumber,                                                            "
        + "\n" + "                  hist.t_regkind,                                                                    "
        + "\n" + "                  hist.t_operationdate,                                                              "
        + "\n" + "                  hist.t_roubleReceipt                                                               "
        + "\n" + "                 ))                                                                                  "
        + "\n" + " ORDER BY GROUPING (hist.t_regkind) DESC, hist.t_regkind, hist.t_operationdate, hist.t_contractNumber");

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.roubleReceipt;
        end;

        m_protocol.printProtocol(dataSet, hasData);

        return sum;
    end;

    constructor();
end;

class (TDataSourceLoansRegChangeHistory4033) TDataSourceLoansRegChangeHistory_4927()
    initTDataSourceLoansRegChangeHistory4033();
    /**
     * Сумма прихода.
     * @param     filter
     * @protocol
     */
    macro getReceiptSum(regKindMasks : String, protocol)
        var filter;

        if (regKindMasks == null)
            filter = "";
        elif((regKindMasks == "") OR (regKindMasks == "EMPTY_MASKS"))
            filter = " AND 1 = 0";
        else
            filter = " AND ( " + ConvertMaskToSQLFormat(regKindMasks, "hist.t_regkind") + " ) ";
        end;

        var dataSet = RcbDataSet(
                 "SELECT hist.t_contractNumber                                                                                  AS t_number,        "
        + "\n" + "       hist.t_regkind,                                                                                                            "
        + "\n" + "       hist.t_operationdate,                                                                                                      "
        + "\n" + "       (SELECT credit.t_openDate FROM dF110credit_tmp credit WHERE credit.t_number = hist.t_contractNumber)   AS t_openDate,      "
        + "\n" + "       SUM (hist.t_roubleReceipt)                                                                             AS t_roubleReceipt, "
        + "\n" + "       'X'                                                                                                    AS t_roubleexpense  "
        + "\n" + "  FROM df110regchangehistory_tmp hist                                                                                             "
        + "\n" + " WHERE hist.t_roubleReceipt != 0                                                                                                  "
        + "\n" + "       " + filter
        + "\n" + " GROUP BY ROLLUP ((hist.t_contractNumber,                                                                                         "
        + "\n" + "                  hist.t_regkind,                                                                                                 "
        + "\n" + "                  hist.t_operationdate,                                                                                           "
        + "\n" + "                  hist.t_roubleReceipt                                                                                            "
        + "\n" + "                 ))                                                                                                               "
        + "\n" + " ORDER BY GROUPING (hist.t_regkind) DESC, hist.t_regkind, hist.t_operationdate, hist.t_contractNumber");

        dataSet.setFieldType("t_openDate", V_DATE);

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.roubleReceipt;
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE,
                                                                       PCN_REGISTER,
                                                                       PCN_REGISTER_DATE,
                                                                       PCN_REGISTER_SUM
                                                                       ),
                                                    RcbArray().initialize("t_number",
                                                                          "t_openDate",
                                                                          "t_regkind",
                                                                          "t_operationdate",
                                                                          "t_roubleReceipt"
                                                                          ),
                              BO_NAME_LOANS
                              );
        else
            m_protocol.printProtocol(dataSet, hasData);
        end;

        return sum;
    end;
end;

/**
 * Источник данных по счетам резервов в ГК.
 *
 */
class (TDataSource) TDataSourceGkboReserveAccounts()
    private macro constructor()
        initTDataSource(TDataSourceFiltersGkboReserves(), TProtocolGkboReserveAccounts());
    end;

    /**
     * ФактРезервРВПC (ДООП; true)
     * !!!!
     * @param     filter
     */
    macro getRealRvpAndRvps(filter : String, protocol)
        var realSum = RcbDataSet(
        " SELECT acc.t_account                           reserveAccount,                    "
        "        acc.t_outCoverRest                      reserveAccRest,                    "
        "        sum(NVL(reserveAcc.t_endDateReserveAmount,                                 "
        "                acc.t_outCoverRest))            reserveAmount                      "
        " FROM drepreserveaccount_vw reserveAcc,                                            "
        "      drepaccount_vw        acc                                                    "
        " WHERE acc.t_chapter = 1"
        "   AND acc.t_chapter = reserveAcc.t_reserveChapter(+)                              "
        "   AND acc.t_fiId    = reserveAcc.t_reserveFiId(+)                                 "
        "   AND acc.t_account = reserveAcc.t_reserveAccount(+)                              "
        "   AND acc.t_outCoverRest != 0                                                     "
        + filter +
        " GROUP BY ROLLUP ((                                                                "
        "                   reserveAcc.t_reserveaccount,                                    "
        "                   acc.t_account,                                                  "
        "                   acc.t_outCoverRest,                                             "
        "                   reserveAcc.t_enddateReserveAmount                               "
        "                 ))                                                                "
        " ORDER BY GROUPING (reserveAcc.t_reserveaccount) DESC, reserveAcc.t_reserveaccount ");

        var hasData = realSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realSum.reserveAmount;
        end;

        if (protocol != null)
            protocol.printData(realSum, hasData);
        else
            m_protocol.printProtocol(realSum, hasData);
        end;

        return sum;
    end;

    constructor();
end;

class (TDataSource) TDataSourceGkboAccount()
    initTDataSource(TDataSourceFiltersGkboReserves2332(), TProtocolGkboAccount());

    macro getAccountRest(filter : String, protocol)
        var accountRestSum = TRsbDataSet(
          "\n" + " WITH accountRest AS                                                       "
        + "\n" + "      (SELECT fi.t_code fiId, acc.t_account account,                       "
        + "\n" + "              acc.t_outCoverRest outCoverRest,                             "
        + "\n" + "              CASE                                                         "
        + "\n" + "                  WHEN fi.t_id = " + NATCUR
        + "\n" + "                      THEN acc.t_outCoverRest                              "
        + "\n" + "                  ELSE 0                                                   "
        + "\n" + "              END nationalSum,                                             "
        + "\n" + "              CASE                                                         "
        + "\n" + "                  WHEN fi.t_id != " + NATCUR
        + "\n" + "                      THEN acc.t_outCoverRest                              "
        + "\n" + "                  ELSE 0                                                   "
        + "\n" + "              END foreignSum                                               "
        + "\n" + "         FROM drepaccount_vw acc, drepfininstrument_vw fi                  "
        + "\n" + "        WHERE 1 = 1 " + filter
        + "\n" + "          AND acc.t_chapter = 1                                            "
        + "\n" + "          AND acc.t_fiId = fi.t_id                                         "
        + "\n" + "          AND acc.t_outCoverRest != 0)                                     "
        + "\n" + " SELECT fiId,                                                              "
        + "\n" + "        account,                                                           "
        + "\n" + "        SUM (outCoverRest) outCoverRest,                                   "
        + "\n" + "        SUM (nationalSum)  nationalSum,                                    "
        + "\n" + "        SUM (foreignSum)   foreignSum ,                                    "
        + "\n" + "        'X'                reserveAccount,                                 "
        + "\n" + "        'X'                rvpsAmount,                                     "
        + "\n" + "        'X'                rvpAmount,                                      "
        + "\n" + "        'X'                rofshAmount                                     "
        + "\n" + "   FROM accountRest                                                        "
        + "\n" + "  GROUP BY ROLLUP ((fiId, account, outCoverRest, nationalSum, foreignSum)) "
        + "\n" + "  ORDER BY GROUPING (fiId) DESC, fiId, account                             ",
        RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = accountRestSum.moveNext();

        if (protocol != null)
            protocol.printData(accountRestSum, hasData);
        else
            m_protocol.printProtocol(accountRestSum, hasData);
        end;

        if (hasData)
            accountRestSum.moveFirst();

            return accountRestSum;
        else
            return 0;
        end;
    end;
end;

class (TDataSourceGkboAccount) TDataSourceGkboAccount3006()
    initTDataSource(TDataSourceFiltersGkboReserves3006(), TProtocolGkboAccount());
end;

class (TDataSourceGkboAccount) TDataSourceGkboAccount4212()
    initTDataSource(TDataSourceFiltersGkboReserves4212(), TProtocolGkboAccount());
end;

class (TDataSourceGkboAccount) TDataSourceGkboAccount4637()
    initTDataSource(TDataSourceFiltersGkboReserves4637(), TProtocolGkboAccount());
end;

class (TDataSourceGkboAccount) TDataSourceGkboAccount4927()
    macro getAccountRest(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var accountRestSum = TRsbDataSet(
          "\n" + " WITH accountRest AS                                                       "
        + "\n" + "      (SELECT (SELECT fi.t_code FROM dRepFininstrument_vw fi WHERE acc.t_fiId = fi.t_id) t_fiId, "
        + "\n" + "              acc.t_account t_account,                                       "
        + "\n" + "              (SELECT party.t_shortName FROM dRepParty_vw party WHERE party.t_id = acc.t_contragentId) t_contragentName,"
        + "\n" + "              acc.t_outCoverRest,                                          "
        + "\n" + "              CASE                                                         "
        + "\n" + "                  WHEN acc.t_fiId = " + NATCUR
        + "\n" + "                      THEN acc.t_outCoverRest                              "
        + "\n" + "                  ELSE 0                                                   "
        + "\n" + "              END t_nationalSum,                                             "
        + "\n" + "              CASE                                                         "
        + "\n" + "                  WHEN acc.t_fiId != " + NATCUR
        + "\n" + "                      THEN acc.t_outCoverRest                              "
        + "\n" + "                  ELSE 0                                                   "
        + "\n" + "              END t_foreignSum                                               "
        + "\n" + "         FROM drepaccount_vw acc                  "
        + "\n" + "        WHERE 1 = 1 " + filter
        + "\n" + "          AND acc.t_chapter = 1                                            "
        + "\n" + "          AND acc.t_outCoverRest != 0)                                     "
        + "\n" + " SELECT t_fiId,                                                              "
        + "\n" + "        t_account,                                                           "
        + "\n" + "        t_contragentName,                                                    "
        + "\n" + "        SUM (t_nationalSum) * " + ternary(isMinus, "(-1)", "1") + " t_nationalSum,                                    "
        + "\n" + "        SUM (t_foreignSum) * " + ternary(isMinus, "(-1)", "1") + " t_foreignSum                                      "
        + "\n" + "   FROM accountRest                                                        "
        + "\n" + "  GROUP BY ROLLUP ((t_fiId, t_account, t_contragentName, t_nationalSum, t_foreignSum)) "
        + "\n" + "  ORDER BY GROUPING (t_fiId) DESC, t_fiId, t_account                             ",
        RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = accountRestSum.moveNext();

        if (protocol != null)
            protocol.printData(accountRestSum, hasData, RcbArray().initialize(PCN_CURRENCY,
                                                                              PCN_ACCOUNT,
                                                                              PCN_CONTRAGENT,
                                                                              PCN_ACC_CURRENCY_REST,
                                                                              PCN_ACC_ROUBLE_REST
                                                                              ),
                                                        RcbArray().initialize("t_fiId",
                                                                              "t_account",
                                                                              "t_contragentName",
                                                                              "t_foreignSum",
                                                                              "t_nationalSum"
                                                                              ),
                               BO_NAME_GK
                              );
        end;

        if (hasData)
            accountRestSum.moveFirst();

            return accountRestSum;
        else
            return 0;
        end;
    end;
    initTDataSource(TDataSourceFiltersGkboReserves4637(), TProtocolGkboAccount());
end;
/**
 * Источник данных по резервам в ГК.
 *
 */
class (TDataSource) TDataSourceGkboReserves()
    initTDataSource(TDataSourceFiltersGkboReserves(), TProtocolGkboReserves());

    /**
     * ФактРезервРВП(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRvp(filter : String, protocol)

        var realRvpSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,          "
        + "\n" + "       acc.t_account                           account,       "
        + "\n" + "       acc.t_outCoverRest                      outCoverRest,  "
        + "\n" + "       reserveacc.t_reserveAccount             reserveAccount,"
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount)  realReserve    "
        + "\n" + "  FROM drepaccount_vw        acc,                             "
        + "\n" + "       drepfininstrument_vw  fi,                              "
        + "\n" + "       drepreserveaccount_vw reserveacc                       "
        + "\n" + " WHERE acc.t_accountId = reserveacc.t_connectaccountId        "
        + "\n" + "   AND acc.t_chapter = 1                                      "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                   "
        + "\n" + "   AND acc.t_outCoverRest != 0                                "
        + "\n" + "  " +  filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                 "
        + "\n" + "                   acc.t_account,                             "
        + "\n" + "                   acc.t_outcoverrest,                        "
        + "\n" + "                   reserveacc.t_reserveaccount,               "
        + "\n" + "                   reserveacc.t_enddateReserveAmount,         "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount     "
        + "\n" + "                 ))                                           "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account ");

        var hasData = realRvpSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpSum.realReserve;
        end;

        if (protocol != null)
            protocol.printData(realRvpSum, hasData);
        else
            m_protocol.printProtocol(realRvpSum, hasData);
        end;

        return sum;
    end;

    /**
     * ФактРезервРВПС(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRvps(filter : String, protocol)
        var realRvpsSum = RcbDataSet(
        " SELECT fi.t_code                               fiId,              "
        "        acc.t_account                           account,           "
        "        acc.t_outCoverRest                      outCoverRest,      "
        "        reserveacc.t_reserveAccount             reserveAccount,    "
        "        sum(reserveacc.t_endDateReserveAmount)  realReserve        "
        " FROM drepaccount_vw        acc,                                   "
        "      drepfininstrument_vw fi,                                     "
        "      drepreserveaccount_vw reserveacc                             "
        " WHERE acc.t_accountId = reserveacc.t_connectAccountId             "
        "   AND acc.t_chapter = 1                                           "
        "   AND acc.t_fiid = fi.t_id                                        "
        "   AND acc.t_outCoverRest != 0                                     "
        + filter +
        " GROUP BY ROLLUP ((fi.t_code,                                      "
        "                   acc.t_account,                                  "
        "                   acc.t_outcoverrest,                             "
        "                   reserveacc.t_reserveaccount,                    "
        "                   reserveacc.t_enddatereserveamount,              "
        "                   reserveacc.t_enddaterofshreserveamount          "
        "                 ))                                                "
        " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account    ");

        var hasData = realRvpsSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpsSum.realReserve;
        end;

        if (protocol != null)
            protocol.printData(realRvpsSum, hasData);
        else
            m_protocol.printProtocol(realRvpsSum, hasData);
        end;

        return sum;
    end;

    /**
     * резерв РВП
     *
     * @param     filter
     */
    macro getReserveRvp(filter : String, protocol)
        var realRvpSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,               "
        + "\n" + "       accRes.t_account                        account,            "
        + "\n" + "       accRes.t_outCoverRest                   outCoverRest,       "
        + "\n" + "       acc.t_account                           reserveAccount,     "
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount)  realReserve         "
        + "\n" + "  FROM drepaccount_vw        acc,                                  "
        + "\n" + "       drepaccount_vw        accRes,                               "
        + "\n" + "       drepfininstrument_vw  fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                            "
        + "\n" + " WHERE accRes.t_accountId  = reserveacc.t_connectaccountId         "
        + "\n" + "   AND acc.t_account       = reserveacc.t_reserveAccount           "
        + "\n" + "   AND acc.t_chapter       = 1                                     "
        + "\n" + "   AND acc.t_fiid          = fi.t_id                               "
        + "\n" + "   AND acc.t_outCoverRest != 0                                     "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                      "
        + "\n" + "                   acc.t_account,                                  "
        + "\n" + "                   accRes.t_outcoverrest,                          "
        + "\n" + "                   accRes.t_account,                               "
        + "\n" + "                   reserveacc.t_reserveaccount,                    "
        + "\n" + "                   reserveacc.t_enddateReserveAmount,              "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount          "
        + "\n" + "                 ))                                                "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account      ");

        var hasData = realRvpSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpSum.realReserve;
        end;

        if (protocol != null)
            protocol.printData(realRvpSum, hasData);
        else
            m_protocol.printProtocol(realRvpSum, hasData);
        end;

        return sum;
    end;

    /**
     * резерв РВПС
     *
     * @param     filter
     */
    macro getReserveRvps(filter : String, protocol)
        var realRvpsSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,               "
        + "\n" + "       accRes.t_account                        account,            "
        + "\n" + "       accRes.t_outCoverRest                   outCoverRest,       "
        + "\n" + "       acc.t_account                           reserveAccount,     "
        + "\n" + "       reserveacc.t_reserveAccount             reserveAccount,     "
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount)  realReserve         "
        + "\n" + "  FROM drepaccount_vw        acc,                                  "
        + "\n" + "       drepaccount_vw        accRes,                               "
        + "\n" + "       drepfininstrument_vw  fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                            "
        + "\n" + " WHERE accRes.t_accountId  = reserveacc.t_connectaccountId         "
        + "\n" + "   AND acc.t_account       = reserveacc.t_reserveAccount           "
        + "\n" + "   AND acc.t_fiid          = fi.t_id                               "
        + "\n" + "   AND acc.t_outCoverRest != 0                                     "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                      "
        + "\n" + "                   acc.t_account,                                  "
        + "\n" + "                   accRes.t_outcoverrest,                          "
        + "\n" + "                   accRes.t_account,                               "
        + "\n" + "                   reserveacc.t_reserveaccount,                    "
        + "\n" + "                   reserveacc.t_enddatereserveamount,              "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount          "
        + "\n" + "                 ))                                                "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account      ");

        var hasData = realRvpsSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpsSum.realReserve;
        end;

        if (protocol != null)
            protocol.printData(realRvpsSum, hasData);
        else
            m_protocol.printProtocol(realRvpsSum, hasData);
        end;

        return sum;
    end;

    /**
     * ФактРезервРОФШ(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRofsh(filter : String, protocol)

        var realRofshSum = RcbDataSet(
                 "SELECT fi.t_code                                   fiId,          "
        + "\n" + "       acc.t_account                               account,       "
        + "\n" + "       acc.t_outCoverRest                          outCoverRest,  "
        + "\n" + "       reserveacc.t_reserveAccount                 reserveAccount,"
        + "\n" + "       sum(reserveacc.t_enddateRofshReserveAmount) realReserve    "
        + "\n" + "  FROM drepaccount_vw        acc,                                 "
        + "\n" + "       drepfininstrument_vw fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                           "
        + "\n" + " WHERE acc.t_accountId = reserveacc.t_connectAccountId            "
        + "\n" + "   AND acc.t_chapter = 1                                          "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                       "
        + "\n" + "   AND acc.t_outCoverRest != 0                                    "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                     "
        + "\n" + "                   acc.t_account,                                 "
        + "\n" + "                   acc.t_outcoverrest,                            "
        + "\n" + "                   reserveacc.t_reserveaccount,                   "
        + "\n" + "                   reserveacc.t_enddatereserveamount,             "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount         "
        + "\n" + "                 ))                                               "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account     ");

        var hasData = realRofshSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRofshSum.realReserve;
        end;

        if (protocol != null)
            protocol.printData(realRofshSum, hasData);
        else
            m_protocol.printProtocol(realRofshSum, hasData);
        end;

        return sum;
    end;

    /**
     * Остаток(ДООП)
     *
     * @param     filter
     */
    macro getAccountRest(filter : String)

        var accountRestSum = RcbDataSet(
          "\n" + "SELECT fi.t_code                fiId,                        "
        + "\n" + "       acc.t_account            account,                     "
        + "\n" + "       sum(acc.t_outCoverRest)  outCoverRest,                "
        + "\n" + "       'X'                      reserveAccount,              "
        + "\n" + "       'X'                      realReserve                  "
        + "\n" + "  FROM drepaccount_vw acc,                                   "
        + "\n" + "       drepfininstrument_vw fi                               "
        + "\n" + " WHERE 1 = 1                                                 "
        + "\n" + "  " +  filter
        + "\n" + "   AND acc.t_chapter = 1                                     "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                  "
        + "\n" + "   AND acc.t_outCoverRest != 0                               "
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                "
        + "\n" + "                   acc.t_account,                            "
        + "\n" + "                   acc.t_outcoverrest                        "
        + "\n" + "                 ))                                          "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account ");

        var hasData = accountRestSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = accountRestSum.outCoverRest;
        end;

        m_protocol.printProtocol(accountRestSum, hasData);

        return sum;
    end;
end;

/**
 * Источник данных по резервам в ГК для 2332-У.
 *
 */
class (TDataSourceGkboReserves) TDataSourceGkboReserves2332()
    initTDataSource(TDataSourceFiltersGkboReserves2332(), TProtocolGkboReserves());
end;

/**
 * Источник данных по резервам в ГК для 3269-У.
 *
 */
class (TDataSourceGkboReserves) TDataSourceGkboReserves3269()
    initTDataSource(TDataSourceFiltersGkboReserves3269(), TProtocolGkboReserves());
end;

/**
 * Источник данных по резервам в ГК для 4927-У.
 *
 */
class (TDataSourceGkboReserves) TDataSourceGkboReserves4927()
    initTDataSource(TDataSourceFiltersGkboReserves3269(), TProtocolGkboReserves());

    /**
     * ФактРезервРВП(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRvp(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var realRvpSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,          "
        + "\n" + "       acc.t_account                           account,       "
        + "\n" + "       reserveacc.t_reserveAccount             reserveAccount,"
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount) * " + ternary(isMinus, "(-1)", "1") + "  realReserve    "
        + "\n" + "  FROM drepaccount_vw        acc,                             "
        + "\n" + "       drepfininstrument_vw  fi,                              "
        + "\n" + "       drepreserveaccount_vw reserveacc                       "
        + "\n" + " WHERE acc.t_accountId = reserveacc.t_connectaccountId        "
        + "\n" + "   AND acc.t_chapter = 1                                      "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                   "
        + "\n" + "   AND acc.t_outCoverRest != 0                                "
        + "\n" + "  " +  filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                 "
        + "\n" + "                   acc.t_account,                             "
        + "\n" + "                   reserveacc.t_reserveaccount,               "
        + "\n" + "                   reserveacc.t_enddateReserveAmount,         "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount     "
        + "\n" + "                 ))                                           "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account ");

        var hasData = realRvpSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpSum.realReserve;
            protocol.printData(realRvpSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                          PCN_ACC_ROUBLE_REST
                                                                          ),
                                                        RcbArray().initialize("reserveAccount",
                                                                              "realReserve"
                                                                              ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * ФактРезервРВПС(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRvps(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var realRvpsSum = RcbDataSet(
        " SELECT fi.t_code                               fiId,              "
        "        acc.t_account                           account,           "
        "        reserveacc.t_reserveAccount             reserveAccount,    "
        "        sum(reserveacc.t_endDateReserveAmount) * " + ternary(isMinus, "(-1)", "1") + "  realReserve        "
        " FROM drepaccount_vw        acc,                                   "
        "      drepfininstrument_vw fi,                                     "
        "      drepreserveaccount_vw reserveacc                             "
        " WHERE acc.t_accountId = reserveacc.t_connectAccountId             "
        "   AND acc.t_chapter = 1                                           "
        "   AND acc.t_fiid = fi.t_id                                        "
        "   AND acc.t_outCoverRest != 0                                     "
        + filter +
        " GROUP BY ROLLUP ((fi.t_code,                                      "
        "                   acc.t_account,                                  "
        "                   reserveacc.t_reserveaccount,                    "
        "                   reserveacc.t_enddatereserveamount,              "
        "                   reserveacc.t_enddaterofshreserveamount          "
        "                 ))                                                "
        " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account    ");

        var hasData = realRvpsSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpsSum.realReserve;
            protocol.printData(realRvpsSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                           PCN_ACC_ROUBLE_REST
                                                                           ),
                                                        RcbArray().initialize("reserveAccount",
                                                                              "realReserve"
                                                                              ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * резерв РВП
     *
     * @param     filter
     */
    macro getReserveRvp(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);

        var realRvpSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,               "
        + "\n" + "       accRes.t_account                        account,            "
        + "\n" + "       accRes.t_outCoverRest                   outCoverRest,       "
        + "\n" + "       acc.t_account                           reserveAccount,     "
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount) * " + ternary(isMinus, "(-1)", "1") + " realReserve         "
        + "\n" + "  FROM drepaccount_vw        acc,                                  "
        + "\n" + "       drepaccount_vw        accRes,                               "
        + "\n" + "       drepfininstrument_vw  fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                            "
        + "\n" + " WHERE accRes.t_accountId  = reserveacc.t_connectaccountId         "
        + "\n" + "   AND acc.t_account       = reserveacc.t_reserveAccount           "
        + "\n" + "   AND acc.t_chapter       = 1                                     "
        + "\n" + "   AND acc.t_fiid          = fi.t_id                               "
        + "\n" + "   AND acc.t_outCoverRest != 0                                     "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                      "
        + "\n" + "                   acc.t_account,                                  "
        + "\n" + "                   accRes.t_outcoverrest,                          "
        + "\n" + "                   accRes.t_account,                               "
        + "\n" + "                   reserveacc.t_reserveaccount,                    "
        + "\n" + "                   reserveacc.t_enddateReserveAmount,              "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount          "
        + "\n" + "                 ))                                                "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account      ");

        var hasData = realRvpSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpSum.realReserve;

            protocol.printData(realRvpSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                          PCN_ACC_ROUBLE_REST
                                                                          ),
                                                    RcbArray().initialize("account",
                                                                          "realReserve"
                                                                          ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * резерв РВПС
     *
     * @param     filter
     */
    macro getReserveRvps(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var realRvpsSum = RcbDataSet(
                 "SELECT fi.t_code                               fiId,               "
        + "\n" + "       accRes.t_account                        account,            "
        + "\n" + "       reserveacc.t_reserveAccount             reserveAccount,     "
        + "\n" + "       sum(reserveacc.t_endDateReserveAmount) * " + ternary(isMinus, "(-1)", "1") + "  realReserve         "
        + "\n" + "  FROM drepaccount_vw        acc,                                  "
        + "\n" + "       drepaccount_vw        accRes,                               "
        + "\n" + "       drepfininstrument_vw  fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                            "
        + "\n" + " WHERE accRes.t_accountId  = reserveacc.t_connectaccountId         "
        + "\n" + "   AND acc.t_account       = reserveacc.t_reserveAccount           "
        + "\n" + "   AND acc.t_fiid          = fi.t_id                               "
        + "\n" + "   AND acc.t_outCoverRest != 0                                     "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                      "
        + "\n" + "                   accRes.t_account,                               "
        + "\n" + "                   reserveacc.t_reserveaccount,                    "
        + "\n" + "                   reserveacc.t_enddatereserveamount,              "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount          "
        + "\n" + "                 ))                                                "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, accRes.t_account      ");

        var hasData = realRvpsSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRvpsSum.realReserve;

            protocol.printData(realRvpsSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                           PCN_ACC_ROUBLE_REST
                                                                           ),
                                                     RcbArray().initialize("reserveAccount",
                                                                           "realReserve"
                                                                           ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * ФактРезервРОФШ(ДООП; true)
     *
     * @param     filter
     */
    macro getRealRofsh(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);

        var realRofshSum = RcbDataSet(
                 "SELECT fi.t_code                                   fiId,          "
        + "\n" + "       acc.t_account                               account,       "
        + "\n" + "       reserveacc.t_reserveAccount                 reserveAccount,"
        + "\n" + "       sum(reserveacc.t_enddateRofshReserveAmount) * " + ternary(isMinus, "(-1)", "1") + "realReserve    "
        + "\n" + "  FROM drepaccount_vw        acc,                                 "
        + "\n" + "       drepfininstrument_vw fi,                                   "
        + "\n" + "       drepreserveaccount_vw reserveacc                           "
        + "\n" + " WHERE acc.t_accountId = reserveacc.t_connectAccountId            "
        + "\n" + "   AND acc.t_chapter = 1                                          "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                       "
        + "\n" + "   AND acc.t_outCoverRest != 0                                    "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                     "
        + "\n" + "                   acc.t_account,                                 "
        + "\n" + "                   reserveacc.t_reserveaccount,                   "
        + "\n" + "                   reserveacc.t_enddatereserveamount,             "
        + "\n" + "                   reserveacc.t_enddaterofshreserveamount         "
        + "\n" + "                 ))                                               "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account     ");

        var hasData = realRofshSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realRofshSum.realReserve;
            protocol.printData(realRofshSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                            PCN_ACC_ROUBLE_REST
                                                                            ),
                                                      RcbArray().initialize("reserveAccount",
                                                                            "realReserve"
                                                                            ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * Остаток(ДООП)
     *
     * @param     filter
     */
    macro getAccountRest(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var accountRestSum = RcbDataSet(
          "\n" + "SELECT fi.t_code                fiId,                        "
        + "\n" + "       acc.t_accountId          accountId,                   "
        + "\n" + "       acc.t_account            account,                     "
        + "\n" + "       sum(acc.t_outCoverRest) * " + ternary(isMinus, " (-1)", " 1") + " outCoverRest"
        + "\n" + "  FROM drepaccount_vw acc,                                   "
        + "\n" + "       drepfininstrument_vw fi                               "
        + "\n" + " WHERE 1 = 1                                                 "
        + "\n" + "  " +  filter
        + "\n" + "   AND acc.t_chapter = 1                                     "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                  "
        + "\n" + "   AND acc.t_outCoverRest != 0                               "
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                "
        + "\n" + "                   acc.t_accountId,                          "
        + "\n" + "                   acc.t_account,                            "
        + "\n" + "                   acc.t_outcoverrest                        "
        + "\n" + "                 ))                                          "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account ");

        var hasData = accountRestSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = accountRestSum.outCoverRest;
        end;

        if (protocol != null)
            protocol.printData(accountRestSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                              PCN_ACC_ROUBLE_REST
                                                                              ),
                                                        RcbArray().initialize("account",
                                                                              "outCoverRest"
                                                                              ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;

    /**
     * Сумма корректировок (Увеличивающая - уменьшающая)
     *
     * @param     filter
     */
    macro getCorrSum(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var corrSum = RcbDataSet(
                 "SELECT acc.t_account                               account,       "
        + "\n" +         ternary(isMinus, "rep_account.getCorrAccountReserveDecrease(rep_data.getEndDate(), acc.t_account, acc.t_fiId, acc.t_chapter)", "rep_account.getCorrAccountReserveIncrease(rep_data.getEndDate(), acc.t_account, acc.t_fiId, acc.t_chapter)") + " corrAccount,   "
        + "\n" + "       sum(" + ternary(isMinus, "rep_account.getSumCorrReserveDecrease(rep_data.getEndDate(), acc.t_account, acc.t_fiId, acc.t_chapter)", "rep_account.getSumCorrReserveIncrease(rep_data.getEndDate(), acc.t_account, acc.t_fiId, acc.t_chapter)") + ") corrSum  "
        + "\n" + "  FROM drepaccount_vw        acc,                                 "
        + "\n" + "       drepfininstrument_vw fi                                    "
        + "\n" + " WHERE acc.t_fiid = fi.t_id                                       "
        + "\n" + "  " + filter
        + "\n" + " GROUP BY ROLLUP ((acc.t_account,                                 "
        + "\n" + "                   acc.t_fiId,                                    "
        + "\n" + "                   acc.t_chapter                                  "
        + "\n" + "                 ))                                               "
        + "\n" + " ORDER BY GROUPING (acc.t_account)     ");

        var hasData = corrSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = corrSum.corrSum;
            protocol.printData(corrSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                       PCN_ACC_ROUBLE_REST
                                                                       ),
                                                 RcbArray().initialize("corrAccount",
                                                                       "corrSum"
                                                                       ),
                               BO_NAME_GK
                              );
        end;

        return sum;
    end;
end;

/**
 * Источник данных по Securities
 */
class TDataSourceSecurities()
    private var m_protocol       : TDataSourceProtocol;
    private var m_securitiesData : C_110_Secur;
    private var m_existsData     : bool;

    private macro scaling(val)
        var units = RcbApplication().currentReport.dimension;

        if   (units == RCB_DIM_NATIONAL)
            return val * 1000;
        elif (units == RCB_DIM_ROUBLE)
            return val * 1000;
        elif (units == RCB_DIM_THOUSAND)
            return val;
        elif (units == RCB_DIM_MILLION)
            return round(val/1000.0, 0);
        else
            return val;
        end;
    end;

    private macro getDecryption(decryption)
        var val;
        var sum;
        var dataSet;

        if (m_existsData)
            val     = ExecExp("m_securitiesData." + decryption);
            sum     = scaling(round(val/1000, 0, 2) * 1000);                                                    //округляем, как в Securities
            dataSet = TRsbDataSet("SELECT " + ternary(val != null, val, 0) + " AS t_securitiesSum FROM dual");
            dataSet.moveNext();
//            m_protocol.printProtocol(dataSet, true);
        else
            sum = 0;
//            m_protocol.printProtocol(dataSet, false);   //dataSet == null, но это отлавливается в протоколе
        end;

        return sum;
    end;

    macro getА50505_4()
        return getDecryption("А50505_4");
    end;

    macro getА50505_6_1()
        return getDecryption("А50505_6_1");
    end;

    macro getА50507_4()
        return getDecryption("А50507_4");
    end;

    macro getА50507_6_2()
        return getDecryption("А50507_6_2");
    end;

    macro getА505_4()
        return getDecryption("А505_4");
    end;

    macro getА505_6_2()
        return getDecryption("А505_6_2");
    end;

    macro getS175_16()
        return getDecryption("S175_16");
    end;

    macro getS176_17()
        return getDecryption("S176_17");
    end;

    macro getS_4_2()
        return getDecryption("S_4_2");
    end;

    macro getS385_16()
        return getDecryption("S385_16");
    end;

    macro getS386_17()
        return getDecryption("S386_17");
    end;

    macro getS_4_4()
        return getDecryption("S_4_4");
    end;

    private macro constructor()
        var str          = SubStr(rcbDepartmentList.getAsSqlSetFilial(), 2, StrLen(rcbDepartmentList.getAsSqlSetFilial()) - 2) + "," + SubStr(rcbDepartmentList.getAsSqlSetVsp(), 2, StrLen(rcbDepartmentList.getAsSqlSetVsp()) - 2);
        var departaments = StrCut(str, ",");
        var beginDate;
        var y;

        //01.01.ГГГГ, где ГГГГ = ГГГГ из ДООП
        DateSplit(RcbApplication().currentReport.context.period.endDate, null, null, y);
        beginDate = Date(1, 1, y);

        m_securitiesData = C_110_Secur(beginDate, RcbApplication().currentReport.context.period.endDate, departaments);
        m_existsData     = ternary(m_securitiesData.Get() == 0, true, false);
        m_protocol       = TProtocolSecurities();
    end;

    constructor();
end;

/**
 * Источник данных по документам ГК.
 *
 */
class (TDataSource) TDataSourceGkboDocuments()
    initTDataSource(TDataSourceFilterGkboDocuments(), TProtocolGkboDocuments());

    /**
     * Сумма документов и протокол.
     *
     * @param     filter
     */
    private macro calculatedDocSum(document : String, withQuery : String, protocol)
        var docSum = RcbDataSet(
        ternary(withQuery != null, withQuery + ",", "WITH ")+
        "     doc AS (" + document + ")                                                                                "
        + "\n" + "SELECT fi.t_code fiid,                                                                               "
        + "\n" + "       accountSymbol,                                                                                "
        + "\n" + "       docNumber,                                                                                    "
        + "\n" + "       docDate,                                                                                      "
        + "\n" + "       creditAccount,                                                                                "
        + "\n" + "       debetAccount,                                                                                 "
        + "\n" + "       SUM(sum) sum,                                                                                 "
        + "\n" + "       note,                                                                                         "
        + "\n" + "       correctType,                                                                                  "
        + "\n" + "       correctionalFor                                                                               "
        + "\n" + "  FROM doc,                                                                                          "
        + "\n" + "       drepfininstrument_vw fi                                                                       "
        + "\n" + " WHERE fiId = fi.t_id                                                                                "
        + "\n" + " GROUP BY ROLLUP ((fi.t_code, accountSymbol, docNumber, docDate, creditAccount, debetAccount, note, correctType, correctionalFor)) "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, accountSymbol, fi.t_code, docDate, docNumber                    ");

        var hasData = docSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = docSum.sum;
        end;

        m_protocol.printProtocol(docSum, hasData);

        return sum;
    end;

    /**
     * Символ отчетности на счетах доходов/расходов.
     */
    private macro getAccountSymbol()
        return
                 " case when doc.t_creditBalance LIKE '70%'                                              "
        + "\n" + " then                                                                                  "
        + "\n" + "       rcb_opu.getAccountSymbol                                                        "
        + "\n" + "                (doc.t_creditBalance,                                                  "
        + "\n" + "                 doc.t_creditAccount,                                                  "
        + "\n" + "                 rsb_rep_ac.makeAccountId (doc.t_creditAccount, doc.t_creditFiId, doc.t_chapter, NULL )) "
        + "\n" + " else                                                                                  "
        + "\n" + "       rcb_opu.getAccountSymbol                                                        "
        + "\n" + "                (doc.t_debetBalance,                                                   "
        + "\n" + "                 doc.t_debetAccount,                                                   "
        + "\n" + "                 rsb_rep_ac.makeAccountId (doc.t_debetAccount, doc.t_debetFiId, doc.t_chapter, NULL )) "
        + "\n" + " end                                                                                   ";

    end;

    /**
     * Отбор счетов резерва по субпортфелям и "напрямую"
     *
     * @param     filter
     */
    private macro getReserveAccount(accountFilter : String, subCaseFilter : String, identificationReserveAccountFilter : String)
        return
        "WITH account AS                                                                        "
        "     (SELECT t_reserveAccount,                                                         "
        "             t_reserveChapter,                                                         "
        "             t_reserveFiId                                                             "
        "        FROM (SELECT reserveAcc.t_reserveAccount,                                      "
        "                     reserveAcc.t_reserveChapter,                                      "
        "                     reserveAcc.t_reserveFiId                                          "
        "                FROM drepAccount_vw acc, drepReserveAccount_vw reserveAcc              "
        "               WHERE acc.t_accountId = reserveacc.t_connectAccountId                   "
        "                 AND acc.t_chapter = 1                                                 "
        +                     ternary(accountFilter != null, accountFilter, "AND 1 = 0")  +
        "               UNION                                                                   "
        "              SELECT subCase.t_reserveAccount,                                         "
        "                     subCase.t_reserveAccountChapter,                                  "
        "                     subCase.t_reserveAccountFiId                                      "
        "                FROM drepSubCase_vw subCase                                            "
        "               WHERE subCase.t_caseReserveKind = " + KindReserveLoss            /*РВП*/
        +                     ternary(subCaseFilter != null, subCaseFilter, "AND 1 = 0")+
        "               UNION                                                                   "
        "              SELECT reserveAcc.t_account t_reserveAccount,                            "
        "                     reserveAcc.t_chapter t_reserveChapter,                            "
        "                     reserveAcc.t_fiId    t_reserveFiId                                "
        "                FROM drepAccount_vw reserveAcc                                         "
        "               WHERE 1 = 1                                                             "
        "                 AND reserveAcc.t_chapter = 1                                          "
        +                     ternary(identificationReserveAccountFilter != null, identificationReserveAccountFilter, "AND 1 = 0") +
        "             )                                                                         "
        "      )                                                                                ";
    end;

    /**
     * Сумма документов(доходы от восстановления сумм резервов) с кучей фильтров.
     *
     * @param     filter
     */
    private macro getDocSum(arhdocFilter : String, isMinusSum /*: Bool*/, includeAccount)
        return
          "\n" + "SELECT doc.t_debetFiid                                         fiId,                   "
        + "\n" +         getAccountSymbol() +                                  " accountSymbol,          "
        + "\n" + "       doc.t_number                                            docNumber,              "
        + "\n" + "       doc.t_date                                              docDate,                "
        + "\n" + "       doc.t_creditAccount                                     creditAccount,          "
        + "\n" + "       doc.t_debetAccount                                      debetAccount,           "
        + "\n" +         ternary(isMinusSum == true, " -", "")
        + "\n" + "       doc.t_inCoverSum                                        sum,                    "
        + "\n" + "       doc.t_note                                              note,                   "
        + "\n" + "       CASE                                                                            "
        + "\n" + "           WHEN doc.t_isCorrect = 1                                                    "
        + "\n" + "           THEN (SELECT typ.t_type_document                                            "
        + "\n" + "                  FROM drepCorrectionalDocument_vw typ                                 "
        + "\n" + "                 WHERE typ.t_documentId    = doc.t_id                                  "
        + "\n" + "                   AND typ.t_numb_document = doc.t_number)                             "
        + "\n" + "       END                                                      AS correctType,        "
        + "\n" + "       CASE                                                                            "
        + "\n" + "          WHEN doc.t_isCorrect = 1                                                     "
        + "\n" + "          THEN (SELECT typ.t_errorDocumentId                                           "
        + "\n" + "                  FROM drepCorrectionalDocument_vw typ                                 "
        + "\n" + "                 WHERE typ.t_documentId    = doc.t_id                                  "
        + "\n" + "                   AND typ.t_numb_document = doc.t_number)                             "
        + "\n" + "       END                                                      AS correctionalFor     "
        + "\n" + "  FROM drepDocumentWithCorrection_vw  doc                                              "/*здесь будут только рублевые проводки, т.к. счета резервов ведуться только в рублях*/
        + "\n" +         ternary(includeAccount == true, ", account acc", "")
        + "\n" + " WHERE doc.t_date BETWEEN " + getSqlDate(global.getBeginYearDate())
        + "\n" + "                      AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
        + "\n" + "   AND doc.t_chapter = 1"
        + "\n" +     ternary(arhdocFilter  != null, arhdocFilter , "")                                   ;
    end;

    /**
     * Сумма документов.
     *
     * @param     accountFilter   фильтр по резервируемым л/с
     * @param     subCaseFilter   фильтр на субпортфели, по которым определяются счета резервов
     * @param     resAccFilter    фильтр по определению л/с резервов
     * @param     arhdocFilter    фильтр на документы по счетам резервов
     */
    macro getDocumentsRvpSum(accountFilter : String, subCaseFilter : String, resAccFilter : String, arhdocFilter : String)
        return calculatedDocSum(getDocSum(arhdocFilter, null, true),
                                getReserveAccount(accountFilter, subCaseFilter, resAccFilter));
    end;

    /**
     * Сумма документов.
     *
     * @param     filter
     */
    macro getDocumentsSum(arhdocFilter : String, isMinusSum /*: Bool*/)
        var i   : Integer = 1;
        var filter;
        var sign;
        var text = null;
        var protocol = null;

        while (    getParm(i, filter)
               and (i < Parmcount() - 1)
              )
             getParm(i + 1, sign);
             if (valType(sign) == V_STRING)
                 text = ternary(text != null, text + "\n union all ", "") + getDocSum(filter);
                 i = i + 1;
             else
                 text = ternary(text != null, text + "\n union all ", "") + getDocSum(filter, sign);
                 i = i + 2;
             end;
        end;

        return calculatedDocSum(text, null);
    end;
end;

/**
 * Источник данных по истории изменения регистров Loans.
 *
 */
class (TDataSource) TDataLoansRegister3006()

    private macro constructorTDataLoansRegister3006()
        initTDataSource(TDataSourceFiltersLoansRegister3006, TProtocolLoansData());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df110Register_tmp");
    end;

    macro cacheData()
        sql_execute(" INSERT INTO df110Register_tmp (t_creditId,                       "
           + "\n" + "                                t_restDate,                       "
           + "\n" + "                                t_type,                           "
           + "\n" + "                                t_rest,                           "
           + "\n" + "                                t_currencyId)                     "
           + "\n" + "                        SELECT crd.t_id            AS t_creditId, "
           + "\n" + "                               reg.t_date          AS t_restDate, "
           + "\n" + "                               reg.t_type          AS t_type,     "
           + "\n" + "                               reg.t_roubleRest    AS t_rest,     "
           + "\n" + "                               reg.t_currencyId    AS t_currencyId"
           + "\n" + "                          FROM repLnsRegister_vw reg, repLnsTranches_vw trn, df110credit_tmp crd"
           + "\n" + "                         WHERE trn.t_contractId = crd.t_id AND reg.t_trancheNumber = trn.t_number AND trn.t_kind = reg.t_trancheKind");

    end;

    /**
     * Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRest(filter : String, protocol)
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0)        AS rest,"
           + "\n" + "        NVL(SUM(t_nationalSum), 0) AS nationalSum,"
           + "\n" + "        NVL(SUM(t_foreignSum), 0)  AS foreignSum,"
           + "\n" + "        t_number,                 "
           + "\n" + "        t_openDate,"
           + "\n" + "        t_regKind                  AS regKind,"
           + "\n" + "        t_fiid                     AS fiid,"
           + "\n" + "        GROUPING(t_number)         AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                                                          AS t_rest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid = " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                  AS t_nationalSum,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid != " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                  AS t_foreignSum,"
           + "\n" + "                data.t_type                                                                          AS t_type,"
           + "\n" + "                (SELECT reg.t_name FROM dspr_reg_dbt reg WHERE reg.t_regId = data.t_type)            AS t_regKind,"
           + "\n" + "                (SELECT fin.t_code FROM drepfininstrument_vw fin WHERE data.t_currencyid = fin.t_id) AS t_fiid,"
           + "\n" + "                data.t_contragentId                                                                  AS t_contragentId,"
           + "\n" + "                data.t_number                                                                        AS t_number,"
           + "\n" + "                data.t_openDate                                                                      AS t_openDate"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest         AS t_rest,"
           + "\n" + "                        reg.t_type         AS t_type,"
           + "\n" + "                        reg.t_currencyid   AS t_currencyid,"
           + "\n" + "                        (SELECT crd.t_contragentId FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId) AS t_contragentId,"
           + "\n" + "                        (SELECT crd.t_number FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_number,"
           + "\n" + "                        (SELECT crd.t_openDate FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_openDate"
           + "\n" + "                   FROM df110Register_tmp reg) data"
           + "\n" + "          WHERE data.t_rest != 0" + NVL(filter, " ")
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number, t_openDate, t_fiid, t_regKind))"
           + "\n" + " ORDER BY t_fiid, t_number";
        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.setFieldType("t_openDate", V_DATE);
        if (dataSet.moveFirst())
            hasData = true;
        end;

        //dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        //dataSet.setFieldType("t_openDate", V_DATE);

        if (protocol != null)
            protocol.printData(dataSet, hasData);
        else
            m_protocol.printProtocol(dataSet, hasData);
        end;

        dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        while (dataSet.moveNext())
            if (dataSet.total == 1)
                return dataSet;
            end;
        end;

        return 0;
    end;

    constructorTDataLoansRegister3006();
end;

/**
 * Источник данных по истории изменения регистров Loans по 4927-У.
 *
 */
class (TDataLoansRegister3006) TDataLoansRegister4927()
    private macro constructorTDataLoansRegister4927()
        initTDataLoansRegister3006();
    end;

    macro cacheData()
        sql_execute(" INSERT INTO df110Register_tmp (t_creditId,                       "
           + "\n" + "                                t_trancheKind,                    "
           + "\n" + "                                t_trancheNumber,                  "
           + "\n" + "                                t_restDate,                       "
           + "\n" + "                                t_type,                           "
           + "\n" + "                                t_rest,                           "
           + "\n" + "                                t_currencyId)                     "
           + "\n" + "                        SELECT crd.t_id            AS t_creditId, "
           + "\n" + "                               trn.t_kind          AS t_trancheKind, "
           + "\n" + "                               trn.t_number        AS t_trancheNumber, "
           + "\n" + "                               reg.t_date          AS t_restDate, "
           + "\n" + "                               reg.t_type          AS t_type,     "
           + "\n" + "                               reg.t_roubleRest    AS t_rest,     "
           + "\n" + "                               reg.t_currencyId    AS t_currencyId"
           + "\n" + "                          FROM repLnsRegister_vw reg, repLnsTranches_vw trn, df110credit_tmp crd"
           + "\n" + "                         WHERE trn.t_contractId = crd.t_id AND reg.t_trancheNumber = trn.t_number AND trn.t_kind = reg.t_trancheKind");
    end;

    /**
     * Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRestUseTranche(filter : String, protocol)
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0)        AS t_sum,"
           + "\n" + "        NVL(SUM(t_mainRest), 0)    AS t_mainRest, "
           + "\n" + "        NVL(SUM(t_claimRest), 0)   AS t_claimRest, "
           + "\n" + "        NVL(SUM(t_expRest), 0)     AS t_expRest, "
           + "\n" + "        NVL(SUM(t_exppercRest), 0) AS t_exppercRest, "
           + "\n" + "        t_number             AS t_number, "
           + "\n" + "        t_openDate           AS openDate,"
           + "\n" + "        GROUPING(t_number)   AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                                                            AS t_rest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_MAINREST
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_mainRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_CLAIM
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_claimRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_EXPREST
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_expRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_EXPPERC
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_exppercRest,"
           + "\n" + "                data.t_type                                                                            AS t_type,"
           + "\n" + "                data.t_number                                                                          AS t_number,"
           + "\n" + "                data.t_openDate                                                                        AS t_openDate"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest             AS t_rest,"
           + "\n" + "                        reg.t_type             AS t_type,"
           + "\n" + "                        credit.t_contragentId  AS t_contragentId,"
           + "\n" + "                        credit.t_number        AS t_number,"
           + "\n" + "                        credit.t_openDate      AS t_openDate"
           + "\n" + "                   FROM df110Register_tmp reg,"
           + "\n" + "                         df110credit_tmp credit, "
           + "\n" + "                         repLnsTranches_vw tranche "
           + "\n" + "                  WHERE reg.t_creditId = credit.t_id  "
           + "\n" + "                    AND tranche.t_contractId = credit.t_id  " + filter + ") data"
           + "\n" + "          WHERE data.t_rest != 0"
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number), t_openDate)"
           + "\n" + " ORDER BY GROUPING(t_number) DESC, t_openDate, t_number";
        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.setFieldType("openDate", V_DATE);

        var result;

        hasData = dataSet.moveNext();
        if (hasData)
            result = dataSet.sum;
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_MAIN_REST_AMOUNT,
                                                                       PCN_ACCRUED_INTEREST_AMOUNT,
                                                                       PCN_DELAYD_MAIN_REST_AMOUNT,
                                                                       PCN_DELAYD_PERCENT_AMOUNT,
                                                                       PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE
                                                                       ),
                                                 RcbArray().initialize("t_mainRest",
                                                                       "t_claimRest",
                                                                       "t_expRest",
                                                                       "t_exppercRest",
                                                                       "t_number",
                                                                       "openDate"
                                                                       ),
                               BO_NAME_LOANS
                              );
        end;

        if (hasData)
            return result;
        else
            return 0;
        end;
    end;

    /**
     * Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRestUseContract(filter : String, protocol)
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0)        AS rest,"
           + "\n" + "        t_number                   AS t_number, "
           + "\n" + "        t_openDate                 AS openDate,"
           + "\n" + "        SUM(t_depoPercSum)         AS t_depoPercSum,"
           + "\n" + "        GROUPING(t_number)         AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                            AS t_rest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_DEPOPERC
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                    AS t_depoPercSum,"
           + "\n" + "                data.t_type                            AS t_type,"
           + "\n" + "                data.t_number                          AS t_number,"
           + "\n" + "                data.t_openDate                        AS t_openDate"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest             AS t_rest,"
           + "\n" + "                        reg.t_type             AS t_type,"
           + "\n" + "                        credit.t_number        AS t_number,"
           + "\n" + "                        credit.t_openDate      AS t_openDate"
           + "\n" + "                   FROM df110Register_tmp reg,"
           + "\n" + "                        df110credit_tmp   credit "
           + "\n" + "                  WHERE reg.t_creditId = credit.t_id  "
           + "\n" + "                        " + filter + ") data"
           + "\n" + "          WHERE data.t_rest != 0"
           + "\n" + "          )"
           + "\n" + " GROUP BY ROLLUP ((t_number), t_openDate)"
           + "\n" + " ORDER BY GROUPING(t_number) DESC, t_openDate, t_number";
        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("openDate", V_DATE);
        var result;

        hasData = dataSet.moveNext();
        if (hasData)
            result = dataSet.rest;
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_ACCRUED_INTEREST_AMOUNT,
                                                                       PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE
                                                                       ),
                                                 RcbArray().initialize("t_depoPercSum",
                                                                       "t_number",
                                                                       "openDate"
                                                                       ),
                               BO_NAME_LOANS
                              );
        end;

        if (hasData)
            return result;
        else
            return 0;
        end;
    end;

     /* Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRestMinusReserve(filter : String, isOverdue : Bool, protocol)
        var field1 = ternary(isOverdue, "t_RVPSPD", "t_RVPSOD");
        var field2 = ternary(isOverdue, "t_RVPEXPPERC", "t_RVPPERC");
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0) - t_reserve AS t_sum,"
           + "\n" + "        NVL(SUM(t_RvpsOd), 0)           AS t_RvpsOd,"
           + "\n" + "        NVL(SUM(t_RvpsPd), 0)           AS t_RvpsPd,"
           + "\n" + "        NVL(SUM(t_rvpPerc), 0)          AS t_rvpPerc,"
           + "\n" + "        NVL(SUM(t_rvpExpPerc), 0)       AS t_rvpExpPerc,"
           + "\n" + "        t_number                        AS t_number, "
           + "\n" + "        t_openDate                      AS openDate,"
           + "\n" + "        GROUPING(t_number)              AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                             AS t_rest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_MAINREST
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_mainRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_CLAIM
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_claimRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_EXPREST
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_expRest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_type = " + TDR_EXPPERC
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                    AS t_exppercRest,"
           + "\n" + "                data.t_type,"
           + "\n" + "                data.t_number,"
           + "\n" + "                data.t_openDate,"
           + "\n" + "                data.t_reserve,"
           + "\n" + "                data.t_RvpsOd,"
           + "\n" + "                data.t_RvpsPd,"
           + "\n" + "                data.t_rvpPerc,"
           + "\n" + "                data.t_rvpExpPerc"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest                                      AS t_rest,"
           + "\n" + "                        reg.t_type                                      AS t_type,"
           + "\n" + "                        credit.t_number                                 AS t_number,"
           + "\n" + "                        credit.t_openDate                               AS t_openDate,"
           + "\n" + "                        tranche." + field1 + " + tranche." + field2 + " AS t_reserve,"
           + "\n" + "                        tranche.t_RvpsPd AS t_RvpsPd,"
           + "\n" + "                        tranche.t_RvpsOd AS t_RvpsOd,"
           + "\n" + "                        tranche.t_rvpExpPerc AS t_rvpExpPerc,"
           + "\n" + "                        tranche.t_rvpPerc AS t_rvpPerc"
           + "\n" + "                   FROM df110Register_tmp reg,"
           + "\n" + "                         df110credit_tmp credit, "
           + "\n" + "                         repLnsTranches_vw tranche "
           + "\n" + "                  WHERE reg.t_creditId = credit.t_id  "
           + "\n" + "                    AND tranche.t_contractId = credit.t_id  " + filter + ") data"
           + "\n" + "          WHERE data.t_rest != 0"
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number), t_openDate, t_reserve)"
           + "\n" + " ORDER BY GROUPING(t_number) DESC, t_openDate, t_number";
        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("openDate", V_DATE);

        var result;

        hasData = dataSet.moveNext();
        if (hasData)
            result = dataSet.sum;
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_RVPS_SUM,
                                                                       PCN_RVPS_DELAYED_SUM,
                                                                       PCN_PERC_RVP_SUM,
                                                                       PCN_RVP_DELAYED_PERCENT,
                                                                       PCN_MAIN_REST_AMOUNT,
                                                                       PCN_DELAYD_MAIN_REST_AMOUNT,
                                                                       PCN_ACCRUED_INTEREST_AMOUNT,
                                                                       PCN_DELAYD_PERCENT_AMOUNT,
                                                                       PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE
                                                                       ),
                                                 RcbArray().initialize("t_RvpsOd",
                                                                       "t_RvpsPd",
                                                                       "t_rvpPerc",
                                                                       "t_rvpExpPerc",
                                                                       "t_mainRest",
                                                                       "t_expRest",
                                                                       "t_claimRest",
                                                                       "t_exppercRest",
                                                                       "t_number",
                                                                       "openDate"
                                                                       ),
                               BO_NAME_LOANS
                              );
        end;

        if (hasData)
            return result;
        else
            return 0;
        end;
    end;

    /**
     * Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRest(filter : String, protocol, isMinus : bool)
        defaultParm(isMinus, false);
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0) * " + ternary(isMinus, "(-1)", "1") + "  AS rest,"
           + "\n" + "        NVL(SUM(t_nationalSum), 0) * " + ternary(isMinus, "(-1)", "1") + " AS nationalSum,"
           + "\n" + "        NVL(SUM(t_foreignSum), 0) * " + ternary(isMinus, "(-1)", "1") + "  AS foreignSum,"
           + "\n" + "        t_number,                 "
           + "\n" + "        t_openDate,"
           + "\n" + "        t_regKind                  AS regKind,"
           + "\n" + "        t_fiid                     AS fiid,"
           + "\n" + "        t_contragent               AS t_contragent,"
           + "\n" + "        GROUPING(t_number)         AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                                                          AS t_rest,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid = " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                  AS t_nationalSum,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid != " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                  AS t_foreignSum,"
           + "\n" + "                data.t_type                                                                          AS t_type,"
           + "\n" + "                (SELECT reg.t_name FROM dspr_reg_dbt reg WHERE reg.t_regId = data.t_type)            AS t_regKind,"
           + "\n" + "                (SELECT fin.t_code FROM drepfininstrument_vw fin WHERE data.t_currencyid = fin.t_id) AS t_fiid,"
           + "\n" + "                (SELECT party.t_shortName FROM dRepParty_vw party WHERE party.t_id = data.t_contragentId) AS t_contragent,"
           + "\n" + "                data.t_number                                                                        AS t_number,"
           + "\n" + "                data.t_openDate                                                                      AS t_openDate"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest         AS t_rest,"
           + "\n" + "                        reg.t_type         AS t_type,"
           + "\n" + "                        reg.t_currencyid   AS t_currencyid,"
           + "\n" + "                        (SELECT crd.t_contragentId FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId) AS t_contragentId,"
           + "\n" + "                        (SELECT crd.t_number FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_number,"
           + "\n" + "                        (SELECT crd.t_openDate FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_openDate"
           + "\n" + "                   FROM df110Register_tmp reg) data"
           + "\n" + "          WHERE data.t_rest != 0" + NVL(filter, " ")
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number, t_openDate, t_fiid, t_contragent, t_regKind))"
           + "\n" + " ORDER BY t_fiid, t_number";
        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.setFieldType("openDate", V_DATE);

        var rec;

        if (dataSet.moveFirst())
            hasData = true;
            rec = dataSet.getRecord();
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_REGISTER_ROUBLE_REST,
                                                                       PCN_REGISTER_CURRENCY_REST,
                                                                       PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE,
                                                                       PCN_REGISTER,
                                                                       PCN_CURRENCY,
                                                                       PCN_CONTRAGENT
                                                                       ),
                                                 RcbArray().initialize("nationalSum",
                                                                       "foreignSum",
                                                                       "t_number",
                                                                       "openDate",
                                                                       "regKind",
                                                                       "fiId",
                                                                       "t_contragent"
                                                                       ),
                               BO_NAME_LOANS
                              );
        end;

        if (hasData)
            return rec;
        else
            return 0;
        end;

    end;

    constructorTDataLoansRegister4927();
end;

class (TDataSource) TDataDepositRegister3006()
    private macro constructorTDataDepositRegister3006()
        initTDataSource(TDataSourceFiltersLoansRegister3006, TProtocolDepositData());
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
    end;

    macro cacheData()
    end;

    /**
     * Сумма остатков регистра.
     *
     * @param     filter
     */
    macro getRest(filter : String)
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0)        AS rest,"
           + "\n" + "        NVL(SUM(t_nationalSum), 0) AS nationalSum,"
           + "\n" + "        NVL(SUM(t_foreignSum), 0)  AS foreignSum,"
           + "\n" + "        t_regKind                  AS regKind,"
           + "\n" + "        t_number                   AS creditNumber,"
           + "\n" + "        t_fiid                     AS fiid,"
           + "\n" + "        GROUPING(t_number)         AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                                                           AS t_rest,"
           + "\n" + "                CASE                                                         "
           + "\n" + "                   WHEN data.t_currencyid = " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                   AS t_nationalSum,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid != " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                   AS t_foreignSum,"
           + "\n" + "                data.t_type                                     AS t_type,"
           + "\n" + "        (SELECT reg.t_name FROM dspr_reg_dbt reg WHERE reg.t_regId = data.t_type)                     AS t_regKind,"
           + "\n" + "                (SELECT fin.t_code FROM drepfininstrument_vw fin WHERE data.t_currencyid = fin.t_id)  AS t_fiid,"
           + "\n" + "                data.t_contragentId                                                                   AS t_contragentId,"
           + "\n" + "                data.t_number                                                                         AS t_number"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest         AS t_rest,"
           + "\n" + "                        reg.t_type         AS t_type,"
           + "\n" + "                        reg.t_currencyid   AS t_currencyid,"
           + "\n" + "                        (SELECT crd.t_contragentId FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId) AS t_contragentId,"
           + "\n" + "                        (SELECT crd.t_number FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_number"
           + "\n" + "                   FROM df110Register_tmp reg) data"
           + "\n" + "          WHERE data.t_rest != 0" + NVL(filter, " ")
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number, t_fiid, t_regKind))"
           + "\n" + " ORDER BY GROUPING(t_number) DESC,  t_fiId, t_number";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        var rec;

        if (dataSet.moveFirst())
            hasData = true;
            rec = dataSet.getRecord();
            m_protocol.printProtocol(dataSet, hasData);

            return rec;
        else
            return 0;
        end;
    end;

    constructorTDataDepositRegister3006();
end;

class (TDataDepositRegister3006) TDataDepositRegister_4927()
    initTDataDepositRegister3006();

    macro getRest(filter : String, protocol)
        var hasData = false;
        var query = " SELECT NVL(SUM(t_rest), 0)        AS rest,"
           + "\n" + "        NVL(SUM(t_nationalSum), 0) AS nationalSum,"
           + "\n" + "        NVL(SUM(t_foreignSum), 0)  AS foreignSum,"
           + "\n" + "        t_regKind                  AS regKind,"
           + "\n" + "        t_number,                                  "
           + "\n" + "        t_openDate                 AS openDate,"
           + "\n" + "        t_fiid                     AS fiid,"
           + "\n" + "        t_contragent               AS t_contragent,"
           + "\n" + "        GROUPING(t_number)         AS total"
           + "\n" + "   FROM ("
           + "\n" + "         SELECT data.t_rest                                                                           AS t_rest,"
           + "\n" + "                CASE                                                         "
           + "\n" + "                   WHEN data.t_currencyid = " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                   AS t_nationalSum,"
           + "\n" + "                CASE"
           + "\n" + "                   WHEN data.t_currencyid != " + NATCUR
           + "\n" + "                      THEN data.t_rest"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END                                                                                   AS t_foreignSum,"
           + "\n" + "                data.t_type                                     AS t_type,"
           + "\n" + "        (SELECT reg.t_name FROM dspr_reg_dbt reg WHERE reg.t_regId = data.t_type)                     AS t_regKind,"
           + "\n" + "                (SELECT fin.t_code FROM drepfininstrument_vw fin WHERE data.t_currencyid = fin.t_id)  AS t_fiid,"
           + "\n" + "                (SELECT party.t_shortName FROM dRepParty_vw party WHERE party.t_id = data.t_contragentId) AS t_contragent,"
           + "\n" + "                data.t_number                                                                         AS t_number,"
           + "\n" + "                data.t_openDate                                                                       AS t_openDate"
           + "\n" + "           FROM ("
           + "\n" + "                 SELECT reg.t_rest                                                                           AS t_rest,"
           + "\n" + "                        reg.t_type                                                                           AS t_type,"
           + "\n" + "                        reg.t_currencyid                                                                     AS t_currencyid,"
           + "\n" + "                        (SELECT crd.t_contragentId FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId) AS t_contragentId,"
           + "\n" + "                        (SELECT crd.t_number FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)       AS t_number,"
           + "\n" + "                        (SELECT crd.t_openDate FROM df110credit_tmp crd WHERE crd.t_id = reg.t_creditId)     AS t_openDate"
           + "\n" + "                   FROM df110Register_tmp reg) data"
           + "\n" + "          WHERE data.t_rest != 0" + NVL(filter, " ")
           + "\n" + "          )"
           + "\n" + "  GROUP BY ROLLUP ((t_number, t_fiid, t_contragent, t_regKind, t_openDate))"
           + "\n" + " ORDER BY GROUPING(t_number) DESC,  t_fiId, t_number, t_openDate";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.setFieldType("openDate", V_DATE);

        var rec;

        if (dataSet.moveFirst())
            hasData = true;
            rec = dataSet.getRecord();
        end;

        if (protocol != null)
            protocol.printData(dataSet, hasData, RcbArray().initialize(PCN_REGISTER_ROUBLE_REST,
                                                                       PCN_REGISTER_CURRENCY_REST,
                                                                       PCN_CONTRACT_DEALS_NUMBER,
                                                                       PCN_CONTRACT_DEALS_DATE,
                                                                       PCN_REGISTER,
                                                                       PCN_CURRENCY,
                                                                       PCN_CONTRAGENT
                                                                       ),
                                                 RcbArray().initialize("nationalSum",
                                                                       "foreignSum",
                                                                       "t_number",
                                                                       "openDate",
                                                                       "regKind",
                                                                       "fiId",
                                                                       "t_contragent"
                                                                       ),
                              BO_NAME_DEPOSITS
                              );
        end;

        if (hasData)
            return rec;
        else
            return 0;
        end;
    end;
end;

/**
 * Источник данных по документам ГК.
 *
 */
class (TDataSourceGkboDocuments) TDataSourceGkboDocuments2332()
    initTDataSource(TDataSourceFilterGkboDocuments2332(), TProtocolGkboDocuments());
end;

/**
 * Источник данных по документам ГК.
 *
 */
class (TDataSourceGkboDocuments2332) TDataSourceGkboDocuments3053()
    initTDataSource(TDataSourceFilterGkboDocuments2332(), TProtocolGkboDocuments3053());
end;

/**
 * Источник данных по документам ГК.
 *
 */
class (TDataSourceGkboDocuments3053) TDataSourceGkboDocuments3875()
    initTDataSource(TDataSourceFilterGkboDocuments3875(), TProtocolGkboDocuments3053());
end;

/**
 * Источник данных по документам ГК.
 *
 */
class (TDataSourceGkboDocuments3875) TDataSourceGkboDocuments4033()
    initTDataSource(TDataSourceFilterGkboDocuments4033(), TProtocolGkboDocuments4033());
end;

class (TDataSourceGkboDocuments4033) TDataSourceGkboDocuments_4927()
    initTDataSourceGkboDocuments4033();

    /**
     * Сумма документов и протокол.
     * @protocol  протокол данных
     * @param     filter
     */
    private macro calculatedDocSum(protocol, document : String, withQuery : String)
        var docSum = RcbDataSet(
        ternary(withQuery != null, withQuery + ",", "WITH ")+
        "     doc AS (" + document + ")                                                                                "
        + "\n" + "SELECT fi.t_code fiid,                                                                               "
        + "\n" + "       accountSymbol,                                                                                "
        + "\n" + "       docNumber,                                                                                    "
        + "\n" + "       docDate,                                                                                      "
        + "\n" + "       creditAccount,                                                                                "
        + "\n" + "       debetAccount,                                                                                 "
        + "\n" + "       SUM(sum) sum,                                                                                 "
        + "\n" + "       note,                                                                                         "
        + "\n" + "       correctType,                                                                                  "
        + "\n" + "       correctionalFor                                                                               "
        + "\n" + "  FROM doc,                                                                                          "
        + "\n" + "       drepfininstrument_vw fi                                                                       "
        + "\n" + " WHERE fiId = fi.t_id                                                                                "
        + "\n" + " GROUP BY ROLLUP ((fi.t_code, accountSymbol, docNumber, docDate, creditAccount, debetAccount, note, correctType, correctionalFor)) "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, accountSymbol, fi.t_code, docDate, docNumber                    ");

        docSum.SetFieldType("docDate", V_DATE);

        var hasData = docSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = docSum.sum;
        end;

        if (protocol != null)
            protocol.printData(docSum, hasData, RcbArray().initialize(PCN_DOC_NUMBER,
                                                                      PCN_DOC_DATE,
                                                                      PCN_DEBET,
                                                                      PCN_CREDIT,
                                                                      PCN_DOC_SUM
                                                                      ),
                                                RcbArray().initialize("docNumber",
                                                                      "docDate",
                                                                      "debetAccount",
                                                                      "creditAccount",
                                                                      "sum"
                                                                      ),
                              BO_NAME_GK
                             );
        end;

        return sum;
    end;

    /**
     * Сумма документов.
     *
     * @param     filter
     */
    macro getDocumentsSum(protocol, arhdocFilter : String, isMinusSum /*: Bool*/)
        var i   : Integer = 2;
        var filter;
        var sign;
        var text = null;

        while (    getParm(i, filter)
               and (i < Parmcount() - 1)
              )
             getParm(i + 1, sign);
             if (valType(sign) == V_STRING)
                 text = ternary(text != null, text + "\n union all ", "") + getDocSum(filter);
                 i = i + 1;
             else
                 text = ternary(text != null, text + "\n union all ", "") + getDocSum(filter, sign);
                 i = i + 2;
             end;
        end;

        return calculatedDocSum(protocol, text, null);
    end;
end;

/**
 * Источник данных для расчета по МБК
 *
 */
class (TDataSource) TDataSourceMbk()
    private macro constructor()
        initTDataSource(TDataSourceFilterMbk(), TProtocolMbk());
    end;

   /**
    * Раздел 1
    * Атрибут А/5.2_МБК
    */
    macro getRealRvpsAndRvpsDelayed(filter : String, dealFilter : String, protocol)
        defaultParm(dealFilter, "");

        var selectRvpsSum : String = " rvpsSum"
        + "\n" + "        AS (SELECT DISTINCT deals.t_number,"
        + "\n" + "                   deals.t_openDate,"
        + "\n" + "                   dealReserve.t_reserveMainRestAccount,"
        + "\n" + "                  (dealReserve.t_rvpsSum) AS realReserve"
        + "\n" + "              FROM repMmDealReserve_vw dealReserve, repMmdeals_vw deals"
        + "\n" + "             WHERE     deals.t_id = dealReserve.t_dealid"
        + "\n" + "                   AND deals.t_kind IN (" + DEAL_KIND_PLACEMENT + ")"
               + dealFilter
               + getFilter().getRvpsAccount(filter) + "),";

        var selectRvpsDelayedSum : String = "\n" + "     rvpsDelayedSum"
        + "\n" + "        AS (SELECT DISTINCT deals.t_number,"
        + "\n" + "                   deals.t_openDate,"
        + "\n" + "                   dealReserve.t_reserveDelayedMainRestAcc,"
        + "\n" + "                  (dealReserve.t_rvpsDelayedSum) AS realReserve"
        + "\n" + "              FROM repMmDealReserve_vw dealReserve, repMmdeals_vw deals"
        + "\n" + "             WHERE     deals.t_id = dealReserve.t_dealid"
        + "\n" + "                   AND deals.t_kind IN (" + DEAL_KIND_PLACEMENT + ")"
               + dealFilter
               + getFilter().getRvpsDelayedAccount(filter) + "),";

        var selectResultConcatenation : String = "\n" + "     resultConcatenation"
        + "\n" + "        AS (SELECT NVL (rSum.t_number, rDelayedSum.t_number) AS t_numberDeal,"
        + "\n" + "                   NVL (rSum.t_openDate, rDelayedSum.t_openDate) AS t_dateDeal,"
        + "\n" + "                   rSum.t_reserveMainRestAccount,"
        + "\n" + "                   rDelayedSum.t_reserveDelayedMainRestAcc,"
        + "\n" + "                   NVL (rSum.realReserve, 0) AS t_realReserveRvps,"
        + "\n" + "                   NVL (rDelayedSum.realReserve, 0) AS t_realReserveRvpsDelayed"
        + "\n" + "              FROM rvpsSum rSum"
        + "\n" + "                   FULL JOIN rvpsDelayedSum rDelayedSum ON (rSum.t_number = rDelayedSum.t_number))";

        var realSum = TRsbDataSet( "WITH " + selectRvpsSum + selectRvpsDelayedSum + selectResultConcatenation
        + "\n" + "SELECT t_numberDeal,"
        + "\n" + "       t_dateDeal,"
        + "\n" + "       t_reserveMainRestAccount,"
        + "\n" + "       t_reserveDelayedMainRestAcc,"
        + "\n" + "       SUM (t_realReserveRvps) AS t_realReserveRvps,"
        + "\n" + "       SUM (t_realReserveRvpsDelayed) AS t_realReserveRvpsDelayed,"
        + "\n" + "       SUM (t_realReserveRvps + t_realReserveRvpsDelayed) AS t_realReserveSum"
        + "\n" + "  FROM resultConcatenation"
        + "\n" + "  GROUP BY ROLLUP ( (t_dateDeal,"
        + "\n" + "           t_numberDeal,"
        + "\n" + "           t_reserveMainRestAccount,"
        + "\n" + "           t_realReserveRvps,"
        + "\n" + "           t_reserveDelayedMainRestAcc,"
        + "\n" + "           t_realReserveRvpsDelayed))"
        + "\n" + "  ORDER BY GROUPING (t_dateDeal) DESC,"
        + "\n" + "                     t_numberDeal,"
        + "\n" + "                     t_reserveMainRestAccount,"
        + "\n" + "                     t_realReserveRvps,"
        + "\n" + "                     t_reserveDelayedMainRestAcc,"
        + "\n" + "                     t_realReserveRvpsDelayed,"
        + "\n" + "                     t_realReserveSum;",  RSDVAL_CLIENT, RSDVAL_STATIC);

        realSum.SetFieldType("t_dateDeal", V_DATE);

        var hasData = realSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = realSum.realReserveSum;
        end;

        if (protocol != null)
            protocol.printData(realSum, hasData);
        else
            m_protocol.printProtocol(realSum, hasData);
        end;

        return sum;
    end;

    /**
     * Раздел 2
     * Атрибуты S28401/1.1 S47401/2.
     */
    macro getDocumentsSum(filter : String, field : String, protocol)
        var filterField = "\n" + "                  AND dealsTemp." +  field + " = acc.t_Account";

        var accountSource : String =
          "\n" + "          SELECT deals.t_id                 AS t_idDeal,"
        + "\n" + "                 deals.t_number             AS t_numberDeal,"
        + "\n" + "                 deals.t_openDate           AS t_dateDeal,"
        + "\n" + "                 fi.t_code                  AS t_fiIdDeal,"
        + "\n" + "                 party.t_name               AS t_contragentDeal,"
        + "\n" + "                 deals." + field + "        AS t_accountDeal,"
        + "\n" + "                 acc.t_outCoverRest         AS t_outCoverRest"
        + "\n" + "            FROM repMmDeals_vw deals,"
        + "\n" + "                 drepfininstrument_vw fi,"
        + "\n" + "                 drepParty_vw party,"
        + "\n" + "                 drepAccount_vw acc"
        + "\n" + "           WHERE deals.t_isOpened = 1"
        + "\n" + "             AND deals.t_kind IN (" + DEAL_KIND_PLACEMENT + ", " + DEAL_KIND_ATTRACTION + ")"
        + "\n" + "             AND deals.t_fiId = fi.t_id"
        + "\n" + "             AND deals.t_contragentId = party.t_id"
        + "\n" + "             AND acc.t_chapter = 1"
               +               filter;

        var result : String =
          "\n" + " SELECT deal.t_numberDeal,"
        + "\n" + "        deal.t_dateDeal,"
        + "\n" + "        deal.t_fiIdDeal,"
        + "\n" + "        deal.t_contragentDeal,"
        + "\n" + "        deal.t_accountDeal,"
        + "\n" + "        SUM(deal.t_outCoverRest)    AS t_sum"
        + "\n" + "        FROM (" + accountSource + ") deal"
        + "\n" + "GROUP BY ROLLUP ( (deal.t_numberDeal,"
        + "\n" + "                   deal.t_dateDeal,"
        + "\n" + "                   deal.t_fiIdDeal,"
        + "\n" + "                   deal.t_contragentDeal,"
        + "\n" + "                   deal.t_accountDeal,"
        + "\n" + "                   deal.t_outCoverRest))"
        + "\n" + "ORDER BY GROUPING (deal.t_numberDeal) DESC,"
        + "\n" + "                   deal.t_dateDeal,"
        + "\n" + "                   deal.t_accountDeal,"
        + "\n" + "                   deal.t_outCoverRest";

        var docSum = TRsbDataSet(result);
        docSum.SetFieldType("t_dateDeal", V_DATE);

        var hasData = docSum.moveNext();
        var sum : Money = $0.0;

        if (hasData)
            sum = docSum.sum;
        end;

        if (protocol != null)
            protocol.printData(docSum, hasData);
        else
            m_protocol.printProtocol(docSum, hasData);
        end;

        return sum;
    end;

    /**
     * Раздел 4
     * Атрибуты IL/2-4 IA/1-3
     */
    macro getAccountRest(masks : String, filterMbk : String, filterAccount : string, protocol)
        var accountRest : String =
          "\n" + "           UNION ALL"
        + "\n" + "          SELECT NULL AS t_number,"
        + "\n" + "                 NULL AS t_openDate,"
        + "\n" + "                 NULL AS t_fiIdDeal,"
        + "\n" + "                 NULL AS t_contragentIdDeal,"
        + "\n" + "                 NULL AS t_accruedInterestAccount,"
        + "\n" + "                 acc.t_fiId,"
        + "\n" + "                 acc.t_account,"
        + "\n" + "                 acc.t_outCoverRest,"
        + "\n" + "                 acc.nationalSum,"
        + "\n" + "                 acc.foreignSum,"
        + "\n" + "                 acc.t_contragentId"
        + "\n" + "            FROM account acc"
        + "\n" + "           WHERE (1 = 1)"
               +             NVL(filterAccount, "");

        var dealRest : String =
          "\n" + "WITH account"
        + "\n" + "     AS ( SELECT  fi.t_code t_fiId,"
        + "\n" + "                  acc.t_contragentId,"
        + "\n" + "                  acc.t_account,"
        + "\n" + "                  acc.t_outCoverRest,"
        + "\n" + "                  CASE"
        + "\n" + "                      WHEN fi.t_id = 0"
        + "\n" + "                          THEN acc.t_outCoverRest"
        + "\n" + "                      ELSE 0"
        + "\n" + "                  END nationalSum,"
        + "\n" + "                  CASE"
        + "\n" + "                      WHEN fi.t_id != 0"
        + "\n" + "                          THEN acc.t_outCoverRest"
        + "\n" + "                      ELSE 0"
        + "\n" + "                  END foreignSum"
        + "\n" + "            FROM  drepaccount_vw acc, drepfininstrument_vw fi"
        + "\n" + "           WHERE  acc.t_fiId = fi.t_id"
        + "\n" + "             AND  acc.t_chapter = 1"
        + "\n" + "             AND  acc.t_outCoverRest != 0"
        + "\n" + "             AND" + getFilter().isSatisfiesToMasks("acc.t_account", masks) + "),"
        + "\n" + "     mmData"
        + "\n" + "     AS ( SELECT DISTINCT"
        + "\n" + "                  deals.t_number,"
        + "\n" + "                  deals.t_openDate,"
        + "\n" + "                  fi.t_code AS t_fiIdDeal,"
        + "\n" + "                  deals.t_contragentId AS t_contragentIdDeal,"
        + "\n" + "                  deals.t_accruedInterestAccount,"
        + "\n" + "                  acc.t_fiId,"
        + "\n" + "                  acc.t_account,"
        + "\n" + "                  acc.t_outCoverRest,"
        + "\n" + "                  acc.nationalSum,"
        + "\n" + "                  acc.foreignSum,"
        + "\n" + "                  acc.t_contragentId"
        + "\n" + "            FROM  repMmdeals_vw deals, drepfininstrument_vw fi, account acc"
        + "\n" + "           WHERE  deals.t_fiId = fi.t_id"
        + "\n" + "             AND acc.t_account = deals.t_accruedInterestAccount"
        + "\n" +               filterMbk
        + "\n" +  ternary(filterAccount, accountRest, "") +")";

        var resultRest : String =
        "\n" + "        SELECT  deal.t_number                                       AS numberDeal,"
        + "\n" + "              deal.t_openDate                                     AS dateDeal,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_fiIdDeal IS NULL "
        + "\n" + "                      THEN deal.t_fiId"
        + "\n" + "                  ELSE deal.t_fiIdDeal"
        + "\n" + "              END                                                 AS fiId,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_contragentIdDeal IS NULL"
        + "\n" + "                      THEN (SELECT t_name"
        + "\n" + "                             FROM drepParty_vw"
        + "\n" + "                            WHERE t_id = deal.t_contragentId)"
        + "\n" + "                  ELSE (SELECT t_name"
        + "\n" + "                          FROM drepParty_vw"
        + "\n" + "                         WHERE t_id = deal.t_contragentIdDeal)"
        + "\n" + "              END                                                 AS contragent,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_accruedInterestAccount IS NULL"
        + "\n" + "                      THEN deal.t_account"
        + "\n" + "                  ELSE deal.t_accruedInterestAccount"
        + "\n" + "              END                                                 AS t_account,"
        + "\n" + "              SUM (deal.t_outCoverRest)                           AS outCoverRest,"
        + "\n" + "              SUM (deal.nationalSum) AS nationalSum,"
        + "\n" + "              SUM (deal.foreignSum) AS foreignSum,"
        + "\n" + "              'X' reserveAccount,"
        + "\n" + "              'X' rvpsAmount,"
        + "\n" + "              'X' rvpAmount,"
        + "\n" + "              'X' rofshAmount"
        + "\n" + "        FROM  mmData deal"
        + "\n" + "      GROUP BY ROLLUP ( ( deal.t_number,"
        + "\n" + "                          deal.t_openDate,"
        + "\n" + "                          deal.t_fiIdDeal,"
        + "\n" + "                          deal.t_contragentIdDeal,"
        + "\n" + "                          deal.t_contragentId,"
        + "\n" + "                          deal.t_accruedInterestAccount,"
        + "\n" + "                          deal.t_account,"
        + "\n" + "                          deal.t_fiId,"
        + "\n" + "                          deal.t_outCoverRest,"
        + "\n" + "                          deal.nationalSum,"
        + "\n" + "                          deal.foreignSum))"
        + "\n" + "      ORDER BY GROUPING (deal.t_fiIdDeal) DESC,"
        + "\n" + "                        (deal.t_openDate) DESC,"
        + "\n" + "                         deal.t_account";

        var accountRestSum = TRsbDataSet(dealRest + resultRest,
                                         RSDVAL_CLIENT,
                                         RSDVAL_STATIC);
        accountRestSum.SetFieldType("dateDeal", V_DATE);

        var hasData = accountRestSum.moveNext();
        if (hasData)
            if (isUseBoAccounts())
                var boAcc = TBoAccounts();
                while (accountRestSum.moveNext())
                    boAcc.addAccount(accountRestSum.account);
                end;
                boAcc.insertAccounts();
                accountRestSum.moveFirst();
            end;
        end;

        if (protocol != null)
            protocol.printData(accountRestSum, hasData);
        else
            m_protocol.printProtocol(accountRestSum, hasData);
        end;

        if (hasData)
            accountRestSum.moveFirst();

            return accountRestSum;
        else
            return 0;
        end;
    end;

    constructor();
end;

/**
 * Источник данных для расчета по МБК по 4927-У
 *
 */
class (TDataSourceMbk) TDataSourceMbk_4927()
    initTDataSourceMbk();

    macro getSumFieldsMmDeals(sourceTable : String, fieldsArray : RcbArray, accountMasks : String, dealsFilter : String, protocolFieldsName : RcbArray, protocol, isMinus : bool) : Money
        defaultParm(isMinus, false);
        var fieldsAlias = ternary(sourceTable == "", "deals.", "addTable.");
        var where = "\n WHERE deals.t_isOpened = 1 " + dealsFilter;
        var whereNonZero = "\n AND (";
        var select = "SELECT deals.t_number AS t_numberDeal,"
            + "\n" + "       deals.t_openDate AS t_dateDeal";
        var groupBy = "\n GROUP BY ROLLUP ((t_number, t_openDate";
        var orderBy = "\n ORDER BY (t_openDate) DESC";
        var isFirst = true;
        var totalSum = ",\n SUM(";
        var hasAccountFields = false;
        var accountsFields = TArray;

        fieldsArray.moveFirst();
        while (fieldsArray.moveNext())
            select = select + ", \n SUM (" + fieldsAlias + fieldsArray.getCurrentItem() + ") * " +  ternary(isMinus, "(-1)", "1") + " AS " + fieldsArray.getCurrentItem();
            totalSum = totalSum + ternary(isFirst, "", " + ") + fieldsArray.getCurrentItem();
            whereNonZero = whereNonZero + ternary(isFirst, "", "\n OR ") + fieldsArray.getCurrentItem() + " != 0 ";
            fieldsArray.moveNext();
            if (fieldsArray.getCurrentItem() != "")
                hasAccountFields = true;
                select = select + ", \n " + fieldsAlias + fieldsArray.getCurrentItem() + " AS " + fieldsArray.getCurrentItem();
                groupBy = groupBy + ", " + fieldsArray.getCurrentItem();
                orderBy = orderBy + ", " + fieldsArray.getCurrentItem();

                where = where + ternary(isFirst, "\n AND (", "\n  OR ");
                where = where + getFilter().isSatisfiesToMasks( + fieldsAlias + fieldsArray.getCurrentItem(), accountMasks);

                accountsFields[accountsFields.size] = fieldsArray.getCurrentItem();
            end;
            isFirst = false;
        end;

        if (hasAccountFields)
            where = where + ")";
        end;

        whereNonZero = whereNonZero + ")";
        groupBy = groupBy + "))";
        totalSum = totalSum + ") * " +  ternary(isMinus, "(-1)", "1") + " AS t_totalSum";
        select = select + totalSum;

        var from = "\n FROM repMmdeals_vw deals";

        if (sourceTable != "")
            from = from + ", " + sourceTable + " addTable";
            where = where + "\n AND deals.t_id = addTable.t_dealId";
        end;

        var query = select + from + where + whereNonZero + groupBy + orderBy;
        var dataSet = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_dateDeal", V_DATE);

        var hasData = dataSet.moveNext();
        var sum = 0;

        if (hasData)
            sum = dataSet.totalSum;

            if (isUseBoAccounts())
                var boAcc = TBoAccounts();

                while (dataSet.moveNext())
                    var field;
                    for (field, accountsFields)
                        boAcc.addAccount(dataSet.value(field));
                    end;
                end;
                boAcc.insertAccounts();
                dataSet.moveFirst();
            end;
        end;

        if (protocolFieldsname.size > 0)
            if (protocol != null)
                fieldsArray.push_back("t_numberDeal");
                fieldsArray.push_back("t_dateDeal");
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_NUMBER);
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_DATE);

                protocol.printData(dataSet, hasData, protocolFieldsName, fieldsArray, BO_NAME_BOIBC);
             end;
        end;

        return sum;
    end;

    macro getRealRvpsAndRvpsDelayed(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealReserve_vw",
                                      RcbArray.initialize("t_rvpsSum", //
                                                          "t_reserveMainRestAccount", //
                                                          "t_rvpsDelayedSum", //
                                                          "t_reserveDelayedMainRestAcc" //
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_RVPS_SUM,
                                                          PCN_RVPS_MAIN_REST_ACCOUNT,
                                                          PCN_RVPS_DELAYED_SUM,
                                                          PCN_RVPS_DELAYED_MAIN_REST_ACC
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getRestMainDebtAndProc(dealFilter : String, protocol)
        var sum = getSumFieldsMmDeals("",
                                      RcbArray.initialize("t_mainRestRoubleAmount", //Остаток ОД в рублевом эквиваленте
                                                          "",
                                                          "t_delaydMainRestRoubleAmount", //Остаток просроченного ОД в рублевом эквиваленте
                                                          "",
                                                          "t_delaydPercentRoubleAmount", //Сумма просроченных процентов в рублевом эквиваленте
                                                          "",
                                                          "t_accruedInterestRoubleAmount", //Сумма начисленных, но не оплаченных процентов
                                                          ""
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_MAIN_REST_AMOUNT,
                                                          PCN_DELAYD_MAIN_REST_AMOUNT,
                                                          PCN_DELAYD_PERCENT_AMOUNT,
                                                          PCN_ACCRUED_INTEREST_AMOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getSumReserve(dealFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealReserve_vw",
                                      RcbArray.initialize("t_rvpsSum", //
                                                          "",
                                                          "t_rvpsDelayedSum", //
                                                          "",
                                                          "t_rvpPercentSum", //
                                                          "",
                                                          "t_rvpDelayedPercentSum", //
                                                          ""
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_RVPS_SUM,
                                                          PCN_RVPS_DELAYED_SUM,
                                                          PCN_PERC_RVP_SUM,
                                                          PCN_RVP_DELAYED_PERCENT
                                                          ),
                                      protocol, isMinus);
        return sum;
    end;

    macro getMainDebtAndPercentSum(dealFilter : String, protocol)
        var sum = getSumFieldsMmDeals("",
                                      RcbArray.initialize("t_mainRestRoubleAmount", //Остаток ОД в рублевом эквиваленте
                                                          "",
                                                          "t_delaydMainRestRoubleAmount", //Остаток просроченного ОД в рублевом эквиваленте
                                                          "",
                                                          "t_delaydPercentRoubleAmount", //Сумма просроченных процентов в рублевом эквиваленте
                                                          ""
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_MAIN_REST_AMOUNT,
                                                          PCN_DELAYD_MAIN_REST_AMOUNT,
                                                          PCN_DELAYD_PERCENT_AMOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getCorrIncResPercPenSum(dealFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_incAdjInterestReserve", //Сумма корректировки, увеличивающей резерв по процентам (Дата)
                                                          "t_incAdjInterestReserveAcc"
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        sum = sum + getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                         RcbArray.initialize("t_correctIncResPenaltySum", //Сумма корректировки, увеличивающей резерв по неустойкам
                                                             "t_correctIncResPenaltyAccount"
                                                            ),
                                         "",
                                         dealFilter,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                             ),
                                         protocol);
        return sum;
    end;

    macro getCorrDecResPercPenSum(dealFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_decAdjInterestReserve", //Сумма корректировки, уменьшающей резерв по процентам (Дата)
                                                          "t_decAdjInterestReserveAcc"
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        sum = sum + getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                         RcbArray.initialize("t_correctDecResPenaltySum", //Сумма корректировки, уменьшающей резерв по неустойкам
                                                             "t_correctDecResPenaltyAcc"
                                                            ),
                                         "",
                                         dealFilter,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                             ),
                                         protocol,
                                         isMinus);
        return sum;
    end;


    macro getRvpProcPenaltySum(dealFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealReserve_vw",
                                      RcbArray.initialize("t_rvpPercentSum", //Сумма РВП_проц
                                                          "",
                                                          "t_rvpPenaltySum", //Сумма РВП_неустойки
                                                          ""
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_PERC_RVP_SUM,
                                                          PCN_RVP_PENALTY_SUM
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getDecAdjPlacedFundsCost(dealFilter : String, accountFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_decAdjPlacedFundsCost", //Сумма корректировки, уменьшающей стоим. размещ. средств (Дата)
                                                          "t_decAdjPlacedFundsCostAcc" //Счет корректировки, уменьшающей стоим. размещ. средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        return sum;
    end;

    macro getIncAdjPlacedFundsCost(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_incAdjPlacedFundsCost", //Сумма корректировки, увеличивающей стоим. размещ. средств
                                                          "t_incAdjPlacedFundsCostAcc" //Счет корректировки, увеличивающей стоим. размещ. средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getDecAdjAttractedCost(dealFilter : String, accountFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_decAdjAttractedCost", //Сумма корректировки, уменьшающей стоим. привлеч. средств (Дата)
                                                          "t_decAdjAttractedCostAcc" //Счет корректировки, уменьшающей стоим. привлеч. средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        return sum;
    end;

    macro getIncAdjAttractedCost(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_incAdjAttractedCost", //Сумма корректировки, увеличивающей стоим. привлеч. средств
                                                          "t_incAdjAttractedCostAcc" //Счет корректировки, увеличивающей стоим. привлеч. средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getOtherIncomeSum(dealFilter : String, accountFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_otherIncomePlaceSum", //Сумма учета прочих доходов от размещенных средств
                                                          "t_otherIncomePlaceAccount" //Счет учета прочих доходов от размещенных средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        return sum;
    end;

    macro getCalcOtherIncomeSum(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_calcOtherIncomePlaceSum", //Сумма расчетов по прочим доходам от размещенных средств
                                                          "t_calcOtherIncomePlaceAccount" //Счет расчетов по прочим доходам от размещенных средств
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        return sum;
    end;


    macro getPaymentsSum(dealFilter : String, accountFilter : String, protocol, isMinus : bool)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_paymentsAmount", //Сумма расчетов по затратам по сделке
                                                          "t_paymentsAcc" //Счет расчетов по затратам по сделке
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        return sum;
    end;

    macro getCostsSum(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_costsAmount", //Сумма учтенных затрат по сделке (Дата)
                                                          "t_costsAcc" //Счет учтенных затрат по сделке
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    macro getCorrIncReserveMainDebt(dealFilter : String, accountFilter : String, protocol)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_incAdjMainDebtReserve", //Сумма корректировки, увеличивающая резерв по ОД (Дата)
                                                          "t_incAdjMainDebtReserveAcc" //Счет корректировки, увеличивающей резерв по ОД
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol);
        sum = sum + getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                         RcbArray.initialize("t_incAdjDelDebtReserve", //Сумма корректировки, увеличивающая резерв по просроченному ОД (Дата)
                                                             "t_incAdjDelDebtReserveAcc" //Счет корректировки, увеличивающей резерв по просроченному ОД
                                                            ),
                                         accountFilter,
                                         dealFilter,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                             ),
                                         protocol);
        return sum;
    end;

    macro getCorrDecReserveMainDebt(dealFilter : String, accountFilter : String, protocol, isMinus)
        var sum = getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                      RcbArray.initialize("t_decAdjMainDebtReserve", //Сумма корректировки, уменьшающей резерв по ОД (Дата)
                                                          "t_decAdjMainDebtReserveAcc" //Счет корректировки, уменьшающей резерв по ОД
                                                         ),
                                      accountFilter,
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      protocol,
                                      isMinus);
        sum = sum + getSumFieldsMmDeals("repMmDealMsfoConcepts_vw",
                                         RcbArray.initialize("t_decAdjDelDebtReserve", //Сумма корректировки, уменьшающей резерв по просроченному ОД (Дата)
                                                             "t_decAdjDelDebtReserveAcc" //Счет корректировки, уменьшающей резерв по просроченному ОД
                                                            ),
                                         accountFilter,
                                         dealFilter,
                                         RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                             PCN_ACCOUNT
                                                             ),
                                         protocol,
                                         isMinus);
        return sum;
    end;

    macro getPercentSum(dealFilter : String, protocol)
        var sum = getSumFieldsMmDeals("",
                                      RcbArray.initialize("t_accruedInterestRoubleAmount", //Сумма начисленных, но не оплаченных процентов
                                                          ""
                                                         ),
                                      "",
                                      dealFilter,
                                      RcbArray.initialize(PCN_ACCRUED_INTEREST_AMOUNT
                                                          ),
                                      protocol);
        return sum;
    end;

    /**
     * Раздел 2
     * Атрибуты S28401/1.1 S47401/2.
     */
    macro getDocumentsSum(filter : String, field : String, protocol)
        var filterField = "\n" + "                  AND dealsTemp." +  field + " = acc.t_Account";

        var accountSource : String =
          "\n" + "          SELECT deals.t_id                 AS t_idDeal,"
        + "\n" + "                 deals.t_number             AS t_numberDeal,"
        + "\n" + "                 deals.t_openDate           AS t_dateDeal,"
        + "\n" + "                 fi.t_code                  AS t_fiIdDeal,"
        + "\n" + "                 party.t_name               AS t_contragentDeal,"
        + "\n" + "                 deals." + field + "        AS t_accountDeal,"
        + "\n" + "                 acc.t_outCoverRest         AS t_outCoverRest"
        + "\n" + "            FROM repMmDeals_vw deals,"
        + "\n" + "                 drepfininstrument_vw fi,"
        + "\n" + "                 drepParty_vw party,"
        + "\n" + "                 drepAccount_vw acc"
        + "\n" + "           WHERE deals.t_isOpened = 1"
        + "\n" + "             AND deals.t_kind IN (" + DEAL_KIND_PLACEMENT + ", " + DEAL_KIND_ATTRACTION + ")"
        + "\n" + "             AND deals.t_fiId = fi.t_id"
        + "\n" + "             AND deals.t_contragentId = party.t_id"
        + "\n" + "             AND acc.t_chapter = 1"
               +               filter;

        var result : String =
          "\n" + " SELECT deal.t_numberDeal,"
        + "\n" + "        deal.t_dateDeal,"
        + "\n" + "        deal.t_fiIdDeal,"
        + "\n" + "        deal.t_contragentDeal,"
        + "\n" + "        deal.t_accountDeal,"
        + "\n" + "        SUM(deal.t_outCoverRest)    AS t_sum"
        + "\n" + "        FROM (" + accountSource + ") deal"
        + "\n" + "GROUP BY ROLLUP ( (deal.t_numberDeal,"
        + "\n" + "                   deal.t_dateDeal,"
        + "\n" + "                   deal.t_fiIdDeal,"
        + "\n" + "                   deal.t_contragentDeal,"
        + "\n" + "                   deal.t_accountDeal,"
        + "\n" + "                   deal.t_outCoverRest))"
        + "\n" + "ORDER BY GROUPING (deal.t_numberDeal) DESC,"
        + "\n" + "                   deal.t_dateDeal,"
        + "\n" + "                   deal.t_accountDeal,"
        + "\n" + "                   deal.t_outCoverRest";

        var docSum = TRsbDataSet(result);
        docSum.SetFieldType("t_dateDeal", V_DATE);

        var hasData = docSum.moveNext();
        var sum : Money = $0.0;

        if (hasData)
            sum = docSum.sum;
        end;

        if (protocol != null)
            protocol.printData(docSum, hasData, RcbArray().initialize(PCN_CONTRACT_DEALS_NUMBER,
                                                                      PCN_CONTRACT_DEALS_DATE,
                                                                      PCN_ACCOUNT,
                                                                      PCN_ACC_ROUBLE_REST
                                                                       ),
                                                 RcbArray().initialize("t_numberDeal",
                                                                       "t_dateDeal",
                                                                       "t_accountDeal",
                                                                       "t_sum"
                                                                       ),
                               BO_NAME_BOIBC
                              );
        end;

        return sum;
    end;

    /**
     * Атрибут S27801/1.1.
     */
    macro getTurnoverHistorySum(debetCredit, filter : String, protocol, isMinus : bool)
        var sumField = ternary(debetCredit == RCB_ACSDCL_DEBET, "doc.t_roubleDebetSum", "doc.t_roubleCreditSum");

        var query =
          "\n" + " SELECT deal.t_dealNumber,"
        + "\n" + "        deal.t_dealDate,"
        + "\n" + "        doc.t_number AS t_docNumber,"
        + "\n" + "        doc.t_date AS t_docDate,"
        + "\n" + "        doc.t_debetAccount,"
        + "\n" + "        doc.t_creditAccount,"
        + "\n" + "        SUM(" + sumField + ") * " + ternary(isMinus, "(-1)", "1") + " AS t_sum"
        + "\n" + "        FROM repMmDealTurnoverHistory_vw doc,"
        + "\n" + "            (SELECT mmDeal.t_id,"
        + "\n" + "                    mmDeal.t_number AS t_dealNumber,"
        + "\n" + "                    mmDeal.t_openDate AS t_dealDate"
        + "\n" + "              FROM repMmDeals_vw mmDeal"
        + "\n" + "             WHERE mmDeal.t_isOpened = 1"
        + "\n" + "               AND mmDeal.t_kind = " + DEAL_KIND_PLACEMENT
        + "\n" + "            ) deal"
        + "\n" + "  WHERE doc.t_dealId = deal.t_id"
        + "\n" + "    AND doc.t_date BETWEEN " + getSqlDate(global.getBeginYearDate())
        + "\n" + "                       AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
        + "\n" + "     " + filter
        + "\n" + "GROUP BY ROLLUP ( (deal.t_dealNumber,"
        + "\n" + "                   deal.t_dealDate,"
        + "\n" + "                   doc.t_number,"
        + "\n" + "                   doc.t_date,"
        + "\n" + "                   doc.t_debetAccount,"
        + "\n" + "                   doc.t_creditAccount,"
        + "\n" + "                   " + sumField + "))"
        + "\n" + "ORDER BY GROUPING (deal.t_dealNumber) DESC,"
        + "\n" + "                   deal.t_dealDate,"
        + "\n" + "                   doc.t_number,"
        + "\n" + "                   doc.t_date";

        var docSum = TRsbDataSet(query);
        docSum.SetFieldType("t_dealDate", V_DATE);
        docSum.SetFieldType("t_docDate", V_DATE);

        var hasData = docSum.moveNext();
        var sum : Money = $0.0;

        if (hasData)
            sum = docSum.sum;
        end;

        if (protocol != null)
            protocol.printData(docSum, hasData, RcbArray().initialize(PCN_CONTRACT_DEALS_NUMBER,
                                                                      PCN_CONTRACT_DEALS_DATE,
                                                                      PCN_DOC_NUMBER,
                                                                      PCN_DOC_DATE,
                                                                      PCN_DEBET,
                                                                      PCN_CREDIT,
                                                                      PCN_DOC_SUM
                                                                       ),
                                                 RcbArray().initialize("t_dealNumber",
                                                                       "t_dealDate",
                                                                       "t_docNumber",
                                                                       "t_docDate",
                                                                       "t_debetAccount",
                                                                       "t_creditAccount",
                                                                       "t_sum"
                                                                       ),
                               BO_NAME_BOIBC
                              );
        end;

        return sum;
    end;

    /**
     * Раздел 4
     * Атрибуты IL/2-4 IA/1-3
     */
    macro getAccountRest(masks : String, filterMbk : String, filterAccount : string, protocol)
        var accountRest : String =
          "\n" + "           UNION ALL"
        + "\n" + "          SELECT NULL AS t_number,"
        + "\n" + "                 NULL AS t_openDate,"
        + "\n" + "                 NULL AS t_fiIdDeal,"
        + "\n" + "                 NULL AS t_contragentIdDeal,"
        + "\n" + "                 NULL AS t_accruedInterestAccount,"
        + "\n" + "                 acc.t_fiId,"
        + "\n" + "                 acc.t_account,"
        + "\n" + "                 acc.t_outCoverRest,"
        + "\n" + "                 acc.nationalSum,"
        + "\n" + "                 acc.foreignSum,"
        + "\n" + "                 acc.t_contragentId"
        + "\n" + "            FROM account acc"
        + "\n" + "           WHERE (1 = 1)"
               +             NVL(filterAccount, "");

        var dealRest : String =
          "\n" + "WITH account"
        + "\n" + "     AS ( SELECT  fi.t_code t_fiId,"
        + "\n" + "                  acc.t_contragentId,"
        + "\n" + "                  acc.t_account,"
        + "\n" + "                  acc.t_outCoverRest,"
        + "\n" + "                  CASE"
        + "\n" + "                      WHEN fi.t_id = 0"
        + "\n" + "                          THEN acc.t_outCoverRest"
        + "\n" + "                      ELSE 0"
        + "\n" + "                  END nationalSum,"
        + "\n" + "                  CASE"
        + "\n" + "                      WHEN fi.t_id != 0"
        + "\n" + "                          THEN acc.t_outCoverRest"
        + "\n" + "                      ELSE 0"
        + "\n" + "                  END foreignSum"
        + "\n" + "            FROM drepaccount_vw       acc, "
        + "\n" + "                 drepfininstrument_vw fi"
        + "\n" + "           WHERE  acc.t_fiId = fi.t_id"
        + "\n" + "             AND  acc.t_chapter = 1"
        + "\n" + "             AND  acc.t_outCoverRest != 0"
        + "\n" + "             AND" + getFilter().isSatisfiesToMasks("acc.t_account", masks) + "),"
        + "\n" + "     mmDataPre"
        + "\n" + "     AS ( SELECT DISTINCT"
        + "\n" + "                  deals.t_number,"
        + "\n" + "                  deals.t_openDate,"
        + "\n" + "                  fi.t_code AS t_fiIdDeal,"
        + "\n" + "                  deals.t_contragentId AS t_contragentIdDeal,"
        + "\n" + "                  deals.t_accruedInterestAccount,"
        + "\n" + "                  acc.t_fiId,"
        + "\n" + "                  acc.t_account,"
        + "\n" + "                  acc.t_outCoverRest,"
        + "\n" + "                  acc.nationalSum,"
        + "\n" + "                  acc.foreignSum,"
        + "\n" + "                  acc.t_contragentId"
        + "\n" + "            FROM repMmdeals_vw        deals, "
        + "\n" + "                 drepfininstrument_vw fi, "
        + "\n" + "                 account              acc"
        + "\n" + "           WHERE  deals.t_fiId = fi.t_id"
        + "\n" + "             AND acc.t_account = deals.t_accruedInterestAccount"
        + "\n" +               filterMbk
        + "\n" +  ternary(filterAccount, accountRest, "") +"),"
        + "\n" + "     mmData"
        + "\n" + "     AS ( SELECT t_number,"
        + "\n" + "                 t_openDate,"
        + "\n" + "                 t_fiIdDeal,"
        + "\n" + "                 t_contragentIdDeal,"
        + "\n" + "                 t_accruedInterestAccount,"
        + "\n" + "                 t_fiId,"
        + "\n" + "                 t_account,"
        + "\n" + "                 ROW_NUMBER() OVER (PARTITION BY t_account ORDER BY t_account) accConsecutiveNumber,"   //порядковый номер л/с в выборке (группировка по л/с для выявления дубликатов)
        + "\n" + "                 t_outCoverRest,"
        + "\n" + "                 nationalSum,"
        + "\n" + "                 foreignSum,"
        + "\n" + "                 t_contragentId"
        + "\n" + "            FROM mmDataPre),"
        + "\n" + "     res "
        + "\n" + "     AS ( SELECT deal.t_number                                    AS numberDeal,"
        + "\n" + "              deal.t_openDate                                     AS dateDeal,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_fiIdDeal IS NULL "
        + "\n" + "                      THEN deal.t_fiId"
        + "\n" + "                  ELSE deal.t_fiIdDeal"
        + "\n" + "              END                                                 AS fiId,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_contragentIdDeal IS NULL"
        + "\n" + "                      THEN (SELECT t_name"
        + "\n" + "                             FROM drepParty_vw"
        + "\n" + "                            WHERE t_id = deal.t_contragentId)"
        + "\n" + "                  ELSE (SELECT t_name"
        + "\n" + "                          FROM drepParty_vw"
        + "\n" + "                         WHERE t_id = deal.t_contragentIdDeal)"
        + "\n" + "              END                                                 AS contragent,"
        + "\n" + "              CASE"
        + "\n" + "                  WHEN deal.t_accruedInterestAccount IS NULL"
        + "\n" + "                      THEN deal.t_account"
        + "\n" + "                  ELSE deal.t_accruedInterestAccount"
        + "\n" + "              END                                                 AS t_account,"
        + "\n" + "             deal.t_outCoverRest                                  AS outCoverRest,"
        + "\n" + "             deal.nationalSum                                     AS nationalSum,"
        + "\n" + "             deal.foreignSum                                      AS foreignSum,"
        + "\n" + "              'X' reserveAccount,"
        + "\n" + "              'X' rvpsAmount,"
        + "\n" + "              'X' rvpAmount,"
        + "\n" + "              'X' rofshAmount"
        + "\n" + "        FROM  mmData deal"
        + "\n" + "       UNION "
        + "\n" + "      SELECT NULL,"
        + "\n" + "             NULL,"
        + "\n" + "             NULL,"
        + "\n" + "             NULL,"
        + "\n" + "             NULL,"
        + "\n" + "             SUM (deal.t_outCoverRest),"
        + "\n" + "             SUM (deal.nationalSum),"
        + "\n" + "             SUM (deal.foreignSum),"
        + "\n" + "             'X',"
        + "\n" + "             'X',"
        + "\n" + "             'X',"
        + "\n" + "             'X'"
        + "\n" + "        FROM mmData deal"
        + "\n" + "       WHERE accConsecutiveNumber = 1"
        + "\n" + "       GROUP BY accConsecutiveNumber)";
        ;

        var resultRest : String =
          "\n" + "        SELECT numberDeal,"
        + "\n" + "               dateDeal,"
        + "\n" + "               fiId,"
        + "\n" + "               contragent,"
        + "\n" + "               t_account,"
        + "\n" + "               outCoverRest,"
        + "\n" + "               nationalSum,"
        + "\n" + "               foreignSum,"
        + "\n" + "               reserveAccount,"
        + "\n" + "               rvpsAmount,"
        + "\n" + "               rvpAmount,"
        + "\n" + "               rofshAmount"
        + "\n" + "          FROM res"
        + "\n" + "         ORDER BY fiId     DESC,"
        + "\n" + "                  dateDeal DESC,"
        + "\n" + "                  t_account";

        var accountRestSum = TRsbDataSet(dealRest + resultRest,
                                         RSDVAL_CLIENT,
                                         RSDVAL_STATIC);
        accountRestSum.SetFieldType("dateDeal", V_DATE);

        var hasData = accountRestSum.moveNext();
        if (hasData)
            if (isUseBoAccounts())
                var boAcc = TBoAccounts();
                while (accountRestSum.moveNext())
                    boAcc.addAccount(accountRestSum.account);
                end;
                boAcc.insertAccounts();
                accountRestSum.moveFirst();
            end;
        end;

        if (protocol != null)
            protocol.printData(accountRestSum, hasData, RcbArray().initialize(PCN_CONTRACT_DEALS_NUMBER,
                                                                              PCN_CONTRACT_DEALS_DATE,
                                                                              PCN_CURRENCY,
                                                                              PCN_CONTRAGENT,
                                                                              PCN_ACCOUNT,
                                                                              PCN_ACC_ROUBLE_REST,
                                                                              PCN_ACC_CURRENCY_REST
                                                                               ),
                                                 RcbArray().initialize("numberDeal",
                                                                       "dateDeal",
                                                                       "fiId",
                                                                       "contragent",
                                                                       "t_account",
                                                                       "nationalSum",
                                                                       "foreignSum"
                                                                       ),
                               BO_NAME_BOIBC
                              );
        end;

        if (hasData)
            accountRestSum.moveFirst();

            return accountRestSum;
        else
            return 0;
        end;
    end;
end;

/**
 * Источник данных для расчета по Ритейл
 *
 */
class (TDataSource) TDataSourceRetail()
    private macro constructor()
        initTDataSource(TDataSourceFilterRetail(), TProtocolRetail());
    end;

    private macro getDataFromAddTable(sourceTable : String, fieldsArray : RcbArray, contractFilter : String, accountMasks : String, protocolFieldsName : RcbArray, linkField : String, protocol, isMinus : bool)
        defaultParm(linkField, "t_contractId");
        defaultParm(isMinus, false);

        var fieldsAlias = ternary(sourceTable == "", "contract.", "addTable.");
        var where = "\n WHERE 1 = 1 " + contractFilter;
        var whereNonZero = "\n AND (";
        var select = "SELECT contract.t_number AS t_number,"
            + "\n" + "       contract.t_openDate AS t_openDate";
        var groupBy = "\n GROUP BY ROLLUP ((t_number, t_openDate";
        var orderBy = "\n ORDER BY (t_openDate) DESC";
        var isFirst = true;
        var totalSum = ",\n SUM(";
        var hasAccountFields = false;
        var accountsFields = TArray;

        fieldsArray.moveFirst();
        while (fieldsArray.moveNext())
            select = select + ", \n SUM (" + fieldsAlias + fieldsArray.getCurrentItem() + ") * " + ternary(isMinus, "(-1)", "1") + " AS " + fieldsArray.getCurrentItem();
            totalSum = totalSum + ternary(isFirst, "", " + ") + fieldsArray.getCurrentItem();
            whereNonZero = whereNonZero + ternary(isFirst, "", "\n OR ") + fieldsArray.getCurrentItem() + " != 0 ";
            fieldsArray.moveNext();
            if (fieldsArray.getCurrentItem() != "")
                hasAccountFields = true;
                select = select + ", \n " + fieldsAlias + fieldsArray.getCurrentItem() + " AS " + fieldsArray.getCurrentItem();
                groupBy = groupBy + ", " + fieldsArray.getCurrentItem();
                orderBy = orderBy + ", " + fieldsArray.getCurrentItem();

                where = where + ternary(isFirst, "\n AND (", "\n  OR ");
                where = where + getFilter().isSatisfiesToMasks( + fieldsAlias + fieldsArray.getCurrentItem(), accountMasks);

                accountsFields[accountsFields.size] = fieldsArray.getCurrentItem();
            end;
            isFirst = false;
        end;

        if (hasAccountFields)
            where = where + ")";
        end;

        whereNonZero = whereNonZero + ")";
        groupBy = groupBy + "))";
        totalSum = totalSum + ") * " + ternary(isMinus, "(-1)", "1") + " AS t_totalSum";
        select = select + totalSum;

        var from = "\n FROM repRtlDeposit_vw contract";

        if (sourceTable != "")
            from = from + ", " + sourceTable + " addTable";
            where = where + "\n AND contract.t_contractId = addTable." + linkField;
        end;

        var query = select + from + where + whereNonZero + groupBy + orderBy;
        var dataSet = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = dataSet.moveNext();
        var sum     = 0;

        if (hasData)
            sum = dataSet.totalSum;

            if (isUseBoAccounts())
                var boAcc = TBoAccounts();

                while (dataSet.moveNext())
                    var field;
                    for (field, accountsFields)
                        boAcc.addAccount(dataSet.value(field));
                    end;
                end;
                boAcc.insertAccounts();
                dataSet.moveFirst();
            end;
        end;

        if (protocolFieldsname.size > 0)
            if (protocol != null)
                fieldsArray.push_back("t_number");
                fieldsArray.push_back("t_openDate");
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_NUMBER);
                protocolFieldsName.push_back(PCN_CONTRACT_DEALS_DATE);

                protocol.printData(dataSet, hasData, protocolFieldsName, fieldsArray, BO_NAME_RETAIL);
            end;
        end;

        return sum;
   end;

    macro getDecAdjAttractedCost(contractFilter : String, accountFilter : String, protocol, isMinus)
        var sum = getDataFromAddTable("repRtlIfrsEntities_vw",
                                      RcbArray.initialize("t_correctDecBorrowSum", //Сумма корректировки, уменьшающей стоим. привлеч. средств (Дата)
                                                          "t_correctDecBorrowAccount" //Счет корректировки, уменьшающей стоим. привлеч. средств
                                                         ),
                                      contractFilter,
                                      accountFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      null,
                                      protocol,
                                      isMinus
                                     );
        return sum;
    end;

    macro getIncAdjAttractedCost(contractFilter : String, accountFilter : String, protocol)
        var sum = getDataFromAddTable("repRtlIfrsEntities_vw",
                                      RcbArray.initialize("t_correctIncBorrowSum", //Сумма корректировки, увеличивающей стоим. привлеч. средств
                                                          "t_correctIncBorrowAccount" //Счет корректировки, увеличивающей стоим. привлеч. средств
                                                         ),
                                      contractFilter,
                                      accountFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      null,
                                      protocol
                                     );
        return sum;
    end;

    macro getPercentSum(contractFilter : String, protocol)
        var sum = getDataFromAddTable("",
                                      RcbArray.initialize("t_roubleAccruedInterestSum", //Сумма начисленных процентов
                                                          ""
                                                         ),
                                      contractFilter,
                                      "",
                                      RcbArray.initialize(PCN_ACCRUED_INTEREST_AMOUNT
                                                          ),
                                      null,
                                      protocol
                                     );
        return sum;
    end;

    macro getPositiveRevalBorrowSum(contractFilter : String, accountFilter : String, protocol)
        var sum = getDataFromAddTable("repRtlIfrsEntities_vw",
                                      RcbArray.initialize("t_positiveRevalBorrowSum", //Сумма положительной переоценки привлеч. средств (Дата)
                                                          "t_positiveRevalBorrowAcc" //Счет положительной переоценки привлеч. средств
                                                         ),
                                      contractFilter,
                                      accountFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      null,
                                      protocol
                                     );
        return sum;
    end;

    macro getNegativeRevalBorrowSum(contractFilter : String, accountFilter : String, protocol, isMinus : bool)
        var sum = getDataFromAddTable("repRtlIfrsEntities_vw",
                                      RcbArray.initialize("t_negativeRevalBorrowSum", //Сумма отрицательной переоценки привлеч. средств (Дата)
                                                          "t_negativeRevalBorrowAcc" //отрицательной переоценки привлеч. средств
                                                         ),
                                      contractFilter,
                                      accountFilter,
                                      RcbArray.initialize(PCN_ACC_ROUBLE_REST,
                                                          PCN_ACCOUNT
                                                          ),
                                      null,
                                      protocol,
                                      isMinus
                                     );
        return sum;
    end;

    macro getAccountRest(contractFilter : String, accountMasks : String, protocol)
        var accountRestSum = RcbDataSet(
          "\n" + "SELECT fi.t_code                fiId,                        "
        + "\n" + "       acc.t_account            account,                     "
        + "\n" + "       sum(acc.t_outCoverRest)  outCoverRest                 "
        + "\n" + "  FROM drepaccount_vw acc,                                   "
        + "\n" + "       drepfininstrument_vw fi                               "
        + "\n" + " WHERE 1 = 1                                                 "
        + "\n" + "   AND " + getFilter().isSatisfiesToMasks("acc.t_account", accountMasks)
        + "\n" + "   AND EXISTS(SELECT 1                                 v     "
        + "\n" + "                FROM repRtlDepAccount_vw depAcc              "
        + "\n" + "               WHERE depAcc.t_cbAccount = acc.t_account      "
        + "\n" + "                 AND depAcc.t_fiId = acc.t_fiId              "
        + "\n" + "                 AND EXISTS(SELECT 1"
        + "\n" + "                              FROM repRtlDeposit_vw contract"
        + "\n" + "                             WHERE contract.t_contractId = depAcc.t_contractId"
        + "\n" + "                               " + contractFilter
        + "\n" + "                            )   "
        + "\n" + "             )   "
        + "\n" + "   AND acc.t_chapter = 1                                     "
        + "\n" + "   AND acc.t_fiid = fi.t_id                                  "
        + "\n" + "   AND acc.t_outCoverRest != 0                               "
        + "\n" + " GROUP BY ROLLUP ((fi.t_code,                                "
        + "\n" + "                   acc.t_account,                            "
        + "\n" + "                   acc.t_outcoverrest                        "
        + "\n" + "                 ))                                          "
        + "\n" + " ORDER BY GROUPING (fi.t_code) DESC, fi.t_code, acc.t_account ");

        var hasData = accountRestSum.moveNext();
        var sum     = 0;

        if (hasData)
            sum = accountRestSum.outCoverRest;
        end;

        if (protocol != null)
            protocol.printData(accountRestSum, hasData, RcbArray().initialize(PCN_ACCOUNT,
                                                                              PCN_ACC_ROUBLE_REST
                                                                              ),
                                                        RcbArray().initialize("account",
                                                                              "outCoverRest"
                                                                              ),
                               BO_NAME_RETAIL
                              );
        end;

        return sum;
    end;

    constructor();
end;

/**
 * Источник данных формы 110 от 2055-У.
 */
class (TDataSource) TDataSource2055()

    /**
     * Источник данных (раздел 1 Loans).
     */
    private var dataSourceLoansCredit;

    /**
     * Источник данных (раздел 1 Loans).
     */
    private var dataSourceLoansCase;

    /**
     * Источник данных (раздел 2 Loans).
     */
    private var dataSourceLoansRegChangeHistory;

    /**
     * Источник данных (раздел 1,3 ГК).
     */
    private var dataSourceGkboReserves;

    /**
     * Источник данных (раздел 2,3 ГК).
     */
    private var dataSourceGkboDocuments;

    /**
     * Источник данных (раздел 1 ГК строка 13.5 и 13.6).
     */
    private var dataSourceGkboReserveAccounts;

    /**
    * Источник данных
    */
    private var dataSourceGkboAccount;

    /**
    * Источник данных (по п/с МБК)
    */
    private var dataSourceMbkDeals;

    /**
    * Источник данных (по п/с Ритейл)
    */
    private var dataSourceRetail;

    /**
     * Конструктор.
     */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceMbkDeals              = TDataSourceMbk();
    end;

    /**
     * Очистить кэш данных.
     */
    private macro clear()
        dataSourceLoansCredit.clear();
        dataSourceLoansCase.clear();
        dataSourceLoansRegChangeHistory.clear();
        dataSourceGkboReserves.clear();
        dataSourceGkboDocuments.clear();
        dataSourceGkboReserveAccounts.clear();
    end;

    macro cacheData()
        clear();

        dataSourceLoansCredit.cacheData();
        dataSourceLoansCase.cacheData();
        dataSourceLoansRegChangeHistory.cacheData();
        dataSourceGkboReserves.cacheData();
        dataSourceGkboDocuments.cacheData();
        dataSourceGkboReserveAccounts.cacheData();
    end;

    /**
     * Источник данных (раздел 1 Loans).
     */
    macro dataLoansCredit()
        return dataSourceLoansCredit;
    end;

    /**
     * Источник данных (раздел 1 Loans).
     */
    macro dataLoansCase()
        return dataSourceLoansCase;
    end;

    /**
     * Источник данных (раздел 2 Loans).
     */
    macro dataLoansRegChangeHistory()
        return dataSourceLoansRegChangeHistory;
    end;

    /**
     * Источник данных (раздел 1 ГК).
     */
    macro dataGkboReserves()
        return dataSourceGkboReserves;
    end;

    /**
     * Источник данных (раздел 2,3 ГК).
     */
    macro dataGkboDocuments()
        return dataSourceGkboDocuments;
    end;

    macro dataGkboReserveAccounts()
        return dataSourceGkboReserveAccounts;
    end;

    macro dataGkboAccount()
        return dataSourceGkboAccount;
    end;

    macro dataMbkDeals()
        return dataSourceMbkDeals;
    end;

    macro dataRetail()
        return dataSourceRetail;
    end;

    constructor();
end;

/**
 * Источник данных формы 110 от 2332-У.
 */
class (TDataSource2055) TDataSource2332()
    initTDataSource2055();
    /**
     * Конструктор.
     */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves2332();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments2332();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
    end;

/*    constructor();*/
end;
/**
* Источник данных формы 110 от 2539-У.
*/
class (TDataSource2055) TDataSource2539()

    initTDataSource2055();
    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves2332();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments2332();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount();
    end;

   /**
    * Очистить кэш данных.
    */
    private macro clear()
        clear();
        dataSourceGkboAccount.clear();
    end;

    macro cacheData()
        cacheData();
        dataSourceGkboAccount.cacheData();
    end;

end;

/**
* Источник данных формы 110 от 2539-У.
*/
class (TDataSource2539) TDataSource3006()

    initTDataSource2539();
    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves2332();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments2332();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount3006();
    end;
end;

/**
* Источник данных формы 110 от 3053-У.
*/
class (TDataSource3006) TDataSource3053()

    initTDataSource3006();
    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves2332();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments3053();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount3006();
    end;
end;

/**
* Источник данных формы 110 от 3269-У.
*/
class (TDataSource3053) TDataSource3269()

    /**
    * Источник данных Кредитование (Раздел 4)
    */
    private var dataSourceLoansRegister;

    /**
    * Источник данных Депозиты (Раздел 4)
    */
    private var dataSourceDepositRegister;

    initTDataSource3053();
    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves3269();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments3053();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount3006();
        dataSourceLoansRegister         = TDataLoansRegister3006();
        dataSourceDepositRegister       = TDataDepositRegister3006();
    end;

    macro dataLoansRegister()
        return dataSourceLoansRegister;
    end;

    macro dataDepositRegister()
        return dataSourceDepositRegister;
    end;

   /**
    * Очистить кэш данных.
    */
    private macro clear()
        clear();
        dataSourceGkboAccount.clear();
        dataSourceLoansRegister.clear();
    end;

    macro cacheData()
        cacheData();
        dataSourceGkboAccount.cacheData();
        dataSourceLoansRegister.cacheData();
    end;
end;

/**
* Источник данных формы 110 от 3875-У.
*/
class (TDataSource3269) TDataSource3875()
    initTDataSource3269();

    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory();
        dataSourceGkboReserves          = TDataSourceGkboReserves3269();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments3875();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount3006();
        dataSourceLoansRegister         = TDataLoansRegister3006();
        dataSourceDepositRegister       = TDataDepositRegister3006();
    end;
end;

/**
* Источник данных формы 110 от 4033-У.
*/
class (TDataSource3875) TDataSource4033()
    initTDataSource3875();

    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory4033();
        dataSourceGkboReserves          = TDataSourceGkboReserves3269();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments4033();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount3006();
        dataSourceLoansRegister         = TDataLoansRegister3006();
        dataSourceDepositRegister       = TDataDepositRegister3006();
    end;
end;

/**
* Источник данных формы 110 от 4212-У.
*/
class (TDataSource4033) TDataSource4212()
    initTDataSource4033();

    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory4033();
        dataSourceGkboReserves          = TDataSourceGkboReserves3269();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments4033();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount4212();
        dataSourceLoansRegister         = TDataLoansRegister3006();
        dataSourceDepositRegister       = TDataDepositRegister3006();
    end;
end;

/**
* Источник данных формы 110 от 4637-У.
*/
class (TDataSource4212) TDataSource4637()
    initTDataSource4212();

    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit();
        dataSourceLoansCase             = TDataSourceLoansCase();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory4033();
        dataSourceGkboReserves          = TDataSourceGkboReserves3269();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments4033();
        dataSourceGkboReserveAccounts   = TDataSourceGkboReserveAccounts();
        dataSourceGkboAccount           = TDataSourceGkboAccount4637();
        dataSourceLoansRegister         = TDataLoansRegister3006();
        dataSourceDepositRegister       = TDataDepositRegister3006();
        dataSourceMbkDeals              = TDataSourceMbk();
    end;
end;

/**
* Источник данных формы 110 по 4927-У.
*/
class (TDataSource4637) TDataSource4927()
    initTDataSource4637();

    /**
    * Источник данных (по Securities)
    */
    private var dataSourceSecurities;

    macro dataSecurities()
        return dataSourceSecurities;
    end;

    /**
     * Очистить кэш данных.
     */
    private macro clear()
        dataSourceLoansCredit.clear();
        dataSourceLoansRegChangeHistory.clear();
        dataSourceGkboReserves.clear();
        dataSourceGkboDocuments.clear();
    end;

    macro cacheData()
        clear();

        dataSourceLoansCredit.cacheData();
        dataSourceLoansRegChangeHistory.cacheData();
        dataSourceGkboReserves.cacheData();
        dataSourceGkboDocuments.cacheData();
    end;

    /**
    * Конструктор.
    */
    macro constructor()
        dataSourceLoansCredit           = TDataSourceLoansCredit_4927();
        dataSourceLoansRegChangeHistory = TDataSourceLoansRegChangeHistory_4927();
        dataSourceGkboReserves          = TDataSourceGkboReserves4927();
        dataSourceGkboDocuments         = TDataSourceGkboDocuments_4927();
        dataSourceGkboAccount           = TDataSourceGkboAccount4927();
        dataSourceLoansRegister         = TDataLoansRegister4927();
        dataSourceDepositRegister       = TDataDepositRegister_4927();
        dataSourceMbkDeals              = TDataSourceMbk_4927();
        dataSourceRetail                = TDataSourceRetail();
        dataSourceSecurities            = TDataSourceSecurities();
    end;
end;
