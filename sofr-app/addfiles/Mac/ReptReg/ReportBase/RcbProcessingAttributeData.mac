/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Классы для обработки атрибута отчета

   CREATED : 08.12.08 Ser.
└─────────────────────────────────────────────────────────────────────────- */
import RcbLibrary;
import RcbAttributeBase;

/**
 * Класс содержащий данные для вызова одного метода произвольного класса
 */
class RcbExecutionData(methodReferences : MethodRef, methodParameters : RcbArray)
    private var m_methodReferences    : MethodRef = methodReferences;

    private var m_methodParameters    : RcbArray  = nvl(methodParameters, RcbArray());

    private macro getCommandText() : String
        var parameterString = "";
        var i = 0;

        while (i < m_methodParameters.size)
            parameterString = parameterString + ", m_methodParameters[" + i + "]";
            i = i + 1;
        end;

        return "callR2M(m_methodReferences" + parameterString + ")";
    end;

    macro process()
        return ExecExp(getCommandText());
    end;
end;

/**
 * TypeDef для методов предобработки
 */
class (RcbExecutionData) RcbPreprocessingData(methodReferences : MethodRef, methodParameters : RcbArray)
    initRcbExecutionData(methodReferences, methodParameters);

    macro calculate()
        return process();
    end;
end;

/**
 * TypeDef для методов расчета
 */
class (RcbExecutionData) RcbCalculationData(methodReferences : MethodRef, methodParameters : RcbArray)
    initRcbExecutionData(methodReferences, methodParameters);

    macro calculate()
        return process();
    end;
end;

/**
 * TypeDef для методов контроля
 */
class (RcbExecutionData) RcbCheckoutData(methodReferences : MethodRef, methodParameters : RcbArray)
    initRcbExecutionData(methodReferences, methodParameters);
end;

/**
 * Класс для хранения зависимостей атрибутов, по сути просто контейнер, содержащий ссылки на атрибуты, от которых зависит рассчитываемый атрибут
 */
class RcbDependencesData(dependetAttributePool : RcbArray)
    private var m_dependetAttributePool : RcbArray = nvl(dependetAttributePool, RcbArray());


    macro getDependentAttributePool() : RcbArray
        return m_dependetAttributePool;
    end;

    /**
     * @param     attribute
     */
    macro addAttribute(attribute : RcbAttributeBase) : RcbDependencesData
        m_dependetAttributePool.push_back(attribute);
        return this;
    end;
end;

/**
 * Набор данных для выполнения предобработки.
 * Для универсализации завязываемся на конкретный атрибут, хотя предобработка может предназначаться и для расчета в целом.
 *
 */
class RcbPreprocessingAttributeData(attribute : RcbAttributeBase, preprocessingDataPool : RcbArray, dependencesData : RcbDependencesData)
    private var m_preprocessingDataPool : RcbArray     = preprocessingDataPool;

    private var m_dependencesData : RcbDependencesData = nvl(dependencesData, RcbDependencesData());

    private var m_attribute       : RcbAttributeBase   = attribute;

    private var m_isExecuted      : Bool               = false;

    macro addPreprocessingData(preprocessingData : RcbPreprocessingData) : RcbPreprocessingAttributeData
        m_preprocessingDataPool.push_back(preprocessingData);
        return this;
    end;

    macro isExecute() : bool
        return m_isExecuted;
    end;

    macro setExecuted()
        m_isExecuted = true;
    end;

    macro getPreprocessingDataPool() : RcbArray
        return m_preprocessingDataPool;
    end;

    macro getDependencesData() : RcbDependencesData
        return m_dependencesData;
    end;

    macro getAttribute() : RcbAttributeBase
        return m_attribute;
    end;
end;

/**
 * Набор данных для расчета одного атрибута
 */
class RcbCalculationAttributeData(attribute : RcbAttributeBase, calculationDataPool : RcbArray, dependencesData : RcbDependencesData)
    private var m_calculateDataPool : RcbArray           = calculationDataPool;

    private var m_dependencesData   : RcbDependencesData = nvl(dependencesData, RcbDependencesData());

    private var m_attribute         : RcbAttributeBase   = attribute;

    private var m_isCalculated      : Bool               = false;

    macro addCalculationData(calculationData : RcbCalculationData) : RcbCalculationAttributeData
        m_calculateDataPool.push_back(calculationData);
        return this;
    end;

    macro isCalculate() : bool
        return m_isCalculated;
    end;

    macro setCalculated()
        m_isCalculated = true;
    end;

    macro getCalculationDataPool() : RcbArray
        return m_calculateDataPool;
    end;

    macro getDependencesData() : RcbDependencesData
        return m_dependencesData;
    end;

    macro getAttribute() : RcbAttributeBase
        return m_attribute;
    end;
end;

/**
 * Данные для контроля атрибута (претендуют на универсальные данные для обработки)
 */
class RcbProcessingAttributeData(attribute : RcbAttributeBase, processingDataPool : RcbArray, dependencesData : RcbDependencesData)
    private var m_processingDataPool : RcbArray = processingDataPool;
    private var m_dependencesData : RcbDependencesData = nvl(dependencesData, RcbDependencesData());
    private var m_attribute : RcbAttributeBase = attribute;
    private var m_isProcessed : Bool = false;
    private var m_isFailedProcessing : Bool = true;

    macro addProcessingData(processingData : Object) : Object
        m_processingDataPool.push_back(processingData);
        return this;
    end;

    macro isProcessed() : bool
        return m_isProcessed;
    end;

    macro setProcessed()
        m_isProcessed = true;
    end;

    macro isFailedProcessing()
        return m_isFailedProcessing;
    end;

    macro setFailedProcessing(value : Bool)
        m_isFailedProcessing = value;
    end;

    macro getProcessingDataPool() : RcbArray
        return m_processingDataPool;
    end;

    macro getDependencesData() : RcbDependencesData
        return m_dependencesData;
    end;

    macro getAttribute() : RcbAttributeBase
        return m_attribute;
    end;
end;
