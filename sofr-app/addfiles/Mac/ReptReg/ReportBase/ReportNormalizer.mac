/*
$Name:          ReportNormalizer.mac
$Module:        Регламентируемая отчетность
$Description:   ReportBase. Класс нормализатора
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Класс для работы с нормализатором

   CREATED : 03.08.09 Radko.
└─────────────────────────────────────────────────────────────────────────- */
import rcw;
import ReportNormalizationAlgorithm;
import ReportNode;
import ReportLinearRelation;
import lib_path;
import Reporting;

private class JavaReportNormalizer(multiplier : Integer)
    /*
     * Java обект класса ReportNormalaizer.
     */
    private  var normalizer;
    /*
     * Объект класса TJavaHost.
     */
    var jvm;
    /**
     * Конструктор класса.
     */
    private macro constructorReportNormalizer(multiplier : Integer)
        jvm = CreateObject ("rsjvm", "TJavaHost", "GlobalJavaHost");
        var path = ReturnDirString( "TEXTDIR", "TXTFILE" );
        var fileName = "normalizer" + StrSubst ( String(time), ":", "" ) + String (Random(1000))+ ".log";
        normalizer = jvm.createJavaObject ("ReportNormalizer.Normalizer","<init>", multiplier, path , fileName);
        normalizer.initOutStream();
        RepTxtFilesQueue().add(fileName, false);
    end;
    /*-------------------------------------------------------------------------*/
    /*Блок открытых методов*/
    /*-------------------------------------------------------------------------*/
    /**
     * Метод возвращает вершину дерева нормализации.
     */
    macro node(code : String)
        if (normalizer.node(code) == null)
            return null;
        end;

        return ReportNode(normalizer.node(code));
    end;
    /**
     * Метод добавляет вершину в дерево нормализации.
     */
    macro addNode(code : String)
        return ReportNode(normalizer.addNode(code));
    end;
    /**
     * Метод добавляет линейное отношение в нормализатор.
     */
    macro addRelation(relation : Object)
        normalizer.addRelation(relation.getLinearRelation());
    end;

    /**
     * Метод определяет удалось ли нормализовать данные.
     */
    macro isNormalized()
        return normalizer.isNormalized();
    end;

    /**
     * Метод возвращает флаг ошибки проверки на точных значениях.
     */
    macro isErrorExact()
        return normalizer.isErrorExact();
    end;

    /**
     * Метод проверяет выполняется ли данные условия на неокругленных значениях.
     */
    macro checkExactValue()
        return normalizer.checkExactValue();
    end;
    /**
     * Метод возвращает полный путь к log-файлу.
     */
    macro getLogFilePath()
        return normalizer.getLogFilePath();
    end;
    /**
     * Метод выполняет операцию нормализации.
     */
    macro normalize()
        normalizer.normalize();
        normalizer.resetOutStream();
    end;

    /**
     * Метод устанавливает максимальное количество допустимых решений.
     */
    macro setMaxNumberOfDecision(numberOfDecision : Integer)
        normalizer.setMaxNumberOfDecision(numberOfDecision);
    end;

    /**
     * Метод устанавливает признак оптимальности решения.
     */
    macro setIsOptimalDecision(isOptimalDecision : Bool)
        normalizer.setIsOptimalDecision(isOptimalDecision);
    end;
    /**
     * Метод устанавливает признак поуровневой нормализации.
     */
    macro setIsNormalizeByGroup(isNormalizeByGroup : Bool)
        normalizer.setIsNormalizeByGroup(isNormalizeByGroup);
    end;
    /**
     * Метод возвращает группу по id.
     */
    macro getGroup(idGroup : Integer)
        return normalizer.getGroup(idGroup);
    end;
    /**
     * Метод устанавливает максимальное время решения задачи нормализации.
     */
    macro setTimeLimit(limit : Integer)
        normalizer.setTimeLimit(limit);
    end;

    macro getTimeNormalizationAsString()
        return normalizer.getTimeNormalizationAsString();
    end;

    /*
     * Вызов конструктора класса.
     */
    constructorReportNormalizer(multiplier);
    /*
     * Деструктор класса.
     */
    macro destructor()
        normalizer.resetOutStream();
        normalizer = null;
        jvm.collect;
        jvm.DisposeAllJavaObjects (false);
        jvm = null;
    end;
end;

class JavaSmNormalizer(multiplier : Integer)
    private var m_normalizer;
    private var m_path;
    private var m_fileName;

    /*
     * Объект класса TJavaHost.
     */
    private macro constructorJavaSmNormalizer(multiplier : Integer)
        var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
        m_normalizer = jvm.createJavaObject("SmNormalizer.Normalizer","<init>", multiplier);
        m_path = ReturnDirString("TEXTDIR", "TXTFILE");
        m_fileName = m_path + "normalizer" + StrSubst(String(time), ":", "") + String(Random(1000))+ ".log";
    end;

    macro toString()
        return m_normalizer.toString();
    end;

    macro node(code : String)
        if (m_normalizer.getNode(code) == null)
            return null;
        end;
        return JSMReportNode(m_normalizer.getNode(code));
    end;

    macro addNode(code : String)
        return JSMReportNode(m_normalizer.addNode(code));
    end;

    macro addRelation(relation : Object)
        m_normalizer.addRelation(relation.getLinearRelation());
    end;

    macro isNormalized()
        return m_normalizer.isNormalized();
    end;

    macro isErrorExact()
        return m_normalizer.isErrorExact();
    end;

    macro checkExactValue()
        return m_normalizer.checkExactValue();
    end;

    macro getLogFilePath()
        return m_fileName;
    end;

    macro normalize()
        var v = m_normalizer.normalize();
        var out = setOutput(m_fileName, true);
        println(m_normalizer.getLogText());
        setOutput(out, true);

        return v;
    end;

    macro setMaxNumberOfDecision(numberOfDecision : Integer)
        ;
    end;

    macro setIsOptimalDecision(isOptimalDecision : Bool)
        ;
    end;

    macro setIsNormalizeByGroup(isNormalizeByGroup : Bool)
        ;
    end;

    macro getGroup(idGroup : Integer)
        return DummyGroup();
    end;

    macro setTimeLimit(limit : Integer)
        ;
    end;

    macro getTimeNormalizationAsString()
        return m_normalizer.getTimeNormalizationAsString();
    end;

    constructorJavaSmNormalizer(multiplier);
end;

class ReportNormalizer(multiplier : Integer)
    /*
     * Java обект класса ReportNormalaizer.
     */
    private  var normalizer;
    /**
     * Конструктор класса.
     */
    private macro constructorReportNormalizer(multiplier : Integer)
        if (NormalizationAlgorithm.getReportNormalizationAlgorithm() == CPP_MMB_NORMALIZER)
            var path     = ReturnDirString( "TEXTDIR", "TXTFILE" );
            var fileName = "normalizer" + StrSubst ( String(time), ":", "" ) + String (Random(1000))+ ".log";

            normalizer = CReportNormalizer(Double(multiplier), path, fileName);

            normalizer.initOutStream();

            RepTxtFilesQueue().add(fileName, false);
        elif (NormalizationAlgorithm.getReportNormalizationAlgorithm() == JAVA_SM_NORMALIZER)
            normalizer = JavaSmNormalizer(multiplier);
        else
            normalizer = JavaReportNormalizer(multiplier);
        end;
    end;
    /*-------------------------------------------------------------------------*/
    /*Блок открытых методов*/
    /*-------------------------------------------------------------------------*/
    /**
     * Метод возвращает вершину дерева нормализации.
     */
    macro node(code : String)
        if (normalizer.node(code) == null)
            return null;
        end;
        return normalizer.node(code);
    end;
    /**
     * Метод добавляет вершину в дерево нормализации.
     */
    macro addNode(code : String)
        return normalizer.addNode(code);
    end;
    /**
     * Метод добавляет линейное отношение в нормализатор.
     */
    macro addRelation(relation : Object)
        normalizer.addRelation(relation.getLinearRelation());
    end;

    /**
     * Метод определяет удалось ли нормализовать данные.
     */
    macro isNormalized()
        return normalizer.isNormalized();
    end;

    /**
     * Метод возвращает флаг ошибки проверки на точных значениях.
     */
    macro isErrorExact()
        return normalizer.isErrorExact();
    end;

    /**
     * Метод проверяет выполняется ли данные условия на неокругленных значениях.
     */
    macro checkExactValue()
        return normalizer.checkExactValue();
    end;
    /**
     * Метод возвращает полный путь к log-файлу.
     */
    macro getLogFilePath()
        return normalizer.getLogFilePath();
    end;
    /**
     * Метод выполняет операцию нормализации.
     */
    macro normalize()
        normalizer.normalize();
    end;

    /**
     * Метод устанавливает максимальное количество допустимых решений.
     */
    macro setMaxNumberOfDecision(numberOfDecision : Integer)
        normalizer.setMaxNumberOfDecision(numberOfDecision);
    end;

    /**
     * Метод устанавливает признак оптимальности решения.
     */
    macro setIsOptimalDecision(isOptimalDecision : Bool)
        normalizer.setIsOptimalDecision(isOptimalDecision);
    end;
    /**
     * Метод устанавливает признак поуровневой нормализации.
     */
    macro setIsNormalizeByGroup(isNormalizeByGroup : Bool)
        normalizer.setIsNormalizeByGroup(isNormalizeByGroup);
    end;
    /**
     * Метод возвращает группу по id.
     */
    macro getGroup(idGroup : Integer)
        return normalizer.getGroup(idGroup);
    end;
    /**
     * Метод устанавливает максимальное время решения задачи нормализации.
     */
    macro setTimeLimit(limit : Integer)
        normalizer.setTimeLimit(limit);
    end;

    macro getTimeNormalizationAsString()
        return normalizer.getTimeNormalizationAsString();
    end;

    macro toString()
        if (NormalizationAlgorithm.getReportNormalizationAlgorithm() == JAVA_SM_NORMALIZER)
            return normalizer.toString();
        end;

        return "";
    end;

    /*
     * Вызов конструктора класса.
     */
    constructorReportNormalizer(multiplier);
end;
