/**
 * Класс TDepartmentOkatoControlOperation.
 */
import globals;
import cb_sql;
import RcbCoreInter;
import departmentFilter;
import RcbDepartmentOkatoControlProtocolView;

/**
 * Операция контроля первичных даных.
 */
class TDepartmentOkatoControlOperation(reportName : String)

    private var m_endDate;

    private var m_reportName;

    macro constructorTDepartmentOkatoControlOperation(reportName)
        m_reportName = reportName;
        m_endDate   = rcbApplication().currentReport.context.period.endDate;
    end;

    macro cashDepartments()
        sql_execute("call rep_opt.resetDepartmentCodesCache();");
        sql_execute("call rep_opt.cacheDepartmentCodes( " + getSqlDate(m_endDate) + " , " + getSqlString("dp_dep.t_code IN " + rcbDepartmentList().getAsSqlSetFull()) + " );");
    end;

    /**
     * Выполнить контроль.
     */
    macro execute()
        var protocolView = TDepartmentOkatoControlProtocolView("ПРОТОКОЛ КОНТРОЛЯ НАЛИЧИЯ КОДОВ ОКАТО У ПОДРАЗДЕЛЕНИЙ", m_reportName);

        cashDepartments();

        protocolView.printProtocol();
    end;

    constructorTDepartmentOkatoControlOperation(reportName);

end;

