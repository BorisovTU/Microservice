/*
$Name:          calc_f251rt.mac
$Module:        Регламентируемая отчетность
$Description:   Расчет формы 251 по данным Retail.
*/

import testLib;
import calc_f251;

/***************************************************************************************************
 *  Константы
 **************************************************************************************************/
//private const INTERNET_DEPOSIT = 4;

/***************************************************************************************************
 *  Параметры отчета
 **************************************************************************************************/
private var parameters = TParameters();

/***************************************************************************************************
 *  Классы для создания запросов
 **************************************************************************************************/
private class TRtQueryBuilder(line : String)
    private var m_line = line;

    // Значения полей по-умолчанию.
    var m_bo                      = BORETAIL;
    var m_column                  = string(-1);
    var m_account                 = "NULL";
    var m_creditAccount           = "NULL";
    var m_clientCode              = string(-1);
    var m_documentNumber          = "NULL";
    var m_documentReferenceNumber = "NULL";
    var m_carryDate               = "'" + Date(0,0,0) + "'";
    var m_fiid                    = string(-1);
    var m_roublesum               = string(0);
    var m_currencySum             = string(0);
    var m_sendingMode             = "NULL";
    var m_docCount                = string(1);
    var m_errorKind               = ERROR_KIND_NONE;
    var m_isInternetOrigin        = string(-1);
    var m_autoKey                 = string(-1);
    var m_isPmd                   = string(-1);

    private macro getSelectClause()
        private var query =
                     "SELECT " + string(m_bo)                       + " t_backOffice,"
            + "\n" + "       " + getSqlString(m_line)               + " t_line,"
            + "\n" + "       " + m_column                           + " t_column,"
            + "\n" + "       " + m_account                          + " t_account,"
            + "\n" + "       " + m_creditAccount                    + " t_creditAccount,"
            + "\n" + "       " + m_clientCode                       + " t_clientCode,"
            + "\n" + "       " + m_documentNumber                   + " t_documentNumber,"
            + "\n" + "       " + m_documentReferenceNumber          + " t_documentReferenceNumber,"
            + "\n" + "       " + m_carryDate                        + " t_carryDate,"
            + "\n" + "       " + m_fiid                             + " t_fiid,"
            + "\n" + "       " + m_roublesum                        + " t_roublesum,"
            + "\n" + "       " + m_currencySum                      + " t_currencySum,"
            + "\n" + "       " + m_sendingMode                      + " t_sendingMode,"
            + "\n" + "       " + getSqlString(substr(m_line, 1, 1)) + " t_part,"
            + "\n" + "       " + m_docCount                         + " t_docCount,"
            + "\n" + "       " + string(m_errorKind)                + " t_errorKind,"
            + "\n" + "       " + m_isInternetOrigin                 + " t_isInternetOrigin,"
            + "\n" + "       " + m_autoKey                          + " t_autoKey,"
            + "\n" + "       " + m_isPmd                            + " t_isPmd";

        return query;
    end;

    macro build()
        return getSelectClause();
    end;
end;

private class (TRtQueryBuilder) TRtQueryBuilder_1(line : String)
    initTRtQueryBuilder(line);

    if (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
        m_creditAccount = "rd.t_cbAccount";
    end;
    m_account     = "rd.t_account";
    m_column      = "DECODE(rd.t_currencyId, 0, 3, 4)";
    m_roublesum   = "rd.t_roubleOutRest";
    m_currencySum = "DECODE(rd.t_currencyId, 0, 0, rd.t_outRest)";
    m_errorKind   = "DECODE(NVL((SELECT 1                               "
           + "\n" + "              FROM dRepParty_vw                    "
           + "\n" + "             WHERE t_id         = rd.t_contragentId"
           + "\n" + "               AND t_isPhisical = 1), 0), 1, " + ERROR_KIND_NONE + ", " + ERROR_KIND_WRONG_DOCUMENT_CLIENT + ")";
    m_clientCode  = "rd.t_contragentId";
    m_fiid        = "rd.t_finInstrumentId";

    macro build()
        return getSelectClause()
            + "\n" + "  FROM repRtlDeposit_vw rd,"
            + "\n" + "       repRtlDepAccount_vw rda"
            + "\n" + " WHERE (" + convertMaskToSqlFormat(tuneTable.getMaskForLine(m_line, BORETAIL), "rd.t_account") + ")"
            + "\n" + "   AND rda.t_account           = rd.t_account"
            + "\n" + "   AND rda.t_isOpenedAtEndDate = 1"
            + "\n" + "   AND rd.t_isOpenedAtEndDate  = 1"
            + "\n" + "   AND " + rcbBranchFieldFilter.getAsSqlString("rd.t_branchid")
            + "\n" + "   AND CASE"
            + "\n" + "           WHEN rd.t_balance IN ('40806', '40809', '40812', '40814', '40815', '40823', '40824')"
            + "\n" + "               THEN CASE"
            + "\n" + "                        WHEN (SELECT party.t_isPhisical"
            + "\n" + "                                FROM dRepParty_vw party"
            + "\n" + "                               WHERE party.t_id = rd.t_contragentId) = 1"
            + "\n" + "                             THEN 1"
            + "\n" + "                        ELSE 0"
            + "\n" + "                    END"
            + "\n" + "           ELSE 1"
            + "\n" + "       END = 1";
    end;
end;

private class (TRtQueryBuilder_1) TRtQueryBuilder_1_2()
    initTRtQueryBuilder_1("1.2");
end;

private class (TRtQueryBuilder_1) TRtQueryBuilder_1_2_1()
    initTRtQueryBuilder_1("1.2.1");
end;

/***************************************************************************************************
 *  Источники данных
 **************************************************************************************************/
private class (TDataSource) TDataSourceRetailAccounts()
    initTDataSource(BORETAIL);

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_1_2().build());
        sql_execute(insertClause + TRtQueryBuilder_1_2_1().build());
    end;
end;

private class (TDataSource) TDataSourceRetailAccounts_3875()
    initTDataSource(BORETAIL);

    private class (TRtQueryBuilder_1) TRtQueryBuilder_1_2_1_3875()
        initTRtQueryBuilder_1("1.2.1");

        macro build()
            return build()
            + "\n" + "   AND t_hasOtherRemoteAccess = 1";
        end;
    end;

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_1_2().build());
        sql_execute(insertClause + TRtQueryBuilder_1_2_1_3875().build());
    end;
end;

private class (TDataSourceRetailAccounts) TDataSourceRetailDocuments()
    initTDataSourceRetailAccounts();

    private class (TRtQueryBuilder_1) TRtQueryBuilder_1_2_2(line : String)
        defaultParm(line, "1.2.2");
        initTRtQueryBuilder_1(line);

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
            m_creditAccount = "rd.t_cbAccount";
        end;

        m_errorKind       = "DECODE(NVL((select 1 from dRepParty_vw where T_ID = rd.t_contragentid"
            + "\n" + "            and t_isPhisical = 1 and t_isEmployer = 0), 0), 1, " + ERROR_KIND_NONE + ", " + ERROR_KIND_WRONG_DOCUMENT_CLIENT + ")";

        macro build()
            var year = 0;
            dateSplit(parameters.getEndDate(), null, null, year);

            return build()
                + "\n" + "   AND EXISTS(SELECT NULL"
                + "\n" + "                FROM repRtlDepDocument_vw rdd"
                + "\n" + "               WHERE rdd.t_referenc = rd.t_referenc"
                + "\n" + "                 AND rdd.t_date >= " + getSqlDate(Date(01, 01, year))
                + "\n" + "                 AND rdd.t_date <= " + getSqlDate(parameters.getEndDate())
                + "\n" + "                 AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine(m_line, BORETAIL), "rdd.t_debetBalance") + ")"
                + "\n" + "                 AND NOT (" + convertMaskToSqlFormat("202*", "rdd.t_creditBalance") + ")"
                + "\n" + "              )";
        end;
    end;

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();
        sql_execute(insertClause + TRtQueryBuilder_1_2_2().build());
    end;
end;

private class (TDataSourceRetailDocuments) TDataSourceRetailDocumentsInternet()
    initTDataSourceRetailDocuments();

    private class (TRtQueryBuilder_1_2_2) TRtQueryBuilder_1_2_2_1_1()
        initTRtQueryBuilder_1_2_2("1.2.2"); // в настроечной таблице нет строки для "1.2.2.1.1"

        private macro getSelectClause()
            private var query;
            private var line = m_line;
            m_line = "1.2.2.1.1";
            query = getSelectClause();
            m_line = line;

            return query;
        end;

        macro build()
            return build()
                // когда позволит источник данных, вставить фильтр
                // "Категория = <Доступ через Интернет>" (подробнее см. #115121)
                // а пока ставим заглушку :
                + "\n" + "   AND 0 = 1";
        end;
    end;

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();
        sql_execute(insertClause + TRtQueryBuilder_1_2_2_1_1().build());
    end;
end;

private class (TDataSource) TDataSourceRetailDocuments_2_2()
    initTDataSource(BORETAIL);

    private class (TRtQueryBuilder) TRtQueryBuilder_2_2(line : String)
        initTRtQueryBuilder(line);

        m_line                    = line;
        m_column                  = "DECODE(dataPmd.t_debitCurrCode, 643, 3, 4)";
        m_account                 = "dataPmd.t_debitAccount";
        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
            m_creditAccount       = "dataPmd.t_creditAccount";
        end;
        m_roublesum               = "dataPmd.t_natCurrEquivalent";
        m_currencySum             = "dataPmd.t_natCurrEquivalent";
        m_errorKind               = ERROR_KIND_NONE;
        m_clientCode              = "dataPmd.t_payerPartyId";
        m_fiid                    = "0";
        m_documentNumber          = "dataPmd.t_documentId";
        m_carryDate               = "dataPmd.t_date";
        m_documentReferenceNumber = "dataPmd.t_operationcipher";
        m_isPmd                   = 1;  /* note: Документ является расчетно-денежным (РДД). */

        macro build()
            return getSelectClause()
                + "\n" + " FROM (SELECT NVL((SELECT party.t_name"
                + "\n" + "                     FROM dRepParty_vw party"
                + "\n" + "                    WHERE pmd.t_payerPartyId = party.t_id"
                + "\n" + "                      AND party.t_isPhisical = 1),"
                + "\n" + "                  (SELECT pmdParty.t_name"
                + "\n" + "                     FROM repRtlPmdParty_vw pmdParty"
                + "\n" + "                    WHERE pmdParty.t_type      = 2"
                + "\n" + "                      AND pmdParty.t_character = 1"
                + "\n" + "                      AND pmd.t_documentId     = pmdParty.t_documentId"
                + "\n" + "                      AND rownum < 2)) as t_payerPartyName,"
                + "\n" + "              pmd.*"
                + "\n" + "         FROM "
                + "\n" + "              (SELECT pmd.t_debitCurrCode,"
                + "\n" + "                      NVL(pmd.t_debitAccount, pmdAccount.t_account) as t_debitAccount,"
                + "\n" + "                      DECODE(pmd.t_debitAccount, NULL, pmdAccount.t_amount, pmd.t_debitAmount) as t_debitAmount,"
                + "\n" + "                      pmd.t_creditAccount,"
                + "\n" + "                      pmd.t_payerPartyId,"
                + "\n" + "                      pmd.t_documentId,"
                + "\n" + "                      pmd.t_operationcipher,"
                + "\n" + "                      pmd.t_date,"
                + "\n" + "                      DECODE(pmd.t_debitAccount, NULL, pmdAccount.t_natCurrEquivalent, pmd.t_natCurrEquivalent) as t_natCurrEquivalent,"
                + "\n" + "                      pmd.t_paymentMode,"
                + "\n" + "                      pmd.t_isInternet"
                + "\n" + "                 FROM repRtlPmd_vw pmd"
                + "\n" + "            LEFT JOIN repRtlPmdAccount_vw pmdAccount"
                + "\n" + "                   ON pmd.t_documentId = pmdAccount.t_documentId"
                + "\n" + "                WHERE NOT pmd.t_date IS NULL"
                + "\n" + "                  AND EXISTS(SELECT 1 "
                + "\n" + "                               FROM dpmpaym_dbt pmpaym "
                + "\n" + "                              WHERE pmpaym.t_paymstatus = 32000 "
                + "\n" + "                                AND pmpaym.t_documentid = (SELECT oproper.t_documentid "
                + "\n" + "                                                             FROM doproper_dbt oproper "
                + "\n" + "                                                            WHERE oproper.t_id_operation = TO_NUMBER(pmd.t_paymentid)))"
                + "\n" + "                  AND NOT (    pmd.t_payerPartyId = pmd.t_receiverPartyId"
                + "\n" + "                           AND EXISTS(SELECT 1 FROM drepourbank_tmp ourBank WHERE pmd.t_payerPartyId <> ourBank.t_partyId)"
                + "\n" + "                          )"
                + "\n" + "                  AND (SELECT party.t_isPhisical"
                + "\n" + "                         FROM dRepParty_vw party"
                + "\n" + "                        WHERE party.t_id = pmd.t_payerPartyID) = 1"
                + "\n" + "                  AND CASE"
                + "\n" + "                          WHEN NOT pmd.t_payerPartyID IS NULL"
                + "\n" + "                              THEN CASE"
                + "\n" + "                                       WHEN (SELECT party.t_isPhisical"
                + "\n" + "                                               FROM dRepParty_vw party"
                + "\n" + "                                              WHERE party.t_id = pmd.t_payerPartyID) = 1"
                + "\n" + "                                           THEN 1"
                + "\n" + "                                       ELSE 0"
                + "\n" + "                                   END"
                + "\n" + "                          ELSE CASE"
                + "\n" + "                                   WHEN (SELECT pmdParty.t_type"
                + "\n" + "                                           FROM repRtlPmdParty_vw pmdParty"
                + "\n" + "                                          WHERE pmdParty.t_documentId = pmd.t_documentId) != 1"
                + "\n" + "                                       THEN 1"
                + "\n" + "                                   ELSE 0"
                + "\n" + "                               END"
                + "\n" + "                      END = 1"
                + "\n" + "              ) pmd"
                + "\n" + "      ) dataPmd"
                + "\n" + "WHERE NOT dataPmd.t_payerPartyName IS NULL"
                + "\n" + "  AND dataPmd.t_date >= rep_data.getBeginDate()"
                + "\n" + "  AND dataPmd.t_date <= rep_data.getEndDate()";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_1(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '01'";
        end;
    end;

    private class (TRtQueryBuilder_2_2_1) TRtQueryBuilder_2_2_1_1(line : String)
        initTRtQueryBuilder_2_2_1(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    private class (TRtQueryBuilder_2_2_1_1) TRtQueryBuilder_2_2_1_1_1(line : String)
        initTRtQueryBuilder_2_2_1_1(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_isInternet = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_2_1_1) TRtQueryBuilder_2_2_1_1_2(line : String)
        initTRtQueryBuilder_2_2_1_1(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_isInternet = 2";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_2(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.2", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '08'";
        end;
    end;

    /*private class (TRtQueryBuilder_2_2_2) TRtQueryBuilder_2_2_2_1(line : String)*/
        /*initTRtQueryBuilder_2_2_2(line);*/

        /*macro build()*/
            /*return build()*/
                /*+ "\n" + "  AND dataPmd.t_operationCipher = '08'";*/
        /*end;*/
    /*end;*/

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_3(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.3", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '02'";
        end;
    end;

    private class (TRtQueryBuilder_2_2_3) TRtQueryBuilder_2_2_3_1(line : String)
        initTRtQueryBuilder_2_2_3(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    private class (TRtQueryBuilder_2_2_3_1) TRtQueryBuilder_2_2_3_1_1(line : String)
        initTRtQueryBuilder_2_2_3_1(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_isInternet = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_4(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.4", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '06'";
        end;
    end;

    private class (TRtQueryBuilder_2_2_4) TRtQueryBuilder_2_2_4_1(line : String)
        initTRtQueryBuilder_2_2_4(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_5(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.5", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '07'";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_6(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '17'";
        end;
    end;

    private class (TRtQueryBuilder_2_2_6) TRtQueryBuilder_2_2_6_1(line : String)
        initTRtQueryBuilder_2_2_6(line);

        macro build()
            return build()
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_6_2(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND ((dataPmd.t_operationCipher = '17'"
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6.2", BORETAIL), "dataPmd.t_creditAccount") + "))"
                + "\n" + "  OR ("
                + "\n" + "  dataPmd.t_operationCipher = '09'"
                + "\n" + "  AND (" + convertMaskToSqlFormat("40905*,40909*-40913*", "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND (" + convertMaskToSqlFormat("70601*", "dataPmd.t_creditAccount") + ")))";
        end;
    end;

    private class (TRtQueryBuilder_2_2) TRtQueryBuilder_2_2_6_2_1(line : String)
        initTRtQueryBuilder_2_2(line);

        macro build()
            return build()
                + "\n" + "  AND ((dataPmd.t_operationCipher = '17'"
                + "\n" + "  AND dataPmd.t_paymentMode = 3"
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6.2", BORETAIL), "dataPmd.t_creditAccount") + "))"
                + "\n" + "  OR ("
                + "\n" + "  dataPmd.t_operationCipher = '09'"
                + "\n" + "  AND dataPmd.t_paymentMode = 3"
                + "\n" + "  AND (" + convertMaskToSqlFormat("40905*,40909*-40913*", "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND (" + convertMaskToSqlFormat("70601*", "dataPmd.t_creditAccount") + ")))"
        end;
    end;

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_2_2_1(    "2.2.1"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1(  "2.2.1.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1_1("2.2.1.1.1").build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1_2("2.2.1.1.2").build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_2(    "2.2.2"    ).build());
        //sql_execute(insertClause + TRtQueryBuilder_2_2_2_1(  "2.2.2.1").build());   /* note: Будет реализовано по запросу 176103 */

        sql_execute(insertClause + TRtQueryBuilder_2_2_3(    "2.2.3"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_3_1(  "2.2.3.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_3_1_1("2.2.3.1.1").build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_4(    "2.2.4"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_4_1(  "2.2.4.1"  ).build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_5(    "2.2.5"    ).build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_6(    "2.2.6"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_6_1(  "2.2.6.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_6_2(  "2.2.6.2"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_6_2_1("2.2.6.2.1").build());
    end;
end;

private class (TDataSourceRetailDocuments_2_2) TDataSourceRetailDocuments_2_2_3269()
    initTDataSourceRetailDocuments_2_2();

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_2_2_1(    "2.2.1"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1(  "2.2.1.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1_1("2.2.1.1.1").build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_1_1_2("2.2.1.1.2").build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_2(    "2.2.2"    ).build());
        //sql_execute(insertClause + TRtQueryBuilder_2_2_2_1(  "2.2.2.1").build());   /* note: Будет реализовано по запросу 176103 */

        sql_execute(insertClause + TRtQueryBuilder_2_2_3(    "2.2.3"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_3_1(  "2.2.3.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_3_1_1("2.2.3.1.1").build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_4(    "2.2.4"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_4_1(  "2.2.4.1"  ).build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_5(    "2.2.5"    ).build());

        sql_execute(insertClause + TRtQueryBuilder_2_2_6(    "2.2.6"    ).build());
        sql_execute(insertClause + TRtQueryBuilder_2_2_6_1(  "2.2.6.1"  ).build());
    end;
end;

private class (TDataSource) TDataSourceRetailTransferStatistics()
    initTDataSource(BORETAIL);

    private class (TRtQueryBuilder) TRtQueryBuilder_2_4(line : String)
        defaultParm(line, "2.4");
        initTRtQueryBuilder(line);

        m_column          = "DECODE(rts.t_currencyCode, '810', 3, 4)";
        m_roublesum       = "DECODE(rts.t_currencyCode, '810', rts.t_operationsSum, "
                          + "rsb_fiinstr.convSum(rts.t_operationsSum, (SELECT t_fiid FROM dfininstr_dbt "
                          +                                                "WHERE t_codeInAccount = rts.t_currencyCode), 0, rts.t_date))";
        m_currencySum     = "DECODE(rts.t_currencyCode, '810', 0, rts.t_operationsSum)";
        m_fiid            = "NVL((SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = rts.t_currencycode), -1)";
        m_carryDate       = "rts.t_date";

        macro build()
            return getSelectClause()
                + "\n" + "  FROM repRtlTransferStatistics_vw rts"
                + "\n" + " WHERE rts.t_isReceipts = 0"
                + "\n" + "   AND rts.t_date >= " + getSqlDate(parameters.getBeginDate())
                + "\n" + "   AND rts.t_date <= " + getSqlDate(parameters.getEndDate())
                + "\n" + "   AND " + rcbBranchFieldFilter.getAsSqlString("rts.t_branchId");
        end;
    end;

    private class (TRtQueryBuilder_2_4) TRtQueryBuilder_2_4_1(line : String)
        defaultParm(line, "2.4.1");
        initTRtQueryBuilder_2_4(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isByMoneyTransSystem = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1) TRtQueryBuilder_2_4_1_1()
        initTRtQueryBuilder_2_4("2.4.1.1");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferWithinRf = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1) TRtQueryBuilder_2_4_1_2()
        initTRtQueryBuilder_2_4("2.4.1.2");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1_2) TRtQueryBuilder_2_4_1_2_1()
        initTRtQueryBuilder_2_4("2.4.1.2.1");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isCreditRepayment = 1";
        end;
    end;


    private class (TRtQueryBuilder_2_4) TRtQueryBuilder_2_4_2(line: String)
        defaultParm(line, "2.4.2");
        initTRtQueryBuilder_2_4(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isByMoneyTransSystem = 0";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_1()
        initTRtQueryBuilder_2_4("2.4.2.1");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferWithinRf = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_2()
        initTRtQueryBuilder_2_4("2.4.2.2");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2_2) TRtQueryBuilder_2_4_2_2_1()
        initTRtQueryBuilder_2_4("2.4.2.2.1");
        macro build()
            return build()
                + "\n" + "   AND rts.t_isCreditRepayment = 1";
        end;
    end;


    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_2_4().build());

        sql_execute(insertClause + TRtQueryBuilder_2_4_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_2().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_2_1().build());

        sql_execute(insertClause + TRtQueryBuilder_2_4_2().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_2().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_2_1().build());
    end;
end;

private class (TDataSourceRetailTransferStatistics) TDataSourceRetailTransferStatistics_2926()
    initTDataSourceRetailTransferStatistics();

    private class (TRtQueryBuilder_2_4_1) TRtQueryBuilder_2_4_1_1_2_2926(line: String)
        defaultParm(line, "2.4.1.1.2");
        initTRtQueryBuilder_2_4(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 1"
                + "\n" + "   AND rts.t_isTransferWithinRf = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1_1_2_2926) TRtQueryBuilder_2_4_1_1_2_1_2926(line: String)
        defaultParm(line, "2.4.1.1.2.1");
        initTRtQueryBuilder_2_4_1_1_2_2926(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isCreditRepayment = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1) TRtQueryBuilder_2_4_1_2_2926(line: String)
        defaultParm(line, "2.4.1.2");
        initTRtQueryBuilder_2_4_1(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferWithinRf = 0";
        end;
    end;

    private class (TRtQueryBuilder_2_4_1_2_2926) TRtQueryBuilder_2_4_1_2_2_2926(line: String)
        defaultParm(line, "2.4.1.2.2");
        initTRtQueryBuilder_2_4_1_2_2926(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_1_1(line: String)
        defaultParm(line, "2.4.2.1.1");
        initTRtQueryBuilder_2_4_2(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 0"
                + "\n" + "   AND rts.t_isTransferWithinRf = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_1_2_2926(line: String)
        defaultParm(line, "2.4.2.1.2");
        initTRtQueryBuilder_2_4_2(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferForLegal = 1"
                + "\n" + "   AND rts.t_isTransferWithinRf = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2_1_2_2926) TRtQueryBuilder_2_4_2_1_2_1_2926(line: String)
        defaultParm(line, "2.4.2.1.2.1");
        initTRtQueryBuilder_2_4_2_1_2_2926(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isCreditRepayment  = 1";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_2_2926(line: String)
        defaultParm(line, "2.4.2.2");
        initTRtQueryBuilder_2_4_2(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferWithinRf = 0";
        end;
    end;

    private class (TRtQueryBuilder_2_4_2) TRtQueryBuilder_2_4_2_2_2_2926(line: String)
        defaultParm(line, "2.4.2.2.2");
        initTRtQueryBuilder_2_4_2(line);
        macro build()
            return build()
                + "\n" + "   AND rts.t_isTransferWithinRf = 0"
                + "\n" + "   AND rts.t_isTransferForLegal = 1";
        end;
    end;

    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_2_4().build());

        sql_execute(insertClause + TRtQueryBuilder_2_4_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_1_2_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_1_2_1_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_2_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_1_2_2_2926().build());
        //sql_execute(insertClause + TRtQueryBuilder_2_4_1_2_1().build());

        sql_execute(insertClause + TRtQueryBuilder_2_4_2().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_1_1().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_1_2_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_1_2_1_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_2_2926().build());
        sql_execute(insertClause + TRtQueryBuilder_2_4_2_2_2_2926().build());
        //sql_execute(insertClause + TRtQueryBuilder_2_4_2_2_1().build());
    end;
end;

/**
 * Класс раздела 3.
 */
private class (TDataSource) TDataSourceRetailDocuments_3()
    initTDataSource(BORETAIL);

    /**
     * Базовый класс для строк.
     * @param line Номер строки
     */
    private class (TRtQueryBuilder) TRtQueryBuilder_3(line : String)
        initTRtQueryBuilder(line);

        m_line = line;
        m_column          = "DECODE(dataPmd.t_debitCurrCode, 643, 3, 4)";
        m_account         = "dataPmd.t_debitAccount";
        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
            m_creditAccount = "dataPmd.t_creditAccount";
        end;
        m_roublesum       = "dataPmd.t_natCurrEquivalent";
        m_currencySum     = "dataPmd.t_natCurrEquivalent";
        m_errorKind       = ERROR_KIND_NONE;
        m_clientCode      = "dataPmd.t_payerPartyId";
        m_fiid            = "0";
        m_documentNumber  = "dataPmd.t_documentId";
        m_carryDate       = "dataPmd.t_date";
        m_documentReferenceNumber = "dataPmd.t_operationcipher";
        m_isPmd                   = 1;  /* note: Документ является расчетно-денежным (РДД). */

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return getSelectClause()
                + "\n" + " FROM"
                + "\n" + "    (SELECT pmd.t_debitCurrCode,"
                + "\n" + "            NVL(pmd.t_debitAccount, pmdAccount.t_account) as t_debitAccount,"
                + "\n" + "            DECODE(pmd.t_debitAccount, NULL, pmdAccount.t_amount, pmd.t_debitAmount) as t_debitAmount,"
                + "\n" + "            pmd.t_creditAccount,"
                + "\n" + "            pmd.t_payerPartyId,"
                + "\n" + "            pmd.t_documentId,"
                + "\n" + "            pmd.t_operationcipher,"
                + "\n" + "            pmd.t_date,"
                + "\n" + "            DECODE(pmd.t_debitAccount, NULL, pmdAccount.t_natCurrEquivalent, pmd.t_natCurrEquivalent) as t_natCurrEquivalent,"
                + "\n" + "            pmd.t_paymentMode,"
                + "\n" + "            pmd.t_isInternet,"
                + "\n" + "            pmd.t_corrAcc,"
                + "\n" + "            pmd.t_isForCredit,"
                + "\n" + "            pmd.t_isMonTrans"
                + "\n" + "       FROM repRtlPmd_vw pmd"
                + "\n" + "  LEFT JOIN repRtlPmdAccount_vw pmdAccount"
                + "\n" + "         ON pmd.t_documentId = pmdAccount.t_documentId"
                + "\n" + "      WHERE NOT pmd.t_date IS NULL"
                + "\n" + "                  AND EXISTS(SELECT 1 "
                + "\n" + "                               FROM dpmpaym_dbt pmpaym "
                + "\n" + "                              WHERE pmpaym.t_paymstatus = 32000 "
                + "\n" + "                                AND pmpaym.t_documentid = (SELECT oproper.t_documentid "
                + "\n" + "                                                             FROM doproper_dbt oproper "
                + "\n" + "                                                            WHERE oproper.t_id_operation = TO_NUMBER(pmd.t_paymentid)))"
                + "\n" + "                  AND NOT (pmd.t_payerPartyId = pmd.t_receiverPartyId AND EXISTS(SELECT 1 FROM drepourbank_tmp ourBank WHERE pmd.t_payerPartyId <> ourBank.t_partyId))"
                + "\n" + "       ) dataPmd"
                + "\n" + "WHERE 1 = 1";
        end;
    end;

    /**
     * Класс строки 3.1
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_1(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )";
        end;
    end;

    /**
     * Класс строки 3.1.1
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_1_1(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )"
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    /**
     * Класс строки 3.2
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_2(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )";
        end;
    end;

    /**
     * Класс строки 3.2.1
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_2_1(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )"
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    /**
     * Класс строки 3.3
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_3(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки 2.2.6.
         */
        macro build_2_2_6()
            return getSelectClause()
                + "\n" + " FROM (SELECT NVL((SELECT party.t_name"
                + "\n" + "                     FROM dRepParty_vw party"
                + "\n" + "                    WHERE pmd.t_payerPartyId = party.t_id"
                + "\n" + "                      AND party.t_isPhisical = 1),"
                + "\n" + "                  (SELECT pmdParty.t_name"
                + "\n" + "                     FROM repRtlPmdParty_vw pmdParty"
                + "\n" + "                    WHERE pmdParty.t_type = 2"
                + "\n" + "                      AND pmdParty.t_character = 1"
                + "\n" + "                      AND pmd.t_documentId = pmdParty.t_documentId"
                + "\n" + "                      AND rownum < 2)) as t_payerPartyName,"
                + "\n" + "              pmd.*"
                + "\n" + "         FROM repRtlPmd_vw pmd"
                + "\n" + "      ) dataPmd"
                + "\n" + "WHERE NOT dataPmd.t_payerPartyName IS NULL"
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher = '17'";
        end;

        /**
         * Расчет строки 3.3. Добавляется ограничивающее условие и выборка строки 2.2.6.
         */
        macro build()
            return build()
                + "\n" + "  AND ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08'))"
                + "\n" + "  OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "  AND dataPmd.t_isForCredit = 0"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08'))"
                + "\n" + "  OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.3.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_creditAccount") + ")"
                + "\n" + "    OR (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_creditAccount") + "))"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08'))";
        end;
    end;

    /**
     * Класс строки 3.3.1
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_3_1(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки 2.2.6.
         */
        macro build_2_2_6()
            return getSelectClause()
                + "\n" + " FROM (SELECT NVL((SELECT party.t_name"
                + "\n" + "                     FROM dRepParty_vw party"
                + "\n" + "                    WHERE pmd.t_payerPartyId = party.t_id"
                + "\n" + "                      AND party.t_isPhisical = 1),"
                + "\n" + "                  (SELECT pmdParty.t_name"
                + "\n" + "                     FROM repRtlPmdParty_vw pmdParty"
                + "\n" + "                    WHERE pmdParty.t_type = 2"
                + "\n" + "                      AND pmdParty.t_character = 1"
                + "\n" + "                      AND pmd.t_documentId = pmdParty.t_documentId"
                + "\n" + "                      AND rownum < 2)) as t_payerPartyName,"
                + "\n" + "              pmd.*"
                + "\n" + "         FROM repRtlPmd_vw pmd"
                + "\n" + "      ) dataPmd"
                + "\n" + "WHERE NOT dataPmd.t_payerPartyName IS NULL"
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.6", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND dataPmd.t_paymentMode = 3"
                + "\n" + "  AND dataPmd.t_operationCipher = '17'";
        end;

        /**
         * Расчет строки. Добавляется ограничивающее условие и выборка строки 2.2.6.
         */
        macro build()
            return build()
                + "\n" + "  AND (((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08'))"
                + "\n" + "  OR"
                + "\n" + "      (("  + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.1", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.2", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND NOT (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "  AND dataPmd.t_isForCredit = 0"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08'))"
                + "\n" + "  OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.3.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "  AND ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_creditAccount") + ")"
                + "\n" + "    OR (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_creditAccount") + "))"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')))"
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    /**
     * Класс строки 3.4
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_4(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )";
        end;
    end;

    /**
     * Класс строки 3.4.1
     * @param line Номер строки
     */
    private class (TRtQueryBuilder_3) TRtQueryBuilder_3_4_1(line : String)
        initTRtQueryBuilder_3(line);

        /**
         * Расчет строки. Добавляется ограничивающее условие.
         */
        macro build()
            return build()
                + "\n" + "  AND (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("3.4", BORETAIL), "dataPmd.t_corrAcc") + ")"
                + "\n" + "  AND dataPmd.t_operationCipher IN ('01','02','06','07','08')"
                + "\n" + "  AND"
                + "\n" + "  (   (" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.2.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      OR"
                + "\n" + "      ((" + convertMaskToSqlFormat(tuneTable.getMaskForLine("2.4.1", BORETAIL), "dataPmd.t_debitAccount") + ")"
                + "\n" + "      AND dataPmd.t_isMonTrans  = 1"
                + "\n" + "      AND dataPmd.t_isForCredit = 0)"
                + "\n" + "  )"
                + "\n" + "  AND dataPmd.t_paymentMode = 3";
        end;
    end;

    /**
     * Заполнить временную таблицу.
     * @param tempTable: TTempTable Временная таблица
     */
    macro fillTempTable(tempTable)
        var insertClause = tempTable.getInsertClause();

        sql_execute(insertClause + TRtQueryBuilder_3_1(  "3.1"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_3_1_1("3.1.1").build());
        sql_execute(insertClause + TRtQueryBuilder_3_2(  "3.2"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_3_2_1("3.2.1").build());
        sql_execute(insertClause + TRtQueryBuilder_3_3(  "3.3"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_3_3(  "3.3"  ).build_2_2_6());
        sql_execute(insertClause + TRtQueryBuilder_3_3_1("3.3.1").build());
        sql_execute(insertClause + TRtQueryBuilder_3_3_1("3.3.1").build_2_2_6());
        sql_execute(insertClause + TRtQueryBuilder_3_4(  "3.4"  ).build());
        sql_execute(insertClause + TRtQueryBuilder_3_4_1("3.4.1").build());
    end;
end;

/***************************************************************************************************
 *  Контроллеры расчета
 **************************************************************************************************/

private class TCalculator()
    private var m_tempTable = TTempTable_2926();

    macro execute()
        var year;
        DateSplit(getSqlDate(parameters.getBeginDate()), null, null, year);

        sql_execute("BEGIN"
           + "\n" + "   rsvoxprm.clearPrmMap;"
           + "\n" + "   rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(Date(1, 1, year)) + ", 'DD.MM.YYYY')));"
           + "\n" + "   rsvoxprm.setPrmVal('EndDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(parameters.getEndDate()) + ", 'DD.MM.YYYY')));"
           + "\n" + "END;"
                   );

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I3875_DATE2)
            TDataSourceRetailAccounts_3875().fillTempTable(m_tempTable);
        else
            TDataSourceRetailAccounts().fillTempTable(m_tempTable);
        end;
        TDataSourceRetailDocuments().fillTempTable(m_tempTable);
        TDataSourceRetailDocumentsInternet().fillTempTable(m_tempTable);

        sql_execute("BEGIN"
           + "\n" + "   rsvoxprm.clearPrmMap;"
           + "\n" + "   rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(parameters.getBeginDate()) + ", 'DD.MM.YYYY')));"
           + "\n" + "   rsvoxprm.setPrmVal('EndDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(parameters.getEndDate()) + ", 'DD.MM.YYYY')));"
           + "\n" + "END;"
                   );

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I3269_DATE)
            TDataSourceRetailDocuments_2_2_3269().fillTempTable(m_tempTable);
        else
            TDataSourceRetailDocuments_2_2().fillTempTable(m_tempTable);
        end;

        TDataSourceRetailDocuments_3().fillTempTable(m_tempTable);

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I2926_DATE)
            TDataSourceRetailTransferStatistics_2926().fillTempTable(m_tempTable);
        else
            TDataSourceRetailTransferStatistics().fillTempTable(m_tempTable);
        end;
    end;
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()

    var profiler = TSQLProfiler(getTxtFileName("!sqlProfileCalc_f251rt"));
    profiler.clear();
    profiler.on();

    var bo_retail = TBackOffice(BORETAIL);
    var tuneTable = RcbTuneTable("dt251_dbt");

    if   (RcbApplication().currentReport().context().period().endDate() >= RCB_I3269_DATE)
        tuneTable.setInstructionFilter(RCB_I3269_DATE);
    elif (RcbApplication().currentReport().context().period().endDate() >= RCB_I2926_DATE)
        tuneTable.setInstructionFilter(RCB_I2926_DATE);
    elif (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
        tuneTable.setInstructionFilter(RCB_I2742_DATE);
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
        tuneTable.setInstructionFilter(RCB_I2332_DATE -1);
    else
        tuneTable.setInstructionFilter(RCB_I2332_DATE);
    end;

    if (tuneTable.hasDataFor(bo_retail, "t_backOfice"))
        TCalculator().execute();
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/

main();
УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
