/*
$Name:          print_f634f.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 634. Печатная форма
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Печать формы 634. Печатная форма

  Создан: 07.08.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

import rcbimport;
import print_f634com;
import param;
import or_rep_h;
import f634PrintProtocolView;
import f634ExcelReportView;

/**
 *  Константы
 */
private const ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT = 0; // печать данных по валютам, для которых есть открытые л/с
private const ZERO_DATA_PRINT_MODE_ALL                 = 1; // печать данных по валютам, существующим в справочнике валют Главной книги
private const ZERO_DATA_PRINT_MODE_ONLY_LIMITED        = 2; // печать данных по валютам, для которых установлен лимит ОВП

/**
 *  Колонка таблицы
 */
private class TColumn(name, width, align)

    private var m_name;
    private var m_width;
    private var m_align;

    macro getName()
        return m_name;
    end;

    macro getWidth()
        return m_width;
    end;

    macro getAlign()
        return m_align;
    end;

    private macro constructor(name, width, align)
        m_name = name;
        m_width = width;
        m_align = align;
    end;

    constructor(name, width, align);

end;

/**
 *  Таблица отчета. CTableReport не устраивает
 */
private class TTableReport(offset, shadow, innerShadow)

    private var m_offset;
    private var m_shadow;
    private var m_innerShadow;

    private var m_columnList;

    private var m_width;


    macro getWidth()
        return m_width + m_columnList.size + 1;
    end;


    macro addColumn(name, width, align)

        m_columnList[m_columnList.size] = TColumn(name, width, align);

        m_width = m_width + width;

    end;


    macro getColumnList()
        return m_columnList;
    end;


    macro printString()

        macro formatValue(str, width, align)

            str = string(str);

            str = subStr(str, 1, width);

            if (str == "X")
                align = STR_ALIGN_CENTER;
            end;

            str = strAlign(str, width, align);

            return str;

        end;

        var str;

        var tokenList = TArray();

        var i;

        var parameter;

        i = 1;
        while ((i < parmCount()) and ((i - 1) < m_columnList.size))
            getParm(i, parameter);

            tokenList[tokenList.size] = formatValue(parameter, m_columnList[i-1].getWidth(), m_columnList[i-1].getAlign());

            i = i + 1;
        end;

        i = i - 1;
        while (i < m_columnList.size)
            tokenList[tokenList.size] = formatValue(" ", m_columnList[i].getWidth(), m_columnList[i].getAlign());
            i = i + 1;
        end;

        str = "";

        str = str + ternary(m_shadow, " ", "│");

        i = 0;
        while (i < tokenList.size)
            str = str + tokenList[i] + ternary(m_innerShadow, " ", "│");
            i = i + 1;
        end;

        str = subStr(str, 1, strLen(str) - 1);

        str = str + ternary(m_shadow, " ", "│");

        println(str);

    end;


    macro printFreeString(str)
        println(mkStr(" ", m_offset) + str);
    end;


    macro printSeparator()

        var i;

        var str;

        str = "";

        str = str + ternary(m_shadow, " ", "├");

        i = 0;
        while (i < m_columnList.size)
            str = str + ternary(m_innerShadow, (mkStr(" ", m_columnList[i].getWidth()) + "┼"),
                                               (mkStr("─", m_columnList[i].getWidth()) + "┼"));
            i = i + 1;
        end;

        str = subStr(str, 1, strLen(str) - 1);

        str = str + ternary(m_shadow, " ", "┤");

        println(str);

    end;


    private macro constructorTTableReport(offset, shadow, innerShadow)

        m_offset = offset;
        m_shadow = shadow;
        m_innerShadow = innerShadow;

        m_width = 0;

        m_columnList = TArray();

    end;

    constructorTTableReport(offset, shadow, innerShadow);

end;

/**
 *  Список полей структуры
 */
private class TFieldList(attributeName : String, filter : Object)

    private var m_filter;

    private var m_attributeName;

    private macro createFieldIdList()

        class TSorter()
            macro isLess(v1, v2)
                return v1.number < v2.number;
            end;
        end;

        var structureFieldIdList = TArray();

        var fieldIterator = RcbApplication().currentReport.form.attribute(OCP_DATA).structure.createFieldIterator();

        fieldIterator.setSortOrder(TSorter());

        if (m_filter != null)
            fieldIterator.setFilter(m_filter);
        end;

        fieldIterator.first();
        while (not fieldIterator.isDone())
            structureFieldIdList[structureFieldIdList.size] = fieldIterator.currentItem.id;
            fieldIterator.next();
        end;

        return structureFieldIdList;

    end;

    macro get()
        throw(TPureVirtualMethodCallException("TFieldList::get"));
    end;

    private macro constructorTFieldList(attributeName : String, filter : Object)

        m_filter = filter;

        m_attributeName = attributeName;

    end;

    constructorTFieldList(attributeName, filter);

end;

/**
 *  Список значимых полей структуры данных по ОВП
 */
private var ocpDataStructureSignificantFieldIdList = null;
private class (TFieldList) TOcpDataSignificantFieldList()

    private class TFilter()
        macro isSuitable(v)
            return (v.name != "1") and (v.name != "2") and (v.name != "12") and (v.name != "2_810") and (v.name != "Отчетная дата");
        end;
    end;

    macro get()
        return ocpDataStructureSignificantFieldIdList
    end;

    private macro constructorTOcpDataSignificantFieldList()

        initTFieldList(OCP_DATA, TFilter());

        if (ocpDataStructureSignificantFieldIdList == null)
            ocpDataStructureSignificantFieldIdList = createFieldIdList();
        end;

    end;

    constructorTOcpDataSignificantFieldList();

end;

/**
 *  Список "ин. валютных" или "металлических" полей структуры данных по ОВП
 */
private var ocpDataStructureForeignFieldIdList = null;
private class (TFieldList) TOcpDataForeignFieldList()

    private class TFilter()
        macro isSuitable(v)
            return (subStr(v.name, strLen(v.name) - 2) != "810") and
                   (v.name != "Отчетная дата")                   and
                   (v.name != "Код валюты")                      and
                   (v.name != "Сортировка")                      and
                   (v.name != "1");
        end;
    end;

    macro get()
        return ocpDataStructureForeignFieldIdList
    end;

    private macro constructorTOcpDataForeignFieldList()

        initTFieldList(OCP_DATA, TFilter());

        if (ocpDataStructureForeignFieldIdList == null)
            ocpDataStructureForeignFieldIdList = createFieldIdList();
        end;

    end;

    constructorTOcpDataForeignFieldList();

end;

/**
 *  Список "рублевых" полей структуры данных по ОВП
 */
private var ocpDataStructureEquivalentFieldIdList = null;
private class (TFieldList) TOcpDataEquivalentFieldList()

    private class TFilter()
        macro isSuitable(v)
            return (subStr(v.name, strLen(v.name) - 2) == "810");
        end;
    end;

    macro get()
        return ocpDataStructureEquivalentFieldIdList
    end;

    private macro constructorTOcpDataEquivalentFieldList()

        initTFieldList(OCP_DATA, TFilter());

        if (ocpDataStructureEquivalentFieldIdList == null)
            ocpDataStructureEquivalentFieldIdList = createFieldIdList();
        end;

    end;

    constructorTOcpDataEquivalentFieldList();

end;

/**
 *  Фильтр валют с заданным лимитом ОВП
 */
private class (TFilterByReportDate) TLimitedFiFilter(reportDate)

    macro isSuitable(v)

        return (v.fieldValue("16").exact != 0) and isSuitable(v);

    end;

    private macro constructor(reportDate)
        initTFilterByReportDate(reportDate);
    end;

    constructor(reportDate);

end;

/**
 *  Сортировка по ФИ
 */
private class TFiSorter()
    macro isLess(v1, v2)
        return (v1.fieldValue("Сортировка").exact < v2.fieldValue("Сортировка").exact);
    end;
end;

/**
 *  Класс печатной формы, базовый (шапка, подвал).
 *  После реализации унифицированной печати форм нужно будет убрать.
 *  А все нужное перенести в класс печати содержательной части формы.
 */
private class TPrintableReport(report : Object)

    private const MINIMAL_REPORT_WIDTH = 150; // 01.12.2009 ABP Было 83.

    private var m_reportWidth = MINIMAL_REPORT_WIDTH;

    private var m_report;

    private var m_printableFormName;

    private var m_zeroDataPrintMode;

    private var m_lastOutput;

    private var m_parameters;


    private macro getPeriodicityString()

        private macro getPeriodicityName(kind)
            var nameKind;

            if (kind == RCB_PK_DAY)
                nameKind = "Суточная";
            elif (kind == RCB_PK_MONTH)
                nameKind = "Месячная";
            elif (kind == RCB_PK_QUARTER)
                nameKind = "Квартальная";
            else nameKind = "Период";
            end;

            return nameKind;
        end;

        var formPeriodicityAll = arrCreate(RCB_PK_PERIOD,
                                           RCB_PK_DAY,   RCB_PK_FIVE_DAYS,  RCB_PK_WEEK,        RCB_PK_TEN_DAYS,
                                           RCB_PK_MONTH, RCB_PK_QUARTER,    RCB_PK_HALFYEAR,    RCB_PK_YEAR);
        var sizePeriod = formPeriodicityAll.size;
        var formPeriodicityName = "";
        var i = 0;

        while (i < sizePeriod)
            if (formPeriodicityAll[i] == m_report.context.period.kind)
              formPeriodicityName = getPeriodicityName(formPeriodicityAll[i]);
              i = sizePeriod;
            end;
            i = i + 1;
        end;

        return formPeriodicityName;
    end;


    macro getReportWidth()
        return m_reportWidth;
    end;

    macro switchOutput()
        if (m_lastOutput != "")
            setOutput(m_lastOutput, true);
            m_lastOutput = "";
        else
            m_lastOutput = setOutput(m_printableFormName, true);
        end;
    end;

    macro isEmpty()
        throw(TPureVirtualMethodCallException());
    end;

    macro addHeader()
        var i;

        var okato, okpo, ogrn, rnb, bik;

        var bankNameDescription = "Наименование кредитной организации (головной кредитной организации банковской (консолидированной) группы): ",
            bankName : TArray;

        var postAddressDescription = "Почтовый адрес: ",
            postAddress : TArray;

        if (isEmpty())
            m_reportWidth = MINIMAL_REPORT_WIDTH;
        end;

        okato = strAlign(Код_СОАТО, 15, STR_ALIGN_CENTER);
        okpo  = strAlign(Код_ОКПО, 9, STR_ALIGN_CENTER);
        ogrn  = strAlign(ОГРН, 24, STR_ALIGN_CENTER);
        rnb   = strAlign(РегНомерБанка, 15, STR_ALIGN_CENTER);
        bik   = strAlign({MFO_Bank}, 12, STR_ALIGN_CENTER);

        bankName = strTransferByWord({Name_Bank}, m_reportWidth - strLen(bankNameDescription), STR_ALIGN_LEFT);

        var postAddressString = TNamesZone().getLendingAgencyPostalAdress();
        postAddress = strTransferByWord(ternary((postAddressString == ""), " ", postAddressString), getReportWidth() - strLen(postAddressDescription), STR_ALIGN_LEFT);

        switchOutput();

        println();
        println(strAlign("Банковская отчетность", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌───────────────┬───────────────────────────────────────────────────────────────┐", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│      Код      │       Код кредитной организации (филиала)                     │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│   территории  ├─────────┬────────────────────────┬───────────────┬────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО   │ по ОКПО │основной государственный│регистрационный│    БИК     │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│               │         │  регистрационный номер │    номер      │            │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("├───────────────┼─────────┼────────────────────────┼───────────────┼────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│" + okato +   "│"+okpo+ "│" + ogrn +             "│" + rnb +     "│" + bik +  "│", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("└───────────────┴─────────┴────────────────────────┴───────────────┴────────────┘", m_reportWidth, STR_ALIGN_RIGHT));

        println();
        println(strAlign("ОТЧЕТ ОБ ОТКРЫТЫХ ВАЛЮТНЫХ ПОЗИЦИЯХ", m_reportWidth, STR_ALIGN_CENTER));

        println();
        println(strAlign("по состоянию на " + string((m_parameters.getEndDate() + 1):m), m_reportWidth, STR_ALIGN_CENTER));

        println();
        i = 1;
        println(strAlign(bankNameDescription + bankName[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < bankName.size)
            println(strAlign(mkStr(" ", strLen(bankNameDescription)) + bankName[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        i = 1;
        println(strAlign(postAddressDescription + postAddress[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < postAddress.size)
            println(strAlign(mkStr(" ", strLen(postAddressDescription)) + postAddress[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        println();
        println(strAlign("Код формы 0409634 ", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign(getPeriodicityString() + " ", m_reportWidth, STR_ALIGN_RIGHT));

        switchOutput();
    end;

    macro addFooter()
        switchOutput();

        var signatureZone = TSignatureZone();
        signatureZone.print(m_reportWidth);

        switchOutput();
    end;

    macro addEmptyMessage()
        switchOutput();

        println(strAlign("Нет данных", m_reportWidth, STR_ALIGN_CENTER));

        switchOutput();
    end;

    macro create()
        setOutput(setOutput(m_printableFormName), true);
    end;

    macro show()
        viewFileLog(m_printableFormName);
    end;

    macro getName()
        return m_printableFormName;
    end;

    macro getParameters()
        return m_parameters;
    end;

    macro setReportWidth(reportWidth)
        m_reportWidth = ternary(reportWidth < MINIMAL_REPORT_WIDTH, MINIMAL_REPORT_WIDTH, reportWidth);
    end;

    private macro constructorTPrintableReport(report : Object)

        m_printableFormName = getNameLog("f634part");

        m_lastOutput = "";

        m_zeroDataPrintMode = ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT;
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 634/ПЕЧАТЬ_НУЛЕВЫХ", V_INTEGER, m_zeroDataPrintMode, NULL);

        m_report = RcbApplication().currentReport;

        m_parameters = TParameters(report);

    end;

    constructorTPrintableReport(report);

end;

/**
 *  Класс печатной формы раздела
 */
private class (TPrintableReport) TPrintableForm634(report : Object)

    private var m_reportTable : TTableReport;

    private var m_capitalData : TCapitalData;

    macro isEmpty()

        var valueIterator;
        var result = true;

        var i;

        if (m_zeroDataPrintMode != ZERO_DATA_PRINT_MODE_ALL)

            valueIterator = m_report.attributeValue(OCP_DATA).createValueIterator();

        else

            result = false; // Если задана печать нулевых, то форма при любом раскладе пустой быть не может

        end;

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT)

            valueIterator.setFilter(TOpenedAccountFilter(getParameters().getEndDate()));
            valueIterator.first();

            result = valueIterator.isDone();

        end;

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_LIMITED)

            valueIterator.setFilter(TLimitedFiFilter(getParameters().getEndDate()));
            valueIterator.first();

            result = valueIterator.isDone();

        end;

        return result;

    end;

    private macro printHeader()

        switchOutput();

        println();
        println(strAlign("┌───┬──────────────────────────────┬───────────────────────────────────────────────────────────┬───────────┬───────────────────────┬───────────┬─────────────┬───────────────────────────────────┬───────────────┬───────────────┬───────────────┬───────────────┐", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│Но-│   Наименование иностранной   │     Чистые позиции в иностранных валютах и драгоценных    │Совокупная │       Совокупная      │ Открытые  │    Курсы    │         Рублевый эквивалент       │   Открытые    │    Лимиты     │  Превышение   │ Контрольные   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│мер│            валюты            │     металлах, тыс. ед. иностранной валюты или граммов     │балансовая │ внебалансовая позиция,│ валютные  │    (цены)   │      открытых валютных позиций,   │   валютные    │   открытых    │   лимитов     │  значения     │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│п/п│  (наименование драгоценного  │                      драгоценного металла                 │  позиция, │  тыс. ед. иностранной │ позиции,  │    Банка    │              тыс. руб.            │   позиции,    │   валютных    │   открытых    │   лимитов     │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │            металла)          │                                                           │  тыс. ед. │   валюты или граммов  │ тыс. ед.  │   России,   │                                   │  в процентах  │   позиций,    │   валютных    │  открытых     │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │                                                           │иностранной│  драгоценного металла │иностранной│ руб. за ед. │                                   │ от собственных│  в процентах  │   позиций,    │  валютных     │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              ├───────────┬───────────┬───────────┬───────────┬───────────┤ валюты или├───────────┬───────────┤  валюты   │ иностранной ├─────────────────┬─────────────────┤    средств    │ от собственных│ в процентах   │  позиций, в   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │ балансовая│    спот   │  срочная  │ опционная │     по    │  граммов  │    всего  │в том числе│    или    │  валюты или │     длинные     │     короткие    │  (капитала)   │    средств    │      от       │  процентах    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │ гарантиям │ драгоцен- │           │     по    │  граммов  │    грамма   │  (со знаком +)  │   (со знаком -) │               │  (капитала)   │ собственных   │     от        │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │(банковским│го металла │           │ процентам │ драгоцен- │драгоценного │                 │                 │               │               │   средств     │  собственных  │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │гарантиям),│           │           │           │   ного    │   металла   │                 │                 │               │               │  (капитала)   │   средств     │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │поручитель-│           │           │           │  металла  │             │                 │                 │               │               │               │  (капитала)   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │  ствам и  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │ аккредити-│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │    вам,   │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │в том числе│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│   │                              │           │           │           │           │  залогам  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("├───┼──────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼─────────────┼─────────────────┼─────────────────┼───────────────┼───────────────┼───────────────┼───────────────┤", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│ 1 │              2               │     3     │     4     │     5     │     6     │     7     │     8     │     9     │     10    │     11    │     12      │        13       │        14       │       15      │       16      │      17       │      18       │", m_reportWidth, STR_ALIGN_LEFT));

        switchOutput();

    end;

    private macro printFooter()

        var columnList;

        var i;

        var footer = "";

        var width;

        columnList = m_reportTable.getColumnList();

        switchOutput();

        footer = footer + "└";

        i = 0;
        width = 0;
        while (i < 10)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        footer = footer + mkStr("─", width);
        footer = footer + "┴";

        i = 10;
        width = 0;
        while (i < 12)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        footer = footer + mkStr("─", width);
        footer = footer + "┴";

        i = 12;
        while (i < 18)
            footer = footer + mkStr("─", columnList[i].getWidth());
            footer = footer + "┴";
            i = i + 1;
        end;
        footer = substr(footer, 1, strLen(footer) - 1);
        footer = footer + "┘";

        m_reportTable.printFreeString(footer);

        switchOutput();

    end;

    private macro printLine(count, value, isMetal)

        macro makeCommandString(value, fieldList, isMetal)

            var i;
            var commandString = "";
            var str;

            i = 0;
            while (i < fieldList.size)

                if (isMetal and ((fieldList[i] == "3") or (fieldList[i] == "4") or (fieldList[i] == "5") or (fieldList[i] == "6") or (fieldList[i] == "7") or
                                   (fieldList[i] == "8") or (fieldList[i] == "9") or (fieldList[i] == "10") or (fieldList[i] == "11")))

                    str = "\"" + value.fieldValue(fieldList[i]).exactAsString + "00" + "\"";
                else

                    str = "\"" + value.fieldValue(fieldList[i]).currentAsString + "\"";

                end;

                commandString = commandString + str + ",";

                i = i + 1;

            end;

            commandString = subStr(commandString, 1, strLen(commandString) - 1);

            return commandString;

        end;

        var commandString;

        switchOutput();

        commandString = "count," + makeCommandString(value, TOcpDataForeignFieldList().get(), isMetal);
        m_reportTable.printSeparator();
        execExp("m_reportTable.printString(" + commandString + ")");

        commandString = "count + \".1\"," + makeCommandString(value, TOcpDataEquivalentFieldList().get(), isMetal);
        commandString = commandString + ", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\", \"X\"";
        m_reportTable.printSeparator();
        execExp("m_reportTable.printString(" + commandString + ")");

        switchOutput();

    end;

    private macro printFiData()

        var valueIterator = m_report.attributeValue(OCP_DATA).createValueIterator();

        var value;

        var columnList;

        var footer = "";

        var i;

        var count = 0;

        valueIterator.setSortOrder(TFiSorter());

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT)
            valueIterator.setFilter(TOpenedAccountFilter(getParameters().getEndDate()));
        end;

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_LIMITED)
            valueIterator.setFilter(TLimitedFiFilter(getParameters().getEndDate()));
        end;

        valueIterator.first();

        while (not valueIterator.isDone())

            count = count + 1;

            value = valueIterator.currentItem();

            printLine(count, value, (subStr(value.fieldValue("Сортировка").exact, 1, 1) == "2") or (subStr(value.fieldValue("Сортировка").exact, 1, 1) == "3"));

            valueIterator.next();

        end;

        // 10.08.2007 ABP подвал данных по ОВП
        columnList = m_reportTable.getColumnList();

        footer = footer + "├";

        footer = footer + mkStr("─", columnList[0].getWidth());
        footer = footer + "┼";

        i = 1;
        while (i < 12)
            footer = footer + mkStr("─", columnList[i].getWidth());
            footer = footer + "┴";
            i = i + 1;
        end;
        footer = substr(footer, 1, strLen(footer) - 1);

        footer = footer + "┼";

        i = 12;
        while (i < 18)
            footer = footer + mkStr("─", columnList[i].getWidth());
            footer = footer + "┼";
            i = i + 1;
        end;
        footer = substr(footer, 1, strLen(footer) - 1);
        footer = footer + "┤";

        switchOutput();

        m_reportTable.printFreeString(footer);

        switchOutput();

        return count;

    end;

    private macro printTotals(count)

        var valueIterator = m_report.attributeValue(TOTALS_DATA).createValueIterator();

        var value;

        var columnList;

        var i;

        var line = "";

        var footer = "";

        var width;

        valueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));
        valueIterator.first();
        value = valueIterator.currentItem();

        columnList = m_reportTable.getColumnList();

        line = line + "│";

        line = line + strAlign(string(count), columnList[0].getWidth(), STR_ALIGN_CENTER);
        line = line + "│";

        i = 1;
        width = 0;
        while (i < 12)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        line = line + strAlign("Итого во всех иностранных валютах и драгоценных металлах", width, STR_ALIGN_CENTER);
        line = line + "│";

        line = line + strAlign(value.fieldValue("ДП_13").currentAsString, columnList[12].getWidth(), STR_ALIGN_RIGHT);
        line = line + "│";

        line = line + strAlign(value.fieldValue("КП_14").currentAsString, columnList[13].getWidth(), STR_ALIGN_RIGHT);
        line = line + "│";

        i = 14;
        while (i < 18)
            line = line + strAlign("X", columnList[i].getWidth(), STR_ALIGN_CENTER);
            line = line + "│";
            i = i + 1;
        end;

        footer = footer + "├";

        footer = footer + mkStr("─", columnList[0].getWidth());
        footer = footer + "┴";

        i = 1;
        width = 0;
        while (i < 10)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        footer = footer + mkStr("─", width);
        footer = footer + "┬";

        i = 10;
        width = 0;
        while (i < 12)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        footer = footer + mkStr("─", width);
        footer = footer + "┼";

        i = 12;
        while (i < 18)
            footer = footer + mkStr("─", columnList[i].getWidth());
            footer = footer + "┼";
            i = i + 1;
        end;
        footer = substr(footer, 1, strLen(footer) - 1);
        footer = footer + "┤";

        switchOutput();

        m_reportTable.printFreeString(line);
        m_reportTable.printFreeString(footer);

        switchOutput();

    end;

    private macro printCapital()

        macro makeDateStr(dateValue)
          var dateString = string(dateValue : m);

          dateString = "\"" + strSubst(subStr(dateString, 1, 2), " ", "0") + "\"" + subStr(dateString, 3);

          return dateString;
        end;

        macro makeString(v2, p11, v13, v14, v15, v16, v17, v18, columnList)
            var i;

            var line = "";

            var width;

            line = line + "│";

            i = 0;
            width = 0;
            while (i < 10)
                width = width + columnList[i].getWidth() + 1;
                i = i + 1;
            end;
            width = width - 1;
            line = line + strAlign(v2, width, STR_ALIGN_CENTER);
            line = line + "│";

            i = 10;
            width = 0;
            while (i < 12)
                width = width + columnList[i].getWidth() + 1;
                i = i + 1;
            end;
            width = width - 1;
            line = line + strAlign(p11, width, STR_ALIGN_CENTER);
            line = line + "│";

            line = line + strAlign(v13, columnList[12].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            line = line + strAlign(v14, columnList[13].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            line = line + strAlign(v15, columnList[14].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            line = line + strAlign(v16, columnList[15].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            line = line + strAlign(v17, columnList[16].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            line = line + strAlign(v18, columnList[17].getWidth(), STR_ALIGN_RIGHT);
            line = line + "│";

            return line;
        end;

        var valueIterator = m_report.attributeValue(TOTALS_DATA).createValueIterator();

        var value;

        var columnList;

        var i;

        var line = "";

        var footer = "";

        var width;

        var capitalString;

        valueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));
        valueIterator.first();
        value = valueIterator.currentItem();

        columnList = m_reportTable.getColumnList();

        switchOutput();

        capitalString = "";
        line = makeString(capitalString, "Балансирующая позиция", ternary(value.fieldValue("ДБП_13").exact != 0, value.fieldValue("ДБП_13").currentAsString, ""),
                                                                  ternary(value.fieldValue("КБП_14").exact != 0, value.fieldValue("КБП_14").currentAsString, ""),
                                                                  value.fieldValue("БОВП_15").exactAsString,
                                                                  value.fieldValue("ЛимБОВП_16").exactAsString,
                                                                  value.fieldValue("ПрЛОВПБ_17").exactAsString,
                                                                  value.fieldValue("КОВПБ_18").exactAsString,
                          columnList);
        m_reportTable.printFreeString(line);

        capitalString = "Собственные средства (капитал) на " + makeDateStr(m_capitalData.getDate());
        line = makeString(capitalString, "в рублях, тыс. руб.", "", "", "", "", "", "", columnList);
        m_reportTable.printFreeString(line);

        line = "│";

        i = 0;
        width = 0;
        while (i < 10)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        line = line + mkStr(" ", width);
        line = line + "├";

        i = 10;
        width = 0;
        while (i < 12)
            width = width + columnList[i].getWidth() + 1;
            i = i + 1;
        end;
        width = width - 1;
        line = line + mkStr("─", width);
        line = line + "┼";

        i = 12;
        while (i < 18)
            line = line + mkStr("─", columnList[i].getWidth());
            line = line + "┼";
            i = i + 1;
        end;
        line = substr(line, 1, strLen(line) - 1);
        line = line + "┤";

        m_reportTable.printFreeString(line);

        capitalString = "составляют: " + substr(m_capitalData.getValue().exactAsString, 1, index(m_capitalData.getValue().exactAsString, ".") - 1) + " тыс. руб";
        line = makeString(capitalString, "Сумма открытых валютных", value.fieldValue("ДОВП_13").currentAsString,
                                                                    value.fieldValue("КОВП_14").currentAsString,
                                                                    value.fieldValue("СумОВП_15").exactAsString,
                                                                    value.fieldValue("ЛимСОВП_16").exactAsString,
                                                                    value.fieldValue("ПрЛОВПСум_17").exactAsString,
                                                                    value.fieldValue("КОВПСум_18").exactAsString,
                          columnList);
        m_reportTable.printFreeString(line);

        capitalString = "";
        line = makeString(capitalString, "позиций, тыс. руб.", "", "", "", "", "", "", columnList);
        m_reportTable.printFreeString(line);

        switchOutput();

    end;

    macro printDeals()

        var needFooter = true;

        var dealTable;

        var dealList = m_report.attributeValue(DEALS_DATA).createValueIterator();

        dealList.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        dealList.first();

        dealTable = CTableReport(0, false, dealList.isDone());

        dealTable.addColumn("Наименование финансового инструмента", 25, AL_LEFT);
        dealTable.addColumn("Стоимость сделки, тыс. руб", 18, AL_RIGHT);

        switchOutput();

        dealTable.printFreeString("");
        dealTable.printHead("Справочно:");

        if (dealList.isDone())
            println(strAlign("Нет данных", dealTable.getSumLen(), STR_ALIGN_CENTER));
            needFooter = false;
        end;

        while (not dealList.isDone())
            dealTable.printString(dealList.currentItem.fieldValue("Наименование ФИ").currentAsString,
                                  dealList.currentItem.fieldValue("Стоимость сделки").currentAsString);
            dealList.next();
        end;

        if (needFooter)
            dealTable.printBottom();
        end;

        switchOutput();

    end;

    macro print()

        var count;

        addHeader();

        if (not isEmpty())

            printHeader();

            count = printFiData();

            printTotals(count + 1);

            printCapital();

            printFooter();

            printDeals();

        else

            addEmptyMessage();

        end;

        addFooter();

    end;

    private macro initializeReportTable()

        m_reportTable = TTableReport(0, false, false);

        m_reportTable.addColumn(1,  03, STR_ALIGN_CENTER);
        m_reportTable.addColumn(2,  30, STR_ALIGN_LEFT  );
        m_reportTable.addColumn(3,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(4,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(5,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(6,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(7,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(8,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(9,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(10, 11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(11, 11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(12, 13, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(13, 17, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(14, 17, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(15, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(16, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(17, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(18, 15, STR_ALIGN_RIGHT );

    end;

    private macro constructorTPrintableForm634(report : Object)

        initTPrintableReport(report);

        initializeReportTable();

        setReportWidth(m_reportTable.getWidth());

        m_capitalData = TCapitalData(report);

    end;

    constructorTPrintableForm634(report);

end;

/**
 *  Класс печатной формы раздела по 2332У
 */
private class (TPrintableForm634) TPrintableForm634_2332U(report : Object)

    private var bankNameDescription = "Сокращенное фирменное наименование кредитной организации (головной кредитной организации банковской (консолидированной) группы): ";

    private macro initializeReportTable()

        m_reportTable = TTableReport(0, false, false);

        m_reportTable.addColumn(1,  06, STR_ALIGN_CENTER);
        m_reportTable.addColumn(2,  30, STR_ALIGN_LEFT  );
        m_reportTable.addColumn(3,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(4,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(5,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(6,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(7,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(8,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(9,  11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(10, 11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(11, 11, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(12, 13, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(13, 17, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(14, 17, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(15, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(16, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(17, 15, STR_ALIGN_RIGHT );
        m_reportTable.addColumn(18, 15, STR_ALIGN_RIGHT );

    end;

    macro addHeader()
        var i;

        var okato, okpo, ogrn, rnb, bik;

        var bankName : TArray;

        var postAddressDescription = "Почтовый адрес: ",
            postAddress : TArray;

        if (isEmpty())
            m_reportWidth = MINIMAL_REPORT_WIDTH;
        end;

        okato = strAlign(TLendingAgencyCodeZone().getOkato(), 15, STR_ALIGN_CENTER);
        okpo  = strAlign(Код_ОКПО, 9, STR_ALIGN_CENTER);
        ogrn  = strAlign(ОГРН, 24, STR_ALIGN_CENTER);
        rnb   = strAlign(РегНомерБанка, 15, STR_ALIGN_CENTER);
        bik   = strAlign({MFO_Bank}, 12, STR_ALIGN_CENTER);

        bankName = strTransferByWord(TZone().party.rec.shortname, m_reportWidth - strLen(bankNameDescription), STR_ALIGN_LEFT);

        var postAddressString = TNamesZone().getLendingAgencyPostalAdress();
        postAddress = strTransferByWord(ternary((postAddressString == ""), " ", postAddressString), getReportWidth() - strLen(postAddressDescription), STR_ALIGN_LEFT);

        switchOutput();

        println();
        println(strAlign("Банковская отчетность", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌───────────────┬───────────────────────────────────────────────────────────────┐", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│      Код      │       Код кредитной организации (филиала)                     │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│   территории  ├─────────┬────────────────────────┬───────────────┬────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО   │ по ОКПО │основной государственный│регистрационный│    БИК     │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│               │         │  регистрационный номер │    номер      │            │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("├───────────────┼─────────┼────────────────────────┼───────────────┼────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│" + okato +   "│"+okpo+ "│" + ogrn +             "│" + rnb +     "│" + bik +  "│", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("└───────────────┴─────────┴────────────────────────┴───────────────┴────────────┘", m_reportWidth, STR_ALIGN_RIGHT));

        println();
        println(strAlign("ОТЧЕТ ОБ ОТКРЫТЫХ ВАЛЮТНЫХ ПОЗИЦИЯХ", m_reportWidth, STR_ALIGN_CENTER));

        println();
        println(strAlign("по состоянию на " + string((m_parameters.getEndDate() + 1):m), m_reportWidth, STR_ALIGN_CENTER));

        println();
        i = 1;
        println(strAlign(bankNameDescription + bankName[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < bankName.size)
            println(strAlign(mkStr(" ", strLen(bankNameDescription)) + bankName[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        i = 1;
        println(strAlign(postAddressDescription + postAddress[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < postAddress.size)
            println(strAlign(mkStr(" ", strLen(postAddressDescription)) + postAddress[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        println();
        println(strAlign("Код формы по ОКУД 0409634 ", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign(getPeriodicityString() + " ", m_reportWidth, STR_ALIGN_RIGHT));

        switchOutput();
    end;

    private macro printHeader()

        switchOutput();

        println();
        println(strAlign("┌──────┬──────────────────────────────┬───────────────────────────────────────────────────────────┬───────────┬───────────────────────┬───────────┬─────────────┬───────────────────────────────────┬───────────────┬───────────────┬───────────────┬───────────────┐", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│Номер │   Наименование иностранной   │    Чистые позиции в иностранных валютах и драгоценных     │Совокупная │       Совокупная      │ Открытые  │    Курсы    │         Рублевый эквивалент       │   Открытые    │    Лимиты     │  Превышение   │  Контрольные  │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│строки│            валюты            │     металлах, тыс. ед. иностранной валюты или граммов     │балансовая │ внебалансовая позиция,│ валютные  │  (учетные   │      открытых валютных позиций,   │   валютные    │   открытых    │   лимитов     │   значения    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │  (наименование драгоценного  │                   драгоценного металла                    │  позиция, │  тыс. ед. иностранной │ позиции,  │    цены)    │              тыс. руб.            │   позиции,    │   валютных    │   открытых    │    лимитов    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │            металла)          │                                                           │  тыс. ед. │   валюты или граммов  │ тыс. ед.  │Банка России,│                                   │  в процентах  │   позиций,    │   валютных    │   открытых    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │                                                           │иностранной│  драгоценного металла │иностранной│ руб. за ед. │                                   │ от собственных│  в процентах  │   позиций,    │   валютных    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              ├───────────┬───────────┬───────────┬───────────┬───────────┤ валюты или├───────────┬───────────┤  валюты   │ иностранной ├─────────────────┬─────────────────┤    средств    │ от собственных│ в процентах   │  позиций, в   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │балансовая │  \"спот\"   │  срочная  │ опционная │    по     │  граммов  │   всего   │в том числе│    или    │ валюты или  │     длинные     │     короткие    │  (капитала)   │    средств    │      от       │   процентах   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │ гарантиям │ драгоцен- │           │    по     │  граммов  │    грамм    │  (со знаком +)  │   (со знаком -) │               │  (капитала)   │ собственных   │      от       │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │(банковским│го металла │           │ процентам │ драгоцен- │драгоценного │                 │                 │               │               │   средств     │  собственных  │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │гарантиям),│           │           │           │   ного    │   металла   │                 │                 │               │               │  (капитала)   │    средств    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │поручитель-│           │           │           │  металла  │             │                 │                 │               │               │               │  (капитала)   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │  ствам и  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │ аккредити-│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │    вам,   │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │в том числе│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │  залогам  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("├──────┼──────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼─────────────┼─────────────────┼─────────────────┼───────────────┼───────────────┼───────────────┼───────────────┤", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│  1   │              2               │     3     │     4     │     5     │     6     │     7     │     8     │     9     │     10    │     11    │     12      │        13       │        14       │       15      │       16      │      17       │      18       │", m_reportWidth, STR_ALIGN_LEFT));

        switchOutput();

    end;

    private macro constructorTPrintableForm634_2332U(report : Object)

        initTPrintableForm634(report);

    end;

    constructorTPrintableForm634_2332U(report);
end;

/**
 *  Класс печатной формы раздела по 2851-У
 */
private class (TPrintableForm634_2332U) TPrintableForm634_2851U(report : Object)
    private var postAddressDescription;

    macro addHeader()
        var i;
        var okato, okpo, ogrn, rnb, bik;
        var bankName : TArray;
        var postAddress : TArray;
        var _date;

        if (isEmpty())
            m_reportWidth = MINIMAL_REPORT_WIDTH;
        end;

        okato = strAlign(TLendingAgencyCodeZone().getOkato(), 16, STR_ALIGN_CENTER);
        okpo  = strAlign(Код_ОКПО, 16, STR_ALIGN_CENTER);
        rnb   = strAlign(РегНомерБанка, 23, STR_ALIGN_CENTER);

        bankName = strTransferByWord(TZone().party.rec.shortname, m_reportWidth - strLen(bankNameDescription), STR_ALIGN_LEFT);

        var postAddressString = TNamesZone().getLendingAgencyPostalAdress();
        postAddress = strTransferByWord(ternary((postAddressString == ""), " ", postAddressString), getReportWidth() - strLen(postAddressDescription), STR_ALIGN_LEFT);

        switchOutput();

        println();
        println(strAlign("Банковская отчетность", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌────────────────┬────────────────────────────────────────┐", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│ Код территории │   Код кредитной организации (филиала)  │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО    ├────────────────┬───────────────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│                │    по ОКПО     │ регистрационный номер │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│                │                │  (/порядковый номер)  │", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("├────────────────┼────────────────┼───────────────────────┤", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("│"+ okato +     "│"+ okpo +      "│" + rnb +             "│", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign("└────────────────┴────────────────┴───────────────────────┘", m_reportWidth, STR_ALIGN_RIGHT));

        println();
        println(strAlign("ОТЧЕТ ОБ ОТКРЫТЫХ ВАЛЮТНЫХ ПОЗИЦИЯХ", m_reportWidth, STR_ALIGN_CENTER));

        println();
        _date = string((m_parameters.getEndDate() + 1):m:f);
        _date = "\"" + SubStr(_date, 1, 2) + "\"" + SubStr(_date, 3);
        println(strAlign("по состоянию на " + _date, m_reportWidth, STR_ALIGN_CENTER));

        println();
        i = 1;
        println(strAlign(bankNameDescription + bankName[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < bankName.size)
            println(strAlign(mkStr(" ", strLen(bankNameDescription)) + bankName[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        i = 1;
        println(strAlign(postAddressDescription + postAddress[0], m_reportWidth, STR_ALIGN_LEFT));
        while (i < postAddress.size)
            println(strAlign(mkStr(" ", strLen(postAddressDescription)) + postAddress[i], m_reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        println();
        println(strAlign("Код формы по ОКУД 0409634 ", m_reportWidth, STR_ALIGN_RIGHT));
        println(strAlign(getPeriodicityString() + " ", m_reportWidth, STR_ALIGN_RIGHT));

        switchOutput();
    end;

    private macro constructorTPrintableForm634_2851U(report : Object)
        initTPrintableForm634_2332U(report);

        postAddressDescription = "Почтовый адрес: "
    end;

    constructorTPrintableForm634_2851U(report);
end;

/**
 *  Класс печатной формы раздела по 3093-У
 */
private class (TPrintableForm634_2851U) TPrintableForm634_3093U(report : Object)
    initTPrintableForm634_2851U(report);

    bankNameDescription = "Сокращенное фирменное наименование кредитной организации (головной кредитной организации банковской группы): ";
end;

private class (TPrintableForm634_3093U) TPrintableForm634_3468(report : Object)
    initTPrintableForm634_3093U(report);

    m_capitalData = TCapitalData_3468(report);
end;

private class (TPrintableForm634_3468) TPrintableForm634_4212(report : Object)
    initTPrintableForm634_3468(report);

    postAddressDescription = "Адрес (место нахождения) кредитной организации (головной кредитной организации банковской группы) ";
    bankNameDescription    = "Полное или сокращенное фирменное наименование кредитной организации (головной кредитной организации банковской группы) ";
end;

private class (TPrintableForm634_4212) TPrintableForm634_4927(report : Object)
    initTPrintableForm634_4212(report);

    private macro printHeader()

        switchOutput();

        println();
        println(strAlign("┌──────┬──────────────────────────────┬───────────────────────────────────────────────────────────┬───────────┬───────────────────────┬───────────┬─────────────┬───────────────────────────────────┬───────────────┬───────────────┬───────────────┬───────────────┐", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│Номер │   Наименование иностранной   │    Чистые позиции в иностранных валютах и драгоценных     │Совокупная │       Совокупная      │ Открытые  │    Курсы    │         Рублевый эквивалент       │   Открытые    │    Лимиты     │  Превышение   │  Контрольные  │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│строки│            валюты            │     металлах, тыс. ед. иностранной валюты или граммов     │балансовая │ внебалансовая позиция,│ валютные  │  (учетные   │      открытых валютных позиций,   │   валютные    │   открытых    │   лимитов     │   значения    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │     (драгоценного металла)   │                   драгоценного металла                    │  позиция, │  тыс. ед. иностранной │ позиции,  │    цены)    │              тыс. руб.            │   позиции,    │   валютных    │   открытых    │    лимитов    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │                                                           │  тыс. ед. │   валюты или граммов  │ тыс. ед.  │Банка России,│                                   │  в процентах  │   позиций,    │   валютных    │   открытых    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │                                                           │иностранной│  драгоценного металла │иностранной│ руб. за ед. │                                   │ от собственных│  в процентах  │   позиций,    │   валютных    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              ├───────────┬───────────┬───────────┬───────────┬───────────┤ валюты или├───────────┬───────────┤  валюты   │ иностранной ├─────────────────┬─────────────────┤    средств    │ от собственных│ в процентах   │  позиций, в   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │балансовая │  \"спот\"   │  срочная  │ опционная │    по     │  граммов  │   всего   │в том числе│    или    │ валюты или  │     длинные     │     короткие    │  (капитала)   │    средств    │      от       │   процентах   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │ гарантиям │ драгоцен- │           │    по     │  граммов  │    грамм    │  (со знаком +)  │   (со знаком -) │               │  (капитала)   │ собственных   │      от       │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │(банковским│го металла │           │ процентам │ драгоцен- │драгоценного │                 │                 │               │               │   средств     │  собственных  │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │гарантиям),│           │           │           │   ного    │   металла   │                 │                 │               │               │  (капитала)   │    средств    │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │поручитель-│           │           │           │  металла  │             │                 │                 │               │               │               │  (капитала)   │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │  ствам и  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │ аккредити-│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │    вам,   │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │в том числе│           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│      │                              │           │           │           │           │  залогам  │           │           │           │           │             │                 │                 │               │               │               │               │", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("├──────┼──────────────────────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼─────────────┼─────────────────┼─────────────────┼───────────────┼───────────────┼───────────────┼───────────────┤", m_reportWidth, STR_ALIGN_LEFT));
        println(strAlign("│  1   │              2               │     3     │     4     │     5     │     6     │     7     │     8     │     9     │     10    │     11    │     12      │        13       │        14       │       15      │       16      │      17       │      18       │", m_reportWidth, STR_ALIGN_LEFT));

        switchOutput();
    end;
end;

/**
 *  Основная функция
 */
macro printReport(showReport : bool) : String
    defaultParm(showReport, true);
    var currentReport = RcbApplication().currentReport;
    var report;
    var context;
    var period;
    var dateIncrement;
    var beginDate;
    var endDate;

    var printableForm;

    var printerController = TPrinterController("f634form");

    var isOperationDaysListUsed = false; // Признак использования переменной "СписокОперационныхДней"

    printerController.create();

    var parameters = TParameters(currentReport);

    if (currentReport.context.period.endDate >= RCB_I3468_DATE)
        if ((currentReport.context.period.kind == RCB_PK_MONTH) and parameters.isEveryDay())
            dateIncrement = 1;
            isOperationDaysListUsed = true;
        else
            dateIncrement = currentReport.context.period.endDate - currentReport.context.period.beginDate + 1;
            isOperationDaysListUsed = false;
        end;
    else
        if (currentReport.context.period.kind == RCB_PK_TEN_DAYS)
            dateIncrement = 1;
            isOperationDaysListUsed = false;
        else
            dateIncrement = currentReport.context.period.endDate - currentReport.context.period.beginDate + 1;
            isOperationDaysListUsed = false;
        end;
    end;

    beginDate = currentReport.context.period.beginDate;
    while (beginDate <=  currentReport.context.period.endDate)
        endDate = beginDate + dateIncrement - 1;

        if (   (isOperationDaysListUsed and global.inListOperationDay(endDate))
            or not isOperationDaysListUsed
           )
            context = currentReport.context;
            period = RcbPeriod(beginDate, endDate);
            context = RcbReportContext(period, context.departmentCode, context.issueMode, context.organizationStructure, context.isSummaryMode);
            report = RcbApplication().objectFactory().createReport("Форма 634", context);

            if   (endDate >= RCB_I4927_DATE)
                printableForm = TPrintableForm634_4927(report);
            elif (endDate >= RCB_I4212_DATE)
                printableForm = TPrintableForm634_4212(report);
            elif (endDate >= RCB_I3468_DATE)
                printableForm = TPrintableForm634_3468(report);
            elif (endDate >= RCB_I3093_DATE)
                printableForm = TPrintableForm634_3093U(report);
            elif (endDate >= RCB_I2851_DATE)
                printableForm = TPrintableForm634_2851U(report);
            // elif (endDate >= RCB_I2332_DATE)
                // printableForm = TPrintableForm634_2332U(report);
            else
                printableForm = TPrintableForm634(report);
            end;

            printableForm.create();

            printableForm.print();

            printerController.add(printableForm.getName());
        end;

        beginDate = beginDate + dateIncrement;
    end;

    if (showReport)
        printerController.show();
    end;

    return printerController.getReportFileName();

    onError(error)
        exceptionMessage(error);
        exit(1);
end;

/**
 * CMakeReport с перегруженными методми
 *     GetRegim_LoadNewApplication - для перекрытия настройки BANK_INI\WINDOWS REPORT\LOADNEWAPPLICATION
 *
 * @since 22.02.2019
 * @version 6.20.031.054
 */
private class (CMakeReport) TMakeReport(_HeaderStr:string, _SepStr:string, _CountStrOnPage:integer, _CurStr:integer)
    initCMakeReport(_HeaderStr, _SepStr, _CountStrOnPage, _CurStr);

    private macro GetRegim_LoadNewApplication()
        return false;
    end;
end;

/**
 * Печатное представление Excel
 *
 * @since 26.02.2019
 * @version 6.20.031.055
 */
class TF634ExcelView(txtReportFileName : String, coefficent : Double)
    private var m_printEngine : TMakeReport;
    private var m_txtReportFileName : String;

    macro print()
        var outstream = TStreamDoc(m_txtReportFileName, "R");
        var str = "";
        var length = 0;

        while (outstream.readLine(str))
            var tmp = strlen(str);
            if (tmp > length)
                length = tmp;
            end;
        end;

        var i = 0;

        str = "";
        outstream = TStreamDoc(m_txtReportFileName, "R");

        while (outstream.readLine())
            i = i + 1;
            var line = outstream.str;
            if (line == "")
                line = mkstr(" ", length);
            end;

            str = str + "\n" + line;
        end;

        str = substr(str, 2);

        m_printEngine.autoscan("["+str+"]");
        m_printEngine.printWinRep();
    end;

    macro show()
        m_printEngine.showWinRep();
    end;

    private macro constructorTF634ExcelView(txtReportFileName : String, coefficent : Double)
        m_printEngine = TMakeReport("", SEP_DEFAULT, 100000);
        m_printEngine.setWinRepOutput(WINREP_OUTPUT_EXCEL, WINREP_FORMAT_XLSX);
        m_printEngine.setFlagShowIndicator(false);
        m_printEngine.setFlagShowGrid(false);
        m_printEngine.setFont("Courier New", 10, coefficent);

        var ext : String;
        splitFile(txtReportFileName, m_txtReportFileName, ext);
        m_printEngine.setFileNameWin(m_txtReportFileName);
        m_txtReportFileName = m_txtReportFileName + ext;
    end;

    constructorTF634ExcelView(txtReportFileName, coefficent);
end;


/**
 * Контроллер печати в Excel
 *
 * @since 28.06.2019
 * @version 6.20.031.058
 */
class TF634ExcelReportPrintController(reportView, report)
	private var m_view ; 
	private var m_report;
	private var m_parameters;
	private var m_capitalData;
	private var m_zeroDataPrintMode;
	
	macro getParameters()
        return m_parameters;
    end;
	
	private macro printLine(count, value, isMetal)
		macro makeCommandString(value, fieldList, isMetal, rowArray)
            var i;
            i = 0;
            while (i < fieldList.size)

                if (isMetal and ((fieldList[i] == "3") or (fieldList[i] == "4") or (fieldList[i] == "5") or (fieldList[i] == "6") or (fieldList[i] == "7") or
                                   (fieldList[i] == "8") or (fieldList[i] == "9") or (fieldList[i] == "10") or (fieldList[i] == "11")))
                    rowArray[rowArray.size] = value.fieldValue(fieldList[i]).exactAsString + "00";
                else

                    rowArray[rowArray.size] = value.fieldValue(fieldList[i]).currentAsString;

                end;
                i = i + 1;
            end;
        end;
		
		var row = RcbArray();
		row[row.size] = count;
        makeCommandString(value, TOcpDataForeignFieldList().get(), isMetal, row);
		m_view.getPartView(0).printRow(row);

		row = RcbArray();
		row[row.size] = count + ".1";
        makeCommandString(value, TOcpDataEquivalentFieldList().get(), isMetal, row);
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
		row[row.size] = "X";
        m_view.getPartView(0).printRow(row);
    end;

    private macro printFiData()

        var valueIterator = m_report.attributeValue(OCP_DATA).createValueIterator();

        var value;

        var count = 0;

        valueIterator.setSortOrder(TFiSorter());

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT)
            valueIterator.setFilter(TOpenedAccountFilter(getParameters().getEndDate()));
        end;

        if (m_zeroDataPrintMode == ZERO_DATA_PRINT_MODE_ONLY_LIMITED)
            valueIterator.setFilter(TLimitedFiFilter(getParameters().getEndDate()));
        end;

        valueIterator.first();

        while (not valueIterator.isDone())

            count = count + 1;

            value = valueIterator.currentItem();
			
			if (value == null)
				m_view.getProtocolView().printLine("Переменная не найдена для строки " + count + " за " + (getParameters().getEndDate() + 1));
			else
			    printLine(count, value, (subStr(value.fieldValue("Сортировка").exact, 1, 1) == "2") or (subStr(value.fieldValue("Сортировка").exact, 1, 1) == "3"));
			end;

            valueIterator.next();

        end;

		return count;
    end;
	
	private macro printTotals(count)

        var valueIterator = m_report.attributeValue(TOTALS_DATA).createValueIterator();

        var value;
		
		var row = RcbArray();
		
        valueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));
        valueIterator.first();
        value = valueIterator.currentItem();

		if (value == null)
			m_view.getProtocolView().printLine("Переменная не найдена для строки Итого за " + (getParameters().getEndDate() + 1));
		else
		    row[row.size] = count;
			row[row.size] = "Итого во всех иностранных валютах и драгоценных металлах";
			row[row.size] = value.fieldValue("ДП_13").currentAsString;
			row[row.size] = value.fieldValue("КП_14").currentAsString;
			row[row.size] = "X";
			row[row.size] = "X";
			row[row.size] = "X";
			row[row.size] = "X";
			m_view.getPartView(0).printTotalRow(row);
		end;
        
    end;
	
	private macro printCapital()

        macro makeDateStr(dateValue)
          var dateString = string(dateValue : m);

          dateString = "\\\"" + strSubst(subStr(dateString, 1, 2), " ", "0") + "\\\"" + subStr(dateString, 3);

          return dateString;
        end;
        
		var valueIterator = m_report.attributeValue(TOTALS_DATA).createValueIterator();

        var value;

        valueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));
        valueIterator.first();
        value = valueIterator.currentItem();
		
		if (value == null)
			m_view.getProtocolView().printLine("Переменная не найдена для строки \"Собственные средства (капитал)\" за " + (getParameters().getEndDate() + 1));
		else
			var row = RcbArray();
			row[row.size] = "Собственные средства (капитал) на " + makeDateStr(m_capitalData.getDate()) +
		                "составляют: " + substr(m_capitalData.getValue().exactAsString, 1, index(m_capitalData.getValue().exactAsString, ".") - 1) + " тыс. руб";
			row[row.size] = "Балансирующая позиция в рублях, тыс. руб.";
			row[row.size] = ternary(value.fieldValue("ДБП_13").exact != 0, value.fieldValue("ДБП_13").currentAsString, "");
			row[row.size] = ternary(value.fieldValue("КБП_14").exact != 0, value.fieldValue("КБП_14").currentAsString, "");
			row[row.size] = value.fieldValue("БОВП_15").exactAsString;
			row[row.size] = value.fieldValue("ЛимБОВП_16").exactAsString;
			row[row.size] = value.fieldValue("ПрЛОВПБ_17").exactAsString;
			row[row.size] = value.fieldValue("КОВПБ_18").exactAsString;
		
			m_view.getPartView(0).printCapitalRow(row, true);

			row = RcbArray();
			row[row.size] = "";
			row[row.size] = "Сумма открытых валютных позиций, тыс. руб.";
			row[row.size] =  value.fieldValue("ДОВП_13").currentAsString;
			row[row.size] =  value.fieldValue("КОВП_14").currentAsString;
			row[row.size] =  value.fieldValue("СумОВП_15").exactAsString;
			row[row.size] =  value.fieldValue("ЛимСОВП_16").exactAsString;
			row[row.size] =  value.fieldValue("ПрЛОВПСум_17").exactAsString;
			row[row.size] =  value.fieldValue("КОВПСум_18").exactAsString;
		
			m_view.getPartView(0).printCapitalRow(row, false);
		end;
		
    end;
	
	macro printDeals()
        var dealList = m_report.attributeValue(DEALS_DATA).createValueIterator();
        dealList.setFilter(TFilterByReportDate(getParameters().getEndDate()));
        dealList.first();
				
        if (dealList.isDone())
            m_view.getPartView(1).printRow();
        end;
		
        var row;
        while (not dealList.isDone())
			row = RcbArray();
			row[row.size] = dealList.currentItem.fieldValue("Наименование ФИ").currentAsString;
			row[row.size] = dealList.currentItem.fieldValue("Стоимость сделки").currentAsString;
            m_view.getPartView(1).printRow(row);
            dealList.next();
        end;
    end;
	
	macro print()
		
		m_view.getPartView(0).printHead();
		m_view.getPartView(0).printSignature();
		
		var count = printFiData();
		printTotals(count + 1);
		printCapital();
		m_view.getPartView(0).print();
		
		printDeals();
		m_view.getPartView(1).print();
	end;
	
	macro show()
		m_view.show()
	end;
	
	macro constructorTF634ExcelReportPrintController(reportView, report)
		m_view              = reportView; 
		m_report            = RcbApplication().currentReport;
		m_parameters        = TParameters(report);
		m_capitalData       = TCapitalData_3468(report);
		m_zeroDataPrintMode = ZERO_DATA_PRINT_MODE_ONLY_OPENED_ACCOUNT;
	end;
	constructorTF634ExcelReportPrintController(reportView, report);
end;

//Печать отчета в Excel
macro printReportExcel()
	if   (RcbApplication().currentReport.context.period.endDate >= RCB_I4927_DATE)
		var currentReport = RcbApplication().currentReport;
		var report;
		var context;
		var period;
		var dateIncrement;
		var beginDate;
		var endDate;
		var printController;
		var isOperationDaysListUsed = false; // Признак использования переменной "СписокОперационныхДней"

		var parameters = TParameters(currentReport);

		if (currentReport.context.period.endDate >= RCB_I3468_DATE)
			if ((currentReport.context.period.kind == RCB_PK_MONTH) and parameters.isEveryDay())
				dateIncrement = 1;
				isOperationDaysListUsed = true;
			else
				dateIncrement = currentReport.context.period.endDate - currentReport.context.period.beginDate + 1;
				isOperationDaysListUsed = false;
			end;
		else
			if (currentReport.context.period.kind == RCB_PK_TEN_DAYS)
				dateIncrement = 1;
				isOperationDaysListUsed = false;
			else
				dateIncrement = currentReport.context.period.endDate - currentReport.context.period.beginDate + 1;
				isOperationDaysListUsed = false;
			end;
		end;

		beginDate = currentReport.context.period.beginDate;
		while (beginDate <=  currentReport.context.period.endDate)
			endDate = beginDate + dateIncrement - 1;

			if (   (isOperationDaysListUsed and global.inListOperationDay(endDate))
				or not isOperationDaysListUsed
			)
				context = currentReport.context;
				period  = RcbPeriod(beginDate, endDate);
				context = RcbReportContext(period, context.departmentCode, context.issueMode, context.organizationStructure, context.isSummaryMode);
				report  = RcbApplication().objectFactory().createReport("Форма 634", context);

				printController = TF634ExcelReportPrintController(TF634ReportExcelView(TF634PrintProtocolView(), report), report);
				
				printController.print();
		        printController.show();
			end;

			beginDate = beginDate + dateIncrement;
		end;
	else
		var reportFileName = printReport(false);
		var excelView = TF634ExcelView(reportFileName, 1.0);

		excelView.print();
		excelView.show();
	end;
    
end;
