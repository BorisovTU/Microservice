/*
$Name:          f303ReportCalculateController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 303. Контроллер расчета отчета
*/

/**
 * Форма 303. Контроллер расчета отчета.
 *
 * @since   10.08.2015
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (RcbReportCalculateController) TF303ReportCalculateController()
    initRcbReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF303BasePartCalculateController(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "1"));
        m_partCalculateControllers.push_back(TF303Part2CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part3CalculateController(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "4"));
        m_partCalculateControllers.push_back(TF303Part5CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part6CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part7CalculateController(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "8"));
        m_partCalculateControllers.push_back(TF303Part9CalculateController(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "10"));
    end;

    macro initialize() : Bool
        global().initializeRepDataPackage(global().getRcbReport());

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;

    private macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        var calculationDataPool = calculationAttributeData.getCalculationDataPool();

        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationDataPool.getCurrentItem().calculate();
        end;

        calculationAttributeData.setCalculated();
    end;

    macro calculate() : Bool
        initialize();

        initProgress(m_partCalculateControllers.getCount(), "Инициализация контроллера расчета", "Инициализация контроллера расчета");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "Выполнение предобработки данных", "Выполнение предобработки данных");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_calculationDataPool.getCount(), "Выполнение расчета", "Выполнение расчета");
        m_calculationDataPool.moveFirst();

        remProgress();

        initProgress(-1, "Cохранение расчитанных данных", "Cохранение расчитанных данных");
        RcbApplication.TransactionManager.commit();
        remProgress();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;
end;

class (TF303ReportCalculateController) TF303ReportCalculateController_4637()
    initTF303ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF303BasePartCalculateController(this));
        m_partCalculateControllers.push_back(TF303Part1CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part2CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part3CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part4CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part5CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part6CalculateController(this));
        m_partCalculateControllers.push_back(TF303Part7CalculateController(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "8"));
        m_partCalculateControllers.push_back(TF303Part9CalculateController_4637(this));
        m_partCalculateControllers.push_back(TF303PartCalculateController(this, "10"));
    end;
end;

class (RcbReportCalculateController) TF303ReportUserCalculateController()
    initRcbReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF303UserPartCalculateController(this, "1User", "1"));
        m_partCalculateControllers.push_back(TF303UserPart2CalculateController(this, "2User", "2"));
        m_partCalculateControllers.push_back(TF303UserPart3CalculateController(this, "3User", "3"));
        m_partCalculateControllers.push_back(TF303UserPartCalculateController(this, "4User", "4"));
        m_partCalculateControllers.push_back(TF303UserPart5CalculateController(this, "5User", "5"));
        m_partCalculateControllers.push_back(TF303UserPart6CalculateController(this, "6User", "6"));
        m_partCalculateControllers.push_back(TF303UserPart7CalculateController(this, "7User", "7"));
        m_partCalculateControllers.push_back(TF303UserPartCalculateController(this, "8User", "8"));
        m_partCalculateControllers.push_back(TF303UserPart9CalculateController(this, "9User", "9"));
        m_partCalculateControllers.push_back(TF303UserPart10CalculateController(this, "10User", "10"));
    end;

    macro initialize() : Bool
        global.getRcbReport().attributeValue("Раздел1_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел2_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел3_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел4_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел5_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел6_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел7_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел8_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел9_Ввод").removeAllValues();
        global.getRcbReport().attributeValue("Раздел10_Ввод").removeAllValues();

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;

    private macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        var calculationDataPool = calculationAttributeData.getCalculationDataPool();

        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationDataPool.getCurrentItem().calculate();
        end;

        calculationAttributeData.setCalculated();
    end;

    macro calculate() : Bool
        initialize();

        initProgress(m_partCalculateControllers.getCount(), "Инициализация контроллера расчета", "Инициализация контроллера расчета");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "Выполнение предобработки данных", "Выполнение предобработки данных");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_calculationDataPool.getCount(), "Выполнение расчета", "Выполнение расчета");
        m_calculationDataPool.moveFirst();

        remProgress();

        initProgress(-1, "Cохранение расчитанных данных", "Cохранение расчитанных данных");
        RcbApplication.TransactionManager.commit();
        remProgress();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;
end;

class (TF303ReportUserCalculateController) TF303ReportUserCalculateController_4637()
    initTF303ReportUserCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF303UserPart1CalculateController(this, "1User", "1"));
        m_partCalculateControllers.push_back(TF303UserPart2CalculateController(this, "2User", "2"));
        m_partCalculateControllers.push_back(TF303UserPart3CalculateController(this, "3User", "3"));
        m_partCalculateControllers.push_back(TF303UserPart4CalculateController(this, "4User", "4"));
        m_partCalculateControllers.push_back(TF303UserPart5CalculateController(this, "5User", "5"));
        m_partCalculateControllers.push_back(TF303UserPart6CalculateController(this, "6User", "6"));
        m_partCalculateControllers.push_back(TF303UserPart7CalculateController(this, "7User", "7"));
        m_partCalculateControllers.push_back(TF303UserPartCalculateController(this, "8User", "8"));
        m_partCalculateControllers.push_back(TF303UserPart9CalculateController_4637(this, "9User", "9"));
        m_partCalculateControllers.push_back(TF303UserPart10CalculateController(this, "10User", "10"));
    end;
end;