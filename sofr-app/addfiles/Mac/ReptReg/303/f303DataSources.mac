/*
$Name:          f303DataSources.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 303. Источники данных
*/

/**
 * Для удобства использования в Меткомбанке
 */
private const IS_METKOM = false;

/**
 * Форма 303. Источники данных.
 *
 * @since   10.08.2015
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (RcbDataSource) TF303BaseDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro clear()
        sql_execute("TRUNCATE TABLE df303contracts_tmp");
        sql_execute("TRUNCATE TABLE df303accounts_tmp");
        sql_execute("TRUNCATE TABLE df303tranches_tmp");
        sql_execute("TRUNCATE TABLE df303operation_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        var departmentList = rcbDepartmentList().getAsSqlSetFull();

        var query = "INSERT /*+ APPEND*/ INTO df303contracts_tmp"
           + "\n" + "(t_creditId,"
           + "\n" + " t_creditNumber,"
           + "\n" + " t_type,"
           + "\n" + " t_issueType,"
           + "\n" + " t_openDate,"
           + "\n" + " t_closeDate,"
           + "\n" + " t_rightsOfClaimContractId,"
           + "\n" + " t_firstContractId,"
           + "\n" + " t_firstContractDate,"
           + "\n" + " t_firstContractEndDate,"
           + "\n" + " t_finishDate,"
           + "\n" + " t_conversionsCount,"
           + "\n" + " t_contractAmount,"
           + "\n" + " t_contractAmountWithChanges,"
           + "\n" + " t_fiid,"
           + "\n" + " t_assessmentLoans,"
           + "\n" + " t_rvpsReservePercent,"
           + "\n" + " t_rvpsSum,"
           + "\n" + " t_rvpsQualityCategory,"
           + "\n" + " t_contragentId,"
           + "\n" + " t_contragent,"
           + "\n" + " t_briefCaseId,"
           + "\n" + " t_insuranceKind,"
           + "\n" + " t_isCredit,"
           + "\n" + " t_isCession,"
           + "\n" + " t_isConcession,"
           + "\n" + " t_isCreditline,"
           + "\n" + " t_isRepaidLoan,"
           + "\n" + " t_purple,"
           + "\n" + " t_specCondCredit,"
           + "\n" + " t_sumFactCostAcq,"
           + "\n" + " t_sumPaidOD,"
           + "\n" + " t_sumPaidPerc,"
           + "\n" + " t_sumPaidOther,"
           + "\n" + " t_sourcePayment,"
           + "\n" + " t_crdRefinId,"
           + "\n" + " t_regNumberCredOrg"
           + "\n" + ")"
           + "\n" + "SELECT contract.t_id,"
           + "\n" + "       contract.t_number,"
           + "\n" + "       contract.t_type,"
           + "\n" + "       contract.t_issueType,"
           + "\n" + "       contract.t_openDate,"
           + "\n" + "       contract.t_closeDate,"
           + "\n" + "       contract.t_rightsOfClaimContractId,"
           + "\n" + "       contract.t_firstContractId,"
           + "\n" + "       contract.t_firstContractDate,"
           + "\n" + "       contract.t_firstcontractenddate,"
           + "\n" + "       contract.t_finishDate,"
           + "\n" + "       contract.t_conversionsCount,"
           + "\n" + "       contract.t_contractAmount,"
           + "\n" + "       contract.t_contractAmountWithChanges,"
           + "\n" + "       contract.t_fiid,"
           + "\n" + "       contract.t_assessmentLoans,"
           + "\n" + "       contract.t_rvpsReservePercent,"
           + "\n" + "       0 /*loansVox.calcrvps(contract.t_id, rep_data.getEndDate())*/ AS t_rvpsSum,"
           + "\n" + "       contract.t_rvpsQualityCategory,"
           + "\n" + "       contract.t_contragentId,"
           + "\n" + "       party.t_name AS t_contragent,"
           + "\n" + "       contract.t_briefCaseId,"
           + "\n" + "       contract.t_insuranceKind,"
           + "\n" + "       CASE"
           + "\n" + "          WHEN (contract.t_issueType != 3 /* LoansConst.cf_crlin */ AND contract.t_issueType != 4 /* LoansConst.cf_crlinno */ AND contract.t_issueType != 5 /* LoansConst.cf_crlinnew */)"
           + "\n" + "                AND contract.t_rightsOfClaimContractId = 0"
           + "\n" + "            THEN 1"
           + "\n" + "          ELSE 0"
           + "\n" + "       END AS t_isCredit,"
           + "\n" + "       CASE"
           + "\n" + "          WHEN contract.t_rightsOfClaimContractId != 0"
           + "\n" + "            THEN 1"
           + "\n" + "          ELSE 0"
           + "\n" + "       END AS t_isCession,"
           + "\n" + "       NULL AS t_isConcession,"
           + "\n" + "       CASE"
           + "\n" + "          WHEN (contract.t_issueType = 3 /* LoansConst.cf_crlin */ OR contract.t_issueType = 4 /* LoansConst.cf_crlinno */ OR contract.t_issueType = 5 /* LoansConst.cf_crlinnew */)"
           + "\n" + "                AND contract.t_rightsOfClaimContractId = 0 AND contract.t_type = " + LO_CREDIT
           + "\n" + "            THEN 1"
           + "\n" + "          ELSE 0"
           + "\n" + "       END AS t_isCreditline,";

        if (IS_METKOM) // Упрощенный способ определения погашенности ссуды
           query = query
           + "\n" + "       CASE"
           + "\n" + "            WHEN (contract.t_closeDate <= rep_data.getEndDate() AND contract.t_closeDate <> TO_DATE('01-01-0001', 'DD-MM-YYYY'))"
           + "\n" + "            THEN 1"
           + "\n" + "          ELSE 0"
           + "\n" + "       END AS t_isRepaidLoan,";
        else
           query = query
           + "\n" + "       CASE"
           + "\n" + "          WHEN EXISTS (SELECT 1"
           + "\n" + "                         FROM repLnsRegister_vw reg"
           + "\n" + "                        WHERE reg.t_rest != 0 and reg.t_trancheNumber = contract.t_id"
           + "\n" + "                      )"
           + "\n" + "           OR NOT EXISTS (SELECT 1"
           + "\n" + "                            FROM repLnsRegChangeHistory_vw regHist"
           + "\n" + "                           WHERE regHist.t_trancheNumber = contract.t_id AND regHist.t_operationKind = 3"
           + "\n" + "                         )"
           + "\n" + "            THEN 0"
           + "\n" + "          ELSE 1"
           + "\n" + "       END AS t_isRepaidLoan,";
        end;

        query = query
           + "\n" + "       contract.t_purple,"
           + "\n" + "       contract.t_specCondCredit,"
           + "\n" + "       NVL(contract.t_sumFactCostAcq, 0),"
           + "\n" + "       NVL(contract.t_sumPaidOD, 0),"
           + "\n" + "       NVL(contract.t_sumPaidPerc, 0),"
           + "\n" + "       NVL(contract.t_sumPaidOther, 0),"
           + "\n" + "       contract.t_sourcePayment, "
           + "\n" + "       NVL(contract.t_crdRefinId, ''), "
           + "\n" + "       contract.t_regNumberCredOrg "
           + "\n" + "  FROM repLnsContract_vw contract, drepparty_vw party"
           + "\n" + "  WHERE (contract.t_openDate <= rep_data.getEndDate() AND (contract.t_closeDate > rep_data.getBeginDate() or contract.t_closeDate = TO_DATE('01-01-0001', 'DD-MM-YYYY')))"
           + "\n" + "    AND contract.t_type IN ( " + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + " )"
           + "\n" + "    AND contract.t_clientType = " + RCB_JURIDICAL_PERSON
           + "\n" + "    AND contract.t_contragentId = party.t_id"
           + "\n" + "    AND (party.t_isBank = 0 OR party.t_isEmployer = 1 OR party.t_isPhisical = 0)"
           + "\n" + "    AND contract.t_departmentId IN " + departmentList;
        sql_execute(query);

        // Кэширование траншей
        query =  "INSERT /*+ APPEND*/ INTO df303tranches_tmp                      "
        + "\n" + "(t_creditId,                                                    "
        + "\n" + " t_trancheNumber,                                               "
        + "\n" + " t_trancheKind,                                                 "
        + "\n" + " t_userTrancheNumber,                                           "
        + "\n" + " t_fiid,                                                        "
        + "\n" + " t_plannedLastRepaymentDate,                                    "
        + "\n" + "                                    t_firstIssueDate,           "
        + "\n" + "                                    t_firstIssueSum,            "
        + "\n" + " t_issueSum,                                                    "
        + "\n" + " t_CalcRVPSPD,                                                  "
        + "\n" + " t_CalcRVPSOD,                                                  "
        + "\n" + " t_CalcRVPPerc,                                                 "
        + "\n" + " t_rvpPerc,                                                     "
        + "\n" + " t_rvpExpPerc,                                                  "
        + "\n" + " t_sumPaidOD,                                                   "
        + "\n" + " t_sumPaidPerc,                                                 "
        + "\n" + " t_sumPaidOther,                                                "
        + "\n" + " t_sourcePayment                                                "
        + "\n" + ")                                                               "
        + "\n" + " SELECT tranche.t_contractId,                                   "
        + "\n" + "        tranche.t_number t_trancheNumber ,                      "
        + "\n" + "        tranche.t_kind AS t_trancheKind,                        "
        + "\n" + "        tranche.t_trancheNumber AS t_userTrancheNumber,         "
        + "\n" + "        tranche.t_fiid AS t_fiId,                               "
        + "\n" + "        tranche.t_plannedLastRepaymentDate,                     "
        + "\n" + "        tranche.t_firstIssueDate,                               "
        + "\n" + "        tranche.t_firstIssueSum,                                "
        + "\n" + "        tranche.t_issueSum,                                     "
        + "\n" + "        0 /*tranche.t_CalcRVPSPD*/,                             "
        + "\n" + "        0 /*tranche.t_CalcRVPSOD*/,                             "
        + "\n" + "        0 /*tranche.t_CalcRVPPerc */,                           "
        + "\n" + "        tranche.t_rvpPerc,                                      "
        + "\n" + "        tranche.t_rvpExpPerc,                                   "
        + "\n" + "        tranche.t_sumPaidOD,                                    "
        + "\n" + "        tranche.t_sumPaidPerc,                                  "
        + "\n" + "        tranche.t_sumPaidOther,                                 "
        + "\n" + "        tranche.t_sourcePayment                                 "
        + "\n" + "   FROM df303contracts_tmp contract, repLnsTranches_vw tranche  "
        + "\n" + "  WHERE tranche.t_contractId = contract.t_creditId"
        + "\n" + "    AND tranche.t_isFictive = 0"
        + "\n" + "    AND tranche.t_lastIssueDate <= rep_data.getEndDate()";

        if (not IS_METKOM)
            query = query
            + "\n" + "    AND (   EXISTS (SELECT 1 "
            + "\n" + "                      FROM repLnsRegister_vw reg "
            + "\n" + "                     WHERE reg.t_trancheKind = tranche.t_kind AND reg.t_trancheNumber = tranche.t_number"
            + "\n" + "                       AND reg.t_rest > 0)"
            + "\n" + "         OR EXISTS (SELECT 1 "
            + "\n" + "                      FROM repLnsOperation_vw op"
            + "\n" + "                     WHERE op.t_trancheKind = tranche.t_kind AND op.t_trancheNumber = tranche.t_number"
            + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
            + "\n" + "                       AND op.t_type = 3))";
        end;
        sql_execute(query);

        if (IS_METKOM)
            sql_execute("DELETE FROM df303tranches_tmp tranche"
               + "\n" + " WHERE"
               + "\n" + "   NOT EXISTS (SELECT 1 "
               + "\n" + "                 FROM DDUTYREST_DBT dutyrest, (SELECT lc.t_id AS t_lcRegId, tr.t_trancheNumber, tr.t_trancheKind      "
               + "\n" + "                                                 FROM dlcusreg_dbt lc, df303tranches_tmp tr                        "
               + "\n" + "                                                WHERE lc.t_objectTypeId = tr.t_trancheKind      "
               + "\n" + "                                                  AND lc.t_objectNumber = tr.t_trancheNumber   "
               + "\n" + "                                              ) lcReg                                           "
               + "\n" + "                 WHERE dutyrest.t_id_ref = lcReg.t_lcRegId                                      "
               + "\n" + "                   AND dutyrest.t_restDate = (SELECT MAX(rest.t_restDate)                       "
               + "\n" + "                                                FROM DDUTYREST_DBT rest                         "
               + "\n" + "                                               WHERE rest.t_id_ref = lcReg.t_lcRegId            "
               + "\n" + "                                                 AND rest.t_restDate <= rep_data.getEndDate())  "
               + "\n" + "   AND dutyRest.t_restSum <> 0 AND lcreg.t_trancheNumber = tranche.t_trancheNumber AND lcreg.t_tranchekind = tranche.t_trancheKind)"
               + "\n" + "         AND NOT EXISTS (SELECT 1 "
               + "\n" + "                      FROM repLnsOperation_vw op"
               + "\n" + "                     WHERE op.t_trancheKind = tranche.t_trancheKind AND op.t_trancheNumber = tranche.t_trancheNumber"
               + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
               + "\n" + "                       AND op.t_type = 3)"
                       );
        end;

        // Кэширование счетов
        sql_execute( "INSERT /*+ APPEND*/ INTO df303accounts_tmp (t_creditId,      "
                    + "\n" + "                                    t_trancheNumber, "
                    + "\n" + "                                    t_trancheKind,   "
                    + "\n" + "                                    t_openDate,      "
                    + "\n" + "                                    t_typeAccount,   "
                    + "\n" + "                                    t_account,       "
                    + "\n" + "                                    t_cbAccount,     "
                    + "\n" + "                                    t_outRest)       "
                    + "\n" + "                SELECT lnsAcc.t_contractId,      "
                    + "\n" + "                       lnsAcc.t_objectNumber,    "
                    + "\n" + "                       lnsAcc.t_objectId,        "
                    + "\n" + "                       lnsAcc.t_openDate,        "
                    + "\n" + "                       lnsAcc.t_type,            "
                    + "\n" + "                       lnsAcc.t_account,         "
                    + "\n" + "                       lnsAcc.t_cbAccount,       "
                    + "\n" + "                       lnsAcc.t_outRest          "
                    + "\n" + "                  FROM replnsaccount_vw lnsAcc   "
                    + "\n" + "                 WHERE lnsAcc.t_type IN ('С', 'З') "
                    + "\n" + "                   AND EXISTS (SELECT 1 FROM df303contracts_tmp credit WHERE lnsAcc.t_contractId = credit.t_creditId) "
                    + "\n" + "                   AND lnsAcc.t_isValidAccount = 1"
                   );

       var queryReserve =   "(SELECT t_creditId AS a_creditNumber,"
                  + "\n" + "         t_type     AS a_type         "
                  + "\n" + "    FROM df303contracts_tmp)          ";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, queryReserve);

        command.execute();

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_trancheNumber AS a_objectNumber,"
                   + "\n" + "        t_trancheKind   AS a_objectTypeId "
                   + "\n" + "   FROM df303tranches_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();
    end;

    private macro constructorF303BaseDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("0", protocolView, dataSources);
    end;

    constructorF303BaseDataSource(protocolView, dataSources);
end;

class (TF303BaseDataSource) TF303BaseDataSource_4033(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303BaseDataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        var departmentList = rcbDepartmentList().getAsSqlSetFull();
        var queryText = "";

        queryText = "INSERT /*+ APPEND*/ INTO df303contracts_tmp (t_creditId,"
                    + "\n" + "                        t_creditNumber,"
                    + "\n" + "                        t_type,"
                    + "\n" + "                        t_issueType,"
                    + "\n" + "                        t_openDate,"
                    + "\n" + "                        t_closeDate,"
                    + "\n" + "                        t_rightsOfClaimContractId,"
                    + "\n" + "                        t_firstContractId,"
                    + "\n" + "                        t_firstContractDate,"
                    + "\n" + "                        t_firstContractEndDate,"
                    + "\n" + "                        t_finishDate,"
                    + "\n" + "                        t_conversionsCount,"
                    + "\n" + "                        t_contractAmount,"
                    + "\n" + "                        t_contractAmountWithChanges,"
                    + "\n" + "                        t_fiid,"
                    + "\n" + "                        t_assessmentLoans,"
                    + "\n" + "                        t_rvpsReservePercent,"
                    + "\n" + "                        t_rvpsSum,"
                    + "\n" + "                        t_rvpsQualityCategory,"
                    + "\n" + "                        t_contragentId,"
                    + "\n" + "                        t_contragent,"
                    + "\n" + "                        t_briefCaseId,"
                    + "\n" + "                        t_insuranceKind,"
                    + "\n" + "                        t_isCredit,"
                    + "\n" + "                        t_isCession,"
                    + "\n" + "                        t_isConcession,"
                    + "\n" + "                        t_isCreditline,"
                    + "\n" + "                        t_isRepaidLoan,"
                    + "\n" + "                        t_purple,"
                    + "\n" + "                        t_specCondCredit,"
                    + "\n" + "                        t_sumFactCostAcq,"
                    + "\n" + "                        t_sumPaidOD,"
                    + "\n" + "                        t_sumPaidPerc,"
                    + "\n" + "                        t_sumPaidOther,"
                    + "\n" + "                        t_sourcePayment,"
                    + "\n" + "                        t_crdRefinId,"
                    + "\n" + "                        t_regNumberCredOrg)"
                    + "\n" + "SELECT data.t_id,"
                    + "\n" + "                data.t_number,"
                    + "\n" + "                data.t_type,"
                    + "\n" + "                data.t_issueType,"
                    + "\n" + "                data.t_openDate,"
                    + "\n" + "                data.t_closeDate,"
                    + "\n" + "                data.t_rightsOfClaimContractId,"
                    + "\n" + "                data.t_firstContractId,"
                    + "\n" + "                data.t_firstContractDate,"
                    + "\n" + "                data.t_firstcontractenddate,"
                    + "\n" + "                data.t_finishDate,"
                    + "\n" + "                data.t_conversionsCount,"
                    + "\n" + "                data.t_contractAmount,"
                    + "\n" + "                data.t_contractAmountWithChanges,"
                    + "\n" + "                data.t_fiid,"
                    + "\n" + "                data.t_assessmentLoans,"
                    + "\n" + "                data.t_rvpsReservePercent,"
                    + "\n" + "                data.t_rvpsSum,";

            if (TF303Parameters().getIsAccountingEnsure() == 1)
                    queryText = queryText
                           + "\n" + "         CASE"
                           + "\n" + "           WHEN data.t_isCreditLine = 1 AND data.t_isRepaidLoan = 1"
                           + "\n" + "             THEN data.t_rvpQualityCategory"
                           + "\n" + "             ELSE data.t_rvpsQualityCategory"
                           + "\n" + "         END AS t_qualityCategory,";
            else
                    queryText = queryText
                           + "\n" + "         data.t_rvpsQualityCategory,";
            end;

            queryText = queryText + "\n" + "  data.t_contragentId,"
                    + "\n" + "                data.t_contragent,"
                    + "\n" + "                data.t_briefCaseId,"
                    + "\n" + "                data.t_insuranceKind,"
                    + "\n" + "                data.t_isCredit,"
                    + "\n" + "                data.t_isCession,"
                    + "\n" + "                data.t_isConcession,"
                    + "\n" + "                data.t_isCreditline,"
                    + "\n" + "                data.t_isRepaidLoan,"
                    + "\n" + "                data.t_purple,"
                    + "\n" + "                data.t_specCondCredit,"
                    + "\n" + "                data.t_sumFactCostAcq,"
                    + "\n" + "                data.t_sumPaidOD,"
                    + "\n" + "                data.t_sumPaidPerc,"
                    + "\n" + "                data.t_sumPaidOther,"
                    + "\n" + "                data.t_sourcePayment, "
                    + "\n" + "                data.t_crdRefinId,"
                    + "\n" + "                data.t_regNumberCredOrg "
                    + "\n" + "  FROM ("
                    + "\n" + "         SELECT contract.t_id,"
                    + "\n" + "                contract.t_number,"
                    + "\n" + "                contract.t_type,"
                    + "\n" + "                contract.t_issueType,"
                    + "\n" + "                contract.t_openDate,"
                    + "\n" + "                contract.t_closeDate,"
                    + "\n" + "                contract.t_rightsOfClaimContractId,"
                    + "\n" + "                contract.t_firstContractId,"
                    + "\n" + "                contract.t_firstContractDate,"
                    + "\n" + "                contract.t_firstcontractenddate,"
                    + "\n" + "                contract.t_finishDate,"
                    + "\n" + "                contract.t_conversionsCount,"
                    + "\n" + "                contract.t_contractAmount,"
                    + "\n" + "                contract.t_contractAmountWithChanges,"
                    + "\n" + "                contract.t_fiid,"
                    + "\n" + "                contract.t_assessmentLoans,"
                    + "\n" + "                contract.t_rvpsReservePercent,"
                    + "\n" + "                0 /*loansVox.calcrvps(contract.t_id, rep_data.getEndDate())*/ AS t_rvpsSum,"
                    + "\n" + "                contract.t_rvpQualityCategory," /* ККУО  на дату изменения */
                    + "\n" + "                contract.t_rvpsQualityCategory," /* ККС на дату изменения */
                    + "\n" + "                contract.t_contragentId,"
                    + "\n" + "                party.t_name AS t_contragent,"
                    + "\n" + "                contract.t_briefCaseId,"
                    + "\n" + "                contract.t_insuranceKind,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN (contract.t_issueType != 3 /* LoansConst.cf_crlin */ AND contract.t_issueType != 4 /* LoansConst.cf_crlinno */ AND contract.t_issueType != 5 /* LoansConst.cf_crlinnew */)"
                    + "\n" + "                         AND contract.t_rightsOfClaimContractId = 0"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCredit,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN contract.t_rightsOfClaimContractId != 0"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCession,"
                    + "\n" + "                NULL AS t_isConcession,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN (contract.t_issueType = 3 /* LoansConst.cf_crlin */ OR contract.t_issueType = 4 /* LoansConst.cf_crlinno */ OR contract.t_issueType = 5 /* LoansConst.cf_crlinnew */)"
                    + "\n" + "                         AND contract.t_rightsOfClaimContractId = 0 AND contract.t_type = " + LO_CREDIT
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCreditline,";

            if (IS_METKOM) // Упрощенный способ определения погашенности ссуды
                queryText = queryText
                    + "\n" + "                CASE"
                    + "\n" + "                     WHEN (contract.t_closeDate <= rep_data.getEndDate() AND contract.t_closeDate <> TO_DATE('01-01-0001', 'DD-MM-YYYY'))"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isRepaidLoan,";
            else
                queryText = queryText
                    + "\n" +          "       CASE"
                    + "\n" + "                   WHEN EXISTS (SELECT 1"
                    + "\n" + "                                  FROM repLnsRegister_vw reg"
                    + "\n" + "                                 WHERE reg.t_rest != 0 and reg.t_trancheNumber = contract.t_id"
                    + "\n" + "                               )"
                    + "\n" + "                    OR NOT EXISTS (SELECT 1"
                    + "\n" + "                                     FROM repLnsRegChangeHistory_vw regHist"
                    + "\n" + "                                    WHERE regHist.t_trancheNumber = contract.t_id AND regHist.t_operationKind = 3"
                    + "\n" + "                                  )"
                    + "\n" + "                     THEN 0"
                    + "\n" + "                   ELSE 1"
                    + "\n" + "                END AS t_isRepaidLoan,";
            end;

            queryText = queryText
                    + "\n" + "                contract.t_purple,"
                    + "\n" + "                contract.t_specCondCredit,"
                    + "\n" + "                NVL(contract.t_sumFactCostAcq, 0) AS t_sumFactCostAcq,"
                    + "\n" + "                NVL(contract.t_sumPaidOD, 0) AS t_sumPaidOD,"
                    + "\n" + "                NVL(contract.t_sumPaidPerc, 0) AS t_sumPaidPerc,"
                    + "\n" + "                NVL(contract.t_sumPaidOther, 0) AS t_sumPaidOther,"
                    + "\n" + "                contract.t_sourcePayment, "
                    + "\n" + "                NVL(contract.t_crdRefinId, '') AS t_crdRefinId, "
                    + "\n" + "                contract.t_regNumberCredOrg "
                    + "\n" + "           FROM repLnsContract_vw contract, drepparty_vw party"
                    + "\n" + "          WHERE (contract.t_openDate <= rep_data.getEndDate() AND (contract.t_closeDate > rep_data.getBeginDate() or contract.t_closeDate = TO_DATE('01-01-0001', 'DD-MM-YYYY')))"
                    + "\n" + "            AND contract.t_type IN ( " + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + " )"
                    + "\n" + "            AND contract.t_clientType = " + RCB_JURIDICAL_PERSON
                    + "\n" + "            AND contract.t_contragentId = party.t_id"
                    + "\n" + "            AND (party.t_isBank = 0 OR party.t_isEmployer = 1 OR party.t_isPhisical = 0)"
                    +"\n"+ "              AND contract.t_departmentId IN " + departmentList + ") data";

        sql_execute(queryText);

        // Кэширование траншей
        queryText = "INSERT /*+ APPEND*/ INTO df303tranches_tmp (t_creditId,                 "
                    + "\n" + "                                    t_trancheNumber,            "
                    + "\n" + "                                    t_trancheKind,              "
                    + "\n" + "                                    t_userTrancheNumber,        "
                    + "\n" + "                                    t_fiid,                     "
                    + "\n" + "                                    t_plannedLastRepaymentDate, "
                    + "\n" + "                                    t_firstIssueDate,           "
                    + "\n" + "                                    t_firstIssueSum,            "
                    + "\n" + "                                    t_issueSum,                 "
                    + "\n" + "                                    t_CalcRVPSPD,               "
                    + "\n" + "                                    t_CalcRVPSOD,               "
                    + "\n" + "                                    t_CalcRVPPerc,              "
                    + "\n" + "                                    t_rvpPerc,                  "
                    + "\n" + "                                    t_rvpExpPerc,               "
                    + "\n" + "                                    t_sumPaidOD,                "
                    + "\n" + "                                    t_sumPaidPerc,              "
                    + "\n" + "                                    t_sumPaidOther,             "
                    + "\n" + "                                    t_sourcePayment)            "
                    + "\n" + " SELECT tranche.t_contractId,                                   "
                    + "\n" + "        tranche.t_number t_trancheNumber ,                      "
                    + "\n" + "        tranche.t_kind AS t_trancheKind,                        "
                    + "\n" + "        tranche.t_trancheNumber AS t_userTrancheNumber,         "
                    + "\n" + "        tranche.t_fiid AS t_fiId,                               "
                    + "\n" + "        tranche.t_plannedLastRepaymentDate,                     "
                    + "\n" + "        tranche.t_firstIssueDate,                               "
                    + "\n" + "        tranche.t_firstIssueSum,                                "
                    + "\n" + "        0 AS t_issueSum,                                        "
                    + "\n" + "        0 /*tranche.t_CalcRVPSPD*/,                             "
                    + "\n" + "        0 /*tranche.t_CalcRVPSOD*/,                             "
                    + "\n" + "        0 /*tranche.t_CalcRVPPerc */,                           "
                    + "\n" + "        0 AS t_rvpPerc,                                         "
                    + "\n" + "        0 AS t_rvpExpPerc,                                      "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidOD, 0),    "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidPerc, 0),  "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidOther, 0), "
                    + "\n" + "        tranche.t_sourcePayment                                 "

                    + "\n" + "   FROM df303contracts_tmp contract, repLnsTranches_vw tranche  "
                    + "\n" + "  WHERE tranche.t_contractId = contract.t_creditId"
                    + "\n" + "    AND tranche.t_isFictive = 0"
                    + "\n" + "    AND tranche.t_lastIssueDate <= rep_data.getEndDate()";

        if (not IS_METKOM)
            queryText = queryText
                    + "\n" + "    AND (   EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsRegister_vw reg "
                    + "\n" + "                     WHERE reg.t_trancheKind = tranche.t_kind AND reg.t_trancheNumber = tranche.t_number"
                    + "\n" + "                       AND reg.t_rest > 0)"
                    + "\n" + "         OR EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsOperation_vw op"
                    + "\n" + "                     WHERE op.t_trancheKind = tranche.t_kind AND op.t_trancheNumber = tranche.t_number"
                    + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
                    + "\n" + "                       AND op.t_type = 3))";
        end;
        sql_execute(queryText);

        if (IS_METKOM)
            sql_execute("DELETE FROM df303tranches_tmp tranche WHERE"
                    + "\n" + "    NOT EXISTS (SELECT 1 "
                    + "\n" + "                  FROM DDUTYREST_DBT dutyrest, (SELECT lc.t_id AS t_lcRegId, tr.t_trancheNumber, tr.t_trancheKind      "
                    + "\n" + "                 FROM dlcusreg_dbt lc, df303tranches_tmp tr                        "
                    + "\n" + "                            WHERE lc.t_objectTypeId = tr.t_trancheKind           "
                    + "\n" + "                               AND lc.t_objectNumber = tr.t_trancheNumber        "
                    + "\n" + "               ) lcReg                                                           "
                    + "\n" + "                 WHERE dutyrest.t_id_ref = lcReg.t_lcRegId                                      "
                    + "\n" + "                   AND dutyrest.t_restDate = (SELECT MAX(rest.t_restDate)                       "
                    + "\n" + "                                                FROM DDUTYREST_DBT rest                         "
                    + "\n" + "                                               WHERE rest.t_id_ref = lcReg.t_lcRegId            "
                    + "\n" + "                                                 AND rest.t_restDate <= rep_data.getEndDate())  "
                    + "\n" + "   AND dutyRest.t_restSum <> 0 AND lcreg.t_trancheNumber = tranche.t_trancheNumber AND lcreg.t_tranchekind = tranche.t_trancheKind)"
                    + "\n" + "         AND NOT EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsOperation_vw op"
                    + "\n" + "                     WHERE op.t_trancheKind = tranche.t_trancheKind AND op.t_trancheNumber = tranche.t_trancheNumber"
                    + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
                    + "\n" + "                       AND op.t_type = 3)"
           );
        end;

        // Кэширование счетов
        sql_execute( "INSERT /*+ APPEND*/ INTO df303accounts_tmp (t_creditId,      "
                    + "\n" + "                                    t_trancheNumber, "
                    + "\n" + "                                    t_trancheKind,   "
                    + "\n" + "                                    t_openDate,      "
                    + "\n" + "                                    t_typeAccount,   "
                    + "\n" + "                                    t_account,       "
                    + "\n" + "                                    t_cbAccount,     "
                    + "\n" + "                                    t_outRest)       "
                    + "\n" + "                SELECT lnsAcc.t_contractId,      "
                    + "\n" + "                       lnsAcc.t_objectNumber,    "
                    + "\n" + "                       lnsAcc.t_objectId,        "
                    + "\n" + "                       lnsAcc.t_openDate,        "
                    + "\n" + "                       lnsAcc.t_type,            "
                    + "\n" + "                       lnsAcc.t_account,         "
                    + "\n" + "                       lnsAcc.t_cbAccount,       "
                    + "\n" + "                       lnsAcc.t_outRest          "
                    + "\n" + "                  FROM replnsaccount_vw lnsAcc   "
                    + "\n" + "                 WHERE lnsAcc.t_type IN ('С', 'З') "
                    + "\n" + "                   AND EXISTS (SELECT 1 FROM df303contracts_tmp credit WHERE lnsAcc.t_contractId = credit.t_creditId) "
                    + "\n" + "                   AND lnsAcc.t_isValidAccount = 1"
                   );

        var queryReserve =   "(SELECT t_creditId AS a_creditNumber,"
                    + "\n" + "         t_type     AS a_type        "
                    + "\n" + "    FROM df303contracts_tmp)         ";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, queryReserve);

        command.execute();

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_trancheNumber AS a_objectNumber,"
                   + "\n" + "        t_trancheKind   AS a_objectTypeId "
                   + "\n" + "   FROM df303tranches_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();
    end;
end;


class (TF303BaseDataSource) TF303BaseDataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303BaseDataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        var departmentList = rcbDepartmentList().getAsSqlSetFull();
        var queryText = "";

        queryText = "INSERT /*+ APPEND*/ INTO df303contracts_tmp (t_creditId,"
                    + "\n" + "                        t_creditNumber,"
                    + "\n" + "                        t_type,"
                    + "\n" + "                        t_issueType,"
                    + "\n" + "                        t_openDate,"
                    + "\n" + "                        t_closeDate,"
                    + "\n" + "                        t_rightsOfClaimContractId,"
                    + "\n" + "                        t_firstContractId,"
                    + "\n" + "                        t_firstContractDate,"
                    + "\n" + "                        t_firstContractEndDate,"
                    + "\n" + "                        t_finishDate,"
                    + "\n" + "                        t_conversionsCount,"
                    + "\n" + "                        t_contractAmount,"
                    + "\n" + "                        t_contractAmountWithChanges,"
                    + "\n" + "                        t_fiid,"
                    + "\n" + "                        t_assessmentLoans,"
                    + "\n" + "                        t_rvpsReservePercent,"
                    + "\n" + "                        t_rvpsSum,"
                    + "\n" + "                        t_rvpsQualityCategory,"
                    + "\n" + "                        t_contragentId,"
                    + "\n" + "                        t_contragent,"
                    + "\n" + "                        t_contragentIsEmployer,"
                    + "\n" + "                        t_briefCaseId,"
                    + "\n" + "                        t_insuranceKind,"
                    + "\n" + "                        t_isCredit,"
                    + "\n" + "                        t_isCession,"
                    + "\n" + "                        t_isConcession,"
                    + "\n" + "                        t_isCreditline,"
                    + "\n" + "                        t_isRepaidLoan,"
                    + "\n" + "                        t_purple,"
                    + "\n" + "                        t_specCondCredit,"
                    + "\n" + "                        t_sumFactCostAcq,"
                    + "\n" + "                        t_sumPaidOD,"
                    + "\n" + "                        t_sumPaidPerc,"
                    + "\n" + "                        t_sumPaidOther,"
                    + "\n" + "                        t_sourcePayment,"
                    + "\n" + "                        t_crdRefinId,"
                    + "\n" + "                        t_regNumberCredOrg,"
                    + "\n" + "                        t_securitySumReservePrincipal,"
                    + "\n" + "                        t_securitySumReservePercent,"
                    + "\n" + "                        t_securitySumReserveDebt,"
                    + "\n" + "                        t_isQualityCategoryRaising, "
                    + "\n" + "                        t_qualityCategoryRaisingDate, "
                    + "\n" + "                        t_limNoRealActiv, "
                    + "\n" + "                        t_qualityServiceDebt, "
                    + "\n" + "                        t_highRiskFactor, "
                    + "\n" + "                        t_lastConversionDate) "
                    + "\n" + "SELECT data.t_id,"
                    + "\n" + "                data.t_number,"
                    + "\n" + "                data.t_type,"
                    + "\n" + "                data.t_issueType,"
                    + "\n" + "                data.t_openDate,"
                    + "\n" + "                data.t_closeDate,"
                    + "\n" + "                data.t_rightsOfClaimContractId,"
                    + "\n" + "                data.t_firstContractId,"
                    + "\n" + "                data.t_firstContractDate,"
                    + "\n" + "                data.t_firstcontractenddate,"
                    + "\n" + "                data.t_finishDate,"
                    + "\n" + "                data.t_conversionsCount,"
                    + "\n" + "                data.t_contractAmount,"
                    + "\n" + "                data.t_contractAmountWithChanges,"
                    + "\n" + "                data.t_fiid,"
                    + "\n" + "                data.t_assessmentLoans,"
                    + "\n" + "                data.t_rvpsReservePercent,"
                    + "\n" + "                data.t_rvpsSum,";

            if (TF303Parameters().getIsAccountingEnsure() == 1)
                    queryText = queryText
                           + "\n" + "         CASE"
                           + "\n" + "           WHEN data.t_isCreditLine = 1 AND data.t_isRepaidLoan = 1"
                           + "\n" + "             THEN data.t_rvpQualityCategory"
                           + "\n" + "             ELSE data.t_rvpsQualityCategory"
                           + "\n" + "         END AS t_qualityCategory,";
            else
                    queryText = queryText
                           + "\n" + "         data.t_rvpsQualityCategory,";
            end;

            queryText = queryText + "\n" + "  data.t_contragentId,"
                    + "\n" + "                data.t_contragent,"
                    + "\n" + "                data.t_contragentIsEmployer,"
                    + "\n" + "                data.t_briefCaseId,"
                    + "\n" + "                data.t_insuranceKind,"
                    + "\n" + "                data.t_isCredit,"
                    + "\n" + "                data.t_isCession,"
                    + "\n" + "                data.t_isConcession,"
                    + "\n" + "                data.t_isCreditline,"
                    + "\n" + "                data.t_isRepaidLoan,"
                    + "\n" + "                data.t_purple,"
                    + "\n" + "                data.t_specCondCredit,"
                    + "\n" + "                data.t_sumFactCostAcq,"
                    + "\n" + "                data.t_sumPaidOD,"
                    + "\n" + "                data.t_sumPaidPerc,"
                    + "\n" + "                data.t_sumPaidOther,"
                    + "\n" + "                data.t_sourcePayment, "
                    + "\n" + "                data.t_crdRefinId,"
                    + "\n" + "                data.t_regNumberCredOrg, "
                    + "\n" + "                data.t_securitySumReservePrincipal, "
                    + "\n" + "                data.t_securitySumReservePercent, "
                    + "\n" + "                data.t_securitySumReserveDebt, "
                    + "\n" + "                data.t_isQualityCategoryRaising, "
                    + "\n" + "                data.t_qualityCategoryRaisingDate, "
                    + "\n" + "                data.t_limNoRealActiv, "
                    + "\n" + "                data.t_qualityServiceDebt, "
                    + "\n" + "                data.t_highRiskFactor, "
                    + "\n" + "                data.t_lastConversionDate "
                    + "\n" + "  FROM ("
                    + "\n" + "         SELECT contract.t_id,"
                    + "\n" + "                contract.t_number,"
                    + "\n" + "                contract.t_type,"
                    + "\n" + "                contract.t_issueType,"
                    + "\n" + "                contract.t_openDate,"
                    + "\n" + "                contract.t_closeDate,"
                    + "\n" + "                contract.t_rightsOfClaimContractId,"
                    + "\n" + "                contract.t_firstContractId,"
                    + "\n" + "                contract.t_firstContractDate,"
                    + "\n" + "                contract.t_firstcontractenddate,"
                    + "\n" + "                contract.t_finishDate,"
                    + "\n" + "                contract.t_conversionsCount,"
                    + "\n" + "                contract.t_contractAmount,"
                    + "\n" + "                contract.t_contractAmountWithChanges,"
                    + "\n" + "                contract.t_fiid,"
                    + "\n" + "                contract.t_assessmentLoans,"
                    + "\n" + "                contract.t_rvpsReservePercent,"
                    + "\n" + "                0 /*loansVox.calcrvps(contract.t_id, rep_data.getEndDate())*/ AS t_rvpsSum,"
                    + "\n" + "                contract.t_rvpQualityCategory," /* ККУО  на дату изменения */
                    + "\n" + "                contract.t_rvpsQualityCategory," /* ККС на дату изменения */
                    + "\n" + "                contract.t_contragentId,"
                    + "\n" + "                party.t_name AS t_contragent,"
                    + "\n" + "                party.t_isEmployer AS t_contragentIsEmployer,"
                    + "\n" + "                contract.t_briefCaseId,"
                    + "\n" + "                contract.t_insuranceKind,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN (contract.t_issueType != 3 /* LoansConst.cf_crlin */ AND contract.t_issueType != 4 /* LoansConst.cf_crlinno */ AND contract.t_issueType != 5 /* LoansConst.cf_crlinnew */)"
                    + "\n" + "                         AND contract.t_rightsOfClaimContractId = 0"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCredit,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN contract.t_rightsOfClaimContractId != 0"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCession,"
                    + "\n" + "                NULL AS t_isConcession,"
                    + "\n" + "                CASE"
                    + "\n" + "                   WHEN (contract.t_issueType = 3 /* LoansConst.cf_crlin */ OR contract.t_issueType = 4 /* LoansConst.cf_crlinno */ OR contract.t_issueType = 5 /* LoansConst.cf_crlinnew */)"
                    + "\n" + "                         AND contract.t_rightsOfClaimContractId = 0 AND contract.t_type = " + LO_CREDIT
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isCreditline,";

            if (IS_METKOM) // Упрощенный способ определения погашенности ссуды
                queryText = queryText
                    + "\n" + "                CASE"
                    + "\n" + "                     WHEN (contract.t_closeDate <= rep_data.getEndDate() AND contract.t_closeDate <> TO_DATE('01-01-0001', 'DD-MM-YYYY'))"
                    + "\n" + "                     THEN 1"
                    + "\n" + "                   ELSE 0"
                    + "\n" + "                END AS t_isRepaidLoan,";
            else
                queryText = queryText
                    + "\n" +          "       CASE"
                    + "\n" + "                   WHEN EXISTS (SELECT 1"
                    + "\n" + "                                  FROM repLnsRegister_vw reg"
                    + "\n" + "                                 WHERE reg.t_rest != 0 and reg.t_trancheNumber = contract.t_id"
                    + "\n" + "                               )"
                    + "\n" + "                    OR NOT EXISTS (SELECT 1"
                    + "\n" + "                                     FROM repLnsRegChangeHistory_vw regHist"
                    + "\n" + "                                    WHERE regHist.t_trancheNumber = contract.t_id AND regHist.t_operationKind = 3"
                    + "\n" + "                                  )"
                    + "\n" + "                     THEN 0"
                    + "\n" + "                   ELSE 1"
                    + "\n" + "                END AS t_isRepaidLoan,";
            end;

            queryText = queryText
                    + "\n" + "                contract.t_purple,"
                    + "\n" + "                contract.t_specCondCredit,"
                    + "\n" + "                NVL(contract.t_sumFactCostAcq, 0) AS t_sumFactCostAcq,"
                    + "\n" + "                NVL(contract.t_sumPaidOD, 0) AS t_sumPaidOD,"
                    + "\n" + "                NVL(contract.t_sumPaidPerc, 0) AS t_sumPaidPerc,"
                    + "\n" + "                NVL(contract.t_sumPaidOther, 0) AS t_sumPaidOther,"
                    + "\n" + "                contract.t_sourcePayment, "
                    + "\n" + "                NVL(contract.t_crdRefinId, '') AS t_crdRefinId, "
                    + "\n" + "                contract.t_regNumberCredOrg, "
                    + "\n" + "                contract.t_securitySumReservePrincipal, "
                    + "\n" + "                contract.t_securitySumReservePercent, "
                    + "\n" + "                contract.t_securitySumReserveDebt, "
                    + "\n" + "                contract.t_isQualityCategoryRaising, "
                    + "\n" + "                contract.t_qualityCategoryRaisingDate, "
                    + "\n" + "                contract.t_limNoRealActiv, "
                    + "\n" + "                contract.t_qualityServiceDebt, "
                    + "\n" + "                contract.t_highRiskFactor, "
                    + "\n" + "                contract.t_lastConversionDate "
                    + "\n" + "           FROM repLnsContract_vw contract, drepparty_vw party"
                    + "\n" + "           WHERE (contract.t_openDate <= rep_data.getEndDate() AND (contract.t_closeDate > rep_data.getBeginDate() or contract.t_closeDate = TO_DATE('01-01-0001', 'DD-MM-YYYY')))"
                    + "\n" + "            AND contract.t_type IN ( " + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + " )"
                    + "\n" + "            AND contract.t_clientType = " + RCB_JURIDICAL_PERSON
                    + "\n" + "            AND contract.t_contragentId = party.t_id"
                    + "\n" + "            AND (party.t_isBank = 0 OR party.t_isEmployer = 1 OR party.t_isPhisical = 0)"
                    +"\n"+ "              AND contract.t_departmentId IN " + departmentList + ") data";

        sql_execute(queryText);

        // Кэширование траншей
        queryText = "INSERT /*+ APPEND*/ INTO df303tranches_tmp (t_creditId,                  "
                    + "\n" + "                                    t_trancheNumber,            "
                    + "\n" + "                                    t_trancheKind,              "
                    + "\n" + "                                    t_userTrancheNumber,        "
                    + "\n" + "                                    t_fiid,                     "
                    + "\n" + "                                    t_plannedLastRepaymentDate, "
                    + "\n" + "                                    t_firstIssueDate,           "
                    + "\n" + "                                    t_firstIssueSum,            "
                    + "\n" + "                                    t_issueSum,                 "
                    + "\n" + "                                    t_CalcRVPSPD,               "
                    + "\n" + "                                    t_CalcRVPSOD,               "
                    + "\n" + "                                    t_CalcRVPPerc,              "
                    + "\n" + "                                    t_rvpPerc,                  "
                    + "\n" + "                                    t_rvpExpPerc,               "
                    + "\n" + "                                    t_sumPaidOD,                "
                    + "\n" + "                                    t_sumPaidPerc,              "
                    + "\n" + "                                    t_sumPaidOther,             "
                    + "\n" + "                                    t_sourcePayment,            "
                    + "\n" + "                                    t_isQualityCategoryRaising, "
                    + "\n" + "                                    t_qualityServiceDebt,       "
                    + "\n" + "                                    t_highRiskFactor,           "
                    + "\n" + "                                    t_conversionsCount)         "
                    + "\n" + " SELECT tranche.t_contractId,                                   "
                    + "\n" + "        tranche.t_number t_trancheNumber ,                      "
                    + "\n" + "        tranche.t_kind AS t_trancheKind,                        "
                    + "\n" + "        tranche.t_trancheNumber AS t_userTrancheNumber,         "
                    + "\n" + "        tranche.t_fiid AS t_fiId,                               "
                    + "\n" + "        tranche.t_plannedLastRepaymentDate,                     "
                    + "\n" + "        tranche.t_firstIssueDate,                               "
                    + "\n" + "        tranche.t_firstIssueSum,                                "
                    + "\n" + "        0 AS t_issueSum,                                        "
                    + "\n" + "        0 /*tranche.t_CalcRVPSPD*/,                             "
                    + "\n" + "        0 /*tranche.t_CalcRVPSOD*/,                             "
                    + "\n" + "        0 /*tranche.t_CalcRVPPerc */,                           "
                    + "\n" + "        0 AS t_rvpPerc,                                         "
                    + "\n" + "        0 AS t_rvpExpPerc,                                      "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidOD, 0),    "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidPerc, 0),  "
                    + "\n" + "        DECODE(contract.t_isCreditLine, 1, tranche.t_sumPaidOther, 0), "
                    + "\n" + "        tranche.t_sourcePayment,                                "
                    + "\n" + "        tranche.t_isQualityCategoryRaising,                     "
                    + "\n" + "        tranche.t_qualityServiceDebt,                           "
                    + "\n" + "        tranche.t_highRiskFactor,                               "
                    + "\n" + "        tranche.t_conversionsCount                              "
                    + "\n" + "   FROM df303contracts_tmp contract, repLnsTranches_vw tranche  "
                    + "\n" + "  WHERE tranche.t_contractId = contract.t_creditId"
                    + "\n" + "    AND tranche.t_isFictive = 0"
                    + "\n" + "    AND tranche.t_lastIssueDate <= rep_data.getEndDate()";

        if (not IS_METKOM)
            queryText = queryText
                    + "\n" + "    AND (   EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsRegister_vw reg "
                    + "\n" + "                     WHERE reg.t_trancheKind = tranche.t_kind AND reg.t_trancheNumber = tranche.t_number"
                    + "\n" + "                       AND reg.t_rest > 0)"
                    + "\n" + "         OR EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsOperation_vw op"
                    + "\n" + "                     WHERE op.t_trancheKind = tranche.t_kind AND op.t_trancheNumber = tranche.t_number"
                    + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
                    + "\n" + "                       AND op.t_type = 3))";
        end;
        sql_execute(queryText);

        if (IS_METKOM)
            sql_execute("DELETE FROM df303tranches_tmp tranche WHERE"
                    + "\n" + "    NOT EXISTS (SELECT 1 "
                    + "\n" + "                  FROM DDUTYREST_DBT dutyrest, (SELECT lc.t_id AS t_lcRegId, tr.t_trancheNumber, tr.t_trancheKind      "
                    + "\n" + "                 FROM dlcusreg_dbt lc, df303tranches_tmp tr                        "
                    + "\n" + "                            WHERE lc.t_objectTypeId = tr.t_trancheKind           "
                    + "\n" + "                               AND lc.t_objectNumber = tr.t_trancheNumber        "
                    + "\n" + "               ) lcReg                                                           "
                    + "\n" + "                 WHERE dutyrest.t_id_ref = lcReg.t_lcRegId                                      "
                    + "\n" + "                   AND dutyrest.t_restDate = (SELECT MAX(rest.t_restDate)                       "
                    + "\n" + "                                                FROM DDUTYREST_DBT rest                         "
                    + "\n" + "                                               WHERE rest.t_id_ref = lcReg.t_lcRegId            "
                    + "\n" + "                                                 AND rest.t_restDate <= rep_data.getEndDate())  "
                    + "\n" + "   AND dutyRest.t_restSum <> 0 AND lcreg.t_trancheNumber = tranche.t_trancheNumber AND lcreg.t_tranchekind = tranche.t_trancheKind)"
                    + "\n" + "         AND NOT EXISTS (SELECT 1 "
                    + "\n" + "                      FROM repLnsOperation_vw op"
                    + "\n" + "                     WHERE op.t_trancheKind = tranche.t_trancheKind AND op.t_trancheNumber = tranche.t_trancheNumber"
                    + "\n" + "                       AND op.t_date >= rep_data.getBeginDate()"
                    + "\n" + "                       AND op.t_type = 3)"
           );
        end;

        // Кэширование счетов
        sql_execute( "INSERT /*+ APPEND*/ INTO df303accounts_tmp (t_creditId,      "
                    + "\n" + "                                    t_trancheNumber, "
                    + "\n" + "                                    t_trancheKind,   "
                    + "\n" + "                                    t_openDate,      "
                    + "\n" + "                                    t_typeAccount,   "
                    + "\n" + "                                    t_account,       "
                    + "\n" + "                                    t_cbAccount,     "
                    + "\n" + "                                    t_outRest)       "
                    + "\n" + "                SELECT lnsAcc.t_contractId,      "
                    + "\n" + "                       lnsAcc.t_objectNumber,    "
                    + "\n" + "                       lnsAcc.t_objectId,        "
                    + "\n" + "                       lnsAcc.t_openDate,        "
                    + "\n" + "                       lnsAcc.t_type,            "
                    + "\n" + "                       lnsAcc.t_account,         "
                    + "\n" + "                       lnsAcc.t_cbAccount,       "
                    + "\n" + "                       lnsAcc.t_outRest          "
                    + "\n" + "                  FROM replnsaccount_vw lnsAcc   "
                    + "\n" + "                 WHERE lnsAcc.t_type IN ('С', 'З') "
                    + "\n" + "                   AND EXISTS (SELECT 1 FROM df303contracts_tmp credit WHERE lnsAcc.t_contractId = credit.t_creditId) "
                    + "\n" + "                   AND lnsAcc.t_isValidAccount = 1"
                   );

        // Кэширование операций
        sql_execute( "INSERT /*+ APPEND*/ INTO df303operation_tmp (t_id,               "
                    + "\n" + "                                     t_creditId,         "
                    + "\n" + "                                     t_trancheKind,      "
                    + "\n" + "                                     t_trancheNumber,    "
                    + "\n" + "                                     t_operationDate,    "
                    + "\n" + "                                     t_sourcePayment,    "
                    + "\n" + "                                     t_crdRefinId,       "
                    + "\n" + "                                     t_regNumberCredOrg, "
                    + "\n" + "                                     t_sumPaidOnMainDebt,"
                    + "\n" + "                                     t_sumOfInterestPaid,"
                    + "\n" + "                                     t_sumOfCommissions) "
                    + "\n" + "                SELECT operation.t_id,                   "
                    + "\n" + "                       operation.t_contractId,           "
                    + "\n" + "                       operation.t_trancheKind,          "
                    + "\n" + "                       operation.t_trancheNumber,        "
                    + "\n" + "                       DECODE(operation.t_history, 'К', operation.t_correctionDate, operation.t_date) AS t_operationDate, "
                    + "\n" + "                       operation.t_sourcePayment,        "
                    + "\n" + "                       operation.t_crdRefinId,           "
                    + "\n" + "                       operation.t_regNumberCredOrg,     "
                    + "\n" + "                       operation.t_sumPaidOnMainDebt,    "
                    + "\n" + "                       operation.t_sumOfInterestPaid,    "
                    + "\n" + "                       operation.t_sumOfCommissions      "
                    + "\n" + "                  FROM repLnsOperation_vw operation      "
                    + "\n" + "                 WHERE 1 = 1 --operation.t_type = 3              "
                    + "\n" + "                   AND EXISTS (SELECT 1 FROM df303contracts_tmp credit WHERE operation.t_contractId = credit.t_creditId) "
                    + "\n" + "                   AND DECODE(operation.t_history, 'К', operation.t_correctionDate, operation.t_date) BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                   );

        var queryReserve =   "(SELECT t_creditId AS a_creditNumber,"
                    + "\n" + "         t_type     AS a_type        "
                    + "\n" + "    FROM df303contracts_tmp)         ";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, queryReserve);

        command.execute();

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_trancheNumber AS a_objectNumber,"
                   + "\n" + "        t_trancheKind   AS a_objectTypeId "
                   + "\n" + "   FROM df303tranches_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();
    end;
end;

class (RcbDataSource) TF303Part1DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p1_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)

        sql_execute( "INSERT /*+ APPEND*/ INTO df303p1_tmp (T_CREDITID,"
            + "\n" + "                         T_DEBTOR,"
            + "\n" + "                         T_DEBTORID,"
            + "\n" + "                         T_OGRN,"
            + "\n" + "                         T_OGRNIP,"
            + "\n" + "                         T_REGISTRATIONDATE,"
            + "\n" + "                         T_DEBTORINN,"
            + "\n" + "                         T_DEBTOROKPO,"
            + "\n" + "                         T_DEBTOROKSM,"
            + "\n" + "                         T_ISMSP,"
            + "\n" + "                         T_RELATIONSWITNBANK)"

            + "\n" + "SELECT data.t_creditId AS t_creditId,"
            + "\n" + "       data.t_contragent AS t_contragent,"
            + "\n" + "       data.t_contragentId AS t_contragentId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtOrJuridical = 1 AND t_isDebtorResident = 1"
            + "\n" + "            THEN NVL((SELECT t_code"
            + "\n" + "                        FROM dRepPartyCodes_vw"
            + "\n" + "                       WHERE t_partyId = data.t_contragentId AND t_codeKind = 27), chr(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrn,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorEmployer = 1 AND t_isDebtorResident = 1"
            + "\n" + "            THEN NVL((SELECT t_code"
            + "\n" + "                        FROM dRepPartyCodes_vw"
            + "\n" + "                       WHERE t_partyId = data.t_contragentId AND t_codeKind = 27), chr(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrnip,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN"
            + "\n" + "              CASE"
            + "\n" + "                 WHEN t_isDebtorResident = 1"
            + "\n" + "                   THEN NVL((SELECT t_beginDate"
            + "\n" + "                               FROM dRepPartyCodes_vw"
            + "\n" + "                              WHERE t_partyId = data.t_contragentId AND t_codeKind = 27), NULL)"
            + "\n" + "                    ELSE NVL((SELECT t_startDate"
            +"\n"+ "                                 FROM dobjRgDoc_dbt objRgDoc"
            +"\n"+ "                                WHERE objRgDoc.t_objectType =  " + RCB_OBJTYPE_PARTY
            +"\n"+ "                                  AND objRgDoc.t_regDocKind =  (SELECT t_regDocKind"
            +"\n"+ "                                                                  FROM dobjKDoc_dbt objKDoc"
            +"\n"+ "                                                                 WHERE objKDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            +"\n"+ "                                                                   AND objKDoc.t_name = 'Аккредитация представительства фирмы')"
            +"\n"+ "                                  AND objRgDoc.t_isMain = 'X'"
            +"\n"+ "                                  AND objRgDoc.t_objectID = data.t_contragentId), (SELECT t_startDate"
            +"\n"+ "                                                                                     FROM dobjRgDoc_dbt objRgDoc"
            +"\n"+ "                                                                                    WHERE objRgDoc.t_objectType =  " + RCB_OBJTYPE_PARTY
            +"\n"+ "                                                                                      AND objRgDoc.t_regDocKind =  (SELECT t_regDocKind"
            +"\n"+ "                                                                                                                      FROM dobjKDoc_dbt objKDoc"
            +"\n"+ "                                                                                                                     WHERE objKDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            +"\n"+ "                                                                                                                       AND objKDoc.t_name = 'Регистрационный номер')"
            +"\n"+ "                                                                                      AND objRgDoc.t_isMain = 'X'"
            +"\n"+ "                                                                                      AND objRgDoc.t_objectID = data.t_contragentId))"
            + "\n" + "               END"
            + "\n" + "            ELSE NULL"
            + "\n" + "       END AS t_registrationDate,"
            + "\n" + "       CASE"
/* КИО, ТIN, LEI - это все когда нибудь ядро сделает  */
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "            THEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1)"
            + "\n" + "          WHEN t_isDebtorResident = 0"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 16) = CHR(1)"
            + "\n" + "                      THEN CASE"
            + "\n" + "                              WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) = CHR(1)"
            + "\n" + "                                THEN CHR(1)" // далее идет аналогичная проверка, когда появятся коды КИО, ТIN, LEI и тд
            + "\n" + "                              ELSE rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) || 'NUM'"
            + "\n" + "                           END"
            + "\n" + "                    ELSE rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1)"
            + "\n" + "                 END"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS T_DEBTORINN,"
/*****************************************************/
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN (SELECT t_okpo FROM dparty_dbt WHERE t_partyId = data.t_contragentId)"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS T_DEBTOROKPO,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN '643'"
            + "\n" + "         ELSE NVL((SELECT C.T_CODENUM3"
            + "\n" + "                     FROM DCOUNTRY_DBT C"
            + "\n" + "                    WHERE C.T_CODELAT3 = (SELECT P.T_NRCOUNTRY"
            + "\n" + "                                            FROM DPARTY_DBT  p"
            + "\n" + "                                           WHERE p.T_PARTYID =  data.t_contragentId)), CHR(1))"
            + "\n" + "       END AS T_DEBTOROKSM,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 0"
            + "\n" + "           THEN CHR(1)"
            + "\n" + "         ELSE NVL((SELECT (SELECT t_numInList"
            + "\n" + "                             FROM dobjattr_dbt a"
            + "\n" + "                            WHERE a.t_attrId = atc.t_attrID AND a.t_objectType = atc.t_ObjectType AND a.t_groupId = 68)"
            + "\n" + "                     FROM dobjatcor_dbt atc"
            + "\n" + "                    WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                      AND atc.t_GroupID    = 68" // Ввести константу
            + "\n" + "                      AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
            + "\n" + "                      AND atc.t_AttrID IN (SELECT att.t_AttrID"
            + "\n" + "                                             FROM dobjattr_dbt att"
            + "\n" + "                                            WHERE att.t_ObjectType = atc.t_ObjectType"
            + "\n" + "                                              AND att.t_GroupID    = atc.t_GroupID"
            + "\n" + "                                              AND att.t_numInList IN('1', '2', '3'))"
            + "\n" + "                      AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate), '0')"
            + "\n" + "       END AS t_isMsp,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "           THEN NVL((SELECT (SELECT CASE t_numInList"
            + "\n" + "                                       WHEN 'ГО'  THEN '1'"
            + "\n" + "                                       WHEN 'ДО'  THEN '2'"
            + "\n" + "                                       WHEN 'ЗО'  THEN '3'"
            + "\n" + "                                       WHEN 'СКП' THEN '4'"
            + "\n" + "                                       WHEN 'СП'  THEN '5'"
            + "\n" + "                                       WHEN 'АБ'  THEN '6'"
            + "\n" + "                                       WHEN 'ИЛ'  THEN '7'"
            + "\n" + "                                       WHEN 'ПР'  THEN '8'"
            + "\n" + "                                    END"
            + "\n" + "                               FROM dobjattr_dbt a"
            + "\n" + "                              WHERE a.t_attrId = atc.t_attrID AND a.t_objectType = atc.t_ObjectType AND a.t_groupId = 2)"
            + "\n" + "                        FROM dobjatcor_dbt atc"
            + "\n" + "                       WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                         AND atc.t_GroupID    = 2" // Ввести константу
            + "\n" + "                         AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
            + "\n" + "                         AND atc.t_AttrID IN (SELECT att.t_AttrID"
            + "\n" + "                                                FROM dobjattr_dbt att"
            + "\n" + "                                               WHERE att.t_ObjectType = atc.t_ObjectType"
            + "\n" + "                                                 AND att.t_GroupID    = atc.t_GroupID"
            + "\n" + "                                                 AND att.t_numInList IN('ГО', 'ДО', 'ЗО', 'СКП', 'СП', 'АБ', 'ИЛ', 'ПР'))"
            + "\n" + "                         AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate), '0')"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS t_relationsWitnBank"
            + "\n" + "  FROM ("
            + "\n" + "        SELECT contract.t_creditId            AS t_creditId,"
            + "\n" + "               contract.t_contragent          AS t_contragent,"
            + "\n" + "               contract.t_contragentId        AS t_contragentId,"
            + "\n" + "               (SELECT CASE"
            + "\n" + "                          WHEN party.t_isPhisical = 1"
            + "\n" + "                            THEN 0"
            + "\n" + "                          ELSE 1"
            + "\n" + "                       END"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtOrJuridical,"
            + "\n" + "               (SELECT t_isResident"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtorResident,"
            + "\n" + "               (SELECT t_isEmployer"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtorEmployer"
            + "\n" + "           FROM df303contracts_tmp contract"
            + "\n" + "        ) data");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p1_tmp p1";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_REGISTRATIONDATE", V_DATE);

        return dataSet;
    end;

    private macro constructorF303Part1DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("1", protocolView, dataSources);
    end;

    constructorF303Part1DataSource(protocolView, dataSources);
end;

class (TF303Part1DataSource) TF303Part1DataSource_4212(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part1DataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)

        sql_execute( "INSERT /*+ APPEND*/ INTO df303p1_tmp (T_CREDITID,"
            + "\n" + "                         T_DEBTOR,"
            + "\n" + "                         T_DEBTORID,"
            + "\n" + "                         T_OGRN,"
            + "\n" + "                         T_OGRNIP,"
            + "\n" + "                         T_REGISTRATIONDATE,"
            + "\n" + "                         T_DEBTORINN,"
            + "\n" + "                         T_DEBTOROKPO,"
            + "\n" + "                         T_DEBTOROKSM,"
            + "\n" + "                         T_RELATIONSWITNBANK)"

            + "\n" + "SELECT data.t_creditId AS t_creditId,"
            + "\n" + "       data.t_contragent AS t_contragent,"
            + "\n" + "       data.t_contragentId AS t_contragentId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtOrJuridical = 1 AND t_isDebtorResident = 1"
            + "\n" + "            THEN NVL((SELECT t_code"
            + "\n" + "                        FROM dRepPartyCodes_vw"
            + "\n" + "                       WHERE t_partyId = data.t_contragentId AND t_codeKind = 27), chr(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrn,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorEmployer = 1 AND t_isDebtorResident = 1"
            + "\n" + "            THEN NVL((SELECT t_code"
            + "\n" + "                        FROM dRepPartyCodes_vw"
            + "\n" + "                       WHERE t_partyId = data.t_contragentId AND t_codeKind = 27), chr(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrnip,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN"
            + "\n" + "              CASE"
            + "\n" + "                 WHEN t_isDebtorResident = 1"
            + "\n" + "                   THEN (SELECT objRgDoc.t_docDate"
            + "\n" + "                           FROM dobjRgDoc_dbt objRgDoc"
            + "\n" + "                          WHERE objRgDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                            AND objRgDoc.t_regPartyKind = (SELECT objkrgpt.t_regPartyKind"
            + "\n" + "                                                             FROM dobjkrgpt_dbt objkrgpt"
            + "\n" + "                                                            WHERE objkrgpt.t_name = 'Налоговая служба'"
            + "\n" + "                                                          )"
            + "\n" + "                            AND objRgDoc.t_regDocKind = (SELECT objKDoc.t_regDocKind"
            + "\n" + "                                                           FROM dobjKDoc_dbt objKDoc"
            + "\n" + "                                                          WHERE objKDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                                            AND objKDoc.t_name = 'Свидетельство о госрегистрации'"
            + "\n" + "                                                        )"
            + "\n" + "                            AND objRgDoc.t_objectID = data.t_contragentId"
            + "\n" + "                        )"
            + "\n" + "                   ELSE NVL((SELECT objRgDoc.t_docDate"
            + "\n" + "                               FROM dobjRgDoc_dbt objRgDoc"
            + "\n" + "                              WHERE objRgDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                AND objRgDoc.t_regPartyKind = (SELECT objkrgpt.t_regPartyKind"
            + "\n" + "                                                                 FROM dobjkrgpt_dbt objkrgpt"
            + "\n" + "                                                                WHERE objkrgpt.t_name = 'Регистрационная палата'"
            + "\n" + "                                                              )"
            + "\n" + "                                AND objRgDoc.t_regDocKind = (SELECT t_regDocKind"
            + "\n" + "                                                               FROM dobjKDoc_dbt objKDoc"
            + "\n" + "                                                              WHERE objKDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                                                AND objKDoc.t_name = 'Аккредитация представительства фирмы'"
            + "\n" + "                                                            )"
            + "\n" + "                                AND objRgDoc.t_objectID = data.t_contragentId"
            + "\n" + "                            ),"
            + "\n" + "                            (SELECT objRgDoc.t_docDate"
            + "\n" + "                               FROM dobjRgDoc_dbt objRgDoc"
            + "\n" + "                              WHERE objRgDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                AND objRgDoc.t_regPartyKind = (SELECT objkrgpt.t_regPartyKind"
            + "\n" + "                                                                 FROM dobjkrgpt_dbt objkrgpt"
            + "\n" + "                                                                WHERE objkrgpt.t_name = 'Регистрационный орган в стране учреждения'"
            + "\n" + "                                                              )"
            + "\n" + "                                AND objRgDoc.t_regDocKind = (SELECT t_regDocKind"
            + "\n" + "                                                               FROM dobjKDoc_dbt objKDoc"
            + "\n" + "                                                              WHERE objKDoc.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                                                AND objKDoc.t_name = 'Регистрационный номер'"
            + "\n" + "                                                            )"
            + "\n" + "                                AND objRgDoc.t_objectID = data.t_contragentId"
            + "\n" + "                            )"
            + "\n" + "                           )"
            + "\n" + "               END"
            + "\n" + "            ELSE NULL"
            + "\n" + "       END AS t_registrationDate,"
            + "\n" + "       CASE"
/* КИО, ТIN, LEI - это все когда нибудь ядро сделает  */
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "            THEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1)"
            + "\n" + "          WHEN t_isDebtorResident = 0"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1) != CHR(1)"
            + "\n" + "                      THEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1)"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 16) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 16)"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 6) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 6) || 'SWIFT'"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) || 'NUM'"
            + "\n" + "                    ELSE CHR(1)" // далее идет аналогичная проверка, когда появятся коды КИО, ТIN, LEI и тд
            + "\n" + "                 END"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS T_DEBTORINN,"
/*****************************************************/
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN (SELECT t_okpo FROM dparty_dbt WHERE t_partyId = data.t_contragentId)"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS T_DEBTOROKPO,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN '643'"
            + "\n" + "         ELSE NVL((SELECT C.T_CODENUM3"
            + "\n" + "                     FROM DCOUNTRY_DBT C"
            + "\n" + "                    WHERE C.T_CODELAT3 = (SELECT P.T_NRCOUNTRY"
            + "\n" + "                                            FROM DPARTY_DBT  p"
            + "\n" + "                                           WHERE p.T_PARTYID =  data.t_contragentId)), CHR(1))"
            + "\n" + "       END AS T_DEBTOROKSM,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "           THEN NVL((SELECT (SELECT CASE t_numInList"
            + "\n" + "                                       WHEN 'ГО'  THEN '1'"
            + "\n" + "                                       WHEN 'ДО'  THEN '2'"
            + "\n" + "                                       WHEN 'ЗО'  THEN '3'"
            + "\n" + "                                       WHEN 'СКП' THEN '4'"
            + "\n" + "                                       WHEN 'СП'  THEN '5'"
            + "\n" + "                                       WHEN 'АБ'  THEN '6'"
            + "\n" + "                                       WHEN 'ИЛ'  THEN '7'"
            + "\n" + "                                       WHEN 'ПР'  THEN '8'"
            + "\n" + "                                    END"
            + "\n" + "                               FROM dobjattr_dbt a"
            + "\n" + "                              WHERE a.t_attrId = atc.t_attrID AND a.t_objectType = atc.t_ObjectType AND a.t_groupId = 2)"
            + "\n" + "                       FROM dobjatcor_dbt atc"
            + "\n" + "                      WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                        AND atc.t_GroupID    = 2" // Ввести константу
            + "\n" + "                        AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
            + "\n" + "                        AND atc.t_AttrID IN (SELECT att.t_AttrID"
            + "\n" + "                                               FROM dobjattr_dbt att"
            + "\n" + "                                              WHERE att.t_ObjectType = atc.t_ObjectType"
            + "\n" + "                                                AND att.t_GroupID    = atc.t_GroupID"
            + "\n" + "                                                AND att.t_numInList IN('ГО', 'ДО', 'ЗО', 'СКП', 'СП', 'АБ', 'ИЛ', 'ПР'))"
            + "\n" + "                        AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate), '0')"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS t_relationsWitnBank"
            + "\n" + "  FROM ("
            + "\n" + "        SELECT contract.t_creditId            AS t_creditId,"
            + "\n" + "               contract.t_contragent            AS t_contragent,"
            + "\n" + "               contract.t_contragentId            AS t_contragentId,"
            + "\n" + "               (SELECT CASE"
            + "\n" + "                          WHEN party.t_isPhisical = 1"
            + "\n" + "                            THEN 0"
            + "\n" + "                          ELSE 1"
            + "\n" + "                       END"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtOrJuridical,"
            + "\n" + "               (SELECT t_isResident"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtorResident,"
            + "\n" + "               (SELECT t_isEmployer"
            + "\n" + "                  FROM drepparty_vw party"
            + "\n" + "                 WHERE party.t_id = contract.t_contragentId) AS t_isDebtorEmployer"
            + "\n" + "           FROM df303contracts_tmp contract"
            + "\n" + "        ) data");
    end;
end;

class (TF303Part1DataSource) TF303Part1DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part1DataSource(protocolView, dataSources);

    private macro isLawyerOrNotary()
        const SUBJECT_TYPE = 16; //категория субъекта "Тип субъекта"

        return "EXISTS(SELECT 1 "
      + "\n" + "         FROM dobjatcor_dbt atc"
      + "\n" + "        WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
      + "\n" + "          AND atc.t_GroupID    = " + SUBJECT_TYPE
      + "\n" + "          AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
      + "\n" + "          AND atc.t_AttrID IN (SELECT att.t_AttrID"
      + "\n" + "                                 FROM dobjattr_dbt att"
      + "\n" + "                                WHERE att.t_ObjectType = atc.t_ObjectType"
      + "\n" + "                                  AND att.t_GroupID    = atc.t_GroupID"
      + "\n" + "                                  AND att.t_name IN('Адвокат', 'Нотариус'))"
      + "\n" + "          AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate"
      + "\n" + "      )";
    end;

    macro cacheData(filter : RcbDataSourceFilter)

        sql_execute( "INSERT /*+ APPEND*/ INTO df303p1_tmp (T_CREDITID,"
            + "\n" + "                         T_DEBTOR,"
            + "\n" + "                         T_DEBTORID,"
            + "\n" + "                         T_OGRN,"
            + "\n" + "                         T_OGRNIP,"
            + "\n" + "                         T_REGISTRATIONDATE,"
            + "\n" + "                         T_DEBTORINN,"
            + "\n" + "                         T_DEBTOROKPO,"
            + "\n" + "                         T_DEBTOROKSM,"
            + "\n" + "                         T_RELATIONSWITNBANK,"
            + "\n" + "                         T_OKVED,"
            + "\n" + "                         T_BORROWERSGROUPNUMBER,"
            + "\n" + "                         T_BORROWERSGROUPNAME,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "SELECT data.t_creditId AS t_creditId,"
            + "\n" + "       data.t_contragent AS t_contragent,"
            + "\n" + "       data.t_contragentId AS t_contragentId,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN " + isLawyerOrNotary()
            + "\n" + "              THEN '0000000000000'"
            + "\n" + "           ELSE NVL(data.t_ogrn, CHR(1)) "  // Проверка того, что контрагент юрлицо и резидент делается в dRepParty_vw
            + "\n" + "       END AS t_ogrn,"
            + "\n" + "       NVL(data.t_ogrnEmployer, CHR(1)) AS t_ogrnip," // Проверка того, что контрагент индивидуальный предприниматель и резидент делается в dRepParty_vw
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "            THEN "
            + "\n" + "                CASE "
            + "\n" + "                   WHEN  " + isLawyerOrNotary()
            + "\n" + "                       THEN NULL "
            + "\n" + "                   ELSE "
            + "\n" + "                       CASE "
            + "\n" + "                          WHEN data.t_isDebtorEmployer = 1"
            + "\n" + "                             THEN data.t_ogrnEmployerDate "
            + "\n" + "                          ELSE data.t_ogrnDate "
            + "\n" + "                       END "
            + "\n" + "                END "
            + "\n" + "            ELSE NVL((SELECT rgDoc.t_docDate                                                             "
            + "\n" + "                        FROM (SELECT objRgDocHist.t_docDate, objRgDocHist.t_objectID                     "
            + "\n" + "                                FROM dobjRgDocHist_dbt objRgDocHist                                      "
            + "\n" + "                               WHERE objRgDocHist.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                 AND objRgDocHist.t_regDocKind = (SELECT t_regDocKind                    "
            + "\n" + "                                                                    FROM dobjKDoc_dbt objKDoc            "
            + "\n" + "                                                                   WHERE objKDoc.t_objectType = 3        "
            + "\n" + "                                                                     AND objKDoc.t_shortName = 'АККРЕД') "
            + "\n" + "                                 AND objRgDocHist.t_isClosed  != 'X'                       "
            + "\n" + "                                 AND objRgDocHist.t_startDate  <= rep_data.getEndDate()  "
            + "\n" + "                                 AND (objRgDocHist.t_finishDate >= rep_data.getEndDate() OR objRgDocHist.t_finishDate = TO_DATE('01.01.0001', 'dd.mm.yyyy'))   "
            + "\n" + "                               ORDER BY objRgDocHist.t_sysDate DESC, objRgDocHist.t_sysTime DESC"
            + "\n" + "                             ) rgDoc"
            + "\n" + "                       WHERE rgDoc.t_objectID = data.t_contragentId     "
            + "\n" + "                         AND rownum = 1"
            + "\n" + "                     ),"
            + "\n" + "                     (SELECT rgDoc.t_docDate                                                             "
            + "\n" + "                        FROM (SELECT objRgDocHist.t_docDate, objRgDocHist.t_objectID                     "
            + "\n" + "                                FROM dobjRgDocHist_dbt objRgDocHist                                      "
            + "\n" + "                               WHERE objRgDocHist.t_objectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                 AND objRgDocHist.t_regPartyKind = (SELECT objkrgpt.t_regPartyKind"
            + "\n" + "                                                                      FROM dobjkrgpt_dbt objkrgpt"
            + "\n" + "                                                                     WHERE objkrgpt.t_shortName = 'РОНерез'"
            + "\n" + "                                                                   )"
            + "\n" + "                                 AND objRgDocHist.t_isClosed  != 'X'                       "
            + "\n" + "                                 AND objRgDocHist.t_startDate  <= rep_data.getEndDate()  "
            + "\n" + "                                 AND (objRgDocHist.t_finishDate >= rep_data.getEndDate() OR objRgDocHist.t_finishDate = TO_DATE('01.01.0001', 'dd.mm.yyyy'))   "
            + "\n" + "                               ORDER BY objRgDocHist.t_sysDate DESC, objRgDocHist.t_sysTime DESC"
            + "\n" + "                             ) rgDoc"
            + "\n" + "                       WHERE rgDoc.t_objectID = data.t_contragentId     "
            + "\n" + "                         AND rownum = 1)"
            + "\n" + "                    )"
            + "\n" + "       END t_registrationDate,"
            + "\n" + "       CASE"
/* КИО, ТIN, LEI - это все когда нибудь ядро сделает  */
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "            THEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1) || 'ИНН'"
            + "\n" + "          WHEN t_isDebtorResident = 0"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1) != CHR(1)"
            + "\n" + "                      THEN rsb_rep_pt.get_partyInn(data.t_contragentId, 0, null, 1) || 'ИНН'"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 16) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 16)"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 6) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 6) || 'SWIFT'"
            + "\n" + "                    WHEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) != CHR(1)"
            + "\n" + "                      THEN rsi_rsbparty.GetPartyCode(data.t_contragentId, 33) || 'NUM'"
            + "\n" + "                    ELSE CHR(1)" // далее идет аналогичная проверка, когда появятся коды КИО, ТIN, LEI и тд
            + "\n" + "                 END"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS t_debtorInn,"
/*****************************************************/
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN (SELECT t_okpo FROM dparty_dbt WHERE t_partyId = data.t_contragentId)"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END AS T_DEBTOROKPO,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN t_isDebtorResident = 1"
            + "\n" + "           THEN '643'"
            + "\n" + "         ELSE "
            + "\n" + "             CASE "
            + "\n" + "                WHEN data.t_isInternationalCorporation = 1"
            + "\n" + "                    THEN '998'"
            + "\n" + "                WHEN data.t_isForeignBranch = 1"
            + "\n" + "                    THEN '997'"
            + "\n" + "                ELSE data.t_countryNumberCode"
            + "\n" + "             END "
            + "\n" + "       END AS T_DEBTOROKSM,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "           THEN NVL((SELECT (SELECT CASE t_numInList"
            + "\n" + "                                       WHEN 'ГО'  THEN '1'"
            + "\n" + "                                       WHEN 'ДО'  THEN '2'"
            + "\n" + "                                       WHEN 'ЗО'  THEN '3'"
            + "\n" + "                                       WHEN 'СКП' THEN '4'"
            + "\n" + "                                       WHEN 'СП'  THEN '5'"
            + "\n" + "                                       WHEN 'АБ_ЮЛ_10_20'  THEN '6'"
            + "\n" + "                                       WHEN 'АБ_ЮЛ'  THEN '6.1'"
            + "\n" + "                                       WHEN 'ИЛ'  THEN '7'"
            + "\n" + "                                       WHEN 'ГЛ_КО'  THEN '9'"
            + "\n" + "                                       WHEN 'ПР'  THEN '99'"
            + "\n" + "                                    END"
            + "\n" + "                               FROM dobjattr_dbt a"
            + "\n" + "                              WHERE a.t_attrId = atc.t_attrID AND a.t_objectType = atc.t_ObjectType AND a.t_groupId = 2)"
            + "\n" + "                       FROM dobjatcor_dbt atc"
            + "\n" + "                      WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                        AND atc.t_GroupID    = 2" // Ввести константу
            + "\n" + "                        AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
            + "\n" + "                        AND atc.t_AttrID IN (SELECT att.t_AttrID"
            + "\n" + "                                               FROM dobjattr_dbt att"
            + "\n" + "                                              WHERE att.t_ObjectType = atc.t_ObjectType"
            + "\n" + "                                                AND att.t_GroupID    = atc.t_GroupID"
            + "\n" + "                                                AND att.t_numInList IN('ГО', 'ДО', 'ЗО', 'СКП', 'СП', 'АБ_ЮЛ_10_20', 'АБ_ЮЛ', 'ГЛ_КО', 'АБ', 'ИЛ', 'ПР'))"
            + "\n" + "                        AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate), '')"
            + "\n" + "         ELSE CHR(1)                         "
            + "\n" + "       END AS t_relationsWitnBank,           "
            + "\n" + "       SUBSTR(data.t_okved, 1, 2) AS t_okved,"
            + "\n" + "       data.t_borrowersGroupNumber,          "
            + "\n" + "       data.t_borrowersGroupName,            "
            + "\n" + "       (ROW_NUMBER() OVER(PARTITION BY data.t_creditId ORDER BY data.t_borrowersGroupNumber) - 1) AS t_addLine"
            + "\n" + "  FROM ("
            + "\n" + "        SELECT contract.t_creditId       AS t_creditId,"
            + "\n" + "               contract.t_contragent     AS t_contragent,"
            + "\n" + "               contract.t_contragentId   AS t_contragentId,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN party.t_isPhisical = 1"
            + "\n" + "                    THEN 0"
            + "\n" + "                  ELSE 1"
            + "\n" + "               END  AS t_isDebtorJuridical,"
            + "\n" + "               party.t_isResident AS t_isDebtorResident,"
            + "\n" + "               party.t_isEmployer AS t_isDebtorEmployer,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN party.t_isResident != 1"
            + "\n" + "                    THEN "
            + "\n" + "                      NVL((SELECT att.t_value                                             "
            + "\n" + "                             FROM drepcategory_vw att                                     "
            + "\n" + "                            WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2_FOR_F302
            + "\n" + "                              AND att.t_objectId       = party.t_objectId                 "
            + "\n" + "                              AND att.t_objectType     = " + RCB_OBJTYPE_PARTY
            + "\n" + "                              AND att.t_validFromDate <= " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
            + "\n" + "                              AND att.t_validToDate   >= " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
            + "\n" + "                              AND rownum               = 1                                "
            + "\n" + "                             ),                                                           "
            + "\n" + "                          (                                                               "
            + "\n" + "                           SELECT att.t_value                                             "
            + "\n" + "                             FROM drepcategory_vw att                                     "
            + "\n" + "                            WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2
            + "\n" + "                              AND att.t_objectId       = party.t_objectId                 "
            + "\n" + "                              AND att.t_objectType     = " + RCB_OBJTYPE_PARTY
            + "\n" + "                              AND att.t_validFromDate <= " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
            + "\n" + "                              AND att.t_validToDate   >= " + getSqlDate(rcbApplication().currentReport.context.period.endDate)
            + "\n" + "                              AND rownum               = 1                                "
            + "\n" + "                         ))                                                               "
            + "\n" + "                  ELSE NULL                                                               "
            + "\n" + "               END  AS t_okved,                                                           "
            + "\n" + "               CASE                                          "
            + "\n" + "                  WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY')"
            + "\n" + "                    THEN category.t_value"
            + "\n" + "                  ELSE NULL                                  "
            + "\n" + "               END AS t_borrowersGroupNumber,                "
            + "\n" + "               CASE                                          "
            + "\n" + "                  WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY')"
            + "\n" + "                    THEN category.t_name"
            + "\n" + "                  ELSE NULL                                  "
            + "\n" + "               END AS t_borrowersGroupName,                  "
            + "\n" + "               party.t_ogrn,                         "
            + "\n" + "               party.t_ogrnEmployer,                 "
            + "\n" + "               party.t_ogrnDate,                     "
            + "\n" + "               party.t_ogrnEmployerDate,             "
            + "\n" + "               party.t_isInternationalCorporation,   "
            + "\n" + "               party.t_isForeignBranch,              "
            + "\n" + "               party.t_countryNumberCode             "
            + "\n" + "          FROM df303contracts_tmp contract           "
            + "\n" + "               INNER JOIN (SELECT party.t_id,                  "
            + "\n" + "                                  party.t_objectId,            "
            + "\n" + "                                  party.t_isResident,          "
            + "\n" + "                                  party.t_isEmployer,          "
            + "\n" + "                                  party.t_isPhisical,          "
            + "\n" + "                                  party.t_ogrn,                "
            + "\n" + "                                  party.t_ogrnEmployer,        "
            + "\n" + "                                  party.t_ogrnDate,            "
            + "\n" + "                                  party.t_ogrnEmployerDate,    "
            + "\n" + "                                  party.t_isInternationalCorporation, "
            + "\n" + "                                  party.t_isForeignBranch,     "
            + "\n" + "                                  party.t_countryNumberCode    "
            + "\n" + "                             FROM drepparty_vw party           "
            + "\n" + "                          ) party                              "
            + "\n" + "                       ON contract.t_contragentId = party.t_id "
            + "\n" + "                LEFT JOIN (SELECT cat.t_value,        "
            + "\n" + "                                  cat.t_name,         "
            + "\n" + "                                  cat.t_objectId      "
            + "\n" + "                             FROM drepCategory_vw cat "
            + "\n" + "                            WHERE cat.t_isForParty = 1"
            + "\n" + "                              AND cat.t_isinstalledForEndDate = 1"
            + "\n" + "                              AND cat.t_id = 20) category"
            + "\n" + "                       ON category.t_objectId = rsb_rep_pt.makePartyID(contract.t_contragentId)"
            + "\n" + "        ) data");
    end;
end;

class (RcbDataSource) TF303Part2DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p2_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p2_tmp (T_CREDITID,"
            + "\n" + "                         T_CREDITNUMBER,"
            + "\n" + "                         T_DATE,"
            + "\n" + "                         T_NUMBERLOAN,"
            + "\n" + "                         T_DATELOAN,"
            + "\n" + "                         T_PARTYLOAN,"
            + "\n" + "                         T_OGRNLOAN,"
            + "\n" + "                         T_REGNUMBERLOAN,"
            + "\n" + "                         T_OKSMLOAN,"
            + "\n" + "                         T_NUMBERRESTRUCTURINGS,"
            + "\n" + "                         T_DATECLAIM,"
            + "\n" + "                         T_DATEENTRY,"
            + "\n" + "                         T_SUMCLAIM,"
            + "\n" + "                         T_SUMCOLLECTION,"
            + "\n" + "                         T_FICODE,"
            + "\n" + "                         T_BANKRUPTCYINFO,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN DECODE(contract.t_firstContractID, CHR(1), 'бн', contract.t_firstContractID)"  // Номер договора (contract.t_firstContractID), заключенного между первоначальным заемщиком и первоначальным кредитором (Лоанса в ТЗ стоит "Пусто (заглушка) " (CHR(1)))
            + "\n" + "          ELSE DECODE(contract.t_creditNumber, CHR(1), 'бн', contract.t_creditNumber)"
            + "\n" + "       END AS t_creditNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE contract.t_openDate"
            + "\n" + "       END AS t_date,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_contractNumber, 'бн')"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_numberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN cess.t_contractDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL((SELECT t_name FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId), CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_partyLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_ogrn, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrnLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_regNumber, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_regNumberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_oksm, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_oksmLoan,"
            + "\n" + "       contract.t_conversionsCount    AS t_conversionsCount,"
/************************* Введены запросы на доработку лоанса */
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateClaim,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_beginDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateEntry,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitAmount"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sumClaim,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_recoveryAmount"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sumCollection,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitCurCode"
            + "\n" + "          ELSE chr(1)"
            + "\n" + "       END AS t_fiCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN "
            + "\n" + "              CASE"
            + "\n" + "                WHEN NOT rep_note.getTextPartyNote(contract.t_contragentId, 44, rep_data.getEndDate()) IS NULL"
            + "\n" + "                  THEN 'Б'"
            + "\n" + "                  ELSE CHR(1)"
            + "\n" + "                END "
            + "\n" + "          ELSE  CHR(1)"
            + "\n" + "       END AS t_bankruptcyInfo,"
            + "\n" + "       contract.t_creditId AS t_trancheNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN (ROW_NUMBER() over(partition by contract.t_creditId, lawsuits.t_id order by contract.t_creditId) > 1)"
            + "\n" + "            THEN 1"
            + "\n" + "          ELSE  0"
            + "\n" + "       END AS t_addLine"
            + "\n" + "  FROM df303contracts_tmp contract LEFT JOIN repLnsCession_vw cess ON contract.t_rightsOfClaimContractId = cess.t_id"
            + "\n" + "       LEFT JOIN repLnsLawsuits_vw lawsuits ON contract.t_creditId = lawsuits.t_id");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p2_tmp p2";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_DATE", V_DATE);
        dataSet.SetFieldType("T_DATELOAN", V_DATE);
        dataSet.SetFieldType("T_DATECLAIM", V_DATE);
        dataSet.SetFieldType("T_DATEENTRY", V_DATE);

        return dataSet;
    end;

    private macro constructorF303Part2DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("2", protocolView, dataSources);
    end;

    constructorF303Part2DataSource(protocolView, dataSources);
end;

class (TF303Part2DataSource) TF303Part2DataSource_4212(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part2DataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p2_tmp (T_CREDITID,"
            + "\n" + "                         T_CREDITNUMBER,"
            + "\n" + "                         T_DATE,"
            + "\n" + "                         T_NUMBERLOAN,"
            + "\n" + "                         T_DATELOAN,"
            + "\n" + "                         T_PARTYLOAN,"
            + "\n" + "                         T_OGRNLOAN,"
            + "\n" + "                         T_REGNUMBERLOAN,"
            + "\n" + "                         T_OKSMLOAN,"
            + "\n" + "                         T_NUMBERRESTRUCTURINGS,"
            + "\n" + "                         T_DATEFILINGSUIT,"
            + "\n" + "                         T_LAWCOURT,"
            + "\n" + "                         T_DATECLAIM,"
            + "\n" + "                         T_DATEENTRY,"
            + "\n" + "                         T_SUMCLAIM,"
            + "\n" + "                         T_SUMCOLLECTION,"
            + "\n" + "                         T_FICODE,"
            + "\n" + "                         T_BANKRUPTCYINFO,"
            + "\n" + "                         T_DATEBANKRUPTCY,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN DECODE(contract.t_firstContractID, CHR(1), 'бн', contract.t_firstContractID)"  // Номер договора (contract.t_firstContractID), заключенного между первоначальным заемщиком и первоначальным кредитором (Лоанса в ТЗ стоит "Пусто (заглушка) " (CHR(1)))
            + "\n" + "          ELSE DECODE(contract.t_creditNumber, CHR(1), 'бн', contract.t_creditNumber)"
            + "\n" + "       END AS t_creditNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE contract.t_openDate"
            + "\n" + "       END AS t_date,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_contractNumber, 'бн')"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_numberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN cess.t_contractDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN "
            + "\n" + "              CASE "
            + "\n" + "                WHEN (SELECT party.t_isPhisical FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId) = 1"
            + "\n" + "                  THEN 'ФЛ'"
            + "\n" + "                ELSE NVL((SELECT t_name FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId), CHR(1))"
            + "\n" + "              END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_partyLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_ogrn, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrnLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_regNumber, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_regNumberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_oksm, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_oksmLoan,"
            + "\n" + "       contract.t_conversionsCount    AS t_conversionsCount,"
/************************* Введены запросы на доработку лоанса */
            + "\n" + "       lawsuits.t_dateFilingSuit, "
            + "\n" + "       lawsuits.t_lawCourt, "
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateClaim,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_beginDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateEntry,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitAmount"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sumClaim,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_recoveryAmount"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sumCollection,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN lawsuits.t_lawsuitCurCode"
            + "\n" + "          ELSE chr(1)"
            + "\n" + "       END AS t_fiCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN "
            + "\n" + "              CASE"
            + "\n" + "                WHEN EXISTS(SELECT 1 "
            + "\n" + "                              FROM drepCategory_vw"
            + "\n" + "                             WHERE t_id         = " + RCB_OBJGROUP_ISBANKRUPT
            + "\n" + "                               AND t_isForParty = 1"
            + "\n" + "                               AND t_isinstalledForEndDate = 1"
            + "\n" + "                               AND t_objectId   = rsb_rep_pt.makePartyID(contract.t_contragentId))  "
            + "\n" + "                  THEN 'Б'"
            + "\n" + "                  ELSE CHR(1)"
            + "\n" + "                END "
            + "\n" + "          ELSE  CHR(1)"
            + "\n" + "       END AS t_bankruptcyInfo,"
            + "\n" + "       NVL((SELECT t_validFromDate "
            + "\n" + "              FROM drepCategory_vw"
            + "\n" + "             WHERE t_id         = " + RCB_OBJGROUP_ISBANKRUPT
            + "\n" + "               AND t_isForParty = 1"
            + "\n" + "               AND t_isinstalledForEndDate = 1"
            + "\n" + "               AND t_objectId   = rsb_rep_pt.makePartyID(contract.t_contragentId)), NULL) AS t_dateBankruptcy,"
            + "\n" + "       contract.t_creditId AS t_trancheNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN (ROW_NUMBER() over(partition by contract.t_creditId, lawsuits.t_id order by contract.t_creditId) > 1)"
            + "\n" + "            THEN 1"
            + "\n" + "          ELSE  0"
            + "\n" + "       END AS t_addLine"
            + "\n" + "  FROM df303contracts_tmp contract LEFT JOIN repLnsCession_vw cess ON contract.t_rightsOfClaimContractId = cess.t_id"
            + "\n" + "       LEFT JOIN repLnsLawsuits_vw lawsuits ON contract.t_creditId = lawsuits.t_id");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p2_tmp p2";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_DATE", V_DATE);
        dataSet.SetFieldType("T_DATELOAN", V_DATE);
        dataSet.SetFieldType("T_DATECLAIM", V_DATE);
        dataSet.SetFieldType("T_DATEENTRY", V_DATE);
        dataSet.SetFieldType("T_DATEFILINGSUIT", V_DATE);
        dataSet.SetFieldType("T_DATEBANKRUPTCY", V_DATE);

        return dataSet;
    end;

end;

class (TF303Part2DataSource_4212) TF303Part2DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part2DataSource_4212(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p2_tmp (T_CREDITID,"
            + "\n" + "                                      T_CREDITNUMBER,"
            + "\n" + "                                      T_DATE,"
            + "\n" + "                                      T_NUMBERLOAN,"
            + "\n" + "                                      T_DATELOAN,"
            + "\n" + "                                      T_PARTYLOAN,"
            + "\n" + "                                      T_OGRNLOAN,"
            + "\n" + "                                      T_REGNUMBERLOAN,"
            + "\n" + "                                      T_OKSMLOAN,"
            + "\n" + "                                      T_NUMBERRESTRUCTURINGS,"
            + "\n" + "                                      T_DATEFILINGSUIT,"
            + "\n" + "                                      T_LAWCOURT,"
            + "\n" + "                                      T_DATECLAIM,"
            + "\n" + "                                      T_DATEENTRY,"
            + "\n" + "                                      T_SUMCLAIM,"
            + "\n" + "                                      T_SUMCOLLECTION,"
            + "\n" + "                                      T_FICODE,"
            + "\n" + "                                      T_BANKRUPTCYINFO,"
            + "\n" + "                                      T_DATEBANKRUPTCY,"
            + "\n" + "                                      T_TRANCHENUMBER,"
            + "\n" + "                                      T_DATELASTRESTRUCTURING,"
            + "\n" + "                                      T_BENEFICIARYNAME,"
            + "\n" + "                                      T_BENEFICIARYOGRN,"
            + "\n" + "                                      T_BENEFICIARYREGNUMBER,"
            + "\n" + "                                      T_BENEFICIARYOKSM,"
            + "\n" + "                                      T_OBLIGATIONKIND,"
            + "\n" + "                                      T_OBLIGATIONSUM,"
            + "\n" + "                                      T_MATURITYOBLIGATION,"
            + "\n" + "                                      T_ADDLINE)"

            + "\n" + "SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN DECODE(contract.t_firstContractID, CHR(1), 'бн', contract.t_firstContractID)"  // Номер договора (contract.t_firstContractID), заключенного между первоначальным заемщиком и первоначальным кредитором (Лоанса в ТЗ стоит "Пусто (заглушка) " (CHR(1)))
            + "\n" + "          ELSE DECODE(contract.t_creditNumber, CHR(1), 'бн', contract.t_creditNumber)"
            + "\n" + "       END AS t_creditNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE contract.t_openDate"
            + "\n" + "       END AS t_date,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_contractNumber, 'бн')"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_numberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN cess.t_contractDate"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_dateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN "
            + "\n" + "              CASE "
            + "\n" + "                WHEN (SELECT party.t_isPhisical FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId) = 1"
            + "\n" + "                  THEN 'ФЛ'"
            + "\n" + "                ELSE NVL((SELECT t_name FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId), CHR(1))"
            + "\n" + "              END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_partyLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN "
            + "\n" + "              CASE "
            + "\n" + "                WHEN (SELECT party.t_isEmployer FROM drepparty_vw party WHERE party.t_id = cess.t_contragentId) = 1"
            + "\n" + "                  THEN NVL(cess.t_ogrnEmployer, CHR(1))"
            + "\n" + "                ELSE NVL(cess.t_ogrn, CHR(1))"
            + "\n" + "              END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ogrnLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN NVL(cess.t_regNumber, CHR(1))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_regNumberLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN contract.t_isCession = 1"
            + "\n" + "            THEN "
            + "\n" + "               CASE"
            + "\n" + "                  WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = cess.t_contragentId AND party.t_isResident = 0 AND party.t_isInternationalCorporation = 1)"
            + "\n" + "                     THEN '998'"
            + "\n" + "                  WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = cess.t_contragentId AND party.t_isResident = 0 AND party.t_isForeignBranch = 1)"
            + "\n" + "                     THEN '997'"
            + "\n" + "                  ELSE cess.t_oksm"
            + "\n" + "               END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_oksmLoan,"
            + "\n" + "       contract.t_conversionsCount    AS t_conversionsCount,"
/************************* Введены запросы на доработку лоанса */
            + "\n" + "       lawsuits.t_dateFilingSuit, "
            + "\n" + "       lawsuits.t_lawCourt, "
            + "\n" + "       lawsuits.t_lawsuitDate AS t_dateClaim,"
            + "\n" + "       lawsuits.t_beginDate AS t_dateEntry,"
            + "\n" + "       lawsuits.t_lawsuitAmount AS t_sumClaim,"
            + "\n" + "       lawsuits.t_recoveryAmount AS t_sumCollection,"
            + "\n" + "       lawsuits.t_lawsuitCurCode AS t_fiCode,"
            + "\n" + "       CASE"
            + "\n" + "         WHEN EXISTS(SELECT 1 "
            + "\n" + "                       FROM drepCategory_vw"
            + "\n" + "                      WHERE t_id         = " + RCB_OBJGROUP_ISBANKRUPT
            + "\n" + "                        AND t_isForParty = 1"
            + "\n" + "                        AND t_isinstalledForEndDate = 1"
            + "\n" + "                        AND t_objectId   = rsb_rep_pt.makePartyID(contract.t_contragentId))  "
            + "\n" + "           THEN 'Б'"
            + "\n" + "           ELSE CHR(1)"
            + "\n" + "         END AS t_bankruptcyInfo,"
            + "\n" + "         NVL((SELECT t_validFromDate "
            + "\n" + "                FROM drepCategory_vw"
            + "\n" + "               WHERE t_id         = " + RCB_OBJGROUP_ISBANKRUPT
            + "\n" + "                 AND t_isForParty = 1"
            + "\n" + "                 AND t_isinstalledForEndDate = 1"
            + "\n" + "                 AND t_objectId   = rsb_rep_pt.makePartyID(contract.t_contragentId)), NULL) AS t_dateBankruptcy,"
            + "\n" + "       contract.t_creditId AS t_trancheNumber,"
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY')"
            + "\n" + "            THEN contract.t_lastConversionDate"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_dateLastRestructuring,               "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN "
            + "\n" + "                CASE"
            + "\n" + "                    WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isPhisical = 1 AND party.t_isEmployer = 0)"
            + "\n" + "                       THEN 'ФЛ'"
            + "\n" + "                    ELSE (SELECT party.t_name FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
            + "\n" + "                END"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_beneficiaryName,                     "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN "
            + "\n" + "                CASE"
            + "\n" + "                    WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isEmployer = 1 AND party.t_isResident = 1)"
            + "\n" + "                       THEN (SELECT party.t_ogrnEmployer FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
            + "\n" + "                    ELSE (SELECT party.t_ogrn FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
            + "\n" + "                END"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_beneficiaryOgrn,                     "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN "
            + "\n" + "                CASE"
            + "\n" + "                    WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isCentralBank = 1)"
            + "\n" + "                       THEN 'CBRF'"
            + "\n" + "                    WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isBank = 1 AND party.t_isResident = 1)"
            + "\n" + "                       THEN (SELECT party.t_bankRegNumber FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
            + "\n" + "                    ELSE NULL"
            + "\n" + "                END"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_beneficiaryRegNumber,                "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isResident = 0 AND party.t_isPhisical = 0)"
            + "\n" + "                     THEN "
            + "\n" + "                         CASE "
            + "\n" + "                            WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isInternationalCorporation = 1)"
            + "\n" + "                               THEN '998'"
            + "\n" + "                            WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isForeignBranch = 1)"
            + "\n" + "                               THEN '997'"
            + "\n" + "                            ELSE (SELECT party.t_countryNumberCode FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
            + "\n" + "                         END"
            + "\n" + "                  ELSE NULL"
            + "\n" + "               END"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_beneficiaryOksm,                     "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN encum.t_obligationKind"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_obligationKind,                      "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN encum.t_obligationSum"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_obligationSum,                       "
            + "\n" + "       CASE                                          "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND contract.t_isCreditLine = 0"
            + "\n" + "            THEN encum.t_dutyDate"
            + "\n" + "          ELSE NULL                                  "
            + "\n" + "       END AS t_maturityObligation,                  "
            + "\n" + "       CASE"
            + "\n" + "          WHEN (ROW_NUMBER() OVER(PARTITION BY contract.t_creditId, lawsuits.t_id ORDER BY contract.t_creditId) > 1)"
            + "\n" + "            THEN 1"
            + "\n" + "          ELSE  0"
            + "\n" + "       END AS t_addLine"
            + "\n" + "  FROM df303contracts_tmp contract LEFT JOIN repLnsCession_vw cess ON contract.t_rightsOfClaimContractId = cess.t_id"
            + "\n" + "       LEFT JOIN repLnsLawsuits_vw lawsuits ON contract.t_creditId = lawsuits.t_id"
            + "\n" + "       LEFT JOIN repLnsEncumbrance_vw encum ON contract.t_creditId = encum.t_trancheNumber AND contract.t_type = encum.t_trancheKind"
            );

/* Дополнительные строки */
        if (rcbApplication().currentReport.context.period.endDate >= RCB_I4637_DATE_F303)
            sql_execute( "INSERT /*+ APPEND*/ INTO df303p2_tmp (T_CREDITID,             "
                + "\n" + "                                      T_TRANCHENUMBER,        "
                + "\n" + "                                      T_NUMBERRESTRUCTURINGS, "
                + "\n" + "                                      T_BENEFICIARYOGRN,"
                + "\n" + "                                      T_BENEFICIARYREGNUMBER,"
                + "\n" + "                                      T_BENEFICIARYNAME,"
                + "\n" + "                                      T_BENEFICIARYOKSM,"
                + "\n" + "                                      T_OBLIGATIONKIND,"
                + "\n" + "                                      T_OBLIGATIONSUM,"
                + "\n" + "                                      T_MATURITYOBLIGATION,"
                + "\n" + "                                      T_ADDLINE)              "
                + "\n" + "SELECT contract.t_creditId,                                   "
                + "\n" + "       tranche.t_trancheNumber    AS t_trancheNumber,         "
                + "\n" + "       tranche.t_conversionsCount AS t_conversionsCount,      "
                + "\n" + "       CASE"
                + "\n" + "           WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isPhisical = 1 AND party.t_isEmployer = 0)"
                + "\n" + "              THEN 'ФЛ'"
                + "\n" + "           ELSE (SELECT party.t_name FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
                + "\n" + "       END AS t_beneficiaryName,                     "
                + "\n" + "       CASE"
                + "\n" + "           WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isEmployer = 1 AND party.t_isResident = 1)"
                + "\n" + "              THEN (SELECT party.t_ogrnEmployer FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
                + "\n" + "           ELSE (SELECT party.t_ogrn FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
                + "\n" + "       END AS t_beneficiaryOgrn,                     "
                + "\n" + "       CASE"
                + "\n" + "           WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isCentralBank = 1)"
                + "\n" + "              THEN 'CBRF'"
                + "\n" + "           WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isBank = 1 AND party.t_isResident = 1)"
                + "\n" + "              THEN (SELECT party.t_bankRegNumber FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
                + "\n" + "           ELSE NULL"
                + "\n" + "       END AS t_beneficiaryRegNumber,                "
                + "\n" + "      CASE"
                + "\n" + "         WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isResident = 0 AND party.t_isPhisical = 0)"
                + "\n" + "            THEN "
                + "\n" + "               CASE "
                + "\n" + "                  WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isInternationalCorporation = 1)"
                + "\n" + "                     THEN '998'"
                + "\n" + "                  WHEN EXISTS(SELECT 1 FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId AND party.t_isForeignBranch = 1)"
                + "\n" + "                     THEN '997'"
                + "\n" + "                  ELSE (SELECT party.t_countryNumberCode FROM dRepParty_vw party WHERE party.t_id = encum.t_contragentId)"
                + "\n" + "               END"
                + "\n" + "         ELSE NULL"
                + "\n" + "      END AS t_beneficiaryOksm,                   "
                + "\n" + "      encum.t_obligationKind AS t_obligationKind, "
                + "\n" + "      encum.t_obligationSum AS t_obligationSum,   "
                + "\n" + "      encum.t_dutyDate AS t_maturityObligation,   "
                + "\n" + "       1 AS t_addLine                             "
                + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche  "
                + "\n" + "       LEFT JOIN repLnsEncumbrance_vw encum ON tranche.t_trancheNumber = encum.t_trancheNumber AND tranche.t_trancheKind = encum.t_trancheKind"
                + "\n" + "WHERE contract.t_creditId = tranche.t_creditId AND contract.t_isCreditLine = 1");
        else
            sql_execute( "INSERT /*+ APPEND*/ INTO df303p2_tmp (T_CREDITID,             "
                + "\n" + "                                      T_TRANCHENUMBER,        "
                + "\n" + "                                      T_NUMBERRESTRUCTURINGS, "
                + "\n" + "                                      T_ADDLINE)              "
                + "\n" + "SELECT contract.t_creditId,                                   "
                + "\n" + "       tranche.t_trancheNumber    AS t_trancheNumber,         "
                + "\n" + "       tranche.t_conversionsCount AS t_conversionsCount,      "
                + "\n" + "       1 AS t_addLine                                         "
                + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche "
                + "\n" + "WHERE contract.t_creditId = tranche.t_creditId AND contract.t_isCreditLine = 1");
        end;
    end;

end;

class (RcbDataSource) TF303Part3DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p3_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         t_addLine)"

            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       0"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                              WHEN data.t_type = " + LO_OVERDRAFT
            + "\n" + "                                THEN '1.2'"
            + "\n" + "                              WHEN data.t_type = " + LO_KARTA
            + "\n" + "                                THEN '1.6'"
            + "\n" + "                              ELSE '1.1'"
            + "\n" + "                           END"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_issueType = 5" // под лимит задолженности
            + "\n" + "                      THEN '1.3'"
            + "\n" + "                    WHEN data.t_issueType = 4" // невозобновляемая КЛ
            + "\n" + "                      THEN '1.4'"
            + "\n" + "                    WHEN data.t_issueType = 3" // лимит выдачи + задолженности
            + "\n" + "                      THEN '1.5'"
            + "\n" + "                 END"
            + "\n" + "          WHEN data.t_isCession = 1"
            + "\n" + "                      THEN '5'"
            + "\n" + "       END AS t_typeLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_purple"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_purposeCredit,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_contractAmount"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_conversionsCount > 0"
            + "\n" + "            THEN data.t_contractAmountWithChanges"
            + "\n" + "          ELSE"
            + "\n" + "            CASE"
            + "\n" + "              WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                THEN data.t_contractAmount"
            + "\n" + "          ELSE 0"
            + "\n" + "              END "
            + "\n" + "       END AS t_sumChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_firstContractEndDate"
            + "\n" + "          ELSE  NULL"
            + "\n" + "       END AS t_dateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_conversionsCount > 0"
            + "\n" + "            THEN data.t_finishDate"
            + "\n" + "          ELSE  "
            + "\n" + "            CASE"
            + "\n" + "              WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                THEN data.t_firstContractEndDate"
            + "\n" + "          ELSE  NULL"
            + "\n" + "            END "
            + "\n" + "       END AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "          WHEN data.t_rateType = 1"
            + "\n" + "            THEN 'Ф'"
            + "\n" + "          WHEN data.t_rateType = 2"
            + "\n" + "            THEN 'П'"
            + "\n" + "          WHEN data.t_rateType = 3"
            + "\n" + "            THEN 'М'"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "                 END "
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateValRegisterContract"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid AND ROWNUM < 2)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END  AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1 OR data.t_isCession = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateVal"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                     WHERE rate.t_tariffKind = 29 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                       AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 29))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_periodFix"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_interestPeriod,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                               FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid AND r.t_rateDate <= rep_data.getEndDate()"
            + "\n" + "                                                 AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRate,"
            + "\n" + "       data.t_specCondCredit t_conditionCode,"
            + "\n" + "       CHR(1) t_creditIdCode,"
            + "\n" + "       chr(1) t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               CASE"
            + "\n" + "                 WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                   THEN rcb_f303.getRateTypeForCredit(contract.t_creditId, contract.t_type)"
            + "\n" + "                   ELSE NULL"
            + "\n" + "               END AS t_rateType,"
            + "\n" + "               (SELECT rate.t_rateVal"
            + "\n" + "                  FROM repLnsRateHistory_vw rate"
            + "\n" + "                 WHERE rate.t_tariffKind = 1 AND contract.t_creditId = rate.t_objectNumber AND contract.t_type = rate.t_objectid"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                            FROM repLnsRateHistory_vw r"
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_type,"
            + "\n" + "               contract.t_issueType,"
            + "\n" + "               contract.t_contractAmount,"
            + "\n" + "               contract.t_contractAmountWithChanges,"
            + "\n" + "               contract.t_rightsOfClaimContractId,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_purple,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               contract.t_specCondCredit,"
            + "\n" + "               contract.t_creditId  AS t_trancheNumber,"
            + "\n" + "               contract.t_isCredit,"
            + "\n" + "               contract.t_isCession,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM df303contracts_tmp contract"
            + "\n" + "       ) data"
            + "\n" + "      )");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "WITH contract AS ("
            + "\n" + "                  SELECT credit.t_creditId AS t_creditId, "
            + "\n" + "                         credit.t_isCreditLine AS t_isCreditLine,"
            + "\n" + "                         tranche.t_trancheKind AS t_trancheKind,         "
            + "\n" + "                         tranche.t_trancheNumber t_trancheNumber ,       "
            + "\n" + "                         tranche.t_fiid AS t_fiId,                "
            + "\n" + "                         (SELECT tr.t_issueSum FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind and rownum < 2) t_issueSum,                      "
            + "\n" + "                         tranche.t_plannedLastRepaymentDate,            "
            + "\n" + "                         credit.t_conversionsCount,                     "
            + "\n" + "                         credit.t_firstContractEndDate,           "
            + "\n" + "                         credit.t_finishDate                      "
            + "\n" + "                  FROM df303contracts_tmp credit,                                        "
            + "\n" + "                       df303tranches_tmp tranche                  "
            + "\n" + "                  WHERE credit.t_creditId = tranche.t_creditId  "
            + "\n" + "                    AND credit.t_isCreditLine = 1                                        "
            + "\n" + "                  )"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       1"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CHR(1) AS t_typeLoan,"
            + "\n" + "       CHR(1) AS t_purposeCredit," // Атрибут рассчитывается, если ДООП >= 01.04.2016 (алгоритма на момент реализации не было)
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_issueSum"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN (data.t_conversionsCount > 0) OR (rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY'))"
            + "\n" + "            THEN data.t_issueSum"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_isCreditLine = 1"
            + "\n" + "                      THEN CASE"
            + "\n" + "                              WHEN data.t_plannedLastRepaymentDate = data.t_firstContractEndDate"
            + "\n" + "                                THEN NULL"
            + "\n" + "                              ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                           END"
            + "\n" + "                 END"
            + "\n" + "          ELSE  NULL"
            + "\n" + "       END AS t_dateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_conversionsCount > 0"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_isCreditLine = 1"
            + "\n" + "                      THEN CASE"
            + "\n" + "                              WHEN data.t_plannedLastRepaymentDate = data.t_finishDate"
            + "\n" + "                                THEN NULL"
            + "\n" + "                              ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                           END"
            + "\n" + "                 END"
            + "\n" + "          ELSE  "
            + "\n" + "            CASE"
            + "\n" + "              WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                THEN  CASE"
            + "\n" + "                        WHEN data.t_isCreditLine = 1"
            + "\n" + "                          THEN CASE"
            + "\n" + "                                 WHEN data.t_plannedLastRepaymentDate = data.t_firstContractEndDate"
            + "\n" + "                                   THEN NULL"
            + "\n" + "                                 ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                               END"
            + "\n" + "                      END"
            + "\n" + "          ELSE  NULL"
            + "\n" + "          END "
            + "\n" + "       END AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1 AND rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_rateType = 1"
            + "\n" + "                      THEN 'Ф'"
            + "\n" + "                    WHEN data.t_rateType = 2"
            + "\n" + "                      THEN 'П'"
            + "\n" + "                    WHEN data.t_rateType = 3"
            + "\n" + "                      THEN 'М'"
            + "\n" + "                    ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "            THEN (SELECT rate.t_rateValRegisterContract"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber"
            + "\n" + "                     AND data.t_trancheKind = rate.t_objectid AND ROWNUM < 2)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END  AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_rateVal"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 29 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_periodFix"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r"
            + "\n" + "                                             WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_interestPeriod,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r"
            + "\n" + "                                             WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRate,"
            + "\n" + "       CHR(1) AS t_conditionCode,"
            + "\n" + "       CHR(1) AS t_creditIdCode,"
            + "\n" + "       data.t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               CASE"
            + "\n" + "                 WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                   THEN rcb_f303.getRateTypeForTranche(contract.t_trancheNumber, contract.t_trancheKind, contract.t_creditId)"
            + "\n" + "                   ELSE NULL"
            + "\n" + "               END AS t_rateType,"
            + "\n" + "               (SELECT rate.t_rateVal "
            + "\n" + "                  FROM repLnsRateHistory_vw rate "
            + "\n" + "                 WHERE rate.t_tariffKind = 1"
            + "\n" + "                   AND rate.t_objectNumber = contract.t_trancheNumber"
            + "\n" + "                   AND rate.t_objectId = contract.t_trancheKind"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate) "
            + "\n" + "                                            FROM repLnsRateHistory_vw r "
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber "
            + "\n" + "                                             AND r.t_objectId = rate.t_objectId "
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() "
            + "\n" + "                                             AND r.t_tariffKind = rate.t_tariffKind) "
            + "\n" + "               ) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_issueSum,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               chr(1) t_account,"
            + "\n" + "               contract.t_plannedLastRepaymentDate,"
            + "\n" + "               contract.t_trancheNumber,"
            + "\n" + "               contract.t_trancheKind,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM contract"
            + "\n" + "        )data)");

    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p3_tmp p3";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_DATEORIGCONTRACT", V_DATE);
        dataSet.SetFieldType("T_DATECHANGESCONTRACT", V_DATE);

        return dataSet;
    end;

    private macro constructorF303Part3DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("3", protocolView, dataSources);
    end;

    constructorF303Part3DataSource(protocolView, dataSources);
end;

class (TF303Part3DataSource) TF303Part3DataSource_4212(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part3DataSource(protocolView, dataSources);

    var accountMasks = "46001*-46007*, 46101*-46107*, 46201*-46207*, 46301*-46307*, 46401*-46407*, 46501*-46507*, 46601*-46607*, 46701*-46707*, 46801*-46807*, 46901*-46907*, 47001*-47007*, 47101*-47107*, 47201*-47207*, 47301*-47307*";

    macro cacheMainRowData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         t_addLine)"

            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       0"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                   WHEN data.t_type = " + LO_OVERDRAFT
            + "\n" + "                     THEN '1.2'"
            + "\n" + "                   WHEN data.t_type = " + LO_KARTA
            + "\n" + "                     THEN '1.6'"
            + "\n" + "                   WHEN ((data.t_type = " + LO_CREDIT + ") AND (EXISTS(SELECT 1 "
            + "\n" + "                                                                         FROM df303accounts_tmp acc"
            + "\n" + "                                                                        WHERE acc.t_creditId = data.t_creditId "
            + "\n" + "                                                                          AND acc.t_typeAccount = 'С'"
            + "\n" + "                                                                          AND " + convertMaskToSqlFormat(accountMasks, "acc.t_cbAccount") + ")))"
            + "\n" + "                     THEN '1.9'"
            + "\n" + "                   ELSE '1.1'"
            + "\n" + "                END"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_issueType = 5" // под лимит задолженности
            + "\n" + "                      THEN '1.3'"
            + "\n" + "                    WHEN data.t_issueType = 4" // невозобновляемая КЛ
            + "\n" + "                      THEN '1.4'"
            + "\n" + "                    WHEN data.t_issueType = 3" // лимит выдачи + задолженности
            + "\n" + "                      THEN '1.5'"
            + "\n" + "                 END"
            + "\n" + "          WHEN data.t_isCession = 1"
            + "\n" + "                      THEN '5'"
            + "\n" + "       END AS t_typeLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_purple"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_purposeCredit,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_contractAmount"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_conversionsCount > 0"
            + "\n" + "            THEN data.t_contractAmountWithChanges"
            + "\n" + "          ELSE"
            + "\n" + "            CASE"
            + "\n" + "              WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                THEN data.t_contractAmount"
            + "\n" + "          ELSE 0"
            + "\n" + "              END "
            + "\n" + "       END AS t_sumChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_firstContractEndDate"
            + "\n" + "          ELSE  NULL"
            + "\n" + "       END AS t_dateOrigContract,"
            + "\n" + "       data.t_finishDate AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "          WHEN data.t_rateType = 1"
            + "\n" + "            THEN 'Ф'"
            + "\n" + "          WHEN data.t_rateType = 2"
            + "\n" + "            THEN 'П'"
            + "\n" + "          WHEN data.t_rateType = 3"
            + "\n" + "            THEN 'М'"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "                 END "
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateValRegisterContract"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid AND ROWNUM < 2)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END  AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1 OR data.t_isCession = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateVal"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                     WHERE rate.t_tariffKind = 29 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                       AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 29))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_periodFix"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_interestPeriod,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                               FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid AND r.t_rateDate <= rep_data.getEndDate()"
            + "\n" + "                                                 AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRate,"
            + "\n" + "       data.t_specCondCredit t_conditionCode,"
            + "\n" + "       CHR(1) t_creditIdCode,"
            + "\n" + "       CHR(1) t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               CASE"
            + "\n" + "                 WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                   THEN rcb_f303.getRateTypeForCredit(contract.t_creditId, contract.t_type)"
            + "\n" + "                   ELSE NULL"
            + "\n" + "               END AS t_rateType,"
            + "\n" + "               (SELECT rate.t_rateVal"
            + "\n" + "                  FROM repLnsRateHistory_vw rate"
            + "\n" + "                 WHERE rate.t_tariffKind = 1 AND contract.t_creditId = rate.t_objectNumber AND contract.t_type = rate.t_objectid"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                            FROM repLnsRateHistory_vw r"
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_type,"
            + "\n" + "               contract.t_issueType,"
            + "\n" + "               contract.t_contractAmount,"
            + "\n" + "               contract.t_contractAmountWithChanges,"
            + "\n" + "               contract.t_rightsOfClaimContractId,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_purple,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               contract.t_specCondCredit,"
            + "\n" + "               contract.t_creditId  AS t_trancheNumber,"
            + "\n" + "               contract.t_isCredit,"
            + "\n" + "               contract.t_isCession,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM df303contracts_tmp contract"
            + "\n" + "       ) data"
            + "\n" + "      )");
    end;

    /* Дополнительные строки */
    macro cacheAddRowsData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "WITH contract AS ("
            + "\n" + "                  SELECT credit.t_creditId AS t_creditId,          "
            + "\n" + "                         credit.t_isCreditLine AS t_isCreditLine,  "
            + "\n" + "                         tranche.t_trancheKind AS t_trancheKind,   "
            + "\n" + "                         tranche.t_trancheNumber t_trancheNumber , "
            + "\n" + "                         tranche.t_fiid AS t_fiId,                 "
            + "\n" + "                         (SELECT tr.t_issueSum FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind and rownum < 2) t_issueSum,                      "
            + "\n" + "                         tranche.t_plannedLastRepaymentDate,       "
            + "\n" + "                         credit.t_conversionsCount,                "
            + "\n" + "                         credit.t_firstContractEndDate,            "
            + "\n" + "                         credit.t_finishDate                       "
            + "\n" + "                  FROM df303contracts_tmp credit,                  "
            + "\n" + "                       df303tranches_tmp tranche                   "
            + "\n" + "                  WHERE credit.t_creditId = tranche.t_creditId     "
            + "\n" + "                    AND credit.t_isCreditLine = 1                  "
            + "\n" + "                  )"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       1"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CHR(1) AS t_typeLoan,"
            + "\n" + "       CHR(1) AS t_purposeCredit," // Атрибут рассчитывается, если ДООП >= 01.04.2016 (алгоритма на момент реализации не было)
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN data.t_issueSum"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN (data.t_conversionsCount > 0) OR (rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY'))"
            + "\n" + "            THEN data.t_issueSum"
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_ficodeChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_isCreditLine = 1"
            + "\n" + "                      THEN CASE"
            + "\n" + "                              WHEN data.t_plannedLastRepaymentDate = data.t_firstContractEndDate"
            + "\n" + "                                THEN NULL"
            + "\n" + "                              ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                           END"
            + "\n" + "                 END"
            + "\n" + "          ELSE  NULL"
            + "\n" + "       END AS t_dateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_plannedLastRepaymentDate = data.t_finishDate"
            + "\n" + "                      THEN NULL"
            + "\n" + "                    ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                 END"
            + "\n" + "            ELSE NULL"
            + "\n" + "       END AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1 AND rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_rateType = 1"
            + "\n" + "                      THEN 'Ф'"
            + "\n" + "                    WHEN data.t_rateType = 2"
            + "\n" + "                      THEN 'П'"
            + "\n" + "                    WHEN data.t_rateType = 3"
            + "\n" + "                      THEN 'М'"
            + "\n" + "                    ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "            THEN (SELECT rate.t_rateValRegisterContract"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber"
            + "\n" + "                     AND data.t_trancheKind = rate.t_objectid AND ROWNUM < 2)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END  AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_rateVal"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 29 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_periodFix"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r"
            + "\n" + "                                             WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_interestPeriod,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                    FROM repLnsRateHistory_vw rate"
            + "\n" + "                   WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "                     AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                              FROM repLnsRateHistory_vw r"
            + "\n" + "                                             WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                               AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRate,"
            + "\n" + "       CHR(1) AS t_conditionCode,"
            + "\n" + "       CHR(1) AS t_creditIdCode,"
            + "\n" + "       data.t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               CASE"
            + "\n" + "                 WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                   THEN rcb_f303.getRateTypeForTranche(contract.t_trancheNumber, contract.t_trancheKind, contract.t_creditId)"
            + "\n" + "                   ELSE NULL"
            + "\n" + "               END AS t_rateType,"
            + "\n" + "               (SELECT rate.t_rateVal "
            + "\n" + "                  FROM repLnsRateHistory_vw rate "
            + "\n" + "                 WHERE rate.t_tariffKind = 1"
            + "\n" + "                   AND rate.t_objectNumber = contract.t_trancheNumber"
            + "\n" + "                   AND rate.t_objectId = contract.t_trancheKind"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate) "
            + "\n" + "                                            FROM repLnsRateHistory_vw r "
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber "
            + "\n" + "                                             AND r.t_objectId = rate.t_objectId "
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() "
            + "\n" + "                                             AND r.t_tariffKind = rate.t_tariffKind) "
            + "\n" + "               ) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_issueSum,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               chr(1) t_account,"
            + "\n" + "               contract.t_plannedLastRepaymentDate,"
            + "\n" + "               contract.t_trancheNumber,"
            + "\n" + "               contract.t_trancheKind,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM contract"
            + "\n" + "        )data)");
     end;

    macro cacheData(filter : RcbDataSourceFilter)
        cacheMainRowData(filter);
        cacheAddRowsData(filter);
    end;
end;

class (TF303Part3DataSource_4212) TF303Part3DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part3DataSource_4212(protocolView, dataSources);

    macro cacheMainRowData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_TYPERATEENDDATE,"
            + "\n" + "                         T_TYPEFLOATRATEENDDATE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         t_addLine)"

            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_TYPERATEENDDATE,"
            + "\n" + "       T_TYPEFLOATRATEENDDATE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       0"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                   WHEN data.t_type = " + LO_OVERDRAFT
            + "\n" + "                     THEN '1.2'"
            + "\n" + "                   WHEN data.t_type = " + LO_KARTA
            + "\n" + "                     THEN '1.6'"
            + "\n" + "                   WHEN ((data.t_type = " + LO_CREDIT + ") AND (EXISTS(SELECT 1 "
            + "\n" + "                                                                         FROM df303accounts_tmp acc"
            + "\n" + "                                                                        WHERE acc.t_creditId = data.t_creditId "
            + "\n" + "                                                                          AND acc.t_typeAccount = 'С'"
            + "\n" + "                                                                          AND " + convertMaskToSqlFormat(accountMasks, "acc.t_cbAccount") + ")))"
            + "\n" + "                     THEN '1.9'"
            + "\n" + "                   ELSE '1.1'"
            + "\n" + "                END"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_issueType = 5" // под лимит задолженности
            + "\n" + "                      THEN '1.3'"
            + "\n" + "                    WHEN data.t_issueType = 4" // невозобновляемая КЛ
            + "\n" + "                      THEN '1.4'"
            + "\n" + "                    WHEN data.t_issueType = 3" // лимит выдачи + задолженности
            + "\n" + "                      THEN '1.5'"
            + "\n" + "                 END"
            + "\n" + "          WHEN data.t_isCession = 1"
            + "\n" + "                      THEN '5'"
            + "\n" + "       END AS t_typeLoan,"
            + "\n" + "       data.t_purple AS t_purposeCredit,"
            + "\n" + "       data.t_contractAmount AS t_sumOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_conversionsCount > 0"
            + "\n" + "            THEN data.t_contractAmountWithChanges"
            + "\n" + "          ELSE"
            + "\n" + "            data.t_contractAmount"
            + "\n" + "       END AS t_sumChangesContract,"
            + "\n" + "       DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid)) AS t_ficodeOrigContract,"
            + "\n" + "       DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid)) AS t_ficodeChangesContract,"
            + "\n" + "       data.t_firstContractEndDate AS t_dateOrigContract,"
            + "\n" + "       data.t_finishDate AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_rateType = 1"
            + "\n" + "            THEN 'Ф'"
            + "\n" + "          WHEN data.t_rateType = 2"
            + "\n" + "            THEN 'П'"
            + "\n" + "          WHEN data.t_rateType = 3"
            + "\n" + "            THEN 'М'"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateValFirstIssuance"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid AND ROWNUM < 2)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END  AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCredit = 1 OR data.t_isCession = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_rateVal"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                     WHERE rate.t_tariffKind = 29 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                       AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 29))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateLoan,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_periodFix"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                                FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_interestPeriod,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                               FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid "
            + "\n" + "                                                 AND r.t_rateDate <= (SELECT MIN (tr.t_firstIssueDate) FROM df303tranches_tmp tr WHERE tr.t_creditId = data.t_creditId)"
            + "\n" + "                                                 AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRate,"
            + "\n" + "       data.t_specCondCredit t_conditionCode,"
            + "\n" + "       CHR(1) t_creditIdCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_rateTypeEndDate = 1"
            + "\n" + "            THEN 'Ф'"
            + "\n" + "          WHEN data.t_rateTypeEndDate = 2"
            + "\n" + "            THEN 'П'"
            + "\n" + "          WHEN data.t_rateTypeEndDate = 3"
            + "\n" + "            THEN 'М'"
            + "\n" + "         ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRateEndDate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 0"
            + "\n" + "            THEN (SELECT rate.t_typeCompFloatRate"
            + "\n" + "                     FROM repLnsRateHistory_vw rate"
            + "\n" + "                    WHERE rate.t_tariffKind = 1 AND data.t_creditId = rate.t_objectNumber AND data.t_type = rate.t_objectid"
            + "\n" + "                      AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                               FROM repLnsRateHistory_vw r"
            + "\n" + "                                               WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid "
            + "\n" + "                                                 AND r.t_rateDate <= rep_data.getEndDate()"
            + "\n" + "                                                 AND r.t_tariffKind = 1))"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_typeFloatRateEndDate,"
            + "\n" + "       CHR(1) t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               rcb_f303.getRateTypeForCredit(contract.t_creditId, contract.t_type, (SELECT MIN (tr.t_firstIssueDate) FROM df303tranches_tmp tr WHERE tr.t_creditId = contract.t_creditId)) AS t_rateType,"
            + "\n" + "               rcb_f303.getRateTypeForCredit(contract.t_creditId, contract.t_type) AS t_rateTypeEndDate,"
            + "\n" + "               (SELECT rate.t_rateVal"
            + "\n" + "                  FROM repLnsRateHistory_vw rate"
            + "\n" + "                 WHERE rate.t_tariffKind = 1 AND contract.t_creditId = rate.t_objectNumber AND contract.t_type = rate.t_objectid"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                            FROM repLnsRateHistory_vw r"
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_type,"
            + "\n" + "               contract.t_issueType,"
            + "\n" + "               contract.t_contractAmount,"
            + "\n" + "               contract.t_contractAmountWithChanges,"
            + "\n" + "               contract.t_rightsOfClaimContractId,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_purple,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               contract.t_specCondCredit,"
            + "\n" + "               contract.t_creditId  AS t_trancheNumber,"
            + "\n" + "               contract.t_isCredit,"
            + "\n" + "               contract.t_isCession,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM df303contracts_tmp contract"
            + "\n" + "       ) data"
            + "\n" + "      )");
    end;

    /* Дополнительные строки */
    macro cacheAddRowsData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p3_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPELOAN,"
            + "\n" + "                         T_PURPOSECREDIT,"
            + "\n" + "                         T_SUMORIGCONTRACT,"
            + "\n" + "                         T_SUMCHANGESCONTRACT,"
            + "\n" + "                         T_FICODEORIGCONTRACT,"
            + "\n" + "                         T_FICODECHANGESCONTRACT,"
            + "\n" + "                         T_DATEORIGCONTRACT,"
            + "\n" + "                         T_DATECHANGESCONTRACT,"
            + "\n" + "                         T_TYPERATE,"
            + "\n" + "                         T_RATEORIGCONTRACT,"
            + "\n" + "                         T_RATECHANGESCONTRACT,"
            + "\n" + "                         T_RATELOAN,"
            + "\n" + "                         T_INTERESTPERIOD,"
            + "\n" + "                         T_TYPEFLOATRATE,"
            + "\n" + "                         T_CONDITIONCODE,"
            + "\n" + "                         T_CREDITIDCODE,"
            + "\n" + "                         T_TYPERATEENDDATE,"
            + "\n" + "                         T_TYPEFLOATRATEENDDATE,"
            + "\n" + "                         T_ACCOUNT,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "WITH contract AS ("
            + "\n" + "                  SELECT credit.t_creditId AS t_creditId,          "
            + "\n" + "                         credit.t_isCreditLine AS t_isCreditLine,  "
            + "\n" + "                         tranche.t_trancheKind AS t_trancheKind,   "
            + "\n" + "                         tranche.t_trancheNumber t_trancheNumber , "
            + "\n" + "                         tranche.t_fiid AS t_fiId,                 "
            + "\n" + "                         (SELECT tr.t_issueSum FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind and rownum < 2) t_issueSum,                      "
            + "\n" + "                         tranche.t_plannedLastRepaymentDate,       "
            + "\n" + "                         tranche.t_firstIssueDate,                 "
            + "\n" + "                         credit.t_conversionsCount,                "
            + "\n" + "                         credit.t_firstContractEndDate,            "
            + "\n" + "                         credit.t_finishDate                       "
            + "\n" + "                  FROM df303contracts_tmp credit,                  "
            + "\n" + "                       df303tranches_tmp tranche                   "
            + "\n" + "                  WHERE credit.t_creditId = tranche.t_creditId     "
            + "\n" + "                    AND credit.t_isCreditLine = 1                  "
            + "\n" + "                  )"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TYPELOAN,"
            + "\n" + "       T_PURPOSECREDIT,"
            + "\n" + "       T_SUMORIGCONTRACT,"
            + "\n" + "       T_SUMCHANGESCONTRACT,"
            + "\n" + "       T_FICODEORIGCONTRACT,"
            + "\n" + "       T_FICODECHANGESCONTRACT,"
            + "\n" + "       T_DATEORIGCONTRACT,"
            + "\n" + "       T_DATECHANGESCONTRACT,"
            + "\n" + "       T_TYPERATE,"
            + "\n" + "       T_RATEORIGCONTRACT,"
            + "\n" + "       T_RATECHANGESCONTRACT,"
            + "\n" + "       T_RATELOAN,"
            + "\n" + "       T_INTERESTPERIOD,"
            + "\n" + "       T_TYPEFLOATRATE,"
            + "\n" + "       T_CONDITIONCODE,"
            + "\n" + "       T_CREDITIDCODE,"
            + "\n" + "       T_TYPERATEENDDATE,"
            + "\n" + "       T_TYPEFLOATRATEENDDATE,"
            + "\n" + "       T_ACCOUNT,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       1"
            + "\n" + "FROM ("
            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       NULL AS t_typeLoan,"
            + "\n" + "       CHR(1) AS t_purposeCredit,"
            + "\n" + "       data.t_issueSum AS t_sumOrigContract,"
            + "\n" + "       data.t_issueSum AS t_sumChangesContract,"
            + "\n" + "       DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid)) AS t_ficodeOrigContract,"
            + "\n" + "       DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid)) AS t_ficodeChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "         WHEN data.t_isCreditLine = 1"
            + "\n" + "           THEN CASE"
            + "\n" + "                   WHEN data.t_plannedLastRepaymentDate = data.t_firstContractEndDate"
            + "\n" + "                     THEN NULL"
            + "\n" + "                   ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                END"
            + "\n" + "        ELSE  NULL"
            + "\n" + "       END AS t_dateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_plannedLastRepaymentDate = data.t_finishDate"
            + "\n" + "                      THEN NULL"
            + "\n" + "                    ELSE data.t_plannedLastRepaymentDate"
            + "\n" + "                 END"
            + "\n" + "            ELSE NULL"
            + "\n" + "       END AS t_dateChangesContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1 "
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_rateType = 1"
            + "\n" + "                      THEN 'Ф'"
            + "\n" + "                    WHEN data.t_rateType = 2"
            + "\n" + "                      THEN 'П'"
            + "\n" + "                    WHEN data.t_rateType = 3"
            + "\n" + "                      THEN 'М'"
            + "\n" + "                    ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRate,"
            + "\n" + "       (SELECT rate.t_rateValFirstIssuance"
            + "\n" + "          FROM repLnsRateHistory_vw rate"
            + "\n" + "         WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber"
            + "\n" + "           AND data.t_trancheKind = rate.t_objectid AND ROWNUM < 2) AS t_rateOrigContract,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1"
            + "\n" + "            THEN NVL(data.t_rateVal, NULL)"
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_rateChangesContract,"
            + "\n" + "       (SELECT rate.t_rateVal"
            + "\n" + "          FROM repLnsRateHistory_vw rate"
            + "\n" + "         WHERE rate.t_tariffKind = 29 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "           AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                    FROM repLnsRateHistory_vw r WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                     AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_rateLoan,"
            + "\n" + "       (SELECT rate.t_periodFix"
            + "\n" + "          FROM repLnsRateHistory_vw rate"
            + "\n" + "         WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "           AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                    FROM repLnsRateHistory_vw r"
            + "\n" + "                                   WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                     AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_interestPeriod,"
            + "\n" + "       (SELECT rate.t_typeCompFloatRate"
            + "\n" + "          FROM repLnsRateHistory_vw rate"
            + "\n" + "         WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "           AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                    FROM repLnsRateHistory_vw r"
            + "\n" + "                                   WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                     AND r.t_rateDate <= data.t_firstIssueDate AND r.t_tariffKind = rate.t_tariffKind)) AS t_typeFloatRate,"
            + "\n" + "       CHR(1) AS t_conditionCode,"
            + "\n" + "       CHR(1) AS t_creditIdCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isCreditLine = 1 "
            + "\n" + "            THEN CASE"
            + "\n" + "                    WHEN data.t_rateTypeEndDate = 1"
            + "\n" + "                      THEN 'Ф'"
            + "\n" + "                    WHEN data.t_rateTypeEndDate = 2"
            + "\n" + "                      THEN 'П'"
            + "\n" + "                    WHEN data.t_rateTypeEndDate = 3"
            + "\n" + "                      THEN 'М'"
            + "\n" + "                    ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END  AS t_typeRateEndDate,"
            + "\n" + "       (SELECT rate.t_typeCompFloatRate"
            + "\n" + "          FROM repLnsRateHistory_vw rate"
            + "\n" + "         WHERE rate.t_tariffKind = 1 AND data.t_trancheNumber = rate.t_objectNumber AND data.t_trancheKind = rate.t_objectid"
            + "\n" + "           AND rate.t_rateDate = (SELECT MAX(r.t_rateDate)"
            + "\n" + "                                    FROM repLnsRateHistory_vw r"
            + "\n" + "                                   WHERE r.t_objectNumber = rate.t_objectNumber AND r.t_objectid = rate.t_objectid"
            + "\n" + "                                     AND r.t_rateDate <= rep_data.getEndDate() AND r.t_tariffKind = rate.t_tariffKind)) AS t_typeFloatRateEndDate,"
            + "\n" + "       data.t_account,"
            + "\n" + "       data.t_trancheNumber"
/********************************атрибуты пока не рассчитываются (будут вводиться запросы */
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               rcb_f303.getRateTypeForTranche(contract.t_trancheNumber, contract.t_trancheKind, contract.t_creditId, contract.t_firstIssueDate) AS t_rateType,"
            + "\n" + "               rcb_f303.getRateTypeForTranche(contract.t_trancheNumber, contract.t_trancheKind, contract.t_creditId) AS t_rateTypeEndDate,"
            + "\n" + "               (SELECT rate.t_rateVal "
            + "\n" + "                  FROM repLnsRateHistory_vw rate "
            + "\n" + "                 WHERE rate.t_tariffKind = 1"
            + "\n" + "                   AND rate.t_objectNumber = contract.t_trancheNumber"
            + "\n" + "                   AND rate.t_objectId = contract.t_trancheKind"
            + "\n" + "                   AND rate.t_rateDate = (SELECT MAX(r.t_rateDate) "
            + "\n" + "                                            FROM repLnsRateHistory_vw r "
            + "\n" + "                                           WHERE r.t_objectNumber = rate.t_objectNumber "
            + "\n" + "                                             AND r.t_objectId = rate.t_objectId "
            + "\n" + "                                             AND r.t_rateDate <= rep_data.getEndDate() "
            + "\n" + "                                             AND r.t_tariffKind = rate.t_tariffKind) "
            + "\n" + "               ) AS t_rateVal,"
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_firstIssueDate,"
            + "\n" + "               contract.t_fiid,"
            + "\n" + "               contract.t_issueSum,"
            + "\n" + "               contract.t_firstContractEndDate,"
            + "\n" + "               contract.t_finishDate,"
            + "\n" + "               contract.t_conversionsCount,"
            + "\n" + "               chr(1) t_account,"
            + "\n" + "               contract.t_plannedLastRepaymentDate,"
            + "\n" + "               contract.t_trancheNumber,"
            + "\n" + "               contract.t_trancheKind,"
            + "\n" + "               contract.t_isCreditLine"
            + "\n" + "          FROM contract"
            + "\n" + "        )data)");
     end;
end;

class (RcbDataSource) TF303Part4DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p4_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p4_tmp (T_CREDITID,"
            + "\n" + "                         T_TYPESECURITY,"
            + "\n" + "                         T_SUMFIRSTQUALITY,"
            + "\n" + "                         T_SUMSECONDQUALITY,"
            + "\n" + "                         T_SUMSECURITIESRESERVE,"
            + "\n" + "                         T_TYPEINSURANCE)"

            + "\n" + "SELECT data.t_creditId                      AS t_creditId,"
            + "\n" + "       data.t_typeSecurity                  AS t_typeSecurity,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE NVL(SUM(data.t_sumFirstQuality), 0)"
            + "\n" + "       END                                  AS t_sumFirstQuality,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE NVL(SUM(data.t_sumSecondQuality), 0)"
            + "\n" + "       END                                  AS t_sumSecondQuality,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE NVL(SUM(data.t_sumSecuritiesReserve), 0)"
            + "\n" + "       END                                  AS t_sumSecuritiesReserve,"
            + "\n" + "       data.t_typeInsurance                 AS t_typeInsurance"
            + "\n" + "    FROM ("
            + "\n" + "          SELECT contract.t_creditId            AS t_creditId,"
            + "\n" + "                 NVL(guaranty.t_ensureKind, 0)  AS t_typeSecurity,"
            + "\n" + "                 DECODE(guaranty.t_rvpsGuarantyCoeffitient, 1, guaranty.t_roubleReserveSum, 0) AS t_sumFirstQuality,"
            + "\n" + "                 DECODE(guaranty.t_rvpsGuarantyCoeffitient, 0.5, guaranty.t_roubleReserveSum, 0) AS t_sumSecondQuality,"
            + "\n" + "                 guaranty.t_roubleReserveSum * guaranty.t_rvpsGuarantyCoeffitient          AS t_sumSecuritiesReserve,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                      THEN contract.t_insuranceKind"
            + "\n" + "                    ELSE 0"
            + "\n" + "                 END AS t_typeInsurance,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN EXISTS (SELECT 1"
            + "\n" + "                                   FROM repLnsCase_vw case"
            + "\n" + "                                  WHERE case.t_id = contract.t_briefCaseId AND case.t_type = 1)"
            + "\n" + "                      THEN 1"
            + "\n" + "                    ELSE 0"
            + "\n" + "                 END AS t_isIncludedInCase"
            + "\n" + "            FROM df303contracts_tmp contract LEFT JOIN repLnsGuaranty_vw guaranty ON (contract.t_creditId = guaranty.t_contractId)"
            + "\n" + "           WHERE contract.t_isRepaidLoan = 0 AND (guaranty.t_rvpsGuarantyCoeffitient IN (0.5, 1) OR contract.t_insuranceKind != 0)"
            + "\n" + "         ) data"
            + "\n" + "GROUP BY (data.t_creditId, data.t_typeSecurity, data.t_typeInsurance, data.t_isIncludedInCase)");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p4_tmp p4";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;

    private macro constructorF303Part4DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("4", protocolView, dataSources);
    end;

    constructorF303Part4DataSource(protocolView, dataSources);
end;

class (TF303Part4DataSource) TF303Part4DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p4_tmp (T_CREDITID,"
            + "\n" + "                                      T_TYPESECURITY,"
            + "\n" + "                                      T_SUMSECURITIES,"
            + "\n" + "                                      T_REPOSSESSIONDATE,"
            + "\n" + "                                      T_SUMSECURITIESRESERVE,"
            + "\n" + "                                      T_TYPEINSURANCE,"
            + "\n" + "                                      T_SECURITIESRVPPERCENT,"
            + "\n" + "                                      T_SECURITIESRVPOBLIGATIONS,"
            + "\n" + "                                      T_ADDLINE)"

            + "\n" + "SELECT contract.t_creditId      AS t_creditId,"
            + "\n" + "       0                        AS t_typeSecurity,"
            + "\n" + "       NULL                     AS t_sumSecurities,"
            + "\n" + "       NULL                     AS t_repossessionDate,"
            + "\n" + "       NULL                     AS t_sumSecuritiesReserve,"
            + "\n" + "       contract.t_insuranceKind AS t_typeInsurance,"
            + "\n" + "       NULL                     AS t_securitiesRrvpPercent,"
            + "\n" + "       NULL                     AS t_securitiesRvpObligations,"
            + "\n" + "       0                        AS t_addLine"
            + "\n" + "  FROM df303contracts_tmp contract "
            + "\n" + " WHERE contract.t_isRepaidLoan = 0");

        sql_execute( "INSERT /*+ APPEND*/ INTO df303p4_tmp (T_CREDITID,"
            + "\n" + "                                      T_TYPESECURITY,"
            + "\n" + "                                      T_SUMSECURITIES,"
            + "\n" + "                                      T_REPOSSESSIONDATE,"
            + "\n" + "                                      T_SUMSECURITIESRESERVE,"
            + "\n" + "                                      T_TYPEINSURANCE,"
            + "\n" + "                                      T_SECURITIESRVPPERCENT,"
            + "\n" + "                                      T_SECURITIESRVPOBLIGATIONS,"
            + "\n" + "                                      T_ADDLINE)"

            + "\n" + "SELECT data.t_creditId                                  AS t_creditId,"
            + "\n" + "       data.t_typeSecurity                              AS t_typeSecurity,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE SUM(data.t_sumSecurities)"
            + "\n" + "       END                                              AS t_sumSecurities,"
            + "\n" + "       MIN(data.t_repossessionDate)                     AS t_repossessionDate,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE "
            + "\n" + "             CASE "
            + "\n" + "                WHEN data.t_allSumSecuritiesReserve != 0 "
            + "\n" + "                   THEN data.t_sumSecuritiesReserve * SUM(NVL(data.t_roubleReserveSum, 0)) / data.t_allSumSecuritiesReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END"
            + "\n" + "       END                                              AS t_sumSecuritiesReserve,"
            + "\n" + "       NULL                                             AS t_typeInsurance,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE "
            + "\n" + "             CASE "
            + "\n" + "                WHEN data.t_allSumSecuritiesReserve != 0 "
            + "\n" + "                   THEN data.t_securitiesRrvpPercent * SUM(NVL(data.t_roubleReserveSum, 0)) / data.t_allSumSecuritiesReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END"
            + "\n" + "       END                                              AS t_securitiesRrvpPercent,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_isIncludedInCase = 1"
            + "\n" + "            THEN NULL"
            + "\n" + "          ELSE "
            + "\n" + "             CASE "
            + "\n" + "                WHEN data.t_allSumSecuritiesReserve != 0 "
            + "\n" + "                   THEN data.t_securitiesRvpObligations * SUM(NVL(data.t_roubleReserveSum, 0)) / data.t_allSumSecuritiesReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END"
            + "\n" + "       END                                              AS t_securitiesRvpObligations, "
            + "\n" + "       DENSE_RANK() OVER(PARTITION BY data.t_creditId ORDER BY data.t_creditId, data.t_typeSecurity) AS t_addLine"
            + "\n" + "    FROM ("
            + "\n" + "          SELECT contract.t_creditId                    AS t_creditId,"
            + "\n" + "                 NVL(guaranty.t_ensureKindByQuality, 0) AS t_typeSecurity,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN guaranty.t_roubleMarketSum != 0"
            + "\n" + "                      THEN guaranty.t_roubleMarketSum"
            + "\n" + "                    ELSE guaranty.t_roubleRatingSum"
            + "\n" + "                 END                                    AS t_sumSecurities,"
            + "\n" + "                 guaranty.t_dateGroundRecovery          AS t_repossessionDate,"
            + "\n" + "                 contract.t_securitySumReservePrincipal AS t_sumSecuritiesReserve,"
            + "\n" + "                 guaranty.t_roubleReserveSum            AS t_roubleReserveSum,"
            + "\n" + "                 NVL((SELECT SUM(g.t_roubleReserveSum)"
            + "\n" + "                        FROM repLnsGuaranty_vw g"
            + "\n" + "                       WHERE g.t_contractId = contract.t_creditId), 0) AS t_allSumSecuritiesReserve,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY')"
            + "\n" + "                      THEN contract.t_securitySumReservePercent"
            + "\n" + "                    ELSE NULL"
            + "\n" + "                 END                                    AS t_securitiesRrvpPercent,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY')"
            + "\n" + "                      THEN contract.t_securitySumReserveDebt"
            + "\n" + "                    ELSE NULL"
            + "\n" + "                 END                                    AS t_securitiesRvpObligations,"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN EXISTS (SELECT 1"
            + "\n" + "                                   FROM repLnsCase_vw case"
            + "\n" + "                                  WHERE case.t_id = contract.t_briefCaseId AND case.t_type = 1)"
            + "\n" + "                      THEN 1"
            + "\n" + "                    ELSE 0"
            + "\n" + "                 END AS t_isIncludedInCase"
            + "\n" + "            FROM df303contracts_tmp contract LEFT JOIN repLnsGuaranty_vw guaranty ON (contract.t_creditId = guaranty.t_contractId)"
            + "\n" + "           WHERE contract.t_isRepaidLoan = 0 "
            + "\n" + "         ) data"
            + "\n" + " GROUP BY (data.t_creditId, data.t_typeSecurity, data.t_isIncludedInCase, data.t_sumSecuritiesReserve, data.t_securitiesRrvpPercent, data.t_securitiesRvpObligations)");

    end;

    private macro constructorTF303Part4DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTF303Part4DataSource(protocolView, dataSources);
    end;

    constructorTF303Part4DataSource_4637(protocolView, dataSources);
end;

class (RcbDataSource) TF303Part5DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p5_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p5_tmp (T_CREDITID,"
            + "\n" + "                         T_DATELOAN,             "
            + "\n" + "                         T_TRANCHENUMBER,        "
            + "\n" + "                         T_TRANCHEKIND,          "
            + "\n" + "                         T_USERTRANCHENUMBER,    "
            + "\n" + "                         T_FUNDS,                "
            + "\n" + "                         T_FICODE,               "
            + "\n" + "                         T_OKATO,                "
            + "\n" + "                         T_ADDLINE)              "
            + "\n" + "SELECT                                                                                                                  "
            + "\n" + "       contract.t_creditId,                                                                                             "
            + "\n" + "       CASE                                                                                                             "
            + "\n" + "          WHEN contract.t_isCredit = 1                                                                                  "
            + "\n" + "            THEN CASE                                                                                                   "
            + "\n" + "                    WHEN contract.t_type IN(22, 8)                                                                      "
            + "\n" + "                      THEN (SELECT MIN(op.t_date)                                                                       "
            + "\n" + "                              FROM repLnsOperation_vw op                                                                "
            + "\n" + "                             WHERE op.t_type = 2 AND contract.t_creditId = op.t_trancheNumber)                          "
            + "\n" + "                    ELSE (SELECT /* ++FIRST_ROWS*/ tranche.t_firstIssueDate                                             "
            + "\n" + "                            FROM df303tranches_tmp tranche                                                              "
            + "\n" + "                           WHERE contract.t_creditId = tranche.t_creditId                                               "
            + "\n" + "                             AND ROWNUM < 2)                                                                            "
            + "\n" + "                 END                                                                                                    "
            + "\n" + "          WHEN contract.t_isConcession = 1                                                                              "
            + "\n" + "            THEN (SELECT cession.t_contractDate FROM repLnsCession_vw cession WHERE contract.t_creditId = cession.t_id) "
            + "\n" + "       END AS t_dateLoan,                                                                                               "
            + "\n" + "       contract.t_creditId AS t_trancheNumber,                                                                          "
            + "\n" + "       NULL AS t_trancheKind,                                                                                           "
            + "\n" + "       chr(1) AS t_userTrancheNumber,                                                                                   "
            + "\n" + "       CASE                                                                                                             "
            + "\n" + "          WHEN contract.t_isCredit = 1                                                                                  "
            + "\n" + "            THEN  NVL((SELECT SUM(tr.t_firstIssueSum)                                                                   "
            + "\n" + "                         FROM df303tranches_tmp tr                                                                      "
            + "\n" + "                        WHERE tr.t_creditId = contract.t_creditId), 0)                                                  "
            + "\n" + "          WHEN contract.t_isCession = 1                                                                                 "
            + "\n" + "            THEN contract.t_sumFactCostAcq                                                                              "
            + "\n" + "          ELSE 0                                                                                                        "
            + "\n" + "       END AS t_funds,                                                                                                  "
            + "\n" + "       CASE                                                                                                             "
            + "\n" + "          WHEN contract.t_isCredit = 1 OR  contract.t_isConcession = 1                                                  "
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = contract.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = contract.t_fiid))"
            + "\n" + "          ELSE CHR(0)                                                                                                   "
            + "\n" + "       END AS t_fiCode,                                                                                                 "
            + "\n" + "       RPAD(SUBSTR(LoansVOX.GetOkatoTsOpenDep(contract.t_creditId, rep_data.getEndDate()), 1, 5), 5, '0') AS t_okato,   "
            + "\n" + "       0   AS t_addLine                                                                                                 "
            + "\n" + "  FROM df303contracts_tmp contract                                                                                      "
            + "\n" + " WHERE contract.t_isCreditLine = 0 ");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p5_tmp (T_CREDITID,"
            + "\n" + "                         T_DATELOAN,             "
            + "\n" + "                         T_TRANCHENUMBER,        "
            + "\n" + "                         T_TRANCHEKIND,          "
            + "\n" + "                         T_USERTRANCHENUMBER,    "
            + "\n" + "                         T_FUNDS,                "
            + "\n" + "                         T_FICODE,               "
            + "\n" + "                         T_OKATO,                "
            + "\n" + "                         T_ADDLINE)              "
            + "\n" + "SELECT contract.t_creditId,                                                                    "
            + "\n" + "       tranche.t_firstIssueDate AS t_dateLoan,                                                 "
            + "\n" + "       tranche.t_trancheNumber AS t_trancheNumber,                                             "
            + "\n" + "       tranche.t_trancheKind AS t_trancheKind,                                                 "
            + "\n" + "       tranche.t_userTrancheNumber AS t_userTrancheNumber,                                     "
            + "\n" + "       NVL(tranche.t_firstIssueSum, 0) AS t_funds,                      "
            + "\n" + "       DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = tranche.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = tranche.t_fiid)) AS t_fiCode,"
            + "\n" + "       RPAD(SUBSTR(LoansVOX.GetOkatoTsOpenDep(contract.t_creditId, rep_data.getEndDate()), 1, 5), 5, '0') AS t_okato,"
            + "\n" + "       1 AS t_addLine                                                                          "
            + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche                                  "
            + "\n" + "WHERE contract.t_creditId = tranche.t_creditId AND contract.t_isCreditLine = 1");

    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p5_tmp p5";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_DATELOAN", V_DATE);

        return dataSet;
    end;

    private macro constructorF303Part5DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("5", protocolView, dataSources);
    end;

    constructorF303Part5DataSource(protocolView, dataSources);
end;

class (RcbDataSource) TF303Part6DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p6_tmp");
    end;

    macro getRegistrySum(register, trancheKindAlias, trancheNumberAlias)
        return " NVL((SELECT RSI_RSB_FIINSTR.ConvSum(ABS(SUM(dutyrest.t_restSum)), " + SubStr(trancheKindAlias,1,Index(trancheKindAlias,".") - 1) + ".t_fiid, 0, rep_data.getEndDate()) "
         + "\n" + "FROM DDUTYREST_DBT dutyrest                                                                                  "
         + "\n" + "  WHERE dutyrest.t_id_ref = (SELECT lcreg.t_id                                                               "
         + "\n" + "                              FROM dlcusreg_dbt lcreg                                                        "
         + "\n" + "                             WHERE lcreg.t_objectTypeId = " + trancheKindAlias
         + "\n" + "                               AND lcreg.t_objectNumber = " + trancheNumberAlias
         + "\n" + "                               AND lcreg.t_regId = " + register + ")                                         "
         + "\n" + "   AND DUTYREST.T_RESTDATE = (SELECT MAX(rest.t_restDate)                                                    "
         + "\n" + "                                FROM DDUTYREST_DBT rest                                                      "
         + "\n" + "                               WHERE rest.t_id_ref = (SELECT lcreg.t_id                                      "
         + "\n" + "                                                            FROM dlcusreg_dbt lcreg                          "
         + "\n" + "                                                           WHERE lcreg.t_objectTypeId = " + trancheKindAlias
         + "\n" + "                                                             AND lcreg.t_objectNumber = " + trancheNumberAlias
         + "\n" + "                                                             AND lcreg.t_regId = " + register + ")           "
         + "\n" + "                                 AND rest.t_restDate <= rep_data.getEndDate()) ), 0)";
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       0 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_sumOverDebt > 0"
            + "\n" + "                  THEN data.t_arrearsAccount"
            + "\n" + "                ELSE chr(1)"
            + "\n" + "             END t_arrearsAccount,"
            + "\n" + "             data.t_sumTermDebt AS t_sumTermDebt,"
            + "\n" + "             data.t_sumOverDebt AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_iscreditLine = 0"
            + "\n" + "                         THEN data.t_sumCalcReserveSecurity"
            + "\n" + "                       ELSE NULL"
            + "\n" + "                    END"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN "
            + "\n" + "                           CASE"
            + "\n" + "                             WHEN data.t_qualitycategoryraisingdate <= rep_data.getEndDate() AND (NOT NVL(data.t_isqualitycategoryraising, '') = '') "
            + "\n" + "                               THEN "
            + "\n" + "                                 CASE"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate >= rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1.1', '3.14.3', '2.1', '3.12', '3.1', '3.12.2', '5', '0')"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate < rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1', '3.14.3', '2', '3.12', '3', '3.12.2', '5', '0')"
            + "\n" + "                                   ELSE "
            + "\n" + "                                     CASE"
            + "\n" + "                                       WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                         THEN '4'"
            + "\n" + "                                       ELSE '0'"
            + "\n" + "                                     END"
            + "\n" + "                                 END"
            + "\n" + "                             ELSE "
            + "\n" + "                               CASE"
            + "\n" + "                                 WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                   THEN '4'"
            + "\n" + "                                 ELSE '0'"
            + "\n" + "                               END"
            + "\n" + "                           END"
            + "\n" + "                    END"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_tranchenumber,"
            + "\n" + "             data.t_loansTermAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_loansArrearsAccount AS t_loansArrearsAccount"
            + "\n" + "      FROM ("
            + "\n" + "            SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                   END AS t_termDebtAccount,"
            + "\n" + "                   CASE"
            + "\n" + "                       WHEN contract.t_isCreditLine = 0"
            + "\n" + "                           THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                       ELSE NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = contract.t_type AND acc.t_trancheNumber = contract.t_creditId  and rownum < 2), CHR(1))"
            + "\n" + "                   END AS t_arrearsAccount,"
            + "\n" + "                   CASE"
            + "\n" + "                       WHEN contract.t_isCreditLine = 0"
            + "\n" + "                           THEN NVL(" + getRegistrySum(1, "contract.t_type", "contract.t_creditId") + ", 0)"
            + "\n" + "                       ELSE (SELECT SUM(" + getRegistrySum(1, "tr.t_trancheKind", "tr.t_trancheNumber") + ") FROM df303tranches_tmp tr WHERE tr.t_creditId = contract.t_creditId)"
            + "\n" + "                   END AS t_sumTermDebt,"
            + "\n" + "                   NVL((SELECT RSI_RSB_FIINSTR.ConvSum(ABS(SUM(acc.t_outRest)), contract.t_fiid, 0, rep_data.getEndDate()) FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_creditId = contract.t_creditId), 0) AS t_sumOverDebt,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN contract.t_rvpsQualityCategory"
            + "\n" + "                      ELSE NULL"
            + "\n" + "                   END            AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN contract.t_rvpsReservePercent "
            + "\n" + "                      ELSE NULL"
            + "\n" + "                   END  AS t_calcReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_rvpsSum"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                      ELSE  (SELECT (t_rvpsSum + t_rvpSum + t_delayedRvpsSum)"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                   END    AS t_sumFormedReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_calcRvpsSum"
            + "\n" + "                                FROM repLnsReserve_vw reserve"
            + "\n" + "                               WHERE reserve.t_objectNumber = contract.t_creditId"
            + "\n" + "                                 AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                        ELSE NULL"
            + "\n" + "                   END    AS t_sumCalcReserveSecurity,"
            + "\n" + "                   (SELECT credit.t_isqualitycategoryraising FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_isqualitycategoryraising,"
            + "\n" + "                   (SELECT credit.t_qualitycategoryraisingdate FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_qualitycategoryraisingdate,"
            + "\n" + "                   (SELECT credit.t_limNoRealActiv FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_limNoRealActiv,"
            + "\n" + "                   contract.t_isCredit    AS t_isCredit,"
            + "\n" + "                   contract.t_creditId    AS t_trancheNumber,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN NVL((SELECT acc.t_account FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                   END AS t_loansTermAccount,"
            + "\n" + "                   CHR(1) AS t_loansArrearsAccount,"
            + "\n" + "                   NVL((SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_creditId = contract.t_creditId AND p5.t_addLine = 0), 0) AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isConcession    AS t_isConcession,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan"
            + "\n" + "              FROM df303contracts_tmp contract "
            + "\n" + "           ) data)");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       1 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN (data.t_arrearsAccount = chr(1) AND " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber") + " > 0 )"
            + "\n" + "                 THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = data.t_contractType AND acc.t_trancheNumber = data.t_creditId  and rownum < 2), CHR(1))"
            + "\n" + "               ELSE"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN data.t_sumOverDebt > 0"
            + "\n" + "                      THEN data.t_arrearsAccount"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "             END AS t_arrearsAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN data.t_termDebtAccount = chr(1)"
            + "\n" + "                 THEN 0"
            + "\n" + "               ELSE"
            + "\n" + "                 " + getRegistrySum(1, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "             END AS t_sumTermDebt,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_arrearsAccount = chr(1) "
            + "\n" + "                  THEN " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "                ELSE data.t_sumOverDebt"
            + "\n" + "             END AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve --LoansVox.GetValPercRezervCrd (data.t_trancheKind, data.t_trancheNumber, 1, rep_data.getEndDate())"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN data.t_sumCalcReserveSecurity"
            + "\n" + "                       ELSE NULL"
            + "\n" + "                    END"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CHR(1) AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_trancheNumber,"
            + "\n" + "             data.t_loansTermAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_loansArrearsAccount AS t_loansArrearsAccount"
            + "\n" + "      FROM ("
            + "\n" + "            SELECT contract.t_fiid AS t_fiid,"
            + "\n" + "                   contract.t_creditId AS t_creditId,"
            + "\n" + "                   contract.t_type AS t_contractType,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_termDebtAccount,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_arrearsAccount,"
            + "\n" + "                   0 AS t_sumTermDebt,"
            + "\n" + "                   NVL((SELECT RSI_RSB_FIINSTR.ConvSum(ABS(SUM(acc.t_outRest)), contract.t_fiid, 0, rep_data.getEndDate()) FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), 0) AS t_sumOverDebt,"
            + "\n" + "                   contract.t_rvpsQualityCategory AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   contract.t_rvpsReservePercent /*tranche.t_calcRvpPerc  */  AS t_calcReserve,"
            + "\n" + "                   (SELECT tr.t_CalcRVPSOD FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumCalcReserveSecurity,"
            + "\n" + "                   (SELECT tr.t_RVPSOD + tr.t_RVPSPD FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumFormedReserve,"
            + "\n" + "                   tranche.t_trancheNumber    AS t_tranchenumber,"
            + "\n" + "                   tranche.t_trancheKind    AS t_trancheKind,"
            + "\n" + "                   NVL((SELECT acc.t_account FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_loansTermAccount,"
            + "\n" + "                   CHR(1) AS t_loansArrearsAccount,"
            + "\n" + "                   (SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_trancheNumber = tranche.t_trancheNumber AND p5.t_trancheKind = tranche.t_trancheKind AND p5.t_addLine = 1)   AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan"
            + "\n" + "              FROM df303contracts_tmp contract, "
            + "\n" + "                   df303tranches_tmp tranche "
            + "\n" + "           WHERE contract.t_isCreditLine = 1"
            + "\n" + "             AND contract.t_creditId = tranche.t_creditId "
            + "\n" + "           ) data)"
            + "\n" + "WHERE t_trancheNumber IS NOT NULL");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p6_tmp p6";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;

    private macro constructorF303Part6DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("6", protocolView, dataSources);
    end;

    constructorF303Part6DataSource(protocolView, dataSources);
end;

class (TF303Part6DataSource) TF303Part6DataSource_4033(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part6DataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       0 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_sumOverDebt > 0"
            + "\n" + "                  THEN data.t_arrearsAccount"
            + "\n" + "                ELSE chr(1)"
            + "\n" + "             END t_arrearsAccount,"
            + "\n" + "             data.t_sumTermDebt AS t_sumTermDebt,"
            + "\n" + "             data.t_sumOverDebt AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_iscreditLine = 0"
            + "\n" + "                         THEN data.t_sumCalcReserveSecurity"
            + "\n" + "                       ELSE NULL"
            + "\n" + "                    END"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN "
            + "\n" + "                           CASE"
            + "\n" + "                             WHEN data.t_qualitycategoryraisingdate <= rep_data.getEndDate() AND (NOT NVL(data.t_isqualitycategoryraising, '') = '') "
            + "\n" + "                               THEN "
            + "\n" + "                                 CASE"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate >= rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1.1', '3.14.3', '2.1', '3.12', '3.1', '3.12.2', '5', '0')"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate < rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1', '3.14.3', '2', '3.12', '3', '3.12.2', '5', '0')"
            + "\n" + "                                   ELSE "
            + "\n" + "                                     CASE"
            + "\n" + "                                       WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                         THEN '4'"
            + "\n" + "                                       ELSE '0'"
            + "\n" + "                                     END"
            + "\n" + "                                 END"
            + "\n" + "                             ELSE "
            + "\n" + "                               CASE"
            + "\n" + "                                 WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                   THEN '4'"
            + "\n" + "                                 ELSE '0'"
            + "\n" + "                               END"
            + "\n" + "                           END"
            + "\n" + "                    END"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_tranchenumber,"
            + "\n" + "             data.t_loansTermAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_loansArrearsAccount AS t_loansArrearsAccount"
            + "\n" + "      FROM ("
            + "\n" + "            SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                   END AS t_termDebtAccount,"
            + "\n" + "                   CASE"
            + "\n" + "                       WHEN contract.t_isCreditLine = 0"
            + "\n" + "                           THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                       ELSE NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = contract.t_type AND acc.t_trancheNumber = contract.t_creditId  and rownum < 2), CHR(1))"
            + "\n" + "                   END AS t_arrearsAccount,"
            + "\n" + "                   CASE"
            + "\n" + "                       WHEN contract.t_isCreditLine = 0"
            + "\n" + "                           THEN NVL(" + getRegistrySum(1, "contract.t_type", "contract.t_creditId") + ", 0)"
            + "\n" + "                       ELSE (SELECT SUM(" + getRegistrySum(1, "tr.t_trancheKind", "tr.t_trancheNumber") + ") FROM df303tranches_tmp tr WHERE tr.t_creditId = contract.t_creditId)"
            + "\n" + "                   END AS t_sumTermDebt,"
            + "\n" + "                   NVL((SELECT RSI_RSB_FIINSTR.ConvSum(ABS(SUM(acc.t_outRest)), contract.t_fiid, 0, rep_data.getEndDate()) FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_creditId = contract.t_creditId), 0) AS t_sumOverDebt,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN contract.t_rvpsQualityCategory"
            + "\n" + "                      ELSE CASE"
            + "\n" + "                              WHEN (SELECT regexp_replace((LISTAGG(TO_CHAR(contract.t_rvpsQualityCategory)) WITHIN GROUP (order by tr.t_creditId)), '(.)\\1+','')"
            + "\n" + "                                      FROM df303tranches_tmp tr"
            + "\n" + "                                     WHERE contract.t_creditId = tr.t_creditId AND tr.t_trancheKind <> 1) IS NULL"
            + "\n" + "                                THEN contract.t_rvpsQualityCategory"
            + "\n" + "                              ELSE NULL"
            + "\n" + "                           END"
            + "\n" + "                   END            AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN contract.t_rvpsReservePercent "
            + "\n" + "                      ELSE NULL"
            + "\n" + "                   END  AS t_calcReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_rvpsSum"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                      ELSE  (SELECT (t_rvpsSum + t_rvpSum + t_delayedRvpsSum)"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                   END    AS t_sumFormedReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_calcRvpsSum"
            + "\n" + "                                FROM repLnsReserve_vw reserve"
            + "\n" + "                               WHERE reserve.t_objectNumber = contract.t_creditId"
            + "\n" + "                                 AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                        ELSE NULL"
            + "\n" + "                   END    AS t_sumCalcReserveSecurity,"
            + "\n" + "                   (SELECT credit.t_isqualitycategoryraising FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_isqualitycategoryraising,"
            + "\n" + "                   (SELECT credit.t_qualitycategoryraisingdate FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_qualitycategoryraisingdate,"
            + "\n" + "                   (SELECT credit.t_limNoRealActiv FROM repLnsContract_vw credit WHERE credit.t_id = contract.t_creditId) AS t_limNoRealActiv,"
            + "\n" + "                   contract.t_isCredit    AS t_isCredit,"
            + "\n" + "                   contract.t_creditId    AS t_trancheNumber,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN NVL((SELECT acc.t_account FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_creditId = contract.t_creditId AND ROWNUM < 2), CHR(1))"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                   END AS t_loansTermAccount,"
            + "\n" + "                   CHR(1) AS t_loansArrearsAccount,"
            + "\n" + "                   NVL((SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_creditId = contract.t_creditId AND p5.t_addLine = 0), 0) AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isConcession    AS t_isConcession,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan"
            + "\n" + "              FROM df303contracts_tmp contract "
            + "\n" + "           ) data)");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       1 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN (data.t_arrearsAccount = chr(1) AND " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber") + " > 0 )"
            + "\n" + "                 THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = data.t_contractType AND acc.t_trancheNumber = data.t_creditId  and rownum < 2), CHR(1))"
            + "\n" + "               ELSE"
            + "\n" + "                 CASE"
            + "\n" + "                    WHEN data.t_sumOverDebt > 0"
            + "\n" + "                      THEN data.t_arrearsAccount"
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                 END"
            + "\n" + "             END AS t_arrearsAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN data.t_termDebtAccount = chr(1)"
            + "\n" + "                 THEN 0"
            + "\n" + "               ELSE"
            + "\n" + "                 " + getRegistrySum(1, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "             END AS t_sumTermDebt,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_arrearsAccount = chr(1) "
            + "\n" + "                  THEN " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "                ELSE data.t_sumOverDebt"
            + "\n" + "             END AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve --LoansVox.GetValPercRezervCrd (data.t_trancheKind, data.t_trancheNumber, 1, rep_data.getEndDate())"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN data.t_sumCalcReserveSecurity"
            + "\n" + "                       ELSE NULL"
            + "\n" + "                    END"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CHR(1) AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_trancheNumber,"
            + "\n" + "             data.t_loansTermAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_loansArrearsAccount AS t_loansArrearsAccount"
            + "\n" + "      FROM ("
            + "\n" + "            SELECT contract.t_fiid AS t_fiid,"
            + "\n" + "                   contract.t_creditId AS t_creditId,"
            + "\n" + "                   contract.t_type AS t_contractType,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_termDebtAccount,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_arrearsAccount,"
            + "\n" + "                   0 AS t_sumTermDebt,"
            + "\n" + "                   NVL((SELECT RSI_RSB_FIINSTR.ConvSum(ABS(SUM(acc.t_outRest)), contract.t_fiid, 0, rep_data.getEndDate()) FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), 0) AS t_sumOverDebt,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN (SELECT regexp_replace((LISTAGG(TO_CHAR(contract.t_rvpsQualityCategory)) WITHIN GROUP (order by tr.t_creditId)), '(.)\\1+','')"
            + "\n" + "                              FROM df303tranches_tmp tr"
            + "\n" + "                             WHERE contract.t_creditId = tr.t_creditId AND tr.t_trancheKind <> 1) IS NULL"
            + "\n" + "                         THEN NULL"
            + "\n" + "                      ELSE contract.t_rvpsQualityCategory"
            + "\n" + "                   END AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   contract.t_rvpsReservePercent /*tranche.t_calcRvpPerc */   AS t_calcReserve,"
            + "\n" + "                   (SELECT tr.t_CalcRVPSOD FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumCalcReserveSecurity,"
            + "\n" + "                   (SELECT tr.t_RVPSOD + tr.t_RVPSPD FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumFormedReserve,"
            + "\n" + "                   tranche.t_trancheNumber    AS t_tranchenumber,"
            + "\n" + "                   tranche.t_trancheKind    AS t_trancheKind,"
            + "\n" + "                   NVL((SELECT acc.t_account FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'С' AND acc.t_trancheKind = tranche.t_trancheKind AND acc.t_trancheNumber = tranche.t_trancheNumber and rownum < 2), CHR(1)) AS t_loansTermAccount,"
            + "\n" + "                   CHR(1) AS t_loansArrearsAccount,"
            + "\n" + "                   (SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_trancheNumber = tranche.t_trancheNumber AND p5.t_trancheKind = tranche.t_trancheKind AND p5.t_addLine = 1)   AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan"
            + "\n" + "              FROM df303contracts_tmp contract, "
            + "\n" + "                   df303tranches_tmp tranche "
            + "\n" + "           WHERE contract.t_isCreditLine = 1"
            + "\n" + "             AND contract.t_creditId = tranche.t_creditId"
            + "\n" + "           ) data)"
            + "\n" + "WHERE t_trancheNumber IS NOT NULL");
    end;
end;

class (TF303Part6DataSource_4033) TF303Part6DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part6DataSource_4033(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_FINPOSITIONBORROWER, "
            + "\n" + "                         T_QUALITYSERVICEDEBT, "
            + "\n" + "                         T_HIGHRISKFACTOR, "
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       T_FINPOSITIONBORROWER, "
            + "\n" + "       T_QUALITYSERVICEDEBT, "
            + "\n" + "       T_HIGHRISKFACTOR, "
            + "\n" + "       1 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN (data.t_arrearsAccount = chr(1) AND " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber") + " > 0 )"
            + "\n" + "                 THEN NVL((SELECT acc.t_cbAccount FROM df303accounts_tmp acc WHERE acc.t_typeAccount = 'З' AND acc.t_trancheKind = data.t_contractType AND acc.t_trancheNumber = data.t_creditId  and rownum < 2), CHR(1))"
            + "\n" + "               ELSE"
            + "\n" + "                  data.t_arrearsAccount"
            + "\n" + "             END AS t_arrearsAccount,"
            + "\n" + "             CASE"
            + "\n" + "               WHEN data.t_termDebtAccount = chr(1)"
            + "\n" + "                 THEN 0"
            + "\n" + "               ELSE"
            + "\n" + "                 " + getRegistrySum(1, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "             END AS t_sumTermDebt,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_arrearsAccount != chr(1) OR " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber") + " > 0 "
            + "\n" + "                  THEN " + getRegistrySum(2, "data.t_trancheKind", "data.t_trancheNumber") + " + " + getRegistrySum(16, "data.t_trancheKind", "data.t_trancheNumber")
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve "
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                     data.t_sumCalcReserveSecurity"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN "
            + "\n" + "                           CASE"
            + "\n" + "                             WHEN data.t_qualitycategoryraisingdate <= rep_data.getEndDate() AND (LENGTH(data.t_isqualitycategoryraising) > 0) "
            + "\n" + "                               THEN "
            + "\n" + "                                 CASE"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate >= rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1.1', '3.14.3', '2.1', '3.12', '3.1', '3.12.2', '5', '0')"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate < rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1', '3.14.3', '2', '3.12', '3', '3.12.2', '5', '0')"
            + "\n" + "                                   ELSE "
            + "\n" + "                                     CASE"
            + "\n" + "                                       WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                         THEN '4'"
            + "\n" + "                                       ELSE '0'"
            + "\n" + "                                     END"
            + "\n" + "                                 END"
            + "\n" + "                             ELSE "
            + "\n" + "                               CASE"
            + "\n" + "                                 WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                   THEN '4'"
            + "\n" + "                                 ELSE '0'"
            + "\n" + "                               END"
            + "\n" + "                           END"
            + "\n" + "                    END"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_trancheNumber,"
            + "\n" + "             data.t_termDebtAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_arrearsAccount AS t_loansArrearsAccount,"
            + "\n" + "             NULL AS t_finPositionBorrower,           "
            + "\n" + "             CASE"
            + "\n" + "                WHEN rep_data.getEndDate() >= TO_DATE('01-01-2018', 'DD-MM-YYYY')"
            + "\n" + "                 THEN data.t_qualityServiceDebt        "
            + "\n" + "               ELSE NULL                               "
            + "\n" + "             END AS t_qualityServiceDebt,              "
            + "\n" + "             data.t_highRiskFactor AS t_highRiskFactor "
            + "\n" + "      FROM ("
            + "\n" + "            SELECT contract.t_fiid AS t_fiid,"
            + "\n" + "                   contract.t_creditId AS t_creditId,"
            + "\n" + "                   contract.t_type AS t_contractType,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount   "
            + "\n" + "                          FROM df303accounts_tmp acc "
            + "\n" + "                         WHERE acc.t_typeAccount = 'С' "
            + "\n" + "                           AND acc.t_trancheNumber = tranche.t_trancheNumber "
            + "\n" + "                           AND acc.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                           AND rowNum < 2"
            + "\n" + "                           AND acc.t_openDate = (SELECT MAX(ac.t_openDate) "
            + "\n" + "                                                   FROM df303accounts_tmp ac"
            + "\n" + "                                                  WHERE ac.t_typeAccount = 'С' "
            + "\n" + "                                                    AND ac.t_trancheNumber = tranche.t_trancheNumber "
            + "\n" + "                                                    AND ac.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                                                )"
            + "\n" + "                        ), CHR(1)) AS t_termDebtAccount,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount   "
            + "\n" + "                          FROM df303accounts_tmp acc "
            + "\n" + "                         WHERE acc.t_typeAccount = 'З' "
            + "\n" + "                           AND acc.t_trancheNumber = tranche.t_trancheNumber "
            + "\n" + "                           AND acc.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                           AND (   (acc.t_outRest != 0 AND contract.t_isRepaidLoan = 0)"
            + "\n" + "                                OR (acc.t_outRest = 0  AND contract.t_isRepaidLoan = 1)) "
            + "\n" + "                           AND acc.t_openDate = (SELECT MAX(ac.t_openDate) "
            + "\n" + "                                                   FROM df303accounts_tmp ac"
            + "\n" + "                                                  WHERE ac.t_typeAccount = 'З' "
            + "\n" + "                                                    AND ac.t_trancheNumber = tranche.t_trancheNumber "
            + "\n" + "                                                    AND ac.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                                                    AND (   (ac.t_outRest != 0 AND contract.t_isRepaidLoan = 0)"
            + "\n" + "                                                         OR (ac.t_outRest = 0  AND contract.t_isRepaidLoan = 1)) "
            + "\n" + "                                                )"
            + "\n" + "                        ), CHR(1)) AS t_arrearsAccount,"
            + "\n" + "                   0 AS t_sumTermDebt,"
            + "\n" + "                   NULL AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   NULL AS t_calcReserve,"
            + "\n" + "                   (SELECT tr.t_CalcRVPSOD + tr.t_calcRvpsPd FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumCalcReserveSecurity,"
            + "\n" + "                   (SELECT tr.t_RVPSOD + tr.t_RVPSPD FROM repLnsTranches_vw tr WHERE tr.t_number = tranche.t_trancheNumber AND tr.t_kind = tranche.t_trancheKind  and rownum < 2) AS t_sumFormedReserve,"
            + "\n" + "                   tranche.t_trancheNumber    AS t_tranchenumber,"
            + "\n" + "                   tranche.t_trancheKind    AS t_trancheKind,"
            + "\n" + "                   (SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_trancheNumber = tranche.t_trancheNumber AND p5.t_trancheKind = tranche.t_trancheKind AND p5.t_addLine = 1)   AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan,"
            + "\n" + "                   tranche.t_isQualityCategoryRaising AS t_isqualitycategoryraising,"
            + "\n" + "                   contract.t_qualitycategoryraisingdate AS t_qualitycategoryraisingdate,"
            + "\n" + "                   contract.t_limNoRealActiv AS t_limNoRealActiv,"
            + "\n" + "                   contract.t_contragentId AS t_contragentId,"
            + "\n" + "                   tranche.t_qualityServiceDebt AS t_qualityServiceDebt,"
            + "\n" + "                   tranche.t_highRiskFactor AS t_highRiskFactor"
            + "\n" + "              FROM df303contracts_tmp contract, "
            + "\n" + "                   df303tranches_tmp tranche "
            + "\n" + "           WHERE contract.t_isCreditLine = 1"
            + "\n" + "             AND contract.t_creditId = tranche.t_creditId"
            + "\n" + "           ) data)"
            + "\n" + "WHERE t_trancheNumber IS NOT NULL");

/*Основная строка*/
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p6_tmp (T_CREDITID,"
            + "\n" + "                         T_TERMDEBTACCOUNT,"
            + "\n" + "                         T_ARREARSACCOUNT,"
            + "\n" + "                         T_SUMTERMDEBT,"
            + "\n" + "                         T_SUMOVERDEBT,"
            + "\n" + "                         T_LOANQUALITY,"
            + "\n" + "                         T_EVALUATION,"
            + "\n" + "                         T_CALCRESERVE,"
            + "\n" + "                         T_SUMCALCRESERVESECURITY,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_INFORMATION254P,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_LOANSTERMACCOUNT,"
            + "\n" + "                         T_LOANSARREARSACCOUNT,"
            + "\n" + "                         T_FINPOSITIONBORROWER, "
            + "\n" + "                         T_QUALITYSERVICEDEBT, "
            + "\n" + "                         T_HIGHRISKFACTOR, "
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "SELECT T_CREDITID,"
            + "\n" + "       T_TERMDEBTACCOUNT,"
            + "\n" + "       T_ARREARSACCOUNT,"
            + "\n" + "       T_SUMTERMDEBT,"
            + "\n" + "       T_SUMOVERDEBT,"
            + "\n" + "       T_LOANQUALITY,"
            + "\n" + "       T_EVALUATION,"
            + "\n" + "       T_CALCRESERVE,"
            + "\n" + "       T_SUMCALCRESERVESECURITY,"
            + "\n" + "       T_SUMFORMEDRESERVE,"
            + "\n" + "       T_INFORMATION254P,"
            + "\n" + "       T_TRANCHENUMBER,"
            + "\n" + "       T_LOANSTERMACCOUNT,"
            + "\n" + "       T_LOANSARREARSACCOUNT,"
            + "\n" + "       T_FINPOSITIONBORROWER, "
            + "\n" + "       T_QUALITYSERVICEDEBT, "
            + "\n" + "       T_HIGHRISKFACTOR, "
            + "\n" + "       0 T_ADDLINE"
            + "\n" + "FROM ("
            + "\n" + "      SELECT data.t_creditId AS t_creditId,"
            + "\n" + "             data.t_termDebtAccount,"
            + "\n" + "             data.t_arrearsAccount AS t_arrearsAccount,"
            + "\n" + "             data.t_sumTermDebt AS t_sumTermDebt,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isCreditLine = 0 "
            + "\n" + "                   THEN "
            + "\n" + "                      CASE"
            + "\n" + "                         WHEN data.t_arrearsAccount = chr(1) "
            + "\n" + "                           THEN 0"
            + "\n" + "                         ELSE " + getRegistrySum(2, "data.t_type", "data.t_creditId") + " + " +getRegistrySum(16, "data.t_type", "data.t_creditId")
            + "\n" + "                      END"
            + "\n" + "                ELSE"
            + "\n" + "                   (SELECT SUM(NVL(part6.t_sumOverDebt, 0)) FROM df303p6_tmp part6 WHERE part6.t_creditId = data.t_creditId AND part6.t_addLine = 1)"
            + "\n" + "             END AS t_sumOverDebt,"
            + "\n" + "             data.t_loanQuality AS t_loanQuality,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_evaluation"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_evaluation,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_calcReserve"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_calcReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                      data.t_sumCalcReserveSecurity"
            + "\n" + "                ELSE NULL"
            + "\n" + "             END AS t_sumCalcReserveSecurity,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN data.t_sumFormedReserve"
            + "\n" + "                ELSE 0"
            + "\n" + "             END AS t_sumFormedReserve,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN data.t_isRepaidLoan = 0"
            + "\n" + "                  THEN"
            + "\n" + "                    CASE"
            + "\n" + "                       WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                         THEN "
            + "\n" + "                           CASE"
            + "\n" + "                             WHEN data.t_qualitycategoryraisingdate <= rep_data.getEndDate() AND (LENGTH(data.t_isqualitycategoryraising) > 0) "
            + "\n" + "                               THEN "
            + "\n" + "                                 CASE"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate >= rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1.1', '3.14.3', '2.1', '3.12', '3.1', '3.12.2', '5', '0')"
            + "\n" + "                                   WHEN data.t_qualitycategoryraisingdate < rep_data.getBeginDate()"
            + "\n" + "                                     THEN DECODE(data.t_isqualitycategoryraising, '3.10', '1', '3.14.3', '2', '3.12', '3', '3.12.2', '5', '0')"
            + "\n" + "                                   ELSE "
            + "\n" + "                                     CASE"
            + "\n" + "                                       WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                         THEN '4'"
            + "\n" + "                                       ELSE '0'"
            + "\n" + "                                     END"
            + "\n" + "                                 END"
            + "\n" + "                             ELSE "
            + "\n" + "                               CASE"
            + "\n" + "                                 WHEN data.t_limNoRealActiv = 1"
            + "\n" + "                                   THEN '4'"
            + "\n" + "                                 ELSE '0'"
            + "\n" + "                               END"
            + "\n" + "                           END"
            + "\n" + "                    END"
            + "\n" + "                ELSE CHR(1)"
            + "\n" + "             END AS t_information254p,"
            + "\n" + "             data.t_tranchenumber AS t_tranchenumber,"
            + "\n" + "             data.t_termDebtAccount AS t_loansTermAccount,"
            + "\n" + "             data.t_arrearsAccount AS t_loansArrearsAccount,"
            + "\n" + "             CASE"
            + "\n" + "                WHEN rep_data.getEndDate() >= TO_DATE('01-01-2018', 'DD-MM-YYYY')"
            + "\n" + "                 THEN NVL((SELECT (SELECT a.t_numInList"
            + "\n" + "                                     FROM dobjattr_dbt a"
            + "\n" + "                                    WHERE a.t_attrId = atc.t_attrID AND a.t_objectType = atc.t_ObjectType AND a.t_groupId = 22)"
            + "\n" + "                             FROM dobjatcor_dbt atc"
            + "\n" + "                            WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
            + "\n" + "                              AND atc.t_GroupID    = 22"
            + "\n" + "                              AND atc.t_Object     = rsb_rep_pt.makePartyID(data.t_contragentId)"
            + "\n" + "                              AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate), '')"
            + "\n" + "               ELSE CHR(1)                         "
            + "\n" + "             END AS t_finPositionBorrower,           "
            + "\n" + "             CASE"
            + "\n" + "                WHEN rep_data.getEndDate() >= TO_DATE('01-01-2018', 'DD-MM-YYYY')"
            + "\n" + "                 THEN data.t_qualityServiceDebt   "
            + "\n" + "               ELSE NULL                          "
            + "\n" + "             END AS t_qualityServiceDebt,         "
            + "\n" + "             data.t_highRiskFactor AS t_highRiskFactor "
            + "\n" + "       FROM ("
            + "\n" + "            SELECT contract.t_creditId AS t_creditId,"
            + "\n" + "                   contract.t_fiid AS t_fiid,"
            + "\n" + "                   contract.t_type AS t_type,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN "
            + "\n" + "                          NVL((SELECT acc.t_cbAccount   "
            + "\n" + "                                 FROM df303accounts_tmp acc "
            + "\n" + "                                WHERE acc.t_typeAccount = 'С' "
            + "\n" + "                                  AND acc.t_trancheNumber = contract.t_creditId "
            + "\n" + "                                  AND acc.t_trancheKind = contract.t_type "
            + "\n" + "                                  AND rowNum < 2"
            + "\n" + "                                  AND acc.t_openDate = (SELECT MAX(ac.t_openDate) "
            + "\n" + "                                                          FROM df303accounts_tmp ac"
            + "\n" + "                                                         WHERE ac.t_typeAccount = 'С' "
            + "\n" + "                                                           AND ac.t_trancheNumber = contract.t_creditId "
            + "\n" + "                                                           AND ac.t_trancheKind = contract.t_type "
            + "\n" + "                                                       )"
            + "\n" + "                               ), CHR(1)) "
            + "\n" + "                      ELSE CHR(1)"
            + "\n" + "                   END AS t_termDebtAccount,"
            + "\n" + "                   NVL((SELECT acc.t_cbAccount   "
            + "\n" + "                          FROM df303accounts_tmp acc "
            + "\n" + "                         WHERE acc.t_typeAccount = 'З' "
            + "\n" + "                           AND acc.t_trancheNumber = contract.t_creditId "
            + "\n" + "                           AND acc.t_trancheKind = contract.t_type "
            + "\n" + "                           AND (   (acc.t_outRest != 0 AND contract.t_isRepaidLoan = 0)"
            + "\n" + "                                OR (acc.t_outRest = 0  AND contract.t_isRepaidLoan = 1)) "
            + "\n" + "                           AND acc.t_openDate = (SELECT MAX(ac.t_openDate) "
            + "\n" + "                                                   FROM df303accounts_tmp ac"
            + "\n" + "                                                  WHERE ac.t_typeAccount = 'З' "
            + "\n" + "                                                    AND ac.t_trancheNumber = contract.t_creditId "
            + "\n" + "                                                    AND ac.t_trancheKind = contract.t_type "
            + "\n" + "                                                    AND (   (ac.t_outRest != 0 AND contract.t_isRepaidLoan = 0)"
            + "\n" + "                                                         OR (ac.t_outRest = 0  AND contract.t_isRepaidLoan = 1)) "
            + "\n" + "                                                )"
            + "\n" + "                        ), CHR(1)) AS t_arrearsAccount,"
            + "\n" + "                   CASE"
            + "\n" + "                       WHEN contract.t_isCreditLine = 0"
            + "\n" + "                           THEN NVL(" + getRegistrySum(1, "contract.t_type", "contract.t_creditId") + ", 0)"
            + "\n" + "                       ELSE (SELECT SUM(" + getRegistrySum(1, "tr.t_trancheKind", "tr.t_trancheNumber") + ") FROM df303tranches_tmp tr WHERE tr.t_creditId = contract.t_creditId)"
            + "\n" + "                   END AS t_sumTermDebt,"
            + "\n" + "                   contract.t_rvpsQualityCategory AS t_loanQuality,"
            + "\n" + "                   contract.t_assessmentLoans AS t_evaluation,"
            + "\n" + "                   contract.t_rvpsReservePercent AS t_calcReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_rvpsSum + reserve.t_delayedRvpsSum"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                      ELSE  (SELECT SUM(NVL(part6.t_sumFormedReserve, 0)) FROM df303p6_tmp part6 WHERE part6.t_creditId = contract.t_creditId AND part6.t_addLine = 1)"
            + "\n" + "                   END    AS t_sumFormedReserve,"
            + "\n" + "                   CASE"
            + "\n" + "                      WHEN contract.t_isCreditLine = 0"
            + "\n" + "                        THEN (SELECT reserve.t_calcRvpsSum + reserve.t_calcDelayedRvpsSum"
            + "\n" + "                               FROM repLnsReserve_vw reserve"
            + "\n" + "                              WHERE reserve.t_objectNumber = contract.t_creditId AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                      ELSE  (SELECT SUM(NVL(part6.t_sumCalcReserveSecurity, 0)) FROM df303p6_tmp part6 WHERE part6.t_creditId = contract.t_creditId AND part6.t_addLine = 1)"
            + "\n" + "                   END    AS t_sumCalcReserveSecurity,"
            + "\n" + "                   t_isQualityCategoryRaising AS t_isQualityCategoryRaising,"
            + "\n" + "                   t_qualityCategoryRaisingDate AS t_qualityCategoryRaisingDate,"
            + "\n" + "                   t_limNoRealActiv AS t_limNoRealActiv,"
            + "\n" + "                   contract.t_isCredit    AS t_isCredit,"
            + "\n" + "                   contract.t_creditId    AS t_trancheNumber,"
            + "\n" + "                   NVL((SELECT p5.t_funds FROM df303p5_tmp p5 WHERE p5.t_creditId = contract.t_creditId AND p5.t_addLine = 0), 0) AS t_funds,"
            + "\n" + "                   contract.t_isCreditLine    AS t_isCreditLine,"
            + "\n" + "                   contract.t_isConcession    AS t_isConcession,"
            + "\n" + "                   contract.t_isRepaidLoan    AS t_isRepaidLoan,"
            + "\n" + "                   contract.t_contragentId AS t_contragentId,"
            + "\n" + "                   contract.t_qualityServiceDebt AS t_qualityServiceDebt,"
            + "\n" + "                   contract.t_highRiskFactor AS t_highRiskFactor"
            + "\n" + "              FROM df303contracts_tmp contract "
            + "\n" + "           ) data)");
    end;
end;

class (RcbDataSource) TF303Part7DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p7_tmp");
    end;

    macro getRegistrySum(register)
        return " NVL((SELECT dutyrest.t_restSum                                                                                    "
         + "\n" + "FROM DDUTYREST_DBT dutyrest                                                                                     "
         + "\n" + "  WHERE dutyrest.t_id_ref = (SELECT lcreg.t_id                                                                  "
         + "\n" + "                              FROM dlcusreg_dbt lcreg                                                           "
         + "\n" + "                             WHERE lcreg.t_objectTypeId = tranche.t_trancheKind                                 "
         + "\n" + "                               AND lcreg.t_objectNumber = tranche.t_trancheNumber                               "
         + "\n" + "                               AND lcreg.t_regId = " + register + ")                                            "
         + "\n" + "   AND DUTYREST.T_RESTDATE = (SELECT MAX(rest.t_restDate)                                                       "
         + "\n" + "                                FROM DDUTYREST_DBT rest                                                         "
         + "\n" + "                               WHERE rest.t_id_ref = (SELECT lcreg.t_id                                         "
         + "\n" + "                                                            FROM dlcusreg_dbt lcreg                             "
         + "\n" + "                                                           WHERE lcreg.t_objectTypeId = tranche.t_trancheKind   "
         + "\n" + "                                                             AND lcreg.t_objectNumber = tranche.t_trancheNumber "
         + "\n" + "                                                             AND lcreg.t_regId = " + register + ")              "
         + "\n" + "                                 AND rest.t_restDate <= rep_data.getEndDate()) ), 0)";
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p7_tmp (T_CREDITID,"
            + "\n" + "                         T_SUMCLAIMBALANCE,"
            + "\n" + "                         T_SUMCLAIMBALANCEOVER,"
            + "\n" + "                         T_SUMCLAIMNOTBALANCE,"
            + "\n" + "                         T_SUMCLAIMNOTBALANCEOVER,"
            + "\n" + "                         T_SUMFORMEDRESERVE,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "SELECT t_creditId,                                                         "
            + "\n" + "       SUM(t_sumClaimBalance),                                             "
            + "\n" + "       SUM(t_sumClaimBalanceOver),                                         "
            + "\n" + "       SUM(t_sumClaimNotBalance),                                          "
            + "\n" + "       SUM(t_sumClaimNotBalanceOver),                                      "
            + "\n" + "       SUM(t_sumFormedReserve),                                            "
            + "\n" + "       CASE                                                                "
            + "\n" + "         WHEN GROUPING(t_trancheNumber) = 1                                "
            + "\n" + "           THEN t_creditId                                                 "
            + "\n" + "           ELSE t_trancheNumber                                            "
            + "\n" + "       END t_trancheNumber,                                                "
            + "\n" + "       CASE                                                                "
            + "\n" + "         WHEN data.t_isCreditLine = 0 or grouping(t_trancheNumber) = 1     "
            + "\n" + "           THEN 0                                                          "
            + "\n" + "           ELSE 1                                                          "
            + "\n" + "       END AS t_addLine                                                    "
            + "\n" + "FROM (SELECT DISTINCT"
            + "\n" + "       contract.t_creditId AS t_creditId,"
            + "\n" + "            contract.t_isCreditLine,"
            + "\n" +            "(" + getRegistrySum(4) + " - " + getRegistrySum(75) + ") AS t_sumClaimBalance,"
            + "\n" + "           (" +  getRegistrySum(3) + " + " + getRegistrySum(18) + " - " + getRegistrySum(76) + " - " + getRegistrySum(78) + ") AS t_sumClaimBalanceOver,"
            + "\n" + "            CASE"
            + "\n" + "               WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                 THEN " + getRegistrySum(75)
            + "\n" + "               ELSE 0"
            + "\n" + "            END AS t_sumClaimNotBalance,"
            + "\n" + "            CASE"
            + "\n" + "               WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "                 THEN (" + getRegistrySum(76) + " + " +  getRegistrySum(78) + ")"
            + "\n" + "               ELSE 0"
            + "\n" + "            END AS t_sumClaimNotBalanceOver,"
            + "\n" + "            CASE "
            + "\n" + "                 WHEN contract.t_isCreditLine = 0 "
            + "\n" + "                   THEN (SELECT reserve.t_percentrvpsum + reserve.t_delayedpercentrvpsum"
            + "\n" + "          FROM repLnsReserve_vw reserve"
            + "\n" + "                          WHERE reserve.t_objectNumber = contract.t_creditId"
            + "\n" + "                            AND reserve.t_objectTypeId = contract.t_type)"
            + "\n" + "                   ELSE ( LoansVOX.RVPPerc    (tranche.t_trancheKind, tranche.t_trancheNumber, rep_data.getEndDate()) + LoansVOX.RVPExpPerc (tranche.t_trancheKind, tranche.t_trancheNumber, rep_data.getEndDate()))"
            + "\n" + "            END AS t_sumFormedReserve,"
            + "\n" + "            tranche.t_trancheNumber AS t_trancheNumber,"
            + "\n" + "            CASE "
            + "\n" + "              WHEN contract.t_isCreditLine = 0 "
            + "\n" + "                THEN 0 "
            + "\n" + "                ELSE 1 "
            + "\n" + "            END AS t_addLine"
            + "\n" + "   FROM df303contracts_tmp contract, df303tranches_tmp tranche"
            + "\n" + "       WHERE contract.t_isRepaidLoan = 0 AND contract.t_creditId = tranche.t_creditId) data"
            + "\n" + "GROUP BY ROLLUP (t_creditId,  t_iscreditLine, t_trancheNumber)     "
            + "\n" + "HAVING GROUPING(t_creditId) = 0 AND GROUPING(t_isCreditLine) = 0 AND GROUPING(t_trancheNumber) = 0 or t_isCreditLine = 1  ");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p7_tmp p7";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;

    private macro constructorF303Part7DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("7", protocolView, dataSources);
    end;

    constructorF303Part7DataSource(protocolView, dataSources);
end;

class (RcbDataSource) TF303Part8DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p8_tmp");
    end;

    macro getRegistrySum(register)
        return "NVL(RSI_RSB_FIINSTR.ConvSum(NVL((SELECT dutyrest.t_restSum                                                                               "
         + "\n" + "                                FROM DDUTYREST_DBT dutyrest                                                                           "
         + "\n" + "                               WHERE dutyrest.t_id_ref = (SELECT lcreg.t_id                                                           "
         + "\n" + "                                                            FROM dlcusreg_dbt lcreg                                                   "
         + "\n" + "                                                           WHERE lcreg.t_objectTypeId = contract.t_type                               "
         + "\n" + "                                                             AND lcreg.t_objectNumber = contract.t_creditId                           "
         + "\n" + "                                                             AND lcreg.t_regId = " + register + ")                                    "
         + "\n" + "                                 AND DUTYREST.T_RESTDATE = (SELECT MAX(rest.t_restDate)                                               "
         + "\n" + "                                                              FROM DDUTYREST_DBT rest                                                 "
         + "\n" + "                                                             WHERE rest.t_id_ref = (SELECT lcreg.t_id                                 "
         + "\n" + "                                                                                      FROM dlcusreg_dbt lcreg                         "
         + "\n" + "                                                                                     WHERE lcreg.t_objectTypeId = contract.t_type     "
         + "\n" + "                                                                                       AND lcreg.t_objectNumber = contract.t_creditId "
         + "\n" + "                                                                                       AND lcreg.t_regId = " + register + ")          "
         + "\n" + "                                                               AND rest.t_restDate <= rep_data.getEndDate()) ), 0),                   "
         + "\n" + "                         contract.t_fiId,                                                             "
         + "\n" + "                       " + NATCUR + ", "
         + "\n" + "                         rep_data.getEndDate()), 0)"
;
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p8_tmp (t_creditId,"
            + "\n" + "                                      t_sumUnusedLimits,"
            + "\n" + "                                      t_sumCalcReserveSecurity,"
            + "\n" + "                                      t_sumFormedReserve)"

            + "\n" + "          SELECT contract.t_creditId            AS t_creditId,"
            + "\n" + "                 CASE "
            + "\n" + "                      WHEN contract.t_type IN ( " + LO_KARTA + ", " + LO_OVERDRAFT + " ) "
            + "\n" + "                        THEN " + getRegistrySum(8)
            + "\n" + "                      WHEN contract.t_issueType = 5 " //под лимит задолженности
            + "\n" + "                        THEN " + getRegistrySum(8)
            + "\n" + "                      WHEN contract.t_issueType = 4 " //невозобновляемая КЛ
            + "\n" + "                        THEN " + getRegistrySum(7)
            + "\n" + "                      WHEN contract.t_issueType = 3 " //под лимит выдачи + задолженности
            + "\n" + "                        THEN " + getRegistrySum(68)
            + "\n" + "                        ELSE NULL"
            + "\n" + "                 END                  AS t_sumUnusedLimits,"
            + "\n" + "                 reserve.t_calcRvpSum AS t_sumCalcReserveSecurity,"
            + "\n" + "                 reserve.t_rvpSum     AS t_sumFormedReserve"
            + "\n" + "            FROM df303contracts_tmp contract LEFT JOIN repLnsReserve_vw reserve ON (contract.t_creditId = reserve.t_objectNumber AND contract.t_type = reserve.t_objectTypeId)"
            + "\n" + "           WHERE contract.t_isRepaidLoan = 0 AND rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p8_tmp p8";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;

    private macro constructorF303Part8DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("8", protocolView, dataSources);
    end;

    constructorF303Part8DataSource(protocolView, dataSources);
end;

class (TF303Part8DataSource) TF303Part8DataSource_4212(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part8DataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p8_tmp (t_creditId,"
            + "\n" + "                                      t_sumUnusedLimits,"
            + "\n" + "                                      t_sumCalcReserveSecurity,"
            + "\n" + "                                      t_sumFormedReserve,"
            + "\n" + "                                      t_rvpPercent)"
            + "\n" + "          SELECT contract.t_creditId    AS t_creditId,"
            + "\n" + "                 CASE "
            + "\n" + "                      WHEN contract.t_type IN ( " + LO_KARTA + ", " + LO_OVERDRAFT + " ) "
            + "\n" + "                        THEN " + getRegistrySum(8)
            + "\n" + "                      WHEN contract.t_issueType = 5 " //под лимит задолженности
            + "\n" + "                        THEN " + getRegistrySum(8)
            + "\n" + "                      WHEN contract.t_issueType = 4 " //невозобновляемая КЛ
            + "\n" + "                        THEN " + getRegistrySum(7)
            + "\n" + "                      WHEN contract.t_issueType = 3 " //под лимит выдачи + задолженности
            + "\n" + "                        THEN " + getRegistrySum(68)
            + "\n" + "                        ELSE NULL"
            + "\n" + "                 END                    AS t_sumUnusedLimits,"
            + "\n" + "                 reserve.t_calcRvpSum   AS t_sumCalcReserveSecurity,"
            + "\n" + "                 reserve.t_rvpSum       AS t_sumFormedReserve,"
            + "\n" + "                 reserve.t_rvp_Perc_Val AS t_rvpPercent"
            + "\n" + "            FROM df303contracts_tmp contract LEFT JOIN repLnsReserve_vw reserve ON (contract.t_creditId = reserve.t_objectNumber AND contract.t_type = reserve.t_objectTypeId)"
            + "\n" + "           WHERE contract.t_isRepaidLoan = 0 AND rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')");
    end;
end;

class (RcbDataSource) TF303Part9DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p9_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)

/* Основная строка для Кредитных договоров, Договоров о приобретении прав требования */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                         T_PERIODICITYREPAYMENT,"
            + "\n" + "                         T_SUMPROVIDEDDEBT,"
            + "\n" + "                         T_SUMPAIDDEBT,"
            + "\n" + "                         T_PERIODICITYINTEREST,"
            + "\n" + "                         T_SUMPROVIDEDINTEREST,"
            + "\n" + "                         T_SUMPAIDINTEREST,"
            + "\n" + "                         T_SUMFINES,"
            + "\n" + "                         T_DATEREMOVALDEBT,"
            + "\n" + "                         T_MATURITYDATEDEBT,"
            + "\n" + "                         T_SOURCEREPAYMENT,"
            + "\n" + "                         T_CODENEWCREDIT,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "WITH repaymentSheduleMaxDate AS ("
            + "\n" + "                                 SELECT repaymentShedule.t_periodPayOD, "
            + "\n" + "                                        repaymentShedule.t_periodPayPerc,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayOd,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayPerc,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                               FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                              WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                AND r.t_constructionDate <= rep_data.getEndDate)"
            + "\n" + "                                ),"
            + "\n" + "     repaymentSheduleByPeriod AS ("
            + "\n" + "                                 SELECT SUM(repaymentShedule.t_plannedPaySum)     AS t_plannedPaySum, "
            + "\n" + "                                        SUM(repaymentShedule.t_plannedPercentSum) AS t_plannedPercentSum,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND (repaymentShedule.t_plannedPayDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate < rep_data.getBeginDate)"
            + "\n" + "                               GROUP BY tranche.t_trancheNumber, tranche.t_trancheKind"
            + "\n" + "                                )"

            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "            THEN                                                                                                                                              "
            + "\n" + "              CASE data.t_typePeriodPayOd                          "
            + "\n" + "                 WHEN 1                           "
            + "\n" + "                   THEN 7                                                       "
            + "\n" + "                 WHEN 2                           "
            + "\n" + "                   THEN                                                         "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodPayOd, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodPayOd, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                       THEN 6                                                                                                                                        "
            + "\n" + "                       ELSE                                                                                                                                          "
            + "\n" + "                         DECODE(data.t_periodPayOd, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                                                                                                                                       "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                                                                                                                   "
            + "\n" + "                ELSE 7                                                                                                                   "
            + "\n" + "              END                                                                                                                   "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityRepayment,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "              THEN data.t_plannedPaySum                                                                                                                                         "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumProvidedDebt,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sumPaidDebt                                                                                                                                         "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumPaidDebt,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "            THEN                                                                                                                                              "
            + "\n" + "              CASE data.t_typePeriodicityInterest                          "
            + "\n" + "                 WHEN 1                           "
            + "\n" + "                   THEN 7                                                       "
            + "\n" + "                 WHEN 2                           "
            + "\n" + "                   THEN                                                         "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodicityInterest, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodicityInterest, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                       THEN 6                                                                                                                                        "
            + "\n" + "                       ELSE                                                                                                                                          "
            + "\n" + "                         DECODE(data.t_periodicityInterest, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                                                                                                                                       "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                                                                                                                   "
            + "\n" + "                ELSE 7                                                                                                                   "
            + "\n" + "              END                                                                                                                   "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') AND data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "              THEN data.t_sumProvidedInterest                                                                                                                                         "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumProvidedInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sumPaidInterest                                     "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumPaidInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sumFines                                            "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumFines,"
            + "\n" + "       data.t_dateRemovalDebt,"
            + "\n" + "       data.t_maturityDateDebt,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sourceRepayment                                     "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sourceRepayment,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_codeNewCredit                                       "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_codeNewCredit,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_regNumber                                           "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_regNumber,"
            + "\n" + "       data.t_trancheNumber,"
            + "\n" + "       0 T_ADDLINE"

            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "       contract.t_creditId,"
            + "\n" + "               contract.t_type,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPaySum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_plannedPaySum,"
            + "\n" + "               contract.t_sumPaidOD AS t_sumPaidDebt,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodicityInterest,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPercentSum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_sumProvidedInterest,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodicityInterest,"
            + "\n" + "               contract.t_sumPaidPerc AS t_sumPaidInterest,"
            + "\n" + "               contract.t_sumPaidOther AS t_sumFines,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN (SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3)) > 0"
            + "\n" + "                      THEN                                            "
            + "\n" + "                        CASE"
            + "\n" + "                           WHEN NOT EXISTS(SELECT 1 "
            + "\n" + "                                             FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                            WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                              AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                              AND regHist.t_operationDate > rep_data.getBeginDate"
            + "\n" + "                                              AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                           THEN                                            "
            + "\n" + "                             (SELECT MIN(reg.t_date) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3))"
            + "\n" + "                        ELSE"
            + "\n" + "                          CASE"
            + "\n" + "                             WHEN EXISTS(SELECT 1 "
            + "\n" + "                                           FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                          WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                            AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                            AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                             THEN                                            "
            + "\n" + "                               ("
            + "\n" + "                                SELECT MAX (regHist.t_operationDate) AS t_operationDate"
            + "\n" + "                                  FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                   AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                   AND regHist.t_operationDate <= rep_data.getEndDate"
            + "\n" + "                                   AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind"
            + "\n" + "                               )"
            + "\n" + "                             ELSE NULL"
            + "\n" + "                           END "
            + "\n" + "                        END "
            + "\n" + "                  ELSE NULL"
            + "\n" + "               END   t_dateRemovalDebt,"
            + "\n" + "       NULL  AS t_maturityDateDebt,"
            + "\n" + "               DECODE(contract.t_sourcePayment, chr(1), '12','', '12', NULL, '12', contract.t_sourcePayment) AS t_sourceRepayment,"
            + "\n" + "               contract.t_crdRefinId   AS t_codeNewCredit,"
            + "\n" + "               NVL(contract.t_regNumberCredOrg, '') AS t_regNumber,"
            + "\n" + "               contract.t_creditId AS t_trancheNumber"
            + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche"
            + "\n" + " WHERE contract.t_isCreditLine = 0"
            + "\n" + "           AND contract.t_creditId = tranche.t_creditId"
            + "\n" + "           ) data"
            + "\n" + "     UNION ALL "
            + "\n" + "        SELECT "
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               NULL AS t_periodPayOD,"
            + "\n" + "               NULL AS t_plannedPaySum,"
            + "\n" + "               NULL AS t_sumPaidDebt,"
            + "\n" + "               NULL AS t_periodicityInterest,"
            + "\n" + "               NULL AS t_sumProvidedInterest,"
            + "\n" + "               NULL AS t_sumPaidInterest,"
            + "\n" + "               NULL AS t_sumFines,"
            + "\n" + "               NULL AS t_dateRemovalDebt,"
            + "\n" + "               NULL  AS t_maturityDateDebt,"
            + "\n" + "               DECODE(contract.t_sourcePayment, chr(1), '12','', '12', NULL, '12', contract.t_sourcePayment) AS t_sourceRepayment,"
            + "\n" + "               contract.t_crdRefinId   AS t_codeNewCredit,"
            + "\n" + "               NVL(contract.t_regNumberCredOrg, '') AS t_regNumber,"
            + "\n" + "               contract.t_creditId AS t_trancheNumber,"
            + "\n" + "               0 AS t_addLine"
            + "\n" + "          FROM df303contracts_tmp contract"
            + "\n" + "         WHERE contract.t_isCreditLine = 1");

/* Дополнительные строки для основных и дополнительных строк */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                         T_PERIODICITYREPAYMENT,"
            + "\n" + "                         T_SUMPROVIDEDDEBT,"
            + "\n" + "                         T_SUMPAIDDEBT,"
            + "\n" + "                         T_PERIODICITYINTEREST,"
            + "\n" + "                         T_SUMPROVIDEDINTEREST,"
            + "\n" + "                         T_SUMPAIDINTEREST,"
            + "\n" + "                         T_SUMFINES,"
            + "\n" + "                         T_DATEREMOVALDEBT,"
            + "\n" + "                         T_MATURITYDATEDEBT,"
            + "\n" + "                         T_SOURCEREPAYMENT,"
            + "\n" + "                         T_CODENEWCREDIT,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + " SELECT "
            + "\n" + "        contract.t_creditId,"
            + "\n" + "        NULL AS t_periodPayOD,"
            + "\n" + "        NULL AS t_plannedPaySum,"
            + "\n" + "        NULL AS t_sumPaidDebt,"
            + "\n" + "        NULL AS t_periodicityInterest,"
            + "\n" + "        NULL AS t_sumProvidedInterest,"
            + "\n" + "        NULL AS t_sumPaidInterest,"
            + "\n" + "        NULL AS t_sumFines,"
            + "\n" + "        CASE"
            + "\n" + "           WHEN regHist.t_operationDate = MIN (regHist.t_operationDate) OVER (PARTITION BY contract.t_creditId, tranche.t_trancheNumber) "
            + "\n" + "             THEN"
            + "\n" + "               CASE"
            + "\n" + "           WHEN EXISTS(SELECT 1 "
            + "\n" + "                         FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                        WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                          AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                          AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate"
            + "\n" + "                          AND reg.t_trancheNumber = tranche.t_number AND reg.t_trancheKind = tranche.t_kind)"
            + "\n" + "           THEN (SELECT MAX(regHist.t_operationDate)"
            + "\n" + "                   FROM repLnsRegChangeHistory_vw regHist"
            + "\n" + "                  WHERE regHist.t_trancheNumber = tranche.t_number"
            + "\n" + "                    AND regHist.t_trancheKind = tranche.t_kind"
            + "\n" + "                    AND regHist.t_regKind IN (2, 3)"
            + "\n" + "                    AND regHist.t_operationKind = 4)"
            + "\n" + "           ELSE NULL"
            + "\n" + "               END "
            + "\n" + "           ELSE NULL"
            + "\n" + "        END t_dateRemovalDebt,"
            + "\n" + "        regHist.t_operationDate  AS t_maturityDateDebt,"
            + "\n" + "        NULL AS t_sourceRepayment,"
            + "\n" + "        NULL AS t_codeNewCredit,"
            + "\n" + "        NULL AS t_regNumber,"
            + "\n" + "        tranche.t_number AS t_trancheNumber,"
            + "\n" + "        2 AS t_addLine"
            + "\n" + "   FROM df303contracts_tmp contract, repLnsTranches_vw tranche,"
            + "\n" + "       ( SELECT DISTINCT lcusreg.t_objecttypeid AS t_trancheKind,                    "
            + "\n" + "                lcusreg.t_objectnumber AS t_trancheNumber,                           "
            + "\n" + "                crd_op.t_credoperdate AS t_operationDate                             "
            + "\n" + "           FROM dlchsumrg_dbt lchsumrg, dlcusreg_dbt lcusreg, dcrd_op_dbt crd_op     "
            + "\n" + "          WHERE lchsumrg.t_usregid_ref = lcusreg.t_id                                "
            + "\n" + "            AND lchsumrg.t_date = crd_op.t_credoperdate                              "
            + "\n" + "            AND crd_op.t_credoperid = lchsumrg.t_credoperid_ref                      "
            + "\n" + "            AND crd_op.t_isdeleted = 0                                               "
            + "\n" + "            AND crd_op.t_stageid_ref = 99                                            "
            + "\n" + "            AND lcusreg.t_regid IN (2,3)                                             "
            + "\n" + "            AND crd_op.t_systemoperationid=3                                         "
            + "\n" + "            AND (crd_op.t_credoperdate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate())"
            + "\n" + "            AND lchsumrg.t_sum <> 0) regHist"
            + "\n" + "  WHERE tranche.t_kind = regHist.t_trancheKind AND tranche.t_number = regHist.t_trancheNumber AND contract.t_creditId = tranche.t_contractId");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                         T_PERIODICITYREPAYMENT,"
            + "\n" + "                         T_SUMPROVIDEDDEBT,"
            + "\n" + "                         T_SUMPAIDDEBT,"
            + "\n" + "                         T_PERIODICITYINTEREST,"
            + "\n" + "                         T_SUMPROVIDEDINTEREST,"
            + "\n" + "                         T_SUMPAIDINTEREST,"
            + "\n" + "                         T_SUMFINES,"
            + "\n" + "                         T_DATEREMOVALDEBT,"
            + "\n" + "                         T_MATURITYDATEDEBT,"
            + "\n" + "                         T_SOURCEREPAYMENT,"
            + "\n" + "                         T_CODENEWCREDIT,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_ADDLINE)"

            + "\n" + "WITH repaymentSheduleMaxDate AS ("
            + "\n" + "                                 SELECT repaymentShedule.t_periodPayOD, "
            + "\n" + "                                        repaymentShedule.t_periodPayPerc,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayOd,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayPerc,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate <= rep_data.getEndDate)"
            + "\n" + "                                ),"
            + "\n" + "     repaymentSheduleByPeriod AS ("
            + "\n" + "                                 SELECT SUM(repaymentShedule.t_plannedPaySum)     AS t_plannedPaySum, "
            + "\n" + "                                        SUM(repaymentShedule.t_plannedPercentSum) AS t_plannedPercentSum,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND (repaymentShedule.t_plannedPayDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate < rep_data.getBeginDate)"
            + "\n" + "                               GROUP BY tranche.t_trancheNumber, tranche.t_trancheKind"
            + "\n" + "                                )"

            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "            THEN                                                                                                                                              "
            + "\n" + "              CASE data.t_typePeriodPayOd                          "
            + "\n" + "                 WHEN 1                           "
            + "\n" + "                   THEN 7                                                       "
            + "\n" + "                 WHEN 2                           "
            + "\n" + "                   THEN                                                         "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodPayOd, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodPayOd, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                       THEN 6                                                                                                                                        "
            + "\n" + "                       ELSE                                                                                                                                          "
            + "\n" + "                         DECODE(data.t_periodPayOd, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                                                                                                                                       "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                                                         "
            + "\n" + "                ELSE 7                                                            "
            + "\n" + "              END                                                                 "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityRepayment,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "              THEN data.t_plannedPaySum                                     "
            + "\n" + "          ELSE 0                                                            "
            + "\n" + "       END AS t_sumProvidedDebt,                                            "
            + "\n" + "       CASE                                                                 "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "              THEN data.t_sumPaidDebt                                       "
            + "\n" + "          ELSE 0                                                            "
            + "\n" + "       END AS t_sumPaidDebt,                                                "
            + "\n" + "       CASE                                                                 "
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "            THEN                                                            "
            + "\n" + "              CASE data.t_typePeriodicityInterest                           "
            + "\n" + "                 WHEN 1                                                     "
            + "\n" + "                   THEN 7                                                   "
            + "\n" + "                 WHEN 2                                                     "
            + "\n" + "                   THEN                                                     "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodicityInterest, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodicityInterest, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                       THEN 6                                                                                                                                        "
            + "\n" + "                       ELSE                                                                                                                                          "
            + "\n" + "                         DECODE(data.t_periodicityInterest, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                                                                                                                                       "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                                                                                                                   "
            + "\n" + "                ELSE 7                                                                                                                   "
            + "\n" + "              END                                                            "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY') "
            + "\n" + "              THEN data.t_sumProvidedInterest                                "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumProvidedInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sumPaidInterest                                    "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumPaidInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sumFines                                           "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumFines,"
            + "\n" + "       data.t_dateRemovalDebt,"
            + "\n" + "       data.t_maturityDateDebt,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_sourceRepayment                                    "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_sourceRepayment,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_codeNewCredit                                      "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_codeNewCredit,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-04-2016', 'DD-MM-YYYY')"
            + "\n" + "              THEN data.t_regNumber                                          "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_regNumber,"
            + "\n" + "       data.t_trancheNumber,"
            + "\n" + "       1 T_ADDLINE"
            + "\n" + "  FROM ("
            + "\n" + "SELECT "
            + "\n" + "       contract.t_creditId,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPaySum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_plannedPaySum,"
            + "\n" + "               tranche.t_sumPaidOD AS t_sumPaidDebt,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodicityInterest,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPercentSum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_sumProvidedInterest,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodicityInterest,"
            + "\n" + "               tranche.t_sumPaidPerc AS t_sumPaidInterest,"
            + "\n" + "               tranche.t_sumPaidOther AS t_sumFines,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN (SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3)) > 0"
            + "\n" + "                      THEN                                            "
            + "\n" + "                        CASE"
            + "\n" + "                           WHEN NOT EXISTS(SELECT 1 "
            + "\n" + "                                             FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                            WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                              AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                              AND regHist.t_operationDate > rep_data.getBeginDate"
            + "\n" + "                                              AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                           THEN                                            "
            + "\n" + "                             (SELECT MIN(reg.t_date) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3))"
            + "\n" + "                        ELSE"
            + "\n" + "                          CASE"
            + "\n" + "                             WHEN EXISTS(SELECT 1 "
            + "\n" + "                                           FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                          WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                            AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                            AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate"
            + "\n" + "                                            AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                             THEN                                            "
            + "\n" + "                               ("
            + "\n" + "                                SELECT MAX (regHist.t_operationDate) AS t_operationDate"
            + "\n" + "                                  FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                   AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                   AND regHist.t_operationDate <= rep_data.getEndDate"
            + "\n" + "                                   AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind"
            + "\n" + "                               )"
            + "\n" + "                             ELSE NULL"
            + "\n" + "                           END "
            + "\n" + "                        END "
            + "\n" + "                  ELSE NULL"
            + "\n" + "               END   t_dateRemovalDebt,"
            + "\n" + "               NULL AS t_maturityDateDebt,  "
            + "\n" + "               DECODE(tranche.t_sourcePayment, chr(1), '12', '', '12', NULL, '12', tranche.t_sourcePayment) AS t_sourceRepayment,"
            + "\n" + "               contract.t_crdRefinId   AS t_codeNewCredit,"
            + "\n" + "               NVL(contract.t_regNumberCredOrg, '') AS t_regNumber,"
            + "\n" + "       tranche.t_trancheNumber   AS t_trancheNumber,"
            + "\n" + "               tranche.t_trancheKind AS t_trancheKind"
            + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche"
            + "\n" + "  WHERE contract.t_isCreditLine = 1 AND contract.t_creditId = tranche.t_creditId) data");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p9_tmp p9";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("T_DATEREMOVALDEBT", V_DATE);
        dataSet.SetFieldType("T_MATURITYDATEDEBT", V_DATE);

        return dataSet;
    end;

    private macro constructorF303Part9DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("9", protocolView, dataSources);
    end;

    constructorF303Part9DataSource(protocolView, dataSources);
end;

class (TF303Part9DataSource) TF303Part9DataSource_4637(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro cacheData(filter : RcbDataSourceFilter)


/* Дополнительные строки для основных и дополнительных строк */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                         T_PERIODICITYREPAYMENT,"
            + "\n" + "                         T_SUMPROVIDEDDEBT,"
            + "\n" + "                         T_SUMPAIDDEBT,"
            + "\n" + "                         T_PERIODICITYINTEREST,"
            + "\n" + "                         T_SUMPROVIDEDINTEREST,"
            + "\n" + "                         T_SUMPAIDINTEREST,"
            + "\n" + "                         T_SUMFINES,"
            + "\n" + "                         T_DATEREMOVALDEBT,"
            + "\n" + "                         T_MATURITYDATEDEBT,"
            + "\n" + "                         T_SOURCEREPAYMENT,"
            + "\n" + "                         T_CODENEWCREDIT,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_PRINCIPALPAYMENTFICODE,"
            + "\n" + "                         T_PERCENTPAYMENTFICODE,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + " SELECT "
            + "\n" + "        contract.t_creditId,"
            + "\n" + "        NULL AS t_periodPayOD,"
            + "\n" + "        NULL AS t_plannedPaySum,"
            + "\n" + "        operation.t_sumPaidDebt AS t_sumPaidDebt,"
            + "\n" + "        NULL AS t_periodicityInterest,"
            + "\n" + "        NULL AS t_sumProvidedInterest,"
            + "\n" + "        t_sumPaidInterest AS t_sumPaidInterest,"
            + "\n" + "        t_sumFines AS t_sumFines,"
            + "\n" + "        CASE"
            + "\n" + "           WHEN regHist.t_operationDate = MIN (regHist.t_operationDate) OVER (PARTITION BY contract.t_creditId, tranche.t_trancheNumber) "
            + "\n" + "             THEN"
            + "\n" + "               CASE"
            + "\n" + "           WHEN EXISTS(SELECT 1 "
            + "\n" + "                         FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                        WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                          AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                          AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate"
            + "\n" + "                          AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "           THEN (SELECT MAX(regHist.t_operationDate)"
            + "\n" + "                   FROM repLnsRegChangeHistory_vw regHist"
            + "\n" + "                  WHERE regHist.t_trancheNumber = tranche.t_trancheNumber"
            + "\n" + "                    AND regHist.t_trancheKind = tranche.t_trancheKind"
            + "\n" + "                    AND regHist.t_regKind IN (2, 3)"
            + "\n" + "                    AND regHist.t_operationKind = 4)"
            + "\n" + "           ELSE NULL"
            + "\n" + "               END "
            + "\n" + "           ELSE NULL"
            + "\n" + "        END t_dateRemovalDebt,"
            + "\n" + "        regHist.t_operationDate  AS t_maturityDateDebt,"
            + "\n" + "        operation.t_sourcePayment AS t_sourceRepayment,"
            + "\n" + "        operation.t_crdNumber AS t_codeNewCredit,"
            + "\n" + "        operation.t_regNumberCredOrg AS t_regNumber,"
            + "\n" + "        tranche.t_trancheNumber AS t_trancheNumber,"
            + "\n" + "        CASE "
            + "\n" + "           WHEN operation.t_sumPaidDebt > 0 "
            + "\n" + "              THEN "
            + "\n" + "                  (SELECT p3.t_fiCodeOrigcontract"
            + "\n" + "                    FROM df303p3_tmp p3"
            + "\n" + "                   WHERE p3.t_creditId = operation.t_creditId"
            + "\n" + "                     AND p3.t_trancheNumber = operation.t_trancheNumber"
            + "\n" + "                     AND p3.t_addLine = 0"
            + "\n" + "                  ) "
            + "\n" + "              ELSE NULL "
            + "\n" + "        END AS t_principalPaymentFiCode,"
            + "\n" + "        CASE "
            + "\n" + "           WHEN operation.t_sumPaidInterest > 0 "
            + "\n" + "              THEN "
            + "\n" + "                  (SELECT p3.t_fiCodeOrigcontract"
            + "\n" + "                    FROM df303p3_tmp p3"
            + "\n" + "                   WHERE p3.t_creditId = operation.t_creditId"
            + "\n" + "                     AND p3.t_trancheNumber = operation.t_trancheNumber"
            + "\n" + "                     AND p3.t_addLine = 0"
            + "\n" + "                  ) "
            + "\n" + "              ELSE NULL "
            + "\n" + "        END AS t_percentPaymentFiCode,"
            + "\n" + "        2 AS t_addLine"
            + "\n" + "   FROM (df303contracts_tmp contract INNER JOIN df303tranches_tmp tranche ON contract.t_creditId = tranche.t_creditId)"
            + "\n" + "        LEFT JOIN (SELECT DISTINCT lcusreg.t_objecttypeid AS t_trancheKind,                    "
            + "\n" + "                lcusreg.t_objectnumber AS t_trancheNumber,                           "
            + "\n" + "                crd_op.t_credoperdate AS t_operationDate                             "
            + "\n" + "           FROM dlchsumrg_dbt lchsumrg, dlcusreg_dbt lcusreg, dcrd_op_dbt crd_op     "
            + "\n" + "          WHERE lchsumrg.t_usregid_ref = lcusreg.t_id                                "
            + "\n" + "            AND lchsumrg.t_date = crd_op.t_credoperdate                              "
            + "\n" + "            AND crd_op.t_credoperid = lchsumrg.t_credoperid_ref                      "
            + "\n" + "            AND crd_op.t_isdeleted = 0                                               "
            + "\n" + "            AND crd_op.t_stageid_ref = 99                                            "
            + "\n" + "            AND lcusreg.t_regid IN (2,3)                                             "
            + "\n" + "            AND crd_op.t_systemoperationid=3                                         "
            + "\n" + "            AND (crd_op.t_credoperdate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate())"
            + "\n" + "            AND lchsumrg.t_sum <> 0) regHist ON (tranche.t_trancheKind = regHist.t_trancheKind AND tranche.t_trancheNumber = regHist.t_trancheNumber) "
            + "\n" + "        LEFT JOIN (SELECT oper.t_creditid,                                          "
            + "\n" + "                         oper.t_trancheKind,                                        "
            + "\n" + "                         oper.t_trancheNumber,                                      "
            + "\n" + "                         crdRefin.t_needSum,                                        "
            + "\n" + "                         DECODE(oper.t_sourcePayment, chr(1), '99','', '99', NULL, '99', oper.t_sourcePayment) AS t_sourcePayment, "
            + "\n" + "                         crdRefin.t_crdNumber,                                     "
            + "\n" + "                         oper.t_regNumberCredOrg,                                  "
            + "\n" + "                         SUM(oper.t_sumPaidOnMainDebt * crdRefin.t_needSum) AS t_sumPaidDebt,     "
            + "\n" + "                         SUM(oper.t_sumOfInterestPaid * crdRefin.t_needSum) AS t_sumPaidInterest, "
            + "\n" + "                         SUM(oper.t_sumOfCommissions * crdRefin.t_needSum) AS  t_sumFines         "
            + "\n" + "                    FROM df303Operation_tmp oper                                   "
            + "\n" + "                         LEFT JOIN (SELECT op.t_id,                                "
            + "\n" + "                                           DECODE(level, 1, 1, 0) AS t_needSum,    "
            + "\n" + "                                           REGEXP_SUBSTR(op.t_crdRefinId, '(\\d+)(,|$)', 1, level, 'c', 1) AS t_crdNumber "
            + "\n" + "                                      FROM df303Operation_tmp op                                                         "
            + "\n" + "                          CONNECT BY LEVEL <= REGEXP_COUNT(op.t_crdRefinId, '\\d+(,|$)')) crdRefin                       "
            + "\n" + "                         ON oper.t_id = crdRefin.t_id                                                                    "
             + "\n" + "                    GROUP BY oper.t_creditID, oper.t_trancheKind, oper.t_trancheNumber, oper.t_sourcePayment,           "
            + "\n" + "                             crdRefin.t_crdNumber, oper.t_regNumberCredOrg, crdRefin.t_needSum                           "
            + "\n" + "                    ) operation ON (operation.t_trancheKind = tranche.t_trancheKind AND operation.t_trancheNumber = tranche.t_trancheNumber)"
            + "\n" + "                    ORDER BY contract.t_creditID, tranche.t_trancheKind, tranche.t_trancheNumber, operation.t_sourcePayment, operation.t_crdNumber, operation.t_regNumberCredOrg, t_needSum"
            );

/* Основная строка для Кредитных договоров, Договоров о приобретении прав требования */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                                      T_PERIODICITYREPAYMENT,"
            + "\n" + "                                      T_SUMPROVIDEDDEBT,"
            + "\n" + "                                      T_SUMPAIDDEBT,"
            + "\n" + "                                      T_PERIODICITYINTEREST,"
            + "\n" + "                                      T_SUMPROVIDEDINTEREST,"
            + "\n" + "                                      T_SUMPAIDINTEREST,"
            + "\n" + "                                      T_SUMFINES,"
            + "\n" + "                                      T_DATEREMOVALDEBT,"
            + "\n" + "                                      T_MATURITYDATEDEBT,"
            + "\n" + "                                      T_SOURCEREPAYMENT,"
            + "\n" + "                                      T_CODENEWCREDIT,"
            + "\n" + "                                      T_REGNUMBER,"
            + "\n" + "                                      T_TRANCHENUMBER,"
            + "\n" + "                                      T_PRINCIPALPAYMENTFICODE,"
            + "\n" + "                                      T_PERCENTPAYMENTFICODE,"
            + "\n" + "                                      T_ADDLINE)"
            + "\n" + "WITH repaymentSheduleMaxDate AS ("
            + "\n" + "                                 SELECT repaymentShedule.t_periodPayOD, "
            + "\n" + "                                        repaymentShedule.t_periodPayPerc,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayOd,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayPerc,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                               FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                              WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                AND r.t_constructionDate <= rep_data.getEndDate)"
            + "\n" + "                                ),"
            + "\n" + "     repaymentSheduleByPeriod AS ("
            + "\n" + "                                 SELECT SUM(repaymentShedule.t_plannedPaySum)     AS t_plannedPaySum, "
            + "\n" + "                                        SUM(repaymentShedule.t_plannedPercentSum) AS t_plannedPercentSum,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND (repaymentShedule.t_plannedPayDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate < rep_data.getBeginDate)"
            + "\n" + "                               GROUP BY tranche.t_trancheNumber, tranche.t_trancheKind"
            + "\n" + "                                )"

            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE            "
            + "\n" + "          WHEN data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "            THEN                                  "
            + "\n" + "              CASE data.t_typePeriodPayOd         "
            + "\n" + "                 WHEN 1                           "
            + "\n" + "                   THEN 7                         "
            + "\n" + "                 WHEN 2                           "
            + "\n" + "                   THEN                           "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodPayOd, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodPayOd, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                       THEN 6                                                                                                                                        "
            + "\n" + "                       ELSE                                                                                                                                          "
            + "\n" + "                         DECODE(data.t_periodPayOd, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                         "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                         "
            + "\n" + "                ELSE 7                            "
            + "\n" + "              END                                 "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityRepayment,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "              THEN data.t_plannedPaySum                                             "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumProvidedDebt,"
            + "\n" + "       data.t_sumPaidDebt AS t_sumPaidDebt,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "            THEN                                                                    "
            + "\n" + "              CASE data.t_typePeriodicityInterest                                   "
            + "\n" + "                 WHEN 1                                                             "
            + "\n" + "                   THEN 7                                                           "
            + "\n" + "                 WHEN 2                                                             "
            + "\n" + "                   THEN                                                             "
            + "\n" + "                     CASE WHEN INSTR(data.t_periodicityInterest, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodicityInterest, ' Дн.','')) BETWEEN 1 AND 29                   "
            + "\n" + "                       THEN 6                                                                                                                                                "
            + "\n" + "                       ELSE                                                                                                                                                  "
            + "\n" + "                         DECODE(data.t_periodicityInterest, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "                     END                                                                                                                                             "
            + "\n" + "                 WHEN 3                           "
            + "\n" + "                   THEN 5                                                                                                                                       "
            + "\n" + "                 WHEN 4                           "
            + "\n" + "                   THEN 7                                                                                                                   "
            + "\n" + "                ELSE 7                                                                                                                   "
            + "\n" + "              END                                                                                                                   "
            + "\n" + "          ELSE NULL"
            + "\n" + "       END AS t_periodicityInterest,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN data.t_type != " + LO_OVERDRAFT + " AND data.t_type != " + LO_KARTA
            + "\n" + "              THEN data.t_sumProvidedInterest                                                                                                                                         "
            + "\n" + "          ELSE 0"
            + "\n" + "       END AS t_sumProvidedInterest,"
            + "\n" + "       data.t_sumPaidInterest AS t_sumPaidInterest,"
            + "\n" + "       data.t_sumFines AS t_sumFines,"
            + "\n" + "       data.t_dateRemovalDebt,"
            + "\n" + "       data.t_maturityDateDebt,"
            + "\n" + "       data.t_sourceRepayment AS t_sourceRepayment,"
            + "\n" + "       CASE WHEN instr(data.t_codeNewCredit, ',') > 0 THEN NULL ELSE data.t_codeNewCredit END  AS t_codeNewCredit,"
            + "\n" + "       CASE WHEN instr(data.t_regNumber, ',') > 0 THEN NULL ELSE data.t_codeNewCredit END  AS t_regNumber,"
            + "\n" + "       data.t_trancheNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND data.t_sumPaidDebt > 0"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_principalPaymentFiCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND data.t_sumPaidInterest > 0"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_percentPaymentFiCode,"
            + "\n" + "       0 T_ADDLINE"
            + "\n" + "  FROM ("
            + "\n" + "        SELECT "
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_type,"
            + "\n" + "               contract.t_fiId,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPaySum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_plannedPaySum,"
            + "\n" + "               contract.t_sumPaidOD AS t_sumPaidDebt,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodicityInterest,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPercentSum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_sumProvidedInterest,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodicityInterest,"
            + "\n" + "               contract.t_sumPaidPerc AS t_sumPaidInterest,"
            + "\n" + "               (SELECT SUM(p9.t_sumFines) FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) AS t_sumFines,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN (SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3)) > 0"
            + "\n" + "                      THEN                                            "
            + "\n" + "                        CASE"
            + "\n" + "                           WHEN NOT EXISTS(SELECT 1 "
            + "\n" + "                                             FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                            WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                              AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                              AND regHist.t_operationDate > rep_data.getBeginDate"
            + "\n" + "                                              AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                           THEN                                            "
            + "\n" + "                             (SELECT MIN(reg.t_date) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3))"
            + "\n" + "                        ELSE"
            + "\n" + "                          CASE"
            + "\n" + "                             WHEN EXISTS(SELECT 1 "
            + "\n" + "                                           FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                          WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                            AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                            AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                             THEN                                            "
            + "\n" + "                               ("
            + "\n" + "                                SELECT MAX (regHist.t_operationDate) AS t_operationDate"
            + "\n" + "                                  FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                   AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                   AND regHist.t_operationDate <= rep_data.getEndDate"
            + "\n" + "                                   AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind"
            + "\n" + "                               )"
            + "\n" + "                             ELSE NULL"
            + "\n" + "                           END "
            + "\n" + "                        END "
            + "\n" + "                  ELSE NULL"
            + "\n" + "               END   t_dateRemovalDebt,"
            + "\n" + "               NULL  AS t_maturityDateDebt,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(p9.t_sourceRepayment, ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) AS t_sourceRepayment,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_codeNewCredit, chr(1), null, ' ', null, p9.t_codeNewCredit), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) AS t_codeNewCredit,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_regNumber, chr(1), null, ' ', null, p9.t_regNumber), ',')) WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) AS t_regNumber,"
            + "\n" + "               contract.t_creditId AS t_trancheNumber"
            + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche"
            + "\n" + " WHERE contract.t_isCreditLine = 0"
            + "\n" + "           AND contract.t_creditId = tranche.t_creditId"
            + "\n" + "           ) data"
            + "\n" + "     UNION ALL "
            + "\n" + "        SELECT "
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               NULL AS t_periodPayOD,"
            + "\n" + "               NULL AS t_plannedPaySum,"
            + "\n" + "               NULL AS t_sumPaidDebt,"
            + "\n" + "               NULL AS t_periodicityInterest,"
            + "\n" + "               NULL AS t_sumProvidedInterest,"
            + "\n" + "               NULL AS t_sumPaidInterest,"
            + "\n" + "               NULL AS t_sumFines,"
            + "\n" + "               NULL AS t_dateRemovalDebt,"
            + "\n" + "               NULL  AS t_maturityDateDebt,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(p9.t_sourceRepayment, ',') WITHIN GROUP (ORDER BY p9.t_creditId)),  '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) AS t_sourceRepayment,"
            + "\n" + "               CASE"
            + "\n" + "                    WHEN instr((SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_codeNewCredit, chr(1), null, ' ', null, p9.t_codeNewCredit), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                                  FROM df303p9_tmp p9 "
            + "\n" + "                                 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2), ',') > 0 "
            + "\n" + "                       THEN NULL "
            + "\n" + "                    ELSE  "
            + "\n" + "                       (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_codeNewCredit, chr(1), null, ' ', null, p9.t_codeNewCredit), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                          FROM df303p9_tmp p9 "
            + "\n" + "                         WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2)"
            + "\n" + "               END  AS t_codeNewCredit,"
            + "\n" + "               CASE"
            + "\n" + "                    WHEN instr((SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_regNumber, chr(1), null, ' ', null, p9.t_regNumber), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                                  FROM df303p9_tmp p9 "
            + "\n" + "                                 WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2), ',') > 0 "
            + "\n" + "                       THEN NULL "
            + "\n" + "                    ELSE  "
            + "\n" + "                       (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_regNumber, chr(1), null, ' ', null, p9.t_regNumber), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)), '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                          FROM df303p9_tmp p9 "
            + "\n" + "                         WHERE p9.t_creditId = contract.t_creditID AND p9.t_addLine = 2) "
            + "\n" + "               END  AS t_regNumber,"
            + "\n" + "               contract.t_creditId AS t_trancheNumber,"
            + "\n" + "               NULL AS t_principalPaymentFiCode,"
            + "\n" + "               NULL AS t_percentPaymentFiCode,"
            + "\n" + "               0 AS t_addLine"
            + "\n" + "          FROM df303contracts_tmp contract"
            + "\n" + "         WHERE contract.t_isCreditLine = 1");

/* Дополнительные строки */
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p9_tmp (T_CREDITID,"
            + "\n" + "                         T_PERIODICITYREPAYMENT,"
            + "\n" + "                         T_SUMPROVIDEDDEBT,"
            + "\n" + "                         T_SUMPAIDDEBT,"
            + "\n" + "                         T_PERIODICITYINTEREST,"
            + "\n" + "                         T_SUMPROVIDEDINTEREST,"
            + "\n" + "                         T_SUMPAIDINTEREST,"
            + "\n" + "                         T_SUMFINES,"
            + "\n" + "                         T_DATEREMOVALDEBT,"
            + "\n" + "                         T_MATURITYDATEDEBT,"
            + "\n" + "                         T_SOURCEREPAYMENT,"
            + "\n" + "                         T_CODENEWCREDIT,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_TRANCHENUMBER,"
            + "\n" + "                         T_PRINCIPALPAYMENTFICODE,"
            + "\n" + "                         T_PERCENTPAYMENTFICODE,"
            + "\n" + "                         T_ADDLINE)"
            + "\n" + "WITH repaymentSheduleMaxDate AS ("
            + "\n" + "                                 SELECT repaymentShedule.t_periodPayOD, "
            + "\n" + "                                        repaymentShedule.t_periodPayPerc,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayOd,"
            + "\n" + "                                        repaymentShedule.t_typePeriodPayPerc,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate <= rep_data.getEndDate)"
            + "\n" + "                                ),"
            + "\n" + "     repaymentSheduleByPeriod AS ("
            + "\n" + "                                 SELECT SUM(repaymentShedule.t_plannedPaySum)     AS t_plannedPaySum, "
            + "\n" + "                                        SUM(repaymentShedule.t_plannedPercentSum) AS t_plannedPercentSum,"
            + "\n" + "                                        tranche.t_trancheNumber,"
            + "\n" + "                                        tranche.t_trancheKind"
            + "\n" + "                                   FROM repLnsPlanRepaymentSchedule_vw repaymentShedule,"
            + "\n" + "                                        df303tranches_tmp tranche"
            + "\n" + "                                  WHERE tranche.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                    AND tranche.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                    AND (repaymentShedule.t_plannedPayDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate)"
            + "\n" + "                                    AND repaymentShedule.t_constructionDate = (SELECT MAX(r.t_constructionDate) "
            + "\n" + "                                                                                 FROM repLnsPlanRepaymentSchedule_vw r"
            + "\n" + "                                                                                WHERE r.t_trancheNumber = repaymentShedule.t_trancheNumber"
            + "\n" + "                                                                                  AND r.t_trancheKind   = repaymentShedule.t_trancheKind"
            + "\n" + "                                                                                  AND r.t_constructionDate < rep_data.getBeginDate)"
            + "\n" + "                               GROUP BY tranche.t_trancheNumber, tranche.t_trancheKind"
            + "\n" + "                                )"

            + "\n" + "SELECT data.t_creditId,"
            + "\n" + "       CASE data.t_typePeriodPayOd        "
            + "\n" + "          WHEN 1                          "
            + "\n" + "            THEN 7                        "
            + "\n" + "          WHEN 2                          "
            + "\n" + "            THEN                          "
            + "\n" + "              CASE WHEN INSTR(data.t_periodPayOd, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodPayOd, ' Дн.','')) BETWEEN 1 AND 29                           "
            + "\n" + "                THEN 6                                                                                                                                        "
            + "\n" + "                ELSE                                                                                                                                          "
            + "\n" + "                  DECODE(data.t_periodPayOd, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "              END                                 "
            + "\n" + "          WHEN 3                                  "
            + "\n" + "            THEN 5                                "
            + "\n" + "          WHEN 4                                  "
            + "\n" + "            THEN 7                                "
            + "\n" + "         ELSE 7                                   "
            + "\n" + "       END AS t_periodicityRepayment,             "
            + "\n" + "       data.t_plannedPaySum AS t_sumProvidedDebt, "
            + "\n" + "       data.t_sumPaidDebt AS t_sumPaidDebt,       "
            + "\n" + "       CASE data.t_typePeriodicityInterest        "
            + "\n" + "          WHEN 1                                  "
            + "\n" + "            THEN 7                                "
            + "\n" + "          WHEN 2                                  "
            + "\n" + "            THEN                                  "
            + "\n" + "              CASE WHEN INSTR(data.t_periodicityInterest, 'Дн.') > 0 AND TO_NUMBER(REPLACE(data.t_periodicityInterest, ' Дн.','')) BETWEEN 1 AND 29         "
            + "\n" + "                THEN 6                                                                                                                                        "
            + "\n" + "                ELSE                                                                                                                                          "
            + "\n" + "                  DECODE(data.t_periodicityInterest, '1 Мес.', 1, '30 Дн.', 1, '3 Мес.', 2, '90 Дн.', 2, '6 Мес.', 3, '180 Дн.', 3, '12 Мес.', 4, '360 Дн.', 4, NULL) "
            + "\n" + "              END                                                                                                                                             "
            + "\n" + "          WHEN 3                           "
            + "\n" + "            THEN 5                                                                                                                                       "
            + "\n" + "          WHEN 4                           "
            + "\n" + "            THEN 7                                                                                                                   "
            + "\n" + "         ELSE 7                                                                                                                   "
            + "\n" + "       END AS t_periodicityInterest,"
            + "\n" + "       data.t_sumProvidedInterest AS t_sumProvidedInterest,"
            + "\n" + "       data.t_sumPaidInterest AS t_sumPaidInterest,"
            + "\n" + "       data.t_sumFines AS t_sumFines,"
            + "\n" + "       data.t_dateRemovalDebt,"
            + "\n" + "       data.t_maturityDateDebt,"
            + "\n" + "       data.t_sourceRepayment AS t_sourceRepayment,"
            + "\n" + "       CASE WHEN instr(data.t_codeNewCredit, ',') > 0 THEN NULL ELSE data.t_codeNewCredit END AS t_codeNewCredit,"
            + "\n" + "       CASE WHEN instr(data.t_regNumber, ',') > 0 THEN NULL ELSE data.t_codeNewCredit END  AS t_regNumber,"
            + "\n" + "       data.t_trancheNumber,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND data.t_sumPaidDebt > 0"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_principalPaymentFiCode,"
            + "\n" + "       CASE"
            + "\n" + "          WHEN rep_data.getEndDate() >= TO_DATE('01-07-2018', 'DD-MM-YYYY') AND data.t_sumPaidInterest > 0"
            + "\n" + "            THEN DECODE((SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid), '810', '643', (SELECT fin.t_isoNumber FROM drepfininstrument_vw fin WHERE fin.t_id = data.t_fiid))"
            + "\n" + "          ELSE CHR(1)"
            + "\n" + "       END AS t_percentPaymentFiCode,"
             + "\n" + "       1 T_ADDLINE"
            + "\n" + "  FROM (SELECT "
            + "\n" + "               contract.t_creditId,"
            + "\n" + "               contract.t_fiId,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPaySum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_plannedPaySum,"
            + "\n" + "               tranche.t_sumPaidOD AS t_sumPaidDebt,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_periodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_periodicityInterest,"
            + "\n" + "               (SELECT repaymentSheduleByPeriod.t_plannedPercentSum "
            + "\n" + "                  FROM repaymentSheduleByPeriod "
            + "\n" + "                 WHERE repaymentSheduleByPeriod.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleByPeriod.t_trancheNumber = tranche.t_trancheNumber) AS t_sumProvidedInterest,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayOD "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodPayOD,"
            + "\n" + "               (SELECT repaymentSheduleMaxDate.t_typePeriodPayPerc "
            + "\n" + "                  FROM repaymentSheduleMaxDate "
            + "\n" + "                 WHERE repaymentSheduleMaxDate.t_trancheKind = tranche.t_trancheKind "
            + "\n" + "                   AND repaymentSheduleMaxDate.t_trancheNumber = tranche.t_trancheNumber AND ROWNUM < 2) AS t_typePeriodicityInterest,"
            + "\n" + "               tranche.t_sumPaidPerc AS t_sumPaidInterest,"
            + "\n" + "               (SELECT SUM(p9.t_sumFines) FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND tranche.t_trancheNumber = p9.t_trancheNumber AND p9.t_addLine = 2) AS t_sumFines,"
            + "\n" + "               CASE"
            + "\n" + "                  WHEN (SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3)) > 0"
            + "\n" + "                      THEN                                            "
            + "\n" + "                        CASE"
            + "\n" + "                           WHEN NOT EXISTS(SELECT 1 "
            + "\n" + "                                             FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                            WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                              AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                              AND regHist.t_operationDate > rep_data.getBeginDate"
            + "\n" + "                                              AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                           THEN                                            "
            + "\n" + "                             (SELECT MIN(reg.t_date) FROM repLnsRegister_vw reg WHERE reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind AND reg.t_type IN (2, 3))"
            + "\n" + "                        ELSE"
            + "\n" + "                          CASE"
            + "\n" + "                             WHEN EXISTS(SELECT 1 "
            + "\n" + "                                           FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                          WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                            AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                            AND regHist.t_operationDate BETWEEN rep_data.getBeginDate AND rep_data.getEndDate"
            + "\n" + "                                            AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind)"
            + "\n" + "                             THEN                                            "
            + "\n" + "                               ("
            + "\n" + "                                SELECT MAX (regHist.t_operationDate) AS t_operationDate"
            + "\n" + "                                  FROM repLnsRegister_vw reg, repLnsRegChangeHistory_vw regHist"
            + "\n" + "                                WHERE reg.t_trancheNumber = regHist.t_trancheNumber AND reg.t_trancheKind = regHist.t_trancheKind"
            + "\n" + "                                   AND reg.t_type IN (2, 3) AND regHist.t_operationKind = 3 AND regHist.t_regKind = reg.t_type "
            + "\n" + "                                   AND regHist.t_operationDate <= rep_data.getEndDate"
            + "\n" + "                                   AND reg.t_trancheNumber = tranche.t_trancheNumber AND reg.t_trancheKind = tranche.t_trancheKind"
            + "\n" + "                               )"
            + "\n" + "                             ELSE NULL"
            + "\n" + "                           END "
            + "\n" + "                        END "
            + "\n" + "                  ELSE NULL"
            + "\n" + "               END   t_dateRemovalDebt,"
            + "\n" + "               NULL AS t_maturityDateDebt,  "
            + "\n" + "               (SELECT regexp_replace((LISTAGG(p9.t_sourceRepayment, ',') WITHIN GROUP (ORDER BY p9.t_creditId)),  '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_trancheNumber = tranche.t_trancheNumber AND p9.t_addLine = 2) AS t_sourceRepayment,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_codeNewCredit, chr(1), null, ' ', null, p9.t_codeNewCredit), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)),  '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_trancheNumber = tranche.t_trancheNumber AND p9.t_addLine = 2) AS t_codeNewCredit,"
            + "\n" + "               (SELECT regexp_replace((LISTAGG(NVL(DECODE(p9.t_regNumber, chr(1), null, ' ', null, p9.t_regNumber), ''), ',') WITHIN GROUP (ORDER BY p9.t_creditId)),  '([^,]+)(,\\1)+', '\\1') "
            + "\n" + "                  FROM df303p9_tmp p9 WHERE p9.t_creditId = contract.t_creditID AND p9.t_trancheNumber = tranche.t_trancheNumber AND p9.t_addLine = 2) AS t_regNumber,"
            + "\n" + "       tranche.t_trancheNumber   AS t_trancheNumber,"
            + "\n" + "               tranche.t_trancheKind AS t_trancheKind"
            + "\n" + "  FROM df303contracts_tmp contract, df303tranches_tmp tranche"
            + "\n" + "  WHERE contract.t_isCreditLine = 1 AND contract.t_creditId = tranche.t_creditId) data");
    end;

    initTF303Part9DataSource(protocolView, dataSources);
end;

class (RcbDataSource) TF303Part10DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getDataSourceFilters() : RcbDataSourceFilters
        return NULL;
    end;

    macro clear()
        sql_execute("TRUNCATE TABLE df303p10_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p10_tmp (T_CREDITID,"
            + "\n" + "                         T_METHODREFINANCING,"
            + "\n" + "                         T_SUMREFINANCINGDEBT,"
            + "\n" + "                         T_SUMFUNDS,"
            + "\n" + "                         T_PARTY,"
            + "\n" + "                         T_OGRN,"
            + "\n" + "                         T_REGNUMBER,"
            + "\n" + "                         T_OKSM)"

            + "\n" + "SELECT * FROM ("
            + "\n" + "SELECT 1, 'T_METHODREFINANCING1', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY1', 'T_OGRN1', 'T_REGNUMBER1', 'T_OKSM1' from dual"
            + "\n" + "UNION ALL"
            + "\n" + "SELECT 2, 'T_METHODREFINANCING2', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY2', 'T_OGRN2', 'T_REGNUMBER2', 'T_OKSM2' from dual"
            + "\n" + "UNION ALL"
            + "\n" + "SELECT 3, 'T_METHODREFINANCING3', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY3', 'T_OGRN3', 'T_REGNUMBER3', 'T_OKSM3' from dual"
            + "\n" + "UNION ALL"
            + "\n" + "SELECT 4, 'T_METHODREFINANCING4', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY4', 'T_OGRN4', 'T_REGNUMBER4', 'T_OKSM4' from dual"
            + "\n" + "UNION ALL"
            + "\n" + "SELECT 5, 'T_METHODREFINANCING5', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY5', 'T_OGRN5', 'T_REGNUMBER5', 'T_OKSM5' from dual"
            + "\n" + "UNION ALL"
            + "\n" + "SELECT 6, 'T_METHODREFINANCING6', 1000 T_SUMREFINANCINGDEBT, 1000 T_SUMFUNDS, 'T_PARTY6', 'T_OGRN6', 'T_REGNUMBER6', 'T_OKSM6' from dual)");
    end;

    macro getData()
        var query = "SELECT *"
            + "\n" + "   FROM df303p10_tmp p10";

        var dataSet = TRsbDataSet(query , RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;

    private macro constructorF303Part10DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("10", protocolView, dataSources);
    end;

    constructorF303Part10DataSource(protocolView, dataSources);
end;

class (TF303Part10DataSource) TF303Part10DataSource_4212(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF303Part10DataSource(protocolView, dataSources);

    macro cacheData(filter : RcbDataSourceFilter)
        sql_execute( "INSERT /*+ APPEND*/ INTO df303p10_tmp (T_CREDITID,          "
            + "\n" + "                                       T_METHODREFINANCING, "
            + "\n" + "                                       T_SUMREFINANCINGDEBT,"
            + "\n" + "                                       T_SUMFUNDS,          "
            + "\n" + "                                       T_PARTY,             "
            + "\n" + "                                       T_OGRN,              "
            + "\n" + "                                       T_REGNUMBER,         "
            + "\n" + "                                       T_OKSM,              "
            + "\n" + "                                       T_SUMDEAL,           "
            + "\n" + "                                       T_FICODE)            "
            + "\n" + "SELECT contract.t_creditId,                                 "
            + "\n" + "       NULL AS t_methodRefinancing,                         "
            + "\n" + "       NULL AS t_sumRefinancingDebt,                        "
            + "\n" + "       NULL AS t_sumFunds,                                  "
            + "\n" + "       NULL AS t_party,                                     "
            + "\n" + "       NULL AS t_ogrn,                                      "
            + "\n" + "       NULL AS t_regNumber,                                 "
            + "\n" + "       NULL AS t_oksm,                                      "
            + "\n" + "       NULL AS t_sumDeal,                                   "
            + "\n" + "       NULL AS t_fiCode                                     "
            + "\n" + "  FROM df303contracts_tmp contract                          ");
    end;

end;

class (RcbDataSources) TF303DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(TF303BaseDataSource(null, this));
        m_dataSourcePool.push_back(TF303Part1DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part2DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part3DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part4DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part5DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part6DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part7DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part8DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part9DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part10DataSource(null, this));
    end;
end;

class (RcbDataSources) TF303DataSources_4033(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(TF303BaseDataSource_4033(null, this));
        m_dataSourcePool.push_back(TF303Part1DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part2DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part3DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part4DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part5DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part6DataSource_4033(null, this));
        m_dataSourcePool.push_back(TF303Part7DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part8DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part9DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part10DataSource(null, this));
    end;
end;

class (RcbDataSources) TF303DataSources_4212(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(TF303BaseDataSource_4033(null, this));
        m_dataSourcePool.push_back(TF303Part1DataSource_4212(null, this));
        m_dataSourcePool.push_back(TF303Part2DataSource_4212(null, this));
        m_dataSourcePool.push_back(TF303Part3DataSource_4212(null, this));
        m_dataSourcePool.push_back(TF303Part4DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part5DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part6DataSource_4033(null, this));
        m_dataSourcePool.push_back(TF303Part7DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part8DataSource_4212(null, this));
        m_dataSourcePool.push_back(TF303Part9DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part10DataSource_4212(null, this));
    end;
end;

class (RcbDataSources) TF303DataSources_4637(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(TF303BaseDataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part1DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part2DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part3DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part4DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part5DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part6DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part7DataSource(null, this));
        m_dataSourcePool.push_back(TF303Part8DataSource_4212(null, this));
        m_dataSourcePool.push_back(TF303Part9DataSource_4637(null, this));
        m_dataSourcePool.push_back(TF303Part10DataSource_4212(null, this));
    end;
end;
