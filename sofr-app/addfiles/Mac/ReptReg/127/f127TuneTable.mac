/*
$Name: f127TuneTable.mac
$Module: Регламентируемая отчетность
$Description: Форма 127. Настроечная таблица
*/
import XmlRpcInter, ServiceAction;
import RcbGeneratedDataSource;
import RcbTuneTable;

/**
 * Класс настроечной таблицы для формы 127
 *
 * @param tableName String Наименование таблицы
 * @param instructionDate Date Дата указания
 */
class (RcbTuneTable) TF127TuneTable(instructionDate: Date)

    /**
     * Установить ключ поиска
     *
     * @param line String Строка
     * @param backOffice Integer Бэк-офис
     * @param column String Графа
     */
    private macro setKeyFilter(line: String, backOffice: Integer, column: String)

        setUserFilter
        (
                     "    t_line LIKE     " + getSqlString(line)
            + "\n" + "AND t_backOffice =  " + backOffice
            + "\n" + "AND t_column     = '" + column + "'"
        );

    end;

    /**
     * Получить маски лицевых счетов
     *
     * @param line String Строка
     * @param backOffice Integer Бэк-офис
     * @param column String Графа
     *
     * @return String Если найдено, то маски лицевых счетов, иначе - значение "EMPTY_MASKS"
     */
    macro getAccountMasks
    (
        line:       String,
        backOffice: Integer,
        column:     String
    ): String

        /**
         * Набор данных
         */
        var dataSet: Object = NULL;

        /**
         * Маски лицевых счетов
         */
        var result = "";

        setKeyFilter(line, backOffice, column);

        dataSet = getDataSet();

        if (dataSet.moveNext())

            result = dataSet.accountMasks;

        end;

        if ((result == "") OR (result == NULL))

            result = "EMPTY_MASKS";

        end;

        return result;

    end;

    /**
     * Получить номера регистров Loans
     *
     * @param line String Строка
     * @param backOffice Integer Бэк-офис
     * @param column String Графа
     *
     * @return String Если найдено, то строка с номерами регистров, иначе пустая строка
     */
    macro getRegistryNumbers
    (
        line:       String,
        backOffice: Integer,
        column:     String
    ): String

        /**
         * Набор данных
         */
        var dataSet: Object = NULL;

        /**
         * Регистры
         */
        var result = "";

        setKeyFilter(line, backOffice, column);

        dataSet = getDataSet();

        if (dataSet.moveNext())
            result = dataSet.registryNumber;
        end;

        if ((result == "") OR (result == NULL))
            result = "-1";
        end;

        return result;

    end;

    /**
     * Получить список полей настроечной таблицы.
     * Является истоником мета-данных для веб-интерфейса.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object

        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        /**
         * Результат
         */
        var result: TArray = TArray();

        /* result[result.size] = TMetaInformation */
        /* ( */
        /*     result.size, */
        /*     f127Constant.tuneTable.COLUMN_LINE, */
        /*     "Строка отчета", */
        /*     RCB_META_READONLY, */
        /*     RCB_META_VISIBLE */
        /* ); */
        /*  */
        /* result[result.size] = TMetaInformation */
        /* ( */
        /*     result.size, */
        /*     f127Constant.tuneTable.COLUMN_BACKOFFICE, */
        /*     "Бэк-офис", */
        /*     NOT RCB_META_READONLY, */
        /*     RCB_META_VISIBLE */
        /* ); */
        /* result[result.size - 1].type = TYPE_BACKOFFICE; // t_backoffice */
        /*  */
        /* result[result.size] = TMetaInformation */
        /* ( */
        /*     result.size, */
        /*     f127Constant.tuneTable.COLUMN_BACKOFFICEDISTR, */
        /*     "Бэк-офис дистр. значение", */
        /*     RCB_META_READONLY, */
        /*     NOT RCB_META_VISIBLE */
        /* ); */
        /*  */
        /* result[result.size] = TMetaInformation */
        /* ( */
        /*     result.size, */
        /*     f127Constant.tuneTable.COLUMN_ACCOUNTMASKS, */
        /*     "Маски л/с", */
        /*     NOT RCB_META_READONLY, */
        /*     RCB_META_VISIBLE */
        /* ); */
        /*  */
        /* result[result.size] = TMetaInformation */
        /* ( */
        /*     result.size, */
        /*     f127Constant.tuneTable.COLUMN_COMMENT, */
        /*     "Комментарий", */
        /*     NOT RCB_META_READONLY, */
        /*     RCB_META_VISIBLE */
        /* ); */

        return result;

    end;

    /**
     * Конструктор
     *
     * @param tableName String Наименование таблицы
     * @param instructionDate Date Дата указания
     */
    private macro constructorTF127TuneTable(instructionDate: Date)
        initRcbTuneTable("dt127_dbt");
        setInstructionFilter(NVL(instructionDate, RCB_I3875_DATE2));
    end;

    constructorTF127TuneTable(instructionDate);

end;

/**
 * Создать и вернуть объект настроечной таблицы.
 *
 * @param destination Указание.
 *
 * @return Объект настроечной таблицы в формате xml.
 */
macro getObjectTuneTableWeb(attribute /* : TRcbTuneTableItemTree */): String

    /**
     * Объект настроечной таблицы.
     */
    var tuneTable: Object = null;

    if (attribute.nameDesignation == NAME_DESTINATION_3606U)
        tuneTable = TF127TuneTable(RCB_I3875_DATE2);
    else
        runError("Неизвестная инструкция ЦБ \"" + attribute.nameDesignation + "\"");
    end;

    // Нижеследующие строки не менять, это часть инструментальной функциональности
    var metadataList = tuneTable.getMetadataTuneTableWeb();
    tuneTable.saveMetadataTuneTable(metadataList);
    tuneTable.saveDataTuneTable();

    var resultXml: String = "";
    if (convertToXml(tuneTable, null, resultXml) != 0)
        runError("Ошибка преобразования объекта настроечной таблицы в XML");
    end;

    return resultXml;

end;

/**
 * Получить массив указаний\разделов для настроечной таблицы.
 *
 * @return TArray Массив указаний\разделов.
 */
macro getDestinationTuneTableWeb(): String

    var result = TArray();

    /* result[result.size] = NAME_DESTINATION_3606U; */

    // Нижеследующие строки не менять, это часть инструментальной функциональности
    var resultXml : String = "";
    if (convertToXml(result, null, resultXml) != 0)
        runError("Ошибка преобразования списка указаний\разделов в XML");
    end;

    return resultXml;

end;
