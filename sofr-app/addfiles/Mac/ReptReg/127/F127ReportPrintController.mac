/*
$Name:          F127ReportPrintController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 127. Контроллер печати отчета
*/
import rcw;

class (RcbReportPrintController) TF127ReportPrintController(format : Integer)
    private var m_format : Integer;
    private var m_part;
    private var m_currency;
    private var m_checkReportError : Bool = false;

    private var m_jvm : Object;
    private var m_attributeValueContainer : Object;

    private macro makeAttributeKey(currency : String, row : String, column : String)
        return currency + row + column;
    end;

    private macro fillAttributeValueContainer()
        m_attributeValueContainer = m_jvm.createJavaObject("java.util.HashMap", "<init>");

        for (var attribute, m_part.getAttributes())
            var attributeKey = makeAttributeKey(attribute.fieldValue(f127Constant.structure.CURRENCY).exactAsString,
                                                attribute.fieldValue(f127Constant.structure.LINE).exactAsString,
                                                attribute.fieldValue(f127Constant.structure.COLUMN).exactAsString
                                               );

            m_attributeValueContainer.put(attributeKey, attribute);
        end;
    end;

    private macro printCommonString(rowNumber, description)
        getReportView().getPartView("1").printCommonString(rowNumber, description);
    end;

    private macro getRcbAttribute(currency, row, column)
        return m_attributeValueContainer.get(makeAttributeKey(currency, row, String(column)));
    end;

    private macro checkReportOnCurrency()
        var codeCurrency = TF127Parameters().getCodeCurrencyArray();
        var reportMode = TF127Global().getReportMode();
        var subString : string;
        var i;

        if ((reportMode == 0) and (m_part.checkRcbAttributeCurrency("000") == true))
            subString = "";
        else subString = "\"Расчет по всем валютам\"";
        end;
        if (reportMode == 1)
            for (i, 0, codeCurrency.size - 1)
                if (m_part.checkRcbAttributeCurrency(codeCurrency[i]) == true)
                    subString = "";
                else subString = "\"Расчет в разрезе валют\"";
                end;
            break;
            end;
        end;
        if (subString!= "")
            m_checkReportError = true;
            RepErrorsQueue().add(0, "Печать может быть выполнена только после выполнения операции "+ subString);
            msgBox("Печать может быть выполнена только после выполнения операции " + subString);
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;
    end;

    private macro printDataString(rowNumber : String, description : String, separatorNeed : bool)
        var dataArray = RcbArray().initialize(rowNumber, description);

        var i = m_report.getFirstColumn();
        while (i <= m_report.getLastColumn)
            var fieldValue = getRcbAttribute(m_currency, rowNumber, i).fieldValue(f127Constant.structure.VALUE);
            var value = null;
            if (not fieldValue.isDefined())
                value =  "X";
            else
                if ((rowNumber == "8.1") or (rowNumber == "8.2"))
                   value = string(fieldValue.exact);
                elif (rowNumber == "8.3")
                   value = string(fieldValue.exact :r:0:4);
                else
                    value = fieldValue.currentAsString;
                end;
            end;
            dataArray.push_back(value);

            i = i + 1;
        end;

        getReportView().getPartView("1").printString(dataArray, separatorNeed);
    end;

    macro printNote()
        var note =  m_part.getNoteAsArray(m_currency);

        getReportView().getPartView("1").printNote(note);
    end;

    private macro printData()
        printCommonString("1", "БАЛАНСОВЫЕ АКТИВЫ");
        printDataString("1.1","Денежные средства и их эквиваленты");
        printDataString("1.2","Средства на корреспондентских счетах в кредитных организациях");
        printDataString("1.3","Ссудная задолженность, всего, из них:");
        printDataString("1.3.1","кредитных организаций");
        printDataString("1.3.2","юридических лиц, не являющихся кредитными организациями, всего, из них:");
        printDataString("1.3.2.1","ссуды в виде \"до востребования\" и \"овердрафт\"");
        printDataString("1.3.3","физических лиц, всего, \nиз них:");
        printDataString("1.3.3.1","ссуды с использованием банковских карт");
        printDataString("1.3.3.2","жилищные ссуды");
        printDataString("1.4","Вложения в долговые обязательства");
        printDataString("1.5","Вложения в долевые ценные бумаги");
        printDataString("1.6","Прочие активы");
        printDataString("1.7","Основные средства и нематериальные активы");
        printCommonString("2","ВНЕБАЛАНСОВЫЕ ТРЕБОВАНИЯ");
        printDataString("2.1","Фьючерсы");
        printDataString("2.2","Форварды");
        printDataString("2.3","Валютно-процентные свопы");
        printDataString("2.4","Процентные свопы");
        printDataString("2.5","Опционы \"Put\"");
        printDataString("2.6","Опционы \"Call\"");
        printDataString("2.7","Прочие договоры (контракты)");
        printDataString("3","Итого балансовых активов и внебалансовых требований");
        printCommonString("4","БАЛАНСОВЫЕ ПАССИВЫ");
        printDataString("4.1","Средства кредитных организаций, всего, из них:");
        printDataString("4.1.1","на корреспондентских счетах");
        printDataString("4.1.2","межбанковские ссуды, депозиты");
        printDataString("4.2","Средства клиентов, не являющихся кредитными организациями, всего, из них:");
        printDataString("4.2.1","на расчетных (текущих) счетах юридических и физических лиц");
        printDataString("4.2.2","депозиты юридических лиц");
        printDataString("4.2.3","вклады (депозиты) физических лиц");
        printDataString("4.3","Выпущенные долговые обязательства");
        printDataString("4.4","Прочие пассивы");
        printDataString("4.5","Источники собственных средств (капитала)");
        printCommonString("5","ВНЕБАЛАНСОВЫЕ ОБЯЗАТЕЛЬСТВА");
        printDataString("5.1","Фьючерсы");
        printDataString("5.2","Форварды");
        printDataString("5.3","Валютно-процентные свопы");
        printDataString("5.4","Процентные свопы");
        printDataString("5.5","Опционы \"Put\"");
        printDataString("5.6","Опционы \"Call\"");
        printDataString("5.7","Прочие договоры (контракты)");
        printDataString("6","Итого балансовых пассивов и внебалансовых обязательств");
        printDataString("7","Совокупный ГЭП (строка 3 - строка 6)");
        printDataString("8","Изменение чистого процентного дохода:");
        printDataString("8.1","+ 400 базисных пунктов");
        printDataString("8.2","- 400 базисных пунктов");
        printDataString("8.3","временной коэффициент");
    end;

    private macro printDataZone()
        fillAttributeValueContainer();

        var codeCurrency = TF127Parameters().getCodeCurrencyArray();
        var i;

        for (i, 0, codeCurrency.size - 1)
            m_currency = codeCurrency[i];
            getReportView().getPartView("1").printCurrency(codeCurrency[i]);
            getReportView().getPartView("1").printHead();
            printData();

            getReportView().getPartView("1").printBottom();

            printNote();
        end;
    end;

    private macro destructor()
        if ((m_format == WINREP_FORMAT_XLSX) and (m_checkReportError == false))
            var view = getReportView();
            view.printSignatureZone();

            if (not m_protocolView.isEmpty())
                m_protocolView.show();
            end;

            view.resetOutputFile();

            view.createExcel();

            view.showExcel();
        elif (m_checkReportError)
            if (not m_protocolView.isEmpty())
                m_protocolView.show();
            end;
        else
            destructor();
        end;
    end;

    private macro constructorTF127ReportPrintController(format : Integer)
        initRcbReportPrintController();

        m_format = nvl(format, WINREP_FORMAT_HTML);

        if (m_format == WINREP_FORMAT_XLSX)
            m_reportView = objectFactoryInstance.createReportExcelView(getProtocolView());
        end;

        m_jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");

        m_part        = objectFactoryInstance.createReport(TF127Global().getRcbReport()).getPart(f127Constant.part.PART_DATA);
        m_reportWidth = getReportView().getPartView("1").getWidth();
        m_attributeValueContainer = null;
    end;

    constructorTF127ReportPrintController(format);

end;

class (TF127ReportPrintController) TF127ReportPrintController_4212(format : Integer)
    initTF127ReportPrintController(format);

    private macro printData()
        printCommonString("1", "БАЛАНСОВЫЕ АКТИВЫ");
        printDataString("1.1","Денежные средства и их эквиваленты", false);
        printDataString("1.2","Средства на корреспондентских счетах в кредитных организациях");
        printDataString("1.3","Ссудная задолженность, всего, из нее:");
        printDataString("1.3.1","кредитных организаций");
        printDataString("1.3.2","юридических лиц, не являющихся кредитными организациями, всего, из них:");
        printDataString("1.3.2.1","ссуды в виде \"до востребования\" и \"овердрафт\"");
        printDataString("1.3.3","физических лиц, всего, \nиз них:");
        printDataString("1.3.3.1","ссуды с использованием банковских карт");
        printDataString("1.3.3.2","жилищные ссуды");
        printDataString("1.4","Вложения в долговые обязательства");
        printDataString("1.5","Вложения в долевые ценные бумаги");
        printDataString("1.6","Прочие активы");
        printDataString("1.7","Основные средства и нематериальные активы");
        printCommonString("2","ВНЕБАЛАНСОВЫЕ ТРЕБОВАНИЯ");
        printDataString("2.1","Фьючерсы", false);
        printDataString("2.2","Форварды");
        printDataString("2.3","Валютно-процентные свопы");
        printDataString("2.4","Процентные свопы");
        printDataString("2.5","Опционы \"Put\"");
        printDataString("2.6","Опционы \"Call\"");
        printDataString("2.7","Прочие договоры (контракты)");
        printDataString("3","Итого балансовых активов и внебалансовых требований");
        printCommonString("4","БАЛАНСОВЫЕ ПАССИВЫ");
        printDataString("4.1","Средства кредитных организаций, всего, из них:", false);
        printDataString("4.1.1","на корреспондентских счетах");
        printDataString("4.1.2","межбанковские ссуды, депозиты");
        printDataString("4.2","Средства клиентов, не являющихся кредитными организациями, всего, из них:");
        printDataString("4.2.1","на расчетных (текущих) счетах юридических и физических лиц");
        printDataString("4.2.2","депозиты юридических лиц");
        printDataString("4.2.3","вклады (депозиты) физических лиц");
        printDataString("4.3","Выпущенные долговые обязательства");
        printDataString("4.4","Прочие пассивы");
        printDataString("4.5","Источники собственных средств (капитала)");
        printCommonString("5","ВНЕБАЛАНСОВЫЕ ОБЯЗАТЕЛЬСТВА");
        printDataString("5.1","Фьючерсы", false);
        printDataString("5.2","Форварды");
        printDataString("5.3","Валютно-процентные свопы");
        printDataString("5.4","Процентные свопы");
        printDataString("5.5","Опционы \"Put\"");
        printDataString("5.6","Опционы \"Call\"");
        printDataString("5.7","Прочие договоры (контракты)");
        printDataString("6","Итого балансовых пассивов и внебалансовых обязательств");
        printDataString("7","Совокупный ГЭП (строка 3 - строка 6)");
        printDataString("8","Изменение чистого процентного дохода:");
        printDataString("8.1","+ 200 базисных пунктов");
        printDataString("8.2","- 200 базисных пунктов");
        printDataString("8.3","временной коэффициент");
    end;

    macro print()
        checkReport();
        checkReportOnCurrency();

        getReportView().setOutputFile();

        getReportView().setReportWidth(m_reportWidth);
        getReportView().printLendingAgencyCodeZone();
        getReportView().printNamesZone("Полное или сокращенное фирменное наименование кредитной организации (головной кредитной организации банковской группы) ",
                                       "Адрес (место нахождения) кредитной организации (головной кредитной организации банковской группы) ");

        if (getReport().isEmpty())
            getReportView().printNullDataZone();
        else
            printDataZone();
        end;
    end;
end;