/*
$Name:          f127CalculateProtocolView.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 127. Классы протоколов расчета.
*/

import ofstream;

private class (RcbDataProtocolView) TF127ProtocolData(id : String)
    private const DELIMITER = "\t";

    private var m_stream          : Object;
    private var m_isHeaderPrinted : Bool;

    private macro initialize()
    end;

    macro getFileName()
        var name     = m_stream.getFileName();
        var dotIndex = strlen(name);

        while ((dotIndex > 0) and (substr(name, dotIndex, 1) != "."))
            dotIndex = dotIndex - 1;
        end;
        if (dotIndex == 0)
            dotIndex = strlen(name) + 1;
        end;
        strset(name, dotIndex, "_");
        name = name + ".csv";

        return name;
    end;

    macro save()
        m_stream.save(getFileName());
    end;

    macro printString()
        var i = 1;
        var p = null;
        var str = "";

        while (getParm(i, p))
            str = str + DELIMITER + "\"" + ternary(p != null, p, "") + "\"";
            i = i + 1;
        end;
        str = substr(str, 2);

        m_stream.setOutputFile();
        println(str);
        m_stream.resetOutputFile();
    end;

    private macro printHeader()
    end;

    macro printRow(maskRow:string)
        var nameBackOffice : String = ""; 
        if   ((getId() == "cb_active") or (getId() == "cb_passive") or 
              (getId() == "cb_passive_4_5_plus") or (getId() == "cb_passive_4_5_minus"))
            nameBackOffice = "Главная книга.";
        elif (getId() == "loans")
            nameBackOffice = "Кредитование.";
        elif (getId() == "retail")   
            nameBackOffice = "Вклады.";
        elif (getId() == "deposit")
            nameBackOffice = "Депозиты.";
        end;
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            printString("Все валюты. Строка " + maskRow +". " + nameBackOffice);
        else
            printString("В разрезе валют. Строка " + maskRow +". "+ nameBackOffice);
        end;
    end;

private macro constructorTF127ProtocolData(id : String)
        initRcbDataProtocolView(id);
      
        m_stream          = TOfstream("f127_calculate_" + id);
        m_isHeaderPrinted = false;
    end;

    constructorTF127ProtocolData(id);
end;

class (TF127ProtocolData) TF127ProtocolDataLoans(id)
    private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Строка отчета",
                        "Номер договора",
                        "Номер транша",
                        "Тип договора",
                        "Контрагент по договору",
                        "ККС",
                        "Дата окончания договора/транша",
                        "Процентная ставка",
                        "% резервирования",
                        "Вид Объекта",
                        "Сумма в отчете",
                        "Временной интервал"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127ProtocolDataLoans(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127ProtocolDataLoans(id);
end;

class (TF127ProtocolData) TF127ProtocolDataDeposit(id)
    private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Строка отчета",
                        "Номер договора",
                        "Номер транша",
                        "Тип договора",
                        "Контрагент по договору",
                        "ККС",
                        "Дата окончания договора/транша",
                        "Процентная ставка",
                        "% резервирования",
                        "Вид Объекта",
                        "Сумма в отчете",
                        "Временной интервал"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127ProtocolDataDeposit(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127ProtocolDataDeposit(id);
end;

class (TF127ProtocolData) TF127ProtocolDataRetail(id)
    private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Номер договора",
                        "Код клиента",
                        "До востребования",
                        "Дата окончания",
                        "Сумма вклада"
                        "Сумма вклада",
                        "Временной интервал"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127ProtocolDataRetail(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127ProtocolDataRetail(id);
end;

class (TF127ProtocolData) TF127ProtocolDataCb(id)
   private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Строка отчета",
                        "Лицевой счет",
                        "Вид инструмента",
                        "Сведения о риске для % ставки",
                        "Категория качества",
                        "Дата погашения",
                        "Остаток счета в рублях",
                        "Расчетный резерв",
                        "% резервирования",
                        "Бэк-офис/Номер проц. договора",
                        "Тип % ставки",
                        "Основной ПД по счету",
                        "Сумма в отчете",
                        "Временной интервал"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127ProtocolDataCbActive(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127ProtocolDataCbActive(id);
end;

//абстрактный класс контейнера протоколов (если ИД нужно более одного протокола)
//в потомках нужно перекрывать initialize(), где заполнять m_protocols нужными протоколами
private class (RcbDataProtocolView) TF127ProtocolsContainer(id : String)
    private var m_protocols : RcbArray;

    macro getDataProtocolView(id : String) : RcbDataProtocolView
        m_protocols.moveFirst();
        while (m_protocols.moveNext())
            if (m_protocols.getCurrentItem().getId() == id)
                return m_protocols.getCurrentItem();
            end;
        end;

        return null;
    end;

    macro save()
        var i = 0;
        while (i < m_protocols.getCount())
            m_protocols[i].save();
            i = i + 1;
        end;
    end;

    private macro constructorTF127ProtocolsContainer(id : String)
        initRcbDataProtocolView(id);
    end;

    constructorTF127ProtocolsContainer(id);
end;

class (TF127ProtocolData) TF127MbkProtocols(id : String)
    private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Номер сделки",
                        "Вид сделки",
                        "Категория качества",
                        "Дата погашения планируемая",
                        "Процентная ставка",
                        "Процент резерва",
                        "Остаток основного долга",
                        "Сумма просроченного основного долга",
                        "Сумма начисленных процентов",
                        "Сумма просроченных процентов",
                        "Временной интервал",
                        "Сумма в отчете",
                        "Временной интервал"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127MbkProtocols(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127MbkProtocols(id);
end;

class (TF127ProtocolData) TF127ProtocolDataSecuritis(id)
    private macro printHeader()
        if (not m_isHeaderPrinted)
            printString("Договор",
                        "Строка",
                        "Графа",
                        "Сумма",
                        "Валюта"
                       );
            m_isHeaderPrinted = true;
        end;
    end;

    macro constructorTF127ProtocolDataSecuritis(id)
        initTF127ProtocolData(id);

        printHeader();
    end;

    constructorTF127ProtocolDataSecuritis(id);
end;

class (RcbCalculateProtocolView) TF127CalculateProtocolView(protocolName : String)
    private macro initialize()
        m_dataProtocolViewPull.push_back(TF127ProtocolDataCb("cb"));
        m_dataProtocolViewPull.push_back(TF127ProtocolDataLoans("loans"));
        m_dataProtocolViewPull.push_back(TF127MbkProtocols("mbk"));
        m_dataProtocolViewPull.push_back(TF127ProtocolDataRetail("retail"));
        m_dataProtocolViewPull.push_back(TF127ProtocolDataDeposit("deposit"));
        m_dataProtocolViewPull.push_back(TF127ProtocolDataSecuritis("securitis"));
    end;

    private macro constructorTF127CalculateProtocolView(protocolName : String)
        initRcbCalculateProtocolView(null, protocolName);
    end;

    constructorTF127CalculateProtocolView(protocolName);
end;