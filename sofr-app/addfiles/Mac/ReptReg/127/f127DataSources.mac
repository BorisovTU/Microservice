/*
$Name:          f127DataSources.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 127. Источники данных.
*/

import SbCrdInter;
import lib_str;
import rcb_bo;
import dlreprisk;

/**
 * константы строк п/с Securitis
 */
const SECURITIS_ROW_CODE_1_3_1 = 1,
      SECURITIS_ROW_CODE_1_3_2 = 2,
      SECURITIS_ROW_CODE_1_3_2_1 = 3,
      SECURITIS_ROW_CODE_1_3_3 = 4,
      SECURITIS_ROW_CODE_1_4 = 5,
      SECURITIS_ROW_CODE_1_5 = 6,
      SECURITIS_ROW_CODE_1_6 = 7,
      SECURITIS_ROW_CODE_2_1 = 8,
      SECURITIS_ROW_CODE_2_2 = 9,
      SECURITIS_ROW_CODE_2_3 = 10,
      SECURITIS_ROW_CODE_2_4 = 11,
      SECURITIS_ROW_CODE_2_5 = 12,
      SECURITIS_ROW_CODE_2_6 = 13,
      SECURITIS_ROW_CODE_4_3 = 14,
      SECURITIS_ROW_CODE_4_4 = 15,
      SECURITIS_ROW_CODE_5_1 = 16,
      SECURITIS_ROW_CODE_5_2 = 17,
      SECURITIS_ROW_CODE_5_3 = 18,
      SECURITIS_ROW_CODE_5_4 = 19,
      SECURITIS_ROW_CODE_5_5 = 20,
      SECURITIS_ROW_CODE_5_6 = 21;

class TTerms(from : integer, to : integer)
    private var m_from : integer;
    private var m_to   : integer;

    macro getFrom()
        return m_from;
    end;

    macro getTo()
        return m_to;
    end;

    macro constructorTTerms(from : integer, to : integer)
        m_from = from;
        m_to   = to;
    end;

    constructorTTerms(from, to);
end;

/**
* Форма 127. Источник данных Формы 127
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/

private class (RcbDataSource) TF127DataSourceBase(id : string, protocolView : RcbDataProtocolView)
    var m_terms = TArray();
    private var m_report : Object;

    /**
    * Бэк-офис
    */
    private var m_backOffice: Object = NULL;

    /**
    * Фильтры
    */
    private var m_dataFilter: Object = NULL;

    /**
    * Настроечная таблица
    */
    private var m_tuneTable: Object = NULL;

    /**
    * Маски лицевых счетов
    */
    private var m_accountMasks: String = "";

    private macro fillTerms()
        var day   = 0;
        var month = 0;
        var year  = 0;
        var endDate = RcbApplication().currentReport.context.period.endDate;

        dateSplit(endDate, day, month, year);

        m_terms[m_terms.size] = TTerms(0,  30);
        m_terms[m_terms.size] = TTerms(31, 90);
        m_terms[m_terms.size] = TTerms(91, 180);
        m_terms[m_terms.size] = TTerms(181, date(day, month, year + 1) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 1) - endDate + 1, date(day, month, year + 2) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 2) - endDate + 1, date(day, month, year + 3) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 3) - endDate + 1, date(day, month, year + 4) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 4) - endDate + 1, date(day, month, year + 5) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 5) - endDate + 1, date(day, month, year + 7) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 7) - endDate + 1, date(day, month, year + 10) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 10) - endDate + 1, date(day, month, year + 15) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 15) - endDate + 1, date(day, month, year + 20) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 20) - endDate + 1, date(31, 12, 9999));
    end;

    private macro setBackOffice(id : Object)
        m_backOffice = id;
    end;

    private macro setTuneTable(tuneTable :  RcbTuneTable)
        m_tuneTable = tuneTable;
    end;

    /*
    * Возвращает "нулевую" дату
    */
    private macro getNullDate()
        //return date(1,1,1);
        return "to_date(" + getSqlString("01.01.0001") + "," +  getSqlString("dd.mm.yyyy") + ")";
    end;

    /*
    * Возвращает объект Фильтр
    */
    macro getFilter()
        return m_dataFilter;
    end;

    private macro getBackOffice();
        return m_backOffice;
    end;

    private macro getTuneTable() :  RcbTuneTable
        return m_tuneTable;
    end;

    private macro getAccountMask(row : String, column : String)
        return getTuneTable().getAccountMasks(row, getBackOffice().getId(), column);
    end;

    private macro getRegisterMask(row : String, column : String)
        return getTuneTable().getRegistryNumbers(row, getBackOffice().getId(), column);
    end;

    macro getTerms(column : integer)
        return m_terms[column - m_report.getFirstColumn()];
    end;

    macro getCurrencyFilter(alias : string)
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "(1 = 1)";
        else
            return alias + " IN (" + TF127ParametersImpl().getCurrencyCodesAsSqlString()() + ")";
        end;
    end;

    /**
    * Определение графы отчета по временному интервалу
    */
    private macro getTermsCondition(alias)
        var str = "";
        var i = 0;

        str =  "\n" + "CASE ";

        for (i, m_report.getFirstColumn(),m_report.getLastColumn() - 1)
            str = str + "\n" + "    WHEN " + alias + " BETWEEN " + getTerms(i).getFrom() + " AND " + getTerms(i).getTo();
            str = str + "\n" + "        THEN " + string(i);
        end;

        str = str  + "\n" + "       WHEN " +  alias + " < 0 ";
        str = str  + "\n" + "         THEN " + m_report.getFirstColumn();
        str = str  + "\n" + "         ELSE 0 "  ;
        str = str  + "\n" + "     END ";

        return str;
    end;

    // Вставка в таблицу рассчитанных данных из sql запроса
    private macro summaryInserter(cmdQuery : string)
        var strCmd = "INSERT INTO df127_tmp (t_contractId, t_row, t_column, t_value, t_currency, t_boffice) " + "\n";

        strCmd = strCmd + cmdQuery;

        sql_execute(strCmd);
    end;

    macro constructorTF127DataSourceBase(id : String, protocolView : RcbDataProtocolView)
        initRcbDataSource(id, protocolView);
        m_report = objectFactoryInstance.createReport(TF127Global().getRcbReport());
        fillTerms();
    end;

    constructorTF127DataSourceBase(id, protocolView);
end;

private class (TF127DataSourceBase) TF127DataSourceBase_4637(id : string, protocolView : RcbDataProtocolView)
    private macro fillTerms()
        var day   = 0;
        var month = 0;
        var year  = 0;
        var endDate = RcbApplication().currentReport.context.period.endDate;

        dateSplit(endDate, day, month, year);

        m_terms[m_terms.size] = TTerms(0,  30);
        m_terms[m_terms.size] = TTerms(31, 90);
        m_terms[m_terms.size] = TTerms(91, 180);
        m_terms[m_terms.size] = TTerms(181, date(day, month, year + 1) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 1) - endDate + 1, date(day, month, year + 2) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 2) - endDate + 1, date(day, month, year + 3) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 3) - endDate + 1, date(day, month, year + 4) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 4) - endDate + 1, date(day, month, year + 5) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 5) - endDate + 1, date(day, month, year + 7) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 7) - endDate + 1, date(day, month, year + 10) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 10) - endDate + 1, date(day, month, year + 15) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 15) - endDate + 1, date(day, month, year + 20) - endDate);
        m_terms[m_terms.size] = TTerms(date(day, month, year + 20) - endDate + 1, date(31, 12, 9999));
    end;

    private macro setBackOffice(id : Object)
        m_backOffice = id;
    end;

    private macro setTuneTable(tuneTable :  RcbTuneTable)
        m_tuneTable = tuneTable;
    end;

    /*
    * Возвращает "нулевую" дату
    */
    private macro getNullDate()
        //return date(1,1,1);
        return "to_date(" + getSqlString("01.01.0001") + "," +  getSqlString("dd.mm.yyyy") + ")";
    end;

    /*
    * Возвращает объект Фильтр
    */
    macro getFilter()
        return m_dataFilter;
    end;

    private macro getBackOffice();
        return m_backOffice;
    end;

    private macro getTuneTable() : RcbTuneTable
        return m_tuneTable;
    end;

    private macro getAccountMask(row : String, column : String)
        return getTuneTable().getAccountMasks(row, getBackOffice().getId(), column);
    end;

    private macro getRegisterMask(row : String, column : String)
        return getTuneTable().getRegistryNumbers(row, getBackOffice().getId(), column);
    end;

    macro getTerms(column : integer)
        return m_terms[column - m_report.getFirstColumn()];
    end;

    macro getCurrencyFilter(alias : string)
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "(1 = 1)";
        else
            return alias + " IN (" + TF127ParametersImpl().getCurrencyCodesAsSqlString()() + ")";
        end;
    end;

    /**
    * Определение графы отчета по временному интервалу
    */
    private macro getTermsCondition(alias)
        var str = "";
        var i = 0;

        str =  "\n" + "CASE ";

        for (i, m_report.getFirstColumn(),m_report.getLastColumn() - 1)
            str = str + "\n" + "    WHEN " + alias + " BETWEEN " + getTerms(i).getFrom() + " AND " + getTerms(i).getTo();
            str = str + "\n" + "        THEN " + string(i);
        end;

        str = str  + "\n" + "       WHEN " +  alias + " < 0 ";
        str = str  + "\n" + "         THEN " + m_report.getFirstColumn();
        str = str  + "\n" + "         ELSE 0 "  ;
        str = str  + "\n" + "     END ";

        return str;
    end;

    /**
    * Заполнить временные интервалы для каждого столбца
    */
    private macro getTermsIntervals()
        var str = "";
        var i = 0;

        for (i, m_report.getFirstColumn(),m_report.getLastColumn() - 1)
            if (i == m_report.getLastColumn() - 1)
                str = str + "\n" + "SELECT rep_data.getEndDate() + " + getTerms(i).getFrom() + "  AS t_previousDate,"
                          + "\n" + "       TO_DATE('31.12.9999', 'dd.mm.yyyy') AS t_date, "
                          + "\n            " + getTerms(i).getFrom() + "                     AS t_startDay,"
                          + "\n            " + getTerms(i).getTo()   + "                    AS t_endDay,"
                          + "\n            " + i + " AS t_column"
                          + "\n" + "  FROM DUAL ";
            else
                str = str + "\n" + "SELECT rep_data.getEndDate() + " + getTerms(i).getFrom() + "  AS t_previousDate,"
                          + "\n" + "       rep_data.getEndDate() + " + getTerms(i).getTo() + " AS t_date,"
                          + "\n            " + getTerms(i).getFrom() + "                    AS t_startDay,"
                          + "\n            " + getTerms(i).getTo() + "                 AS t_endDay,"
                          + "\n            " + i + "                     AS t_column"
                          + "\n" + "  FROM DUAL ";
                str = str  + "\n" + "UNION ALL";
            end;
        end;

        return str;
    end;

    private macro getIncomeIsDefinedCondition(alias : String)
        var incomeIsDefined;

        if (TF127Parameters().isIncome3rdQualityCategory())
            incomeIsDefined = "CASE WHEN " + alias + " IN (1,2,3) THEN 1 ELSE 0 END";
        else
            incomeIsDefined = "CASE WHEN " + alias + " IN (1,2) THEN 1 ELSE 0 END";
        end;

        return incomeIsDefined;
    end;

    private macro getExistsInterestRatesTable()
        var isExistsInterestRatesTable : String =  "\n" + "EXISTS(SELECT temp.t_isExistsInterestRatesTable"
                                                    + "\n" + "         FROM contractAll temp"
                                                    + "\n" + "        WHERE    temp.t_accountId = data.t_accountId"
                                                   + "\n" + "              AND temp.t_isExistsInterestRatesTable = 1)";

        return isExistsInterestRatesTable;
    end;

    // Вставка в таблицу рассчитанных данных из sql запроса
    private macro summaryInserter(contractsIds : TArray, rows : TArray, columns : TArray, values : TArray, currencies : TArray, boffices : TArray)
        var query = "INSERT INTO df127_tmp (t_contractId, t_row, t_column, t_value, t_currency, t_boffice) VALUES (?,?,?,?,?,?)";

        var inserter = RsbSqlInsert(query, 6, contractsIds.size);

        inserter.addParam(V_INTEGER, contractsIds);
        inserter.addParam(V_STRING, rows, 10);
        inserter.addParam(V_INTEGER, columns);
        inserter.addParam(V_MONEY, values);
        inserter.addParam(V_STRING, currencies, 5);
        inserter.addParam(V_INTEGER, boffices);
        inserter.insert();

        sql_execute("COMMIT");
    end;

    private macro getColumnsQuery(columnFrom : Integer, columnTo : Integer)
        var i = 0;
        var query = "";

        for (i, columnFrom, columnTo)
            if (i > columnFrom)
                query = query + "UNION ALL \n";
            end;

            query = query + "SELECT " + i + " AS t_column FROM DUAL \n";
        end;
    end;

    macro constructorTF127DataSourceBase_4637(id : String, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(id, protocolView);
        m_report = objectFactoryInstance.createReport(TF127Global().getRcbReport());
        fillTerms();
    end;

    constructorTF127DataSourceBase_4637(id, protocolView);
end;

/**
* Форма 127. Источник данных расчета по данным "Главной книги"
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127CbData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Инициализация фильтра
    * Выполняется очистка и базовая настройка фильтра
    *
    * @param line String Строка настроечной таблицы
    * @param column String Графа настроечной таблицы
    * @param filter Object Объект фильтра
    *
    * @return filter Object Настроенный фильтр
    */
    private macro initializeFilter(line: String, column: String, filter: Object)
        m_accountMasks = m_tuneTable.getAccountMasks(line, m_backOffice.getId(), column);

        filter.clear();
        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");
        filter.isSatisfiesToMasks(m_accountMasks);

        return filter;
    end;

    private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "account.t_iso_number";
        end;
    end;

    private macro getBaseQueryForActive(filter : Object)
        var query =
                 " SELECT NVL(account.t_outConvertionCbRest - account.t_calcReserveAmount, 0)            AS t_rest,"
        + "\n" + "        NVL(account.t_accountReservePercent, 0)                                        AS t_reservePercent,"
        + "\n" + "    " + getCurrencyString() + "                                                        AS t_currency,"
        + "\n" + "        account.t_accountId                                                            AS t_accountId,"
        + "\n" + "        account.t_account                                                              AS t_account,"
        + "\n" + "        account.t_fiId                                                                 AS t_fiId,"
        + "\n" + "        account.t_chapter                                                              AS t_chapter,"
        + "\n" + "        account.t_maturityDate                                                         AS t_maturityDate,"
        + "\n" + "        account.t_qualityCategory                                                      AS t_qualityCategory,"
        + "\n" + "        rep_account.getOverdueSum(t_fiId, t_chapter, t_account, rep_data.getEndDate()) AS t_overdueSum,"
        + "\n" + "        TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                         FROM drepcategory_vw atc"
        + "\n" + "                        WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                          AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                          AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                          AND atc.t_isInstalledForEndDate = 1), 0))                    AS t_categoryToRisk,  "
        + "\n" + "        CASE "
        + "\n" + "            WHEN (    TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                                       FROM drepcategory_vw atc"
        + "\n" + "                                      WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                        AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                        AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                                        AND atc.t_isInstalledForEndDate = 1), 0)) != " + m_report.getLastColumn()
        + "\n" + "                  AND (t_qualityCategory IN (1,2,3))) " //проценты считаем для всех граф, кроме последней
        + "\n" + "                THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) "
        + "\n" + "                            FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                           WHERE repaymentSchedule.t_delayMaturityDate >= rep_data.getEndDate()"
        + "\n" + "                             AND repaymentSchedule.t_contractId         IN (SELECT contract.t_Id "
        + "\n" + "                                                                              FROM repPercentContract_vw contract"
        + "\n" + "                                                                             WHERE contract.t_accountId = account.t_accountId)),0 ) "
        + "\n" + "            ELSE 0 "
        + "\n" + "        END                                                                            AS t_percentSum,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN (SELECT rate.t_type "
        + "\n" + "                    FROM repPercentRate_vw rate"
        + "\n" + "                   WHERE rate.t_id = (SELECT MAX(contract.t_rateId) "
        + "\n" + "                                        FROM repPercentContract_vw contract"
        + "\n" + "                                       WHERE contract.t_accountId = account.t_accountId)) = 1"
        + "\n" + "                THEN NVL(t_maturityDate - rep_data.getEndDate(), 0) "
        + "\n" + "            ELSE NVL((SELECT MAX(repaymentSchedule.t_delayMaturityDate) "
        + "\n" + "                        FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                       WHERE repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                  FROM repPercentContract_vw contract"
        + "\n" + "                                                                 WHERE contract.t_accountId = account.t_accountId)), NULL) - rep_data.getEndDate()"
        + "\n" + "        END                                                                            AS t_timeInterval"
        + "\n" + "   FROM dRepAccount_vw account"
        + "\n" + "  WHERE account.t_outCoverRest != 0"
        + "\n" + "    AND " + filter.getFilter()
        + "\n" + "    AND " + getCurrencyFilter("account.t_iso_number")
        + "\n" + "    ORDER BY t_timeInterval";

        return query;
    end;
     /**
    * Расчет одного столбца
    */
    macro insertRowDataForOneColumn(row : String, column : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var strQuery =
                    "SELECT 0 AS t_contract_id, "
        + "\n" + "          " + getSqlString(row) + " AS t_row,"
        + "\n" + "          " + column + " AS t_column,"
        + "\n" + "              NVL(SUM(account.t_outConvertionCbRest - account.t_calcReserveAmount), 0) AS t_value,"
        + "\n" + "          " + getCurrencyString() + " AS t_currency,"
        + "\n" + "          " + getBackOffice().getId() + " AS t_backOffice"
        + "\n" + "     FROM dRepAccount_vw account"
        + "\n" + "    WHERE account.t_outCoverRest != 0"
        + "\n" + "      AND " + filter.getFilter()
        + "\n" + "      AND " + getCurrencyFilter("account.t_iso_number")
        + "\n" + "    GROUP BY t_iso_number";

        summaryInserter(strQuery);
        //пишем данные в протокол
        var protocolData = TRsbDataSet(getBaseQueryForActive(filter));


        m_protocolView.printRow(maskRow);

        while (protocolData.MoveNext())
            m_protocolView.printString(protocolData.t_account,
                                                                        protocolData.t_categoryToRisk,
                                                                        ternary(protocolData.t_qualityCategory != NULL, protocolData.t_qualityCategory," "),
                                                                        ternary(protocolData.t_timeInterval != NULL, protocolData.t_timeInterval," "),
                                                                        protocolData.t_rest,
                                                                        protocolData.t_overdueSum * protocolData.t_reservePercent,
                                                                        protocolData.t_percentSum,
                                                                        protocolData.t_overdueSum,
                                                                        protocolData.t_reservePercent,
                                                                        protocolData.t_rest
                                                                        - protocolData.t_overdueSum * protocolData.t_reservePercent
                                                                        + (protocolData.t_percentSum - (protocolData.t_percentSum * protocolData.t_reservePercent) / 100)
                                                                        + (protocolData.t_overdueSum - (protocolData.t_overdueSum * protocolData.t_reservePercent) / 100)
                                                                       );
        end;
    end;
    /**
    * Расчет одной строки по активу
    */
    macro insertRowDataForActive(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var intervalCase =  "CASE"
        + "\n" + "                WHEN (SELECT rate.t_type "
        + "\n" + "                        FROM repPercentRate_vw rate"
        + "\n" + "                       WHERE rate.t_id = (SELECT MAX(contract.t_rateId) "
        + "\n" + "                                            FROM repPercentContract_vw contract"
        + "\n" + "                                           WHERE contract.t_accountId = data.t_accountId)) = 1"
        + "\n" + "                    THEN NVL(data.t_maturityDate - rep_data.getEndDate(), 0) "
        + "\n" + "                ELSE NVL((SELECT MAX(repaymentSchedule.t_delayMaturityDate) "
        + "\n" + "                            FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                           WHERE repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                      FROM repPercentContract_vw contract"
        + "\n" + "                                                                     WHERE contract.t_accountId = data.t_accountId)), NULL) - rep_data.getEndDate()"
        + "\n" + "            END";

        var strQueryData =  "SELECT 0 AS t_contract_id, "
        + "\n" + "          " + getSqlString(row) + " AS t_row,"
        + "\n" + "              totalData.t_column AS t_column,"
        + "\n" + "              NVL(SUM(CASE WHEN totalData.t_column = " + m_report.getFirstColumn()
        + "\n" + "                               THEN rep_account.getOverdueSum(totalData.t_fiId, totalData.t_chapter, totalData.t_account, rep_data.getEndDate()) * totalData.t_reservePercent"   //колонка 3      колонки 4-15
        + "\n" + "                           ELSE 0"                                                                                                                                               //Сумма2         ------
        + "\n" + "                      END"                                                                                                                                                       //Сумма1         Сумма1
        + "\n" + "                      + totalData.t_rest"                                                                                                                                        //Сумма3         Сумма2
        + "\n" + "                      + totalData.t_percentSum * totalData.t_reservePercent"
        + "\n" + "                     ), 0) AS t_value,"
        + "\n" + "              totalData.t_currency AS t_currency,"
        + "\n" + "          " + getBackOffice().getId() + " AS t_backOffice";

        var strQueryProtocol = strQueryData + ","
        + "\n" + "           totalData.t_account                                          AS t_account,"
        + "\n" + "           totalData.t_qualityCategory                                  AS t_qualityCategory,"
        + "\n" + "           totalData.t_timeInterval                                     AS t_timeInterval,"
        + "\n" + "           totalData.t_percentSumProtocol                               AS t_percentSum,"
        + "\n" + "           totalData.t_overdueSum                                       AS t_overdueSum,"
        + "\n" + "           totalData.t_reservePercent                                   AS t_reservePercent,"
        + "\n" + "           totalData.t_restProtocol                                     AS t_restProtocol,"
        + "\n" + "           totalData.t_categoryToRisk                                   AS t_categoryToRisk";

        var strQuery =
        "\n" + "         FROM (SELECT data.t_rest                        AS t_rest, "
        + "\n" + "                      (1 - data.t_reservePercent/100.00) AS t_reservePercent,"
        + "\n" + "                      data.t_currency                    AS t_currency,"
        + "\n" + "                      data.t_account                     AS t_account,"
        + "\n" + "                      data.t_fiId                        AS t_fiId,"
        + "\n" + "                      data.t_chapter                     AS t_chapter,"
        + "\n" + "                      data.t_qualityCategory             AS t_qualityCategory,"
        + "\n" + "                      t_percentSum                       AS t_percentSumProtocol,"
        + "\n" + "                      t_timeInterval,"
        + "\n" + "                      t_overdueSum,"
        + "\n" + "                      t_categoryToRisk,"
        + "\n" + "                      data.t_rest                         AS t_restProtocol,"
        + "\n" + "                      CASE "
        + "\n" + "                           WHEN data.t_categoryToRisk > 0"
        + "\n" + "                               THEN data.t_categoryToRisk"
        + "\n" + "                           WHEN data.t_qualityCategory IN (4,5)"
        + "\n" + "                               THEN " + m_report.getLastColumn()
        + "\n" + "                           WHEN data.t_qualityCategory IN (1,2,3)"
        + "\n" + "                               THEN " + getTermsCondition(intervalCase)
        + "\n" + "                           ELSE 0 "
        + "\n" + "                      END                                AS t_column,"
        + "\n" + "                      CASE "
        + "\n" + "                           WHEN (     data.t_categoryToRisk != " + m_report.getLastColumn()
        + "\n" + "                                 AND (data.t_qualityCategory IN (1,2,3))) " //проценты считаем для всех граф, кроме последней
        + "\n" + "                               THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) "
        + "\n" + "                                           FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                                          WHERE repaymentSchedule.t_delayMaturityDate >= rep_data.getEndDate()"
        + "\n" + "                                            AND repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                                     FROM repPercentContract_vw contract"
        + "\n" + "                                                                                    WHERE contract.t_accountId = data.t_accountId)), 0) "
        + "\n" + "                               ELSE 0 "
        + "\n" + "                      END                                AS t_percentSum"
        + "\n" + "                FROM (" + getBaseQueryForActive(filter) + ") data"
        + "\n" + "               ) totalData "
        + "\n" + "           WHERE totalData.t_column BETWEEN " + columnFrom + " AND " + columnTo
        + "\n" + "  GROUP BY t_column,t_reservePercent,t_currency,t_account,t_overdueSum,t_timeInterval,t_percentSum,t_qualityCategory,t_percentSumProtocol,t_restProtocol,t_categoryToRisk"
        + "\n" + "  ORDER BY t_column";

        summaryInserter(strQueryData + strQuery);

        //пишем данные в протокол
        var protocolData = TRsbDataSet(strQueryProtocol + strQuery);
        var graphName:string ="";

        m_protocolView.printRow(maskRow);
        while (protocolData.MoveNext())
            if (graphName!=string(protocolData.t_column))
                m_protocolView.printString("Графа " + int(protocolData.t_column));
                graphName = protocolData.t_column;
            end;
            if ( (maskColumn != 16) and (protocolData.t_timeInterval != NULL) )
            m_protocolView.printString(protocolData.t_account,
                                                                        protocolData.t_categoryToRisk,
                                                                        ternary(protocolData.t_qualityCategory != NULL, protocolData.t_qualityCategory," "),
                                                                        ternary(protocolData.t_timeInterval != NULL, protocolData.t_timeInterval," "),
                                                                        protocolData.t_restProtocol,
                                                                        protocolData.t_overdueSum * protocolData.t_reservePercent,
                                                                        protocolData.t_percentSum,
                                                                        protocolData.t_overdueSum,
                                                                        protocolData.t_reservePercent,
                                                                        protocolData.t_restProtocol
                                                                        - protocolData.t_overdueSum * protocolData.t_reservePercent
                                                                        + (protocolData.t_percentSum - (protocolData.t_percentSum * protocolData.t_reservePercent) / 100)
                                                                        + (protocolData.t_overdueSum - (protocolData.t_overdueSum * protocolData.t_reservePercent) / 100)
                                                                       );
            end;
        end;
    end;

    private macro getBaseQueryForPassive(filter : Object, contractorIsBank : bool)
        var contractorFilter = "";

        if   (contractorIsBank == NULL)
            contractorFilter = "(1 = 1)";
        elif (contractorIsBank)
            contractorFilter = "((SELECT party.t_isBank FROM drepparty_vw party WHERE party.t_id = account.t_contragentId) = 1)";
        else
            contractorFilter = "((SELECT party.t_isBank FROM drepparty_vw party WHERE party.t_id = account.t_contragentId) = 0)";
        end;

        var query =
                 "SELECT NVL(account.t_outConvertionCbRest, 0)                                                          AS t_rest,"  //Остаток по курсу ЦБ считается для всех граф
        + "\n" + "    " + getCurrencyString() + "                                                                       AS t_currency,"
        + "\n" + "        account.t_accountId                                                                           AS t_accountId,"
        + "\n" + "        account.t_account                                                                             AS t_account,"
        + "\n" + "        account.t_maturityDate                                                                        AS t_maturityDate,"
        + "\n" + "        (SELECT party.t_isBank FROM drepparty_vw party WHERE party.t_id = account.t_contragentId)     AS t_isBank, "
        + "\n" + "        (SELECT party.t_isPhisical FROM drepparty_vw party WHERE party.t_id = account.t_contragentId) AS t_isPhisical, "
        + "\n" + "        (SELECT SUM(contract.t_isExistsInterestRatesTable) "
        + "\n" + "           FROM repPercentContract_vw contract"
        + "\n" + "          WHERE contract.t_accountId = account.t_accountId)                                           AS t_isExistsInterestRatesTable,"
        + "\n" + "        TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                         FROM drepcategory_vw atc"
        + "\n" + "                        WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                          AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                          AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                          AND atc.t_isInstalledForEndDate = 1), 0))                                   AS t_categoryToRisk,  "
        + "\n" + "        CASE "
        + "\n" + "             WHEN (     TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                                         FROM drepcategory_vw atc"
        + "\n" + "                                        WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                          AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                          AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                                          AND atc.t_isInstalledForEndDate = 1), 0)) != " + m_report.getLastColumn()
        + "\n" + "                   AND ((SELECT SUM(contract.t_isExistsInterestRatesTable) "
        + "\n" + "                           FROM repPercentContract_vw contract"
        + "\n" + "                          WHERE contract.t_accountId = account.t_accountId) > 0) AND " + contractorFilter + ") " //проценты считаем для всех граф, кроме последней
        + "\n" + "                 THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) "
        + "\n" + "                             FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                            WHERE repaymentSchedule.t_delayMaturityDate >= rep_data.getEndDate()"
        + "\n" + "                              AND repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                       FROM repPercentContract_vw contract"
        + "\n" + "                                                                      WHERE contract.t_accountId = account.t_accountId)), 0) "
        + "\n" + "                 ELSE 0 "
        + "\n" + "        END                                                                                           AS t_percentSum,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN (SELECT rate.t_type "
        + "\n" + "                    FROM repPercentRate_vw rate"
        + "\n" + "                   WHERE rate.t_id = (SELECT MAX(contract.t_rateId) "
        + "\n" + "                                        FROM repPercentContract_vw contract"
        + "\n" + "                                       WHERE contract.t_accountId = account.t_accountId)) = 1"
        + "\n" + "                THEN NVL(t_maturityDate - rep_data.getEndDate(), 0) "
        + "\n" + "                ELSE NVL((SELECT MAX(repaymentSchedule.t_delayMaturityDate) "
        + "\n" + "                            FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                           WHERE repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                      FROM repPercentContract_vw contract"
        + "\n" + "                                                                     WHERE contract.t_accountId = account.t_accountId)), NULL) - rep_data.getEndDate()"
        + "\n" + "            END                                                                                       AS t_timeInterval"
        + "\n" + "   FROM dRepAccount_vw account"
        + "\n" + "  WHERE account.t_outCoverRest != 0"
        + "\n" + "    AND " + filter.getFilter()
        + "\n" + "    AND " + getCurrencyFilter("account.t_iso_number");

        return query;
    end;

    /**
    * Расчет одной строки по пассиву
    */
    macro insertRowDataForPassive(row : String, filter : Object, contractorIsBank : bool, maskRow : String, maskColumn : String, sign : integer)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var contractorFilter = "";
        if   (contractorIsBank == NULL)
            contractorFilter = "(1 = 1)";
        elif (contractorIsBank)
            contractorFilter = "(data.t_isBank = 1)";
        else
            contractorFilter = "(data.t_isBank = 0)";
        end;

        var intervalCase =  "CASE"
        + "\n" + "                WHEN (SELECT rate.t_type "
        + "\n" + "                        FROM repPercentRate_vw rate"
        + "\n" + "                       WHERE rate.t_id = (SELECT MAX(contract.t_rateId) "
        + "\n" + "                                            FROM repPercentContract_vw contract"
        + "\n" + "                                           WHERE contract.t_accountId = data.t_accountId)) = 1"
        + "\n" + "                    THEN NVL(data.t_maturityDate - rep_data.getEndDate(), 0) "
        + "\n" + "                    ELSE NVL((SELECT MAX(repaymentSchedule.t_delayMaturityDate) "
        + "\n" + "                                FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                               WHERE repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                          FROM repPercentContract_vw contract"
        + "\n" + "                                                                         WHERE contract.t_accountId = data.t_accountId)),NULL ) - rep_data.getEndDate()"
        + "\n" + "            END";

        var strQueryData =  "SELECT 0 AS t_contract_id, "
        + "\n" + "          " + getSqlString(row) + " AS t_row,"
        + "\n" + "              totalData.t_column AS t_column,"
        + "\n" + "              NVL(SUM(totalData.t_rest + totalData.t_percentSum) * " + sign + ", 0) AS t_value,"
        + "\n" + "              totalData.t_currency AS t_currency,"
        + "\n" + "          " + getBackOffice().getId() + " AS t_backOffice";

        var strQueryProtocol = strQueryData + ","
        + "\n" + "           " + getBackOffice().getId() + " AS t_backOffice,"
        + "\n" + "           totalData.t_account                                          AS t_account,"
        + "\n" + "           totalData.t_categoryToRisk                                   AS t_categoryToRisk,"
        + "\n" + "           totalData.t_isBank                                           AS t_isBank,"
        + "\n" + "           totalData.t_timeInterval                                     AS t_timeInterval,"
        + "\n" + "           totalData.t_percentSumProtocol                               AS t_percentSum,"
        + "\n" + "           totalData.t_isPhisicalProtocol                               AS t_isPhisical" ;

        var strQuery = "         FROM (SELECT data.t_rest AS t_rest, "
        + "\n" + "                      data.t_currency AS t_currency,"
        + "\n" + "                      data.t_account    AS t_account,"
        + "\n" + "                      t_isBank,"
        + "\n" + "                      t_categoryToRisk,"
        + "\n" + "                      t_timeInterval,"
        + "\n" + "                      t_percentSum AS t_percentSumProtocol,"
        + "\n" + "                      t_isPhisical AS t_isPhisicalProtocol,"
        + "\n" + "                      CASE "
        + "\n" + "                           WHEN data.t_categoryToRisk > 0"
        + "\n" + "                               THEN data.t_categoryToRisk"
        + "\n" + "                           WHEN ((data.t_isExistsInterestRatesTable != 1) AND " + contractorFilter  + ")"
        + "\n" + "                               THEN " + m_report.getLastColumn()
        + "\n" + "                           WHEN ((data.t_isExistsInterestRatesTable  = 1) AND " + contractorFilter + ")"
        + "\n" + "                               THEN "
        + "\n" + "                                 " + getTermsCondition(intervalCase)
        + "\n" + "                               ELSE 0 "
        + "\n" + "                      END t_column,"
        + "\n" + "                      CASE "
        + "\n" + "                           WHEN (     data.t_categoryToRisk != " + m_report.getLastColumn()
        + "\n" + "                                 AND (data.t_isExistsInterestRatesTable = 1) AND " + contractorFilter + ") " //проценты считаем для всех граф, кроме последней
        + "\n" + "                               THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) "
        + "\n" + "                                           FROM repPercentRepaymentSchedule_vw repaymentSchedule"
        + "\n" + "                                          WHERE repaymentSchedule.t_delayMaturityDate >= rep_data.getEndDate()"
        + "\n" + "                                            AND repaymentSchedule.t_contractId IN (SELECT contract.t_Id "
        + "\n" + "                                                                                     FROM repPercentContract_vw contract"
        + "\n" + "                                                                                    WHERE contract.t_accountId = data.t_accountId)),0 ) "
        + "\n" + "                               ELSE 0 "
        + "\n" + "                      END t_percentSum"
        + "\n" + "                FROM (" + getBaseQueryForPassive(filter, contractorIsBank) + ") data"
        + "\n" + "               ) totalData "
        + "\n" + "           WHERE totalData.t_column > 0"
        + "\n" + "         GROUP BY t_column,t_currency,t_account,t_categoryToRisk,t_isBank,t_timeInterval,t_percentSumProtocol,t_isPhisicalProtocol"
        + "\n" + "         ORDER BY t_column";

        summaryInserter(strQueryData + strQuery);

        //пишем данные в протокол
        var protocolData = TRsbDataSet(strQueryProtocol + strQuery);
        var protocol;
        var graphName:string ="";

        if  (maskRow == "4.5_плюс")
            protocol = m_protocolView.getDataProtocolView("cb_passive_4_5_plus");
            protocol.printRow(maskRow);
            while (protocolData.MoveNext())
                if (graphName!=string(protocolData.t_column))
                    protocol.printString("Графа " + int(protocolData.t_column));
                    graphName = protocolData.t_column;
                end;
                protocol.printString(protocolData.t_account,
                                     protocolData.t_categoryToRisk,
                                     ternary(protocolData.t_timeInterval != NULL, protocolData.t_timeInterval," "),
                                     protocolData.t_value,
                                     protocolData.t_percentSum,
                                     protocolData.t_value + protocolData.t_percentSum
                                    );
            end;
        elif (maskRow == "4.5_минус")
            protocol = m_protocolView.getDataProtocolView("cb_passive_4_5_minus");
            protocol.printRow(maskRow);
            while (protocolData.MoveNext())
                if (graphName!=string(protocolData.t_column))
                    protocol.printString("Графа " + int(protocolData.t_column));
                end;
                graphName = protocolData.t_column;
                protocol.printString(protocolData.t_account,
                                     protocolData.t_categoryToRisk,
                                     ternary(protocolData.t_timeInterval != NULL, protocolData.t_timeInterval," "),
                                     protocolData.t_value,
                                     protocolData.t_percentSum,
                                     protocolData.t_value + protocolData.t_percentSum
                                    );
            end;
        else
            protocol = m_protocolView.getDataProtocolView("cb_passive");
            protocol.printRow(maskRow);
            while (protocolData.MoveNext())
                if (graphName!=string(protocolData.t_column))
                    protocol.printString("Графа " + int(protocolData.t_column));
                end;
                graphName = protocolData.t_column;
                protocol.printString(protocolData.t_account,
                                     ternary(protocolData.t_isBank == 1, "КО", ternary(protocolData.t_isPhisical == 1, "ФЛ", "ЮЛ")),
                                     protocolData.t_categoryToRisk,
                                     ternary(protocolData.t_timeInterval != NULL, protocolData.t_timeInterval," "),
                                     protocolData.t_value,
                                     protocolData.t_percentSum,
                                     protocolData.t_value + protocolData.t_percentSum
                                    );
            end;
        end;
    end;
    /**
    * Получить данные по главной книге
    *
    * @return TArray of TF127StandaloneAttributeValue Список рассчитанных атрибутов
    */
    macro getData(): TArray

    end;

    /**
    * Кеширование данных.
    */
    macro cashData()
         sql_execute("BEGIN"
             +"\n"+ "      rep_data.initPercentRepaymentSchedule(rep_data.getEndDate(),"
             +"\n"+ "                                           'SELECT acc.t_chapter,"
             +"\n"+ "                                                   acc.t_fiId,"
             +"\n"+ "                                                   acc.t_account"
             +"\n"+ "                                              FROM drepAccount_vw acc"
             +"\n"+ "                                             WHERE acc.t_isOpenedAtEndDate = 1"
             +"\n"+ "                                               AND " + strSubst(getCurrencyFilter("acc.t_iso_number"), "'","''")
             +"\n"+ "                                               AND acc.t_chapter = 1');"
             +"\n"+ "END;");
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_CB);
        cashData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127CbData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase_4637(f127Constant.dataSource.IDENTIFIER_CB, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_CB));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127CbData(tuneTable, protocolView);
end;

private class (TF127CbData) TF127CbData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Инициализация фильтра
    * Выполняется очистка и базовая настройка фильтра
    *
    * @param line String Строка настроечной таблицы
    * @param column String Графа настроечной таблицы
    * @param filter Object Объект фильтра
    *
    * @return filter Object Настроенный фильтр
    */
    private macro initializeFilter(line: String, column: String, filter: Object)
        m_accountMasks = m_tuneTable.getAccountMasks(line, m_backOffice.getId(), column);

        filter.clear();
        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");
        filter.isSatisfiesToMasks(m_accountMasks);

        return filter;
    end;

    private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "account.t_iso_number";
        end;
    end;

    /**
     * Расчет одного столбца
     */
    macro insertRowDataForOneColumn(row : String, column : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var strQuery =
                    "SELECT 0 AS t_contractId, "
        + "\n" + "          " + getSqlString(row) + "                AS t_row,"
        + "\n" + "          " + column + " AS t_column,"
        + "\n" + "          NVL(account.t_outConvertionCbRest, 0)    AS t_rest, "
        + "\n" + "          NVL(account.t_calcReserveAmount,0)       AS t_reserveAmount,"
        + "\n" + "          " + getCurrencyString() + "              AS t_currency,"
        + "\n" + "          " + getBackOffice().getId() + "          AS t_backOffice,"
        + "\n" + "          account.t_account AS t_account,"
        + "\n" + "          account.t_qualityCategory                AS t_qualityCategory"
        + "\n" + "     FROM dRepAccount_vw account"
        + "\n" + "    WHERE account.t_outCoverRest != 0"
        + "\n" + "      AND " + filter.getFilter()
        + "\n" + "      AND " + getCurrencyFilter("account.t_iso_number");

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);
        m_protocolView.printString("Графа 16");

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) - nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = nvl(sumForReport, 0);
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        "",
                                        "",
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        "",
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        "",
                                        getBackOffice.getName(),
                                        "",
                                        "",
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

    /**
     * Базовый запрос
     */
    private macro getBaseQuery(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String,
                               maskColumn : String, getCalculatedQuery : String, mode : String, tempFilter : String)

        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op("AND");
        end;

        filter.accountIsOpened().op("AND").isChapterIn("1").op("AND").isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));
        filter.op("AND").getIncomeIsDefinedCondition();

        /**
         * для строк актива  - Признак наличия календарной таблицы процентных ставок = 1
         */
        if   (mode == "active")
            filter.op("AND").addFilter("cntrAcc.t_isExistsInterestRatesTable = 1");
        end;

        var isIncomeDefined : string = "";
        var intervalCase = getTermsIntervals();

        var contractAll = " SELECT pc.*,"
        + "\n" + "         (SELECT rate.t_type"
        + "\n" + "            FROM repPercentRate_vw rate"
        + "\n" + "           WHERE rate.t_id = pc.t_rateId) AS t_rateInstrumentType,"
        + "\n" + "                        pc.t_accountId   AS t_accountIdContract"
        + "\n" + "                    FROM repPercentContract_vw pc";

        var mainPercentContract = "SELECT mainPd.*"
        + "\n" + "                   FROM dRepAccount_vw account"
        + "\n" + "                        INNER JOIN"
        + "\n" + "                       (SELECT RANK ()"
        + "\n" + "                               OVER (PARTITION BY contract.t_accountIdContract"
        + "\n" + "                               ORDER BY contract.t_isMainPercentContract DESC,"
        + "\n" + "                                        contract.t_rateInstrumentType DESC,"
        + "\n" + "                                        contract.t_id DESC)                      AS t_rowForAccount,"
        + "\n" + "                              contract.t_id                                      AS t_mainPercentContract,"
        + "\n" + "                              contract.t_rateInstrumentType                      AS t_rateType,"
        + "\n" + "                              contract.t_accountIdContract,"
        + "\n" + "                              contract.t_isMainPercentContract"
        + "\n" + "                         FROM contractAll contract"
        + "\n" + "                        WHERE contract.t_isExistsInterestRatesTable = 1"
        + "\n" + "                        ) mainPd"
        + "\n" + "                     ON mainPd.t_accountIdContract = account.t_accountId  AND t_rowForAccount = 1";

        var contractIntervalContract = " SELECT LAG(timeInterval.t_date, 1, rep_data.getEndDate()) over (PARTITION BY timeInterval.t_contractId ORDER BY timeInterval.t_date) AS t_previousDate,"
        + "\n" + "        timeInterval.t_date,"
        + "\n" + "        timeInterval.t_column,"
        + "\n" + "        timeInterval.t_dayInterval,"
        + "\n" + "        timeInterval.t_contractId"
        + "\n" + "  FROM (SELECT ratesColumn.t_contractId,"
        + "\n" + "               ratesColumn.t_date,"
        + "\n" + "               ratesColumn.t_column,"
        + "\n" + "               ratesColumn.t_dayInterval,"
        + "\n" + "               RANK() OVER(PARTITION BY ratesColumn.t_contractId, ratesColumn.t_column ORDER BY ratesColumn.t_date DESC) AS t_isFirstRow"
        + "\n" + "          FROM (SELECT CASE"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 0 AND 30"
        + "\n" + "                              THEN 3"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 31 AND 90"
        + "\n" + "                              THEN 4"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 91 AND 180"
        + "\n" + "                              THEN 5"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 181 AND 366"
        + "\n" + "                              THEN 6"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 367 AND 731"
        + "\n" + "                              THEN 7"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 732 AND 1096"
        + "\n" + "                              THEN 8"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 1097 AND 1461"
        + "\n" + "                              THEN 9"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 1462 AND 1827"
        + "\n" + "                              THEN 10"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 1828 AND 2557"
        + "\n" + "                              THEN 11"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 2558 AND 3653"
        + "\n" + "                              THEN 12"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 3654 AND 5479"
        + "\n" + "                              THEN 13"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 5480 AND 7305"
        + "\n" + "                               THEN 14"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() BETWEEN 7306 AND 3652059"
        + "\n" + "                              THEN 15"
        + "\n" + "                          WHEN rates.t_date - rep_data.getEndDate() < 0"
        + "\n" + "                              THEN 3"
        + "\n" + "                       ELSE 0"
        + "\n" + "                       END  AS t_column,"
        + "\n" + "                       rates.t_date - rep_data.getEndDate() AS t_dayInterval,"
        + "\n" + "                       rates.t_date,"
        + "\n" + "                       rates.t_contractId"
        + "\n" + "                  FROM repPercentRateChangeHistory_vw rates"
        + "\n" + "                  WHERE rates.t_date > rep_data.getEndDate()) ratesColumn"
        + "\n" + "        ) timeInterval"
        + "\n" + "  WHERE t_isFirstRow = 1";

        var totalData = "SELECT account.t_accountId,"
        + "\n" + "              account.t_account,"
        + "\n" + "              account.t_balance,"
        + "\n" + "              account.t_outConvertionCbRest,"
        + "\n" + "              account.t_calcReserveAmount,"
        + "\n" + "              (account.t_accountReservePercent/100.00)                                                         AS t_percentAccount,"
        + "\n" + "              TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                              FROM drepcategory_vw atc"
        + "\n" + "                             WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                               AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                               AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                               AND atc.t_isInstalledForEndDate = 1), 0))                                          AS t_categoryToRisk,"
        + "\n" + "               account.t_qualityCategory,"
        + "\n" + "               " + getIncomeIsDefinedCondition("account.t_qualityCategory") + "                                   AS t_isIncomeDefined,"
        + "\n" + "               account.t_maturityDate,   "
        + "\n" + "               " + getCurrencyString() + "                                                                        AS t_currency,"
        + "\n" + "               cntrAcc.t_number,"
        + "\n" + "               cntrAcc.t_id,"
        + "\n" + "               cntrAcc.t_rateInstrumentType,"
        + "\n" + "               cntrAcc.t_backOffice,"
        + "\n" + "               cntrAcc.t_backOfficeCode,"
        + "\n" + "               DECODE (cntrAcc.t_id, mainPd.t_mainPercentContract, " + rcbSqlBool(true) + ")                      AS t_isMain,"
        + "\n" + "               ctrInterval.t_date                                                                                 AS t_dateInterval,"
        + "\n" + "               ctrInterval.t_dayInterval,"
        + "\n" + "               mainPd.*"
        + "\n" + "         FROM contractIntervalContract ctrInterval, dRepAccount_vw account, contractAll cntrAcc LEFT JOIN mainPercentContract mainPd ON (cntrAcc.t_id = mainPd.t_mainPercentContract)"
        + "\n" + "        WHERE     cntrAcc.t_accountId = account.t_accountId"
        + "\n" + "              AND ctrInterval.t_contractId = cntrAcc.t_id"
        + "\n" + "              AND " + filter.getFilter()
        + "\n" + "              AND " + getCurrencyFilter("account.t_iso_number");

        var mainWith = " WITH intervalCase                                      "
        + "\n" + "            AS (" + intervalCase + "),                        "
        + "\n" + "            contractIntervalContract                          "
        + "\n" + "            AS (" + contractIntervalContract + "),            "
        + "\n" + "            contractAll                                       "
        + "\n" + "            AS (" + contractAll + "),                         "
        + "\n" + "            mainPercentContract                               "
        + "\n" + "            AS (" + mainPercentContract + "),                 "
        + "\n" + "            totalData                                         "
        + "\n" + "            AS (" + totalData + "),                           "
        + "\n" + "            calculateData                                     "
        + "\n" + "            AS ( SELECT data.*,                               "
               +                          getCalculatedQuery
        + "\n" + "                  FROM totalData data                         "
        + "\n" + "                  WHERE " + ternary((valType(tempFilter) == V_UNDEF) or (tempFilter == ""),  "1 = 1" , tempFilter)
        + "\n" + "                ) ";

        var strQuery = mainWith
        + "\n" + "     SELECT " + getSqlString(row) + "                                                        AS t_row,"
        + "\n" + "              data.t_account                                              AS t_account,"
        + "\n" + "              CASE                 "
        + "\n" + "                  WHEN data.t_rateInstrumentType != 1 THEN 'Плав. % ставка'"
        + "\n" + "                  ELSE 'Фикс. % ставка'"
        + "\n" + "              END                                                         AS t_rateInstrumentType,"
        + "\n" + "              data.t_isMain                                               AS t_isMainPercentContract,"
        + "\n" + "              data.t_categoryToRisk                                       AS t_categoryToRisk,"
        + "\n" + "              data.t_qualityCategory                                      AS t_qualityCategory,"
        + "\n" + "              data.t_maturityDate                                         AS t_maturityDate,"
        + "\n" + "              data.t_rest                                                 AS t_rest,"
        "\n" + "                data.t_reserveAmount                                        AS t_reserveAmount,"
        "\n" + "                data.t_percentAccount                                       AS t_percentAccount,"
        + "\n" + "              " + getBackOffice().getId() + "                                           AS t_backOffice,"
        + "\n" + "              data.t_backOfficeCode                                       AS t_backOfficeCode,"
        + "\n" + "              DECODE (data.t_rateInstrumentType, 1, 'Абсолютная',"
        + "\n" + "                                                 2, 'Пользовательская',"
        + "\n" + "                                                 3, 'Плавающая')          AS t_rateType,"
        + "\n" + "              data.t_number                                               AS t_number,"
        + "\n" + "              data.t_Id                                                   AS t_contractId,"
        + "\n" + "              data.t_accountId                                            AS t_accountId,"
        + "\n" + "              data.t_column                                               AS t_column,"
        + "\n" + "              data.t_currency                                             AS t_currency,"
        + "\n" + "              data.t_dateInterval"
        + "\n" + "         FROM calculateData data"
        + "\n" + "        WHERE data.t_column > 0"
        + "\n" + "          AND data.t_column BETWEEN " + columnFrom + " AND " + columnTo
        + "\n" + "        ORDER BY t_account,"
        + "\n" + "                 t_isMainPercentContract DESC";

        return strQuery;
    end;

    /**
     * Расчет строки 1.2
     */
    macro insertRowDataForRow1_2(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                             AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
          "\n" + "             CASE"
        + "\n" + "                WHEN (" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") != 1"
        + "\n" + "                  THEN  NVL(data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END                                                                                                  AS t_rest,"
        + "\n" + "             (CASE"
        + "\n" + "                WHEN (" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") != 1"
        + "\n" + "                   THEN NVL((SELECT SUM(acc.t_outConvertionCbRest - acc.t_calcReserveAmount)"
        + "\n" + "                               FROM dRepAccount_vw acc"
        + "\n" + "                              WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                        FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                       WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                         AND percAccount.t_accountTypeName IN ('Счет срочных процентов для балансового учета',"
        + "\n" + "                                                                                               'Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                             ), 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END "
        + "\n" + "              + "
        + "\n" + "             CASE"
        + "\n" + "                WHEN ((" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                                           OR data.t_categoryToRisk = " + m_report.getLastColumn() + ")"
        + "\n" + "                    THEN NVL((SELECT acc.t_outConvertionCbRest - acc.t_calcReserveAmount"
        + "\n" + "                                FROM dRepAccount_vw acc"
        + "\n" + "                               WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                         FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                        WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                          AND percAccount.t_accountTypeName IN ('Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                              ), 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END )                                                                                                   AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType = 1"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType != 1"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                                       WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                         AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                         AND temp.t_endDay)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     -- Расчет суммы 3_4"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) - (SUM(repaymentSchedule.t_roubleSum) * data.t_percentAccount)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) - (SUM(repaymentSchedule.t_roubleSum) * data.t_percentAccount)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"

        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter, maskRow, maskColumn, getCalculatedQuery, "active");

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();


        m_protocolView.printRow(maskRow);
        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

     /**
     * Расчет строк: 1.3.1
     *               1.3.2
     *               1.3.2.1
     *               1.3.3
     */
    macro insertRowDataForRow1_3(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                             AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
          "\n" + "             CASE"
        + "\n" + "                WHEN (" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") != 1"
        + "\n" + "                  THEN  NVL(data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END                                                                                                  AS t_rest,"
        + "\n" + "             (CASE"
        + "\n" + "                WHEN (" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") != 1"
        + "\n" + "                   THEN NVL((SELECT SUM(acc.t_outConvertionCbRest - acc.t_calcReserveAmount)"
        + "\n" + "                               FROM dRepAccount_vw acc"
        + "\n" + "                              WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                        FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                       WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                         AND percAccount.t_accountTypeName IN ('Счет срочных процентов для балансового учета',"
        + "\n" + "                                                                                               'Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                             ), 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END"
        + "\n" + "             + "
        + "\n" + "             CASE"
        + "\n" + "                WHEN ((" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                                           OR data.t_categoryToRisk = " + m_report.getLastColumn() + ")"
        + "\n" + "                    THEN NVL((SELECT acc.t_outConvertionCbRest - acc.t_calcReserveAmount"
        + "\n" + "                                FROM dRepAccount_vw acc"
        + "\n" + "                               WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                         FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                        WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                          AND percAccount.t_accountTypeName IN ('Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                              ), 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END )                                                                                                   AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE"
        + "\n" + "                          WHEN data.t_id  = data.t_mainPercentContract AND"
        + "\n" + "                                   ((" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                                           OR data.t_categoryToRisk > 0 )"
        + "\n" + "                               THEN CASE"
        + "\n" + "                                        WHEN data.t_rateType = 1 AND EXISTS(SELECT 1"
        + "\n" + "                                                                              FROM  intervalCase temp"
        + "\n" + "                                                                              WHERE      data.t_maturityDate IS NOT NULL"
        + "\n" + "                                                                                AND  data.t_maturityDate > rep_data.getEndDate()"
        + "\n" + "                                                                                AND  data.t_maturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                                      AND temp.t_endDay)"
        + "\n" + "                                                                  OR data.t_maturityDate IS NULL"
        + "\n" + "                                                                  OR data.t_categoryToRisk > 0"
        + "\n" + "                                             THEN  NVL (data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "                                        WHEN data.t_rateType != 1  AND EXISTS(SELECT 1"
        + "\n" + "                                                                                FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                               WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                 AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                   AND temp.t_endDay)"
        + "\n" + "                                             THEN NVL (data.t_outConvertionCbRest - data.t_calcReserveAmount, 0)"
        + "\n" + "                                    ELSE 0"
        + "\n" + "                                    END"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1 AND"
        + "\n" + "                                   ((" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                                           OR data.t_categoryToRisk > 0 )"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) - (SUM(repaymentSchedule.t_roubleSum) * data.t_percentAccount)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN data.t_rateInstrumentType = 1 AND"
        + "\n" + "                                   ((" + getIncomeIsDefinedCondition("data.t_qualityCategory") + ") = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                                           OR data.t_categoryToRisk > 0 )"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum) - (SUM(repaymentSchedule.t_roubleSum) * data.t_percentAccount)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"
        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1  AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_categoryToRisk > 0"
        + "\n" + "                              THEN data.t_categoryToRisk"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter, maskRow, maskColumn, getCalculatedQuery, "active");

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

    /**
     * Расчет строки 1.6
     */
    macro insertRowDataForRow1_6(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

    /**
     *  На счете Не установлена категория <Треб/обяз. для исполнения в неденежном выражении> = "Неденежные Треб/Обяз"
     */
        filter.addfilter( "\n" + "EXISTS(SELECT 1"
        + "\n" + "                         FROM drepcategory_vw atc"
        + "\n" + "                        WHERE    atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                             AND atc.t_id                    = " + RCB_OBJGROUP_FOR_REPORTING
        + "\n" + "                             AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                             AND atc.t_isInstalledForEndDate = 1"
        + "\n" + "                             AND atc.t_value LIKE 'Неденежные Треб/Обяз')");

       insertRowDataForRow1_3(row, columnFrom, columnTo, filter, maskRow, maskColumn);
     end;

    /**
     * Расчет строки 1.7
     */
    macro insertRowDataForRow1_7(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

    /**
     *  На счете Не установлена категория <Треб/обяз. для исполнения в неденежном выражении> = "Неденежные Треб/Обяз"
     */
        filter.op("AND").addfilter("\n" + "EXISTS(SELECT 1"
        + "\n" + "                       FROM drepcategory_vw atc"
        + "\n" + "                      WHERE     atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                            AND atc.t_id                    = " + RCB_OBJGROUP_ACTIVEKIND
        + "\n" + "                            AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                            AND atc.t_value LIKE 'Лизинг'"
        + "\n" + "                            AND atc.t_shortName LIKE 'Имущество, переданное в финансовую аренду (лизинг)')");

        var accountsForReserve = "61902,61904,61906,61908";

        var intervalCase =  "NVL(tempData.t_maturityDate - rep_data.getEndDate(), 0) ";

        var isLastColumn = ternary((columnFrom = string(m_report.getLastColumn())) and (columnFrom = columnTo), true, false);

        var strQuery =
                 "     SELECT 0                                              AS t_contract_id,                                      "
        + "\n" + "        " + getSqlString(row) + "                          AS t_row,                                              "
        + "\n" + "        " + getBackOffice().getId() + "                    AS t_backOffice,                                       "
        + "\n" + "            data.t_rest                                    AS t_rest,                                             "
        + "\n" + "            data.t_reserveAmount                           AS t_reserveAmount,                                    "
        + "\n" + "            data.t_currency                                AS t_currency,                                         "
        + "\n" + "            data.t_account                                 AS t_account,                                          "
        + "\n" + "            data.t_fiId                                    AS t_fiId,                                             "
        + "\n" + "            data.t_chapter                                 AS t_chapter                                           "
        + "\n" + "      FROM (SELECT CASE                                                                                           "
        + "\n" + "                       WHEN tempData.t_balance IN (" + accountsForReserve + ") AND tempData.t_isIncomeDefined = " + ternary(isLastColumn, "0", "1")
        + "\n" + "                            THEN 0"
        + "\n" + "                       WHEN tempData.t_categoryToRisk > 0                                                         "
        + "\n" + "                            THEN tempData.t_categoryToRisk                                                        "
        + "\n" + "                       WHEN " + ternary(isLastColumn, "1 = 1", "1 = 0")
        + "\n" + "                            THEN " + m_report.getLastColumn()
        + "\n" + "                  ELSE " + getTermsCondition(intervalCase)
        + "\n" + "                  END                                            AS t_column,                                     "
        + "\n" + "                  tempData.*                                                                                      "
        + "\n" + "             FROM (SELECT NVL(account.t_outConvertionCbRest , 0)                       AS t_rest,                 "
        + "\n" + "                          CASE                                                                                    "
        + "\n" + "                              WHEN account.t_balance IN (" + accountsForReserve + ")                              "
        + "\n" + "                                  THEN account.t_calcReserveAmount                                                "
        + "\n" + "                          ELSE 0                                                                                  "
        + "\n" + "                          END                                                          AS t_reserveAmount,        "
        + "\n" + "                          " + getCurrencyString() +   "                                    AS t_currency,         "
        + "\n" + "                          account.t_accountId                                          AS t_accountId,            "
        + "\n" + "                          account.t_account                                            AS t_account,              "
        + "\n" + "                          account.t_account                                            AS t_balance,              "
        + "\n" + "                          account.t_fiId                                               AS t_fiId,                 "
        + "\n" + "                          account.t_chapter                                            AS t_chapter,              "
        + "\n" + "                          account.t_maturityDate                                       AS t_maturityDate,         "
        + "\n" + "                          account.t_qualityCategory                                    AS t_qualityCategory,      "
        + "\n" + "                          " + getIncomeIsDefinedCondition("account.t_qualityCategory") + " AS t_isIncomeDefined,  "
        + "\n" + "                          CASE                                                                                    "
        + "\n" + "                              WHEN account.t_balance IN (" + accountsForReserve + ")                              "
        + "\n" + "                                  THEN TO_NUMBER(NVL((SELECT atc.t_value                                          "
        + "\n" + "                                                        FROM drepcategory_vw atc                                  "
        + "\n" + "                                                       WHERE     atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                                             AND atc.t_id         = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                                             AND atc.t_ObjectId   = account.t_objectId            "
        + "\n" + "                                                             AND atc.t_isInstalledForEndDate = 1), 0))            "
        + "\n" + "                          ELSE 0                                                                                  "
        + "\n" + "                          END                                                           AS t_categoryToRisk       "
        + "\n" + "               FROM dRepAccount_vw account                                                                        "
        + "\n" + "              WHERE account.t_outCoverRest != 0                                                                   "
        + "\n" + "                AND " + filter.getFilter()
        + "\n" + "                AND " + getCurrencyFilter("account.t_iso_number") + ") tempData) data                             "
        + "\n" + "      WHERE data.t_column BETWEEN " + columnFrom + " AND " + columnTo
        + "\n" + "        AND CASE WHEN (data.t_balance IN (" + accountsForReserve + ") AND NOT ((data.t_categoryToRisk > 0) OR (data.t_isIncomeDefined = 1) )) THEN 0 ELSE 1 END = 1";

         //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        getBackOffice().getName() + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
     end;

    /**
     * Расчет строк: 4.1
     *               4.2
     *               4.4
     */
    macro insertRowDataForRow4_N(row : String, columnFrom : String, columnTo : String,  filter : Object, maskRow : String, maskColumn : String)
        private var accounts= "60806,61304";

        private var tempFilter : string = "((" + getExistsInterestRatesTable() + ") AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                  OR data.t_categoryToRisk > 0 "
        + "\n" + "                                                                  OR data.t_balance IN (" + accounts + ") )";

        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                                 AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
        "\n" + "             CASE"
        + "\n" + "                  WHEN (data.t_categoryToRisk = " + getSqlString(m_report.getLastColumn())
        + "\n" + "                      OR (data.t_categoryToRisk = 0"
        + "\n" + "                      AND NOT " + getExistsInterestRatesTable()
        + "\n" + "                     OR (    data.t_balance IN (" + accounts + ")"
        + "\n" + "                         AND data.t_maturityDate IS NULL)))"
        + "\n" + "                        THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END AS t_rest,"
        + "\n" + "          CASE"
        + "\n" + "               WHEN (data.t_categoryToRisk = " + getSqlString(m_report.getLastColumn())
        + "\n" + "                      OR (data.t_categoryToRisk = 0"
        + "\n" + "                     AND " + getExistsInterestRatesTable() + "))"
        + "\n" + "                     THEN NVL((SELECT acc.t_outConvertionCbRest"
        + "\n" + "                                FROM dRepAccount_vw acc"
        + "\n" + "                               WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                         FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                        WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                          AND percAccount.t_accountTypeName IN ('Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                              ), 0)"
        + "\n" + "          ELSE 0"
        + "\n" + "          END                                                                                                        AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType = 1"
        + "\n" + "                                                                           OR data.t_balance IN (61304)"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM  intervalCase temp"
        + "\n" + "                                                                                       WHERE  data.t_maturityDate IS NOT NULL"
        + "\n" + "                                                                                         AND  data.t_maturityDate BETWEEN temp.t_previousDate"
        + "\n" + "                                                                                                                         AND temp.t_date)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType != 1"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                                       WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                         AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                           AND temp.t_endDay)"
        + "\n" + "                                                                           OR data.t_balance IN (" + accounts + ")"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN  data.t_rateInstrumentType != 1 "
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN  data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"
        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                        WHEN data.t_categoryToRisk > 0"
        + "\n" + "                             THEN data.t_categoryToRisk"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter,  maskRow, maskColumn, getCalculatedQuery, "passive", tempFilter);

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);
        while (data.MoveNext())
            var sumForReport = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

   /**
    * Расчет строк 4.1.1
    *              4.2.1
    */
    macro insertRowDataForRow4_N_1(row : String, columnFrom : String, columnTo : String,  filter : Object, maskRow : String, maskColumn : String)
        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                             AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
          "\n" + "             CASE"
        + "\n" + "                  WHEN (data.t_categoryToRisk = " + getSqlString(m_report.getLastColumn())
        + "\n" + "                      OR (data.t_categoryToRisk = 0"
        + "\n" + "                      AND NOT " + getExistsInterestRatesTable() + "))"
        + "\n" + "                        THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END AS t_rest,"
        + "\n" + "          CASE"
        + "\n" + "               WHEN (data.t_categoryToRisk = " + getSqlString(m_report.getLastColumn())
        + "\n" + "                      OR (data.t_categoryToRisk = 0"
        + "\n" + "                     AND " + getExistsInterestRatesTable() + "))"
        + "\n" + "                     THEN NVL((SELECT acc.t_outConvertionCbRest"
        + "\n" + "                                FROM dRepAccount_vw acc"
        + "\n" + "                               WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                         FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                        WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                          AND percAccount.t_accountTypeName IN ('Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                              ), 0)"
        + "\n" + "          ELSE 0"
        + "\n" + "          END                                                                                                        AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType = 1"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         WHEN data.t_id  = data.t_mainPercentContract AND data.t_rateType != 1"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                                       WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                         AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                           AND temp.t_endDay)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"
        + "\n" + "                     -- Определение интервала (столбца) для каждого ПД"
        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter, maskRow, maskColumn, getCalculatedQuery, "passive");

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

   /**
    * Расчет строки 4.2.2
    */
    macro insertRowDataForRow4_2_2(row : String, columnFrom : String, columnTo : String,  filter : Object, maskRow : String, maskColumn : String)
        private var tempFilter : string = "((" + getExistsInterestRatesTable() + ") AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                  OR data.t_categoryToRisk > 0 )";

        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                             AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
          "\n" + "             CASE"
        + "\n" + "                  WHEN (data.t_categoryToRisk = " + getSqlString(m_report.getLastColumn())
        + "\n" + "                      OR (data.t_categoryToRisk = 0"
        + "\n" + "                         AND NOT " + getExistsInterestRatesTable() + "))"
        + "\n" + "                        THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END AS t_rest,"
        + "\n" + "          CASE"
        + "\n" + "               WHEN " + getExistsInterestRatesTable()
        + "\n" + "                     THEN NVL((SELECT acc.t_outConvertionCbRest"
        + "\n" + "                                FROM dRepAccount_vw acc"
        + "\n" + "                               WHERE acc.t_account IN (SELECT percAccount.t_account"
        + "\n" + "                                                         FROM repPercentAccounts_vw percAccount"
        + "\n" + "                                                        WHERE percAccount.t_contractId = data.t_id"
        + "\n" + "                                                          AND percAccount.t_accountTypeName IN ('Счет просроченных процентов для балансового учета' ))"
        + "\n" + "                              ), 0)"
        + "\n" + "             ELSE 0"
        + "\n" + "             END                                                                                                     AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE "
        + "\n" + "                         WHEN  data.t_id  = data.t_mainPercentContract AND data.t_rateType = 1"
        + "\n" + "                                                                           AND( EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM  intervalCase temp"
        + "\n" + "                                                                                       WHERE      data.t_maturityDate IS NOT NULL"
        + "\n" + "                                                                                             AND  data.t_maturityDate > rep_data.getEndDate()"
        + "\n" + "                                                                                             AND  data.t_maturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                                                      AND temp.t_endDay)"
        + "\n" + "                                                                          OR data.t_maturityDate IS NULL"
        + "\n" + "                                                                          OR data.t_categoryToRisk > 0)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         WHEN  data.t_id  = data.t_mainPercentContract AND data.t_rateType != 1"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                                       WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                         AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                           AND temp.t_endDay)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN  data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN  data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"
        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN  data.t_categoryToRisk > 0"
        + "\n" + "                             THEN data.t_categoryToRisk"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter,  maskRow, maskColumn, getCalculatedQuery, "passive", tempFilter);

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

   /**
    * Расчет строк 4.3
    */
    macro insertRowDataForRow4_3(row : String, columnFrom : String, columnTo : String,  filter : Object, maskRow : String, maskColumn : String)
        private var tempFilter : string = "((" + getExistsInterestRatesTable() + ") AND data.t_categoryToRisk = 0"
        + "\n" + "                                                                  OR data.t_categoryToRisk > 0 )";

        var getCalculatedQuery : String = "";

        var getfloatingRateInstrument =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate > rep_data.getEndDate()"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate < data.t_dateInterval"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate BETWEEN temp.t_previousDate AND temp.t_date";

        var getFixedRateInstrument    =  "\n" + "                                         FROM repPercentRepaymentSchedule_vw repaymentSchedule, intervalCase temp"
        + "\n" + "                                        WHERE repaymentSchedule.t_contractId = data.t_id"
        + "\n" + "                                          AND repaymentSchedule.t_delayMaturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay "
        + "\n" + "                                                                                                             AND temp.t_endDay ";

       if (columnTo ==  m_report.getLastColumn)
            getCalculatedQuery =
          "\n" + "             NVL (data.t_outConvertionCbRest, 0)                                                                     AS t_rest,"
        + "\n" + "             0                                                                                                       AS t_reserveAmount,"
        + "\n" + "             16                                                                                                      AS t_column";
        else
            getCalculatedQuery =
          "\n" + "                     CASE "
        + "\n" + "                         WHEN  data.t_id  = data.t_mainPercentContract AND data.t_rateType = 1"
        + "\n" + "                                                                           AND( EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM  intervalCase temp"
        + "\n" + "                                                                                       WHERE      data.t_maturityDate IS NOT NULL"
        + "\n" + "                                                                                             AND  data.t_maturityDate > rep_data.getEndDate()"
        + "\n" + "                                                                                             AND  data.t_maturityDate - rep_data.getEndDate()  BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                                                      AND temp.t_endDay)"
        + "\n" + "                                                                          OR data.t_maturityDate IS NULL"
        + "\n" + "                                                                          OR data.t_categoryToRisk > 0)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         WHEN  data.t_id  = data.t_mainPercentContract AND data.t_rateType != 1"
        + "\n" + "                                                                           AND EXISTS(SELECT 1"
        + "\n" + "                                                                                        FROM contractIntervalContract ctrInterval, intervalCase temp"
        + "\n" + "                                                                                       WHERE ctrInterval.t_contractId = data.t_id"
        + "\n" + "                                                                                         AND ctrInterval.t_dayInterval BETWEEN temp.t_startDay"
        + "\n" + "                                                                                                                           AND temp.t_endDay)"
        + "\n" + "                             THEN NVL (data.t_outConvertionCbRest, 0)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END                                                                                             AS t_rest,"
        + "\n" + "                     CASE"
        + "\n" + "                         WHEN  data.t_rateInstrumentType != 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                       ), 0)"
        + "\n" + "                        WHEN  data.t_rateInstrumentType = 1"
        + "\n" + "                             THEN NVL((SELECT SUM(repaymentSchedule.t_roubleSum)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                     ELSE 0"
        + "\n" + "                     END                                                                                             AS t_reserveAmount,"
        + "\n" + "                     CASE "
        + "\n" + "                         WHEN data.t_rateInstrumentType != 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getfloatingRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_rateInstrumentType = 1 AND data.t_categoryToRisk = 0"
        + "\n" + "                             THEN NVL((SELECT MAX(temp.t_column)"
               +                                         getFixedRateInstrument
        + "\n" + "                                      ), 0)"
        + "\n" + "                         WHEN data.t_categoryToRisk > 0"
        + "\n" + "                             THEN data.t_categoryToRisk"
        + "\n" + "                     END                                                                                             AS t_column";
        end;

        var baseQuery : String = getBaseQuery(row, columnFrom, columnTo, filter, row, maskColumn, getCalculatedQuery, "passive", tempFilter);

       //пишем данные в протокол
        var data = TRsbDataSet(baseQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        data.t_rateInstrumentType,
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        data.t_backOfficeCode + "/" + data.t_number,
                                        data.t_rateType,
                                        data.t_isMainPercentContract,
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

   /**
    * Расчет строк 4.5
    */
    macro insertRowDataForRow4_5(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("1");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var intervalCase =  "NVL(account.t_maturityDate - rep_data.getEndDate(), 0) ";

        var isLastColumn = ternary((columnFrom == string(m_report.getLastColumn())) and (columnFrom = columnTo), true, false);

        var strQuery = "SELECT 0                                AS t_contractId,                                           "
        + "\n" + "             " + getSqlString(row) + "        AS t_row,                                                  "
        + "\n" + "             account.t_outConvertionCbRest    AS t_rest,                                                 "
        + "\n" + "             account.t_calcReserveAmount      AS t_reserveAmount,                                        "
        + "\n" + "             " + getCurrencyString() + "      AS t_currency,                                             "
        + "\n" + "             account.t_account,                                                                          "
        + "\n" + "             account.t_iso_number,                                                                       "
        + "\n" + "             account.t_maturityDate,                                                                     "
        + "\n" + "             account.t_column,                                                                           "
        + "\n" + "             account.t_percentAccount,                                                                   "
        + "\n" + "             account.t_categoryToRisk,                                                                   "
        + "\n" + "             account.t_qualityCategory,                                                                  "
        + "\n" + "             " + getBackOffice().getId() + "  AS t_backOffice                                            "
        + "\n" + "       FROM (SELECT account.t_maturityDate,                                                              "
        + "\n" + "                    account.t_iso_number,                                                                "
        + "\n" + "                    account.t_outConvertionCbRest,                                                       "
        + "\n" + "                    account.t_calcReserveAmount,                                                         "
        + "\n" + "                    account.t_account,                                                                   "
        + "\n" + "                    NVL(account.t_accountReservePercent/100.00, 0)              AS t_percentAccount,     "
        + "\n" + "                    TO_NUMBER(NVL((SELECT atc.t_value                                                    "
        + "\n" + "                                     FROM drepcategory_vw atc                                            "
        + "\n" + "                                    WHERE atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                      AND atc.t_id         = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                      AND atc.t_ObjectId   = account.t_objectId                          "
        + "\n" + "                                      AND atc.t_isInstalledForEndDate = 1), 0)) AS t_categoryToRisk,     "
        + "\n" + "                    account.t_qualityCategory                                   AS t_qualityCategory,    "
        + "\n" + "                    CASE                                                                                 "
        + "\n" + "                        WHEN " + ternary(isLastColumn, "1 = 1", "1 = 0")
        + "\n" + "                            THEN " + m_report.getLastColumn()
        + "\n" + "                        ELSE " + getTermsCondition(intervalCase)
        + "\n" + "                    END                                                         AS t_column              "
        + "\n" + "               FROM dRepAccount_vw account                                                               "
        + "\n" + "              WHERE account.t_outCoverRest != 0                                                          "
        + "\n" +                       filter.getFilter()
        + "\n" + "                AND " + getCurrencyFilter("account.t_iso_number")
        + "\n" + "                AND (" + ternary(isLastColumn, "1 = 1", "1 = 0")
        + "\n" + "                    AND  account.t_objectId IN                                                           "
        + "\n" + "                   (SELECT atc.t_ObjectId                                                                "
        + "\n" + "                      FROM drepcategory_vw atc                                                           "
        + "\n" + "                     WHERE atc.t_ObjectId   = account.t_objectId                                         "
        + "\n" + "                       AND atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                       AND atc.t_id         = " + RCB_OBJGROUP_SHARESTYPE
        + "\n" + "                       AND ( (atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('Привилегированные акции, выпущенные в соотв. с ФЗ № 181-ФЗ')          "
        + "\n" + "                          AND atc.t_value LIKE ('ПА по 181-ФЗ'))                                         "
        + "\n" + "                      OR (    atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('Прив. акции, проведенные до 01.03.2013 года, п. 3.1.1 395-П')         "
        + "\n" + "                          AND atc.t_value LIKE ('ПА до 01.03.2013'))                                     "
        + "\n" + "                      OR (    atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('ПА, оплаченные АСВ облигациями ФЗ в соответствии с 451-ФЗ')           "
        + "\n" + "                          AND atc.t_value LIKE                                                           "
        + "\n" + "                                ('ПА, оплаченные АСВ'))                                                  "
        + "\n" + "                      OR (    atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('Прив. акции, проведенные после 01.03.2013 г., п. 3.1.1 395-П')        "
        + "\n" + "                          AND atc.t_value LIKE                                                           "
        + "\n" + "                                 ('ПА после 01.03.2013'))                                                "
        + "\n" + "                      OR (    atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('Прив. акц, выпущенные после 01.03.2013 в соотв. с ФЗ №173-ФЗ')        "
        + "\n" + "                          AND atc.t_value LIKE                                                           "
        + "\n" + "                                 ('ПА по 173-ФЗ с 01.03.2013'))                                          "
        + "\n" + "                      OR (    atc.t_shortName LIKE                                                       "
        + "\n" + "                                 ('ПА, выпущ. до 01.03.2013 в соотв. с абз. 4 п.2.1.1 и №173-ФЗ')        "
        + "\n" + "                          AND atc.t_value LIKE                                                           "
        + "\n" + "                                 ('ПА по 173-ФЗ до 01.03.2013')))                                        "
        + "\n" + "                AND atc.t_isInstalledForEndDate = 1)))account                                            "
        + "\n" + "      WHERE t_column BETWEEN " + columnFrom + " AND " + columnTo;

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_rest",   V_MONEY);
            data.setFieldType("t_reserveAmount", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_rest) + nvl(data.t_reserveAmount);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        "",
                                        data.t_categoryToRisk,
                                        ternary(data.t_qualityCategory != NULL, data.t_qualityCategory, ""),
                                        ternary(data.t_maturityDate != NULL, data.t_maturityDate, ""),
                                        data.t_rest,
                                        data.t_reserveAmount,
                                        data.t_percentAccount,
                                        getBackOffice().getName() + "/" + 0,
                                        "",
                                        "",
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

   //Внебалансовые требования/обязательства
    macro insertRowDataForOffBalance(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        if (filter == NULL)
            filter = getFilter().clear();
        else
            filter = filter.op.("AND");
        end;

        filter.accountIsOpened();
        filter.op("AND");
        filter.isChapterIn("3");
        filter.op("AND");

        filter.isSatisfiesToMasks(getAccountMask(maskRow, maskColumn));

        var strQuery =
                 " SELECT data.* "
        + "\n" + "   FROM (SELECT 0 AS t_contractId, "
        + "\n" + "                " + getSqlString(row) + " AS t_row,"
        + "\n" + "                CASE WHEN TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                                           FROM drepcategory_vw atc"
        + "\n" + "                                          WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                            AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                            AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                                            AND atc.t_isInstalledForEndDate = 1), 0)) > 0  "
        + "\n" + "                     THEN TO_NUMBER(NVL((SELECT atc.t_value"
        + "\n" + "                                           FROM drepcategory_vw atc"
        + "\n" + "                                          WHERE atc.t_ObjectType            = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                                            AND atc.t_id                    = " + RCB_OBJGROUP_RISKTOINTERESTRATE
        + "\n" + "                                            AND atc.t_ObjectId              = account.t_objectId"
        + "\n" + "                                            AND atc.t_isInstalledForEndDate = 1), 0)) "
        + "\n" + "                     ELSE " + getTermsCondition("NVL(account.t_maturityDate - rep_data.getEndDate(), 0) ")
        + "\n" + "                END  t_column,"
        + "\n" + "                    NVL(account.t_outConvertionCbRest, 0) AS t_value,"
        + "\n" + "                " + getCurrencyString() + " AS t_currency,"
        + "\n" + "                " + getBackOffice().getId() + " AS t_backOffice,"
        + "\n" + "                account.t_account AS t_account"
        + "\n" + "           FROM dRepAccount_vw account"
        + "\n" + "          WHERE account.t_outCoverRest != 0"
        + "\n" + "            AND " + filter.getFilter()
        + "\n" + "            AND " + getCurrencyFilter("account.t_iso_number") + ") data"
        + "\n" + " WHERE t_column BETWEEN " + columnFrom + " AND " + columnTo;

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_account,
                                        "",
                                        "",
                                        "",
                                        "",
                                        "",
                                        "",
                                        "",
                                        ""
                                        "",
                                        "",
                                        sumForReport,
                                        data.t_column
                                        );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

    /**
    * Получить данные по главной книге
    *
    * @return TArray of TF127StandaloneAttributeValue Список рассчитанных атрибутов
    */
    macro getData(): TArray

    end;

    /**
    * Кеширование данных.
    */
    macro cashData()
         sql_execute("BEGIN"
             +"\n"+ "      rep_data.initPercentRepaymentSchedule(rep_data.getEndDate(),"
             +"\n"+ "                                           'SELECT acc.t_chapter,"
             +"\n"+ "                                                   acc.t_fiId,"
             +"\n"+ "                                                   acc.t_account"
             +"\n"+ "                                              FROM drepAccount_vw acc"
             +"\n"+ "                                             WHERE acc.t_isOpenedAtEndDate = 1"
             +"\n"+ "                                               AND " + strSubst(getCurrencyFilter("acc.t_iso_number"), "'","''")
             +"\n"+ "                                               AND acc.t_chapter = 1');"
             +"\n"+ "END;");
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_CB);
        cashData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127CbData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127CbData(tuneTable, protocolView);
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127CbData_4637(tuneTable, protocolView);
end;

/**
* Форма 127. Источник данных расчета по данным Loans
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127LoansData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Номера регистров, задаваемые в настроечной таблице
    */
    private var m_userRegisters : String;

    private macro getUserRegisters()
        return m_userRegisters;
    end;

    /**
    * Заполнить номера регистров, задаваемые в настроечной таблице
    */
    private macro fillUserRegisters();
        m_userRegisters = NVL(m_tuneTable.getRegistryNumbers("1.6", getBackOffice().getId(), "3"),    "0")
                  + "," + NVL(m_tuneTable.getRegistryNumbers("1.6", getBackOffice().getId(), "4-16"), "0");
    end;

    private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = contract.t_fiId)";
        end;
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df127Contract_tmp");
        sql_execute("TRUNCATE TABLE df127TermDemand_tmp");
        sql_execute("TRUNCATE TABLE df127Interest_tmp");
        sql_execute("TRUNCATE TABLE df127Register_tmp");
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
        var strQuery = "";

        //Договора
        strQuery ="INSERT INTO df127Contract_tmp(t_contractId,      "
        + "\n" + "                               t_creditType,      "
        + "\n" + "                               t_trancheKind,     "
        + "\n" + "                               t_trancheNumber,   "
        + "\n" + "                               t_currency,        "
        + "\n" + "                               t_issueType,       "
        + "\n" + "                               t_finishDate,      "
        + "\n" + "                               t_qualityCategory, "
        + "\n" + "                               t_reservePercent,  "
        + "\n" + "                               t_aim,             "
        + "\n" + "                               t_isBank,          "
        + "\n" + "                               t_clientType,      "
        + "\n" + "                               t_timeInterval)    "
        + "\n" + " SELECT contract.t_id,                       "
        + "\n" + "        contract.t_type,                     "
        + "\n" + "        tranche.t_kind,                     "
        + "\n" + "        tranche.t_number AS t_trancheNumber,"
        + "\n" + "        " + getCurrencyString() + " AS t_currency,"
        + "\n" + "        contract.t_issueType,                "
        + "\n" + "        contract.t_finishDate,               "
        + "\n" + "        contract.t_rvpsQualityCategory,      "
        + "\n" + "        contract.t_rvpsReservePercent,       "
        + "\n" + "        contract.t_aim,       "
        + "\n" + "        (SELECT party.t_isBank FROM dRepParty_vw party WHERE contract.t_contragentId = party.t_id) AS t_isBank, "
        + "\n" + "        contract.t_clientType AS t_clientType, "
        + "\n" + "        0 AS t_timeInterval"
        + "\n" + "   FROM repLnsContract_vw  contract,          "
        + "\n" + "        repLnsTranches_vw tranche          "
        + "\n" + "  WHERE contract.t_id = tranche.t_contractId"
        + "\n" + "    AND " + rcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
        + "\n" + "    AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND tranche.t_isFictive = 0"
        + "\n" + "    AND " + getCurrencyFilter("(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = contract.t_fiId)")
        + "\n" + "    AND (   contract.t_type = " + LO_CREDIT
        + "\n" + "         OR contract.t_type = " + LO_KARTA
        + "\n" + "         OR contract.t_type = " + LO_GUARANTEE
        + "\n" + "         OR contract.t_type = " + LO_OVERDRAFT
        + "\n" + "         OR contract.t_type = " + LO_DEPOSIT + ")";

        sql_execute(strQuery);

        var commandInitPerc = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_trancheNumber AS a_objectNumber,"
                   + "\n" + "        t_trancheKind   AS a_objectTypeId "
                   + "\n" + "   FROM df127Contract_tmp)          ";

        commandInitPerc.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandInitPerc.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandInitPerc.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandInitPerc.addParam("DataSource", RSDBP_IN, queryTranches);

        commandInitPerc.execute();

        /* Обновление временного интервала */
        strQuery =" UPDATE df127Contract_tmp contract "
        + "\n" + "    SET contract.t_timeInterval = NVL((SELECT (rate.t_rateDate - rep_data.getEndDate())       "
        + "\n" + "                                         FROM repLnsRateHistory_vw rate    "
        + "\n" + "                                        WHERE contract.t_trancheKind   = rate.t_objectId "
        + "\n" + "                                          AND contract.t_trancheNumber = rate.t_objectNumber"
        + "\n" + "                                          AND rate.t_rateType <> 1  "
        + "\n" + "                                          AND rate.t_rateDate  = (SELECT MIN(r.t_rateDate) "
        + "\n" + "                                                                    FROM repLnsRateHistory_vw r "
        + "\n" + "                                                                   WHERE contract.t_trancheKind   = r.t_objectId "
        + "\n" + "                                                                     AND contract.t_trancheNumber = r.t_objectNumber"
        + "\n" + "                                                                     AND r.t_rateType <> 1  "
        + "\n" + "                                                                     AND r.t_rateDate > rep_data.getEndDate()"
        + "\n" + "                                                                  )    "
        + "\n" + "                                      ), 0)";

        /*Срочное требование*/
        strQuery =" INSERT INTO df127TermDemand_tmp(t_trancheKind,   "
        + "\n" + "                                 t_trancheNumber, "
        + "\n" + "                                 t_roubleRest,    "
        + "\n" + "                                 t_demandDate)    "
        + "\n" + " SELECT expDemand.t_trancheKind,                  "
        + "\n" + "        expDemand.t_trancheNumber,                "
        + "\n" + "        expDemand.t_roubleRest,                   "
        + "\n" + "        expDemand.t_repaymentDate                 "
        + "\n" + "   FROM repLnsExpDemand_vw expDemand              "
        + "\n" + "  WHERE expDemand.t_isOpenedAtEndDate = 1         "
        + "\n" + "    AND EXISTS(SELECT 1                           "
        + "\n" + "                 FROM df127Contract_tmp contract  "
        + "\n" + "                WHERE contract.t_trancheKind   = expDemand.t_trancheKind     "
        + "\n" + "                  AND contract.t_trancheNumber = expDemand.t_trancheNumber "
        + "\n" + "                  AND contract.t_creditType   != " + LO_DEPOSIT
        + "\n" + "              )";

        sql_execute(strQuery);

/* Вычисление временных интервалов */
        strQuery =" UPDATE df127Contract_tmp contract "
        + "\n" + "    SET contract.t_timeInterval = (CASE WHEN  contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "                                            THEN contract.t_finishDate"
        + "\n" + "                                        ELSE    "
        + "\n" + "                                            NVL ((SELECT MAX(td.t_demandDate)  "
        + "\n" + "                                                    FROM df127TermDemand_tmp td   "
        + "\n" + "                                                   WHERE td.t_trancheKind = contract.t_trancheKind     "
        + "\n" + "                                                     AND td.t_trancheNumber = contract.t_trancheNumber "
        + "\n" + "                                                ), contract.t_finishDate)                "
        + "\n" + "                                   END - rep_data.getEndDate()                            "
        + "\n" + "                                  )                            "
        + "\n" + "  WHERE contract.t_timeInterval = 0 "
        + "\n" + "    AND (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "              AND contract.t_qualityCategory IN (1, 2, 3))"
        + "\n" + "         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "        )";

        sql_execute(strQuery);

/* Вычисление графы отчета по временному интервалу */
        strQuery =" UPDATE df127Contract_tmp contract "
        + "\n" + "    SET contract.t_column = CASE WHEN contract.t_timeInterval > 0"
        + "\n" + "                                     THEN "
        + "\n" + getTermsCondition("contract.t_timeInterval")
        + "\n" + "                                 ELSE " + m_report.getFirstColumn()
        + "\n" + "                            END "
        + "\n" + "  WHERE (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "              AND contract.t_qualityCategory IN (1, 2, 3))"
        + "\n" + "         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "        )";

        sql_execute(strQuery);


        /*Наращенные проценты*/
        strQuery =" INSERT INTO df127Interest_tmp(t_trancheKind,    "
        + "\n" + "                               t_trancheNumber,  "
        + "\n" + "                               t_roubleRest,     "
        + "\n" + "                               t_column)         "
        + "\n" + " SELECT interest.t_trancheKind,                  "
        + "\n" + "        interest.t_trancheNumber,                "
        + "\n" + "        interest.t_roubleSum,                    "
        + "\n" + getTermsCondition("interest.t_repaymentRemainTerm") + " AS t_column"
        + "\n" + "   FROM repLnsInterest_vw interest               "
        + "\n" + "  WHERE t_isOpenedAtEndDate = 0                  "
        + "\n" + "    AND EXISTS(SELECT 1                          "
        + "\n" + "                 FROM df127Contract_tmp contract "
        + "\n" + "                WHERE contract.t_trancheKind = interest.t_trancheKind     "
        + "\n" + "                  AND contract.t_trancheNumber = interest.t_trancheNumber "
        + "\n" + "                  AND (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "                              AND contract.t_qualityCategory IN (1, 2, 3))"
        + "\n" + "                         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "                        )"
        + "\n" + "              )";

        sql_execute(strQuery);

        /* Заполнить временную таблицу резервов*/
        var querySource =    "SELECT credit.t_contractId AS a_creditNumber,     "
                    + "\n" + "       credit.t_creditType AS a_type              "
                    + "\n" + "  FROM df127Contract_tmp credit                   "
                    + "\n" + " WHERE credit.t_creditType != " + LO_DEPOSIT
                    + "\n" + "   AND credit.t_qualityCategory IN (1, 2, 3)      "
                    + "\n" + " GROUP BY credit.t_contractId, credit.t_creditType";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);

        command.execute();

        /* Регистры */

        strQuery =" INSERT INTO df127Register_tmp (t_trancheKind,   "
        + "\n" + "                                t_trancheNumber, "
        + "\n" + "                                t_type,          "
        + "\n" + "                                t_roubleRest)    "
        + "\n" + " SELECT register.t_trancheKind,                  "
        + "\n" + "        register.t_trancheNumber,                "
        + "\n" + "        register.t_type,                         "
        + "\n" + "        register.t_roubleRest                    "
        + "\n" + "   FROM repLnsRegister_vw register               "
        + "\n" + "  WHERE EXISTS(SELECT 1                          "
        + "\n" + "                 FROM df127Contract_tmp contract "
        + "\n" + "                WHERE contract.t_trancheKind = register.t_trancheKind     "
        + "\n" + "                  AND contract.t_trancheNumber = register.t_trancheNumber)"
        + "\n" + "    AND register.t_roubleRest <> 0 AND register.t_type IN (" + TDR_MAINREST            +" ,"
                                                                               + TDR_EXPREST             +" ,"
                                                                               + TDR_EXPPERC             +" ,"
                                                                               + TDR_EXPPERC_OV          +" ,"
                                                                               + TDR_PAYMGUARANTEE       +" ,"
                                                                               + TDR_EXPPAYMGUARANTEE    +" ,"
                                                                               + TDR_PAYMGUARANTEEEXPPERC+" ,"
                                                                               + TDR_DEPOHIST            +" ,"
                                                                               + TDR_EXPDEPOHIST         +" ,"
                                                                               + TDR_DEPOPERC            +" ,"
                                                                               + TDR_DEPOEXPPERC         +" ,"
                                                                               + getUserRegisters() + ")     ";
        sql_execute(strQuery);

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(     " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                      "
                + "\n" + "                                       t_backOfficeId,                 "
                + "\n" + "                                       t_creditId,                     "
                + "\n" + "                                       t_fiId,                         "
                + "\n" + "                                       t_cbAccountNumber)              "
                + "\n" + "                                SELECT t_chapter,                      "
                + "\n" + "                                       CASE WHEN EXISTS(SELECT 1 "
                + "\n" + "                                                          FROM df127contract_tmp cr "
                + "\n" + "                                                         WHERE acc.t_contractId = cr.t_contractId  "
                + "\n" + "                                                           AND cr.t_creditType =  " + LO_DEPOSIT + ")"
                + "\n" + "                                                THEN " + f127Constant.backOffice.BACKOFFICE_DEPOSITS
                + "\n" + "                                                ELSE " + getBackOffice().getId()
                + "\n" + "                                       END,"
                + "\n" + "                                       acc.t_contractId,               "
                + "\n" + "                                       acc.t_fiId,                     "
                + "\n" + "                                       acc.t_cbAccount                 "
                + "\n" + "                                  FROM repLnsAccount_vw acc            "
                + "\n" + "                                WHERE  acc.t_cbAccount <> chr(1)       "
                + "\n" + "                                  AND  acc.t_outRest != 0       "
                + "\n" + "                                  AND  EXISTS (SELECT 1 FROM df127contract_tmp c WHERE acc.t_contractId = c.t_contractId)");
    end;

    private macro getBaseQuery(maskRow : string, maskColumn : String, filter : Object, isNotBank : bool)
        var filterCond = "";

        if (valType(filter) != V_UNDEF)
            filterCond = filter.getFilter();
        end;

        var query =
                 "SELECT credit.t_contractId,"
        + "\n" + "       (select contract.t_number                                                      "
        + "\n" + "          from repLnsContract_vw contract                                             "
        + "\n" + "         where contract.t_id = credit.t_contractId)              AS t_number,         "
        + "\n" + "       case                                                                           "
        + "\n" + "           when credit.t_isBank = 1                                                   "
        + "\n" + "               then 'КО'                                                              "
        + "\n" + "           when credit.t_clientType = 1                                               "
        + "\n" + "               then 'ЮЛ'                                                              "
        + "\n" + "           when credit.t_clientType = 2                                               "
        + "\n" + "               then 'ФЛ'                                                              "
        + "\n" + "           else ' '                                                                   "
        + "\n" + "       end                                                       AS t_contragent,     "
        + "\n" + "       credit.t_aim, "
        + "\n" + "       case                                                                           "
        + "\n" + "           when credit.t_creditType = " + LO_CREDIT
        + "\n" + "               then 'ОВ'                                                              "
        + "\n" + "           when credit.t_creditType = " + LO_GUARANTEE
        + "\n" + "               then 'КД'                                                              "
        + "\n" + "           when credit.t_creditType = " + LO_KARTA
        + "\n" + "               then 'БК'                                                              "
        + "\n" + "           when credit.t_creditType = " + LO_GUARANTEE
        + "\n" + "               then 'ДГ'                                                              "
        + "\n" + "           else ' '                                                                   "
        + "\n" + "       end                                                       AS t_creditType,     "
        + "\n" + "       (SELECT SUM(interest.t_roubleRest)                                             "
        + "\n" + "          FROM df127Interest_tmp interest                                             "
        + "\n" + "         WHERE interest.t_trancheKind   = credit.t_trancheKind                        "
        + "\n" + "           AND interest.t_trancheNumber = credit.t_trancheNumber                      "
        + "\n" + "           AND interest.t_column        = credit.t_column)       AS t_interestSum,    "
        + "\n" + "       (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "          FROM df127register_tmp register                                             "
        + "\n" + "         WHERE register.t_trancheKind   = credit.t_trancheKind                        "
        + "\n" + "           AND register.t_trancheNumber = credit.t_trancheNumber                      "
        + "\n" + "           AND register.t_type          = " + TDR_EXPREST + ")   AS t_expRest,        "
        + "\n" + "       (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "          FROM df127register_tmp register                                             "
        + "\n" + "         WHERE register.t_trancheKind   = credit.t_trancheKind                        "
        + "\n" + "           AND register.t_trancheNumber = credit.t_trancheNumber                      "
        + "\n" + "           AND register.t_type          = " + TDR_EXPPERC + ")   AS t_expPerc,        "
        + "\n" + "       (SELECT SUM(tranches.t_calcRvpPerc)                                            "
        + "\n" + "          FROM repLnsTranches_vw tranches                                             "
        + "\n" + "         WHERE tranches.t_kind          = credit.t_trancheKind                        "
        + "\n" + "           AND tranches.t_number        = credit.t_trancheNumber                      "
        + "\n" + "           AND tranches.t_contractId    = credit.t_contractId)   AS t_calcRvpPerc,    "
        + "\n" + "       credit.t_timeInterval, "
        + "\n" + "       credit.t_trancheKind, "
        + "\n" + "       credit.t_trancheNumber,"
        + "\n" + "       credit.t_qualityCategory,"
        + "\n" + "       credit.t_currency,"
        + "\n" + "       CASE "
        + "\n" + "            WHEN credit.t_qualityCategory IN (4,5)"
        + "\n" + "                THEN " + m_report.getLastColumn()
        + "\n" + "            WHEN credit.t_qualityCategory IN (1,2,3)"
        + "\n" + "                THEN credit.t_column"
        + "\n" + "            ELSE"
        + "\n" + "                0"
        + "\n" + "       END AS t_column,"
        + "\n" + "       (1 - credit.t_reservePercent/100.0) AS t_reservePercent," //т.к. процент резервирования везде используется в виде: Сумма - Сумма*ПроцентРезервирования
        + "\n" + "       NVL((SELECT SUM(register.t_roubleRest) "
        + "\n" + "              FROM df127register_tmp register "
        + "\n" + "             WHERE register.t_trancheKind   = credit.t_trancheKind "
        + "\n" + "               AND register.t_trancheNumber = credit.t_trancheNumber"
        + "\n" + "               AND register.t_type          = DECODE(credit.t_creditType, " + LO_GUARANTEE + ", " + TDR_PAYMGUARANTEE + ", " + TDR_MAINREST + ")), 0) AS t_trancheRest"
        + "\n" + "  FROM df127Contract_tmp credit "
        + "\n" + " WHERE EXISTS(SELECT 1  "
        + "\n" + "                FROM drcbBackOfficeAccount_tmp account   "
        + "\n" + "               WHERE credit.t_contractId    = account.t_creditId"
        + "\n" + "                 AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                 AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "   AND credit.t_creditType != " + LO_DEPOSIT
        + "\n" + "   " + filterCond
        + "\n" + "   " + ternary(isNotBank == true, "AND credit.t_isBank != 1", "")
        + "\n" + " ORDER BY t_column";

        return query;
    end;

    //вывод данных в протокол
    private macro fillProtocol(maskRow : string, maskColumn : String, filter : Object, isNotBank : bool)
        var protocolData = TRsbDataSet(getBaseQuery(maskRow, maskColumn, filter, isNotBank));
        var trancheRest;            //Остаток основного долга
        var reservePercent;         //Процент резервирования
        var interestSum;
        var expRest;
        var expPerc;
        var calcRvpPerc;
        var reportSum;              //Сумма в отчете
        var graphName:string ="";

        m_protocolView.printRow(maskRow);
        while (protocolData.MoveNext())
            trancheRest    = ternary(protocolData.t_trancheRest    != null, protocolData.t_trancheRest,    $0.0);
            reservePercent = ternary(protocolData.t_reservePercent != null, protocolData.t_reservePercent, $0.0);
            interestSum    = ternary(protocolData.t_interestSum    != null, protocolData.t_interestSum,    $0.0);
            expRest        = ternary(protocolData.t_expRest        != null, protocolData.t_expRest,        $0.0);
            expPerc        = ternary(protocolData.t_expPerc        != null, protocolData.t_expPerc,        $0.0);
            calcRvpPerc    = ternary(protocolData.t_calcRvpPerc    != null, protocolData.t_calcRvpPerc,    $0.0);
            reportSum = trancheRest - trancheRest * reservePercent / 100
                      + interestSum - interestSum * reservePercent / 100
                      + expRest     - expRest     * reservePercent / 100
                      + expPerc     - calcRvpPerc;
            if ((graphName!=string(protocolData.t_column)) and protocolData.t_column !=0)
                m_protocolView.printString("Графа " + int(protocolData.t_column));
                graphName = protocolData.t_column;
                m_protocolView.printString(protocolData.t_number,                                                               //Номер договора
                                       ternary(protocolData.t_trancheNumber   != null, protocolData.t_trancheNumber,   ""), //Номер транша
                                       ternary(protocolData.t_creditType      != null, protocolData.t_creditType,      ""), //Тип договора
                                       ternary(protocolData.t_aim             != null, protocolData.t_aim,             ""), //Цель кредита
                                       protocolData.t_contragent,                                                           //Контрагент по договору
                                       ternary(protocolData.t_qualityCategory != null, protocolData.t_qualityCategory, ""), //ККС
                                       protocolData.t_timeInterval,                                                         //Временной интервал
                                       ternary(protocolData.t_trancheRest     != null, protocolData.t_trancheRest,     ""), //Остаток основного долга
                                       ternary(protocolData.t_reservePercent  != null, protocolData.t_reservePercent,  ""), //Процент резервирования
                                       ternary(protocolData.t_interestSum     != null, protocolData.t_interestSum,     ""), //Сумма наращенных %
                                       ternary(protocolData.t_expRest         != null, protocolData.t_expRest,         ""), //Сумма просроченного  основного долга
                                       ternary(protocolData.t_expPerc         != null, protocolData.t_expPerc,         ""), //Сумма просроченных процентов
                                       ternary(protocolData.t_calcRvpPerc     != null, protocolData.t_calcRvpPerc,     ""), //Сумма резерва по процентам
                                       reportSum                                                                            //Сумма в отчете
                                      );
            end;
        end;
    end;

    /*
    * Вставить данные для строки(кроме строки 1.6)
    */
    macro insertRowData(row : string, filter : Object, maskRow : string, maskColumn : String)
        var strQuery = "";

        strQuery =
                 "SELECT t_contractId,"
        + "\n" + "       " + getSqlString(row) + "       AS t_row,"
        + "\n" + "       t_column                        AS t_column,"
        + "\n" + "       SUM(t_value)                    AS t_value,"
        + "\n" + "       t_currency                      AS t_currency,"
        + "\n" + "       " + getBackOffice().getId() + " AS t_backOffice"
        + "\n" + "  FROM (SELECT data.t_contractId,"
        + "\n" + "               CASE "
        + "\n" + "                   WHEN data.t_qualityCategory IN (4,5)"
        + "\n" + "                       THEN " + m_report.getLastColumn()
        + "\n" + "                   ELSE data.t_column"
        + "\n" + "               END AS t_column, "
        + "\n" + "               (CASE WHEN (data.t_trancheRest != 0) "
        + "\n" + "                       THEN NVL((SELECT SUM(termDemand.t_roubleRest) "       //Срочные требования
        + "\n" + "                                   FROM df127TermDemand_tmp termDemand "
        + "\n" + "                                  WHERE termDemand.t_trancheKind   = data.t_trancheKind "
        + "\n" + "                                    AND termDemand.t_trancheNumber = data.t_trancheNumber), 0) * data.t_reservePercent "
        + "\n" + "                      ELSE DECODE (data.t_column, " + m_report.getFirstColumn() + ","
        + "\n" + "                                   NVL((SELECT SUM(register.t_roubleRest) * data.t_reservePercent"
        + "\n" + "                                          FROM df127register_tmp register "
        + "\n" + "                                         WHERE register.t_trancheKind   = data.t_trancheKind "
        + "\n" + "                                           AND register.t_trancheNumber = data.t_trancheNumber"
        + "\n" + "                                           AND register.t_roubleRest   != 0"
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPREST          + ","
                                                                                       + TDR_EXPPAYMGUARANTEE
        + "\n" + "                                                                   )), 0) + "
        + "\n" + "                                   NVL((SELECT SUM(register.t_roubleRest) - SUM((SELECT tranche.t_CalcRVPExpPerc "
        + "\n" + "                                                                                   FROM repLnsTranches_vw tranche "
        + "\n" + "                                                                                  WHERE tranche.t_kind   = data.t_trancheKind "
        + "\n" + "                                                                                    AND tranche.t_number = data.t_trancheNumber))"
        + "\n" + "                                          FROM df127register_tmp register "
        + "\n" + "                                         WHERE register.t_trancheKind   = data.t_trancheKind "
        + "\n" + "                                           AND register.t_trancheNumber = data.t_trancheNumber"
        + "\n" + "                                           AND register.t_roubleRest   != 0"
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPPERC              + ","
                                                                                       + TDR_EXPPERC_OV           + ","
                                                                                       + TDR_PAYMGUARANTEEEXPPERC
        + "\n" + "                                                                   )), 0),"
        + "\n" + "                                        0)"
        + "\n" + "                END) "
        + "\n" + "                  +                      "
        + "\n" + "                CASE "
        + "\n" + "                    WHEN (data.t_qualityCategory IN (1,2,3) AND data.t_trancheRest != 0)"  //Для всех граф, кроме последней
        + "\n" + "                        THEN NVL((SELECT SUM(interest.t_roubleRest) "       //Наращенные проценты
        + "\n" + "                                    FROM df127Interest_tmp interest "
        + "\n" + "                                   WHERE interest.t_trancheKind   = data.t_trancheKind "
        + "\n" + "                                     AND interest.t_trancheNumber = data.t_trancheNumber"
        + "\n" + "                                     AND interest.t_column        = data.t_column), 0) * t_reservePercent"
        + "\n" + "                    ELSE 0"
        + "\n" + "                END AS t_value,"
        + "\n" + "                data.t_currency AS t_currency"
        + "\n" + "           FROM (" + getBaseQuery(maskRow, maskColumn, filter, true) + ") data )"
        + "\n" + "           WHERE t_column > 0 "
        + "\n" + " GROUP BY t_currency, t_column, t_contractId ";

        summaryInserter(strQuery);

        //пишем данные в протокол
        fillProtocol(maskRow, maskColumn, filter, true);
    end;

    macro insertRowData_1_6(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String)
        var strQuery = "";

        strQuery = "SELECT t_contractId,"
        + "\n" + "     " + getSqlString(row) + " AS t_row,"
        + "\n" + "         t_column AS t_column,"
        + "\n" + "         SUM(t_value) AS t_value,"
        + "\n" + "         t_currency AS t_currency,"
        + "\n" + "     " + getBackOffice().getId() + " AS t_backOffice"
        + "\n" + "    FROM (SELECT data.t_contractId,"
        + "\n" + "                 data.t_currency,"
        + "\n" + "                 data.t_column,"
        + "\n" + "                 NVL((SELECT SUM(register.t_roubleRest) - SUM(NVL((SELECT reserve.t_calcRvpKomiss "
        + "\n" + "                                                                     FROM repLnsReserve_vw reserve "
        + "\n" + "                                                                    WHERE reserve.t_ObjectTypeId = data.t_creditType "
        + "\n" + "                                                                      AND reserve.t_objectNumber = data.t_contractId), 0))"
        + "\n" + "                        FROM df127register_tmp register "
        + "\n" + "                       WHERE register.t_trancheKind   = data.t_trancheKind "
        + "\n" + "                         AND register.t_trancheNumber = data.t_trancheNumber"
        + "\n" + "                         AND register.t_roubleRest   != 0"
        + "\n" + "                         AND register.t_type IN (" + getRegisterMask(maskRow, maskColumn) + ")), 0) AS t_value"
        + "\n" + "           FROM (" + getBaseQuery(maskRow, maskColumn, null, false) + ") data"
        + "\n" + "         WHERE t_column BETWEEN " + columnFrom + " AND " + columnTo + ") "
        + "\n" + " GROUP BY t_currency, t_column, t_contractId ";

        summaryInserter(strQuery);

        //пишем данные в протокол
        fillProtocol(maskRow, maskColumn, null, false);
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_LOANS);

        fillUserRegisters();

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127LoansData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(f127Constant.dataSource.IDENTIFIER_LOANS, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_LOANS));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127LoansData(tuneTable, protocolView);
end;

private class (TF127LoansData) TF127LoansData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    private macro getUserRegisters()
        return m_userRegisters;
    end;

    /**
    * Заполнить номера регистров, задаваемые в настроечной таблице
    */
    private macro fillUserRegisters();
        m_userRegisters = NVL(m_tuneTable.getRegistryNumbers("1.6", getBackOffice().getId(), "3"),    "0")
                  + "," + NVL(m_tuneTable.getRegistryNumbers("1.6", getBackOffice().getId(), "4-16"), "0");
    end;

    private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = contract.t_fiId)";
        end;
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df127Contract_tmp");
        sql_execute("TRUNCATE TABLE df127TermDemand_tmp");
        sql_execute("TRUNCATE TABLE df127Interest_tmp");
        sql_execute("TRUNCATE TABLE df127Register_tmp");
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
        var strQuery = "";

        //Договора
        strQuery ="INSERT INTO df127Contract_tmp(t_contractId,                                                                                "
        + "\n" + "                               t_creditType,                                                                                "
        + "\n" + "                               t_trancheKind,                                                                               "
        + "\n" + "                               t_trancheNumber,                                                                             "
        + "\n" + "                               t_currency,                                                                                  "
        + "\n" + "                               t_issueType,                                                                                 "
        + "\n" + "                               t_finishDate,                                                                                "
        + "\n" + "                               t_qualityCategory,                                                                           "
        + "\n" + "                               t_reservePercent,                                                                            "
        + "\n" + "                               t_aim,                                                                                       "
        + "\n" + "                               t_isBank,                                                                                    "
        + "\n" + "                               t_clientType,                                                                                "
        + "\n" + "                               t_timeInterval,                                                                              "
        + "\n" + "                               t_isNoProcentPeriod)                                                                         "
        + "\n" + " SELECT contract.t_id,                                                                                                      "
        + "\n" + "        contract.t_type,                                                                                                    "
        + "\n" + "        tranche.t_kind,                                                                                                     "
        + "\n" + "        tranche.t_number AS t_trancheNumber,                                                                                "
        + "\n" + "        " + getCurrencyString() + " AS t_currency,                                                                          "
        + "\n" + "        contract.t_issueType,                                                                                               "
        + "\n" + "        contract.t_finishDate,                                                                                              "
        + "\n" + "        contract.t_rvpsQualityCategory,                                                                                     "
        + "\n" + "        contract.t_rvpsReservePercent,                                                                                      "
        + "\n" + "        contract.t_aim,                                                                                                     "
        + "\n" + "        (SELECT party.t_isBank FROM dRepParty_vw party WHERE contract.t_contragentId = party.t_id) AS t_isBank,             "
        + "\n" + "        contract.t_clientType AS t_clientType,                                                                              "
        + "\n" + "        0 AS t_timeInterval,                                                                                                "
        + "\n" + "        contract.t_isNoProcentPeriod                                                                                        "
        + "\n" + "   FROM repLnsContract_vw  contract,                                                                                        "
        + "\n" + "        repLnsTranches_vw tranche                                                                                           "
        + "\n" + "  WHERE contract.t_id = tranche.t_contractId                                                                                "
        + "\n" + "    AND " + rcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
        + "\n" + "    AND contract.t_isOpenedAtEndDate = 1                                                                                    "
        + "\n" + "    AND tranche.t_isFictive = 0                                                                                             "
        + "\n" + "    AND CASE WHEN contract.t_type = " + LO_GUARANTEE + "AND NOT EXISTS(SELECT 1                                             "
        + "\n" + "                                                                         FROM repLnsRegChangeHistory_vw regHistory          "
        + "\n" + "                                                                        WHERE regHistory.t_receipt != 0                     "
        + "\n" + "                                                                          AND regHistory.t_regKind = " + TDR_PAYMGUARANTEE
        + "\n" + "                                                                          AND regHistory.t_trancheKind = tranche.t_kind     "
        + "\n" + "                                                                          AND regHistory.t_trancheNumber = tranche.t_number)"
        + "\n" + "               THEN 0                                                                                                       "
        + "\n" + "               ELSE 1                                                                                                       "
        + "\n" + "        END = 1                                                                                                             "
        + "\n" + "    AND " + getCurrencyFilter("(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = contract.t_fiId)")
        + "\n" + "    AND (   contract.t_type = " + LO_CREDIT
        + "\n" + "         OR contract.t_type = " + LO_KARTA
        + "\n" + "         OR contract.t_type = " + LO_GUARANTEE
        + "\n" + "         OR contract.t_type = " + LO_OVERDRAFT
        + "\n" + "         OR contract.t_type = " + LO_DEPOSIT + ")";

        sql_execute(strQuery);

        var commandInitPerc = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_trancheNumber AS a_objectNumber,"
                   + "\n" + "        t_trancheKind   AS a_objectTypeId "
                   + "\n" + "   FROM df127Contract_tmp)          ";

        commandInitPerc.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandInitPerc.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandInitPerc.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandInitPerc.addParam("DataSource", RSDBP_IN, queryTranches);

        commandInitPerc.execute();

        /* Обновление временного интервала */
        strQuery =" UPDATE df127Contract_tmp contract                                                                                 "
        + "\n" + "    SET contract.t_timeInterval = NVL((SELECT (rate.t_rateDate - rep_data.getEndDate())                             "
        + "\n" + "                                         FROM repLnsRateHistory_vw rate                                             "
        + "\n" + "                                        WHERE contract.t_trancheKind   = rate.t_objectId                            "
        + "\n" + "                                          AND contract.t_trancheNumber = rate.t_objectNumber                        "
        + "\n" + "                                          AND rate.t_rateType <> 1                                                  "
        + "\n" + "                                          AND rate.t_rateDate  = (SELECT MIN(r.t_rateDate)                          "
        + "\n" + "                                                                    FROM repLnsRateHistory_vw r                     "
        + "\n" + "                                                                   WHERE contract.t_trancheKind   = r.t_objectId    "
        + "\n" + "                                                                     AND contract.t_trancheNumber = r.t_objectNumber"
        + "\n" + "                                                                     AND r.t_rateType <> 1                          "
        + "\n" + "                                                                     AND r.t_rateDate > rep_data.getEndDate()       "
        + "\n" + "                                                                 )                                                  "
        + "\n" + "                                      ), 0)";

       sql_execute(strQuery);

        /*Срочное требование*/
        strQuery =" INSERT INTO df127TermDemand_tmp(t_trancheKind,                           "
        + "\n" + "                                 t_trancheNumber,                          "
        + "\n" + "                                 t_roubleRest,                             "
        + "\n" + "                                 t_demandDate)                             "
        + "\n" + " SELECT expDemand.t_trancheKind,                                           "
        + "\n" + "        expDemand.t_trancheNumber,                                         "
        + "\n" + "        expDemand.t_roubleRest,                                            "
        + "\n" + "        expDemand.t_repaymentDate                                          "
        + "\n" + "   FROM repLnsExpDemand_vw expDemand                                       "
        + "\n" + "  WHERE expDemand.t_isOpenedAtEndDate = 1                                  "
        + "\n" + "    AND EXISTS(SELECT 1                                                    "
        + "\n" + "                 FROM df127Contract_tmp contract                           "
        + "\n" + "                WHERE contract.t_trancheKind   = expDemand.t_trancheKind   "
        + "\n" + "                  AND contract.t_trancheNumber = expDemand.t_trancheNumber "
        + "\n" + "                  AND contract.t_creditType   != " + LO_DEPOSIT
        + "\n" + "              )";

        sql_execute(strQuery);

/* Вычисление временных интервалов */
        strQuery =" UPDATE df127Contract_tmp contract                                                                    "
        + "\n" + "    SET contract.t_timeInterval = (CASE WHEN  contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "                                            THEN contract.t_finishDate                                 "
        + "\n" + "                                        ELSE                                                           "
        + "\n" + "                                            NVL ((SELECT MAX(td.t_demandDate)                          "
        + "\n" + "                                                    FROM df127TermDemand_tmp td                        "
        + "\n" + "                                                   WHERE td.t_trancheKind = contract.t_trancheKind     "
        + "\n" + "                                                     AND td.t_trancheNumber = contract.t_trancheNumber "
        + "\n" + "                                                ), contract.t_finishDate)                              "
        + "\n" + "                                   END - rep_data.getEndDate()                                         "
        + "\n" + "                                  )                                                                    "
        + "\n" + "  WHERE contract.t_timeInterval = 0                                                                    "
        + "\n" + "    AND (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "              AND contract.t_qualityCategory IN (1, 2, 3))                                             "
        + "\n" + "         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "        )";

        sql_execute(strQuery);

/* Вычисление графы отчета по временному интервалу */
        strQuery =" UPDATE df127Contract_tmp contract                               "
        + "\n" + "    SET contract.t_column = CASE WHEN contract.t_timeInterval > 0 "
        + "\n" + "                                     THEN                         "
        + "\n" + getTermsCondition("contract.t_timeInterval")
        + "\n" + "                                 ELSE " + m_report.getFirstColumn()
        + "\n" + "                            END                                   "
        + "\n" + "  WHERE (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "              AND contract.t_qualityCategory IN (1, 2, 3))        "
        + "\n" + "         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "        )";

        sql_execute(strQuery);

        /*Наращенные проценты*/
        strQuery =" INSERT INTO df127Interest_tmp(t_trancheKind,                            "
        + "\n" + "                               t_trancheNumber,                           "
        + "\n" + "                               t_roubleRest,                              "
        + "\n" + "                               t_column)                                  "
        + "\n" + " SELECT interest.t_trancheKind,                                           "
        + "\n" + "        interest.t_trancheNumber,                                         "
        + "\n" + "        interest.t_roubleSum,                                             "
        + "\n" + getTermsCondition("interest.t_repaymentRemainTerm") + " AS t_column        "
        + "\n" + "   FROM repLnsInterest_vw interest                                        "
        + "\n" + "  WHERE t_isOpenedAtEndDate = 0                                           "
        + "\n" + "    AND EXISTS(SELECT 1                                                   "
        + "\n" + "                 FROM df127Contract_tmp contract                          "
        + "\n" + "                WHERE contract.t_trancheKind = interest.t_trancheKind     "
        + "\n" + "                  AND contract.t_trancheNumber = interest.t_trancheNumber "
        + "\n" + "                  AND (    (    contract.t_creditType != " + LO_DEPOSIT
        + "\n" + "                              AND contract.t_qualityCategory IN (1, 2, 3))"
        + "\n" + "                         OR contract.t_creditType = " + LO_DEPOSIT
        + "\n" + "                        )                                                 "
        + "\n" + "              )";

        sql_execute(strQuery);

        /* Заполнить временную таблицу резервов*/
        var querySource =    "SELECT credit.t_contractId AS a_creditNumber,     "
                    + "\n" + "       credit.t_creditType AS a_type              "
                    + "\n" + "  FROM df127Contract_tmp credit                   "
                    + "\n" + " WHERE credit.t_creditType != " + LO_DEPOSIT
                    + "\n" + "   AND credit.t_qualityCategory IN (1, 2, 3)      "
                    + "\n" + " GROUP BY credit.t_contractId, credit.t_creditType";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);

        command.execute();

        /* Регистры */
        strQuery =" INSERT INTO df127Register_tmp (t_trancheKind,  "
        + "\n" + "                                t_trancheNumber, "
        + "\n" + "                                t_type,          "
        + "\n" + "                                t_roubleRest)    "
        + "\n" + " SELECT register.t_trancheKind,                  "
        + "\n" + "        register.t_trancheNumber,                "
        + "\n" + "        register.t_type,                         "
        + "\n" + "        register.t_roubleRest                    "
        + "\n" + "   FROM repLnsRegister_vw register               "
        + "\n" + "  WHERE EXISTS(SELECT 1                          "
        + "\n" + "                 FROM df127Contract_tmp contract "
        + "\n" + "                WHERE contract.t_trancheKind = register.t_trancheKind     "
        + "\n" + "                  AND contract.t_trancheNumber = register.t_trancheNumber)"
        + "\n" + "    AND register.t_roubleRest <> 0 AND register.t_type IN (" + TDR_MAINREST            +" ,"
                                                                               + TDR_EXPREST             +" ,"
                                                                               + TDR_EXPPERC             +" ,"
                                                                               + TDR_EXPPERC_OV          +" ,"
                                                                               + TDR_PAYMGUARANTEE       +" ,"
                                                                               + TDR_EXPPAYMGUARANTEE    +" ,"
                                                                               + TDR_PAYMGUARANTEEEXPPERC+" ,"
                                                                               + TDR_DEPOHIST            +" ,"
                                                                               + TDR_EXPDEPOHIST         +" ,"
                                                                               + TDR_DEPOPERC            +" ,"
                                                                               + TDR_DEPOEXPPERC         +" ,"
                                                                               + getUserRegisters() + ")     ";
        sql_execute(strQuery);

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(     " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                      "
                + "\n" + "                                       t_backOfficeId,                 "
                + "\n" + "                                       t_creditId,                     "
                + "\n" + "                                       t_fiId,                         "
                + "\n" + "                                       t_cbAccountNumber)              "
                + "\n" + "                                SELECT t_chapter,                      "
                + "\n" + "                                       CASE WHEN EXISTS(SELECT 1 "
                + "\n" + "                                                          FROM df127contract_tmp cr "
                + "\n" + "                                                         WHERE acc.t_contractId = cr.t_contractId  "
                + "\n" + "                                                           AND cr.t_creditType =  " + LO_DEPOSIT + ")"
                + "\n" + "                                                THEN " + f127Constant.backOffice.BACKOFFICE_DEPOSITS
                + "\n" + "                                                ELSE " + getBackOffice().getId()
                + "\n" + "                                       END,"
                + "\n" + "                                       acc.t_contractId,               "
                + "\n" + "                                       acc.t_fiId,                     "
                + "\n" + "                                       acc.t_cbAccount                 "
                + "\n" + "                                  FROM repLnsAccount_vw acc            "
                + "\n" + "                                WHERE  acc.t_cbAccount <> chr(1)       "
                + "\n" + "                                  AND  acc.t_outRest != 0       "
                + "\n" + "                                  AND  EXISTS (SELECT 1 FROM df127contract_tmp c WHERE acc.t_contractId = c.t_contractId)");
    end;


    //вывод данных в протокол
    private macro fillProtocol(maskRow : string, maskColumn : String, filter : Object, isNotBank : bool)

    end;

    /*
    * Вставить данные для строки(кроме строки 1.6)
    */
    macro insertRowData(row : string, filter : Object, maskRow : string, maskColumn : String)
        var strQuery = "";

        strQuery =
                 "SELECT t_contractId,                                    "
        + "\n" + "       " + getSqlString(row) + "       AS t_row,        "
        + "\n" + "       t_column                        AS t_column,     "
        + "\n" + "       SUM(t_value)                    AS t_value,      "
        + "\n" + "       t_currency                      AS t_currency,   "
        + "\n" + "       " + getBackOffice().getId() + " AS t_backOffice, "
        + "\n" + "       t_trancheKind,                                   "
        + "\n" + "       t_trancheNumber,                                 "
        + "\n" + "       t_creditType,                                    "
        + "\n" + "       t_qualityCategory,                               "
        + "\n" + "       t_finishDate,                                    "
        + "\n" + "       t_reservePercent                                 "
        + "\n" + "  FROM (SELECT credit.t_contractId,                     "
        + "\n" + "               credit.t_currency,                       "
        + "\n" + "                        credit.t_reservePercent,        "
        + "\n" + "                        credit.t_finishDate,            "
        + "\n" + "                        credit.t_qualityCategory,       "
        + "\n" + "                        credit.t_creditType,            "
        + "\n" + "                        credit.t_trancheKind,           "
        + "\n" + "                        credit.t_trancheNumber,         "
        + "\n" + "               CASE                                     "
        + "\n" + "                   WHEN " + getIncomeIsDefinedCondition("credit.t_qualityCategory") + " != 0"
        + "\n" + "                       THEN " + m_report.getLastColumn()
        + "\n" + "                   ELSE credit.t_column"
        + "\n" + "               END AS t_column, "
        + "\n" + "               (CASE WHEN 1 = 1  "  //необходимо исправить (условие выполняется при кэшировании register.t_roubleRest <>)
        + "\n" + "                       THEN NVL((SELECT SUM(termDemand.t_roubleRest) "       //Срочные требования
        + "\n" + "                                   FROM df127TermDemand_tmp termDemand "
        + "\n" + "                                  WHERE termDemand.t_trancheKind   = credit.t_trancheKind "
        + "\n" + "                                    AND termDemand.t_trancheNumber = credit.t_trancheNumber), 0) * credit.t_reservePercent         "
        + "\n" + "                       ELSE DECODE (credit.t_column, " + m_report.getFirstColumn() + ",                                            "
        + "\n" + "                                   NVL((SELECT SUM(register.t_roubleRest) * credit.t_reservePercent                                "
        + "\n" + "                                          FROM df127register_tmp register                                                          "
        + "\n" + "                                         WHERE register.t_trancheKind   = credit.t_trancheKind                                     "
        + "\n" + "                                           AND register.t_trancheNumber = credit.t_trancheNumber                                   "
        + "\n" + "                                           AND register.t_roubleRest   != 0                                                        "
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPREST + ",                                            "
                                                                                       + TDR_MAINREST + ",                                           "
                                                                                       + TDR_PAYMGUARANTEE + ",                                      "
                                                                                       + TDR_EXPPAYMGUARANTEE
        + "\n" + "                                                                   )), 0) +                                                        "
        + "\n" + "                                   NVL((SELECT SUM(register.t_roubleRest) - SUM((SELECT tranche.t_CalcRVPExpPerc                "
        + "\n" + "                                                                                   FROM repLnsTranches_vw tranche                  "
        + "\n" + "                                                                                  WHERE tranche.t_kind   = credit.t_trancheKind    "
        + "\n" + "                                                                                    AND tranche.t_number = credit.t_trancheNumber))"
        + "\n" + "                                          FROM df127register_tmp register "
        + "\n" + "                                         WHERE register.t_trancheKind   = credit.t_trancheKind "
        + "\n" + "                                           AND register.t_trancheNumber = credit.t_trancheNumber"
        + "\n" + "                                           AND register.t_roubleRest   != 0"
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPPERC              + ","
                                                                                       + TDR_EXPPERC_OV           + ","
                                                                                       + TDR_PAYMGUARANTEEEXPPERC
        + "\n" + "                                                                   )), 0),"
        + "\n" + "                                        0)"
        + "\n" + "                END) "
        + "\n" + "                  +                      "
        + "\n" + "                CASE "
        + "\n" + "                    WHEN (credit.t_qualityCategory IN (1,2,3))"  //Для всех граф, кроме последней
        + "\n" + "                        THEN NVL((SELECT SUM(interest.t_roubleRest) "       //Наращенные проценты
        + "\n" + "                                    FROM df127Interest_tmp interest "
        + "\n" + "                                   WHERE interest.t_trancheKind   = credit.t_trancheKind "
        + "\n" + "                                     AND interest.t_trancheNumber = credit.t_trancheNumber"
        + "\n" + "                                     AND interest.t_column        = credit.t_column), 0) * t_reservePercent"
        + "\n" + "                    ELSE 0"
        + "\n" + "                END AS t_value"
        + "\n" + "   FROM df127Contract_tmp credit "
        + "\n" + "  WHERE EXISTS(SELECT 1  "
        + "\n" + "                 FROM  drcbBackOfficeAccount_tmp account   "
        + "\n" + "                WHERE credit.t_contractId = account.t_creditId"
        + "\n" + "                  AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                  AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "    AND credit.t_creditType != " + LO_DEPOSIT
        + "\n" + "    AND (" + getIncomeIsDefinedCondition("credit.t_qualityCategory") + ") = 0"
        + "\n" + "                )"
        + "\n" + "           WHERE t_column > 0 "
        + "\n" + " GROUP BY t_currency, t_column, t_contractId, t_contractId, t_currency,t_reservePercent, t_finishDate,"
        + "\n" + "                    t_qualityCategory, t_creditType, t_trancheKind, t_trancheNumber ";

         //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();
        var graphName:string ="";

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString(data.t_row,
                                       data.t_contractId,
                                       data.t_trancheNumber,
                                       data.t_creditType,
                                       data.t_contragent,
                                       data.t_qualityCategory,
                                       data.t_finishDate,
                                       "",
                                       data.t_reservePercent,
                                       "", //вид объекта
                                       sumForReport,
                                       data.t_column
                                       );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);

    end;

    macro insertRowData_1_6(row : String, filter : Object, maskRow : String, maskColumn : String)
        var strQuery = "";

        strQuery =
                 " SELECT credit.t_contractId,                                                                                     "
        + "\n" + "    " + getSqlString(row) + " AS t_row,                                                                          "
        + "\n" + "    " + getBackOffice().getId() + " AS t_backOffice,                                                              "
        + "\n" + "        credit.t_creditType,                                                                                     "
        + "\n" + "        credit.t_trancheKind,                                                                                    "
        + "\n" + "        credit.t_trancheNumber,                                                                                  "
        + "\n" + "        credit.t_currency,                                                                                       "
        + "\n" + "        NVL((SELECT SUM(register.t_roubleRest) - SUM(NVL((SELECT reserve.t_calcRvpKomiss                         "
        + "\n" + "                                                            FROM repLnsReserve_vw reserve                        "
        + "\n" + "                                                           WHERE reserve.t_ObjectTypeId = credit.t_creditType      "
        + "\n" + "                                                             AND reserve.t_objectNumber = credit.t_contractId), 0))"
        + "\n" + "               FROM df127register_tmp register                                                                   "
        + "\n" + "              WHERE register.t_trancheKind = credit.t_trancheKind                                                  "
        + "\n" + "                AND register.t_trancheNumber = credit.t_trancheNumber                                              "
        + "\n" + "                AND register.t_roubleRest != 0                                                                   "
        + "\n" + "                AND register.t_type IN (" + getRegisterMask(maskRow, maskColumn) + ")), 0) AS t_value,            "
        + "\n" + "    " + m_report.getLastColumn() + " AS t_column                                                                 "
        + "\n" + "   FROM df127Contract_tmp credit                                                                                 "
        + "\n" + "  WHERE EXISTS(SELECT 1                                                                                          "
        + "\n" + "                 FROM  drcbBackOfficeAccount_tmp account                                                         "
        + "\n" + "                WHERE credit.t_contractId = account.t_creditId                                                   "
        + "\n" + "                  AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                  AND account.t_backOfficeId = " + getBackOffice().getId() + ")                                  "
        + "\n" + "    AND credit.t_creditType != " + LO_DEPOSIT
        + "\n" + "    AND " + getIncomeIsDefinedCondition("credit.t_qualityCategory") + " = 0";

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();
        var graphName : String = "";

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString( data.t_row,
                                        data.t_contractId,
                                        data.t_trancheNumber,
                                        data.t_creditType,
                                        data.t_contragent,
                                        data.t_qualityCategory,
                                        data.t_finishDate,
                                        data.t_reservePercent,
                                        "",
                                        sumForReport,
                                        data.t_column
                                      );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_LOANS);

        fillUserRegisters();

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127LoansData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127LoansData(tuneTable, protocolView);
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127LoansData_4637(tuneTable, protocolView);
end;

/**
* Форма 127. Источник данных расчета по подсистеме Депозиты
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127DepositsData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
    end;

    private macro getBaseQuery(maskRow : string, maskColumn : String)
        var query =
                 "SELECT deposit.t_contractId,"
        + "\n" + "       (select contract.t_number                                                      "
        + "\n" + "          from repLnsContract_vw contract                                             "
        + "\n" + "         where contract.t_id = deposit.t_contractId)               AS t_number,       "
        + "\n" + "       case                                                                           "
        + "\n" + "           when deposit.t_isBank = 1                                                  "
        + "\n" + "               then 'КО'                                                              "
        + "\n" + "           when deposit.t_clientType = 1                                              "
        + "\n" + "               then 'ЮЛ'                                                              "
        + "\n" + "           when deposit.t_clientType = 2                                              "
        + "\n" + "               then 'ФЛ'                                                              "
        + "\n" + "           else ''                                                                    "
        + "\n" + "       end                                                         AS t_contragent,   "
        + "\n" + "       deposit.t_timeInterval,                                                        "
        + "\n" + "       deposit.t_creditType,                                                          "
        + "\n" + "       deposit.t_trancheKind,                                                         "
        + "\n" + "       deposit.t_trancheNumber,                                                       "
        + "\n" + "       deposit.t_currency,                                                            "
        + "\n" + "       deposit.t_column,                                                              "
        + "\n" + "       (SELECT SUM(interest.t_roubleRest)                                             "
        + "\n" + "          FROM df127Interest_tmp interest                                             "
        + "\n" + "         WHERE interest.t_trancheKind   = deposit.t_trancheKind                       "
        + "\n" + "           AND interest.t_trancheNumber = deposit.t_trancheNumber) AS t_interestSum,  "
        + "\n" + "       (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "          FROM df127register_tmp register                                             "
        + "\n" + "         WHERE register.t_trancheKind   = deposit.t_trancheKind                       "
        + "\n" + "           AND register.t_trancheNumber = deposit.t_trancheNumber                     "
        + "\n" + "           AND register.t_type          = " + TDR_DEPOHIST + ")    AS t_trancheRest,  "
        + "\n" + "       (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "          FROM df127register_tmp register                                             "
        + "\n" + "         WHERE register.t_trancheKind   = deposit.t_trancheKind                       "
        + "\n" + "           AND register.t_trancheNumber = deposit.t_trancheNumber                     "
        + "\n" + "           AND register.t_type          = " + TDR_EXPDEPOHIST + ") AS t_expRest,      "
        + "\n" + "       (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "          FROM df127register_tmp register                                             "
        + "\n" + "         WHERE register.t_trancheKind   = deposit.t_trancheKind                       "
        + "\n" + "           AND register.t_trancheNumber = deposit.t_trancheNumber                     "
        + "\n" + "           AND register.t_type          = " + TDR_DEPOEXPPERC + ") AS t_expPerc       "
        + "\n" + "  FROM df127Contract_tmp deposit                                                      "
        + "\n" + " WHERE EXISTS(SELECT 1                                                                "
        + "\n" + "                FROM  drcbBackOfficeAccount_tmp account                               "
        + "\n" + "               WHERE deposit.t_contractId   = account.t_creditId                      "
        + "\n" + "                 AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                 AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "   AND deposit.t_creditType  = " + LO_DEPOSIT
        + "\n" + "   AND deposit.t_isBank     != 1"
        + "\n" + " ORDER BY t_column";
        return query;
    end;

    /*
    * Вставить данные для строки
    */
    macro insertRowData(row : string, maskRow : string, maskColumn : String)
        var strQuery = "";

        strQuery =
                 "SELECT t_contractId,"
        + "\n" + "      " + getSqlString(row) + "       AS t_row,"
        + "\n" + "       t_column                       AS t_column,"
        + "\n" + "       SUM(t_value)                   AS t_value,"
        + "\n" + "       t_currency                     AS t_currency,"
        + "\n" + "      " + getBackOffice().getId() + " AS t_backOffice"
        + "\n" + "  FROM (SELECT data.t_contractId,"
        + "\n" + "               CASE "
        + "\n" + "                   WHEN data.t_interestSum IS NULL"
        + "\n" + "                       THEN " + m_report.getLastColumn()
        + "\n" + "                   ELSE data.t_column"
        + "\n" + "               END AS t_column, "
        + "\n" + "              (NVL(data.t_trancheRest, 0) + "
        + "\n" + "                   CASE "
        + "\n" + "                       WHEN (data.t_interestSum IS NOT NULL AND data.t_trancheRest != 0)"
        + "\n" + "                           THEN data.t_interestSum"
        + "\n" + "                           ELSE DECODE (data.t_column, " + m_report.getFirstColumn() + ","
        + "\n" + "                                       (SELECT SUM(register.t_roubleRest) "
        + "\n" + "                                          FROM df127register_tmp register "
        + "\n" + "                                         WHERE register.t_trancheKind = data.t_trancheKind "
        + "\n" + "                                           AND register.t_trancheNumber = data.t_trancheNumber"
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPDEPOHIST + ","
                                                                                       + TDR_DEPOPERC    + ","
                                                                                       + TDR_DEPOEXPPERC
        + "\n" + "                                                                   )),"
        + "\n" + "                                        0)"
        + "\n" + "                   END "
        + "\n" + "                   ) AS t_value,"
        + "\n" + "               data.t_currency AS t_currency"
        + "\n" + "           FROM (" + getBaseQuery(maskRow, maskColumn) + ") data) "
        + "\n" + " GROUP BY t_currency, t_column, t_contractId ";

        summaryInserter(strQuery);

        //пишем данные в протокол
        var protocolData = TRsbDataSet(getBaseQuery(maskRow, maskColumn));
        var graphName:string ="";

        m_protocolView.printRow(maskRow);
        while (protocolData.MoveNext())
            if (graphName!=string(protocolData.t_column))
                m_protocolView.printString("Графа " + int(protocolData.t_column));
                graphName = protocolData.t_column;
            end;
            m_protocolView.printString(protocolData.t_number,
                                       protocolData.t_contragent,
                                       protocolData.t_timeInterval,
                                       ternary(protocolData.t_trancheRest != null, protocolData.t_trancheRest, ""),
                                       ternary(protocolData.t_interestSum != null, protocolData.t_interestSum, ""),
                                       ternary(protocolData.t_expRest     != null, protocolData.t_expRest,     ""),
                                       ternary(protocolData.t_expPerc     != null, protocolData.t_expPerc,     ""),
                                         ternary(protocolData.t_trancheRest != null, protocolData.t_trancheRest, 0)
                                       + ternary(protocolData.t_interestSum != null, protocolData.t_interestSum, 0)
                                       + ternary(protocolData.t_expRest     != null, protocolData.t_expRest,     0)
                                       + ternary(protocolData.t_expPerc     != null, protocolData.t_expPerc,     0)
                                      );
        end;
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_DEPOSITS);

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127DepositsData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(f127Constant.dataSource.IDENTIFIER_DEPOSITS, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_DEPOSITS));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127DepositsData(tuneTable, protocolView);
end;

private class (TF127DepositsData) TF127DepositsData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
    end;

    /*
    * Вставить данные для строки
    */
    macro insertRowData(row : string, maskRow : string, maskColumn : String)
        var strQuery = "";

        strQuery =
                 "SELECT t_contractId,                                                                          "
        + "\n" + "      " + getSqlString(row) + "       AS t_row,                                               "
        + "\n" + "       t_column                       AS t_column,                                            "
        + "\n" + "       SUM(t_interestSum)             AS t_interestSum,                                       "
        + "\n" + "       SUM(t_trancheRest)             AS t_trancheRest,                                       "
        + "\n" + "       SUM(t_expRest)                 AS t_expRest,                                           "
        + "\n" + "       SUM(t_expPerc)                 AS t_expPerc,                                           "
        + "\n" + "       SUM(t_value)                   AS t_value,                                             "
        + "\n" + "       t_currency                     AS t_currency,                                          "
        + "\n" + "      " + getBackOffice().getId() + " AS t_backOffice,                                        "
        + "\n" + "       t_rateType                     AS t_rateType                                           "
        + "\n" + "  FROM (SELECT deposit.t_contractId,                                                          "
        + "\n" + "               deposit.t_interestSum,                                                         "
        + "\n" + "               deposit.t_trancheRest,                                                         "
        + "\n" + "               deposit.t_expRest,                                                             "
        + "\n" + "               deposit.t_expPerc,                                                             "
        + "\n" + "               deposit.t_currency AS t_currency,                                              "
        + "\n" + "               (SELECT r.t_rateType                                                      "
        + "\n" + "                  FROM repLnsRateHistory_vw r                                                 "
        + "\n" + "                 WHERE deposit.t_trancheKind   = r.t_objectId                                 "
        + "\n" + "                   AND deposit.t_trancheNumber = r.t_objectNumber                             "
        + "\n" + "                   AND r.t_rateDate > rep_data.getEndDate()) AS t_rateType,                   "
        + "\n" + "               CASE                                                                           "
        + "\n" + "                   WHEN deposit.t_interestSum IS NULL                                         "
        + "\n" + "                        THEN " + m_report.getLastColumn()
        + "\n" + "                   ELSE deposit.t_column                                                         "
        + "\n" + "               END AS t_column,                                                               "
        + "\n" + "              (NVL(deposit.t_trancheRest, 0) +                                                   "
        + "\n" + "                   CASE                                                                       "
        + "\n" + "                       WHEN (deposit.t_interestSum IS NOT NULL AND deposit.t_trancheRest != 0)   "
        + "\n" + "                           THEN deposit.t_interestSum                                            "
        + "\n" + "                           ELSE DECODE (deposit.t_column, " + m_report.getFirstColumn() + ",     "
        + "\n" + "                                       (SELECT SUM(register.t_roubleRest)                     "
        + "\n" + "                                          FROM df127register_tmp register                     "
        + "\n" + "                                         WHERE register.t_trancheKind = deposit.t_trancheKind    "
        + "\n" + "                                           AND register.t_trancheNumber = deposit.t_trancheNumber"
        + "\n" + "                                           AND register.t_type IN (" + TDR_EXPDEPOHIST + ",   "
                                                                                       + TDR_DEPOPERC    + ",   "
                                                                                       + TDR_DEPOEXPPERC
        + "\n" + "                                                                   )),                        "
        + "\n" + "                                        0)                                                    "
        + "\n" + "                   END                                                                        "
        + "\n" + "                   ) AS t_value                                                               "
        + "\n" + "   FROM (SELECT dps.*,"
        + "\n" + "                (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "                   FROM df127register_tmp register                                             "
        + "\n" + "                  WHERE register.t_trancheKind   = dps.t_trancheKind                       "
        + "\n" + "                    AND register.t_trancheNumber = dps.t_trancheNumber                     "
        + "\n" + "                    AND register.t_type          = " + TDR_EXPDEPOHIST + ") AS t_expRest,      "
        + "\n" + "                (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "                   FROM df127register_tmp register                                             "
        + "\n" + "                  WHERE register.t_trancheKind   = dps.t_trancheKind                       "
        + "\n" + "                    AND register.t_trancheNumber = dps.t_trancheNumber                     "
        + "\n" + "                    AND register.t_type          = " + TDR_DEPOEXPPERC + ") AS t_expPerc,       "
        + "\n" + "                 (SELECT SUM(interest.t_roubleRest)                                             "
        + "\n" + "                  FROM df127Interest_tmp interest                                             "
        + "\n" + "                 WHERE interest.t_trancheKind   = dps.t_trancheKind                           "
        + "\n" + "                   AND interest.t_trancheNumber = dps.t_trancheNumber)     AS t_interestSum,  "
        + "\n" + "               (SELECT SUM(register.t_roubleRest)                                             "
        + "\n" + "                  FROM df127register_tmp register                                             "
        + "\n" + "                 WHERE register.t_trancheKind   = dps.t_trancheKind                           "
        + "\n" + "                   AND register.t_trancheNumber = dps.t_trancheNumber                         "
        + "\n" + "                   AND register.t_type          = " + TDR_DEPOHIST + ")    AS t_trancheRest   "
        + "\n" + "           FROM df127Contract_tmp dps                                                         "
        + "\n" + "           WHERE EXISTS(SELECT 1                                                              "
        + "\n" + "                          FROM  drcbBackOfficeAccount_tmp account                             "
        + "\n" + "                         WHERE dps.t_contractId = account.t_creditId                       "
        + "\n" + "                           AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                           AND account.t_backOfficeId = " + getBackOffice().getId() + ")      "
        + "\n" + "            AND dps.t_creditType = " + LO_DEPOSIT
        + "\n" + "            AND (" + getIncomeIsDefinedCondition("dps.t_qualityCategory") + ") = 0) deposit) "
        + "\n" + "           GROUP BY t_currency, t_column, t_contractId, t_rateType";

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();
        var graphName:string ="";

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            if (graphName!=string(data.t_column))
                m_protocolView.printString("Графа " + int(data.t_column));
                graphName = data.t_column;
            end;

            m_protocolView.printString(data.t_contractId,
                                       data.t_rateType,
                                       "", //Процентная ставка
                                       ternary(data.t_trancheRest != null, data.t_trancheRest, ""),
                                       ternary(data.t_expRest     != null, data.t_expRest,     ""),
                                       ternary(data.t_expPerc     != null, data.t_expPerc,     ""),
                                       sumForReport,
                                       data.t_column
                                      );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);

     end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_DEPOSITS);

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127DepositsData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DepositsData(tuneTable, protocolView);
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127DepositsData_4637(tuneTable, protocolView);
end;

/**
* Форма 127. Источник данных расчета по МБК
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127MbkData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
    end;

    private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "NVL((SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = deals.t_fiId), '000')";
        end;
    end;

    private macro getInterval()
        var getTerms = getTermsIntervals();

        var getRateDate = "SELECT deals.t_id                                     AS t_dealId,"
        + "\n" + "                DECODE(rateHistory.t_rateType, 1, 'простая',"
        + "\n" + "                                               2, 'плавающая') AS t_rateType,"
        + "\n" + "                CASE"
        + "\n" + "                    WHEN rateHistory.t_rateType = 2"
        + "\n" + "                         THEN rateHistory.t_rateDate - rep_data.getEndDate ()"
        + "\n" + "                    WHEN rateHistory.t_rateType = 1"
        + "\n" + "                         THEN deals.t_termRest"
        + "\n" + "                END AS t_timeInterval"
        + "\n" + "           FROM repMmDeals_vw deals, repMmDealRateHistory_vw rateHistory"
        + "\n" + "           WHERE     deals.t_id = rateHistory.t_dealId"
        + "\n" + "                 AND rateHistory.t_percentKind = 7"
        + "\n" + "                 AND rateHistory.t_rateType IN (1, 2)"
        + "\n" + "                 AND rateHistory.t_rateDate = (SELECT MIN (r.t_rateDate)"
        + "\n" + "                                                 FROM repMmDealRateHistory_vw r"
        + "\n" + "                                                 WHERE     deals.t_id = r.t_dealId"
        + "\n" + "                                                       AND r.t_percentKind = 7"
        + "\n" + "                                                       AND r.t_rateType IN (1, 2)"
        + "\n" + "                                                       AND r.t_rateDate > rep_data.getEndDate ())";

        return "  SELECT deals.*,"
        + "\n" + "      caseInterval.t_column"
        + "\n" + "  FROM (" + getTerms + ") caseInterval,"
        + "\n" + "       (" + getRateDate + ") deals"
        + "\n" + " WHERE deals.t_timeInterval BETWEEN caseInterval.t_startDay"
        + "\n" + "                                AND caseInterval.t_endDay";
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
    end;

    /*
    * Вставить данные для строки
    */
    macro insertRowData(row : String, columnFrom : String, columnTo : String, filter : Object, maskRow : String, maskColumn : String, mod : String)
        var strQuery = "";

        strQuery =
                 "SELECT t_contractId,                                                                   "
        + "\n" + "      " + getSqlString(row) + "       AS t_row,                                        "
        + "\n" + "      " + getSqlString(row) + "       AS t_row,                                        "
        + "\n" + "       t_column                       AS t_column,                                     "
        + "\n" + "       SUM(t_value)                   AS t_value,                                      "
        + "\n" + "       t_currency                     AS t_currency,                                   "
        + "\n" + "      " + getBackOffice().getId() + " AS t_backOffice,                                 "
        + "\n" + "      data.t_plannedFinishDate,                                                        "
        + "\n" + "      data.t_qualityCategory,                                                          "
        + "\n" + "      data.t_kind,                                                                     "
        + "\n" + "      data.t_mainRestRoubleAmount,                                                     "
        + "\n" + "      data.t_reservePercent,                                                           "
        + "\n" + "      data.t_delaydMainRestRoubleAmount,                                               "
        + "\n" + "      data.t_accruedInterestRoubleAmount,                                              "
        + "\n" + "      data.t_delaydPercentRoubleAmount,                                                "
        + "\n" + "      data.t_rateType                                                                  "
        + "\n" + "  FROM (SELECT deals.t_number                                        AS t_contractId,  "
        + "\n" + "               deals.t_plannedFinishDate,                                              "
        + "\n" + "               reserve.t_qualityCategory,                                              "
        + "\n" + "               deals.t_kind,                                                           "
        + "\n" + "               deals.t_mainRestRoubleAmount,                                           "
        + "\n" + "               reserve.t_reservePercent,                                               "
        + "\n" + "               deals.t_delaydMainRestRoubleAmount,                                     "
        + "\n" + "               deals.t_accruedInterestRoubleAmount,                                    "
        + "\n" + "               deals.t_delaydPercentRoubleAmount,                                      "
        + "\n" + "               intervals.t_rateType,                                                   "
        + "\n" + "               CASE                                                                    "
        + "\n" + "                   WHEN (" + getIncomeIsDefinedCondition("reserve.t_qualityCategory")+ ") = 1"
        + "\n" + "                       THEN intervals.t_column                                         "
        + "\n" + "                   ELSE " + m_report.getLastColumn()
        + "\n" + "               END AS t_column,                                                        "
        + "\n" + "               CASE"
        + "\n" + "                    WHEN " + trim(columnFrom) + " LIKE " + getSqlString(String(m_report.getLastColumn()))
        + "\n" + "                        THEN CASE                                                       "
        + "\n" + "                                 WHEN (" + getIncomeIsDefinedCondition("reserve.t_qualityCategory") + ") = 0                           "
        + "\n" + "                                     THEN NVL(deals.t_mainRestRoubleAmount, 0) - NVL(reserve.t_calcRvps, 0)                            "
        + "\n" + "                                          +                                                                                            "
        + "\n" + "                                          NVL(deals.t_delaydMainRestRoubleAmount, 0) - NVL((   deals.t_delaydMainRestRoubleAmount      "
        + "\n" + "                                                                                             * reserve.t_reservePercent / 100), 0)     "
        + "\n" + "                                          +                                                                                            "
        + "\n" + "                                          NVL(deals.t_accruedInterestRoubleAmount, 0) - NVL((   deals.t_accruedInterestRoubleAmount    "
        + "\n" + "                                                                                              * reserve.t_reservePercent / 100),0)     "
        + "\n" + "                                           +                                                                                           "
        + "\n" + "                                          NVL(deals.t_delaydPercentRoubleAmount, 0) -  NVL((   deals.t_delaydPercentRoubleAmount       "
        + "\n" + "                                                                                             * reserve.t_reservePercent / 100), 0)     "
        + "\n" + "             END                                                                                                                       "
        + "\n" + "             +                                                                                                                         "
        + "\n" + "             CASE                                                                                                                      "
        + "\n" + "                 WHEN " + getIncomeIsDefinedCondition("reserve.t_qualityCategory") + " = 1"
        + "\n" + "                     THEN"
        + "\n" + "                         NVL(deals.t_delaydMainRestRoubleAmount, 0) - NVL((   t_delaydMainRestRoubleAmount                             "
        + "\n" + "                                                                            * reserve.t_reservePercent / 100), 0)                      "
        + "\n" + "                      + "
        + "\n" + "                         NVL(deals.t_delaydPercentRoubleAmount, 0 ) -  NVL((   deals.t_delaydPercentRoubleAmount                       "
        + "\n" + "                                                                             * reserve.t_reservePercent / 100), 0)"
        + "\n" + "             END"
        + "\n" + "    ELSE"
        + "\n" + "        NVL(deals.t_mainRestRoubleAmount, 0) - NVL((   t_mainRestRoubleAmount                                                           "
        + "\n" + "                                                     * reserve.t_reservePercent / 100), 0)                                             "
        + "\n" + "        + "
        + "\n" + "        NVL(deals.t_accruedInterestRoubleAmount, 0) - NVL((   deals.t_accruedInterestRoubleAmount"
        + "\n" + "                                                            * reserve.t_reservePercent / 100) ,0) "
        + "\n" + "    END AS t_value,                                                                    "
        + "\n" + "        " + getCurrencyString() +   " AS t_currency                                    "
        + "\n" + "          FROM repMmDeals_vw deals,                                                    "
        + "\n" + "               repMmDealReserve_vw reserve,                                            "
        + "\n" + "               (" + getInterval() + ") intervals                                       "
        + "\n" + "         WHERE deals.t_id = reserve.t_dealId                                           "
        + "\n" + "           AND deals.t_id = intervals.t_dealId                                         "
        + "\n" + "           AND deals.t_kind IN (" + getSqlString(mod) + ")                             "
        + "\n" + "           AND " + getCurrencyFilter("deals.t_fiId")
        + "\n" +             filter.getFilter()
        + "\n" + "              ) data                                                                   "
        + "\n" + " WHERE data.t_column BETWEEN " + columnFrom + " AND " + columnTo
        + "\n" + " GROUP BY t_currency, t_column, t_contractId, t_plannedFinishDate, t_qualityCategory, t_kind,t_mainRestRoubleAmount,"
        + "\n" + "          t_reservePercent, t_delaydMainRestRoubleAmount, t_accruedInterestRoubleAmount, t_delaydPercentRoubleAmount, t_rateType";

        //пишем данные в протокол
        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = ternary(columnFrom != m_report.getLastColumn(), data.t_column, m_report.getLastColumn());
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString(data.t_number,
                                       data.t_kind,
                                       data.t_qualityCategory,
                                       data.t_plannedFinishDate,
                                       data.t_rateType,
                                       ternary(data.t_reservePercent              != null, data.t_reservePercent, ""),
                                       ternary(data.t_mainRestRoubleAmount        != null, data.t_mainRestRoubleAmount, ""),
                                       ternary(data.t_delaydMainRestRoubleAmount  != null, data.t_delaydMainRestRoubleAmount, ""),
                                       ternary(data.t_accruedInterestRoubleAmount != null, data.t_accruedInterestRoubleAmount,     ""),
                                       ternary(data.t_delaydPercentRoubleAmount   != null, data.t_delaydPercentRoubleAmount,     ""),
                                       data.t_timeInterval,
                                       sumForReport,
                                       data.t_column
                                      );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);

     end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_MBK);

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127MbkData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(f127Constant.dataSource.IDENTIFIER_MBK, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_MBK));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127MbkData(tuneTable, protocolView);
end;

/**
* Форма 127. Источник данных расчета по данным Retail
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127RtlData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df127RtlDeposit_tmp");
    end;

     private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "NVL((SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = dep.t_finInstrumentId), '000')";
        end;
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
        var strQuery = "";

        //Договора
        strQuery = "INSERT INTO df127RtlDeposit_tmp(t_contractId,       "
        + "\n" + "                                 t_cbAccount,         "
        + "\n" + "                                 t_plannedCloseDate,  "
        + "\n" + "                                 t_currency,          "
        + "\n" + "                                 t_isPhisical,        "
        + "\n" + "                                 t_isBank,            "
        + "\n" + "                                 t_roubleRest,        "
        + "\n" + "                                 t_roubleInterestSum, "
        + "\n" + "                                 t_columnForRest,     "
        + "\n" + "                                 t_columnForInterest) "
        + "\n" + " SELECT dep.t_contractId,                                                                                          "
        + "\n" + "        dep.t_cbaccount,                                                                                           "
        + "\n" + "        dep.t_plannedCloseDate,                                                                                    "
        + "\n" + "        " + getCurrencyString() + " AS t_currency,"
        + "\n" + "        (SELECT party.t_isPhisical FROM dRepParty_vw party WHERE dep.t_contragentId = party.t_id) AS t_isPhisical, "
        + "\n" + "        (SELECT party.t_isBank FROM dRepParty_vw party WHERE dep.t_contragentId = party.t_id) AS t_isBank,         "
        + "\n" + "        dep.t_roubleOutRest,                                                                                       "
        + "\n" + "        dep.t_roubleInterestSum,                                                                                   "
        + "\n" + "    " + getTermsCondition("dep.t_remainterm") + " AS t_columnForRest,                                              "
        + "\n" + "    " + getTermsCondition("dep.t_interestrepaymentremainterm") + " AS t_columnForInterest                          "
        + "\n" + "   FROM repRtlDeposit_vw dep                                                                                       "
        + "\n" + "  WHERE " + RcbBranchFieldFilter().GetAsSqlString("dep.t_branchId")
        + "\n" + "    AND dep.t_isopenedatenddate = 1                                                                                "
        + "\n" + "    AND " + getCurrencyFilter("(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = dep.t_finInstrumentId)")
        + "\n" + "    AND dep.t_account IS NOT NULL";

        sql_execute(strQuery);

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(     " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                      "
                + "\n" + "                                       t_backOfficeId,                 "
                + "\n" + "                                       t_creditId,                     "
                + "\n" + "                                       t_fiId,                         "
                + "\n" + "                                       t_cbAccountNumber)              "
                + "\n" + "                                SELECT 1,                              "
                + "\n" + "                                       " + getBackOffice().getId() + ","
                + "\n" + "                                       acc.t_contractId,               "
                + "\n" + "                                       0,                              "
                + "\n" + "                                       acc.t_cbAccount                 "
                + "\n" + "                                  FROM repRtlDepAccount_vw acc         "
                + "\n" + "                                WHERE  acc.t_cbAccount <> chr(1)       "
                + "\n" + "                                  AND  EXISTS (SELECT 1 FROM df127RtlDeposit_tmp c WHERE acc.t_contractId = c.t_contractId)");
    end;

    private macro getBaseQuery(row : string, dataFilter : Object, maskRow : String, maskColumn : String)
        var query =
                 "SELECT deposit.t_contractId,"
        + "\n" + "       (select contract.t_number                                         "
        + "\n" + "          from repRtlDeposit_vw contract                                 "
        + "\n" + "         where contract.t_contractId = deposit.t_contractId              "
        + "\n" + "           and contract.t_branchId   = " + RcbApplication().currentReport.context.departmentCode + ") AS t_number,"
        + "\n" + "       case                                                              "
        + "\n" + "           when deposit.t_isBank = 1                                     "
        + "\n" + "               then 'КО'                                                 "
        + "\n" + "           when deposit.t_isPhisical = 0                                 "
        + "\n" + "               then 'ЮЛ'                                                 "
        + "\n" + "           when deposit.t_isPhisical = 1                                 "
        + "\n" + "               then 'ФЛ'                                                 "
        + "\n" + "           else ''                                                       "
        + "\n" + "       end                                           AS t_client,        "
        + "\n" + "       deposit.t_currency,                                               "
        + "\n" + "       deposit.t_plannedCloseDate,                                       "
        + "\n" + "       deposit.t_roubleRest,                                             "
        + "\n" + "       deposit.t_roubleInterestSum,                                      "
        + "\n" + "       deposit.t_columnForInterest,                                      "
        + "\n" + "       deposit.t_columnForRest                                           "
        + "\n" + "  FROM df127RtlDeposit_tmp deposit                                       "
        + "\n" + " WHERE EXISTS(SELECT 1                                                   "
        + "\n" + "                FROM drcbBackOfficeAccount_tmp account                   "
        + "\n" + "               WHERE deposit.t_contractId = account.t_creditId           "
        + "\n" + "                 AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                 AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "   AND " + dataFilter.getFilter();

        return query;
    end;

    /*
    * Вставить данные для строки
    */
    macro insertRowData(row : string, dataFilter : Object, maskRow : String, maskColumn : String)
        var strQuery = "";

        strQuery = "WITH deposits AS (" + getBaseQuery(row, dataFilter, maskRow, maskColumn) + ")"
        + "\n" + "SELECT t_contractId,"
        + "\n" + "     " + getSqlString(row) + "       AS t_row,"
        + "\n" + "       t_column                      AS t_column,"
        + "\n" + "       SUM(t_value)                  AS t_value,"
        + "\n" + "       t_currency                    AS t_currency,"
        + "\n" + "     " + getBackOffice().getId() + " AS t_backOffice"
        + "\n" + "  FROM (SELECT t_contractId,"    //сумма остатков для граф 3-16
        + "\n" + "               CASE "
        + "\n" + "                   WHEN (t_plannedCloseDate = " + getNullDate() + ") "
        + "\n" + "                       THEN " + m_report.getLastColumn()
        + "\n" + "                       ELSE t_columnForRest "
        + "\n" + "               END          AS t_column,"
        + "\n" + "               t_roubleRest AS t_value,"
        + "\n" + "               t_currency"
        + "\n" + "          FROM deposits    "
        + "\n" + " UNION ALL      "
        + "\n" + "           SELECT t_contractId,"    //сумма процентов для граф 3-15
        + "\n" + "                  t_columnForInterest AS t_column,"
        + "\n" + "                  t_roubleInterestSum AS t_value,"
        + "\n" + "                  t_currency"
        + "\n" + "          FROM deposits    "
        + "\n" + "         WHERE t_plannedCloseDate != " + getNullDate()
        + "\n" + "      ) data"
        + "\n" + " GROUP BY t_currency, t_column, t_contractId ";

        summaryInserter(strQuery);

        //пишем данные в протокол
        var protocolData = TRsbDataSet(getBaseQuery(row, dataFilter, maskRow, maskColumn));
        var graphName:string ="";

        m_protocolView.printRow(maskRow);
        while (protocolData.MoveNext())
            if (graphName!=string(protocolData.t_columnForRest))
                m_protocolView.printString("Графа " + int(protocolData.t_columnForRest));
                graphName = protocolData.t_columnForRest;
            end;
            m_protocolView.printString(protocolData.t_number,
                                       protocolData.t_client,
                                       protocolData.t_plannedCloseDate,
                                       protocolData.t_roubleRest,
                                       protocolData.t_roubleInterestSum,
                                         ternary(protocolData.t_roubleRest        != null, protocolData.t_roubleRest,        $0.0)
                                       + ternary(protocolData.t_roubleInterestSum != null, protocolData.t_roubleInterestSum, $0.0)
                                      );
        end;
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_RETAIL);

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127RtlData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(f127Constant.dataSource.IDENTIFIER_RETAIL, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_RETAIL));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127RtlData(tuneTable, protocolView);
end;

private class (TF127RtlData) TF127RtlData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df127RtlDeposit_tmp");
    end;

     private macro getCurrencyString()
        if (TF127Global().getReportMode() == f127Constant.modeReport.MODE_BYALLCURRENCIES)
            return "'000'";
        else
            return "NVL((SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = dep.t_finInstrumentId), '000')";
        end;
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
        var strQuery = "";

        //Договора
        strQuery = "INSERT INTO df127RtlDeposit_tmp(t_contractId,       "
        + "\n" + "                                 t_number,            "
        + "\n" + "                                 t_cbAccount,         "
        + "\n" + "                                 t_plannedCloseDate,  "
        + "\n" + "                                 t_currency,          "
        + "\n" + "                                 t_isPhisical,        "
        + "\n" + "                                 t_isBank,            "
        + "\n" + "                                 t_isDemand,          "
        + "\n" + "                                 t_isPutPerc,         "
        + "\n" + "                                 t_roubleRest,        "
        + "\n" + "                                 t_roubleInterestSum, "
        + "\n" + "                                 t_columnForRest,     "
        + "\n" + "                                 t_columnForInterest) "
        + "\n" + " SELECT dep.t_contractId,                                                                                          "
        + "\n" + "        dep.t_number,                                                                                              "
        + "\n" + "        dep.t_cbaccount,                                                                                           "
        + "\n" + "        dep.t_plannedCloseDate,                                                                                    "
        + "\n" + "        " + getCurrencyString() + " AS t_currency,                                                                 "
        + "\n" + "        (SELECT party.t_isPhisical FROM dRepParty_vw party WHERE dep.t_contragentId = party.t_id) AS t_isPhisical, "
        + "\n" + "        (SELECT party.t_isBank FROM dRepParty_vw party WHERE dep.t_contragentId = party.t_id) AS t_isBank,         "
        + "\n" + "        dep.t_isDemand,                                                                                            "
        + "\n" + "        dep.t_putPerc AS t_isPutPerc,                                                                              "
        + "\n" + "        dep.t_roubleOutRest,                                                                                       "
        + "\n" + "        dep.t_roubleInterestSum,                                                                                   "
        + "\n" + "    " + getTermsCondition("dep.t_remainterm") + " AS t_columnForRest,                                              "
        + "\n" + "    " + getTermsCondition("dep.t_interestrepaymentremainterm") + " AS t_columnForInterest                          "
        + "\n" + "   FROM repRtlDeposit_vw dep                                                                                       "
        + "\n" + "  WHERE " + RcbBranchFieldFilter().GetAsSqlString("dep.t_branchId")
        + "\n" + "    AND dep.t_isopenedatenddate = 1                                                                                "
        + "\n" + "    AND " + getCurrencyFilter("(SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = dep.t_finInstrumentId)")
        + "\n" + "    AND dep.t_account IS NOT NULL";

        sql_execute(strQuery);

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(     " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                      "
                + "\n" + "                                       t_backOfficeId,                 "
                + "\n" + "                                       t_creditId,                     "
                + "\n" + "                                       t_fiId,                         "
                + "\n" + "                                       t_cbAccountNumber)              "
                + "\n" + "                                SELECT 1,                              "
                + "\n" + "                                       " + getBackOffice().getId() + ","
                + "\n" + "                                       acc.t_contractId,               "
                + "\n" + "                                       0,                              "
                + "\n" + "                                       acc.t_cbAccount                 "
                + "\n" + "                                  FROM repRtlDepAccount_vw acc         "
                + "\n" + "                                 WHERE acc.t_cbAccount <> chr(1)       "
                + "\n" + "                                   AND EXISTS (SELECT 1 FROM df127RtlDeposit_tmp c WHERE acc.t_contractId = c.t_contractId)");
    end;

    /*
    * Вставить данные для строки
    */
    macro insertRowData(row : string, dataFilter : Object, maskRow : String, maskColumn : String)
        var strQuery = "";

        strQuery = "SELECT data.t_contractId,"
        + "\n" + "       " + getSqlString(row) + "       AS t_row,              "
        + "\n" + "         data.t_column                 AS t_column,           "
        + "\n" + "         SUM(data.t_roubleRest)        AS t_roubleRest,       "
        + "\n" + "         SUM(data.t_roubleInterestSum) AS t_roubleInterestSum,"
        + "\n" + "         data.t_currency               AS t_currency,         "
        + "\n" + "       " + getBackOffice().getId() + " AS t_backOffice,       "
        + "\n" + "         data.t_number AS t_number,                           "
        + "\n" + "         data.t_client,                                        "
        + "\n" + "         data.t_isDemand,                                   "
        + "\n" + "         data.t_plannedCloseDate                           "
        + "\n" + "    FROM (SELECT t_contractId,"    //сумма остатков для граф 3-16
        + "\n" + "                 CASE                                                                   "
        + "\n" + "                     WHEN (t_plannedCloseDate = " + getNullDate() + ")                  "
        + "\n" + "                         THEN " + m_report.getLastColumn()
        + "\n" + "                         ELSE t_columnForRest                                           "
        + "\n" + "                 END          AS t_column,                                              "
        + "\n" + "                 t_roubleRest,                                                          "
        + "\n" + "                 0 AS t_roubleInterestSum,                                              "
        + "\n" + "                 t_currency,                                                            "
        + "\n" + "                 t_number,                                                              "
        + "\n" + "                 CASE                                                                   "
        + "\n" + "                      WHEN t_isBank = 1                                                 "
        + "\n" + "                          THEN 'КО'                                                     "
        + "\n" + "                      WHEN t_isPhisical = 0                                             "
        + "\n" + "                          THEN 'ЮЛ'                                                     "
        + "\n" + "                      WHEN t_isPhisical = 1                                             "
        + "\n" + "                          THEN 'ФЛ'                                                     "
        + "\n" + "                 ELSE ''                                                                "
        + "\n" + "                 END                           AS t_client ,                            "
        + "\n" + "                 deposits.t_isDemand,                                                   "
        + "\n" + "                 deposits.t_plannedCloseDate                                            "
        + "\n" + "            FROM df127RtlDeposit_tmp deposits                                           "
        + "\n" + "           WHERE EXISTS(SELECT 1                                                        "
        + "\n" + "                          FROM drcbBackOfficeAccount_tmp account                        "
        + "\n" + "                         WHERE deposits.t_contractId = account.t_creditId               "
        + "\n" + "                           AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                           AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "   UNION ALL                                                                            "
        + "\n" + "             SELECT t_contractId,                                                       "    //сумма процентов для граф 3-15
        + "\n" + "                    t_columnForInterest AS t_column,                                    "
        + "\n" + "                    0 AS t_roubleRest,                                                  "
        + "\n" + "                    t_roubleInterestSum AS t_roubleInterestSum,                         "
        + "\n" + "                    t_currency,                                                         "
        + "\n" + "                    t_number,                                                           "
        + "\n" + "                    CASE                                                  "
        + "\n" + "                        WHEN t_isBank = 1                           "
        + "\n" + "                            THEN 'КО'                                    "
        + "\n" + "                        WHEN t_isPhisical = 0                       "
        + "\n" + "                            THEN 'ЮЛ'                                    "
        + "\n" + "                        WHEN t_isPhisical = 1                       "
        + "\n" + "                            THEN 'ФЛ'                                    "
        + "\n" + "                   ELSE ''                                               "
        + "\n" + "                   END                           AS t_client,            "
        + "\n" + "                   deposits.t_isDemand,                                                 "
        + "\n" + "                   deposits.t_plannedCloseDate                                          "
        + "\n" + "            FROM df127RtlDeposit_tmp deposits                                           "
        + "\n" + "           WHERE t_plannedCloseDate != " + getNullDate()
        + "\n" + "             AND EXISTS(SELECT 1                                                        "
        + "\n" + "                          FROM drcbBackOfficeAccount_tmp account                        "
        + "\n" + "                         WHERE deposits.t_contractId = account.t_creditId               "
        + "\n" + "                           AND " + convertMaskToSqlFormat(getAccountMask(maskRow, maskColumn), "account.t_cbAccountNumber")
        + "\n" + "                           AND account.t_backOfficeId = " + getBackOffice().getId() + ")"
        + "\n" + "        ) data"
        + "\n" + "    GROUP BY t_currency, t_column, t_contractId, t_roubleRest, t_roubleInterestSum,t_currency, t_number,t_client, t_isDemand, t_plannedCloseDate ";

        //пишем данные в протокол

        var data = TRsbDataSet(strQuery);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_roubleRest", V_MONEY);
            data.setFieldType("t_roubleInterestSum", V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        m_protocolView.printRow(maskRow);

        while (data.MoveNext())
            var sumForReport : Money =   ternary(data.t_roubleRest != null, data.t_roubleRest, $0.0)
                               + ternary(data.t_roubleInterestSum != null, data.t_roubleInterestSum, $0.0);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

            m_protocolView.printString(data.t_number,
                                       data.t_client,
                                       ternary(data.t_isDemand == 1, "X", ""),
                                       data.t_plannedCloseDate,
                                       sumForReport,
                                       data.t_column
                                      );
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        m_dataFilter = objectFactoryInstance.createDataSourceFilters().getFilter(f127Constant.dataSource.IDENTIFIER_RETAIL);

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127RtlData_4637(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127RtlData(tuneTable, protocolView);
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127RtlData_4637(tuneTable, protocolView);
end;

/**
* Форма 127. Источник данных расчета по данным Securitis
*
* @param tuneTable RcbTuneTable Настроечная таблица
*/
private class (TF127DataSourceBase_4637) TF127SecuritisData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
    var m_securitisDataSources = RcbArray();
    var m_currencyArray = RcbArray();

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
    end;

    private macro getFiCodeFromIsoNumber(isoNumber : String)
        var dataSet =  RcbDataSet("SELECT fi.t_id FROM dRepFinInstrument_vw fi WHERE fi.t_isoNumber = " + getSqlString(isoNumber));

        if (dataSet.moveNext())
            return dataSet.id;
        else
            return NULL;
        end;
    end;

    private macro fillCurrencyArray()
        var currencies = TF127Parameters().getCodeCurrencyArray();
        var i = 0;

        for (i, 0, currencies.size - 1)
            m_currencyArray.push_back(ternary(currencies[i] == "000", -1, getFiCodeFromIsoNumber(currencies[i])));
        end;
    end;

    /**
    * Кэширование данных.
    */
    macro casheData()
        var departmentListDataSource;
        var reportDate = RcbApplication().currentReport.context.period.endDate;
        var c;
        RcbDepartmentList().saveToTable();

        departmentListDataSource = TRsbDataset("SELECT * FROM dbldept_tmp");

        while (departmentListDataSource.next())
            m_currencyArray.moveFirst();

            while (m_currencyArray.moveNext())
                m_securitisDataSources.push_back(C_f127(reportDate, m_currencyArray.getCurrentItem(), departmentListDataSource.code));
            end;
        end;
    end;

   /**
    * Вставить данные для строки
    */
    macro insertRowData(row : string, rowCode : Integer, columnMask : string)
        var strQuery = "";
        var i = 0;
        var firstColumn =  m_report.getFirstColumn();
        var lastColumn  =  m_report.getLastColumn();

        if   (columnMask == "16")
            firstColumn = m_report.getLastColumn();
        elif (columnMask == "3-15")
            lastColumn =  m_report.getLastColumn() - 1;
        end;

        m_securitisDataSources.moveFirst();
        m_protocolView.printRow(row);

        while(m_securitisDataSources.moveNext())
            for (i, firstColumn,  lastColumn)
                strQuery = "SELECT 0                           AS t_contractId, "
                 + "\n" +          getSqlString(row) + "       AS t_row, "
                 + "\n" +          i + "                       AS t_column, "
                 + "\n" +          m_securitisDataSources.getCurrentItem().A_Sum_All[rowCode].(i - m_report.getFirstColumn()) + " AS t_value, "
                 + "\n" +          getSqlString(m_securitisDataSources.getCurrentItem().КодВалюты()) + " AS t_currency,"
                 + "\n" +          getBackOffice().getId() + " AS t_boffice"
                 + "\n" +"    FROM DUAL";

                //пишем данные в протокол
                var data = TRsbDataSet(strQuery);
                    data.setFieldType("t_column", V_INTEGER);
                    data.setFieldType("t_value",  V_MONEY);

                var contractsIds = TArray();
                var rows         = TArray();
                var columns      = TArray();
                var values       = TArray();
                var currencies   = TArray();
                var boffices     = TArray();

                while (data.MoveNext())
                    var sumForReport : Money = nvl(data.t_value);

                    contractsIds[contractsIds.size] = data.t_contractId;
                    rows        [rows.size        ] = data.t_row;
                    columns     [columns.size     ] = data.t_column;
                    values      [values.size      ] = sumForReport;
                    currencies  [currencies.size  ] = data.t_currency;
                    boffices    [boffices.size    ] = data.t_boffice;

                    m_protocolView.printString( data.t_contractId,
                                                data.t_row,
                                                data.t_column,
                                                sumForReport,
                                                data.t_currency
                                              );
                end;

                summaryInserter(contractsIds, rows, columns, values, currencies, boffices);
            end;
        end;
    end;

    /**
    * Инициализация источника данных.
    */
    macro initialize()
        fillCurrencyArray();

        casheData();
    end;

    /**
    * Конструктор
    *
    * @param tuneTable RcbTuneTable Настроечная таблица
    */
    private macro constructorTF127SecuritisData(tuneTable: RcbTuneTable, protocolView : RcbDataProtocolView)
        initTF127DataSourceBase(f127Constant.dataSource.IDENTIFIER_SECURITIES, protocolView);

        setBackOffice(TBackOffice(f127Constant.backOffice.BACKOFFICE_SECURITIES));
        setTuneTable(tuneTable);

        initialize();
    end;

    private macro destructor()
        m_protocolView.save();
    end;

    constructorTF127SecuritisData(tuneTable, protocolView);
end;

/**
* Форма 127. Источник сводных данных
*/

private class (TF127DataSourceBase_4637) TF127SummaryData()
    /**
    * Инициализация источника данных.
    */
    macro clear()
        sql_execute("TRUNCATE TABLE df127_tmp");
    end;

    // получить итоговые данные
    macro getSummaryData()
        var commandText = "SELECT t_row,                        "
                 + "\n" + "       t_column,                     "
                 + "\n" + "       t_currency,                   "
                 + "\n" + "       SUM(t_value) AS t_value       "
                 + "\n" + "  FROM df127_tmp                     "
                 + "\n" + " GROUP BY t_currency,                "
                 + "\n" + "          t_row,                     "
                 + "\n" + "          t_column                   "
                 + "\n" + " ORDER BY t_currency, t_row, t_column";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        return data;
    end;

    macro insertTotalsRow(rowTo : String, rowsFrom : RcbArray, columnFrom : integer, columnTo : integer)
        var rowsString = "";
        var row;

        for(row, rowsFrom)
            rowsString = rowsString + getSqlString(row) + ",";
        end;

        rowsString = subStr(rowsString, 1, strLen(rowsString) - 1);

        var strCmd = "     SELECT 0 AS t_contractId,"
                + "\n" +  getSqlString(rowTo) + " AS t_row,"
                + "\n" + "       t_column,                    "
                + "\n" + "       SUM(t_value) AS t_value,     "
                + "\n" + "       t_currency,                  "
                + "\n" + "       0 AS t_backOffice            "
                + "\n" + "  FROM df127_tmp                    "
                + "\n" + " WHERE t_row IN (" + rowsString + ")"
                + "\n" + "   AND t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY t_currency,                "
                + "\n" + "         t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        summaryInserter(strCmd);
    end;

    macro insertTotalsRowMinus(rowTo : String, rowFrom1 : String, rowFrom2 : String, columnFrom : integer, columnTo : integer)
        var strCmd = "     SELECT 0 AS t_contractId,"
                + "\n" +  getSqlString(rowTo) + " AS t_row,"
                + "\n" + "       t_column,                    "
                + "\n" + "       SUM(CASE WHEN t_row = " + getSqlString(rowFrom1) + " THEN t_value ELSE - t_value END) AS t_value,     "
                + "\n" + "       t_currency,                  "
                + "\n" + "       0 AS t_backOffice            "
                + "\n" + "  FROM df127_tmp                    "
                + "\n" + " WHERE t_row IN (" + getSqlString(rowFrom1) + ", " + getSqlString(rowFrom2) + ")"
                + "\n" + "   AND t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY t_currency,                "
                + "\n" + "         t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        summaryInserter(strCmd);
    end;

    macro insertTotalsRowMultyplay(rowTo : String, rowFrom1 : String, rowFrom2 : String,  multiplier : double, columnFrom : integer, columnTo : integer)
        var strCmd = "     SELECT 0 AS t_contractId,"
                + "\n" +  getSqlString(rowTo) + " AS t_row,"
                + "\n" + "       data1.t_column,                    "
                + "\n" + "       SUM(data1.t_value * " + string(multiplier) + ") * (SELECT SUM(data2.t_value)"
                + "\n" + "                                                            FROM df127_tmp data2                   "
                + "\n" + "                                                           WHERE data2.t_row = " + getSqlString(rowFrom2)
                + "\n" + "                                                             AND data2.t_column = data1.t_column"
                + "\n" + "                                                             AND data2.t_currency = data1.t_currency) AS t_value,     "
                + "\n" + "       data1.t_currency,                  "
                + "\n" + "       0 AS t_backOffice            "
                + "\n" + "  FROM df127_tmp data1                   "
                + "\n" + " WHERE data1.t_row = " + getSqlString(rowFrom1)
                + "\n" + "   AND data1.t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY data1.t_currency,                "
                + "\n" + "         data1.t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        summaryInserter(strCmd);
    end;

    macro initValues(rows : RcbArray)
        var i, j;
        var isFirst = true;
        var strCmd  = "";
        var codeCurrency = TF127Parameters().getCodeCurrencyArray();

        for (j, 0, codeCurrency.size - 1)
            rows.moveFirst();
            while (rows.moveNext())
                for (i, m_report.getFirstColumn(), m_report.getLastColumn())
                    if (not isFirst)
                        strCmd = strCmd + " UNION ALL" + "\n"
                    else
                        isFirst = false;
                    end;

                    strCmd = strCmd + "SELECT 0, " + getSqlString(rows.getCurrentItem()) + ", " + i + ", 0, " + getSqlString(codeCurrency[j]) + ", 0 FROM DUAL" + "\n";
                end;
            end;
        end;

        summaryInserter(strCmd);
    end;

    macro setValue(row, column, value, currency)
        var strCmd = "SELECT 0, " + getSqlString(row) + ", " + column + "," + value + ", " + getSqlString(currency) + ", 0 FROM DUAL";

        summaryInserter(strCmd);
    end;

    /**
    * Конструктор
    *
    */
    private macro constructorTF127SummaryData()
        initTF127DataSourceBase_4637(f127Constant.dataSource.IDENTIFIER_SUMMARY);
    end;

    constructorTF127SummaryData();
end;

private class (TF127SummaryData) TF127SummaryData_4637()
    /**
    * Инициализация источника данных.
    */
    macro clear()
        sql_execute("TRUNCATE TABLE df127_tmp");
    end;

    // получить итоговые данные
    macro getSummaryData()
        var commandText = "SELECT t_row,                        "
                 + "\n" + "       t_column,                     "
                 + "\n" + "       t_currency,                   "
                 + "\n" + "       SUM(t_value) AS t_value       "
                 + "\n" + "  FROM df127_tmp                     "
                 + "\n" + " GROUP BY t_currency,                "
                 + "\n" + "          t_row,                     "
                 + "\n" + "          t_column                   "
                 + "\n" + " ORDER BY t_currency, t_row, t_column";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        return data;
    end;

    macro insertTotalsRow(rowTo : String, rowsFrom : RcbArray, columnFrom : integer, columnTo : integer)
        var rowsString = "";
        var row;

        for(row, rowsFrom)
            rowsString = rowsString + getSqlString(row) + ",";
        end;

        rowsString = subStr(rowsString, 1, strLen(rowsString) - 1);

        var strCmd = "     SELECT 0 AS t_contractId,          "
                + "\n" +  getSqlString(rowTo) + " AS t_row,   "
                + "\n" + "       t_column,                    "
                + "\n" + "       SUM(t_value) AS t_value,     "
                + "\n" + "       t_currency,                  "
                + "\n" + "       0 AS t_backOffice            "
                + "\n" + "  FROM df127_tmp                    "
                + "\n" + " WHERE t_row IN (" + rowsString + ")"
                + "\n" + "   AND t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY t_currency,                "
                + "\n" + "         t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        var data = TRsbDataSet(strCmd);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();
        var graphName:string ="";

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices)
    end;

    macro insertTotalsRowMinus(rowTo : String, rowFrom1 : String, rowFrom2 : String, columnFrom : integer, columnTo : integer)
        var strCmd = "     SELECT 0 AS t_contractId,"
                + "\n" +  getSqlString(rowTo) + " AS t_row,"
                + "\n" + "       t_column,                    "
                + "\n" + "       SUM(CASE WHEN t_row = " + getSqlString(rowFrom1) + " THEN t_value ELSE - t_value END) AS t_value,     "
                + "\n" + "       t_currency,                  "
                + "\n" + "       0 AS t_backOffice            "
                + "\n" + "  FROM df127_tmp                    "
                + "\n" + " WHERE t_row IN (" + getSqlString(rowFrom1) + ", " + getSqlString(rowFrom2) + ")"
                + "\n" + "   AND t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY t_currency,                "
                + "\n" + "         t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        var data = TRsbDataSet(strCmd);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;
        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices)
    end;

    macro insertTotalsRowMultyplay(rowTo : String, rowFrom1 : String, rowFrom2 : String,  multiplier : double, columnFrom : integer, columnTo : integer)
        var strCmd = "     SELECT 0 AS t_contractId,                "
                + "\n" +  getSqlString(rowTo) + " AS t_row,         "
                + "\n" + "       data1.t_column,                    "
                + "\n" + "       SUM(data1.t_value * " + string(multiplier) + ") * (SELECT SUM(data2.t_value)                               "
                + "\n" + "                                                            FROM df127_tmp data2                                  "
                + "\n" + "                                                           WHERE data2.t_row = " + getSqlString(rowFrom2)
                + "\n" + "                                                             AND data2.t_column = data1.t_column                  "
                + "\n" + "                                                             AND data2.t_currency = data1.t_currency) AS t_value, "
                + "\n" + "       data1.t_currency,                  "
                + "\n" + "       0 AS t_backOffice                  "
                + "\n" + "  FROM df127_tmp data1                    "
                + "\n" + " WHERE data1.t_row = " + getSqlString(rowFrom1)
                + "\n" + "   AND data1.t_column BETWEEN " + columnFrom + " AND " + columnTo
                + "\n" + "GROUP BY data1.t_currency,                "
                + "\n" + "         data1.t_column                   "
                + "\n" + "ORDER BY t_currency, t_row, t_column";

        var data = TRsbDataSet(strCmd);
            data.setFieldType("t_column", V_INTEGER);
            data.setFieldType("t_value",  V_MONEY);

        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        while (data.MoveNext())
            var sumForReport : Money = nvl(data.t_value);

            contractsIds[contractsIds.size] = data.t_contractId;
            rows        [rows.size        ] = data.t_row;
            columns     [columns.size     ] = data.t_column;
            values      [values.size      ] = sumForReport;
            currencies  [currencies.size  ] = data.t_currency;
            boffices    [boffices.size    ] = data.t_backOffice;

        end;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices)
    end;

    macro initValues(rows : RcbArray)
        var i, j;
        var isFirst = true;
        var strCmd  = "";
        var codeCurrency = TF127Parameters().getCodeCurrencyArray();

        var contractsIds = TArray();
        var rowsArray    = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();

        for (j, 0, codeCurrency.size - 1)
            rows.moveFirst();
            while (rows.moveNext())
                for (i, m_report.getFirstColumn(), m_report.getLastColumn())
                    contractsIds[contractsIds.size] = 0;
                    rowsArray   [rowsArray.size   ] = rows.getCurrentItem();
                    columns     [columns.size     ] = i;
                    values      [values.size      ] = 0;
                    currencies  [currencies.size  ] = codeCurrency[j];
                    boffices    [boffices.size    ] = 0;
                end;
            end;
        end;

        summaryInserter(contractsIds, rowsArray, columns, values, currencies, boffices);
    end;

    macro setValue(row, column, value, currency)
        var contractsIds = TArray();
        var rows         = TArray();
        var columns      = TArray();
        var values       = TArray();
        var currencies   = TArray();
        var boffices     = TArray();
        var sumForReport : Money = nvl(value);

        contractsIds[contractsIds.size] = 0;
        rows        [rows.size        ] = row;
        columns     [columns.size     ] = column;
        values      [values.size      ] = sumForReport;
        currencies  [currencies.size  ] = currency;
        boffices    [boffices.size    ] = 0;

        summaryInserter(contractsIds, rows, columns, values, currencies, boffices)
    end;

    /**
     * Конструктор
     */
    private macro constructorTF127SummaryData_4637()
        initTF127SummaryData();
    end;

    constructorTF127SummaryData_4637();
end;

/**
* Форма 127. Контейнер ИД
*/
class (RcbDataSources) TF127DataSources(protocolView : RcbCalculateProtocolView)

    private var m_tuneTable: RcbTuneTable = NULL;

    macro getTuneTable()
        return m_tuneTable;
    end;

    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        sql_execute("TRUNCATE TABLE drcbBackOfficeAccount_tmp");

        m_dataSourcePool.push_back(TF127CbData(m_tuneTable,        m_protocolView.getDataProtocolView("cb")));
        m_dataSourcePool.push_back(TF127LoansData(m_tuneTable,     m_protocolView.getDataProtocolView("loans")));
        m_dataSourcePool.push_back(TF127RtlData(m_tuneTable,       m_protocolView.getDataProtocolView("retail")));
        m_dataSourcePool.push_back(TF127DepositsData(m_tuneTable,  m_protocolView.getDataProtocolView("deposit")));
        m_dataSourcePool.push_back(TF127MbkData(m_tuneTable,       m_protocolView.getDataProtocolView("mbk")));
        m_dataSourcePool.push_back(TF127SecuritisData(m_tuneTable, m_protocolView.getDataProtocolView("securitis")));

        m_dataSourcePool.push_back(TF127SummaryData());
    end;

    private macro constructorTF127DataSources(protocolView : RcbCalculateProtocolView)
        m_tuneTable = objectFactoryInstance.createTuneTable();
        initRcbDataSources(protocolView);
    end;

    constructorTF127DataSources(protocolView);
end;

class (TF127DataSources) TF127DataSources_4637(protocolView : RcbCalculateProtocolView)
    private macro initialize()
        sql_execute("TRUNCATE TABLE drcbBackOfficeAccount_tmp");

        m_dataSourcePool.push_back(TF127CbData_4637(m_tuneTable,        m_protocolView.getDataProtocolView("cb")));
        m_dataSourcePool.push_back(TF127LoansData_4637(m_tuneTable,     m_protocolView.getDataProtocolView("loans")));
        m_dataSourcePool.push_back(TF127RtlData_4637(m_tuneTable,       m_protocolView.getDataProtocolView("retail")));
        m_dataSourcePool.push_back(TF127DepositsData_4637(m_tuneTable,  m_protocolView.getDataProtocolView("deposit")));
        m_dataSourcePool.push_back(TF127MbkData(m_tuneTable,       m_protocolView.getDataProtocolView("mbk")));
        m_dataSourcePool.push_back(TF127SecuritisData(m_tuneTable, m_protocolView.getDataProtocolView("securitis")));

        m_dataSourcePool.push_back(TF127SummaryData_4637());
    end;

    private macro constructorTF127DataSources_4637(protocolView : RcbCalculateProtocolView)
        m_tuneTable = objectFactoryInstance.createTuneTable();
        initTF127DataSources(protocolView);
    end;

    constructorTF127DataSources_4637(protocolView);
end;