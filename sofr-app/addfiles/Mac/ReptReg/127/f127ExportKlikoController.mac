/*
$Name: f127ExportKlikoController.mac
$Module: Регламентируемая отчетность
$Description: Класс экспорта в kliko.exe.
*/

/**
 * Экспорт в kliko.exe.
 */
class (RcbKlikoExportController) TF127ExportKlikoController()
    private var m_jvm : Object;
    private var m_attributeValueContainer : Object;
    private var m_part : Object;

    private macro makeAttributeKey(currency : String, row : String, column : String)
        return currency + row + column;
    end;

    private macro fillAttributeValueContainer()
        m_attributeValueContainer = m_jvm.createJavaObject("java.util.HashMap", "<init>");

        for (var attribute, m_part.getAttributes())
            var attributeKey = makeAttributeKey(attribute.fieldValue(f127Constant.structure.CURRENCY).exactAsString,
                                                attribute.fieldValue(f127Constant.structure.LINE).exactAsString,
                                                attribute.fieldValue(f127Constant.structure.COLUMN).exactAsString
                                               );

            m_attributeValueContainer.put(attributeKey, attribute);
        end;
    end;

    private macro getRcbAttribute(currency, row, column)
        return m_attributeValueContainer.get(makeAttributeKey(currency, row, String(column)));
    end;

    private macro getDescriptorInfo()
        return "F127_04.PAK от 31.03.2015";
    end;

    private macro getExportString(str : string)
        return strSubst(str, "\"", "~^");
    end;

    private macro printDataString(rowNumber : String, description : String, currency : String, number : integer, isPrintCurrency : bool)
        defaultParm(isPrintCurrency, false);

        var dataArray = RcbArray().initialize(rowNumber, getExportString(description), ternary(isPrintCurrency,currency, ""));
        var fieldValue;
        var value;

        var i = m_report.getFirstColumn();
        while (i <= m_report.getLastColumn)
            var attribute = getRcbAttribute(currency, rowNumber, i);

            if (attribute == NULL)
                value = "";
            else
                fieldValue = attribute.fieldValue(f127Constant.structure.VALUE);
                if (not fieldValue.isDefined())
                    value = "";
                else
                     if ((rowNumber == "8.1") or (rowNumber == "8.2"))
                        value = string(fieldValue.exact);
                     elif (rowNumber == "8.3")
                        value = string(fieldValue.exact :r:0:4);
                    else
                        value = fieldValue.currentAsString;
                    end;
                end;

                fieldValue = attribute.fieldValue(f127Constant.structure.VALUE);
            end;

            dataArray.push_back(value);

            i = i + 1;
        end;

        dataArray.push_back("1");
        dataArray.push_back(number);
        dataArray.push_back("");

        m_view.printRow(dataArray);
    end;

    macro isExistsCurrencyPart(currency : String)
        return not (getRcbAttribute(currency, "1.1", m_report.getLastColumn()) == NULL);
    end;

    private macro printMainStringNote(currency : string, note : String)
        m_view.printRow(currency, note, "*", "1", "1", "");
    end;

    private macro printAddStringNote(note: String)
        m_view.printRow("", note, "-", "1", "0", "1");
    end;

    macro printNote(currency : String)
        var noteArray = m_part.getNoteAsArray(currency);
        var i = 0;

        while (i < noteArray.size)
            if (i == 0)
                printMainStringNote(currency, NVL(noteArray[i], ""));
            else
                printAddStringNote(noteArray[i]);
            end;

            i = i + 1;
        end;
    end;

    private macro printData(currency : String)
        printDataString("1", "БАЛАНСОВЫЕ АКТИВЫ", currency, 1, true);
        printDataString("1.1","Денежные средства и их эквиваленты", currency, 2);
        printDataString("1.2","Средства на корреспондентских счетах в кредитных организациях", currency, 3);
        printDataString("1.3","Ссудная задолженность, всего, из них:", currency, 4);
        printDataString("1.3.1","кредитных организаций", currency, 5);
        printDataString("1.3.2","юридических лиц, не являющихся кредитными организациями, всего, из них:", currency, 6);
        printDataString("1.3.2.1","ссуды в виде \"до востребования\" и \"овердрафт\"", currency, 7);
        printDataString("1.3.3","физических лиц, всего, из них:", currency, 8);
        printDataString("1.3.3.1","ссуды с использованием банковских карт", currency, 9);
        printDataString("1.3.3.2","жилищные ссуды", currency, 10);
        printDataString("1.4","Вложения в долговые обязательства", currency, 11);
        printDataString("1.5","Вложения в долевые ценные бумаги", currency, 12);
        printDataString("1.6","Прочие активы", currency, 13);
        printDataString("1.7","Основные средства и нематериальные активы", currency, 14);
        printDataString("2","ВНЕБАЛАНСОВЫЕ ТРЕБОВАНИЯ", currency, 15);
        printDataString("2.1","Фьючерсы", currency, 16);
        printDataString("2.2","Форварды", currency, 17);
        printDataString("2.3","Валютно-процентные свопы", currency, 18);
        printDataString("2.4","Процентные свопы", currency, 19);
        printDataString("2.5","Опционы \"Put\"", currency, 20);
        printDataString("2.6","Опционы \"Call\"", currency, 21);
        printDataString("2.7","Прочие договоры (контракты)", currency, 22);
        printDataString("3","Итого балансовых активов и внебалансовых требований", currency, 23);
        printDataString("4","БАЛАНСОВЫЕ ПАССИВЫ", currency, 24);
        printDataString("4.1","Средства кредитных организаций, всего, из них:", currency, 25);
        printDataString("4.1.1","на корреспондентских счетах", currency, 26);
        printDataString("4.1.2","межбанковские ссуды, депозиты", currency, 27);
        printDataString("4.2","Средства клиентов, не являющихся кредитными организациями, всего, из них:", currency, 28);
        printDataString("4.2.1","на расчетных (текущих) счетах юридических и физических лиц", currency, 29);
        printDataString("4.2.2","депозиты и юридических лиц", currency, 30);
        printDataString("4.2.3","вклады (депозиты) физических лиц", currency, 31);
        printDataString("4.3","Выпущенные долговые обязательства", currency, 32);
        printDataString("4.4","Прочие пассивы", currency, 33);
        printDataString("4.5","Источники собственных средств (капитала)", currency, 34);
        printDataString("5","ВНЕБАЛАНСОВЫЕ ОБЯЗАТЕЛЬСТВА", currency, 35);
        printDataString("5.1","Фьючерсы", currency, 36);
        printDataString("5.2","Форварды", currency, 37);
        printDataString("5.3","Валютно-процентные свопы", currency, 38);
        printDataString("5.4","Процентные свопы", currency, 39);
        printDataString("5.5","Опционы \"Put\"", currency, 40);
        printDataString("5.6","Опционы \"Call\"", currency, 41);
        printDataString("5.7","Прочие договоры (контракты)", currency, 42);
        printDataString("6","Итого балансовых пассивов и внебалансовых обязательств", currency, 43);
        printDataString("7","Совокупный ГЭП (строка 3 - строка 6)", currency, 44);
        printDataString("8","Изменение чистого процентного дохода:", currency, 45);
        printDataString("8.1","+ 400 базисных пунктов", currency, 46);
        printDataString("8.2","- 400 базисных пунктов", currency, 47);
        printDataString("8.3","временной коэффициент", currency, 48);
    end;

    private macro printDataZone()
       fillAttributeValueContainer();

        var codeCurrency = TF127Parameters().getCurrencyCodesAsArray();
        var i;

        m_view.setOutputFile();
        m_view.printHead("F127A");

        if  (m_part.checkRcbAttributeCurrency("000"))
            printData("000");
        end;

        for (i, 0, codeCurrency.size - 1)
            if (isExistsCurrencyPart(codeCurrency[i]))
                printData(codeCurrency[i]);
            end;
        end;

        //Печать примечаний
        m_view.printHead("F127_PRIM");

        if  (m_part.checkRcbAttributeCurrency("000"))
            printNote("000");
        end;

        for (i, 0, codeCurrency.size - 1)
            if (isExistsCurrencyPart(codeCurrency[i]))
                printNote(codeCurrency[i]);
            end;
        end;


        m_view.resetOutputFile();
    end;

    /**
     * Конструктор
     */
    private macro constructorTF127ExportKlikoController()
        initRcbKlikoExportController("127", objectFactoryInstance.createReport(RcbApplication.currentReport));

        m_jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
        m_part = objectFactoryInstance.createReport(TF127Global().getRcbReport()).getPart(f127Constant.part.PART_DATA);
    end;

    constructorTF127ExportKlikoController();

end;

class (TF127ExportKlikoController) TF127ExportKlikoController_4212()
    initTF127ExportKlikoController();

    private macro printData(currency : String)
        printDataString("1", "БАЛАНСОВЫЕ АКТИВЫ", currency, 1, true);
        printDataString("1.1","Денежные средства и их эквиваленты", currency, 2);
        printDataString("1.2","Средства на корреспондентских счетах в кредитных организациях", currency, 3);
        printDataString("1.3","Ссудная задолженность, всего, из нее:", currency, 4);
        printDataString("1.3.1","кредитных организаций", currency, 5);
        printDataString("1.3.2","юридических лиц, не являющихся кредитными организациями, всего, из них:", currency, 6);
        printDataString("1.3.2.1","ссуды в виде \"до востребования\" и \"овердрафт\"", currency, 7);
        printDataString("1.3.3","физических лиц, всего, из них:", currency, 8);
        printDataString("1.3.3.1","ссуды с использованием банковских карт", currency, 9);
        printDataString("1.3.3.2","жилищные ссуды", currency, 10);
        printDataString("1.4","Вложения в долговые обязательства", currency, 11);
        printDataString("1.5","Вложения в долевые ценные бумаги", currency, 12);
        printDataString("1.6","Прочие активы", currency, 13);
        printDataString("1.7","Основные средства и нематериальные активы", currency, 14);
        printDataString("2","ВНЕБАЛАНСОВЫЕ ТРЕБОВАНИЯ", currency, 15);
        printDataString("2.1","Фьючерсы", currency, 16);
        printDataString("2.2","Форварды", currency, 17);
        printDataString("2.3","Валютно-процентные свопы", currency, 18);
        printDataString("2.4","Процентные свопы", currency, 19);
        printDataString("2.5","Опционы \"Put\"", currency, 20);
        printDataString("2.6","Опционы \"Call\"", currency, 21);
        printDataString("2.7","Прочие договоры (контракты)", currency, 22);
        printDataString("3","Итого балансовых активов и внебалансовых требований", currency, 23);
        printDataString("4","БАЛАНСОВЫЕ ПАССИВЫ", currency, 24);
        printDataString("4.1","Средства кредитных организаций, всего, из них:", currency, 25);
        printDataString("4.1.1","на корреспондентских счетах", currency, 26);
        printDataString("4.1.2","межбанковские ссуды, депозиты", currency, 27);
        printDataString("4.2","Средства клиентов, не являющихся кредитными организациями, всего, из них:", currency, 28);
        printDataString("4.2.1","на расчетных (текущих) счетах юридических и физических лиц", currency, 29);
        printDataString("4.2.2","депозиты и юридических лиц", currency, 30);
        printDataString("4.2.3","вклады (депозиты) физических лиц", currency, 31);
        printDataString("4.3","Выпущенные долговые обязательства", currency, 32);
        printDataString("4.4","Прочие пассивы", currency, 33);
        printDataString("4.5","Источники собственных средств (капитала)", currency, 34);
        printDataString("5","ВНЕБАЛАНСОВЫЕ ОБЯЗАТЕЛЬСТВА", currency, 35);
        printDataString("5.1","Фьючерсы", currency, 36);
        printDataString("5.2","Форварды", currency, 37);
        printDataString("5.3","Валютно-процентные свопы", currency, 38);
        printDataString("5.4","Процентные свопы", currency, 39);
        printDataString("5.5","Опционы \"Put\"", currency, 40);
        printDataString("5.6","Опционы \"Call\"", currency, 41);
        printDataString("5.7","Прочие договоры (контракты)", currency, 42);
        printDataString("6","Итого балансовых пассивов и внебалансовых обязательств", currency, 43);
        printDataString("7","Совокупный ГЭП (строка 3 - строка 6)", currency, 44);
        printDataString("8","Изменение чистого процентного дохода:", currency, 45);
        printDataString("8.1","+ 200 базисных пунктов", currency, 46);
        printDataString("8.2","- 200 базисных пунктов", currency, 47);
        printDataString("8.3","временной коэффициент", currency, 48);
    end;
end;