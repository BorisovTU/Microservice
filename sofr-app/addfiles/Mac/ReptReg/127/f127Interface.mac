/*
$Name: f127Interface.mac
$Module: Регламентируемая отчетность
$Description: Форма 127. Доступ к операциям формы.
*/

import f127Import;

/**
 *  Запуск операции расчета отчета
 */
macro executeCalculationOperation()
    var profiler = TSqlProfiler(getTxtFileName("!F127CalculateProfile"));
    profiler.clear();
    profiler.on();

    const MODE_LABEL    = "-mode:";

    var modeLabelIndex = index(cmdArgs, MODE_LABEL);
    var modeReport     = ternary(substr(cmdArgs, modeLabelIndex + strlen(MODE_LABEL), strlen("inContextOfCurrencies")) == "inContextOfCurrencies",
                                                                                               f127Constant.modeReport.MODE_INCONTEXTOFCURRENCIES,
                                                                                                     f127Constant.modeReport.MODE_BYALLCURRENCIES);

    TF127Global().setReportMode(modeReport);

    objectFactoryInstance.createReportCalculateController().calculate();
    RcbApplication().transactionManager.commit();
end;

/**
 *  Запуск операции пересчета после свода
 */
macro executeRecalculationOperation()
    objectFactoryInstance.createReportRecalculateController().calculate();
    RcbApplication().transactionManager.commit();
end;

/**
 *  Запуск операции печати отчета
 */
macro executePrintOperation()
    const MODE_LABEL    = "-mode:";

    var modeLabelIndex = index(cmdArgs, MODE_LABEL);
    var modeReport     = ternary(substr(cmdArgs, modeLabelIndex + strlen(MODE_LABEL), strlen("inContextOfCurrencies")) == "inContextOfCurrencies",
                                                                                               f127Constant.modeReport.MODE_INCONTEXTOFCURRENCIES,
                                                                                                     f127Constant.modeReport.MODE_BYALLCURRENCIES);

    TF127Global().setReportMode(modeReport);

    objectFactoryInstance.createReportPrintController().print();
end;

/**
 *  Запуск операции печати отчета в формате Excel
 */
macro executeExcelPrintOperation()
    const MODE_LABEL    = "-mode:";

    var modeLabelIndex = index(cmdArgs, MODE_LABEL);
    var modeReport     = ternary(substr(cmdArgs, modeLabelIndex + strlen(MODE_LABEL), strlen("inContextOfCurrencies")) == "inContextOfCurrencies",
                                                                                               f127Constant.modeReport.MODE_INCONTEXTOFCURRENCIES,
                                                                                                     f127Constant.modeReport.MODE_BYALLCURRENCIES);

    TF127Global().setReportMode(modeReport);

    objectFactoryInstance.createReportPrintController(WINREP_FORMAT_XLSX).print();
end;

/**
 *  Запуск операции экспорта в kliko.exe
 */
macro executeKlikoExportOperation()
    if (not rcbApplication().currentReport.isCalculated)
        TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe").checkCalculateReport("kliko.exe");
        return;
    end;

    objectFactoryInstance.createKlikoExportController().execute();
end;

/**
 *  Запуск операции экспорта в ПТК ПСД
 */
macro executePtkPsdExportOperation()
    msgbox("Экспорт в АС ПТК временно не реализован");
    RepErrorsQueue().add(0, "Экспорт в АС ПТК временно не реализован");

//    objectFactoryInstance.createPtkPsdExportController().execute();
end;

macro executeXmlExportOperation()
    objectFactoryInstance.createXmlExportController().execute();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
