/*
$Name: f127ReportCalculateController.mac
$Module: Регламентируемая отчетность
$Description: Форма 127. Класс контроллера расчета отчета.
*/

/**
 * Контроллер расчета отчета
 */
class (RcbReportCalculateController) TF127ReportCalculateController()

    private macro clearValues()

        var partConstant: Object = f127Constant.part;

        var part = getReport().getPart(partConstant.PART_DATA);
        var codeCurrency = TF127Parameters().getCodeCurrencyArray();
        var attribute : Object;
        var i = 0;

        for(i, 0, codeCurrency.size -1)
            attribute = part.getAttributeCurrency(codeCurrency[i]);

            if (attribute != NULL)
                attribute.removeAllValues();
                part.getPartCompositeValue().removeValue(attribute.valueId());
            end;
        end;

        RcbApplication().transactionManager.commit();

        getReport().getPart(partConstant.PART_DATA).clear();

    end;

    /**
     * Установка контроллеров расчета по разделам
     */
    private macro pushControllers()

        var partData = objectFactoryInstance.createPartDataCalculateController(this);
        m_partCalculateControllers.push_back(partData);

    end;

    /**
     * Печать дополнительного протокола данных
     */
    private macro printAdditionalProtocolData()

        TF127Parameters().printCalculationReport(getProtocolView());

    end;

    /**
     * Расчет
     *
     * @return Bool TRUE, если расчет выполнен, иначе - FALSE.
     */
    macro calculate(): Bool
        var result: Bool = calculate();

        for (var part, m_partCalculateControllers)

            /* part.getDataProtocolView().save(); */

        end;

        return result;

    end;

    /**
     * Инициализация
     *
     * @return Bool TRUE, если есть данные (контроллеры разделов), иначе - FALSE.
     */
    macro initialize(): Bool

        clearValues();
        pushControllers();

        return m_partCalculateControllers.size > 0;

    end;

    /**
     * Конструктор
     */
    private macro constructorTF127ReportCalculateController()

        initRcbReportCalculateController();

    end;

    constructorTF127ReportCalculateController();

end;
