/*
$Name:          c_f711.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 711. Инициализация и расчет формы
*/

/* ──────────────────────────────────────────────────────────────────────────┐
    RS-Bank V6                                                 R-Style Softlab
    Файл подсистемы "Регламентированная отчетность"

    Расчет формы 711

    CREATED : 07.09.05   Лузгин

    MODIFICATIONS:
    NOTES:

└─────────────────────────────────────────────────────────────────────────- */

IMPORT RsbObjFactory, RsbDataSet, com_f711;
import cb_sql;
import RcbCoreInter;
import rcb_lib;
import calc_f711bill;
import calc_f711avoir;
import calc_f711Part3;
import calc_f711Part4;
import testLib;

import com_f711objectFactory;

/* ============================= Декларации =============================== */

/* ------------------------- Настройки и константы ------------------------ */

CONST   TempTable = "df711ac_tmp";         // Основная временная таблица для расчета формы
CONST   TempTable2 = "df711interdepo_tmp"; // Временная таблица для протокола расчета подраздела 1.2
CONST   TempTable3 = "df711depo_tmp";      // Временная таблица для протокола расчета подраздела 1.3

CONST   QueryOurBanks = "(SELECT t_partyId FROM drepourbank_tmp)"; // Запрос к таблице с подразделениями, являющимися "нашим банком"

CONST   FOREIGN_SECURITIES = "Чужие ц/б";

private const RECORDTYPE_SECURE = 1;
private const RECORDTYPE_INVCARD = 2;
private const RECORDTYPE_COLLECTION = 3;

/* -------------------------- Классы, переменные -------------------------- */
private var m_purposeString = TArray();

m_purposeString[ 0] = "00 вычисляемый";
m_purposeString[ 1] = "01 счет владельца";
m_purposeString[ 2] = "02 счет номинального держателя";
m_purposeString[ 3] = "03 счет доверительного управляющего";
m_purposeString[ 4] = "04 счет залогодержателя";
m_purposeString[ 5] = "05 эмиссионный счет эмитента";
m_purposeString[ 6] = "06 счет эмитента для выкупа/погашения";
m_purposeString[ 7] = "07 ценные бумаги неустановленных лиц";
m_purposeString[21] = "21 хранилище";
m_purposeString[22] = "22 междепозитарный счет";
m_purposeString[98] = "98 транзитный счет";

private var m_ourBankId;

private macro getMaxPurposeStringLength()
    var result = 0;
    var i = 0;

    while (i < m_purposeString.size)
        if ((m_purposeString[i] != null) and (strLen(m_purposeString[i]) > result))
            result = strLen(m_purposeString[i]);
        end;
        i = i + 1;
    end;

    return result;
end;

/* ========================= Вспомогательные функции ====================== */

// Описание типа счета депо по назначению
private macro getTypeDescription(type)
    return nvl(m_purposeString[ternary(type < 0, m_purposeString.size, type)], "тип счета неопределен");
end;

// Комментарий к счету по количеству ц/б (для протокола)
private macro getNoteForAmount(amount)
    return ternary(strLen(string(amount:0:4)) > 16,
                   "Внимание! Количество ц/б по л/с превышает допустимое значение для выгрузки в kliko.exe: тип N - число с плав.точкой, 16.4.",
                   "");
end;

// Сумма ц/б на лицевых счетах счета депо
macro CalculateSum(ID)

    var v_Sum;
    var sumQuery = "SELECT SUM(T_REST) T_SUM FROM " + TempTable +
                    " WHERE T_DEPOID = " + ID +
                    " AND T_ACCOUNT != " + getSqlString("") +
                    " AND T_CODEFI != " + getSqlString("");

    var data = TRsbDataSet (SumQuery);
    if ((data) and (data.Next()) and (data.Sum != NULL))
        v_Sum = data.Sum;
    else
        v_Sum = 0;
    end;

    return v_Sum;

end;

/**
 * Сумма ц/б на лицевых счетах счета депо, владелец которых является реестродержателем
 */
macro calculateSumRegistrar(id)

    var sum;
    var query = "SELECT SUM(account.t_rest) t_sum"
       + "\n" + "  FROM " + tempTable + " account,"
       + "\n" + "       ormFinAvoiriss avoiriss"
       + "\n" + " WHERE account.t_depoId = " + id
       + "\n" + "   AND account.t_account != " + getSqlString("")
       + "\n" + "   AND account.t_codeFi != " + getSqlString("")
       + "\n" + "   AND avoiriss.t_fiId = account.t_fiId"
       + "\n" + "   AND avoiriss.t_regHolderId = account.t_partyId"
       ;

    var data = TRsbDataset(query);
    data.setFieldType("t_sum", V_MONEY);

    if ((data.next()) and (data.sum != NULL))
        sum = data.sum;
    else
        sum = $0;
    end;

    return sum;

end;

/**
 * Сумма ц/б на лицевых счетах счета депо, владелец которых НЕ является реестродержателем
 */
macro calculateSumNotRegistrar(id)

    var sum;
    var query = "SELECT SUM(account.t_rest) t_sum"
       + "\n" + "  FROM " + tempTable + " account"
       + "\n" + " WHERE account.t_depoId = " + id
       + "\n" + "   AND account.t_account != " + getSqlString("")
       + "\n" + "   AND account.t_codeFi != " + getSqlString("")
       + "\n" + "   AND NOT EXISTS (SELECT NULL"
       + "\n" + "                     FROM ormFinAvoiriss avoiriss"
       + "\n" + "                    WHERE avoiriss.t_fiId = account.t_fiId"
       + "\n" + "                      AND avoiriss.t_regHolderId = account.t_partyId"
       + "\n" + "                  )"
       ;

    var data = TRsbDataset(query);
    data.setFieldType("t_sum", V_MONEY);

    if ((data.next()) and (data.sum != NULL))
        sum = data.sum;
    else
        sum = $0;
    end;

    return sum;

end;

/* ======================= Заполнение временного файла ==================== */

private MACRO FillTempTable()

    message( "Заполнение временной таблицы данными Депозитария..." );

    // Объект "Счет депо"
    var depoAcc : String; //rcbGetObject("RsbDepoAcc711");

    // Объект "Лицевой счет депо"
    var depoAccount : String; //rcbGetObject("RsbDepoAccount711");

    depoAcc = "INSERT /*+ APPEND*/ INTO " + tempTable
     + "\n" + "("
     + "\n" + " t_partyId,"
     + "\n" + " t_subject,"
     + "\n" + " t_isNr,"
     + "\n" + " t_depoId,"
     + "\n" + " t_depoNumb,"
     + "\n" + " t_depoKind,"
     + "\n" + " t_account,"
     + "\n" + " t_codeFi,"
     + "\n" + " t_rest,"
     + "\n" + " t_depoType,"
     + "\n" + " t_depoType1,"
     + "\n" + " t_ownership,"
     + "\n" + " t_departmentCode"
     + "\n" + ")"
     + "\n" + "SELECT DECODE(depAcc.t_ownerId, 0, " + OurBank + ", depAcc.t_ownerId),"
     + "\n" + "       SUBSTR(rsb_rep_pt.get_ptshname(DECODE(depAcc.t_ownerId, 0, " + OurBank + ", depAcc.t_ownerId)), 1, 60),"
     + "\n" + "       (SELECT DECODE(party.t_notResident, 'X', 1, 0)"
     + "\n" + "          FROM dparty_dbt party"
     + "\n" + "         WHERE DECODE(depAcc.t_ownerId, 0, " + OurBank + ", depAcc.t_ownerId) = party.t_partyId"
     + "\n" + "       ),"
     + "\n" + "       depAcc.t_autokey,"
     + "\n" + "       depAcc.t_code,"
     + "\n" + "       depAcc.t_kindCh,"
     + "\n" + "       CHR(1),"
     + "\n" + "       CHR(2),"
     + "\n" + "       0,"
     + "\n" + "       depAcc.t_purpose,"
     + "\n" + "       depAcc.t_typeNumber,"
     + "\n" + "       depAcc.t_ownership,"
     + "\n" + "       depAcc.t_department"
     + "\n" + "  FROM ormDepAcc depAcc"
     + "\n" + " WHERE depAcc.t_statusName != 'Закрыт'"
     + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("depAcc.t_department", "depAcc.t_branch");

    sql_execute(depoAcc);
    sql_execute("COMMIT");

    sql_truncate("drsbdepocache711_tmp");
    sql_execute("INSERT /*+ APPEND*/ INTO drsbdepocache711_tmp"
       + "\n" + "("
       + "\n" + " t_depoId,"
       + "\n" + " t_depoNumb,"
       + "\n" + " t_depoType,"
       + "\n" + " t_depoKind,"
       + "\n" + " t_partyId,"
       + "\n" + " t_subject,"
       + "\n" + " t_isNr"
       + "\n" + ")"
       + "\n" + "SELECT t_depoId,"
       + "\n" + "       t_depoNumb,"
       + "\n" + "       t_depoType,"
       + "\n" + "       t_depoKind,"
       + "\n" + "       t_partyId,"
       + "\n" + "       t_subject,"
       + "\n" + "       t_isNr"
       + "\n" + "  FROM df711ac_tmp"
       + "\n" + " WHERE t_depoId IN (SELECT MIN(t.t_depoId)"
       + "\n" + "                      FROM df711ac_tmp t"
       + "\n" + "                     GROUP BY t.t_depoNumb)"
               );
    sql_execute("COMMIT");

    depoAccount = "INSERT /*+ APPEND*/ INTO " + tempTable
         + "\n" + "("
         + "\n" + " t_partyId,"
         + "\n" + " t_subject,"
         + "\n" + " t_isNr,"
         + "\n" + " t_depoId,"
         + "\n" + " t_depoNumb,"
         + "\n" + " t_depoKind,"
         + "\n" + " t_depoType,"
         + "\n" + " t_account,"
         + "\n" + " t_codeFi,"
         + "\n" + " t_rest,"
         + "\n" + " t_ownership,"
         + "\n" + " t_fiId"
         + "\n" + ")"
         + "\n" + "SELECT attr.t_partyId,"
         + "\n" + "       attr.t_subject,"
         + "\n" + "       attr.t_isNr,"
         + "\n" + "       attr.t_depoId,"
         + "\n" + "       attr.t_depoNumb,"
         + "\n" + "       attr.t_depoKind,"
         + "\n" + "       attr.t_depoType,"
         + "\n" + "       depoAccount.t_account,"
         + "\n" + "       depoAccount.t_fi_code,"
         + "\n" + "       depoAccount.t_restEnd,"
         + "\n" + "       CHR(1),"
         + "\n" + "       t_code_currency"
         + "\n" + "  FROM ormDepAccount depoAccount,"
         + "\n" + "       drsbdepocache711_tmp attr"
         + "\n" + " WHERE attr.t_depoNumb = depoAccount.t_depoAccCode"
         + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("depoAccount.t_department", "depoAccount.t_branch")
         + "\n" + "   AND depoAccount.t_open_date <= " + getSqlDate(ДатаОтчета)
         + "\n" + "   AND (depoAccount.t_close_date >= " + getSqlDate(ДатаОтчета) + " OR depoAccount.t_close_date < depoAccount.t_open_date)";
    sql_execute(depoAccount);
    sql_execute("COMMIT");

    message( "Заполнение временной таблицы корреспонденции с активными счетами..." );
    sql_truncate("df711CorAccount_tmp");
    sql_execute("INSERT /*+ APPEND*/ INTO  df711CorAccount_tmp(t_connectAccount, t_connectFiId, t_ownerId, t_rest)"

                + "\n" + " SELECT "
                + "\n" + "        account.t_account       AS t_connectAccount,"
                + "\n" + "        account.t_code_currency AS t_connectFiId,"
                + "\n" + "        acc.t_owner             AS t_ownerId,"
                + "\n" + "        NULL                    AS t_rest"
                + "\n" + "   FROM OrmDepAccount account,"
                + "\n" + "        OrmDepAcc acc"
                + "\n" + "  WHERE account.t_depoRoot = acc.t_autoKey"
                + "\n" + "UNION ALL "
                + "\n" + " SELECT "
                + "\n" + "        ain.t_account AS t_connectAccount,"
                + "\n" + "        ain.t_code_currency AS t_connectFiId,"
                + "\n" + "        acc.t_owner AS t_ownerId,"
                + "\n" + "        ain.t_restend AS t_rest"
                + "\n" + "   FROM ormdepainpaccount ain,"
                + "\n" + "        OrmDepAccount account,"
                + "\n" + "        OrmDepAcc acc"
                + "\n" + "  WHERE  ain.t_ainPAccount = account.t_account"
                + "\n" + "    AND  ain.t_code_currency = account.t_code_currency"
                + "\n" + "    AND  account.t_depoRoot = acc.t_autoKey");
    sql_execute("COMMIT");

    message( "Заполнение временной таблицы данных для владельца активного счета..." );
    sql_truncate("df711ActiveAccountOwner_tmp");
    sql_execute("INSERT /*+ APPEND*/ INTO df711ActiveAccountOwner_tmp("
                + "\n" + "      t_realId,"
                + "\n" + "      t_id,"
                + "\n" + "      t_name,"
                + "\n" + "      t_inn,"
                + "\n" + "      t_orcbNumber,"
                + "\n" + "      t_specDepoLicenseNumber,"
                + "\n" + "      t_isResident,"
                + "\n" + "      t_isBank,"
                + "\n" + "      t_isDepositary,"
                + "\n" + "      t_isRegistrar,"
                + "\n" + "      t_isIssuer,"
                + "\n" + "      t_countryCode)"

                + "\n" + "SELECT"
                + "\n" + "        t_id AS t_realId,"
                + "\n" + "        CASE"
                + "\n" + "            WHEN t_id IN (SELECT t_partyId"
                + "\n" + "                            FROM drepourbank_tmp"
                + "\n" + "                         )"
                + "\n" + "            THEN " + m_ourBankId
                + "\n" + "            ELSE t_id"
                + "\n" + "        END AS t_id,"
                + "\n" + "        t_name,"
                + "\n" + "        (SELECT t_code"
                + "\n" + "           FROM drepPartyCodes_vw pc"
                + "\n" + "          WHERE pc.t_partyId = pt.t_id"
                + "\n" + "            AND t_codeKind = 16/*ИНН*/) t_inn,"
                + "\n" + "        (SELECT t_code"
                + "\n" + "           FROM drepPartyCodes_vw pc"
                + "\n" + "          WHERE pc.t_partyId = pt.t_id"
                + "\n" + "            AND t_codeKind = 17/*Номер лицензии участника ОРЦБ*/) t_orcbNumber,"
                + "\n" + "        (SELECT t_code"
                + "\n" + "           FROM drepPartyCodes_vw pc"
                + "\n" + "          WHERE pc.t_partyId = pt.t_id"
                + "\n" + "            AND t_codeKind = 57/*Номер спецдепозитарной лицензии*/) t_specDepoLicenseNumber,"
                + "\n" + "        t_isResident,"
                + "\n" + "        t_isBank,"
                + "\n" + "        t_isDepositary,"
                + "\n" + "        t_isRegistrar,"
                + "\n" + "        t_isIssuer,"
                + "\n" + "        (SELECT t_codeNum3"
                + "\n" + "           FROM dcountry_dbt"
                + "\n" + "          WHERE t_countryCode = t_codeLat3 AND t_countryCode != CHR(1)) t_countryCode"
                + "\n" + "   FROM drepParty_vw pt");
    sql_execute("COMMIT");

    message( "Заполнение временной таблицы ИК..." );
    sql_truncate("df711InvCard_tmp");
    sql_execute("INSERT /*+ APPEND*/ INTO df711InvCard_tmp("
                + "\n" + "      t_xid,"
                + "\n" + "      t_issuerId,"
                + "\n" + "      t_faceValueFiId,"
                + "\n" + "      t_fiid,"
                + "\n" + "      t_faceValue,"
                + "\n" + "      t_hAccount,"
                + "\n" + "      t_copies,"
                + "\n" + "      t_objectType,"
                + "\n" + "      t_code711Group,"
                + "\n" + "      t_code711Name,"
                + "\n" + "      t_status,"
                + "\n" + "      t_autokey)"

                + "\n" + "        SELECT invCard.t_xid,"
                + "\n" + "               invCard.t_issuerId,"
                + "\n" + "               invCard.t_faceValueFiId,"
                + "\n" + "               invCard.t_fiid,"
                + "\n" + "               invCard.t_faceValue,"
                + "\n" + "               invCard.t_hAccount,"
                + "\n" + "               invCard.t_copies,"
                + "\n" + "               invCard.t_objectType,"
                + "\n" + "               invCard.t_code711Group,"
                + "\n" + "               (SELECT att.t_name"
                + "\n" + "                  FROM dobjattr_dbt att,"
                + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
                + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
                + "\n" + "                               atc.t_objectType AS t_realObjectType,"
                + "\n" + "                               atc.t_groupId AS t_realGroupId,"
                + "\n" + "                               atc.t_attrId t_attrId,"
                + "\n" + "                               atc.t_object t_object,"
                + "\n" + "                               atc.t_validToDate t_validToDate,"
                + "\n" + "                               atc.t_validFromDate t_validFromDate"
                + "\n" + "                          FROM dobjatcor_dbt atc,"
                + "\n" + "                               dobjgroup_dbt grp"
                + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
                + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
                + "\n" + "                           AND atc.t_general = 'X') atc"
                + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
                + "\n" + "                   AND atc.t_objectType = att.t_objectType"
                + "\n" + "                   AND atc.t_groupId = att.t_groupId"
                + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
                + "\n" + "                   AND atc.t_realObjectType = invCard.t_objectType"
                + "\n" + "                   AND atc.t_realGroupId = invCard.t_code711Group"
                + "\n" + "                   AND atc.t_object = TO_CHAR(invCard.t_autokey)"
                + "\n" + "               ) AS t_code711Name,"
                + "\n" + "               invCard.t_status,"
                + "\n" + "               invCard.t_autokey"
                + "\n" + "          FROM OrmDepInvCard invCard");

    sql_execute("COMMIT");
END;

/* ====================== Инициализация расчета =========================== */

/**
*  Инициализация процедуры расчета
*
*  @author Andrew B. Panov
*  @since 6.00.020.29
*/
private macro initialize()

    // Очистка временных таблиц
    sql_truncate(TempTable);
    sql_truncate(TempTable2);
    sql_truncate(tempTable3);

    // Инициализация протокола расчета
    setoutput( ИмяФайлаПротокола );
    println("Форма 711. Раздел 1 \"Депозитарные операции\"");
    println("ПРОТОКОЛ РАСЧЕТА");
    println("    Период отчета с " + string(RcbApplication().currentReport.context.period.beginDate) + " по " + string(RcbApplication().currentReport.context.period.endDate));
    println("    Исполнитель: " + Исполнитель);
    println("    Дата и время выпуска отчета " + string(date())+ "  " + string(time()));
    println();

    sql_execute("BEGIN"
       + "\n" + "   rep_opt.clearOurBankTable();"
       + "\n" + "   rep_opt.makeOurBankSlice();"
       + "\n" + " "
       + "\n" + "   rsvoxprm.clearPrmMap;"
       + "\n" + "   rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "   rsvoxprm.setPrmVal('EndDate', UTL_RAW.CAST_TO_RAW(TO_CHAR(" + getSqlDate(RcbApplication().currentReport.context.period.endDate) + ", 'DD.MM.YYYY')));"
       + "\n" + "END;"
               );

    var cmd = RsdCommand("{ ? = CALL rep_opt.getTopSuperiorId(?) }");
    cmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
    cmd.addParam("ourBankId", RSDBP_IN, {OurBank});
    cmd.execute();
    m_ourBankId = cmd.value("retval");

end;

/* ========== Расчет и сохранение переменных первого раздела ============== */

private MACRO Department_1()

    var v_DepoNumb, v_Type, v_Owner, v_NR, v_ch;

/* ----------------- Запросы к временной таблице -------------------------- */

    var BaseQuery = "SELECT * FROM " + TempTable + " WHERE t_DepoKind = 'П' AND t_Account = CHR(1)";

    var EndQuery = " ORDER BY t_depoNumb, t_depoType";

    // Условия для соответствующих граф отчета (первый раздел)
    var Query = TArray();

    Query[1] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_isNR = 0 AND t_DepoType = 1";
    Query[2] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_isNR = 1 AND t_DepoType = 1";
    Query[3] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_isNR = 0 AND t_DepoType = 2";
    Query[4] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_isNR = 1 AND t_DepoType = 2";
    Query[5] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_DepoType = 4";
    Query[6] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_DepoType = 3";
    Query[7] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_DepoType = 5";
    Query[8] = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_DepoType = 6";

    Query[9] = " AND t_DepoType = 7";

    Query[10] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType = 1";
    Query[11] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType = 4";
    Query[12] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType = 3";
    Query[13] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType = 5";
    Query[14] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType = 6";
    Query[15] = " AND t_PartyID IN " + QueryOurBanks + " AND t_DepoType NOT IN (0, 1, 3, 4, 5, 6, 98)";

    // Cчета, не учитывающиеся в отчете, для вывода в протокол
    var invalidAccountsSubpart11 = " AND t_PartyID NOT IN " + QueryOurBanks + " AND t_depoType IN (0, 98)";
    var invalidAccountsSubpart12 = " AND t_PartyID IN " + QueryOurBanks + " AND t_depoType IN (0, 98)";

    var v_Name, v_Sum, v_i;

    private macro calculate(header, startColumn, stopColumn, invalidAccountQuery, increment)

        var data;
        var first_data = true;

        var i;
        var protocol = CTableReport(0);

        protocol.addColumn("", 1, AL_CENTER);
        protocol.addColumn("Графа", 2, AL_CENTER);
        protocol.addColumn("Счет депо", 25, AL_LEFT);
        protocol.addColumn("Тип счета депо по назначению", 34, AL_LEFT);
        protocol.addcolumn("Владелец", 20, AL_LEFT);
        protocol.addColumn("Н", 1);

        protocol.printHead("          " + header);

        // Счета с ошибками
        v_ch = "!";
        v_i = "";

        data = TRsbDataset(BaseQuery + invalidAccountQuery + EndQuery);

        while ((data != null) and data.next())

            first_data = false;

            v_DepoNumb = data.DepoNumb;
            v_Type = getTypeDescription(data.depoType);
            v_Owner = data.Subject;
            v_NR = ternary(data.isNR, "X", "");

            protocol.printStringTransferByWord(v_ch, v_i, v_DepoNumb, v_Type, v_Owner, v_NR);
        end;

        // Счета без ошибок
        v_ch = "";
        i = startColumn - 1;
        while(i < stopColumn);

            i = i + 1;
            v_Sum = 0;
            v_Name = GetVarName(1, i);
            data = TRsbDataset(BaseQuery + Query[i] + EndQuery);
            while ((data != null) and data.next())

                if (first_data)

                    first_data = false;
                    v_i = i;

                else

                    if (v_i != i)
                        v_i = i;
                        protocol.printSeparator();
                    end;

                end;

                v_DepoNumb = data.DepoNumb;
                v_Type = getTypeDescription(data.DepoType);
                v_Owner = data.Subject;
                v_NR = ternary(data.isNR, "X", "");
                v_Sum = v_Sum + 1;
                protocol.printStringTransferByWord(v_ch, v_i+increment, v_DepoNumb, v_Type, v_Owner, v_NR);

            end;

            RcbApplication().currentReport().attributeValue("Ф711_Гр"+i).exact = v_Sum;

        end;

        if (not first_data)
            protocol.printBottom();
        else
            println(strAlign("Нет данных", protocol.getSumLen(), STR_ALIGN_CENTER));
        end;

    end;

/* -------------------- Основной цикл расчета ----------------------------- */
    begAction(1000, "Расчет переменных раздела 1");

    if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)

        message("Расчет переменных раздела 1...");

        println("Раздел 1 \"Счета депо\"");

        calculate("1.1 \"Счета депо клиентов\"", 1, MaxColumn_1_1, invalidAccountsSubpart11, 1);

        println();

        calculate("1.2 \"Счета депо кредитной организации\"", MaxColumn_1_1 + 1, MaxColumn_1, invalidAccountsSubpart12, 2);

    else

        message("Расчет переменных подраздела 1...");

        println("Подраздел 1.1 \"Счета депо\"");

        calculate("1.1.1 \"Счета депо клиентов\"", 1, MaxColumn_1_1, invalidAccountsSubpart11, 1);

        println();

        calculate("1.1.2 \"Счета депо кредитной организации\"", MaxColumn_1_1 + 1, MaxColumn_1, invalidAccountsSubpart12, 2);

    end;

    endAction();

END;

/* ========== Расчет и сохранение переменных второго раздела ============== */

private MACRO Department_2()

    var data, first_data = true;
    // Объект "Счет депо"
    var DepoAcc;
    // Объект "Субъект"
    var Subject;

/* -------- Инициализация протокола расчета для второго раздела ----------- */

    var Protocol = CTableReport(0);

    Protocol.AddColumn( "Вид счета", 6, AL_CENTER );
    Protocol.AddColumn( "Корреспондент", 20, AL_LEFT );
    Protocol.AddColumn( "Номер счета депо", 25, AL_LEFT );
    Protocol.AddColumn( "Номер счета депо у корр.", 25, AL_LEFT );
    Protocol.AddColumn( "Список лицевых счетов депо", 25, AL_LEFT );
    Protocol.Addcolumn( "Количество ц/б на л/с", 24, AL_RIGHT );
    protocol.addcolumn( "Примечание",            24, AL_LEFT);

    // Идентификатор счета депо для протокола
    var protocolDepoId = 0;

/* -------- Промежуточные переменные и вспомогательные функции ------------ */

    var v_Subject, v_License, v_Badge;
    var v_DepoNumb, v_CorrNumb, v_Kind;
    var v_Sum, v_sumRegistrar, v_sumNotRegistrar;

    // Счета ЛОРО. Должно соотвествовать условиям отбора счетов.
    macro isPart21()
        return (data.depoKind == "П") and (data.depoType == 2);
    end;

    // Счета НОСТРО. Должно соотвествовать условиям отбора счетов.
    macro isPart22()
        return (data.depoKind == "А") and (data.depoType == 22) and (data.ownership == FOREIGN_SECURITIES);
    end;

    macro isRegistrar(badge)
        return     (badge != null)
               and (strlen(badge) > 1)
               and (   (index(badge, "Э") != 0)
                    or (index(badge, "Р") != 0)
                   );
    end;

    macro isNotRegistrar(badge)
        return     (badge != null)
               and (strlen(badge) > 1)
               and (   (index(badge, "И") != 0)
                    or (index(badge, "К") != 0)
                    or (index(badge, "Н") != 0)
                   );
    end;

    // Обработать новый междепозитарный счет
    macro NewDepoNumber( number, ID )

        v_DepoNumb = number;

        if (isPart22())

            v_Sum = -CalculateSum(ID);
            v_sumRegistrar = ternary(isRegistrar(v_Badge), -calculateSumRegistrar(id), null);
            v_sumNotRegistrar = ternary(isNotRegistrar(v_Badge), -calculateSumNotRegistrar(id), null);

//            DepoAcc = rcbGetObject ( "RsbDepoAcc711" );
            depoAcc = TRsbDataset("SELECT t_corAccount"
                         + "\n" + "  FROM ormDepAcc"
                         + "\n" + " WHERE " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("t_department", "t_branch")
                         + "\n" + "   AND t_autokey = " + id
                                 );
            depoAcc.next();
            v_CorrNumb = DepoAcc.CorAccount;

        elif (isPart21())

            v_Sum = CalculateSum(ID);
            v_CorrNumb = "";

        end;

    end;

    // Обработать нового субъекта-корреспондента
    macro NewSubject( sub, ID )
        v_Subject = sub;

//        Subject = rcbGetObject( "RSCOMParty711" );
        subject = TRsbDataset("SELECT CASE"
                     + "\n" + "           WHEN EXISTS (SELECT NULL"
                     + "\n" + "                          FROM dpartyown_dbt partyOwn"
                     + "\n" + "                         WHERE partyOwn.t_partyId = " + id
                     + "\n" + "                           AND partyOwn.t_partyKind = 4"
                     + "\n" + "                       )"
                     + "\n" + "           THEN 1"
                     + "\n" + "           ELSE 0"
                     + "\n" + "       END t_isDepository,"
                     + "\n" + "       CASE"
                     + "\n" + "           WHEN EXISTS (SELECT NULL"
                     + "\n" + "                          FROM dpartyown_dbt partyOwn"
                     + "\n" + "                         WHERE partyOwn.t_partyId = " + id
                     + "\n" + "                           AND partyOwn.t_partyKind = 2"
                     + "\n" + "                       )"
                     + "\n" + "           THEN 1"
                     + "\n" + "           ELSE 0"
                     + "\n" + "       END t_isBank,"
                     + "\n" + "       (SELECT code.t_code"
                     + "\n" + "          FROM dpartcode_dbt code"
                     + "\n" + "         WHERE code.t_partyId = " + id
                     + "\n" + "           AND code.t_codeKind = 17"
                     + "\n" + "       ) t_license,"
                     + "\n" + "       CASE"
                     + "\n" + "           WHEN EXISTS (SELECT NULL"
                     + "\n" + "                          FROM dpartyown_dbt partyOwn"
                     + "\n" + "                         WHERE partyOwn.t_partyId = " + id
                     + "\n" + "                           AND partyOwn.t_partyKind = 12"
                     + "\n" + "                       )"
                     + "\n" + "           THEN 1"
                     + "\n" + "           ELSE 0"
                     + "\n" + "       END t_isRegHolder,"
                     + "\n" + "       CASE"
                     + "\n" + "           WHEN EXISTS (SELECT NULL"
                     + "\n" + "                          FROM dpartyown_dbt partyOwn"
                     + "\n" + "                         WHERE partyOwn.t_partyId = " + id
                     + "\n" + "                           AND partyOwn.t_partyKind = 5"
                     + "\n" + "                       )"
                     + "\n" + "           THEN 1"
                     + "\n" + "           ELSE 0"
                     + "\n" + "       END t_isIssuer"
                     + "\n" + "  FROM DUAL"
                             );
        subject.next();

        v_Badge = "";
        v_License = "";

        if (isPart21())

            if (data.isNR)
                v_Badge = "И";
            else
                if (Subject.isDepository and Subject.isBank)
                    v_Badge = "К";
                elif (Subject.isDepository and not Subject.isBank)
                    v_Badge = "Н";
                end;
            end;

            if (RcbApplication().currentReport.context.period.endDate >= RCB_I2742_DATE)
                if (not (data.isNR or (Subject.isRegHolder and Subject.isIssuer)))
                    v_License = Subject.License;
                end;
            elif (not data.isNR)
                v_License = Subject.License;
            end;

        else

            if (data.isNR)
                v_Badge = v_Badge + "И";
            else
                if (Subject.isRegHolder and Subject.isIssuer)
                    v_Badge = v_Badge + "Э";
                end;
                if (Subject.isRegHolder and not Subject.isIssuer)
                    v_Badge = v_Badge + "Р";
                end;
                if (Subject.isDepository and Subject.isBank)
                    v_Badge = v_Badge + "К";
                end;
                if (Subject.isDepository and not Subject.isBank)
                    v_Badge = v_Badge + "Н";
                end;
            end;

            if (RcbApplication().currentReport.context.period.endDate >= RCB_I2742_DATE)
                if (not (data.isNR or (Subject.isRegHolder and Subject.isIssuer)))
                    v_License = Subject.License;
                end;
            elif (not data.isNR)
                v_License = Subject.License;
            end;

        end;

    end;

    macro saveProtocolData(depoId, depoAccountKind, correspondentName, depoAccount, correspondentAccount, copies, isRegistrar)

        var tables;
        var whereClause;

        if (isRegistrar == null)
            tables = tempTable + " " + "account";
            whereClause = "";
        elif (isRegistrar)
            tables = tempTable + " account,"
            + "\n" + "ormFinAvoiriss avoiriss";
            whereClause =
                   "\n" + "   AND avoiriss.t_fiId = account.t_fiId"
                 + "\n" + "   AND avoiriss.t_regHolderId = account.t_partyId";
        else
            tables = tempTable + " account";
            whereClause =
                   "\n" + "   AND NOT EXISTS (SELECT NULL"
                 + "\n" + "                     FROM ormFinAvoiriss avoiriss"
                 + "\n" + "                    WHERE avoiriss.t_fiId = account.t_fiId"
                 + "\n" + "                      AND avoiriss.t_regHolderId = account.t_partyId"
                 + "\n" + "                  )";
        end;

        protocolDepoId = protocolDepoId + 1;

        sql_execute("INSERT INTO " + TempTable2
           + "\n" + "("
           + "\n" + " t_depoAccountKind,"
           + "\n" + " t_correspondentName,"
           + "\n" + " t_depoId,"
           + "\n" + " t_depoAccount,"
           + "\n" + " t_correspondentAccount,"
           + "\n" + " t_account,"
           + "\n" + " t_copies"
           + "\n" + ")"
           + "\n" + "SELECT " + getSqlString(depoAccountKind) + ","
           + "\n" + "       " + getSqlString(correspondentName) + ","
           + "\n" + "       " + protocolDepoId + ","
           + "\n" + "       " + getSqlString(depoAccount) + ","
           + "\n" + "       " + getSqlString(nvl(correspondentAccount, "")) + ","
           + "\n" + "       " + getSqlString("") + ","
           + "\n" + "       " + copies
           + "\n" + "  FROM DUAL"
           + "\n" + "UNION ALL"
           + "\n" + "SELECT " + getSqlString(depoAccountKind) + ","
           + "\n" + "       " + getSqlString(correspondentName) + ","
           + "\n" + "       " + protocolDepoId + ","
           + "\n" + "       " + getSqlString(depoAccount) + ","
           + "\n" + "       " + getSqlString(nvl(correspondentAccount, "")) + ","
           + "\n" + "       account.t_account,"
           + "\n" + "       account.t_rest"
           + "\n" + "  FROM " + tables
           + "\n" + " WHERE account.t_depoId = " + depoId
           + "\n" + "   AND account.t_account != " + getSqlString("")
           + "\n" + "   AND account.t_codeFi != " + getSqlString("")
           +        whereClause
                   );

    end;

    // Добавить значение к структурной переменной
    macro addToStructVar(depoId);

        var currentItem;
        var number = v_DepoNumb;
        var badgeNumber = 0;
        var badgesCount = strLen(v_Badge);
        var sum;

        if (isPart22())
            number = v_CorrNumb;
        end;

        while (badgeNumber < ternary((v_Badge == NULL) or (badgesCount < 1), 1, badgesCount))

            badgeNumber = badgeNumber + 1;
            sum = v_Sum;

            if (isPart21())
                currentItem = RcbApplication().currentReport().attributeValue("Ф711_2_1").addValue(RCB_NEW_VALUE_ID);
                v_kind = "ЛОРО";
            elif (isPart22())
                currentItem = RcbApplication().currentReport().attributeValue("Ф711_2_2").addValue(RCB_NEW_VALUE_ID);
                v_kind = "НОСТРО";

                if (isRegistrar(substr(v_Badge, badgeNumber, 1) + mkstr("_", badgesCount - 1)))
                    sum = v_sumRegistrar;
                elif (isNotRegistrar(substr(v_Badge, badgeNumber, 1) + mkstr("_", badgesCount - 1)))
                    sum = v_sumNotRegistrar;
                end;
            end;

            if (v_Subject == NULL)
                currentItem.fieldValue("Наименование депозитария").setUndefined();
            else
                currentItem.fieldValue("Наименование депозитария").exact = v_Subject;
            end;

            if ( (v_License == NULL) or (v_License == "")
              or (    (RcbApplication().currentReport.context.period.endDate < RCB_I2742_DATE)
                  and (    (index(v_Badge, "К") != badgeNumber) // не депозитарий
                       and (index(v_Badge, "Н") != badgeNumber) // не депозитарий
                      )
                 )
               )
                   currentItem.fieldValue("Лицензия участника ОРЦБ").setUndefined();
            else
                currentItem.fieldValue("Лицензия участника ОРЦБ").exact = v_License;
            end;

            if ((v_Badge == NULL) or (badgesCount < 1))
                currentItem.fieldValue("Признак депозитария").setUndefined();
            else
                currentItem.fieldValue("Признак депозитария").exact = subStr(v_Badge, badgeNumber, 1);
            end;

            if (number == NULL)
                currentItem.fieldValue("Междепозитарный счет").setUndefined();
            else
                currentItem.fieldValue("Междепозитарный счет").exact = number;
            end;

            if (sum == NULL)
                currentItem.fieldValue("Количество ц/б на счете").setUndefined();
            else
                currentItem.fieldValue("Количество ц/б на счете").exact = sum;
            end;

            if (RcbApplication().currentReport.context.period.endDate >= RCB_I2055_DATE2)

                // Для проверки берем текущий признак (один символ) и присоединяем к нему (badgesCount - 1) символов подчеркивания.
                // Если изначально в списке символов был один символ или не было символов, то проверяемая строка будет состоять
                // из одного символа, что автоматически приведет к ветке else. Если же символов было больше одного, то будет проводится
                // проверка на реестродержателя.
                if (isRegistrar(substr(v_Badge, badgeNumber, 1) + mkstr("_", badgesCount - 1)) and isPart22())
                    saveProtocolData(depoId, v_kind, v_subject, v_depoNumb, v_corrNumb, sum, true);
                elif (isNotRegistrar(substr(v_Badge, badgeNumber, 1) + mkstr("_", badgesCount - 1)) and isPart22())
                    saveProtocolData(depoId, v_kind, v_subject, v_depoNumb, v_corrNumb, sum, false);
                else
                    saveProtocolData(depoId, v_kind, v_subject, v_depoNumb, v_corrNumb, sum, null);
                end;

                currentItem.fieldValue("Id счета депо").exact = protocolDepoId;
            end;

        end;

    end;

/* ----------------- Запросы к временной таблице -------------------------- */

    var filedList = sqlGetFieldsString(tempTable) + ", " + "UPPER(t_subject) AS t_sortCorrespondentName";

    var BaseQuery =          "SELECT " + filedList
                    + "\n" + "  FROM " + TempTable
                    + "\n" + " WHERE t_depoKind = " + getSqlChar("П")
                    + "\n" + "   AND t_depoType = 2"
                    + "\n" + "UNION ALL"
                    + "\n" + "SELECT " + filedList
                    + "\n" + "  FROM " + TempTable
                    + "\n" + " WHERE t_depoKind = " + getSqlChar("А")
                    + "\n" + "   AND t_depoType = 22"
                    + "\n" + "   AND t_ownership = " + getSqlString(FOREIGN_SECURITIES)
                    + "\n" + " ORDER BY t_depoType, t_sortCorrespondentName, t_depoNumb, t_account";

/* -------------------- Основной цикл расчета ----------------------------- */
    RcbApplication().currentReport().attributeValue("Ф711_2_1").removeAllValues();
    RcbApplication().currentReport().attributeValue("Ф711_2_2").removeAllValues();

    data = TRsbDataSet( BaseQuery );

    while ( data and data.Next())
        message( "Расчет переменных второго раздела, счета \..." );

        if( first_data )

            first_data = false;
            Protocol.printFreeString("");
            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
                Protocol.PrintHead("Раздел 2 \"Междепозитарные счета\"");
            end;
            NewSubject( data.Subject, data.PartyID );
            NewDepoNumber( data.DepoNumb, data.DepoID );
            addToStructVar(data.depoId);
            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
                Protocol.PrintStringTransferByWord(v_Kind, v_Subject, v_DepoNumb, v_CorrNumb, data.Account, v_Sum, getNoteForAmount(v_Sum));
            end;

        elif( v_Subject != data.Subject )
            Protocol.PrintSeparator();
            NewSubject( data.Subject, data.PartyID );
            NewDepoNumber( data.DepoNumb, data.DepoID );
            addToStructVar(data.depoId);
            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
                Protocol.PrintStringTransferByWord(v_Kind, v_Subject, v_DepoNumb, v_CorrNumb, data.Account, v_Sum, getNoteForAmount(v_Sum));
            end;

        elif( v_DepoNumb != data.DepoNumb )
            NewSubject( data.Subject, data.PartyID );
            NewDepoNumber( data.DepoNumb, data.DepoID );
            addToStructVar(data.depoId);
            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
                Protocol.PrintStringTransferByWord("", "", v_DepoNumb, v_CorrNumb, data.Account, v_Sum, getNoteForAmount(v_Sum));
            end;
        else
            if ((data.Account != StrFor(1)) and (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2))
                if (isPart22())
                    v_Sum = v_Sum - data.Rest;
                    Protocol.PrintStringTransferByWord("", "", "", "", data.Account, -data.Rest, getNoteForAmount(-data.Rest));
                else
                    v_Sum = v_Sum + data.Rest;
                    Protocol.PrintStringTransferByWord("", "", "", "", data.Account, data.Rest, getNoteForAmount(data.Rest));
                end;
            end;
        end;

    end;

    if (not first_data and (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2))
        Protocol.PrintBottom();
    end;

END;

macro printProtocolInterDepo()

    macro printProtocolPart(protocol, dataSource)

        var depoAccountData;

        dataSource.first();
        while (not dataSource.isDone())

            depoAccountData = TRsbDataset(       "SELECT t_depoAccountKind                AS t_depoAccountKind,"
                                        + "\n" + "       t_correspondentName              AS t_correspondentName,"
                                        + "\n" + "       t_depoAccount                    AS t_depoAccount,"
                                        + "\n" + "       NVL(t_correspondentAccount, '') AS t_correspondentAccount,"
                                        + "\n" + "       t_account                        AS t_account,"
                                        + "\n" + "       ABS(t_copies)                    AS t_copies"
                                        + "\n" + "  FROM " + TempTable2
                                        + "\n" + " WHERE t_depoId = " + dataSource.currentItem.fieldValue("Id счета депо").exact
                                        + "\n" + " ORDER BY t_depoAccountKind,"
                                        + "\n" + "          t_correspondentName,"
                                        + "\n" + "          t_depoAccount,"
                                        + "\n" + "          t_account"
                                        );

            depoAccountData.setFieldType("t_copies", V_DOUBLE);

            if (depoAccountData.next())
                protocol.printStringTransferByWord(dataSource.currentItem.fieldValue("Номер п/п").exactAsString,
                                                   depoAccountData.depoAccountKind,
                                                   depoAccountData.correspondentName,
                                                   depoAccountData.depoAccount,
                                                   depoAccountData.correspondentAccount,
                                                   "",
                                                   depoAccountData.copies,
                                                   getNoteForAmount(depoAccountData.copies)
                                                  );
            end;

            while (depoAccountData.next())
                protocol.printStringTransferByWord("",
                                                   "",
                                                   "",
                                                   "",
                                                   "",
                                                   depoAccountData.account,
                                                   depoAccountData.copies,
                                                   getNoteForAmount(depoAccountData.copies)
                                                  );
            end;

            dataSource.next();

        end;

    end;

    var protocol;

    var dataSource;

    var hasData = false;

    protocol = CTableReport();

    protocol.addColumn("N п/п",                              3., AL_CENTER);
    protocol.addColumn("Вид счета",                          6., AL_CENTER);
    protocol.addColumn("Корреспондент",                     20., AL_LEFT);
    protocol.addColumn("Номер счета депо",                  25., AL_LEFT);
    protocol.addColumn("Номер счета депо у корреспондента", 25., AL_LEFT);
    protocol.addColumn("Список лицевых счетов депо",        25., AL_LEFT);
    protocol.addcolumn("Количество ц/б на лицевом счете",   24., AL_RIGHT);
    protocol.addcolumn("Примечание",                        24., AL_LEFT);

    protocol.printFreeString("");
    protocol.printFreeString("Подраздел 1.2 \"Междепозитарные счета\"");
    protocol.printHead("          1.2.1. Данные об остатках на междепозитарных счетах \"ЛОРО\"");

    dataSource = RcbApplication().currentReport.attributeValue("Ф711_2_1").createValueIterator();
    dataSource.setSortOrder(TSubpartition21ValuesSorter());
    hasData = (dataSource.count() > 0);
    printProtocolPart(protocol, dataSource);

    protocol.printBottom();
    protocol.printFreeString("");
    protocol.printHead("          1.2.2. Данные об остатках на междепозитарных счетах и счетах номинального держателя,открытых кредитной организации в других организациях");

    dataSource = RcbApplication().currentReport.attributeValue("Ф711_2_2").createValueIterator();
    dataSource.setSortOrder(TSubpartition22ValuesSorter());
    hasData = hasData or (dataSource.count() > 0);
    printProtocolPart(protocol, dataSource);

    if (hasData)
        protocol.printBottom();
    else
        protocol.printFreeString(strAlign("Нет данных", protocol.getSumLen(), STR_ALIGN_CENTER));
    end;

end;

/* ========== Расчет и сохранение переменных третьего раздела ============= */
// Расчте раздела 3 в соответствии с Указанием 1376-У
// Расчте подраздела 1.3.1 и части 1.3.2 (ЦБ, учтенные на счетах НБ) в соответствии с Указанием 2055-У
private MACRO Department_3()

    var i = 0;

    var tempRecord;

    // Оъект "Субъект"
    var Subject;
    // Объект "Ценная бумага", инициализируем пока в цикле (из-за ошибки SCR 74989)
    var FinInstr;
    // Объект "Инвентарная карточка" депозитария
    var InvCard;

    var data, dataFI, first_data;

    var m_secureId;

    var m_xid;
    var m_collectionEntriesCount;

/* -------- Промежуточные переменные и вспомогательные функции ------------ */

    var v_SubID, v_Emitent, v_INN, v_Ident, v_CodeType, v_TypeEmitent, v_TypeIdent, v_point, v_IssuerId;

    macro isOurBank(bankJoinFieldName : String) : String
        return   "(SELECT NULL"
        + "\n" + "   FROM drepourbank_tmp ourBank"
        + "\n" + "  WHERE " + bankJoinFieldName + " = ourBank.t_partyId"
        + "\n" + ")";
    end;

    macro saveProtocolData(part, secureCode, column, account, amount, purpose, ownerName, isOwnerNotResident, recordType)

        sql_execute(         "INSERT INTO " + TempTable3
                    + "\n" + "("
                    + "\n" + " t_counter,"
                    + "\n" + " t_secureCode,"
                    + "\n" + " t_column,"
                    + "\n" + " t_account,"
                    + "\n" + " t_amount,"
                    + "\n" + " t_purpose,"
                    + "\n" + " t_ownerName,"
                    + "\n" + " t_isOwnerNotResident,"
                    + "\n" + " t_recordType,"
                    + "\n" + " t_id,"
                    + "\n" + " t_part"
                    + "\n" + ")"
                    + "\n" + "SELECT 0,"
                    + "\n" + "       " + getSqlString(secureCode) + ","
                    + "\n" + "       " + getSqlString(column) + ","
                    + "\n" + "       " + getSqlString(account) + ","
                    + "\n" + "       " + amount + ","
                    + "\n" + "       " + getSqlString(purpose) + ","
                    + "\n" + "       " + getSqlString(ownerName) + ","
                    + "\n" + "       " + getSqlString(ternary(isOwnerNotResident, "X", "")) + ","
                    + "\n" + "       " + recordType + ","
                    + "\n" + "       " + m_secureId + ","
                    + "\n" + "       " + getSqlString(part)
                    + "\n" + "  FROM DUAL"
                    );

    end;

    // Обработать нового эмитента инвентарной карточки
    macro processNewInvIssuer()
        v_IssuerId = InvCard.IssuerID;

        v_SubID = InvCard.IssuerCode;
        if( FinInstr.SecurKind == "MFUN" )
            v_Emitent = InvCard.Issuer_FullName + "(" + FinInstr.InvstName + ")";
            if( (v_Emitent == NULL) or (v_Emitent == "") )
                v_Emitent = InvCard.Issuer_ShortName + "(" + FinInstr.InvstName + ")";
            end;
        elif( FinInstr.SecurKind == "BIL" and (InvCard.Issuer_isPhysical) )
            v_Emitent = InvCard.Issuer_FullName;
        else
            v_Emitent = InvCard.Issuer_FullName;
            if( (v_Emitent == NULL) or (v_Emitent == "") )
                v_Emitent = InvCard.Issuer_ShortName;
            end;
        end;

        if( InvCard.Issuer_IsNonResident )
            if( InvCard.Issuer_IsPhysical )
                v_TypeEmitent = "02";
            else
                v_TypeEmitent = "01";
            end;
            v_INN = GetCountryCode( InvCard.Issuer_CountryLat3 );
            if( (v_INN == NULL) or (v_INN == "") )
                v_INN = "999";
            end;
            if( InvCard.IsInternationalOrganization)
                v_INN == "998";
            end;
        else
            if( InvCard.Issuer_IsPhysical )
                v_TypeEmitent = "12";
                if ((InvCard.Issuer_INN == null) or (InvCard.Issuer_INN == ""))
                    v_INN = mkStr("0", 12);
                else
                    v_INN = InvCard.Issuer_INN;
                end;
            else
                v_TypeEmitent = "11";
                if ((InvCard.Issuer_INN == null) or (InvCard.Issuer_INN == ""))
                    v_INN = mkStr("0", 10);
                else
                    v_INN = SubStr( InvCard.Issuer_INN, 1, 10 );
                end;
            end;
        end;
        v_CodeType = InvCard.Code711Name;
        if( (v_CodeType == NULL) or (v_CodeType == "") )
            v_CodeType = FinInstr.Code711Name;
        end;

        if(v_CodeType == "ENC")
            v_TypeEmitent = "12";
        end;

        v_Ident = "";
        v_TypeIdent = "";
    end;

    // Обработать нового эмитента ценной бумаги
    macro processNewIssuer()
        v_IssuerId = FinInstr.IssuerID;

        if( FinInstr.SecurKind == "MFUN" )
            v_Emitent = FinInstr.Issuer_FullName + "(" + FinInstr.InvstName + ")";
            if( (v_Emitent == NULL) or (v_Emitent == "") )
                v_Emitent = FinInstr.Issuer_ShortName + "(" + FinInstr.InvstName + ")";
            end;
        elif( FinInstr.SecurKind == "BIL" and (FinInstr.Issuer_isPhysical) )
            v_Emitent = FinInstr.Issuer_FullName;
        else
            v_Emitent = FinInstr.Issuer_FullName;
            if( (v_Emitent == NULL) or (v_Emitent == "") )
                v_Emitent = FinInstr.Issuer_ShortName;
            end;
        end;

        if( FinInstr.Issuer_IsNonResident )
            if( FinInstr.Issuer_IsPhysical )
                v_TypeEmitent = "02";
            else
                v_TypeEmitent = "01";
            end;
            v_Ident = FinInstr.ISIN;
            v_TypeIdent = "2";
            v_INN = GetCountryCode( FinInstr.Issuer_CountryLat3 );
            if( (v_INN == NULL) or (v_INN == "") )
                v_INN = "999";
            end;
            if( FinInstr.IsInternationalOrganization)
                v_INN == "998";
            end;
        else
            if( FinInstr.Issuer_IsPhysical )
                v_TypeEmitent = "12";
                if ((Fininstr.Issuer_INN == null) or (Fininstr.Issuer_INN == ""))
                    v_INN = mkStr("0", 12);
                else
                    v_INN = Fininstr.Issuer_INN;
                end;
            else
                v_TypeEmitent = "11";
                if ((Fininstr.Issuer_INN == null) or (Fininstr.Issuer_INN == ""))
                    v_INN = mkStr("0", 10);
                else
                    v_INN = SubStr( Fininstr.Issuer_INN, 1, 10 );
                end;
            end;
            v_Ident = FinInstr.LSIN;
            v_TypeIdent = "1";
            if( (v_Ident == NULL) or (v_Ident == "") )
                v_Ident = FinInstr.ISIN;
                v_TypeIdent = "2";
            end;
        end;

        if (FinInstr.isIndividual == 1)
            v_Ident = "";
        end;

        v_CodeType = FinInstr.Code711Name;

        if(v_CodeType == "ENC")
            v_TypeEmitent = "12";
        end;
        if ((v_Ident == null) or (v_Ident == ""))
            v_TypeIdent = "";
        end;

    end;

    var v_Values, v_NominalFI, v_Nominal, v_activeAccountOwnerId;
    var MinValColumn = TArray;      // Номера граф, с которых начинаются значения "количество ц/б"..
    var AmountValColumn = TArray;   // Количество граф, содержащих значения "количество ц/б"..
    MinValColumn[0] = 32;   AmountValColumn[0] = 12;    // .. для таблицы 3.1
    MinValColumn[1] = 50;   AmountValColumn[1] = 6;     // .. для таблицы 3.2

    // Инициализировать массив значений для последующего заполнения и добавления в структурную переменную
    macro initValuesArray(i);
        v_Values = arrCreate(v_Emitent, v_INN, v_CodeType, v_Ident, v_NominalFI, v_Nominal);
        var j = 0;
        while (j < AmountValColumn[i])
            v_Values[j+6] = 0.0;
            j = j + 1;
        end;
        v_Values[j+6] = v_TypeEmitent;
        v_Values[j+7] = v_TypeIdent;
    end;

    // Получить номер графы, в которую войдут данные по конкретным ц/б на конкретном л/с
    macro GetColumn( data, i )
        var type = data.DepoType;
        var isNR = data.isNR;

        if (i)
            if( type == 0 )
                return 0;
            elif( type == 1 )
                return 50;
            elif( type == 4 )
                return 51;
            elif( type == 3 )
                return 52;
            elif( type == 5 )
                return 53;
            elif( type == 6 )
                return 54;
            else
                return 55;
            end;
        elif( type == 7 )
            return 43;
        elif( type == 6 )
            return 42;
        elif( type == 5 )
            return 41;
        elif( type == 3 )
            return 40;
        elif( type == 4 )
            if (isNR)
                return 39;
            else
                return 38;
            end;
        elif( type == 2 )
            if (isNR)
                return 37;
            else

//                Subject = rcbGetObject( "RSCOMParty711" );
                subject = TRsbDataset("SELECT CASE"
                             + "\n" + "           WHEN EXISTS (SELECT NULL"
                             + "\n" + "                          FROM dpartyown_dbt partyOwn"
                             + "\n" + "                         WHERE partyOwn.t_partyId = " + data.partyId
                             + "\n" + "                           AND partyOwn.t_partyKind = 2"
                             + "\n" + "                       )"
                             + "\n" + "           THEN 1"
                             + "\n" + "           ELSE 0"
                             + "\n" + "       END t_isBank"
                             + "\n" + "  FROM DUAL"
                                     );

                Subject.Next();
                if (Subject.IsBank)
                    // Если данные входят в две графы (например, 36 и 35), возвращается
                    //  большее значение, далее это будет обработано
                    return 36;
                else
                    return 35;
                end;
            end;
        elif( type == 1 )
            if (isNR)
                return 34;
            else

//                Subject = rcbGetObject( "RSCOMParty711" );
                subject = TRsbDataset("SELECT CASE"
                             + "\n" + "           WHEN EXISTS (SELECT NULL"
                             + "\n" + "                          FROM dpartyown_dbt partyOwn"
                             + "\n" + "                         WHERE partyOwn.t_partyId = " + data.partyId
                             + "\n" + "                           AND partyOwn.t_partyKind = 2"
                             + "\n" + "                       )"
                             + "\n" + "           THEN 1"
                             + "\n" + "           ELSE 0"
                             + "\n" + "       END t_isBank"
                             + "\n" + "  FROM DUAL"
                                     );

                Subject.Next();
                if (Subject.IsBank)
                    return 33;
                else
                    return 32;
                end;
            end;
        else
            return 0;
        end;
    end;

    // Получить запись из временной таблицы, относящуюся к конкретному л/с
    macro GetTempRecord( account, code )
        data = TRsbDataSet( "SELECT DISTINCT t_DepoType, t_Subject, t_PartyID, t_isNR, t_DepoType1, t_DepoPart FROM " + TempTable +
                            " WHERE t_Account = '" + account + "' AND t_CodeFI = '" +  code + "'");
        if( data and data.Next() )
            return data;
        else
            return NULL;
        end;
    end;

    var v_Code;
    var v_Account;

    // Обработать данные по коллекции ИК на конкретном л/с
    macro processColumnInv(data, col, i, part, secureCode, amount, recordType)

        var ind = col - MinValColumn[i] + 6;
        var column = "0";

        if (col)
            v_Values[ind] = v_Values[ind] + amount;
        end;

        if (col > 0)
            column = string(col + 5 +i);
        end;
        // Внести данные по л/с банков также и в общие данные по резидентам
        if( (col == 33) or (col == 36) )
            column = string("(", col + 4, ",", col + 5, ")");
            v_Values[ind-1] = v_Values[ind-1] + amount;
        end;

        if (part == "1.3.1")
            col = 33;
        elif (part == "1.3.2")
            col = 52;
        end;

        if ((v_Values[2] == NULL) OR (valType(v_Values[2]) == V_UNDEF))
            saveProtocolData(part,
                            secureCode,
                            col,
                            "",
                            0,
                            "",
                            "",
                            "",
                            recordType
                            );
        end;

        saveProtocolData(part,
                        secureCode,
                        column,
                        v_account,
                        amount,
                        getTypeDescription(data.depoType),
                        data.subject,
                        data.isNr == 1,
                        recordType
                        );
    end;

    // Обработать данные по ц/б на конкретном л/с
    macro processColumn(data, col, i, part)

        var rest = data.Rest;
        var ind = col - MinValColumn[i] + 6;
        var column = "0";

        if (col)
            v_Values[ind] = v_Values[ind] + rest;
        end;

        if (col > 0)
            column = string(col + 5 + i);
        end;
        // Внести данные по л/с банков также и в общие данные по резидентам
        if( (col == 33) or (col == 36) )
            v_Values[ind-1] = v_Values[ind-1] + rest;
            column = string("(", col + 4, ",", col + 5, ")");
        end;

        if (part == "1.3.1")
            col = 33;
        elif (part == "1.3.2")
            col = 52;
        end;

        if ((v_Values[2] == NULL) OR (valType(v_Values[2]) == V_UNDEF))
            saveProtocolData(part,
                            v_code,
                            col,
                            "",
                            0,
                            "",
                            "",
                            "",
                            RECORDTYPE_SECURE
                            );
        end;

        saveProtocolData(part,
                        v_code,
                        column,
                        data.account,
                        rest,
                        getTypeDescription(data.depoType),
                        data.subject,
                        data.isNr == 1,
                        RECORDTYPE_SECURE
                        );
    end;

    // Добавить структурное значение к переменной
    macro addToStructVar(values, secureId, dataSet)

        var currentItem;
        var j = 0;      // SCR 78872

        while (j < 6)
            if (values[j] == NULL)
                values[j] = "";
            end;
            j = j + 1;
        end;

        if(i)
            currentItem = RcbApplication().currentReport().attributeValue("Ф711_3_2").addValue(RCB_NEW_VALUE_ID);

            currentItem.fieldValue("Эмитент").exact = values[0];
            currentItem.fieldValue("ИНН эмитента").exact = values[1];
            currentItem.fieldValue("Код типа ц/б").exact = values[2];
            if (in(values[2], "SHS7", "SHS71", "SHS8"))
                currentItem.fieldValue("Идентификатор ц/б").exact = "";
            else
                currentItem.fieldValue("Идентификатор ц/б").exact = values[3];
            end;
            currentItem.fieldValue("Валюта ц/б").exact = ternary(values[5] == 0, 0, values[4]);
            if (in(values[2], "DR", "SHS7", "SHS71", "SHS8", "OPN"))
                currentItem.fieldValue("Номинал ц/б").exact = 0;
            else
                currentItem.fieldValue("Номинал ц/б").exact = values[5];
            end;
            currentItem.fieldValue("Графа 50").exact = values[6];
            currentItem.fieldValue("Графа 51").exact = values[7];
            currentItem.fieldValue("Графа 52").exact = values[8];
            currentItem.fieldValue("Графа 53").exact = values[9];
            currentItem.fieldValue("Графа 54").exact = values[10];
            currentItem.fieldValue("Графа 55").exact = values[11];

            if (RcbApplication().currentReport.context.period.endDate >= RCB_I2627_DATE)
                currentItem.fieldValue("Графа 62").exact = dataSet.t_column62;
                currentItem.fieldValue("Графа 63").exact = dataSet.t_column63;
                currentItem.fieldValue("Графа 64").exact = dataSet.t_column64;
                currentItem.fieldValue("Графа 65").exact = dataSet.t_column65;
            end;

            currentItem.fieldValue("Тип эмитента").exact = values[12];
            currentItem.fieldValue("Способ заполнения номера").exact = values[13];
            currentItem.fieldValue("Точность номинала ц/б").exact = nvl(v_point, 0);
            currentItem.fieldValue("Id ц/б для протокола").exact = secureId;
            currentItem.fieldValue("ID эмитента").exact = nvl(v_IssuerId,0);
        else
            currentItem = RcbApplication().currentReport().attributeValue("Ф711_3_1").addValue(RCB_NEW_VALUE_ID);

            currentItem.fieldValue("Эмитент").exact = values[0];
            currentItem.fieldValue("ИНН эмитента").exact = values[1];
            currentItem.fieldValue("Код типа ц/б").exact = values[2];
            if (in(values[2], "SHS7", "SHS71", "SHS8"))
                currentItem.fieldValue("Идентификатор ц/б").exact = "";
            else
                currentItem.fieldValue("Идентификатор ц/б").exact = values[3];
            end;
            currentItem.fieldValue("Валюта ц/б").exact = ternary(values[5] == 0, 0, values[4]);
            if (in(values[2], "DR", "SHS7", "SHS71", "SHS8", "OPN"))
                currentItem.fieldValue("Номинал ц/б").exact = 0;
            else
                currentItem.fieldValue("Номинал ц/б").exact = values[5];
            end;
            currentItem.fieldValue("Графа 32").exact = values[6];
            currentItem.fieldValue("Графа 33").exact = values[7];
            currentItem.fieldValue("Графа 34").exact = values[8];
            currentItem.fieldValue("Графа 35").exact = values[9];
            currentItem.fieldValue("Графа 36").exact = values[10];
            currentItem.fieldValue("Графа 37").exact = values[11];
            currentItem.fieldValue("Графа 38").exact = values[12];
            currentItem.fieldValue("Графа 39").exact = values[13];
            currentItem.fieldValue("Графа 40").exact = values[14];
            currentItem.fieldValue("Графа 41").exact = values[15];
            currentItem.fieldValue("Графа 42").exact = values[16];
            currentItem.fieldValue("Графа 43").exact = values[17];
            currentItem.fieldValue("Тип эмитента").exact = values[18];
            currentItem.fieldValue("Способ заполнения номера").exact = values[19];
            currentItem.fieldValue("Точность номинала ц/б").exact = nvl(v_point, 0);
            currentItem.fieldValue("Id ц/б для протокола").exact = secureId;
            currentItem.fieldValue("ID эмитента").exact = nvl(v_IssuerId,0);
        end;

    end;

/* ----------------- Запросы к временной таблице -------------------------- */

    var BaseFIQuery =          "SELECT DISTINCT t_codeFi"
                        + "\n" + "  FROM"
                        + "\n" + TempTable
                        + "\n" + " WHERE t_depoKind = 'П'"
                        + "\n" + "   AND t_codeFi <> CHR(1)"
                        + "\n" + "   AND t_rest <> 0";

    var EndFIQuery = " ORDER BY t_codeFi";
    var BaseQuery = "SELECT * FROM " + TempTable + " WHERE t_depoKind = 'П'";
    var EndQuery = "ORDER BY t_subject, t_depoNumb, t_account";
    var Query = TArray;
    // Условие для таблицы 3.1
    Query[0] = " AND t_partyId NOT IN " + QueryOurBanks + " AND t_depoType NOT IN (0, 98)";
    // Условие для таблицы 3.2
    Query[1] = " AND t_partyId IN " + QueryOurBanks + " AND t_depoType NOT IN (0, 98)";

/* -------------------- Основной цикл расчета ----------------------------- */
var v_Column, v_Name, filter;
var hasData;

while( i < 2 )

    m_secureId = 0;

    dataFI = TRsbDataSet( BaseFIQuery + Query[i] + EndFIQuery );
    while( dataFI and dataFI.Next() )
        // Находим объект "Ценная бумага"
//        FinInstr = rcbGetObject( "RSCOMAvoiriss711" );

        filter = "avoiriss.t_fi_code = '" + dataFI.CodeFI + "'";

        if (RcbApplication().currentReport.context.period.endDate >= RCB_I2055_DATE2)
            filter = filter
            + "\n" + "AND (   avoiriss.t_code711Name IS NULL"
            + "\n" + "     OR avoiriss.t_code711Name != " + getSqlString("ENC")
            + "\n" + "     OR (    avoiriss.t_code711Name = " + getSqlString("ENC")
            + "\n" + "         AND NOT EXISTS (SELECT NULL"
            + "\n" + "                           FROM dparty_dbt party"
            + "\n" + "                          WHERE party.t_partyId = avoiriss.t_issuerId"
            + "\n" + "                            AND party.t_legalForm = 2"
            + "\n" + "                        )"
            + "\n" + "        )"
            + "\n" + "    )";
        end;

        finInstr = "SELECT avoiriss.t_fi_code                               AS t_fi_code,"
          + "\n" + "       avoiriss.t_isIndividual                          AS t_isIndividual,"
          + "\n" + "       avoiriss.t_avoirKind                             AS t_avoirKind,"
          + "\n" + "       NVL((SELECT fi.t_iso_number"
          + "\n" + "              FROM dfininstr_dbt fi"
          + "\n" + "             WHERE fi.t_fiId = avoiriss.t_faceValueFiId"
          + "\n" + "           ), 0)                                        AS t_faceValueFiCode,"
          + "\n" + "       avoiriss.t_faceValue                             AS t_faceValue,"
          + "\n" + "       avoiriss.t_point + 2                             AS t_point,"
          + "\n" + "       avoiriss.t_securKind                             AS t_securKind,"
          + "\n" + "       avoiriss.t_invstName                             AS t_invstName,"
          + "\n" + "       avoiriss.t_code711Name                           AS t_code711Name,"
          + "\n" + "       (SELECT party.t_name"
          + "\n" + "          FROM dparty_dbt party"
          + "\n" + "         WHERE party.t_partyId = avoiriss.t_issuerId"
          + "\n" + "       )                                                AS t_issuer_fullName,"
          + "\n" + "       (SELECT SUBSTR(party.t_shortName, 1, 60)"
          + "\n" + "          FROM dparty_dbt party"
          + "\n" + "         WHERE party.t_partyId = avoiriss.t_issuerId"
          + "\n" + "       )                                                AS t_issuer_shortName,"
          + "\n" + "       (SELECT party.t_isPhisical"
          + "\n" + "          FROM drepparty_vw party"
          + "\n" + "         WHERE party.t_id = avoiriss.t_issuerId"
          + "\n" + "       )                                                AS t_issuer_isPhysical,"
          + "\n" + "       (SELECT DECODE(party.t_isResident, 1, 0, 1)"
          + "\n" + "          FROM drepparty_vw party"
          + "\n" + "         WHERE party.t_id = avoiriss.t_issuerId"
          + "\n" + "       )                                                AS t_issuer_isNonResident,"
          + "\n" + "       DECODE(avoiriss.t_isEmissive, 'X',avoiriss.t_isin,'') AS t_isin,"
          + "\n" + "       (SELECT party.t_countryCode"
          + "\n" + "          FROM drepparty_vw party"
          + "\n" + "         WHERE party.t_id = avoiriss.t_issuerId"
          + "\n" + "       )                                                AS t_issuer_countryLat3,"
          + "\n" + "       NVL((SELECT 1"
          + "\n" + "              FROM dpartyown_dbt partyown"
          + "\n" + "             WHERE partyown.t_partyid = avoiriss.t_issuerId"
          + "\n" + "               AND partyown.t_partykind = 34), 0)       AS t_isInternationalOrganization,"
          + "\n" + "       rsb_rep_pt.get_partyCode(" + PTCK_INN + ","
          + "\n" + "                                avoiriss.t_issuerId,"
          + "\n" + "                            " + getSqlDate(ДатаОтчета) + ","
          + "\n" + "                                1)                      AS t_issuer_inn,"
          + "\n" + "       DECODE(avoiriss.t_isEmissive, 'X',avoiriss.t_lsin,'') AS t_lsin,"
          + "\n" + "       avoiriss.t_issuerId                              AS t_issuerId,"
          + "\n" + "       NVL(avoiriss.t_regHolderId, -1)                  AS t_registrarId,"
          + "\n" + "       avoiriss.t_isDocumentary                         AS t_isDocumentary"
          + "\n" + "  FROM (SELECT avoiriss.*,"
          + "\n" + "               rsb_fiinstr.FI_IsSecurIndividual(avoiriss.t_fiId) AS t_isIndividual,"
          + "\n" + "               (CASE"
          + "\n" + "                    WHEN rsb_fiinstr.fi_avrKindsGetRoot(2, avoiriss.t_avoirKind) = 10"
          + "\n" + "                    THEN NVL((SELECT t_issuer"
          + "\n" + "                                FROM ormFinAvoiriss baseFi"
          + "\n" + "                               WHERE baseFi.t_objectId = (SELECT t_AttrID"
          + "\n" + "                                                            FROM DOBJLINK_DBT"
          + "\n" + "                                                           WHERE t_ObjectID = avoiriss.t_objectId"
          + "\n" + "                                                             AND t_ObjectType = 12"
          + "\n" + "                                                             AND t_GroupID = 10"
          + "\n" + "                                                         )"
          + "\n" + "                             ), -1"
          + "\n" + "                            )"
          + "\n" + "                    ELSE avoiriss.t_issuer"
          + "\n" + "                END"
          + "\n" + "               ) AS t_issuerId,"
          + "\n" + "               (SELECT att.t_name"
          + "\n" + "                  FROM dobjattr_dbt att,"
          + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
          + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
          + "\n" + "                               atc.t_objectType AS t_realObjectType,"
          + "\n" + "                               atc.t_groupId AS t_realGroupId,"
          + "\n" + "                               atc.t_attrId t_attrId,"
          + "\n" + "                               atc.t_object t_object,"
          + "\n" + "                               atc.t_validToDate t_validToDate,"
          + "\n" + "                               atc.t_validFromDate t_validFromDate"
          + "\n" + "                          FROM dobjatcor_dbt atc,"
          + "\n" + "                               dobjgroup_dbt grp"
          + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
          + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
          + "\n" + "                           AND atc.t_general = 'X') atc"
          + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
          + "\n" + "                   AND atc.t_objectType = att.t_objectType"
          + "\n" + "                   AND atc.t_groupId = att.t_groupId"
          + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
          + "\n" + "                   AND atc.t_realObjectType = avoiriss.t_objectType"
          + "\n" + "                   AND atc.t_realGroupId = avoiriss.t_code711CategoryNum"
          + "\n" + "                   AND atc.t_object = avoiriss.t_objectId"
          + "\n" + "               ) AS t_code711Name"
          + "\n" + "          FROM ormFinAvoiriss avoiriss"
          + "\n" + "       ) avoiriss"
          + "\n" + " WHERE " + filter;

        finInstr = TRsbDataset(finInstr);
        finInstr.SetFieldType("t_faceValue", V_MONEY);

        if( FinInstr.Next() )
            v_Code = FinInstr.FI_Code;

            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
                message( "Расчет переменных третьего раздела, код ц/б " + string(v_Code) + "..." );
            else
                message( "Расчет переменных подраздела 1.3, код ц/б " + string(v_Code) + "..." );
            end;

            var column62_65FillingInCondition = " (NOT (    activeAccountOwner.t_id = " + m_ourBankId
                                              + "       OR " + getSqlString(finInstr.t_securKind) + " = " + getSqlString("BIL")
                                              + "      )"
                                              + " )";

            // Если ц/б индивидуальная, то это - "толстый ФИ" и ..
            if (finInstr.isIndividual == 1)

                // .. нужно обрабатывать инвентарные карточки
//                invCard = rcbGetObject("RsbDepoInvCard711");
                invCard = "";

                invCard = invCard
                 + "\n" + "SELECT invCard.t_xid                                             AS t_xid,";

                if (i != 0)
                 invCard = invCard
                 + "\n" + "       activeAccountOwner.t_id                                   AS t_activeAccountOwnerId,"
                 + "\n" + "       activeAccountOwner.t_name                                 AS t_activeAccountOwnerName,"
                 + "\n" + "       activeAccountOwner.t_inn                                  AS t_activeAccountOwnerInn,"
                 + "\n" + "       activeAccountOwner.t_orcbNumber                           AS t_activeAccountOwnerOrcbNumber,"
                 + "\n" + "       activeAccountOwner.t_isResident                           AS t_activeAccountOwnerIsResident,"
                 + "\n" + "       activeAccountOwner.t_isBank                               AS t_activeAccountOwnerIsBank,"
                 + "\n" + "       activeAccountOwner.t_isDepositary                         AS t_activeAccOwnertIsDepositary,"
                 + "\n" + "       activeAccountOwner.t_countryCode                          AS t_activeAccOwnerCountryCode,"
                 + "\n" + "       CASE"
                 + "\n" + "           WHEN " + column62_65FillingInCondition
                 + "\n" + "           THEN NVL(activeAccountOwner.t_name, CHR(1))"
                 + "\n" + "           ELSE CHR(1)"
                 + "\n" + "       END                                                       AS t_column62,"
                 + "\n" + "       CASE"
                 + "\n" + "           WHEN " + column62_65FillingInCondition
                 + "\n" + "            AND activeAccountOwner.t_isResident = 1"
                 + "\n" + "           THEN NVL(activeAccountOwner.t_inn, '0000000000')"
                 + "\n" + "           WHEN " + column62_65FillingInCondition
                 + "\n" + "            AND activeAccountOwner.t_isResident != 1"
                 + "\n" + "           THEN NVL(activeAccountOwner.t_countryCode, 999)"
                 + "\n" + "           ELSE CHR(1)"
                 + "\n" + "       END                                                       AS t_column63,"
                 + "\n" + "       CASE"
                 + "\n" + "           WHEN " + column62_65FillingInCondition
                 + "\n" + "            AND (activeAccountOwner.t_isResident = 0 OR invCard.t_issuerId = activeAccountOwner.t_realId)"
                 + "\n" + "           THEN CHR(1)"
                 + "\n" + "         ELSE"
                 + "\n" + "           CASE"
                 + "\n" + "             WHEN " + column62_65FillingInCondition
                 + "\n" + "              AND NOT (activeAccountOwner.t_isResident = 0 OR invCard.t_issuerId = activeAccountOwner.t_realId)"
                 + "\n" + "             THEN"
                 + "\n" + "               CASE"
                 + "\n" + "                 WHEN " + ternary(finInstr.code711Name, getSqlString(finInstr.code711Name), "NULL") + " IN ('SHS7', 'SHS71', 'SHS8')"
                 + "\n" + "                  AND activeAccountOwner.t_specDepoLicenseNumber IS NOT NULL"
                 + "\n" + "                 THEN activeAccountOwner.t_specDepoLicenseNumber"
                 + "\n" + "                 ELSE NVL(activeAccountOwner.t_orcbNumber, CHR(1))"
                 + "\n" + "               END"
                 + "\n" + "             ELSE CHR(1)"
                 + "\n" + "           END"
                 + "\n" + "       END                                                         AS t_column64,"
                 + "\n" + "       CASE"
                 + "\n" + "           WHEN (   CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isResident = 0"
                 + "\n" + "                         THEN 'И'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isIssuer = 1"
                 + "\n" + "                         THEN 'Э'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isIssuer = 0"
                 + "\n" + "                         THEN 'Р'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isBank = 1"
                 + "\n" + "                         THEN 'К'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isBank = 0"
                 + "\n" + "                         THEN 'Н'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                ) IS NULL"
                 + "\n" + "           THEN CHR(1)"
                 + "\n" + "           WHEN LENGTH(   CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                                AND activeAccountOwner.t_isResident = 0"
                 + "\n" + "                               THEN 'И'"
                 + "\n" + "                               ELSE NULL"
                 + "\n" + "                          END"
                 + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                                AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                                AND activeAccountOwner.t_isIssuer = 1"
                 + "\n" + "                               THEN 'Э'"
                 + "\n" + "                               ELSE NULL"
                 + "\n" + "                          END"
                 + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                                AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                                AND activeAccountOwner.t_isIssuer = 0"
                 + "\n" + "                               THEN 'Р'"
                 + "\n" + "                               ELSE NULL"
                 + "\n" + "                          END"
                 + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                                AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                                AND activeAccountOwner.t_isBank = 1"
                 + "\n" + "                               THEN 'К'"
                 + "\n" + "                               ELSE NULL"
                 + "\n" + "                          END"
                 + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                                AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                                AND activeAccountOwner.t_isBank = 0"
                 + "\n" + "                               THEN 'Н'"
                 + "\n" + "                               ELSE NULL"
                 + "\n" + "                          END"
                 + "\n" + "                      ) = 1"
                 + "\n" + "           THEN (   CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isResident = 0"
                 + "\n" + "                         THEN 'И'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isIssuer = 1"
                 + "\n" + "                         THEN 'Э'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isIssuer = 0"
                 + "\n" + "                         THEN 'Р'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isBank = 1"
                 + "\n" + "                         THEN 'К'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                 + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "                          AND activeAccountOwner.t_isBank = 0"
                 + "\n" + "                         THEN 'Н'"
                 + "\n" + "                         ELSE NULL"
                 + "\n" + "                    END"
                 + "\n" + "                )"
                 + "\n" + "           WHEN activeAccountOwner.t_realId = " + finInstr.t_registrarId
                 + "\n" + "            AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "            AND activeAccountOwner.t_isIssuer = 1"
                 + "\n" + "           THEN 'Э'"
                 + "\n" + "           WHEN activeAccountOwner.t_realId = " + finInstr.t_registrarId
                 + "\n" + "            AND activeAccountOwner.t_isRegistrar = 1"
                 + "\n" + "            AND activeAccountOwner.t_isIssuer = 0"
                 + "\n" + "           THEN 'Р'"
                 + "\n" + "           WHEN activeAccountOwner.t_realId != " + finInstr.t_registrarId
                 + "\n" + "            AND activeAccountOwner.t_isResident = 0"
                 + "\n" + "           THEN 'И'"
                 + "\n" + "           WHEN activeAccountOwner.t_realId != " + finInstr.t_registrarId
                 + "\n" + "            AND activeAccountOwner.t_isDepositary = 1"
                 + "\n" + "            AND activeAccountOwner.t_isBank = 0"
                 + "\n" + "           THEN 'Н'"
                 + "\n" + "           ELSE CHR(1)"
                 + "\n" + "       END                                                       AS t_column65,"
                end;

                 invCard = invCard
                 + "\n" + "       rsb_rep_pt.get_partyCode(" + PTCK_CONTR + ","
                 + "\n" + "                                invCard.t_issuerId,"
                 + "\n" + "                            " + getSqlDate(ДатаОтчета) + ","
                 + "\n" + "                                1)                               AS t_issuerCode,"
                 + "\n" + "       NVL((SELECT fi.t_iso_number"
                 + "\n" + "              FROM dfininstr_dbt fi"
                 + "\n" + "             WHERE fi.t_fiId = invCard.t_faceValueFiId"
                 + "\n" + "           ), 0)                                                 AS t_faceValueFiCode,"
                 + "\n" + "       (SELECT party.t_name"
                 + "\n" + "          FROM dparty_dbt party"
                 + "\n" + "         WHERE party.t_partyId = invCard.t_issuerId"
                 + "\n" + "       )                                                         AS t_issuer_fullName,"
                 + "\n" + "       invCard.t_faceValue                                       AS t_faceValue,"
                 + "\n" + "       (SELECT fi.t_point + 2"
                 + "\n" + "          FROM dfininstr_dbt fi"
                 + "\n" + "         WHERE fi.t_fiId = invCard.t_faceValueFiId"
                 + "\n" + "       )                                                         AS t_point,"
                 + "\n" + "       invCard.t_hAccount                                        AS t_hAccount,"
                 + "\n" + "       invCard.t_issuerId                                        AS t_issuerId,"
                 + "\n" + "       invCard.t_copies                                          AS t_copies,"
                 + "\n" + "       (SELECT SUBSTR(party.t_shortName, 1, 60)"
                 + "\n" + "          FROM dparty_dbt party"
                 + "\n" + "         WHERE party.t_partyId = invCard.t_issuerId"
                 + "\n" + "       )                                                         AS t_issuer_shortName,"
                 + "\n" + "       (SELECT party.t_isPhisical"
                 + "\n" + "          FROM drepparty_vw party"
                 + "\n" + "         WHERE party.t_id = invCard.t_issuerId"
                 + "\n" + "       )                                                         AS t_issuer_isPhysical,"
                 + "\n" + "       (SELECT DECODE(party.t_isResident, 1, 0, 1)"
                 + "\n" + "          FROM drepparty_vw party"
                 + "\n" + "         WHERE party.t_id = invCard.t_issuerId"
                 + "\n" + "       )                                                         AS t_issuer_isNonResident,"
                 + "\n" + "       (SELECT party.t_countryCode"
                 + "\n" + "          FROM drepparty_vw party"
                 + "\n" + "         WHERE party.t_id = invCard.t_issuerId"
                 + "\n" + "       )                                                         AS t_issuer_countryLat3,"
                 + "\n" + "       NVL((SELECT 1"
                 + "\n" + "              FROM dpartyown_dbt partyown"
                 + "\n" + "             WHERE partyown.t_partyid = invCard.t_issuerId"
                 + "\n" + "               AND partyown.t_partykind = 34), 0)                AS t_isInternationalOrganization,"
                 + "\n" + "       rsb_rep_pt.get_partyCode(" + PTCK_INN + ","
                 + "\n" + "                                invCard.t_issuerId,"
                 + "\n" + "                            " + getSqlDate(ДатаОтчета) + ","
                 + "\n" + "                              1)                                 AS t_issuer_inn,"
                 + "\n" + "       NVL(invCard.t_code711Name, '')                                     AS t_code711Name";

                if (i != 0)
                 invCard = invCard
                 + "\n" + "  FROM df711InvCard_tmp invCard,"
                 + "\n" + "       df711CorAccount_tmp corAccount,"
                 + "\n" + "       df711ActiveAccountOwner_tmp activeAccountOwner";
                else
                 invCard = invCard
                 + "\n" + "  FROM df711InvCard_tmp invCard";
                end;

                 invCard = invCard
                 + "\n" + "   WHERE invCard.t_fi_code = " + getSqlString(v_code)
                 + "\n" + "     AND invCard.t_status = " + getSqlString("На хранении")
                 + "\n" + "     AND (   invCard.t_code711Name != " + getSqlString("ENC")
                 + "\n" + "          OR NOT EXISTS (SELECT NULL"
                 + "\n" + "                           FROM dparty_dbt party"
                 + "\n" + "                          WHERE party.t_partyId = invCard.t_issuerId"
                 + "\n" + "                            AND party.t_legalForm = 2"
                 + "\n" + "                        )"
                 + "\n" + "         )";

                if (i != 0)
                 invCard = invCard
                 + "\n" + "     AND invCard.t_lAccount = corAccount.t_connectAccount"
                 + "\n" + "     AND invCard.t_fiId     = corAccount.t_connectFiID"
                 + "\n" + "     AND activeAccountOwner.t_realId = corAccount.t_ownerId ";
                end;

                invCard = invCard
                 + "\n" + "     AND EXISTS (SELECT NULL"
                 + "\n" + "                   FROM df711ac_tmp account"
                 + "\n" + "                  WHERE account.t_account = invCard.t_hAccount"
                 + "\n" + "                    AND account.t_codeFi = invCard.t_fi_code"
                 + "\n" + "                    AND account.t_depoKind = " + getSqlString("П")
                 + "\n" + "                    AND account.t_depoType NOT IN (0, 98)"
                 + "\n" + "                    AND account.t_rest != 0"
                 + "\n" + "              " + query[i]
                 + "\n" + "           )"
                 + "\n" + "   ORDER BY t_issuerCode,"
                 + "\n" + "            t_faceValueFiCode,"
                 + "\n" + "            t_faceValue,";
                if (i != 0)
                 invCard = invCard
                 + "\n" + "            t_activeAccountOwnerId,";
                end;

                invCard = invCard
                 + "\n" + "            t_hAccount";

                invCard = TRsbDataset(invCard);
                invCard.SetFieldType("t_faceValue", V_MONEY);

                first_data = true;
                // Проходим по всем ИК соответствующим нашему "толстому ФИ" ..
                v_subId = 0;
                v_nominalFi = 0;
                v_nominal = 0;
                v_activeAccountOwnerId = 0;

                m_xid = "";
                m_collectionEntriesCount = 0;
                var v_record : Object;
                while (invCard.next())

                    if (invCard.xid != m_xid)
                        m_xid = invCard.xid;
                        m_collectionEntriesCount = m_collectionEntriesCount + 1;
                    end;

                    // Новая ИК или коллекция ИК
                    if (   (v_subId != invCard.issuerCode)
                        or (v_nominalFi != invCard.faceValueFiCode)
                        or (v_nominal != invCard.faceValue)
                        or ((i != 0) and (v_activeAccountOwnerId != invCard.t_activeAccountOwnerId) and (RcbApplication().currentReport.context.period.endDate >= RCB_I2627_DATE))
                        )

                        if (not first_data)

                            if (v_column != 0)
                                addToStructVar(v_values, m_secureId, v_record);
                            end;

                        else
                            first_data = false;
                        end;

                        m_secureId = m_secureId + 1;
                        v_NominalFI = InvCard.FaceValueFICode;
                        if (i != 0)
                            v_activeAccountOwnerId = invCard.t_activeAccountOwnerId;
                        end;
                        v_Nominal = InvCard.FaceValue;
                        v_point = InvCard.point;
                        m_collectionEntriesCount = 0;

                        processNewInvIssuer();

                        initValuesArray(i);

                    end;

                    v_account = invCard.hAccount;
                    tempRecord = getTempRecord(v_account, v_code);
                    if (tempRecord == null)
                        continue;
                    end;

                    v_column = getColumn(tempRecord, i);

                    processColumnInv(data,
                                    v_column,
                                    i,
                                    ternary(i == 0, "1.3.1", "1.3.2"),
                                    invCard.xid,
                                    invCard.copies,
                                    ternary(m_collectionEntriesCount == 0, RECORDTYPE_INVCARD, RECORDTYPE_COLLECTION));
                    v_record = invCard.getRecord();
                end;

                if (not first_data)

                    if (v_column != 0)
                        addToStructVar(v_values, m_secureId, v_record);
                    end;

                end;

            else

                first_data = true;
                // для "нормальных" ц/б все гораздо проще
                processNewIssuer();

                v_nominalFI = finInstr.faceValueFICode;
                v_nominal = nvl(finInstr.faceValue, "");
                v_point = nvl(finInstr.point, 0);

                initValuesArray(i);
                // Получаем данные по счетам депо и л/с, на которых учитываются
                //  такие ц/б, из временной таблицы

                var queryText =  "SELECT ac.t_subject, ac.t_isNr, ac.t_DepoType, ac.t_partyId, ac.t_account,"
                        + "\n" + "       corAccount.t_rest                                           AS t_rest,"
                        + "\n" + "       activeAccountOwner.t_id                                     AS t_activeAccountOwnerId,"
                        + "\n" + "       activeAccountOwner.t_realId                                 AS t_activeAccountOwnerRealId,"
                        + "\n" + "       activeAccountOwner.t_name                                   AS t_activeAccountOwnerName,"
                        + "\n" + "       activeAccountOwner.t_inn                                    AS t_activeAccountOwnerInn,"
                        + "\n" + "       activeAccountOwner.t_orcbNumber                             AS t_activeAccountOwnerOrcbNumber,"
                        + "\n" + "       activeAccountOwner.t_isResident                             AS t_activeAccountOwnerIsResident,"
                        + "\n" + "       activeAccountOwner.t_isBank                                 AS t_activeAccountOwnerIsBank,"
                        + "\n" + "       activeAccountOwner.t_isDepositary                           AS t_activeAccOwnertIsDepositary,"
                        + "\n" + "       activeAccountOwner.t_countryCode                            AS t_activeAccOwnerCountryCode,"
                        + "\n" + "       CASE"
                        + "\n" + "           WHEN " + column62_65FillingInCondition
                        + "\n" + "           THEN NVL(activeAccountOwner.t_name, CHR(1))"
                        + "\n" + "           ELSE CHR(1)"
                        + "\n" + "       END                                                         AS t_column62,"
                        + "\n" + "       CASE"
                        + "\n" + "           WHEN " + column62_65FillingInCondition
                        + "\n" + "            AND activeAccountOwner.t_isResident = 1"
                        + "\n" + "           THEN NVL(activeAccountOwner.t_inn, '0000000000')"
                        + "\n" + "           WHEN " + column62_65FillingInCondition
                        + "\n" + "            AND activeAccountOwner.t_isResident != 1"
                        + "\n" + "           THEN NVL(activeAccountOwner.t_countryCode, 999)"
                        + "\n" + "           ELSE CHR(1)"
                        + "\n" + "       END                                                         AS t_column63,"
                        + "\n" + "       CASE"
                        + "\n" + "         WHEN " + column62_65FillingInCondition
                        + "\n" + "          AND (activeAccountOwner.t_isResident = 0 OR " + FinInstr.t_issuerId + " = activeAccountOwner.t_realId)"
                        + "\n" + "         THEN CHR(1)"
                        + "\n" + "         ELSE"
                        + "\n" + "           CASE"
                        + "\n" + "             WHEN " + column62_65FillingInCondition
                        + "\n" + "              AND NOT (activeAccountOwner.t_isResident = 0 OR " + FinInstr.t_issuerId + " = activeAccountOwner.t_realId)"
                        + "\n" + "             THEN"
                        + "\n" + "               CASE"
                        + "\n" + "                 WHEN " + ternary(finInstr.code711Name, getSqlString(finInstr.code711Name), "NULL") + " IN ('SHS7', 'SHS71', 'SHS8')"
                        + "\n" + "                  AND activeAccountOwner.t_specDepoLicenseNumber IS NOT NULL"
                        + "\n" + "                 THEN activeAccountOwner.t_specDepoLicenseNumber"
                        + "\n" + "                 ELSE NVL(activeAccountOwner.t_orcbNumber, CHR(1))"
                        + "\n" + "               END"
                        + "\n" + "             ELSE CHR(1)"
                        + "\n" + "           END"
                        + "\n" + "       END                                                         AS t_column64,"
                        + "\n" + "       CASE"
                        + "\n" + "           WHEN (   CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isResident = 0"
                        + "\n" + "                         THEN 'И'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isIssuer = 1"
                        + "\n" + "                         THEN 'Э'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isIssuer = 0"
                        + "\n" + "                         THEN 'Р'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isBank = 1"
                        + "\n" + "                         THEN 'К'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isBank = 0"
                        + "\n" + "                         THEN 'Н'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                ) IS NULL"
                        + "\n" + "           THEN CHR(1)"
                        + "\n" + "           WHEN LENGTH(   CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                                AND activeAccountOwner.t_isResident = 0"
                        + "\n" + "                               THEN 'И'"
                        + "\n" + "                               ELSE NULL"
                        + "\n" + "                          END"
                        + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                                AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                                AND activeAccountOwner.t_isIssuer = 1"
                        + "\n" + "                               THEN 'Э'"
                        + "\n" + "                               ELSE NULL"
                        + "\n" + "                          END"
                        + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                                AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                                AND activeAccountOwner.t_isIssuer = 0"
                        + "\n" + "                               THEN 'Р'"
                        + "\n" + "                               ELSE NULL"
                        + "\n" + "                          END"
                        + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                                AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                                AND activeAccountOwner.t_isBank = 1"
                        + "\n" + "                               THEN 'К'"
                        + "\n" + "                               ELSE NULL"
                        + "\n" + "                          END"
                        + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                                AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                                AND activeAccountOwner.t_isBank = 0"
                        + "\n" + "                               THEN 'Н'"
                        + "\n" + "                               ELSE NULL"
                        + "\n" + "                          END"
                        + "\n" + "                      ) = 1"
                        + "\n" + "           THEN (   CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isResident = 0"
                        + "\n" + "                         THEN 'И'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isIssuer = 1"
                        + "\n" + "                         THEN 'Э'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isIssuer = 0"
                        + "\n" + "                         THEN 'Р'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isBank = 1"
                        + "\n" + "                         THEN 'К'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
                        + "\n" + "                          AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "                          AND activeAccountOwner.t_isBank = 0"
                        + "\n" + "                         THEN 'Н'"
                        + "\n" + "                         ELSE NULL"
                        + "\n" + "                    END"
                        + "\n" + "                )"
                        + "\n" + "           WHEN activeAccountOwner.t_realId = " + finInstr.t_registrarId
                        + "\n" + "            AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "            AND activeAccountOwner.t_isIssuer = 1"
                        + "\n" + "           THEN 'Э'"
                        + "\n" + "           WHEN activeAccountOwner.t_realId = " + finInstr.t_registrarId
                        + "\n" + "            AND activeAccountOwner.t_isRegistrar = 1"
                        + "\n" + "            AND activeAccountOwner.t_isIssuer = 0"
                        + "\n" + "           THEN 'Р'"
                        + "\n" + "           WHEN activeAccountOwner.t_realId != " + finInstr.t_registrarId
                        + "\n" + "            AND activeAccountOwner.t_isResident = 0"
                        + "\n" + "           THEN 'И'"
                        + "\n" + "           WHEN activeAccountOwner.t_realId != " + finInstr.t_registrarId
                        + "\n" + "            AND activeAccountOwner.t_isDepositary = 1"
                        + "\n" + "            AND activeAccountOwner.t_isBank = 0"
                        + "\n" + "           THEN 'Н'"
                        + "\n" + "           ELSE CHR(1)"
                        + "\n" + "       END                                                         AS t_column65"
                        + "\n" + "  FROM df711ac_tmp ac,"
                        + "\n" + "       df711CorAccount_tmp corAccount,"
                        + "\n" + "       df711ActiveAccountOwner_tmp activeAccountOwner"
                        + "\n" + " WHERE ac.t_account = corAccount.t_connectAccount"
                        + "\n" + "   AND ac.t_fiId = corAccount.t_connectFiID"
                        + "\n" + "   AND activeAccountOwner.t_realId = corAccount.t_ownerId "
                        + "\n" + "   AND ac.t_depoKind = 'П'" + query[i] + " AND corAccount.t_rest <> 0 AND ac.t_CodeFI = '" + v_code + "'"
                        + "\n" + " ORDER BY t_activeAccountOwnerId, ac.t_subject, ac.t_depoNumb, ac.t_account";
/*!!!*/
                if (i != 0)
                    data = TRsbDataset(queryText);
                else
                    data = TRsbDataset(baseQuery + query[i] + " AND t_rest <> 0 AND t_CodeFI = '" + v_code + "'" + endQuery);
                end;

                data.SetFieldType("t_faceValue", V_MONEY);

                hasData = false;
                v_activeAccountOwnerId = -1;

                while (data.next())
                    if ((i != 0) and (RcbApplication().currentReport.context.period.endDate >= RCB_I2627_DATE))
                        if (v_activeAccountOwnerId != data.t_activeAccountOwnerId)

                            v_activeAccountOwnerId = data.t_activeAccountOwnerId;

                            if (hasData)
                                addToStructVar(v_values, m_secureId, v_record);
                            end;

                            if (first_data)
                                m_secureId = m_secureId + 1;
                            end;

                            initValuesArray(i);
                        end;

                    else
                        if (first_data)
                            m_secureId = m_secureId + 1;
                            first_data = false;
                        end;
                    end;

                    v_column = getColumn(data, i);

                    if (v_IssuerId == -1)
                        v_column = 0;
                        hasData = false;
                    else
                        hasData = true;
                    end;
                    processColumn(data, v_column, i, ternary(i == 0, "1.3.1", "1.3.2"));

                    first_data = false;
                    v_record = data.getRecord();
                end;

                if (hasData)
                    addToStructVar(v_values, m_secureId, v_record);
                end;
            end;

        end;
    end;
    i = i + 1;
end;

END;


// Расчет части подраздела 1.3.2 (закладные ФЛ) в соответствии с Указанием 2055-У

/**
*  Вспомогательный класс сортировки для класса TDataSourcePart32Mortgage_I2055
*  Сортировка в убывающем порядке
*  @since 6.00.020.29
*  @author ABP
*/
private class TPart32SorterBySecureId()
    macro isLess(value1, value2)
        return value1.fieldValue("Id ц/б для протокола").exact > value2.fieldValue("Id ц/б для протокола").exact;
    end;
end;

/**
*  Класс источника данных для части подраздела 1.3.2 (закладные ФЛ)
*  @since 6.00.020.29
*  @author ABP
*/
class (TDataSource) TDataSourcePart32Mortgage_I2055()

    private var m_secureId;

    macro getValue(attributeName)

        var value;

        if (strUpr(attributeName) == strUpr("secureId"))
            value = m_secureId;
            m_secureId = m_secureId + 1;
        else
            value = getValue(attributeName);
        end;

        return value;

    end;

    private macro constructorTDataSourcePart32Mortgage_I2055()

        var iterator;
        var queryText;
        var dataset;

        initTDataSource();

        iterator = RcbApplication().currentReport.attributeValue("Ф711_3_2").createValueIterator();
        iterator.setSortOrder(TPart32SorterBySecureId());
        iterator.first();
        if (not iterator.isDone())
            m_secureId = iterator.currentItem.fieldValue("Id ц/б для протокола").exact;
        else
            m_secureId = 0;
        end;

        m_secureId = m_secureId + 1;

        queryText = "WITH account"
           + "\n" + "AS"
           + "\n" + "("
           + "\n" + " SELECT DISTINCT t_codeFi AS t_codeFi,"
           + "\n" + "                 t_account AS t_account,"
           + "\n" + "                 t_depoType AS t_purpose,"
           + "\n" + "                 t_isNr AS t_isOwnerNotResident,"
           + "\n" + "                 t_subject AS t_ownerName"
           + "\n" + "   FROM df711ac_tmp"
           + "\n" + "  WHERE t_depoKind = 'П'"
           + "\n" + "    AND t_depoType != 0"
           + "\n" + "    AND t_rest != 0"
           + "\n" + "    AND t_partyId IN (SELECT t_partyId"
           + "\n" + "                        FROM drepourbank_tmp"
           + "\n" + "                     )"
           + "\n" + ")"
           + "\n" + "SELECT NVL(card.t_faceValueFiCode, 0)                              AS t_faceValueFiCode,"
           + "\n" + "       NVL(card.t_xid, CHR(1))                                     AS t_identificator,"
           + "\n" + "       NVL(SUM(card.t_faceValue), 0)                               AS t_faceValue,"
           + "\n" + "       NVL2(fi.t_point, fi.t_point + 2, 0)                         AS t_point,"
           + "\n" + "       NVL(SUM(card.t_copies), 0)                                  AS t_copies,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 1, card.t_copies, 0)), 0) AS t_column56,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 4, card.t_copies, 0)), 0) AS t_column57,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 3, card.t_copies, 0)), 0) AS t_column58,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 5, card.t_copies, 0)), 0) AS t_column59,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 6, card.t_copies, 0)), 0) AS t_column60,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose NOT IN (1,3,4,5,6)"
           + "\n" + "                       THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column61,"
           + "\n" + "       NVL(account.t_purpose, -1)                                  AS t_purpose,"
           + "\n" + "       NVL(account.t_account, CHR(1))                              AS t_account,"
           + "\n" + "       NVL(account.t_ownerName, CHR(1))                            AS t_ownerName,"
           + "\n" + "       NVL(account.t_isOwnerNotResident, 0)                        AS t_isOwnerNotResident,"
           + "\n" + "       (-1)                                                        AS t_issuerId,"
           + "\n" + "       'ENC'                                                       AS t_code711Name,"
           + "\n" + "       'Физические лица'                                           AS t_issuerName,"
           + "\n" + "       CHR(1)                                                      AS t_issuerInn,"
           + "\n" + "       '12'                                                        AS t_issuerType,"
           + "\n" + "       CHR(1)                                                      AS t_identificatorType,"
           + "\n" + "       CASE account.t_purpose"
           + "\n" + "          WHEN 1 THEN 56"
           + "\n" + "          WHEN 4 THEN 57"
           + "\n" + "          WHEN 3 THEN 58"
           + "\n" + "          WHEN 5 THEN 59"
           + "\n" + "          WHEN 6 THEN 60"
           + "\n" + "          ELSE 61"
           + "\n" + "       END                                                         AS t_column"
           + "\n" + "  FROM (SELECT avoiriss.t_fi_code,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = avoiriss.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = avoiriss.t_code711CategoryNum"
           + "\n" + "                   AND atc.t_object = avoiriss.t_objectId"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmFinAvoiriss avoiriss"
           + "\n" + "       ) avoiriss,"
           + "\n" + "       dfininstr_dbt fi,"
           + "\n" + "       (SELECT invCard.t_xid,"
           + "\n" + "               invCard.t_faceValue,"
           + "\n" + "               invCard.t_copies,"
           + "\n" + "               invCard.t_fi_code,"
           + "\n" + "               invCard.t_issuerId,"
           + "\n" + "               invCard.t_faceValueFiId,"
           + "\n" + "               invCard.t_hAccount,"
           + "\n" + "               NVL((SELECT fi.t_iso_number"
           + "\n" + "                      FROM dfininstr_dbt fi"
           + "\n" + "                     WHERE fi.t_fiId = invCard.t_faceValueFiId"
           + "\n" + "                   ), 0) AS t_faceValueFiCode,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = invCard.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = invCard.t_code711Group"
           + "\n" + "                   AND atc.t_object = TO_CHAR(invCard.t_autokey)"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmDepInvCard invCard"
           + "\n" + "       ) card,"
           + "\n" + "       dparty_dbt party,"
           + "\n" + "       account"
           + "\n" + " WHERE avoiriss.t_fi_code = card.t_fi_code"
           + "\n" + "   AND card.t_issuerId = party.t_partyId"
           + "\n" + "   AND card.t_faceValueFiId = fi.t_fiId"
           + "\n" + "   AND (   card.t_code711Name = 'ENC'"
           + "\n" + "        OR (    avoiriss.t_code711Name = 'ENC'"
           + "\n" + "            AND (   card.t_code711Name IS NULL"
           + "\n" + "                 OR card.t_code711Name = ''"
           + "\n" + "                )"
           + "\n" + "           )"
           + "\n" + "       )"
           + "\n" + "   AND party.t_legalForm = 2"
           + "\n" + "   AND account.t_codeFi = card.t_fi_code"
           + "\n" + "   AND account.t_account = card.t_hAccount"
           + "\n" + " GROUP BY ROLLUP ("
           + "\n" + "                  card.t_faceValueFiCode,"
           + "\n" + "                  ("
           + "\n" + "                   card.t_xid,"
           + "\n" + "                   fi.t_point,"
           + "\n" + "                   account.t_purpose,"
           + "\n" + "                   account.t_account,"
           + "\n" + "                   account.t_ownerName,"
           + "\n" + "                   account.t_isOwnerNotResident"
           + "\n" + "                  )"
           + "\n" + "                 )"
           + "\n" + "HAVING GROUPING(card.t_faceValueFiCode) = 0"
           + "\n" + " ORDER BY t_faceValueFiCode,"
           + "\n" + "          t_account";

        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_column", V_INTEGER);
        dataset.SetFieldType("t_faceValue", V_MONEY);
        add("RcbMortgage711_I2055", dataset);

    end;

    constructorTDataSourcePart32Mortgage_I2055();

end;

/**
*  Класс источника данных для части подраздела 1.3.1 (закладные ФЛ)
*  @since 6.00.020.29
*  @author Shestakov Dmitry
*/
class (TDataSource) TDataSourcePart31Mortgage_I2332()

    private var m_secureId;

    macro getValue(attributeName)

        var value;

        if (strUpr(attributeName) == strUpr("secureId"))
            value = m_secureId;
            m_secureId = m_secureId + 1;
        else
            value = getValue(attributeName);
        end;

        return value;

    end;

    private macro constructorTDataSourcePart31Mortgage_I2332()

        var iterator;
        var queryText;
        var dataset;

        initTDataSource();

        iterator = RcbApplication().currentReport.attributeValue("Ф711_3_1").createValueIterator();
        iterator.setSortOrder(TPart32SorterBySecureId());
        iterator.first();
        if (not iterator.isDone())
            m_secureId = iterator.currentItem.fieldValue("Id ц/б для протокола").exact;
        else
            m_secureId = 0;
        end;

        m_secureId = m_secureId + 1;

        queryText = "WITH account"
           + "\n" + "AS"
           + "\n" + "("
           + "\n" + " SELECT DISTINCT t_codeFi AS t_codeFi,"
           + "\n" + "                 t_account AS t_account,"
           + "\n" + "                 t_depoType AS t_purpose,"
           + "\n" + "                 t_isNr AS t_isOwnerNotResident,"
           + "\n" + "                 t_subject AS t_ownerName"
           + "\n" + "   FROM df711ac_tmp"
           + "\n" + "  WHERE t_depoKind = 'П'"
           + "\n" + "    AND t_depoType != 0"
           + "\n" + "    AND t_rest != 0"
           + "\n" + "    AND t_partyId NOT IN (SELECT t_partyId"
           + "\n" + "                            FROM drepourbank_tmp"
           + "\n" + "                         )"
           + "\n" + ")"
           + "\n" + "SELECT NVL(card.t_faceValueFiCode, 0)                              AS t_faceValueFiCode,"
           + "\n" + "       NVL(card.t_xid, CHR(1))                                     AS t_identificator,"
           + "\n" + "       NVL(SUM(card.t_faceValue), 0)                               AS t_faceValue,"
           + "\n" + "       NVL2(fi.t_point, fi.t_point + 2, 0)                         AS t_point,"
           + "\n" + "       NVL(SUM(card.t_copies), 0)                                  AS t_copies,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 1"
           + "\n" + "                    AND account.t_isOwnerNotResident != 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column37,"
           + "\n" + "       0                                                           AS t_column38,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 1"
           + "\n" + "                    AND account.t_isOwnerNotResident = 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column39,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 2"
           + "\n" + "                    AND account.t_isOwnerNotResident != 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column40,"
           + "\n" + "       0                                                           AS t_column41,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 2"
           + "\n" + "                    AND account.t_isOwnerNotResident = 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column42,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 4"
           + "\n" + "                    AND account.t_isOwnerNotResident != 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column43,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 4"
           + "\n" + "                    AND account.t_isOwnerNotResident = 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column44,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose = 3"
           + "\n" + "                    AND account.t_isOwnerNotResident != 1"
           + "\n" + "                   THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column45,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 5, card.t_copies, 0)), 0) AS t_column46,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 6, card.t_copies, 0)), 0) AS t_column47,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 7, card.t_copies, 0)), 0) AS t_column48,"
           + "\n" + "       NVL(account.t_purpose, -1)                                  AS t_purpose,"
           + "\n" + "       NVL(account.t_account, CHR(1))                              AS t_account,"
           + "\n" + "       NVL(account.t_ownerName, CHR(1))                            AS t_ownerName,"
           + "\n" + "       NVL(account.t_isOwnerNotResident, 0)                        AS t_isOwnerNotResident,"
           + "\n" + "       NVL(party.t_party711inn, CHR(1))                            AS t_issuerInn,"
           + "\n" + "       (-1)                                                        AS t_issuerId,"
           + "\n" + "       'ENC'                                                       AS t_code711Name,"
           + "\n" + "       'Физические лица'                                           AS t_issuerName,"
           + "\n" + "       '12'                                                        AS t_issuerType,"
           + "\n" + "       CHR(1)                                                      AS t_identificatorType,"
           + "\n" + "       37                                                          AS t_column"
           + "\n" + "  FROM (SELECT avoiriss.t_fi_code,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = avoiriss.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = avoiriss.t_code711CategoryNum"
           + "\n" + "                   AND atc.t_object = avoiriss.t_objectId"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmFinAvoiriss avoiriss"
           + "\n" + "       ) avoiriss,"
           + "\n" + "       dfininstr_dbt fi,"
           + "\n" + "       (SELECT invCard.t_xid,"
           + "\n" + "               invCard.t_faceValue,"
           + "\n" + "               invCard.t_copies,"
           + "\n" + "               invCard.t_fi_code,"
           + "\n" + "               invCard.t_issuerId,"
           + "\n" + "               invCard.t_faceValueFiId,"
           + "\n" + "               invCard.t_hAccount,"
           + "\n" + "               NVL((SELECT fi.t_iso_number"
           + "\n" + "                      FROM dfininstr_dbt fi"
           + "\n" + "                     WHERE fi.t_fiId = invCard.t_faceValueFiId"
           + "\n" + "                   ), 0) AS t_faceValueFiCode,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = invCard.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = invCard.t_code711Group"
           + "\n" + "                   AND atc.t_object = TO_CHAR(invCard.t_autokey)"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmDepInvCard invCard"
           + "\n" + "       ) card,"
           + "\n" + "       (SELECT party.t_partyId,"
           + "\n" + "               party.t_legalForm,"
           + "\n" + "               DECODE(party.t_notResident, 'X', (SELECT t_codenum3"
           + "\n" + "                                                   FROM dcountry_dbt"
           + "\n" + "                                                  WHERE t_codelat3 = party.t_nrCountry"
           + "\n" + "                                                    AND rownum = 1"
           + "\n" + "                                                ),"
           + "\n" + "                                           '000000000000'"
           + "\n" + "                     ) AS t_party711inn"
           + "\n" + "         FROM dparty_dbt party"
           + "\n" + "       ) party,"
           + "\n" + "       account"
           + "\n" + " WHERE avoiriss.t_fi_code = card.t_fi_code"
           + "\n" + "   AND card.t_issuerId = party.t_partyId"
           + "\n" + "   AND card.t_faceValueFiId = fi.t_fiId"
           + "\n" + "   AND (   card.t_code711Name = 'ENC'"
           + "\n" + "        OR (    avoiriss.t_code711Name = 'ENC'"
           + "\n" + "            AND (   card.t_code711Name IS NULL"
           + "\n" + "                 OR card.t_code711Name = ''"
           + "\n" + "                )"
           + "\n" + "           )"
           + "\n" + "       )"
           + "\n" + "   AND party.t_legalForm = 2"
           + "\n" + "   AND account.t_codeFi = card.t_fi_code"
           + "\n" + "   AND account.t_account = card.t_hAccount"
           + "\n" + " GROUP BY ROLLUP ("
           + "\n" + "                  ("
           + "\n" + "                   card.t_faceValueFiCode,"
           + "\n" + "                   party.t_party711inn"
           + "\n" + "                  ),"
           + "\n" + "                  ("
           + "\n" + "                   card.t_xid,"
           + "\n" + "                   fi.t_point,"
           + "\n" + "                   account.t_purpose,"
           + "\n" + "                   account.t_account,"
           + "\n" + "                   account.t_ownerName,"
           + "\n" + "                   account.t_isOwnerNotResident"
           + "\n" + "                  )"
           + "\n" + "                 )"
           + "\n" + "HAVING GROUPING(card.t_faceValueFiCode) = 0"
           + "\n" + " ORDER BY t_faceValueFiCode,"
           + "\n" + "          t_account";

        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_column", V_INTEGER);
        dataset.SetFieldType("t_faceValue", V_MONEY);
        add("RcbMg711_31_I2332", dataset);

    end;

    constructorTDataSourcePart31Mortgage_I2332();

end;

/**
*  Класс источника данных для части подраздела 1.3.2 (закладные ФЛ)
*  @since 6.00.020.29
*  @author Shestakov Dmitry
*/
class (TDataSource) TDataSourcePart32Mortgage_I2332()

    private var m_secureId;

    macro getValue(attributeName)

        var value;

        if (strUpr(attributeName) == strUpr("secureId"))
            value = m_secureId;
            m_secureId = m_secureId + 1;
        else
            value = getValue(attributeName);
        end;

        return value;

    end;

    private macro constructorTDataSourcePart32Mortgage_I2332()

        var iterator;
        var queryText;
        var dataset;

        initTDataSource();

        iterator = RcbApplication().currentReport.attributeValue("Ф711_3_2").createValueIterator();
        iterator.setSortOrder(TPart32SorterBySecureId());
        iterator.first();
        if (not iterator.isDone())
            m_secureId = iterator.currentItem.fieldValue("Id ц/б для протокола").exact;
        else
            m_secureId = 0;
        end;

        m_secureId = m_secureId + 1;

        queryText = "WITH account"
           + "\n" + "AS"
           + "\n" + "("
           + "\n" + " SELECT DISTINCT t_codeFi AS t_codeFi,"
           + "\n" + "                 t_account AS t_account,"
           + "\n" + "                 t_depoType AS t_purpose,"
           + "\n" + "                 t_isNr AS t_isOwnerNotResident,"
           + "\n" + "                 t_subject AS t_ownerName"
           + "\n" + "   FROM df711ac_tmp"
           + "\n" + "  WHERE t_depoKind = 'П'"
           + "\n" + "    AND t_depoType != 0"
           + "\n" + "    AND t_rest != 0"
           + "\n" + "    AND t_partyId IN (SELECT t_partyId"
           + "\n" + "                        FROM drepourbank_tmp"
           + "\n" + "                     )"
           + "\n" + ")"
           + "\n" + "SELECT NVL(card.t_faceValueFiCode, 0)                              AS t_faceValueFiCode,"
           + "\n" + "       NVL(card.t_xid, CHR(1))                                     AS t_identificator,"
           + "\n" + "       NVL(SUM(card.t_faceValue), 0)                               AS t_faceValue,"
           + "\n" + "       NVL2(fi.t_point, fi.t_point + 2, 0)                         AS t_point,"
           + "\n" + "       NVL(SUM(card.t_copies), 0)                                  AS t_copies,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 1, card.t_copies, 0)), 0) AS t_column56,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 4, card.t_copies, 0)), 0) AS t_column57,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 3, card.t_copies, 0)), 0) AS t_column58,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 5, card.t_copies, 0)), 0) AS t_column59,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 6, card.t_copies, 0)), 0) AS t_column60,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose NOT IN (1,3,4,5,6)"
           + "\n" + "                       THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column61,"
           + "\n" + "       NVL(account.t_purpose, -1)                                  AS t_purpose,"
           + "\n" + "       NVL(account.t_account, CHR(1))                              AS t_account,"
           + "\n" + "       NVL(account.t_ownerName, CHR(1))                            AS t_ownerName,"
           + "\n" + "       NVL(account.t_isOwnerNotResident, 0)                        AS t_isOwnerNotResident,"
           + "\n" + "       NVL(party.t_party711inn, CHR(1))                            AS t_issuerInn,"
           + "\n" + "       (-1)                                                        AS t_issuerId,"
           + "\n" + "       'ENC'                                                       AS t_code711Name,"
           + "\n" + "       'Физические лица'                                           AS t_issuerName,"
           + "\n" + "       '12'                                                        AS t_issuerType,"
           + "\n" + "       CHR(1)                                                      AS t_identificatorType,"
           + "\n" + "       CASE account.t_purpose"
           + "\n" + "          WHEN 1 THEN 56"
           + "\n" + "          WHEN 4 THEN 57"
           + "\n" + "          WHEN 3 THEN 58"
           + "\n" + "          WHEN 5 THEN 59"
           + "\n" + "          WHEN 6 THEN 60"
           + "\n" + "          ELSE 61"
           + "\n" + "       END                                                         AS t_column"
           + "\n" + "  FROM (SELECT avoiriss.t_fi_code,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = avoiriss.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = avoiriss.t_code711CategoryNum"
           + "\n" + "                   AND atc.t_object = avoiriss.t_objectId"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmFinAvoiriss avoiriss"
           + "\n" + "       ) avoiriss,"
           + "\n" + "       dfininstr_dbt fi,"
           + "\n" + "       (SELECT invCard.t_xid,"
           + "\n" + "               invCard.t_faceValue,"
           + "\n" + "               invCard.t_copies,"
           + "\n" + "               invCard.t_fi_code,"
           + "\n" + "               invCard.t_issuerId,"
           + "\n" + "               invCard.t_faceValueFiId,"
           + "\n" + "               invCard.t_hAccount,"
           + "\n" + "               NVL((SELECT fi.t_iso_number"
           + "\n" + "                      FROM dfininstr_dbt fi"
           + "\n" + "                     WHERE fi.t_fiId = invCard.t_faceValueFiId"
           + "\n" + "                   ), 0) AS t_faceValueFiCode,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = invCard.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = invCard.t_code711Group"
           + "\n" + "                   AND atc.t_object = TO_CHAR(invCard.t_autokey)"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmDepInvCard invCard"
           + "\n" + "       ) card,"
           + "\n" + "       (SELECT party.t_partyId,"
           + "\n" + "               party.t_legalForm,"
           + "\n" + "               DECODE(party.t_notResident, 'X', (SELECT t_codenum3"
           + "\n" + "                                                   FROM dcountry_dbt"
           + "\n" + "                                                  WHERE t_codelat3 = party.t_nrCountry"
           + "\n" + "                                                    AND rownum = 1"
           + "\n" + "                                                ),"
           + "\n" + "                                           '000000000000'"
           + "\n" + "                     ) AS t_party711inn"
           + "\n" + "         FROM dparty_dbt party"
           + "\n" + "       ) party,"
           + "\n" + "       account"
           + "\n" + " WHERE avoiriss.t_fi_code = card.t_fi_code"
           + "\n" + "   AND card.t_issuerId = party.t_partyId"
           + "\n" + "   AND card.t_faceValueFiId = fi.t_fiId"
           + "\n" + "   AND (   card.t_code711Name = 'ENC'"
           + "\n" + "        OR (    avoiriss.t_code711Name = 'ENC'"
           + "\n" + "            AND (   card.t_code711Name IS NULL"
           + "\n" + "                 OR card.t_code711Name = ''"
           + "\n" + "                )"
           + "\n" + "           )"
           + "\n" + "       )"
           + "\n" + "   AND party.t_legalForm = 2"
           + "\n" + "   AND account.t_codeFi = card.t_fi_code"
           + "\n" + "   AND account.t_account = card.t_hAccount"
           + "\n" + " GROUP BY ROLLUP ("
           + "\n" + "                  ("
           + "\n" + "                   card.t_faceValueFiCode,"
           + "\n" + "                   party.t_party711inn"
           + "\n" + "                  ),"
           + "\n" + "                  ("
           + "\n" + "                   card.t_xid,"
           + "\n" + "                   fi.t_point,"
           + "\n" + "                   account.t_purpose,"
           + "\n" + "                   account.t_account,"
           + "\n" + "                   account.t_ownerName,"
           + "\n" + "                   account.t_isOwnerNotResident"
           + "\n" + "                  )"
           + "\n" + "                 )"
           + "\n" + "HAVING GROUPING(card.t_faceValueFiCode) = 0"
           + "\n" + " ORDER BY t_faceValueFiCode,"
           + "\n" + "          t_account";

        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_column", V_INTEGER);
        dataset.SetFieldType("t_faceValue", V_MONEY);
        add("RcbMg711_32_I2332", dataset);

    end;

    constructorTDataSourcePart32Mortgage_I2332();

end;

/**
*  Класс источника данных для части подраздела 1.3.2 (закладные ФЛ)
*  @since 6.00.020.29
*  @author ABP
*/
class (TDataSourcePart32Mortgage_I2332) TDataSourcePart32Mortgage_I2539()

    private macro constructorTDataSourcePart32Mortgage_I2539()

        initTDataSourcePart32Mortgage_I2332();

    end;

    constructorTDataSourcePart32Mortgage_I2539();

end;

/**
*  Класс источника данных для части подраздела 1.3.2 (закладные ФЛ) по 2627-У
*  @since 6.00.020.29
*  @author SER
*/
class (TDataSourcePart32Mortgage_I2539) TDataSourcePart32Mortgage_I2627()

    private macro constructorTDataSourcePart32Mortgage_I2627()

        var iterator;
        var queryText;
        var dataset;

        initTDataSource();

        iterator = RcbApplication().currentReport.attributeValue("Ф711_3_2").createValueIterator();
        iterator.setSortOrder(TPart32SorterBySecureId());
        iterator.first();
        if (not iterator.isDone())
            m_secureId = iterator.currentItem.fieldValue("Id ц/б для протокола").exact;
        else
            m_secureId = 0;
        end;

//        var column62_65FillingInCondition = "(NOT (    corAccount.t_activeAccountOwnerId = " + m_ourBankId
//                                          + "      OR avoiriss.t_securKind = " + getSqlString("BIL")
//                                          + "     )"
//                                          + ")";

        m_secureId = m_secureId + 1;

        queryText = "WITH  corAccount AS" //данные по корреспондирующему активному счету
           + "\n" + "("
           + "\n" + " SELECT /*+ MATERIALIZE*/"
           + "\n" + "        account.t_account               AS t_account,"
           + "\n" + "        account.t_code_currency         AS t_fiId,"
//           + "\n" + "        pt.t_id                         AS t_activeAccountRealOwnerId,"
//           + "\n" + "        pt.t_name                       AS t_activeAccountOwnerName,"
//           + "\n" + "        (SELECT t_code"
//           + "\n" + "           FROM drepPartyCodes_vw pc"
//           + "\n" + "          WHERE pc.t_partyId = pt.t_id"
//           + "\n" + "            AND t_codeKind = " + PTCK_INN
//           + "\n" + "        )                               AS t_activeAccountOwnerInn,"
//           + "\n" + "        (SELECT t_code"
//           + "\n" + "           FROM drepPartyCodes_vw pc"
//           + "\n" + "          WHERE pc.t_partyId = pt.t_id"
//           + "\n" + "            AND t_codeKind = " + PTCK_ORCBLICENSE
//           + "\n" + "        )                               AS t_activeAccountOwnerOrcbNumber,"
//           + "\n" + "        pt.t_isResident                 AS t_activeAccountOwnerIsResident,"
//           + "\n" + "        pt.t_isBank                     AS t_activeAccountOwnerIsBank,"
//           + "\n" + "        pt.t_isDepositary               AS t_activeAccOwnertIsDepositary,"
//           + "\n" + "        pt.t_isRegistrar                AS t_activeAccOwnertIsRegistrar,"
//           + "\n" + "        pt.t_isIssuer                   AS t_activeAccOwnertIsIssuer,"
//           + "\n" + "        pt.t_countryCode                AS t_activeAccOwnerCountryCode,"
           + "\n" + "        CASE"
           + "\n" + "            WHEN pt.t_id IN (SELECT t_partyId"
           + "\n" + "                               FROM drepourbank_tmp"
           + "\n" + "                            )"
           + "\n" + "            THEN " + m_ourBankId
           + "\n" + "            ELSE pt.t_id"
           + "\n" + "        END                             AS t_activeAccountOwnerId"
           + "\n" + "   FROM OrmDepAccount account,"
           + "\n" + "        OrmDepAcc depoAccount,"
           + "\n" + "        drepParty_vw pt"
           + "\n" + "  WHERE account.t_depoRoot = depoAccount.t_autoKey"
           + "\n" + "    AND depoAccount.t_owner = pt.t_id"
           + "\n" + "),"
           + "\n" + "      account AS"
           + "\n" + "(SELECT /*+ MATERIALIZE*/ DISTINCT"
           + "\n" + "        ac.t_codeFi   AS t_codeFi,"
           + "\n" + "        ac.t_account  AS t_account,"
           + "\n" + "        ac.t_depoType AS t_purpose,"
           + "\n" + "        ac.t_isNr     AS t_isOwnerNotResident,"
           + "\n" + "        ac.t_subject  AS t_ownerName,"
           + "\n" + "        ac.t_rest     AS t_rest"
           + "\n" + "   FROM df711ac_tmp ac"
           + "\n" + "  WHERE ac.t_depoKind = 'П'"
           + "\n" + "    AND ac.t_depoType != 0"
           + "\n" + "    AND ac.t_rest != 0"
           + "\n" + "    AND ac.t_partyId IN (SELECT t_partyId"
           + "\n" + "                           FROM drepourbank_tmp"
           + "\n" + "                        )"
           + "\n" + ")"
           + "\n" + "SELECT NVL(card.t_faceValueFiCode, 0)                              AS t_faceValueFiCode,"
           + "\n" + "       NVL(card.t_xid, CHR(1))                                     AS t_identificator,"
           + "\n" + "       NVL(SUM(card.t_faceValue), 0)                               AS t_faceValue,"
           + "\n" + "       NVL2(fi.t_point, fi.t_point + 2, 0)                         AS t_point,"
           + "\n" + "       NVL(SUM(card.t_copies), 0)                                  AS t_copies,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 1, card.t_copies, 0)), 0) AS t_column56,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 4, card.t_copies, 0)), 0) AS t_column57,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 3, card.t_copies, 0)), 0) AS t_column58,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 5, card.t_copies, 0)), 0) AS t_column59,"
           + "\n" + "       NVL(SUM(DECODE(account.t_purpose, 6, card.t_copies, 0)), 0) AS t_column60,"
           + "\n" + "       NVL(SUM(CASE"
           + "\n" + "                   WHEN account.t_purpose NOT IN (1,3,4,5,6)"
           + "\n" + "                       THEN card.t_copies"
           + "\n" + "                   ELSE 0"
           + "\n" + "                END"
           + "\n" + "              ), 0"
           + "\n" + "          )                                                        AS t_column61,"
           // 31.10.2011 ABP Графы 62-65 для закладных физ. лиц не заполняются.
           + "\n" + "       CHR(1)                                                      AS t_column62,"
           + "\n" + "       CHR(1)                                                      AS t_column63,"
           + "\n" + "       CHR(1)                                                      AS t_column64,"
           + "\n" + "       CHR(1)                                                      AS t_column65,"
//           + "\n" + "       CASE"
//           + "\n" + "           WHEN " + column62_65FillingInCondition
//           + "\n" + "           THEN NVL(corAccount.t_activeAccountOwnerName, CHR(1))"
//           + "\n" + "           ELSE CHR(1)"
//           + "\n" + "       END                                                         AS t_column62,"
//           + "\n" + "       CASE"
//           + "\n" + "           WHEN " + column62_65FillingInCondition
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsResident = 1"
//           + "\n" + "           THEN NVL(corAccount.t_activeAccountOwnerInn, '0000000000')"
//           + "\n" + "           WHEN " + column62_65FillingInCondition
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsResident != 1"
//           + "\n" + "           THEN NVL(corAccount.t_activeAccOwnerCountryCode, 999)"
//           + "\n" + "           ELSE CHR(1)"
//           + "\n" + "       END                                                         AS t_column63,"
//           + "\n" + "       CASE"
//           + "\n" + "           WHEN " + column62_65FillingInCondition
//           + "\n" + "            AND (corAccount.t_activeAccountOwnerIsResident = 0 OR avoiriss.t_issuerId = corAccount.t_activeAccountRealOwnerId)"
//           + "\n" + "           THEN CHR(1)"
//           + "\n" + "           WHEN " + column62_65FillingInCondition
//           + "\n" + "            AND NOT (corAccount.t_activeAccountOwnerIsResident = 0 OR avoiriss.t_issuerId = corAccount.t_activeAccountRealOwnerId)"
//           + "\n" + "           THEN NVL(corAccount.t_activeAccountOwnerOrcbNumber, CHR(1))"
//           + "\n" + "           ELSE CHR(1)"
//           + "\n" + "       END                                                         AS t_column64,"
//           + "\n" + "       CASE"
//           + "\n" + "           WHEN (   CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsResident = 0"
//           + "\n" + "                         THEN 'И'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsIssuer = 1"
//           + "\n" + "                         THEN 'Э'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsIssuer = 0"
//           + "\n" + "                         THEN 'Р'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsBank = 1"
//           + "\n" + "                         THEN 'К'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsBank = 0"
//           + "\n" + "                         THEN 'Н'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                ) IS NULL"
//           + "\n" + "           THEN CHR(1)"
//           + "\n" + "           WHEN LENGTH(   CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsResident = 0"
//           + "\n" + "                               THEN 'И'"
//           + "\n" + "                               ELSE NULL"
//           + "\n" + "                          END"
//           + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsIssuer = 1"
//           + "\n" + "                               THEN 'Э'"
//           + "\n" + "                               ELSE NULL"
//           + "\n" + "                          END"
//           + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsIssuer = 0"
//           + "\n" + "                               THEN 'Р'"
//           + "\n" + "                               ELSE NULL"
//           + "\n" + "                          END"
//           + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsBank = 1"
//           + "\n" + "                               THEN 'К'"
//           + "\n" + "                               ELSE NULL"
//           + "\n" + "                          END"
//           + "\n" + "                       || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                                AND corAccount.t_activeAccountOwnerIsBank = 0"
//           + "\n" + "                               THEN 'Н'"
//           + "\n" + "                               ELSE NULL"
//           + "\n" + "                          END"
//           + "\n" + "                      ) = 1"
//           + "\n" + "           THEN (   CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsResident = 0"
//           + "\n" + "                         THEN 'И'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsIssuer = 1"
//           + "\n" + "                         THEN 'Э'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsIssuer = 0"
//           + "\n" + "                         THEN 'Р'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsBank = 1"
//           + "\n" + "                         THEN 'К'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                 || CASE WHEN " + column62_65FillingInCondition
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "                          AND corAccount.t_activeAccountOwnerIsBank = 0"
//           + "\n" + "                         THEN 'Н'"
//           + "\n" + "                         ELSE NULL"
//           + "\n" + "                    END"
//           + "\n" + "                )"
//           + "\n" + "           WHEN corAccount.t_activeAccountRealOwnerId = avoiriss.t_registrarId"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsIssuer = 1"
//           + "\n" + "           THEN 'Э'"
//           + "\n" + "           WHEN corAccount.t_activeAccountRealOwnerId = avoiriss.t_registrarId"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsRegistrar = 1"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsIssuer = 0"
//           + "\n" + "           THEN 'Р'"
//           + "\n" + "           WHEN corAccount.t_activeAccountRealOwnerId != avoiriss.t_registrarId"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsResident = 0"
//           + "\n" + "           THEN 'И'"
//           + "\n" + "           WHEN corAccount.t_activeAccountRealOwnerId != avoiriss.t_registrarId"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsDepositary = 1"
//           + "\n" + "            AND corAccount.t_activeAccountOwnerIsBank = 0"
//           + "\n" + "           THEN 'Н'"
//           + "\n" + "           ELSE CHR(1)"
//           + "\n" + "       END                                                         AS t_column65,"
           + "\n" + "       NVL(account.t_purpose, -1)                                  AS t_purpose,"
           + "\n" + "       NVL(account.t_account, CHR(1))                              AS t_account,"
           + "\n" + "       NVL(account.t_ownerName, CHR(1))                            AS t_ownerName,"
           + "\n" + "       NVL(account.t_isOwnerNotResident, 0)                        AS t_isOwnerNotResident,"
           + "\n" + "       NVL(party.t_party711inn, CHR(1))                            AS t_issuerInn,"
           + "\n" + "       (-1)                                                        AS t_issuerId,"
           + "\n" + "       'ENC'                                                       AS t_code711Name,"
           + "\n" + "       'Физические лица'                                           AS t_issuerName,"
           + "\n" + "       '12'                                                        AS t_issuerType,"
           + "\n" + "       CHR(1)                                                      AS t_identificatorType,"
           + "\n" + "       CASE account.t_purpose"
           + "\n" + "          WHEN 1 THEN 56"
           + "\n" + "          WHEN 4 THEN 57"
           + "\n" + "          WHEN 3 THEN 58"
           + "\n" + "          WHEN 5 THEN 59"
           + "\n" + "          WHEN 6 THEN 60"
           + "\n" + "          ELSE 61"
           + "\n" + "       END                                                         AS t_column"
           + "\n" + "  FROM (SELECT /*+ MATERIALIZE*/ avoiriss.t_fi_code     AS t_fi_code,"
//           + "\n" + "               avoiriss.t_issuer      AS t_issuerId,"
//           + "\n" + "               avoiriss.t_regHolderId AS t_registrarId,"
//           + "\n" + "               avoiriss.t_securKind   AS t_securKind,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = avoiriss.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = avoiriss.t_code711CategoryNum"
           + "\n" + "                   AND atc.t_object = avoiriss.t_objectId"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmFinAvoiriss avoiriss"
           + "\n" + "       ) avoiriss,"
           + "\n" + "       dfininstr_dbt fi,"
           + "\n" + "       (SELECT /*+ MATERIALIZE*/ invCard.t_xid,"
           + "\n" + "               invCard.t_faceValue,"
           + "\n" + "               invCard.t_copies,"
           + "\n" + "               invCard.t_fi_code,"
           + "\n" + "               invCard.t_fiId,"
           + "\n" + "               invCard.t_issuerId,"
           + "\n" + "               invCard.t_faceValueFiId,"
           + "\n" + "               invCard.t_hAccount,"
           + "\n" + "               invCard.t_lAccount,"
           + "\n" + "               NVL((SELECT fi.t_iso_number"
           + "\n" + "                      FROM dfininstr_dbt fi"
           + "\n" + "                     WHERE fi.t_fiId = invCard.t_faceValueFiId"
           + "\n" + "                   ), 0) AS t_faceValueFiCode,"
           + "\n" + "               (SELECT att.t_name"
           + "\n" + "                  FROM dobjattr_dbt att,"
           + "\n" + "                       (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
           + "\n" + "                               DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
           + "\n" + "                               atc.t_objectType AS t_realObjectType,"
           + "\n" + "                               atc.t_groupId AS t_realGroupId,"
           + "\n" + "                               atc.t_attrId t_attrId,"
           + "\n" + "                               atc.t_object t_object,"
           + "\n" + "                               atc.t_validToDate t_validToDate,"
           + "\n" + "                               atc.t_validFromDate t_validFromDate"
           + "\n" + "                          FROM dobjatcor_dbt atc,"
           + "\n" + "                               dobjgroup_dbt grp"
           + "\n" + "                         WHERE atc.t_groupId = grp.t_groupId"
           + "\n" + "                           AND atc.t_objectType = grp.t_objectType"
           + "\n" + "                           AND atc.t_general = 'X') atc"
           + "\n" + "                 WHERE atc.t_attrId = att.t_attrId"
           + "\n" + "                   AND atc.t_objectType = att.t_objectType"
           + "\n" + "                   AND atc.t_groupId = att.t_groupId"
           + "\n" + "                   AND " + getSqlDate(ДатаОтчета) + " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
           + "\n" + "                   AND atc.t_realObjectType = invCard.t_objectType"
           + "\n" + "                   AND atc.t_realGroupId = invCard.t_code711Group"
           + "\n" + "                   AND atc.t_object = TO_CHAR(invCard.t_autokey)"
           + "\n" + "               ) AS t_code711Name"
           + "\n" + "          FROM OrmDepInvCard invCard"
           + "\n" + "       ) card,"
           + "\n" + "       (SELECT party.t_partyId,"
           + "\n" + "               party.t_legalForm,"
           + "\n" + "               DECODE(party.t_notResident, 'X', (SELECT t_codenum3"
           + "\n" + "                                                   FROM dcountry_dbt"
           + "\n" + "                                                  WHERE t_codelat3 = party.t_nrCountry"
           + "\n" + "                                                    AND rownum = 1"
           + "\n" + "                                                ),"
           + "\n" + "                                           '000000000000'"
           + "\n" + "                     ) AS t_party711inn"
           + "\n" + "         FROM dparty_dbt party"
           + "\n" + "       ) party,"
           + "\n" + "       account,"
           + "\n" + "       corAccount"
           + "\n" + " WHERE avoiriss.t_fi_code = card.t_fi_code"
           + "\n" + "   AND card.t_issuerId = party.t_partyId"
           + "\n" + "   AND card.t_faceValueFiId = fi.t_fiId"
           + "\n" + "   AND (   card.t_code711Name = 'ENC'"
           + "\n" + "        OR (    avoiriss.t_code711Name = 'ENC'"
           + "\n" + "            AND (   card.t_code711Name IS NULL"
           + "\n" + "                 OR card.t_code711Name = ''"
           + "\n" + "                )"
           + "\n" + "           )"
           + "\n" + "       )"
           + "\n" + "   AND party.t_legalForm = 2"
           + "\n" + "   AND corAccount.t_fiId = card.t_fiId"
           + "\n" + "   AND corAccount.t_account = card.t_lAccount"
           + "\n" + "   AND account.t_codeFi = card.t_fi_code"
           + "\n" + "   AND account.t_account = card.t_hAccount"
           + "\n" + " GROUP BY ROLLUP ("
           + "\n" + "                  ("
           + "\n" + "                   card.t_faceValueFiCode,"
           + "\n" + "                   party.t_party711inn,"
           + "\n" + "                   corAccount.t_activeAccountOwnerId"
           + "\n" + "                  ),"
           + "\n" + "                  ("
           + "\n" + "                   card.t_xid,"
           + "\n" + "                   fi.t_point,"
           + "\n" + "                   account.t_purpose,"
           + "\n" + "                   account.t_account,"
           + "\n" + "                   account.t_ownerName,"
           + "\n" + "                   account.t_isOwnerNotResident"
//           + "\n" + "                   corAccount.t_activeAccountRealOwnerId,"
//           + "\n" + "                   corAccount.t_activeAccountOwnerName,"
//           + "\n" + "                   corAccount.t_activeAccountOwnerInn,"
//           + "\n" + "                   corAccount.t_activeAccountOwnerOrcbNumber,"
//           + "\n" + "                   corAccount.t_activeAccountOwnerIsResident,"
//           + "\n" + "                   corAccount.t_activeAccountOwnerIsBank,"
//           + "\n" + "                   corAccount.t_activeAccOwnertIsDepositary,"
//           + "\n" + "                   corAccount.t_activeAccOwnerCountryCode,"
//           + "\n" + "                   avoiriss.t_issuerId,"
//           + "\n" + "                   avoiriss.t_securKind"
           + "\n" + "                  )"
           + "\n" + "                 )"
           + "\n" + "HAVING GROUPING(card.t_faceValueFiCode) = 0"
           + "\n" + " ORDER BY t_faceValueFiCode,"
           + "\n" + "          t_account";

        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_column", V_INTEGER);
        dataset.SetFieldType("t_faceValue", V_MONEY);
        add("RcbMg711_32_I2627", dataset);
    end;

    constructorTDataSourcePart32Mortgage_I2627();

end;

/**
*  Класс расчета для части подраздела 1.3 (закладные ФЛ)
*  @since 6.00.020.29
*  @author ABP
*/
private class TCalculatorPart3()

    private var m_secureId;

    private macro saveProtocolData(part, secureCode, column, account, amount, purpose, ownerName, isOwnerNotResident, recordType)

        sql_execute(         "INSERT INTO " + TempTable3
                    + "\n" + "("
                    + "\n" + " t_counter,"
                    + "\n" + " t_secureCode,"
                    + "\n" + " t_column,"
                    + "\n" + " t_account,"
                    + "\n" + " t_amount,"
                    + "\n" + " t_purpose,"
                    + "\n" + " t_ownerName,"
                    + "\n" + " t_isOwnerNotResident,"
                    + "\n" + " t_recordType,"
                    + "\n" + " t_id,"
                    + "\n" + " t_part"
                    + "\n" + ")"
                    + "\n" + "SELECT 0,"
                    + "\n" + "       " + getSqlString(secureCode) + ","
                    + "\n" + "       " + getSqlString(column) + ","
                    + "\n" + "       " + getSqlString(account) + ","
                    + "\n" + "       " + amount + ","
                    + "\n" + "       " + getSqlString(purpose) + ","
                    + "\n" + "       " + getSqlString(ownerName) + ","
                    + "\n" + "       " + getSqlString(ternary(isOwnerNotResident, "X", "")) + ","
                    + "\n" + "       " + recordType + ","
                    + "\n" + "       " + m_secureId + ","
                    + "\n" + "       " + getSqlString(part)
                    + "\n" + "  FROM DUAL"
                    );

    end;

    private macro calculateMortgage(attributeName, dataSource)

        var variable;
        var columnArray = TArray();
        var column;
        var i;
        var protocolPart : string;
        var isSubpartN1 : bool;

        if   (attributeName == "Ф711_3_1")
            protocolPart = "1.3.1";
            isSubpartN1  = true;
        elif (attributeName == "Ф711_3_2")
            protocolPart = "1.3.2";
            isSubpartN1  = false;
        end;

        while ((dataSource != null) and dataSource.next())

            if (dataSource.getValue("account") == "") // ABP Агрегированные данные содержатся в элементе с пустым номером счета

                m_secureId = dataSource.getValue("secureId");

                variable = RcbApplication().currentReport.attributeValue(attributeName).addValue(RCB_NEW_VALUE_ID);

                variable.fieldValue("Эмитент").exact           = dataSource.getValue("issuerName");
                variable.fieldValue("ИНН эмитента").exact      = dataSource.getValue("issuerInn");
                variable.fieldValue("Код типа ц/б").exact      = dataSource.getValue("code711Name");
                if (in(dataSource.getValue("code711Name"), "SHS7", "SHS71", "SHS8"))
                    variable.fieldValue("Идентификатор ц/б").exact = "";
                else
                    variable.fieldValue("Идентификатор ц/б").exact = dataSource.getValue("identificator");
                end;
                variable.fieldValue("Валюта ц/б").exact        = ternary(dataSource.getValue("faceValue") == 0, 0, dataSource.getValue("faceValueFiCode"));
                if (in(dataSource.getValue("code711Name"), "DR", "SHS7", "SHS71", "SHS8", "OPN"))
                    variable.fieldValue("Номинал ц/б").exact = 0;
                else
                variable.fieldValue("Номинал ц/б").exact       = dataSource.getValue("faceValue");
                end;
                if (isSubpartN1)
                    variable.fieldValue("Графа 32").exact      = dataSource.getValue("column37");
                    variable.fieldValue("Графа 33").exact      = dataSource.getValue("column38");
                    variable.fieldValue("Графа 34").exact      = dataSource.getValue("column39");
                    variable.fieldValue("Графа 35").exact      = dataSource.getValue("column40");
                    variable.fieldValue("Графа 36").exact      = dataSource.getValue("column41");
                    variable.fieldValue("Графа 37").exact      = dataSource.getValue("column42");
                    variable.fieldValue("Графа 38").exact      = dataSource.getValue("column43");
                    variable.fieldValue("Графа 39").exact      = dataSource.getValue("column44");
                    variable.fieldValue("Графа 40").exact      = dataSource.getValue("column45");
                    variable.fieldValue("Графа 41").exact      = dataSource.getValue("column46");
                    variable.fieldValue("Графа 42").exact      = dataSource.getValue("column47");
                    variable.fieldValue("Графа 43").exact      = dataSource.getValue("column48");
                else
                    variable.fieldValue("Графа 50").exact      = dataSource.getValue("column56");
                    variable.fieldValue("Графа 51").exact      = dataSource.getValue("column57");
                    variable.fieldValue("Графа 52").exact      = dataSource.getValue("column58");
                    variable.fieldValue("Графа 53").exact      = dataSource.getValue("column59");
                    variable.fieldValue("Графа 54").exact      = dataSource.getValue("column60");
                    variable.fieldValue("Графа 55").exact      = dataSource.getValue("column61");

                    if (RcbApplication().currentReport.context.period.endDate >= RCB_I2627_DATE)
                        variable.fieldValue("Графа 62").exact = dataSource.getValue("column62");
                        variable.fieldValue("Графа 63").exact = dataSource.getValue("column63");
                        variable.fieldValue("Графа 64").exact = dataSource.getValue("column64");
                        variable.fieldValue("Графа 65").exact = dataSource.getValue("column65");
                    end;

                end;
                variable.fieldValue("Тип эмитента").exact             = dataSource.getValue("issuerType");
                variable.fieldValue("Способ заполнения номера").exact = dataSource.getValue("identificatorType");
                variable.fieldValue("Точность номинала ц/б").exact    = dataSource.getValue("point");
                variable.fieldValue("Id ц/б для протокола").exact     = m_secureId;
                variable.fieldValue("ID эмитента").exact              = nvl(dataSource.getValue("issuerId"), 0);

            else // ABP Данные для протокола предоставляются в разрезе счетов. Предполагается, что каждая ИК учитывается только на одном л/с

                if (arrFind(columnArray, dataSource.getValue("column")) < 0)
                    columnArray[columnArray.size] = dataSource.getValue("column");
                end;

                if (columnArray.size > 1)
                    i = 0;
                    column = "";
                    while (i < columnArray.size)
                        column = column + "," + columnArray[i];
                        i = i + 1;
                    end;
                    column = "(" + subStr(column, 2) + ")";
                else
                    column = string(columnArray[0]);
                end;

                saveProtocolData(protocolPart,
                                 dataSource.getValue("identificator"),
                                 column,
                                 dataSource.getValue("account"),
                                 dataSource.getValue("copies"),
                                 getTypeDescription(dataSource.getValue("purpose")),
                                 dataSource.getValue("ownerName"),
                                 dataSource.getValue("isOwnerNotResident"),
                                 RECORDTYPE_COLLECTION // считаем, что закладные физ. лиц - всегда коллекция ИК
                                );

            end;

        end;

    end;

    macro calculate()

        begAction(1000, "Расчет переменных подраздела 1.3");

        department_3();

        message("Расчет по закладным физ. лиц");

        calculateMortgage("Ф711_3_1", objectFactoryInstance.createDataSourcePart31Mortgage());
        calculateMortgage("Ф711_3_2", objectFactoryInstance.createDataSourcePart32Mortgage());

        endAction();

    end;

end;

/* ------------ Печать протокола расчета для третьего раздела ------------- */

private macro printProtocolDepo()

    macro updateCounter(attributeName, partNumber)

        var iterator = RcbApplication().currentReport.attributeValue(attributeName).createValueIterator();

        var currentItem;

        iterator.first();

        while (not iterator.isDone())

            currentItem = iterator.currentItem;

            sql_execute(         "UPDATE " + TempTable3
                        + "\n" + "   SET t_counter = " + currentItem.fieldValue("Номер п/п").current
                        + "\n" + " WHERE t_part = " + getSqlString(partNumber)
                        + "\n" + "   AND t_id = " + currentItem.fieldValue("Id ц/б для протокола").current
                        );

            iterator.next();

        end;

    end;

    macro updateRecordType()

        sql_execute(         "UPDATE " + TempTable3 + " records"
                    + "\n" + "   SET records.t_recordType = (SELECT MAX(t_recordType)"
                    + "\n" + "                                 FROM " + TempTable3
                    + "\n" + "                                WHERE t_id = records.t_id"
                    + "\n" + "                              )"
                    + "\n" + " WHERE records.t_recordType IN (2, 3)"
                    );
    end;

    macro printAccounts(protocol, data)

        var hasData = false;

        var warningCharacter;
        var counterString;
        var columnString;
        var hasError = false;

        while ((data != null) and data.next())

            hasData = true;
            if (data.columnString != "0")
                warningCharacter = "";
                counterString = data.counterString;
                columnString = data.columnString;
            else
                hasError = true;
                warningCharacter = "!";
                counterString = "";
                columnString = "";
            end;

            var note = getNoteForAmount(data.amount);
            if ((columnString == "33") OR (columnString == "52"))
                note = "Внимание! Для ценной бумаги не задано значение примечания \"Код типа ц.б. для формы 711\"";
            end;

            if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)

                protocol.printStringTransferByWord(warningCharacter,
                                                   data.secureCodeString,
                                                   columnString,
                                                   data.accountString,
                                                   data.amount : 0 : 4,
                                                   data.purposeString,
                                                   data.ownerNameString,
                                                   data.isOwnerNotResidentString,
                                                   note
                                                );
            else
                protocol.printStringTransferByWord(warningCharacter,
                                                   counterString,
                                                   data.secureCodeString,
                                                   columnString,
                                                   data.accountString,
                                                   data.amount : 0 : 4,
                                                   data.purposeString,
                                                   data.ownerNameString,
                                                   data.isOwnerNotResidentString,
                                                   note
                                                );
            end;

        end;

        return hasData;

    end;

    macro getPartQuery(partNumber, forValidAccounts)

        var query;

        var accountCondition = ternary(forValidAccounts, "t_column != '0'", "t_column = '0'");

        query = "SELECT DECODE(GROUPING(t_account), 0, CHR(1), t_counter) AS t_counterString,"
       + "\n" + "       DECODE(GROUPING(t_account), 0, CHR(1), t_secureCode) AS t_secureCodeString,"
       + "\n" + "       DECODE(GROUPING(t_account), 0, CHR(1), t_column) AS t_columnString,"
       + "\n" + "       NVL(t_account, CHR(1)) AS t_accountString,"
       + "\n" + "       SUM(t_amount) AS t_amount,"
       + "\n" + "       NVL(t_purpose, CHR(1)) AS t_purposeString,"
       + "\n" + "       NVL(t_ownerName, CHR(1)) AS t_ownerNameString,"
       + "\n" + "       NVL(t_isOwnerNotResident, CHR(0)) AS t_isOwnerNotResidentString,"
       + "\n" + "       t_counter AS t_counter,"
       + "\n" + "       t_secureCode AS t_secureCode,"
       + "\n" + "       t_column AS t_column,"
       + "\n" + "       t_account AS t_account"
       + "\n" + "  FROM " + TempTable3
       + "\n" + " WHERE t_recordType = " + RECORDTYPE_SECURE
       + "\n" + "   AND t_part = " + getSqlString(partNumber)
       + "\n" + "   AND " + accountCondition
       + "\n" + " GROUP BY ROLLUP (t_counter, t_column, t_secureCode, (t_account, t_purpose, t_ownerName, t_isOwnerNotResident))"
       + "\n" + "HAVING GROUPING_ID(t_counter, t_column, t_secureCode) = 0"
       + "\n" + "UNION ALL"
       + "\n" + "SELECT DECODE(GROUPING(t_account), 0, CHR(1), t_counter) AS t_counterString,"
       + "\n" + "       DECODE(GROUPING(t_account), 0, CHR(1), 'ИК ' || t_secureCode) AS t_secureCodeString,"
       + "\n" + "       DECODE(GROUPING(t_account), 0, CHR(1), t_column) AS t_columnString,"
       + "\n" + "       NVL(t_account, CHR(1)) AS t_accountString,"
       + "\n" + "       SUM(t_amount) AS t_amount,"
       + "\n" + "       NVL(t_purpose, CHR(1)) AS t_purposeString,"
       + "\n" + "       NVL(t_ownerName, CHR(1)) AS t_ownerNameString,"
       + "\n" + "       NVL(t_isOwnerNotResident, CHR(0)) AS t_isOwnerNotResidentString,"
       + "\n" + "       t_counter AS t_counter,"
       + "\n" + "       t_secureCode AS t_secureCode,"
       + "\n" + "       t_column AS t_column,"
       + "\n" + "       t_account AS t_account"
       + "\n" + "  FROM " + TempTable3
       + "\n" + " WHERE t_recordType = " + RECORDTYPE_INVCARD
       + "\n" + "   AND t_part = " + getSqlString(partNumber)
       + "\n" + "   AND " + accountCondition
       + "\n" + " GROUP BY ROLLUP (t_counter, t_column, t_secureCode, (t_account, t_purpose, t_ownerName, t_isOwnerNotResident))"
       + "\n" + "HAVING GROUPING_ID(t_counter, t_column, t_secureCode) = 0"
       + "\n" + "UNION ALL"
       + "\n" + "SELECT DECODE(GROUPING(t_secureCode), 0, CHR(1), t_counter) AS t_counterString,"
       + "\n" + "       CASE"
       + "\n" + "           WHEN GROUPING(t_secureCode) = 1"
       + "\n" + "               THEN 'Коллекция ИК'"
       + "\n" + "           WHEN GROUPING(t_account) = 0"
       + "\n" + "               THEN CHR(1)"
       + "\n" + "           ELSE '    ИК ' || t_secureCode"
       + "\n" + "        END AS t_secureCodeString,"
       + "\n" + "       DECODE(GROUPING(t_secureCode), 0, CHR(1), t_column) AS t_columnString,"
       + "\n" + "       NVL(t_account, CHR(1)) AS t_accountString,"
       + "\n" + "       SUM(t_amount) AS t_amount,"
       + "\n" + "       NVL(t_purpose, CHR(1)) AS t_purposeString,"
       + "\n" + "       NVL(t_ownerName, CHR(1)) AS t_ownerNameString,"
       + "\n" + "       NVL(t_isOwnerNotResident, CHR(0)) AS t_isOwnerNotResidentString,"
       + "\n" + "       t_counter AS t_counter,"
       + "\n" + "       t_secureCode AS t_secureCode,"
       + "\n" + "       t_column AS t_column,"
       + "\n" + "       t_account AS t_account"
       + "\n" + "  FROM " + TempTable3
       + "\n" + " WHERE t_recordType = " + RECORDTYPE_COLLECTION
       + "\n" + "   AND t_part = " + getSqlString(partNumber)
       + "\n" + "   AND " + accountCondition
       + "\n" + " GROUP BY ROLLUP (t_counter, t_column, t_secureCode, (t_account, t_purpose, t_ownerName, t_isOwnerNotResident))"
       + "\n" + "HAVING GROUPING_ID(t_counter, t_column, t_secureCode) IN (0, 1)"
       + "\n" + " ORDER BY t_counter, t_secureCode NULLS FIRST, t_account NULLS FIRST";

        return query;

    end;

    macro printPart(header, partNumber)

        var protocol = CTableReport(0);

        var data;
        var hasData = false;
        var hasPartData;

        protocol.addColumn("", 1, AL_CENTER);

        if (RcbApplication().currentReport.context.period.endDate >= RCB_I2055_DATE2)
            protocol.addColumn("N п/п", 3., AL_CENTER);
        end;

        protocol.addColumn("Код ценной бумаги",                                               30., AL_LEFT);
        protocol.addColumn("Графа",                                                            7., AL_CENTER);
        protocol.addColumn("Номер лицевого счета депо",                                       25., AL_LEFT);
        protocol.addColumn("Количество ц/б на лицевом счете",                                 24., AL_RIGHT);
        protocol.addColumn("Тип счета депо по назначению",                                    24., AL_LEFT);
        protocol.addcolumn("Владелец",                                                        20., AL_LEFT);
        protocol.addColumn("Н",                                                                1., AL_CENTER);
        protocol.addcolumn("Примечание",                                                      24., AL_LEFT);

        protocol.printHead("          " + header);

        data = TRsbDataset(getPartQuery(partNumber, false));

        hasPartData = printAccounts(protocol, data);
        hasData = hasData or hasPartData;

        if (hasData)
            protocol.printSeparator();
        end;

        data = TRsbDataset(getPartQuery(partNumber, true));

        hasPartData = printAccounts(protocol, data);
        hasData = hasData or hasPartData;

        if (hasData)
            protocol.printBottom();
        else
            println(strAlign("Нет данных", protocol.getSumLen(), STR_ALIGN_CENTER));
        end;

    end;

    updateRecordType();

    updateCounter("Ф711_3_1", "1.3.1");

    updateCounter("Ф711_3_2", "1.3.2");

    println();

    if (RcbApplication().currentReport.context.period.endDate < RCB_I2055_DATE2)
        println("Раздел 3 \"Список ценных бумаг, учитываемых в депозитарии на счетах депо\"");
        printPart("3.1. Ценные бумаги, учитываемые на счетах депо клиентов депозитария", "1.3.1");
        println();
        printPart("3.2. Ценные бумаги, учитываемые на счетах депо кредитной организации", "1.3.2");
    else
        println("Подраздел 1.3 \"Список ценных бумаг, учитываемых в депозитарии на счетах депо\"");
        printPart("1.3.1. Ценные бумаги, учитываемые на счетах депо клиентов депозитария", "1.3.1");
        println();
        printPart("1.3.2. Ценные бумаги, учитываемые на счетах депо кредитной организации", "1.3.2");
    end;

end;

macro calculatePart4()
    var report         : Object = RcbApplication.currentReport;
    var attributeValue : Object = report.attributeValue("Ф711_4");

    var filter;
    var departmentList = RcbDepartmentList().getAsSqlSetFull();

    var dataSet        : Object = null;
    var compositeValue : Object = null;

    filter = "dp_dep.t_code IN " + departmentList + " AND dp_dep.t_code != " + string(report.context.departmentCode);

    filter = filter + " AND dp_dep.t_nodeType = 1"
                +"\n"+ " AND EXISTS (SELECT 1"
                +"\n"+ "               FROM dpartyown_dbt partyown"
                +"\n"+ "              WHERE partyown.t_partyId = dp_dep.t_partyId "
                +"\n"+ "                AND partyown.t_partykind = " + PTK_DEPOSITORY + ")";

    var departmentDataSet = TRsbDataSet("SELECT DISTINCT t_departmentCode"
                                + "\n" + "  FROM " + tempTable
                                + "\n" + " WHERE t_depoType IN (1, 3)"
                                + "\n" + "   AND t_partyId NOT IN (SELECT t_partyId"
                                + "\n" + "                           FROM ddp_dep_dbt"
                                + "\n" + "                        )"
                                + "\n" + "   AND t_account = ''"
                                        );

    departmentList = "";

    while (departmentDataSet.next())
        departmentList = departmentList + "," + departmentDataSet.departmentCode;
    end;

    if (departmentList != "")
        departmentList = subStr(departmentList, 2);
        filter = filter + "\n" + "AND dp_dep.t_code IN (" + departmentList + ")";
    else
        // 27.08.2008 ABP Нет подчиненных филиалов, осуществляющих депозитарные операции с клиентами
        filter = "";
    end;

    if (filter != "")
        sql_execute("call rep_opt.resetDepartmentCodesCache()");
        sql_execute("call rep_opt.cacheDepartmentCodes(" + getSqlDate(report.context.period.endDate) + ", " + getSqlString(filter) + ")");

        dataSet = TRsbDataSet("SELECT COUNT(1)                                           AS t_nDepartment,"
                        +"\n"+ "       t_okatoCode                                        AS t_okatoCode,"
                        +"\n"+ "       (SELECT t_name"
                        +"\n"+ "          FROM dobjAttr_dbt"
                        +"\n"+ "         WHERE t_objectType = " + OBJTYPE_PARTY
                        +"\n"+ "           AND t_groupId    = " + RCB_OBJGROUP_PT_OKATO
                        +"\n"+ "           AND t_numInList  = t_okatoCode)                AS t_regionName"
                        +"\n"+ "  FROM drepdepcode_tmp data"
                        +"\n"+ " GROUP BY t_okatoCode");

        while (dataSet.moveNext())
            compositeValue = attributeValue.addValue();
            compositeValue.fieldValue("regionName").exact  = String(nvl(dataSet.regionName, " "));
            compositeValue.fieldValue("okatoCode").exact   = String(nvl(dataSet.okatoCode, " "));
            compositeValue.fieldValue("nDepartment").exact = Int(dataSet.nDepartment);
        end;
    end;
end;

private class TSubpartitionAttributeFilter()
    macro isSuitable(val)
        return in(val.attribute.name, "Ф711_2_1", "Ф711_2_2", "Ф711_3_1", "Ф711_3_2", "Ф711_4");
    end;
end;

private macro fillCounterField()

    var counter;

    var iteratorLevel0 = RcbApplication().currentReport.createAttributeValueIterator();
    var iteratorLevel1;
    var sorter;

    iteratorLevel0.setFilter(TSubpartitionAttributeFilter());

    iteratorLevel0.first();
    while (not iteratorLevel0.isDone())

        if (iteratorLevel0.currentItem.attribute.name == "Ф711_2_1")
            sorter = TSubpartition21ValuesSorter();
        elif (iteratorLevel0.currentItem.attribute.name == "Ф711_2_2")
            sorter = TSubpartition22ValuesSorter();
        elif (iteratorLevel0.currentItem.attribute.name == "Ф711_3_1")
            sorter = TSubpartition31ValuesSorter();
        elif (iteratorLevel0.currentItem.attribute.name == "Ф711_3_2")
            sorter = TSubpartition32ValuesSorter();
        else
            sorter = TSubpartition4ValuesSorter();
        end;

        counter = 0;

        iteratorLevel1 = iteratorLevel0.currentItem.createValueIterator();

        iteratorLevel1.setSortOrder(sorter);

        iteratorLevel1.first();
        while (not iteratorLevel1.isDone())

            counter = counter + 1;

            if (iteratorLevel0.currentItem.attribute.name == "Ф711_4")
                iteratorLevel1.currentItem.fieldValue("counter").exact = counter;
            else
                iteratorLevel1.currentItem.fieldValue("Номер п/п").exact = counter;
            end;

            iteratorLevel1.next();

        end;

        iteratorLevel0.next();
    end;
end;

/**
 * Заполнение переменной Ф711_Гр61_ввод строками
 */
private macro fillColumn61()

    if (RcbApplication().currentReport.context.period.endDate < RCB_I2539_DATE)
        return;
    end;

    var column61Manual;
    var part132 = RcbApplication().currentReport.attributeValue("Ф711_3_2").createValueIterator();

    part132.first();
    while (not part132.isDone())
        column61Manual = RcbApplication().currentReport.attributeValue("Ф711_Гр61_ввод").addValue(RCB_NEW_VALUE_ID);

        column61Manual.fieldValue("Номер п/п").exact         = part132.currentItem.fieldValue("Номер п/п").exact;
        column61Manual.fieldValue("Эмитент").exact           = part132.currentItem.fieldValue("Эмитент").exact;
        column61Manual.fieldValue("Идентификатор ц/б").exact = part132.currentItem.fieldValue("Идентификатор ц/б").exact;
        column61Manual.fieldValue("Эмитент").exact           = part132.currentItem.fieldValue("Эмитент").exact;
        column61Manual.fieldValue("Графа 61 ввод").exact     = 0;

        column61Manual.recalculateScaled();

        part132.next();
    end;
end;

/* ====================== Точка входа в программу ========================= */
/**
 * Предварительный расчет
 * Вычисление значений переменных, подготовка переменных пользовательского ввода к заполнению значениями
 */
macro prepareCalculate()

    private var sqlProfiler = TSqlProfiler(getTxtFileName("!f711precalc_sqlProfile"));
    sqlProfiler.clear();
    sqlProfiler.on();

    initialize();

    var onlyLoaded = "", queryText, dataSet;

    queryText =  "SELECT t_flag1"
        + "\n" + "  FROM dcy_rdate_dbt"
        + "\n" + " WHERE t_issummary  = " + RcbSqlBool(RcbApplication().parameters.isSummaryMode)
        + "\n" + "   AND t_organizationstructure = "+ rcbApplication().currentReport.context.organizationStructure
        + "\n" + "   AND t_issuemode  = " + rcbApplication().currentReport.context.issueMode
        + "\n" + "   AND t_inumdprt   = " + string(rcbApplication().currentReport.context.departmentCode)
        + "\n" + "   AND t_bdrepdate  = " + getsqlDate(rcbApplication().currentReport.context.period.endDate)
        + "\n" + "   AND t_bdprevdate = " + getSqlDate(rcbApplication().currentReport.context.period.beginDate)
        + "\n" + "   AND t_iformid    = " + string(НайтиИдентификаторОтчетаПоНазванию(rcbApplication().currentReport.form.id))
        + "\n" + "   AND t_cvarkind   = chr(0)";

    dataSet = TRsbDataSet(queryText);
    if (dataSet.moveNext())
        onlyLoaded = dataSet.flag1;
    end;

    if (onlyLoaded)
        TCalculatorSection1_Loaded().calculate();
        TCalculatorSection3_Loaded().calculate();
    elif ((RcbApplication().currentReport.context.period.endDate >= RCB_I5986_DATE) or
          (RcbApplication().currentReport.context.period.endDate >= RCB_I5456_DATE) or
          is4927ChangesProject())
        TCalculatorSection1_5456().calculate();
        TCalculatorSection2().calculate();
        TCalculatorSection3().calculate();
        TCalculatorSection4().calculate();
    elif (RcbApplication().currentReport.context.period.endDate >= RCB_I3129_DATE3)
        TCalculatorSection1().calculate();
        TCalculatorSection2().calculate();
        TCalculatorSection3().calculate();
    elif (RcbApplication().currentReport.context.period.endDate >= RCB_I3129_DATE2)
        TCalculatorSection1().calculate();
        TCalculatorSection2().calculate();
    else
        FillTempTable();
        Department_1();
        Department_2();
        TCalculatorPart3().calculate();

        if (RcbApplication().currentReport.context.period.endDate < RCB_I2627_DATE)
            calculatePart4();
        end;

        fillCounterField();
        fillColumn61();
        TCalculatorSection2().calculate();

        RcbApplication().transactionManager.commit();

        if (RcbApplication().currentReport.context.period.endDate < RCB_I2539_DATE)

            if (rcbApplication().currentReport.context.period.endDate >= RCB_I2055_DATE2)
                printProtocolInterDepo();
            end;

            printProtocolDepo();

            ViewFileLog(ИмяФайлаПротокола);

        else
            msgbox("Предварительный расчет завершен");
        end;
    end;

    УстановитьФлагВозврата( OK_MACRO_FLAG ); // Успешное завершение макроса
    exit(1);
end;

/**
 * Сортировщик для синхронизируемых итераторов
 * Для переменных Ф711_Гр61_ввод, Ф711_3_2
 */
private class TSyncSorter()
    macro isLess(lhs : Object, rhs : Object)
        return lhs.fieldValue("Номер п/п").exact < rhs.fieldValue("Номер п/п").exact;
    end;
end;

/**
 * Сортировщик для синхронизируемых итераторов
 * Для переменных первого раздела
 */
private class TSyncSorterPart1()
    macro isLess(lhs : Object, rhs : Object)
        return nvl(lhs.fieldValue("counter").exact, -1) < nvl(rhs.fieldValue("counter").exact, -1);
    end;
end;

/**
 * Сортировщик для синхронизируемых итераторов
 * Для переменных 3-го раздела
 */
private class TSyncSorterPart3()
    macro isLess(lhs : Object, rhs : Object)
        return nvl(lhs.fieldValue("counter").exact, -1) < nvl(rhs.fieldValue("counter").exact, -1);
    end;
end;

/**
 * Основной расчет
 * Корректировка значений переменных с учетом значений переменных пользовательского ввода
 * Реализация через синхронизацию итераторов.
 */
macro calculate()

    private var sqlProfiler = TSqlProfiler(getTxtFileName("!f711calc_sqlProfile"));
    sqlProfiler.clear();
    sqlProfiler.on();

    var column61ManualValue;
    var column61Manual;

    var protocol_11;
    var protocol_23;
    var protocol_3;
    var part13;
    var part132;
    var part13User;
    var part3;
    var part3User;

    var synchronizer;

    if (RcbApplication().currentReport.context.period.endDate >= RCB_I3129_DATE3)
        part13 = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_Подраздел_1_3").createValueIterator();
        part13User = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_3_Ввод").createValueIterator();

        part13.setSortOrder(TSyncSorterPart1());
        part13User.setSortOrder(TSyncSorterPart1());

        synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_INNER_JOIN, TSyncSorterPart1());
        synchronizer.addIterator(part13);
        synchronizer.addIterator(part13User);

        synchronizer.moveFirst();
        while (not synchronizer.isDone())
            part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact, part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact);
            part13.currentItem.fieldValue("СвоиЦБ_Займ").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_Займ").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact, 0.0);

            part13.currentItem.fieldValue("СвоиЦБ_Всего").exact = part13.currentItem.fieldValue("СвоиЦБ_ОснБаланс").exact      +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact, part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact)     +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_Займ").exact, 0.0)         +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact, 0.0) +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact, 0.0)    +
                                                      part13.currentItem.fieldValue("СвоиЦБ_ЗачислОшибочно").exact             +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact, 0.0);

            part13.currentItem.fieldValue("СвоиЦБ_Всего").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_Займ").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_Безнадежн").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_ИныеПричины").recalculateScaled();
            synchronizer.moveNext();
        end;
        RcbApplication().transactionManager.commit();

        protocol_11 = TProtocolDataPart11();

        protocol_11.beginProtocol();
        protocol_11.print()();

        protocol_23 = TProtocolDataPart1_23(2);

        protocol_23.beginProtocol();
        protocol_23.print()();

        protocol_23 = TProtocolDataPart1_23(3);
        protocol_23.beginProtocol();
        protocol_23.print()();

        part3     = RcbApplication().currentReport.attributeValue("Ф711_Раздел3").createValueIterator();
        part3User = RcbApplication().currentReport.attributeValue("Ф711_Раздел3_Ввод").createValueIterator();

        part3.setSortOrder(TSyncSorterPart3());
        part3User.setSortOrder(TSyncSorterPart3());

        synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_INNER_JOIN, TSyncSorterPart3());
        synchronizer.addIterator(part3);
        synchronizer.addIterator(part3User);

        synchronizer.moveFirst();
        while (not synchronizer.isDone())
            part3.currentItem.fieldValue("SaleREPOAmount").exact      = NVL(part3User.currentItem.fieldValue("SaleREPOAmount").exact,      part3.currentItem.fieldValue("SaleREPOAmount").exact);
            part3.currentItem.fieldValue("TransLoanAmount").exact     = NVL(part3User.currentItem.fieldValue("TransLoanAmount").exact,     part3.currentItem.fieldValue("TransLoanAmount").exact);
            part3.currentItem.fieldValue("BuyREPOAmount").exact       = NVL(part3User.currentItem.fieldValue("BuyREPOAmount").exact,       part3.currentItem.fieldValue("BuyREPOAmount").exact);
            part3.currentItem.fieldValue("AcceptLoanAmount").exact    = NVL(part3User.currentItem.fieldValue("AcceptLoanAmount").exact,    part3.currentItem.fieldValue("AcceptLoanAmount").exact);
            part3.currentItem.fieldValue("TransDUAmount").exact       = NVL(part3User.currentItem.fieldValue("TransDUAmount").exact,       part3.currentItem.fieldValue("TransDUAmount").exact);
            part3.currentItem.fieldValue("TransRightsDUAmount").exact = NVL(part3User.currentItem.fieldValue("TransRightsDUAmount").exact, part3.currentItem.fieldValue("TransRightsDUAmount").exact);
            part3.currentItem.fieldValue("TransPledgeBOAmount").exact = NVL(part3User.currentItem.fieldValue("TransPledgeBOAmount").exact, part3.currentItem.fieldValue("TransPledgeBOAmount").exact);
            part3.currentItem.fieldValue("TransPledgeAmount").exact   = NVL(part3User.currentItem.fieldValue("TransPledgeAmount").exact,   part3.currentItem.fieldValue("TransPledgeAmount").exact);
            part3.currentItem.fieldValue("AcceptPledgeAmount").exact  = NVL(part3User.currentItem.fieldValue("AcceptPledgeAmount").exact,  part3.currentItem.fieldValue("AcceptPledgeAmount").exact);
            part3.currentItem.fieldValue("note").exact                = NVL(part3User.currentItem.fieldValue("note").exact, "");

            part3.currentItem.fieldValue("SaleREPOAmount").recalculateScaled();
            part3.currentItem.fieldValue("TransLoanAmount").recalculateScaled();
            part3.currentItem.fieldValue("BuyREPOAmount").recalculateScaled();
            part3.currentItem.fieldValue("AcceptLoanAmount").recalculateScaled();
            part3.currentItem.fieldValue("TransDUAmount").recalculateScaled();
            part3.currentItem.fieldValue("TransRightsDUAmount").recalculateScaled();
            part3.currentItem.fieldValue("TransPledgeBOAmount").recalculateScaled();
            part3.currentItem.fieldValue("TransPledgeAmount").recalculateScaled();
            part3.currentItem.fieldValue("AcceptPledgeAmount").recalculateScaled();
            part3.currentItem.fieldValue("note").recalculateScaled();
            synchronizer.moveNext();
        end;

        RcbApplication().transactionManager.commit();

        protocol_3 = TProtocolDataPart3();
        protocol_3.beginProtocol(true);
        protocol_3.print();

        ViewFileLog(ИмяФайлаПротокола);

    elif (RcbApplication().currentReport.context.period.endDate >= RCB_I3129_DATE2)
        part13 = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_Подраздел_1_3").createValueIterator();
        part13User = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_3_Ввод").createValueIterator();

        part13.setSortOrder(TSyncSorterPart1());
        part13User.setSortOrder(TSyncSorterPart1());

        synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_INNER_JOIN, TSyncSorterPart1());
        synchronizer.addIterator(part13);
        synchronizer.addIterator(part13User);

        synchronizer.moveFirst();
        while (not synchronizer.isDone())
            part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact, part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact);
            part13.currentItem.fieldValue("СвоиЦБ_Займ").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_Займ").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact, 0.0);
            part13.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact = NVL(part13User.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact, 0.0);

            part13.currentItem.fieldValue("СвоиЦБ_Всего").exact = part13.currentItem.fieldValue("СвоиЦБ_ОснБаланс").exact      +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact, part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact)     +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_Займ").exact, 0.0)         +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact, 0.0) +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact, 0.0)    +
                                                      part13.currentItem.fieldValue("СвоиЦБ_ЗачислОшибочно").exact             +
                                                      NVL(part13User.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact, 0.0);

            part13.currentItem.fieldValue("СвоиЦБ_Всего").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_Займ").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_Безнадежн").recalculateScaled();
            part13.currentItem.fieldValue("СвоиЦБ_ИныеПричины").recalculateScaled();
            synchronizer.moveNext();
        end;
        RcbApplication().transactionManager.commit();

        protocol_11 = TProtocolDataPart11();

        protocol_11.beginProtocol();
        protocol_11.print()();

        protocol_23 = TProtocolDataPart1_23(2);

        protocol_23.beginProtocol();
        protocol_23.print()();

        protocol_23 = TProtocolDataPart1_23(3);
        protocol_23.beginProtocol();
        protocol_23.print()();
        ViewFileLog(ИмяФайлаПротокола);
    elif (RcbApplication().currentReport.context.period.endDate >= RCB_I2539_DATE)

        column61Manual = RcbApplication().currentReport.attributeValue("Ф711_Гр61_ввод").createValueIterator();
        part132 = RcbApplication().currentReport.attributeValue("Ф711_3_2").createValueIterator();

        column61Manual.setSortOrder(TSyncSorter());
        part132.setSortOrder(TSyncSorter());

        synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_INNER_JOIN, TSyncSorter());
        synchronizer.addIterator(column61Manual);
        synchronizer.addIterator(part132);

        synchronizer.moveFirst();
        while (not synchronizer.isDone())

            column61ManualValue = column61Manual.currentItem.fieldValue("Графа 61 ввод");
            if (column61ManualValue.isDefined())
                column61ManualValue = column61ManualValue.exact;
            else
                column61ManualValue = 0;
            end;
            part132.currentItem.fieldValue("Графа 50").exact = part132.currentItem.fieldValue("Графа 50").exact - column61ManualValue; //Гр. 56
            part132.currentItem.fieldValue("Графа 55").exact = part132.currentItem.fieldValue("Графа 55").exact + column61ManualValue; //Гр. 61
            part132.currentItem.recalculateScaled();

            synchronizer.moveNext();
        end;

        RcbApplication().currentReport.attributeValue("Ф711_3_2").summarizeDependentValues(RCB_SU_EXACT);
        RcbApplication().transactionManager.commit();

        setOutput(ИмяФайлаПротокола, true);

        printProtocolInterDepo();
        printProtocolDepo();

        ViewFileLog(ИмяФайлаПротокола);

    else
        msgbox("Для отчетных дат, предшествующих дате вступления в силу указания 2539-У, операция не определена");
    end;

    УстановитьФлагВозврата(OK_MACRO_FLAG); // Успешное завершение макроса
    exit(1);
end;
