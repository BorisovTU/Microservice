/*
$Name:        f302Normalizer.mac
$Module:      ê•£´†¨•≠‚®‡„•¨†Ô Æ‚Á•‚≠Æ·‚Ï
$Description: îÆ‡¨† 302. çÆ‡¨†´®ß†Ê®Ô
*/

import ä†´•≠§†‡Ï;
import RcbLibrary;
import RcbProtocolView;
import rcbconst;
import ReptcbCommon;
import ReportNormalizer;
import ReportLinearRelation;
import RcbGlobal;
import balanceAttribute;
import RcbArTuneTable;

class (ReportNormalizer) TF302ReportNormalizer(protocolView)
    private var m_balanceReports = TArray();
    private var m_okatoPart1     = TArray();
    private var m_okatoPart2     = TArray();
    private var m_fieldNamePart1 = TArray();
    private var m_fieldNamePart2 = TArray();
    private var m_report         = rcbApplication.currentReport;
    private var m_rowsPart1;
    private var m_rowsPart2;
    private var m_protocolView;
    private var m_yearReport;
    private var m_monthReport;
    private var m_part1BeginColumn;
    private var m_part1EndColumn;
    private var m_part2BeginColumn;
    private var m_part2EndColumn;
    private const ROW_KIND       = TRowKind();
    private const COLUMN_KIND    = TColumnKind();

    macro fillFieldsNameAndCounts()
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleSum";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencySum";
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencyDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleDelayedDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencyDelayedDebt";

        m_fieldNamePart2[m_fieldNamePart2.size] = "rubObtainedFundsRest";
        m_fieldNamePart2[m_fieldNamePart2.size] = "curObtainedFundsRest";

        m_part1BeginColumn = 4;
        m_part1EndColumn   = 9;
        m_part2BeginColumn = 4;
        m_part2EndColumn   = 5;
    end;

    macro contructorTF302ReportNormalizer(protocolView)
        initReportNormalizer(rcbApplication.currentReport.multiplier);
        m_protocolView = protocolView;

        dateSplit(m_report.context.period.endDate, NULL, m_monthReport, m_yearReport);

        fillFieldsNameAndCounts();
    end;

    macro getNodeId(part, okato, row, column)
        return "ê†ß§•´" + part + "_" + okato + "_" + row + "_" + column;
    end;

    macro getRowsPart1()
        if (m_rowsPart1 == NULL)
            m_rowsPart1 = RcbArray().initialize("2", "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.2.1", "2.1.2.2", "2.1.2.3", "2.1.2.4", "2.1.2.5", "2.1.2.6",
                                                "2.1.2.7", "2.1.2.8", "2.1.2.8.1", "2.1.2.9", "2.1.2.9.1", "2.1.3", "2.1.4", "2.1.4.1", "2.1.5", "2.1.5.1",
                                                "2.1.6", "2.1.6.1", "2.1.7", "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1", "3");
        end;

        return m_rowsPart1;
    end;

    macro getRowsPart2()
        if (m_rowsPart2 == NULL)
            m_rowsPart2 = RcbArray().initialize("1.1", "1.2", "1.3", "1.4", "1.5", "1.6", "1.7", "1.8", "1.9");
        end;

        return m_rowsPart2;
    end;

    macro addRuleForAoOkatoPart1(rows, sign)
        var i = 0;
        var j;
        var column;
        var node;
        var nodeOkato;
        var isFoundAoOkato;
        var okatoCount = m_okatoPart1.size;
        while (i < okatoCount)
            if (subStr(m_okatoPart1[i], 3,3) == "000")
                rows.moveFirst();
                while (rows.moveNext())
                    column = m_part1BeginColumn;
                    while (column <= m_part1EndColumn)
                        j = 0;
                        isFoundAoOkato = false;
                        while (j < okatoCount)
                            if ((not (subStr(m_okatoPart1[j], 3,3) == "000")) and (subStr(m_okatoPart1[i], 1,2) == subStr(m_okatoPart1[j], 1,2)))
                                if(not isFoundAoOkato);
                                    var relation = ReportLinearRelation(sign);
                                    nodeOkato = normalizer.node(getNodeId(1, m_okatoPart1[i], rows.getCurrentItem(), column));

                                    isFoundAoOkato = true;
                                end;
                                if (not valType(nodeOkato) == V_UNDEF)
                                    node = normalizer.node(getNodeId(1, m_okatoPart1[j], rows.getCurrentItem(), column));
                                    relation.rhs.plus(nvl(node, 0.0));
                                end;
                            end;
                            j = j + 1;
                        end;
                        if ((not valType(relation) == V_UNDEF) and (isFoundAoOkato) and (not valType(nodeOkato) == V_UNDEF))
                            relation.lhs.plus(nodeOkato);
                            this.addRelation(relation);
                         end;
                        column = column + 1;
                    end;
                end;
            end;
            i = i + 1;
        end;
    end;

    macro addRulesForRow1Part1(beginColumn, endColumn, sign, rhsRows : RcbArray)
        var i;
        var col;
        var node;

        col = beginColumn;
        while (col <= endColumn)
            node = normalizer.node(getNodeId(1, "", "1", col));
            if (not valType(node) == V_UNDEF)
                var relation = ReportLinearRelation(sign);
                relation.lhs.plus(node);
                i = 0;
                while (i < m_okatoPart1.size)
                    if (subStr(m_okatoPart1[i], 3,3) == "000")
                        rhsRows.moveFirst();
                        while (rhsRows.moveNext())
                            relation.rhs.plus(nvl(normalizer.node(getNodeId(1, m_okatoPart1[i], rhsRows.getCurrentItem(), col)), 0.0));
                        end;

                        this.addRelation(relation);
                    end;
                   i = i + 1;
                end;
            end;

            col = col + 1;
        end;
    end;

    macro addRuleForRowsPart1(rows : RcbArray, lhsColumns : RcbArray, sign, rhsColumns : RcbArray)
        var i = 0;
        var column;
        var node;

        while (i < m_okatoPart1.size)
            rows.moveFirst();
            while (rows.moveNext())
                lhsColumns.moveFirst();
                while (lhsColumns.moveNext())
                    node = normalizer.node(getNodeId(1, m_okatoPart1[i], rows.getCurrentItem(), lhsColumns.getCurrentItem()));
                    if (not valType(node) == V_UNDEF)
                        var relation = ReportLinearRelation(sign);
                        relation.lhs.plus(node);
                    end;
                end;

                if (not valType(relation) == V_UNDEF)
                    rhsColumns.moveFirst();
                    while (rhsColumns.moveNext())
                        relation.rhs.plus(nvl(normalizer.node(getNodeId(1, m_okatoPart1[i], rows.getCurrentItem(), rhsColumns.getCurrentItem())), 0.0));
                    end;

                    this.addRelation(relation);
                end;
            end;
            i = i + 1;
        end;
    end;

    macro addRulesForRowByOkato(part, beginColumn, endColumn, row, sign, rhsRows : RcbArray)
        var okatoArray = ternary(part == 1, m_okatoPart1, m_okatoPart2);
        var i          = 0;
        var col;
        var node;

        while (i < okatoArray.size)
            col = beginColumn;
            while (col <= endColumn)
                node = normalizer.node(getNodeId(part, okatoArray[i], row, col));
                if (not valType(node) == V_UNDEF)
                    var relation = ReportLinearRelation(sign);
                    relation.lhs.plus(node);

                    rhsRows.moveFirst();
                    while (rhsRows.moveNext())
                        relation.rhs.plus(nvl(normalizer.node(getNodeId(part, okatoArray[i], rhsRows.getCurrentItem(), col)), 0.0));
                    end;

                    this.addRelation(relation);
                end;
                col = col + 1;
            end;

            i = i + 1;
        end;

    end;

    macro getFieldName(part, column)
         if (part == 1)
            return m_fieldNamePart1[column - 4];
         else
            return m_fieldNamePart2[column - 4];
         end;

        return
    end;

    private macro initializeNode(part, beginColumn, endColumn, attribute)
        var node;
        var nodeId;
        var i = beginColumn;

        while (i <= endColumn)
            nodeId = getNodeId(part, attribute.fieldValue("okatoCode").currentAsString, attribute.fieldValue("row").currentAsString, i);
            node = normalizer.addNode(nodeId);

            node.setExact(attribute.fieldValue(getFieldName(part, i)).exact);
            node.setScaled(attribute.fieldValue(getFieldName(part, i)).scaled);

            i = i + 1;
        end;
    end;

    macro getBalanceSum(balanceReport, balance : RcbArray, rowKind, columnKind)
        var balanceAttribute = TBalanceAttribute("ÅÄãÄçë", balanceReport, TBalanceAttributeMode.READ_ONLY);
        var sumBalance       = 0.0;
        var currentBalance;
        var endBalance;
        var attr;
        var pos;

        balance.moveFirst();
        while (balance.moveNext())
            pos = index(balance.getCurrentItem(), "-");
            if (pos > 0)
                currentBalance = int(subStr(balance.getCurrentItem(), 1, pos));
                endBalance     = int(subStr(balance.getCurrentItem(), pos + 1));
            else
                currentBalance = int(balance.getCurrentItem());
                endBalance     = currentBalance;
            end;

            while (currentBalance <= endBalance)
                attr = balanceAttribute.getBalanceAttributeValue(1, string(currentBalance), columnKind, rowKind);

                if (not valType(attr) == V_UNDEF)
                    sumBalance = sumBalance + attr.scaled;
                end;

                currentBalance = currentBalance + 1;
            end;
        end;

        return sumBalance;
    end;

    /* ÑÆ°†¢´•≠®• „ß´Æ¢ ê†ß§•´† 1 */
    macro addNodesForPart1()
        var row1Iterator = m_report.attributeValue("ê†ß§•´1").createValueIterator();
        var rowIterator;
        var okatoIterator;

        row1Iterator.moveFirst();

        if (not row1Iterator.isDone())
            initializeNode(1, m_part1BeginColumn, m_part1EndColumn, row1Iterator.currentItem());

            okatoIterator = row1Iterator.currentItem().createValueIterator();
            okatoIterator.moveFirst();

            while (not okatoIterator.isDone())
                rowIterator = okatoIterator.currentItem().createValueIterator();
                rowIterator.moveFirst();

                while (not rowIterator.isDone())
                    initializeNode(1, m_part1BeginColumn, m_part1EndColumn, rowIterator.currentItem());

                    rowIterator.moveNext();
                end;

                m_okatoPart1[m_okatoPart1.size] = okatoIterator.currentItem().fieldValue("okatoCode").currentAsString;
                okatoIterator.moveNext();
            end;
        end;
    end;

    /* ÑÆ°†¢´•≠®• „ß´Æ¢ ê†ß§•´† 2*/
    macro addNodesForPart2()
        var okatoIterator = m_report.attributeValue("ê†ß§•´2").createValueIterator();
        var rowIterator;

        okatoIterator.moveFirst();
        while (not okatoIterator.isDone())
            rowIterator = okatoIterator.currentItem().createValueIterator();
            rowIterator.moveFirst();

            while (not rowIterator.isDone())
                initializeNode(2, m_part2BeginColumn, m_part2EndColumn, rowIterator.currentItem());

                rowIterator.moveNext();
            end;

            m_okatoPart2[m_okatoPart2.size] = okatoIterator.currentItem().fieldValue("okatoCode").currentAsString;
            okatoIterator.moveNext();
        end;
    end;

    macro addRulesForPart1Totals();
        addRuleForAoOkatoPart1(getRowsPart1(), RCB_RS_GREATER_OR_EQUAL);

        addRulesForRow1Part1(m_part1BeginColumn, m_part1EndColumn, RCB_RS_EQUAL, RcbArray().initialize("2", "3"));

        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2",       RCB_RS_EQUAL,            RcbArray().initialize("2.1", "2.2"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1",     RCB_RS_EQUAL,            RcbArray().initialize("2.1.1", "2.1.2", "2.1.3", "2.1.4", "2.1.5",
                                                                                                                                 "2.1.6", "2.1.7", "2.1.8", "2.1.9"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.1",   RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.1.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.2",   RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.2.1", "2.1.2.2", "2.1.2.3", "2.1.2.4", "2.1.2.5",
                                                                                                                                 "2.1.2.6", "2.1.2.7", "2.1.2.8", "2.1.2.9"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.2.8", RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.2.8.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.2.9", RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.2.9.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.4",   RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.4.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.5",   RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.5.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.1.6",   RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.1.6.1"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.3",     RCB_RS_LESS_OR_EQUAL,    RcbArray().initialize("2"));
        addRulesForRowByOkato(1, m_part1BeginColumn, m_part1EndColumn, "2.3",     RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("2.3.1"));

        addRuleForRowsPart1(getRowsPart1(), RcbArray().initialize("8"), RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("6"));

        addRuleForRowsPart1(getRowsPart1(), RcbArray().initialize("9"), RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("7"));
    end;

    macro addRulesForPart2Totals();
        addRulesForRowByOkato(2, m_part2BeginColumn, m_part2EndColumn, "1", RCB_RS_GREATER_OR_EQUAL, getRowsPart2());
    end;

    macro getBalanceSumForPeriod(allBalanceReports, balance, rowKind, columnKind)
        var month = ternary(allBalanceReports, 1, m_monthReport);
        var sum = 0.0;

        while (month <= m_monthReport)
            sum = sum + getBalanceSum(m_balanceReports[month - 1], balance, rowKind, columnKind);
            month = month + 1;
        end;

        return sum;
    end;

    /* ÑÆ°†¢´•≠®• „·´Æ¢®Ô §´Ô ·‚‡Æ™® 1 1-£Æ ‡†ß§•´† */
    macro addRuleForRow1AndBalance(column, sign, balance, rowKind, columnKind, diff, allBalanceReports)
        var node = normalizer.node(getNodeId(1, "", "1", column));
        var beginMonth = 1;

        if (not valType(node) == V_UNDEF)
            var relation = ReportLinearRelation(sign);
            relation.lhs.plus(node);

            relation.rhs.plus(getBalanceSumForPeriod(allBalanceReports, balance, rowKind, columnKind) + diff);

            this.addRelation(relation);
        end;
    end;

    /* ÑÆ°†¢´•≠®• „·´Æ¢®Ô §´Ô 1-£Æ ‡†ß§•´† ØÆ ¢·•¨ éäÄíé*/
    macro addRuleForBalanceByOkato(row, column, minusColumn, sign, balance, rowKind, columnKind, allBalanceReports)
        var relation     = ReportLinearRelation(sign);
        var isFoundNodes = false;
        var okato        = 0;
        var node;

        while (okato < m_okatoPart1.size)
            node = normalizer.node(getNodeId(1, m_okatoPart1[okato], row, column));
            if (not valType(node) == V_UNDEF)
                isFoundNodes = true;

                relation.lhs.plus(node);

                if (minusColumn != "")
                    relation.lhs.minus(normalizer.node(getNodeId(1, m_okatoPart1[okato], row, minusColumn)));
                end;
            end;

            okato = okato + 1;
        end;

        if (isFoundNodes)
            relation.rhs.plus(getBalanceSumForPeriod(allBalanceReports, balance, rowKind, columnKind));

            this.addRelation(relation);
        end;
    end;

    /* ÑÆ°†¢´•≠®• „·´Æ¢®Ô §´Ô ‡†ß§•´† 2 ØÆ ¢·•¨ éäÄíé §´Ô Ø•‡•§†¢†•¨Æ© ·‚‡Æ™• ® £‡†‰•. ë„¨¨† ØÆ °†´†≠·Æ¢Î¨ ¢ÎÁ®·´Ô•‚·Ô ØÆ Ø‡†¢®´„:
        ë„¨¨†è†··®¢(balance) + ë„¨¨†1, £§•
        ë„¨¨†1 = Ö·´® (ë„¨¨†è†··®¢(addBalanceè) - ë„¨¨†Ä™‚®¢(addBalanceÄ)) > 0 ‚Æ ë„¨¨†è†··®¢(addBalanceè) - ë„¨¨†Ä™‚®¢(addBalanceÄ), ®≠†Á• 0
        addBalanceÄ ® addBalanceè °•‡„‚·Ô ®ß addBalance, ™Æ‚Æ‡Î©  Ø•‡•§†•‚·Ô ¢ ¢®§• ·‚‡Æ™® "addBalanceè-addBalanceÄ"
    */
    macro addRuleForBalancePart2(row, column, sign, balance, addBalance, rowKind)
        var relation     = ReportLinearRelation(sign);
        var isFoundNodes = false;
        var balanceSum   = 0.0;
        var okato        = 0;
        var addBalanceA;
        var addBalanceP;
        var node;
        var pos;

        while (okato < m_okatoPart2.size)
            node = normalizer.node(getNodeId(2, m_okatoPart2[okato], row, column));
            if (not valType(node) == V_UNDEF)
                isFoundNodes = true;

                relation.lhs.plus(node);
            end;

            okato = okato + 1;
        end;

        if (isFoundNodes)
            balanceSum = getBalanceSumForPeriod(false, balance, rowKind, COLUMN_KIND.PASSIVE_OUT_REST);

            if (valType(addBalance) == valType(RcbArray))
                addBalance.moveFirst();

                while (addBalance.moveNext())
                    pos = index(addBalance.getCurrentItem(), "-");

                    if (pos > 0)
                        addBalanceP = getBalanceSumForPeriod(false, RcbArray().initialize(subStr(addBalance.getCurrentItem(), 1, pos -1)), rowKind, COLUMN_KIND.PASSIVE_OUT_REST);
                        addBalanceA = getBalanceSumForPeriod(false, RcbArray().initialize(subStr(addBalance.getCurrentItem(), pos + 1))  , rowKind, COLUMN_KIND.ACTIVE_OUT_REST);

                        if ((addBalanceP - addBalanceA) > 0)
                            balanceSum = balanceSum + (addBalanceP - addBalanceA);
                        end;
                    end;
                end;
            end;

            relation.rhs.plus(balanceSum);

            this.addRelation(relation);
        end;
    end;

    macro addRulesForPart1WithBalance()
        addRuleForRow1AndBalance("6", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "20317", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409", "45502-45509", "45805-45815"),
                                 ROW_KIND.ROUBLE, COLUMN_KIND.ACTIVE_OUT_REST, 5, false);

        addRuleForRow1AndBalance("7", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "20317", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409", "45502-45509", "45805-45815"),
                                 ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, 5, false);

        addRuleForRow1AndBalance("8", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("20317", "45805-45815"), ROW_KIND.ROUBLE, COLUMN_KIND.ACTIVE_OUT_REST, 5, false);
        addRuleForRow1AndBalance("9", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("20317", "45805-45815"), ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, 5, false);

        addRuleForRow1AndBalance("4", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409", "45502-45509"),
                                 ROW_KIND.ROUBLE, COLUMN_KIND.DEBET, 0, true);

        addRuleForRow1AndBalance("5", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409", "45502-45509"),
                                 ROW_KIND.CURRENCY, COLUMN_KIND.DEBET, 0, true);

        addRuleForBalanceByOkato("2", "4", "", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409"),
                                 ROW_KIND.ROUBLE, COLUMN_KIND.DEBET, true);

        addRuleForBalanceByOkato("2", "5", "", RCB_RS_LESS_OR_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409"),
                                 ROW_KIND.CURRENCY, COLUMN_KIND.DEBET, true);

        addRuleForBalanceByOkato("3", "4", "", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("45502-45509"), ROW_KIND.ROUBLE, COLUMN_KIND.DEBET, true);
        addRuleForBalanceByOkato("3", "5", "", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("45502-45509"), ROW_KIND.CURRENCY, COLUMN_KIND.DEBET, true);

        addRuleForBalanceByOkato("2", "6", "8", RCB_RS_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409"),
                                 ROW_KIND.ROUBLE, COLUMN_KIND.ACTIVE_OUT_REST, false);

        addRuleForBalanceByOkato("2", "7", "9", RCB_RS_EQUAL,
                                 RcbArray().initialize("20311", "44501-44509", "44601-44609", "44701-44709", "44801-44809", "44901-44909", "45001-45009",
                                                       "45101-45109", "45201-45209", "45301-45309", "45401-45409"),
                                 ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, false);

        addRuleForBalanceByOkato("2", "8", "",  RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("20317", "45805-45814"), ROW_KIND.ROUBLE,   COLUMN_KIND.ACTIVE_OUT_REST, false);
        addRuleForBalanceByOkato("2", "9", "",  RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("20317", "45805-45814"), ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, false);
        addRuleForBalanceByOkato("3", "6", "8", RCB_RS_EQUAL,         RcbArray().initialize("45502-45509"),          ROW_KIND.ROUBLE,   COLUMN_KIND.ACTIVE_OUT_REST, false);
        addRuleForBalanceByOkato("3", "7", "9", RCB_RS_EQUAL,         RcbArray().initialize("45502-45509"),          ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, false);
        addRuleForBalanceByOkato("3", "8", "",  RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("45815"),                ROW_KIND.ROUBLE,   COLUMN_KIND.ACTIVE_OUT_REST, false);
        addRuleForBalanceByOkato("3", "9", "",  RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("45815"),                ROW_KIND.CURRENCY, COLUMN_KIND.ACTIVE_OUT_REST, false);
    end;

    macro addRulesForPart2WithBalance()
        addRuleForBalancePart2("1", "4", RCB_RS_LESS_OR_EQUAL,
                               RcbArray().initialize("20309", "20310", "30220", "30223", "30227", "30601",  "30606", "40101", "40105", "40106", "40116", "402", "40301", "40302",
                                                     "40306", "40312", "404", "405", "406", "407", "408", "40901", "40902", "40903", "40905", "40906", "40909", "40910", "40911",
                                                     "40912", "40913", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "425",
                                                     "426", "427", "428", "429", "430", "431", "432", "433", "434","435", "436", "437", "438", "439", "440", "47401", "47418",
                                                     "47601", "47602", "47603", "47605", "521", "522", "52403", "52404"),
                               RcbArray().initialize("40108-40109", "40110-40111", "40907-40908"),
                               ROW_KIND.ROUBLE);

        addRuleForBalancePart2("1", "5", RCB_RS_LESS_OR_EQUAL,
                               RcbArray().initialize("20309", "20310", "30220", "30223", "30227", "30601",  "30606", "40101", "40105", "40106", "40116", "402", "40301", "40302",
                                                     "40306", "40312", "404", "405", "406", "407", "408", "40901", "40902", "40903", "40905", "40906", "40909", "40910", "40911",
                                                     "40912", "40913", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "425",
                                                     "426", "427", "428", "429", "430", "431", "432", "433", "434","435", "436", "437", "438", "439", "440", "47401", "47418",
                                                     "47601", "47602", "47603", "47605", "521", "522", "52403", "52404"),
                               RcbArray().initialize("40108-40109", "40110-40111", "40907-40908"),
                               ROW_KIND.CURRENCY);

        addRuleForBalancePart2("1.1", "4", RCB_RS_LESS_OR_EQUAL,
                               RcbArray().initialize("40101", "40105", "40106", "40116"),
                               RcbArray().initialize("40108-40109", "40110-40111"),
                               ROW_KIND.ROUBLE);

        addRuleForBalancePart2("1.1", "5", RCB_RS_EQUAL,
                               RcbArray().initialize("40101", "40105", "40106", "40116"),
                               RcbArray().initialize("40108-40109", "40110-40111"),
                               ROW_KIND.CURRENCY);

         addRuleForBalancePart2("1.2", "4", RCB_RS_EQUAL, RcbArray().initialize("402"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.2", "5", RCB_RS_EQUAL, RcbArray().initialize("402"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.3", "4", RCB_RS_EQUAL, RcbArray().initialize("40301", "40302", "40306", "40312"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.3", "5", RCB_RS_EQUAL, RcbArray().initialize("40301", "40302", "40306", "40312"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.4", "4", RCB_RS_EQUAL, RcbArray().initialize("404"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.4", "5", RCB_RS_EQUAL, RcbArray().initialize("404"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.5", "4", RCB_RS_EQUAL, RcbArray().initialize("405", "406"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.5", "5", RCB_RS_EQUAL, RcbArray().initialize("405", "406"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.6", "4", RCB_RS_EQUAL, RcbArray().initialize("407"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.6", "5", RCB_RS_EQUAL, RcbArray().initialize("407"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.7", "4", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("40802", "40804", "40805", "40821", "421"),"", ROW_KIND.ROUBLE);
         addRuleForBalancePart2("1.7", "5", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("40802", "40804", "40805", "40821", "421"),"", ROW_KIND.CURRENCY);

         addRuleForBalancePart2("1.8", "4", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421",
                                                      "422", "425", "47601", "47602", "521", "52403"),
                                "", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.8", "5", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421",
                                                      "422", "425", "47601", "47602", "521", "52403"),
                                "", ROW_KIND.CURRENCY);

         addRuleForBalancePart2("1.9", "4", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "40803", "40806", "40809", "40812", "40813", "40814", "40815", "40817", "40818",
                                                      "40819", "40820", "423", "426", "47603", "47605",  "522", "52404"),
                                "", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.9", "5", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "40803", "40806", "40809", "40812", "40813", "40814", "40815", "40817", "40818",
                                                      "40819", "40820", "423", "426", "47603", "47605",  "522", "52404"),
                                "", ROW_KIND.CURRENCY);
    end;

    macro savePart1()
        var row1Iterator = m_report.attributeValue("ê†ß§•´1").createValueIterator();
        var rowIterator;
        var okatoIterator;
        var node;
        var i;
        var isHeadPrinted = false;
        var partNameLength = strLen("ê†ß§•´1_");

        row1Iterator.moveFirst();

        if (not row1Iterator.isDone())
            i = m_part1BeginColumn;
            while (i <= m_part1EndColumn)
                node = normalizer.node(getNodeId(1, "", row1Iterator.currentItem().fieldValue("row").currentAsString, i));
                if (not (valType(node) == V_UNDEF) )
                    if (not isHeadPrinted)
                        m_protocolView.printHeadTable("ê†ß§•´ 1");
                        isHeadPrinted = true;
                    end;

                    m_protocolView.printString(subStr(node.code(), partNameLength + 2), row1Iterator.currentItem().fieldValue(getFieldName(1, i)).exact, node.getScaled());

                    row1Iterator.currentItem().fieldValue(getFieldName(1, i)).scaled = node.getScaled();
                end;
                i = i + 1;
            end;

            okatoIterator = row1Iterator.currentItem().createValueIterator();
            okatoIterator.moveFirst();

            while (not okatoIterator.isDone())
                rowIterator = okatoIterator.currentItem().createValueIterator();
                rowIterator.moveFirst();

                while (not rowIterator.isDone())
                    i = m_part1BeginColumn;
                    while (i <= m_part1EndColumn)
                        node = normalizer.node(getNodeId(1, rowIterator.currentItem().fieldValue("okatoCode").currentAsString, rowIterator.currentItem().fieldValue("row").currentAsString, i));
                        if (not (valType(node) == V_UNDEF) )
                            if (not isHeadPrinted)
                                m_protocolView.printHeadTable("ê†ß§•´ 1");
                                isHeadPrinted = true;
                            end;

                            m_protocolView.printString(subStr(node.code(), partNameLength + 1), rowIterator.currentItem().fieldValue(getFieldName(1, i)).exact, node.getScaled());

                            rowIterator.currentItem().fieldValue(getFieldName(1, i)).scaled = node.getScaled();
                        end;
                        i = i + 1;
                    end;

                    rowIterator.moveNext();
                end;

                okatoIterator.moveNext();
            end;
        end;

        if (isHeadPrinted)
            m_protocolView.printEndTable();
        end;
    end;

    macro savePart2()
        var okatoIterator = m_report.attributeValue("ê†ß§•´2").createValueIterator();
        var rowIterator;
        var node;
        var i;
        var isHeadPrinted = false;
        var partNameLength = strLen("ê†ß§•´2_");

        okatoIterator.moveFirst();
        while (not okatoIterator.isDone())
            rowIterator = okatoIterator.currentItem().createValueIterator();
            rowIterator.moveFirst();

            while (not rowIterator.isDone())
                i = m_part2BeginColumn;
                while (i <= m_part2EndColumn)
                    node = normalizer.node(getNodeId(2, rowIterator.currentItem().fieldValue("okatoCode").currentAsString, rowIterator.currentItem().fieldValue("row").currentAsString, i));
                    if (not (valType(node) == V_UNDEF) )
                        if (not isHeadPrinted)
                            m_protocolView.printHeadTable("ê†ß§•´ 2");
                            isHeadPrinted = true;
                        end;

                        m_protocolView.printString(subStr(node.code(), partNameLength + 1), rowIterator.currentItem().fieldValue(getFieldName(2, i)).exact, node.getScaled());

                        rowIterator.currentItem().fieldValue(getFieldName(2, i)).scaled = node.getScaled();
                    end;
                    i = i + 1;
                end;

                rowIterator.moveNext();
            end;

            m_okatoPart2[m_okatoPart2.size] = okatoIterator.currentItem().fieldValue("okatoCode").currentAsString;
            okatoIterator.moveNext();
        end;

        if (isHeadPrinted)
            m_protocolView.printEndTable();
        end;
    end;

    macro fillBalanceReports()
        var month = 1;
        var context;

        while (month <= m_monthReport)
            context = RcbReportContext(RcbPeriod(date(1, month, m_yearReport), date(getDaysInMonth(date(1, month, m_yearReport)), month, m_yearReport)),
                                                 m_report.context.departmentCode,
                                                 m_report.context.issueMode,
                                                 m_report.context.organizationStructure,
                                                 m_report.context.isSummaryMode);

            m_balanceReports[m_balanceReports.size] = RcbApplication().objectFactory.createReport(m_report.form.id, context).createBalanceReport();

            month = month + 1;
        end;
    end;

    macro checkBalanceReports()
        var i = 0;
        var result = true;

        while (i < m_balanceReports.size())
            if   (m_balanceReports(i) == NULL)
                m_protocolView.printBalanceReportAbsence(i + 1, m_yearReport);

                result = false;
            elif (not m_balanceReports(i).isCalculated())
                m_protocolView.printBalanceReportAbsence(i + 1, m_yearReport);

                result = false;
            end;

            i = i + 1;
        end;

        return result;
    end;

    macro executeNormalization()
        addNodesForPart1();
        addNodesForPart2();

        addRulesForPart1Totals();
        addRulesForPart2Totals();

        fillBalanceReports();

        if (checkBalanceReports())
            addRulesForPart1WithBalance();
            addRulesForPart2WithBalance();
        else
            m_protocolView.printLine("", "çÆ‡¨†´®ß†Ê®Ô · ‰Æ‡¨Æ© 'Å†´†≠·Æ¢Î• ·Á•‚†' ≠• ¢ÎØÆ´≠Ô´†·Ï.");
        end;

        normalize();
        if (normalizer.isNormalized())
            savePart1();
            savePart2();
        end;
    end;

    contructorTF302ReportNormalizer(protocolView);
end;

class (TF302ReportNormalizer) TF302ReportNormalizer_4637(protocolView)
    private var m_aoOkatoCodes = RcbArray();

    private macro isAoOkato(okatoCode : String)
        m_aoOkatoCodes.moveFirst();

        while (m_aoOkatoCodes.moveNext())
            if (m_aoOkatoCodes.getCurrentItem() == okatoCode)
                return true;
            end;
        end;

        return false;
    end;

    private macro fillAoOkatoCodes()
        var okatoDataSet = RcbArTuneTable_4637().getDataSet();

        while (okatoDataSet.moveNext())
            m_aoOkatoCodes.push_back(okatoDataSet.okato);
        end;
    end;

    macro fillFieldsNameAndCounts()
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleSum";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencySum";
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencyDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "roubleDelayedDebt";
        m_fieldNamePart1[m_fieldNamePart1.size] = "currencyDelayedDebt";

        m_fieldNamePart2[m_fieldNamePart2.size] = "obtainedFundsRestTotal";
        m_fieldNamePart2[m_fieldNamePart2.size] = "obtainedFundsRest_643";
        m_fieldNamePart2[m_fieldNamePart2.size] = "obtainedFundsRest_840";
        m_fieldNamePart2[m_fieldNamePart2.size] = "obtainedFundsRest_978";
        m_fieldNamePart2[m_fieldNamePart2.size] = "obtainedFundsRest_156";

        m_part1BeginColumn = 4;
        m_part1EndColumn   = 9;
        m_part2BeginColumn = 4;
        m_part2EndColumn   = 8;
    end;

    macro addRuleForBalancePart2(row, column, minusColumn, sign, balance, addBalance, rowKind)
        var relation     = ReportLinearRelation(sign);
        var isFoundNodes = false;
        var balanceSum   = 0.0;
        var okato        = 0;
        var addBalanceA;
        var addBalanceP;
        var node;
        var pos;

        while (okato < m_okatoPart2.size)
            if (not isAoOkato( m_okatoPart2[okato]))
                node = normalizer.node(getNodeId(2, m_okatoPart2[okato], row, column));
                if (not valType(node) == V_UNDEF)
                    isFoundNodes = true;

                    relation.lhs.plus(node);

                    if (minusColumn != "")
                        relation.lhs.minus(normalizer.node(getNodeId(2, m_okatoPart2[okato], row, minusColumn)));
                    end;
                end;
            end;

            okato = okato + 1;
        end;

        if (isFoundNodes)
            balanceSum = getBalanceSumForPeriod(false, balance, rowKind, COLUMN_KIND.PASSIVE_OUT_REST);

            if (valType(addBalance) == valType(RcbArray))
                addBalance.moveFirst();

                while (addBalance.moveNext())
                    pos = index(addBalance.getCurrentItem(), "-");

                    if (pos > 0)
                        addBalanceP = getBalanceSumForPeriod(false, RcbArray().initialize(subStr(addBalance.getCurrentItem(), 1, pos -1)), rowKind, COLUMN_KIND.PASSIVE_OUT_REST);
                        addBalanceA = getBalanceSumForPeriod(false, RcbArray().initialize(subStr(addBalance.getCurrentItem(), pos + 1))  , rowKind, COLUMN_KIND.ACTIVE_OUT_REST);

                        if ((addBalanceP - addBalanceA) > 0)
                            balanceSum = balanceSum + (addBalanceP - addBalanceA);
                        end;
                    end;
                end;
            end;

            relation.rhs.plus(balanceSum);

            this.addRelation(relation);
        end;
    end;

    macro addRulesForPart2WithBalance()
        addRuleForBalancePart2("1", "4", "5", RCB_RS_LESS_OR_EQUAL,
                               RcbArray().initialize("20309", "20310", "30220", "30223", "30227", "30601",  "30606", "40101", "40105", "40106", "40116", "402", "40301", "40302",
                                                     "40306", "40312", "404", "405", "406", "407", "408", "40901", "40902", "40903", "40905", "40906", "40909", "40910", "40911",
                                                     "40912", "40913", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "425",
                                                     "426", "427", "428", "429", "430", "431", "432", "433", "434","435", "436", "437", "438", "439", "440", "47401", "47418",
                                                     "47601", "47602", "47603", "47605", "47610", "521", "522", "52403", "52404"),
                               RcbArray().initialize("40108-40109", "40110-40111", "40907-40908"),
                               ROW_KIND.CURRENCY);

        addRuleForBalancePart2("1", "5", "", RCB_RS_EQUAL,
                               RcbArray().initialize("20309", "20310", "30220", "30223", "30227", "30601",  "30606", "40101", "40105", "40106", "40116", "402", "40301", "40302",
                                                     "40306", "40312", "404", "405", "406", "407", "408", "40901", "40902", "40903", "40905", "40906", "40909", "40910", "40911",
                                                     "40912", "40913", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "425",
                                                     "426", "427", "428", "429", "430", "431", "432", "433", "434","435", "436", "437", "438", "439", "440", "47401", "47418",
                                                     "47601", "47602", "47603", "47605", "47610", "521", "522", "52403", "52404"),
                               RcbArray().initialize("40108-40109", "40110-40111", "40907-40908"),
                               ROW_KIND.ROUBLE);

        addRuleForBalancePart2("1.1", "4", "5", RCB_RS_EQUAL,
                               RcbArray().initialize("40101", "40105", "40106", "40116"),
                               RcbArray().initialize("40108-40109", "40110-40111"),
                               ROW_KIND.CURRENCY);

        addRuleForBalancePart2("1.1", "5", "", RCB_RS_EQUAL,
                               RcbArray().initialize("40101", "40105", "40106", "40116"),
                               RcbArray().initialize("40108-40109", "40110-40111"),
                               ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.2", "4", "5", RCB_RS_EQUAL, RcbArray().initialize("402"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.2", "5", "", RCB_RS_EQUAL, RcbArray().initialize("402"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.3", "4", "5", RCB_RS_EQUAL, RcbArray().initialize("40301", "40302", "40306", "40312"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.3", "5", "", RCB_RS_EQUAL, RcbArray().initialize("40301", "40302", "40306", "40312"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.4", "4", "5", RCB_RS_EQUAL, RcbArray().initialize("404"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.4", "5", "", RCB_RS_EQUAL, RcbArray().initialize("404"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.5", "4", "5", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("405", "406", "40821"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.5", "5", "", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("405", "406", "40821"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.6", "4", "5", RCB_RS_EQUAL, RcbArray().initialize("407", "40807", "40821"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.6", "5", "", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("407", "40807", "40821"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.7", "4", "5", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("40802", "40804", "40805", "40821", "40825", "42108", "42109", "42110", "42111", "42112", "42113", "42114", "47610"),"", ROW_KIND.CURRENCY);
         addRuleForBalancePart2("1.7", "5", "", RCB_RS_LESS_OR_EQUAL, RcbArray().initialize("40802", "40804", "40805", "40821", "40825", "42108", "42109", "42110", "42111", "42112", "42113", "42114", "47610"),"", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.8", "4", "5", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "42101", "42102", "42103", "42104", "42105", "42106", "42107",
                                                      "422", "425", "47601", "47602", "521", "52403"),
                                "", ROW_KIND.CURRENCY);

         addRuleForBalancePart2("1.8", "5", "", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "42101", "42102", "42103", "42104", "42105", "42106", "42107",
                                                      "422", "425", "47601", "47602", "521", "52403"),
                                "", ROW_KIND.ROUBLE);

         addRuleForBalancePart2("1.9", "4", "5", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "40803", "40806", "40809", "40812", "40813", "40814", "40815", "40817", "40818",
                                                      "40819", "40820", "40823", "40824", "423", "426", "47603", "47605",  "522", "52404"),
                                "", ROW_KIND.CURRENCY);

         addRuleForBalancePart2("1.9", "5", "", RCB_RS_LESS_OR_EQUAL,
                                RcbArray().initialize("20309", "20310", "40803", "40806", "40809", "40812", "40813", "40814", "40815", "40817", "40818",
                                                      "40819", "40820", "40823", "40824", "423", "426", "47603", "47605",  "522", "52404"),
                                "", ROW_KIND.ROUBLE);
    end;

    macro addRuleForRowsPart2(rows : RcbArray, lhsColumns : RcbArray, sign, rhsColumns : RcbArray)
        var i = 0;
        var column;
        var node;

        while (i < m_okatoPart2.size)
            rows.moveFirst();
            while (rows.moveNext())
                lhsColumns.moveFirst();
                while (lhsColumns.moveNext())
                    node = normalizer.node(getNodeId(2, m_okatoPart2[i], rows.getCurrentItem(), lhsColumns.getCurrentItem()));
                    if (not valType(node) == V_UNDEF)
                        var relation = ReportLinearRelation(sign);
                        relation.lhs.plus(node);
                    end;
                end;

                if (not valType(relation) == V_UNDEF)
                    rhsColumns.moveFirst();
                    while (rhsColumns.moveNext())
                        relation.rhs.plus(nvl(normalizer.node(getNodeId(2, m_okatoPart2[i], rows.getCurrentItem(), rhsColumns.getCurrentItem())), 0.0));
                    end;

                    this.addRelation(relation);
                end;
            end;
            i = i + 1;
        end;
    end;

    macro addRulesForPart2Totals();
        addRulesForRowByOkato(2, m_part2BeginColumn, m_part2EndColumn, "1", RCB_RS_GREATER_OR_EQUAL, getRowsPart2());

        addRuleForRowsPart2(getRowsPart2(), RcbArray().initialize("4"), RCB_RS_GREATER_OR_EQUAL, RcbArray().initialize("5", "6", "7", "8"));
    end;

    macro contstructorTF302ReportNormalizer_4637(protocolView)
        initTF302ReportNormalizer(protocolView);

        fillAoOkatoCodes();
    end;

    contstructorTF302ReportNormalizer_4637(protocolView);
end;

class (TProtocolView) TF302NormalizationProtocolView()
    initTProtocolView("èêéíéäéã èêéñÖÑìêõ çéêåÄãàáÄñàà");

    macro printNullData()
        [    äÆ‡‡•™‚®‡Æ¢Æ™ Æ™‡„£´•≠≠ÎÂ ß≠†Á•≠®© ·®¨¢Æ´Æ¢ ≠• ØÆ‚‡•°Æ¢†´Æ·Ï.];
    end;

    macro beginProtocol()
        setProtocolOutput();
        printHead();
    end;

    macro printSeparatorLine()
        [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ¥];
    end;

    macro printEndTable()
        [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒŸ];
            [ ];
        end;

    macro endProtocol(normalizer)
        if (m_isEmpty)
            if (normalizer.isNormalized())
                printNullData();
            else
                printLine("çÆ‡¨†´®ßÆ¢†‚Ï §†≠≠Î• ≠• „§†´Æ·Ï. èÆ§‡Æ°≠Æ·‚® ¢ Ø‡Æ‚Æ™Æ´• " + normalizer.getLogFilePath());
            end;
        end;

        resetProtocolOutput();
    end;

    macro printBalanceReportAbsence(month, year)
        printLine("é‚·„‚·‚¢„•‚ ‡†··Á®‚†≠≠Î© °†´†≠· ß† Ø•‡®Æ§ " + string(date(1, month, year)) + " - " + string(date(getDaysInMonth(date(1, month, year)), month, year)));
    end;

    macro printHeadTable(tableName : String)
        [#############################################################################################]
        (tableName);

        [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ-ø];
        [≥                               ≥                          á≠†Á•≠®•                         ≥];
        [≥  ê†ß§•´_éäÄíé_ë‚‡Æ™†_É‡†‰†    √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¥];
        [≥                               ≥ Ñ•©·‚¢®‚•´Ï≠Æ• ≥ é™‡„£´•≠≠Æ• ≥ çÆ‡¨†´®ßÆ¢†≠≠Æ• ≥ ê†ß≠Æ·‚Ï ≥];
        [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ¥];

        end;

    macro printString(str : String, exact : Money, scaled : Double)
        var floored = floor(Double(exact) / rcbApplication.currentReport.multiplier + 0.5);
        var sing;

        if   (scaled > floored)
            sing = "+";
        elif (scaled < floored)
            sing = "-";
        else
            sing = "";
        end;

        [≥###############################≥################≥#############≥#################≥##########≥]
        (str, exact, floored : 0 : 0, scaled : 0 : 0, String(sing, abs(floored - scaled) : 0 : 0) : r);

        m_isEmpty = false;
    end;
end;

class F302NormalizationController()
    private var m_protocolView     = null;
    private var m_reportNormalizer = null;

    macro constructorF302NormalizationController()
        if (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
            m_protocolView     = TF302NormalizationProtocolView();
            m_reportNormalizer = TF302ReportNormalizer(m_protocolView);
        else
            m_protocolView     = TF302NormalizationProtocolView();
            m_reportNormalizer = TF302ReportNormalizer_4637(m_protocolView);
        end;
    end;

    macro execute()
        m_protocolView.beginProtocol();

        initProgress(null, "ÇÎØÆ´≠•≠®• ≠Æ‡¨†´®ß†Ê®® §†≠≠ÎÂ", "ÇÎØÆ´≠•≠®• ≠Æ‡¨†´®ß†Ê®® §†≠≠ÎÂ");

        m_reportNormalizer.executeNormalization();
        RcbApplication().TransactionManager().commit();
        remProgress();
        m_protocolView.endProtocol(m_reportNormalizer);
        m_protocolView.show();
    end;

    constructorF302NormalizationController();
end;

macro executeNormalizationOperation()
    F302NormalizationController().execute();
end;

„·‚†≠Æ¢®‚Ïî´†£ÇÆß¢‡†‚†(OK_MACRO_FLAG);
exit(1);