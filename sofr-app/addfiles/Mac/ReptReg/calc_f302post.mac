/*
$Name:          calc_f302post.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 302. Расчет формы 302
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Расчет формы 302

   CREATED : 28.08.07 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/*
 *  Общебанковские интеры и модули
 */
import RsbDataSet;
import RcbLibrary;
import cb_sql;
import lib_lang;
import log_lib;
import lib_str;

/*
 *  Интеры и модели подсистемы
 */
import rcbCoreInter;
import treport;
import rcb_bo;
import rcbconst;
import RcbProtocolView;

import testLib;
import com_f302n;

/***************************************************************************************************
 *  Базовый класс протокола расчета
 **************************************************************************************************/
private class TProtocol()
    private var   m_report  = CTableReport(0, false, true);
    private var   m_dataSet = NULL;

    private macro getDataSet()
        msgBox("Ошибка! Вызов чисто виртуального метода");
    end;

    private macro printOkatoHeader()
        var dataSet = TRsbDataSet("SELECT t_numInList code, t_fullname"
            + "\n" +              "  FROM dobjAttr_dbt"
            + "\n" +              " WHERE t_objectType = " + OBJTYPE_PARTY
            + "\n" +              "   AND t_groupId    = " + RCB_OBJGROUP_PT_OKATO
            + "\n" +              "   AND t_numInList  = " + getSqlString(subStr(String(m_dataSet.okatoCode), 1, 2)));

        print("\n Код - наименование ОКАТО ");

        if (dataSet.moveNext())
            print(m_dataSet.okatoCode + " - " + dataSet.fullname);
        end;
        println();
    end;

    private macro getContragentName()
        return String(nvl(m_dataSet.clientcode, "")) + " " +  String(nvl(m_dataSet.shortName, ""));
    end;

    private macro initialize()
        msgBox("Ошибка! Вызов чисто виртуального метода");
    end;

    private macro getColumn(isPrinting : Bool)
        if (isPrinting)
            return m_dataSet.column;
        end;
        return "";
    end;

    m_dataSet = getDataSet();
    initialize();
end;

/***************************************************************************************************
 *  Класс протокола расчета по первому разделу
 **************************************************************************************************/
private class (TProtocol) TPart1Protocol()
    private var m_dataSetQerry = "";

    macro getDataSetQerry()
        m_dataSetQerry =   "SELECT *"
            + "\n" +       "  FROM (SELECT  CASE"
            + "\n" +       "                    WHEN (isGrRowAndColumn = 1)"
            + "\n" +       "                        THEN 1"
            + "\n" +       "                    ELSE 0"
            + "\n" +       "                END t_isOkato,"
            + "\n" +       "                CASE"
            + "\n" +       "                    WHEN (isGrTranche = 1 AND isGrRowAndColumn = 0)"
            + "\n" +       "                        THEN 1"
            + "\n" +       "                    ELSE 0"
            + "\n" +       "                END t_isRowAndColumn,"
            + "\n" +       "                CASE"
            + "\n" +       "                    WHEN (isGrOperation = 1 AND isGrTranche = 0)"
            + "\n" +       "                        THEN 1"
            + "\n" +       "                    ELSE 0"
            + "\n" +       "                END t_isTranche,"
            + "\n" +       "                d.*"
            + "\n" +       "          FROM (SELECT   GROUPING (t_okatoCode)     isGrOkato,"
            + "\n" +       "                         GROUPING (t_row)           isGrRowAndColumn,"
            + "\n" +       "                         GROUPING (t_trancheNumber) isGrTranche,"
            + "\n" +       "                         GROUPING (t_operationId)   isGrOperation,"
            + "\n" +       "                         t_okatocode, t_row, t_column, t_creditNumber, t_creditDate, t_trancheKind, t_trancheNumber, t_operationId,"
            + "\n" +       "                         SUM (t_roubleSum) t_roubleSum, SUM (t_currencySum) t_currencySum, t_recalculateRateDate, t_clientCode, t_shortName,"
            + "\n" +       "                         t_trancheIssueDate, t_operationIssueDate, t_term, t_currencyId, t_initialInterestRate"
            + "\n" +       "                    FROM (SELECT *"
            + "\n" +       "                            FROM df302p1_tmp"
            + "\n" +       "                           WHERE t_column BETWEEN '4' AND '9'"
            + "\n" +       "                             AND t_backoffice = 2)"
            + "\n" +       "                GROUP BY ROLLUP (t_okatoCode, (t_row, t_column), (t_creditNumber, t_creditDate, t_trancheKind, t_trancheNumber,"
            + "\n" +       "                                 t_trancheIssueDate, t_clientCode, t_shortName),"
            + "\n" +       "                                 (t_operationId, t_operationIssueDate, t_term, t_initialInterestRate, t_currencyId, t_recalculateRateDate, t_roubleSum))"
            + "\n" +       "                  HAVING GROUPING (t_okatoCode) = 0) d)"
            + "\n" +       " WHERE t_column IN ('4', '5')"
            + "\n" +       "    OR t_isTranche = 0"
            + "\n" +       " ORDER BY t_okatoCode, t_isOkato DESC,"
            + "\n" +       "          t_row, t_column, t_isRowAndColumn,"
            + "\n" +       "          t_creditDate, t_creditNumber, t_trancheIssueDate, t_isTranche DESC,"
            + "\n" +       "          t_operationIssueDate";
        return m_dataSetQerry;
    end;

    private macro getDataSet()
        return TRsbDataSet(getDataSetQerry(), RSDVAL_CLIENT, RSDVAL_STATIC);
    end;

    private macro printHeader()
        [Форма 302. Сведения о кредитах и задолженности по кредитам, выданным заемщикам разных регионов ];
        [ПРОТОКОЛ РАСЧЕТА                                                                               ];
        [                                                                                               ];
        [   Период отчета с          # по          #                                                    ](ПредДатаОтчета:r:f, ДатаОтчета:r:f);
        [   Исполнитель: #######################                                                        ](Исполнитель:r);
        [   Дата и время выпуска отчета          #      #                                               ](Date():r:f, subStr(strSubst(String(Time()), " ", "0"), 1, 5):r);
        [                                                                                               ];
        [РАЗДЕЛ 1                                                                                       ];
    end;

    private macro getRow(isPrinting : Bool)
        if (isPrinting)
            return m_dataSet.row;
        end;
        return "";
    end;

    private macro getColumn(isPrinting : Bool)
        if (isPrinting)
            return m_dataSet.column;
        end;
        return "";
    end;

    private macro getRecalculateRateDate()
        if (in(m_dataSet.column, "4", "5") or (m_dataSet.currencyId == NATCUR))
            return "";
        end;

        return String(m_dataSet.recalculateRateDate:f)
    end;

    private macro getIssueDate()
        if (in(m_dataSet.column, "4", "5") and (m_dataSet.isTranche == 0))
            return String(m_dataSet.operationIssueDate:f);
        end;

        return String(m_dataSet.trancheIssueDate:f);
    end;
    private macro getCurrencySum()
        if (in(m_dataSet.column, "4", "5") or (m_dataSet.currencyId == NATCUR))
            return "";
        end;

        return m_dataSet.currencySum;
    end;

    private macro getCreditNumber()
        if (in(m_dataSet.column, "4", "5") and (m_dataSet.isTranche == 0))
            return "";
        end;

        return m_dataSet.creditNumber;
    end;

    private macro getInterestRate()
        if (in(m_dataSet.row, "4.1", "4.1.1") and (m_dataSet.isTranche == 0))
            return String((nvl(m_dataSet.initialInterestRate, 0.0)):0:1);
        end;

        return "";
    end;

    private macro getTerm()
        if (in(m_dataSet.row, "4.1", "4.1.1") and (m_dataSet.isTranche == 0))
            return String((nvl(m_dataSet.term)):0:1);
        end;

        return "";
    end;

    private macro getCreditDate()
        if (in(m_dataSet.column, "4", "5") and (m_dataSet.isTranche == 0))
            return "";
        end;

        return String(m_dataSet.creditDate:f);
    end;

    private macro printOkatoHeader(okatoCode : String)

        var okato;

        if (subStr(okatoCode,3,3) == "000")
            okato = subStr(String(okatoCode), 1, 2);
        else
            okato = okatoCode;
        end;

        var dataSet = TRsbDataSet("SELECT t_numInList code, t_fullname"
            + "\n" +              "  FROM dobjAttr_dbt"
            + "\n" +              " WHERE t_objectType = " + OBJTYPE_PARTY
            + "\n" +              "   AND t_groupId    = " + RCB_OBJGROUP_PT_OKATO
            + "\n" +              "   AND t_numInList  = " + getSqlString(okato));

        print("\n Код - наименование ОКАТО ");

        print(okatoCode);
        if (dataSet.moveNext())
            print(" - " + dataSet.fullname);
        end;
        println();
    end;

    macro print()
        var isFirstRow        = true;
        var isPrintRowAndColumn = true;

        printHeader();

        while (m_dataSet.moveNext())
            if (m_dataSet.isOkato == 1)
                if (not isFirstRow)
                    m_report.printBottom();
                end;
                printOkatoHeader(m_dataSet.okatoCode);
                m_report.printHead();
                isFirstRow             = false;
                isPrintRowAndColumn = true;
            elif (m_dataSet.isRowAndColumn == 1)
                m_report.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 28, " ") + strLPad(String(m_dataSet.t_roubleSum), 90, " "), m_report.getAColumns().size);
                isPrintRowAndColumn = true;
            else
                m_report.printStringTransferByWord(getRow(isPrintRowAndColumn),
                                                   getColumn(isPrintRowAndColumn),
                                                   getCreditNumber(),
                                                   getCreditDate(),
                                                   getIssueDate(),
                                                   getTerm(),
                                                   getInterestRate(),
                                                   m_dataSet.currencyId,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getRecalculateRateDate(),
                                                   getContragentName());
                if (m_dataSet.isTranche == 1)
                    m_report.printStringExt(mkstr(" ", m_report.getWidthBeforeCol(4)) + "операции выдачи по СО:", m_report.getAColumns().size);
                end;
                isPrintRowAndColumn = false;
            end;
        end;
        if (not isFirstRow)
            m_report.printBottom();
        else
            printLn("\n Нет данных по первому разделу.\n");
        end;
    end;

    macro initialize()
        m_dataSet.setFieldType("t_creditDate",          V_DATE);
        m_dataSet.setFieldType("t_trancheIssueDate",    V_DATE);
        m_dataSet.setFieldType("t_operationIssueDate",  V_DATE);
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_report.addColumn("Стро|ка",                       5, AL_LEFT);
        m_report.addColumn("Графа",                         5, AL_LEFT);
        m_report.addColumn("Номер|договора",               35, AL_LEFT);
        m_report.addColumn("Дата|договора",                10, AL_LEFT);
        m_report.addColumn("Дата выдачи| СО / |операции",  10, AL_LEFT);
        m_report.addColumn("Срок|транша|(мес)",             6, AL_RIGHT);
        m_report.addColumn("%|ставка",                      5, AL_RIGHT);
        m_report.addColumn("Ва|лю|та",                      3, AL_LEFT);
        m_report.addColumn("Сумма|в валюте",               15, AL_RIGHT);
        m_report.addColumn("Сумма|в рублевом|эквиваленте", 15, AL_RIGHT);
        m_report.addColumn("Дата|курса|пересчета",         10, AL_LEFT);
        m_report.addColumn("Контрагент",                   20, AL_LEFT);
    end;

    initTProtocol();
end;

/***************************************************************************************************
 *  Класс протокола расчета по первому разделу по 2055У
 **************************************************************************************************/
private class (TPart1Protocol) TPart1Protocol2055()
    macro print()
        var isFirstRow          = true;
        var isPrintRowAndColumn = true;

        printHeader();

        while (m_dataSet.moveNext())
            if (m_dataSet.isOkato == 1)
                if (not isFirstRow)
                    m_report.printBottom();
                end;
                printOkatoHeader(m_dataSet.okatoCode);
                m_report.printHead();
                isFirstRow             = false;
                isPrintRowAndColumn = true;
            elif (m_dataSet.isRowAndColumn == 1)
                m_report.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 30, " ") + strLPad(String(m_dataSet.t_roubleSum), 72, " "), m_report.getAColumns().size);
                isPrintRowAndColumn = true;
            else
                m_report.printStringTransferByWord(getRow(isPrintRowAndColumn),
                                                   getColumn(isPrintRowAndColumn),
                                                   getCreditNumber(),
                                                   getCreditDate(),
                                                   getIssueDate(),
                                                   m_dataSet.currencyId,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getRecalculateRateDate(),
                                                   getContragentName());
                if (m_dataSet.isTranche == 1)
                    m_report.printStringExt(mkstr(" ", m_report.getWidthBeforeCol(4)) + "операции выдачи по СО:", m_report.getAColumns().size);
                end;
                isPrintRowAndColumn = false;
            end;
        end;
        if (not isFirstRow)
            m_report.printBottom();
        else
            printLn("\n Нет данных по первому разделу.\n");
        end;
    end;

    macro initialize()
        m_dataSet.setFieldType("t_creditDate",          V_DATE);
        m_dataSet.setFieldType("t_trancheIssueDate",    V_DATE);
        m_dataSet.setFieldType("t_operationIssueDate",  V_DATE);
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_report.addColumn("Строка|отчета",                  9, AL_LEFT);
        m_report.addColumn("Графа|отчета",                   5, AL_LEFT);
        m_report.addColumn("Номер|договора",               35, AL_LEFT);
        m_report.addColumn("Дата|договора",                10, AL_LEFT);
        m_report.addColumn("Дата выдачи| СО ",              10, AL_LEFT);
        m_report.addColumn("Ва-|лю-|та",                      3, AL_LEFT);
        m_report.addColumn("Сумма|в валюте",               15, AL_RIGHT);
        m_report.addColumn("Сумма|в рублевом|эквиваленте", 15, AL_RIGHT);
        m_report.addColumn("Дата|курса|пересчета",         10, AL_LEFT);
        m_report.addColumn("Контрагент|по договору",        20, AL_LEFT);
        m_report.addColumn("Подразделение",                20, AL_LEFT);
    end;

    initTPart1Protocol();
end;

/***************************************************************************************************
 *  Класс протокола расчета по первому разделу по 2183У
 **************************************************************************************************/
private class (TPart1Protocol2055) TPart1Protocol2183()

    initTPart1Protocol2055();

    private var m_reportCB = CTableReport(0, false, true);

    private macro getCreditNumber()
        return nvl(m_dataSet.creditNumber,"");
    end;
    private macro getCreditDate()
        return String(m_dataSet.creditDate:f);
    end;
    private macro getCurrencySum()
        if (m_dataSet.currencyId == NATCUR)
            return "";
        end;
    return m_dataSet.currencySum;
    end;

    private macro printOkatoHeader()
        if (m_dataset.okatoCode == "99999")
            println("\n Код - наименование ОКАТО " + m_dataset.okatoCode + " - " + "Код ОКАТО не задан");
        else
            printOkatoHeader(m_dataset.okatoCode);
        end;
    end;

    /*запрос формирующий данные для первого раздела*/
    macro getDataSetQerry()
        m_dataSetQerry =              "SELECT *"
                       + "\n" +       "  FROM (SELECT DISTINCT t_okatocode,"
                       + "\n" +       "               t_backoffice, "
                       + "\n" +       "               t_row,"
                       + "\n" +       "               t_column,"
                       + "\n" +       "               t_account,"
                       + "\n" +       "               t_currencyid,"
                       + "\n" +       "               SUM (t_roublesum) t_roublesum,"
                       + "\n" +       "               SUM (t_currencysum) t_currencysum,"
                       + "\n" +       "               t_recalculateratedate,"
                       + "\n" +       "               t_recalculaterate,"
                       + "\n" +       "               t_opendate,"
                       + "\n" +       "               t_closedate,"
                       + "\n" +       "               t_creditnumber,"
                       + "\n" +       "               t_creditdate,"
                       + "\n" +       "               t_trancheissuedate,"
                       + "\n" +       "               t_clientcode,"
                       + "\n" +       "               t_shortname,"
                       + "\n" +       "               t_operationIssueDate,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN grouping(t_account) = 1 AND grouping(t_row) = 1 AND t_backoffice is NULL"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END    AS t_isokato,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN grouping(t_account) = 1 AND grouping(t_row) = 1"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END  AS t_isbackoffice,"
                       + "\n" +       "               grouping(t_account) AS t_iscolumn,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN GROUPING (t_operationId) = 1 AND GROUPING (t_trancheNumber) = 0 AND t_backoffice = 2"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END AS t_isTranche,"
                       + "\n" +       "               t_branchName"
                       + "\n" +       "         FROM  (SELECT DISTINCT t_okatocode, t_row, t_backoffice, t_column, t_creditnumber,"
                       + "\n" +       "                       t_creditdate, t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid, SUM(t_roublesum) t_roublesum,"
                       + "\n" +       "                       SUM(t_currencysum) t_currencysum, t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName"
                       + "\n" +       "                  FROM (SELECT DISTINCT df302p1_tmp.*,"
                       + "\n" +       "                      CASE"
                       + "\n" +       "                          WHEN t_row = '4'"
                       + "\n" +       "                             THEN (SELECT t_shortname"
                       + "\n" +       "                                FROM dparty_dbt party INNER JOIN drepdepcode_vw depcode"
                       + "\n" +       "                                      ON party.t_partyid = depcode.t_partyid"
                       + "\n" +       "                                WHERE depcode.t_departmentcode = df302p1_tmp.t_branch)"
                       + "\n" +       "                          ELSE ''"
                       + "\n" +       "                       END AS t_branchName"
                       + "\n" +       "                          FROM df302p1_tmp)"
                       + "\n" +       "              GROUP BY t_backoffice, t_okatocode, t_row, t_column, t_creditnumber, t_creditdate,"
                       + "\n" +       "                       t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid,t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode, t_backoffice,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName)"
                       + "\n" +       "        GROUP  BY ROLLUP (t_okatocode,"
                       + "\n" +       "                          t_backoffice,"
                       + "\n" +       "                          (t_row,t_column),"
                       + "\n" +       "                          (t_account,"
                       + "\n" +       "                           t_currencyid,"
                       + "\n" +       "                           t_roublesum,"
                       + "\n" +       "                           t_currencysum,"
                       + "\n" +       "                           t_recalculateratedate,"
                       + "\n" +       "                           t_recalculaterate,"
                       + "\n" +       "                           t_opendate,"
                       + "\n" +       "                           t_closedate,"
                       + "\n" +       "                           t_trancheNumber,"
                       + "\n" +       "                           t_creditnumber,"
                       + "\n" +       "                           t_creditdate,"
                       + "\n" +       "                           t_trancheissuedate,"
                       + "\n" +       "                           t_branchName),"
                       + "\n" +       "                          (t_operationId,"
                       + "\n" +       "                           t_clientcode,"
                       + "\n" +       "                           t_shortname,"
                       + "\n" +       "                           t_operationIssueDate))"
                       + "\n" +       "       HAVING GROUPING (t_okatocode) = 0"
                       + "\n" +       "        ORDER BY t_okatocode, t_isOkato DESC, t_backoffice, t_row,t_column,t_account,t_trancheissuedate,"
                       + "\n" +       "                 t_creditDate, t_creditNumber, t_trancheIssueDate, t_roublesum, t_isTranche DESC) protocolTable"
                       + "\n" +       "WHERE (t_backoffice = 1"
                       + "\n" +       "   OR ( t_backoffice = 2 AND (t_column IN ('4', '5') OR t_isTranche = 0))"
                       + "\n" +       "   OR t_backoffice IS NULL)";
        return m_dataSetQerry;
    end;

    macro print()
        var isEmpty   = true;
        var isFistRow = true;

        printHeader();

        while (m_dataSet.moveNext())
            isEmpty = false;

            if (m_dataSet.isOkato == 1)
                printOkatoHeader(m_dataSet.okatoCode);
                isFistRow = true;
            elif ((m_dataSet.isBackOffice == 1) AND (m_dataSet.isOkato != 1))
                if (m_dataSet.backOffice == 1)
                    m_reportCB.printBottom();
                else
                    m_report.printBottom();
                end;
                isFistRow = true;
            elif ((m_dataSet.isColumn == 1) AND (m_dataSet.isBackOffice != 1) AND (m_dataSet.isOkato != 1))
                if (m_dataSet.backOffice == 1)
                    m_reportCB.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 40, " ") + strLPad(String(m_dataSet.t_roubleSum), 72, " "), m_reportCB.getAColumns().size);
                else
                    m_report.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 30, " ") + strLPad(String(m_dataSet.t_roubleSum), 72, " "), m_report.getAColumns().size);
                end;
            else
                if (isFistRow)
                    if (m_dataSet.backOffice == 1)
                        println(" Данные по ГК");
                        m_reportCB.printHead();
                    else
                        println(" Данные по Loans");
                        m_report.printHead();
                    end;
                    isFistRow = false;
                end;

                if (m_dataSet.backOffice == 1)
                    m_reportCB.printStringTransferByWord(m_dataSet.row,
                                                       m_dataSet.column,
                                                       m_dataSet.account,
                                                       m_dataSet.openDate,
                                                       m_dataSet.closeDate,
                                                       m_dataSet.currencyId,
                                                       getCurrencySum(),
                                                       m_dataSet.roubleSum,
                                                       nvl(m_dataSet.recalculateRateDate,""),
                                                       nvl(m_dataSet.recalculateRate,""),
                                                       m_dataset.branchName);
                elif (m_dataSet.backOffice == 2)
                    if (m_dataSet.isTranche == 1)
                        m_report.printStringExt(mkstr(" ", m_report.getWidthBeforeCol(4)) + "операции выдачи по СО:", m_report.getAColumns().size);
                        m_dataSet.moveNext();
                    end;
                    m_report.printStringTransferByWord(getRow(true),
                                                       getColumn(true),
                                                       getCreditNumber(),
                                                       getCreditDate(),
                                                       getIssueDate(),
                                                       m_dataSet.currencyId,
                                                       getCurrencySum(),
                                                       m_dataSet.roubleSum,
                                                       getRecalculateRateDate(),
                                                       getContragentName(),
                                                       m_dataset.branchName);
                end;

            end;
        end;

        if (isEmpty)
            printLn("\n Нет данных по первому разделу.\n");
        end;
    end;

    /*инициализация протокола первого раздела по ГК*/
    macro initializeCB()
        m_dataSet.setFieldType("t_openDate",            V_DATE);
        m_dataSet.setFieldType("t_closeDate",           V_DATE);
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_reportCB.addColumn("Строка",                        9, AL_LEFT);
        m_reportCB.addColumn("Графа",                         5, AL_LEFT);
        m_reportCB.addColumn("Номер счёта               ",   25, AL_LEFT);
        m_reportCB.addColumn("Дата|открытия|счёта",          10, AL_LEFT);
        m_reportCB.addColumn("Дата|закрытия|счёта",          10, AL_LEFT);
        m_reportCB.addColumn("Ва|лю|та",                      3, AL_LEFT);
        m_reportCB.addColumn("Сумма|в валюте",               15, AL_RIGHT);
        m_reportCB.addColumn("Сумма|в рублевом|эквиваленте", 15, AL_RIGHT);
        m_reportCB.addColumn("Дата|курса|погашения|долга",   10, AL_LEFT);
        m_reportCB.addColumn("Курс|погашения|долга",         15, AL_RIGHT);
        m_reportCB.addColumn("Подразделение",                20, AL_LEFT);
    end;

    initializeCB();
end;

/***************************************************************************************************
 *  Классы протокола расчета по первому разделу по 2627-У
 **************************************************************************************************/
private class (TPart1Protocol2183) TPart1Col45Protocol2627()
    initTPart1Protocol2183();

    private var m_isEmpty = true;

    /*запрос формирующий данные для первого раздела*/
    macro getDataSetQerry()
        m_dataSetQerry = "SELECT account.t_okatoCode,"
                + "\n" + "       account.t_row,"
                + "\n" + "       account.t_column,"
                + "\n" + "       account.t_account,"
                + "\n" + "       CASE t_column"
                + "\n" + "           WHEN '4' THEN SUM(account.t_roubleSum)"
                + "\n" + "           WHEN '5' THEN SUM(account.t_documentEquivalentSum)"
                + "\n" + "       END t_amount,"
                + "\n" + "       CASE"
                + "\n" + "           WHEN account.t_row = '4'"
                + "\n" + "              THEN (SELECT party.t_shortname"
                + "\n" + "                      FROM dparty_dbt party INNER JOIN drepdepcode_vw depcode"
                + "\n" + "                        ON party.t_partyid = depcode.t_partyid"
                + "\n" + "                     WHERE depcode.t_departmentcode = account.t_branch"
                + "\n" + "                   )"
                + "\n" + "           ELSE CHR(1)"
                + "\n" + "       END AS t_branchName,"
                + "\n" + "       CASE"
                + "\n" + "           WHEN     GROUPING(account.t_account) = 1"
                + "\n" + "                AND GROUPING(account.t_column)  = 1"
                + "\n" + "                AND GROUPING(account.t_row)     = 1"
                + "\n" + "           THEN 1"
                + "\n" + "           ELSE 0"
                + "\n" + "       END AS t_isOkato,"
                + "\n" + "       GROUPING(account.t_account) AS t_isColumn"
                + "\n" + "  FROM df302p1_tmp account,F302DOCWITHCORRECTION_VW document"
                + "\n" + " WHERE account.t_backOffice = 1"
                + "\n" + "   AND (   account.t_column  = '4'"
                + "\n" + "        OR (    account.t_column  = '5'"
                + "\n" + "            AND account.t_documentId IS NOT NULL"
                + "\n" + "            )"
                + "\n" + "        )"
                + "\n" + "   AND document.t_debetAccount = account.t_account                                         "
                + "\n" + "   AND document.t_Id           = account.t_documentId                                      "
                + "\n" + "   AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                + "\n" + "                           AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                + "\n" + "   AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)     "
                + "\n" + " GROUP BY ROLLUP (account.t_okatoCode,"
                + "\n" + "                  (account.t_row,"
                + "\n" + "                   account.t_column"
                + "\n" + "                  ),"
                + "\n" + "                  account.t_account,"
                + "\n" + "                  account.t_branch"
                + "\n" + "                 )"
                + "\n" + "HAVING GROUPING_ID(account.t_okatoCode, account.t_row, account.t_column, account.t_account, account.t_branch) = 0"
                + "\n" + "    OR GROUPING_ID(account.t_okatoCode, account.t_row, account.t_column, account.t_account, account.t_branch) = 3"
                + "\n" + "    OR GROUPING_ID(account.t_okatoCode, account.t_row, account.t_column, account.t_account, account.t_branch) = 15"
                + "\n" + " ORDER BY t_okatoCode,"
                + "\n" + "          t_row NULLS LAST,"
                + "\n" + "          t_column NULLS LAST,"
                + "\n" + "          t_account NULLS LAST,"
                + "\n" + "          t_isOkato,"
                + "\n" + "          t_isColumn"
                ;

        return m_dataSetQerry;
    end;

    macro print()
        var isFistRow = true;

        while (m_dataSet.moveNext())
            m_isEmpty = false;

            if (isFistRow)
                printOkatoHeader(m_dataSet.okatoCode);
                println(" Данные по ГК");
                m_reportCB.printHead();
                isFistRow = false;
            end;

            if (m_dataSet.isOkato == 1)
                m_reportCB.printBottom();
                isFistRow = true;
            elif ((m_dataSet.isColumn == 1) and (m_dataSet.isOkato != 1))
                m_reportCB.printStringExt("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column,
                                          7,
                                          String(m_dataSet.amount)
                                         );
            else
                m_reportCB.printStringTransferByWord(m_dataSet.row,
                                                     m_dataSet.column,
                                                     m_dataSet.account,
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     m_dataset.amount,
                                                     m_dataset.branchName
                                                    );
            end;
        end;
    end;

    macro isEmpty()
        return m_isEmpty;
    end;

    /*инициализация протокола первого раздела по ГК*/
    macro initializeCB()
        m_dataSet.setFieldType("t_documentDate",          V_DATE);
        m_dataSet.setFieldType("t_amount",                V_MONEY);
        m_dataSet.setFieldType("t_documentEquivalentSum", V_MONEY);

        m_reportCB = CTableReport(0, false, true);

        m_reportCB.addColumn("Строка",                    9, AL_LEFT);
        m_reportCB.addColumn("Графа",                     5, AL_LEFT);
        m_reportCB.addColumn("Ссудный счет",             25, AL_LEFT);
        m_reportCB.addColumn("№ документа",              15, AL_LEFT);
        m_reportCB.addColumn("Дата|документа",           10, AL_LEFT);
        m_reportCB.addColumn("Счет Дт",                  25, AL_LEFT);
        m_reportCB.addColumn("Счет Кт",                  25, AL_LEFT);
        m_reportCB.addColumn("Сумма документа|в рублях", 15, AL_RIGHT);
        m_reportCB.addColumn("Подразделение",            20, AL_LEFT);
    end;

    initializeCB();
end;

/***************************************************************************************************
 *  Классы протокола расчета по первому разделу кредитования по 2627-У
 **************************************************************************************************/
private class (TPart1Col45Protocol2627) TPart1Col45CredProtocol2627()
    initTPart1Protocol2055();

    private var m_reportCR_4_5 = CTableReport(0, false, true);

    private macro getCreditNumber()
        return nvl(m_dataSet.creditNumber,"");
    end;

    private macro getCreditDate()
        return String(m_dataSet.creditDate:f);
    end;

    private macro getCurrencySum()
        if (m_dataSet.currencyId == NATCUR)
            return "";
        end;

        return m_dataSet.currencySum;
    end;

    private macro printOkatoHeader()
        if (m_dataset.okatoCode == "99999")
            println("\n Код - наименование ОКАТО " + m_dataset.okatoCode + " - " + "Код ОКАТО не задан");
        else
            printOkatoHeader(m_dataset.okatoCode);
        end;
    end;

    /*запрос формирующий данные для первого раздела*/
    macro getDataSetQerry()
        m_dataSetQerry =              "SELECT *"
                       + "\n" +       "  FROM (SELECT DISTINCT t_okatocode,"
                       + "\n" +       "               t_backoffice, "
                       + "\n" +       "               t_row,"
                       + "\n" +       "               t_column,"
                       + "\n" +       "               t_account,"
                       + "\n" +       "               t_currencyId,"
                       + "\n" +       "               (SELECT fi.t_code"
                       + "\n" +       "                  FROM dRepFinInstrument_vw fi"
                       + "\n" +       "                 WHERE fi.t_id = t_currencyId)               AS t_currencyCode,"
                       + "\n" +       "               SUM (t_roublesum)                             AS t_roublesum,"
                       + "\n" +       "               SUM (t_currencysum)                           AS t_currencysum,"
                       + "\n" +       "               t_recalculateratedate,"
                       + "\n" +       "               t_recalculaterate,"
                       + "\n" +       "               t_opendate,"
                       + "\n" +       "               t_closedate,"
                       + "\n" +       "               t_creditnumber,"
                       + "\n" +       "               t_creditdate,"
                       + "\n" +       "               t_trancheissuedate,"
                       + "\n" +       "               t_clientcode,"
                       + "\n" +       "               t_shortname,"
                       + "\n" +       "               t_operationIssueDate,"
                       + "\n" +       "               t_correctionDate,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN t_history = 'К'"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isCorrection,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN     grouping(t_account) = 1 "
                       + "\n" +       "                        AND grouping(t_row)     = 1 "
                       + "\n" +       "                        AND t_backoffice is NULL"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isokato,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN     grouping(t_account) = 1 "
                       + "\n" +       "                        AND grouping(t_row)     = 1"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isbackoffice,"
                       + "\n" +       "               grouping(t_account)                           AS t_iscolumn,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN     GROUPING (t_operationId)   = 1 "
                       + "\n" +       "                        AND GROUPING (t_trancheNumber) = 0 "
                       + "\n" +       "                        AND t_backoffice               = 2"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isTranche,"
                       + "\n" +       "               t_branchName"
                       + "\n" +       "         FROM  (SELECT DISTINCT t_okatocode, t_row, t_backoffice, t_column, t_creditnumber,"
                       + "\n" +       "                       t_creditdate, t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid, SUM(t_roublesum) t_roublesum, t_correctionDate, t_history,"
                       + "\n" +       "                       SUM(t_currencysum) t_currencysum, t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName"
                       + "\n" +       "                  FROM (SELECT DISTINCT df302p1_tmp.*, oprep.t_correctionDate, oprep.t_history,"
                       + "\n" +       "                               CASE"
                       + "\n" +       "                                   WHEN t_row = '4'"
                       + "\n" +       "                                      THEN (SELECT t_shortname"
                       + "\n" +       "                                              FROM dparty_dbt party "
                       + "\n" +       "                                        INNER JOIN drepdepcode_vw depcode"
                       + "\n" +       "                                                ON party.t_partyid = depcode.t_partyid"
                       + "\n" +       "                                             WHERE depcode.t_departmentcode = df302p1_tmp.t_branch)"
                       + "\n" +       "                                   ELSE ''"
                       + "\n" +       "                                END AS t_branchName"
                       + "\n" +       "                          FROM df302p1_tmp, replnsoperation_vw oprep"
                       + "\n" +       "                         WHERE oprep.t_tranchenumber = df302p1_tmp.t_tranchenumber"
                       + "\n" +       "                           AND oprep.t_tranchekind = df302p1_tmp.t_tranchekind"
                       + "\n" +       "                           AND oprep.t_id = df302p1_tmp.t_operationId"
                       + "\n" +       "                       )"
                       + "\n" +       "              GROUP BY t_backoffice, t_okatocode, t_row, t_column, t_creditnumber, t_creditdate,"
                       + "\n" +       "                       t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid,t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode, t_backoffice,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName, t_correctionDate, t_history)"
                       + "\n" +       "        GROUP  BY ROLLUP (t_okatocode,"
                       + "\n" +       "                          t_backoffice,"
                       + "\n" +       "                          (t_row,t_column),"
                       + "\n" +       "                          (t_account,"
                       + "\n" +       "                           t_currencyid,"
                       + "\n" +       "                           t_roublesum,"
                       + "\n" +       "                           t_currencysum,"
                       + "\n" +       "                           t_recalculateratedate,"
                       + "\n" +       "                           t_recalculaterate,"
                       + "\n" +       "                           t_opendate,"
                       + "\n" +       "                           t_closedate,"
                       + "\n" +       "                           t_trancheNumber,"
                       + "\n" +       "                           t_creditnumber,"
                       + "\n" +       "                           t_creditdate,"
                       + "\n" +       "                           t_correctionDate,"
                       + "\n" +       "                           t_history,"
                       + "\n" +       "                           t_trancheissuedate,"
                       + "\n" +       "                           t_branchName),"
                       + "\n" +       "                          (t_operationId,"
                       + "\n" +       "                           t_clientcode,"
                       + "\n" +       "                           t_shortname,"
                       + "\n" +       "                           t_operationIssueDate))"
                       + "\n" +       "       HAVING GROUPING (t_okatocode) = 0"
                       + "\n" +       "        ORDER BY t_okatocode, t_isOkato DESC, t_backoffice, t_row,t_column,t_account,t_trancheissuedate,"
                       + "\n" +       "                 t_creditDate, t_creditNumber, t_trancheIssueDate, t_roublesum, t_isTranche DESC) protocolTable"
                       + "\n" +       "WHERE (t_backoffice = 2 AND t_column IN ('4', '5')  AND t_isTranche = 0)";
        return m_dataSetQerry;
    end;

    macro print()
        var OkatoPrev = 0;
        var isFistRow = true;

        while (m_dataSet.moveNext())
            m_isEmpty = false;

            if (((OkatoPrev != m_dataSet.okatoCode) OR (m_dataSet.EOF)) AND (isFistRow != true))
                m_reportCR_4_5.printBottom();
                isFistRow = true;
            end;

            if (OkatoPrev != m_dataSet.okatoCode)
                printOkatoHeader(m_dataSet.okatoCode);
                println(" Данные по Loans");
                m_reportCR_4_5.printHead();
                OkatoPrev = m_dataSet.okatoCode;
                isFistRow = false;
            end;

            if ((m_dataSet.isColumn == 1) and (m_dataSet.isOkato != 1))
                m_reportCR_4_5.printStringExt(strRPad("Итого строка " + getRow(true) + ", графа " + getColumn(true), 40, " ") + strLPad(String(m_dataSet.roubleSum), 65, " "), m_reportCR_4_5.getAColumns().size);
            else
                m_reportCR_4_5.printStringTransferByWord(getRow(true),
                                                     getColumn(true),
                                                     getCreditNumber(),
                                                     getCreditDate(),
                                                     m_dataSet.t_trancheissuedate,
                                                     m_dataSet.currencyCode,
                                                     m_dataSet.t_currencysum,
                                                     m_dataSet.roubleSum,
                                                     m_dataSet.t_recalculateratedate,
                                                     ternary(m_dataSet.isCorrection == 1, "X", ""),
                                                     m_dataSet.correctionDate,
                                                     getContragentName(),
                                                     m_dataset.branchName
                                                    );
            end;
        end;

        if (isFistRow == false)
            m_reportCR_4_5.printBottom();
            isFistRow = true;
        end;
    end;

    macro isEmpty()
        return m_isEmpty;
    end;

    /*инициализация протокола первого раздела по ГК*/
    macro initializeCR_4_5()
        m_dataSet.setFieldType("t_openDate",            V_DATE);
        m_dataSet.setFieldType("t_operationIssueDate",  V_DATE);
        m_dataSet.setFieldType("correctionDate",        V_DATE);
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_reportCR_4_5.addColumn("Строка|отчета",                              9, AL_LEFT);
        m_reportCR_4_5.addColumn("Графа|отчета",                               5, AL_LEFT);
        m_reportCR_4_5.addColumn("Номер|договора ",                           25, AL_LEFT);
        m_reportCR_4_5.addColumn("Дата|договора",                             10, AL_LEFT);
        m_reportCR_4_5.addColumn("Дата|операции",                             10, AL_LEFT);
        m_reportCR_4_5.addColumn("Ва-|лю-|та",                                 3, AL_LEFT);
        m_reportCR_4_5.addColumn("Сумма|в валюте",                            10, AL_RIGHT);
        m_reportCR_4_5.addColumn("Сумма|в рублевом|эквиваленте",              10, AL_RIGHT);
        m_reportCR_4_5.addColumn("Дата|курса|пересчета",                      10, AL_LEFT);
        m_reportCR_4_5.addColumn("Корректирующая|операция",                   15, AL_RIGHT);
        m_reportCR_4_5.addColumn("Дата,|за которую|проведена корр.|операция", 15, AL_RIGHT);
        m_reportCR_4_5.addColumn("Контрагент|по договору",                    15, AL_RIGHT);
        m_reportCR_4_5.addColumn("Подразделение",                             15, AL_LEFT);
    end;

    initializeCR_4_5();
end;

private class (TPart1Protocol2183) TPart1Col69Protocol2627()
    initTPart1Protocol2183();

    private var m_isEmpty = true;

    /*запрос формирующий данные для первого раздела*/
    macro getDataSetQerry()
        m_dataSetQerry =              "SELECT *"
                       + "\n" +       "  FROM (SELECT DISTINCT t_okatocode,"
                       + "\n" +       "               t_backoffice, "
                       + "\n" +       "               t_row,"
                       + "\n" +       "               t_column,"
                       + "\n" +       "               t_account,"
                       + "\n" +       "               t_currencyid,"
                       + "\n" +       "               (SELECT fi.t_code"
                       + "\n" +       "                  FROM dRepFinInstrument_vw fi"
                       + "\n" +       "                 WHERE fi.t_id = t_currencyid)               AS t_currencyCode,"
                       + "\n" +       "               SUM (t_roublesum)                             AS t_roublesum,"
                       + "\n" +       "               SUM (t_currencysum)                           AS t_currencysum,"
                       + "\n" +       "               t_recalculateratedate,"
                       + "\n" +       "               t_recalculaterate,"
                       + "\n" +       "               t_opendate,"
                       + "\n" +       "               t_closedate,"
                       + "\n" +       "               t_creditnumber,"
                       + "\n" +       "               t_creditdate,"
                       + "\n" +       "               t_trancheissuedate,"
                       + "\n" +       "               t_clientcode,"
                       + "\n" +       "               t_shortname,"
                       + "\n" +       "               t_operationIssueDate,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN     grouping(t_account) = 1 "
                       + "\n" +       "                        AND grouping(t_row)     = 1 "
                       + "\n" +       "                        AND t_backoffice is NULL"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isokato,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN     grouping(t_account) = 1 "
                       + "\n" +       "                        AND grouping(t_row)     = 1"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isbackoffice,"
                       + "\n" +       "               grouping(t_account)                           AS t_iscolumn,"
                       + "\n" +       "               CASE"
                       + "\n" +       "                   WHEN GROUPING (t_operationId)       = 1 "
                       + "\n" +       "                        AND GROUPING (t_trancheNumber) = 0"
                       + "\n" +       "                        AND t_backoffice               = 2"
                       + "\n" +       "                   THEN 1"
                       + "\n" +       "                   ELSE 0"
                       + "\n" +       "               END                                           AS t_isTranche,"
                       + "\n" +       "               t_branchName"
                       + "\n" +       "         FROM  (SELECT DISTINCT t_okatocode, t_row, t_backoffice, t_column, t_creditnumber,"
                       + "\n" +       "                       t_creditdate, t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid, SUM(t_roublesum) t_roublesum,"
                       + "\n" +       "                       SUM(t_currencysum) t_currencysum, t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName"
                       + "\n" +       "                  FROM (SELECT DISTINCT df302p1_tmp.*,"
                       + "\n" +       "                               CASE"
                       + "\n" +       "                                   WHEN t_row = '4'"
                       + "\n" +       "                                       THEN (SELECT t_shortname"
                       + "\n" +       "                                               FROM dparty_dbt party"
                       + "\n" +       "                                         INNER JOIN drepdepcode_vw depcode"
                       + "\n" +       "                                                 ON party.t_partyid = depcode.t_partyid"
                       + "\n" +       "                                              WHERE depcode.t_departmentcode = df302p1_tmp.t_branch)"
                       + "\n" +       "                                   ELSE ''"
                       + "\n" +       "                                END AS t_branchName"
                       + "\n" +       "                          FROM df302p1_tmp"
                       + "\n" +       "                       )"
                       + "\n" +       "              GROUP BY t_backoffice, t_okatocode, t_row, t_column, t_creditnumber, t_creditdate,"
                       + "\n" +       "                       t_tranchekind, t_tranchenumber, t_operationId, t_trancheissuedate,"
                       + "\n" +       "                       t_operationIssueDate, t_currencyid,t_recalculateratedate, t_contractorid,"
                       + "\n" +       "                       t_term, t_initialinterestrate, t_shortname, t_clientcode, t_backoffice,"
                       + "\n" +       "                       t_opendate, t_closedate, t_recalculaterate, t_account, t_branchName)"
                       + "\n" +       "        GROUP  BY ROLLUP (t_okatocode,"
                       + "\n" +       "                          t_backoffice,"
                       + "\n" +       "                          (t_row,t_column),"
                       + "\n" +       "                          (t_account,"
                       + "\n" +       "                           t_currencyid,"
                       + "\n" +       "                           t_roublesum,"
                       + "\n" +       "                           t_currencysum,"
                       + "\n" +       "                           t_recalculateratedate,"
                       + "\n" +       "                           t_recalculaterate,"
                       + "\n" +       "                           t_opendate,"
                       + "\n" +       "                           t_closedate,"
                       + "\n" +       "                           t_trancheNumber,"
                       + "\n" +       "                           t_creditnumber,"
                       + "\n" +       "                           t_creditdate,"
                       + "\n" +       "                           t_trancheissuedate,"
                       + "\n" +       "                           t_branchName),"
                       + "\n" +       "                          (t_operationId,"
                       + "\n" +       "                           t_clientcode,"
                       + "\n" +       "                           t_shortname,"
                       + "\n" +       "                           t_operationIssueDate))"
                       + "\n" +       "       HAVING GROUPING (t_okatocode) = 0"
                       + "\n" +       "        ORDER BY t_okatocode, t_isOkato DESC, t_backoffice, t_row,t_column,t_account,t_trancheissuedate,"
                       + "\n" +       "                 t_creditDate, t_creditNumber, t_trancheIssueDate, t_roublesum, t_isTranche DESC) protocolTable"
                       + "\n" +       "WHERE (t_backoffice = 1 AND t_column NOT IN ('4', '5'))"
                       + "\n" +       "   OR (t_backoffice = 2 AND (t_column IN ('4', '5') OR t_isTranche = 0))"
                       + "\n" +       "   OR t_backoffice IS NULL";
        return m_dataSetQerry;
    end;

    macro print()
        var isFistRow = true;
        var prevBackoffice = -1;
        var prevBackofficePrev;
        var backOfficePrev;
        var okatoCodePrev;
        var col_4_5;

        while (m_dataSet.moveNext())
            col_4_5 = getColumn(true);
            m_isEmpty = false;

            if   (m_dataSet.isOkato == 1)
                printOkatoHeader(m_dataSet.okatoCode);
                isFistRow = true;
            elif ((m_dataSet.isBackOffice == 1) AND (m_dataSet.isOkato != 1))
                if (m_dataSet.backOffice != 1)
                    m_report.printBottom();
                end;
                isFistRow = true;
            elif ((m_dataSet.isColumn == 1) AND (m_dataSet.isBackOffice != 1) AND (m_dataSet.isOkato != 1))
                if (m_dataSet.backOffice == 1)
                    m_reportCB.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 40, " ") + strLPad(String(m_dataSet.t_roubleSum), 74, " "), m_reportCB.getAColumns().size);

                    prevBackofficePrev = m_dataSet.backOffice;
                    backOfficePrev = m_dataSet.backOffice;
                    okatoCodePrev =  m_dataSet.okatoCode;

                    m_dataSet.moveNext();
                    if ((prevBackofficePrev != m_dataSet.backOffice()) OR (m_dataSet.EOF))
                        if (backOfficePrev == 1)
                            m_reportCB.printBottom();

                            if (not m_dataSet.EOF)
                                if ((okatoCodePrev == m_dataSet.okatoCode))
                                    printOkatoHeader(m_dataSet.okatoCode);
                                end;
                            end;
                        end;
                    end;
                    m_dataSet.movePrev();

                else
                    if ((col_4_5 != "4") AND (col_4_5 != "5"))
                        m_report.printStringExt(strRPad("Итого строка " + m_dataSet.row + ", графа " + m_dataSet.column, 30, " ") + strLPad(String(m_dataSet.t_roubleSum), 95, " "), m_report.getAColumns().size);
                    end;
                end;
            else
                if (isFistRow or (prevBackoffice != m_dataSet.backOffice))
                    if (m_dataSet.backOffice == 1)
                        println(" Данные по ГК");
                        m_reportCB.printHead();
                    else
                        println(" Данные по Loans");
                        m_report.printHead();
                    end;
                    isFistRow = false;
                end;

                if (m_dataSet.backOffice == 1)
                    m_reportCB.printStringTransferByWord(m_dataSet.row,
                                                         m_dataSet.column,
                                                         m_dataSet.account,
                                                         m_dataSet.openDate,
                                                         m_dataSet.closeDate,
                                                         m_dataSet.currencyCode,
                                                         getCurrencySum(),
                                                         m_dataSet.roubleSum,
                                                         nvl(m_dataSet.recalculateRateDate,""),
                                                         nvl(m_dataSet.recalculateRate,""),
                                                         m_dataset.branchName
                                                        );
                elif (m_dataSet.backOffice == 2)
                    if ((col_4_5 != "4") AND (col_4_5 != "5"))
                        m_report.printStringTransferByWord(getRow(true),
                                                           getColumn(true),
                                                           getCreditNumber(),
                                                           getCreditDate(),
                                                           getIssueDate(),
                                                           m_dataSet.currencyCode,
                                                           getCurrencySum(),
                                                           m_dataSet.roubleSum,
                                                           getRecalculateRateDate(),
                                                           getContragentName(),
                                                           m_dataset.branchName
                                                          );
                    end;
                end;

            end;
            prevBackoffice = m_dataSet.backOffice;
        end;
    end;

    macro isEmpty()
        return m_isEmpty;
    end;

    /*инициализация протокола первого раздела по ГК*/
    macro initializeCB()
        m_dataSet.setFieldType("t_openDate",            V_DATE);
        m_dataSet.setFieldType("t_closeDate",           V_DATE);
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_reportCB = CTableReport(0, false, true);

        m_reportCB.addColumn("Строка",                        9, AL_LEFT);
        m_reportCB.addColumn("Графа",                         5, AL_LEFT);
        m_reportCB.addColumn("Номер счёта",                  25, AL_LEFT);
        m_reportCB.addColumn("Дата|открытия|счёта",          10, AL_LEFT);
        m_reportCB.addColumn("Дата|закрытия|счёта",          10, AL_LEFT);
        m_reportCB.addColumn("Ва-|лю-|та",                    3, AL_LEFT);
        m_reportCB.addColumn("Сумма|в валюте",               15, AL_RIGHT);
        m_reportCB.addColumn("Сумма|в рублевом|эквиваленте", 15, AL_RIGHT);
        m_reportCB.addColumn("Дата|курса|погашения|долга",   10, AL_LEFT);
        m_reportCB.addColumn("Курс|погашения|долга",         15, AL_RIGHT);
        m_reportCB.addColumn("Подразделение",                20, AL_LEFT);
    end;

    initializeCB();
end;

private class (TPart1Protocol) TPart1Protocol2627()
    initTPart1Protocol();

    private var m_column_4_5     = TPart1Col45Protocol2627();
    private var m_columnCred_4_5 = TPart1Col45CredProtocol2627();
    private var m_column_6_9     = TPart1Col69Protocol2627();

    macro print()
        printHeader();

        m_column_4_5.print();
        m_columnCred_4_5.print();
        m_column_6_9.print();

        if (    m_column_6_9.isEmpty()
            and m_column_4_5.isEmpty()
            and m_columnCred_4_5.isEmpty())
            printLn("\n Нет данных по первому разделу.\n");
        end;
    end;
end;

/***************************************************************************************************
 *  Класс протокола расчета по второму разделу
 **************************************************************************************************/
private class (TProtocol) TPart2Protocol()

    private macro getDataSet()
        return TRsbDataSet("SELECT *"
            + "\n" +       "  FROM (SELECT CASE"
            + "\n" +       "               WHEN (isGrRow = 1)"
            + "\n" +       "                   THEN 1"
            + "\n" +       "               ELSE 0"
            + "\n" +       "           END isOkato,"
            + "\n" +       "           CASE"
            + "\n" +       "               WHEN (isGrRow = 0 AND isGrColumn = 1)"
            + "\n" +       "                   THEN 1"
            + "\n" +       "               ELSE 0"
            + "\n" +       "           END isRow,"
            + "\n" +       "           CASE"
            + "\n" +       "               WHEN (isGrColumn = 0 AND isGrBackOffice = 1)"
            + "\n" +       "                   THEN 1"
            + "\n" +       "               ELSE 0"
            + "\n" +       "           END isColumn,"
            + "\n" +       "           CASE"
            + "\n" +       "               WHEN (isGrBackOffice = 0 AND isGrSum = 1)"
            + "\n" +       "                   THEN 1"
            + "\n" +       "               ELSE 0"
            + "\n" +       "           END isBackOfficeAndAccountNumber,"
            + "\n" +       "            d.*"
            + "\n" +       "      FROM (SELECT GROUPING (t_row)           isGrRow,"
            + "\n" +       "                   GROUPING (t_column)        isGrColumn,"
            + "\n" +       "                   GROUPING (t_backOffice)    isGrBackOffice,"
            + "\n" +       "                   GROUPING (t_roubleSum)     isGrSum,"
            + "\n" +       "                   t_okatoCode, t_row, t_column, t_accountNumber, t_backOffice, t_sign, SUM(t_roubleSum) t_roubleSum, SUM(t_currencySum) t_currencySum,"
            + "\n" +       "                   t_currencyId, t_shortName, t_clientCode, t_clientKind, t_recalculateRateDate"
            + "\n" +       "              FROM df302p2_tmp"
            + "\n" +       "             GROUP BY ROLLUP (t_okatoCode, t_row, t_column, (t_backOffice, t_accountNumber, t_currencyId, t_shortName, t_clientCode, t_clientKind),"
            + "\n" +       "                              (t_sign, t_recalculateRateDate, t_roubleSum, t_currencySum))"
            + "\n" +       "            HAVING GROUPING (t_okatoCode) = 0) d)"
            + "\n" +       " ORDER BY t_okatoCode, isOkato DESC, t_row, isRow DESC, t_column, isColumn, isColumn, t_backOffice, t_accountNumber, isBackOfficeAndAccountNumber DESC, t_roubleSum");
    end;

    private macro getAccountNumber(isPrinting : Bool)
        if (isPrinting)
            return m_dataSet.accountNumber;
        end;

        return "";
    end;

    private macro getCurrencySum()
        if ((m_dataSet.currencyId == NATCUR) or (m_dataSet.isBackOfficeAndAccountNumber == 1))
            return "";
        end;

        return m_dataSet.currencySum;
    end;

    private macro getRecalculateRateDate(isPrinting : Bool)
        if (isPrinting)
            return m_dataSet.recalculateRateDate;
        end;

        return "";
    end;

    private macro getBackOffice()
        if (m_dataSet.isBackOfficeAndAccountNumber)
            return subStr(TBackOffice(m_dataSet.backOffice).getSuffix(), 2);
        end;
        return "";
    end;

    private macro printHeaderBackOffice()
        if (m_dataSet.backOffice == BOCB)
            m_report.printStringExt(mkStr(" ", 20) + "Кредитовые документы по счету:", m_report.getAColumns().size);
        else
            m_report.printStringExt(mkStr(" ", 20) + "Операции по договору:", m_report.getAColumns().size);
        end;
    end;

    private macro printHeader()
        printLn("\nРАЗДЕЛ 2");
    end;

    private macro printRowHeader(isFirst : Bool)
        if (not isFirst)
            m_report.printBottom();
        end;
        printLn("\n Строка ", m_dataSet.row);
        m_report.printHead();
    end;

    private macro printColumnBottom()
        m_report.printStringExt(strRPad("Итого графа " + m_dataSet.column, 40, " ") + strLPad(String(m_dataSet.roubleSum), 41, " "), m_report.getAColumns().size);
    end;

    macro print()
        var isBackOfficeAndAccountNumber   = false;
        var isFirstRow        = true;
        var currentBackOffice = 0;
        printHeader();


        while (m_dataSet.moveNext())
            if (m_dataSet.isOkato == 1)
                printOkatoHeader();
                isFirstRow = true;
            elif (m_dataSet.isRow == 1)
                printRowHeader(isFirstRow);
                isFirstRow = false;
            elif (m_dataSet.isColumn == 1)
                printColumnBottom();
            else
                isBackOfficeAndAccountNumber = m_dataSet.isBackOfficeAndAccountNumber == 1;

                m_report.printStringTransferByWord(getColumn(isBackOfficeAndAccountNumber),
                                                   getBackOffice(),
                                                   getAccountNumber(isBackOfficeAndAccountNumber),
                                                   m_dataSet.currencyId,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getRecalculateRateDate(isBackOfficeAndAccountNumber),
                                                   getContragentName(),
                                                   m_dataSet.clientKind);
                if (isBackOfficeAndAccountNumber)
                    printHeaderBackOffice();
                end;
            end;
        end;
        if (not isFirstRow)
            m_report.printBottom();
        else
            printLn("\n Нет данных по второму разделу.\n");
        end;
    end;

    private macro initialize()
        m_dataSet = getDataSet();
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_report.addColumn("Графа",                         5,  AL_LEFT);
        m_report.addColumn("БО",                            3,  AL_LEFT);
        m_report.addColumn("Номер л/с",                    25,  AL_LEFT);
        m_report.addColumn("Ва|лю|та",                      3,  AL_LEFT);
        m_report.addColumn("Сумма|в валюте",               15,  AL_RIGHT);
        m_report.addColumn("Сумма|в рублевом|эквиваленте", 15,  AL_RIGHT);
        m_report.addColumn("Дата|курса|пересчета",         10,  AL_LEFT);
        m_report.addColumn("Контрагент",                   20,  AL_LEFT);
        m_report.addColumn(" ",                             3,  AL_LEFT);
    end;
    initTProtocol();
end;

/***************************************************************************************************
 *  Класс протокола расчета по второму разделу после 1948У
 **************************************************************************************************/
private class (TPart2Protocol) TPart2Protocol1948()

    private var m_dataSetForFirstString;

    private macro getDataSet()
        return TRsbDataSet("SELECT t_okatoCode,"
       + "\n" +      "             t_backOffice,"
       + "\n" +      "             t_row,"
       + "\n" +      "             t_column,"
       + "\n" +      "             t_accountNumber,"
       + "\n" +      "             t_currencyID,"
       + "\n" +      "             t_shortname,"
       + "\n" +      "             t_clientcode,"
       + "\n" +      "             t_clientkind,"
       + "\n" +      "             t_roublesum,"
       + "\n" +      "             t_currencysum,"
       + "\n" +      "             SUM"
       + "\n" +      "               (CASE"
       + "\n" +      "                     WHEN t_isP = '0'"
       + "\n" +      "                     THEN t_roublesum"
       + "\n" +      "                     ELSE 0"
       + "\n" +      "             END"
       + "\n" +      "                ) AS t_generalroublesum,"
       + "\n" +      "             SUM"
       + "\n" +      "               (CASE"
       + "\n" +      "                     WHEN t_isP = '0'"
       + "\n" +      "                     THEN t_currencysum"
       + "\n" +      "                     ELSE 0"
       + "\n" +      "             END"
       + "\n" +      "                ) AS t_generalcurrencysum,"
       + "\n" +      "             t_isP,"
       + "\n" +      "             t_sign,"
       + "\n" +      "             SUM"
       + "\n" +      "               (CASE"
       + "\n" +      "                   WHEN t_sign = '-' AND (t_isP <> '0')"
       + "\n" +      "                   THEN - t_roublesum"
       + "\n" +      "                   WHEN t_sign <> '-' AND (t_isP <> '0')"
       + "\n" +      "                   THEN t_roublesum"
       + "\n" +      "                   ELSE 0"
       + "\n" +      "                END"
       + "\n" +      "               ) AS t_p,"
       + "\n" +      "              GROUPING (t_accountNumber) t_isEndP,"
       + "\n" +      "              GROUPING (t_isP) t_isRowOrColumn,"
       + "\n" +      "              GROUPING (t_row) t_isOkato"
       + "\n" +      "         FROM (SELECT df302p2_tmp.*,"
       + "\n" +      "                      CASE"
       + "\n" +      "                           WHEN (t_accountnumber LIKE '40108%' OR t_accountnumber LIKE '40109%')AND (t_row = '1')"
       + "\n" +      "                           THEN 1"
       + "\n" +      "                           WHEN (t_accountnumber LIKE '40110%' OR t_accountnumber LIKE '40111%') AND (t_row = '1')"
       + "\n" +      "                           THEN 2"
       + "\n" +      "                           WHEN (t_accountnumber LIKE '40907%' OR t_accountnumber LIKE '40908%') AND (t_row = '1')"
       + "\n" +      "                           THEN 3"
       + "\n" +      "                           ELSE 0"
       + "\n" +      "                      END AS t_isP"
       + "\n" +      "                 FROM df302p2_tmp)p1p2p3"
       + "\n" +      "GROUP BY ROLLUP (t_okatoCode,"
       + "\n" +      "                 t_row,"
       + "\n" +      "                 t_column,"
       + "\n" +      "                 t_isP,"
       + "\n" +      "                 (t_backOffice,"
       + "\n" +      "                  t_accountNumber,"
       + "\n" +      "                  t_currencyID,"
       + "\n" +      "                  t_shortname,"
       + "\n" +      "                  t_clientcode,"
       + "\n" +      "                  t_clientkind,"
       + "\n" +      "                  t_sign,"
       + "\n" +      "                  t_roublesum,"
       + "\n" +      "                  t_currencysum))"
       + "\n" +      "          HAVING GROUPING (t_okatocode) = 0"
       + "\n" +      "             AND NOT (    GROUPING (t_row) = 0"
       + "\n" +      "                       AND GROUPING (t_column) = 1)"
       + "\n" +      "        ORDER BY t_okatoCode,"
       + "\n" +      "                 t_isOkato DESC,"
       + "\n" +      "                 t_row,"
       + "\n" +      "                 t_column,"
       + "\n" +      "                 t_isP,"
       + "\n" +      "                 t_isEndP,"
       + "\n" +      "                 t_backoffice");
    end;


    private macro printColumnBottom(P_)
        m_report.printStringExt(strRPad("Итого графа " + m_dataSet.column, 40, " ") + strLPad(String(m_dataSet.generalroublesum + P_), 49, " "), m_report.getAColumns().size);
    end;

    private macro printOkatoHeader()
        if (m_dataset.okatoCode == "99999")
            println("\n Код - наименование ОКАТО " + m_dataset.okatoCode + " - " + "Код ОКАТО не задан");
        else
            printOkatoHeader();
        end;

    end;

    private macro getBackOffice()
        return subStr(TBackOffice(m_dataSet.backOffice).getSuffix(), 2);
    end;

    private macro getCurrencySum()
        if (m_dataSet.currencyId == NATCUR)
            return "";
        end;

        return m_dataSet.currencySum;
    end;

    private macro printReclculateRateDate()
        printLn("\n Дата курса пересчета: ", ДатаОтчета);
    end;

    private macro printInformationAboutP1P2P3(isContinue_);
        var isContinue = NVL(isContinue_,false);

        while (isContinue)
            m_dataSetForFirstString.moveNext();
            if (m_dataSetForFirstString.okatoCode == m_dataSet.okatoCode)
            else
            end;
        end;

    end;

    macro print()
        var isBackOfficeAndAccountNumber   = false;
        var isFirstRow        = true;
        var currentBackOffice = 0;
        var previousRow ="";
        var isFirstP = true;
        var P = 0;

        printHeader();

        printReclculateRateDate();


        while (m_dataSet.moveNext())

            if (m_dataSet.isOkato == 1)
                if (not isFirstRow)
                    m_report.printBottom();
                end;
                printOkatoHeader();
                isFirstRow = true;
                previousRow = "";

            elif (m_dataSet.row != previousRow)
                if(m_dataSet.row != null)
                    printRowHeader(isFirstRow);
                    previousRow = m_dataSet.row;
                    isFirstRow = false;
                    m_report.printStringTransferByWord(m_dataSet.column,
                                                       getBackOffice(),
                                                       m_dataSet.accountNumber,
                                                       m_dataSet.currencyId,
                                                       m_dataSet.sign,
                                                       getCurrencySum(),
                                                       m_dataSet.roubleSum,
                                                       getContragentName(),
                                                       m_dataSet.clientKind);
                end;
            elif ((m_dataSet.row == previousRow) and (m_dataSet.isRowOrColumn == 1))
                printColumnBottom(P);
                P = 0;
            elif ((m_dataSet.isP == 0) and (m_dataSet.isEndP != 1))
                m_report.printStringTransferByWord(m_dataSet.column,
                                                   getBackOffice(),
                                                   m_dataSet.accountNumber,
                                                   m_dataSet.currencyId,
                                                   m_dataSet.sign,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getContragentName(),
                                                   m_dataSet.clientKind);
            elif ((m_dataSet.isP != 0) and (m_dataSet.isEndP != 1))
                if (isFirstP)
                    m_report.printStringExt("Рассчитаем P" + String(Int(m_dataSet.isP)) + ":", m_report.getAColumns().size);
                    isFirstP = false;
                end;
                m_report.printStringTransferByWord(m_dataSet.column,
                                                   getBackOffice(),
                                                   m_dataSet.accountNumber,
                                                   m_dataSet.currencyId,
                                                   m_dataSet.sign,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getContragentName(),
                                                   m_dataSet.clientKind);
            elif ((m_dataSet.isP != 0) and (m_dataSet.isEndP == 1))
                isFirstP = true;

                m_report.printStringExt("P" + String(Int(m_dataSet.isP)) + " = " + String(m_dataSet.P), m_report.getAColumns().size);
                if (m_dataSet.P < 0)
                    m_report.printStringExt("Т.к. < 0, то " + "P" + String(m_dataSet.isP) + " = " + "0",m_report.getAColumns().size);
                else
                    P = P + m_dataSet.P;
                end;
            end;
        end;
        if (not isFirstRow)
            m_report.printBottom();
        else
            printLn("\n Нет данных по второму разделу.\n");
        end;
    end;

    private macro initialize()
        m_dataSet = getDataSet();
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_report.addColumn("Графа",                         5,  AL_LEFT);
        m_report.addColumn("БО",                            3,  AL_LEFT);
        m_report.addColumn("Номер л/с",                    25,  AL_LEFT);
        m_report.addColumn("Ва|лю|та",                      3,  AL_LEFT);
        m_report.addColumn("Знак",                         5,   AL_CENTER);
        m_report.addColumn("Сумма|в валюте",               15,  AL_RIGHT);
        m_report.addColumn("Сумма|в рублевом|эквиваленте", 15,  AL_RIGHT);
        m_report.addColumn("Контрагент",                   20,  AL_LEFT);
        m_report.addColumn(" ",                             3,  AL_LEFT);
    end;
    initTPart2Protocol();
end;

/**
 * Класс протокола расчета раздела 2 в соответствии с 2742-У
 *
 * @since v.6.20.030.050
 * @version 1.0
 * @author ABP
 */
private class (TPart2Protocol1948) TPart2Protocol2742()

    private macro getDataSet()
        return TRsbDataSet("SELECT t_okatoCode,"
                  + "\n" + "       t_backOffice,"
                  + "\n" + "       t_row,"
                  + "\n" + "       t_column,"
                  + "\n" + "       t_accountNumber,"
                  + "\n" + "       t_fiCode,"
                  + "\n" + "       t_currencyId,"
                  + "\n" + "       t_shortname,"
                  + "\n" + "       t_clientcode,"
                  + "\n" + "       t_clientkind,"
                  + "\n" + "       SUM(t_roublesum) AS t_roubleSum,"
                  + "\n" + "       SUM(t_currencysum) AS t_currencySum,"
                  + "\n" + "       t_sign,"
                  + "\n" + "       t_isPledge,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 1"
                  + "\n" + "            AND GROUPING(t_row) = 1"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isOkato,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 1"
                  + "\n" + "            AND GROUPING(t_row) = 0"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isRow,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 0"
                  + "\n" + "            AND GROUPING(t_row) = 0"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isColumn"
                  + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                  + "\n" + "               df302p2_tmp.t_backOffice,"
                  + "\n" + "               df302p2_tmp.t_clientCode,"
                  + "\n" + "               df302p2_tmp.t_clientKind,"
                  + "\n" + "               df302p2_tmp.t_column,"
                  + "\n" + "               df302p2_tmp.t_contractorId,"
                  + "\n" + "               (SELECT fi.t_fi_code"
                  + "\n" + "                  FROM dfininstr_dbt fi"
                  + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                  + "\n" + "               ) AS t_fiCode,"
                  + "\n" + "               df302p2_tmp.t_currencyId,"
                  + "\n" + "               df302p2_tmp.t_currencySum,"
                  + "\n" + "               df302p2_tmp.t_okatoCode,"
                  + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                  + "\n" + "               df302p2_tmp.t_roubleSum,"
                  + "\n" + "               CASE df302p2_tmp.t_row"
                  + "\n" + "                   WHEN '1.7_з' THEN '1.7'"
                  + "\n" + "                   WHEN '1.8_з' THEN '1.8'"
                  + "\n" + "                   ELSE df302p2_tmp.t_row"
                  + "\n" + "               END AS t_row,"
                  + "\n" + "               df302p2_tmp.t_shortName,"
                  + "\n" + "               df302p2_tmp.t_sign,"
                  + "\n" + "               CASE"
                  + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.7_з', '1.8_з')"
                  + "\n" + "                       THEN 'X'"
                  + "\n" + "                   ELSE CHR(1)"
                  + "\n" + "               END AS t_isPledge"
                  + "\n" + "          FROM df302p2_tmp"
                  + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                  + "\n" + "       )"
                  + "\n" + " GROUP BY ROLLUP (t_okatoCode,"
                  + "\n" + "                  t_row,"
                  + "\n" + "                  t_column,"
                  + "\n" + "                  (t_accountNumber,"
                  + "\n" + "                   t_backOffice,"
                  + "\n" + "                   t_isPledge,"
                  + "\n" + "                   t_fiCode,"
                  + "\n" + "                   t_currencyId,"
                  + "\n" + "                   t_shortName,"
                  + "\n" + "                   t_clientCode,"
                  + "\n" + "                   t_clientKind,"
                  + "\n" + "                   t_sign"
                  + "\n" + "                  )"
                  + "\n" + "                 )"
                  + "\n" + "HAVING GROUPING_ID(t_okatoCode, t_row, t_column) = 0"
                  + "\n" + "    OR GROUPING_ID(t_okatoCode, t_row, t_column) = 1"
                  + "\n" + "    OR GROUPING_ID(t_okatoCode, t_row, t_column) = 3"
                  + "\n" + " ORDER BY t_okatoCode,"
                  + "\n" + "          t_row NULLS LAST,"
                  + "\n" + "          t_column NULLS LAST,"
                  + "\n" + "          t_backoffice NULLS LAST,"
                  + "\n" + "          t_accountNumber NULLS LAST"
                          );
    end;

    private macro printColumnBottom()
        m_report.printStringExt("Итого графа " + m_dataSet.column, 6, String(m_dataSet.roubleSum : 0 : 2));
    end;

    private macro printReclculateRateDate()
        m_report.printFreeString("\nДата курса пересчета: " + String(ДатаОтчета : f));
    end;

    macro print()
        var isFirstRow = true;
        var hasData = false;
        var needRowHeader = true;
        var needOkatoHeader = true;

        printHeader();

        printReclculateRateDate();

        while (m_dataSet.moveNext())

            hasData = true;

            if (needOkatoHeader)
                printOkatoHeader(m_dataSet.okatoCode);
                needOkatoHeader = false;
                isFirstRow = true;
            end;

            if (needRowHeader)
                if (not isFirstRow)
                    m_report.printBottom();
                else
                    isFirstRow = false;
                end;

                if (m_dataSet.isOkato != 1)
                    m_report.printFreeString("\n Строка " + m_dataSet.row);
                    m_report.printHead();
                end;

                needRowHeader = false;
            end;

            if (m_dataSet.isOkato == 1)
                needOkatoHeader = true;
                needRowHeader = true;
            elif (m_dataSet.isRow == 1)
                needRowHeader = true;
            elif (m_dataSet.isColumn == 1)
                printColumnBottom();
            else
                m_report.printStringTransferByWord(m_dataSet.column,
                                                   getBackOffice(),
                                                   m_dataSet.accountNumber,
                                                   m_dataSet.fiCode,
                                                   m_dataSet.sign,
                                                   getCurrencySum(),
                                                   m_dataSet.roubleSum,
                                                   getContragentName(),
                                                   m_dataSet.clientKind,
                                                   m_dataSet.isPledge
                                                  );
            end;

        end;

        if (not hasData)
            m_report.printFreeString("\n Нет данных по второму разделу.");
        end;
    end;

    private macro initialize()
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_report.addColumn("Графа",                         5,  AL_LEFT);
        m_report.addColumn("БО",                            3,  AL_LEFT);
        m_report.addColumn("Номер л/с",                    25,  AL_LEFT);
        m_report.addColumn("Ва|лю|та",                      3,  AL_LEFT);
        m_report.addColumn("Знак",                          5,  AL_CENTER);
        m_report.addColumn("Сумма|в валюте",               15,  AL_RIGHT);
        m_report.addColumn("Сумма|в рублевом|эквиваленте", 15,  AL_RIGHT);
        m_report.addColumn("Контрагент",                   20,  AL_LEFT);
        m_report.addColumn(" ",                             3,  AL_LEFT);
        m_report.addColumn("Залог|за|ключ",                 3,  AL_CENTER);
    end;

    initTPart2Protocol1948();
end;


/**
 * Класс протокола расчета раздела 2 в соответствии с 2926-У
 *
 * @since v.6.20.030.057
 * @version 1.0
 * @author GWW
 */
private class (TPart2Protocol2742) TPart2Protocol2926()

    private macro getDataSet()
        return TRsbDataSet("SELECT t_okatoCode,"
                  + "\n" + "       t_backOffice,"
                  + "\n" + "       t_row,"
                  + "\n" + "       t_column,"
                  + "\n" + "       t_accountNumber,"
                  + "\n" + "       t_fiCode,"
                  + "\n" + "       t_currencyId,"
                  + "\n" + "       t_shortname,"
                  + "\n" + "       t_clientcode,"
                  + "\n" + "       t_clientkind,"
                  + "\n" + "       SUM(t_roublesum) AS t_roubleSum,"
                  + "\n" + "       SUM(t_currencysum) AS t_currencySum,"
                  + "\n" + "       t_sign,"
                  + "\n" + "       t_isPledge,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 1"
                  + "\n" + "            AND GROUPING(t_row) = 1"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isOkato,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 1"
                  + "\n" + "            AND GROUPING(t_row) = 0"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isRow,"
                  + "\n" + "       CASE"
                  + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                  + "\n" + "            AND GROUPING(t_column) = 0"
                  + "\n" + "            AND GROUPING(t_row) = 0"
                  + "\n" + "           THEN 1"
                  + "\n" + "           ELSE 0"
                  + "\n" + "       END AS t_isColumn"
                  + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                  + "\n" + "               df302p2_tmp.t_backOffice,"
                  + "\n" + "               df302p2_tmp.t_clientCode,"
                  + "\n" + "               df302p2_tmp.t_clientKind,"
                  + "\n" + "               df302p2_tmp.t_column,"
                  + "\n" + "               df302p2_tmp.t_contractorId,"
                  + "\n" + "               (SELECT fi.t_fi_code"
                  + "\n" + "                  FROM dfininstr_dbt fi"
                  + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                  + "\n" + "               ) AS t_fiCode,"
                  + "\n" + "               df302p2_tmp.t_currencyId,"
                  + "\n" + "               df302p2_tmp.t_currencySum,"
                  + "\n" + "               df302p2_tmp.t_okatoCode,"
                  + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                  + "\n" + "               df302p2_tmp.t_roubleSum,"
                  + "\n" + "               CASE df302p2_tmp.t_row"
                  + "\n" + "                   WHEN '1.9_з' THEN '1.9'"
                  + "\n" + "                   ELSE df302p2_tmp.t_row"
                  + "\n" + "               END AS t_row,"
                  + "\n" + "               df302p2_tmp.t_shortName,"
                  + "\n" + "               df302p2_tmp.t_sign,"
                  + "\n" + "               CASE"
                  + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                  + "\n" + "                       THEN 'X'"
                  + "\n" + "                   ELSE CHR(1)"
                  + "\n" + "               END AS t_isPledge"
                  + "\n" + "          FROM df302p2_tmp"
                  + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                  + "\n" + "       )"
                  + "\n" + " GROUP BY ROLLUP (t_okatoCode,"
                  + "\n" + "                  t_row,"
                  + "\n" + "                  t_column,"
                  + "\n" + "                  (t_accountNumber,"
                  + "\n" + "                   t_backOffice,"
                  + "\n" + "                   t_isPledge,"
                  + "\n" + "                   t_fiCode,"
                  + "\n" + "                   t_currencyId,"
                  + "\n" + "                   t_shortName,"
                  + "\n" + "                   t_clientCode,"
                  + "\n" + "                   t_clientKind,"
                  + "\n" + "                   t_sign"
                  + "\n" + "                  )"
                  + "\n" + "                 )"
                  + "\n" + "HAVING GROUPING_ID(t_okatoCode, t_row, t_column) = 0"
                  + "\n" + "    OR GROUPING_ID(t_okatoCode, t_row, t_column) = 1"
                  + "\n" + "    OR GROUPING_ID(t_okatoCode, t_row, t_column) = 3"
                  + "\n" + " ORDER BY t_okatoCode,"
                  + "\n" + "          t_row NULLS LAST,"
                  + "\n" + "          t_column NULLS LAST,"
                  + "\n" + "          t_backoffice NULLS LAST,"
                  + "\n" + "          t_accountNumber NULLS LAST"
                          );
    end;

    initTPart2Protocol2742();
end;

private class (TPart2Protocol2926) TPart2Protocol3129()

    //класс для сохранения промежуточных сумм по корректирующим счетам ГК
    private class CorrectCbAccountsSumClass(column4, column5)
        var m_column4 : Money = column4;
        var m_column5 : Money = column5;

        macro plus(obj)
            m_column4 = m_column4 + obj.m_column4;
            m_column5 = m_column5 + obj.m_column5;
        end;
    end;

    private var CorrectCbAccountsSum = CorrectCbAccountsSumClass(0, 0);
    private var m_reportCbAll = CTableReport(0, false, true);             //таблица по данным ГК (без корректирующих счетов)
    private var m_reportCb    = CTableReport(0, false, true);             //таблица по корректирующим счетам ГК
    private var m_reportRt    = CTableReport(0, false, true);             //таблица по Ритейлу
    private var m_reportLn    = CTableReport(0, false, true);             //таблица по Депозитам
    private var m_curreport;                                              //"абстрактная" таблица

    //отбор данных для таблиц по ГК (без корректирующих счетов), Депозитам и Ритейлу
    private macro getDataSet()
        var dataSet = TRsbDataSet("SELECT t_okatoCode,"
                         + "\n" + "       t_row,"
                         + "\n" + "       t_backOffice,"
                         + "\n" + "       t_accountNumber,"
                         + "\n" + "       t_fiCode,"
                         + "\n" + "       t_shortname,"
                         + "\n" + "       t_clientcode,"
                         + "\n" + "       t_clientkind,"
                         + "\n" + "       SUM(t_roublesum4)                             AS t_roubleSum4,"
                         + "\n" + "       SUM(t_currencysum4)                           AS t_currencySum4,"
                         + "\n" + "       SUM(t_roublesum5)                             AS t_roubleSum5,"
                         + "\n" + "       SUM(t_currencysum5)                           AS t_currencySum5,"
                         + "\n" + "       t_sign,"
                         + "\n" + "       t_isPledge,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN     GROUPING(t_accountNumber) = 1"
                         + "\n" + "                AND GROUPING(t_backOffice)    = 1"
                         + "\n" + "                AND GROUPING(t_row)           = 1"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isOkato,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN     GROUPING(t_accountNumber) = 1"
                         + "\n" + "                AND GROUPING(t_backOffice)    = 1"
                         + "\n" + "                AND GROUPING(t_row)           = 0"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isRow,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isBO,"
                         + "\n" + "       GROUPING(t_accountNumber)                     AS accGrouping,"
                         + "\n" + "       GROUPING(t_backOffice)                        AS boGrouping,"
                         + "\n" + "       GROUPING(t_row)                               AS rowGrouping"
                         + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencySum4,"
                         + "\n" + "               0                                                         AS t_currencysum5,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roubleSum4,"
                         + "\n" + "               0                                                         AS t_roublesum5,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 4"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "         UNION"
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               0                                                         AS t_currencysum4,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencySum5,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                         AS t_roublesum4,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roubleSum5,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 5"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "       )"
                         + "\n" + " GROUP BY ROLLUP (t_okatoCode,"
                         + "\n" + "                  t_row,"
                         + "\n" + "                  t_backOffice,"
                         + "\n" + "                  ("
                         + "\n" + "                   t_accountNumber,"
                         + "\n" + "                   t_isPledge,"
                         + "\n" + "                   t_fiCode,"
                         + "\n" + "                   t_shortName,"
                         + "\n" + "                   t_clientCode,"
                         + "\n" + "                   t_clientKind,"
                         + "\n" + "                   t_sign"
                         + "\n" + "                  )"
                         + "\n" + "                 )"
                         + "\n" + " ORDER BY t_okatoCode,"
                         + "\n" + "          t_row           NULLS LAST,"
                         + "\n" + "          t_backoffice    NULLS LAST,"
                         + "\n" + "          t_fiCode        NULLS LAST,"
                         + "\n" + "          t_accountNumber NULLS LAST"
                                  );

        dataSet.setFieldType("t_roubleSum4",   V_MONEY);
        dataSet.setFieldType("t_roubleSum5",   V_MONEY);
        dataSet.setFieldType("t_currencySum4", V_MONEY);
        dataSet.setFieldType("t_currencySum5", V_MONEY);

        return dataSet;
    end;

    //отбор данных для таблицы по корректирующим счетам ГК
    private macro getDataSetCorrectAccounts(Okato, passiveAccount, activeAccount)
        var dataSet = TRsbDataSet("SELECT t_accountNumber,"
                         + "\n" + "       t_fiCode,"
                         + "\n" + "       t_currencyId,"
                         + "\n" + "       t_shortname,"
                         + "\n" + "       t_clientcode,"
                         + "\n" + "       t_clientkind,"
                         + "\n" + "       SUM(t_roublesum4)         AS t_roubleSum4,"
                         + "\n" + "       SUM(t_currencysum4)       AS t_currencySum4,"
                         + "\n" + "       SUM(t_roublesum5)         AS t_roubleSum5,"
                         + "\n" + "       SUM(t_currencysum5)       AS t_currencySum5,"
                         + "\n" + "       t_sign,"
                         + "\n" + "       SUM(t_outcoverrestP)      AS t_outcoverrestP,"
                         + "\n" + "       SUM(t_outcoverrestA)      AS t_outcoverrestA,"
                         + "\n" + "       GROUPING(t_accountNumber) AS accGrouping,"
                         + "\n" + "       GROUPING(t_fiCode)        AS fiCodeGrouping"
                         + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencySum4,"
                         + "\n" + "               0                                                                     AS t_currencysum5,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roubleSum4,"
                         + "\n" + "               0                                                                     AS t_roublesum5,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 4"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "         UNION"
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               0                                                                     AS t_currencysum4,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencySum5,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                                     AS t_roublesum4,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roubleSum5,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 5"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "       )"
                         + "\n" + " GROUP BY ROLLUP (t_fiCode,"
                         + "\n" + "                  ("
                         + "\n" + "                   t_accountNumber,"
                         + "\n" + "                   t_currencyId,"
                         + "\n" + "                   t_shortName,"
                         + "\n" + "                   t_clientCode,"
                         + "\n" + "                   t_clientKind,"
                         + "\n" + "                   t_sign"
                         + "\n" + "                  )"
                         + "\n" + "                 )"
                         + "\n" + " ORDER BY t_fiCode        NULLS LAST,"
                         + "\n" + "          t_accountNumber NULLS LAST"
                                 );
        dataSet.setFieldType("t_outcoverrestA", V_MONEY);
        dataSet.setFieldType("t_outcoverrestP", V_MONEY);
        dataSet.setFieldType("t_roubleSum4",    V_MONEY);
        dataSet.setFieldType("t_roubleSum5",    V_MONEY);
        dataSet.setFieldType("t_currencySum4",  V_MONEY);
        dataSet.setFieldType("t_currencySum5",  V_MONEY);

        return dataSet;
    end;

    private macro printHeaderBackOffice()
        if (m_dataSet.backOffice != NULL)
            println(" Наименование бэк-офиса: ", TBackOffice(m_dataSet.backOffice).getFullName());
        end;
    end;

    //печать строк таблицы по корректирующим счетам ГК (без шапки, низа и Итого)
    macro printCorrectAccounts(Okato, passiveAccount, activeAccount) : CorrectCbAccountsSumClass
        var dataSet = getDataSetCorrectAccounts(Okato, passiveAccount, activeAccount);
        var active  = $0;
        var passive = $0;
        var title;
        var currency;
        private var currentSum = CorrectCbAccountsSumClass($0, $0);

        while (dataSet.moveNext())
            if   (SubStr(dataSet.accountNumber, 1, 5) == passiveAccount)
                m_reportCb.printStringTransferByWord(dataSet.accountNumber,
                                                     dataSet.fiCode,
                                                     dataSet.t_outcoverrestP,
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     dataSet.t_shortName,
                                                     dataSet.t_clientkind
                                                    );
                passive = passive + dataSet.t_outcoverrestP;
                currency = dataSet.currencyId;
            elif (SubStr(dataSet.accountNumber, 1, 5) == activeAccount)
                m_reportCb.printStringTransferByWord(dataSet.accountNumber,
                                                     dataSet.fiCode,
                                                     "",
                                                     dataSet.t_outcoverrestA,
                                                     "",
                                                     "",
                                                     "",
                                                     dataSet.t_shortName,
                                                     dataSet.t_clientkind
                                                    );

                active = active + dataSet.t_outcoverrestA;
                currency = dataSet.currencyId;
            elif (    (dataSet.accGrouping    == 1)
                  and (dataSet.fiCodeGrouping == 0))
                if (currency == NATCUR)
                    title = "Итого по счетам " + passiveAccount +", " + activeAccount + " в нац. валюте:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column4 = ternary(passive - active > 0, currentSum.m_column4 + passive - active, currentSum.m_column4 + $0);
                    passive = $0;
                    active = $0;
                else
                    title = "Итого по счетам " + passiveAccount +", " + activeAccount + " в ин. валюте:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         "",
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column5 = ternary(passive - active > 0, currentSum.m_column5 + passive - active, currentSum.m_column5 + $0);
                end;
            end;
        end;

        return currentSum;
    end;

    macro print()
        var hasData         = false;
        var needRowHeader   = true;
        var needOkatoHeader = true;
        var m_isRetail      = false;

        printHeader();
        printReclculateRateDate();

        while (m_dataSet.moveNext())
            hasData = true;

            if ((m_dataSet.isRow == 1) or (m_dataSet.isBO == 1))
                needRowHeader   = true;
            end;

            if ((needOkatoHeader) and (m_dataSet.OkatoCode != Null))
                printOkatoHeader(m_dataSet.okatoCode);
                needOkatoHeader = false;
            end;

            if ((m_dataSet.isBO == 1) and (m_dataSet.isRow != 1) and (m_dataSet.isOkato != 1))
                m_curreport.printBottom();
                if (m_isRetail == true)
                    [####################                    ################   ###############]
                    ("   Всего по бэкофису", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                else
                    [####################               ################  ################]
                    ("   Всего по бэкофису", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                end;
                continue;
            end;

            if ((m_dataSet.isRow == 1) and (m_dataSet.isOkato != 1))
                if (m_isRetail == true)
                    [####################                    ################   ###############]
                    ("   Всего по строке", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                else
                    [####################               ################  ################]
                    ("   Всего по строке", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                end;

                //для строк 1 и 1.1 выводим информацию по корректирующим счетам
                if (m_dataSet.row == "1")
                    m_reportCb.printHead();
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40907","40908"));
                    m_reportCb.printStringTransferByWord("Итого:",
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         CorrectCbAccountsSum.m_column4,
                                                         CorrectCbAccountsSum.m_column5,
                                                         "",
                                                         ""
                                                        );
                    CorrectCbAccountsSum = CorrectCbAccountsSumClass(0, 0);
                    m_reportCb.printBottom();
                end;
                if (m_dataSet.row == "1.1")
                    m_reportCb.printHead();
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40108","40109"));
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40110","40111"));
                    m_reportCb.printStringTransferByWord("Итого:",
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         CorrectCbAccountsSum.m_column4,
                                                         CorrectCbAccountsSum.m_column5,
                                                         "",
                                                         ""
                                                        );
                    m_reportCb.printBottom();
                end;
                continue;
            end;

            if (m_dataSet.isOkato == 1)
                if (m_dataSet.OkatoCode != Null)
                    if (m_isRetail == true)
                        [####################                    ################   ###############]
                        ("   Всего по ОКАТО", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                    else
                        [####################               ################  ################]
                        ("   Всего по ОКАТО", m_dataSet.t_roubleSum4:r, m_dataSet.t_roubleSum5:r);
                    end;
                    needOkatoHeader = true;
                end;
                continue;
            end;

            if (needRowHeader)
                if   (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Главная книга")
                    m_curreport = m_reportCbAll;
                    m_isRetail  = false;
                elif (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Депозиты")
                    m_curreport = m_reportLn;
                    m_isRetail  = false;
                elif (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Retail")
                    m_curreport = m_reportRt;
                    m_isRetail  = true;
                else
                    continue;//msgbox("Unknow BackOffice!");
                end;

                if (m_dataSet.isOkato != 1)
                    m_reportCbAll.printFreeString("\n Строка " + m_dataSet.row);
                    printHeaderBackOffice();
                    m_curreport.printHead();
                    needRowHeader = false;
                end;
            end;

            if   (   (m_curreport == m_reportCbAll)
                  or (m_curreport == m_reportLn))
                m_curreport.printStringTransferByWord(m_dataSet.accountNumber,
                                                      m_dataSet.fiCode,
                                                      ternary((m_dataSet.fiCode == "810") or  (m_dataSet.fiCode == "643"), m_dataSet.roubleSum4, ""),
                                                      ternary((m_dataSet.fiCode != "810") and (m_dataSet.fiCode != "643"), m_dataSet.roubleSum5, ""),
                                                      getContragentName()
                                                     );
            elif (m_curreport == m_reportRt)
                m_curreport.printStringTransferByWord(m_dataSet.accountNumber,
                                                      m_dataSet.fiCode,
                                                      ternary((m_dataSet.fiCode == "810") or  (m_dataSet.fiCode == "643"), m_dataSet.roubleSum4, ""),
                                                      ternary((m_dataSet.fiCode != "810") and (m_dataSet.fiCode != "643"), m_dataSet.roubleSum5, ""),
                                                      getContragentName(),
                                                      m_dataSet.isPledge
                                                     );
            end;
        end;

        if (not hasData)
            m_report.printFreeString("\n Нет данных по второму разделу.");
        end;
    end;

    private macro initialize()
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_reportLn.addColumn("Номер договора",                     25, AL_LEFT);
        m_reportLn.addColumn("Ва-|лю-|та",                          3, AL_LEFT);
        m_reportLn.addColumn("Графа 4",                            15, AL_RIGHT);
        m_reportLn.addColumn("Графа 5",                            15, AL_RIGHT);
        m_reportLn.addColumn("Контрагент",                         30, AL_LEFT);

        m_reportRt.addColumn("Номер договора",                     25, AL_LEFT);
        m_reportRt.addColumn("Валюта|договора",                     8, AL_CENTER);
        m_reportRt.addColumn("Графа 4",                            15, AL_RIGHT);
        m_reportRt.addColumn("Графа 5",                            15, AL_RIGHT);
        m_reportRt.addColumn("Контрагент",                         40, AL_LEFT);
        m_reportRt.addColumn("Залог|за|ключ",                       3, AL_CENTER);

        m_reportCb.addColumn("Номер л/с",                          25, AL_LEFT);
        m_reportCb.addColumn("Ва-|лю-|та",                          3, AL_LEFT);
        m_reportCb.addColumn("Остаток счета (П)",                  15, AL_RIGHT);
        m_reportCb.addColumn("Остаток счета (А)",                  15, AL_RIGHT);
        m_reportCb.addColumn("П - А",                              15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 4)", 15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 5)", 15, AL_RIGHT);
        m_reportCb.addColumn("Контрагент",                         40, AL_LEFT);
        m_reportCb.addColumn("",                                    1, AL_LEFT);

        m_reportCbAll.addColumn("Номер л/с",                       25, AL_LEFT);
        m_reportCbAll.addColumn("Ва-|лю-|та",                       3, AL_LEFT);
        m_reportCbAll.addColumn("Графа 4",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Графа 5",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Контрагент",                      40, AL_LEFT);
    end;

    initTPart2Protocol2926();
end;

private class (TPart2Protocol3129) TPart2Protocol4637()

    //класс для сохранения промежуточных сумм по корректирующим счетам ГК
    private class CorrectCbAccountsSumClass_4637(column4, column5, column6, column7, column8)
        var m_column4 : Money = column4;
        var m_column5 : Money = column5;
        var m_column6 : Money = column6;
        var m_column7 : Money = column7;
        var m_column8 : Money = column8;

        macro plus(obj)
            m_column4 = m_column4 + obj.m_column4;
            m_column5 = m_column5 + obj.m_column5;
            m_column6 = m_column6 + obj.m_column6;
            m_column7 = m_column7 + obj.m_column7;
            m_column8 = m_column8 + obj.m_column8;
        end;
    end;

    //отбор данных для таблиц по ГК (без корректирующих счетов), Депозитам и Ритейлу
    private macro getDataSet()
        var dataSet = TRsbDataSet("SELECT t_okatoCode,"
                         + "\n" + "       t_row,"
                         + "\n" + "       t_backOffice,"
                         + "\n" + "       t_accountNumber,"
                         + "\n" + "       t_fiCode,"
                         + "\n" + "       t_column,"
                         + "\n" + "       t_order,"
                         + "\n" + "       t_shortname,"
                         + "\n" + "       t_clientcode,"
                         + "\n" + "       t_clientkind,"
                         + "\n" + "       SUM(t_roublesum4)                             AS t_roubleSum4,"
                         + "\n" + "       SUM(t_currencysum4)                           AS t_currencySum4,"
                         + "\n" + "       SUM(t_roublesum5)                             AS t_roubleSum5,"
                         + "\n" + "       SUM(t_currencysum5)                           AS t_currencySum5,"
                         + "\n" + "       SUM(t_roublesum6)                             AS t_roubleSum6,"
                         + "\n" + "       SUM(t_currencysum6)                           AS t_currencySum6,"
                         + "\n" + "       SUM(t_roublesum7)                             AS t_roubleSum7,"
                         + "\n" + "       SUM(t_currencysum7)                           AS t_currencySum7,"
                         + "\n" + "       SUM(t_roublesum8)                             AS t_roubleSum8,"
                         + "\n" + "       SUM(t_currencysum8)                           AS t_currencySum8,"
                         + "\n" + "       t_sign,"
                         + "\n" + "       t_isPledge,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN     GROUPING(t_accountNumber) = 1"
                         + "\n" + "                AND GROUPING(t_backOffice)    = 1"
                         + "\n" + "                AND GROUPING(t_row)           = 1"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isOkato,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN     GROUPING(t_accountNumber) = 1"
                         + "\n" + "                AND GROUPING(t_backOffice)    = 1"
                         + "\n" + "                AND GROUPING(t_row)           = 0"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isRow,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN GROUPING(t_accountNumber) = 1"
                         + "\n" + "           THEN 1"
                         + "\n" + "           ELSE 0"
                         + "\n" + "       END                                           AS t_isBO,"
                         + "\n" + "       GROUPING(t_accountNumber)                     AS accGrouping,"
                         + "\n" + "       GROUPING(t_backOffice)                        AS boGrouping,"
                         + "\n" + "       GROUPING(t_row)                               AS rowGrouping"
                         //прочие
                         + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               '4'                                                       AS t_column,"
                         + "\n" + "               5                                                         AS t_order,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencySum4,"
                         + "\n" + "               0                                                         AS t_currencysum5,"
                         + "\n" + "               0                                                         AS t_currencysum6,"
                         + "\n" + "               0                                                         AS t_currencysum7,"
                         + "\n" + "               0                                                         AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roubleSum4,"
                         + "\n" + "               0                                                         AS t_roublesum5,"
                         + "\n" + "               0                                                         AS t_roublesum6,"
                         + "\n" + "               0                                                         AS t_roublesum7,"
                         + "\n" + "               0                                                         AS t_roublesum8,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 4"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "         UNION"
                         //рубли
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               1                                                         AS t_order,"
                         + "\n" + "               0                                                         AS t_currencysum4,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencySum5,"
                         + "\n" + "               0                                                         AS t_currencysum6,"
                         + "\n" + "               0                                                         AS t_currencysum7,"
                         + "\n" + "               0                                                         AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                         AS t_roublesum4,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roubleSum5,"
                         + "\n" + "               0                                                         AS t_roublesum6,"
                         + "\n" + "               0                                                         AS t_roublesum7,"
                         + "\n" + "               0                                                         AS t_roublesum8,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 5"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "         UNION"
                         //доллары США
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               2                                                         AS t_order,"
                         + "\n" + "               0                                                         AS t_currencysum4,"
                         + "\n" + "               0                                                         AS t_currencySum5,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencysum6,"
                         + "\n" + "               0                                                         AS t_currencysum7,"
                         + "\n" + "               0                                                         AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                         AS t_roublesum4,"
                         + "\n" + "               0                                                         AS t_roubleSum5,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roublesum6,"
                         + "\n" + "               0                                                         AS t_roublesum7,"
                         + "\n" + "               0                                                         AS t_roublesum8,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 6"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "         UNION"
                         //евро
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               3                                                         AS t_order,"
                         + "\n" + "               0                                                         AS t_currencysum4,"
                         + "\n" + "               0                                                         AS t_currencySum5,"
                         + "\n" + "               0                                                         AS t_currencysum6,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencysum7,"
                         + "\n" + "               0                                                         AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                         AS t_roublesum4,"
                         + "\n" + "               0                                                         AS t_roubleSum5,"
                         + "\n" + "               0                                                         AS t_roublesum6,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roublesum7,"
                         + "\n" + "               0                                                         AS t_roublesum8,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 7"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "         UNION"
                         //юани
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_backOffice,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               NVL((SELECT fi.t_code"
                         + "\n" + "                      FROM dRepFinInstrument_vw fi"
                         + "\n" + "                     WHERE fi.t_id = df302p2_tmp.t_currencyId"
                         + "\n" + "                   ),"
                         + "\n" + "                   (SELECT fi.t_short_name"
                         + "\n" + "                      FROM dCurrency_dbt fi"
                         + "\n" + "                     WHERE fi.t_code_currency = df302p2_tmp.t_currencyId"
                         + "\n" + "                   )"
                         + "\n" + "                  )                                                      AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               4                                                         AS t_order,"
                         + "\n" + "               0                                                         AS t_currencysum4,"
                         + "\n" + "               0                                                         AS t_currencySum5,"
                         + "\n" + "               0                                                         AS t_currencysum6,"
                         + "\n" + "               0                                                         AS t_currencysum7,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                 AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_okatoCode,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                         AS t_roublesum4,"
                         + "\n" + "               0                                                         AS t_roubleSum5,"
                         + "\n" + "               0                                                         AS t_roublesum6,"
                         + "\n" + "               0                                                         AS t_roublesum7,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                   AS t_roublesum8,"
                         + "\n" + "               CASE df302p2_tmp.t_row"
                         + "\n" + "                   WHEN '1.9_з' THEN '1'"
                         + "\n" + "                   ELSE df302p2_tmp.t_row"
                         + "\n" + "               END                                                       AS t_row,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE"
                         + "\n" + "                   WHEN df302p2_tmp.t_row IN ('1.9_з')"
                         + "\n" + "                       THEN 'X'"
                         + "\n" + "                   ELSE CHR(1)"
                         + "\n" + "               END                                                       AS t_isPledge"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column = 8"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40907'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40908'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40108'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40109'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40110'"
                         + "\n" + "           AND SUBSTR(df302p2_tmp.t_accountNumber,1,5) <> '40111'"
                         + "\n" + "       )"
                         + "\n" + " GROUP BY ROLLUP (t_okatoCode,"
                         + "\n" + "                  t_row,"
                         + "\n" + "                  t_backOffice,"
                         + "\n" + "                  ("
                         + "\n" + "                   t_accountNumber,"
                         + "\n" + "                   t_isPledge,"
                         + "\n" + "                   t_fiCode,"
                         + "\n" + "                   t_column,"
                         + "\n" + "                   t_order,"
                         + "\n" + "                   t_shortName,"
                         + "\n" + "                   t_clientCode,"
                         + "\n" + "                   t_clientKind,"
                         + "\n" + "                   t_sign"
                         + "\n" + "                  )"
                         + "\n" + "                 )"
                         + "\n" + " ORDER BY t_okatoCode,"
                         + "\n" + "          t_row           NULLS LAST,"
                         + "\n" + "          t_backoffice    NULLS LAST,"
                         + "\n" + "          t_order,"
                         + "\n" + "          t_fiCode        NULLS LAST,"
                         + "\n" + "          t_accountNumber NULLS LAST"
                                  );

        dataSet.setFieldType("t_roubleSum4",   V_MONEY);
        dataSet.setFieldType("t_roubleSum5",   V_MONEY);
        dataSet.setFieldType("t_roubleSum6",   V_MONEY);
        dataSet.setFieldType("t_roubleSum7",   V_MONEY);
        dataSet.setFieldType("t_roubleSum8",   V_MONEY);
        dataSet.setFieldType("t_currencySum4", V_MONEY);
        dataSet.setFieldType("t_currencySum5", V_MONEY);
        dataSet.setFieldType("t_currencySum6", V_MONEY);
        dataSet.setFieldType("t_currencySum7", V_MONEY);
        dataSet.setFieldType("t_currencySum8", V_MONEY);

        return dataSet;
    end;

    //отбор данных для таблицы по корректирующим счетам ГК
    private macro getDataSetCorrectAccounts(Okato, passiveAccount, activeAccount)
        var dataSet = TRsbDataSet("SELECT t_accountNumber,"
                         + "\n" + "       t_fiCode,"
                         + "\n" + "       t_currencyId,"
                         + "\n" + "       t_column,"
                         + "\n" + "       t_order,"
                         + "\n" + "       t_shortname,"
                         + "\n" + "       t_clientcode,"
                         + "\n" + "       t_clientkind,"
                         + "\n" + "       SUM(t_roublesum4)         AS t_roubleSum4,"
                         + "\n" + "       SUM(t_currencysum4)       AS t_currencySum4,"
                         + "\n" + "       SUM(t_roublesum5)         AS t_roubleSum5,"
                         + "\n" + "       SUM(t_currencysum5)       AS t_currencySum5,"
                         + "\n" + "       SUM(t_roublesum6)         AS t_roubleSum6,"
                         + "\n" + "       SUM(t_currencysum6)       AS t_currencySum6,"
                         + "\n" + "       SUM(t_roublesum7)         AS t_roubleSum7,"
                         + "\n" + "       SUM(t_currencysum7)       AS t_currencySum7,"
                         + "\n" + "       SUM(t_roublesum8)         AS t_roubleSum8,"
                         + "\n" + "       SUM(t_currencysum8)       AS t_currencySum8,"
                         + "\n" + "       t_sign,"
                         + "\n" + "       SUM(t_outcoverrestP)      AS t_outcoverrestP,"
                         + "\n" + "       SUM(t_outcoverrestA)      AS t_outcoverrestA,"
                         + "\n" + "       GROUPING(t_accountNumber) AS accGrouping,"
                         + "\n" + "       GROUPING(t_fiCode)        AS fiCodeGrouping"
                         //прочие
                         + "\n" + "  FROM (SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               5                                                                     AS t_order,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencysum4,"
                         + "\n" + "               0                                                                     AS t_currencySum5,"
                         + "\n" + "               0                                                                     AS t_currencysum6,"
                         + "\n" + "               0                                                                     AS t_currencysum7,"
                         + "\n" + "               0                                                                     AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roublesum4,"
                         + "\n" + "               0                                                                     AS t_roubleSum5,"
                         + "\n" + "               0                                                                     AS t_roublesum6,"
                         + "\n" + "               0                                                                     AS t_roublesum7,"
                         + "\n" + "               0                                                                     AS t_roublesum8,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 4"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "         UNION"
                         //рубли
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               1                                                                     AS t_order,"
                         + "\n" + "               0                                                                     AS t_currencysum4,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencySum5,"
                         + "\n" + "               0                                                                     AS t_currencysum6,"
                         + "\n" + "               0                                                                     AS t_currencysum7,"
                         + "\n" + "               0                                                                     AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                                     AS t_roublesum4,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roubleSum5,"
                         + "\n" + "               0                                                                     AS t_roublesum6,"
                         + "\n" + "               0                                                                     AS t_roublesum7,"
                         + "\n" + "               0                                                                     AS t_roublesum8,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 5"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "         UNION"
                         //доллары США
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               2                                                                     AS t_order,"
                         + "\n" + "               0                                                                     AS t_currencysum4,"
                         + "\n" + "               0                                                                     AS t_currencySum5,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencysum6,"
                         + "\n" + "               0                                                                     AS t_currencysum7,"
                         + "\n" + "               0                                                                     AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                                     AS t_roublesum4,"
                         + "\n" + "               0                                                                     AS t_roubleSum5,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roublesum6,"
                         + "\n" + "               0                                                                     AS t_roublesum7,"
                         + "\n" + "               0                                                                     AS t_roublesum8,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 6"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "         UNION"
                         //евро
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               3                                                                     AS t_order,"
                         + "\n" + "               0                                                                     AS t_currencysum4,"
                         + "\n" + "               0                                                                     AS t_currencySum5,"
                         + "\n" + "               0                                                                     AS t_currencysum6,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencysum7,"
                         + "\n" + "               0                                                                     AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                                     AS t_roublesum4,"
                         + "\n" + "               0                                                                     AS t_roubleSum5,"
                         + "\n" + "               0                                                                     AS t_roublesum6,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roublesum7,"
                         + "\n" + "               0                                                                     AS t_roublesum8,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 7"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "         UNION"
                         //юани
                         + "\n" + "        SELECT df302p2_tmp.t_accountNumber,"
                         + "\n" + "               df302p2_tmp.t_clientCode,"
                         + "\n" + "               df302p2_tmp.t_clientKind,"
                         + "\n" + "               df302p2_tmp.t_contractorId,"
                         + "\n" + "               (SELECT fi.t_fi_code"
                         + "\n" + "                  FROM dfininstr_dbt fi"
                         + "\n" + "                 WHERE fi.t_fiId = df302p2_tmp.t_currencyId"
                         + "\n" + "               )                                                                     AS t_fiCode,"
                         + "\n" + "               df302p2_tmp.t_currencyId,"
                         + "\n" + "               df302p2_tmp.t_column,"
                         + "\n" + "               4                                                                     AS t_order,"
                         + "\n" + "               0                                                                     AS t_currencysum4,"
                         + "\n" + "               0                                                                     AS t_currencySum5,"
                         + "\n" + "               0                                                                     AS t_currencysum6,"
                         + "\n" + "               0                                                                     AS t_currencysum7,"
                         + "\n" + "               df302p2_tmp.t_currencySum                                             AS t_currencysum8,"
                         + "\n" + "               df302p2_tmp.t_recalculateRateDate,"
                         + "\n" + "               0                                                                     AS t_roublesum4,"
                         + "\n" + "               0                                                                     AS t_roubleSum5,"
                         + "\n" + "               0                                                                     AS t_roublesum6,"
                         + "\n" + "               0                                                                     AS t_roublesum7,"
                         + "\n" + "               df302p2_tmp.t_roubleSum                                               AS t_roublesum8,"
                         + "\n" + "               df302p2_tmp.t_shortName,"
                         + "\n" + "               df302p2_tmp.t_sign,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + passiveAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestP,"
                         + "\n" + "               CASE SUBSTR(df302p2_tmp.t_accountNumber,1,5)"
                         + "\n" + "                   WHEN '" + activeAccount + "' THEN drepaccount_vw.t_outcoverrest"
                         + "\n" + "                   ELSE 0"
                         + "\n" + "               END                                                                   AS t_outcoverrestA"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "     LEFT JOIN drepaccount_vw"
                         + "\n" + "            ON drepaccount_vw.t_account = df302p2_tmp.t_accountNumber"
                         + "\n" + "         WHERE df302p2_tmp.t_row IS NOT NULL"
                         + "\n" + "           AND df302p2_tmp.t_column    = 8"
                         + "\n" + "           AND df302p2_tmp.t_okatoCode = '" + Okato + "'"
                         + "\n" + "           AND (   SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + passiveAccount + "'"
                         + "\n" + "                OR SUBSTR(df302p2_tmp.t_accountNumber,1,5) = '" + activeAccount  + "')"
                         + "\n" + "       )"
                         + "\n" + " GROUP BY ROLLUP ("
                         + "\n" + "                  ("
                         + "\n" + "                   t_order,"
                         + "\n" + "                   t_fiCode"
                         + "\n" + "                  ),"
                         + "\n" + "                  ("
                         + "\n" + "                   t_accountNumber,"
                         + "\n" + "                   t_currencyId,"
                         + "\n" + "                   t_column,"
                         + "\n" + "                   t_shortName,"
                         + "\n" + "                   t_clientCode,"
                         + "\n" + "                   t_clientKind,"
                         + "\n" + "                   t_sign"
                         + "\n" + "                  )"
                         + "\n" + "                 )"
                         + "\n" + " ORDER BY t_order, "
                         + "\n" + "          t_fiCode        NULLS LAST,"
                         + "\n" + "          t_accountNumber NULLS LAST"
                         );

        dataSet.setFieldType("t_outcoverrestA", V_MONEY);
        dataSet.setFieldType("t_outcoverrestP", V_MONEY);
        dataSet.setFieldType("t_roubleSum4",    V_MONEY);
        dataSet.setFieldType("t_roubleSum5",    V_MONEY);
        dataSet.setFieldType("t_roubleSum6",    V_MONEY);
        dataSet.setFieldType("t_roubleSum7",    V_MONEY);
        dataSet.setFieldType("t_roubleSum8",    V_MONEY);
        dataSet.setFieldType("t_currencySum4",  V_MONEY);
        dataSet.setFieldType("t_currencySum5",  V_MONEY);
        dataSet.setFieldType("t_currencySum6",  V_MONEY);
        dataSet.setFieldType("t_currencySum7",  V_MONEY);
        dataSet.setFieldType("t_currencySum8",  V_MONEY);

        return dataSet;
    end;

    private macro printHeaderBackOffice()
        if (m_dataSet.backOffice != NULL)
            println(" Наименование бэк-офиса: ", TBackOffice(m_dataSet.backOffice).getFullName());
        end;
    end;

    //печать строк таблицы по корректирующим счетам ГК (без шапки, низа и Итого)
    macro printCorrectAccounts(Okato, passiveAccount, activeAccount) : CorrectCbAccountsSumClass_4637
        var dataSet = getDataSetCorrectAccounts(Okato, passiveAccount, activeAccount);
        var active  = $0;
        var passive = $0;
        var title;
        var column;

        private var currentSum = CorrectCbAccountsSumClass_4637($0, $0, $0, $0, $0);

        while (dataSet.moveNext())
            if   (SubStr(dataSet.accountNumber, 1, 5) == passiveAccount)
                m_reportCb.printStringTransferByWord(dataSet.accountNumber,
                                                     dataSet.fiCode,
                                                     dataSet.t_outcoverrestP,
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     dataSet.t_shortName,
                                                     dataSet.t_clientkind
                                                    );
                passive = passive + dataSet.t_outcoverrestP;
                column  = dataSet.column;
            elif (SubStr(dataSet.accountNumber, 1, 5) == activeAccount)
                m_reportCb.printStringTransferByWord(dataSet.accountNumber,
                                                     dataSet.fiCode,
                                                     "",
                                                     dataSet.t_outcoverrestA,
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     "",
                                                     dataSet.t_shortName,
                                                     dataSet.t_clientkind
                                                    );

                active = active + dataSet.t_outcoverrestA;
                column = dataSet.column;
            elif (    (dataSet.accGrouping    == 1)
                  and (dataSet.fiCodeGrouping == 0))
                if (column == 4)
                    title = "Итого по счетам " + passiveAccount + ", " + activeAccount + " в ин. валюте:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column4 = ternary(passive - active > 0, currentSum.m_column4 + passive - active, currentSum.m_column4 + $0);
                    passive = $0;
                    active  = $0;
                elif (column == 5)
                    title = "Итого по счетам " + passiveAccount + ", " + activeAccount + " в нац. валюте:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column5 = ternary(passive - active > 0, currentSum.m_column5 + passive - active, currentSum.m_column5 + $0);
                    passive = $0;
                    active  = $0;
                elif (column == 6)
                    title = "Итого по счетам " + passiveAccount + ", " + activeAccount + " в долларах США:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column6 = ternary(passive - active > 0, currentSum.m_column6 + passive - active, currentSum.m_column6 + $0);
                    passive = $0;
                    active  = $0;
                elif (column == 7)
                    title = "Итого по счетам " + passiveAccount + ", " + activeAccount + " в евро:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column7 = ternary(passive - active > 0, currentSum.m_column7 + passive - active, currentSum.m_column7 + $0);
                    passive = $0;
                    active  = $0;
                elif (column == 8)
                    title = "Итого по счетам " + passiveAccount + ", " + activeAccount + " в юанях:";
                    m_reportCb.printStringTransferByWord(title,
                                                         "",
                                                         passive,
                                                         active,
                                                         passive - active,
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         "",
                                                         "",
                                                         ternary(passive - active > 0, passive - active, $0),
                                                         "",
                                                         ""
                                                        );
                    currentSum.m_column8 = ternary(passive - active > 0, currentSum.m_column8 + passive - active, currentSum.m_column8 + $0);
                    passive = $0;
                    active  = $0;
                end;
            end;
        end;

        return currentSum;
    end;

    //сумма для графы 4 (для конкретного л/с только одна из сумм будет отлична от нуля)
    macro getTotalSum(otherSum, rurSum, usdSum, eurSum, cnySum)
        if   (rurSum != 0)
            return otherSum + rurSum;
        elif (usdSum != 0)
            return otherSum + usdSum;
        elif (eurSum != 0)
            return otherSum + eurSum;
        elif (cnySum != 0)
            return otherSum + cnySum;
        else
            return otherSum;
        end;
    end;

    macro print()
        var hasData         = false;
        var needRowHeader   = true;
        var needOkatoHeader = true;
        var m_isRetail      = false;

        printHeader();
        printReclculateRateDate();

        while (m_dataSet.moveNext())
            hasData = true;

            if ((m_dataSet.isRow == 1) or (m_dataSet.isBO == 1))
                needRowHeader   = true;
            end;

            if ((needOkatoHeader) and (m_dataSet.OkatoCode != Null))
                printOkatoHeader(m_dataSet.okatoCode);
                needOkatoHeader = false;
            end;

            if ((m_dataSet.isBO == 1) and (m_dataSet.isRow != 1) and (m_dataSet.isOkato != 1))
                m_curreport.printBottom();
                if (m_isRetail == true)
                    [####################                    ################   ###############   ###############   ###############   ###############]
                    ("   Всего по бэкофису", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                                m_dataSet.t_roubleSum5:r, m_dataSet.t_roubleSum6:r, m_dataSet.t_roubleSum7:r, m_dataSet.t_roubleSum8:r);
                else
                    [####################               ################  ################  ################  ################  ################]
                    ("   Всего по бэкофису", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                          m_dataSet.t_roubleSum5:r, m_dataSet.t_roubleSum6:r, m_dataSet.t_roubleSum7:r, m_dataSet.t_roubleSum8:r);
                end;
                continue;
            end;

            if ((m_dataSet.isRow == 1) and (m_dataSet.isOkato != 1))
                //для строк 1 и 1.1 выводим информацию по корректирующим счетам
                if (m_dataSet.row == "1")
                    m_reportCb.printHead();
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40907","40908"));
                    m_reportCb.printStringTransferByWord("Итого:",
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         CorrectCbAccountsSum.m_column4 + CorrectCbAccountsSum.m_column5 + CorrectCbAccountsSum.m_column6 + CorrectCbAccountsSum.m_column7 + CorrectCbAccountsSum.m_column8,
                                                         CorrectCbAccountsSum.m_column5,
                                                         CorrectCbAccountsSum.m_column6,
                                                         CorrectCbAccountsSum.m_column7,
                                                         CorrectCbAccountsSum.m_column8,
                                                         "",
                                                         ""
                                                        );

                    m_reportCb.printBottom();
                    [####################                                                                         ###################  ###################  ###################  ###################  ###################]
                    ("   Всего по строке", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8
                                            + CorrectCbAccountsSum.m_column4 + CorrectCbAccountsSum.m_column5 + CorrectCbAccountsSum.m_column6 + CorrectCbAccountsSum.m_column7 + CorrectCbAccountsSum.m_column8):r,
                                                                          (m_dataSet.t_roubleSum5 + CorrectCbAccountsSum.m_column5):r,
                                                                                            (m_dataSet.t_roubleSum6 + CorrectCbAccountsSum.m_column6):r,
                                                                                                              (m_dataSet.t_roubleSum7 + CorrectCbAccountsSum.m_column7):r,
                                                                                                                                (m_dataSet.t_roubleSum8 + CorrectCbAccountsSum.m_column8):r);
                    CorrectCbAccountsSum = CorrectCbAccountsSumClass_4637(0, 0, 0, 0, 0);
                    continue;
                end;

                if (m_dataSet.row == "1.1")
                    m_reportCb.printHead();
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40108","40109"));
                    CorrectCbAccountsSum.plus(printCorrectAccounts(m_dataSet.okatoCode,"40110","40111"));
                    m_reportCb.printStringTransferByWord("Итого:",
                                                         "",
                                                         "",
                                                         "",
                                                         "",
                                                         CorrectCbAccountsSum.m_column4 + CorrectCbAccountsSum.m_column5 + CorrectCbAccountsSum.m_column6 + CorrectCbAccountsSum.m_column7 + CorrectCbAccountsSum.m_column8,
                                                         CorrectCbAccountsSum.m_column5,
                                                         CorrectCbAccountsSum.m_column6,
                                                         CorrectCbAccountsSum.m_column7,
                                                         CorrectCbAccountsSum.m_column8,
                                                         "",
                                                         ""
                                                        );

                    m_reportCb.printBottom();
                    [####################                                                                         ###################  ###################  ###################  ###################  ###################]
                    ("   Всего по строке", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8
                                            + CorrectCbAccountsSum.m_column4 + CorrectCbAccountsSum.m_column5 + CorrectCbAccountsSum.m_column6 + CorrectCbAccountsSum.m_column7 + CorrectCbAccountsSum.m_column8):r,
                                                                          (m_dataSet.t_roubleSum5 + CorrectCbAccountsSum.m_column5):r,
                                                                                            (m_dataSet.t_roubleSum6 + CorrectCbAccountsSum.m_column6):r,
                                                                                                              (m_dataSet.t_roubleSum7 + CorrectCbAccountsSum.m_column7):r,
                                                                                                                                (m_dataSet.t_roubleSum8 + CorrectCbAccountsSum.m_column8):r);
                    continue;
                end;

                if (m_isRetail == true)
                    [####################                    ################   ###############   ###############   ###############   ###############]
                    ("   Всего по строке", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                                (m_dataSet.t_roubleSum5):r,
                                                                                                  (m_dataSet.t_roubleSum6):r,
                                                                                                                    (m_dataSet.t_roubleSum7):r,
                                                                                                                                      (m_dataSet.t_roubleSum8):r);
                else
                    [####################               ################  ################  ################  ################  ################]
                    ("   Всего по строке", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                          m_dataSet.t_roubleSum5:r, m_dataSet.t_roubleSum6:r, m_dataSet.t_roubleSum7:r, m_dataSet.t_roubleSum8);
                end;

                continue;
            end;

            if (m_dataSet.isOkato == 1)
                if (m_dataSet.OkatoCode != Null)
                    if (m_isRetail == true)
                        [####################                    ################   ###############   ###############   ###############   ###############]
                        ("   Всего по ОКАТО", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                                    m_dataSet.t_roubleSum5:r, m_dataSet.t_roubleSum6:r, m_dataSet.t_roubleSum7:r, m_dataSet.t_roubleSum8);
                    else
                        [####################               ################  ################  ################  ################  ################]
                        ("   Всего по ОКАТО", (m_dataSet.t_roubleSum4 + m_dataSet.t_roubleSum5 + m_dataSet.t_roubleSum6 + m_dataSet.t_roubleSum7 + m_dataSet.t_roubleSum8):r,
                                                                              m_dataSet.t_roubleSum5:r, m_dataSet.t_roubleSum6:r, m_dataSet.t_roubleSum7:r, m_dataSet.t_roubleSum8);
                    end;
                    needOkatoHeader = true;
                end;
                continue;
            end;

            if (needRowHeader)
                if   (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Главная книга")
                    m_curreport = m_reportCbAll;
                    m_isRetail  = false;
                elif (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Депозиты")
                    m_curreport = m_reportLn;
                    m_isRetail  = false;
                elif (TBackOffice(m_dataSet.t_backOffice).getFullName() == "Retail")
                    m_curreport = m_reportRt;
                    m_isRetail  = true;
                else
                    continue;//msgbox("Unknow BackOffice!");
                end;

                if (m_dataSet.isOkato != 1)
                    m_reportCbAll.printFreeString("\n Строка " + m_dataSet.row);
                    printHeaderBackOffice();
                    m_curreport.printHead();
                    needRowHeader = false;
                end;
            end;

            if   (   (m_curreport == m_reportCbAll)
                  or (m_curreport == m_reportLn))
                m_curreport.printStringTransferByWord(m_dataSet.accountNumber,
                                                      m_dataSet.fiCode,
                                                      getTotalSum(m_dataSet.roubleSum4, m_dataSet.roubleSum5, m_dataSet.roubleSum6, m_dataSet.roubleSum7, m_dataSet.roubleSum8),
                                                      ternary(m_dataSet.column == "5", m_dataSet.roubleSum5, ""),
                                                      ternary(m_dataSet.column == "6", m_dataSet.roubleSum6, ""),
                                                      ternary(m_dataSet.column == "7", m_dataSet.roubleSum7, ""),
                                                      ternary(m_dataSet.column == "8", m_dataSet.roubleSum8, ""),
                                                      getContragentName()
                                                     );
            elif (m_curreport == m_reportRt)
                m_curreport.printStringTransferByWord(m_dataSet.accountNumber,
                                                      m_dataSet.fiCode,
                                                      getTotalSum(m_dataSet.roubleSum4, m_dataSet.roubleSum5, m_dataSet.roubleSum6, m_dataSet.roubleSum7, m_dataSet.roubleSum8),
                                                      ternary(m_dataSet.column == "5", m_dataSet.roubleSum5, ""),
                                                      ternary(m_dataSet.column == "6", m_dataSet.roubleSum6, ""),
                                                      ternary(m_dataSet.column == "7", m_dataSet.roubleSum7, ""),
                                                      ternary(m_dataSet.column == "8", m_dataSet.roubleSum8, ""),
                                                      getContragentName(),
                                                      m_dataSet.isPledge
                                                     );
            end;
        end;

        if (not hasData)
            m_report.printFreeString("\n Нет данных по второму разделу.");
        end;
    end;

    private macro initialize()
        m_dataSet.setFieldType("t_recalculateRateDate", V_DATE);
        m_dataSet.setFieldType("t_roubleSum",           V_MONEY);
        m_dataSet.setFieldType("t_currencySum",         V_MONEY);

        m_reportLn.addColumn("Номер договора",                     25, AL_LEFT);
        m_reportLn.addColumn("Ва-|лю-|та",                          3, AL_LEFT);
        m_reportLn.addColumn("Графа 4",                            15, AL_RIGHT);
        m_reportLn.addColumn("Графа 5",                            15, AL_RIGHT);
        m_reportLn.addColumn("Графа 6",                            15, AL_RIGHT);
        m_reportLn.addColumn("Графа 7",                            15, AL_RIGHT);
        m_reportLn.addColumn("Графа 8",                            15, AL_RIGHT);
        m_reportLn.addColumn("Контрагент",                         30, AL_LEFT);

        m_reportRt.addColumn("Номер договора",                     25, AL_LEFT);
        m_reportRt.addColumn("Валюта|договора",                     8, AL_CENTER);
        m_reportRt.addColumn("Графа 4",                            15, AL_RIGHT);
        m_reportRt.addColumn("Графа 5",                            15, AL_RIGHT);
        m_reportRt.addColumn("Графа 6",                            15, AL_RIGHT);
        m_reportRt.addColumn("Графа 7",                            15, AL_RIGHT);
        m_reportRt.addColumn("Графа 8",                            15, AL_RIGHT);
        m_reportRt.addColumn("Контрагент",                         40, AL_LEFT);
        m_reportRt.addColumn("Залог|за|ключ",                       3, AL_CENTER);

        m_reportCb.addColumn("Номер л/с",                          25, AL_LEFT);
        m_reportCb.addColumn("Ва-|лю-|та",                          3, AL_LEFT);
        m_reportCb.addColumn("Остаток счета (П)",                  15, AL_RIGHT);
        m_reportCb.addColumn("Остаток счета (А)",                  15, AL_RIGHT);
        m_reportCb.addColumn("П - А",                              15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 4)", 15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 5)", 15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 6)", 15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 7)", 15, AL_RIGHT);
        m_reportCb.addColumn("Сумма, вошедшая|в расчет (графа 8)", 15, AL_RIGHT);
        m_reportCb.addColumn("Контрагент",                         40, AL_LEFT);
        m_reportCb.addColumn("",                                    1, AL_LEFT);

        m_reportCbAll.addColumn("Номер л/с",                       25, AL_LEFT);
        m_reportCbAll.addColumn("Ва-|лю-|та",                       3, AL_LEFT);
        m_reportCbAll.addColumn("Графа 4",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Графа 5",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Графа 6",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Графа 7",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Графа 8",                         15, AL_RIGHT);
        m_reportCbAll.addColumn("Контрагент",                      40, AL_LEFT);
    end;

    private macro constructor()
        initTPart2Protocol3129();

        CorrectCbAccountsSum = CorrectCbAccountsSumClass_4637(0, 0, 0, 0, 0);
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класс печати протокола расчета
 **************************************************************************************************/
private class (TProtocolView) TProtocolPrinter(part1Protocol : Object, part2Protocol : Object)
    initTProtocolView("ПРОТОКОЛ РАСЧЕТА ФОРМЫ 302");

    private var m_part1Protocol = part1Protocol;
    private var m_part2Protocol = part2Protocol;

    macro view()
        viewFileLog(m_fileName);
    end;

    macro print()
        setProtocolOutput();

        m_part1Protocol.print();
        m_part2Protocol.print();

        resetProtocolOutput();
    end;
end;

/***************************************************************************************************
 *  Базовый клас расчета отчета
 **************************************************************************************************/
private class TCalculator(attributeId : String, filter : Object)
    private var m_report         = RcbApplication.currentReport;
    private var m_attributeValue = m_report.attributeValue(attributeId);
    private var m_filter         = filter;
    private var m_structure      = m_attributeValue.attribute.structure;

    private macro writeOkato(compositeValue : Object, dataSet : Object)
        compositeValue.fieldValue("okatoCode").exact = String(dataSet.okatoCode);
    end;

    private macro writeOkatoAndRow(compositeValue : Object, dataSet : Object)
        writeOkato(compositeValue, dataSet);
        compositeValue.fieldValue("row").exact = String(dataSet.row);
    end;

    private macro initializeCompositeValue(compositeValue : Object)
        var iterator    = m_structure.createFieldIterator();
        var currentItem = NULL;

        iterator.moveFirst();
        while (not iterator.isDone())
            currentItem = iterator.currentItem;
            if (currentItem.type() == RCB_VT_STRING)
                compositeValue.fieldValue(currentItem.id).exact = "";
            elif (currentItem.type() == RCB_VT_ITEM)
                compositeValue.fieldValue(currentItem.id).exact = 0;
            elif (in(currentItem.type(), RCB_VT_PERCENT, RCB_VT_NUMBER))
                compositeValue.fieldValue(currentItem.id).exact = 0.0;
            elif (currentItem.type() == RCB_VT_MONEY)
                compositeValue.fieldValue(currentItem.id).exact = $0.0;
            end;

            iterator.moveNext();
        end;
    end;

    macro execute()
        msgBox("Ошибка! Вызов чисто виртуального метода");
    end;
end;

/***************************************************************************************************
 *  Клас расчета первого раздела
 **************************************************************************************************/
private class (TCalculator) TPart1Calculator(filter : Object)
    private macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("roubleSum").setUndefined;
            compositeValue.fieldValue("roubleSum").exact                = dataSet.roubleSum;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("currencySum").setUndefined;
            compositeValue.fieldValue("currencySum").exact              = dataSet.roubleSum;
        elif (dataSet.column == "6")
            compositeValue.fieldValue("roubleDebt").setUndefined;
            compositeValue.fieldValue("roubleDebt").exact               = dataSet.roubleSum;
        elif (dataSet.column == "7")
            compositeValue.fieldValue("currencyDebt").setUndefined;
            compositeValue.fieldValue("currencyDebt").exact             = dataSet.roubleSum;
        elif (dataSet.column == "8")
            compositeValue.fieldValue("roubleDelayedDebt").setUndefined;
            compositeValue.fieldValue("roubleDelayedDebt").exact        = dataSet.roubleSum;
        elif (dataSet.column == "9")
            compositeValue.fieldValue("currencyDelayedDebt").setUndefined;
            compositeValue.fieldValue("currencyDelayedDebt").exact      = dataSet.roubleSum;
        elif ((dataSet.column == "10") and in(dataSet.row, "4.1", "4.1.1"))
            compositeValue.fieldValue("roubleAveragePeriod").setUndefined;
            compositeValue.fieldValue("roubleAveragePeriod").exact      = Double(dataSet.roubleSum);
        elif ((dataSet.column == "11") and in(dataSet.row, "4.1", "4.1.1"))
            compositeValue.fieldValue("currencyAveragePeriod").setUndefined;
            compositeValue.fieldValue("currencyAveragePeriod").exact    = Double(dataSet.roubleSum);
        elif ((dataSet.column == "12") and in(dataSet.row, "4.1", "4.1.1"))
            compositeValue.fieldValue("rubAverageInterestRate").setUndefined;
            compositeValue.fieldValue("rubAverageInterestRate").exact   = Double(dataSet.roubleSum);
        elif ((dataSet.column == "13") and in(dataSet.row, "4.1", "4.1.1"))
            compositeValue.fieldValue("curAverageInterestRate").setUndefined;
            compositeValue.fieldValue("curAverageInterestRate").exact   = Double(dataSet.roubleSum);
        end;
    end;

    class TFilter()
        macro isSuitable(v : Object)
            return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.2", "2.3", "2.4", "2.5", "2.6", "2.7", "2.8", "2.9", "2.10", "4.1", "4.1.1");
        end;
    end;

    macro execute()
        var dataSet = TRsbDataSet("SELECT   t_okatoCode, t_row, t_column, SUM(t_roubleSum) t_roubleSum"
            + "\n" +              "    FROM (SELECT   t_okatoCode, t_row, t_column, SUM(t_roubleSum) t_roubleSum"
            + "\n" +              "              FROM df302p1_tmp"
            + "\n" +              "             WHERE NOT (    t_row IN ('4.1', '4.1.1')"
            + "\n" +              "                        AND t_column IN ('10', '11', '12', '13'))"
            + "\n" +              "          GROUP BY t_okatoCode, t_row, t_column"
            + "\n" +              "          UNION"
            + "\n" +              "          SELECT   t_okatoCode, '2', t_column, SUM(t_roubleSum) t_roubleSum"
            + "\n" +              "              FROM df302p1_tmp"
            + "\n" +              "             WHERE t_row IN ('2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7', '2.8', '2.9', '2.10')"
            + "\n" +              "          GROUP BY t_okatoCode, t_row, t_column"
            + "\n" +              "          UNION"
            + "\n" +              "          SELECT   t_okatoCode, t_row, t_column,"
            + "\n" +              "                    CASE"
            + "\n" +              "                        WHEN (SUM(ROUND(t_roubleSum / 1000)) = 0)"
            + "\n" +              "                            THEN 0"
            + "\n" +              "                        WHEN (t_column = '10' OR t_column = '11')"
            + "\n" +              "                            THEN SUM(ROUND(t_roubleSum / " + m_report.multiplier + ") * t_term)/SUM(ROUND(t_roubleSum / " + m_report.multiplier + "))"
            + "\n" +              "                        ELSE"
            + "\n" +              "                            SUM(ROUND(t_roubleSum / " + m_report.multiplier + ") * t_initialInterestRate)/SUM(ROUND(t_roubleSum / " + m_report.multiplier + "))"
            + "\n" +              "                   END t_roubleSum"
            + "\n" +              "              FROM df302p1_tmp"
            + "\n" +              "             WHERE t_row IN ('4.1', '4.1.1')"
            + "\n" +              "               AND t_column IN ('10', '11', '12', '13')"
            + "\n" +              "          GROUP BY t_okatoCode, t_row, t_column)"
            + "\n" +              "GROUP BY t_okatoCode, t_row, t_column"
            + "\n" +              "ORDER BY t_okatoCode, t_row, t_column");
        dataSet.setFieldType("t_roubleSum", V_MONEY);

        var currentOkato        = "";
        var currentRow          = "";
        var okatoCompositeValue = NULL;
        var rowCompositeValue   = NULL;
        var row1CompositeValue  = m_attributeValue.addValue();
        var isEmpty             = true;
        while (dataSet.moveNext())
            if (dataSet.okatoCode != currentOkato)
                okatoCompositeValue = row1CompositeValue.addValue();
                currentOkato        = dataSet.okatoCode;
                currentRow          = "";
                initializeCompositeValue(okatoCompositeValue);
                writeOkato(okatoCompositeValue, dataSet);
                isEmpty = false;
            end;

            if (dataSet.row != currentRow)
                rowCompositeValue = okatoCompositeValue.addValue();
                currentRow        = dataSet.row;
                initializeCompositeValue(rowCompositeValue);
                writeOkatoAndRow(rowCompositeValue, dataSet);
            end;

            processRow(rowCompositeValue, dataSet);
        end;

        if (not isEmpty)
            initializeCompositeValue(row1CompositeValue);
            row1CompositeValue.summarizeDependentValues(RCB_SU_EXACT, TFilter());
            row1CompositeValue.fieldValue("row").exact = "1";
            RcbApplication().TransactionManager().commit();
        else
            RcbApplication().TransactionManager().rollback();
        end;
    end;

    if(filter == NULL)
        initTCalculator("Раздел1", TFilter());
    else
        initTCalculator("Раздел1", filter);
    end;
end;

/***************************************************************************************************
 *  Клас расчета первого раздела после 2055У
 **************************************************************************************************/
private class (TPart1Calculator) TPart1Calculator2055()
    macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("roubleSum").setUndefined;
            compositeValue.fieldValue("roubleSum").exact                = dataSet.roubleSum;
            compositeValue.fieldValue("roubleSum").scaled               = dataSet.t_roublesumscaled;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("currencySum").setUndefined;
            compositeValue.fieldValue("currencySum").exact              = dataSet.roubleSum;
            compositeValue.fieldValue("currencySum").scaled             = dataSet.t_roublesumscaled;
        elif (dataSet.column == "6")
            compositeValue.fieldValue("roubleDebt").setUndefined;
            compositeValue.fieldValue("roubleDebt").exact               = dataSet.roubleSum;
            compositeValue.fieldValue("roubleDebt").scaled              = dataSet.t_roublesumscaled;
        elif (dataSet.column == "7")
            compositeValue.fieldValue("currencyDebt").setUndefined;
            compositeValue.fieldValue("currencyDebt").exact             = dataSet.roubleSum;
            compositeValue.fieldValue("currencyDebt").scaled            = dataSet.t_roublesumscaled;
        elif (dataSet.column == "8")
            compositeValue.fieldValue("roubleDelayedDebt").setUndefined;
            compositeValue.fieldValue("roubleDelayedDebt").exact        = dataSet.roubleSum;
            compositeValue.fieldValue("roubleDelayedDebt").scaled       = dataSet.t_roublesumscaled;
        elif (dataSet.column == "9")
            compositeValue.fieldValue("currencyDelayedDebt").setUndefined;
            compositeValue.fieldValue("currencyDelayedDebt").exact      = dataSet.roubleSum;
            compositeValue.fieldValue("currencyDelayedDebt").scaled     = dataSet.t_roublesumscaled;
        end;
    end;

    class TFilter2055()
        macro isSuitable(v : Object)
            return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.3", "2.1.4", "2.1.5", "2.1.6", "2.1.7", "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1")
                   and (subStr(v.fieldValue("okatoCode").exact,3,3) == "000");
        end;
    end;


    macro execute()
        var dataSet = TRsbDataSet("WITH data1 AS"
                        + "\n" +       "(SELECT   t_okatocode, t_row, t_column, SUM (t_roublesum) t_roublesum, ROUND(SUM (t_roublesum)/1000) AS t_roublesumscaled"
                        + "\n" +            "FROM (SELECT DISTINCT *"
                        + "\n" +                    "FROM df302p1_tmp"
                        + "\n" +                   "WHERE t_okatocode <> '99999')"
                        + "\n" +        "GROUP BY t_okatocode, t_row, t_column"
                        + "\n" +        "UNION"
                        + "\n" +        "SELECT   t_okatocode, '2.1', t_column, SUM (t_roublesum) t_roublesum, SUM (t_roublesumscaled) AS t_roublesumscaled"
                        + "\n" +            "FROM (SELECT t_okatocode, t_row, t_column, SUM (t_roublesum) AS t_roublesum, ROUND(SUM (t_roublesum)/1000) AS t_roublesumscaled"
                        + "\n" +                    "FROM (SELECT DISTINCT *"
                        + "\n" +                            "FROM df302p1_tmp"
                        + "\n" +                   "WHERE t_okatocode <> '99999')"
                        + "\n" +                "GROUP BY t_okatocode, t_row, t_column)"
                        + "\n" +           "WHERE t_row LIKE '2.1.%' AND length(t_row) = 5"
                        + "\n" +        "GROUP BY t_okatocode, t_column)"
                        + "\n" +  "SELECT   t_okatocode, t_row, t_column, t_roublesum, t_roublesumscaled"
                        + "\n" +      "FROM (SELECT   t_okatocode, '2' AS t_row, t_column, SUM (t_roublesum) t_roublesum, SUM (t_roublesumscaled) AS t_roublesumscaled"
                        + "\n" +                "FROM data1"
                        + "\n" +               "WHERE t_row IN ('2.1', '2.2')"
                        + "\n" +            "GROUP BY t_okatocode, t_column"
                        + "\n" +            "UNION"
                        + "\n" +            "SELECT   t_okatocode, t_row, t_column, t_roublesum, t_roublesumscaled"
                        + "\n" +                "FROM data1)"
                        + "\n" +  "ORDER BY t_okatocode, t_row, t_column");
        dataSet.setFieldType("t_roubleSum", V_MONEY);

        var currentOkato        = "";
        var currentRow          = "";
        var okatoCompositeValue = NULL;
        var rowCompositeValue   = NULL;
        var row1CompositeValue  = m_attributeValue.addValue();
        var isEmpty             = true;

        while (dataSet.moveNext())
            if (dataSet.okatoCode != currentOkato)
                okatoCompositeValue = row1CompositeValue.addValue();
                currentOkato        = dataSet.okatoCode;
                currentRow          = "";
                initializeCompositeValue(okatoCompositeValue);
                writeOkato(okatoCompositeValue, dataSet);
                isEmpty = false;
            end;

            if (dataSet.row != currentRow)
                rowCompositeValue = okatoCompositeValue.addValue();
                currentRow        = dataSet.row;
                initializeCompositeValue(rowCompositeValue);
                writeOkatoAndRow(rowCompositeValue, dataSet);
            end;

            processRow(rowCompositeValue, dataSet);
        end;

        if (not isEmpty)
            initializeCompositeValue(row1CompositeValue);
            row1CompositeValue.summarizeDependentValues(RCB_SU_SCALED, m_filter);
            row1CompositeValue.fieldValue("row").exact = "1";
            RcbApplication().TransactionManager().commit();
        else
            RcbApplication().TransactionManager().rollback();
        end;
    end;

    initTPart1Calculator(TFilter2055());
end;

/***************************************************************************************************
 *  Клас расчета первого раздела после 2183У
 **************************************************************************************************/
private class (TPart1Calculator2055) TPart1Calculator2183()

    class TFilter2183()
        macro isSuitable(v : Object)
            return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.2.1", "2.1.2.2", "2.1.2.3","2.1.2.4",
                                                     "2.1.2.5", "2.1.2.6", "2.1.2.7", "2.1.2.8", "2.1.2.8.1", "2.1.2.9", "2.1.2.9.1",
                                                     "2.1.3", "2.1.4", "2.1.4.1", "2.1.5", "2.1.5.1", "2.1.6", "2.1.6.1", "2.1.7",
                                                     "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1")
                   and (subStr(v.fieldValue("okatoCode").exact,3,3) == "000");
        end;
    end;

    macro summarizeAOValues(compositeValue)

        class TAoFilter2183()
            macro isSuitable(v : Object)
                return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.2.1", "2.1.2.2", "2.1.2.3","2.1.2.4",
                                                         "2.1.2.5", "2.1.2.6", "2.1.2.7", "2.1.2.8", "2.1.2.8.1", "2.1.2.9", "2.1.2.9.1",
                                                         "2.1.3", "2.1.4", "2.1.4.1", "2.1.5", "2.1.5.1", "2.1.6", "2.1.6.1", "2.1.7",
                                                         "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1");
            end;
        end;

        var iterator = compositeValue.createValueIterator();
        var aoHead = null;
        var filter = TAoFilter2183();

        iterator.moveFirst();
        while (not iterator.isDone())
            aoHead = iterator.currentItem;
            if (subStr(aoHead.fieldValue("okatoCode").exact,3,3) != "000")
                aoHead.summarizeDependentValues(RCB_SU_SCALED, filter);
            end;
            iterator.moveNext();
        end;
    end;

    macro execute()
        var dataSet = TRsbDataSet("WITH data1 AS"
                        + "\n" +       "(SELECT   t_okatocode, t_row, t_column, SUM (t_roublesum) t_roublesum, ROUND(SUM (t_roublesum)/1000) AS t_roublesumscaled"
                        + "\n" +            "FROM (SELECT DISTINCT *"
                        + "\n" +                    "FROM df302p1_tmp"
                        + "\n" +                   "WHERE t_okatocode <> '99999')"
                        + "\n" +        "GROUP BY t_okatocode, t_row, t_column"
                        + "\n" +        "UNION"
                        + "\n" +        "SELECT   t_okatocode, '2.1', t_column, SUM (t_roublesum) t_roublesum, SUM (t_roublesumscaled) AS t_roublesumscaled"
                        + "\n" +            "FROM (SELECT t_okatocode, t_row, t_column, SUM (t_roublesum) AS t_roublesum, ROUND(SUM (t_roublesum)/1000) AS t_roublesumscaled"
                        + "\n" +                    "FROM (SELECT DISTINCT *"
                        + "\n" +                            "FROM df302p1_tmp"
                        + "\n" +                   "WHERE t_okatocode <> '99999')"
                        + "\n" +                "GROUP BY t_okatocode, t_row, t_column)"
                        + "\n" +           "WHERE t_row LIKE '2.1.%' AND length(t_row) = 5"
                        + "\n" +        "GROUP BY t_okatocode, t_column)"
                        + "\n" +  "SELECT   t_okatocode, t_row, t_column, t_roublesum, t_roublesumscaled"
                        + "\n" +      "FROM (SELECT   t_okatocode, '2' AS t_row, t_column, SUM (t_roublesum) t_roublesum, SUM (t_roublesumscaled) AS t_roublesumscaled"
                        + "\n" +                "FROM data1"
                        + "\n" +               "WHERE t_row IN ('2.1', '2.2')"
                        + "\n" +            "GROUP BY t_okatocode, t_column"
                        + "\n" +            "UNION"
                        + "\n" +            "SELECT   t_okatocode, t_row, t_column, t_roublesum, t_roublesumscaled"
                        + "\n" +                "FROM data1)"
                        + "\n" +  "ORDER BY t_okatocode, t_row, t_column");
        dataSet.setFieldType("t_roubleSum", V_MONEY);

        var currentOkato        = "";
        var currentRow          = "";
        var okatoCompositeValue = NULL;
        var rowCompositeValue   = NULL;
        var row1CompositeValue  = m_attributeValue.addValue();
        var isEmpty             = true;

        while (dataSet.moveNext())
            if (dataSet.okatoCode != currentOkato)
                okatoCompositeValue = row1CompositeValue.addValue();
                currentOkato        = dataSet.okatoCode;
                currentRow          = "";
                initializeCompositeValue(okatoCompositeValue);
                writeOkato(okatoCompositeValue, dataSet);
                isEmpty = false;
            end;

            if (dataSet.row != currentRow)
                rowCompositeValue = okatoCompositeValue.addValue();
                currentRow        = dataSet.row;
                initializeCompositeValue(rowCompositeValue);
                writeOkatoAndRow(rowCompositeValue, dataSet);
            end;

            processRow(rowCompositeValue, dataSet);
        end;

        if (not isEmpty)
            initializeCompositeValue(row1CompositeValue);
            row1CompositeValue.summarizeDependentValues(RCB_SU_SCALED, m_filter);
            summarizeAOValues(row1CompositeValue);
            row1CompositeValue.fieldValue("row").exact = "1";
            RcbApplication().TransactionManager().commit();
        else
            RcbApplication().TransactionManager().rollback();
        end;
    end;

    initTPart1Calculator(TFilter2183());
end;

/***************************************************************************************************
 *  Клас расчета первого раздела после 2627-У
 **************************************************************************************************/
private class (TPart1Calculator2183) TPart1Calculator2627()

    class TFilter2627()
        macro isSuitable(v : Object)
            return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.2.1", "2.1.2.2", "2.1.2.3","2.1.2.4",
                                                     "2.1.2.5", "2.1.2.6", "2.1.2.7", "2.1.2.8", "2.1.2.8.1", "2.1.2.9", "2.1.2.9.1",
                                                     "2.1.3", "2.1.4", "2.1.4.1", "2.1.5", "2.1.5.1", "2.1.6", "2.1.6.1", "2.1.7",
                                                     "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1", "4")
                   and (subStr(v.fieldValue("okatoCode").exact,3,3) == "000");
        end;
    end;

    macro summarizeAOValues(compositeValue)

        class TAoFilter2627()
            macro isSuitable(v : Object)
                return not in(v.fieldValue("row").exact, "2.1", "2.1.1", "2.1.1.1", "2.1.2", "2.1.2.1", "2.1.2.2", "2.1.2.3","2.1.2.4",
                                                         "2.1.2.5", "2.1.2.6", "2.1.2.7", "2.1.2.8", "2.1.2.8.1", "2.1.2.9", "2.1.2.9.1",
                                                         "2.1.3", "2.1.4", "2.1.4.1", "2.1.5", "2.1.5.1", "2.1.6", "2.1.6.1", "2.1.7",
                                                         "2.1.8", "2.1.9", "2.2", "2.3", "2.3.1", "4");
            end;
        end;

        var iterator = compositeValue.createValueIterator();
        var aoHead = null;
        var filter = TAoFilter2627();

        iterator.moveFirst();
        while (not iterator.isDone())
            aoHead = iterator.currentItem;

            if (subStr(aoHead.fieldValue("okatoCode").exact,3,3) != "000")
                aoHead.summarizeDependentValues(RCB_SU_SCALED, filter);
            end;
            iterator.moveNext();
        end;
    end;

    macro execute()
        var dataSet = TRsbDataSet("WITH data1 AS"
                         + "\n" + "("
                         + "\n" + " SELECT t_okatocode,"
                         + "\n" + "        t_row,"
                         + "\n" + "        t_column,"
                         + "\n" + "        SUM(t_roublesum)             AS t_roublesum,"
                         + "\n" + "        ROUND(SUM(t_roublesum)/1000) AS t_roublesumscaled"
                         + "\n" + "   FROM (SELECT DISTINCT *"
                         + "\n" + "           FROM df302p1_tmp"
                         + "\n" + "          WHERE t_okatocode <> '99999'"
                         + "\n" + "            AND t_documentId IS NULL AND t_row NOT IN ('2.1', '2.1.1', '2.1.2')"
                         + "\n" + "        )"
                         + "\n" + "  GROUP BY t_okatocode,"
                         + "\n" + "           t_row,"
                         + "\n" + "           t_column"
                         + "\n" + "  UNION"
                         + "\n" + " SELECT t_okatocode,"
                         + "\n" + "        '2.1.1',"
                         + "\n" + "        t_column,"
                         + "\n" + "        SUM(t_roublesum)       AS t_roublesum,"
                         + "\n" + "        SUM(t_roublesumscaled) AS t_roublesumscaled"
                         + "\n" + "   FROM (SELECT t_okatocode,"
                         + "\n" + "                t_row,"
                         + "\n" + "                t_column,"
                         + "\n" + "                SUM(t_roublesum)             AS t_roublesum,"
                         + "\n" + "                ROUND(SUM(t_roublesum)/1000) AS t_roublesumscaled"
                         + "\n" + "           FROM (SELECT DISTINCT *"
                         + "\n" + "                   FROM df302p1_tmp"
                         + "\n" + "                  WHERE t_okatocode <> '99999'"
                         + "\n" + "                    AND t_documentId IS NULL"
                         + "\n" + "                )"
                         + "\n" + "          GROUP BY t_okatocode,"
                         + "\n" + "                   t_row,"
                         + "\n" + "                   t_column"
                         + "\n" + "        )"
                         + "\n" + "  WHERE t_row LIKE '2.1.1.%'"
                         + "\n" + "    AND length(t_row) = 7"
                         + "\n" + "  GROUP BY t_okatocode,"
                         + "\n" + "           t_column"
                         + "\n" + "  UNION"
                         + "\n" + " SELECT t_okatocode,"
                         + "\n" + "        '2.1.2',"
                         + "\n" + "        t_column,"
                         + "\n" + "        SUM(t_roublesum)       AS t_roublesum,"
                         + "\n" + "        SUM(t_roublesumscaled) AS t_roublesumscaled"
                         + "\n" + "   FROM (SELECT t_okatocode,"
                         + "\n" + "                t_row,"
                         + "\n" + "                t_column,"
                         + "\n" + "                SUM(t_roublesum)             AS t_roublesum,"
                         + "\n" + "                ROUND(SUM(t_roublesum)/1000) AS t_roublesumscaled"
                         + "\n" + "           FROM (SELECT DISTINCT *"
                         + "\n" + "                   FROM df302p1_tmp"
                         + "\n" + "                  WHERE t_okatocode <> '99999'"
                         + "\n" + "                    AND t_documentId IS NULL"
                         + "\n" + "                )"
                         + "\n" + "          GROUP BY t_okatocode,"
                         + "\n" + "                   t_row,"
                         + "\n" + "                   t_column"
                         + "\n" + "        )"
                         + "\n" + "  WHERE t_row LIKE '2.1.2.%'"
                         + "\n" + "    AND length(t_row) = 7"
                         + "\n" + "  GROUP BY t_okatocode,"
                         + "\n" + "           t_column"
                         + "\n" + ")"
                         + "\n" + "SELECT t_okatocode,"
                         + "\n" + "       t_row,"
                         + "\n" + "       t_column,"
                         + "\n" + "       t_roublesum,"
                         + "\n" + "       t_roublesumscaled"
                         + "\n" + "  FROM (SELECT t_okatocode,"
                         + "\n" + "               '2'                    AS t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               SUM(t_roublesum)       AS t_roublesum,"
                         + "\n" + "               SUM(t_roublesumscaled) AS t_roublesumscaled"
                         + "\n" + "          FROM data1"
                         + "\n" + "         WHERE (data1.t_row LIKE '2.1.%' and length(data1.t_row) = 5) or data1.t_row = '2.2'"
                         + "\n" + "         GROUP BY t_okatocode,"
                         + "\n" + "                  t_column"
                         + "\n" + "        UNION"
                         + "\n" + "        SELECT t_okatocode,"
                         + "\n" + "               '2.1'                    AS t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               SUM(t_roublesum)       AS t_roublesum,"
                         + "\n" + "               SUM(t_roublesumscaled) AS t_roublesumscaled"
                         + "\n" + "          FROM data1"
                         + "\n" + "         WHERE data1.t_row LIKE '2.1.%' and length(data1.t_row) = 5"
                         + "\n" + "         GROUP BY t_okatocode,"
                         + "\n" + "                  t_column"
                         + "\n" + "        UNION"
                         + "\n" + "        SELECT t_okatocode,"
                         + "\n" + "               t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               t_roublesum,"
                         + "\n" + "               t_roublesumscaled"
                         + "\n" + "          FROM data1"
                         + "\n" + "       )"
                         + "\n" + " ORDER BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column"
                                 );

        dataSet.setFieldType("t_roubleSum", V_MONEY);

        var currentOkato        = "";
        var currentRow          = "";
        var okatoCompositeValue = NULL;
        var rowCompositeValue   = NULL;
        var row1CompositeValue  = m_attributeValue.addValue();
        var isEmpty             = true;

        while (dataSet.moveNext())
            if (dataSet.okatoCode != currentOkato)
                okatoCompositeValue = row1CompositeValue.addValue();
                currentOkato        = dataSet.okatoCode;
                currentRow          = "";
                initializeCompositeValue(okatoCompositeValue);
                writeOkato(okatoCompositeValue, dataSet);
                isEmpty = false;
            end;

            if (dataSet.row != currentRow)
                rowCompositeValue = okatoCompositeValue.addValue();
                currentRow        = dataSet.row;
                initializeCompositeValue(rowCompositeValue);
                writeOkatoAndRow(rowCompositeValue, dataSet);
            end;

            processRow(rowCompositeValue, dataSet);
        end;

        if (not isEmpty)
            initializeCompositeValue(row1CompositeValue);
            row1CompositeValue.summarizeDependentValues(RCB_SU_SCALED, m_filter);
            summarizeAOValues(row1CompositeValue);
            row1CompositeValue.fieldValue("row").exact = "1";
            RcbApplication().TransactionManager().commit();
        else
            RcbApplication().TransactionManager().rollback();
        end;
    end;

    initTPart1Calculator(TFilter2627());
end;

/***************************************************************************************************
 *  Клас расчета второго раздела
 **************************************************************************************************/
private class (TCalculator) TPart2Calculator()
    private macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("roubleObtainedFundsSum").setUndefined;
            compositeValue.fieldValue("roubleObtainedFundsSum").exact    = dataSet.roubleSum;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("currencyObtainedFundsSum").setUndefined;
            compositeValue.fieldValue("currencyObtainedFundsSum").exact  = dataSet.roubleSum;
        elif (dataSet.column == "6")
            compositeValue.fieldValue("rubObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("rubObtainedFundsRest").exact   = dataSet.roubleSum;
        elif (dataSet.column == "7")
            compositeValue.fieldValue("curObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("curObtainedFundsRest").exact = dataSet.roubleSum;
        end;
    end;

    private macro writeOkatoAndRowAndBackOffice(compositeValue : Object, dataSet : Object)
        compositeValue.fieldValue("backOffice").exact = TBackOffice(dataSet.backOffice).getName();
    end;

    class TFilter()
        macro isSuitable(v : Object)
            return true;
        end;
    end;

    private macro getDataSet()
        var dataSet = TRsbDataSet("SELECT   t_okatoCode, t_row, t_column, SUM(t_roubleSum) t_roubleSum, t_backOffice"
            + "\n" +              "    FROM df302p2_tmp"
            + "\n" +              "GROUP BY t_okatoCode, t_row, t_column, t_backOffice"
            + "\n" +              "ORDER BY t_okatoCode, t_row, t_column, t_backOffice");
        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    macro execute()
        var dataSet = getDataSet();

        var currentOkato              = "";
        var currentRow                = "";
        var currentBackOffice         = "";
        var okatoCompositeValue       = NULL;
        var rowCompositeValue         = NULL;
        var backOfficeCompositeValue  = NULL;
        var isEmpty                   = true;

        while (dataSet.moveNext())
            if (dataSet.okatoCode != currentOkato)
                okatoCompositeValue = m_attributeValue.addValue();
                currentOkato        = dataSet.okatoCode;
                currentRow          = "";
                currentBackOffice   = "";
                initializeCompositeValue(okatoCompositeValue);
                writeOkato(okatoCompositeValue, dataSet);
                isEmpty = false;
            end;

            if (dataSet.row != currentRow)
                rowCompositeValue = okatoCompositeValue.addValue();
                currentRow        = dataSet.row;
                currentBackOffice = "";
                initializeCompositeValue(rowCompositeValue);
                writeOkatoAndRow(rowCompositeValue, dataSet);
            end;

            if (dataSet.backOffice != currentBackOffice)
                backOfficeCompositeValue = rowCompositeValue.addValue();
                currentBackOffice        = dataSet.backOffice;
                initializeCompositeValue(backOfficeCompositeValue);
                writeOkatoAndRowAndBackOffice(backOfficeCompositeValue, dataSet);
            end;

            processRow(backOfficeCompositeValue, dataSet);
        end;

        if (not isEmpty)
            initializeCompositeValue(m_attributeValue);
            m_attributeValue.summarizeDependentValues(RCB_SU_EXACT, TFilter());
            RcbApplication().TransactionManager().commit();
        else
            RcbApplication().TransactionManager().rollback();
        end;
    end;

    initTCalculator("Раздел2", TFilter());
end;

/***************************************************************************************************
 *  Клас расчета второго раздела после 1948У
 **************************************************************************************************/
private class (TPart2Calculator) TPart2Calculator1948()

    private macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("rubObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("rubObtainedFundsRest").exact   = dataSet.roubleSum;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("curObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("curObtainedFundsRest").exact = dataSet.roubleSum;
        end;
    end;

    private macro getDataSet()
        var dataSet = TRsbDataSet("SELECT   t_okatoCode, t_row, t_column, SUM(DECODE(t_sign, '-', -1, 1) * NVL(t_roubleSum, 0)) t_roubleSum, t_backOffice"
            + "\n" +              "    FROM df302p2_tmp"
            + "\n" +              "GROUP BY t_okatoCode, t_row, t_column, t_backOffice"
            + "\n" +              "ORDER BY t_okatoCode, t_row, t_column, t_backOffice");
        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator();
end;

/***************************************************************************************************
 *  Клас расчета второго раздела после 2055У
 **************************************************************************************************/
private class (TPart2Calculator) TPart2Calculator2055()
    private macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("rubObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("rubObtainedFundsRest").exact   = dataSet.roubleSum;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("curObtainedFundsRest").setUndefined;
            compositeValue.fieldValue("curObtainedFundsRest").exact = dataSet.roubleSum;
        end;
    end;
    private macro getDataSet()
        macro P_(account_1, account_2, n, column)
            var dataSet = "(SUM"
            + "\n" +          "(CASE"
            + "\n" +              "WHEN t_accountnumber LIKE '" + account_1 + "%'"
            + "\n" +              "AND t_column = '" + column + "'"
            + "\n" +                 "THEN t_roublesum"
            + "\n" +              "WHEN t_accountnumber LIKE '" + account_2 + "%'"
            + "\n" +              "AND t_column = '" + column + "'"
            + "\n" +                 "THEN -t_roublesum"
            + "\n" +              "ELSE 0"
            + "\n" +           "END"
            + "\n" +          ")"
            + "\n" +      ") AS p" + n;
            return dataSet;
        end;
        var dataSet = TRsbDataSet("WITH column_ AS"
                    + "\n" +           "(SELECT (  DECODE (SIGN (p1), 1, p1, 0)"
                    + "\n" +                    "+ DECODE (SIGN (p2), 1, p2, 0)"
                    + "\n" +                    "+ DECODE (SIGN (p3), 1, p3, 0)"
                    + "\n" +                   ") AS t_4,"
                    + "\n" +                   "(  DECODE (SIGN (p4), 1, p4, 0)"
                    + "\n" +                    "+ DECODE (SIGN (p5), 1, p5, 0)"
                    + "\n" +                    "+ DECODE (SIGN (p6), 1, p6, 0)"
                    + "\n" +                   ") AS t_5"
                    + "\n" +              "FROM (SELECT "
                    + "\n" +                            P_(40108,40109,1,4) + ","
                    + "\n" +                            P_(40110,40111,2,4) + ","
                    + "\n" +                            P_(40907,40908,3,4) + ","
                    + "\n" +                            P_(40108,40109,4,5) + ","
                    + "\n" +                            P_(40110,40111,5,5) + ","
                    + "\n" +                            P_(40907,40908,6,5)
                    + "\n" +                      "FROM df302p2_tmp"
                    + "\n" +                     "WHERE t_column IN ('4', '5') AND t_row = '1'"
                    + "\n" +                     "AND (" + convertMaskToSqlFormat("40108*,40109*,40110*,40111*,40907*,40908*", "t_accountNumber") + ")))"
                    + "\n" +"SELECT   t_okatocode, t_row, t_column,"
                    + "\n" +         "CASE"
                    + "\n" +            "WHEN t_column = '4' AND t_row = '1'"
                    + "\n" +               "THEN (t_roublesum) + t_4"
                    + "\n" +            "WHEN t_column = '5' AND t_row = '1'"
                    + "\n" +               "THEN (t_roublesum) + t_5"
                    + "\n" +            "ELSE (t_roublesum)"
                    + "\n" +         "END AS t_roublesum,"
                    + "\n" +         "t_backoffice"
                    + "\n" +    "FROM (SELECT   t_okatocode, t_row, t_column,"
                    + "\n" +                   "SUM (NVL (t_roublesum, 0)) t_roublesum, t_backoffice"
                    + "\n" +              "FROM df302p2_tmp"
                    + "\n" +             "WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                    + "\n" +                  "GROUP BY t_okatocode, t_row, t_column, t_backoffice),"
                    + "\n" +                 "column_"
                    + "\n" +        "ORDER BY t_okatocode, t_row, t_column, t_backoffice");

        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator();
end;

/**
 * Расчет раздела 2 по 2742-У
 * @since v.6.20.030.050
 * @version 1.0
 * @author ABP
 */
private class (TPart2Calculator2055) TPart2Calculator2742()

    private macro getDataSet()
        macro P_(account_1, account_2, n, row, column)
            var dataSet = "(SUM"
                 + "\n" + "    (CASE"
                 + "\n" + "         WHEN t_accountnumber LIKE '" + account_1 + "%'"
                 + "\n" + "          AND t_column = '" + column + "'"
                 + "\n" + "          AND t_row = '" + row + "'"
                 + "\n" + "             THEN t_roublesum"
                 + "\n" + "         WHEN t_accountnumber LIKE '" + account_2 + "%'"
                 + "\n" + "          AND t_column = '" + column + "'"
                 + "\n" + "          AND t_row = '" + row + "'"
                 + "\n" + "             THEN -t_roublesum"
                 + "\n" + "         ELSE 0"
                 + "\n" + "     END"
                 + "\n" + "    )"
                 + "\n" + ") AS p" + n;
            return dataSet;
        end;

        var dataSet = TRsbDataSet("WITH column_ AS"
                         + "\n" + "(SELECT DECODE(SIGN(p1), 1, p1, 0)       AS t_1_4,"
                         + "\n" + "        DECODE(SIGN(p2), 1, p2, 0)       AS t_1_5,"
                         + "\n" + "        (  DECODE(SIGN(p3), 1, p3, 0)"
                         + "\n" + "         + DECODE(SIGN(p5), 1, p5, 0)"
                         + "\n" + "        )                                AS t_1_1_4,"
                         + "\n" + "        (  DECODE(SIGN(p4), 1, p4, 0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6, 0)"
                         + "\n" + "        )                                AS t_1_1_5"
                         + "\n" + "   FROM (SELECT " + P_("40907","40908",1,"1","4") + ","
                         + "\n" + "                " + P_("40907","40908",2,"1","5") + ","
                         + "\n" + "                " + P_("40108","40109",3,"1.1","4") + ","
                         + "\n" + "                " + P_("40108","40109",4,"1.1","5") + ","
                         + "\n" + "                " + P_("40110","40111",5,"1.1","4") + ","
                         + "\n" + "                " + P_("40110","40111",6,"1.1","5")
                         + "\n" + "           FROM df302p2_tmp"
                         + "\n" + "          WHERE t_column IN ('4', '5')"
                         + "\n" + "            AND t_row IN ('1', '1.1')"
                         + "\n" + "            AND (" + convertMaskToSqlFormat("40108*,40109*,40110*,40111*,40907*,40908*", "t_accountNumber") + ")"
                         + "\n" + "        )"
                         + "\n" + ")"
                         + "\n" + "SELECT t_okatocode,"
                         + "\n" + "       t_row,"
                         + "\n" + "       t_column,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN t_column = '4' AND t_row = '1'"
                         + "\n" + "               THEN t_roublesum + t_1_4"
                         + "\n" + "           WHEN t_column = '5' AND t_row = '1'"
                         + "\n" + "               THEN t_roublesum + t_1_5"
                         + "\n" + "           WHEN t_column = '4' AND t_row = '1.1'"
                         + "\n" + "               THEN t_roublesum + t_1_1_4"
                         + "\n" + "           WHEN t_column = '5' AND t_row = '1.1'"
                         + "\n" + "               THEN t_roublesum + t_1_1_5"
                         + "\n" + "           ELSE t_roublesum"
                         + "\n" + "       END AS t_roublesum,"
                         + "\n" + "       t_backoffice"
                         + "\n" + "  FROM (SELECT t_okatocode,"
                         + "\n" + "               CASE t_row"
                         + "\n" + "                   WHEN '1.7_з' THEN '1.7'"
                         + "\n" + "                   WHEN '1.8_з' THEN '1.8'"
                         + "\n" + "                   ELSE t_row"
                         + "\n" + "               END AS t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               SUM(NVL(t_roublesum, 0)) t_roublesum,"
                         + "\n" + "               t_backoffice"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "           AND t_row IS NOT NULL"
                         + "\n" + "         GROUP BY t_okatocode,"
                         + "\n" + "                  CASE t_row"
                         + "\n" + "                      WHEN '1.7_з' THEN '1.7'"
                         + "\n" + "                      WHEN '1.8_з' THEN '1.8'"
                         + "\n" + "                      ELSE t_row"
                         + "\n" + "                  END,"
                         + "\n" + "                  t_column,"
                         + "\n" + "                  t_backoffice"
                         + "\n" + "       ),"
                         + "\n" + "       column_"
                         + "\n" + " ORDER BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_backoffice"
                                 );

        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator2055();
end;

/**
 * Расчет раздела 2 по 2835-У
 * @version 1.0
 */
private class (TPart2Calculator2742) TPart2Calculator2835()
    private macro getDataSet()
        macro P_(account_1, account_2, n, row, column)
            var dataSet = "(SUM"
                 + "\n" + "    (CASE"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_1 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN t_roublesum"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_2 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN -t_roublesum"
                 + "\n" + "         ELSE 0"
                 + "\n" + "     END"
                 + "\n" + "    )"
                 + "\n" + ") AS p" + n;
            return dataSet;
        end;

        var dataSet = TRsbDataSet("WITH column_ AS"
                         + "\n" + "(SELECT DECODE(SIGN(p1), 1, p1, 0)       AS t_1_4,"
                         + "\n" + "        DECODE(SIGN(p2), 1, p2, 0)       AS t_1_5,"
                         + "\n" + "        (  DECODE(SIGN(p3), 1, p3, 0)"
                         + "\n" + "         + DECODE(SIGN(p5), 1, p5, 0)"
                         + "\n" + "        )                                AS t_1_1_4,"
                         + "\n" + "        (  DECODE(SIGN(p4), 1, p4, 0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6, 0)"
                         + "\n" + "        )                                AS t_1_1_5"
                         + "\n" + "   FROM (SELECT " + P_("40907","40908",1,"1","4") + ","
                         + "\n" + "                " + P_("40907","40908",2,"1","5") + ","
                         + "\n" + "                " + P_("40108","40109",3,"1.1","4") + ","
                         + "\n" + "                " + P_("40108","40109",4,"1.1","5") + ","
                         + "\n" + "                " + P_("40110","40111",5,"1.1","4") + ","
                         + "\n" + "                " + P_("40110","40111",6,"1.1","5")
                         + "\n" + "           FROM df302p2_tmp"
                         + "\n" + "          WHERE t_column IN ('4', '5')"
                         + "\n" + "            AND t_row IN ('1', '1.1')"
                         + "\n" + "            AND (" + convertMaskToSqlFormat("40108*,40109*,40110*,40111*,40907*,40908*", "t_accountNumber") + ")"
                         + "\n" + "        )"
                         + "\n" + ")"
                         + "\n" + "SELECT t_okatocode, t_row, t_column, SUM(t_roublesum) AS t_roubleSum, t_backoffice"
                         + "\n" + "  FROM (SELECT t_okatocode,"
                         + "\n" + "       t_row,"
                         + "\n" + "       t_column,"
                         + "\n" + "       CASE"
                         + "\n" + "           WHEN t_column = '4' AND t_row = '1'"
                         + "\n" + "               THEN t_roublesum + t_1_4"
                         + "\n" + "           WHEN t_column = '5' AND t_row = '1'"
                         + "\n" + "               THEN t_roublesum + t_1_5"
                         + "\n" + "           WHEN t_column = '4' AND t_row = '1.1'"
                         + "\n" + "               THEN t_roublesum + t_1_1_4"
                         + "\n" + "           WHEN t_column = '5' AND t_row = '1.1'"
                         + "\n" + "               THEN t_roublesum + t_1_1_5"
                         + "\n" + "           ELSE t_roublesum"
                         + "\n" + "       END AS t_roublesum,"
                         + "\n" + "       t_backoffice"
                         + "\n" + "  FROM ((SELECT t_okatocode,"
                         + "\n" + "               CASE t_row"
                         + "\n" + "                   WHEN '1.7_з' THEN '1.7'"
                         + "\n" + "                   WHEN '1.8_з' THEN '1.8'"
                         + "\n" + "                   ELSE t_row"
                         + "\n" + "               END AS t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               SUM(NVL(t_roublesum, 0)) t_roublesum,"
                         + "\n" + "               t_backoffice"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "           AND t_row IS NOT NULL"
                         + "\n" + "         GROUP BY t_okatocode,"
                         + "\n" + "                  CASE t_row"
                         + "\n" + "                      WHEN '1.7_з' THEN '1.7'"
                         + "\n" + "                      WHEN '1.8_з' THEN '1.8'"
                         + "\n" + "                      ELSE t_row"
                         + "\n" + "                  END,"
                         + "\n" + "                  t_column,"
                         + "\n" + "                  t_backoffice)"
                         + "\n" + "  UNION ALL"
                         + "\n" + "        (SELECT t_okatocode,"
                         + "\n" + "               '1' AS t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               SUM(NVL(t_roublesum, 0)) t_roublesum,"
                         + "\n" + "               t_backoffice"
                         + "\n" + "          FROM df302p2_tmp"
                         + "\n" + "         WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "           AND t_row <> '1' "
                         + "\n" + "           AND t_row IS NOT NULL"
                         + "\n" + "         GROUP BY t_okatocode, t_row, t_column, t_backoffice"
                         + "\n" + "       )),"
                         + "\n" + "       column_)"
                         + "\n" + " GROUP BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_backoffice"
                         + "\n" + " ORDER BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_backoffice"
                                 );

        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator2742();
end;

/**
 * Расчет раздела 2 по 2835-У
 * @version 1.0
 */
private class (TPart2Calculator2835) TPart2Calculator2926()

    //индикаторы использования добавок для строк 1 и 1.1
    private var P_1_4   : bool = false;
    private var P_1_1_4 : bool = false;
    private var P_1_5   : bool = false;
    private var P_1_1_5 : bool = false;
    private var isLine1NeedCaclulate = isBackofficeSet(BOCB, RCB_I3656_DATE, "2", "1", "4,5");

    private macro processRow(compositeValue : Object, dataSet : Object)
        if (dataSet.column == "4")
            compositeValue.fieldValue("rubObtainedFundsRest").setUndefined;
            if ((P_1_4 == false) and (dataSet.row == "1"))
                //учет рублевой добавки по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("rubObtainedFundsRest").exact = dataSet.roubleSum + dataSet.t_1_4;
                end;
                P_1_4 = true;
            elif ((P_1_1_4 == false) and (dataSet.row == "1.1"))
                //учет рублевой добавки по строке 1.1
                compositeValue.fieldValue("rubObtainedFundsRest").exact = dataSet.roubleSum + dataSet.t_1_1_4;
                P_1_1_4 = true;
            else
                compositeValue.fieldValue("rubObtainedFundsRest").exact   = dataSet.roubleSum;
            end;
        elif (dataSet.column == "5")
            compositeValue.fieldValue("curObtainedFundsRest").setUndefined;
            if ((P_1_5 == false) and (dataSet.row == "1"))
                //учет валютной добавки по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("curObtainedFundsRest").exact = dataSet.roubleSum + dataSet.t_1_5;
                end;
                P_1_5 = true;
            elif ((P_1_1_5 == false) and (dataSet.row == "1.1"))
                //учет валютной добавки по строке 1.1
                compositeValue.fieldValue("curObtainedFundsRest").exact = dataSet.roubleSum + dataSet.t_1_1_5;
                P_1_1_5 = true;
            else
                compositeValue.fieldValue("curObtainedFundsRest").exact   = dataSet.roubleSum;
            end;
        end;
    end;

    private macro getDataSet()
        macro P_(account_1, account_2, n, row, column)
            var dataSet = "(SUM"
                 + "\n" + "    (CASE"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_1 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN t_roublesum"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_2 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN -t_roublesum"
                 + "\n" + "         ELSE 0"
                 + "\n" + "     END"
                 + "\n" + "    )"
                 + "\n" + ") AS p" + n;
            return dataSet;
        end;

        var dataSet = TRsbDataSet("WITH column_ AS"
                         + "\n" + "(SELECT ("
                         + "\n" + "           DECODE(SIGN(p1), 1, p1, 0)"
                         + "\n" + "         + DECODE(SIGN(p3), 1, p3, 0)"
                         + "\n" + "         + DECODE(SIGN(p5), 1, p5, 0)"
                         + "\n" + "        )                                AS t_1_4,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p2), 1, p2, 0)"
                         + "\n" + "         + DECODE(SIGN(p4), 1, p4, 0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6, 0)"
                         + "\n" + "        )                                AS t_1_5,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p3), 1, p3, 0)"
                         + "\n" + "         + DECODE(SIGN(p5), 1, p5, 0)"
                         + "\n" + "        )                                AS t_1_1_4,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p4), 1, p4, 0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6, 0)"
                         + "\n" + "        )                                AS t_1_1_5"
                         + "\n" + "   FROM (SELECT " + P_("40907","40908",1,"1","4") + ","
                         + "\n" + "                " + P_("40907","40908",2,"1","5") + ","
                         + "\n" + "                " + P_("40108","40109",3,"1.1","4") + ","
                         + "\n" + "                " + P_("40108","40109",4,"1.1","5") + ","
                         + "\n" + "                " + P_("40110","40111",5,"1.1","4") + ","
                         + "\n" + "                " + P_("40110","40111",6,"1.1","5")
                         + "\n" + "           FROM df302p2_tmp"
                         + "\n" + "          WHERE t_column IN ('4', '5')"
                         + "\n" + "            AND t_row IN ('1', '1.1')"
                         + "\n" + "            AND (" + convertMaskToSqlFormat("40108*,40109*,40110*,40111*,40907*,40908*", "t_accountNumber") + ")"
                         + "\n" + "        )"
                         + "\n" + ")"
                         + "\n" + "SELECT t_okatocode, t_row, t_column, SUM(t_roublesum) AS t_roubleSum, t_backoffice, t_1_4, t_1_5, t_1_1_4, t_1_1_5"
                         + "\n" + "  FROM (SELECT t_okatocode,"
                         + "\n" + "               t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               t_roubleSum,"
                         + "\n" + "               t_backoffice,"
                         + "\n" + "               t_1_4,"
                         + "\n" + "               t_1_5,"
                         + "\n" + "               t_1_1_4,"
                         + "\n" + "               t_1_1_5"
                         + "\n" + "          FROM "
                         + "\n" + "              ("
                         + "\n" + "                ("
                         + "\n" + "                 SELECT t_okatocode,"
                         + "\n" + "                        t_row,"
                         + "\n" + "                        t_column,"
                         + "\n" + "                        SUM(NVL(t_roublesum, 0)) t_roublesum,"
                         + "\n" + "                        t_backoffice"
                         + "\n" + "                   FROM df302p2_tmp"
                         + "\n" + "                  WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "                    AND t_row IS NOT NULL"
                         + "\n" + "                    AND t_row != '1.9_з'"
                         + "\n" + "                  GROUP BY t_okatocode,"
                         + "\n" + "                           t_row,"
                         + "\n" + "                           t_column,"
                         + "\n" + "                           t_backoffice"
                         + "\n" + "                )"
                         + "\n" + "                 UNION ALL"
                         + "\n" + "                ("
                         + "\n" + "                 SELECT t_okatocode,"
                         + "\n" + "                        '1' AS t_row,"
                         + "\n" + "                        t_column,"
                         + "\n" + "                        " + ternary(isLine1NeedCaclulate, "SUM(NVL(t_roublesum, 0))", "0") + "t_roublesum,"
                         + "\n" + "                        t_backoffice"
                         + "\n" + "                   FROM df302p2_tmp"
                         + "\n" + "                  WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "                    AND t_row <> '1' "
                         + "\n" + "                    AND t_row IS NOT NULL"
                         + "\n" + "                  GROUP BY t_okatocode, t_column, t_backoffice"
                         + "\n" + "                )"
                         + "\n" + "              )"
                         + "\n" + "       ,column_)"
                         + "\n" + " GROUP BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_backoffice,"
                         + "\n" + "          t_1_4,"
                         + "\n" + "          t_1_5,"
                         + "\n" + "          t_1_1_4,"
                         + "\n" + "          t_1_1_5"
                         + "\n" + " ORDER BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_backoffice"
                                 );

        dataSet.setFieldType("t_roubleSum", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator2742();
end;

private class (TPart2Calculator2926) TPart2Calculator4637()
    //индикаторы использования добавок для строк 1 и 1.1
    private var P_1_6   : bool = false;
    private var P_1_1_6 : bool = false;
    private var P_1_7   : bool = false;
    private var P_1_1_7 : bool = false;
    private var P_1_8   : bool = false;
    private var P_1_1_8 : bool = false;
    private var currentOkato = "";

    isLine1NeedCaclulate = isBackofficeSet(BOCB, RCB_I4637_DATE_F302, "2", "1", "4,5,6,7,8");

    private macro processRow(compositeValue : Object, dataSet : Object)
        if (currentOkato != dataSet.okatoCode)
            currentOkato = dataSet.okatoCode;
            P_1_4   = false;
            P_1_1_4 = false;
            P_1_5   = false;
            P_1_1_5 = false;
            P_1_6   = false;
            P_1_1_6 = false;
            P_1_7   = false;
            P_1_1_7 = false;
            P_1_8   = false;
            P_1_1_8 = false;
        end;

        if   (dataSet.column == "5")
            compositeValue.fieldValue("obtainedFundsRest_643").setUndefined;
            if ((P_1_5 == false) and (dataSet.row == "1"))
                //учет рублевой добавки по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("obtainedFundsRest_643").exact = dataSet.roubleSum + dataSet.t_1_5;
                end;
                P_1_5 = true;
            elif ((P_1_1_5 == false) and (dataSet.row == "1.1"))
                //учет рублевой добавки по строке 1.1
                compositeValue.fieldValue("obtainedFundsRest_643").exact = dataSet.roubleSum + dataSet.t_1_1_5;
                P_1_1_5 = true;
            else
                compositeValue.fieldValue("obtainedFundsRest_643").exact = dataSet.roubleSum;
            end;
        elif (dataSet.column == "6")
            compositeValue.fieldValue("obtainedFundsRest_840").setUndefined;
            if ((P_1_6 == false) and (dataSet.row == "1"))
                //учет добавки доллара США по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("obtainedFundsRest_840").exact = dataSet.roubleSum + dataSet.t_1_6;
                end;
                P_1_6 = true;
            elif ((P_1_1_6 == false) and (dataSet.row == "1.1"))
                //учет добавки доллара США по строке 1.1
                compositeValue.fieldValue("obtainedFundsRest_840").exact = dataSet.roubleSum + dataSet.t_1_1_6;
                P_1_1_6 = true;
            else
                compositeValue.fieldValue("obtainedFundsRest_840").exact = dataSet.roubleSum;
            end;
        elif (dataSet.column == "7")
            compositeValue.fieldValue("obtainedFundsRest_978").setUndefined;
            if ((P_1_7 == false) and (dataSet.row == "1"))
                //учет добавки евро по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("obtainedFundsRest_978").exact = dataSet.roubleSum + dataSet.t_1_7;
                end;
                P_1_7 = true;
            elif ((P_1_1_7 == false) and (dataSet.row == "1.1"))
                //учет добавки евро по строке 1.1
                compositeValue.fieldValue("obtainedFundsRest_978").exact = dataSet.roubleSum + dataSet.t_1_1_7;
                P_1_1_7 = true;
            else
                compositeValue.fieldValue("obtainedFundsRest_978").exact = dataSet.roubleSum;
            end;
        elif (dataSet.column == "8")
            compositeValue.fieldValue("obtainedFundsRest_156").setUndefined;
            if ((P_1_8 == false) and (dataSet.row == "1"))
                //учет добавки юаней по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("obtainedFundsRest_156").exact = dataSet.roubleSum + dataSet.t_1_8;
                end;
                P_1_8 = true;
            elif ((P_1_1_8 == false) and (dataSet.row == "1.1"))
                //учет добавки юаней по строке 1.1
                compositeValue.fieldValue("obtainedFundsRest_156").exact = dataSet.roubleSum + dataSet.t_1_1_8;
                P_1_1_8 = true;
            else
                compositeValue.fieldValue("obtainedFundsRest_156").exact = dataSet.roubleSum;
            end;
        //графа 4 - Всего
        else
            compositeValue.fieldValue("obtainedFundsRestTotal").setUndefined;
            if ((P_1_4 == false) and (dataSet.row == "1"))
                //учет добавки по строке 1
                if (isLine1NeedCaclulate)
                    compositeValue.fieldValue("obtainedFundsRestTotal").exact = dataSet.totalSumFor4Column + dataSet.t_1_4;
                end;
                P_1_4 = true;
            elif ((P_1_1_4 == false) and (dataSet.row == "1.1"))
                //учет добавки по строке 1.1
                compositeValue.fieldValue("obtainedFundsRestTotal").exact = dataSet.totalSumFor4Column + dataSet.t_1_1_4;
                P_1_1_4 = true;
            else
                compositeValue.fieldValue("obtainedFundsRestTotal").exact = dataSet.totalSumFor4Column;
            end;
        end;
    end;

    private macro getDataSet()
        macro P_(account_1, account_2, n, row, column)
            var dataSet = "(SUM"
                 + "\n" + "    (CASE"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_1 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN t_roublesum"
                 + "\n" + "         WHEN     t_accountnumber LIKE '" + account_2 + "%'"
                 + "\n" + "              AND t_column = '" + column + "'"
                 + "\n" + "              AND t_row    = '" + row + "'"
                 + "\n" + "             THEN -t_roublesum"
                 + "\n" + "         ELSE 0"
                 + "\n" + "     END"
                 + "\n" + "    )"
                 + "\n" + ") AS p" + n;
            return dataSet;
        end;

        var dataSet = TRsbDataSet("WITH column_ AS"
                         + "\n" + "(SELECT ("
                         + "\n" + "           DECODE(SIGN(p1),  1, p1,  0)"
                         + "\n" + "         + DECODE(SIGN(p3),  1, p3,  0)"
                         + "\n" + "         + DECODE(SIGN(p5),  1, p5,  0)"
                         + "\n" + "         + DECODE(SIGN(p2),  1, p2,  0)"
                         + "\n" + "         + DECODE(SIGN(p4),  1, p4,  0)"
                         + "\n" + "         + DECODE(SIGN(p6),  1, p6,  0)"
                         + "\n" + "         + DECODE(SIGN(p26), 1, p26, 0)"
                         + "\n" + "         + DECODE(SIGN(p46), 1, p46, 0)"
                         + "\n" + "         + DECODE(SIGN(p66), 1, p66, 0)"
                         + "\n" + "         + DECODE(SIGN(p27), 1, p27, 0)"
                         + "\n" + "         + DECODE(SIGN(p47), 1, p47, 0)"
                         + "\n" + "         + DECODE(SIGN(p67), 1, p67, 0)"
                         + "\n" + "         + DECODE(SIGN(p28), 1, p28, 0)"
                         + "\n" + "         + DECODE(SIGN(p48), 1, p48, 0)"
                         + "\n" + "         + DECODE(SIGN(p68), 1, p68, 0)"
                         + "\n" + "        )                                AS t_1_4,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p2), 1, p2,  0)"
                         + "\n" + "         + DECODE(SIGN(p4), 1, p4,  0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6,  0)"
                         + "\n" + "        )                                AS t_1_5,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p26), 1, p26, 0)"
                         + "\n" + "         + DECODE(SIGN(p46), 1, p46, 0)"
                         + "\n" + "         + DECODE(SIGN(p66), 1, p66, 0)"
                         + "\n" + "        )                                AS t_1_6,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p27), 1, p27, 0)"
                         + "\n" + "         + DECODE(SIGN(p47), 1, p47, 0)"
                         + "\n" + "         + DECODE(SIGN(p67), 1, p67, 0)"
                         + "\n" + "        )                                AS t_1_7,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p28), 1, p28, 0)"
                         + "\n" + "         + DECODE(SIGN(p48), 1, p48, 0)"
                         + "\n" + "         + DECODE(SIGN(p68), 1, p68, 0)"
                         + "\n" + "        )                                AS t_1_8,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p3),  1, p3,  0)"
                         + "\n" + "         + DECODE(SIGN(p5),  1, p5,  0)"
                         + "\n" + "         + DECODE(SIGN(p4),  1, p4,  0)"
                         + "\n" + "         + DECODE(SIGN(p6),  1, p6,  0)"
                         + "\n" + "         + DECODE(SIGN(p46), 1, p46, 0)"
                         + "\n" + "         + DECODE(SIGN(p66), 1, p66, 0)"
                         + "\n" + "         + DECODE(SIGN(p47), 1, p47, 0)"
                         + "\n" + "         + DECODE(SIGN(p67), 1, p67, 0)"
                         + "\n" + "         + DECODE(SIGN(p48), 1, p48, 0)"
                         + "\n" + "         + DECODE(SIGN(p68), 1, p68, 0)"
                         + "\n" + "        )                                AS t_1_1_4,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p4), 1, p4,  0)"
                         + "\n" + "         + DECODE(SIGN(p6), 1, p6,  0)"
                         + "\n" + "        )                                AS t_1_1_5,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p46), 1, p46, 0)"
                         + "\n" + "         + DECODE(SIGN(p66), 1, p66, 0)"
                         + "\n" + "        )                                AS t_1_1_6,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p47), 1, p47, 0)"
                         + "\n" + "         + DECODE(SIGN(p67), 1, p67, 0)"
                         + "\n" + "        )                                AS t_1_1_7,"
                         + "\n" + "        ("
                         + "\n" + "           DECODE(SIGN(p48), 1, p48, 0)"
                         + "\n" + "         + DECODE(SIGN(p68), 1, p68, 0)"
                         + "\n" + "        )                                AS t_1_1_8,"
                         + "\n" + "        t_okatoCode                      AS t_okatoCode"
                         + "\n" + "   FROM (SELECT " + P_("40907","40908",1, "1",  "4") + ","
                         + "\n" + "                " + P_("40907","40908",2, "1",  "5") + ","
                         + "\n" + "                " + P_("40907","40908",26,"1",  "6") + ","
                         + "\n" + "                " + P_("40907","40908",27,"1",  "7") + ","
                         + "\n" + "                " + P_("40907","40908",28,"1",  "8") + ","
                         + "\n" + "                " + P_("40108","40109",3, "1.1","4") + ","
                         + "\n" + "                " + P_("40108","40109",4, "1.1","5") + ","
                         + "\n" + "                " + P_("40108","40109",46,"1.1","6") + ","
                         + "\n" + "                " + P_("40108","40109",47,"1.1","7") + ","
                         + "\n" + "                " + P_("40108","40109",48,"1.1","8") + ","
                         + "\n" + "                " + P_("40110","40111",5, "1.1","4") + ","
                         + "\n" + "                " + P_("40110","40111",6, "1.1","5") + ","
                         + "\n" + "                " + P_("40110","40111",66,"1.1","6") + ","
                         + "\n" + "                " + P_("40110","40111",67,"1.1","7") + ","
                         + "\n" + "                " + P_("40110","40111",68,"1.1","8") + ","
                         + "\n" + "                t_okatoCode"
                         + "\n" + "           FROM df302p2_tmp"
                         + "\n" + "          WHERE t_column IN ('4', '5', '6', '7', '8')"
                         + "\n" + "            AND t_row IN ('1', '1.1')"
                         + "\n" + "            AND (" + convertMaskToSqlFormat("40108*,40109*,40110*,40111*,40907*,40908*", "t_accountNumber") + ")"
                         + "\n" + "          GROUP BY t_okatoCode"
                         + "\n" + "        )"
                         + "\n" + "),"
                         + "\n" + "okatos as"
                         + "\n" + "("
                         + "\n" + "SELECT distinct t_okatoCode"
                         + "\n" + "  FROM df302p2_tmp"
                         + "\n" + "),"
                         + "\n" + "bo as"
                         + "\n" + "("
                         + "\n" + "SELECT distinct t_backoffice"
                         + "\n" + "  FROM df302p2_tmp"
                         + "\n" + "),"
                         + "\n" + "reportRows as"
                         + "\n" + "("
                         + "\n" + "SELECT '1' as reprow"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.1'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.2'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.3'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.4'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.5'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.6'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.7'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.8'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '1.9'"
                         + "\n" + "  FROM dual"
                         + "\n" + "),"
                         + "\n" + "colunms as"
                         + "\n" + "("
                         + "\n" + "SELECT '4' as col"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '5'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '6'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '7'"
                         + "\n" + "  FROM dual"
                         + "\n" + " UNION"
                         + "\n" + "SELECT '8'"
                         + "\n" + "  FROM dual"
                         + "\n" + ")"
                         + "\n" + "SELECT t_okatocode, t_row, t_column, SUM(t_roublesum) AS t_roubleSum, t_totalSumFor4Column, t_backoffice,  "
                         + "\n" + "       t_1_4, t_1_5, t_1_6, t_1_7, t_1_8, t_1_1_4, t_1_1_5, t_1_1_6, t_1_1_7, t_1_1_8"
                         + "\n" + "  FROM (SELECT data_.t_okatocode,"
                         + "\n" + "               t_row,"
                         + "\n" + "               t_column,"
                         + "\n" + "               t_roubleSum,"
                         + "\n" + "               SUM(t_roubleSum) OVER (PARTITION BY data_.t_okatoCode, t_row, t_backOffice) t_totalSumFor4Column,"                       //общая сумма
                         + "\n" + "               t_backoffice,"
                         + "\n" + "               nvl(t_1_4, 0)   as t_1_4,"
                         + "\n" + "               nvl(t_1_5, 0)   as t_1_5,"
                         + "\n" + "               nvl(t_1_6, 0)   as t_1_6,"
                         + "\n" + "               nvl(t_1_7, 0)   as t_1_7,"
                         + "\n" + "               nvl(t_1_8, 0)   as t_1_8,"
                         + "\n" + "               nvl(t_1_1_4, 0) as t_1_1_4,"
                         + "\n" + "               nvl(t_1_1_5, 0) as t_1_1_5,"
                         + "\n" + "               nvl(t_1_1_6, 0) as t_1_1_6,"
                         + "\n" + "               nvl(t_1_1_7, 0) as t_1_1_7,"
                         + "\n" + "               nvl(t_1_1_8, 0) as t_1_1_8"
                         + "\n" + "          FROM "
                         + "\n" + "              ("
                         //данные по всем строкам
                         + "\n" + "                 SELECT t_okatocode,"
                         + "\n" + "                        t_row,"
                         + "\n" + "                        t_column,"
                         + "\n" + "                        SUM(NVL(t_roublesum, 0)) t_roublesum,"
                         + "\n" + "                        t_backoffice"
                         + "\n" + "                   FROM df302p2_tmp"
                         + "\n" + "                  WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "                    AND t_row IS NOT NULL"
                         + "\n" + "                    AND t_row != '1.9_з'"    //Сумма залогов по договору аренды банковской ячейки включается сразу в расчет итоговой суммы по строке 1
                         + "\n" + "                  GROUP BY t_okatocode,"
                         + "\n" + "                           t_row,"
                         + "\n" + "                           t_column,"
                         + "\n" + "                           t_backoffice"
                         + "\n" + "                  UNION ALL"
                         //данные по строке 1 (по данным остальных строк)
                         + "\n" + "                 SELECT t_okatocode,"
                         + "\n" + "                        '1' AS t_row,"
                         + "\n" + "                        t_column,"
                         + "\n" + "                        " + ternary(isLine1NeedCaclulate, "SUM(NVL(t_roublesum, 0))", "0") + "t_roublesum,"
                         + "\n" + "                        t_backoffice"
                         + "\n" + "                   FROM df302p2_tmp"
                         + "\n" + "                  WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber")
                         + "\n" + "                    AND t_row <> '1' "
                         + "\n" + "                    AND t_row IS NOT NULL"
                         + "\n" + "                  GROUP BY t_okatocode, t_column, t_backoffice"
                         //принудительно добавляем ВСЕ строки и колонки по всем бэкофисам и ОКАТО
                         + "\n" + "                  UNION "
                         + "\n" + "                 SELECT okatos.t_okatocode,"
                         + "\n" + "                        reportRows.reprow,"
                         + "\n" + "                        colunms.col,"
                         + "\n" + "                        0 as t_roublesum,"
                         + "\n" + "                        bo.t_backoffice"
                         + "\n" + "                   FROM okatos,"
                         + "\n" + "                        bo,"
                         + "\n" + "                        reportRows,"
                         + "\n" + "                        colunms"
                         + "\n" + "                  WHERE CASE"
                         + "\n" + "                            WHEN reportRows.reprow IN ('1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.9') AND bo.t_backoffice IN (" + BODeposits + ")"
                         + "\n" + "                                THEN 0"
                         + "\n" + "                            WHEN reportRows.reprow IN ('1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7', '1.8') AND bo.t_backoffice IN (" + BORetail + ")"
                         + "\n" + "                                THEN 0"
                         + "\n" + "                            ELSE 1"
                         + "\n" + "                        END = 1"
                         + "\n" + "                    AND (okatos.t_okatocode, reportRows.reprow, colunms.col, bo.t_backoffice) NOT IN (SELECT t_okatocode, t_row, t_column, t_backoffice"
                         + "\n" + "                                                                                                        FROM df302p2_tmp"
                         + "\n" + "                                                                                                       WHERE " + convertMaskToSqlFormat("!(40108*,40109*,40110*,40111*,40907*,40908*)", "t_accountNumber") + ")"
                         + "\n" + "              ) data_"
                         + "\n" + "          LEFT JOIN column_"
                         + "\n" + "            ON data_.t_okatoCode = column_.t_okatoCode"
                         + "\n" + "       )"
                         + "\n" + " GROUP BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_column,"
                         + "\n" + "          t_totalSumFor4Column,"
                         + "\n" + "          t_backoffice,"
                         + "\n" + "          t_1_4,"
                         + "\n" + "          t_1_5,"
                         + "\n" + "          t_1_6,"
                         + "\n" + "          t_1_7,"
                         + "\n" + "          t_1_8,"
                         + "\n" + "          t_1_1_4,"
                         + "\n" + "          t_1_1_5,"
                         + "\n" + "          t_1_1_6,"
                         + "\n" + "          t_1_1_7,"
                         + "\n" + "          t_1_1_8"
                         + "\n" + " ORDER BY t_okatocode,"
                         + "\n" + "          t_row,"
                         + "\n" + "          t_backoffice,"
                         + "\n" + "          t_column"
                                 );

        dataSet.setFieldType("t_roubleSum",          V_MONEY);
        dataSet.setFieldType("t_totalSumFor4Column", V_MONEY);

        return dataSet;
    end;

    initTPart2Calculator2926();
end;

/***************************************************************************************************
 *  Вызов функций осуществляется системной операцией
 **************************************************************************************************/
private macro calculateReport()

    var profiler = TSQLProfiler(getTxtFileName("!calc_f302post_sqlprof"));
    profiler.clear();
    profiler.on();

    if   (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
        TPart1Calculator2055().execute();
        TPart2Calculator2055().execute();
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2627_DATE)
        TPart1Calculator2183().execute();
        TPart2Calculator2055().execute();
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2742_DATE)
        TPart1Calculator2627().execute();
        TPart2Calculator2055().execute();
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2835_DATE)
        TPart1Calculator2627().execute();
        TPart2Calculator2742().execute();
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2926_DATE)
        TPart1Calculator2627().execute();
        TPart2Calculator2835().execute();
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
        TPart1Calculator2627().execute();
        TPart2Calculator2926().execute();
    else
        TPart1Calculator2627().execute();
        TPart2Calculator4637().execute();
    end;

    var protocolPrinter = null;

    if   (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2055(), TPart2Protocol1948());
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2627_DATE)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2183(), TPart2Protocol1948());
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2742_DATE)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2627(), TPart2Protocol1948());
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2926_DATE)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2627(), TPart2Protocol2742());
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3129_DATE)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2627(), TPart2Protocol2926());
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
        protocolPrinter = TProtocolPrinter(TPart1Protocol2627(), TPart2Protocol3129());
    else
        protocolPrinter = TProtocolPrinter(TPart1Protocol2627(), TPart2Protocol4637());
    end;
    protocolPrinter.print();
    protocolPrinter.view();
end;

private macro viewProtocolFile()
    TProtocolPrinter().view();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
