/*
$Name:          pr12spod.mac
$Module:        Регламентируемая отчетность
$Description:   Ведомость оборотов по отражению СПОД. Приложение 12
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                           R-Style Software Lab

  File Name   : pr13spod.mac                                January 24, 2005
  Programmer  : Alexander A. Zaitsev (BugZ).
  Description : Ведомость оборотов по отражению СПОД - Прил. 13
  Comment     : CSpodTableReport - отчет.
  Modify      :
    BugZ    27.01.2005  Сортировка по полю дебета лицевого счета.
    BugZ    31.01.2005  Отчет в виде макроформы.
    BugZ    27.02.2005  Исправление: вывод рублевых сумм (по счетам покрытия
                        вместо валютных).
    BugZ    16.04.2005  SCR 66920 Суммы проводок выводятся по модулю.
    BugZ    19.04.2005  SCR 66894 Оптимизация расчета на PL/SQL.
    BugZ    25.04.2005  SCR 67312 NullConversion не работает в 4 релизе-chr(1)
    BugZ    26.04.2005  SCR 67398 Отчет включающий сегодняшний день.
    BugZ    29.04.2005  NullConversion починили - убрал StrNullConversion.
    BugZ    21.07.2005  SCR 67395 Фильтрация по ТС/РС.
    BugZ    19.08.2005  SCR 72458 Убрал ненужное поле t_isFromDocumentTable
└───────────────────────────────────────────────────────────────────────────*/

import ReptCBInter;         /* Даты периода */
import TReport;             /* Класс отчета */
import param;               /* Руководитель, Главный бухгалтер */
import RcbConst;            /* RCB_RUBCARRY */
import RsbDataSet;          /* TRsbDataSet */
import cb_sql;              /* GetSQLString */
import DepartmentFilter;    /* RcbAccountFilter */
import or_rep_h;            /* Печать Excel*/
import CompositeTableField; 
import rcbimport;

/**
  * Переопределенный инструмент для снятия потока
  * (убран trim для печати в Excel с помощью Autoscan).
  */
private var _outString;

private Macro _collectOutProc (str)
   if (_outString)
      _outString = _outString + " " + str;
   else
      _outString = str;
      _outString = StrSubst(_outString,"\n","");
   end;
end;

macro CaptureOutput
   _outString = null;
   SetOutHandler (@_collectOutProc);
end;

macro StopCaptureOutput
   var retVal = _outString;
   _outString = null;
   SetOutHandler;
   return retVal;
end;


/**
 * Класс отчета
 */
class TSpodReport(beginDate : Date, endDate : Date)
    private var m_dataSource;
    private var m_parameters;
    private var m_reportView;

    /**
     * Класс параметров.
     */
    class TSpodParameters(_beginDate : Date, _endDate : Date)
        var bossPosition : string;
        var bookPosition : string;
        var isPeriod     : bool;
        var bossName     : string;
        var bookName     : string;
        var bankName     : string;
        var beginDate    : Date;
        var endDate      : Date;

        private macro constructorTSpodParameters(_beginDate, _endDate)
            beginDate = _beginDate;
            endDate   = _endDate;
            if ( beginDate == endDate )
                isPeriod = FALSE;
            elif ( beginDate < endDate )
                isPeriod = TRUE;
            end;

            bossPosition = {Name_Boss};
            bookPosition = {Name_Book};
            bossName     = {FIO_Boss};
            bookName     = {FIO_Book};
            bankName     = {Name_Bank};
        end;

        constructorTSpodParameters(_beginDate, _endDate);
    end;

    /**
     * Класс источника данных.
     */
    private class TSpodDataSources(parameters : object)
        private var m_parameters: object;
        private var m_dataSourcePool = RcbArray();

        macro getData()
            var accountFilter = RcbAccountFilter();
            var accountQuery =  " SELECT    t_AccountId,     " +
                                "           t_Type_Account   " +
                                " FROM      daccount_dbt a   " +
                                " WHERE                      " +
                                accountFilter.GetAsSqlString( "a" );

            var allDocumentsQuery =
                    " SELECT   ad.t_accTrnId                                              AutoKey,               " +
                    "          ad.t_Chapter                                               Chapter,               " +
                    "          ad.t_Account_Payer                                         AccountDebit,          " +
                    "          CASE"
                    "              WHEN ad.t_fiId_payer = 0"
                    "              THEN ABS( ad.t_Sum_Payer )"
                    "              ELSE 0"
                    "          END                                                        DebitRoubleTurnovers,"
                    "          CASE"
                    "              WHEN ad.t_fiId_payer = 0"
                    "              THEN 0"
                    "              ELSE ABS( ad.t_Sum_Natcur )"
                    "          END                                                        DebitCoverTurnovers,"
                    "          ABS( ad.t_Sum_Natcur )                                     DebitTotalTurnovers,   " +
                    "          ad.t_Account_Receiver                                      AccountCredit,         " +
                    "              CASE"
                    "              WHEN ad.t_fiId_receiver = 0"
                    "              THEN ABS( ad.t_Sum_Receiver )"
                    "              ELSE 0"
                    "          END                                                        CreditRoubleTurnovers,"
                    "          CASE"
                    "                  WHEN ad.t_fiId_receiver = 0"
                    "              THEN 0"
                    "              ELSE ABS( ad.t_Sum_Natcur )"
                    "          END                                                        CreditCoverTurnovers,"
                    "          ABS( ad.t_Sum_Natcur )                                     CreditTotalTurnovers,  " +
                    "          ad.t_Ground                                                OperationGround        " +
                    " FROM     dacctrn_dbt                      ad, " +
                    "       (" + accountQuery  + ")             db, " +
                    "       (" + accountQuery + ")              cr  " +
                    " WHERE    ad.t_Date_Carry >=                   " + GetSQLDate( m_parameters.beginDate )           +
                    " AND      ad.t_Date_Carry <=                   " + GetSQLDate( m_parameters.endDate   )           +
                    " AND      ad.t_state = 1                       " +
                    " AND      INSTR( ad.t_TypeDocument,            " + GetSQLString( "З" ) + " ) > 0   "   +
                    " AND      ad.t_AccountId_Payer = db.t_AccountId    " +
                    " AND      ad.t_AccountId_Receiver = cr.t_AccountId ";

            var documentsDataSet = TRsbDataSet( allDocumentsQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
            SQL_Truncate( "da13_tmp" );
            var reportDataSetInsert = TRsbDataSet( " SELECT * FROM da13_tmp ", RSDVAL_CLIENT, RSDVAL_STATIC );

            while ( documentsDataSet.MoveNext() )
                reportDataSetInsert.AddNew();
                reportDataSetInsert.AutoKey               = documentsDataSet.AutoKey;
                reportDataSetInsert.AccountDebit          = documentsDataSet.AccountDebit;
                /* Убрать приведение, когда починят DataSet, см. SCR 66395 */
                reportDataSetInsert.DebitRoubleTurnovers  = money( documentsDataSet.DebitRoubleTurnovers  );
                reportDataSetInsert.DebitCoverTurnovers   = money( documentsDataSet.DebitCoverTurnovers   );
                reportDataSetInsert.DebitTotalTurnovers   = money( documentsDataSet.DebitTotalTurnovers   );
                reportDataSetInsert.AccountCredit         = documentsDataSet.AccountCredit;
                reportDataSetInsert.CreditRoubleTurnovers = money( documentsDataSet.CreditRoubleTurnovers );
                reportDataSetInsert.CreditCoverTurnovers  = money( documentsDataSet.CreditCoverTurnovers  );
                reportDataSetInsert.CreditTotalTurnovers  = money( documentsDataSet.CreditTotalTurnovers  );
                reportDataSetInsert.OperationGround       = documentsDataSet.OperationGround;
                reportDataSetInsert.Update();
            end;

            m_dataSourcePool.push_back(TRsbDataSet( " SELECT * FROM da13_tmp ORDER BY t_Chapter, t_AccountDebit " ));

            return m_dataSourcePool;
        end;

        private macro constructorTSpodDataSource(parameters: object)
            m_parameters = parameters;
        end;

        constructorTSpodDataSource(parameters);
    end;

    /**
     * Класс модели представления.
     */
    private class TSpodReportView(parameters : object)
        private var m_parameters : object;
        private var m_template : TCompositeTableField;

        private  macro composePeriodString()
            if ( m_parameters.isPeriod )
                return string( "за период с ", m_parameters.BeginDate:m:l, " по ", m_parameters.EndDate:m:l );
            else
                return string( "за ", m_parameters.BeginDate:m:l );
            end;
        end;

        macro getFooter()
            return string(m_parameters.bossPosition + " __________" + m_parameters.bossName + "______________________ " + m_parameters.bookPosition + " _______" + m_parameters.bookName + "_________________");
        end;

        macro getHeader()
            CaptureOutput();
            [ ];
            [                                                                                                                                                             Приложение 13];
            [                                                                                                                                   к Правилам ведения бухгалтерского учета];
            [                                                                                                                                   в кредитных организациях, расположенных];
            [                                                                                                                                        на территории Российской Федерации];
            [                                                                                                                                      (Приложение к Положению Банка России];
            [                                                                                                                                               от 5 декабря 2002г. № 205-П];
            [                                                                                                                                  "О правилах ведения бухгалтерского учета];
            [                                                                                                                                   в кредитных организациях, расположенных];
            [                                                                                                                                      на территории Российской Федерации")];
            [ ];
            [##########################################################################################################################################################################] ( m_parameters.bankName:w );
            [__________________________________________________________________________________________________________________________________________________________________________];
            [ (наименование кредитной организации)];
            [ ];
            [##########################################################################################################################################################################] ("ВЕДОМОСТЬ ОБОРОТОВ":c);
            [##########################################################################################################################################################################] ("ПО ОТРАЖЕНИЮ СОБЫТИЙ ПОСЛЕ ОТЧЕТНОЙ ДАТЫ":c);
            [##########################################################################################################################################################################] ( ComposePeriodString():c );
            var result = StopCaptureOutput();

            return result
        end;

        macro getTableHeader()
            var header;
            var fieldWidthAccount : integer = 25;
            var fieldWidthGround  : integer = 25;
            var fieldWidthOther   : integer = 15;
            var template = TCompositeTableField();

            var debitAccount = TTableHeaderField("номер лицевого|счета", fieldWidthAccount, STR_ALIGN_LEFT);
            var debitResRub  = TTableHeaderField("в рублях", fieldWidthOther, STR_ALIGN_RIGHT);
            var debitResCur  = TTableHeaderField("ин. валюта в| рублевом |эквиваленте", fieldWidthOther, STR_ALIGN_RIGHT);
            var debitTotal   = TTableHeaderField("итого", fieldWidthOther, STR_ALIGN_RIGHT);

            var debitAccountData = TTableDataField("AccountDebit",         debitAccount.width, getFormatSpecifier(debitAccount.format));
            var debitResRubData  = TTableDataField("DebitRoubleTurnovers", debitResRub.width,  getFormatSpecifier(debitResRub.format));
            var debitResCurData  = TTableDataField("DebitCoverTurnovers",  debitResCur.width,  getFormatSpecifier(debitResCur.format));
            var debitTotalData   = TTableDataField("DebitTotalTurnovers",  debitTotal.width,   getFormatSpecifier(debitTotal.format));

            var creditAccount = TTableHeaderField("номер лицевого|счета", fieldWidthAccount, STR_ALIGN_LEFT);
            var creditResRub  = TTableHeaderField("в рублях", fieldWidthOther, STR_ALIGN_RIGHT);
            var creditResCur  = TTableHeaderField("ин. валюта в| рублевом |эквиваленте", fieldWidthOther, STR_ALIGN_RIGHT);
            var creditTotal   = TTableHeaderField("итого", fieldWidthOther, STR_ALIGN_RIGHT);

            var creditAccountData = TTableDataField("AccountCredit",         creditAccount.width, getFormatSpecifier(creditAccount.format));
            var creditResRubData  = TTableDataField("CreditRoubleTurnovers", creditResRub.width,  getFormatSpecifier(creditResRub.format));
            var creditResCurData  = TTableDataField("CreditCoverTurnovers",  creditResCur.width,  getFormatSpecifier(creditResCur.format));
            var creditTotalData   = TTableDataField("CreditTotalTurnovers",  creditTotal.width,   getFormatSpecifier(creditTotal.format));

            var operationGround     = TTableHeaderField("Содержание операции", fieldWidthGround, STR_ALIGN_RIGHT);
            var operationGroundData = TTableDataField("OperationGround", operationGround.width, getFormatSpecifier(operationGround.format));

            var amountHeader1 = TCompositeTableField();
            var amountHeader2 = TCompositeTableField();

            amountHeader1.setTableField(TTableField("Обороты по дебету", null, STR_ALIGN_CENTER));
                amountHeader1.addField(debitAccount, debitAccountData);
                amountHeader1.addField(debitResRub,  debitResRubData);
                amountHeader1.addField(debitResCur,  debitResCurData);
                amountHeader1.addField(debitTotal,   debitTotalData);

            amountHeader2.setTableField(TTableField("Обороты по кредиту", null, STR_ALIGN_CENTER));
                amountHeader2.addField(creditAccount, creditAccountData);
                amountHeader2.addField(creditResRub,  creditResRubData);
                amountHeader2.addField(creditResCur,  creditResCurData);
                amountHeader2.addField(creditTotal,   creditTotalData);

            template.addField(amountHeader1);
            template.addField(amountHeader2);
            template.addField(operationGround ,operationGroundData);

            m_template = template;

            header = "";
            for (var i, template.getReportHeader(true))
                header = header + "\n" + i;
            end;

            header = substr(header, 2);

            return header;
        end;

        macro getTemplate()
            return m_template;
        end;

        macro getEmptyData()
            return string("Данные отсутствуют");
        end;

        private macro constructorTSpodReportView(parameters: object)
            m_parameters = parameters;
        end;

        constructorTSpodReportView(parameters: object);
    end;

    /**
     * Движок печати на основе CMakeReport для PlainText и Excel
     */
    private class TSpodPrintEngine(reportView : object)
        private var m_printEngine : Object;
        private var m_separator   : String;
        private var m_reportWidth : Integer;
        private var m_tableWidth  : Integer;
        private var m_viewModel   : object;

        private macro getFullFileName(path, name)
            return toAnsi(path + "\\" + name);
        end;

        private macro getHeaderWidth()
            return m_printEngine.getSumLen();
        end;

        private macro printEmptyData()
            m_printEngine.addEmptyStr();
            m_printEngine.autoscan("["+m_viewModel.getEmptyData()+"]");
        end;

        private macro printHeader(isExcel : bool)
            if (isExcel)
                m_printEngine.autoscan("["+m_viewModel.getHeader()+"]");
            else
                print(SubStr(m_viewModel.getHeader(),2));
            end;

            m_printEngine.SetHeaderStr(m_viewModel.getTableHeader());
        end;

        private macro printRow(dataset : object)
            var data;
            var precision;

            for (var i, m_viewModel.getTemplate().getDataColumns())
                data = execExp("dataset." + i.dataSourceName);
                precision = ternary (valType(data) == V_MONEY, 2, 0);
                m_printEngine.addPrintCell(data, 0, precision, i.format, REP_ELEM_TABL);
            end;
            m_printEngine.addStr();
        end;

        private macro printFooter();
            m_printEngine.addEmptyStr();
            m_printEngine.addEmptyStr();
            m_printEngine.addEmptyStr();
            m_printEngine.autoscan("[" + m_viewModel.getFooter()+ "]");
        end;

        private macro initializeExcel()
            m_printEngine.setWinRepOutput(WINREP_OUTPUT_EXCEL, WINREP_FORMAT_XLSX);
            m_printEngine.setFlagShowIndicator(false);
            m_printEngine.setFlagShowGrid(false);
            m_printEngine.setFont("Courier New", 10.3, 0.95);
        end;

        private macro show(isExcel : bool)
            if (isExcel)
                m_printEngine.setFlagShowReport(false);
                m_printEngine.printWinRep();
                m_printEngine.showWinRep();

                var excel = CDAOMSExcel(null, true);
                excel.open(getFullFileName(m_printEngine.reportPath, m_printEngine.reportFileName_xls), WINREP_FORMAT_XLSX);
                excel.show();
            else
                m_printEngine.printRep();
            end;
        end;

        macro printReport(dataSourcePool : object, isExcel : bool)
            var hasData : bool = false;
            var dataSource;

            if (isExcel)
                initializeExcel();
            end;

            printHeader(isExcel);

            dataSourcePool.moveFirst();
            while (dataSourcePool.moveNext())
                dataSource = dataSourcePool.getCurrentItem();
                while (dataSource.moveNext())
                    printRow(dataSource);
                    hasData = true;
                end;
            end;

            if (not hasData)
                printEmptyData();
            end;

            printFooter();

            show(isExcel);
        end;

        private macro constructorTSpodPrintEngine(reportView: object)
            m_viewModel = reportView;
            m_printEngine = CMakeReport("", SEP_DEFAULT, 100000);
            m_printEngine.setFlagShowMidSeparator(false);
            m_printEngine.setFlagShowGrid(false);
        end;

        constructorTSpodPrintEngine(reportView: object);
    end;

    /**
     * Метод печатати Excel
     */
    macro printExcel()
        TSpodPrintEngine(m_reportView).printReport(m_dataSource.getData(), true);
    end;

    /**
     * Метод печатати PlainText
     */
    macro printPlainText()
        TSpodPrintEngine(m_reportView).printReport(m_dataSource.getData());
    end;

    private macro initializeRepDataPackage(beginDate : Date, endDate : Date)
        sql_truncate("drepdepartment_tmp");
        sql_execute("CALL rep_data.setBalancePlanNumber(" + rcbApplication.parameters.balancePlanNumber + ")");
        sql_execute("CALL rep_data.setBeginDate(" + getSqlDate(beginDate) + ")");
        sql_execute("CALL rep_data.setEndDate("   + getSqlDate(endDate)   + ")");
        sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(rcbDepartmentList.getAsSqlSetFilial()) + ", "
                                                       + getSqlString(rcbDepartmentList.getAsSqlSetVsp()) + ")");
    end;

    private macro constructorTSpodReport(beginDate : Date, endDate : Date)
        initializeRepDataPackage(beginDate, endDate);

        m_parameters = TSpodParameters(beginDate, endDate);
        m_dataSource = TSpodDataSources(m_parameters);
        m_reportView = TSpodReportView(m_parameters);
    end;

    constructorTSpodReport(beginDate, endDate);
end;

class (TSpodReport)TSpodReport_302(beginDate : Date, endDate : Date)
    private class (TSpodReportView) TSpodReportView_302(parameters: object)
        initTSpodReportView(parameters);

        macro getHeader()
            CaptureOutput();
            [ ];
            [                                                                                                                                                              Приложение 13];
            [                                                                                                                                    к Правилам ведения бухгалтерского учета];
            [                                                                                                                                    в кредитных организациях, расположенных];
            [                                                                                                                                         на территории Российской Федерации];
            [                                                                                                                                                                           ];
            [                                                                                                                                                                (Приложение];
            [                                                                                                                                                            к Положению ЦБР];
            [                                                                                                                                                от 26 марта 2007 г. N 302-П];
            [                                                                                                                                         "О правилах ведения Бухгалтерского];
            [                                                                                                                                            учета в кредитных организациях,];
            [                                                                                                                                                расположенных на территории];
            [                                                                                                                                                     Российской Федерации")];
            [ ];
            [###########################################################################################################################################################################] ( m_parameters.bankName:w );
            [___________________________________________________________________________________________________________________________________________________________________________];
            [ (наименование кредитной организации)];
            [ ];
            [###########################################################################################################################################################################] ("ВЕДОМОСТЬ ОБОРОТОВ":c);
            [###########################################################################################################################################################################] ("ПО ОТРАЖЕНИЮ СОБЫТИЙ ПОСЛЕ ОТЧЕТНОЙ ДАТЫ":c);
            [###########################################################################################################################################################################] ( ComposePeriodString():c );
            var result = StopCaptureOutput();

            return result
        end;
    end;

    private macro constructorTSpodReport_302(beginDate, endDate)
        initTSpodReport(beginDate, endDate);

        m_reportView = TSpodReportView_302(m_parameters);
    end;

    constructorTSpodReport_302(beginDate, endDate);
end;

class (TSpodReport_302)TSpodReport_2477(beginDate : Date, endDate : Date)
    private class (TSpodReportView_302) TSpodReportView_2477(parameters: object)
        initTSpodReportView_302(parameters);

        macro getHeader()
            CaptureOutput();
            [ ];
            [                                                                                                                                                              Приложение 13];
            [                                                                                                                                    к Правилам ведения бухгалтерского учета];
            [                                                                                                                                    в кредитных организациях, расположенных];
            [                                                                                                                                         на территории Российской Федерации];
            [ ];
            [                                                                                                                                                                (Приложение];
            [                                                                                                                                                            к Положению ЦБР];
            [                                                                                                                                                от 26 марта 2007 г. N 302-П];
            [                                                                                                                                         "О правилах ведения Бухгалтерского];
            [                                                                                                                                            учета в кредитных организациях,];
            [                                                                                                                                                расположенных на территории];
            [                                                                                                                                                     Российской Федерации")];
            [                                                                                                                                                                           ];
            [##############################################################################################################################@@###########################################] ( m_parameters.bankName:w );
            [___________________________________________________________________________________________________________________________________________________________________________];
            [ (полное или сокращенное фирменное наименование кредитной организации)];
            [ ];
            [##################################################################################################################################@@#######################################] ("ВЕДОМОСТЬ ОБОРОТОВ":c);
            [####################################################################################################################################@@#####################################] ("ПО ОТРАЖЕНИЮ СОБЫТИЙ ПОСЛЕ ОТЧЕТНОЙ ДАТЫ":c);
            [######################################################################################################################################@@###################################] ( ComposePeriodString():c );
            var result = StopCaptureOutput();

            return result
        end;
    end;

    private macro constructorTSpodReport_2477(beginDate, endDate)
        initTSpodReport_302(beginDate, endDate);

        m_reportView = TSpodReportView_2477(m_parameters);
    end;

    constructorTSpodReport_2477(beginDate, endDate);
end;

class (TSpodReport_2477)TSpodReport_385(beginDate : Date, endDate : Date)
    private class (TSpodDataSources) TSpodDataSources_385(parameters : object)
        private var m_incomeAccounts;      //маска счетов доходов
        private var m_expenditureAccounts; //маска счетов расходов

        macro getData()
            var accountFilter = RcbAccountFilter();
            var accountQuery =  "SELECT t_AccountId,     " +
                                "       t_Type           " +
                                "  FROM drepaccount_vw a " +
                                " WHERE " + accountFilter.GetAsSqlString("a");

            var allDocumentsQuery = "SELECT ad.t_accTrnId                                              AutoKey,              "
                + "\n" +            "       ad.t_Chapter                                               Chapter,              "
                + "\n" +            "       ad.t_Account_Payer                                         AccountDebit,         "
                + "\n" +            "       fi1.t_code                                                 FiidAccountDebit,     "
                + "\n" +            "       ac1.t_kind                                                 KindAccountDebit,     "
                + "\n" +            "       ac1.t_balance                                              BalanceAccountDebit,  "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_payer = 0 AND ad.t_Account_Payer NOT LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Payer)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        DebitRoubleTurnovers, "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_payer != 0 OR ad.t_Account_Payer LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Natcur)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        DebitCoverTurnovers,  "
                + "\n" +            "       ABS(ad.t_Sum_Natcur)                                       DebitTotalTurnovers,  "
                + "\n" +            "       ad.t_Account_Receiver                                      AccountCredit,        "
                + "\n" +            "       fi2.t_code                                                 FiidAccountCredit,    "
                + "\n" +            "       ac2.t_kind                                                 KindAccountCredit,    "
                + "\n" +            "       ac2.t_balance                                              BalanceAccountCredit, "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_receiver = 0 AND ad.t_Account_Receiver NOT LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Receiver)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        CreditRoubleTurnovers,"
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_receiver != 0 OR ad.t_Account_Receiver LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Natcur)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        CreditCoverTurnovers, "
                + "\n" +            "       ABS(ad.t_Sum_Natcur)                                       CreditTotalTurnovers, "
                + "\n" +            "       ad.t_Ground                                                OperationGround       "
                + "\n" +            "  FROM dacctrn_dbt            ad,"
                + "\n" +            "       drepfininstrument_vw   fi1,"
                + "\n" +            "       drepfininstrument_vw   fi2,"
                + "\n" +            "       drepaccount_vw         ac1,"
                + "\n" +            "       drepaccount_vw         ac2,"
                + "\n" +            "       (" + accountQuery + ") db,"
                + "\n" +            "       (" + accountQuery + ") cr "
                + "\n" +            " WHERE ad.t_Date_Carry >= " + GetSQLDate( m_parameters.beginDate )
                + "\n" +            "   AND ad.t_Date_Carry <= " + GetSQLDate( m_parameters.endDate   )
                + "\n" +            "   AND ad.t_state = 1                       "
                + "\n" +            "   AND INSTR(ad.t_TypeDocument, " + GetSQLString( "З" ) + ") > 0"
                + "\n" +            "   AND ad.t_AccountId_Payer    = db.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Receiver = cr.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Payer    = ac1.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Receiver = ac2.t_AccountId"
                + "\n" +            "   AND ad.t_fiid_Payer         = fi1.t_id"
                + "\n" +            "   AND ad.t_Fiid_Receiver      = fi2.t_id";

            var documentsDataSet = TRsbDataSet( allDocumentsQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
            SQL_Truncate( "da13_tmp" );
            var reportDataSetInsert = TRsbDataSet( " SELECT * FROM da13_tmp ", RSDVAL_CLIENT, RSDVAL_STATIC );

            while ( documentsDataSet.MoveNext() )
                reportDataSetInsert.AddNew();
                reportDataSetInsert.AutoKey               = documentsDataSet.AutoKey;
                reportDataSetInsert.AccountDebit          = documentsDataSet.AccountDebit;
                reportDataSetInsert.FiidAccountDebit      = documentsDataSet.FiidAccountDebit;
                reportDataSetInsert.KindAccountDebit      = documentsDataSet.KindAccountDebit;
                reportDataSetInsert.BalanceAccountDebit   = documentsDataSet.BalanceAccountDebit;
                /* Убрать приведение, когда починят DataSet, см. SCR 66395 */
                reportDataSetInsert.DebitRoubleTurnovers  = money( documentsDataSet.DebitRoubleTurnovers  );
                reportDataSetInsert.DebitCoverTurnovers   = money( documentsDataSet.DebitCoverTurnovers   );
                reportDataSetInsert.DebitTotalTurnovers   = money( documentsDataSet.DebitTotalTurnovers   );
                reportDataSetInsert.AccountCredit         = documentsDataSet.AccountCredit;
                reportDataSetInsert.FiidAccountCredit     = documentsDataSet.FiidAccountCredit;
                reportDataSetInsert.KindAccountCredit     = documentsDataSet.KindAccountCredit;
                reportDataSetInsert.BalanceAccountCredit  = documentsDataSet.BalanceAccountCredit;
                reportDataSetInsert.CreditRoubleTurnovers = money( documentsDataSet.CreditRoubleTurnovers );
                reportDataSetInsert.CreditCoverTurnovers  = money( documentsDataSet.CreditCoverTurnovers  );
                reportDataSetInsert.CreditTotalTurnovers  = money( documentsDataSet.CreditTotalTurnovers  );
                reportDataSetInsert.OperationGround       = documentsDataSet.OperationGround;
                reportDataSetInsert.Update();
            end;

        //проверка, есть ли среди счетов доходов/расходов нерублевые
            var currencyTestQuery = "SELECT *                                                                                                                                        "
                + "\n" +            "FROM da13_tmp                                                                                                                                   "
                + "\n" +            "WHERE ((" + convertMaskToSqlFormat(m_incomeAccounts + ", " + m_expenditureAccounts, "t_BalanceAccountDebit")  + ") AND t_fiidAccountDebit  <> '810')"
                + "\n" +            "   OR ((" + convertMaskToSqlFormat(m_incomeAccounts + ", " + m_expenditureAccounts, "t_BalanceAccountCredit") + ") AND t_fiidAccountCredit <> '810')";
            var currencyTest = TRsbDataSet(currencyTestQuery);

            var query1, query2, query3, query4;
            var reportDataSet1, reportDataSet2, reportDataSet3, reportDataSet4;

            if (currencyTest.MoveNext())
            //есть валютные счета
            //проводки, у которых по Кредиту счета  стоит счет доходов
                query1 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'П'"
                + "\n" + " ORDER BY t_fiidAccountCredit, t_accountCredit";
                reportDataSet1 = TRsbDataSet(query1);
            //удаляем выбранные проводки из временной таблицы
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query1 + "))");

            //проводки, у которых по Дебету счета стоит счет доходов
                query2 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'П'"
                + "\n" + " ORDER BY t_fiidAccountDebit, t_accountDebit";
                reportDataSet2 = TRsbDataSet(query2);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query2 + "))");

            //проводки, у которых по Дебету счета  стоит счет расходов
                query3 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'А'"
                + "\n" + " ORDER BY t_fiidAccountDebit, t_accountDebit";
                reportDataSet3 = TRsbDataSet(query3);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query3 + "))");

            //проводки, у которых по Кредиту счета стоит счет расходов
                query4 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'А'"
                + "\n" + " ORDER BY t_fiidAccountCredit, t_accountCredit";
                reportDataSet4 = TRsbDataSet(query4);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query4 + "))");
            else
            //все счета рублевые
            //проводки, у которых по Кредиту счета  стоит счет доходов
                query1 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'П'"
                + "\n" + " ORDER BY t_accountCredit, t_fiidAccountDebit";
                reportDataSet1 = TRsbDataSet(query1);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query1 + "))");

            //проводки, у которых по Дебету счета стоит счет доходов
                query2 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'П'"
                + "\n" + " ORDER BY t_accountDebit, t_fiidAccountCredit";
                reportDataSet2 = TRsbDataSet(query2);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query2 + "))");

            //проводки, у которых по Дебету счета  стоит счет расходов
                query3 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'А'"
                + "\n" + " ORDER BY t_accountDebit, t_fiidAccountCredit";
                reportDataSet3 = TRsbDataSet(query3);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query3 + "))");

            //проводки, у которых по Кредиту счета стоит счет расходов
                query4 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'А'"
                + "\n" + " ORDER BY t_accountCredit, t_fiidAccountDebit";
                reportDataSet4 = TRsbDataSet(query4);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query4 + "))");
            end;

        //пул источников данных
            m_dataSourcePool.push_back(reportDataSet1);
            m_dataSourcePool.push_back(reportDataSet2);
            m_dataSourcePool.push_back(reportDataSet3);
            m_dataSourcePool.push_back(reportDataSet4);

            return m_dataSourcePool;
        end;

        private macro constructorTSpodDataSources_385(parameters : object)
            initTSpodDataSources(parameters);

            m_incomeAccounts      = "707*";
            m_expenditureAccounts = "707*";
        end;

        constructorTSpodDataSources_385(parameters);
    end;

    private class (TSpodReportView_2477) TSpodReportView_385(parameters: object)
        initTSpodReportView_2477(parameters);

        macro getHeader()
            CaptureOutput();
            [ ];
            [                                                                                                                                                              Приложение 12];
            [                                                                                                                                    к Правилам ведения бухгалтерского учета];
            [                                                                                                                                    в кредитных организациях, расположенных];
            [                                                                                                                                         на территории Российской Федерации];
            [ ];
            [                                                                                                                                       (Приложение к Положению Банка России];
            [                                                                                                                                               от 16 июля 2012 года N 385-П];
            [                                                                                                                                   "О правилах ведения бухгалтерского учета];
            [                                                                                                                                    в кредитных организациях, расположенных];
            [                                                                                                                                       на территории Российской Федерации")];
            [ ];
            [###########################################################################################################################################################################] ( m_parameters.bankName:w );
            [___________________________________________________________________________________________________________________________________________________________________________];
            [ (полное или сокращенное фирменное наименование кредитной организации)];
            [ ];
            [###########################################################################################################################################################################] ("Ведомость оборотов":l);
            [###########################################################################################################################################################################] ("по отражению событий после отчетной даты":l);
            [###########################################################################################################################################################################] ( ComposePeriodString():l );
            var result = StopCaptureOutput();

            return result
        end;

        macro getTableHeader()
            var header;
            var fieldWidthAccount : integer = 25;
            var fieldWidthGround  : integer = 25;
            var fieldWidthOther   : integer = 15;
            var template = TCompositeTableField();

            var debitAccount = TTableHeaderField("номер лицевого|счета", fieldWidthAccount, STR_ALIGN_LEFT);
            var debitResRub  = TTableHeaderField("в рублях", fieldWidthOther, STR_ALIGN_RIGHT);
            var debitResCur  = TTableHeaderField("иностранная| валюта в| рублевом |эквиваленте", fieldWidthOther, STR_ALIGN_RIGHT);
            var debitTotal   = TTableHeaderField("итого", fieldWidthOther, STR_ALIGN_RIGHT);

            var debitAccountData = TTableDataField("AccountDebit",         debitAccount.width, getFormatSpecifier(debitAccount.format));
            var debitResRubData  = TTableDataField("DebitRoubleTurnovers", debitResRub.width, getFormatSpecifier(debitResRub.format));
            var debitResCurData  = TTableDataField("DebitCoverTurnovers",  debitResCur.width, getFormatSpecifier(debitResCur.format));
            var debitTotalData   = TTableDataField("DebitTotalTurnovers",  debitTotal.width, getFormatSpecifier(debitTotal.format));

            var creditAccount = TTableHeaderField("номер лицевого|счета", fieldWidthAccount, STR_ALIGN_LEFT);
            var creditResRub  = TTableHeaderField("в рублях", fieldWidthOther, STR_ALIGN_RIGHT);
            var creditResCur  = TTableHeaderField("иностранная| валюта в| рублевом |эквиваленте", fieldWidthOther, STR_ALIGN_RIGHT);
            var creditTotal   = TTableHeaderField("итого", fieldWidthOther, STR_ALIGN_RIGHT);

            var creditAccountData = TTableDataField("AccountCredit",         creditAccount.width, getFormatSpecifier(creditAccount.format));
            var creditResRubData  = TTableDataField("CreditRoubleTurnovers", creditResRub.width, getFormatSpecifier(creditResRub.format));
            var creditResCurData  = TTableDataField("CreditCoverTurnovers",  creditResCur.width, getFormatSpecifier(creditResCur.format));
            var creditTotalData   = TTableDataField("CreditTotalTurnovers",  creditTotal.width, getFormatSpecifier(creditTotal.format));

            var operationGround     = TTableHeaderField("Содержание операции", fieldWidthGround, STR_ALIGN_RIGHT);
            var operationGroundData = TTableDataField("OperationGround", operationGround.width, getFormatSpecifier(operationGround.format));

            var amountHeader1 = TCompositeTableField();
            var amountHeader2 = TCompositeTableField();

            amountHeader1.setTableField(TTableField("Обороты по дебету", null, STR_ALIGN_CENTER));
                amountHeader1.addField(debitAccount, debitAccountData);
                amountHeader1.addField(debitResRub,  debitResRubData);
                amountHeader1.addField(debitResCur,  debitResCurData);
                amountHeader1.addField(debitTotal,   debitTotalData);

            amountHeader2.setTableField(TTableField("Обороты по кредиту", null, STR_ALIGN_CENTER));
                amountHeader2.addField(creditAccount, creditAccountData);
                amountHeader2.addField(creditResRub,  creditResRubData);
                amountHeader2.addField(creditResCur,  creditResCurData);
                amountHeader2.addField(creditTotal,   creditTotalData);

            template.addField(amountHeader1);
            template.addField(amountHeader2);
            template.addField(operationGround ,operationGroundData);

            m_template = template;

            header = "";
            for (var i, template.getReportHeader(true))
                header = header + "\n" + i;
            end;
            header = substr(header, 2);

            return header;
        end;
    end;

    private macro constructorTSpodReport_385(beginDate, endDate)
        initTSpodReport_2477(beginDate, endDate);

        m_dataSource = TSpodDataSources_385(m_parameters);
        m_reportView = TSpodReportView_385(m_parameters);
    end;

    constructorTSpodReport_385(beginDate, endDate);
end;

class (TSpodReport_385)TSpodReport_3460(beginDate : Date, endDate : Date) 
    private class (TSpodDataSources_385) TSpodDataSources_3460(parameters : object)
        macro getData()            
            var accountFilter = RcbAccountFilter();
            var accountQuery =  "SELECT t_AccountId,     " +
                                "       t_Type           " +
                                "  FROM drepaccount_vw a " +
                                " WHERE " + accountFilter.GetAsSqlString("a");

            var allDocumentsQuery = "SELECT ad.t_accTrnId                                              AutoKey,              "
                + "\n" +            "       ad.t_Chapter                                               Chapter,              "
                + "\n" +            "       ad.t_Account_Payer                                         AccountDebit,         "
                + "\n" +            "       fi1.t_code                                                 FiidAccountDebit,     "
                + "\n" +            "       ac1.t_kind                                                 KindAccountDebit,     "
                + "\n" +            "       ac1.t_balance                                              BalanceAccountDebit,  "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_payer = 0 AND ad.t_Account_Payer NOT LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Payer)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        DebitRoubleTurnovers, "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_payer != 0 OR ad.t_Account_Payer LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Natcur)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        DebitCoverTurnovers,  "
                + "\n" +            "       ABS(ad.t_Sum_Natcur)                                       DebitTotalTurnovers,  "
                + "\n" +            "       ad.t_Account_Receiver                                      AccountCredit,        "
                + "\n" +            "       fi2.t_code                                                 FiidAccountCredit,    "
                + "\n" +            "       ac2.t_kind                                                 KindAccountCredit,    "
                + "\n" +            "       ac2.t_balance                                              BalanceAccountCredit, "
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_receiver = 0 AND ad.t_Account_Receiver NOT LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Receiver)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        CreditRoubleTurnovers,"
                + "\n" +            "       CASE"
                + "\n" +            "           WHEN ad.t_fiId_receiver != 0 OR ad.t_Account_Receiver LIKE '20308%'"
                + "\n" +            "           THEN ABS(ad.t_Sum_Natcur)"
                + "\n" +            "           ELSE 0"
                + "\n" +            "       END                                                        CreditCoverTurnovers, "
                + "\n" +            "       ABS(ad.t_Sum_Natcur)                                       CreditTotalTurnovers, "
                + "\n" +            "       ad.t_Ground                                                OperationGround       "
                + "\n" +            "  FROM dacctrn_dbt            ad,"
                + "\n" +            "       drepfininstrument_vw   fi1,"
                + "\n" +            "       drepfininstrument_vw   fi2,"
                + "\n" +            "       drepaccount_vw         ac1,"
                + "\n" +            "       drepaccount_vw         ac2,"
                + "\n" +            "       (" + accountQuery + ") db,"
                + "\n" +            "       (" + accountQuery + ") cr "
                + "\n" +            " WHERE ad.t_Date_Carry >= " + GetSQLDate( m_parameters.beginDate )
                + "\n" +            "   AND ad.t_Date_Carry <= " + GetSQLDate( m_parameters.endDate   )
                + "\n" +            "   AND ad.t_state = 1                       "
                + "\n" +            "   AND INSTR(ad.t_TypeDocument, " + GetSQLString( "З" ) + ") > 0"
                + "\n" +            "   AND ad.t_AccountId_Payer    = db.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Receiver = cr.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Payer    = ac1.t_AccountId"
                + "\n" +            "   AND ad.t_AccountId_Receiver = ac2.t_AccountId"
                + "\n" +            "   AND ad.t_fiid_Payer         = fi1.t_id"
                + "\n" +            "   AND ad.t_Fiid_Receiver      = fi2.t_id";

            var documentsDataSet = TRsbDataSet( allDocumentsQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
            SQL_Truncate( "da13_tmp" );
            var reportDataSetInsert = TRsbDataSet( " SELECT * FROM da13_tmp ", RSDVAL_CLIENT, RSDVAL_STATIC );

            while ( documentsDataSet.MoveNext() )
                reportDataSetInsert.AddNew();
                reportDataSetInsert.AutoKey               = documentsDataSet.AutoKey;
                reportDataSetInsert.AccountDebit          = documentsDataSet.AccountDebit;
                reportDataSetInsert.FiidAccountDebit      = documentsDataSet.FiidAccountDebit;
                reportDataSetInsert.KindAccountDebit      = documentsDataSet.KindAccountDebit;
                reportDataSetInsert.BalanceAccountDebit   = documentsDataSet.BalanceAccountDebit;
            /* Убрать приведение, когда починят DataSet, см. SCR 66395 */
                reportDataSetInsert.DebitRoubleTurnovers  = money( documentsDataSet.DebitRoubleTurnovers  );
                reportDataSetInsert.DebitCoverTurnovers   = money( documentsDataSet.DebitCoverTurnovers   );
                reportDataSetInsert.DebitTotalTurnovers   = money( documentsDataSet.DebitTotalTurnovers   );
                reportDataSetInsert.AccountCredit         = documentsDataSet.AccountCredit;
                reportDataSetInsert.FiidAccountCredit     = documentsDataSet.FiidAccountCredit;
                reportDataSetInsert.KindAccountCredit     = documentsDataSet.KindAccountCredit;
                reportDataSetInsert.BalanceAccountCredit  = documentsDataSet.BalanceAccountCredit;
                reportDataSetInsert.CreditRoubleTurnovers = money( documentsDataSet.CreditRoubleTurnovers );
                reportDataSetInsert.CreditCoverTurnovers  = money( documentsDataSet.CreditCoverTurnovers  );
                reportDataSetInsert.CreditTotalTurnovers  = money( documentsDataSet.CreditTotalTurnovers  );
                reportDataSetInsert.OperationGround       = documentsDataSet.OperationGround;
                reportDataSetInsert.Update();
            end;

            //проверка, есть ли среди счетов доходов/расходов нерублевые
            var currencyTestQuery = "SELECT *                                                                                                                                        "
                + "\n" +            "FROM da13_tmp                                                                                                                                   "
                + "\n" +            "WHERE ((" + convertMaskToSqlFormat(m_incomeAccounts + ", " + m_expenditureAccounts, "t_BalanceAccountDebit")  + ") AND t_fiidAccountDebit  <> '810')"
                + "\n" +            "   OR ((" + convertMaskToSqlFormat(m_incomeAccounts + ", " + m_expenditureAccounts, "t_BalanceAccountCredit") + ") AND t_fiidAccountCredit <> '810')";
            var currencyTest = TRsbDataSet(currencyTestQuery);

            var query1, query2, query3, query4, query5;
            var reportDataSet1, reportDataSet2, reportDataSet3, reportDataSet4, reportDataSet5;

            if (currencyTest.MoveNext())
            //есть валютные счета
            //проводки, у которых по Кредиту счета  стоит счет доходов
                query1 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'П'"
                + "\n" + " ORDER BY t_fiidAccountCredit, t_accountCredit";
                reportDataSet1 = TRsbDataSet(query1);
            //удаляем выбранные проводки из временной таблицы
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query1 + "))");

            //проводки, у которых по Дебету счета стоит счет доходов
                query2 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'П'"
                + "\n" + " ORDER BY t_fiidAccountDebit, t_accountDebit";
                reportDataSet2 = TRsbDataSet(query2);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query2 + "))");

            //проводки, у которых по Дебету счета  стоит счет расходов
                query3 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'А'"
                + "\n" + " ORDER BY t_fiidAccountDebit, t_accountDebit";
                reportDataSet3 = TRsbDataSet(query3);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query3 + "))");

            //проводки, у которых по Кредиту счета стоит счет расходов
                query4 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'А'"
                + "\n" + " ORDER BY t_fiidAccountCredit, t_accountCredit";
                reportDataSet4 = TRsbDataSet(query4);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query4 + "))");
            else
            //все счета рублевые
            //проводки, у которых по Кредиту счета  стоит счет доходов
                query1 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'П'"
                + "\n" + " ORDER BY t_accountCredit, t_fiidAccountDebit";
                reportDataSet1 = TRsbDataSet(query1);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query1 + "))");

            //проводки, у которых по Дебету счета стоит счет доходов
                query2 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'П'"
                + "\n" + " ORDER BY t_accountDebit, t_fiidAccountCredit";
                reportDataSet2 = TRsbDataSet(query2);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query2 + "))");

            //проводки, у которых по Дебету счета  стоит счет расходов
                query3 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountDebit")
                + "\n" + "   AND t_KindAccountDebit = 'А'"
                + "\n" + " ORDER BY t_accountDebit, t_fiidAccountCredit";
                reportDataSet3 = TRsbDataSet(query3);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query3 + "))");

            //проводки, у которых по Кредиту счета стоит счет расходов
                query4 = "SELECT *"
                + "\n" + "  FROM da13_tmp"
                + "\n" + " WHERE " + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountCredit")
                + "\n" + "   AND t_KindAccountCredit = 'А'"
                + "\n" + " ORDER BY t_accountCredit, t_fiidAccountDebit";
                reportDataSet4 = TRsbDataSet(query4);
                sql_execute("DELETE FROM da13_tmp"
                + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query4 + "))");
            end;

            query5 = "SELECT *"
            + "\n" + "  FROM da13_tmp"
            + "\n" + " WHERE NOT(" + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountCredit") + "   AND t_KindAccountCredit = 'П')"
            + "\n" + "AND NOT(" + convertMaskToSqlFormat(m_incomeAccounts, "t_BalanceAccountDebit") + "   AND t_KindAccountDebit = 'П')"
            + "\n" + "AND NOT(" + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountDebit") + "   AND t_KindAccountDebit = 'А')"
            + "\n" + "AND NOT(" + convertMaskToSqlFormat(m_expenditureAccounts, "t_BalanceAccountCredit") + "   AND t_KindAccountCredit = 'А')"
            + "\n" + " ORDER BY t_accountDebit";
            reportDataSet5 = TRsbDataSet(query5);
            sql_execute("DELETE FROM da13_tmp"
            + "\n" + "    WHERE t_autokey IN (SELECT t_autokey FROM (" + query5 + "))");

         //пул источников данных
            m_dataSourcePool.push_back(reportDataSet1);
            m_dataSourcePool.push_back(reportDataSet2);
            m_dataSourcePool.push_back(reportDataSet3);
            m_dataSourcePool.push_back(reportDataSet4);
            m_dataSourcePool.push_back(reportDataSet5);

            return m_dataSourcePool;
        end;

        private macro constructorTSpodDataSources_3460(parameters : object)
            initTSpodDataSources_385(parameters);

            m_incomeAccounts      = "706*, 707*, 10601*, 10609*";
            m_expenditureAccounts = "706*, 707*, 10610*";
        end;

        constructorTSpodDataSources_3460(parameters);
    end;

    private macro constructorTSpodReport_3460(beginDate, endDate)
        initTSpodReport_385(beginDate, endDate);

        m_dataSource = TSpodDataSources_3460(m_parameters);
    end;

    constructorTSpodReport_3460(beginDate, endDate);
end;

class (TSpodReport_3460)TSpodReport_579(beginDate : Date, endDate : Date)   
    private class (TSpodReportView_385) TSpodReportView_579(parameters: object)
        initTSpodReportView_385(parameters);

        macro getHeader()
            CaptureOutput();
            [ ];
            [                                                                                                                                                              Приложение 10];
            [                                                                                                                                     к приложению к Положению Банка России ];
            [                                                                                                                                     от 27 февраля 2017 года N 579-П       ];
            [                                                                                                                                     "О плане счетов бухгалтерского учета  ];
            [                                                                                                                                     в кредитных организациях и порядке его];
            [                                                                                                                                     применения"                           ];
            [ ];
            [###########################################################################################################################################################################] ( m_parameters.bankName:w );
            [___________________________________________________________________________________________________________________________________________________________________________];
            [ (полное или сокращенное фирменное наименование кредитной организации)];
            [ ];
            [############################################################################################################################################################################] ("Группировка счетов бухгалтерского учета":l);
            [############################################################################################################################################################################] ("для составления ведомости оборотов":l);
            [############################################################################################################################################################################] ("по отражению событий после отчетной даты":l);
            [############################################################################################################################################################################] ( ComposePeriodString():l );
            var result = StopCaptureOutput();

            return result
        end;
    end;

    private macro constructorTSpodReport_579(beginDate, endDate)
        initTSpodReport_3460(beginDate, endDate);

        m_reportView = TSpodReportView_579(m_parameters);
    end;

    constructorTSpodReport_579(beginDate, endDate);
end;


macro getCurrentReport(isExcel : bool)
    var report;

    if (ДатаОтчета >= RCB_I579_DATE)
        report = TSpodReport_579(ПредДатаОтчета, ДатаОтчета);
    elif (ДатаОтчета >= RCB_I3460_DATE)
        report = TSpodReport_3460(ПредДатаОтчета, ДатаОтчета);
    elif (ДатаОтчета >= RCB_I385_DATE)
        report = TSpodReport_385(ПредДатаОтчета, ДатаОтчета);
    elif(ДатаОтчета >= RCB_I2477_DATE1)
        report = TSpodReport_2477(ПредДатаОтчета, ДатаОтчета);
    elif (ДатаОтчета >= RCB_I302_DATE1)
        report = TSpodReport_302(ПредДатаОтчета, ДатаОтчета);
    else
        report = TSpodReport(ПредДатаОтчета, ДатаОтчета);
    end;

    return report;
end;

/* Точки входа в макропрограмму */
macro executePrintText()
    getCurrentReport().printPlainText();
end;

macro executePrintExcel()
    getCurrentReport().printExcel();
    установитьФлагВозврата(OK_MACRO_FLAG);
    exit(1);
end;