/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 664.

  Создан: 09.08.2010 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import calc_f664_b1747u; // calc_f664_b1747u.mac
import rcbTuneTable;

/**
 *  Класс нужен исключительно для того, чтоб была возможность получить сформированный источник данных
 */
class (TDataSource) TDataSourceRestsProvider_I2470(parameters : TParameters)

    initTDataSource(BONothing, parameters, TRestsTempTable());

    macro getDataSource()
        var dataSource;
        var query = "";

        var currencyClause = ternary(getParameters().getReportIssue() == 12,
                                     "\n" + "   AND rests.t_currencyId != " + NATCUR,
                                     "");

        query =          "SELECT fi.t_iso_number          t_currencyCode,"
                + "\n" + "       SUM(rests.t_restIn)      t_restIn,"
                + "\n" + "       SUM(rests.t_restOut)     t_restOut"
                + "\n" + "  FROM " + getTempTable().getTableName() + " rests,"
                + "\n" + "       dfininstr_dbt fi"
                + "\n" + " WHERE fi.t_fiId = rests.t_currencyId" + currencyClause
                + "\n" + "   AND rests.t_reportIssue = " + getParameters().getReportIssue()
                + "\n" + "   AND rests.t_accountKind = " + getSqlString(getParameters().getAccountKind())
                + "\n" + "GROUP BY fi.t_iso_number"
                + "\n" + "ORDER BY t_currencyCode"
                + "\n";

        dataSource = TRsbDataSet(query);
        dataSource.setFieldType("t_restIn",  V_MONEY);
        dataSource.setFieldType("t_restOut", V_MONEY);

        return dataSource;
    end;
end;

/**
 *  Класс нужен исключительно для того, чтоб была возможность получить сформированный источник данных
 */
class (TDataSource) TDataSourceTurnsByOperKindProvider(parameters : TParameters)

    initTDataSource(BONothing, parameters, TTurnsTempTable());

    macro getDataSource()
        var dataSource;
        var query = "";

        query =          "SELECT            t_operationCode,"
                + "\n" + "                  t_currencyCode,"
                + "\n" + "       SUM(t_sum) t_sum,"
                + "\n" + "                  t_directionCode"
                + "\n" + "  FROM " + getTempTable().getTableName()
                + "\n" + " WHERE t_reportIssue = " + getParameters().getReportIssue()
                + "\n" + "   AND t_accountKind = " + getSqlString(getParameters().getAccountKind())
                + "\n" + "GROUP BY t_currencyCode, t_directionCode, t_operationCode"
                + "\n" + "ORDER BY t_currencyCode, t_directionCode, t_operationCode"
                + "\n";

        dataSource = TRsbDataSet(query);
        dataSource.setFieldType("t_sum", V_MONEY);

        return dataSource;
    end;
end;

/**
 *  Класс нужен исключительно для того, чтоб была возможность получить сформированный источник данных
 */
class (TDataSource) TDataSourceTurnsByCountryProvider(parameters : TParameters)

    initTDataSource(BONothing, parameters, TTurnsTempTable());

    macro getDataSource()
        var dataSource;
        var query = "";

        query =          "SELECT t_countryCode   t_countryCode,"
                + "\n" + "       t_countryName   t_countryName,"
                + "\n" + "       t_currencyCode  t_currencyCode,"
                + "\n" + "       t_operationCode t_operationCode,"
                + "\n" + "       SUM(t_sum)      t_sum,"
                + "\n" + "       t_directionCode t_directionCode"
                + "\n" + "  FROM " + getTempTable().getTableName()
                + "\n" + " WHERE t_reportIssue = " + getParameters().getReportIssue()
                + "\n" + "   AND t_accountKind = " + getSqlString(getParameters().getAccountKind())
                + "\n" + "   AND t_countryCode != " + getSqlString("")
                + "\n" + "GROUP BY t_countryCode, t_countryName, t_directionCode, t_currencyCode, t_operationCode"
                + "\n" + "ORDER BY t_countryCode, t_countryName, t_directionCode, t_currencyCode, t_operationCode"
                + "\n";

        dataSource = TRsbDataSet(query);
        dataSource.setFieldType("t_sum", V_MONEY);

        return dataSource;
    end;
end;

/**
 *  Источник данных для оборотов ГКБО.
 */
class (TDataSourceCb) TDataSourceCbTurns(parameters : TParameters, restsTempTable : Object, dataSourceName : String)

    private var m_dataSourceName = dataSourceName;

    private var m_restsTempTable = restsTempTable;

    private var paymentFiAlias = "pmcurtr.t_fiid";

    private var currencyClause = "1 = 1";

    private var turnCurrencyIdAlias = "turnData.t_currencyId";

    private var turnOperCodeAlias = "turnData.t_operationCode";

    private var operCodeFiClause = "1 = 1";

    private macro makeDataQuery()

        var dateIn  = getParameters().getBeginDate(),
            dateOut = getParameters().getEndDate();

        var reportIssue = getParameters().getReportIssue();

        var accountKind = getSqlString(getParameters().getAccountKind());

        var countryCodeClause = "NULL";
        var countryNameClause = "NULL";

        var query = "";

        if (reportIssue == 12) // страна банка плательщика/получателя

            countryCodeClause =
                             "        NVL((CASE"
                    + "\n" + "                 WHEN tmp.t_accountNumber = doc.t_account_payer"
                    + "\n" + "                 THEN (SELECT DECODE(pmcurtr.t_receiverBankCountry,"
                    + "\n" + "                                     CHR(1), '999',"
                    + "\n" + "                                     pmcurtr.t_receiverBankCountry"
                    + "\n" + "                                    )"
                    + "\n" + "                         FROM dpmcurtr_dbt pmcurtr"
                    + "\n" + "                        WHERE pmcurtr.t_paymentId = pmdoc.t_paymentId"
                    + "\n" + "                      )"
                    + "\n" + "                 ELSE (SELECT DECODE(pmcurtr.t_payerBankCountry,"
                    + "\n" + "                                     CHR(1), '999',"
                    + "\n" + "                                     pmcurtr.t_payerBankCountry"
                    + "\n" + "                                    )"
                    + "\n" + "                         FROM dpmcurtr_dbt pmcurtr"
                    + "\n" + "                        WHERE pmcurtr.t_paymentId = pmdoc.t_paymentId"
                    + "\n" + "                      )"
                    + "\n" + "             END), '999'"
                    + "\n" + "           )";

            countryNameClause =
                             "        CASE"
                    + "\n" + "            WHEN documentData.t_countryCode = '999'"
                    + "\n" + "            THEN '-'"
                    + "\n" + "            ELSE (SELECT country.t_fullName"
                    + "\n" + "                        FROM dcountry_dbt country"
                    + "\n" + "                       WHERE country.t_codeLat3 = documentData.t_countryCode"
                    + "\n" + "                 )"
                    + "\n" + "        END";

        elif (reportIssue == 34) // нерезидента

            countryCodeClause =
                             "        CASE"
                    + "\n" + "            WHEN UPPER(rcb_objattr.getObjAttr(" + OBJTYPE_PARTY + ","
                    + "\n" + "                                              32,"
                    + "\n" + "                                              rcb_objattr.makePartyId(tmp.t_contragentId),"
                    + "\n" + "                                              " + getSqlDate(dateOut)
                    + "\n" + "                                             )"
                    + "\n" + "                      ) = '1'"
                    + "\n" + "            THEN '998'"
                    + "\n" + "            ELSE (SELECT DECODE(party.t_nrCountry, CHR(1), DECODE(party.t_legalForm, 1, '!997', '!999'), party.t_nrCountry)"
                    + "\n" + "                    FROM dparty_dbt party"
                    + "\n" + "                   WHERE party.t_partyId = tmp.t_contragentId"
                    + "\n" + "                 )"
                    + "\n" + "        END";

            countryNameClause =
                             "        CASE"
                    + "\n" + "            WHEN documentData.t_countryCode IN ('997', '998', '999', '!997', '!999')"
                    + "\n" + "            THEN 'страна не определена'"
                    + "\n" + "            ELSE (SELECT country.t_fullName"
                    + "\n" + "                    FROM dcountry_dbt country"
                    + "\n" + "                   WHERE country.t_codeLat3 = documentData.t_countryCode"
                    + "\n" + "                 )"
                    + "\n" + "        END";

        end;

        query =          "WITH turnData AS"
                + "\n" + "(SELECT documentData.*,"
                + "\n" + "    " + countryNameClause + " t_countryName,"
                + "\n" + "        fi.t_iso_number       t_currencyCode"
                + "\n" + "   FROM dfininstr_dbt fi,"
                + "\n" + "        (SELECT tmp.t_accountNumber                          t_accountNumber,"
                + "\n" + "                tmp.t_chapterNumber                          t_chapterNumber,"
                + "\n" + "                NVL((SELECT pmcurtr.t_fiId"
                + "\n" + "                       FROM dpmcurtr_dbt pmcurtr"
                + "\n" + "                      WHERE pmcurtr.t_paymentId = pmdoc.t_paymentId"
                + "\n" + "                        AND " + currencyClause
                + "\n" + "                    ), tmp.t_currencyId"
                + "\n" + "                   )                                         t_currencyId,"
                + "\n" + "                NVL(pmco.t_amount, doc.t_sum_payer)          t_sum,"
                + "\n" + "                doc.t_date_carry                             t_dateCarry,"
                + "\n" + "                doc.t_account_payer                          t_accountPayer,"
                + "\n" + "                doc.t_account_receiver                       t_accountReceiver,"
                + "\n" + "                doc.t_numb_document                          t_numberDocument,"
                + "\n" + "                pmdoc.t_paymentId                            t_paymentId,"
                + "\n" + "                CASE"
                + "\n" + "                    WHEN tmp.t_accountNumber = doc.t_account_payer"
                + "\n" + "                        THEN " + getSqlString(DEBIT)
                + "\n" + "                    ELSE " + getSqlString(CREDIT)
                + "\n" + "                END                                          t_directionCode,"
                + "\n" + "                (SELECT llvalues.t_code"
                + "\n" + "                   FROM dllvalues_dbt llvalues"
                + "\n" + "                  WHERE llvalues.t_list = " + RCB_OBJTYPE_PURPOSE117
                + "\n" + "                    AND llvalues.t_element = pmco.t_vo_code"
                + "\n" + "                )                                            t_operationCode,"
                + "\n" + "            " + countryCodeClause + "                        t_countryCode,"
                + "\n" + "                tmp.t_contragentId                           t_clientCodeAndName,"
                + "\n" + "                doc.t_accTrnId                               t_autokey"
                + "\n" + "           FROM " + m_dataSourceName + " doc,"
                + "\n" + "                " + m_restsTempTable.getTableName() + " tmp,"
                + "\n" + "                dpmdocs_dbt pmdoc,"
                + "\n" + "                dpmco_dbt pmco"
                + "\n" + "          WHERE (   (    tmp.t_accountNumber = doc.t_account_payer"
                + "\n" + "                     AND tmp.t_currencyId = doc.t_fiId_payer"
                + "\n" + "                    )"
                + "\n" + "                 OR (    tmp.t_accountNumber = doc.t_account_receiver"
                + "\n" + "                     AND tmp.t_currencyId = doc.t_fiId_receiver"
                + "\n" + "                    )"
                + "\n" + "                )"
                + "\n" + "            AND doc.t_state = 1"
                + "\n" + "            AND tmp.t_chapterNumber = doc.t_chapter"
                + "\n" + "            AND tmp.t_reportIssue = " + reportIssue
                + "\n" + "            AND tmp.t_accountKind = " + accountKind
                + "\n" + "            AND doc.t_date_carry BETWEEN " + getSqlDate(dateIn) + " AND " + getSqlDate(dateOut)
// 01.10.2010 ABP Большой вопрос: можно ли работать только с проводками, которые связаны с платежами через dpmdocs_dbt
//                Есть ведь вероятность связи через doprdocs_dbt... Хотя наличие такой связи зависит от кривости рук внедренцев.
                + "\n" + "            AND pmdoc.t_accTrnId = doc.t_accTrnId"
                                      // данные по КВО валютной операции 1-n(0)
                + "\n" + "            AND pmco.t_paymentId(+) = pmdoc.t_paymentId"
                + "\n" + "        ) documentData"
                + "\n" + "  WHERE documentData.t_currencyId = fi.t_fiId"
                + "\n" + ")"
                + "\n" + "SELECT turnData.t_currencyCode                                                            t_currencyCode,"
                + "\n" + "       turnData.t_sum                                                                     t_sum,"
                + "\n" + "       turnData.t_dateCarry                                                               t_dateCarry,"
                + "\n" + "       turnData.t_accountPayer                                                            t_accountPayer,"
                + "\n" + "       turnData.t_accountReceiver                                                         t_accountReceiver,"
                + "\n" + "       turnData.t_numberDocument                                                          t_numberDocument,"
                + "\n" + "       turnData.t_directionCode                                                           t_directionCode,"
                + "\n" + "       CASE WHEN (   turnData.t_operationCode IS NULL"
                + "\n" + "                  OR rcb_f664.isValidOperationCode(turnData.t_operationCode) = 0) THEN"
                + "\n" + "               '00000'"
                + "\n" + "           ELSE"
                + "\n" + "              turnData.t_operationCode"
                + "\n" + "       END                                                                                t_operationCode,"
                + "\n" + "       NVL2(turnData.t_countryCode, SUBSTR(turnData.t_countryCode, -3, 3), CHR(1))        t_countryCode,"
                + "\n" + "       NVL(turnData.t_countryName, 'название страны не найдено')                          t_countryName,"
                + "\n" + "       turnData.t_clientCodeAndName                                                       t_clientCodeAndName,"
                + "\n" + "   " + reportIssue + "                                                                    t_reportIssue,"
                + "\n" + "   " + accountKind + "                                                                    t_accountKind,"
                + "\n" + "   " + getBackOffice() + "                                                                t_backOffice,"
                + "\n" + "       turnData.t_accountNumber                                                           t_accountNumber,"
                + "\n" + "       turnData.t_chapterNumber                                                           t_chapterNumber,"
                + "\n" + "       CASE"
                + "\n" + "           WHEN    turnData.t_countryCode IS NULL"
                + "\n" + "                OR turnData.t_countryCode IN ('!997', '!999')"
                + "\n" + "           THEN 1"
                + "\n" + "           ELSE 0"
                + "\n" + "       END                                                                                t_isWrongPayment"
                + "\n" + "  FROM turnData"
                + "\n" + " WHERE turnData.t_operationCode != " + getSqlString("")
                + "\n" + "   AND (" + operCodeFiClause + ")";

        return query;
    end;

    initTDataSourceCb(parameters, TTurnsTempTable());
end;
