/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank V6                                                                        R-Style Softlab
  ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì"

  ¥ç âì ¯à®â®ª®«  à áç¥â  ¨ ä®à¬ë 664.  §¤¥« 1

  ‘®§¤ ­: 09.08.2010 - Shestakov Dmitry
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import print_f664_b2470u; // print_f664_b2470u.mac

import testLib;

/**
 *  Š®­áâ ­âë
 */
private const DEBIT  = "0";
private const CREDIT = "1";

/**
 * Š« áá ¯à®â®ª®« .
 */
class (TProtocol) TProtocolIssue1()

    private var m_operationOverall;
    private var m_directionOverall;

    private var m_currentOperation;
    private var m_currentDirection;
    private var m_currentCurrency;

    private var m_parameters;

    private var m_mainTableWidth;
    private var m_accountsTableWidth;

    macro isEmptyIssue()

        var query =      "SELECT NULL"
                + "\n" + "  FROM dual"
                + "\n" + " WHERE EXISTS("
                + "\n" + "              SELECT NULL"
                + "\n" + "                FROM " + TTurnsTempTable().getTableName() + " turns"
                + "\n" + "               WHERE turns.t_reportIssue = " + m_parameters.getReportIssue()
                + "\n" + "             )"
                + "\n" + "    OR EXISTS("
                + "\n" + "              SELECT NULL"
                + "\n" + "                FROM " + TRestsTempTable().getTableName() + " rests"
                + "\n" + "               WHERE rests.t_reportIssue = " + m_parameters.getReportIssue()
                + "\n" + "             )";

        return (not TRsbDataSet(query).next());

    end;

    private macro constructorTProtocolIssue1()

        m_operationOverall = $0;
        m_directionOverall = $0;

        m_currentOperation = "";
        m_currentDirection = "";
        m_currentCurrency  = "";

        m_parameters = TParameters("", "", 12);

        m_mainTableWidth     = 110;
        m_accountsTableWidth = 77;

        initTProtocol();

    end;

    private macro addIssueHeader()

        println();
        println();
        println("€‡„…‹ 1");
        println();

    end;

    private macro addCurrencyHeader(currency)

        defaultParm(currency, "«î¡ ï");

        println("‚ «îâ  áç¥â : ", currency);

        println("ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄ¿");
        println("³    Š®¤   ³     ‘ã¬¬  ¢ ¢ «îâ¥   ³   „ â    ³        ‘ç¥â ¯® ¤¥¡¥âã     ³      ‘ç¥â ¯® ªà¥¤¨âã      ³ ü ¤®ª ³");
        println("³ ®¯¥à æ¨¨ ³          áç¥â        ³   ¤®ª    ³                           ³                           ³       ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÙ");

        m_currentCurrency = currency;

        m_currentDirection = "";

    end;

    private macro addCurrencyFooter()

//        println();

    end;

    private macro addDirectionHeader(directionCode)

        var directionStr;

        if (directionCode == DEBIT)
            directionStr = "‘¯¨á ­¨¥";
        else
            directionStr = "‡ ç¨á«¥­¨¥";
        end;

        [ ########## ](directionStr:l);

        m_directionOverall = $0;

        m_currentDirection = directionCode;

        m_currentOperation = "";

    end;

    private macro addDirectionFooter()

        var directionStr;

        if (m_currentDirection == DEBIT)
            directionStr = "‚‘…ƒ ‘ˆ‘";
        else
            directionStr = "‚‘…ƒ ‡€—";
        end;

        [ ########## #####################  ](directionStr:l, m_directionOverall);

        println();

    end;

    private macro addOperationHeader(operationCode)

        m_currentOperation = operationCode;

        m_operationOverall = $0;

    end;

    private macro addOperationFooter()

        [ ########## #####################  ]("ˆ’ƒ":r, m_operationOverall);

    end;

    private macro addAccountsWithoutTurns()

        var isExistsAccounts = false;

        var beginDate = getSqlDate(RcbApplication().currentReport.context.period.beginDate),
            endDate   = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var query =          "SELECT rests.t_accountNumber t_accountNumber,"
                    + "\n" + "       rests.t_restIn        t_restIn,"
                    + "\n" + "       rests.t_restOut       t_restOut"
                    + "\n" + "  FROM " + TRestsTempTable().getTableName() + " rests"
                    + "\n" + " WHERE (rests.t_restIn != 0 OR rests.t_restOut != 0)"
                    + "\n" + "   AND rests.t_reportIssue = " + m_parameters.getReportIssue()
                    + "\n" + "   AND NOT EXISTS (SELECT 1 FROM dacctrn_dbt doc"
                    + "\n" + "                    WHERE (   (    rests.t_accountNumber = doc.t_account_payer"
                    + "\n" + "                               AND rests.t_currencyId = doc.t_fiId_payer"
                    + "\n" + "                              )"
                    + "\n" + "                           OR (    rests.t_accountNumber = doc.t_account_receiver"
                    + "\n" + "                               AND rests.t_currencyId = doc.t_fiId_receiver"
                    + "\n" + "                              )"
                    + "\n" + "                          )"
                    + "\n" + "                      AND doc.t_state = 1"
                    + "\n" + "                      AND rests.t_chapterNumber = doc.t_chapter"
                    + "\n" + "                      AND doc.t_date_carry BETWEEN " + beginDate + " AND " + endDate
                    + "\n" + "                  )"
                    + "\n" + " ORDER BY t_accountNumber";

        var dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_restIn",  V_MONEY);
        dataSource.setFieldType("t_restOut", V_MONEY);

        println();

        println("‹¨æ¥¢ë¥ áç¥â , ¯® ª®â®àë¬ ¢ ®âç¥â­ë© ¯¥à¨®¤ ­¥ ¡ë«® ®¡®à®â®¢, ­® ¡ë«¨ ®áâ âª¨:");
        println("ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
        println("³       ®¬¥à «/á           ³   áâ â®ª ­  ­ ç «®   ³   áâ â®ª ­  ª®­¥æ    ³");
        println("³                           ³        ¯¥à¨®¤         ³        ¯¥à¨®¤         ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

        while (dataSource.next())

            isExistsAccounts = true;

            [  #########################   #####################   ###################### ]
            (  dataSource.accountNumber,   dataSource.restIn,      dataSource.restOut);

        end;

        if (not isExistsAccounts)

            println(strAlign("¥â ¤ ­­ëå", m_accountsTableWidth, STR_ALIGN_CENTER));
            println();

        end;

    end;

    macro addTurns()

        var isContinue;

        var isExistsTurns = false;

        var dataSource;

        var operationCode;

        var query = "";

        query =          "SELECT t_iso_number || ' ' || t_name t_currency,"
                + "\n" + "       turns.t_operationCode                  t_operationCode,"
                + "\n" + "       turns.t_sum                            t_sum,"
                + "\n" + "       turns.t_dateCarry                      t_dateCarry,"
                + "\n" + "       turns.t_accountPayer                   t_accountPayer,"
                + "\n" + "       turns.t_accountReceiver                t_accountReceiver,"
                + "\n" + "       turns.t_numberDocument                 t_numberDocument,"
                + "\n" + "       turns.t_directionCode                  t_directionCode"
                + "\n" + "  FROM " + TTurnsTempTable().getTableName() + " turns,"
                + "\n" + "       dfininstr_dbt fi"
                + "\n" + " WHERE fi.t_iso_number = turns.t_currencyCode"
                + "\n" + "   AND turns.t_reportIssue = " + m_parameters.getReportIssue()
                + "\n" + "ORDER BY t_currency, t_directionCode, t_operationCode, t_accountPayer, t_accountReceiver, t_dateCarry, t_sum";

        dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_sum",       V_MONEY);
        dataSource.setFieldType("t_dateCarry", V_DATE);

        isContinue = dataSource.next();

        addCurrencyHeader(dataSource.currency);

        if (not isContinue)

            println(strAlign("¥â ¤ ­­ëå", m_mainTableWidth, STR_ALIGN_CENTER));
            println();

        end;

        while (isContinue)

            isExistsTurns = true;

            operationCode = "";

            if (dataSource.currency != m_currentCurrency)

                if (m_currentCurrency != "")
                    addOperationFooter();
                    addDirectionFooter();
                    addCurrencyFooter();
                end;

                addCurrencyHeader(dataSource.currency);
                addDirectionHeader(dataSource.directionCode);
                addOperationHeader(dataSource.operationCode);

                operationCode = dataSource.operationCode;

            end;

            if (dataSource.directionCode != m_currentDirection)

                if (m_currentDirection != "")
                    addOperationFooter();
                    addDirectionFooter();
                end;

                addDirectionHeader(dataSource.directionCode);
                addOperationHeader(dataSource.operationCode);

                operationCode = dataSource.operationCode;

            end;

            if (dataSource.operationCode != m_currentOperation)

                if (m_currentOperation != "")
                    addOperationFooter();
                end;

                addOperationHeader(dataSource.operationCode);

                operationCode = dataSource.operationCode;

            end;

            [ ########## #####################  ##########  #########################   #########################   ##### ]
            (operationCode:r,
                         dataSource.sum,
                                                dataSource.dateCarry:f,
                                                            dataSource.accountPayer,    dataSource.accountReceiver,
                                                                                                                    dataSource.numberDocument:l);

            m_operationOverall = m_operationOverall + dataSource.sum;
            m_directionOverall = m_directionOverall + dataSource.sum;

            isContinue = dataSource.next();

        end;

        if (isExistsTurns)

            addOperationFooter();
            addDirectionFooter();
            addCurrencyFooter();

        end;

    end;

    macro print()

        var profiler = TSQLProfiler(getTxtFileName("!print_f664i1_b2470u_p_sqlprofile"));
        profiler.clear();
        profiler.on();

        switchOutput();

        addIssueHeader();

        if (isEmptyIssue())
            println("¥â ¤ ­­ëå");
        else

            addTurns();
            addAccountsWithoutTurns();

        end;

        switchOutput();

    end;

    constructorTProtocolIssue1();
end;

/**
 * Š« áá ¯¥ç â­®© ä®à¬ë à §¤¥«  ¯® 2470-“
 */
class (TIssue1Issue2PrintableForm664) TIssue1PrintableForm664_I2470(rootAttributeName : String)

    macro addHeader()
        var isEmptyReport = strAlign(ternary(IsEmpty(), "0", " "), 5, STR_ALIGN_CENTER);
        var title = strTransferByWord(" §¤¥« 1. ‘âàãªâãà  ®¯¥à æ¨©, ®áãé¥áâ¢«ï¥¬ëå ¯® à áç¥â­ë¬ áç¥â ¬ à¥§¨¤¥­â®¢, ¯® ¢¨¤ ¬ ®¯¥à æ¨©", getWidth(), STR_ALIGN_CENTER);

        switchOutput();

        println(strAlign(                                            "ÚÄÄÄÄÄ¿",                 getWidth(), STR_ALIGN_RIGHT));
        println(strAlign("à¨§­ ª ®âáãâáâ¢¨ï ¤ ­­ëå ¯®  §¤¥« ¬ 1 ¨ 2 ³" + isEmptyReport + "³", getWidth(), STR_ALIGN_RIGHT));
        println(strAlign(                                            "ÀÄÄÄÄÄÙ",                 getWidth(), STR_ALIGN_RIGHT));
        println();
        var i = 0;
        while (i < title.size)
            println(strAlign(title[i], getWidth(), STR_ALIGN_CENTER));
            i = i + 1;
        end;

        switchOutput();
    end;

    macro getDimentionTitle()
        return ternary(m_isCurrency, "âëáïç ¥¤¨­¨æ ¢ «îâë", "¢ âëáïç å àã¡«¥©");
    end;

    macro getEmptyRestSymbol()
        return strAlign("X", 35, STR_ALIGN_CENTER);
    end;

    private macro constructorTIssue1PrintableForm664_I2470(rootAttributeName)
        initTIssue1Issue2PrintableForm664(rootAttributeName, true);
    end;

    constructorTIssue1PrintableForm664_I2470(rootAttributeName);

end;
