/*
$Name:          calc_f634ln.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 634. Получение данных по Loans
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 634. Loans

  Создан: 31.07.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

import testLib;

import calc_f634com;
import sbCrdInter;

/**
 *  Параметры расчета по Loans
 */
private class (TParameters) TParametersLn(report : Object)

    private macro constructorTParametersLn(report : Object)

        initTParameters(report);

    end;

    constructorTParametersLn(report);

end;

/**
 *  Класс построения текста SQL-запроса для источника данных Loans
 */
private class TDataSourceLnQueryTextMaker(parameters : TParametersLn)

    private var m_parameters : TParameters;

    private var m_reportDate : String;

//    private var m_departmentFilterClause : String;

    private macro getParameters()
        return m_parameters;
    end;

    // Выданные гарантии и поручительства для расчета VVV_Гар_К_
    private macro getQueryText_f634guarantyissued()
        return   "SELECT contract.t_branchId                                                                                 AS T_BRANCHID,"
        + "\n" + "       contract.t_id                                                                                       AS T_CONTRACTID,"
        + "\n" + "       contract.t_number                                                                                   AS T_CONTRACTNUMBER,"
        + "\n" + "       register.t_currencyId                                                                               AS T_FIID,"
        + "\n" + "       NULL                                                                                                AS T_SECUREDAMOUNT,"
        + "\n" + "       0                                                                                                   AS T_RESERVEAMOUNT,"
        + "\n" + "       0                                                                                                   AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       SUM(NVL(register.t_rest, 0))                                                                        AS T_REGISTERREST,"
        + "\n" + "       SUM(NVL(register.t_rest, 0))                                                                        AS T_VALUE,"
        + "\n" + "       SUM(NVL(rsb_fiinstr.convSumType(register.t_rest, register.t_currencyId, 0," + RATETYPE_CB + "," + m_reportDate + "), 0)) AS T_ROUBLEVALUE,"
        + "\n" + "       register.t_type                                                                                     AS T_REGISTERTYPE,"
        + "\n" + "       contract.t_fiId                                                                                     AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                                                                AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                                                                AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                                                                AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_gar_k()) + "                                                  AS T_USEDBYPOSITION,"
        + "\n" + "       TO_CHAR(contract.t_id) || TO_CHAR(register.t_type) || TO_CHAR(register.t_currencyId)                AS T_KEY"
        + "\n" + "  FROM F634REGISTER_VW register,"
        + "\n" + "       REPLNSTRANCHES_VW tranche,"
        + "\n" + "       F634CONTRACT_VW contract"
        + "\n" + " WHERE contract.t_isOpenedAtEndDate = 1"
        + "\n" + "   AND contract.t_type = " + LO_GUARANTEE
        + "\n" + "   AND contract.t_guarantType = 1"
        + "\n" + "   AND contract.t_rvpQualityCategory IN (4, 5)"
        + "\n" + "   AND tranche.t_contractId = contract.t_id"
        + "\n" + "   AND register.t_type = 55"
        + "\n" + "   AND register.t_currencyId != 0"
        + "\n" + "   AND register.t_trancheKind = tranche.t_kind"
        + "\n" + "   AND register.t_trancheNumber = tranche.t_number"
        + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + " GROUP BY contract.t_branchId,"
        + "\n" + "          contract.t_id,"
        + "\n" + "          contract.t_number,"
        + "\n" + "          register.t_currencyId,"
        + "\n" + "          register.t_type,"
        + "\n" + "          contract.t_fiId";
    end;

    // Полученные гарантии и поручительства для расчета VVV_ГарантииПолуч_К_
    private macro getQueryText_f634guarantyreceived()
        return   "WITH reserve AS"
        + "\n" + "("
        + "\n" + " SELECT /*+ MATERIALIZE*/"
        + "\n" + "        contractData.t_reserveAmount        AS t_sum,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleSum,"
        + "\n" + "        contractData.t_reserveAmount        AS t_reserveAmount,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleReserveAmount,"
        + "\n" + "        contractData.t_currencyId           AS t_currencyId,"
        + "\n" + "        contractData.t_contractId           AS t_contractId"
        + "\n" + "   FROM (SELECT CASE"
        + "\n" + "                    WHEN contract.t_briefCaseId IS NULL"
        + "\n" + "                      OR contract.t_briefCaseId = 0"
        + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(contract.t_rvpsSum,"
        + "\n" + "                                                     0,"
        + "\n" + "                                                     guaranty.t_currencyId,"
        + "\n" + "                                                 " + RATETYPE_CB + ","
        + "\n" + "                                                     rcb_f634.getRegisterChangeDate(contract.t_id, 10)"
        + "\n" + "                                                    ), 0"
        + "\n" + "                            )"
        + "\n" + "                       + NVL(rsb_fiinstr.convSumType(contract.t_delayedRvpsSum,"
        + "\n" + "                                                     0,"
        + "\n" + "                                                     guaranty.t_currencyId,"
        + "\n" + "                                                 " + RATETYPE_CB + ","
        + "\n" + "                                                     rcb_f634.getRegisterChangeDate(contract.t_id, 11)"
        + "\n" + "                                                    ), 0"
        + "\n" + "                            )"
        + "\n" + "                    ELSE NVL(rsb_fiinstr.convSumType(NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0),"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                            FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                           WHERE portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "                                                         )"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                END                                                             AS t_reserveAmount,"
        + "\n" + "                NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0)  AS t_roubleReserveAmount,"
        + "\n" + "                guaranty.t_currencyId                                           AS t_currencyId,"
        + "\n" + "                contract.t_id                                                   AS t_contractId"
        + "\n" + "           FROM F634CONTRACT_VW contract,"
        + "\n" + "                DF634GUARANTY_TMP guaranty"
        + "\n" + "          WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "            AND guaranty.t_isGuarantee = 1"
        + "\n" + "            AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "            AND contract.t_type != " + LO_DEPOSIT
        + "\n" + "            AND contract.t_fiId != 0"
        + "\n" + "            AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "        ) contractData"
        + "\n" + "),"
        + "\n" + "register AS"
        + "\n" + "("
        + "\n" + " SELECT SUM(rsb_fiinstr.convSumType(rsb_fiinstr.convSumType(register.t_rest,"
        + "\n" + "                                                            register.t_currencyId,"
        + "\n" + "                                                            0,"
        + "\n" + "                                                        " + RATETYPE_CB + ","
        + "\n" + "                                                        " + m_reportDate
        + "\n" + "                                                           ),"
        + "\n" + "                                    0,"
        + "\n" + "                                    guaranty.t_currencyId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + m_reportDate
        + "\n" + "                                   )"
        + "\n" + "           )                                               AS t_sum,"
        + "\n" + "        guaranty.t_currencyId                              AS t_currencyId,"
        + "\n" + "        contract.t_id                                      AS t_contractId"
        + "\n" + "   FROM DF634GUARANTY_TMP guaranty,"
        + "\n" + "        F634CONTRACT_VW contract,"
        + "\n" + "        REPLNSTRANCHES_VW tranche,"
        + "\n" + "        F634REGISTER_VW register"
        + "\n" + "  WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "    AND guaranty.t_isGuarantee = 1"
        + "\n" + "    AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND contract.t_type != " + LO_GUARANTEE
        + "\n" + "    AND contract.t_fiId != 0"
        + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "    AND tranche.t_contractId = contract.t_id"
        + "\n" + "    AND tranche.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND register.t_trancheKind = tranche.t_kind"
        + "\n" + "    AND register.t_trancheNumber = tranche.t_number"
        + "\n" + "    AND register.t_type IN (1, 2, 16, 17)"
        + "\n" + "  GROUP BY guaranty.t_currencyId, contract.t_id"
        + "\n" + ")"
        + "\n" + "SELECT contract.t_branchId                                          AS T_BRANCHID,"
        + "\n" + "       contract.t_id                                                AS T_CONTRACTID,"
        + "\n" + "       contract.t_number                                            AS T_CONTRACTNUMBER,"
        + "\n" + "       guaranty.t_currencyId                                        AS T_FIID,"
        + "\n" + "       guaranty.t_sum                                               AS T_SECUREDAMOUNT,"
        + "\n" + "       reserve.t_reserveAmount                                      AS T_RESERVEAMOUNT,"
        + "\n" + "       reserve.t_roubleReserveAmount                                AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NULL                                                         AS T_REGISTERREST,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN guaranty.t_sum"
        + "\n" + "           ELSE reserve.t_sum"
        + "\n" + "       END                                                          AS T_VALUE,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN rsb_fiinstr.convSumType(guaranty.t_sum,"
        + "\n" + "                                            guaranty.t_currencyId,"
        + "\n" + "                                            0,"
        + "\n" + "                                        " + RATETYPE_CB + ","
        + "\n" + "                                        " + m_reportDate
        + "\n" + "                                           )"
        + "\n" + "           ELSE reserve.t_roubleSum"
        + "\n" + "       END                                                          AS T_ROUBLEVALUE,"
        + "\n" + "       NULL                                                         AS T_REGISTERTYPE,"
        + "\n" + "       contract.t_fiId                                              AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                         AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                         AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                         AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garantiipolu4_k()) + " AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garantiipolu4_k()) + " || TO_CHAR(contract.t_id)  AS T_KEY"
        + "\n" + "  FROM F634CONTRACT_VW contract,"
        + "\n" + "       DF634GUARANTY_TMP guaranty,"
        + "\n" + "       reserve,"
        + "\n" + "       register"
        + "\n" + " WHERE contract.t_isOpenedAtEndDate = 1"
        + "\n" + "   AND contract.t_type != " + LO_DEPOSIT
        + "\n" + "   AND contract.t_fiId != 0"
        + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "   AND guaranty.t_contractId = contract.t_id"
        + "\n" + "   AND guaranty.t_isGuarantee = 1"
        + "\n" + "   AND reserve.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND reserve.t_currencyId = guaranty.t_currencyId"
        + "\n" + "   AND register.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND register.t_currencyId = guaranty.t_currencyId";
    end;

    // Полученные гарантии и поручительства, учтенные в рублях, для расчета VVV_ГарПолуч_810_К
    private macro getQueryText_f634guarantyreceived810()
        return   "WITH reserve AS"
        + "\n" + "("
        + "\n" + " SELECT /*+ MATERIALIZE*/"
        + "\n" + "        contractData.t_reserveAmount        AS t_sum,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleSum,"
        + "\n" + "        contractData.t_reserveAmount        AS t_reserveAmount,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleReserveAmount,"
        + "\n" + "        contractData.t_currencyId           AS t_currencyId,"
        + "\n" + "        contractData.t_contractId           AS t_contractId"
        + "\n" + "   FROM (SELECT CASE"
        + "\n" + "                    WHEN contract.t_briefCaseId IS NULL"
        + "\n" + "                      OR contract.t_briefCaseId = 0"
        + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(contract.t_rvpsSum,"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         rcb_f634.getRegisterChangeDate(contract.t_id, 10)"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                       + NVL(rsb_fiinstr.convSumType(contract.t_delayedRvpsSum,"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         rcb_f634.getRegisterChangeDate(contract.t_id, 11)"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                    ELSE NVL(rsb_fiinstr.convSumType(NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0),"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                            FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                           WHERE portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "                                                         )"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                END                                                             AS t_reserveAmount,"
        + "\n" + "                NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0)  AS t_roubleReserveAmount,"
        + "\n" + "                guaranty.t_currencyId                                           AS t_currencyId,"
        + "\n" + "                contract.t_id                                                   AS t_contractId"
        + "\n" + "           FROM F634CONTRACT_VW contract,"
        + "\n" + "                DF634GUARANTY_TMP guaranty"
        + "\n" + "          WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "            AND guaranty.t_isGuarantee = 1"
        + "\n" + "            AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "            AND contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "            AND contract.t_fiId = 0"
        + "\n" + "            AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "        ) contractData"
        + "\n" + "),"
        + "\n" + "register AS"
        + "\n" + "("
        + "\n" + " SELECT SUM(rsb_fiinstr.convSumType(rsb_fiinstr.convSumType(register.t_rest,"
        + "\n" + "                                                            register.t_currencyId,"
        + "\n" + "                                                            0,"
        + "\n" + "                                                        " + RATETYPE_CB + ","
        + "\n" + "                                                        " + m_reportDate
        + "\n" + "                                                           ),"
        + "\n" + "                                    0,"
        + "\n" + "                                    guaranty.t_currencyId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + m_reportDate
        + "\n" + "                                   )"
        + "\n" + "           )                                               AS t_sum,"
        + "\n" + "        guaranty.t_currencyId                              AS t_currencyId,"
        + "\n" + "        contract.t_id                                      AS t_contractId"
        + "\n" + "   FROM DF634GUARANTY_TMP guaranty,"
        + "\n" + "        F634CONTRACT_VW contract,"
        + "\n" + "        REPLNSTRANCHES_VW tranche,"
        + "\n" + "        F634REGISTER_VW register"
        + "\n" + "  WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "    AND guaranty.t_isGuarantee = 1"
        + "\n" + "    AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "    AND contract.t_fiId = 0"
        + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "    AND tranche.t_contractId = contract.t_id"
        + "\n" + "    AND tranche.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND register.t_trancheKind = tranche.t_kind"
        + "\n" + "    AND register.t_trancheNumber = tranche.t_number"
        + "\n" + "    AND register.t_type IN (1, 2, 16, 17)"
        + "\n" + "  GROUP BY guaranty.t_currencyId, contract.t_id"
        + "\n" + ")"
        + "\n" + "SELECT contract.t_branchId                                                            AS T_BRANCHID,"
        + "\n" + "       contract.t_id                                                                  AS T_CONTRACTID,"
        + "\n" + "       contract.t_number                                                              AS T_CONTRACTNUMBER,"
        + "\n" + "       guaranty.t_currencyId                                                          AS T_FIID,"
        + "\n" + "       guaranty.t_sum                                                                 AS T_SECUREDAMOUNT,"
        + "\n" + "       reserve.t_reserveAmount                                                        AS T_RESERVEAMOUNT,"
        + "\n" + "       reserve.t_roubleReserveAmount                                                  AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NULL                                                                           AS T_REGISTERREST,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN guaranty.t_sum"
        + "\n" + "           ELSE reserve.t_sum"
        + "\n" + "       END                                                                            AS T_VALUE,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN rsb_fiinstr.convSumType(guaranty.t_sum,"
        + "\n" + "                                            guaranty.t_currencyId,"
        + "\n" + "                                            0,"
        + "\n" + "                                        " + RATETYPE_CB + ","
        + "\n" + "                                        " + m_reportDate
        + "\n" + "                                           )"
        + "\n" + "           ELSE reserve.t_roubleSum"
        + "\n" + "       END                                                                            AS T_ROUBLEVALUE,"
        + "\n" + "       NULL                                                                           AS T_REGISTERTYPE,"
        + "\n" + "       contract.t_fiId                                                                AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                                           AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                                           AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                                           AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garpolu4_k_810()) + "                    AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garpolu4_k_810()) + " || TO_CHAR(contract.t_id)   AS T_KEY"
        + "\n" + "  FROM F634CONTRACT_VW contract,"
        + "\n" + "       DF634GUARANTY_TMP guaranty,"
        + "\n" + "       reserve,"
        + "\n" + "       register"
        + "\n" + " WHERE contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "   AND guaranty.t_contractId = contract.t_id"
        + "\n" + "   AND guaranty.t_isGuarantee = 1"
        + "\n" + "   AND reserve.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND reserve.t_currencyId = guaranty.t_currencyId"
        + "\n" + "   AND register.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND register.t_currencyId = guaranty.t_currencyId"
        ;
    end;

    // Совокупная внебалансовая позиция для расчета VVV_10_K
    private macro getQueryText_f634offbalancetotal()
        return   "SELECT contract.t_branchId                                                                                    AS T_BRANCHID,"
        + "\n" + "       contract.t_id                                                                                          AS T_CONTRACTID,"
        + "\n" + "       contract.t_number                                                                                      AS T_CONTRACTNUMBER,"
        + "\n" + "       contract.t_fiId                                                                                        AS T_FIID,"
        + "\n" + "       NULL                                                                                                   AS T_SECUREDAMOUNT,"
        + "\n" + "       NULL                                                                                                   AS T_RESERVEAMOUNT,"
        + "\n" + "       NULL                                                                                                   AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NULL                                                                                                   AS T_REGISTERREST,"
        + "\n" + "       (1.0 - NVL(contract.t_rvpsReservePercent, 0) / 100.0) * account.a_accountOutRest                       AS T_VALUE,"
        + "\n" + "       (1.0 - NVL(contract.t_rvpsReservePercent, 0) / 100.0) * rsb_fiinstr.convSumType(account.a_accountOutRest,"
        + "\n" + "                                                                                   contract.t_fiId,"
        + "\n" + "                                                                                   0,"
        + "\n" + "                                                                               " + RATETYPE_CB + ","
        + "\n" + "                                                                               " + m_reportDate
        + "\n" + "                                                                                  )                           AS T_ROUBLEVALUE,"
        + "\n" + "       NULL                                                                                                   AS T_REGISTERTYPE,"
        + "\n" + "       NULL                                                                                                   AS T_CONTRACTFIID,"
        + "\n" + "       account.a_accountNumber                                                                                AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       account.a_accountOutRest                                                                               AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NVL(contract.t_rvpsReservePercent, 0)                                                                  AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_10_k()) + "                                                      AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_10_k()) + " || TO_CHAR(contract.t_id) || account.a_accountNumber          AS T_KEY"
        + "\n" + "  FROM F634CONTRACT_VW contract,"
        + "\n" + "       OrmLnsACCOUNT account"
        + "\n" + " WHERE contract.t_type != " + LO_DEPOSIT
        + "\n" + "   AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "   AND EXISTS (SELECT NULL"
        + "\n" + "                 FROM REPLNSTRANCHES_VW tranche"
        + "\n" + "                WHERE tranche.t_contractId = contract.t_id"
        + "\n" + "                  AND tranche.t_fiId != 0"
        + "\n" + "                  AND tranche.t_isOpenedAtEndDate = 1"
        + "\n" + "              )"
        + "\n" + "   AND account.a_creditNumber = contract.t_id"
        + "\n" + "   AND account.a_chapter = 'В'"
        + "\n" + "   AND account.a_curCode != 0"
        + "\n" + "   AND account.a_accountNumber LIKE '91604%'"
        + "\n" + "   AND (    account.a_openDate <= " + m_reportDate
        + "\n" + "        AND (   account.a_closeDate >" + m_reportDate
        + "\n" + "             OR account.a_openDate > account.a_closeDate"
        + "\n" + "            )"
        + "\n" + "       )";
    end;

    // Залоги для расчета VVV_Залог_К_
    private macro getQueryText_f634pledge()
        return   "WITH reserve AS"
        + "\n" + "("
//        + "\n" + " SELECT /*+ MATERIALIZE*/"
        + "\n" + " SELECT contractData.t_reserveAmount        AS t_sum,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleSum,"
        + "\n" + "        contractData.t_reserveAmount        AS t_reserveAmount,"
        + "\n" + "        contractData.t_roubleReserveAmount  AS t_roubleReserveAmount,"
        + "\n" + "        contractData.t_currencyId           AS t_currencyId,"
        + "\n" + "        contractData.t_contractId           AS t_contractId"
        + "\n" + "   FROM (SELECT CASE"
        + "\n" + "                    WHEN contract.t_briefCaseId IS NULL"
        + "\n" + "                      OR contract.t_briefCaseId = 0"
        + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(contract.t_rvpsSum,"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         rcb_f634.getRegisterChangeDate(contract.t_id, 10)"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                       + NVL(rsb_fiinstr.convSumType(contract.t_delayedRvpsSum,"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         rcb_f634.getRegisterChangeDate(contract.t_id, 11)"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                    ELSE NVL(rsb_fiinstr.convSumType(NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0),"
        + "\n" + "                                                         0,"
        + "\n" + "                                                         guaranty.t_currencyId,"
        + "\n" + "                                                     " + RATETYPE_CB + ","
        + "\n" + "                                                         (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                            FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                           WHERE portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "                                                         )"
        + "\n" + "                                                        ), 0"
        + "\n" + "                            )"
        + "\n" + "                END                                                               AS t_reserveAmount,"
        + "\n" + "                NVL(contract.t_rvpsSum, 0) + NVL(contract.t_delayedRvpsSum, 0)    AS t_roubleReserveAmount,"
        + "\n" + "                guaranty.t_currencyId                                             AS t_currencyId,"
        + "\n" + "                contract.t_id                                                     AS t_contractId"
        + "\n" + "           FROM F634CONTRACT_VW contract,"
        + "\n" + "                DF634GUARANTY_TMP guaranty"
        + "\n" + "          WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "            AND guaranty.t_isGuarantee = 0"
        + "\n" + "            AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "            AND contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "            AND contract.t_fiId != 0"
        + "\n" + "            AND (   contract.t_rvpsSum > 0"
        + "\n" + "                 OR contract.t_delayedRvpsSum > 0"
        + "\n" + "                )"
        + "\n" + "            AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "        ) contractData"
        + "\n" + "),"
        + "\n" + "register AS"
        + "\n" + "("
        + "\n" + " SELECT SUM(rsb_fiinstr.convSumType(rsb_fiinstr.convSumType(register.t_rest,"
        + "\n" + "                                                            register.t_currencyId,"
        + "\n" + "                                                            0,"
        + "\n" + "                                                        " + RATETYPE_CB + ","
        + "\n" + "                                                        " + m_reportDate
        + "\n" + "                                                           ),"
        + "\n" + "                                    0,"
        + "\n" + "                                    guaranty.t_currencyId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + m_reportDate
        + "\n" + "                                   )"
        + "\n" + "           )                                               AS t_sum,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(register.t_rest,"
        + "\n" + "                                    register.t_currencyId,"
        + "\n" + "                                    0,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + m_reportDate
        + "\n" + "                                   )"
        + "\n" + "           )                                               AS t_roubleSum,"
        + "\n" + "        guaranty.t_currencyId                              AS t_currencyId,"
        + "\n" + "        contract.t_id                                      AS t_contractId"
        + "\n" + "   FROM DF634GUARANTY_TMP guaranty,"
        + "\n" + "        F634CONTRACT_VW contract,"
        + "\n" + "        REPLNSTRANCHES_VW tranche,"
        + "\n" + "        F634REGISTER_VW register"
        + "\n" + "  WHERE contract.t_id = guaranty.t_contractId"
        + "\n" + "    AND guaranty.t_isGuarantee = 0"
        + "\n" + "    AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "    AND contract.t_fiId != 0"
        + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "    AND tranche.t_contractId = contract.t_id"
        + "\n" + "    AND tranche.t_isOpenedAtEndDate = 1"
        + "\n" + "    AND register.t_trancheKind = tranche.t_kind"
        + "\n" + "    AND register.t_trancheNumber = tranche.t_number"
        + "\n" + "    AND register.t_type IN (1, 2, 16, 17)"
        + "\n" + "    AND (   contract.t_rvpsSum > 0"
        + "\n" + "         OR contract.t_delayedRvpsSum > 0"
        + "\n" + "        )"
        + "\n" + "  GROUP BY guaranty.t_currencyId, contract.t_id"
        + "\n" + ")"
        + "\n" + "SELECT contract.t_branchId                                                    AS T_BRANCHID,"
        + "\n" + "       contract.t_id                                                          AS T_CONTRACTID,"
        + "\n" + "       contract.t_number                                                      AS T_CONTRACTNUMBER,"
        + "\n" + "       guaranty.t_currencyId                                                  AS T_FIID,"
        + "\n" + "       guaranty.t_sum                                                         AS T_SECUREDAMOUNT,"
        + "\n" + "       reserve.t_reserveAmount                                                AS T_RESERVEAMOUNT,"
        + "\n" + "       reserve.t_roubleReserveAmount                                          AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       rsb_fiinstr.convSumType(register.t_roubleSum,"
        + "\n" + "                                   0,"
        + "\n" + "                                   contract.t_fiId,"
        + "\n" + "                               " + RATETYPE_CB + ","
        + "\n" + "                               " + m_reportDate
        + "\n" + "                                  )                                           AS T_REGISTERREST,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN guaranty.t_sum"
        + "\n" + "           ELSE reserve.t_sum"
        + "\n" + "       END                                                                    AS T_VALUE,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN guaranty.t_sum < register.t_sum"
        + "\n" + "            AND guaranty.t_sum < reserve.t_sum"
        + "\n" + "           THEN rsb_fiinstr.convSumType(guaranty.t_sum,"
        + "\n" + "                                            guaranty.t_currencyId,"
        + "\n" + "                                            0,"
        + "\n" + "                                        " + RATETYPE_CB + ","
        + "\n" + "                                        " + m_reportDate
        + "\n" + "                                           )"
        + "\n" + "           ELSE reserve.t_roubleSum"
        + "\n" + "       END                                                                    AS T_ROUBLEVALUE,"
        + "\n" + "       1                                                                      AS T_REGISTERTYPE,"
        + "\n" + "       contract.t_fiId                                                        AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                                   AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                                   AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                                   AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_zalog_k()) + "                   AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_zalog_k()) + " || TO_CHAR(contract.t_id)  AS T_KEY"
        + "\n" + "  FROM F634CONTRACT_VW contract,"
        + "\n" + "       DF634GUARANTY_TMP guaranty,"
        + "\n" + "       reserve,"
        + "\n" + "       register"
        + "\n" + " WHERE contract.t_isOpenedAtEndDate = 1"
        + "\n" + "   AND contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
        + "\n" + "   AND contract.t_fiId != 0"
        + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "   AND guaranty.t_contractId = contract.t_id"
        + "\n" + "   AND guaranty.t_isGuarantee = 0"
        + "\n" + "   AND reserve.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND reserve.t_currencyId = guaranty.t_currencyId"
        + "\n" + "   AND register.t_contractId = guaranty.t_contractId"
        + "\n" + "   AND register.t_currencyId = guaranty.t_currencyId";
    end;

    // Резервы по балансовым активам для расчета VVV_рез_бал_К_ (кредитные договора)
    private macro getQueryText_f634provisionforassets01()
        return   "SELECT contractData.t_branchId             AS t_branchId,"
        + "\n" + "       contractData.t_contractId           AS t_contractId,"
        + "\n" + "       'Д ' || contractData.t_number       AS t_contractNumber,"
        + "\n" + "       contractData.t_fiId                 AS t_fiId,"
        + "\n" + "       NULL                                AS t_securedAmount,"
        + "\n" + "       contractData.t_reserveAmount        AS t_reserveAmount,"
        + "\n" + "       contractData.t_roubleReserveAmount  AS t_roubleReserveAmount,"
        + "\n" + "       NULL                                AS t_registerRest,"
        + "\n" + "       contractData.t_reserveAmount        AS t_value,"
        + "\n" + "       contractData.t_roubleReserveAmount  AS t_roubleValue,"
        + "\n" + "       NULL                                AS t_registerType,"
        + "\n" + "       NULL                                AS t_contractFiId,"
        + "\n" + "       NULL                                AS t_percentAccountNumber,"
        + "\n" + "       NULL                                AS t_percentAccountRest,"
        + "\n" + "       NULL                                AS t_reservePercent,"
        + "\n" + "       contractData.t_usedByPosition       AS t_usedByPosition,"
        + "\n" + "       contractData.t_key                  AS t_key"
        + "\n" + "  FROM (SELECT contract.t_branchId                                                                        AS t_branchId,"
        + "\n" + "               contract.t_id                                                                              AS t_contractId,"
        + "\n" + "               contract.t_number                                                                          AS t_number,"
        + "\n" + "               contract.t_fiId                                                                            AS t_fiId,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId = 0"
        + "\n" + "                   THEN   NVL(rsb_fiinstr.convSumType(contract.t_rvpsSum,"
        + "\n" + "                                                          0,"
        + "\n" + "                                                          contract.t_fiId,"
        + "\n" + "                                                      " + RATETYPE_CB + ","
        + "\n" + "                                                          rcb_f634.getRegisterChangeDate(contract.t_id, 10)"
        + "\n" + "                                                         ), 0"
        + "\n" + "                             )"
        + "\n" + "                        + NVL(rsb_fiinstr.convSumType(contract.t_delayedRvpsSum,"
        + "\n" + "                                                          0,"
        + "\n" + "                                                          contract.t_fiId,"
        + "\n" + "                                                      " + RATETYPE_CB + ","
        + "\n" + "                                                          rcb_f634.getRegisterChangeDate(contract.t_id, 11)"
        + "\n" + "                                                         ), 0"
        + "\n" + "                             )"
        + "\n" + "                        + NVL(rsb_fiinstr.convSumType(contract.t_percentRvpSum,"
        + "\n" + "                                                          0,"
        + "\n" + "                                                          contract.t_fiId,"
        + "\n" + "                                                      " + RATETYPE_CB + ","
        + "\n" + "                                                          rcb_f634.getRegisterChangeDate(contract.t_id, 82)"
        + "\n" + "                                                         ), 0"
        + "\n" + "                             )"
        + "\n" + "                        + NVL(rsb_fiinstr.convSumType(contract.t_delayedPercentRvpSum,"
        + "\n" + "                                                          0,"
        + "\n" + "                                                          contract.t_fiId,"
        + "\n" + "                                                      " + RATETYPE_CB + ","
        + "\n" + "                                                          rcb_f634.getRegisterChangeDate(contract.t_id, 79)"
        + "\n" + "                                                         ), 0"
        + "\n" + "                             )"
        + "\n" + "                        + NVL(rsb_fiinstr.convSumType(contract.t_commissionRvpSum,"
        + "\n" + "                                                          0,"
        + "\n" + "                                                          contract.t_fiId,"
        + "\n" + "                                                      " + RATETYPE_CB + ","
        + "\n" + "                                                          rcb_f634.getRegisterChangeDate(contract.t_id, 143)"
        + "\n" + "                                                         ), 0"
        + "\n" + "                             )"
        + "\n" + "                   ELSE NVL(rsb_fiinstr.convSumType(NVL(contract.t_rvpsSum, 0)"
        + "\n" + "                                                  + NVL(contract.t_delayedRvpsSum, 0)"
        + "\n" + "                                                  + NVL(contract.t_percentRvpSum, 0)"
        + "\n" + "                                                  + NVL(contract.t_delayedPercentRvpSum, 0),"
        + "\n" + "                                                    0,"
        + "\n" + "                                                    contract.t_fiId,"
        + "\n" + "                                                " + RATETYPE_CB + ","
        + "\n" + "                                                    (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                       FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                      WHERE portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "                                                    )"
        + "\n" + "                                                   ), 0"
        + "\n" + "                           )"
        + "\n" + "               END                                                                                        AS t_reserveAmount,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId = 0"
        + "\n" + "                   THEN   NVL(contract.t_rvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedRvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_percentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedPercentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_commissionRvpSum, 0)"
        + "\n" + "                   ELSE   NVL(contract.t_rvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedRvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_percentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedPercentRvpSum, 0)"
        + "\n" + "               END                                                                                        AS t_roubleReserveAmount,"
        + "\n" + "           " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + "                                     AS t_usedByPosition,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId = 0"
        + "\n" + "                   THEN " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + " || TO_CHAR(contract.t_id) || TO_CHAR(contract.t_briefCaseId) || TO_CHAR(contract.t_fiId) || '1'"
        + "\n" + "                   ELSE " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + " || TO_CHAR(contract.t_id) || TO_CHAR(contract.t_briefCaseId) || TO_CHAR(contract.t_fiId) || '2'"
        + "\n" + "               END                                                                                        AS t_key"
        + "\n" + "          FROM F634CONTRACT_VW contract"
        + "\n" + "         WHERE contract.t_type != " + LO_DEPOSIT
        + "\n" + "           AND contract.t_fiId != 0"
        + "\n" + "           AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "           AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "       ) contractData";
    end;

    // Резервы по балансовым активам для расчета VVV_рез_бал_К_ (портфели)
    private macro getQueryText_f634provisionforassets02()
        return   "SELECT portfolioData.t_branchId                                                                                                AS t_branchId,"
        + "\n" + "       portfolioData.t_contractId                                                                                              AS t_contractId,"
        + "\n" + "       'П ' || portfolioData.t_number                                                                                          AS t_contractNumber,"
        + "\n" + "       portfolioData.t_fiId                                                                                                    AS t_fiId,"
        + "\n" + "       NULL                                                                                                                    AS t_securedAmount,"
        + "\n" + "       portfolioData.t_reserveAmount                                                                                           AS t_reserveAmount,"
        + "\n" + "       portfolioData.t_roubleReserveAmount                                                                                     AS t_roubleReserveAmount,"
        + "\n" + "       NULL                                                                                                                    AS t_registerRest,"
        + "\n" + "       DECODE(portfolioData.t_sum1, 0, 0, portfolioData.t_reserveAmount * portfolioData.t_sum2 / portfolioData.t_sum1)         AS t_value,"
        + "\n" + "       DECODE(portfolioData.t_sum1, 0, 0, portfolioData.t_roubleReserveAmount * portfolioData.t_sum2 / portfolioData.t_sum1)   AS t_roubleValue,"
        + "\n" + "       NULL                                                                                                                    AS t_registerType,"
        + "\n" + "       NULL                                                                                                                    AS t_contractFiId,"
        + "\n" + "       NULL                                                                                                                    AS t_percentAccountNumber,"
        + "\n" + "       NULL                                                                                                                    AS t_percentAccountRest,"
        + "\n" + "       NULL                                                                                                                    AS t_reservePercent,"
        + "\n" + "       portfolioData.t_usedByPosition                                                                                          AS t_usedByPosition,"
        + "\n" + "       portfolioData.t_key                                                                                                     AS t_key"
        + "\n" + "  FROM (SELECT portfolio.t_branchId             AS t_branchId,"
        + "\n" + "               portfolio.t_id                   AS t_contractId,"
        + "\n" + "               portfolio.t_number               AS t_number,"
        + "\n" + "               reg.t_currencyId                 AS t_fiId,"
        + "\n" + "               NVL(rsb_fiinstr.convSumType(portfolio.t_commissionReserveSum,"
        + "\n" + "                                               0,"
        + "\n" + "                                               reg.t_currencyId,"
        + "\n" + "                                           " + RATETYPE_CB + ","
        + "\n" + "                                               portfolio.t_reserveDate"
        + "\n" + "                                              ), 0)                                   AS t_reserveAmount,"
        + "\n" + "               NVL(portfolio.t_commissionReserveSum, 0)                               AS t_roubleReserveAmount,"
        + "\n" + "               SUM(NVL(rsb_fiinstr.convSumType(reg.t_rest, reg.t_currencyId, 0," + RATETYPE_CB + "," + m_reportDate + "), 0)) OVER(PARTITION BY portfolio.t_id, reg.t_currencyId) AS t_sum1,"
        + "\n" + "               SUM(NVL(rsb_fiinstr.convSumType(reg.t_rest, reg.t_currencyId, 0," + RATETYPE_CB + "," + m_reportDate + "), 0)) OVER(PARTITION BY portfolio.t_id)                   AS t_sum2,"
        + "\n" + "           " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + "                 AS t_usedByPosition,"
        + "\n" + "           " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + " || '0' || TO_CHAR(portfolio.t_id) || TO_CHAR(reg.t_currencyId) || '3'  AS t_key"
        + "\n" + "          FROM F634REGISTER_VW reg,"
        + "\n" + "               REPLNSTRANCHES_VW tranche,"
        + "\n" + "               REPLNSCASE_VW portfolio,"
        + "\n" + "               F634CONTRACT_VW contract"
        + "\n" + "         WHERE rsb_mask.compareStringWithMask(rsb_common.getRegStrValue('REPTREG/REP_GROUPS/COMMON/РЕГИСТРЫ LOANS ПО КОМИССИЯМ', rsbSessionData.oper()),"
        + "\n" + "                                                  TO_CHAR(reg.t_type)) = 0"
        + "\n" + "           AND reg.t_trancheKind = tranche.t_kind"
        + "\n" + "           AND reg.t_trancheNumber = tranche.t_number"
        + "\n" + "           AND tranche.t_contractId = contract.t_id"
        + "\n" + "           AND contract.t_type != " + LO_DEPOSIT
        + "\n" + "           AND contract.t_briefCaseId != 0"
        + "\n" + "           AND contract.t_isOpenedAtEndDate = 1"
        + "\n" + "           AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "           AND portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "       ) portfolioData";
    end;

    // Резервы по выданным гарантиям и поручительствам для расчета VVV_ГарРез_К_
    private macro getQueryText_f634provisionforguaranty()
        return   "SELECT contractData.t_branchId              AS t_branchId,"
        + "\n" + "       contractData.t_contractId            AS t_contractId,"
        + "\n" + "       contractData.t_number                AS t_contractNumber,"
        + "\n" + "       contractData.t_fiId                  AS t_fiId,"
        + "\n" + "       NULL                                 AS t_securedAmount,"
        + "\n" + "       contractData.t_reserveAmount         AS t_reserveAmount,"
        + "\n" + "       contractData.t_roubleReserveAmount   AS t_roubleReserveAmount,"
        + "\n" + "       contractData.t_registerRest          AS t_registerRest,"
        + "\n" + "       contractData.t_reserveAmount         AS t_value,"
        + "\n" + "       contractData.t_roubleReserveAmount   AS t_roubleValue,"
        + "\n" + "       contractData.t_registerType          AS t_registerType,"
        + "\n" + "       contractData.t_contractFiId          AS t_contractFiId,"
        + "\n" + "       NULL                                 AS t_percentAccountNumber,"
        + "\n" + "       NULL                                 AS t_percentAccountRest,"
        + "\n" + "       NULL                                 AS t_reservePercent,"
        + "\n" + "       contractData.t_usedByPosition        AS t_usedByPosition,"
        + "\n" + "       contractData.t_key                   AS t_key"
        + "\n" + "  FROM (SELECT contract.t_branchId  AS t_branchId,"
        + "\n" + "               contract.t_id        AS t_contractId,"
        + "\n" + "               contract.t_number    AS t_number,"
        + "\n" + "               contract.t_fiId      AS t_fiId,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN     contract.t_briefCaseId = 0"
        + "\n" + "                        AND contract.t_portfolioDebtID = 0"
        + "\n" + "                   THEN NVL(rsb_fiinstr.convSumType(contract.t_rvpSum,"
        + "\n" + "                                                " + NATCUR + ","
        + "\n" + "                                                    contract.t_fiId,"
        + "\n" + "                                                " + RATETYPE_CB + ","
        + "\n" + "                                                    rcb_f634.getRegisterChangeDate(contract.t_id, 12)"
        + "\n" + "                                                   ), 0"
        + "\n" + "                           )"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END"
        + "\n" + "             + CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId != 0"
        + "\n" + "                   THEN NVL(rsb_fiinstr.convSumType((SELECT portfolio.t_reserveSum"
        + "\n" + "                                                       FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                      WHERE portfolio.t_id = contract.t_portfolioDebtId"
        + "\n" + "                                                    ),"
        + "\n" + "                                                " + NATCUR + ","
        + "\n" + "                                                    contract.t_fiId,"
        + "\n" + "                                                " + RATETYPE_CB + ","
        + "\n" + "                                                    (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                       FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                      WHERE portfolio.t_id = contract.t_briefCaseId"
        + "\n" + "                                                    )"
        + "\n" + "                                                   ), 0"
        + "\n" + "                           )"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END"
        + "\n" + "             + CASE"
        + "\n" + "                   WHEN contract.t_portfolioDebtId != 0"
        + "\n" + "                   THEN NVL(rsb_fiinstr.convSumType((SELECT portfolio.t_reserveSum"
        + "\n" + "                                                       FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                      WHERE portfolio.t_id = contract.t_portfolioDebtId"
        + "\n" + "                                                    ),"
        + "\n" + "                                                " + NATCUR + ","
        + "\n" + "                                                    contract.t_fiId,"
        + "\n" + "                                                " + RATETYPE_CB + ","
        + "\n" + "                                                    (SELECT portfolio.t_reserveDate"
        + "\n" + "                                                       FROM REPLNSCASE_VW portfolio"
        + "\n" + "                                                      WHERE portfolio.t_id = contract.t_portfolioDebtId"
        + "\n" + "                                                    )"
        + "\n" + "                                                   ), 0"
        + "\n" + "                           )"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END                        AS t_reserveAmount,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN     contract.t_briefCaseId = 0"
        + "\n" + "                        AND contract.t_portfolioDebtID = 0"
        + "\n" + "                   THEN NVL(contract.t_rvpSum, 0)"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END"
        + "\n" + "             + CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId != 0"
        + "\n" + "                   THEN NVL((SELECT portfolio.t_reserveSum"
        + "\n" + "                               FROM REPLNSCASE_VW portfolio"
        + "\n" + "                              WHERE portfolio.t_id = contract.t_portfolioDebtId"
        + "\n" + "                            ), 0"
        + "\n" + "                           )"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END"
        + "\n" + "             + CASE"
        + "\n" + "                   WHEN contract.t_portfolioDebtId != 0"
        + "\n" + "                   THEN NVL((SELECT portfolio.t_reserveSum"
        + "\n" + "                                FROM REPLNSCASE_VW portfolio"
        + "\n" + "                               WHERE portfolio.t_id = contract.t_portfolioDebtId"
        + "\n" + "                            ), 0"
        + "\n" + "                           )"
        + "\n" + "                   ELSE 0"
        + "\n" + "               END                        AS t_roubleReserveAmount,"
        + "\n" + "               0                          AS t_registerRest,"
        + "\n" + "               55                         AS t_registerType,"
        + "\n" + "               contract.t_fiId            AS t_contractFiId,"
        + "\n" + "           " + getSqlString(m_parameters.getCode_vvv_garrez_k()) + " AS t_usedByPosition,"
        + "\n" + "               TO_CHAR(contract.t_id)     AS t_key"
        + "\n" + "          FROM F634CONTRACT_VW contract"
        + "\n" + "         WHERE contract.t_isOpenedAtEndDate = 1"
        + "\n" + "           AND contract.t_type = " + LO_GUARANTEE
        + "\n" + "           AND contract.t_guarantType = 1"
        + "\n" + "           AND contract.t_rvpQualityCategory IN (4, 5)"
        + "\n" + "           AND contract.t_fiId != 0"
        + "\n" + "           AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "       ) contractData";
    end;

    /**
     *  Текст запроса для отбора данных
     */
    macro getQueryText(dataSourceName)
//        return   "SELECT data.t_contractId           AS T_CREDITID,"
//        + "\n" + "       data.t_contractNumber       AS T_USERCREDITNUMBER,"
//        + "\n" + "       data.t_fiId                 AS T_FIID,"
//        + "\n" + "       data.t_securedAmount        AS T_SECUREDAMOUNT,"
//        + "\n" + "       data.t_reserveAmount        AS T_RESERVEAMOUNT,"
//        + "\n" + "       data.t_roubleReserveAmount  AS T_ROUBLERESERVEAMOUNT,"
//        + "\n" + "       data.t_registerRest         AS T_REGISTERREST,"
//        + "\n" + "       data.t_value                AS T_VALUE,"
//        + "\n" + "       data.t_roubleValue          AS T_ROUBLEVALUE,"
//        + "\n" + "       data.t_registerType         AS T_REGISTERTYPE,"
//        + "\n" + "       data.t_contractFiId         AS T_CREDITFIID,"
//        + "\n" + "       data.t_percentAccountNumber AS T_PERCENTACCOUNTNUMBER,"
//        + "\n" + "       data.t_percentAccountRest   AS T_PERCENTACCOUNTREST,"
//        + "\n" + "       data.t_reservePercent       AS T_RESERVEPERCENT,"
//        + "\n" + "       data.t_usedByPosition       AS T_USEDBYPOSITION,"
//        + "\n" + "       data.t_key                  AS T_KEY"
//        + "\n" + "  FROM (" + execExp("getQueryText_" + dataSourceName) + ") data";
        return   "SELECT NVL(data.t_contractId           , 0) AS T_CREDITID,"
        + "\n" + "       NVL(data.t_contractNumber       , CHR(1)) AS T_USERCREDITNUMBER,"
        + "\n" + "       NVL(data.t_fiId                 , -9999) AS T_FIID,"
        + "\n" + "       NVL(data.t_securedAmount        , 0) AS T_SECUREDAMOUNT,"
        + "\n" + "       NVL(data.t_reserveAmount        , 0) AS T_RESERVEAMOUNT,"
        + "\n" + "       NVL(data.t_roubleReserveAmount  , 0) AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NVL(data.t_registerRest         , 0) AS T_REGISTERREST,"
        + "\n" + "       NVL(data.t_value                , 0) AS T_VALUE,"
        + "\n" + "       NVL(data.t_roubleValue          , 0) AS T_ROUBLEVALUE,"
        + "\n" + "       NVL(data.t_registerType         , 0) AS T_REGISTERTYPE,"
        + "\n" + "       NVL(data.t_contractFiId         , -9999) AS T_CREDITFIID,"
        + "\n" + "       NVL(data.t_percentAccountNumber , CHR(1)) AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NVL(data.t_percentAccountRest   , 0) AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NVL(data.t_reservePercent       , 0) AS T_RESERVEPERCENT,"
        + "\n" + "       NVL(data.t_usedByPosition       , CHR(1)) AS T_USEDBYPOSITION,"
        + "\n" + "       NVL(data.t_key                  , CHR(1)) AS T_KEY"
        + "\n" + "  FROM (" + execExp("getQueryText_" + dataSourceName) + ") data";
    end;

    private macro constructorTDataSourceLnQueryTextMaker(parameters : TParametersLn)

        m_parameters = parameters;

        m_reportDate = getSqlDate(m_parameters.getendDate());

    end;

    constructorTDataSourceLnQueryTextMaker(parameters);

end;

/**
 *  Класс построения текста SQL-запроса для источника данных Loans по инструкции ХХХХ-У1
 */
private class (TDataSourceLnQueryTextMaker) TDataSourceLnQueryTextMaker_XXXX1(parameters : TParametersLn)
    initTDataSourceLnQueryTextMaker(parameters);

    // Резервы по балансовым активам для расчета VVV_рез_бал_К_ (кредитные договора)
    private macro getQueryText_f634provisionforassets01()
        return   "SELECT contractData.t_branchId             AS t_branchId,"
        + "\n" + "       contractData.t_contractId           AS t_contractId,"
        + "\n" + "       'Д ' || contractData.t_number       AS t_contractNumber,"
        + "\n" + "       contractData.t_fiId                 AS t_fiId,"
        + "\n" + "       NULL                                AS t_securedAmount,"
        + "\n" + "       contractData.t_reserveAmount        AS t_reserveAmount,"
        + "\n" + "       contractData.t_roubleReserveAmount  AS t_roubleReserveAmount,"
        + "\n" + "       NULL                                AS t_registerRest,"
        + "\n" + "       contractData.t_reserveAmount        AS t_value,"
        + "\n" + "       contractData.t_roubleReserveAmount  AS t_roubleValue,"
        + "\n" + "       NULL                                AS t_registerType,"
        + "\n" + "       NULL                                AS t_contractFiId,"
        + "\n" + "       NULL                                AS t_percentAccountNumber,"
        + "\n" + "       NULL                                AS t_percentAccountRest,"
        + "\n" + "       NULL                                AS t_reservePercent,"
        + "\n" + "       contractData.t_usedByPosition       AS t_usedByPosition,"
        + "\n" + "       contractData.t_key                  AS t_key"
        + "\n" + "  FROM (SELECT contract.t_branchId                                                                        AS t_branchId,"
        + "\n" + "               contract.t_id                                                                              AS t_contractId,"
        + "\n" + "               contract.t_number                                                                          AS t_number,"
        + "\n" + "               contract.t_fiId                                                                            AS t_fiId,"
        + "\n" + "               NVL(rsb_fiinstr.convSumType(reserve.t_rvpsSum,"
        + "\n" + "                                           0,"
        + "\n" + "                                           contract.t_fiId,"
        + "\n" + "                                       " + RATETYPE_CB + ","
        + "\n" + "                                           reserve.t_rvpsDate"
        + "\n" + "                                          ), 0"
        + "\n" + "                  )"
        + "\n" + "             + NVL(rsb_fiinstr.convSumType(reserve.t_delayedRvpsSum,"
        + "\n" + "                                           0,"
        + "\n" + "                                           contract.t_fiId,"
        + "\n" + "                                       " + RATETYPE_CB + ","
        + "\n" + "                                           reserve.t_delayedRvpsDate"
        + "\n" + "                                          ), 0"
        + "\n" + "                  )"
        + "\n" + "             + NVL(rsb_fiinstr.convSumType(reserve.t_percentRvpSum,"
        + "\n" + "                                           0,"
        + "\n" + "                                           contract.t_fiId,"
        + "\n" + "                                       " + RATETYPE_CB + ","
        + "\n" + "                                           reserve.t_rvpPercentDate"
        + "\n" + "                                          ), 0"
        + "\n" + "                  )"
        + "\n" + "             + NVL(rsb_fiinstr.convSumType(reserve.t_delayedPercentRvpSum,"
        + "\n" + "                                           0,"
        + "\n" + "                                           contract.t_fiId,"
        + "\n" + "                                       " + RATETYPE_CB + ","
        + "\n" + "                                           reserve.t_delayedRvpPercentDate"
        + "\n" + "                                          ), 0"
        + "\n" + "                  )"
        + "\n" + "             + NVL(rsb_fiinstr.convSumType(reserve.t_calcRvpKomiss,"
        + "\n" + "                                           0,"
        + "\n" + "                                           contract.t_fiId,"
        + "\n" + "                                       " + RATETYPE_CB + ","
        + "\n" + "                                           reserve.t_rvpKomissDate"
        + "\n" + "                                          ), 0"
        + "\n" + "                  )                                                                                       AS t_reserveAmount,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId = 0"
        + "\n" + "                   THEN   NVL(contract.t_rvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedRvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_percentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedPercentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_commissionRvpSum, 0)"
        + "\n" + "                   ELSE   NVL(contract.t_rvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedRvpsSum, 0)"
        + "\n" + "                        + NVL(contract.t_percentRvpSum, 0)"
        + "\n" + "                        + NVL(contract.t_delayedPercentRvpSum, 0)"
        + "\n" + "               END                                                                                        AS t_roubleReserveAmount,"
        + "\n" + "           " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + "                                     AS t_usedByPosition,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN contract.t_briefCaseId = 0"
        + "\n" + "                   THEN " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + " || TO_CHAR(contract.t_id) || TO_CHAR(contract.t_briefCaseId) || TO_CHAR(contract.t_fiId) || '1'"
        + "\n" + "                   ELSE " + getSqlString(m_parameters.getCode_vvv_rez_bal_k()) + " || TO_CHAR(contract.t_id) || TO_CHAR(contract.t_briefCaseId) || TO_CHAR(contract.t_fiId) || '2'"
        + "\n" + "               END                                                                                        AS t_key"
        + "\n" + "          FROM F634CONTRACT_VW contract,"
        + "\n" + "               repLnsReserve_vw reserve"

        + "\n" + "         WHERE contract.t_type              != " + LO_DEPOSIT
        + "\n" + "           AND contract.t_fiId              != 0"
        + "\n" + "           AND contract.t_isOpenedAtEndDate  = 1"
        + "\n" + "           AND contract.t_id                 = reserve.t_objectNumber"
        + "\n" + "           AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
        + "\n" + "       ) contractData";
    end;

    // Полученные гарантии и поручительства для расчета VVV_ГарантииПолуч_К_
    private macro getQueryText_f634guarantyreceived()
        return   "/*  VVV_ГарантииПолуч_К_  */"
        + "\n" + "SELECT guaranty.t_contractId                                        AS T_CONTRACTID,"
        + "\n" + "       guaranty.t_contractNumber                                    AS T_CONTRACTNUMBER,"
        + "\n" + "       guaranty.t_currencyId                                        AS T_FIID,"
        + "\n" + "       guaranty.t_S_Oi                                              AS T_SECUREDAMOUNT,"
        + "\n" + "       guaranty.t_rezCurrencySum                                    AS T_RESERVEAMOUNT,"
        + "\n" + "       guaranty.t_rezRoubleSum                                      AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NULL                                                         AS T_REGISTERREST,"
        + "\n" + "       guaranty.t_sum                                               AS T_VALUE,"
        + "\n" + "       guaranty.t_sum_rub                                           AS T_ROUBLEVALUE,"
        + "\n" + "       NULL                                                         AS T_REGISTERTYPE,"
        + "\n" + "       guaranty.t_contractCurrensyId                                AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                         AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                         AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                         AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garantiipolu4_k()) + " AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_garantiipolu4_k()) + " || TO_CHAR(guaranty.t_contractId)  AS T_KEY"
        + "\n" + "  FROM DF634GUARANTY_TMP guaranty"
        + "\n" + " WHERE guaranty.t_isGuarantee = 1"
        ;
    end;

    // Залоги для расчета VVV_Залог_К_
    private macro getQueryText_f634pledge()
        return   "/*  VVV_Залог_К_  */"
        + "\n" + "SELECT guaranty.t_contractId                                AS T_CONTRACTID,"
        + "\n" + "       guaranty.t_contractNumber                            AS T_CONTRACTNUMBER,"
        + "\n" + "       guaranty.t_currencyId                                AS T_FIID,"
        + "\n" + "       guaranty.t_S_Oi                                      AS T_SECUREDAMOUNT,"
        + "\n" + "       guaranty.t_rezCurrencySum                            AS T_RESERVEAMOUNT,"
        + "\n" + "       guaranty.t_rezRoubleSum                              AS T_ROUBLERESERVEAMOUNT,"
        + "\n" + "       NULL                                                 AS T_REGISTERREST,"
        + "\n" + "       guaranty.t_sum                                       AS T_VALUE,"
        + "\n" + "       guaranty.t_sum_rub                                   AS T_ROUBLEVALUE,"
        + "\n" + "       NULL                                                 AS T_REGISTERTYPE,"
        + "\n" + "       guaranty.t_contractCurrensyId                        AS T_CONTRACTFIID,"
        + "\n" + "       NULL                                                 AS T_PERCENTACCOUNTNUMBER,"
        + "\n" + "       NULL                                                 AS T_PERCENTACCOUNTREST,"
        + "\n" + "       NULL                                                 AS T_RESERVEPERCENT,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_zalog_k()) + " AS T_USEDBYPOSITION,"
        + "\n" + "   " + getSqlString(m_parameters.getCode_vvv_zalog_k()) + " || TO_CHAR(guaranty.t_contractId)  AS T_KEY"
        + "\n" + "  FROM DF634GUARANTY_TMP guaranty"
        + "\n" + " WHERE guaranty.t_isGuarantee = 0"
        ;
    end;
end;

/**
 *  Класс построения текста SQL-запроса для источника данных счетов Loans
 */
private class TDataSourceLnAccountQueryTextMaker(parameters : TParametersLn)

    private var m_parameters : TParameters;

    private macro getParameters()
        return m_parameters;
    end;

    /**
     *  Текст запроса для отбора счетов Loans, использованных в расчете
     */
    macro getQueryText()
        return          "SELECT account.a_creditNumber  AS t_creditId,"
               + "\n" + "       account.a_chapter       AS t_chapter,"
               + "\n" + "       account.a_odbAccount    AS t_cbAccountNumber,"
               + "\n" + "       CHR(1)                  AS t_balance,"
               + "\n" + "       account.a_curcode       AS t_fiId,"
               + "\n" + "   " + BoLoans + "             AS t_backOfficeId,"
               + "\n" + "       1                       AS t_isIncluded,"
               + "\n" + "       CHR(1)                  AS t_type"
               + "\n" + "  FROM df634ln_tmp loansData,"
               + "\n" + "       OrmLnsACCOUNT account"
               + "\n" + " WHERE account.a_creditNumber = loansData.t_creditId";
    end;

    private macro constructorTDataSourceLnAccountQueryTextMaker(parameters : TParametersLn)

        m_parameters = parameters;

    end;

    constructorTDataSourceLnAccountQueryTextMaker(parameters);

end;

/**
 *  Источник данных Loans
 */
private class (TDataSourceBase) TDataSourceLn(parameters : TParametersLn)

    private macro cache()
        var commandText : String;

//        commandText = "INSERT INTO DF634CONTRACT_TMP"
//             + "\n" + "("
//             + "\n" + "    T_ID,"
//             + "\n" + "    T_BRANCHID,"
//             + "\n" + "    T_NUMBER,"
//             + "\n" + "    T_FIID,"
//             + "\n" + "    T_TYPE,"
//             + "\n" + "    T_RVPSQUALITYCATEGORY,"
//             + "\n" + "    T_RVPSRESERVEPERCENT,"
//             + "\n" + "    T_RVPSSUM,"
//             + "\n" + "    T_DELAYEDRVPSSUM,"
//             + "\n" + "    T_RVPSUM,"
//             + "\n" + "    T_PERCENTRVPSUM,"
//             + "\n" + "    T_DELAYEDPERCENTRVPSUM,"
//             + "\n" + "    T_COMMISSIONRVPSUM,"
//             + "\n" + "    T_BRIEFCASEID,"
//             + "\n" + "    T_PORTFOLIODEBTID"
//             + "\n" + ")"
//             + "\n" + "SELECT contract.t_id,"
//             + "\n" + "       contract.t_branchId,"
//             + "\n" + "       contract.t_number,"
//             + "\n" + "       contract.t_fiId,"
//             + "\n" + "       contract.t_type,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type = " + LO_GUARANTEE
//             + "\n" + "           THEN contract.t_rvpsQualityCategory"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_rvpsQualityCategory,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type != " + LO_DEPOSIT
//             + "\n" + "           THEN NVL(contract.t_rvpsReservePercent, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_rvpsReservePercent,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
//             + "\n" + "           THEN NVL(contract.t_rvpsSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_rvpsSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type NOT IN(" + LO_GUARANTEE + ", " + LO_DEPOSIT + ")"
//             + "\n" + "           THEN NVL(contract.t_delayedRvpsSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_delayedRvpsSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type = " + LO_GUARANTEE
//             + "\n" + "            AND contract.t_rvpsQualityCategory IN (4, 5)"
//             + "\n" + "            AND contract.t_fiId != 0"
//             + "\n" + "           THEN NVL(contract.t_rvpSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_rvpSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type != " + LO_DEPOSIT
//             + "\n" + "           THEN NVL(contract.t_percentRvpSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_percentRvpSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type != " + LO_DEPOSIT
//             + "\n" + "           THEN NVL(contract.t_delayedPercentRvpSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_delayedPercentRvpSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type != " + LO_DEPOSIT
//             + "\n" + "           THEN NVL(contract.t_commissionRvpSum, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_commissionRvpSum,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type != " + LO_DEPOSIT
//             + "\n" + "           THEN NVL(contract.t_briefCaseId, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_briefCaseId,"
//             + "\n" + "       CASE"
//             + "\n" + "           WHEN contract.t_type = " + LO_GUARANTEE
//             + "\n" + "            AND contract.t_rvpsQualityCategory IN (4, 5)"
//             + "\n" + "            AND contract.t_fiId != 0"
//             + "\n" + "           THEN NVL(contract.t_portfolioDebtId, 0)"
//             + "\n" + "           ELSE NULL"
//             + "\n" + "       END                                     AS t_portfolioDebtId"
//             + "\n" + "  FROM REPLNSCONTRACT_VW contract"
//             + "\n" + " WHERE " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("contract.t_departmentId","contract.t_branchId")
//             + "\n" + "   AND contract.t_isOpenedAtEndDate = 1"
//        ;
//        sql_execute(commandText);

        commandText = "TRUNCATE TABLE DF634GUARANTY_TMP";
        sql_execute(commandText);

        commandText = "INSERT INTO DF634GUARANTY_TMP"
             + "\n" + "("
             + "\n" + "    T_ISGUARANTEE,"
             + "\n" + "    T_CONTRACTID,"
             + "\n" + "    T_CURRENCYID,"
             + "\n" + "    T_SUM"
             + "\n" + ")"
             + "\n" + " SELECT 1                            AS t_isGuarantee,"
             + "\n" + "        guaranty.t_contractId        AS t_contractId,"
             + "\n" + "        guaranty.t_ratingCurrencyId  AS t_currencyId,"
             + "\n" + "        SUM(guaranty.t_ratingSum)    AS t_sum"
             + "\n" + "   FROM REPLNSGUARANTY_VW guaranty"
             + "\n" + "  WHERE guaranty.t_systemType = 1"
             + "\n" + "    AND guaranty.t_ratingCurrencyId != 0"
             + "\n" + "  GROUP BY guaranty.t_ratingCurrencyId,"
             + "\n" + "           guaranty.t_contractId"
             + "\n" + " UNION ALL"
             + "\n" + " SELECT 0,"
             + "\n" + "        guaranty.t_contractId,"
             + "\n" + "        guaranty.t_ratingCurrencyId,"
             + "\n" + "        SUM(guaranty.t_ratingSum)"
             + "\n" + "   FROM REPLNSGUARANTY_VW guaranty"
             + "\n" + "  WHERE guaranty.t_systemType IN (2,3,4,5)"
             + "\n" + "    AND guaranty.t_ratingCurrencyId != 0"
             + "\n" + "  GROUP BY guaranty.t_ratingCurrencyId,"
             + "\n" + "           guaranty.t_contractId"
        ;
        sql_execute(commandText);

//        commandText = "INSERT INTO DF634CONTRACTDATA_TMP"
//             + "\n" + "("
//             + "\n" + "    T_ID,"
//             + "\n" + "    T_BRANCHID,"
//             + "\n" + "    T_NUMBER,"
//             + "\n" + "    T_FIID,"
//             + "\n" + "    T_TYPE,"
//             + "\n" + "    T_RVPSQUALITYCATEGORY,"
//             + "\n" + "    T_RVPSRESERVEPERCENT,"
//             + "\n" + "    T_RVPSSUM,"
//             + "\n" + "    T_DELAYEDRVPSSUM,"
//             + "\n" + "    T_RVPSUM,"
//             + "\n" + "    T_PERCENTRVPSUM,"
//             + "\n" + "    T_DELAYEDPERCENTRVPSUM,"
//             + "\n" + "    T_COMMISSIONRVPSUM,"
//             + "\n" + "    T_BRIEFCASEID,"
//             + "\n" + "    T_PORTFOLIODEBTID,"
//             + "\n" + "    T_TRANCHEKIND,"
//             + "\n" + "    T_TRANCHENUMBER,"
//             + "\n" + "    T_TRANCHEISOPENEDATENDDATE,"
//             + "\n" + ")"
//             + "\n" + "SELECT contract.t_id,"
//             + "\n" + "       contract.t_branchId,"
//             + "\n" + "       contract.t_number,"
//             + "\n" + "       contract.t_fiId,"
//             + "\n" + "       contract.t_type,"
//             + "\n" + "       contract.t_rvpsQualityCategory,"
//             + "\n" + "       contract.t_rvpsReservePercent,"
//             + "\n" + "       contract.t_rvpsSum,"
//             + "\n" + "       contract.t_delayedRvpsSum,"
//             + "\n" + "       contract.t_rvpSum,"
//             + "\n" + "       contract.t_percentRvpSum,"
//             + "\n" + "       contract.t_delayedPercentRvpSum,"
//             + "\n" + "       contract.t_commissionRvpSum,"
//             + "\n" + "       contract.t_briefCaseId,"
//             + "\n" + "       contract.t_portfolioDebtId,"
//             + "\n" + "       tranche.t_trancheKind,"
//             + "\n" + "       tranche.t_trancheNumber"
//             + "\n" + "       tranche.t_isOpenedAtEndDate"
//             + "\n" + "  FROM DF634CONTRACT_TMP contract"
//             + "\n" + "       REPLNSTRANCHES_VW tranche"
//             + "\n" + " WHERE tranche.t_contractId = contract.t_id"
//        ;
//        sql_execute(commandText);
    end;

    private macro createDataset(queryText) : Object
        var dataset = TRsbDataset(queryText);

        dataset.setFieldType("T_CREDITID",              V_INTEGER);
        dataset.setFieldType("T_USERCREDITNUMBER",      V_STRING);
        dataset.setFieldType("T_FIID",                  V_INTEGER);
        dataset.setFieldType("T_SECUREDAMOUNT",         V_MONEY);
        dataset.setFieldType("T_RESERVEAMOUNT",         V_MONEY);
        dataset.setFieldType("T_ROUBLERESERVEAMOUNT",   V_MONEY);
        dataset.setFieldType("T_REGISTERREST",          V_MONEY);
        dataset.setFieldType("T_VALUE",                 V_MONEY);
        dataset.setFieldType("T_ROUBLEVALUE",           V_MONEY);
        dataset.setFieldType("T_REGISTERTYPE",          V_INTEGER);
        dataset.setFieldType("T_CREDITFIID",            V_INTEGER);
        dataset.setFieldType("T_PERCENTACCOUNTNUMBER",  V_STRING);
        dataset.setFieldType("T_PERCENTACCOUNTREST",    V_MONEY);
        dataset.setFieldType("T_RESERVEPERCENT",        V_MONEY);
        dataset.setFieldType("T_USEDBYPOSITION",        V_STRING);
        dataset.setFieldType("T_KEY",                   V_STRING);

        return dataset;
    end;

    private macro constructorTDataSourceLn(parameters : TParametersLn)

        initTDataSourceBase(BoLoans, parameters);

        cache();

        var queryText = TDataSourceLnQueryTextMaker(parameters);

//        m_container[m_container.size] = queryText.getQueryText("f634guarantyissued");
//        m_container[m_container.size] = queryText.getQueryText("f634guarantyreceived");
//        m_container[m_container.size] = queryText.getQueryText("f634guarantyreceived810");
//        m_container[m_container.size] = queryText.getQueryText("f634offbalancetotal");
//        m_container[m_container.size] = queryText.getQueryText("f634pledge");
//        m_container[m_container.size] = queryText.getQueryText("f634provisionforassets01");
//        m_container[m_container.size] = queryText.getQueryText("f634provisionforassets02");
//        m_container[m_container.size] = queryText.getQueryText("f634provisionforguaranty");

        m_container[m_container.size] = createDataset(queryText.getQueryText("f634guarantyissued"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634guarantyreceived"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634guarantyreceived810"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634offbalancetotal"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634pledge"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforassets01"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforassets02"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforguaranty"));

    end;

    constructorTDataSourceLn(parameters);
end;

/**
 *  Источник данных Loans по инструкции XXXX-У1
 */
private class (TDataSourceLn) TDataSourceLn_XXXX1(parameters : TParametersLn)

    private macro cache()
        var commandText : String;

        commandText = "TRUNCATE TABLE DF634GUARANTY_TMP";
        sql_execute(commandText);

        commandText = "INSERT INTO DF634GUARANTY_TMP"
             + "\n" + "("
             + "\n" + "    T_ISGUARANTEE,                                                                                                                                                    "
             + "\n" + "    T_CONTRACTID,                                                                                                                                                     "
             + "\n" + "    T_CONTRACTNUMBER,                                                                                                                                                 "
             + "\n" + "    T_CONTRACTCURRENSYID,                                                                                                                                             "
             + "\n" + "    T_S_OI,                                                                                                                                                           "
             + "\n" + "    T_REZCURRENCYSUM,                                                                                                                                                 "
             + "\n" + "    T_REZROUBLESUM,                                                                                                                                                   "
             + "\n" + "    T_CURRENCYID,                                                                                                                                                     "
             + "\n" + "    T_SUM,                                                                                                                                                            "
             + "\n" + "    T_SUM_RUB                                                                                                                                                         "
             + "\n" + ")                                                                                                                                                                     "
             + "\n" + "SELECT * FROM (                                                                                                                                                       "
             + "\n" + "with t6 as                                                                                                                                                            "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + " --для VVV_ГарантииПолуч_К                                                                                                                                            "
             + "\n" + " SELECT 1                            AS t_isGuarantee,                                                                                                                "
             + "\n" + "        guaranty.t_id                AS t_guaranteeId,                                                                                                                "
             + "\n" + "        guaranty.t_contractId        AS t_contractId,                                                                                                                 "
             + "\n" + "        contract.t_type              as t_contractType,                                                                                                               "
             + "\n" + "        contract.t_number            AS t_contractNumber,                                                                                                             "
             + "\n" + "        contract.t_fiId              AS t_contractCurrensyId,                                                                                                         "
             + "\n" + "        guaranty.t_ratingCurrencyId  AS t_currencyId,                                                                                                                 "
             + "\n" + "        -1                           AS t_garantId,                        --для контргарантии определение финансового положения гаранта не требуется                 "
             + "\n" + "        guaranty.t_ratingSum         AS S_Ob,                              --ВалСтоимостьОбеспечения                                                                  "
             + "\n" + "        (select SUM(NVL(rsb_fiinstr.convSumType(t_roubleRest,                                                                                                         "
             + "\n" + "                                            " + NATCUR + ","
             + "\n" + "                                                guaranty.t_ratingCurrencyId,                                                                                          "
             + "\n" + "                                            " + RATETYPE_CB + ","
             + "\n" + "                                            " + m_reportDate
             + "\n" + "                                               ),                                                                                                                     "
             + "\n" + "                        0                                                                                                                                             "
             + "\n" + "                       )                                                                                                                                              "
             + "\n" + "                   )                                                                                                                                                  "
             + "\n" + "           from repLnsRegister_vw register_                                                                                                                           "
             + "\n" + "          where register_.t_trancheNumber = guaranty.t_contractId                                                                                                     "
             + "\n" + "            and register_.t_type IN (1, 2, 16, 17, 55, 62, 64)) AS Ti      --сумма ОД                                                                                 "
             + "\n" + "   FROM REPLNSGUARANTY_VW guaranty,                                                                                                                                   "
             + "\n" + "        REPLNSCONTRACT_VW contract                                                                                                                                    "
             + "\n" + "  WHERE guaranty.t_systemType        = 1                                   --системный тип обеспечения: Поручительство (1)                                            "
             + "\n" + "    AND guaranty.t_ratingCurrencyId != 0                                                                                                                              "
             + "\n" + "    AND guaranty.t_contractId        = contract.t_id                                                                                                                  "
             + "\n" + " UNION ALL                                                                                                                                                            "
             + "\n" + " --для VVV_Залог_К_                                                                                                                                                   "
             + "\n" + " SELECT 0,                                                                                                                                                            "
             + "\n" + "        guaranty.t_id,                                                                                                                                                "
             + "\n" + "        guaranty.t_contractId,                                                                                                                                        "
             + "\n" + "        contract.t_type,                                                                                                                                              "
             + "\n" + "        contract.t_number            AS t_contractNumber,                                                                                                             "
             + "\n" + "        contract.t_fiId              AS t_contractCurrensyId,                                                                                                         "
             + "\n" + "        guaranty.t_ratingCurrencyId,                                                                                                                                  "
             + "\n" + "        guaranty.t_garantId,                                                                                                                                          "
             + "\n" + "        guaranty.t_ratingSum,                                                                                                                                         "
             + "\n" + "        (select SUM(NVL(rsb_fiinstr.convSumType(t_roubleRest,                                                                                                         "
             + "\n" + "                                            " + NATCUR + ","
             + "\n" + "                                                guaranty.t_ratingCurrencyId,                                                                                          "
             + "\n" + "                                            " + RATETYPE_CB + ","
             + "\n" + "                                            " + m_reportDate
             + "\n" + "                                               ),                                                                                                                     "
             + "\n" + "                        0                                                                                                                                             "
             + "\n" + "                       )                                                                                                                                              "
             + "\n" + "                   )                                                                                                                                                  "
             + "\n" + "           from repLnsRegister_vw register_                                                                                                                           "
             + "\n" + "          where register_.t_trancheNumber = guaranty.t_contractId                                                                                                     "
             + "\n" + "            and register_.t_type IN (1, 2, 16, 17, 55, 62, 64)) AS Ti      --сумма ОД                                                                                 "
             + "\n" + "   FROM REPLNSGUARANTY_VW guaranty,                                                                                                                                   "
             + "\n" + "        REPLNSCONTRACT_VW contract                                                                                                                                    "
             + "\n" + "  WHERE guaranty.t_systemType IN (2,3,4,5)                                 --системный тип обеспечения: Залог ЦБ (2), Залог имущества (3), Залог драгоценных металлов (4), Залог прав требований по вкладу (5)"
             + "\n" + "    AND guaranty.t_ratingCurrencyId != 0                                                                                                                              "
             + "\n" + "    AND guaranty.t_contractId        = contract.t_id                                                                                                                  "
             + "\n" + "),                                                                                                                                                                    "
             + "\n" + "t7 as                                                                                                                                                                 "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + "SELECT t_contractId     AS t_contractId,                                                                                                                              "
             + "\n" + "       SUM(Ti)          AS S_D                                             --общая сумма обеспеченного ОД по Договорам, привязанным к одному обеспечению              "
             + "\n" + "  FROM t6                                                                                                                                                             "
             + "\n" + " GROUP BY t_contractId                                                                                                                                                "
             + "\n" + "),                                                                                                                                                                    "

             + "\n" + "--Резервы                                                                                                                                                             "
             + "\n" + "t10 as                                                                                                                                                                "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + "select t_contractId,                                                                                                                                                  "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_calcRvpsSum,                                                                                                             "
             + "\n" + "                                   reserve.t_curRvps,                                                                                                                 "
             + "\n" + "                                   t6.t_currencyId,                                                                                                                   "
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_rvpsDate                                                                                                                 "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS CalcRVPS,                                                                                              "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_calcDelayedRvpsSum,                                                                                                      "
             + "\n" + "                                   reserve.t_delayedRvpsCur,                                                                                                          "
             + "\n" + "                                   t6.t_currencyId,                                                                                                                   "
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_delayedRvpsDate                                                                                                          "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS CalcExpRVPS,                                                                                           "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                THEN NVL(rsb_fiinstr.convSumType(reserve.t_calcRvpSum,                                                                                                "
             + "\n" + "                                                 reserve.t_rvpCur,                                                                                                    "
             + "\n" + "                                                 t6.t_currencyId,                                                                                                     "
             + "\n" + "                                             " + RATETYPE_CB + ","
             + "\n" + "                                                 reserve.t_rvpDate                                                                                                    "
             + "\n" + "                                                ),                                                                                                                    "
             + "\n" + "                         0                                                                                                                                            "
             + "\n" + "                        )                                                                                                                                             "
             + "\n" + "                ELSE 0                                                                                                                                                "
             + "\n" + "            END                                             AS CalcRVP,                                                                                               "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_rvpsSum,                                                                                                                 "
             + "\n" + "                                   reserve.t_curRvps,                                                                                                                 "
             + "\n" + "                                   t6.t_currencyId,                                                                                                                   "
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_rvpsDate                                                                                                                 "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS RezRVPS,                                                                                               "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_rvpsSum,                                                                                                                 "
             + "\n" + "                                   reserve.t_curRvps,                                                                                                                 "
             + "\n" + "                               " + NATCUR + ","
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_rvpsDate                                                                                                                 "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS RezRVPSrub,                                                                                            "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_delayedRvpsSum,                                                                                                          "
             + "\n" + "                                   reserve.t_delayedRvpsCur,                                                                                                          "
             + "\n" + "                                   t6.t_currencyId,                                                                                                                   "
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_delayedRvpsDate                                                                                                          "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS RezExpRVPS,                                                                                            "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(reserve.t_delayedRvpsSum,                                                                                                          "
             + "\n" + "                                   reserve.t_delayedRvpsCur,                                                                                                          "
             + "\n" + "                                   0,                                                                                                                                 "
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                                   reserve.t_delayedRvpsDate                                                                                                          "
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )                                                 AS RezExpRVPSrub,                                                                                         "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                THEN NVL(rsb_fiinstr.convSumType(reserve.t_rvpSum,                                                                                                    "
             + "\n" + "                                                 reserve.t_rvpCur,                                                                                                    "
             + "\n" + "                                                 t6.t_currencyId,                                                                                                     "
             + "\n" + "                                             " + RATETYPE_CB + ","
             + "\n" + "                                                 reserve.t_rvpDate                                                                                                    "
             + "\n" + "                                                ),                                                                                                                    "
             + "\n" + "                         0                                                                                                                                            "
             + "\n" + "                        )                                                                                                                                             "
             + "\n" + "                ELSE 0                                                                                                                                                "
             + "\n" + "            END                                             AS RezRVP,                                                                                                "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                THEN NVL(rsb_fiinstr.convSumType(reserve.t_rvpSum,                                                                                                    "
             + "\n" + "                                                 reserve.t_rvpCur,                                                                                                    "
             + "\n" + "                                             " + NATCUR + ","
             + "\n" + "                                             " + RATETYPE_CB + ","
             + "\n" + "                                                 reserve.t_rvpDate                                                                                                    "
             + "\n" + "                                                ),                                                                                                                    "
             + "\n" + "                         0                                                                                                                                            "
             + "\n" + "                        )                                                                                                                                             "
             + "\n" + "                ELSE 0                                                                                                                                                "
             + "\n" + "            END                                             AS RezRVPrub                                                                                              "
             + "\n" + "  from repLnsReserve_vw reserve, t6                                                                                                                                   "
             + "\n" + " where t6.t_contractId  = reserve.t_objectNumber                                                                                                                      "
             + "\n" + "),                                                                                                                                                                    "
             + "\n" + "t9 as                                                                                                                                                                 "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + "SELECT t_isGuarantee,                                                                                                                                                 "
             + "\n" + "       t6.t_contractId,                                                                                                                                               "
             + "\n" + "       t6.t_contractNumber,                                                                                                                                           "
             + "\n" + "       t6.t_contractCurrensyId,                                                                                                                                       "
             + "\n" + "       t6.t_contractType,                                                                                                                                             "
             + "\n" + "       t_currencyId,                                                                                                                                                  "
             + "\n" + "       Ti,                                                                                                                                                            "
             + "\n" + "       SUM(S_Ob * (Ti / S_D))                               AS t_ensuringSum, --Сумма обеспечения по договору                                                         "
             + "\n" + "       CalcRVPS,                                                                                                                                                      "
             + "\n" + "       CalcExpRVPS,                                                                                                                                                   "
             + "\n" + "       CalcRVP,                                                                                                                                                       "
             + "\n" + "       RezRVPS,                                                                                                                                                       "
             + "\n" + "       RezExpRVPS,                                                                                                                                                    "
             + "\n" + "       RezRVP,                                                                                                                                                        "
             + "\n" + "       RezRVPSrub,                                                                                                                                                    "
             + "\n" + "       RezExpRVPSrub,                                                                                                                                                 "
             + "\n" + "       RezRVPrub,                                                                                                                                                     "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "           WHEN t_contractType != " + LO_GUARANTEE
             + "\n" + "               THEN 'Простое обеспечение'                                                                                                                             "
             + "\n" + "           ELSE 'Контргарантия'                                                                                                                                       "
             + "\n" + "       END                                                  AS t_ensuringType                                                                                         "
             + "\n" + "  FROM t6, t7, t10                                                                                                                                                    "
             + "\n" + " WHERE t6.t_contractId  = t7.t_contractId                                                                                                                             "
             + "\n" + "   AND t6.t_contractId  = t10.t_contractId                                                                                                                            "
             + "\n" + " GROUP BY t6.t_contractId, t_isGuarantee, t_contractNumber, t_contractCurrensyId, t_currencyId, Ti, /*t_isHardFinancialState, t_termFinancialState,*/ t_contractType,     "
             + "\n" + "       CalcRVPS, CalcExpRVPS, CalcRVP,                                                                                                                                "
             + "\n" + "       RezRVPS, RezExpRVPS, RezRVP,                                                                                                                                   "
             + "\n" + "       RezRVPSrub, RezExpRVPSrub, RezRVPrub                                                                                                                           "
             + "\n" + " ORDER BY t6.t_contractId                                                                                                                                             "
             + "\n" + "),                                                                                                                                                                    "
             + "\n" + "t12 as                                                                                                                                                                "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + "SELECT t_isGuarantee,                                                                                                                                                 "
             + "\n" + "       t_contractId,                                                                                                                                                  "
             + "\n" + "       t_contractNumber,                                                                                                                                              "
             + "\n" + "       t_contractCurrensyId,                                                                                                                                          "
             + "\n" + "       t_currencyId,                                                                                                                                                  "
             + "\n" + "       t_ensuringType,                                                                                                                                                "
             + "\n" + "       Ti,                                                                                                                                                            "
             + "\n" + "       t_ensuringSum,                                                                                                                                                 "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "           WHEN t_ensuringType = 'Простое обеспечение'                                                                                                                "
             + "\n" + "               THEN CASE                                                                                                                                              "
             + "\n" + "                        WHEN (t_ensuringSum - ((CalcRVPS + RezExpRVPS + CalcRVP) - (RezRVPS + RezExpRVPS + RezRVP))) > 0                                              "
             + "\n" + "                            THEN t_ensuringSum - ((CalcRVPS + RezExpRVPS + CalcRVP) - (RezRVPS + RezExpRVPS + RezRVP))                                                "
             + "\n" + "                        ELSE 0                                                                                                                                        "
             + "\n" + "                    END                                                                                                                                               "
             + "\n" + "           ELSE t_ensuringSum  --Контргарантия                                                                                                                        "
             + "\n" + "       END                                                  O_,                                                                                                       "
             + "\n" + "       (RezRVPS + RezExpRVPS + RezRVP)                      t_rezCurrencySum,   --сумма сформированного резерва по договору                                           "
             + "\n" + "       (RezRVPSrub + RezExpRVPSrub + RezRVPrub)             t_rezRoubleSum      --сумма сформированного резерва по договору                                           "
             + "\n" + "  FROM t9                                                                                                                                                             "
             + "\n" + "),                                                                                                                                                                    "
             + "\n" + "t13 as                                                                                                                                                                "
             + "\n" + "(                                                                                                                                                                     "
             + "\n" + "SELECT t_isGuarantee,                                                                                                                                                 "
             + "\n" + "       t_contractId,                                                                                                                                                  "
             + "\n" + "       t_contractNumber,                                                                                                                                              "
             + "\n" + "       t_contractCurrensyId,                                                                                                                                          "
             + "\n" + "       t_ensuringSum,                                                                                                                                                 "
             + "\n" + "       t_rezCurrencySum,                                                                                                                                              "
             + "\n" + "       t_rezRoubleSum,                                                                                                                                                "
             + "\n" + "       t_currencyId,                                                                                                                                                  "
             + "\n" + "       CASE                                                                                                                                                           "
             + "\n" + "           WHEN t_ensuringType = 'Простое обеспечение'                                                                                                                "
             + "\n" + "               THEN CASE                                                                                                                                              "
             + "\n" + "                        --VVV_ГарантииПолуч_К                                                                                                                         "
             + "\n" + "                        WHEN t_isGuarantee = 1                                                                                                                        "
             + "\n" + "                            THEN CASE                                                                                                                                 "
             + "\n" + "                                     WHEN t_rezCurrencySum <= O_                                                                                                      "
             + "\n" + "                                         THEN t_rezCurrencySum                                                                                                        "
             + "\n" + "                                     ELSE O_                                                                                                                          "
             + "\n" + "                                 END                                                                                                                                  "
             + "\n" + "                        --VVV_Залог_К_                                                                                                                                "
             + "\n" + "                        ELSE CASE                                                                                                                                     "
             + "\n" + "                                 WHEN t_rezCurrencySum <= O_ AND O_ < Ti                                                                                              "
             + "\n" + "                                     THEN t_rezCurrencySum                                                                                                            "
             + "\n" + "                                 ELSE O_                                                                                                                              "
             + "\n" + "                             END                                                                                                                                      "
             + "\n" + "                    END                                                                                                                                               "
             + "\n" + "           ELSE CASE                                                                                                                                                  "
             + "\n" + "                    WHEN O_ < (Ti - t_rezCurrencySum)                                                                                                                 "
             + "\n" + "                        THEN O_                                                                                                                                       "
             + "\n" + "                    ELSE Ti - t_rezCurrencySum                                                                                                                        "
             + "\n" + "                END                                                                                                                                                   "
             + "\n" + "       END                                               AS P                    --результирующая сумма                                                               "
             + "\n" + "  FROM t12                                                                                                                                                            "
             + "\n" + ")                                                                                                                                                                     "
             + "\n" + "SELECT t_isGuarantee,                                                                                                                                                 "
             + "\n" + "       t_contractId,                                                                                                                                                  "
             + "\n" + "       t_contractNumber,                                                                                                                                              "
             + "\n" + "       t_contractCurrensyId,                                                                                                                                          "
             + "\n" + "       t_ensuringSum,                                                                                                                                                 "
             + "\n" + "       t_rezCurrencySum,                                                                                                                                              "
             + "\n" + "       t_rezRoubleSum,                                                                                                                                                "
             + "\n" + "       t_currencyId,                                                                                                                                                  "
             + "\n" + "       P,                        --результирующая сумма в валюте                                                                                                      "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(P,                                                                                                                                 "
             + "\n" + "                                   t_currencyId,                                                                                                                      "
             + "\n" + "                               " + NATCUR + ","
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                               " + m_reportDate
             + "\n" + "                                  ),                                                                                                                                  "
             + "\n" + "           0                                                                                                                                                          "
             + "\n" + "          )  AS P_rub                                                            --результирующая сумма в рублях                                                      "
             + "\n" + "  FROM t13                                                                                                                                                            "
             + "\n" + ")                                                                                                                                                                     "
        ;
        sql_execute(commandText);
    end;

    private macro constructorTDataSourceLn_XXXX1(parameters : TParametersLn)

        initTDataSourceBase(BoLoans, parameters);

        m_reportDate = getSqlDate(m_parameters.getendDate());

        //инициализация вьюхи OrmLnsReserve
        sql_execute(         "BEGIN"
                    + "\n" +     "LoansVOX.fillLoansRezData(" + getSqlDate(m_parameters.getBeginDate()) + ", " + getSqlDate(m_parameters.getEndDate()) + ", 'OrmLnsCredit');"
                    + "\n" + "END;");

        cache();

        var queryText = TDataSourceLnQueryTextMaker_XXXX1(parameters);

        m_container[m_container.size] = createDataset(queryText.getQueryText("f634guarantyissued"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634guarantyreceived"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634offbalancetotal"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634pledge"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforassets01"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforassets02"));
        m_container[m_container.size] = createDataset(queryText.getQueryText("f634provisionforguaranty"));
    end;

    constructorTDataSourceLn_XXXX1(parameters);
end;

/**
 *  Источник данных Loans по инструкции 178-И
 */
private class (TDataSourceLn_XXXX1) TDataSourceLn_178(parameters : TParametersLn)
    initTDataSourceLn_XXXX1(parameters);

    private macro cache()
        var commandText : String;

        commandText = "TRUNCATE TABLE DF634GUARANTY_TMP";
        sql_execute(commandText);

        commandText = "INSERT INTO DF634GUARANTY_TMP "
             + "\n" + "("
             + "\n" + "    T_ISGUARANTEE,                                                                                                            "
             + "\n" + "    T_CONTRACTID,                                                                                                             "
             + "\n" + "    T_CONTRACTNUMBER,                                                                                                         "
             + "\n" + "    T_CONTRACTCURRENSYID,                                                                                                     "
             + "\n" + "    T_S_OI,                                                                                                                   "
             + "\n" + "    T_REZCURRENCYSUM,                                                                                                         "
             + "\n" + "    T_REZROUBLESUM,                                                                                                           "
             + "\n" + "    T_CURRENCYID,                                                                                                             "
             + "\n" + "    T_SUM,                                                                                                                    "
             + "\n" + "    T_SUM_RUB                                                                                                                 "
             + "\n" + ")                                                                                                                             "
             + "\n" + "SELECT * FROM                                                                                                                 "
             + "\n" + "(                                                                                                                             "
             + "\n" + "SELECT t_isGuarantee,                                                                                                         "
             + "\n" + "       t_contractId,                                                                                                          "
             + "\n" + "       t_contractNumber,                                                                                                      "
             + "\n" + "       t_contractCurrensyId,                                                                                                  "
             + "\n" + "       t_ensuringSum,                                                                                                         "
             + "\n" + "       t_rezCurrencySum,                                                                                                      "
             + "\n" + "       t_rezRoubleSum,                                                                                                        "
             + "\n" + "       t_currencyId,                                                                                                          "
             + "\n" + "       P,                        --результирующая сумма в валюте                                                              "
             + "\n" + "       NVL(rsb_fiinstr.convSumType(P,                                                                                         "
             + "\n" + "                                   t_currencyId,                                                                              "
             + "\n" + "                               " + NATCUR + ","
             + "\n" + "                               " + RATETYPE_CB + ","
             + "\n" + "                               " + m_reportDate
             + "\n" + "                                  ),                                                                                          "
             + "\n" + "           0                                                                                                                  "
             + "\n" + "          )  AS P_rub            --результирующая сумма в рублях                                                              "
             + "\n" + "  FROM (                                                                                                                      "
             + "\n" + "        SELECT t_isGuarantee,                                                                                                 "
             + "\n" + "               t_contractId,                                                                                                  "
             + "\n" + "               t_contractNumber,                                                                                              "
             + "\n" + "               t_contractCurrensyId,                                                                                          "
             + "\n" + "               t_ensuringSum,                                                                                                 "
             + "\n" + "               t_rezCurrencySum,                                                                                              "
             + "\n" + "               t_rezRoubleSum,                                                                                                "
             + "\n" + "               t_currencyId,                                                                                                  "
             + "\n" + "               CASE                                                                                                           "
             + "\n" + "                   WHEN t_ensuringType = 'Простое обеспечение'                                                                "
             + "\n" + "                       THEN CASE                                                                                              "
             + "\n" + "                                --VVV_ГарантииПолуч_К                                                                         "
             + "\n" + "                                WHEN t_isGuarantee = 1                                                                        "
             + "\n" + "                                    THEN CASE                                                                                 "
             + "\n" + "                                             WHEN t_rezCurrencySum <= O_                                                      "
             + "\n" + "                                                 THEN t_rezCurrencySum                                                        "
             + "\n" + "                                             ELSE O_                                                                          "
             + "\n" + "                                         END                                                                                  "
             + "\n" + "                                --VVV_Залог_К_                                                                                "
             + "\n" + "                                ELSE CASE                                                                                     "
             + "\n" + "                                         WHEN t_rezCurrencySum <= O_ AND O_ < Ti                                              "
             + "\n" + "                                             THEN t_rezCurrencySum                                                            "
             + "\n" + "                                         ELSE O_                                                                              "
             + "\n" + "                                     END                                                                                      "
             + "\n" + "                            END                                                                                               "
             + "\n" + "                   ELSE CASE                                                                                                  "
             + "\n" + "                            WHEN O_ < (Ti - t_rezCurrencySum)                                                                 "
             + "\n" + "                                THEN O_                                                                                       "
             + "\n" + "                            ELSE Ti - t_rezCurrencySum                                                                        "
             + "\n" + "                        END                                                                                                   "
             + "\n" + "               END                                               AS P                    --результирующая сумма               "
             + "\n" + "          FROM (                                                                                                              "
             + "\n" + "                SELECT t_isGuarantee,                                                                                         "
             + "\n" + "                       t_contractId,                                                                                          "
             + "\n" + "                       t_contractNumber,                                                                                      "
             + "\n" + "                       t_contractCurrensyId,                                                                                  "
             + "\n" + "                       t_currencyId,                                                                                          "
             + "\n" + "                       t_ensuringType,                                                                                        "
             + "\n" + "                       Ti,                                                                                                    "
             + "\n" + "                       t_ensuringSum,                                                                                         "
             + "\n" + "                       CASE                                                                                                   "
             + "\n" + "                           WHEN t_ensuringType = 'Простое обеспечение'                                                        "
             + "\n" + "                               THEN CASE                                                                                      "
             + "\n" + "                                        WHEN (t_ensuringSum * t_coef - ((CalcRVPS + RezExpRVPS + CalcRVP) - (RezRVPS + RezExpRVPS + RezRVP))) > 0"
             + "\n" + "                                            THEN t_ensuringSum * t_coef - ((CalcRVPS + RezExpRVPS + CalcRVP) - (RezRVPS + RezExpRVPS + RezRVP))"
             + "\n" + "                                        ELSE 0                                                                                "
             + "\n" + "                                    END                                                                                       "
             + "\n" + "                           ELSE t_ensuringSum  --Контргарантия                                                                "
             + "\n" + "                       END                                                  O_,                                               "
             + "\n" + "                       (RezRVPS + RezExpRVPS + RezRVP)                      t_rezCurrencySum,   --сумма сформированного резерва по договору"
             + "\n" + "                       (RezRVPSrub + RezExpRVPSrub + RezRVPrub)             t_rezRoubleSum      --сумма сформированного резерва по договору"
             + "\n" + "                  FROM (                                                                                                      "
             + "\n" + "                        with                                                                                                  "
             + "\n" + "                        dataGuaranty as                                                                                       "
             + "\n" + "                        (                                                                                                     "
             + "\n" + "                         --для VVV_ГарантииПолуч_К                                                                            "
             + "\n" + "                         SELECT 1                            AS t_isGuarantee,                                                "
             + "\n" + "                                guaranty.t_id                AS t_guaranteeId,                                                "
             + "\n" + "                                guaranty.t_contractId        AS t_contractId,                                                 "
             + "\n" + "                                contract.t_type              as t_contractType,                                               "
             + "\n" + "                                contract.t_number            AS t_contractNumber,                                             "
             + "\n" + "                                contract.t_fiId              AS t_contractCurrensyId,                                         "
             + "\n" + "                                guaranty.t_ratingCurrencyId  AS t_currencyId,                                                 "
             + "\n" + "                                1                            AS t_coef,                            --для контргарантии определение финансового положения гаранта не требуется"
             + "\n" + "                                guaranty.t_ratingSum         AS S_Ob,                              --ВалСтоимостьОбеспечения"
             + "\n" + "                                CASE                                                                                          "
             + "\n" + "                               	   WHEN t1.t_contracts > 1                                                                   "
             + "\n" + "                                	       THEN (select SUM(NVL(rsb_fiinstr.convSumType(t_roubleRest,                            "
             + "\n" + "                                                                                 " + NATCUR + ","
             + "\n" + "                                                                                     guaranty.t_ratingCurrencyId,             "
             + "\n" + "                                                                                 " + RATETYPE_CB + ","
             + "\n" + "                                                                                 " + m_reportDate
             + "\n" + "                                                                                    ),                                        "
             + "\n" + "                                                             0                                                                "
             + "\n" + "                                                            )                                                                 "
             + "\n" + "                                                        )                                                                     "
             + "\n" + "                                                from repLnsRegister_vw register_                                              "
             + "\n" + "                                               where register_.t_trancheNumber = guaranty.t_contractId                        "
             + "\n" + "                                                 and register_.t_type IN (1, 2, 16, 17, 55, 62, 64))                          "
             + "\n" + "                           	       ELSE t2.t_sum                                                                             "
             + "\n" + "                                END                                                     AS Ti      --сумма ОД                 "
             + "\n" + "                           FROM REPLNSGUARANTY_VW guaranty,                                                                   "
             + "\n" + "                                REPLNSCONTRACT_VW contract,                                                                   "
             + "\n" + "                                (                                                                                             "
             + "\n" + "                                 SELECT guaranty.t_id                AS t_guaranteeId,                                        "
             + "\n" + "                                        COUNT(guaranty.t_id)         AS t_contracts                                           "
             + "\n" + "                                   FROM REPLNSGUARANTY_VW guaranty                                                            "
             + "\n" + "                                  GROUP BY t_id                                                                               "
             + "\n" + "                                ) t1,                                                                                         "
             + "\n" + "                                (                                                                                             "
             + "\n" + "                                 SELECT guaranty.t_contractId                AS t_contractId,                                 "
             + "\n" + "                                        COUNT(guaranty.t_contractId)         AS t_guarantees,                                 "
             + "\n" + "                                        SUM(guaranty.t_ratingSum)            AS t_sum                                         "
             + "\n" + "                                   FROM REPLNSGUARANTY_VW guaranty                                                            "
             + "\n" + "                                  GROUP BY t_contractId                                                                       "
             + "\n" + "                                ) t2                                                                                          "
             + "\n" + "                          WHERE guaranty.t_systemType        = 1                                   --системный тип обеспечения: Поручительство (1)"
             + "\n" + "                            AND guaranty.t_ratingCurrencyId != 0                                                              "
             + "\n" + "                            AND guaranty.t_contractId        = contract.t_id                                                  "
             + "\n" + "                            AND t1.t_guaranteeId	            = guaranty.t_id                                                  "
             + "\n" + "                            AND t2.t_contractId              = contract.t_id                                                  "
             + "\n" + "                          UNION ALL                                                                                           "
             + "\n" + "                         --для VVV_Залог_К_                                                                                   "
             + "\n" + "                         SELECT 0,                                                                                            "
             + "\n" + "                                guaranty.t_id,                                                                                "
             + "\n" + "                                guaranty.t_contractId,                                                                        "
             + "\n" + "                                contract.t_type,                                                                              "
             + "\n" + "                                contract.t_number            AS t_contractNumber,                                             "
             + "\n" + "                                contract.t_fiId              AS t_contractCurrensyId,                                         "
             + "\n" + "                                guaranty.t_ratingCurrencyId,                                                                  "
             + "\n" + "                                dataFinancialStates.t_coef, --guaranty.t_garantId,                                            "
             + "\n" + "                                guaranty.t_ratingSum,                                                                         "
             + "\n" + "                                (select SUM(NVL(rsb_fiinstr.convSumType(t_roubleRest,                                         "
             + "\n" + "                                                                    " + NATCUR + ","
             + "\n" + "                                                                        guaranty.t_ratingCurrencyId,                          "
             + "\n" + "                                                                    " + RATETYPE_CB + ","
             + "\n" + "                                                                    " + m_reportDate
             + "\n" + "                                                                       ),                                                     "
             + "\n" + "                                                0                                                                             "
             + "\n" + "                                               )                                                                              "
             + "\n" + "                                           )                                                                                  "
             + "\n" + "                                   from repLnsRegister_vw register_                                                           "
             + "\n" + "                                  where register_.t_trancheNumber = guaranty.t_contractId                                     "
             + "\n" + "                                    and register_.t_type IN (1, 2, 16, 17, 55, 62, 64)) AS Ti      --сумма ОД                 "
             + "\n" + "                           FROM REPLNSGUARANTY_VW guaranty,                                                                   "
             + "\n" + "                                REPLNSCONTRACT_VW contract,                                                                   "
             + "\n" + "                                (                                                                                             "
             + "\n" + "                                 select intermediateDataFinancialStates.*,                                                    "
             + "\n" + "                                        NVL(rep_note.getMoneyPartyNote(t_garantId, 70, " + m_reportDate + "),                 "
             + "\n" + "                                            CASE                                                                              "
             + "\n" + "                                                WHEN t_isHardFinancialState = 3                                               "
             + "\n" + "                                                    THEN CASE                                                                 "
             + "\n" + "                                                             WHEN t_termhardstate <= 180                                      "
             + "\n" + "                                                                 THEN 0.75                                                    "
             + "\n" + "                                                             WHEN t_termhardstate <= 270                                      "
             + "\n" + "                                                                 THEN 0.50                                                    "
             + "\n" + "                                                             WHEN t_termhardstate <= 365                                      "
             + "\n" + "                                                                 THEN 0.25                                                    "
             + "\n" + "                                                             ELSE 0                                                           "
             + "\n" + "                                                          END                                                                 "
             + "\n" + "                                                ELSE 1                                                                        "
             + "\n" + "                                            END)  t_coef --К_ФПГ - коэффициент финансового положения гаранта                  "
             + "\n" + "                                   from (   -- финановое положение заемщика                                                   "
             + "\n" + "                                         select guaranty.t_contractId,                                                        "
             + "\n" + "                                                guaranty.t_garantId,                                                          "
             + "\n" + "                                                NVL((SELECT t_value                                                           "
             + "\n" + "                                                       FROM drepcategory_vw                                                   "
             + "\n" + "                                                      WHERE t_objectType = 3                                                  "
             + "\n" + "                                                        AND t_id = 22                                                         "
             + "\n" + "                                                        AND t_isInstalledForEndDate = 1                                       "
             + "\n" + "                                                        AND t_objectid = RSB_REP_PT.MAKEPARTYID(guaranty.t_garantId)),        "
             + "\n" + "                                                    0)                      t_isHardFinancialState,                           "
             + "\n" + "                                            -- продолжительность в днях текущего фининасового положения заемщика              "
             + "\n" + "                                                " + m_reportDate + " -                                                        "
             + "\n" + "                                                NVL((SELECT t_validFromDate                                                   "
             + "\n" + "                                                      FROM drepcategory_vw                                                    "
             + "\n" + "                                                     WHERE t_objectType = 3                                                   "
             + "\n" + "                                                       AND t_id = 22                                                          "
             + "\n" + "                                                       AND t_isInstalledForEndDate = 1                                        "
             + "\n" + "                                                       AND t_objectid = RSB_REP_PT.MAKEPARTYID(guaranty.t_garantId)),         "
             + "\n" + "                                                    " + m_reportDate + ")   t_termHardState                                   "
             + "\n" + "                                           from REPLNSGUARANTY_VW guaranty    -- если категория финансовое положение замещика не определена, тогда все равно нулю"
             + "\n" + "                                        ) intermediateDataFinancialStates                                                     "
             + "\n" + "                                ) dataFinancialStates                                                                         "
             + "\n" + "                          WHERE guaranty.t_systemType IN (2,3,4,5)                                 --системный тип обеспечения: Залог ЦБ (2), Залог имущества (3), Залог драгоценных металлов (4), Залог прав требований по вкладу (5)"
             + "\n" + "                            AND guaranty.t_ratingCurrencyId     != 0                                                          "
             + "\n" + "                            AND guaranty.t_contractId            = contract.t_id                                              "
             + "\n" + "                            AND dataFinancialStates.t_contractId = guaranty.t_contractId                                      "
             + "\n" + "                        )                                                                                                     "
             + "\n" + "                        SELECT t_isGuarantee,                                                                                 "
             + "\n" + "                               dataGuaranty.t_contractId,                                                                     "
             + "\n" + "                               dataGuaranty.t_contractNumber,                                                                 "
             + "\n" + "                               dataGuaranty.t_contractCurrensyId,                                                             "
             + "\n" + "                               dataGuaranty.t_contractType,                                                                   "
             + "\n" + "                               dataGuaranty.t_coef,                                                                           "
             + "\n" + "                               t_currencyId,                                                                                  "
             + "\n" + "                               Ti,                                                                                            "
             + "\n" + "                               SUM(S_Ob * (NVL(NULLIF(Ti, 0), 1) / NVL(NULLIF(S_D, 0), 1))) AS t_ensuringSum, --Сумма обеспечения по договору"
             + "\n" + "                               CalcRVPS,                                                                                      "
             + "\n" + "                               CalcExpRVPS,                                                                                   "
             + "\n" + "                               CalcRVP,                                                                                       "
             + "\n" + "                               RezRVPS,                                                                                       "
             + "\n" + "                               RezExpRVPS,                                                                                    "
             + "\n" + "                               RezRVP,                                                                                        "
             + "\n" + "                               RezRVPSrub,                                                                                    "
             + "\n" + "                               RezExpRVPSrub,                                                                                 "
             + "\n" + "                               RezRVPrub,                                                                                     "
             + "\n" + "                               CASE                                                                                           "
             + "\n" + "                                   WHEN t_contractType != " + LO_GUARANTEE
             + "\n" + "                                       THEN 'Простое обеспечение'                                                             "
             + "\n" + "                                   ELSE 'Контргарантия'                                                                       "
             + "\n" + "                               END                                                  AS t_ensuringType                         "
             + "\n" + "                          FROM dataGuaranty,                                                                                  "
             + "\n" + "                               (                                                                                              "
             + "\n" + "                                SELECT t_contractId     AS t_contractId,                                                      "
             + "\n" + "                                       SUM(Ti)          AS S_D                                             --общая сумма обеспеченного ОД по Договорам, привязанным к одному обеспечению"
             + "\n" + "                                  FROM dataGuaranty                                                                           "
             + "\n" + "                                 GROUP BY t_contractId                                                                        "
             + "\n" + "                               ) t1,                                                                                          "
             + "\n" + "                               (  --Резервы                                                                                   "
             + "\n" + "                                select t_contractId,                                                                          "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_calcRvpsSum,                                     "
             + "\n" + "                                                                   reserve.t_curRvps,                                         "
             + "\n" + "                                                                   dataGuaranty.t_currencyId,                                 "
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_rvpsDate                                         "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS CalcRVPS,                      "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_calcDelayedRvpsSum,                              "
             + "\n" + "                                                                   reserve.t_delayedRvpsCur,                                  "
             + "\n" + "                                                                   dataGuaranty.t_currencyId,                                 "
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_delayedRvpsDate                                  "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS CalcExpRVPS,                   "
             + "\n" + "                                       CASE                                                                                   "
             + "\n" + "                                            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                                                THEN NVL(rsb_fiinstr.convSumType(reserve.t_calcRvpSum,                        "
             + "\n" + "                                                                                 reserve.t_rvpCur,                            "
             + "\n" + "                                                                                 dataGuaranty.t_currencyId,                   "
             + "\n" + "                                                                             " + RATETYPE_CB + ","
             + "\n" + "                                                                                 reserve.t_rvpDate                            "
             + "\n" + "                                                                                ),                                            "
             + "\n" + "                                                         0                                                                    "
             + "\n" + "                                                        )                                                                     "
             + "\n" + "                                                ELSE 0                                                                        "
             + "\n" + "                                            END                                             AS CalcRVP,                       "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_rvpsSum,                                         "
             + "\n" + "                                                                   reserve.t_curRvps,                                         "
             + "\n" + "                                                                   dataGuaranty.t_currencyId,                                 "
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_rvpsDate                                         "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS RezRVPS,                       "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_rvpsSum,                                         "
             + "\n" + "                                                                   reserve.t_curRvps,                                         "
             + "\n" + "                                                               " + NATCUR + ","
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_rvpsDate                                         "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS RezRVPSrub,                    "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_delayedRvpsSum,                                  "
             + "\n" + "                                                                   reserve.t_delayedRvpsCur,                                  "
             + "\n" + "                                                                   dataGuaranty.t_currencyId,                                 "
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_delayedRvpsDate                                  "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS RezExpRVPS,                    "
             + "\n" + "                                       NVL(rsb_fiinstr.convSumType(reserve.t_delayedRvpsSum,                                  "
             + "\n" + "                                                                   reserve.t_delayedRvpsCur,                                  "
             + "\n" + "                                                                   0,                                                         "
             + "\n" + "                                                               " + RATETYPE_CB + ","
             + "\n" + "                                                                   reserve.t_delayedRvpsDate                                  "
             + "\n" + "                                                                  ),                                                          "
             + "\n" + "                                           0                                                                                  "
             + "\n" + "                                          )                                                 AS RezExpRVPSrub,                 "
             + "\n" + "                                       CASE                                                                                   "
             + "\n" + "                                            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                                                THEN NVL(rsb_fiinstr.convSumType(reserve.t_rvpSum,                            "
             + "\n" + "                                                                                 reserve.t_rvpCur,                            "
             + "\n" + "                                                                                 dataGuaranty.t_currencyId,                   "
             + "\n" + "                                                                             " + RATETYPE_CB + ","
             + "\n" + "                                                                                 reserve.t_rvpDate                            "
             + "\n" + "                                                                                ),                                            "
             + "\n" + "                                                         0                                                                    "
             + "\n" + "                                                        )                                                                     "
             + "\n" + "                                                ELSE 0                                                                        "
             + "\n" + "                                            END                                             AS RezRVP,                        "
             + "\n" + "                                       CASE                                                                                   "
             + "\n" + "                                            WHEN t_contractType = " + LO_GUARANTEE
             + "\n" + "                                                THEN NVL(rsb_fiinstr.convSumType(reserve.t_rvpSum,                            "
             + "\n" + "                                                                                 reserve.t_rvpCur,                            "
             + "\n" + "                                                                             " + NATCUR + ","
             + "\n" + "                                                                             " + RATETYPE_CB + ","
             + "\n" + "                                                                                 reserve.t_rvpDate                            "
             + "\n" + "                                                                                ),                                            "
             + "\n" + "                                                         0                                                                    "
             + "\n" + "                                                        )                                                                     "
             + "\n" + "                                                ELSE 0                                                                        "
             + "\n" + "                                            END                                             AS RezRVPrub                      "
             + "\n" + "                                  from repLnsReserve_vw reserve, dataGuaranty                                                 "
             + "\n" + "                                 where dataGuaranty.t_contractId  = reserve.t_objectNumber                                    "
             + "\n" + "                               ) reserves                                                                                     "
             + "\n" + "                         WHERE dataGuaranty.t_contractId  = t1.t_contractId                                                   "
             + "\n" + "                           AND dataGuaranty.t_contractId  = reserves.t_contractId                                             "
             + "\n" + "                         GROUP BY dataGuaranty.t_contractId, t_isGuarantee, t_contractNumber,                                 "
             + "\n" + "                               t_contractCurrensyId, t_currencyId, Ti, t_contractType, dataGuaranty.t_coef,                   "
             + "\n" + "                               CalcRVPS, CalcExpRVPS, CalcRVP,                                                                "
             + "\n" + "                               RezRVPS, RezExpRVPS, RezRVP,                                                                   "
             + "\n" + "                               RezRVPSrub, RezExpRVPSrub, RezRVPrub                                                           "
             + "\n" + "                         ORDER BY dataGuaranty.t_contractId                                                                   "
             + "\n" + "                        ) data                                                                                                "
             + "\n" + "               ) sumGuaranty                                                                                                  "
             + "\n" + "       ) resultsGuaranty                                                                                                      "
             + "\n" + ")                                                                                                                             "
        ;
        sql_execute(commandText);
    end;
end;

/**
 *  Источник данных счетов, учтенных при расчете по Loans
 */
private class (TDataSourceBase) TDataSourceLnAccount(parameters : TParametersLn)

    private macro constructorTDataSourceLnAccount(parameters : TParametersLn)

        initTDataSourceBase(BoLoans, parameters);

        var queryText = TDataSourceLnAccountQueryTextMaker(parameters);

        m_container[m_container.size] = queryText.getQueryText();

    end;

    constructorTDataSourceLnAccount(parameters);

end;

/**
 *  Контроллер извлечения данных
 */
private class TDataExtractionController(parameters : TParametersLn)

    private var m_extractant;
    private var m_extractantAccount;

    macro process()
        m_extractant.extract();
        m_extractantAccount.extract();
    end;

    private macro constructor(parameters : TParametersLn)
        m_extractant = TDataExtractant(TTempTableLn(), TDataSourceLn(parameters));
        m_extractantAccount = TDataExtractant(TTempTableLnAccount(), TDataSourceLnAccount(parameters));
    end;

    constructor(parameters);
end;

/**
 *  Контроллер извлечения данных по инструкции ХХХХ-У1
 */
private class TDataExtractionController_XXXX1(parameters : TParametersLn)

    private var m_extractant;
    private var m_extractantAccount;

    macro process()
        m_extractant.extract();
        m_extractantAccount.extract();
    end;

    private macro constructor(parameters : TParametersLn)
        m_extractant = TDataExtractant(TTempTableLn(), TDataSourceLn_XXXX1(parameters));
        m_extractantAccount = TDataExtractant(TTempTableLnAccount(), TDataSourceLnAccount(parameters));
    end;

    constructor(parameters);
end;

/**
 *  Контроллер извлечения данных по инструкции 178-И
 */
private class TDataExtractionController_178(parameters : TParametersLn)

    private var m_extractant;
    private var m_extractantAccount;

    macro process()
        m_extractant.extract();
        m_extractantAccount.extract();
    end;

    private macro constructor(parameters : TParametersLn)
        m_extractant        = TDataExtractant(TTempTableLn(), TDataSourceLn_178(parameters));
        m_extractantAccount = TDataExtractant(TTempTableLnAccount(), TDataSourceLnAccount(parameters));
    end;

    constructor(parameters);
end;

/**
 *  Основная функция
 */
macro main(report : Object)

    var profiler = TSqlProfiler(getTxtFileName("!calc_f634ln_sqlprofile"));
    profiler.clear();
    profiler.on();

    var parameters = TParametersLn(report);

    begAction(2000, "Получение данных Loans (" + string(parameters.getEndDate() : f) + ")");

    if   (rcbApplication().currentReport().context.period.EndDate >= RCB_I178_DATE)
        TDataExtractionController_178(parameters).process();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_016_41_4_4786_DATE)
        TDataExtractionController_XXXX1(parameters).process();
    else
        TDataExtractionController(parameters).process();
    end;

    endAction(1);

    profiler.off();

    onError(error)
        exceptionMessage(error);
        profiler.off();
        exit(1);
end;
