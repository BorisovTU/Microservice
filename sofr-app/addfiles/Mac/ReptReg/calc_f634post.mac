/*
$Name:          calc_f634post.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 634. Заключительные действия
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 634. Заключительные действия.

  Создан: 24.07.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

import calc_f634com;
import testlib;

/**
 *  Значение не определено
 */
private class (TException) TUndefinedValueException(attributeName)
    initTException("Значение аттрибута <" + attributeName + "> не определено", true);
end;

/**
 *  Атрибут не найден
 */
private class (TException) TAttributeNotFoundException(attributeName)
    initTException("Атрибут <" + attributeName + "> не найден", true);
end;

/**
 *  Курс не найден
 */
private class (TException) TRateNotFoundException(fiCode, otherFiCode)
    initTException("Курс ЦБ для ФИ с кодом <" + fiCode + "> по отношению к ФИ с кодом <" + otherFiCode + "> не найден", true);
end;

/**
 *  Значение курса не найдено
 */
private class (TException) TRateValueNotFoundException(fiCode, otherFiCode, rateValueDate)
    initTException("Значение курса ЦБ для ФИ с кодом <" + fiCode +
                   "> по отношению к ФИ с кодом <" + otherFiCode +
                   "> на дату <" + otherFiCode + "> не найдено", true);
end;

/**
 *  Источник данных для пользовательского ввода в разрезе дат
 */
private class (TDataSource) TUserInputDataSource(parameters : TParameters)

    private var m_rootAttributeName;

    private var m_attributeValueIterator;

    private var m_isFirstCall;

    macro getValue(attributeName)
        return m_attributeValueIterator.currentItem.fieldValue(attributeName).exact;
    end;

    macro next()
        if (m_isFirstCall)
            m_attributeValueIterator.first();
            m_isFirstCall = false;
        else
            m_attributeValueIterator.next();
        end;

        return not m_attributeValueIterator.isDone();
    end;

    private macro constructorTUserInputDataSource(parameters : TParameters)

        initTDataSource(BoNothing, parameters);

        m_rootAttributeName = USER_INPUT_LIMITS;

        m_attributeValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        m_attributeValueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        m_isFirstCall = true;
    end;

    constructorTUserInputDataSource(parameters);
end;

/**
 *  Источник данных
 *  Не предоставляет непосредственного доступа к значениям свойств.
 */
private class (TDataSource) TSaverDataSource(parameters : TParameters)

    private var m_container;
    private var m_viewNameList;
    private var m_rootAttributeName;
    private var m_attributeValueIterator;
    private var m_isFirstCall;

    private class TUserInputSorter()
        macro isLess(v1, v2)
            return v1.fieldValue("Код валюты").exact < v2.fieldValue("Код валюты").exact;
        end;
    end;

    private macro makeFieldAlias(source, isView)
        defaultParm(isView, true);

        if (isView)
            return "t_value_" + substr(source, 6);
        else
            return "t_value_" + source;
        end;
    end;

    private macro makeDataQuery()

        macro getUsedByPositionClause(code : String) : String
            code = execExp("getParameters().getCode_vvv_" + code + "()");
            return "t_usedByPosition LIKE " + getSqlString("%" + code + "%");
        end;

        const SET_CHAR = getSqlChar("X");

        var i;
        var query;
        var reportDate  = getSqlDate(getParameters().getEndDate());
        var kindActive  = getSqlString(getParameters().getAccountKindActive());
        var kindPassive = getSqlString(getParameters().getAccountKindPassive());

        query =  "WITH"
        + "\n" + "attr_3 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_3_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '930%'"
        + "\n" + "                  OR t_balanceNumber LIKE '931%'"
        + "\n" + "                  OR t_balanceNumber LIKE '932%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '960%'"
        + "\n" + "                  OR t_balanceNumber LIKE '961%'"
        + "\n" + "                  OR t_balanceNumber LIKE '962%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '930%'"
        + "\n" + "                  OR t_balanceNumber LIKE '931%'"
        + "\n" + "                  OR t_balanceNumber LIKE '932%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '960%'"
        + "\n" + "                  OR t_balanceNumber LIKE '961%'"
        + "\n" + "                  OR t_balanceNumber LIKE '962%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '930%'"
        + "\n" + "                  OR t_balanceNumber LIKE '931%'"
        + "\n" + "                  OR t_balanceNumber LIKE '932%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '960%'"
        + "\n" + "                  OR t_balanceNumber LIKE '961%'"
        + "\n" + "                  OR t_balanceNumber LIKE '962%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_5_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_10 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(  t_roubleRest"
        + "\n" + "            * (t_roubleRestMain - t_reserveAmount)"
        + "\n" + "            / t_roubleRestMain)                           AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("10")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_10_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(ABS(t_value))                                 AS t_value"
        + "\n" + "   FROM (SELECT t_fiId,"
        + "\n" + "                SUM(t_value) t_value"
        + "\n" + "           FROM df634ln_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("10_k")
        + "\n" + "          GROUP BY t_fiId, t_creditId"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                         " + NATCUR + ","
        + "\n" + "                                             t_fiId,"
        + "\n" + "                                         " + RATETYPE_CB + ","
        + "\n" + "                                             t_reserveDate"
        + "\n" + "                                            )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(DECODE(t_hasNvpi,"
        + "\n" + "               " + SET_CHAR + ","
        + "\n" + "                   t_equivalentRest,"
        + "\n" + "                   t_rest"
        + "\n" + "                  )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_gar_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           t_rest"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiId t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiId,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garantiipolu4_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "             END"
        + "\n" + "           ) t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           rsb_fiinstr.convSumType(t_roubleRest,"
        + "\n" + "                                               " + NATCUR + ","
        + "\n" + "                                                   t_fiIdLinked,"
        + "\n" + "                                               " + RATETYPE_CB + ","
        + "\n" + "                                               " + reportDate
        + "\n" + "                                                  )"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiIdLinked t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "             OR " + getUsedByPositionClause("garpolu4_810_eq")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiIdLinked,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_k_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garpolu4_k_810")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                " + NATCUR + ","
        + "\n" + "                                    t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                    t_reserveDate"
        + "\n" + "                                   )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiId,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiIdLinked,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(t_equivalentRest) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiIdLinked t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("zalog_810")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiIdLinked,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           t_rest"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiId t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("zalog_gk")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiId,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("zalog_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + ")"
        + "\n" + "SELECT fi.t_code " + makeFieldAlias("code", false) + ","
        + "\n" + "       fi.t_sort " + makeFieldAlias("sort", false) + ","
        + "\n" + "       fi.t_name " + makeFieldAlias("name", false) + ","
        + "\n" + "       fi.t_kind " + makeFieldAlias("kind", false) + ","
        + "\n" + "       fi.t_ccy  " + makeFieldAlias("ccy",  false) + ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN EXISTS (SELECT 1"
        + "\n" + "                          FROM daccount_dbt account"
        + "\n" + "                         WHERE fi.t_id = account.t_code_currency"
        + "\n" + "                           AND fi.t_id <> " + NATCUR
        + "\n" + "                           AND (    account.t_open_date <= " + reportDate
        + "\n" + "                                AND (   account.t_close_date > " + reportDate
        + "\n" + "                                     OR account.t_close_date = " + getSqlDate(Date(0,0,0))
        + "\n" + "                                    )"
        + "\n" + "                               )"
        + "\n" + "                       )"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "        END " + makeFieldAlias("hasOpenedAccount", false) + ",";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " NVL(" + m_viewNameList[i] + ".t_value, 0) " + makeFieldAlias(m_viewNameList[i]) + ",";
            i = i + 1;
        end;

        query = subStr(query, 1, strLen(query) - 1);
        query = query + "\n" + " FROM v_rcb_f634_fininstr fi";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " LEFT JOIN " + m_viewNameList[i] + " ON " + m_viewNameList[i] + ".t_fiid = fi.t_id";
            i = i + 1;
        end;

        query = query  + "\n" + "ORDER BY fi.t_code";

        return query;
    end;

    macro getValue(attributeName)
        return m_attributeValueIterator.currentItem.fieldValue(attributeName).exact;

        onError()
            return execExp("m_container." + makeFieldAlias(attributeName, false));
    end;

    macro next()
        var result;

        if (m_isFirstCall)
            m_attributeValueIterator.first();
            result = m_container.next();
            m_isFirstCall = false;
        else
            m_attributeValueIterator.next();
            result = m_container.next();
        end;

        result = result and not m_attributeValueIterator.isDone();

        return result;
    end;

    macro moveNext()
        return next();
    end;

    private macro constructorTSaverDataSource(parameters : TParameters)
        initTDataSource(BoNothing, parameters);

        var i;

        m_viewNameList = arrCreate("attr_3",
                                   "attr_4",
                                   "attr_5",
                                   "attr_10",
                                   "attr_rez_bal_gk",
                                   "attr_rez_bal_gk_810",
                                   "attr_garantiipolu4",
                                   "attr_akkreditiv",
                                   "attr_3_810",
                                   "attr_4_810",
                                   "attr_5_810",
                                   "attr_garpolu4_810",
                                   "attr_rez_bal_k",
                                   "attr_garpolu4_k_810",
                                   "attr_garantiipolu4_k",
                                   "attr_gar_k",
                                   "attr_garrez_k",
                                   "attr_zalog_k",
                                   "attr_3_810_eq",
                                   "attr_4_810_eq",
                                   "attr_5_810_eq",
                                   "attr_10_k",
                                   "attr_akkreditiv_810",
                                   "attr_gar_gk",
                                   "attr_gar_810",
                                   "attr_garrez_gk",
                                   "attr_zalog_810",
                                   "attr_zalog_gk"
                                  );

        m_container = TRsbDataset(makeDataQuery());

        i = 0;
        while (i < m_viewNameList.size)
            m_container.setFieldType(makeFieldAlias(m_viewNameList[i]), V_MONEY);
            i = i + 1;
        end;

        m_rootAttributeName = USER_INPUT;

        m_attributeValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        m_attributeValueIterator.setSortOrder(TUserInputSorter());
        m_attributeValueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        m_isFirstCall = true;
    end;

    constructorTSaverDataSource(parameters);
end;

private class (TSaverDataSource) TSaverDataSource_3107(parameters : TParameters)
    InitTSaverDataSource(parameters);

    private macro makeDataQuery()

        macro getUsedByPositionClause(code : String) : String
            code = execExp("getParameters().getCode_vvv_" + code + "()");
            return "t_usedByPosition LIKE " + getSqlString("%" + code + "%");
        end;

        const SET_CHAR = getSqlChar("X");

        var i;
        var query;
        var reportDate  = getSqlDate(getParameters().getEndDate());
        var kindActive  = getSqlString(getParameters().getAccountKindActive());
        var kindPassive = getSqlString(getParameters().getAccountKindPassive());

        query =  "WITH"
        + "\n" + "attr_3 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_3_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_5_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_10 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(  t_roubleRest"
        + "\n" + "            * (t_roubleRestMain - t_reserveAmount)"
        + "\n" + "            / t_roubleRestMain)                           AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("10")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_10_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(ABS(t_value))                                 AS t_value"
        + "\n" + "   FROM (SELECT t_fiId,"
        + "\n" + "                SUM(t_value) t_value"
        + "\n" + "           FROM df634ln_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("10_k")
        + "\n" + "          GROUP BY t_fiId, t_creditId"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                         " + NATCUR + ","
        + "\n" + "                                             t_fiId,"
        + "\n" + "                                         " + RATETYPE_CB + ","
        + "\n" + "                                             t_reserveDate"
        + "\n" + "                                            )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(DECODE(t_hasNvpi,"
        + "\n" + "               " + SET_CHAR + ","
        + "\n" + "                   t_equivalentRest,"
        + "\n" + "                   t_rest"
        + "\n" + "                  )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_gar_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           t_rest"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiId t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiId,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garantiipolu4_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "             END"
        + "\n" + "           ) t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           rsb_fiinstr.convSumType(t_roubleRest,"
        + "\n" + "                                               " + NATCUR + ","
        + "\n" + "                                                   t_fiIdLinked,"
        + "\n" + "                                               " + RATETYPE_CB + ","
        + "\n" + "                                               " + reportDate
        + "\n" + "                                                  )"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiIdLinked t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "             OR " + getUsedByPositionClause("garpolu4_810_eq")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiIdLinked,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_k_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garpolu4_k_810")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                " + NATCUR + ","
        + "\n" + "                                    t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                    t_reserveDate"
        + "\n" + "                                   )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiId,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiIdLinked,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(t_equivalentRest) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiIdLinked,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiIdLinked t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("zalog_810")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiIdLinked,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_securityRest >= t_accountRest"
        + "\n" + "                  OR (    t_reserveAmount <= t_securityRest"
        + "\n" + "                      AND t_securityRest < t_accountRest"
        + "\n" + "                     )"
        + "\n" + "                    THEN t_reserveAmount"
        + "\n" + "                WHEN t_securityRest < t_accountRest"
        + "\n" + "                 AND t_securityRest < t_reserveAmount"
        + "\n" + "                    THEN t_securityRest"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM (SELECT SUM(DECODE(t_hasNvpi,"
        + "\n" + "                       " + SET_CHAR + ","
        + "\n" + "                           t_equivalentRest,"
        + "\n" + "                           t_rest"
        + "\n" + "                          )"
        + "\n" + "                   ) t_securityRest,"
        + "\n" + "                rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                        t_reserveDate"
        + "\n" + "                                       ) t_reserveAmount,"
        + "\n" + "                rsb_fiinstr.convSumType(t_roubleRestMain,"
        + "\n" + "                                    " + NATCUR + ","
        + "\n" + "                                        t_fiId,"
        + "\n" + "                                    " + RATETYPE_CB + ","
        + "\n" + "                                    " + reportDate
        + "\n" + "                                       ) t_accountRest,"
        + "\n" + "                t_fiId t_fiId"
        + "\n" + "           FROM df634cb_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("zalog_gk")
        + "\n" + "          GROUP BY t_accountNumberMain,"
        + "\n" + "                   t_hasNvpi,"
        + "\n" + "                   t_fiId,"
        + "\n" + "                   t_reserveAmount,"
        + "\n" + "                   t_reserveDate,"
        + "\n" + "                   t_roublerestMain"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_zalog_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("zalog_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + ")"
        + "\n" + "SELECT fi.t_code " + makeFieldAlias("code", false) + ","
        + "\n" + "       fi.t_sort " + makeFieldAlias("sort", false) + ","
        + "\n" + "       fi.t_name " + makeFieldAlias("name", false) + ","
        + "\n" + "       fi.t_kind " + makeFieldAlias("kind", false) + ","
        + "\n" + "       fi.t_ccy  " + makeFieldAlias("ccy",  false) + ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN EXISTS (SELECT 1"
        + "\n" + "                          FROM daccount_dbt account"
        + "\n" + "                         WHERE fi.t_id = account.t_code_currency"
        + "\n" + "                           AND fi.t_id <> " + NATCUR
        + "\n" + "                           AND (    account.t_open_date <= " + reportDate
        + "\n" + "                                AND (   account.t_close_date > " + reportDate
        + "\n" + "                                     OR account.t_close_date = " + getSqlDate(Date(0,0,0))
        + "\n" + "                                    )"
        + "\n" + "                               )"
        + "\n" + "                       )"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "       END " + makeFieldAlias("hasOpenedAccount", false) + ",";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " NVL(" + m_viewNameList[i] + ".t_value, 0) " + makeFieldAlias(m_viewNameList[i]) + ",";
            i = i + 1;
        end;

        query = subStr(query, 1, strLen(query) - 1);
        query = query + "\n" + " FROM v_rcb_f634_fininstr fi";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " LEFT JOIN " + m_viewNameList[i] + " ON " + m_viewNameList[i] + ".t_fiid = fi.t_id";
            i = i + 1;
        end;

        query = query  + "\n" + "ORDER BY fi.t_code";

        return query;
    end;
end;

private class (TSaverDataSource) TSaverDataSource_XXXX1(parameters : TParameters)
    private const POSITIV_REVALUATION_ROLE = 51;
    private const NEGATIV_REVALUATION_ROLE = 52;

    /**
     *  Создание SQL-выражения фильтра для счетов переоценки
     */
    private macro getRevaluationClause(role)
        return   " EXISTS (SELECT 1"
        + "\n" + "               FROM dreplinkedobjects_vw objlink"
        + "\n" + "              WHERE objlink.t_Id = object.t_objectId"
        + "\n" + "                AND objlink.t_role = " + role + ")";
    end;

    private var m_positivRevaluationClause = getRevaluationClause(POSITIV_REVALUATION_ROLE);
    private var m_negativRevaluationClause = getRevaluationClause(NEGATIV_REVALUATION_ROLE);

    private macro makeDataQuery()
        macro getUsedByPositionClause(code : String) : String
            code = execExp("getParameters().getCode_vvv_" + code + "()");
            return "t_usedByPosition LIKE " + getSqlString("%" + code + "%");
        end;

        macro getRevaluationClause(role)
            return   " EXISTS (SELECT 1"
            + "\n" + "               FROM dreplinkedobjects_vw objlink"
            + "\n" + "              WHERE objlink.t_Id = object.t_objectId"
            + "\n" + "                AND objlink.t_role = " + role + ")";
        end;

        const SET_CHAR = getSqlChar("X");

        var i;
        var query;
        var reportDate  = getSqlDate(getParameters().getEndDate());
        var kindActive  = getSqlString(getParameters().getAccountKindActive());
        var kindPassive = getSqlString(getParameters().getAccountKindPassive());

        query =  "WITH"
        + "\n" + "attr_3 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_3_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_5_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_10 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(  t_roubleRest"
        + "\n" + "            * (t_roubleRestMain - t_reserveAmount)"
        + "\n" + "            / t_roubleRestMain)                           AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("10")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_10_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(ABS(t_value))                                 AS t_value"
        + "\n" + "   FROM (SELECT t_fiId,"
        + "\n" + "                SUM(t_value) t_value"
        + "\n" + "           FROM df634ln_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("10_k")
        + "\n" + "          GROUP BY t_fiId, t_creditId"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                         " + NATCUR + ","
        + "\n" + "                                             t_fiId,"
        + "\n" + "                                         " + RATETYPE_CB + ","
        + "\n" + "                                             t_reserveDate"
        + "\n" + "                                            )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(DECODE(t_hasNvpi,"
        + "\n" + "               " + SET_CHAR + ","
        + "\n" + "                   t_equivalentRest,"
        + "\n" + "                   t_rest"
        + "\n" + "                  )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_gar_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_ГК
        + "\n" + "t1 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                          --счет обеспечения"
        + "\n" + "        sum(t_roubleRestMain) as S_A              --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by t_accountNumber"
        + "\n" + "),"
        + "\n" + "t2 as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "t3 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,  --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcreserve"
        + "\n" + "   from t1, t2, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2.t_accountNumberMain"
        + "\n" + "    and t1.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t4 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения"
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3"
        + "\n" + "),"
        + "\n" + "t5 as"
        + "\n" + "("
        + "\n" + " select t4.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi - (t4.t_calcreserve - t4.t_reserveamount) > 0"
        + "\n" + "                             THEN S_Oi - (t4.t_calcreserve - t4.t_reserveamount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4.t_reserveamount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_К
        + "\n" + "attr_garantiipolu4_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garantiipolu4_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_810
        + "\n" + "t1_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                              --счет обеспечения"
        + "\n" + "        sum(t_roubleRestMain) as S_A                                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by t_accountNumber"
        + "\n" + "),"
        + "\n" + "t2_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "),"
        + "\n" + "t3_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_garPolu4_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,         --Сумма обеспечения по активу"
        + "\n" + "        cb.t_reserveAmount,                                           --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                             --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_garPolu4_810, t2_garPolu4_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and t1_garPolu4_810.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_garPolu4_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_garPolu4_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                       --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveamount S,"
        + "\n" + "        t1_garPolu4_810.S_A T"
        + "\n" + "   from t3_garPolu4_810, t1_garPolu4_810"
        + "\n" + "  where t1_garPolu4_810.t_accountNumber = t3_garPolu4_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5_garPolu4_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_garrez_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                " + NATCUR + ","
        + "\n" + "                                    t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                    t_reserveDate"
        + "\n" + "                                   )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiId,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiIdLinked,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_reval AS"
        + "\n" + "("
        + "\n" + " SELECT account.t_fiId                                    AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "           WHEN " + m_positivRevaluationClause
        + "\n" + "               THEN 1"
        + "\n" + "           WHEN " + m_negativRevaluationClause
        + "\n" + "               THEN -1"
        + "\n" + "           ELSE 0"
        + "\n" + "           END * account.t_rest)                          AS t_value"
        + "\n" + "   FROM df634cb_tmp account, drepaccount_vw object"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_reval")
        + "\n" + "    AND account.t_balanceNumber = object.t_balance"
        + "\n" + "    AND account.t_accountNumber = object.t_account"
        + "\n" + "    AND account.t_chapterNumber = object.t_chapter"
        + "\n" + "    AND account.t_fiId          = object.t_fiId"
        + "\n" + "  GROUP BY account.t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_810
        + "\n" + "t1_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                                  --счет обеспечения"
        + "\n" + "        sum(t_roubleRestMain) as S_A                                      --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by t_accountNumber"
        + "\n" + "),"
        + "\n" + "t2_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "),"
        + "\n" + "t3_zalog_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_zalog_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,             --Сумма_Обеспечения для Простого обеспечения"
        + "\n" + "        cb.t_reserveAmount,                                               --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                                 --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                        --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_zalog_810, t2_zalog_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and t1_zalog_810.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_zalog_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_zalog_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                           --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveAmount S,"
        + "\n" + "        t1_zalog_810.S_A T"
        + "\n" + "   from t3_zalog_810, t1_zalog_810"
        + "\n" + "  where t1_zalog_810.t_accountNumber = t3_zalog_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_zalog_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_ГК
        + "\n" + "t1_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                              --счет обеспечения"
        + "\n" + "        sum(t_roubleRestMain) as S_A                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by t_accountNumber"
        + "\n" + "),"
        + "\n" + "t2_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "t3_zalog as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1_zalog.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,   --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcReserve"
        + "\n" + "   from t1_zalog, t2_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2_zalog.t_accountNumberMain"
        + "\n" + "    and t1_zalog.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1_zalog.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t4_zalog as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                                ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения "
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapternumbermain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3_zalog"
        + "\n" + "),"
        + "\n" + "t5_zalog as"
        + "\n" + "("
        + "\n" + " select t4_zalog.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount) > 0"
        + "\n" + "                             THEN S_Oi - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4_zalog.t_reserveAmount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4_zalog.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4_zalog.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "attr_zalog_gk AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_zalog_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("zalog_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + ")"

        + "\n" + "SELECT fi.t_code " + makeFieldAlias("code", false) + ","
        + "\n" + "       fi.t_sort " + makeFieldAlias("sort", false) + ","
        + "\n" + "       fi.t_name " + makeFieldAlias("name", false) + ","
        + "\n" + "       fi.t_kind " + makeFieldAlias("kind", false) + ","
        + "\n" + "       fi.t_ccy  " + makeFieldAlias("ccy",  false) + ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN EXISTS (SELECT 1"
        + "\n" + "                          FROM daccount_dbt account"
        + "\n" + "                         WHERE fi.t_id = account.t_code_currency"
        + "\n" + "                           AND fi.t_id <> " + NATCUR
        + "\n" + "                           AND (    account.t_open_date <= " + reportDate
        + "\n" + "                                AND (   account.t_close_date > " + reportDate
        + "\n" + "                                     OR account.t_close_date = " + getSqlDate(Date(0,0,0))
        + "\n" + "                                    )"
        + "\n" + "                               )"
        + "\n" + "                       )"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "        END " + makeFieldAlias("hasOpenedAccount", false) + ",";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " NVL(" + m_viewNameList[i] + ".t_value, 0) " + makeFieldAlias(m_viewNameList[i]) + ",";
            i = i + 1;
        end;

        query = subStr(query, 1, strLen(query) - 1);
        query = query + "\n" + " FROM v_rcb_f634_fininstr fi";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " LEFT JOIN " + m_viewNameList[i] + " ON " + m_viewNameList[i] + ".t_fiid = fi.t_id";
            i = i + 1;
        end;

        query = query  + "\n" + "ORDER BY fi.t_code";

        return query;
    end;

    private macro constructorTSaverDataSource_XXXX1(parameters : TParameters)
        initTDataSource(BoNothing, parameters);

        var i;

        m_viewNameList = arrCreate("attr_3",
                                   "attr_4",
                                   "attr_5",
                                   "attr_10",
                                   "attr_rez_bal_gk",
                                   "attr_rez_bal_gk_810",
                                   "attr_garantiipolu4",
                                   "attr_akkreditiv",
                                   "attr_3_810",
                                   "attr_3_810_reval",
                                   "attr_4_810",
                                   "attr_5_810",
                                   "attr_garpolu4_810",
                                   "attr_rez_bal_k",
                                   "attr_garantiipolu4_k",
                                   "attr_gar_k",
                                   "attr_garrez_k",
                                   "attr_zalog_k",
                                   "attr_3_810_eq",
                                   "attr_4_810_eq",
                                   "attr_5_810_eq",
                                   "attr_10_k",
                                   "attr_akkreditiv_810",
                                   "attr_gar_gk",
                                   "attr_gar_810",
                                   "attr_garrez_gk",
                                   "attr_zalog_810",
                                   "attr_zalog_gk"
                                  );

        m_container = TRsbDataset(makeDataQuery());

        i = 0;
        while (i < m_viewNameList.size)
            m_container.setFieldType(makeFieldAlias(m_viewNameList[i]), V_MONEY);
            i = i + 1;
        end;

        m_rootAttributeName = USER_INPUT;

        m_attributeValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        m_attributeValueIterator.setSortOrder(TUserInputSorter());
        m_attributeValueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        m_isFirstCall = true;
    end;

    constructorTSaverDataSource_XXXX1(parameters);
end;

private class (TSaverDataSource) TSaverDataSource_178(parameters : TParameters)
    private macro makeDataQuery()
        macro getUsedByPositionClause(code : String) : String
            code = execExp("getParameters().getCode_vvv_" + code + "()");
            return "t_usedByPosition LIKE " + getSqlString("%" + code + "%");
        end;

        const SET_CHAR = getSqlChar("X");

        var i;
        var query;
        var reportDate  = getSqlDate(getParameters().getEndDate());
        var kindActive  = getSqlString(getParameters().getAccountKindActive());
        var kindPassive = getSqlString(getParameters().getAccountKindPassive());

        query =  "WITH"
        + "\n" + "attr_3 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_3_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_5_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_10 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(  t_roubleRest"
        + "\n" + "            * (t_roubleRestMain - t_reserveAmount)"
        + "\n" + "            / t_roubleRestMain)                           AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("10")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_10_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(ABS(t_value))                                 AS t_value"
        + "\n" + "   FROM (SELECT t_fiId,"
        + "\n" + "                SUM(t_value) t_value"
        + "\n" + "           FROM df634ln_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("10_k")
        + "\n" + "          GROUP BY t_fiId, t_creditId"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                         " + NATCUR + ","
        + "\n" + "                                             t_fiId,"
        + "\n" + "                                         " + RATETYPE_CB + ","
        + "\n" + "                                             t_reserveDate"
        + "\n" + "                                            )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(DECODE(t_hasNvpi,"
        + "\n" + "               " + SET_CHAR + ","
        + "\n" + "                   t_equivalentRest,"
        + "\n" + "                   t_rest"
        + "\n" + "                  )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_gar_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_ГК
        + "\n" + "t0 as                                                                                                  "
        + "\n" + "(                                                                                                      "
        + "\n" + " select cb.t_accountNumber,                                                                            "
        + "\n" + "        NVL(rep_note.getMoneyPartyNote(acc.t_partyId, 70, "  + reportDate + "),"
        + "\n" + "            CASE                                                                                       "
        + "\n" + "                WHEN t_chapternumbermain = 1                                                           "
        + "\n" + "                     THEN CASE                                                                         "
        + "\n" + "                              WHEN t_isHardFinancialState = 3                                          "
        + "\n" + "                                 THEN CASE                                                             "
        + "\n" + "                                           WHEN t_termhardstate <= 180                                 "
        + "\n" + "                                               THEN 0.75                                               "
        + "\n" + "                                           WHEN t_termhardstate <= 270                                 "
        + "\n" + "                                               THEN 0.50                                               "
        + "\n" + "                                           WHEN t_termhardstate <= 365                                 "
        + "\n" + "                                               THEN 0.25                                               "
        + "\n" + "                                           ELSE 0                                                      "
        + "\n" + "                                       END                                                             "
        + "\n" + "                              ELSE 1                                                                   "
        + "\n" + "                          END                                                                          "
        + "\n" + "                ELSE 1                                                                                 "
        + "\n" + "            END) t_coef,                          --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        t_usedByPosition,                                                                              "
        + "\n" + "        t_roubleRestMain                                                                               "
        + "\n" + "   from dRepAccount_vw acc,                                                                            "
        + "\n" + "        df634cb_tmp cb                                                                                 "
        + "\n" + "  where acc.t_account = cb.t_accountNumber                                                             "
        + "\n" + "    and acc.t_chapter = cb.t_chapterNumber                                                             "
        + "\n" + "),                                                                                                     "
        + "\n" + "t1 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                          --счет обеспечения"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        sum(t_roubleRestMain) as S_A              --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "        t_coef                                                                                                       "
        + "\n" + "),"
        + "\n" + "t2 as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                t_fiIdLinked,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + reportDate
        + "\n" + "                                )"
        + "\n" + "         AS S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "t3 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1.t_accountNumber,"
        + "\n" + "        t1.t_coef,                                                                                                  "
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,  --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcreserve"
        + "\n" + "   from t1, t2, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2.t_accountNumberMain"
        + "\n" + "    and t1.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve,"
        + "\n" + "           t1.t_coef                                                                                                       "
        + "\n" + "),"
        + "\n" + "t4 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения"
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3"
        + "\n" + "),"
        + "\n" + "t5 as"
        + "\n" + "("
        + "\n" + " select t4.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi * t_coef - (t4.t_calcreserve - t4.t_reserveamount) > 0"
        + "\n" + "                             THEN S_Oi * t_coef - (t4.t_calcreserve - t4.t_reserveamount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4.t_reserveamount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_К
        + "\n" + "attr_garantiipolu4_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garantiipolu4_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_810
        + "\n" + "t1_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                              --счет обеспечения"
        + "\n" + "        t_coef,                                                       --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                                            --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "           t_coef"
        + "\n" + "),"
        + "\n" + "t2_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                t_fiIdLinked,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + reportDate
        + "\n" + "                                )"
        + "\n" + "        AS S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "),"
        + "\n" + "t3_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_garPolu4_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,         --Сумма обеспечения по активу"
        + "\n" + "        cb.t_reserveAmount,                                           --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                             --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_garPolu4_810, t2_garPolu4_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and t1_garPolu4_810.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_garPolu4_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_garPolu4_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                       --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveamount S,"
        + "\n" + "        t1_garPolu4_810.S_A T"
        + "\n" + "   from t3_garPolu4_810, t1_garPolu4_810"
        + "\n" + "  where t1_garPolu4_810.t_accountNumber = t3_garPolu4_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5_garPolu4_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_garrez_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                " + NATCUR + ","
        + "\n" + "                                    t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                    t_reserveDate"
        + "\n" + "                                   )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiId,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiIdLinked,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_reval AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest)                                       AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_reval")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_810
        + "\n" + "t1_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                                  --счет обеспечения"
        + "\n" + "        t_coef,                                                           --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                                      --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                                                --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "        t_coef"
        + "\n" + "),"
        + "\n" + "t2_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "),"
        + "\n" + "t3_zalog_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_zalog_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,             --Сумма_Обеспечения для Простого обеспечения"
        + "\n" + "        cb.t_reserveAmount,                                               --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                                 --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                        --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_zalog_810, t2_zalog_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and t1_zalog_810.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_zalog_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_zalog_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                           --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveAmount S,"
        + "\n" + "        t1_zalog_810.S_A T"
        + "\n" + "   from t3_zalog_810, t1_zalog_810"
        + "\n" + "  where t1_zalog_810.t_accountNumber = t3_zalog_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_zalog_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_ГК
        + "\n" + "t1_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                              --счет обеспечения"
        + "\n" + "        t_coef,                                       --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                            --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "           t_coef"
        + "\n" + "),"
        + "\n" + "t2_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "t3_zalog as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1_zalog.t_accountNumber,"
        + "\n" + "        t1_zalog.t_coef,                                                                                                  "
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,   --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcReserve"
        + "\n" + "   from t1_zalog, t2_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2_zalog.t_accountNumberMain"
        + "\n" + "    and t1_zalog.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1_zalog.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve,"
        + "\n" + "           t1_zalog.t_coef"
        + "\n" + "),"
        + "\n" + "t4_zalog as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                                ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения "
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapternumbermain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3_zalog"
        + "\n" + "),"
        + "\n" + "t5_zalog as"
        + "\n" + "("
        + "\n" + " select t4_zalog.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi * t_coef - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount) > 0"
        + "\n" + "                             THEN S_Oi * t_coef - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4_zalog.t_reserveAmount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4_zalog.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4_zalog.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "attr_zalog_gk AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_zalog_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("zalog_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + ")"

        + "\n" + "SELECT fi.t_code " + makeFieldAlias("code", false) + ","
        + "\n" + "       fi.t_sort " + makeFieldAlias("sort", false) + ","
        + "\n" + "       fi.t_name " + makeFieldAlias("name", false) + ","
        + "\n" + "       fi.t_kind " + makeFieldAlias("kind", false) + ","
        + "\n" + "       fi.t_ccy  " + makeFieldAlias("ccy",  false) + ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN EXISTS (SELECT 1"
        + "\n" + "                          FROM daccount_dbt account"
        + "\n" + "                         WHERE fi.t_id = account.t_code_currency"
        + "\n" + "                           AND fi.t_id <> " + NATCUR
        + "\n" + "                           AND (    account.t_open_date <= " + reportDate
        + "\n" + "                                AND (   account.t_close_date > " + reportDate
        + "\n" + "                                     OR account.t_close_date = " + getSqlDate(Date(0,0,0))
        + "\n" + "                                    )"
        + "\n" + "                               )"
        + "\n" + "                       )"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "        END " + makeFieldAlias("hasOpenedAccount", false) + ",";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " NVL(" + m_viewNameList[i] + ".t_value, 0) " + makeFieldAlias(m_viewNameList[i]) + ",";
            i = i + 1;
        end;

        query = subStr(query, 1, strLen(query) - 1);
        query = query + "\n" + " FROM v_rcb_f634_fininstr fi";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " LEFT JOIN " + m_viewNameList[i] + " ON " + m_viewNameList[i] + ".t_fiid = fi.t_id";
            i = i + 1;
        end;

        query = query  + "\n" + "ORDER BY fi.t_code";

        return query;
    end;

    private macro constructorTSaverDataSource_178(parameters : TParameters)
        initTDataSource(BoNothing, parameters);

        var i;

        m_viewNameList = arrCreate("attr_3",
                                   "attr_4",
                                   "attr_5",
                                   "attr_10",
                                   "attr_rez_bal_gk",
                                   "attr_rez_bal_gk_810",
                                   "attr_garantiipolu4",
                                   "attr_akkreditiv",
                                   "attr_3_810",
                                   "attr_3_810_reval",
                                   "attr_4_810",
                                   "attr_5_810",
                                   "attr_garpolu4_810",
                                   "attr_rez_bal_k",
                                   "attr_garantiipolu4_k",
                                   "attr_gar_k",
                                   "attr_garrez_k",
                                   "attr_zalog_k",
                                   "attr_3_810_eq",
                                   "attr_4_810_eq",
                                   "attr_5_810_eq",
                                   "attr_10_k",
                                   "attr_akkreditiv_810",
                                   "attr_gar_gk",
                                   "attr_gar_810",
                                   "attr_garrez_gk",
                                   "attr_zalog_810",
                                   "attr_zalog_gk"
                                  );

        m_container = TRsbDataset(makeDataQuery());

        i = 0;
        while (i < m_viewNameList.size)
            m_container.setFieldType(makeFieldAlias(m_viewNameList[i]), V_MONEY);
            i = i + 1;
        end;

        m_rootAttributeName = USER_INPUT;

        m_attributeValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        m_attributeValueIterator.setSortOrder(TUserInputSorter());
        m_attributeValueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        m_isFirstCall = true;
    end;

    constructorTSaverDataSource_178(parameters);
end;

class (TSaverDataSource) TSaverDataSource_4927(parameters : TParameters)
    private macro makeDataQuery()
        macro getUsedByPositionClause(code : String) : String
            code = execExp("getParameters().getCode_vvv_" + code + "()");
            return "t_usedByPosition LIKE " + getSqlString("%" + code + "%");
        end;

        const SET_CHAR = getSqlChar("X");

        var i;
        var query;
        var reportDate  = getSqlDate(getParameters().getEndDate());
        var kindActive  = getSqlString(getParameters().getAccountKindActive());
        var kindPassive = getSqlString(getParameters().getAccountKindPassive());

        query =  "WITH"
        + "\n" + "attr_3 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_3_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE t_accountKind"
        + "\n" + "                WHEN " + kindPassive
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                WHEN " + kindActive
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_4_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_4_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '939%'"
        + "\n" + "                  OR t_balanceNumber LIKE '940%'"
        + "\n" + "                  OR t_balanceNumber LIKE '941%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '969%'"
        + "\n" + "                  OR t_balanceNumber LIKE '970%'"
        + "\n" + "                  OR t_balanceNumber LIKE '971%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("4_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                t_equivalentRest,"
        + "\n" + "                                t_rest"
        + "\n" + "                               )"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN DECODE(t_hasNvpi,"
        + "\n" + "                            " + SET_CHAR + ","
        + "\n" + "                                -t_equivalentRest,"
        + "\n" + "                                -t_rest"
        + "\n" + "                               )"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_5_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_roubleRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_roubleRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_5_810_eq AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(CASE"
        + "\n" + "                WHEN t_balanceNumber LIKE '933%'"
        + "\n" + "                  OR t_balanceNumber LIKE '934%'"
        + "\n" + "                  OR t_balanceNumber LIKE '935%'"
        + "\n" + "                  OR t_balanceNumber LIKE '936%'"
        + "\n" + "                    THEN t_equivalentRest"
        + "\n" + "                WHEN t_balanceNumber LIKE '963%'"
        + "\n" + "                  OR t_balanceNumber LIKE '964%'"
        + "\n" + "                  OR t_balanceNumber LIKE '965%'"
        + "\n" + "                  OR t_balanceNumber LIKE '966%'"
        + "\n" + "                    THEN -t_equivalentRest"
        + "\n" + "                ELSE 0"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("5_810_eq")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_10 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(  t_roubleRest"
        + "\n" + "            * (t_roubleRestMain - t_reserveAmount)"
        + "\n" + "            / t_roubleRestMain)                           AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("10")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_10_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(ABS(t_value))                                 AS t_value"
        + "\n" + "   FROM (SELECT t_fiId,"
        + "\n" + "                SUM(t_value) t_value"
        + "\n" + "           FROM df634ln_tmp"
        + "\n" + "          WHERE " + getUsedByPositionClause("10_k")
        + "\n" + "          GROUP BY t_fiId, t_creditId"
        + "\n" + "        )"
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                         " + NATCUR + ","
        + "\n" + "                                             t_fiId,"
        + "\n" + "                                         " + RATETYPE_CB + ","
        + "\n" + "                                             t_reserveDate"
        + "\n" + "                                            )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_akkreditiv_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("akkreditiv_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(t_equivalentRest - rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                                   " + NATCUR + ","
        + "\n" + "                                                       t_fiIdLinked,"
        + "\n" + "                                                   " + RATETYPE_CB + ","
        + "\n" + "                                                       t_reserveDate"
        + "\n" + "                                                      )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_gar_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(DECODE(t_hasNvpi,"
        + "\n" + "               " + SET_CHAR + ","
        + "\n" + "                   t_equivalentRest,"
        + "\n" + "                   t_rest"
        + "\n" + "                  )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_gar_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("gar_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_ГК
        + "\n" + "t0 as                                                                                                  "
        + "\n" + "(                                                                                                      "
        + "\n" + " select cb.t_accountNumber,                                                                            "
        + "\n" + "        NVL(rep_note.getMoneyPartyNote(acc.t_partyId, 70, "  + reportDate + "),"
        + "\n" + "            CASE                                                                                       "
        + "\n" + "                WHEN t_chapternumbermain = 1                                                           "
        + "\n" + "                     THEN CASE                                                                         "
        + "\n" + "                              WHEN t_isHardFinancialState = 3                                          "
        + "\n" + "                                 THEN CASE                                                             "
        + "\n" + "                                           WHEN t_termhardstate <= 180                                 "
        + "\n" + "                                               THEN 0.75                                               "
        + "\n" + "                                           WHEN t_termhardstate <= 270                                 "
        + "\n" + "                                               THEN 0.50                                               "
        + "\n" + "                                           WHEN t_termhardstate <= 365                                 "
        + "\n" + "                                               THEN 0.25                                               "
        + "\n" + "                                           ELSE 0                                                      "
        + "\n" + "                                       END                                                             "
        + "\n" + "                              ELSE 1                                                                   "
        + "\n" + "                          END                                                                          "
        + "\n" + "                ELSE 1                                                                                 "
        + "\n" + "            END) t_coef,                          --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        t_usedByPosition,                                                                              "
        + "\n" + "        t_roubleRestMain                                                                               "
        + "\n" + "   from dRepAccount_vw acc,                                                                            "
        + "\n" + "        df634cb_tmp cb                                                                                 "
        + "\n" + "  where acc.t_account = cb.t_accountNumber                                                             "
        + "\n" + "    and acc.t_chapter = cb.t_chapterNumber                                                             "
        + "\n" + "),                                                                                                     "
        + "\n" + "t1 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                          --счет обеспечения"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        sum(t_roubleRestMain) as S_A              --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "        t_coef                                                                                                       "
        + "\n" + "),"
        + "\n" + "t2 as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                t_fiIdLinked,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + reportDate
        + "\n" + "                                )"
        + "\n" + "         AS S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "t3 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1.t_accountNumber,"
        + "\n" + "        t1.t_coef,                                                                                                  "
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,  --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcreserve"
        + "\n" + "   from t1, t2, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2.t_accountNumberMain"
        + "\n" + "    and t1.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve,"
        + "\n" + "           t1.t_coef                                                                                                       "
        + "\n" + "),"
        + "\n" + "t4 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения"
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3"
        + "\n" + "),"
        + "\n" + "t5 as"
        + "\n" + "("
        + "\n" + " select t4.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi * t_coef - (t4.t_calcreserve - t4.t_reserveamount) > 0"
        + "\n" + "                             THEN S_Oi * t_coef - (t4.t_calcreserve - t4.t_reserveamount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4.t_reserveamount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("garantiipolu4")
        + "\n" + "),"
        + "\n" + "attr_garantiipolu4 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_К
        + "\n" + "attr_garantiipolu4_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garantiipolu4_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_810
        + "\n" + "t1_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                              --счет обеспечения"
        + "\n" + "        t_coef,                                                       --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                                            --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "           t_coef"
        + "\n" + "),"
        + "\n" + "t2_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                t_fiIdLinked,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                " + reportDate
        + "\n" + "                                )"
        + "\n" + "        AS S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "),"
        + "\n" + "t3_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_garPolu4_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,         --Сумма обеспечения по активу"
        + "\n" + "        cb.t_reserveAmount,                                           --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                             --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_garPolu4_810, t2_garPolu4_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and t1_garPolu4_810.t_accountNumber = t2_garPolu4_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("garpolu4_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_garPolu4_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_garPolu4_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_garPolu4_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                       --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveamount S,"
        + "\n" + "        t1_garPolu4_810.S_A T"
        + "\n" + "   from t3_garPolu4_810, t1_garPolu4_810"
        + "\n" + "  where t1_garPolu4_810.t_accountNumber = t3_garPolu4_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_garpolu4_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "           END"
        + "\n" + "          )                                               AS t_value"
        + "\n" + "  from t5_garPolu4_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_garrez_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                " + NATCUR + ","
        + "\n" + "                                    t_fiId,"
        + "\n" + "                                " + RATETYPE_CB + ","
        + "\n" + "                                    t_reserveDate"
        + "\n" + "                                   )"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_garrez_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("garrez_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiId,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_gk_810 AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiIdLinked                                      AS t_fiId,"
        + "\n" + "        SUM(rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                                 " + NATCUR + ","
        + "\n" + "                                     t_fiIdLinked,"
        + "\n" + "                                 " + RATETYPE_CB + ","
        + "\n" + "                                     t_reserveDate"
        + "\n" + "                                    )"
        + "\n" + "            )                                             AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_gk_810")
        + "\n" + "  GROUP BY t_fiIdLinked"
        + "\n" + "),"
        + "\n" + "attr_3_810_reval AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_rest)                                       AS t_value"
        + "\n" + "   FROM df634cb_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("3_810_reval")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"
        + "\n" + "attr_rez_bal_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("rez_bal_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_810
        + "\n" + "t1_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                                                  --счет обеспечения"
        + "\n" + "        t_coef,                                                           --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                                      --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                                                --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "        t_coef"
        + "\n" + "),"
        + "\n" + "t2_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_810")
        + "\n" + "),"
        + "\n" + "t3_zalog_810 as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        t2_zalog_810.t_accountNumber,"
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as t_provisionSum,             --Сумма_Обеспечения для Простого обеспечения"
        + "\n" + "        cb.t_reserveAmount,                                               --Сумма сформированного резерва по активу"
        + "\n" + "        cb.t_calcReserve,                                                 --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapterNumberMain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                                        --Простое обеспечение/Контргарантия"
        + "\n" + "   from t1_zalog_810, t2_zalog_810, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and t1_zalog_810.t_accountNumber = t2_zalog_810.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_810")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           t2_zalog_810.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_calcReserve"
        + "\n" + "),"
        + "\n" + "t5_zalog_810 as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t1_zalog_810.t_accountNumber,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount) > 0"
        + "\n" + "                             THEN t_provisionSum * t_coef - (t_calcReserve - t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE t_provisionSum                                           --Контргарантия"
        + "\n" + "        END O_,"
        + "\n" + "        t_reserveAmount S,"
        + "\n" + "        t1_zalog_810.S_A T"
        + "\n" + "   from t3_zalog_810, t1_zalog_810"
        + "\n" + "  where t1_zalog_810.t_accountNumber = t3_zalog_810.t_accountNumber"
        + "\n" + "),"
        + "\n" + "attr_zalog_810 AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "            END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog_810"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        //расчет VVV_Залог_ГК
        + "\n" + "t1_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumber,                              --счет обеспечения"
        + "\n" + "        t_coef,                                       --К_ФПГ - коэффициент финансового положения гаранта  "
        + "\n" + "        sum(t_roubleRestMain) as S_A                  --общаа сумма обеспеченного актива для конкретного счета обеспечения"
        + "\n" + "   from t0                                            --таблица t0 описана в расчете атрибута VVV_ГарантииПолуч_ГК"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by t_accountNumber,"
        + "\n" + "           t_coef"
        + "\n" + "),"
        + "\n" + "t2_zalog as"
        + "\n" + "("
        + "\n" + " select t_accountNumberMain,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_hasNvpi != " + SET_CHAR
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN t_fiId != 0"
        + "\n" + "                             THEN t_rest"
        + "\n" + "                         ELSE rsb_fiinstr.convSumType(t_rest,"
        + "\n" + "                                                      t_fiIdLinked,"
        + "\n" + "                                                      t_fiId,"
        + "\n" + "                                                  " + RATETYPE_CB + ","
        + "\n" + "                                                  " + reportDate
        + "\n" + "                                                     )"
        + "\n" + "                END"
        + "\n" + "            ELSE t_equivalentRest"
        + "\n" + "        END S_Ob"
        + "\n" + "   from df634cb_tmp"
        + "\n" + "  where " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "t3_zalog as"
        + "\n" + "("
        + "\n" + " select cb.t_fiId,"
        + "\n" + "        cb.t_fiidMain,"
        + "\n" + "        cb.t_accountNumberMain,"
        + "\n" + "        t1_zalog.t_accountNumber,"
        + "\n" + "        t1_zalog.t_coef,                                                                                                  "
        + "\n" + "        SUM(S_Ob * t_roubleRestMain / S_A) as S_Oi,   --сумма обеспечения по активу для конкретного счета обеспечения"
        + "\n" + "        cb.t_chapterNumberMain,"
        + "\n" + "        cb.t_reserveAmount,"
        + "\n" + "        cb.t_calcReserve"
        + "\n" + "   from t1_zalog, t2_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t2_zalog.t_accountNumberMain"
        + "\n" + "    and t1_zalog.t_accountNumber = cb.t_accountNumber"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "  group by cb.t_fiId,"
        + "\n" + "           cb.t_fiidMain,"
        + "\n" + "           t1_zalog.t_accountNumber,"
        + "\n" + "           cb.t_chapterNumberMain,"
        + "\n" + "           cb.t_reserveAmount,"
        + "\n" + "           cb.t_accountNumberMain,"
        + "\n" + "           cb.t_calcReserve,"
        + "\n" + "           t1_zalog.t_coef"
        + "\n" + "),"
        + "\n" + "t4_zalog as"
        + "\n" + "("
        + "\n" + " select t_fiId,"
        + "\n" + "        t_accountNumberMain,"
        + "\n" + "        t_accountNumber,"
        + "\n" + "        t_coef,                                                                                                       "
        + "\n" + "        rsb_fiinstr.convSumType(S_Oi,"
        + "\n" + "                                t_fiidMain,"
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                                ) as S_Oi,            --сумма обеспечения по активу для конкретного счета обеспечения в валюте счета обеспечения "
        + "\n" + "        rsb_fiinstr.convSumType(t_reserveAmount,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_reserveAmount,     --Сумма сформированного резерва по активу"
        + "\n" + "        rsb_fiinstr.convSumType(t_calcReserve,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) t_calcReserve,       --Сумма расчетного резерва по активу"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_chapternumbermain = 1"
        + "\n" + "                THEN 'Простое обеспечение'"
        + "\n" + "            ELSE 'Контргарантия'"
        + "\n" + "        END t_kind                                    --Простое обеспечение/Контргарантия"
        + "\n" + "   from t3_zalog"
        + "\n" + "),"
        + "\n" + "t5_zalog as"
        + "\n" + "("
        + "\n" + " select t4_zalog.t_fiId,"
        + "\n" + "        t_kind,"
        + "\n" + "        CASE"
        + "\n" + "            WHEN t_kind = 'Простое обеспечение'"
        + "\n" + "                THEN CASE"
        + "\n" + "                         WHEN S_Oi * t_coef - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount) > 0"
        + "\n" + "                             THEN S_Oi * t_coef - (t4_zalog.t_calcReserve - t4_zalog.t_reserveAmount)"
        + "\n" + "                         ELSE 0"
        + "\n" + "                     END"
        + "\n" + "            ELSE S_Oi"
        + "\n" + "        END O_,"
        + "\n" + "        t4_zalog.t_reserveAmount S,"
        + "\n" + "        rsb_fiinstr.convSumType(cb.t_roubleRestMain,"
        + "\n" + "                            " + NATCUR + ","
        + "\n" + "                                t4_zalog.t_fiId,"
        + "\n" + "                            " + RATETYPE_CB + ","
        + "\n" + "                            " + reportDate
        + "\n" + "                               ) T"
        + "\n" + "   from t4_zalog, df634cb_tmp cb"
        + "\n" + "  where cb.t_accountNumberMain = t4_zalog.t_accountNumberMain"
        + "\n" + "    and " + getUsedByPositionClause("zalog_gk")
        + "\n" + "),"
        + "\n" + "attr_zalog_gk AS"
        + "\n" + "("
        + "\n" + "select t_fiId                                             AS t_fiId,"
        + "\n" + "       SUM("
        + "\n" + "           CASE"
        + "\n" + "               WHEN t_kind = 'Простое обеспечение' AND S <= O_"
        + "\n" + "                   THEN S"
        + "\n" + "               WHEN t_kind = 'Контргарантия' AND O_ >= (T - S)"
        + "\n" + "                   THEN T - S"
        + "\n" + "               ELSE O_"
        + "\n" + "             END"
        + "\n" + "           )                                              AS t_value"
        + "\n" + "  from t5_zalog"
        + "\n" + " group by t_fiId"
        + "\n" + "),"

        + "\n" + "attr_zalog_k AS"
        + "\n" + "("
        + "\n" + " SELECT t_fiId                                            AS t_fiId,"
        + "\n" + "        SUM(t_value)                                      AS t_value"
        + "\n" + "   FROM df634ln_tmp"
        + "\n" + "  WHERE " + getUsedByPositionClause("zalog_k")
        + "\n" + "  GROUP BY t_fiId"
        + "\n" + "),"

        //расчет VVV_рез_бал_МБК
        + "\n" + "attr_rez_bal_mbk AS                                                                     "
        + "\n" + "(                                                                                       "
        + "\n" + "select t.t_dealFiId                                                          AS t_fiId, "
        + "\n" + "       SUM(NVL(rsb_fiinstr.convSumType(t.t_rvpsSum,                                     "
        + "\n" + "                                       " + NATCUR + ",                                  "
        + "\n" + "                                       t.t_dealFiId,                                    "
        + "\n" + "                                       " + RATETYPE_CB + ",                             "
        + "\n" + "                                       t.t_rvpsRateDate                                 "
        + "\n" + "                                      ),                                                "
        + "\n" + "               0                                                                        "
        + "\n" + "              )                                                                         "
        + "\n" + "           +                                                                            "
        + "\n" + "           NVL(rsb_fiinstr.convSumType(t.t_rvpsDelayedSum,                              "
        + "\n" + "                                       " + NATCUR + ",                                  "
        + "\n" + "                                       t.t_dealFiId,                                    "
        + "\n" + "                                       " + RATETYPE_CB + ",                             "
        + "\n" + "                                       t.t_rvpsDelayedRateDate                          "
        + "\n" + "                                      ),                                                "
        + "\n" + "               0                                                                        "
        + "\n" + "              )                                                                         "
        + "\n" + "           +                                                                            "
        + "\n" + "           NVL(rsb_fiinstr.convSumType(t.t_rvpPercentSum,                               "
        + "\n" + "                                       " + NATCUR + ",                                  "
        + "\n" + "                                       t.t_dealFiId,                                    "
        + "\n" + "                                       " + RATETYPE_CB + ",                             "
        + "\n" + "                                       t.t_rvpPercentRateDate                           "
        + "\n" + "                                      ),                                                "
        + "\n" + "               0                                                                        "
        + "\n" + "              )                                                                         "
        + "\n" + "           +                                                                            "
        + "\n" + "           NVL(rsb_fiinstr.convSumType(t.t_rvpDelayedPercentSum,                        "
        + "\n" + "                                       " + NATCUR + ",                                  "
        + "\n" + "                                       t.t_dealFiId,                                    "
        + "\n" + "                                       " + RATETYPE_CB + ",                             "
        + "\n" + "                                       t.t_rvpDelayedPercentRateDate                    "
        + "\n" + "                                      ),                                                "
        + "\n" + "               0                                                                        "
        + "\n" + "              )                                                                         "
        + "\n" + "           +                                                                            "
        + "\n" + "           NVL(rsb_fiinstr.convSumType(t.t_rvpPenaltySum,                               "
        + "\n" + "                                       " + NATCUR + ",                                  "
        + "\n" + "                                       t.t_dealFiId,                                    "
        + "\n" + "                                       " + RATETYPE_CB + ",                             "
        + "\n" + "                                       t.t_rvpPenaltyRateDate                           "
        + "\n" + "                                      ),                                                "
        + "\n" + "               0                                                                        "
        + "\n" + "              )                                                                         "
        + "\n" + "          )                                                                  AS t_value "
        + "\n" + "  from df634MmdReserves_tmp t                                                           "
        + "\n" + " group by t.t_dealFiId                                                                  "
        + "\n" + "),"

        //расчет VVV_ГарантииПолуч_МБК
        + "\n" + "t1_garantiipolu4_mbk as                                                                                                                                                                                                 "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t.t_dealId,                                                                                                                                                                                                      "
        + "\n" + "       t.t_guaranteeFiId,                                                                                                                                                                                               "
        + "\n" + "       T.T_CALCRVPSSUM + T.T_CALCRVPSDELAYEDSUM                                              AS t_calcReserve,    --Сумма расчетного резерва по Сделке МБК (в рублях)                                                   "
        + "\n" + "       T.T_RVPSSUM + T.T_RVPSDELAYEDSUM                                                      AS t_reserve,        --Сумма сформированного резерва по Сделке МБК (в рублях)                                              "
        + "\n" + "       SUM(t.t_roubleCost) OVER (PARTITION BY t.t_contractNumber)                            AS t_garSumRub,                                                                                                            "
        + "\n" + "       t.t_mainDebtSum,                                                                                                                                                                                                 "
        + "\n" + "       t.t_delayedMainDebtSum,                                                                                                                                                                                          "
        + "\n" + "       SUM(t.t_mainDebtSum + t.t_delayedMainDebtSum) OVER (PARTITION BY t.t_contractNumber)  AS t_mainDebtTotal,  --S_D - суммарный обеспеченный основной долг по одному обеспечению: ОД + просроченный ОД (в рублях)   "
        + "\n" + "       NVL(rep_note.getMoneyPartyNote(t.t_secissuer, 70, " + reportDate + "),                                                                                                                                           "
        + "\n" + "           CASE                                                                                                                                                                                                         "
        + "\n" + "               WHEN T_FINANCIALSTATE = 3                                                                                                                                                                                "
        + "\n" + "                   THEN CASE                                                                                                                                                                                            "
        + "\n" + "                            WHEN t_termhardstate <= 180                                                                                                                                                                 "
        + "\n" + "                                THEN 0.75                                                                                                                                                                               "
        + "\n" + "                            WHEN t_termhardstate <= 270                                                                                                                                                                 "
        + "\n" + "                                THEN 0.50                                                                                                                                                                               "
        + "\n" + "                            WHEN t_termhardstate <= 365                                                                                                                                                                 "
        + "\n" + "                                THEN 0.25                                                                                                                                                                               "
        + "\n" + "                            ELSE 0                                                                                                                                                                                      "
        + "\n" + "                        END                                                                                                                                                                                             "
        + "\n" + "               ELSE 1                                                                                                                                                                                                   "
        + "\n" + "           END) t_coef                                                                                            --К_ФПГ - коэффициент финансового положения гаранта                                                   "
        + "\n" + "  from df634MmdGuaranty_tmp t                                                                                                                                                                                           "
        + "\n" + " WHERE " + getUsedByPositionClause("garantiipolu4_mbk")
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "t2_garantiipolu4_mbk as                                                                                                                                                                                                 "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t1.t_dealId,                                                                                                                                                                                                     "
        + "\n" + "       t1.t_guaranteeFiId,                                                                                                                                                                                              "
        + "\n" + "       t1.t_calcReserve,                                                                                                                                                                                                "
        + "\n" + "       t1.t_reserve,                                                                                                                                                                                                    "
        + "\n" + "       CASE                                                                                                                                                                                                             "
        + "\n" + "           WHEN t1.t_mainDebtTotal <> 0                                                                                                                                                                                 "
        + "\n" + "               THEN (t1.t_mainDebtSum + t1.t_delayedMainDebtSum) * t1.t_garSumRub / t1.t_mainDebtTotal                                                                                                                  "
        + "\n" + "           ELSE 0                                                                                                                                                                                                       "
        + "\n" + "       END                                                                                                AS S_O, --S_О - сумма обеспечения для Сделки МБК (в рублях)                                                   "
        + "\n" + "       t1.t_coef                                                                                                                                                                                                        "
        + "\n" + "  from t1_garantiipolu4_mbk t1                                                                                                                                                                                          "
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "t3_garantiipolu4_mbk AS                                                                                                                                                                                                 "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t2.t_reserve                                                                AS S_,                                                                                                                               "
        + "\n" + "       t2.t_guaranteeFiId,                                                                                                                                                                                              "
        + "\n" + "       case                                                                                                                                                                                                             "
        + "\n" + "            when SUM(S_O) * t2.t_coef - (t2.t_calcReserve - t2.t_reserve) > 0                                     --SUM(S_O) * t_coef - Сумма_Обеспечения                                                               "
        + "\n" + "                then SUM(S_O) * t2.t_coef - (t2.t_calcReserve - t2.t_reserve)                                                                                                                                           "
        + "\n" + "            else 0                                                                                                                                                                                                      "
        + "\n" + "       end                                                                         AS O_                                                                                                                                "
        + "\n" + "  from t2_garantiipolu4_mbk t2                                                                                                                                                                                          "
        + "\n" + " group by t2.t_calcReserve,                                                                                                                                                                                             "
        + "\n" + "          t2.t_reserve,                                                                                                                                                                                                 "
        + "\n" + "          t2.t_guaranteeFiId,                                                                                                                                                                                           "
        + "\n" + "          t2.t_coef                                                                                                                                                                                                     "
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "attr_garantiipolu4_mbk AS                                                                                                                                                                                               "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t3.t_guaranteeFiId                                                          AS t_fiId,                                                                                                                           "
        + "\n" + "       SUM(CASE                                                                                                                                                                                                         "
        + "\n" + "               WHEN t3.S_ < t3.O_                                                                                                                                                                                       "
        + "\n" + "                   THEN NVL(rsb_fiinstr.convSumType(t3.S_,                                                                                                                                                              "
        + "\n" + "                                                    " + NATCUR + ",                                                                                                                                                     "
        + "\n" + "                                                    t3.t_guaranteeFiId,                                                                                                                                                 "
        + "\n" + "                                                    " + RATETYPE_CB + ",                                                                                                                                                "
        + "\n" + "                                                    " + reportDate + "                                                                                                                                                  "
        + "\n" + "                                                   ),                                                                                                                                                                   "
        + "\n" + "                            0                                                                                                                                                                                           "
        + "\n" + "                           )                                                                                                                                                                                            "
        + "\n" + "                   ELSE NVL(rsb_fiinstr.convSumType(t3.O_,                                                                                                                                                              "
        + "\n" + "                                                    " + NATCUR + ",                                                                                                                                                     "
        + "\n" + "                                                    t3.t_guaranteeFiId,                                                                                                                                                 "
        + "\n" + "                                                    " + RATETYPE_CB + ",                                                                                                                                                "
        + "\n" + "                                                    " + reportDate + "                                                                                                                                                  "
        + "\n" + "                                                   ),                                                                                                                                                                   "
        + "\n" + "                            0                                                                                                                                                                                           "
        + "\n" + "                           )                                                                                                                                                                                            "
        + "\n" + "           END)                                                                    AS t_value                                                                                                                           "
        + "\n" + "  from t3_garantiipolu4_mbk t3                                                                                                                                                                                          "
        + "\n" + " group by t3.t_guaranteeFiId                                                                                                                                                                                            "
        + "\n" + "),                                                                                                                                                                                                                      "

        //расчет VVV_Залог_МБК
        + "\n" + "t1_zalog_mbk as                                                                                                                                                                                                         "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t.t_dealId,                                                                                                                                                                                                      "
        + "\n" + "       t.t_guaranteeFiId,                                                                                                                                                                                               "
        + "\n" + "       T.T_CALCRVPSSUM + T.T_CALCRVPSDELAYEDSUM                                              AS t_calcReserve,    --Сумма расчетного резерва по Сделке МБК (в рублях)                                                   "
        + "\n" + "       T.T_RVPSSUM + T.T_RVPSDELAYEDSUM                                                      AS t_reserve,        --Сумма сформированного резерва по Сделке МБК (в рублях)                                              "
        + "\n" + "       SUM(t.t_roubleCost) OVER (PARTITION BY t.t_contractNumber)                            AS t_garSumRub,                                                                                                            "
        + "\n" + "       t.t_mainDebtSum,                                                                                                                                                                                                 "
        + "\n" + "       t.t_delayedMainDebtSum,                                                                                                                                                                                          "
        + "\n" + "       SUM(t.t_mainDebtSum + t.t_delayedMainDebtSum) OVER (PARTITION BY t.t_contractNumber)  AS t_mainDebtTotal,  --S_D - суммарный обеспеченный основной долг по одному обеспечению: ОД + просроченный ОД (в рублях)   "
        + "\n" + "       NVL(rep_note.getMoneyPartyNote(t.t_secissuer, 70, " + reportDate + "),                                                                                                                                           "
        + "\n" + "           CASE                                                                                                                                                                                                         "
        + "\n" + "               WHEN T_FINANCIALSTATE = 3                                                                                                                                                                                "
        + "\n" + "                   THEN CASE                                                                                                                                                                                            "
        + "\n" + "                            WHEN t_termhardstate <= 180                                                                                                                                                                 "
        + "\n" + "                                THEN 0.75                                                                                                                                                                               "
        + "\n" + "                            WHEN t_termhardstate <= 270                                                                                                                                                                 "
        + "\n" + "                                THEN 0.50                                                                                                                                                                               "
        + "\n" + "                            WHEN t_termhardstate <= 365                                                                                                                                                                 "
        + "\n" + "                                THEN 0.25                                                                                                                                                                               "
        + "\n" + "                            ELSE 0                                                                                                                                                                                      "
        + "\n" + "                        END                                                                                                                                                                                             "
        + "\n" + "               ELSE 1                                                                                                                                                                                                   "
        + "\n" + "           END) t_coef                                                                                            --К_ФПГ - коэффициент финансового положения гаранта                                                   "
        + "\n" + "  from df634MmdGuaranty_tmp t                                                                                                                                                                                           "
        + "\n" + " WHERE " + getUsedByPositionClause("zalog_mbk")
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "t2_zalog_mbk as                                                                                                                                                                                                         "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t1.t_dealId,                                                                                                                                                                                                     "
        + "\n" + "       t1.t_guaranteeFiId,                                                                                                                                                                                              "
        + "\n" + "       t1.t_calcReserve,                                                                                                                                                                                                "
        + "\n" + "       t1.t_reserve,                                                                                                                                                                                                    "
        + "\n" + "       CASE                                                                                                                                                                                                             "
        + "\n" + "           WHEN t1.t_mainDebtTotal <> 0                                                                                                                                                                                 "
        + "\n" + "               THEN (t1.t_mainDebtSum + t1.t_delayedMainDebtSum) * t1.t_garSumRub / t1.t_mainDebtTotal                                                                                                                  "
        + "\n" + "           ELSE 0                                                                                                                                                                                                       "
        + "\n" + "       END                                                                                                AS S_O, --S_О - сумма обеспечения для Сделки МБК (в рублях)                                                   "
        + "\n" + "       t1.t_coef                                                                                                                                                                                                        "
        + "\n" + "  from t1_zalog_mbk t1                                                                                                                                                                                                  "
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "t3_zalog_mbk AS                                                                                                                                                                                                         "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t2.t_reserve                                                                AS S_,                                                                                                                               "
        + "\n" + "       t2.t_guaranteeFiId,                                                                                                                                                                                              "
        + "\n" + "       case                                                                                                                                                                                                             "
        + "\n" + "            when SUM(S_O) * t2.t_coef - (t2.t_calcReserve - t2.t_reserve) > 0                                     --SUM(S_O) * t_coef - Сумма_Обеспечения                                                               "
        + "\n" + "                then SUM(S_O) * t2.t_coef - (t2.t_calcReserve - t2.t_reserve)                                                                                                                                           "
        + "\n" + "            else 0                                                                                                                                                                                                      "
        + "\n" + "       end                                                                         AS O_                                                                                                                                "
        + "\n" + "  from t2_zalog_mbk t2                                                                                                                                                                                                  "
        + "\n" + " group by t2.t_calcReserve,                                                                                                                                                                                             "
        + "\n" + "          t2.t_reserve,                                                                                                                                                                                                 "
        + "\n" + "          t2.t_guaranteeFiId,                                                                                                                                                                                           "
        + "\n" + "          t2.t_coef                                                                                                                                                                                                     "
        + "\n" + "),                                                                                                                                                                                                                      "
        + "\n" + "attr_zalog_mbk AS                                                                                                                                                                                                       "
        + "\n" + "(                                                                                                                                                                                                                       "
        + "\n" + "select t3.t_guaranteeFiId                                                          AS t_fiId,                                                                                                                           "
        + "\n" + "       SUM(CASE                                                                                                                                                                                                         "
        + "\n" + "               WHEN t3.S_ < t3.O_                                                                                                                                                                                       "
        + "\n" + "                   THEN NVL(rsb_fiinstr.convSumType(t3.S_,                                                                                                                                                              "
        + "\n" + "                                                    " + NATCUR + ",                                                                                                                                                     "
        + "\n" + "                                                    t3.t_guaranteeFiId,                                                                                                                                                 "
        + "\n" + "                                                    " + RATETYPE_CB + ",                                                                                                                                                "
        + "\n" + "                                                    " + reportDate + "                                                                                                                                                  "
        + "\n" + "                                                   ),                                                                                                                                                                   "
        + "\n" + "                            0                                                                                                                                                                                           "
        + "\n" + "                           )                                                                                                                                                                                            "
        + "\n" + "                   ELSE NVL(rsb_fiinstr.convSumType(t3.O_,                                                                                                                                                              "
        + "\n" + "                                                    " + NATCUR + ",                                                                                                                                                     "
        + "\n" + "                                                    t3.t_guaranteeFiId,                                                                                                                                                 "
        + "\n" + "                                                    " + RATETYPE_CB + ",                                                                                                                                                "
        + "\n" + "                                                    " + reportDate + "                                                                                                                                                  "
        + "\n" + "                                                   ),                                                                                                                                                                   "
        + "\n" + "                            0                                                                                                                                                                                           "
        + "\n" + "                           )                                                                                                                                                                                            "
        + "\n" + "           END)                                                                    AS t_value                                                                                                                           "
        + "\n" + "  from t3_zalog_mbk t3                                                                                                                                                                                                  "
        + "\n" + " group by t3.t_guaranteeFiId                                                                                                                                                                                            "
        + "\n" + ")                                                                                                                                                                                                                       "

        + "\n" + "SELECT fi.t_code " + makeFieldAlias("code", false) + ","
        + "\n" + "       fi.t_sort " + makeFieldAlias("sort", false) + ","
        + "\n" + "       fi.t_name " + makeFieldAlias("name", false) + ","
        + "\n" + "       fi.t_kind " + makeFieldAlias("kind", false) + ","
        + "\n" + "       fi.t_ccy  " + makeFieldAlias("ccy",  false) + ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN EXISTS (SELECT 1"
        + "\n" + "                          FROM daccount_dbt account"
        + "\n" + "                         WHERE fi.t_id = account.t_code_currency"
        + "\n" + "                           AND fi.t_id <> " + NATCUR
        + "\n" + "                            AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
        + "\n" + "                           AND (    account.t_open_date <= " + reportDate
        + "\n" + "                                AND (   account.t_close_date > " + reportDate
        + "\n" + "                                     OR account.t_close_date = " + getSqlDate(Date(0,0,0))
        + "\n" + "                                    )"
        + "\n" + "                               )"
        + "\n" + "                       )"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "       END " + makeFieldAlias("hasOpenedAccount", false) + ",";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " NVL(" + m_viewNameList[i] + ".t_value, 0) " + makeFieldAlias(m_viewNameList[i]) + ",";
            i = i + 1;
        end;

        query = subStr(query, 1, strLen(query) - 1);
        query = query + "\n" + " FROM v_rcb_f634_fininstr fi";

        i = 0;
        while (i < m_viewNameList.size)
            query = query + "\n" + " LEFT JOIN " + m_viewNameList[i] + " ON " + m_viewNameList[i] + ".t_fiid = fi.t_id";
            i = i + 1;
        end;

        query = query  + "\n" + "ORDER BY fi.t_code";

        return query;
    end;

    private macro constructorTSaverDataSource_4927(parameters : TParameters)
        initTDataSource(BoNothing, parameters);

        var i;

        m_viewNameList = arrCreate("attr_3",
                                   "attr_4",
                                   "attr_5",
                                   "attr_10",
                                   "attr_rez_bal_gk",
                                   "attr_rez_bal_gk_810",
                                   "attr_garantiipolu4",
                                   "attr_akkreditiv",
                                   "attr_3_810",
                                   "attr_3_810_reval",
                                   "attr_4_810",
                                   "attr_5_810",
                                   "attr_garpolu4_810",
                                   "attr_rez_bal_k",
                                   "attr_garantiipolu4_k",
                                   "attr_gar_k",
                                   "attr_garrez_k",
                                   "attr_zalog_k",
                                   "attr_3_810_eq",
                                   "attr_4_810_eq",
                                   "attr_5_810_eq",
                                   "attr_10_k",
                                   "attr_akkreditiv_810",
                                   "attr_gar_gk",
                                   "attr_gar_810",
                                   "attr_garrez_gk",
                                   "attr_zalog_810",
                                   "attr_zalog_gk",
                                   "attr_rez_bal_mbk",
                                   "attr_garantiipolu4_mbk",
                                   "attr_zalog_mbk"
                                  );

        m_container = TRsbDataset(makeDataQuery());

        i = 0;
        while (i < m_viewNameList.size)
            m_container.setFieldType(makeFieldAlias(m_viewNameList[i]), V_MONEY);
            i = i + 1;
        end;

        m_rootAttributeName = USER_INPUT;

        m_attributeValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        m_attributeValueIterator.setSortOrder(TUserInputSorter());
        m_attributeValueIterator.setFilter(TFilterByReportDate(getParameters().getEndDate()));

        m_isFirstCall = true;
    end;

    constructorTSaverDataSource_4927(parameters);
end;

/**
 *  Класс сохранения значений переменных, базовый
 */
private class TVariableSaver(attributeName : String, report : Object)
    private var m_report;
    private var m_parameters;
    private var m_attributeName;
    private var m_value;

    macro getAttributeName()
        return m_attributeName;
    end;

    macro getParameters()
        return m_parameters;
    end;

    macro save()
        throw(TPureVirtualMethodCallException("TVariableSaver::save"));
    end;

    private macro getAttributeValue()

        if (not m_report.attributeValue(m_attributeName).isDefined())
            throw(TUndefinedValueException(m_attributeName));
        end;

        return m_report.attributeValue(m_attributeName);
    end;

    private macro constructorTVariableSaver(attributeName : String, report : Object)
        defaultParm(report, RcbApplication().currentReport);

        m_report = RcbApplication().currentReport;
        m_parameters = TParameters(report);
        m_attributeName = attributeName;
    end;

    constructorTVariableSaver(attributeName, report);
end;

/**
 *  Сохранение простой переменной
 */
private class (TVariableSaver) TSimpleVariableSaver(attributeName : String, report : Object)

    private macro makeValue()
        throw(TPureVirtualMethodCallException("TSimpleVariableSaver::makeValue"));
    end;

    macro save()
        if (not m_report.attributeValue(getAttributeName()).isDefined)
            if (m_value == null)
                makeValue();
            end;

            m_report.attributeValue(getAttributeName()).exact = m_value;
        end;
    end;

    macro getValue()
        throw(TPureVirtualMethodCallException("TSimpleVariableSaver::getValue"));
    end;

    private macro constructorTSimpleVariableSaver(attributeName : String, report : Object)
        initTVariableSaver(attributeName, report);
    end;

    constructorTSimpleVariableSaver(attributeName, report);
end;

/**
 *  Сохранение данных ОВП
 *  Структурные переменные польз. ввода указываются в том ФИ, в каком учитываются.
 */
private class (TVariableSaver) TOcpSaver(report : Object, capitalData : TCapitalData)
    private var m_structureFieldIdList;
    private var m_dataSource;
    private var m_capitalData = capitalData;

    private macro createStructureFieldIdList()

        private class TSorter()
            macro isLess(v1, v2)
                return v1.number < v2.number;
            end;
        end;

        var fieldIterator = m_report.form.attribute(getAttributeName()).structure.createFieldIterator();

        fieldIterator.setSortOrder(TSorter());
        fieldIterator.first();
        while (not fieldIterator.isDone())
            m_structureFieldIdList[m_structureFieldIdList.size] = fieldIterator.currentItem.id;
            fieldIterator.next();
        end;
    end;

    private macro getRate(fiCode, precision, scale)
        var value;
        var rate = TRecHandler("ratedef.dbt");

        if (ПолучитьКурс(rate, "810", string(fiCode : 3 : 0 : o : r), RATETYPE_CB) == 0)
            if (ПолучитьЗначениеКурса(rate, getParameters().getEndDate()) == 0)
                if (rate.rec.isInverse == "")
                    value = (rate.rec.rate / pow(10, rate.rec.point)) / rate.rec.scale;
                else
                    value = rate.rec.scale / (rate.rec.rate / pow(10, rate.rec.point));
                end;
            else
                throw(TRateValueNotFoundException(0, string(fiCode : 3 : 0 : o : r), getParameters().getEndDate()));
            end;
        else
            throw(TRateNotFoundException("810", string(fiCode : 3 : 0 : o : r)));
        end;

        precision = rate.rec.point + int(log10(rate.rec.scale));

        setParm(3, rate.rec.scale);
        setParm(2, precision);

        return value;
    end;

    private macro getRateSetDate(code)
        var dataSet = TRsbDataset(         "SELECT t_inputDate"
                                  + "\n" + "  FROM dratedef_dbt"
                                  + "\n" + " WHERE t_otherFi = ("
                                  + "\n" + "                    SELECT t_fiId"
                                  + "\n" + "                      FROM dfininstr_dbt"
                                  + "\n" + "                     WHERE t_fi_code = " + getSqlString(code)
                                  + "\n" + "                   )"
                                  + "\n" + "   AND t_isDominant = " + rcbSqlBool(true));
        dataSet.next();

        return Date(dataSet.inputDate);
    end;

    macro save()
        var variableRoot, variableL1;
        var totalsAttribute, totalsValue;
        var limitsDataSource;
        var i;
        var reportDate;
        var sort;
        var fiCode;
        var scale;
        var currencyOrMetal;
        var ccy;
        var rateSetDate;
        var hasOpenedAccount;
        var ratePrecision;
        var Capital;

        var VVV_1,  VVV_2,  VVV_3,  VVV_4,  VVV_5,  VVV_6,
            VVV_7,  VVV_8,  VVV_9,  VVV_10, VVV_11, VVV_12,
            VVV_13, VVV_14, VVV_15, VVV_16, VVV_17, VVV_18;

        var ДП_13,   КП_14,
            ДБП_13,  КБП_14,
            БОВП_15, КОВПБ_18,
            ДОВП_13, КОВП_14;

        var ЛимБОВП_16, ЛимСОВП_16,
            ПрЛОВПБ_17, ПрЛОВПСум_17,
            КОВПСум_18, СумОВП_15;

        var VVV_рез_бал;
        var VVV_рез_бал_810;
        var VVV_ТрППИвБД, VVV_ТрППИвБД_810;
        var VVV_Гар;
        var VVV_ГарРез;
        var VVV_ГарантииПолуч, VVV_Аккредитив;
        var VVV_Залог;
        var VVV_2_810, VVV_3_810, VVV_4_810, VVV_5_810, VVV_6_810, VVV_7_810;
        var VVV_3_810_eq, VVV_4_810_eq, VVV_5_810_eq;
        var VVV_ГарПолуч_810, VVV_Аккредитив_810, VVV_Гар_810;
        var VVV_СдФИСр, VVV_СдФИСр_810;

        limitsDataSource = TUserInputDataSource(getParameters());

        reportDate = strSubst(string(getParameters().getEndDate()), " ", "0");

        Capital = m_capitalData.getValue().exact;

        ДП_13      = $0;  КП_14        = $0;
        ДБП_13     = $0;  КБП_14       = $0;
        ДОВП_13    = $0;  КОВП_14      = $0;
        БОВП_15    = 0.0; СумОВП_15    = 0.0;
        ПрЛОВПБ_17 = 0.0; ПрЛОВПСум_17 = 0.0;

        if (limitsDataSource.next())
            ЛимБОВП_16 = limitsDataSource.getValue("ЛимБОВП_16");
            ЛимСОВП_16 = limitsDataSource.getValue("ЛимСОВП_16");

            КОВПБ_18   = limitsDataSource.getValue("КОВПБ_18");
            КОВПСум_18 = limitsDataSource.getValue("КОВПСум_18");
        else
            throw(TUndefinedValueException(USER_INPUT_LIMITS));
        end;

        variableRoot = m_report.attributeValue(getAttributeName());

        while (m_dataSource.next())
            sort = m_dataSource.getValue("sort");

            fiCode = m_dataSource.getValue("code");

            hasOpenedAccount = m_dataSource.getValue("hasOpenedAccount");

            VVV_2 = m_dataSource.getValue("name");

            VVV_6 = Round(m_dataSource.getValue("6"), 1);

            VVV_12 = Round(getRate(fiCode, ratePrecision, scale),4);

            currencyOrMetal = m_dataSource.getValue("kind");

            ccy = m_dataSource.getValue("ccy");

            rateSetDate = getRateSetDate(fiCode);

            VVV_16 = m_dataSource.getValue("16");

            VVV_ТрППИвБД = m_dataSource.getValue("ТрППИвБД");

            VVV_Аккредитив = m_dataSource.getValue("akkreditiv");

            VVV_18 = m_dataSource.getValue("18");

            VVV_2_810 = "В том числе руб./" + VVV_2;

            VVV_3_810_eq = Round(m_dataSource.getValue("3_810_eq"), 1);

            VVV_4_810_eq = Round(m_dataSource.getValue("4_810_eq"), 1);

            VVV_5_810_eq = Round(m_dataSource.getValue("5_810_eq"), 1);

            VVV_6_810 = Round(m_dataSource.getValue("6_810") / VVV_12, 1);

            VVV_ТрППИвБД_810 = Round(m_dataSource.getValue("ТрППИвБД_810") / VVV_12, 1);

            VVV_СдФИСр = m_dataSource.getValue("СдФИСр");

            VVV_ГарантииПолуч = m_dataSource.getValue("garantiipolu4") + m_dataSource.getValue("garantiipolu4_k");

            VVV_ГарПолуч_810 = m_dataSource.getValue("garpolu4_810") + m_dataSource.getValue("garpolu4_k_810");

            VVV_СдФИСр_810 = Round(m_dataSource.getValue("СдФИСр_810") / VVV_12, 1);

            VVV_рез_бал_810 = Round(m_dataSource.getValue("rez_bal_gk_810"), 1);

            VVV_рез_бал = Round(m_dataSource.getValue("rez_bal_gk") + m_dataSource.getValue("rez_bal_k"), 1);

            VVV_3_810 = Round(m_dataSource.getValue("3_810") / VVV_12, 1) + VVV_3_810_eq - VVV_рез_бал_810;

            VVV_4_810 = Round(m_dataSource.getValue("4_810") / VVV_12,1) + VVV_4_810_eq;

            VVV_5_810 = Round(m_dataSource.getValue("5_810") / VVV_12, 1) + VVV_5_810_eq - VVV_ТрППИвБД_810 - VVV_СдФИСр_810;

            VVV_7_810 = VVV_ГарПолуч_810 - m_dataSource.getValue("gar_810") - m_dataSource.getValue("akkreditiv_810") + m_dataSource.getValue("zalog_810");

            VVV_Залог = m_dataSource.getValue("zalog_gk") + m_dataSource.getValue("zalog_k");

            VVV_ГарРез = m_dataSource.getValue("garrez_gk") + m_dataSource.getValue("garrez_k");

            VVV_Гар = m_dataSource.getValue("gar_gk") + m_dataSource.getValue("gar_k") - VVV_ГарРез;

            VVV_3 = Round(m_dataSource.getValue("3"), 1) + VVV_3_810 - VVV_рез_бал;

            VVV_4 = Round(m_dataSource.getValue("4"), 1) + VVV_4_810;

            VVV_5 = Round(m_dataSource.getValue("5"), 1) + VVV_5_810 - VVV_ТрППИвБД - VVV_СдФИСр;

            VVV_7 = VVV_ГарантииПолуч - VVV_Гар - VVV_Аккредитив + VVV_Залог + VVV_7_810;

            VVV_8 = VVV_3 + VVV_4;

            VVV_10 = Round(m_dataSource.getValue("10") / VVV_12, 1) + Round(m_dataSource.getValue("10_K"), 1);

            VVV_9 = VVV_5 + VVV_6 + VVV_7 + VVV_10;

            VVV_11 = VVV_8 + VVV_9;

            VVV_13 = Round(Money(max(0, VVV_12 * VVV_11)),1);

            VVV_14 = Round(Money(min(0, VVV_12 * VVV_11)),1);

            if (Capital != 0)
                VVV_15 = Round(ternary(VVV_13 > 0, VVV_13, -VVV_14) / Capital * 100, 4);
            else
                VVV_15 = 0;
            end;

            VVV_17 = max(0, VVV_15 - VVV_16);

            VVV_12 = execExp("string(VVV_12:0:" + ratePrecision + ")");

            variableL1 = variableRoot.addValue();

            variableL1.fieldValue("Отчетная дата").exact = reportDate;
            variableL1.fieldValue("Код валюты").exact    = fiCode;
            variableL1.fieldValue("Сортировка").exact    = sort;
            variableL1.fieldValue("Открытые л/с").exact = hasOpenedAccount;
            variableL1.fieldValue("Валюта/металл").exact = currencyOrMetal;
            variableL1.fieldValue("Масштаб курса").exact = String(scale);
            variableL1.fieldValue("Буквенный код").exact = ccy;
            variableL1.fieldValue("Дата установки курса").exact = String(rateSetDate);

            variableL1.fieldValue("2").exact     = String(VVV_2)    ;
            variableL1.fieldValue("3").exact     = Money(VVV_3)     ;
            variableL1.fieldValue("4").exact     = Money(VVV_4)     ;
            variableL1.fieldValue("5").exact     = Money(VVV_5)     ;
            variableL1.fieldValue("6").exact     = Money(VVV_6)     ;
            variableL1.fieldValue("7").exact     = Money(VVV_7)     ;
            variableL1.fieldValue("8").exact     = Money(VVV_8)     ;
            variableL1.fieldValue("9").exact     = Money(VVV_9)     ;
            variableL1.fieldValue("10").exact    = Money(VVV_10)    ;
            variableL1.fieldValue("11").exact    = Money(VVV_11)    ;
            variableL1.fieldValue("12").exact    = String(VVV_12)   ;
            variableL1.fieldValue("13").exact    = Money(VVV_13)    ;
            variableL1.fieldValue("14").exact    = Money(VVV_14)    ;
            variableL1.fieldValue("15").exact    = Double(VVV_15)   ;
            variableL1.fieldValue("16").exact    = Double(VVV_16)   ;
            variableL1.fieldValue("17").exact    = Double(VVV_17)   ;
            variableL1.fieldValue("18").exact    = Double(VVV_18)   ;
            variableL1.fieldValue("2_810").exact = String(VVV_2_810);
            variableL1.fieldValue("3_810").exact = Money(VVV_3_810) ;
            variableL1.fieldValue("4_810").exact = Money(VVV_4_810) ;
            variableL1.fieldValue("5_810").exact = Money(VVV_5_810) ;
            variableL1.fieldValue("6_810").exact = Money(VVV_6_810) ;
            variableL1.fieldValue("7_810").exact = Money(VVV_7_810) ;

            ДП_13 = ДП_13 + VVV_13;
            КП_14 = КП_14 + VVV_14;
        end;

        ДБП_13 = -min(ДП_13 + КП_14, $0);
        КБП_14 = -max(ДП_13 + КП_14, $0);;

        ДОВП_13 = ДП_13 + ДБП_13;
        КОВП_14 = КП_14 + КБП_14;

        if (Capital != 0)
            СумОВП_15 = ДОВП_13 / Capital * 100;
            БОВП_15 = ternary(ДБП_13 > 0, ДБП_13, -КБП_14) / Capital * 100;
        else
            СумОВП_15 = 0.0;
            БОВП_15 = 0.0;
        end;

        ПрЛОВПБ_17 = max(0.0, БОВП_15 - ЛимБОВП_16);

        ПрЛОВПСум_17 = max(0.0, СумОВП_15 - ЛимСОВП_16);

        totalsAttribute = m_report.attributeValue(TOTALS_DATA);
        totalsValue = totalsAttribute.addValue();

        totalsValue.fieldValue("Отчетная дата").exact = reportDate  ;
        totalsValue.fieldValue("ДП_13").exact         = ДП_13       ;
        totalsValue.fieldValue("КП_14").exact         = КП_14       ;
        totalsValue.fieldValue("ДБП_13").exact        = ДБП_13      ;
        totalsValue.fieldValue("КБП_14").exact        = КБП_14      ;
        totalsValue.fieldValue("БОВП_15").exact       = БОВП_15     ;
        totalsValue.fieldValue("ДОВП_13").exact       = ДОВП_13     ;
        totalsValue.fieldValue("КОВП_14").exact       = КОВП_14     ;
        totalsValue.fieldValue("СумОВП_15").exact     = СумОВП_15   ;
        totalsValue.fieldValue("ПрЛОВПБ_17").exact    = ПрЛОВПБ_17  ;
        totalsValue.fieldValue("ПрЛОВПСум_17").exact  = ПрЛОВПСум_17;
        totalsValue.fieldValue("ЛимБОВП_16").exact    = ЛимБОВП_16  ;
        totalsValue.fieldValue("ЛимСОВП_16").exact    = ЛимСОВП_16  ;
        totalsValue.fieldValue("КОВПБ_18").exact      = КОВПБ_18    ;
        totalsValue.fieldValue("КОВПСум_18").exact    = КОВПСум_18  ;
    end;

    private macro constructorTOcpSaver(report : Object)
        initTVariableSaver(OCP_DATA, report);

        m_dataSource = TSaverDataSource(TParameters(report));
    end;

    constructorTOcpSaver(report);
end;

private class (TOcpSaver) TOcpSaver_2811(report : Object, capitalData : TCapitalData)
    InitTOcpSaver(report, CapitalData);

    macro save()
        var variableRoot, variableL1;
        var totalsAttribute, totalsValue;
        var limitsDataSource;
        var i;
        var reportDate;
        var sort;
        var fiCode;
        var scale;
        var currencyOrMetal;
        var ccy;
        var rateSetDate;
        var hasOpenedAccount;
        var ratePrecision;
        var Capital;

        var VVV_1,  VVV_2,  VVV_3,  VVV_4,  VVV_5,  VVV_6,
            VVV_7,  VVV_8,  VVV_9,  VVV_10, VVV_11, VVV_12,
            VVV_13, VVV_14, VVV_15, VVV_16, VVV_17, VVV_18;

        var ДП_13,   КП_14,
            ДБП_13,  КБП_14,
            БОВП_15, КОВПБ_18,
            ДОВП_13, КОВП_14;

        var ЛимБОВП_16, ЛимСОВП_16,
            ПрЛОВПБ_17, ПрЛОВПСум_17,
            КОВПСум_18, СумОВП_15;

        var VVV_рез_бал;
        var VVV_рез_бал_810;

        var VVV_ТрППИвБД, VVV_ТрППИвБД_810;

        var VVV_Гар;

        var VVV_ГарРез;

        var VVV_ГарантииПолуч, VVV_Аккредитив;

        var VVV_Залог;

        var VVV_2_810, VVV_3_810, VVV_4_810, VVV_5_810, VVV_6_810, VVV_7_810;

        var VVV_3_810_eq, VVV_4_810_eq, VVV_5_810_eq;

        var VVV_ГарПолуч_810, VVV_Аккредитив_810, VVV_Гар_810;

        var VVV_СдФИСр, VVV_СдФИСр_810;

        var VVV_4_ПфиБПБа, VVV_4_ПфиБПБа_810;

        var VVV_5_ПфиБПБа, VVV_5_ПфиБПБа_810;

        limitsDataSource = TUserInputDataSource(getParameters());

        reportDate = strSubst(string(getParameters().getEndDate()), " ", "0");

        Capital = m_capitalData.getValue().exact;

        ДП_13      = $0;  КП_14        = $0;
        ДБП_13     = $0;  КБП_14       = $0;
        ДОВП_13    = $0;  КОВП_14      = $0;
        БОВП_15    = 0.0; СумОВП_15    = 0.0;
        ПрЛОВПБ_17 = 0.0; ПрЛОВПСум_17 = 0.0;

        if (limitsDataSource.next())
            ЛимБОВП_16 = limitsDataSource.getValue("ЛимБОВП_16");
            ЛимСОВП_16 = limitsDataSource.getValue("ЛимСОВП_16");

            КОВПБ_18   = limitsDataSource.getValue("КОВПБ_18");
            КОВПСум_18 = limitsDataSource.getValue("КОВПСум_18");
        else
            throw(TUndefinedValueException(USER_INPUT_LIMITS));
        end;

        variableRoot = m_report.attributeValue(getAttributeName());

        while (m_dataSource.next())
            sort = m_dataSource.getValue("sort");

            fiCode = m_dataSource.getValue("code");

            hasOpenedAccount = m_dataSource.getValue("hasOpenedAccount");

            VVV_2 = m_dataSource.getValue("name");

            VVV_6 = Round(m_dataSource.getValue("6"), 1);

            VVV_12 = Round(getRate(fiCode, ratePrecision, scale),4);

            currencyOrMetal = m_dataSource.getValue("kind");

            ccy = m_dataSource.getValue("ccy");

            rateSetDate = getRateSetDate(fiCode);

            VVV_16 = m_dataSource.getValue("16");

            VVV_ТрППИвБД = m_dataSource.getValue("ТрППИвБД");

            VVV_Аккредитив = m_dataSource.getValue("akkreditiv");

            VVV_18 = m_dataSource.getValue("18");

            VVV_2_810 = "В том числе руб./" + VVV_2;

            VVV_3_810_eq = Round(m_dataSource.getValue("3_810_eq"), 1);

            VVV_4_810_eq = Round(m_dataSource.getValue("4_810_eq"), 1);

            VVV_5_810_eq = Round(m_dataSource.getValue("5_810_eq"), 1);

            VVV_6_810 = Round(m_dataSource.getValue("6_810") / VVV_12, 1);

            VVV_ТрППИвБД_810 = Round(m_dataSource.getValue("ТрППИвБД_810") / VVV_12, 1);

            VVV_СдФИСр = m_dataSource.getValue("СдФИСр");

            VVV_4_ПфиБПБа = m_dataSource.getValue("4_ПфиБПБа");

            VVV_5_ПфиБПБа = m_dataSource.getValue("5_ПфиБПБа");

            VVV_4_ПфиБПБа_810 = Round(m_dataSource.getValue("4_ПфиБПБа_810") / VVV_12, 1);

            VVV_5_ПфиБПБа_810 = Round(m_dataSource.getValue("5_ПфиБПБа_810") / VVV_12, 1);

            VVV_ГарантииПолуч = m_dataSource.getValue("garantiipolu4") + m_dataSource.getValue("garantiipolu4_k");

            VVV_ГарПолуч_810 = m_dataSource.getValue("garpolu4_810") + m_dataSource.getValue("garpolu4_k_810");

            VVV_СдФИСр_810 = Round(m_dataSource.getValue("СдФИСр_810") / VVV_12, 1);

            VVV_рез_бал_810 = Round(m_dataSource.getValue("rez_bal_gk_810"), 1);

            VVV_рез_бал = Round(m_dataSource.getValue("rez_bal_gk") + m_dataSource.getValue("rez_bal_k"), 1);

            VVV_3_810 = Round(m_dataSource.getValue("3_810") / VVV_12, 1) + VVV_3_810_eq - VVV_рез_бал_810;

            VVV_4_810 = Round(m_dataSource.getValue("4_810") / VVV_12, 1) + VVV_4_810_eq + VVV_4_ПфиБПБа_810;

            VVV_5_810 = Round(m_dataSource.getValue("5_810") / VVV_12, 1) + VVV_5_810_eq - VVV_ТрППИвБД_810 - VVV_СдФИСр_810 + VVV_5_ПфиБПБа_810;

            VVV_7_810 = VVV_ГарПолуч_810 - m_dataSource.getValue("gar_810") - m_dataSource.getValue("akkreditiv_810") + m_dataSource.getValue("zalog_810");

            VVV_Залог = m_dataSource.getValue("zalog_gk") + m_dataSource.getValue("zalog_k");

            VVV_ГарРез = m_dataSource.getValue("garrez_gk") + m_dataSource.getValue("garrez_k");

            VVV_Гар = m_dataSource.getValue("gar_gk") + m_dataSource.getValue("gar_k") - VVV_ГарРез;

            VVV_3 = Round(m_dataSource.getValue("3"), 1) + VVV_3_810 - VVV_рез_бал;

            VVV_4 = Round(m_dataSource.getValue("4"), 1) + VVV_4_810 + VVV_4_ПфиБПБа;

            VVV_5 = Round(m_dataSource.getValue("5"), 1) + VVV_5_ПфиБПБа + VVV_5_810 - VVV_ТрППИвБД - VVV_СдФИСр;

            VVV_7 = VVV_ГарантииПолуч - VVV_Гар - VVV_Аккредитив + VVV_Залог + VVV_7_810;

            VVV_8 = VVV_3 + VVV_4;

            VVV_10 = Round(m_dataSource.getValue("10") / VVV_12, 1) + m_dataSource.getValue("10_K");

            VVV_9 = VVV_5 + VVV_6 + VVV_7 + VVV_10;

            VVV_11 = VVV_8 + VVV_9;

            VVV_13 = Round(Money(max(0, VVV_12 * VVV_11)), 1);

            VVV_14 = Round(Money(min(0, VVV_12 * VVV_11)), 1);

            if (Capital != 0)
                VVV_15 = Round(ternary(VVV_13 > 0, VVV_13, -VVV_14) / Capital * 100, 4);
            else
                VVV_15 = 0;
            end;

            VVV_17 = max(0, VVV_15 - VVV_16);

            VVV_12 = execExp("string(VVV_12:0:" + ratePrecision + ")");

            variableL1 = variableRoot.addValue();

            variableL1.fieldValue("Отчетная дата").exact = reportDate;
            variableL1.fieldValue("Код валюты").exact    = fiCode;
            variableL1.fieldValue("Сортировка").exact    = sort;
            variableL1.fieldValue("Открытые л/с").exact = hasOpenedAccount;
            variableL1.fieldValue("Валюта/металл").exact = currencyOrMetal;
            variableL1.fieldValue("Масштаб курса").exact = String(scale);
            variableL1.fieldValue("Буквенный код").exact = ccy;
            variableL1.fieldValue("Дата установки курса").exact = String(rateSetDate);

            variableL1.fieldValue("2").exact     = String(VVV_2)    ;
            variableL1.fieldValue("3").exact     = Money(VVV_3)     ;
            variableL1.fieldValue("4").exact     = Money(VVV_4)     ;
            variableL1.fieldValue("5").exact     = Money(VVV_5)     ;
            variableL1.fieldValue("6").exact     = Money(VVV_6)     ;
            variableL1.fieldValue("7").exact     = Money(VVV_7)     ;
            variableL1.fieldValue("8").exact     = Money(VVV_8)     ;
            variableL1.fieldValue("9").exact     = Money(VVV_9)     ;
            variableL1.fieldValue("10").exact    = Money(VVV_10)    ;
            variableL1.fieldValue("11").exact    = Money(VVV_11)    ;
            variableL1.fieldValue("12").exact    = Money(VVV_12)   ;
            variableL1.fieldValue("13").exact    = Money(VVV_13)    ;
            variableL1.fieldValue("14").exact    = Money(VVV_14)    ;
            variableL1.fieldValue("15").exact    = Double(VVV_15)   ;
            variableL1.fieldValue("16").exact    = Double(VVV_16)   ;
            variableL1.fieldValue("17").exact    = Double(VVV_17)   ;
            variableL1.fieldValue("18").exact    = Double(VVV_18)   ;
            variableL1.fieldValue("2_810").exact = String(VVV_2_810);
            variableL1.fieldValue("3_810").exact = Money(VVV_3_810) ;
            variableL1.fieldValue("4_810").exact = Money(VVV_4_810) ;
            variableL1.fieldValue("5_810").exact = Money(VVV_5_810) ;
            variableL1.fieldValue("6_810").exact = Money(VVV_6_810) ;
            variableL1.fieldValue("7_810").exact = Money(VVV_7_810) ;

            ДП_13 = ДП_13 + VVV_13;
            КП_14 = КП_14 + VVV_14;
        end;

        ДБП_13 = -min(ДП_13 + КП_14, $0);
        КБП_14 = -max(ДП_13 + КП_14, $0);;

        ДОВП_13 = ДП_13 + ДБП_13;
        КОВП_14 = КП_14 + КБП_14;

        if (Capital != 0)
            СумОВП_15 = ДОВП_13 / Capital * 100;
            БОВП_15 = ternary(ДБП_13 > 0, ДБП_13, -КБП_14) / Capital * 100;
        else
            СумОВП_15 = 0.0;
            БОВП_15 = 0.0;
        end;

        ПрЛОВПБ_17 = max(0.0, БОВП_15 - ЛимБОВП_16);

        ПрЛОВПСум_17 = max(0.0, СумОВП_15 - ЛимСОВП_16);

        totalsAttribute = m_report.attributeValue(TOTALS_DATA);
        totalsValue = totalsAttribute.addValue();

        totalsValue.fieldValue("Отчетная дата").exact = reportDate  ;
        totalsValue.fieldValue("ДП_13").exact         = ДП_13       ;
        totalsValue.fieldValue("КП_14").exact         = КП_14       ;
        totalsValue.fieldValue("ДБП_13").exact        = ДБП_13      ;
        totalsValue.fieldValue("КБП_14").exact        = КБП_14      ;
        totalsValue.fieldValue("БОВП_15").exact       = БОВП_15     ;
        totalsValue.fieldValue("ДОВП_13").exact       = ДОВП_13     ;
        totalsValue.fieldValue("КОВП_14").exact       = КОВП_14     ;
        totalsValue.fieldValue("СумОВП_15").exact     = СумОВП_15   ;
        totalsValue.fieldValue("ПрЛОВПБ_17").exact    = ПрЛОВПБ_17  ;
        totalsValue.fieldValue("ПрЛОВПСум_17").exact  = ПрЛОВПСум_17;
        totalsValue.fieldValue("ЛимБОВП_16").exact    = ЛимБОВП_16  ;
        totalsValue.fieldValue("ЛимСОВП_16").exact    = ЛимСОВП_16  ;
        totalsValue.fieldValue("КОВПБ_18").exact      = КОВПБ_18    ;
        totalsValue.fieldValue("КОВПСум_18").exact    = КОВПСум_18  ;
    end;
end;

private class (TOcpSaver_2811) TOcpSaver_3107(report : Object, capitalData : TCapitalData)
    InitTOcpSaver_2811(report, CapitalData);

    private macro constructorTOcpSaver_3107(report : Object)
        m_dataSource = TSaverDataSource_3107(TParameters(report));
    end;

    constructorTOcpSaver_3107(report);
end;

private class (TOcpSaver_3107) TOcpSaver_XXXX1(report : Object, capitalData : TCapitalData)
    macro save()
        var variableRoot, variableL1;
        var totalsAttribute, totalsValue;
        var limitsDataSource;
        var i;
        var reportDate;
        var sort;
        var fiCode;
        var scale;
        var currencyOrMetal;
        var ccy;
        var rateSetDate;
        var hasOpenedAccount;
        var ratePrecision;
        var Capital;

        var VVV_1,  VVV_2,  VVV_3,  VVV_4,  VVV_5,  VVV_6,
            VVV_7,  VVV_8,  VVV_9,  VVV_10, VVV_11, VVV_12,
            VVV_13, VVV_14, VVV_15, VVV_16, VVV_17, VVV_18;

        var ДП_13,   КП_14,
            ДБП_13,  КБП_14,
            БОВП_15, КОВПБ_18,
            ДОВП_13, КОВП_14;

        var ЛимБОВП_16, ЛимСОВП_16,
            ПрЛОВПБ_17, ПрЛОВПСум_17,
            КОВПСум_18, СумОВП_15;

        var VVV_рез_бал;
        var VVV_рез_бал_810;

        var VVV_ТрППИвБД, VVV_ТрППИвБД_810;

        var VVV_Гар;

        var VVV_ГарРез;

        var VVV_ГарантииПолуч, VVV_Аккредитив;

        var VVV_Залог;

        var VVV_2_810, VVV_3_810, VVV_4_810, VVV_5_810, VVV_6_810, VVV_7_810;

        var VVV_3_810_eq, VVV_4_810_eq, VVV_5_810_eq;

        var VVV_ГарПолуч_810, VVV_Аккредитив_810, VVV_Гар_810;

        var VVV_СдФИСр, VVV_СдФИСр_810;

        var VVV_4_ПфиБПБа, VVV_4_ПфиБПБа_810;

        var VVV_5_ПфиБПБа, VVV_5_ПфиБПБа_810;

        limitsDataSource = TUserInputDataSource(getParameters());

        reportDate = strSubst(string(getParameters().getEndDate()), " ", "0");

        Capital = m_capitalData.getValue().exact;

        ДП_13      = $0;  КП_14        = $0;
        ДБП_13     = $0;  КБП_14       = $0;
        ДОВП_13    = $0;  КОВП_14      = $0;
        БОВП_15    = 0.0; СумОВП_15    = 0.0;
        ПрЛОВПБ_17 = 0.0; ПрЛОВПСум_17 = 0.0;

        if (limitsDataSource.next())
            ЛимБОВП_16 = limitsDataSource.getValue("ЛимБОВП_16");
            ЛимСОВП_16 = limitsDataSource.getValue("ЛимСОВП_16");

            КОВПБ_18   = limitsDataSource.getValue("КОВПБ_18");
            КОВПСум_18 = limitsDataSource.getValue("КОВПСум_18");
        else
            throw(TUndefinedValueException(USER_INPUT_LIMITS));
        end;

        variableRoot = m_report.attributeValue(getAttributeName());

        while (m_dataSource.next())
            sort = m_dataSource.getValue("sort");

            fiCode = m_dataSource.getValue("code");

            hasOpenedAccount = m_dataSource.getValue("hasOpenedAccount");

            VVV_2 = m_dataSource.getValue("name");

            VVV_6 = Round(m_dataSource.getValue("6"), 1);

            VVV_12 = Round(getRate(fiCode, ratePrecision, scale),4);

            currencyOrMetal = m_dataSource.getValue("kind");

            ccy = m_dataSource.getValue("ccy");

            rateSetDate = getRateSetDate(fiCode);

            VVV_16 = m_dataSource.getValue("16");

            VVV_ТрППИвБД = m_dataSource.getValue("ТрППИвБД");

            VVV_Аккредитив = m_dataSource.getValue("akkreditiv");

            VVV_18 = m_dataSource.getValue("18");

            VVV_2_810 = "В том числе руб./" + VVV_2;

            VVV_3_810_eq = Round(m_dataSource.getValue("3_810_eq"), 1);

            VVV_4_810_eq = Round(m_dataSource.getValue("4_810_eq"), 1);

            VVV_5_810_eq = Round(m_dataSource.getValue("5_810_eq"), 1);

            VVV_6_810 = Round(m_dataSource.getValue("6_810") / VVV_12, 1);

            VVV_ТрППИвБД_810 = Round(m_dataSource.getValue("ТрППИвБД_810") / VVV_12, 1);

            VVV_СдФИСр = m_dataSource.getValue("СдФИСр");

            VVV_4_ПфиБПБа = m_dataSource.getValue("4_ПфиБПБа");

            VVV_5_ПфиБПБа = m_dataSource.getValue("5_ПфиБПБа");

            VVV_4_ПфиБПБа_810 = Round(m_dataSource.getValue("4_ПфиБПБа_810") / VVV_12, 1);

            VVV_5_ПфиБПБа_810 = Round(m_dataSource.getValue("5_ПфиБПБа_810") / VVV_12, 1);

            VVV_ГарантииПолуч = m_dataSource.getValue("garantiipolu4") + m_dataSource.getValue("garantiipolu4_k");

            VVV_ГарПолуч_810 = m_dataSource.getValue("garpolu4_810");

            VVV_СдФИСр_810 = Round(m_dataSource.getValue("СдФИСр_810") / VVV_12, 1);

            VVV_рез_бал_810 = Round(m_dataSource.getValue("rez_bal_gk_810"), 1);

            VVV_рез_бал = Round(m_dataSource.getValue("rez_bal_gk") + m_dataSource.getValue("rez_bal_k"), 1);

            VVV_3_810 = Round(m_dataSource.getValue("3_810") / VVV_12, 1) + VVV_3_810_eq - VVV_рез_бал_810;

            VVV_4_810 = Round(m_dataSource.getValue("4_810") / VVV_12, 1) + VVV_4_810_eq + VVV_4_ПфиБПБа_810;

            VVV_5_810 = Round(m_dataSource.getValue("5_810") / VVV_12, 1) + VVV_5_810_eq - VVV_ТрППИвБД_810 - VVV_СдФИСр_810 + VVV_5_ПфиБПБа_810;

            VVV_7_810 = VVV_ГарПолуч_810 - m_dataSource.getValue("gar_810") - m_dataSource.getValue("akkreditiv_810") + m_dataSource.getValue("zalog_810");

            VVV_Залог = m_dataSource.getValue("zalog_gk") + m_dataSource.getValue("zalog_k");

            VVV_ГарРез = m_dataSource.getValue("garrez_gk") + m_dataSource.getValue("garrez_k");

            VVV_Гар = m_dataSource.getValue("gar_gk") + m_dataSource.getValue("gar_k") - VVV_ГарРез;

            VVV_3 = Round(m_dataSource.getValue("3"), 1) + Round(m_dataSource.getValue("3_810_reval"), 1) + VVV_3_810 - VVV_рез_бал;

            VVV_4 = Round(m_dataSource.getValue("4"), 1) + VVV_4_810 + VVV_4_ПфиБПБа;

            VVV_5 = Round(m_dataSource.getValue("5"), 1) + VVV_5_ПфиБПБа + VVV_5_810 - VVV_ТрППИвБД - VVV_СдФИСр;

            VVV_7 = VVV_ГарантииПолуч - VVV_Гар - VVV_Аккредитив + VVV_Залог + VVV_7_810;

            VVV_8 = VVV_3 + VVV_4;

            VVV_10 = Round(m_dataSource.getValue("10") / VVV_12, 1) + m_dataSource.getValue("10_K");

            VVV_9 = VVV_5 + VVV_6 + VVV_7 + VVV_10;

            VVV_11 = VVV_8 + VVV_9;

            VVV_13 = Round(Money(max(0, VVV_12 * VVV_11)), 1);

            VVV_14 = Round(Money(min(0, VVV_12 * VVV_11)), 1);

            if (Capital != 0)
                VVV_15 = Round(ternary(VVV_13 > 0, VVV_13, -VVV_14) / Capital * 100, 4);
            else
                VVV_15 = 0;
            end;

            VVV_17 = max(0, VVV_15 - VVV_16);

            VVV_12 = execExp("string(VVV_12:0:" + ratePrecision + ")");

            variableL1 = variableRoot.addValue();

            variableL1.fieldValue("Отчетная дата").exact = reportDate;
            variableL1.fieldValue("Код валюты").exact    = fiCode;
            variableL1.fieldValue("Сортировка").exact    = sort;
            variableL1.fieldValue("Открытые л/с").exact = hasOpenedAccount;
            variableL1.fieldValue("Валюта/металл").exact = currencyOrMetal;
            variableL1.fieldValue("Масштаб курса").exact = String(scale);
            variableL1.fieldValue("Буквенный код").exact = ccy;
            variableL1.fieldValue("Дата установки курса").exact = String(rateSetDate);

            variableL1.fieldValue("2").exact     = String(VVV_2)    ;
            variableL1.fieldValue("3").exact     = Money(VVV_3)     ;
            variableL1.fieldValue("4").exact     = Money(VVV_4)     ;
            variableL1.fieldValue("5").exact     = Money(VVV_5)     ;
            variableL1.fieldValue("6").exact     = Money(VVV_6)     ;
            variableL1.fieldValue("7").exact     = Money(VVV_7)     ;
            variableL1.fieldValue("8").exact     = Money(VVV_8)     ;
            variableL1.fieldValue("9").exact     = Money(VVV_9)     ;
            variableL1.fieldValue("10").exact    = Money(VVV_10)    ;
            variableL1.fieldValue("11").exact    = Money(VVV_11)    ;
            variableL1.fieldValue("12").exact    = Money(VVV_12)   ;
            variableL1.fieldValue("13").exact    = Money(VVV_13)    ;
            variableL1.fieldValue("14").exact    = Money(VVV_14)    ;
            variableL1.fieldValue("15").exact    = Double(VVV_15)   ;
            variableL1.fieldValue("16").exact    = Double(VVV_16)   ;
            variableL1.fieldValue("17").exact    = Double(VVV_17)   ;
            variableL1.fieldValue("18").exact    = Double(VVV_18)   ;
            variableL1.fieldValue("2_810").exact = String(VVV_2_810);
            variableL1.fieldValue("3_810").exact = Money(VVV_3_810) ;
            variableL1.fieldValue("4_810").exact = Money(VVV_4_810) ;
            variableL1.fieldValue("5_810").exact = Money(VVV_5_810) ;
            variableL1.fieldValue("6_810").exact = Money(VVV_6_810) ;
            variableL1.fieldValue("7_810").exact = Money(VVV_7_810) ;

            ДП_13 = ДП_13 + VVV_13;
            КП_14 = КП_14 + VVV_14;
        end;

        ДБП_13 = -min(ДП_13 + КП_14, $0);
        КБП_14 = -max(ДП_13 + КП_14, $0);;

        ДОВП_13 = ДП_13 + ДБП_13;
        КОВП_14 = КП_14 + КБП_14;

        if (Capital != 0)
            СумОВП_15 = ДОВП_13 / Capital * 100;
            БОВП_15 = ternary(ДБП_13 > 0, ДБП_13, -КБП_14) / Capital * 100;
        else
            СумОВП_15 = 0.0;
            БОВП_15 = 0.0;
        end;

        ПрЛОВПБ_17 = max(0.0, БОВП_15 - ЛимБОВП_16);

        ПрЛОВПСум_17 = max(0.0, СумОВП_15 - ЛимСОВП_16);

        totalsAttribute = m_report.attributeValue(TOTALS_DATA);
        totalsValue = totalsAttribute.addValue();

        totalsValue.fieldValue("Отчетная дата").exact = reportDate  ;
        totalsValue.fieldValue("ДП_13").exact         = ДП_13       ;
        totalsValue.fieldValue("КП_14").exact         = КП_14       ;
        totalsValue.fieldValue("ДБП_13").exact        = ДБП_13      ;
        totalsValue.fieldValue("КБП_14").exact        = КБП_14      ;
        totalsValue.fieldValue("БОВП_15").exact       = БОВП_15     ;
        totalsValue.fieldValue("ДОВП_13").exact       = ДОВП_13     ;
        totalsValue.fieldValue("КОВП_14").exact       = КОВП_14     ;
        totalsValue.fieldValue("СумОВП_15").exact     = СумОВП_15   ;
        totalsValue.fieldValue("ПрЛОВПБ_17").exact    = ПрЛОВПБ_17  ;
        totalsValue.fieldValue("ПрЛОВПСум_17").exact  = ПрЛОВПСум_17;
        totalsValue.fieldValue("ЛимБОВП_16").exact    = ЛимБОВП_16  ;
        totalsValue.fieldValue("ЛимСОВП_16").exact    = ЛимСОВП_16  ;
        totalsValue.fieldValue("КОВПБ_18").exact      = КОВПБ_18    ;
        totalsValue.fieldValue("КОВПСум_18").exact    = КОВПСум_18  ;
    end;

    private macro constructorTOcpSaver_XXXX1(report : Object, capitalData : TCapitalData)
        initTVariableSaver(OCP_DATA, report);

        m_dataSource = TSaverDataSource_XXXX1(TParameters(report));
        m_capitalData = capitalData;
    end;

    constructorTOcpSaver_XXXX1(report, capitalData);
end;

private class (TOcpSaver_XXXX1) TOcpSaver_178(report : Object, capitalData : TCapitalData)
    private macro constructorTOcpSaver_178(report : Object, capitalData : TCapitalData)
        initTVariableSaver(OCP_DATA, report);

        m_dataSource = TSaverDataSource_178(TParameters(report));
        m_capitalData = capitalData;
    end;

    constructorTOcpSaver_178(report, capitalData);
end;

private class (TOcpSaver_178) TOcpSaver_I4927(report : Object, capitalData : TCapitalData)
    macro save()
        var variableRoot, variableL1;
        var totalsAttribute, totalsValue;
        var limitsDataSource;
        var i;
        var reportDate;
        var sort;
        var fiCode;
        var scale;
        var currencyOrMetal;
        var ccy;
        var rateSetDate;
        var hasOpenedAccount;
        var ratePrecision;
        var Capital;

        var VVV_1,  VVV_2,  VVV_3,  VVV_4,  VVV_5,  VVV_6,
            VVV_7,  VVV_8,  VVV_9,  VVV_10, VVV_11, VVV_12,
            VVV_13, VVV_14, VVV_15, VVV_16, VVV_17, VVV_18;

        var ДП_13,   КП_14,
            ДБП_13,  КБП_14,
            БОВП_15, КОВПБ_18,
            ДОВП_13, КОВП_14;

        var ЛимБОВП_16, ЛимСОВП_16,
            ПрЛОВПБ_17, ПрЛОВПСум_17,
            КОВПСум_18, СумОВП_15;

        var VVV_рез_бал;
        var VVV_рез_бал_810;

        var VVV_ТрППИвБД, VVV_ТрППИвБД_810;

        var VVV_Гар;

        var VVV_ГарРез;

        var VVV_ГарантииПолуч, VVV_Аккредитив;

        var VVV_Залог;

        var VVV_2_810, VVV_3_810, VVV_4_810, VVV_5_810, VVV_6_810, VVV_7_810;

        var VVV_3_810_eq, VVV_4_810_eq, VVV_5_810_eq;

        var VVV_ГарПолуч_810, VVV_Аккредитив_810, VVV_Гар_810;

        var VVV_СдФИСр, VVV_СдФИСр_810;

        var VVV_4_ПфиБПБа, VVV_4_ПфиБПБа_810;

        var VVV_5_ПфиБПБа, VVV_5_ПфиБПБа_810;

        limitsDataSource = TUserInputDataSource(getParameters());

        reportDate = strSubst(string(getParameters().getEndDate()), " ", "0");

        Capital = m_capitalData.getValue().exact;

        ДП_13      = $0;  КП_14        = $0;
        ДБП_13     = $0;  КБП_14       = $0;
        ДОВП_13    = $0;  КОВП_14      = $0;
        БОВП_15    = 0.0; СумОВП_15    = 0.0;
        ПрЛОВПБ_17 = 0.0; ПрЛОВПСум_17 = 0.0;

        if (limitsDataSource.next())
            ЛимБОВП_16 = limitsDataSource.getValue("ЛимБОВП_16");
            ЛимСОВП_16 = limitsDataSource.getValue("ЛимСОВП_16");

            КОВПБ_18   = limitsDataSource.getValue("КОВПБ_18");
            КОВПСум_18 = limitsDataSource.getValue("КОВПСум_18");
        else
            throw(TUndefinedValueException(USER_INPUT_LIMITS));
        end;

        variableRoot = m_report.attributeValue(getAttributeName());

        while (m_dataSource.next())
            sort = m_dataSource.getValue("sort");

            fiCode = m_dataSource.getValue("code");

            hasOpenedAccount = m_dataSource.getValue("hasOpenedAccount");

            VVV_2 = m_dataSource.getValue("name");

            VVV_6 = Round(m_dataSource.getValue("6"), 1);

            VVV_12 = Round(getRate(fiCode, ratePrecision, scale),4);

            currencyOrMetal = m_dataSource.getValue("kind");

            ccy = m_dataSource.getValue("ccy");

            rateSetDate = getRateSetDate(fiCode);

            VVV_16 = m_dataSource.getValue("16");

            VVV_ТрППИвБД = m_dataSource.getValue("ТрППИвБД");

            VVV_Аккредитив = m_dataSource.getValue("akkreditiv");

            VVV_18 = m_dataSource.getValue("18");

            VVV_2_810 = "В том числе руб./" + VVV_2;

            VVV_3_810_eq = Round(m_dataSource.getValue("3_810_eq"), 1);

            VVV_4_810_eq = Round(m_dataSource.getValue("4_810_eq"), 1);

            VVV_5_810_eq = Round(m_dataSource.getValue("5_810_eq"), 1);

            VVV_6_810 = Round(m_dataSource.getValue("6_810") / VVV_12, 1);

            VVV_ТрППИвБД_810 = Round(m_dataSource.getValue("ТрППИвБД_810") / VVV_12, 1);

            VVV_СдФИСр = m_dataSource.getValue("СдФИСр");

            VVV_4_ПфиБПБа = m_dataSource.getValue("4_ПфиБПБа");

            VVV_5_ПфиБПБа = m_dataSource.getValue("5_ПфиБПБа");

            VVV_4_ПфиБПБа_810 = Round(m_dataSource.getValue("4_ПфиБПБа_810") / VVV_12, 1);

            VVV_5_ПфиБПБа_810 = Round(m_dataSource.getValue("5_ПфиБПБа_810") / VVV_12, 1);

            VVV_ГарантииПолуч = m_dataSource.getValue("garantiipolu4") + m_dataSource.getValue("garantiipolu4_k") + m_dataSource.getValue("garantiipolu4_mbk");

            VVV_ГарПолуч_810 = m_dataSource.getValue("garpolu4_810");

            VVV_СдФИСр_810 = Round(m_dataSource.getValue("СдФИСр_810") / VVV_12, 1);

            VVV_рез_бал_810 = Round(m_dataSource.getValue("rez_bal_gk_810"), 1);

            VVV_рез_бал = Round(m_dataSource.getValue("rez_bal_gk") + m_dataSource.getValue("rez_bal_k") + m_dataSource.getValue("rez_bal_mbk"), 1);

            VVV_3_810 = Round(m_dataSource.getValue("3_810") / VVV_12, 1) + VVV_3_810_eq - VVV_рез_бал_810;

            VVV_4_810 = Round(m_dataSource.getValue("4_810") / VVV_12, 1) + VVV_4_810_eq + VVV_4_ПфиБПБа_810;

            VVV_5_810 = Round(m_dataSource.getValue("5_810") / VVV_12, 1) + VVV_5_810_eq - VVV_ТрППИвБД_810 - VVV_СдФИСр_810 + VVV_5_ПфиБПБа_810;

            VVV_7_810 = VVV_ГарПолуч_810 - m_dataSource.getValue("gar_810") - m_dataSource.getValue("akkreditiv_810") + m_dataSource.getValue("zalog_810");

            VVV_Залог = m_dataSource.getValue("zalog_gk") + m_dataSource.getValue("zalog_k") + m_dataSource.getValue("zalog_mbk");

            VVV_ГарРез = m_dataSource.getValue("garrez_gk") + m_dataSource.getValue("garrez_k");

            VVV_Гар = m_dataSource.getValue("gar_gk") + m_dataSource.getValue("gar_k") - VVV_ГарРез;

            VVV_3 = Round(m_dataSource.getValue("3"), 1) + Round(m_dataSource.getValue("3_810_reval"), 1) + VVV_3_810 - VVV_рез_бал;

            VVV_4 = Round(m_dataSource.getValue("4"), 1) + VVV_4_810 + VVV_4_ПфиБПБа;

            VVV_5 = Round(m_dataSource.getValue("5"), 1) + VVV_5_ПфиБПБа + VVV_5_810 - VVV_ТрППИвБД - VVV_СдФИСр;

            VVV_7 = VVV_ГарантииПолуч - VVV_Гар - VVV_Аккредитив + VVV_Залог + VVV_7_810;

            VVV_8 = VVV_3 + VVV_4;

            VVV_10 = $0;

            VVV_9 = VVV_5 + VVV_6 + VVV_7 + VVV_10;

            VVV_11 = VVV_8 + VVV_9;

            VVV_13 = Round(Money(max(0, VVV_12 * VVV_11)), 1);

            VVV_14 = Round(Money(min(0, VVV_12 * VVV_11)), 1);

            if (Capital != 0)
                VVV_15 = Round(ternary(VVV_13 > 0, VVV_13, -VVV_14) / Capital * 100, 4);
            else
                VVV_15 = 0;
            end;

            VVV_17 = max(0, VVV_15 - VVV_16);

            VVV_12 = execExp("string(VVV_12:0:" + ratePrecision + ")");

            variableL1 = variableRoot.addValue();

            variableL1.fieldValue("Отчетная дата").exact        = reportDate;
            variableL1.fieldValue("Код валюты").exact           = fiCode;
            variableL1.fieldValue("Сортировка").exact           = sort;
            variableL1.fieldValue("Открытые л/с").exact         = hasOpenedAccount;
            variableL1.fieldValue("Валюта/металл").exact        = currencyOrMetal;
            variableL1.fieldValue("Масштаб курса").exact        = String(scale);
            variableL1.fieldValue("Буквенный код").exact        = ccy;
            variableL1.fieldValue("Дата установки курса").exact = String(rateSetDate);
            variableL1.fieldValue("РВП").exact                  = Money(VVV_рез_бал);

            variableL1.fieldValue("2").exact     = String(VVV_2)    ;
            variableL1.fieldValue("3").exact     = Money(VVV_3)     ;
            variableL1.fieldValue("4").exact     = Money(VVV_4)     ;
            variableL1.fieldValue("5").exact     = Money(VVV_5)     ;
            variableL1.fieldValue("6").exact     = Money(VVV_6)     ;
            variableL1.fieldValue("7").exact     = Money(VVV_7)     ;
            variableL1.fieldValue("8").exact     = Money(VVV_8)     ;
            variableL1.fieldValue("9").exact     = Money(VVV_9)     ;
            variableL1.fieldValue("10").exact    = Money(VVV_10)    ;
            variableL1.fieldValue("11").exact    = Money(VVV_11)    ;
            variableL1.fieldValue("12").exact    = Money(VVV_12)    ;
            variableL1.fieldValue("13").exact    = Money(VVV_13)    ;
            variableL1.fieldValue("14").exact    = Money(VVV_14)    ;
            variableL1.fieldValue("15").exact    = Double(VVV_15)   ;
            variableL1.fieldValue("16").exact    = Double(VVV_16)   ;
            variableL1.fieldValue("17").exact    = Double(VVV_17)   ;
            variableL1.fieldValue("18").exact    = Double(VVV_18)   ;
            variableL1.fieldValue("2_810").exact = String(VVV_2_810);
            variableL1.fieldValue("3_810").exact = Money(VVV_3_810) ;
            variableL1.fieldValue("4_810").exact = Money(VVV_4_810) ;
            variableL1.fieldValue("5_810").exact = Money(VVV_5_810) ;
            variableL1.fieldValue("6_810").exact = Money(VVV_6_810) ;
            variableL1.fieldValue("7_810").exact = Money(VVV_7_810) ;

            ДП_13 = ДП_13 + VVV_13;
            КП_14 = КП_14 + VVV_14;
        end;

        ДБП_13 = -min(ДП_13 + КП_14, $0);
        КБП_14 = -max(ДП_13 + КП_14, $0);;

        ДОВП_13 = ДП_13 + ДБП_13;
        КОВП_14 = КП_14 + КБП_14;

        if (Capital != 0)
            СумОВП_15 = ДОВП_13 / Capital * 100;
            БОВП_15 = ternary(ДБП_13 > 0, ДБП_13, -КБП_14) / Capital * 100;
        else
            СумОВП_15 = 0.0;
            БОВП_15 = 0.0;
        end;

        ПрЛОВПБ_17 = max(0.0, БОВП_15 - ЛимБОВП_16);

        ПрЛОВПСум_17 = max(0.0, СумОВП_15 - ЛимСОВП_16);

        totalsAttribute = m_report.attributeValue(TOTALS_DATA);
        totalsValue = totalsAttribute.addValue();

        totalsValue.fieldValue("Отчетная дата").exact = reportDate  ;
        totalsValue.fieldValue("ДП_13").exact         = ДП_13       ;
        totalsValue.fieldValue("КП_14").exact         = КП_14       ;
        totalsValue.fieldValue("ДБП_13").exact        = ДБП_13      ;
        totalsValue.fieldValue("КБП_14").exact        = КБП_14      ;
        totalsValue.fieldValue("БОВП_15").exact       = БОВП_15     ;
        totalsValue.fieldValue("ДОВП_13").exact       = ДОВП_13     ;
        totalsValue.fieldValue("КОВП_14").exact       = КОВП_14     ;
        totalsValue.fieldValue("СумОВП_15").exact     = СумОВП_15   ;
        totalsValue.fieldValue("ПрЛОВПБ_17").exact    = ПрЛОВПБ_17  ;
        totalsValue.fieldValue("ПрЛОВПСум_17").exact  = ПрЛОВПСум_17;
        totalsValue.fieldValue("ЛимБОВП_16").exact    = ЛимБОВП_16  ;
        totalsValue.fieldValue("ЛимСОВП_16").exact    = ЛимСОВП_16  ;
        totalsValue.fieldValue("КОВПБ_18").exact      = КОВПБ_18    ;
        totalsValue.fieldValue("КОВПСум_18").exact    = КОВПСум_18  ;
    end;

    private macro constructorTOcpSaver_I4927(report : Object, capitalData : TCapitalData)
        initTVariableSaver(OCP_DATA, report);

        m_dataSource  = TSaverDataSource_4927(TParameters(report));
        m_capitalData = capitalData;
    end;

    constructorTOcpSaver_I4927(report, capitalData);
end;

/**
 *  Контроллер сохранения значений переменных
 */
private class TVariablesSaverController(report : Object)
    var m_report : Object;

    macro save()
        var capitalData = TCapitalData(m_report);
        var ocp = TOcpSaver(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;

    private macro constructor(report : Object)
        m_report = report;
    end;

    constructor(report);
end;

private class (TVariablesSaverController) TVariablesSaverController_2811(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData(m_report);
        var ocp = TOcpSaver_2811(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

private class (TVariablesSaverController) TVariablesSaverController_3107(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData(m_report);
        var ocp = TOcpSaver_3107(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

private class (TVariablesSaverController) TVariablesSaverController_3468(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData_3468(m_report);
        var ocp = TOcpSaver_3107(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

private class (TVariablesSaverController) TVariablesSaverController_XXXX1(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData_3468(m_report);
        var ocp = TOcpSaver_XXXX1(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

private class (TVariablesSaverController) TVariablesSaverController_178(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData_3468(m_report);
        var ocp = TOcpSaver_178(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

private class (TVariablesSaverController) TVariablesSaverController_I4927(report : Object)
    InitTVariablesSaverController(report);

    macro save()
        var capitalData = TCapitalData_3468(m_report);
        var ocp         = TOcpSaver_I4927(m_report, capitalData);

        BegAction(2000, "Расчет и сохранение значений переменных");

        ocp.save();

        RcbApplication().transactionManager.commit();

        EndAction(1);
    end;
end;

/**
 *  Основная функция
 */
macro main(report : Object)

    var profiler = TSQLProfiler(getTxtFileName("!calc_f634post_profile"));
    profiler.clear();
    profiler.on();

    if   (rcbApplication().currentReport().context.period.EndDate >= RCB_I4927_DATE)
        TVariablesSaverController_I4927(report).save();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I178_DATE)
        TVariablesSaverController_178(report).save();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_016_41_4_4786_DATE)
        TVariablesSaverController_XXXX1(report).save();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3468_DATE)
        TVariablesSaverController_3468(report).save();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3107_DATE)
        TVariablesSaverController_3107(report).save();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I2811_DATE)
        TVariablesSaverController_2811(report).save();
    else
        TVariablesSaverController(report).save();
    end;

    onError(error)
        exceptionMessage(error);
        exit(1);
end;
