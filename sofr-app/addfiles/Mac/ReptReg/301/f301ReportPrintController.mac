/*
$Name:          f301ReportPrintController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 301. Контроллер печати
*/

class TReportPrintController()

    private var m_report      : TReport       = null;
    private var m_reportView  : RcbReportView = null;
    private var m_reportWidth : Integer       = 214;

    macro getReport()
        if (m_report == null)
            m_report = objectFactoryInstance.createReport();
        end;

        return m_report;
    end;

    macro getReportView()
        if (m_reportView == null)
            m_reportView = objectFactoryInstance.createReportView();
        end;

        return m_reportView;
    end;

    private macro initializeValuePool(valuePool : RcbArray, part : TPart, rowNumber : Integer)
        var i = 4;
        var v = null;
        while (getParm(i, v))
            valuePool.push_back(ternary(valType(v) == V_STRING, v, part.getAttribute(v).getValueAsString(rowNumber)));
            i = i + 1;
        end;
    end;

    private macro printPart1(partView : RcbPartView, part : TPart)
        var valuePool = RcbArray();

        partView.printHead();

        initializeValuePool(valuePool, part, 1, "1", "До востребования:", 3,4,5,6,7,8,9,10,11,12,"X");
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 2, "2", "Срочные:", 3,4,5,6,7,8,9,10,11,12,"X");
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 3, "3", "ИТОГО", 3,4,5,6,7,8,9,10,11,12,13);
        partView.printString(valuePool);

        partView.printBottom();
    end;

    private macro printPart2(partView : RcbPartView, part : TPart)
        var valuePool = RcbArray();

        partView.printHead();

        initializeValuePool(valuePool, part, 1, "1", "До 1 года:", 16,17,18,19,20,21,22,23,24,25,"X");
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 2, "2", "Свыше 1 года:", 16,17,18,19,20,21,22,23,24,25,"X");
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 3, "3", "ИТОГО", 16,17,18,19,20,21,22,23,24,25,26);
        partView.printString(valuePool);

        partView.printBottom();
    end;

    private macro printPart3(partView : RcbPartView, part : TPart)
        var valuePool = RcbArray();

        partView.printHead();

        initializeValuePool(valuePool, part, 1, "1", "До 1 года:", 29,30,31,32,33,34);
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 2, "2", "Свыше 1 года:", 29,30,31,32,33,34);
        partView.printString(valuePool);
        valuePool.clear();

        initializeValuePool(valuePool, part, 3, "3", "ИТОГО", 29,30,31,32,33,34);
        partView.printString(valuePool);

        partView.printBottom();
    end;

    macro print()
        if (not global.getRcbReport().isCalculated())
            msgBox("Печать может быть выполнена только после выполнения операции \"Расчет\"");
            RepErrorsQueue().add(0, "Печать может быть выполнена только после выполнения операции \"Расчет\"");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        getReportView().setOutputFile();

        getReportView.setReportWidth(m_reportWidth);
        getReportView.printLendingAgencyCodeZone();
        getReportView.printNamesZone();

        if (getReport().isEmpty())
            getReportView.printNullDataZone();
        else
            printPart1(getReportView.getPart1ReportView(), getReport().getPart(1));
            printPart2(getReportView.getPart2ReportView(), getReport().getPart(2));
            printPart3(getReportView.getPart3ReportView(), getReport().getPart(3));
        end;

        getReportView.printSignatureZone();
        getReportView.show();

        getReportView().resetOutputFile();
    end;
end;

class TAdditionalReportPrintController()
    private var m_attributeDescriptionPool : RcbArray = RcbArray();
    private var m_isEmpty        : Bool    = true;
    private var m_currentReport  : TReport = null;
    private var m_previousReport : TReport = null;
    private var m_view           : TAdditionalReportView = null;
    private var differenceValue  : Money = null;

    if   (global.getRcbReport().context.period.endDate >= RCB_I4637_DATE)
        differenceValue = $10000.00;
    elif (global.getRcbReport().context.period.endDate >= RCB_I3269_DATE)
        differenceValue = $5000.00;
    else
        differenceValue = $2000.00;
    end;

    macro isEmpty()
        return m_isEmpty;
    end;

    private macro initialize()
        if (not global.getRcbReport().isCalculated())
            msgBox("Для выпуска \"Дополнительного отчета\", необходимо произвести расчет текущего отчета");
            RepErrorsQueue().add(0, "Для выпуска \"Дополнительного отчета\", необходимо произвести расчет текущего отчета");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        var previousRcbReport = global.getRcbReport().createPreviousReport();

        if (not previousRcbReport.isCalculated())
            var protocolView2 = TProtocolView("301additionalReport");
            protocolView2.setProtocolOutput();
            protocolView2.printHead();

            protocolView2.printLine("Для выпуска \"Дополнительного отчета\", необходимо расчитать форму за предыдущий период");
            protocolView2.resetProtocolOutput();
            protocolView2.show();
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        m_view           = objectFactoryInstance.createAdditionalReportView();
        m_currentReport  = objectFactoryInstance.createReport();
        m_previousReport = objectFactoryInstance.createReport(previousRcbReport);

        m_attributeDescriptionPool.push_back(TRcbPair(3,  "В рублях, перед нефинансовыми организациями"));
        m_attributeDescriptionPool.push_back(TRcbPair(4,  "В рублях, перед физическими лицами"));
        m_attributeDescriptionPool.push_back(TRcbPair(5,  "В рублях, перед органами государственного управления и внебюджетными фондами, всего"));
        m_attributeDescriptionPool.push_back(TRcbPair(6,  "В рублях, перед органами государственного управления и внебюджетными фондами, из них перед федеральными органами государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(7,  "В рублях, перед органами государственного управления и внебюджетными фондами, из них перед органами власти субъектов Российской Федерации и органами местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(8,  "В ин. Валюте, перед нефинансовыми организациями"));
        m_attributeDescriptionPool.push_back(TRcbPair(9,  "В ин. валюте, перед физическими лицами"));
        m_attributeDescriptionPool.push_back(TRcbPair(10, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, всего"));
        m_attributeDescriptionPool.push_back(TRcbPair(11, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, из них перед федеральными органами государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(12, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, из них перед органами власти субъектов Российской Федерации и органами местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(16, "В рублях, к органам гос. Управления и внебюджетным фондам,  федеральным органам государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(17, "В рублях, к органам гос. Управления и внебюджетным фондам,  органам власти субъектов Российской Федерации и органам местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(18, "В рублях, к органам гос. Управления и  внебюджетным фондам, внебюджетным фондам"));
        m_attributeDescriptionPool.push_back(TRcbPair(19, "В рублях, нефинансовым организациям и  физ. лицам"));
        m_attributeDescriptionPool.push_back(TRcbPair(20, "В ин. валюте, к органам гос. Управления и внебюджетным фондам,  федеральным органам государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(21, "В ин. валюте, к органам гос. управления и внебюджетным фондам, органам власти субъектов Российской Федерации и органам местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(22, "В ин. валюте, к органам гос. управления и внебюджетным фондам, внебюджетным фондам"));
        m_attributeDescriptionPool.push_back(TRcbPair(23, "В рублях, нефинансовым организациям и физ. лицам"));
        m_attributeDescriptionPool.push_back(TRcbPair(24, "Иностранные активы"));
        m_attributeDescriptionPool.push_back(TRcbPair(25, "Иностранные пассивы"));
        m_attributeDescriptionPool.push_back(TRcbPair(26, "Собственные средства кредитной организации за вычетом вложений в акции других кредитных организаций"));
        m_attributeDescriptionPool.push_back(TRcbPair(29, "В рублях, обязательства перед кредитными организациями - резидентами"));
        m_attributeDescriptionPool.push_back(TRcbPair(30, "В рублях, обязательства перед Банком России"));
        m_attributeDescriptionPool.push_back(TRcbPair(31, "В рублях, требования к кредитным организациям - резидентам"));
        m_attributeDescriptionPool.push_back(TRcbPair(32, "В рублях, требования к Банку России"));
        m_attributeDescriptionPool.push_back(TRcbPair(33, "В ин. валюте, обязательства перед кредитными организациями - резидентами"));
        m_attributeDescriptionPool.push_back(TRcbPair(34, "В ин. валюте, требования к кредитным организациям - резидентам"));
    end;

    private macro getDescription(attributeId : Integer) : String
        var i = 0;

        while (i < m_attributeDescriptionPool.size)
            if (m_attributeDescriptionPool[i].first == attributeId)
                return m_attributeDescriptionPool[i].second;
            end;
            i = i + 1;
        end;

        return "";
    end;

    private macro getExtensionSet(partId : Integer, attributeId : Integer, rowNumber : Integer) : TRcbSet
        var extensionSet = TRcbSet();
        var extensionPool = m_currentReport.getPart(partId).getAttribute(attributeId).getExtensionPool(rowNumber);

        while (not extensionPool.isEmpty())
            extensionSet.insert(extensionPool.pop_back());
        end;

        extensionPool = m_previousReport.getPart(partId).getAttribute(attributeId).getExtensionPool(rowNumber);

        while (not extensionPool.isEmpty())
            extensionSet.insert(extensionPool.pop_back());
        end;

        return extensionSet;
    end;

    private macro processSection(partId : Integer, rowNumber : Integer, attributeId : Integer, rowTitle : String)
        var currentAttribute  = m_currentReport.getPart(partId).getAttribute(attributeId);
        var previousAttribute = m_previousReport.getPart(partId).getAttribute(attributeId);

        var currentValue  : Money = nvl(currentAttribute.getScaledValue(rowNumber), $0.0);
        var previousValue : Money = nvl(previousAttribute.getScaledValue(rowNumber), $0.0);

        var resultValue   = abs(currentValue - previousValue);

        if (resultValue < differenceValue)
            return;
        end;

        m_view.getTableView().printRow(rowTitle,//rowNumber,
                                       attributeId,
                                       getDescription(attributeId),
                                       currentAttribute.getValueAsString(rowNumber),
                                       previousAttribute.getValueAsString(rowNumber),
                                       String(resultValue:0:0));

        var i         = 0;
        var iterator  = getExtensionSet(partId, attributeId, rowNumber).createIterator();
        var extension = "";

        m_isEmpty = false;

        iterator.moveFirst();
        if (iterator.isDone())
            return;
        end;

        m_view.getTableView().printExtensionHead();

        while (not iterator.isDone())
            extension = iterator.getCurrentItem();

            currentValue  = nvl(currentAttribute.getValue(rowNumber, extension), $0.0);
            previousValue = nvl(previousAttribute.getValue(rowNumber, extension), $0.0);

            m_view.getTableView().printExtensionRow(extension,
                                                    currentValue,
                                                    previousValue,
                                                    abs(previousValue - currentValue));

            iterator.moveNext();
        end;
    end;

    private macro processBlock(partId : Integer, rowNumber : Integer, attributeIdPool : RcbArray, rowTitle : String)
        var i = 0;
        while (i < attributeIdPool.size)
            processSection(partId, rowNumber, attributeIdPool[i], rowTitle);

            i = i + 1;
        end;
    end;

    macro print()
        m_view.setProtocolOutput();

        m_view.printHead(m_currentReport, m_previousReport);
        m_view.getTableView().printHead();
        m_view.getTableView().printLine("ОБЯЗАТЕЛЬСТВА КРЕДИТНЫХ ОРГАНИЗАЦИЙ");

        var partId    = 1;
        var rowNumber = 1;
        processBlock(partId, rowNumber, RcbArray().initialize(3,4,5,6,7,8,9,10,11,12));

        rowNumber = 2;
        processBlock(partId, rowNumber, RcbArray().initialize(3,4,5,6,7,8,9,10,11,12));

        m_view.getTableView().printLine("ТРЕБОВАНИЯ КРЕДИТНЫХ ОРГАНИЗАЦИЙ");

        partId    = 2;
        rowNumber = 1;
        processBlock(partId, rowNumber, RcbArray().initialize(16,17,18,19,20,21,22,23));

        rowNumber = 2;
        processBlock(partId, rowNumber, RcbArray().initialize(16,17,18,19,20,21,22,23));

        m_view.getTableView().printLine("ИНОСТРАННЫЕ АКТИВЫ");
        partId    = 2;
        rowNumber = 1;
        processBlock(partId, rowNumber, RcbArray().initialize(24));

        rowNumber = 2;
        processBlock(partId, rowNumber, RcbArray().initialize(24));

        m_view.getTableView().printLine("ИНОСТРАННЫЕ АКТИВЫ");
        partId    = 2;
        rowNumber = 1;
        processBlock(partId, rowNumber, RcbArray().initialize(25));

        rowNumber = 2;
        processBlock(partId, rowNumber, RcbArray().initialize(25));

        m_view.getTableView().printLine("СОБСТВЕННЫЕ СРЕДСТВА");
        partId    = 2;
        rowNumber = 3;
        processBlock(partId, rowNumber, RcbArray().initialize(26));

        m_view.getTableView().printLine("МЕЖБАНКОВСКИЕ ОПЕРАЦИИ КРЕДИТНЫХ ОРГАНИЗАЦИЙ");

        partId    = 3;
        rowNumber = 1;
        processBlock(partId, rowNumber, RcbArray().initialize(30,31,32,33,34));

        rowNumber = 2;
        processBlock(partId, rowNumber, RcbArray().initialize(30,31,32,33,34));

        if (isEmpty())
            m_view.printNoData(differenceValue / 1000);
        else
            m_view.getTableView().printBottom("МЕЖБАНКОВСКИЕ ОПЕРАЦИИ КРЕДИТНЫХ ОРГАНИЗАЦИЙ");
        end;

        m_view.resetProtocolOutput();

        m_view.show();
    end;

    initialize();
end;

class (TAdditionalReportPrintController) TAdditionalReportPrintController_2332()
    initTAdditionalReportPrintController();

    private macro initialize()
        if (not global.getRcbReport().isCalculated())
            msgBox("Для выпуска \"Дополнительного отчета\", необходимо произвести расчет текущего отчета");
            RepErrorsQueue().add(0, "Для выпуска \"Дополнительного отчета\", необходимо произвести расчет текущего отчета");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        var previousRcbReport = global.getRcbReport().createPreviousReport();

        if (not previousRcbReport.isCalculated())
            var protocolView2  = TProtocolView("301additionalReport");
            protocolView2.setProtocolOutput();
            protocolView2.printHead();

            protocolView2.printLine("Для выпуска \"Дополнительного отчета\", необходимо расчитать форму за предыдущий период");
            protocolView2.resetProtocolOutput();
            protocolView2.show();
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        m_view = objectFactoryInstance.createAdditionalReportView();

        m_currentReport = objectFactoryInstance.createReport();

        m_previousReport = objectFactoryInstance.createReport(previousRcbReport);

        m_attributeDescriptionPool.push_back(TRcbPair(3,  "В рублях, перед нефинансовыми и финансовыми (кроме кредитных) организациями"));
        m_attributeDescriptionPool.push_back(TRcbPair(4,  "В рублях, перед физическими лицами"));
        m_attributeDescriptionPool.push_back(TRcbPair(5,  "В рублях, перед органами государственного управления и внебюджетными фондами, всего"));
        m_attributeDescriptionPool.push_back(TRcbPair(6,  "В рублях, перед органами государственного управления и внебюджетными фондами, из них перед федеральными органами государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(7,  "В рублях, перед органами государственного управления и внебюджетными фондами, из них перед органами власти субъектов Российской Федерации и органами местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(8,  "В ин. Валюте, перед нефинансовыми и финансовыми (кроме кредитных) организациями"));
        m_attributeDescriptionPool.push_back(TRcbPair(9,  "В ин. валюте, перед физическими лицами"));
        m_attributeDescriptionPool.push_back(TRcbPair(10, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, всего"));
        m_attributeDescriptionPool.push_back(TRcbPair(11, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, из них перед федеральными органами государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(12, "В ин. валюте, перед органами государственного управления и внебюджетными фондами, из них перед органами власти субъектов Российской Федерации и органами местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(16, "В рублях, к органам гос. Управления и внебюджетным фондам,  федеральным органам государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(17, "В рублях, к органам гос. Управления и внебюджетным фондам,  органам власти субъектов Российской Федерации и органам местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(18, "В рублях, к органам гос. Управления и  внебюджетным фондам, внебюджетным фондам"));
        m_attributeDescriptionPool.push_back(TRcbPair(19, "В рублях, нефинансовым организациям и  физ. лицам"));
        m_attributeDescriptionPool.push_back(TRcbPair(20, "В ин. валюте, к органам гос. Управления и внебюджетным фондам,  федеральным органам государственной власти"));
        m_attributeDescriptionPool.push_back(TRcbPair(21, "В ин. валюте, к органам гос. управления и внебюджетным фондам, органам власти субъектов Российской Федерации и органам местного самоуправления"));
        m_attributeDescriptionPool.push_back(TRcbPair(22, "В ин. валюте, к органам гос. управления и внебюджетным фондам, внебюджетным фондам"));
        m_attributeDescriptionPool.push_back(TRcbPair(23, "В рублях, нефинансовым организациям и физ. лицам"));
        m_attributeDescriptionPool.push_back(TRcbPair(24, "Иностранные активы"));
        m_attributeDescriptionPool.push_back(TRcbPair(25, "Иностранные пассивы"));
        m_attributeDescriptionPool.push_back(TRcbPair(26, "Собственные средства кредитной организации за вычетом вложений в акции других кредитных организаций"));
        m_attributeDescriptionPool.push_back(TRcbPair(29, "В рублях, обязательства перед кредитными организациями - резидентами"));
        m_attributeDescriptionPool.push_back(TRcbPair(30, "В рублях, обязательства перед Банком России"));
        m_attributeDescriptionPool.push_back(TRcbPair(31, "В рублях, требования к кредитным организациям - резидентам"));
        m_attributeDescriptionPool.push_back(TRcbPair(32, "В рублях, требования к Банку России"));
        m_attributeDescriptionPool.push_back(TRcbPair(33, "В ин. валюте, обязательства перед кредитными организациями - резидентами"));
        m_attributeDescriptionPool.push_back(TRcbPair(34, "В ин. валюте, требования к кредитным организациям - резидентам"));
    end;
end;