/*
$Name:          f301PartCalculateController.mac
$Module:        ê•£´†¨•≠‚®‡„•¨†Ô Æ‚Á•‚≠Æ·‚Ï
$Description:   îÆ‡¨† 301. äÆ≠‚‡Æ´´•‡ ‡†·Á•‚† ‡†ß§•´†
*/

CONST MINUS = true;
CONST PLUS  = false;

class TPartCalculateController(reportCalculateController : Object /*TReportCalculateController*/, partId : Integer)
    private var m_reportCalculateController : Object             = reportCalculateController;
    private var m_partId                    : Integer            = partId;
    private var m_reoprt                    : TReport            = m_reportCalculateController.getReport();
    private var m_part                      : TPart              = m_reportCalculateController.getReport().getPart(m_partId);
    private var m_dataSources               : TDataSources       = m_reportCalculateController.getDataSources();
    private var m_dataSouceFilters          : TDataSourceFilters = m_dataSources.getDataSourceFilters();
    private var m_tuneTable                 : TTuneTable_2055U   = TTuneTable_2055U();

    macro getPartId()
        return m_partId;
    end;

    macro execute()
    end;
end;

class (TPartCalculateController) TPartCalculateController_2055U(reportCalculateController : Object, partId : Integer)
    initTPartCalculateController(reportCalculateController, partId);

    private macro setValue(attribute : TAttribute, rowNumber : Integer, data : TData, isRecalculateScaled : Bool, isMinus : Bool)
        var i = 0;
        var dataPool = data.getCompositeDataPool();

        while (i < dataPool.size)
            if (isMinus)
                attribute.minus(ternary(isRecalculateScaled, dataPool[i].getValue().exact, dataPool[i].getValue()),
                                rowNumber,
                                dataPool[i].getBalance());
            else
                attribute.plus(ternary(isRecalculateScaled, dataPool[i].getValue().exact, dataPool[i].getValue()),
                               rowNumber,
                               dataPool[i].getBalance());
            end;
            i = i + 1;
        end;
    end;

    macro calculateForBalance(attributeId : Integer, rowNumber : Integer, typeBalance : String, columnNumber : String, isMinus : Bool)
        var attribute  = m_part.getAttribute(attributeId);
        var dataSource = m_dataSources.getBalanceDataSource();
        var filter     = m_dataSouceFilters.getBalanceFilter();

        m_reportCalculateController.getProtocolView().printLine(ternary(isMinus, "\nÇÎÁ®‚†Ó‚·Ô §†≠≠Î•:", "\nÑÆ°†¢´ÔÓ‚·Ô §†≠≠Î•:"));
        setValue(attribute,
                 rowNumber,
                 dataSource.getData(attribute,
                                    m_tuneTable.setKey(nvl(columnNumber, attributeId), rowNumber).getMasks(),
                                    typeBalance),
                 true,
                 isMinus);

        m_reportCalculateController.getProtocolView().printLine("É‡†‰†" + attributeId + "_ë‚‡Æ™†" + rowNumber + " = " + attribute.getValue(rowNumber));
    end;

	private macro isMbkAttribute(row, column)
		return(
			((row == 2) AND (column == 33)) OR
			((row == 2) AND (column == 34)) OR
			((row == 2) AND (column == 35)) OR
			((row == 2) AND (column == 36)) OR
			((row == 2) AND (column == 37)) OR
			((row == 2) AND (column == 38))
		);
	end;
	
    macro calculateForAccount(attributeId : Integer, rowNumber : Integer, filter : TDataSourceFilter, isMinus : Bool)
        var attribute  = m_part.getAttribute(attributeId);
        var dataSource = m_dataSources.getAccountDataSource();
		var withMbk    = (global().isCalculatedMbk() AND isMbkAttribute(rowNumber, attributeId));

        m_reportCalculateController.getProtocolView().printLine(ternary(isMinus, "\nÇÎÁ®‚†Ó‚·Ô §†≠≠Î•:", "\nÑÆ°†¢´ÔÓ‚·Ô §†≠≠Î•:"));

        setValue(attribute,
                 rowNumber,
                 dataSource.getData(attribute, filter, withMbk),
                 true,
                 isMinus);

        m_reportCalculateController.getProtocolView().printLine("É‡†‰†" + attributeId + "_ë‚‡Æ™†" + rowNumber + " = " + attribute.getValue(rowNumber));
    end;

    macro printAttributeHead(attributeId : Integer, rowNumber : Integer)
        m_reportCalculateController.getProtocolView().printLine("\nÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ");
        m_reportCalculateController.getProtocolView().printLine("ê†·Á•‚ £‡†‰Î " + attributeId + ", ·‚‡Æ™® " + rowNumber);
        m_reportCalculateController.getProtocolView().printLine("ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ");
    end;

    macro printProtocolLine(text : String)
        m_reportCalculateController.getProtocolView().printLine(text);
    end;

    macro summarize(attributeId : Integer, row1Number : Integer, row2Number : Integer, itogRowNumber : Integer)

        macro getAtributeCode(attributeId : Integer, rowNumber : Integer) : String
            return "É‡†‰†" + attributeId + "_ë‚‡Æ™†" + rowNumber;
        end;

        var attribute  = m_part.getAttribute(attributeId);
        var value1     = attribute.getValue(row1Number);
        var value2     = attribute.getValue(row2Number);
        var itogValue  = value1 + value2;

        printProtocolLine(" ");
        printProtocolLine(getAtributeCode(attributeId, itogRowNumber) + " = " + getAtributeCode(attributeId, row1Number) + " + " + getAtributeCode(attributeId, row2Number));
        printProtocolLine(" ");
        printProtocolLine(getAtributeCode(attributeId, itogRowNumber) + " = " + value1 + " + " + value2 + " = " + itogValue);

        attribute.setValue(TValue(itogValue, attribute.getScaledValue(row1Number) + attribute.getScaledValue(row2Number)), itogRowNumber);
    end;

    private macro standartCalculateAttributeData(calculationDataPool : RcbArray, attributeId : Integer, rowNumber : Integer, typeData : String, isPrintHead : Bool)
        if (isPrintHead)
            calculationDataPool.push_back(TCalculationData(r2m(this, "printAttributeHead"),
                                                           RcbArray.initialize(attributeId, rowNumber)));
        end;

        calculationDataPool.push_back(TCalculationData(r2m(this, "calculateForBalance"),
                                                       RcbArray.initialize(attributeId, rowNumber, typeData)));
    end;

    private macro standartSummarizeAttributeData(calculationDataPool : RcbArray, attributeId : Integer, isPrintHead : Bool)
        if (isPrintHead)
            calculationDataPool.push_back(TCalculationData(r2m(this, "printAttributeHead"),
                                                           RcbArray.initialize(attributeId, 3)));
        end;

        calculationDataPool.push_back(TCalculationData(r2m(this, "summarize"),
                                                       RcbArray.initialize(attributeId, 1, 2, 3)));
    end;
end;
