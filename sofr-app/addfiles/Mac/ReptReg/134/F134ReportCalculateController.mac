/* ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   RS-Bank V6                                                 R-Style Softlab
   ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨à®¢ ­­ ï ®âç¥â­®áâì"

   ”®à¬  134. Š®­âà®««¥à à áç¥â  ®âç¥â .

   CREATED : 17.07.12 Ser.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ */
class (RcbReportCalculateController) F134ReportCalculateController()
    initRcbReportCalculateController();
    m_protocolView = objectFactoryInstance.createCalculateProtocolView("Ž’ŽŠŽ‹ …„‚€ˆ’…‹œŽƒŽ €‘—…’€");
    private macro clearValues()
        global.getRcbReport().attributeValue("„ ­­ë¥Žâç¥â ").removeAllValues();

        getDataSources().clear();

        RcbApplication.TransactionManager.commit();
    end;

    private var m_isReplacedDependencies = true;

    macro setReplacedDependencies(data)
          m_isReplacedDependencies = data;
    end;

    private macro pushControllers()
        m_partCalculateControllers.push_back(F134Part1CalculateController(this));
    end;

    macro initialize() : Bool
        global.initializeRepDataPackage(global.getRcbReport());

        clearValues();

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;

    private macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        if (m_isReplacedDependencies)
            return;
        end;

        var dependentAttributePool = calculationAttributeData.getDependencesData().getDependentAttributePool();

        dependentAttributePool.moveFirst();
        while (dependentAttributePool.moveNext())
            calculateAttribute(getCalculationAttributeData(dependentAttributePool.getCurrentItem()));
            if(m_isReplacedDependencies)
                return;
            end;
        end;

        var calculationDataPool = calculationAttributeData.getCalculationDataPool();

        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationDataPool.getCurrentItem().calculate();
        end;

        calculationAttributeData.setCalculated();
    end;

    macro calculate() : Bool
        initialize();

        m_protocolView.setProtocolOutput(m_isUseAvailableReport);

        if (not m_isUseAvailableReport)
            m_protocolView.printHead();
        end;

        m_protocolView.printLine(getProtocolText());


        initProgress(m_partCalculateControllers.getCount(), "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ", "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå", "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        while(m_isReplacedDependencies)

            m_isReplacedDependencies = false;

            initProgress(m_calculationDataPool.getCount(), "‚ë¯®«­¥­¨¥ à áç¥â ", "‚ë¯®«­¥­¨¥ à áç¥â ");
            m_calculationDataPool.moveFirst();

            while (m_calculationDataPool.moveNext())
                calculateAttribute(m_calculationDataPool.getCurrentItem());
                if(m_isReplacedDependencies)
                    break;
                end;

                useProgress(m_calculationDataPool.getCurrentIndex());
            end;
            remProgress();
        end;

        if (not m_isUseAvailableReport)
            m_protocolView.resetProtocolOutput();
        end;

        initProgress(-1, "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå", "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå");
        RcbApplication.TransactionManager.commit();
        remProgress();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;


end;

class (F134ReportCalculateController) F134ReportCalculateControllerF134_14_Pak()
    initF134ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(F134Part1CalculateControllerF134_14_Pak(this));
    end;
end;

class (RcbReportCalculateController) F134ReportFinalCalculateController()
    initRcbReportCalculateController();
    m_protocolView = objectFactoryInstance.createCalculateProtocolView("Ž’ŽŠŽ‹ ŽŠŽ—€’…‹œŽƒŽ €‘—…’€");

    private macro pushControllers()
        m_partCalculateControllers.push_back(F134Part1FinalCalculateController(this, F134Part1CalculateController(this)));
    end;

    macro initialize() : Bool
        global.initializeRepDataPackage(global.getRcbReport());

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;
end;

class (F134ReportFinalCalculateController) F134ReportFinalCalculateControllerF134_14_Pak()
    initF134ReportFinalCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(F134Part1FinalCalculateControllerF134_14_Pak(this, F134Part1CalculateControllerF134_14_Pak(this)));
    end;
end;
