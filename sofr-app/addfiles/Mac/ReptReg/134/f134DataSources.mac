/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 134. Источник данных.

   CREATED : 17.07.12 Ser.
└────────────────────────────────────────────────────────────────────────── */
class (RcbDataSource) F134CbDocumentDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("CbDocument", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money

        var query = "WITH paymenttable AS"
            +"\n"+  "    (SELECT /* +INLINE*/"
            +"\n"+  "            --" + attribute.getId()
            +"\n"+  "            rep_note.readpaymentcapitalchangedate(t_paymentid," + getSqlDate(global.getRcbReport().context.period.endDate) + ") t_paymentnote,"
            +"\n"+  "            t_incoversum As t_sum,"
            +"\n"+  "            d.*"
            +"\n"+  "       FROM drepdocument_vw d"
            +"\n"+  "      WHERE t_incoversum <> 0)"
            +"\n"+  "SELECT SUM(document.t_sum) AS t_sum, document.t_chapter, document.t_debetAccount, document.t_creditAccount, document.t_date, document.t_number, GROUPING(document.t_id) AS t_isItog"
            +"\n"+  "  FROM paymenttable document"
            +"\n"+  " WHERE t_chapter = 1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "GROUP BY ROLLUP ((t_chapter, t_debetAccount, t_creditAccount, t_id, document.t_date, document.t_number))"
            +"\n"+  "ORDER BY GROUPING(t_id) ASC";

        var dataSet = TRsbDataSet(query);
        dataSet.setFieldType("t_date", V_DATE);
        var sum = $0.0;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.isItog)
                m_protocolView.printItog(dataSet);
                sum = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;
        m_protocolView.printBottom();
        return sum;
    end;
end;

class (RcbDataSource) F134AccountDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("CbAccount", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String, restDate : Date, noteId : Integer) : Money

        var query = "SELECT  --" + attribute.getId()
            +"\n"+  "        t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,"
            + ternary(noteId,
                 "\n"+  "         CASE"
                +"\n"+  "             WHEN account.t_note is not null"
                +"\n"+  "                 THEN 'В расчет включено значение примечания на л/счете '|| account.t_noteName"
                +"\n"+  "             ELSE account.t_noteName || ' на счете равно нулю, в расчет включен остаток счета'"
                +"\n"+  "         END            AS t_comment,"
            ,
                 "\n"+  "        ' ' t_comment,")
            +"\n"+  "       SUM(t_rest) AS t_rest, GROUPING (t_account) t_isItog"
            +"\n"+  "  FROM (SELECT acc.*,"
            +"\n"+  "               rep_note.getMoneyAccountNote(acc.t_objectId," + NVL(noteId,0) + "," + getSqlDate(nvl(restDate, global.getRcbReport().context.period.endDate)) + ") as t_note,"
            +"\n"+  "               (SELECT kind.t_name"
            +"\n"+  "                   FROM dnotekind_dbt kind--,"
            +"\n"+  "                        --dnotetext_dbt text"
            +"\n"+  "                 WHERE kind.t_objectType = rep_const.get().cb.objectTypes.account"
            +"\n"+  "                   AND kind.t_noteKind = " + NVL(noteId,0)
            +"\n"+  "               )                                   as t_noteName,"
            +"\n"+  "      DECODE (acc.t_kind, 'А', -1, 1)"
            +"\n"+  "                * NVL ("
            +"\n"+  "                     (SELECT restDate.t_rest"
            +"\n"+  "                        FROM dRestDate_dbt restDate"
            +"\n"+  "                       WHERE restDate.t_accountId = acc.t_accountId"
            +"\n"+  "                             AND restDate.t_restCurrency = 0"
            +"\n"+  "                             AND restDate.t_restDate ="
            +"\n"+  "                                    (SELECT MAX (maxDate.t_restDate) t_maxDate"
            +"\n"+  "                                       FROM dRestDate_dbt maxDate"
            +"\n"+  "                                      WHERE maxDate.t_restDate <="  + getSqlDate(nvl(restDate, global.getRcbReport().context.period.endDate))
            +"\n"+  "                                            AND maxDate.t_restCurrency = 0"
            +"\n"+  "                                            AND maxDate.t_accountId = acc.t_accountId)), 0) AS t_rest"
            +"\n"+  "          FROM drepaccount_vw acc) account"
            +"\n"+  " WHERE account.t_chapter = 1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "GROUP BY ROLLUP ((t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,t_note,account.t_noteName))"
            +"\n"+  "ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query);

        var rest = $0.0;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.isItog)
                m_protocolView.printItog(dataSet);
                rest = dataSet.rest;
            else
                m_protocolView.printString(dataSet);
            end;
        end;
        
        m_protocolView.printBottom();

        return rest;
    end;
end;

class (RcbDataSource) F134AccountNoteDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("CbAccountNote", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, noteId : Integer, description : String) : Money

        var query = "SELECT --" + attribute.getId()
            +"\n"+  "        t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,"
            +"\n"+  "        CASE"
            +"\n"+  "            WHEN account.t_note is not null"
            +"\n"+  "                THEN 'В расчет включено значение примечания на л/счете '|| account.t_noteName"
            +"\n"+  "            ELSE account.t_noteName || ' на счете равно нулю, в расчет включен остаток счета'"
            +"\n"+  "        END            AS t_comment,"
            +"\n"+  "       SUM(t_rest) AS t_rest, GROUPING (t_account) t_isItog"
            +"\n"+  "  FROM (SELECT acc.*,"
            +"\n"+  "               rep_note.getMoneyAccountNote(acc.t_objectId, " + noteId + "," + getSqlDate(global.getRcbReport().context.period.endDate) + ") as t_note,"
            +"\n"+  "               (SELECT kind.t_name"
            +"\n"+  "                   FROM dnotekind_dbt kind--,"
            +"\n"+  "                        --dnotetext_dbt text"
            +"\n"+  "                 WHERE kind.t_objectType = rep_const.get().cb.objectTypes.account"
            +"\n"+  "                   AND kind.t_noteKind = " + noteId
            +"\n"+  "               )                                   as t_noteName,"
            +"\n"+  "        NVL(rep_note.getMoneyAccountNote(acc.t_objectId,"
            +"\n"+  "                                                          " + noteId + ","
            +"\n"+  "                                        " + getSqlDate(global.getRcbReport().context.period.endDate) + "), 0) AS t_rest"
            +"\n"+  "          FROM drepaccount_vw acc) account"
            +"\n"+  " WHERE account.t_chapter = 1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "GROUP BY ROLLUP ((t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,t_note,account.t_noteName))"
            +"\n"+  "ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query);

        var rest = $0.0;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.isItog)
                m_protocolView.printItog(dataSet);
                rest = dataSet.rest;
            else
                m_protocolView.printString(dataSet);
            end;
        end;
        
        m_protocolView.printBottom();

        return rest;
    end;
end;

class (RcbDataSource) F134AccountSubCreditDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("CbAccountSubCredit", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money

        var query = "SELECT --" + attribute.getId()
            +"\n"+  "        t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,"
            +"\n"+  "        ' ' t_comment,"
            +"\n"+  "       SUM(t_rest) AS t_rest, GROUPING (t_account) t_isItog"
            +"\n"+  "  FROM (SELECT acc.*,"
            +"\n"+  "               CASE"
            +"\n"+  "                   WHEN t_maturityDate - rep_data.getEndDate() > 5 * 365"
            +"\n"+  "                       THEN  t_outCoverRest"
            +"\n"+  "                   WHEN t_maturityDate - rep_data.getEndDate() <= 5 * 365"
            +"\n"+  "                       THEN t_outCoverRest * FLOOR(MONTHS_BETWEEN (t_maturityDate, rep_data.getEndDate())/3) / 20"
            +"\n"+  "                   ELSE 0"
            +"\n"+  "               END t_rest"
            +"\n"+  "          FROM drepaccount_vw acc) account"
            +"\n"+  " WHERE account.t_chapter = 1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "GROUP BY ROLLUP ((t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId))"
            +"\n"+  "ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query);

        var rest = $0.0;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.isItog)
                m_protocolView.printItog(dataSet);
                rest = dataSet.rest;
            else
                m_protocolView.printString(dataSet);
            end;
        end;
        
        m_protocolView.printBottom();

        return rest;
    end;
end;

class (RcbDataSource) F134AccountReserveDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("CbAccountReserve", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money

        var query = "SELECT --" + attribute.getId()
            +"\n"+  "        t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId,"
            +"\n"+  "        ' ' t_comment,"
            +"\n"+  "       SUM(t_rest) AS t_rest, GROUPING (t_account) t_isItog"
            +"\n"+  "  FROM (SELECT acc.*,"
            +"\n"+  "               NVL((SELECT SUM(reserve.t_endDateReserveAmount)"
            +"\n"+  "                      FROM drepreserveAccount_vw reserve"
            +"\n"+  "                     WHERE reserve.t_connectAccountId = acc.t_accountid), 0) t_rest"
            +"\n"+  "  FROM drepaccount_vw acc) account"
            +"\n"+  " WHERE account.t_chapter = 1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "GROUP BY ROLLUP ((t_chapter, t_account, t_contragentId, t_closeDate,t_openDate,t_partyId,t_fiId))"
            +"\n"+  "ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query);

        var rest = $0.0;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.isItog)
                m_protocolView.printItog(dataSet);
                rest = dataSet.rest;
            else
                m_protocolView.printString(dataSet);
            end;
        end;
        
        m_protocolView.printBottom();

        return rest;
    end;
end;

class (RcbDataSources) F134DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);
    
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(F134CbDocumentDataSource(m_protocolView.getDataProtocolView("CbDocument"), this));
        m_dataSourcePool.push_back(F134AccountDataSource(m_protocolView.getDataProtocolView("CbAccount"), this));
        m_dataSourcePool.push_back(F134AccountNoteDataSource(m_protocolView.getDataProtocolView("CbAccountNote"), this));
        m_dataSourcePool.push_back(F134AccountSubCreditDataSource(m_protocolView.getDataProtocolView("CbAccount"), this));
        m_dataSourcePool.push_back(F134AccountReserveDataSource(m_protocolView.getDataProtocolView("CbAccount"), this));
    end;

end;
