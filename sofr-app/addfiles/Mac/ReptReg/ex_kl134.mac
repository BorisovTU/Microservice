import RcbKlikoView;
import RcbProtocolView;
import rcbConst;

class F134KlikoExportController()

    var StrFile = TArray,
        VarName = TArray;

    private var m_report = rcbApplication.currentReport;

    private var m_view = TRcbKlikoView("134", m_report.context.period.endDate);

    private macro initialize()
        strFile[strFile.size] = "000";   varName[varName.size] = "EqК";
        strFile[strFile.size] = "101";   varName[varName.size] = "Eq2_1_1__2_1_2";
        strFile[strFile.size] = "102";   varName[varName.size] = "Eq2_1_3__2_1_4";
        strFile[strFile.size] = "103";   varName[varName.size] = "Eq2_1_5";
        strFile[strFile.size] = "104";   varName[varName.size] = "Eq2_1_6";
        strFile[strFile.size] = "104.1"; varName[varName.size] = "Eq2_1_6переоценка";
        strFile[strFile.size] = "105";   varName[varName.size] = "Eq2_1_7";
        strFile[strFile.size] = "106";   varName[varName.size] = "Eq2_1_11";
        strFile[strFile.size] = "107";   varName[varName.size] = "EqИстОсн";
        strFile[strFile.size] = "108";   varName[varName.size] = "Eq2_2_1";
        strFile[strFile.size] = "109";   varName[varName.size] = "Eq2_2_2__2_2_3";
        strFile[strFile.size] = "110";   varName[varName.size] = "Eq2_2_4";
        strFile[strFile.size] = "111";   varName[varName.size] = "Eq2_2_5";
        strFile[strFile.size] = "111.1"; varName[varName.size] = "Eq2_2_5переоценка";
        strFile[strFile.size] = "112";   varName[varName.size] = "Eq2_2_6";
        strFile[strFile.size] = "113";   varName[varName.size] = "Eq2_2_8";
        strFile[strFile.size] = "114";   varName[varName.size] = "Eq2_2_9";
        strFile[strFile.size] = "115";   varName[varName.size] = "EqОсн";
        strFile[strFile.size] = "201";   varName[varName.size] = "Eq3_1";
        strFile[strFile.size] = "202";   varName[varName.size] = "Eq3_3";
        strFile[strFile.size] = "203";   varName[varName.size] = "Eq3_4";
        strFile[strFile.size] = "203.1"; varName[varName.size] = "Eq3_4переоценка";
        strFile[strFile.size] = "204";   varName[varName.size] = "Eq3_5";
        strFile[strFile.size] = "205";   varName[varName.size] = "Eq3_6";
        strFile[strFile.size] = "206";   varName[varName.size] = "Eq3_7";
        strFile[strFile.size] = "207";   varName[varName.size] = "Eq3_9";
        strFile[strFile.size] = "208";   varName[varName.size] = "Eq3_10";
        strFile[strFile.size] = "209";   varName[varName.size] = "EqИстДоп";
        strFile[strFile.size] = "210";   varName[varName.size] = "EqДоп";
        strFile[strFile.size] = "301";   varName[varName.size] = "Eq4_1";
        strFile[strFile.size] = "302";   varName[varName.size] = "Eq4_2";
        strFile[strFile.size] = "303";   varName[varName.size] = "Eq4_3";
        strFile[strFile.size] = "304";   varName[varName.size] = "Eq4_5";
        strFile[strFile.size] = "305";   varName[varName.size] = "Eq4_6";
        strFile[strFile.size] = "400";   varName[varName.size] = "EqПром";
        strFile[strFile.size] = "501";   varName[varName.size] = "Eq5_1";
        strFile[strFile.size] = "502";   varName[varName.size] = "Eq5_2";
        strFile[strFile.size] = "503";   varName[varName.size] = "Eq5_3";    
    end;
    
    private macro getValuePool(number)

        var attributeValue = m_report.attributeValue(varName[number]);

        if (attributeValue == null)
            return;
        end;
        
        var valuePool = TArray();

        valuePool[0]  = strFile[number];
        valuePool[1]  = attributeValue.scaledAsString;

        return valuePool;
    end;

    private macro printPart()

        if (m_report.context.period.kind == RCB_PK_MONTH) 
            m_view.printHead("Ф_134");
        else
            m_view.printHead("Ф_134D");
        end;
        
        var i = 0;
        while (i < varName.size)
            m_view.printRow(getValuePool(i));            
            i = i + 1;
        end;          
    end;

    /**
     * Выполнить печать.
     */
    macro execute()

        m_view.setOutputFile();

        printPart();

        m_view.resetOutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String(m_view.getHeadsCount() + m_view.getRowsCount()) + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: " + m_view.getHeadsCount());
        protocolView.printLine("    количество содержательных строк:" + m_view.getRowsCount());

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;

    initialize();
end;

class (F134KlikoExportController) F134KlikoExportController_2332()

    initF134KlikoExportController();

    private macro initialize()
        strFile[strFile.size] = "000";   varName[varName.size] = "EqК";
        strFile[strFile.size] = "101";   varName[varName.size] = "Eq2_1_1__2_1_2";
        strFile[strFile.size] = "102";   varName[varName.size] = "Eq2_1_3__2_1_4";
        strFile[strFile.size] = "103";   varName[varName.size] = "Eq2_1_5";
        strFile[strFile.size] = "104";   varName[varName.size] = "Eq2_1_6";
        strFile[strFile.size] = "104.1"; varName[varName.size] = "Eq2_1_6переоценка";
        strFile[strFile.size] = "105";   varName[varName.size] = "Eq2_1_7";
        strFile[strFile.size] = "106";   varName[varName.size] = "Eq2_1_11";
        strFile[strFile.size] = "107";   varName[varName.size] = "Eq2_1_12";
        strFile[strFile.size] = "108";   varName[varName.size] = "EqИстОсн";
        strFile[strFile.size] = "109";   varName[varName.size] = "Eq2_2_1";
        strFile[strFile.size] = "110";   varName[varName.size] = "Eq2_2_2__2_2_3";
        strFile[strFile.size] = "111";   varName[varName.size] = "Eq2_2_4";
        strFile[strFile.size] = "112";   varName[varName.size] = "Eq2_2_5";
        strFile[strFile.size] = "112.1"; varName[varName.size] = "Eq2_2_5переоценка";
        strFile[strFile.size] = "113";   varName[varName.size] = "Eq2_2_6";
        strFile[strFile.size] = "114";   varName[varName.size] = "Eq2_2_8";
        strFile[strFile.size] = "115";   varName[varName.size] = "Eq2_2_9";
        strFile[strFile.size] = "116";   varName[varName.size] = "EqОсн";
        strFile[strFile.size] = "201";   varName[varName.size] = "Eq3_1";
        strFile[strFile.size] = "202";   varName[varName.size] = "Eq3_3";
        strFile[strFile.size] = "203";   varName[varName.size] = "Eq3_4";
        strFile[strFile.size] = "203.1"; varName[varName.size] = "Eq3_4переоценка";
        strFile[strFile.size] = "204";   varName[varName.size] = "Eq3_5";
        strFile[strFile.size] = "205";   varName[varName.size] = "Eq3_6";
        strFile[strFile.size] = "206";   varName[varName.size] = "Eq3_7";
        strFile[strFile.size] = "207";   varName[varName.size] = "Eq3_9";
        strFile[strFile.size] = "208";   varName[varName.size] = "Eq3_10";
        strFile[strFile.size] = "209";   varName[varName.size] = "EqИстДоп";
        strFile[strFile.size] = "210";   varName[varName.size] = "EqДоп";
        strFile[strFile.size] = "301";   varName[varName.size] = "Eq4_1";
        strFile[strFile.size] = "302";   varName[varName.size] = "Eq4_2";
        strFile[strFile.size] = "303";   varName[varName.size] = "Eq4_3";
        strFile[strFile.size] = "304";   varName[varName.size] = "Eq4_5";
        strFile[strFile.size] = "305";   varName[varName.size] = "Eq4_6";
        strFile[strFile.size] = "400";   varName[varName.size] = "EqПром";
        strFile[strFile.size] = "501";   varName[varName.size] = "Eq5_1";
        strFile[strFile.size] = "502";   varName[varName.size] = "Eq5_2";
        strFile[strFile.size] = "503";   varName[varName.size] = "Eq5_3";
    end;
end;

macro executeKlikoExport()
    if (rcbApplication.currentReport.context.period.endDate <= RCB_I2332_DATE)
        F134KlikoExportController().execute();
    else
        F134KlikoExportController_2332().execute();        
    end;         
end;

executeKlikoExport();

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);