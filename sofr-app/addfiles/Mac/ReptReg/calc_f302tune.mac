/*
$Name:          calc_f302tune.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 302. Настроечная таблица
*/

import XmlRpcInter, ServiceAction;
import RcbConst;
import RcbGeneratedDataSource;

import RcbTuneTable;
import rcb_bo;

/**
 * Настроечная таблица балансовых счетов по 3269-У
 * В 3125 используется только для обеспечения web-интерфейса РО
 */
class (RcbTuneTable) TF302TuneTableBalanceAcc_3269(name : String)
    /**
     * Получить список полей настроечной таблицы.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object
        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        var result: Object = TArray();
        result[result.size] = TMetaInformation(result.size, "t_part",                   "Раздел",           true,  true);
        result[result.size] = TMetaInformation(result.size, "t_row",                    "Строка отчета",    true,  true);
        result[result.size] = TMetaInformation(result.size, "t_columns",                "Графа отчета",     true,  true);
        result[result.size] = TMetaInformation(result.size, "t_backoffice",             "Бэк офис",         false, true);
        result[result.size - 1].type = TYPE_BACKOFFICE; // t_backoffice
        result[result.size] = TMetaInformation(result.size, "t_backofficedistr",        "Бэк офис дистр.",  true,  false);
        result[result.size] = TMetaInformation(result.size, "t_accountMasks",           "Маски л/с",        false, true);
        result[result.size] = TMetaInformation(result.size, "t_accountMasksfor_8_9",    "Маски л/с для ПЗ", false, true);

        return result;
    end;

    private macro constructorTF302TuneTableBalanceAcc_3269(name : String)
        if (   (name == null)
            or (name == "")
           )
            name = "dt302BalanceAccounts_dbt";
        end;
        initRcbTuneTable(name);
        setInstructionFilter(RCB_I3269_DATE);
    end;

    constructorTF302TuneTableBalanceAcc_3269(name);
end;

class (RcbTuneTable) TF302TuneTableBalanceAcc_3875(name : String)
    /**
     * Получить список полей настроечной таблицы.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object
        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        var result: Object = TArray();
        result[result.size] = TMetaInformation(result.size, "t_part",                   "Раздел",           true,  true);
        result[result.size] = TMetaInformation(result.size, "t_row",                    "Строка отчета",    true,  true);
        result[result.size] = TMetaInformation(result.size, "t_columns",                "Графа отчета",     true,  true);
        result[result.size] = TMetaInformation(result.size, "t_backoffice",             "Бэк офис",         false, true);
        result[result.size - 1].type = TYPE_BACKOFFICE; // t_backoffice
        result[result.size] = TMetaInformation(result.size, "t_backofficedistr",        "Бэк офис дистр.",  true,  false);
        result[result.size] = TMetaInformation(result.size, "t_accountMasks",           "Маски л/с",        false, true);
        result[result.size] = TMetaInformation(result.size, "t_accountMasksfor_8_9",    "Маски л/с для ПЗ", false, true);

        return result;
    end;

    private macro constructorTF302TuneTableBalanceAcc_3875(name : String)
        if (   (name == null)
            or (name == "")
           )
            name = "dt302BalanceAccounts_dbt";
        end;
        initRcbTuneTable(name);
        setInstructionFilter(RCB_I3875_DATE2);
    end;

    constructorTF302TuneTableBalanceAcc_3875(name);
end;

/**
 * Настроечная таблица кодов по ОКВЭД по 3269-У
 * В 3125 используется только для обеспечения web-интерфейса РО
 */
class (RcbTuneTable) TF302TuneTableOkved_3269(name : String)
    /**
     * Получить список полей настроечной таблицы.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object
        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        var result: Object = TArray();
        result[result.size] = TMetaInformation(result.size, "t_part",       "Раздел",           true,  true);
        result[result.size] = TMetaInformation(result.size, "t_row",        "Строка отчета",    true,  true);
        result[result.size] = TMetaInformation(result.size, "t_okvedMasks", "Маски ОКВЭД",      false, true);

        return result;
    end;

    private macro constructorTF302TuneTableOkved_3269(name : String)
        if (   (name == null)
            or (name == "")
           )
            name = "dt302okvedmasks_dbt";
        end;
        initRcbTuneTable(name);
        setInstructionFilter(RCB_I3269_DATE);
    end;

    constructorTF302TuneTableOkved_3269(name);
end;

/**
 * Настроечная таблица кодов по ОКАТО по 3269-У
 * В 3125 используется только для обеспечения web-интерфейса РО
 */
class (RcbTuneTable) TF302TuneTableOkato_3269(name : String)
    /**
     * Получить список полей настроечной таблицы.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object
        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        var result: Object = TArray();
        result[result.size] = TMetaInformation(result.size, "t_okato",      "Код ОКАТО",            true,  true);
        result[result.size] = TMetaInformation(result.size, "t_okatoMasks", "Маска кодов ОКАТО АО", false, true);
        result[result.size] = TMetaInformation(result.size, "t_comment",    "Комментарий",          false, true);

        return result;
    end;

    private macro constructorTF302TuneTableOkato_3269(name : String)
        if (   (name == null)
            or (name == "")
           )
            name = "dt302okatocodes_dbt";
        end;
        initRcbTuneTable(name);
        setInstructionFilter(RCB_I3269_DATE);
    end;

    constructorTF302TuneTableOkato_3269(name);
end;

/**
 * Настроечная таблица кодов по ОКАТО по 3875-У
 * В 3125 используется только для обеспечения web-интерфейса РО
 *
 * @param name String Наименование таблицы настроечной таблицы
 */
class (RcbTuneTable) TF302TuneTableOkato_3875(name: String)

    /**
     * Получить список полей настроечной таблицы.
     *
     * @return Массив объектов TMetaInformation.
     */
    macro getMetadataTuneTableWeb() : Object

        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        //Названия полей и колонок смотреть в словаре rs-bank с помощью утилиты ExploreFMT.exe. Поля t_instructiondate и t_isclosed не добавлять
        //Порядок добавления в массив см. в RcbTuneTable.cpp в соотв. функции либо в ТЗ, если НТ делается "с нуля"
        var result: TArray = TArray();
        result[result.size] = TMetaInformation(result.size, "t_okato",      "Код ОКАТО",            TRUE,  TRUE);
        result[result.size] = TMetaInformation(result.size, "t_okatoMasks", "Маска кодов ОКАТО АО", FALSE, TRUE);
        result[result.size] = TMetaInformation(result.size, "t_comment",    "Комментарий",          FALSE, TRUE);

        return result;

    end;

    /**
     * Конструктор
     *
     * @param name String Наименование таблицы настроечной таблицы
     */
    private macro constructorTF302TuneTableOkato_3875(name : String)

        if ((name == NULL) OR (name == ""))

            name = "dt302okatocodes_dbt";

        end;

        initRcbTuneTable(name);
        setInstructionFilter(RCB_I3875_DATE2);

    end;

    constructorTF302TuneTableOkato_3875(name);

end;

private const TUNE_TABLE_BALANCE_ACC = "Балансовые счета";
private const TUNE_TABLE_OKVED = "Коды по ОКВЭД";
private const TUNE_TABLE_OKATO = "Коды АО по ОКАТО";

/**
 * Создать и вернуть объект настроечной таблицы.
 *
 * @param destination Указание.
 *
 * @return Объект настроечной таблицы в формате xml.
 */
macro getObjectTuneTableWeb(attribute /* : TRcbTuneTableItemTree */) : String
    /**
     * Объект настроечной таблицы.
     */
    var tuneTable : Object = null;

    if (attribute.nameDesignation == NAME_DESTINATION_3875U)
        if (attribute.nameObject == TUNE_TABLE_BALANCE_ACC)
            tuneTable = TF302TuneTableBalanceAcc_3875();
        elif (attribute.nameObject == TUNE_TABLE_OKVED)
            tuneTable = TF302TuneTableOkved_3269();
        elif (attribute.nameObject == TUNE_TABLE_OKATO)
            tuneTable = TF302TuneTableOkato_3875();
        else
            runError("Неизвестный раздел \"" + attribute.nameObject + "\"");
        end;
    elif (attribute.nameDesignation == NAME_DESTINATION_3269U)
        if (attribute.nameObject == TUNE_TABLE_BALANCE_ACC)
            tuneTable = TF302TuneTableBalanceAcc_3269();
        elif (attribute.nameObject == TUNE_TABLE_OKVED)
            tuneTable = TF302TuneTableOkved_3269();
        elif (attribute.nameObject == TUNE_TABLE_OKATO)
            tuneTable = TF302TuneTableOkato_3269();
        else
            runError("Неизвестный раздел \"" + attribute.nameObject + "\"");
        end;
    else
        runError("Неизвестная инструкция ЦБ \"" + attribute.nameDesignation + "\"");
    end;

    // Нижеследующие строки не менять, это часть инструментальной функциональности
    var metadataList = tuneTable.getMetadataTuneTableWeb();
    tuneTable.saveMetadataTuneTable(metadataList);
    tuneTable.saveDataTuneTable();
    var resultXml : String = "";
    if (convertToXml(tuneTable, null, resultXml) != 0)
        runError("Ошибка преобразования объекта настроечной таблицы в XML");
    end;

    return resultXml;
end;

/**
 * Получить массив указаний\разделов для настроечной таблицы.
 *
 * Если используются только указания, то формируем простой массив указаний.
 * Если используются и указания и разделы, то формируем сложный массив, по аналогии:
 * var arrayList = TArray();
 * arrayList[arrayList.size] = "Указание 1";
 * var arrayPart = TArray();
 * arrayPart[arrayPart.size] = "Раздел 1";
 * arrayPart[arrayPart.size] = "Раздел 2";
 * arrayList[arrayList.size] = arrayPart;
 * Будет сформировано дерево настроечной таблицы (web):
 *   - Указание 1
 *       - Раздел 1
 *       - Раздел 2
 *
 * @return TArray Массив указаний\разделов.
 */
macro getDestinationTuneTableWeb() : String
    var result = TArray();

    result[result.size] = NAME_DESTINATION_3269U;
    result[result.size] = arrCreate(TUNE_TABLE_BALANCE_ACC, TUNE_TABLE_OKVED, TUNE_TABLE_OKATO);
    result[result.size] = NAME_DESTINATION_3875U;
    result[result.size] = arrCreate(TUNE_TABLE_BALANCE_ACC, TUNE_TABLE_OKVED, TUNE_TABLE_OKATO);

    // Нижеследующие строки не менять, это часть инструментальной функциональности
    var resultXml : String = "";
    if (convertToXml(result, null, resultXml) != 0)
        runError("Ошибка преобразования списка указаний\разделов в XML");
    end;

    return resultXml;
end;
