/*
$Name:          f652PtkPsdExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 652. Контроллер экспорта в АС ПСД
*/

/**
 * Форма 652. Контроллер экспорта АС ПСД.
 *
 * @since   04.07.2013
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (TPtkPsdView) F652PtkPsdView(fileExtension : String, reportDate : Date, encoding : String)
    private macro constructorF652PtkPsdView(fileExtension : String, reportDate : Date, encoding : String)
        initTPtkPsdView(fileExtension, reportDate, encoding);

        var day, month, year;
        DateSplit(m_reportDate, day, month, year);

        m_stringReportDate =  strLpad(string(day),   2, "0") + "."
                            + strLpad(string(month), 2, "0") + "."
                            + string(year);
    end;

    constructorF652PtkPsdView(fileExtension, reportDate, encoding);
end;

class (F652PtkPsdView) F652PtkPsdViewForNull(fileExtension : String, reportDate : Date, encoding : String)
    private macro constructorF652PtkPsdViewForNull(fileExtension : String, reportDate : Date, encoding : String)
        initF652PtkPsdView(fileExtension, reportDate, encoding);
        EOL = "F652";
    end;

    constructorF652PtkPsdViewForNull(fileExtension, reportDate, encoding);
end;

class F652PtkPsdExportController()
    private var m_report;
    private var m_reportName;
    private var m_view;

    private macro constructorF652PtkPsdExportController()
        m_report = objectFactoryInstance.createReport(RcbApplication.currentReport);
        m_reportName = m_report.getRcbReport().form.id;

        if (not m_report.isEmpty())
            m_view = F652PtkPsdView("652", m_report.getPeriod().endDate);
        else
            m_view = F652PtkPsdViewForNull("652", m_report.getPeriod().endDate);
        end;
    end;

    private macro printString(fiCode : String, codeColumn, line : String)
        var value = String(m_report.getPart("").getAttribute(line).getScaledValue(line, fiCode):0:0);
        if (value > 0)
            m_view.printRow("F652", fiCode, codeColumn, value);
        end;
        if (line == "")
            m_view.printRow("F652", fiCode, codeColumn, fiCode);
        end;
    end;

    private macro printNullData()
        m_view.printRow("$attrib$2", "$attrib$", "prnpr", 0);
    end;

    private macro printData()
        var iterator = RcbApplication.currentReport.attributeValue("СписокВалют").createValueIterator();
        var codeColumn = TArray();
        codeColumn[0] = "A";
        codeColumn[1] = "1";
        codeColumn[2] = "2";
        codeColumn[3] = "3";
        codeColumn[31] = "31";
        codeColumn[32] = "32";
        codeColumn[33] = "33";
        codeColumn[34] = "36";
        codeColumn[35] = "37";
        codeColumn[4] = "4";

        iterator.moveFirst();
        while(not iterator.isDone())
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[0], "");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[1], "1");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[2], "2");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[3], "3");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[31], "3.1");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[32], "3.2");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[33], "3.3");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[34], "3.4");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[35], "3.5");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[4], "4");
            iterator.moveNext();
        end;
    end;

    private macro printDataZone()
        m_view.setOutputFile();
        if (not m_report.isEmpty())
            printData();
        else
            printNullData();
        end;
        m_view.resetOutputFile();
    end;

    private macro getDescriptorInfo()
        return "№2_2_1 от 16.11.2012";
    end;

    macro execute()
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", m_reportName);

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String( m_view.getRowsCount()) + ".");

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;

    constructorF652PtkPsdExportController();
end;

class (F652PtkPsdExportController) F652PtkPsdExportController_3198()
    initF652PtkPsdExportController();

    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    private macro printData()
        var iterator = RcbApplication.currentReport.attributeValue("СписокВалют").createValueIterator();
        var codeColumn = TArray();
        codeColumn[0] = "A";
        codeColumn[1] = "1";
        codeColumn[2] = "2";
        codeColumn[21] = "2_1";
        codeColumn[22] = "2_2";
        codeColumn[3] = "3";

        iterator.moveFirst();
        while(not iterator.isDone())
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[0], "");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[1], "1");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[2], "2");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[21], "2.1");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[22], "2.2");
            printString(iterator.currentItem.fieldValue("fiCode").exact, codeColumn[3], "3");
            iterator.moveNext();
        end;
    end;

    macro execute()
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", m_reportName);

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Количество выгруженных строк: " + String( m_view.getRowsCount()) + ".");

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;

class (F652PtkPsdExportController_3198) F652PtkPsdExportController_4637()
    initF652PtkPsdExportController_3198();

    private macro getDescriptorInfo()
        return "Формат экспорта доработан по мета-данным 0mx7p, загруженным в АС ПТК";
    end;
end;