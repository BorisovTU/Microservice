/*
$Name:          f652DataSources.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 652. Источники данных
*/

/**
 * Форма 652. Источники данных.
 *
 * @since   04.07.2013
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

const RATETYPE_CB = 7; //Курс ЦБ
const SUM_USD_FOR_EQUIVALENT = 1000000;  //Сумма долларов США для эквивалента зачисленных средств

class (RcbDataSource) F652AccountsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro clear()
        sql_execute("TRUNCATE TABLE df652accounts_tmp");
    end;

    macro cacheData(filter : RcbDataSourceFilter)

        sql_execute( "INSERT INTO df652accounts_tmp (t_account,"
            + "\n" + "                               t_accountId,"
            + "\n" + "                               t_fiid,"
            + "\n" + "                               t_inRest,"
            + "\n" + "                               t_outRest,"
            + "\n" + "                               t_contragentId,"
            + "\n" + "                               t_debetTurn,"
            + "\n" + "                               t_creditTurn)"

            + "\n" + "SELECT acc.t_account                                                                             t_account,"
            + "\n" + "       acc.t_accountId                                                                           t_accountId,"
            + "\n" + "       acc.t_fiid                                                                                t_fiid,"
            + "\n" + "       acc.t_inRest                                                                              t_inRest,"
            + "\n" + "       acc.t_outRest                                                                             t_outRest,"
            + "\n" + "       acc.t_contragentId                                                                        t_contragentId,"
            + "\n" + "NVL((SELECT t_debet"
            + "\n" + "        FROM drestdate_dbt rest"
            + "\n" + "       WHERE acc.t_accountId = rest.t_accountId"
            + "\n" + "         AND acc.t_fiid = rest.t_restCurrency"
            + "\n" + "         AND rest.t_restDate BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()), 0) AS t_debetTurn,"
            + "\n" + "NVL((SELECT t_credit"
            + "\n" + "        FROM drestdate_dbt rest"
            + "\n" + "       WHERE acc.t_accountId = rest.t_accountId"
            + "\n" + "         AND acc.t_fiid = rest.t_restCurrency"
            + "\n" + "         AND rest.t_restDate BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()), 0) AS t_creditTurn"
            + "\n" + "   FROM drepaccount_vw acc"
            + "\n" + "  WHERE " + NVL(filter.isSuitable(), "1 = 1")
            + "\n" + "    AND ( acc.t_inRest > 0 OR (acc.t_inRest = 0 AND EXISTS (SELECT 1"
            + "\n" + "                                                               FROM drepdocument_vw doc"
            + "\n" + "                                                              WHERE (acc.t_account = doc.t_debetAccount"
            + "\n" + "                                                                  OR acc.t_account = doc.t_creditAccount)"
            + "\n" + "                                                                 AND doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate())) )");
    end;

    private macro constructorF652AccountsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("Accounts", protocolView, dataSources);
    end;

    constructorF652AccountsDataSource(protocolView, dataSources);
end;

class (RcbDataSource) F652DocumentsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

        macro cacheData()
            sql_execute("INSERT INTO df652documents_tmp (t_number,"
            + "\n" + "                               t_debetAccount,"
            + "\n" + "                               t_creditAccount,"
            + "\n" + "                               t_sum,"
            + "\n" + "                               t_fiid,"
            + "\n" + "                               t_currencyOpCode,"
            + "\n" + "                               t_paymentId)"

            + "\n" + "   SELECT t_number,"
            + "\n" + "          t_debetAccount,"
            + "\n" + "          t_creditAccount,"
            + "\n" + "          t_sum,"
            + "\n" + "          t_fiid,"
            + "\n" + "          t_currencyOpCode,"
            + "\n" + "          t_paymentId"
            + "\n" + "      FROM("
            + "\n" + "           SELECT t_number,"
            + "\n" + "                  docs.t_debetAccount     t_debetAccount,"
            + "\n" + "                  docs.t_creditAccount    t_creditAccount,"
            + "\n" + "                  CASE"
            + "\n" + "                    WHEN docs.t_paymentId IS NOT NULL AND EXISTS (SELECT 1 FROM dpmco_dbt pmco WHERE docs.t_paymentId = pmco.t_paymentId)"
            + "\n" + "                      THEN (SELECT t_amount FROM dpmco_dbt pmco WHERE pmco.t_paymentId = docs.t_paymentId AND pmco.t_general = 'X')"
            + "\n" + "                    ELSE"
            + "\n" + "                      docs.t_sum"
            + "\n" + "                  END t_sum,"
            + "\n" + "                  CASE"
            + "\n" + "                    WHEN docs.t_paymentId IS NOT NULL AND EXISTS (SELECT 1 FROM dpmco_dbt pmco WHERE docs.t_paymentId = pmco.t_paymentId)"
            + "\n" + "                      THEN (SELECT t_fiid FROM dpmcurtr_dbt dpmcurtr WHERE dpmcurtr.t_paymentId = docs.t_paymentId)"
            + "\n" + "                    ELSE"
            + "\n" + "                      docs.t_fiid"
            + "\n" + "                  END t_fiid,"
            + "\n" + "                  CASE"
            + "\n" + "                    WHEN docs.t_paymentId IS NOT NULL"
            + "\n" + "                      THEN (SELECT t_vo_codestr FROM dpmco_dbt pmco WHERE pmco.t_paymentId = docs.t_paymentId AND pmco.t_general = 'X')"
            + "\n" + "                    ELSE"
            + "\n" + "                      NVL(REGEXP_SUBSTR(REGEXP_SUBSTR(UPPER(docs.t_ground), '{VO\\d{5}}'), '\\d{5}'), '')"
            + "\n" + "                  END t_currencyOpCode,"
            + "\n" + "                  docs.t_paymentId    t_paymentId"
            + "\n" + "              FROM("
            + "\n" + "                   SELECT CASE"
            + "\n" + "                            WHEN doc.t_paymentId IS NOT NULL"
            + "\n" + "                              THEN (SELECT t_number FROM dpmrmprop_dbt pm WHERE pm.t_paymentId = doc.t_paymentId)"
            + "\n" + "                            ELSE"
            + "\n" + "                              doc.t_number"
            + "\n" + "                          END                                  t_number,"
            + "\n" + "                          doc.t_debetAccount                   t_debetAccount,"
            + "\n" + "                          doc.t_creditAccount                  t_creditAccount,"
            + "\n" + "                          doc.t_debetSum                       t_sum,"
            + "\n" + "                          acc.t_fiid                           t_fiid,"
            + "\n" + "                          doc.t_ground                         t_ground,"
            + "\n" + "                          doc.t_paymentId                      t_paymentId"
            + "\n" + "                      FROM drepdocument_vw doc, df652accounts_tmp acc"
            + "\n" + "                     WHERE doc.t_debetAccount = acc.t_account AND doc.t_creditFiid <> 0"
            + "\n" + "                       AND doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
            + "\n" + "                   ) docs"
            + "\n" + "           ) doc"
            + "\n" + "   GROUP BY t_number, t_debetAccount, t_creditAccount, t_sum, t_fiid, t_currencyOpCode, t_paymentId");
        end;

    macro clear()
        sql_execute("TRUNCATE TABLE df652documents_tmp");
    end;

    private macro constructorF652DocumentsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("Documents", protocolView, dataSources);
    end;

    constructorF652DocumentsDataSource(protocolView, dataSources);
end;

class (RcbDataSource) F652DataSource(line : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    private var m_sortByCurrency;

    private macro updateData(line : String, filter : RcbDataSourceFilter)
        var query = "UPDATE df652documents_tmp doc"
            + "\n" + "   SET t_line = " + getSqlString(line)
            + "\n" + "  WHERE " + nvl(filter.isSuitable(), "1 = 1") 
            + "\n" + "    AND doc.t_line IS NULL";

        sql_execute(query);
    end;

    private macro constructorF652DataSource(line, protocolView, dataSources)
        initRcbDataSource(line, protocolView, dataSources);
        m_sortByCurrency = "ORDER BY CASE t_fiid"
            + "\n" + "                 WHEN '840' THEN '000'"
            + "\n" + "                 WHEN '978' THEN '001'"
            + "\n" + "                 ELSE t_fiid"
            + "\n" + "               END";

    end;

    constructorF652DataSource(line, protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine1(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData()
        var query = "SELECT SUM(acc.t_inrest)                 t_inrest,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE acc.t_fiid = fin.t_fiid) t_fiid"
            + "\n" + "   FROM df652accounts_tmp acc"
            + "\n" + "GROUP BY t_fiid"
            + "\n" + m_sortByCurrency;

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_inrest", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine1(protocolView, dataSources)
        initF652DataSource("1", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine1(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine2(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData()
        var query = "SELECT SUM(acc.t_creditTurn)             t_creditTurn,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE acc.t_fiid = fin.t_fiid) t_fiid"
            + "\n" + "   FROM df652accounts_tmp acc"
            + "\n" + "GROUP BY t_fiid"
            + "\n" + m_sortByCurrency;

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_creditTurn", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine2(protocolView, dataSources)
        initF652DataSource("2", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine2(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine3(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData()
        var query = "SELECT SUM(acc.t_debetTurn)              t_debetTurn,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE acc.t_fiid = fin.t_fiid) t_fiid"
            + "\n" + "   FROM df652accounts_tmp acc"
            + "\n" + "GROUP BY t_fiid"
            + "\n" + m_sortByCurrency;

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_debetTurn", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine3(protocolView, dataSources)
        initF652DataSource("3", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine3(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine31(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(filter : RcbDataSourceFilter)
        updateData("3.1", filter);
        var query = "SELECT '3.1'                             t_line,"
            + "\n" + "      doc.t_number                      t_number,"
            + "\n" + "      doc.t_debetAccount                t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid) t_fiid,"
            + "\n" + "      SUM(doc.t_sum)                    t_sum,"
            + "\n" + "      GROUPING(doc.t_fiid)              t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)              t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = '3.1'"
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_debetAccount))"
            + "\n" + m_sortByCurrency + ", t_number";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine("3.1");
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine31(protocolView, dataSources)
        initF652DataSource("3.1", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine31(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine33(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(filter : RcbDataSourceFilter)
        updateData("3.3", filter);
        var query = "SELECT '3.3'                                 t_line,"
            + "\n" + "      doc.t_number                          t_number,"
            + "\n" + "      doc.t_debetAccount                    t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid)     t_fiid,"
            + "\n" + "      SUM(doc.t_sum)                        t_sum,"
            + "\n" + "      GROUPING(doc.t_fiid)                  t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)                  t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = '3.3'"
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_debetAccount))"
            + "\n" + m_sortByCurrency + ", t_number";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine("3.3");
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine33(protocolView, dataSources)
        initF652DataSource("3.3", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine33(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine34(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(filter : RcbDataSourceFilter)
        updateData("3.4", filter);
        var query = "SELECT '3.4'                                 t_line,"
            + "\n" + "      doc.t_number                          t_number,"
            + "\n" + "      doc.t_debetAccount                    t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid)     t_fiid,"
            + "\n" + "      SUM(doc.t_sum)                        t_sum,"
            + "\n" + "      GROUPING(doc.t_fiid)                  t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)                  t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = '3.4'"
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_debetAccount))"
            + "\n" + m_sortByCurrency + ", t_number";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine("3.4");
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine34(protocolView, dataSources)
        initF652DataSource("3.4", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine34(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine35(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(filter : RcbDataSourceFilter)
        updateData("3.5", filter);
        var query = "SELECT '3.5'                                 t_line,"
            + "\n" + "      doc.t_number                          t_number,"
            + "\n" + "      doc.t_debetAccount                    t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid) t_fiid,"
            + "\n" + "      SUM(doc.t_sum)                        t_sum,"
            + "\n" + "      GROUPING(doc.t_fiid)                  t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)                  t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = '3.5'"
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_debetAccount))"
            + "\n" + m_sortByCurrency + ", t_account";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine("3.5");
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine35(protocolView, dataSources)
        initF652DataSource("3.5", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine35(protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForLine4(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData()
        var query = "SELECT SUM(t_outrest) t_outrest,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE acc.t_fiid = fin.t_fiid) t_fiid"
            + "\n" + "   FROM df652accounts_tmp acc"
            + "\n" + "GROUP BY t_fiid"
            + "\n" + m_sortByCurrency;

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_outrest", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForLine4(protocolView, dataSources)
        initF652DataSource("4", protocolView, dataSources);
    end;

    constructorF652DataSourceForLine4(protocolView, dataSources)
end;

class (F652AccountsDataSource) F652AccountsDataSource_3198()
    initF652AccountsDataSource();


    macro cacheData(filter : RcbDataSourceFilter)

        sql_execute( "INSERT INTO df652accounts_tmp (t_account,"
            + "\n" + "                               t_accountId,"
            + "\n" + "                               t_fiid,"
            + "\n" + "                               t_outRest,"
            + "\n" + "                               t_contragentId)"

            + "\n" + "SELECT acc.t_account           t_account,"
            + "\n" + "       acc.t_accountId         t_accountId,"
            + "\n" + "       acc.t_fiid              t_fiid,"
            + "\n" + "       acc.t_outRest           t_outRest,"
            + "\n" + "       acc.t_contragentId      t_contragentId"
            + "\n" + "  FROM drepaccount_vw acc"
            + "\n" + " WHERE " + NVL(filter.isSuitable(), "1 = 1")
            + "\n" + "   AND (acc.t_outRest > 0 OR EXISTS (SELECT 1"
            + "\n" + "                                       FROM drepdocument_vw doc"
            + "\n" + "                                      WHERE (   acc.t_accountId = doc.t_debetAccountId"
            + "\n" + "                                             OR acc.t_accountId = doc.t_creditAccountId)"
            + "\n" + "                                        AND doc.t_date = rep_data.getEndDate()))");
    end;
end;

class (F652DocumentsDataSource) F652DocumentsDataSource_3198()
    initF652DocumentsDataSource();

        macro cacheData()
            sql_execute("INSERT INTO df652documents_tmp (t_number,"
            + "\n" + "                                   t_debetAccountId,"
            + "\n" + "                                   t_debetAccount,"
            + "\n" + "                                   t_creditAccountId,"
            + "\n" + "                                   t_creditAccount,"
            + "\n" + "                                   t_sum,"
            + "\n" + "                                   t_NatCurSum,"
            + "\n" + "                                   t_fiid,"
            + "\n" + "                                   t_currencyOpCode,"
            + "\n" + "                                   t_paymentId,"
            + "\n" + "                                   t_isDebetTurns)"

            + "\n" + "   SELECT t_number,"
            + "\n" + "          t_debetAccountId,"
            + "\n" + "          t_debetAccount,"
            + "\n" + "          t_creditAccountId,"
            + "\n" + "          t_creditAccount,"
            + "\n" + "          t_sum,"
            + "\n" + "          t_natCurSum,"
            + "\n" + "          t_fiid,"
            + "\n" + "          t_currencyOpCode,"
            + "\n" + "          t_paymentId,"
            + "\n" + "          t_isDebetTurns"
            + "\n" + "      FROM("
            + "\n" + "           SELECT doc.t_number                                         t_number,"
            + "\n" + "                  doc.t_debetAccountId                                 t_debetAccountId,"
            + "\n" + "                  doc.t_debetAccount                                   t_debetAccount,"
            + "\n" + "                  doc.t_creditAccountId                                t_creditAccountId,"
            + "\n" + "                  doc.t_creditAccount                                  t_creditAccount,"
            + "\n" + "                  doc.t_creditSum                                      t_sum, "
            + "\n" + "                  doc.t_creditConvertionCBSum                          t_natCurSum, "
            + "\n" + "                  NULL                                                 t_currencyOpCode,"
            + "\n" + "                  doc.t_creditFiId                                     t_fiId,"
            + "\n" + "                  NULL                                                 t_paymentId,"
            + "\n" + "                  0                                                    t_isDebetTurns"
            + "\n" + "             FROM drepdocument_vw doc"
            + "\n" + "            WHERE doc.t_debetFiid <> 0"
            + "\n" + "              AND doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
            + "\n" + "              AND EXISTS (SELECT 1 "
            + "\n" + "                            FROM df652accounts_tmp acc"
            + "\n" + "                           WHERE doc.t_creditAccountId = acc.t_accountId)"
            + "\n" + "        UNION ALL   "
            + "\n" + "           SELECT CASE"
            + "\n" + "                    WHEN doc.t_paymentId IS NOT NULL"
            + "\n" + "                      THEN (SELECT t_number FROM dpmrmprop_dbt pm WHERE pm.t_paymentId = doc.t_paymentId)"
            + "\n" + "                    ELSE"
            + "\n" + "                      doc.t_number"
            + "\n" + "                  END                                                  t_number,"
            + "\n" + "                  doc.t_debetAccountId                                 t_debetAccountId,"
            + "\n" + "                  doc.t_debetAccount                                   t_debetAccount,"
            + "\n" + "                  doc.t_creditAccountId                                t_creditAccountId,"
            + "\n" + "                  doc.t_creditAccount                                  t_creditAccount,"
            + "\n" + "                  NVL(mco.t_amount, doc.t_debetSum)                    t_sum, "
            + "\n" + "                  0                                                    t_natCurSum, "
            + "\n" + "                  CASE"
            + "\n" + "                    WHEN doc.t_paymentId IS NOT NULL"
            + "\n" + "                      THEN NVL(mco.t_vo_codeStr, '')"
            + "\n" + "                    ELSE"
            + "\n" + "                      NVL(REGEXP_SUBSTR(REGEXP_SUBSTR(UPPER(doc.t_ground), '{VO\\d{5}}'), '\\d{5}'), '')"
            + "\n" + "                  END                                                  t_currencyOpCode,"
            + "\n" + "                  CASE"
            + "\n" + "                    WHEN doc.t_paymentId IS NOT NULL"
            + "\n" + "                      THEN NVL((SELECT t_fiid FROM dpmcurtr_dbt dpmcurtr WHERE dpmcurtr.t_paymentId = doc.t_paymentId), doc.t_debetFiId)"
            + "\n" + "                    ELSE"
            + "\n" + "                      doc.t_debetFiId"
            + "\n" + "                  END                                                  t_fiId,"
            + "\n" + "                  doc.t_paymentId                                      t_paymentId,"
            + "\n" + "                  1                                                    t_isDebetTurns"
            + "\n" + "             FROM drepdocument_vw doc,"
            + "\n" + "                  dpmco_dbt mco"
            + "\n" + "            WHERE doc.t_creditFiid <> 0"
            + "\n" + "              AND mco.t_paymentId (+) = doc.t_paymentId"
            + "\n" + "              AND doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
            + "\n" + "              AND EXISTS (SELECT 1 "
            + "\n" + "                            FROM df652accounts_tmp acc"
            + "\n" + "                           WHERE doc.t_debetAccountId = acc.t_accountId)"
            + "\n" + "           ) doc");
 //           + "\n" + "   GROUP BY t_number, t_debetAccountId, t_debetAccount, t_creditAccountId, t_creditAccount, t_sum, t_natCurSum, t_fiid, t_currencyOpCode, t_paymentId, t_isDebetTurns");
        end;
end;

class (F652DataSource) F652DataSourceForDebet(line : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(line : String, filter : RcbDataSourceFilter)

        updateData(line, filter);

        var query = "SELECT '" + line + "'                        t_line,"
            + "\n" + "      doc.t_number                          t_number,"
            + "\n" + "      doc.t_debetAccount                    t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid)     t_fiid,"
            + "\n" + "      SUM(doc.t_sum)                        t_sum,"
            + "\n" + "      GROUPING(doc.t_fiid)                  t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)                  t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = " + line
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_debetAccount))"
            + "\n" + m_sortByCurrency + ", t_account";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine(line);
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForDebet(line, protocolView, dataSources)
        initF652DataSource(line, protocolView, dataSources);
    end;

    constructorF652DataSourceForDebet(line, protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForCredit(line : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(line : String, filter : RcbDataSourceFilter)

        updateData(line, filter);

        var query = "SELECT '" + line + "'                        t_line,"
            + "\n" + "      doc.t_number                          t_number,"
            + "\n" + "      doc.t_creditAccount                   t_account,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE doc.t_fiid = fin.t_fiid)     t_fiid,"
            + "\n" + "      rsb_fiinstr.ConvSumType(1, doc.t_fiId, 0, " + RATETYPE_CB + ", rep_data.getEndDate(),1) t_rate,"
            + "\n" + "      CASE "
            + "\n" + "           WHEN GROUPING(doc.t_fiId) = 1"
            + "\n" + "               THEN"
            + "\n" + "                   rsb_fiinstr.ConvSumType(" + SUM_USD_FOR_EQUIVALENT + ", "
            + "\n" + "                                            (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '840'),"
            + "\n" + "                                            0, "
            + "\n" +                                              RATETYPE_CB + ","
            + "\n" + "                                            rep_data.getEndDate(),1)"
            + "\n" + "           ELSE 0"
            + "\n" + "      END                                   t_USDequivalentSum,"
            + "\n" + "      SUM(doc.t_sum)                        t_sum,"
            + "\n" + "      SUM(doc.t_natCurSum)                  t_natCurSum,"
            + "\n" + "      GROUPING(doc.t_fiid)                  t_isTotalLine,"
            + "\n" + "      GROUPING(doc.t_line)                  t_isTotalCurrency"
            + "\n" + "   FROM df652documents_tmp doc"
            + "\n" + "  WHERE doc.t_line = " + line
            + "\n" + "GROUP BY ROLLUP (doc.t_fiid, (doc.t_line, doc.t_number, doc.t_creditAccount))"
            + "\n" + m_sortByCurrency + ", t_account";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_natCurSum", V_MONEY);
        dataSet.SetFieldType("t_USDequivalentSum", V_MONEY);
        dataSet.SetFieldType("t_rate", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine(line);
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForCredit(line, protocolView, dataSources)
        initF652DataSource(line, protocolView, dataSources);
    end;

    constructorF652DataSourceForCredit(line, protocolView, dataSources)
end;

class (F652DataSource) F652DataSourceForOutRest(line : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(line : string)
        var query = "SELECT '" + line + "'                    t_line,"
            + "\n" + "      acc.t_account                     t_account,"
            + "\n" + "      SUM(acc.t_outRest)                t_sum,"
            + "\n" + "      (SELECT t_iso_number"
            + "\n" + "          FROM dfininstr_dbt fin"
            + "\n" + "         WHERE acc.t_fiid = fin.t_fiid) t_fiid,"
            + "\n" + "      GROUPING(acc.t_fiid)              t_isTotalLine,"
            + "\n" + "      GROUPING(null)                    t_isTotalCurrency"
            + "\n" + " FROM df652accounts_tmp acc"
            + "\n" + "GROUP BY ROLLUP (t_fiid, (null, t_account))"
            + "\n" + m_sortByCurrency + ", t_isTotalCurrency";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_account", V_STRING);
        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_fiid", V_STRING);

        m_protocolView.printLine(line);
        m_protocolView.printProtocol(dataSet);

        dataSet.moveFirst();

        return dataSet;
    end;

    private macro constructorF652DataSourceForOutRest(line, protocolView, dataSources)
        initF652DataSource(line, protocolView, dataSources);
    end;

    constructorF652DataSourceForOutRest(line, protocolView, dataSources)
end;

class (RcbDataSources) F652DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);
    
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(F652AccountsDataSource(m_protocolView.getDataProtocolView("Accounts"), this));
        m_dataSourcePool.push_back(F652DocumentsDataSource(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine1(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine2(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine3(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine31(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine33(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine34(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine35(m_protocolView.getDataProtocolView("Documents"), this));
        m_dataSourcePool.push_back(F652DataSourceForLine4(m_protocolView.getDataProtocolView("Documents"), this));
    end;
end;

class (F652DataSources) F652DataSources_3198(protocolView : RcbCalculateProtocolView)
    initF652DataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F652AccountsDataSource_3198 (m_protocolView.getDataProtocolView("Accounts" ), this));
        m_dataSourcePool.push_back(F652DocumentsDataSource_3198(m_protocolView.getDataProtocolView("Documents"), this));

        m_dataSourcePool.push_back(F652DataSourceForCredit ("1",   m_protocolView.getDataProtocolView("DocumentsLine1"), this));
        m_dataSourcePool.push_back(F652DataSourceForDebet  ("2.1", m_protocolView.getDataProtocolView("DocumentsLine2"), this));
        m_dataSourcePool.push_back(F652DataSourceForDebet  ("2.2", m_protocolView.getDataProtocolView("DocumentsLine2"), this));
        m_dataSourcePool.push_back(F652DataSourceForOutRest("3",   m_protocolView.getDataProtocolView("DocumentsLine3"), this));
    end;
end;
