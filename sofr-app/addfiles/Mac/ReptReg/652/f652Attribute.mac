/*
$Name:          f652Attribute.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 652. Атрибут отчета
*/

/**
 * Форма 652. Атрибут отчета.
 *
 * @since   04.07.2013
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (RcbAttributeBase) F652Attribute(line : String, part : RcbPartBase, compositeValue : Object /*RcbCompositeValue или RcbAttributeValue*/)
    initRcbAttributeBase(line, part, compositeValue);

    private macro getCompositeValue(line : String, fiCode : String, isFind : Bool) : RcbCompositeValue
        var keyValue = m_attributeCompositeValue.createKeyValue();

        if (line == NULL)
            throw(TVariableIsNotDefined("line"));
        end;

        if (fiCode == NULL)
            throw(TVariableIsNotDefined("fiCode"));
        end;

        keyValue.fieldValue("line") = line;
        keyValue.fieldValue("fiCode") = fiCode;

        var compositeValue = m_attributeCompositeValue.findVAlue(keyValue);

        if (compositeValue != null)
            return compositeValue;
        elif (isFind)
            return null;
        end;

        compositeValue = m_attributeCompositeValue.addValue();

        compositeValue.reset();

        compositeValue.fieldValue("line").exact = line;
        compositeValue.fieldValue("fiCode").exact = fiCode;

        return m_attributeCompositeValue;
    end;

    macro getRcbValue(line : String, fiCode : String, isFind : Bool) : RcbValue
        var compositeValue = getCompositeValue(line, fiCode, isFind);
        var keyValue = compositeValue.createKeyValue();

        if (line == NULL)
            throw(TVariableIsNotDefined("line"));
        end;

        if (fiCode == NULL)
            throw(TVariableIsNotDefined("fiCode"));
        end;
        keyValue.fieldValue("line") = line;
        keyValue.fieldValue("fiCode") = fiCode;

        var rcbValue = compositeValue.findVAlue(keyValue);

        if (rcbValue == null)
            return null;
        end;

        return rcbValue.fieldValue("value");
    end;

    macro getValue(line : String, fiCode : String)
        return getRcbValue(line, fiCode).exact;
    end;

    macro getScaledValue(line : String, fiCode : String)
        return getRcbValue(line, fiCode).scaled;
    end;

    macro setValue(line : String, fiCode : String, value : Variant)
        var val = getRcbValue(line, fiCode);

        if (isEqClass("TValue", value))
            val.exact  = value.exact;
            val.scaled = value.scaled;
        else
            if (value != null)
                val.exact = value;
                val.recalculateScaled();
            else
                val.setUndefined;
            end;
        end;

        return this;
    end;
end;

class (RcbAttributeBase) F652AttributeListCurrency(fiCode : String, part : RcbPartBase, compositeValue : Object /*RcbCompositeValue или RcbAttributeValue*/)
    initRcbAttributeBase(fiCode, part, compositeValue);

    private macro getCompositeValue(fiCode : String, isFind : Bool) : RcbCompositeValue
        var keyValue = m_attributeCompositeValue.createKeyValue();

        if (fiCode == NULL)
            throw(TVariableIsNotDefined("fiCode"));
        end;

        keyValue.fieldValue("fiCode") = fiCode;

        var compositeValue = m_attributeCompositeValue.findVAlue(keyValue);

        if (compositeValue != null)
            return compositeValue;
        elif (isFind)
            return null;
        end;

        compositeValue = m_attributeCompositeValue.addValue();

        compositeValue.reset();

        compositeValue.fieldValue("fiCode").exact = fiCode;

        return m_attributeCompositeValue;
    end;

    macro setValue(fiCode : String, currencyName : String)
        var compositeValue = getCompositeValue(fiCode, currencyName);

        if (fiCode == NULL)
            throw(TVariableIsNotDefined("fiCode"));
        end;

        if (currencyName == NULL)
            throw(TVariableIsNotDefined("currencyName"));
        end;

        compositeValue.fieldValue("fiCode").exact = fiCode;
        compositeValue.fieldValue("currencyName").exact = currencyName;

        return this;
    end;
end;
