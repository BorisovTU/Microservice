/*
$Name:          f601KlikoExportOperation.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 601. Класс операции экспорта и вспомогательные классы
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 601. Класс операции экспорта и вспомогательные классы.

   CREATED : 19.02.08 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/**
 *  Общебанковские интеры и модули
 */
import cb_sql;

/**
 *  Интеры и модели подсистемы
 */
import RcbProtocolView;
import RcbCoreInter;
import RcbKlikoView;
import rcb_bo;
import f601Global;
import f601Report;

/**
 *  Базовый класс для суммирования данных, для экспорта итоговой строки.
 */
private class Summator()
    /**
     *  Ссылка на массив значений для экспорта.
     */
    private var m_valueArray : TArray = TArray();

    /**
     *  Инициализация. Чисто виртуальный метод, необходимо переопределять.
     */
    private macro initialize()
    end;

    /**
     *  Добавить данные к уже имеющимся.
     *
     * @param valueArray массив значений, которые необходимо добавить.
     *
     * return возвращает ссылку на себя.
     */
    macro add(valueArray : TArray) : Summator
        var i = 0;

        while (i < m_valueArray.size)
            if (valType(m_valueArray[i]) != V_STRING)
                m_valueArray[i] = Double(valueArray[i]) + m_valueArray[i];
            end;

            i = i + 1;
        end;

        return this;
    end;

    /**
     * Вернуть массив значений для экспорта в заданном виде.
     *
     *
     * return Возвращает массив значений для экспорта в заданном виде.
     */
    macro getValueArray() : TArray
        var valueArray = TArray();
        var i = 0;

        while (i < m_valueArray.size)
            if (valType(m_valueArray[i]) != V_STRING)
                valueArray[i] = String(m_valueArray[i]:0:3);
            else
                valueArray[i] = m_valueArray[i];
            end;

            i = i + 1;
        end;

        return valueArray;
    end;

    /**
     *  Вызов инициализацирующего метода.
     */
    initialize();
end;

/**
 *  Класс для суммирования данных итоговой части для экспорта итоговой строки.
 */
private class (Summator) SummatorTotalPart()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

/**
 *  Класс для суммирования данных части по ОКАТО для экспорта итоговой строки.
 */
private class (Summator) SummatorOkatoPart()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

/**
 *  Класс для хранения экспортируемого значения и вспомогательной информации по нему.
 */
private class ExportValue(part : String, code : String)
    /**
     *  Номер раздел отчета.
     */
    private var m_part        : String  = part;

    /**
     *  Номер строки либо колонки, в зависимости от раздела отчета.
     */
    private var m_code        : String  = code;

    /**
     *  Тип значения.
     */
    private var m_type        : Integer = 0;

    /**
     *  Значение в строковом виде.
     */
    private var m_value       : String  = "";

    /**
     *  Конструктор.
     */
    private macro ExportValueConstructor()
        if (   ((m_part == "2.1") and (in(m_code, "6",  "8",  "9")))
            or ((m_part == "2.2") and (in(m_code, "12", "14", "15"))))
            m_type = RCB_VT_ITEM;
        else
            m_type = RCB_VT_MONEY;
        end;

    end;

    /**
     *  Доступ на чтение к номеру раздела.
     *
     *  @return номер раздела.
     */
    macro getPart() : String
        return m_part;
    end;

    /**
     *  Доступ на чтение к номеру строки или колонки, в зависимости от раздела.
     *
     *  @return номер строки или колонки, в зависимости от раздела.
     */
    macro getCode() : String
        return m_code;
    end;

    /**
     *  Доступ на чтение к значению.
     *
     *  @return значение в строковом виде.
     */
    macro getValue() : String
        return m_value;
    end;

    /**
     *  Установить новое значение.
     *
     *  @param  value новое значение.
     *
     *  @return новое значение.
     */
    macro setValue(value : String) : String
        return m_value = value;
    end;

    /**
     *  Является ли тип значения "штуками". Так как для экспортируемых значений в данном случае могут быть либо "штуки",
     *  либо деньги. Так что проверка на штуки позволяет однозначно определить тип значения.
     *
     *  @return true если истина.
     */
    macro isItemValue()
        return m_type == RCB_VT_ITEM;
    end;

    /**
     *  Вызов конструктора.
     *
     */
    ExportValueConstructor();
end;

/**
 *  Базовый класс для создания массива экспортируемых значений, одной строки в файле экспорта.
 */
private class ExportValueArrayCreator(fiCode : String, compositeValue : Object)
    /**
     *  Ссылка на список значений для экспорта класса ExportValue.
     */
    private var m_exportValueList : TArray = TArray();

    /**
     *  Ссылка на составное значение RcbCompositeValue.
     */
    private var m_compositeValue  : Object = compositeValue;

    /**
     *  Код ОКАТО для экспортирумых значений.
     */
    private var m_okatoCode       : String = compositeValue.fieldValue("okatoCode").currentAsString;

    /**
     *  Код финансового инструмента для экспортирумых значений.
     */
    private var m_fiCode          : String = fiCode;

    /**
     *  Вернуть ссылку на список значений для экспорта класса ExportValue
     *
     *  @return ссылка на массив значений класса ExportValue
     */
    macro getExportValueList() : TArray
        return m_exportValueList;
    end;

    /**
     *  Вернуть ссылку на список значений для экспорта
     *
     *  @return ссылка на массив значений строкового типа
     */
    macro getValueArray() : TArray
        var valueArray = TArray();

        var i = 0;
        while (i < m_exportValueList.size)
            valueArray[valueArray.size] = m_exportValueList[i].getValue();
            i = i + 1;
        end;

        return valueArray;
    end;

    /**
     *  Вернуть наименование валюты по её коду
     *
     *  @param  fiCode код финансового инструмента
     *
     *  @return наименование валюты
     */
    private macro getFiName(fiCode : String) : String
        var dataSet = TRsbDataSet("SELECT t_name"
            + "\n" +              "  FROM dfininstr_dbt"
            + "\n" +              " WHERE t_fi_code = " + getSqlString(fiCode));

        if (dataSet.moveNext())
            return dataSet.name;
        end;

        return "";
    end;

    /**
     *  Заполнить значения для всех объектов класса ExportValue, значениями аттрибутов отчета. По имеющейся у них мета информации.
     *
     */
    private macro fill()
        var fiCode    = m_compositeValue.fieldValue("fiCode").currentAsString;

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");

        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_okatoCode;

        macro getFieldValue(fieldId : String) : String
            var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

            if (userInputCompositeValue != null)
                return userInputCompositeValue.fieldValue(fieldId).currentAsString;
            end;

            return "";
        end;


        macro setValue(expValue : ExportValue)
            macro getBackOfficeValue(boId : Integer)
                var keyValue  = m_compositeValue.createKeyValue();
                keyValue.fieldValue("okatoCode")  = m_okatoCode;
                keyValue.fieldValue("part")       = expValue.getPart();
                keyValue.fieldValue("code")       = expValue.getCode();
                keyValue.fieldValue("fiCode")     = m_fiCode;
                keyValue.fieldValue("backOffice") = boId;

                var compositeValue = m_compositeValue.findValue(keyValue);

                if (compositeValue != null)
                    return compositeValue.fieldValue(ternary(expValue.isItemValue(), "itemValue", "moneyValue")).current;
                end;

                return 0.0;
            end;
            var value = getBackOfficeValue(BOCB) + getBackOfficeValue(BORETAIL);

            if (expValue.isItemValue())
                expValue.setValue(String(value:0:0));
            else
                expValue.setValue(String(value:0:3));
            end;
        end;

        var i : Integer = 0;
        while (i < m_exportValueList.size)

            if   (m_exportValueList[i].getPart() == "OKATO")
                m_exportValueList[i].setValue(strRpad(substr(m_okatoCode, 1, 4), 4, "0"));
            elif (m_exportValueList[i].getPart() == "nExchPoints")
                m_exportValueList[i].setValue(getFieldValue("nExchPoints"));
            elif (m_exportValueList[i].getPart() == "nVsp")
                m_exportValueList[i].setValue(getFieldValue("nVsp"));
            elif (m_exportValueList[i].getPart() == "fiCode")
                m_exportValueList[i].setValue(m_fiCode);
            elif (m_exportValueList[i].getPart() == "fiName")
                m_exportValueList[i].setValue(getFiName(m_fiCode));
            elif (m_exportValueList[i].getPart() == "CONST_0")
                m_exportValueList[i].setValue("0");
            elif (m_exportValueList[i].getPart() == "CONST_1")
                m_exportValueList[i].setValue("1");
            elif (m_exportValueList[i].getPart() == "")
                m_exportValueList[i].setValue("");
            else
                setValue(@m_exportValueList[i]);
            end;

            i = i + 1;
        end;

    end;

    /**
     *  Инициализация. Чисто виртуальный метод, необходимо переопределять.
     */
    private macro initialize()
    end;

    /**
     *  Вызов инициализацирующего метода.
     */
    initialize();
end;

/**
 *  Класс для создания массива экспортируемых значений, одной строки в файле экспорта, для итоговой части отчета.
 */
class (ExportValueArrayCreator) ExportTotalValueArrayCreator(fiCode : String, compositeValue : Object)

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.9");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.9");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator(fiCode, compositeValue);
end;

/**
 *  Класс для создания массива экспортируемых значений, одной строки в файле экспорта, для части отчета по ОКАТО.
 */
class (ExportValueArrayCreator) ExportOkatoPartValueArrayCreator(fiCode : String, compositeValue : Object, isSubRow : Bool)

    /**
     *  Является ли экспортируемая строка, подстрокой.
     */
    private var m_isSubRow        : Bool   = isSubRow;

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "OKATO"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "nExchPoints"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "nVsp"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.9");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.9");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "CONST_0", "CONST_1"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator(fiCode, compositeValue);
end;

/**
 *  Класс операции экспорта в kliko.exe.
 */
class TKlikoExportOperation()

    private var m_report         : TReport      = objectFactoryInstance.createReport();
    /**
     *  Ссылка на представление экспорта в kliko.exe
     */
    private var m_klikoView      : TRcbKlikoView = TRcbKlikoView("601", global.getRcbReport().context.period.endDate);

    /**
     *  Ссылка на представление протокола экспорта в kliko.exe
     */
    private var m_protocolView   : TProtocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

    /**
     *  Ссылка на сумматор значений для экспорта
     */
    private var m_valueSummator  : Summator  = null;


    private macro getDescriptorInfo()
        return "";
    end;

    /**
     *  Экспорт нулевого отчета
     *
     */
    private macro exportNullData()
        m_klikoView.printHead("F601_1");
        m_klikoView.printRow("Данные отсутствуют", "0", "1", "1", "");
    end;

    /**
     *  Экспорт части <601_1>.
     *
     */
    private macro export601_1()
        m_klikoView.printHead("F601_1");
        var nDepartments : String = "1";

        if (global.getRcbReport().attributeValue("ЧислоФилиалов").isDefined())
            nDepartments = global.getRcbReport().attributeValue("ЧислоФилиалов").currentAsString;
        end;

        m_klikoView.printRow("Число филиалов, осуществлявших операции с наличной ин.валютой", nDepartments, "2", "1", "");

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");
        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_report.getTotalPart().getOkatoCode();
        var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

        macro getFieldValue(fieldId : String) : String

            if (userInputCompositeValue != null)
                userInputCompositeValue.fieldValue(fieldId).currentAsString;
            end;

            return "";
        end;

        m_klikoView.printRow("I. Количество обменных пунктов", getFieldValue("nExchPoints"), "2", "2", "");
        m_klikoView.printRow("II. Количество внутренних структурных подразделений", getFieldValue("nVsp"), "2", "3", "");
        m_klikoView.printRow("III. Количество операционных касс кассового узла", getFieldValue("nOperCash"), "2", "4", "");
    end;

    /**
     *  Экспорт части <601_N>.
     *
     */
    private macro export601_N()
        var valueArray     : TArray        = null;
        var fiCodeIterator = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();

        m_klikoView.printHead("F601_N");

        var attributeValue = global.getRcbReport().attributeValue("ИтоговаяЧасть");
        var keyValue       = attributeValue.createKeyValue();
        keyValue.fieldValue("okatoCode")  = m_report.getTotalPart().getOkatoCode();

        var compositeValue = attributeValue.findValue(keyValue);

        m_valueSummator = SummatorTotalPart();
        fiCodeIterator.moveFirst();
        while (not fiCodeIterator.isDone())
            valueArray = ExportTotalValueArrayCreator(fiCodeIterator.currentItem.fieldValue("code").currentAsString, compositeValue).getValueArray();
            m_klikoView.printRow(valueArray);
            m_valueSummator = m_valueSummator.add(valueArray);
            fiCodeIterator.moveNext();
        end;
        m_klikoView.printRow(m_valueSummator.getValueArray());
    end;

    /**
     *  Экспорт части <601_2>.
     *
     */
    private macro export601_2()
        var valueArray     : TArray        = null;
        var fiCodeIterator    = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();
        var okatoCodeIterator = global.getRcbReport().attributeValue("КодыОКАТО").createValueIterator();

        m_klikoView.printHead("F601_2");
        var isFirst : Bool    = true;

        var attributeValue = global.getRcbReport().attributeValue("ЧастьПоОКАТО");
        var keyValue       = attributeValue.createKeyValue();


        okatoCodeIterator.moveFirst();
        while (not okatoCodeIterator.isDone())
            m_valueSummator = SummatorOkatoPart();
            fiCodeIterator.moveFirst();
            isFirst = true;
            while (not fiCodeIterator.isDone())
                keyValue.fieldValue("okatoCode") = okatoCodeIterator.currentItem.fieldValue("code").currentAsString;

                valueArray = ExportOkatoPartValueArrayCreator(fiCodeIterator.currentItem.fieldValue("code").currentAsString, attributeValue.findValue(keyValue), not isFirst).getValueArray();
                m_klikoView.printRow(valueArray);
                m_valueSummator = m_valueSummator.add(valueArray);
                fiCodeIterator.moveNext();
                isFirst = false;
            end;
            m_klikoView.printRow(m_valueSummator.getValueArray());
            okatoCodeIterator.moveNext();
        end;
    end;

    /**
     *  Выполнить экспорт.
     *
     */
    macro execute()
        m_klikoView.setOutputFile();

        if (m_report.isNullData())
            exportNullData();
        else
            export601_1();
            export601_N();
            export601_2();
        end;

        m_klikoView.resetOutputFile();

        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        m_protocolView.printLine("Файл экспорта: " + m_klikoView.getFileName());
        m_protocolView.printLine("");
        m_protocolView.printLine("Выгружено строк: " + (m_klikoView.getRowsCount() + m_klikoView.getHeadsCount()));
        m_protocolView.printLine(" содержательных: " + m_klikoView.getRowsCount());
        m_protocolView.printLine("      служебных: " + m_klikoView.getHeadsCount());

        m_protocolView.resetProtocolOutput();
    end;
end;



/**
 *  Класс для суммирования данных итоговой части для экспорта итоговой строки.
 */
private class (Summator) SummatorTotalPart2539()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

private class (Summator) SummatorTotalPart3468()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

/**
 *  Класс для суммирования данных части по ОКАТО для экспорта итоговой строки.
 */
private class (Summator) SummatorOkatoPart2539()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

private class (Summator) SummatorOkatoPart3468()

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "Итого";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "";
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = 0;
        m_valueArray[m_valueArray.size] = "1";
        m_valueArray[m_valueArray.size] = "2";
        m_valueArray[m_valueArray.size] = "";
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initSummator();
end;

/**
 *  Базовый класс для создания массива экспортируемых значений, одной строки в файле экспорта.
 */
class (ExportValueArrayCreator) ExportValueArrayCreator2539(fiCode : String, compositeValue : Object)
    initExportValueArrayCreator(fiCode, compositeValue);

    /**
     *  Заполнить значения для всех объектов класса ExportValue, значениями аттрибутов отчета. По имеющейся у них мета информации.
     *
     */
    private macro fill()
        var fiCode    = m_compositeValue.fieldValue("fiCode").currentAsString;

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");

        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_okatoCode;

        macro getFieldValue(fieldId : String) : String
            var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

            if (userInputCompositeValue != null)
                return userInputCompositeValue.fieldValue(fieldId).currentAsString;
            end;

            return "";
        end;


        macro setValue(expValue : ExportValue)
            macro getBackOfficeValue(boId : Integer)
                var keyValue  = m_compositeValue.createKeyValue();
                keyValue.fieldValue("okatoCode")  = m_okatoCode;
                keyValue.fieldValue("part")       = expValue.getPart();
                keyValue.fieldValue("code")       = expValue.getCode();
                keyValue.fieldValue("fiCode")     = m_fiCode;
                keyValue.fieldValue("backOffice") = boId;

                var compositeValue = m_compositeValue.findValue(keyValue);

                if (compositeValue != null)
                    return compositeValue.fieldValue(ternary(expValue.isItemValue(), "itemValue", "moneyValue")).current;
                end;

                return 0.0;
            end;
            var value = getBackOfficeValue(BOCB) + getBackOfficeValue(BORETAIL);

            expValue.setValue(String(value:0:3));

        end;

        var i : Integer = 0;
        while (i < m_exportValueList.size)

            if   (m_exportValueList[i].getPart() == "OKATO")
                m_exportValueList[i].setValue(strRpad(substr(m_okatoCode, 1, 4), 4, "0"));
            elif (m_exportValueList[i].getPart() == "nVsp")
                m_exportValueList[i].setValue(getFieldValue("nVsp"));
            elif (m_exportValueList[i].getPart() == "fiCode")
                m_exportValueList[i].setValue(m_fiCode);
            elif (m_exportValueList[i].getPart() == "fiName")
                m_exportValueList[i].setValue(getFiName(m_fiCode));
            elif (m_exportValueList[i].getPart() == "CONST_0")
                m_exportValueList[i].setValue("0");
            elif (m_exportValueList[i].getPart() == "CONST_1")
                m_exportValueList[i].setValue("1");
            elif (m_exportValueList[i].getPart() == "")
                m_exportValueList[i].setValue("");
            else
                setValue(@m_exportValueList[i]);
            end;

            i = i + 1;
        end;

    end;
end;

class (ExportValueArrayCreator) ExportValueArrayCreator3468(fiCode : String, compositeValue : Object)
    initExportValueArrayCreator(fiCode, compositeValue);

    /**
     *  Заполнить значения для всех объектов класса ExportValue, значениями аттрибутов отчета. По имеющейся у них мета информации.
     *
     */
    private macro fill()
        var fiCode    = m_compositeValue.fieldValue("fiCode").currentAsString;

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");

        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_okatoCode;

        macro getFieldValue(fieldId : String) : String
            var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

            if (userInputCompositeValue != null)
                return userInputCompositeValue.fieldValue(fieldId).currentAsString;
            end;

            return "";
        end;


        macro setValue(expValue : ExportValue)
            macro getBackOfficeValue(boId : Integer)
                var keyValue  = m_compositeValue.createKeyValue();
                keyValue.fieldValue("okatoCode")  = m_okatoCode;
                keyValue.fieldValue("part")       = expValue.getPart();
                keyValue.fieldValue("code")       = expValue.getCode();
                keyValue.fieldValue("fiCode")     = m_fiCode;
                keyValue.fieldValue("backOffice") = boId;

                var compositeValue = m_compositeValue.findValue(keyValue);

                if (compositeValue != null)
                    return compositeValue.fieldValue(ternary(expValue.isItemValue(), "itemValue", "moneyValue")).current;
                end;

                return 0.0;
            end;
            var value = /* getBackOfficeValue(BOCB) + getBackOfficeValue(BORETAIL) +  */getBackOfficeValue(0);

            expValue.setValue(String(value:0:3));

        end;

        var i : Integer = 0;
        while (i < m_exportValueList.size)

            if   (m_exportValueList[i].getPart() == "OKATO")
                m_exportValueList[i].setValue(strRpad(substr(m_okatoCode, 1, 4), 4, "0"));
            elif (m_exportValueList[i].getPart() == "nVsp")
                m_exportValueList[i].setValue(getFieldValue("nVsp"));
            elif (m_exportValueList[i].getPart() == "fiCode")
                m_exportValueList[i].setValue(m_fiCode);
            elif (m_exportValueList[i].getPart() == "fiName")
                m_exportValueList[i].setValue(getFiName(m_fiCode));
            elif (m_exportValueList[i].getPart() == "CONST_0")
                m_exportValueList[i].setValue("0");
            elif (m_exportValueList[i].getPart() == "CONST_1")
                m_exportValueList[i].setValue("1");
            elif (m_exportValueList[i].getPart() == "")
                m_exportValueList[i].setValue("");
            else
                setValue(@m_exportValueList[i]);
            end;

            i = i + 1;
        end;

    end;
end;

/**
 *  Класс для создания массива экспортируемых значений, одной строки в файле экспорта, для итоговой части отчета.
 */
class (ExportValueArrayCreator2539) ExportTotalValueArrayCreator2539(fiCode : String, compositeValue : Object)

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator2539(fiCode, compositeValue);
end;

class (ExportValueArrayCreator3468) ExportTotalValueArrayCreator3468(fiCode : String, compositeValue : Object)

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator3468(fiCode, compositeValue);
end;

/**
 *  Класс для создания массива экспортируемых значений, одной строки в файле экспорта, для части отчета по ОКАТО.
 */
class (ExportValueArrayCreator2539) ExportOkatoPartValueArrayCreator2539(fiCode : String, compositeValue : Object, isSubRow : Bool)
    /**
     *  Является ли экспортируемая строка, подстрокой.
     */
    private var m_isSubRow        : Bool   = isSubRow;

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "OKATO"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "nVsp"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "CONST_0", "CONST_1"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "CONST_1", ""), "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator2539(fiCode, compositeValue);
end;

class (ExportValueArrayCreator3468) ExportOkatoPartValueArrayCreator3468(fiCode : String, compositeValue : Object, isSubRow : Bool)
    /**
     *  Является ли экспортируемая строка, подстрокой.
     */
    private var m_isSubRow        : Bool   = isSubRow;

    /**
     *  Инициализация.
     */
    private macro initialize()
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "OKATO"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "", "nVsp"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiCode", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("fiName", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "1.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "2.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "3.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.4.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.7.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "4.8");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.2");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "5.3");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("1", "6.1");
        m_exportValueList[m_exportValueList.size] = ExportValue("", "");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "4");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "5");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "6");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "7");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "8");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.1", "9");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "10");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "11");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "12");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "13");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "14");
        m_exportValueList[m_exportValueList.size] = ExportValue("2.2", "15");
        m_exportValueList[m_exportValueList.size] = ExportValue("CONST_1", "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "CONST_0", "CONST_1"), "");
        m_exportValueList[m_exportValueList.size] = ExportValue(ternary(m_isSubRow, "CONST_1", ""), "");

        fill();
    end;

    /**
     *  Вызов конструктора базового класса.
     */
    initExportValueArrayCreator3468(fiCode, compositeValue);
end;

/**
 *  Класс операции экспорта в kliko.exe.
 */
class (TKlikoExportOperation) TKlikoExportOperation2539()

    initTKlikoExportOperation();

    private macro getDescriptorInfo()
        return "f601_11.pak от 25.01.2011";
    end;

    /**
     *  Экспорт части <601_1>.
     *
     */
    private macro export601_1()
        m_klikoView.printHead("F601_1");
        var nDepartments : String = "1";

        if (global.getRcbReport().attributeValue("ЧислоФилиалов").isDefined())
            nDepartments = global.getRcbReport().attributeValue("ЧислоФилиалов").current;
        end;

        m_klikoView.printRow("Число филиалов, осуществлявших операции с наличной ин.валютой", String(nvl(nDepartments, 0)), "2", "1", "");

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");
        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_report.getTotalPart().getOkatoCode();
        var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

        macro getFieldValue(fieldId : String)

            if (userInputCompositeValue != null)
                return userInputCompositeValue.fieldValue(fieldId).current;
            end;

            return 0;
        end;

        m_klikoView.printRow("I. Количество внутренних структурных подразделений", String(nvl(getFieldValue("nVsp"), 0)), "2", "2", "");
        m_klikoView.printRow("II. Количество операционных касс кассового узла", String(nvl(getFieldValue("nOperCash"), 0)), "2", "3", "");
    end;

    /**
     *  Экспорт части <601_N>.
     *
     */
    private macro export601_N()
        var valueArray     : TArray        = null;
        var fiCodeIterator = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();

        m_klikoView.printHead("F601_N");

        var attributeValue = global.getRcbReport().attributeValue("ИтоговаяЧасть");
        var keyValue       = attributeValue.createKeyValue();
        keyValue.fieldValue("okatoCode")  = m_report.getTotalPart().getOkatoCode();

        var compositeValue = attributeValue.findValue(keyValue);

        m_valueSummator = SummatorTotalPart2539();
        fiCodeIterator.moveFirst();
        while (not fiCodeIterator.isDone())
            valueArray = ExportTotalValueArrayCreator2539(fiCodeIterator.currentItem.fieldValue("code").currentAsString, compositeValue).getValueArray();
            m_klikoView.printRow(valueArray);
            m_valueSummator = m_valueSummator.add(valueArray);
            fiCodeIterator.moveNext();
        end;
        m_klikoView.printRow(m_valueSummator.getValueArray());
    end;

    /**
     *  Экспорт части <601_2>.
     *
     */
    private macro export601_2()
        var valueArray : TArray = null;
        var fiCodeIterator      = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();
        var okatoCodeIterator   = global.getRcbReport().attributeValue("КодыОКАТО").createValueIterator();

        m_klikoView.printHead("F601_2");
        var isFirst : Bool    = true;

        var attributeValue = global.getRcbReport().attributeValue("ЧастьПоОКАТО");
        var keyValue       = attributeValue.createKeyValue();


        okatoCodeIterator.moveFirst();
        while (not okatoCodeIterator.isDone())
            m_valueSummator = SummatorOkatoPart2539();
            fiCodeIterator.moveFirst();
            isFirst = true;
            while (not fiCodeIterator.isDone())
                keyValue.fieldValue("okatoCode") = okatoCodeIterator.currentItem.fieldValue("code").currentAsString;

                valueArray = ExportOkatoPartValueArrayCreator2539(fiCodeIterator.currentItem.fieldValue("code").currentAsString, attributeValue.findValue(keyValue), not isFirst).getValueArray();
                m_klikoView.printRow(valueArray);
                m_valueSummator = m_valueSummator.add(valueArray);
                fiCodeIterator.moveNext();
                isFirst = false;
            end;
            m_klikoView.printRow(m_valueSummator.getValueArray());
            okatoCodeIterator.moveNext();
        end;
    end;

    /**
     *  Выполнить экспорт.
     *
     */
    macro execute()
        m_klikoView.setOutputFile();

        if (m_report.isNullData())
            exportNullData();
        else
            export601_1();
            export601_N();
            export601_2();
        end;

        m_klikoView.resetOutputFile();

        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        m_protocolView.printLine("Файл экспорта: " + m_klikoView.getFileName());
        m_protocolView.printLine("");
        m_protocolView.printLine("Выгружено строк: " + (m_klikoView.getRowsCount() + m_klikoView.getHeadsCount()));
        m_protocolView.printLine(" содержательных: " + m_klikoView.getRowsCount());
        m_protocolView.printLine("      служебных: " + m_klikoView.getHeadsCount());

        m_protocolView.resetProtocolOutput();
    end;
end;

class (TKlikoExportOperation) TKlikoExportOperation3468()

    initTKlikoExportOperation();

    private macro getDescriptorInfo()
        return "F601_16.PAK от 17.02.2015";
    end;

    macro allNull(valueArray, beginPos)
        var i = beginPos;

        while (i < valueArray.size - 3)
            if (valueArray[i] == "")
                i = i + 1;
                continue;
            end;

            if (double(valueArray[i]) != 0)
                return false;
            end;

            i = i + 1;
        end;

        return true;
    end;
    /**
     *  Экспорт части <601_1>.
     *
     */
    private macro export601_1()
        m_klikoView.printHead("F601_1");
        var nDepartments : String = "1";

        if (global.getRcbReport().attributeValue("ЧислоФилиалов").isDefined())
            nDepartments = global.getRcbReport().attributeValue("ЧислоФилиалов").current;
        end;

        m_klikoView.printRow("Число филиалов, осуществлявших операции с наличной ин.валютой", String(nvl(nDepartments, 0)), "2", "1", "");

        var userInputAttributeValue = global.getRcbReport().attributeValue("ПользовательскийВвод");
        var userInputKeyValue       = userInputAttributeValue.createKeyValue();

        userInputKeyValue.fieldValue("okatoCode") = m_report.getTotalPart().getOkatoCode();
        var userInputCompositeValue = userInputAttributeValue.findValue(userInputKeyValue);

        macro getFieldValue(fieldId : String)

            if (userInputCompositeValue != null)
                return userInputCompositeValue.fieldValue(fieldId).current;
            end;

            return 0;
        end;

        m_klikoView.printRow("I. Количество внутренних структурных подразделений", String(nvl(getFieldValue("nVsp"), 0)), "2", "2", "");
        m_klikoView.printRow("II. Количество операционных касс кассового узла", String(nvl(getFieldValue("nOperCash"), 0)), "2", "3", "");
    end;

    /**
     *  Экспорт части <601_N>.
     *
     */
    private macro export601_N()
        var valueArray     : TArray        = null;
        var fiCodeIterator = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();

        m_klikoView.printHead("F601_N");

        var attributeValue = global.getRcbReport().attributeValue("ИтоговаяЧасть");
        var keyValue       = attributeValue.createKeyValue();
        keyValue.fieldValue("okatoCode")  = m_report.getTotalPart().getOkatoCode();

        var compositeValue = attributeValue.findValue(keyValue);

        m_valueSummator = SummatorTotalPart3468();
        fiCodeIterator.moveFirst();

        while (not fiCodeIterator.isDone())
            valueArray = ExportTotalValueArrayCreator3468(fiCodeIterator.currentItem.fieldValue("code").currentAsString, compositeValue).getValueArray();

            if (not allNull(valueArray, 2))
                m_klikoView.printRow(valueArray);
                m_valueSummator = m_valueSummator.add(valueArray);
            end;
            fiCodeIterator.moveNext();
        end;
        m_klikoView.printRow(m_valueSummator.getValueArray());
    end;

    /**
     *  Экспорт части <601_2>.
     *
     */
    private macro export601_2()
        var valueArray : TArray = null;
        var fiCodeIterator      = global.getRcbReport().attributeValue("КодыФИ").createValueIterator();
        var okatoCodeIterator   = global.getRcbReport().attributeValue("КодыОКАТО").createValueIterator();

        m_klikoView.printHead("F601_2");
        var isFirst : Bool    = true;

        var attributeValue = global.getRcbReport().attributeValue("ЧастьПоОКАТО");
        var keyValue       = attributeValue.createKeyValue();

        okatoCodeIterator.moveFirst();
        while (not okatoCodeIterator.isDone())
            m_valueSummator = SummatorOkatoPart3468();
            fiCodeIterator.moveFirst();
            isFirst = true;
            while (not fiCodeIterator.isDone())
                keyValue.fieldValue("okatoCode") = okatoCodeIterator.currentItem.fieldValue("code").currentAsString;

                valueArray = ExportOkatoPartValueArrayCreator3468(fiCodeIterator.currentItem.fieldValue("code").currentAsString, attributeValue.findValue(keyValue), not isFirst).getValueArray();
                if (not allNull(valueArray, 4))
                    m_klikoView.printRow(valueArray);
                    m_valueSummator = m_valueSummator.add(valueArray);
                end;
                fiCodeIterator.moveNext();
                isFirst = false;
            end;
            m_klikoView.printRow(m_valueSummator.getValueArray());
            okatoCodeIterator.moveNext();
        end;
    end;

    /**
     *  Выполнить экспорт.
     *
     */
    macro execute()
        m_klikoView.setOutputFile();

        if (m_report.isNullData())
            exportNullData();
        else
            export601_1();
            export601_N();
            export601_2();
        end;

        m_klikoView.resetOutputFile();

        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        m_protocolView.printLine("Файл экспорта: " + m_klikoView.getFileName());
        m_protocolView.printLine("");
        m_protocolView.printLine("Выгружено строк: " + (m_klikoView.getRowsCount() + m_klikoView.getHeadsCount()));
        m_protocolView.printLine(" содержательных: " + m_klikoView.getRowsCount());
        m_protocolView.printLine("      служебных: " + m_klikoView.getHeadsCount());

        m_protocolView.resetProtocolOutput();
    end;
end;