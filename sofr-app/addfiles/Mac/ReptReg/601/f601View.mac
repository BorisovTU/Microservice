/*
$Name:          f601View.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 601. Классы представления отчета
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 601. Классы представления отчета.

   CREATED : 13.12.07 Ser.
             05.08.2015 ABP Представления переведены на WindowsReports и CTableReport.
                            Код позаимствован из pr_accstatement.mac и доработан
└─────────────────────────────────────────────────────────────────────────- */
/**
 *  Общебанковские интеры и модули
 */
import or_rep_h;
/**
 *  Интеры и модели подсистемы
 */
import rcbPrintableView;
import rcbTemplateTable;
import CompositeTableField;
import Ofstream;

/**
 * Представление формы 601.
 * Используется модифицированный механизм печати по шаблону (prnfrm.d32) для
 * возможности печати таблиц с переменным количеством столбцов или колонок.
 * См. класс ReportBase::TTemplateTable.
 * Библиотека ресурсов F601Template1881.tpl.
 */
class (TPrintableView) TView601()
    /**
     * Конструктор базового объекта
     */
    initTPrintableView("ОТЧЕТ  ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", RCB_PK_MONTH, DATE_IN_PERIOD_FORMAT);

    /**
     * Признак отчета с нулевыми показателями
     */
    private var m_isEmpty : Bool =  false;

    /**
     * Таблица для реализации setFieldValue, хранит ссылку на текущую таблицу.
     */
    private var m_table : TTemplateTable   = null;
    /**
     * Таблица раздела 1.
     */
    private var m_table0 : TTemplateTable  = null;

    /**
     * Таблица раздела 1.
     */
    private var m_table1 : TTemplateTable  = null;

    /**
     * Таблица раздела 2.1.
     */
    private var m_table21 : TTemplateTable = null;

    /**
     * Таблица раздела 2.2.
     */
    private var m_table22 : TTemplateTable = null;

    /**
     * Напечатать зону кодов кредитной организации.
     */
    macro printLendingAgencyCodeZone()
        // Спецификация:
        //     К стандартной таблице кодов (см. реализцию метода базового класса)
        //     добавляется еще одна колонка:
        //
        //     Число филиалов,
        //     осуществлявших операции
        //     с наличной иностранной валютой
        var nBranch = global.getRcbReport().attributeValue("ЧислоФилиалов").current;

        var okato = strAlign(Код_СОАТО,                15, STR_ALIGN_CENTER);
        var okpo  = strAlign(Код_ОКПО,                 9,  STR_ALIGN_CENTER);
        var ogrn  = strAlign(ОГРН,                     24, STR_ALIGN_CENTER);
        var rnb   = strAlign(РегНомерБанка,            15, STR_ALIGN_CENTER);
        var bik   = strAlign({MFO_Bank},               12, STR_ALIGN_CENTER);
        nBranch   = strAlign(String(nvl(nBranch, "")), 23, STR_ALIGN_CENTER);

        println();
        println(strAlign("Банковская отчетность", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌───────────────┬───────────────────────────────────────────────────────────────┬───────────────────────┐", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│      Код      │       Код кредитной организации (филиала)                     │Число филиалов,        │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│   территории  ├─────────┬────────────────────────┬───────────────┬────────────┤осуществлявших операции│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО   │ по ОКПО │основной государственный│регистрационный│    БИК     │с наличной иностранной │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│               │         │  регистрационный номер │    номер      │            │валютой                │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("├───────────────┼─────────┼────────────────────────┼───────────────┼────────────┼───────────────────────┤", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│" + okato +   "│"+okpo+ "│"      + ogrn +        "│"   + rnb +   "│" + bik +  "│"    + nBranch +      "│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("└───────────────┴─────────┴────────────────────────┴───────────────┴────────────┴───────────────────────┘", m_standardZoneWidth, STR_ALIGN_RIGHT));
    end;

    /**
     * Начать печать отчета.
     *
     * @param     isEmpty   пуст ли отчет?
     */
    macro beginReport(isEmpty : bool)
        m_isEmpty = isEmpty;
    end;

    /**
     * Окончание отчета.
     */
    macro endReport()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начать часть по ОКАТО.
     */
    macro beginOkatoPart()
        // Спецификация:
        //     1. Напечатать таблицу кодов КО (printLendingAgencyCodeZone).
        //     2. Напечатать зону наименований отчета (printNamesZone).
        //     3. Загрузить ресурс Description.
        //     4. Вызовы setFieldValue реализовать как задание значений полям
        //        загруженного ресурса.

        m_table0 = THorizontalTemplateTable("F601Template1881.tpl");
        m_table0.beginHead("Description");
        m_table0.setDefaultValue("");
        m_table = m_table0;
    end;

    /**
     * Окончание печати части отчета по ОКАТО.
     */
    macro endOkatoPart()
        // Спецификация:
        //      1. Получить ширину таблиц m_table1, m_table21, m_table21.
        //      2. Выбрать максимальную из них - это будет ширина отчета.
        //      3. Напечатать название раздела 1: <Раздел 1. Операции уполномоченного
        //         банка (его филиала) с наличной иностранной валютой и чеками
        //         в иностранной валюте>, выравненное по середине отчета.
        //      4. Напечатать таблицу m_table1, выровненную по правому краю отчета.
        //      5. Напечатать название раздела 2: <Раздел 2. Справочная информация
        //         об операциях физических лиц с наличной иностранной валютой>,
        //         выровненное по центру отчета.
        //      6. Напечатать название раздела 2.1: <2.1. Поступление в уполномоченный
        //         банк (его филиал) наличной иностранной валюты>, выровненное по
        //         центру отчета.
        //      7. Напечатать таблицу m_table21, выровненную по правому краю отчета.
        //      8. Напечатать название раздела 2.2: <2.2. Расходование уполномоченным
        //         банком (его филиалом) наличной иностранной валюты >, выровненное по
        //         центру отчета.
        //      9. Напечатать таблицу m_table22, выровненную по правому краю отчета.
        //     10. Напечатать зону подписей отчета (printSignatureZone).

        var reportWidth = max(m_table1.getWidth(), max(m_table21.getWidth(), m_table22.getWidth()));

        setReportWidth(reportWidth);

        printLendingAgencyCodeZone();
        printNamesZone();

        m_table0.endHead();
        m_table0.addTo(null, reportWidth);

        println();
        println(strAlign("Раздел 1. Операции уполномоченного  банка (его филиала) с наличной иностранной валютой и чеками в иностранной валюте", reportWidth, STR_ALIGN_CENTER));
        m_table1.addTo(null,  reportWidth);

        println();
        println(strAlign("Раздел 2. Справочная информация об операциях физических лиц с наличной иностранной валютой", reportWidth, STR_ALIGN_CENTER));
        println();
        println(strAlign("2.1. Поступление в уполномоченный банк (его филиал) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table21.addTo(null, reportWidth);

        println();
        println(strAlign("2.2. Расходование уполномоченным банком (его филиалом) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table22.addTo(null, reportWidth);

        printSignatureZone();
    end;

    /**
     * Начать раздел 1.
     */
    macro beginPart1()
        // Спецификация:
        //     1. Создать объект m_table1 класса TVerticalTemplateTable.
        //     2. Вызвать у него метод beginHead("IndicatorsNames1").
        //     3. Вызвать у него метод endHead().

        m_table1 = TVerticalTemplateTable("F601Template1881.tpl");
        m_table1.beginHead("IndicatorsNames1");
        m_table1.endHead();
    end;

    /**
     * Окончание печати раздела 1.
     */
    macro endPart1()
        // Спецификация:
        //     1. Вызвать метод beginBottom("VerticalTerminator1") у объекта m_table1.
        //     2. Вызвать метод endBottom() у объекта m_table1.

        m_table1.beginBottom("VerticalTerminator1");
        m_table1.endBottom();
    end;

    /**
     * Начало печати второго раздела.
     */
    macro beginPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Окончание второго раздела.
     */
    macro endPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начало печати раздела 2.1.
     */
    macro beginPart21()
        // Спецификация:
        //     1. Создать объект m_table21 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head21").
        //     3. Вызвать у него метод endHead().

        m_table21 = THorizontalTemplateTable("F601Template1881.tpl");
        m_table21.beginHead("Head21");
        m_table21.endHead();
    end;

    /**
     * Окончание раздела 2.1.
     */
    macro endPart21()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table21.
        //     2. Вызвать метод endBottom() у объекта m_table21.
        m_table21.beginBottom("Bottom2");
        m_table21.endBottom();
    end;

    /**
     * Начало печати раздела 2.2.
     */
    macro beginPart22()
        // Спецификация:
        //     1. Создать объект m_table22 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head22").
        //     3. Вызвать у него метод endHead().

        m_table22 = THorizontalTemplateTable("F601Template1881.tpl");
        m_table22.beginHead("Head22");
        m_table22.endHead();
    end;

    /**
     * Окончание раздела 2.2.
     */
    macro endPart22()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table22.
        //     2. Вызвать метод endBottom() у объекта m_table22.

        m_table22.beginBottom("Bottom2");
        m_table22.endBottom();
    end;

    /**
     * Начало обработки колонки по валюте в первом разделе.
     */
    macro beginCurrencyColumn1()
        // Спецификация:
        //     1. Вызвать метод beginRow("CurrencyColumn1") у объекта m_table1.
        //     2. Вызовы setFieldValue реализовать как m_table1.getField(fieldName).value = value.

        m_table1.beginRow("CurrencyColumn1");
        m_table1.setDefaultValue("");
        m_table = m_table1;
    end;

    /**
     * Окончание обработки колонки по валюте в первом разделе.
     */
    macro endCurrencyColumn1()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table1.

        m_table1.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.1.
     */
    macro beginCurrencyRow21()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row21") у объекта m_table21.
        //     2. Вызовы setFieldValue реализовать как m_table21.getField(fieldName).value = value.

        m_table21.beginRow("Row21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки строки по валюте в разделе 2.1.
     */
    macro endCurrencyRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.1.
     */
    macro beginTotalRow21()
        m_table21.beginRow("TotalRow21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.1.
     */
    macro endTotalRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.2.
     */
    macro beginCurrencyRow22()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row22") у объекта m_table22.
        //     2. Вызовы setFieldValue реализовать как m_table22.getField(fieldName).value = value.

        m_table22.beginRow("Row22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.2.
     */
    macro endCurrencyRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.2.
     */
    macro beginTotalRow22()
        m_table22.beginRow("TotalRow22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки колонки по валюте в разделе 2.2.
     */
    macro endTotalRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Установить значение поля отчета.
     *
     * @param     fieldName имя поля представления
     * @param     value значение поля
     */
    macro setFieldValue(fieldName : String, value)
        // Спецификация:
        //     Задать значение поля текущему шаблону.

        m_table.getField(fieldName).value = value;
    end;

    macro getCurrentTableRowsCount()

        if (m_table != null)
            return m_table.getRowsCount();
        end;

        return 0;
    end;
end;

/**
 * Представление формы 601.
 * Используется модифицированный механизм печати по шаблону (prnfrm.d32) для
 * возможности печати таблиц с переменным количеством столбцов или колонок.
 * См. класс ReportBase::TTemplateTable.
 * Библиотека ресурсов F601Template2332.tpl.
 */
class (TPrintableView_2332) TView601_2332()
    /**
     * Конструктор базового объекта
     */
    initTPrintableView_2332("ОТЧЕТ  ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", RCB_PK_MONTH, DATE_IN_PERIOD_FORMAT);

    /**
     * Признак отчета с нулевыми показателями
     */
    private var m_isEmpty : Bool =  false;

    /**
     * Таблица для реализации setFieldValue, хранит ссылку на текущую таблицу.
     */
    private var m_table : TTemplateTable   = null;
    /**
     * Таблица раздела 1.
     */
    private var m_table0 : TTemplateTable  = null;

    /**
     * Таблица раздела 1.
     */
    private var m_table1 : TTemplateTable  = null;

    /**
     * Таблица раздела 2.1.
     */
    private var m_table21 : TTemplateTable = null;

    /**
     * Таблица раздела 2.2.
     */
    private var m_table22 : TTemplateTable = null;

    /**
     * Напечатать зону кодов кредитной организации.
     */
    macro printLendingAgencyCodeZone()
        // Спецификация:
        //     К стандартной таблице кодов (см. реализцию метода базового класса)
        //     добавляется еще одна колонка:
        //
        //     Число филиалов,
        //     осуществлявших операции
        //     с наличной иностранной валютой
        var nBranch = global.getRcbReport().attributeValue("ЧислоФилиалов").current;

        var okato = strAlign(Код_СОАТО,                15, STR_ALIGN_CENTER);
        var okpo  = strAlign(Код_ОКПО,                 9,  STR_ALIGN_CENTER);
        var ogrn  = strAlign(ОГРН,                     24, STR_ALIGN_CENTER);
        var rnb   = strAlign(РегНомерБанка,            15, STR_ALIGN_CENTER);
        var bik   = strAlign({MFO_Bank},               12, STR_ALIGN_CENTER);
        nBranch   = strAlign(String(nvl(nBranch, "")), 23, STR_ALIGN_CENTER);

        println();
        println(strAlign("Банковская отчетность", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌───────────────┬───────────────────────────────────────────────────────────────┬───────────────────────┐", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│      Код      │       Код кредитной организации (филиала)                     │Число филиалов,        │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│   территории  ├─────────┬────────────────────────┬───────────────┬────────────┤осуществлявших операции│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО   │ по ОКПО │основной государственный│регистрационный│    БИК     │с наличной иностранной │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│               │         │  регистрационный номер │    номер      │            │валютой                │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("├───────────────┼─────────┼────────────────────────┼───────────────┼────────────┼───────────────────────┤", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│" + okato +   "│"+okpo+ "│"      + ogrn +        "│"   + rnb +   "│" + bik +  "│"    + nBranch +      "│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("└───────────────┴─────────┴────────────────────────┴───────────────┴────────────┴───────────────────────┘", m_standardZoneWidth, STR_ALIGN_RIGHT));
    end;

    /**
     * Начать печать отчета.
     *
     * @param     isEmpty   пуст ли отчет?
     */
    macro beginReport(isEmpty : bool)
        m_isEmpty = isEmpty;
    end;

    /**
     * Окончание отчета.
     */
    macro endReport()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начать часть по ОКАТО.
     */
    macro beginOkatoPart()
        // Спецификация:
        //     1. Напечатать таблицу кодов КО (printLendingAgencyCodeZone).
        //     2. Напечатать зону наименований отчета (printNamesZone).
        //     3. Загрузить ресурс Description.
        //     4. Вызовы setFieldValue реализовать как задание значений полям
        //        загруженного ресурса.

        m_table0 = THorizontalTemplateTable("F601Template2332.tpl");
        m_table0.beginHead("Description");
        m_table0.setDefaultValue("");
        m_table = m_table0;
    end;

    /**
     * Окончание печати части отчета по ОКАТО.
     */
    macro endOkatoPart()
        // Спецификация:
        //      1. Получить ширину таблиц m_table1, m_table21, m_table21.
        //      2. Выбрать максимальную из них - это будет ширина отчета.
        //      3. Напечатать название раздела 1: <Раздел 1. Операции уполномоченного
        //         банка (его филиала) с наличной иностранной валютой и чеками
        //         в иностранной валюте>, выравненное по середине отчета.
        //      4. Напечатать таблицу m_table1, выровненную по правому краю отчета.
        //      5. Напечатать название раздела 2: <Раздел 2. Справочная информация
        //         об операциях физических лиц с наличной иностранной валютой>,
        //         выровненное по центру отчета.
        //      6. Напечатать название раздела 2.1: <2.1. Поступление в уполномоченный
        //         банк (его филиал) наличной иностранной валюты>, выровненное по
        //         центру отчета.
        //      7. Напечатать таблицу m_table21, выровненную по правому краю отчета.
        //      8. Напечатать название раздела 2.2: <2.2. Расходование уполномоченным
        //         банком (его филиалом) наличной иностранной валюты >, выровненное по
        //         центру отчета.
        //      9. Напечатать таблицу m_table22, выровненную по правому краю отчета.
        //     10. Напечатать зону подписей отчета (printSignatureZone).

        var reportWidth = max(m_table1.getWidth(), max(m_table21.getWidth(), m_table22.getWidth()));

        setReportWidth(reportWidth);

        changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        printLendingAgencyCodeZone();
        excludeAttribute(AC_FORM_UNIT);
        printNamesZone();

        m_table0.endHead();
        m_table0.addTo(null, reportWidth);

        println();
        println(strAlign("Раздел 1. Операции уполномоченного  банка (его филиала) с наличной иностранной валютой и чеками в иностранной валюте", reportWidth, STR_ALIGN_CENTER));
        println(strAlign("тыс. единиц иностранной валюты", reportWidth, STR_ALIGN_RIGHT));
        m_table1.addTo(null,  reportWidth);

        println();
        println(strAlign("Раздел 2. Справочная информация об операциях физических лиц с наличной иностранной валютой", reportWidth, STR_ALIGN_CENTER));
        println();
        println(strAlign("2.1. Поступление в уполномоченный банк (его филиал) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table21.addTo(null, reportWidth);

        println();
        println(strAlign("2.2. Расходование уполномоченным банком (его филиалом) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table22.addTo(null, reportWidth);

        printSignatureZone();
    end;

    /**
     * Начать раздел 1.
     */
    macro beginPart1()
        // Спецификация:
        //     1. Создать объект m_table1 класса TVerticalTemplateTable.
        //     2. Вызвать у него метод beginHead("IndicatorsNames1").
        //     3. Вызвать у него метод endHead().

        m_table1 = TVerticalTemplateTable("F601Template2332.tpl");
        m_table1.beginHead("IndicatorsNames1");
        m_table1.endHead();
    end;

    /**
     * Окончание печати раздела 1.
     */
    macro endPart1()
        // Спецификация:
        //     1. Вызвать метод beginBottom("VerticalTerminator1") у объекта m_table1.
        //     2. Вызвать метод endBottom() у объекта m_table1.

        m_table1.beginBottom("VerticalTerminator1");
        m_table1.endBottom();
    end;

    /**
     * Начало печати второго раздела.
     */
    macro beginPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Окончание второго раздела.
     */
    macro endPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начало печати раздела 2.1.
     */
    macro beginPart21()
        // Спецификация:
        //     1. Создать объект m_table21 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head21").
        //     3. Вызвать у него метод endHead().

        m_table21 = THorizontalTemplateTable("F601Template2332.tpl");
        m_table21.beginHead("Head21");
        m_table21.endHead();
    end;

    /**
     * Окончание раздела 2.1.
     */
    macro endPart21()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table21.
        //     2. Вызвать метод endBottom() у объекта m_table21.
        m_table21.beginBottom("Bottom2");
        m_table21.endBottom();
    end;

    /**
     * Начало печати раздела 2.2.
     */
    macro beginPart22()
        // Спецификация:
        //     1. Создать объект m_table22 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head22").
        //     3. Вызвать у него метод endHead().

        m_table22 = THorizontalTemplateTable("F601Template2332.tpl");
        m_table22.beginHead("Head22");
        m_table22.endHead();
    end;

    /**
     * Окончание раздела 2.2.
     */
    macro endPart22()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table22.
        //     2. Вызвать метод endBottom() у объекта m_table22.

        m_table22.beginBottom("Bottom2");
        m_table22.endBottom();
    end;

    /**
     * Начало обработки колонки по валюте в первом разделе.
     */
    macro beginCurrencyColumn1()
        // Спецификация:
        //     1. Вызвать метод beginRow("CurrencyColumn1") у объекта m_table1.
        //     2. Вызовы setFieldValue реализовать как m_table1.getField(fieldName).value = value.

        m_table1.beginRow("CurrencyColumn1");
        m_table1.setDefaultValue("");
        m_table = m_table1;
    end;

    /**
     * Окончание обработки колонки по валюте в первом разделе.
     */
    macro endCurrencyColumn1()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table1.

        m_table1.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.1.
     */
    macro beginCurrencyRow21()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row21") у объекта m_table21.
        //     2. Вызовы setFieldValue реализовать как m_table21.getField(fieldName).value = value.

        m_table21.beginRow("Row21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки строки по валюте в разделе 2.1.
     */
    macro endCurrencyRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.1.
     */
    macro beginTotalRow21()
        m_table21.beginRow("TotalRow21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.1.
     */
    macro endTotalRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.2.
     */
    macro beginCurrencyRow22()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row22") у объекта m_table22.
        //     2. Вызовы setFieldValue реализовать как m_table22.getField(fieldName).value = value.

        m_table22.beginRow("Row22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.2.
     */
    macro endCurrencyRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.2.
     */
    macro beginTotalRow22()
        m_table22.beginRow("TotalRow22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки колонки по валюте в разделе 2.2.
     */
    macro endTotalRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Установить значение поля отчета.
     *
     * @param     fieldName имя поля представления
     * @param     value значение поля
     */
    macro setFieldValue(fieldName : String, value)
        // Спецификация:
        //     Задать значение поля текущему шаблону.

        m_table.getField(fieldName).value = value;
    end;

    macro getCurrentTableRowsCount()

        if (m_table != null)
            return m_table.getRowsCount();
        end;

        return 0;
    end;
end;

/**
 * Представление формы 601.
 * Используется модифицированный механизм печати по шаблону (prnfrm.d32) для
 * возможности печати таблиц с переменным количеством столбцов или колонок.
 * См. класс ReportBase::TTemplateTable.
 * Библиотека ресурсов F601Template2332.tpl.
 */
class (TView601_2332) TView601_2539()
    /**
     * Конструктор базового объекта
     */
    initTView601_2332();

    /**
     * Начать часть по ОКАТО.
     */
    macro beginOkatoPart()
        m_table0 = THorizontalTemplateTable("F601Template2539.tpl");
        m_table0.beginHead("Description");
        m_table0.setDefaultValue("");
        m_table = m_table0;
    end;

    /**
     * Начать раздел 1.
     */
    macro beginPart1()
        m_table1 = TVerticalTemplateTable("F601Template2539.tpl");
        m_table1.beginHead("IndicatorsNames1");
        m_table1.endHead();
    end;

    /**
     * Начало печати раздела 2.1.
     */
    macro beginPart21()
        m_table21 = THorizontalTemplateTable("F601Template2539.tpl");
        m_table21.beginHead("Head21");
        m_table21.endHead();
    end;

    /**
     * Начало печати раздела 2.2.
     */
    macro beginPart22()
        m_table22 = THorizontalTemplateTable("F601Template2539.tpl");
        m_table22.beginHead("Head22");
        m_table22.endHead();
    end;

end;

/**
 * Представление формы 601.
 * Используется модифицированный механизм печати по шаблону (prnfrm.d32) для
 * возможности печати таблиц с переменным количеством столбцов или колонок.
 * См. класс ReportBase::TTemplateTable.
 * Библиотека ресурсов F601Template2742.tpl.
 */
class (TPrintableView_2742) TView601_2742()
    /**
     * Конструктор базового объекта
     */
    initTPrintableView_2742("ОТЧЕТ  ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", arrCreate(RCB_PK_HALFYEAR, RCB_PK_QUARTER, RCB_PK_MONTH), DATE_IN_PERIOD_FORMAT);

    /**
     * Признак отчета с нулевыми показателями
     */
    private var m_isEmpty : Bool =  false;

    /**
     * Таблица для реализации setFieldValue, хранит ссылку на текущую таблицу.
     */
    private var m_table : TTemplateTable   = null;
    /**
     * Таблица раздела 1.
     */
    private var m_table0 : TTemplateTable  = null;

    /**
     * Таблица раздела 1.
     */
    private var m_table1 : TTemplateTable  = null;

    /**
     * Таблица раздела 2.1.
     */
    private var m_table21 : TTemplateTable = null;

    /**
     * Таблица раздела 2.2.
     */
    private var m_table22 : TTemplateTable = null;

    /**
     * Напечатать зону кодов кредитной организации.
     */
    macro printLendingAgencyCodeZone()
        // Спецификация:
        //     К стандартной таблице кодов (см. реализцию метода базового класса)
        //     добавляется еще одна колонка:
        //
        //     Число филиалов,
        //     осуществлявших операции
        //     с наличной иностранной валютой
        var nBranch = global.getRcbReport().attributeValue("ЧислоФилиалов").current;

        var okato = strAlign(Код_СОАТО,                15, STR_ALIGN_CENTER);
        var okpo  = strAlign(Код_ОКПО,                 9,  STR_ALIGN_CENTER);
        var ogrn  = strAlign(ОГРН,                     24, STR_ALIGN_CENTER);
        var rnb   = strAlign(РегНомерБанка,            15, STR_ALIGN_CENTER);
        var bik   = strAlign({MFO_Bank},               12, STR_ALIGN_CENTER);
        nBranch   = strAlign(String(nvl(nBranch, "")), 23, STR_ALIGN_CENTER);

        println();
        println(strAlign("Банковская отчетность", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌───────────────┬───────────────────────────────────────────────────────────────┬───────────────────────┐", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│      Код      │       Код кредитной организации (филиала)                     │Число филиалов,        │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│   территории  ├─────────┬────────────────────────┬───────────────┬────────────┤осуществлявших операции│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО   │ по ОКПО │основной государственный│регистрационный│    БИК     │с наличной иностранной │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│               │         │  регистрационный номер │    номер      │            │валютой                │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("├───────────────┼─────────┼────────────────────────┼───────────────┼────────────┼───────────────────────┤", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│" + okato +   "│"+okpo+ "│"      + ogrn +        "│"   + rnb +   "│" + bik +  "│"    + nBranch +      "│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("└───────────────┴─────────┴────────────────────────┴───────────────┴────────────┴───────────────────────┘", m_standardZoneWidth, STR_ALIGN_RIGHT));
    end;

    /**
     * Начать печать отчета.
     *
     * @param     isEmpty   пуст ли отчет?
     */
    macro beginReport(isEmpty : bool)
        m_isEmpty = isEmpty;
    end;

    /**
     * Окончание отчета.
     */
    macro endReport()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начать часть по ОКАТО.
     */
    macro beginOkatoPart()
        // Спецификация:
        //     1. Напечатать таблицу кодов КО (printLendingAgencyCodeZone).
        //     2. Напечатать зону наименований отчета (printNamesZone).
        //     3. Загрузить ресурс Description.
        //     4. Вызовы setFieldValue реализовать как задание значений полям
        //        загруженного ресурса.

        m_table0 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table0.beginHead("Description");
        m_table0.setDefaultValue("");
        m_table = m_table0;
    end;

    /**
     * Окончание печати части отчета по ОКАТО.
     */
    macro endOkatoPart()
        // Спецификация:
        //      1. Получить ширину таблиц m_table1, m_table21, m_table21.
        //      2. Выбрать максимальную из них - это будет ширина отчета.
        //      3. Напечатать название раздела 1: <Раздел 1. Операции уполномоченного
        //         банка (его филиала) с наличной иностранной валютой и чеками
        //         в иностранной валюте>, выравненное по середине отчета.
        //      4. Напечатать таблицу m_table1, выровненную по правому краю отчета.
        //      5. Напечатать название раздела 2: <Раздел 2. Справочная информация
        //         об операциях физических лиц с наличной иностранной валютой>,
        //         выровненное по центру отчета.
        //      6. Напечатать название раздела 2.1: <2.1. Поступление в уполномоченный
        //         банк (его филиал) наличной иностранной валюты>, выровненное по
        //         центру отчета.
        //      7. Напечатать таблицу m_table21, выровненную по правому краю отчета.
        //      8. Напечатать название раздела 2.2: <2.2. Расходование уполномоченным
        //         банком (его филиалом) наличной иностранной валюты >, выровненное по
        //         центру отчета.
        //      9. Напечатать таблицу m_table22, выровненную по правому краю отчета.
        //     10. Напечатать зону подписей отчета (printSignatureZone).

        var reportWidth = max(m_table1.getWidth(), max(m_table21.getWidth(), m_table22.getWidth()));

        setReportWidth(reportWidth);

        changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        printLendingAgencyCodeZone();
        excludeAttribute(AC_FORM_UNIT);
        printNamesZone();

        m_table0.endHead();
        m_table0.addTo(null, reportWidth);

        println();
        println(strAlign("Раздел 1. Операции уполномоченного  банка (его филиала) с наличной иностранной валютой и чеками в иностранной валюте", reportWidth, STR_ALIGN_CENTER));
        println(strAlign("тыс. единиц иностранной валюты", reportWidth, STR_ALIGN_RIGHT));
        m_table1.addTo(null,  reportWidth);

        println();
        println(strAlign("Раздел 2. Справочная информация об операциях физических лиц с наличной иностранной валютой", reportWidth, STR_ALIGN_CENTER));
        println();
        println(strAlign("2.1. Поступление в уполномоченный банк (его филиал) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table21.addTo(null, reportWidth);

        println();
        println(strAlign("2.2. Расходование уполномоченным банком (его филиалом) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table22.addTo(null, reportWidth);

        printSignatureZone();
    end;

    /**
     * Начать раздел 1.
     */
    macro beginPart1()
        // Спецификация:
        //     1. Создать объект m_table1 класса TVerticalTemplateTable.
        //     2. Вызвать у него метод beginHead("IndicatorsNames1").
        //     3. Вызвать у него метод endHead().

        m_table1 = TVerticalTemplateTable("F601Template2742.tpl");
        m_table1.beginHead("IndicatorsNames1");
        m_table1.endHead();
    end;

    /**
     * Окончание печати раздела 1.
     */
    macro endPart1()
        // Спецификация:
        //     1. Вызвать метод beginBottom("VerticalTerminator1") у объекта m_table1.
        //     2. Вызвать метод endBottom() у объекта m_table1.

        m_table1.beginBottom("VerticalTerminator1");
        m_table1.endBottom();
    end;

    /**
     * Начало печати второго раздела.
     */
    macro beginPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Окончание второго раздела.
     */
    macro endPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начало печати раздела 2.1.
     */
    macro beginPart21()
        // Спецификация:
        //     1. Создать объект m_table21 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head21").
        //     3. Вызвать у него метод endHead().

        m_table21 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table21.beginHead("Head21");
        m_table21.endHead();
    end;

    /**
     * Окончание раздела 2.1.
     */
    macro endPart21()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table21.
        //     2. Вызвать метод endBottom() у объекта m_table21.
        m_table21.beginBottom("Bottom2");
        m_table21.endBottom();
    end;

    /**
     * Начало печати раздела 2.2.
     */
    macro beginPart22()
        // Спецификация:
        //     1. Создать объект m_table22 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head22").
        //     3. Вызвать у него метод endHead().

        m_table22 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table22.beginHead("Head22");
        m_table22.endHead();
    end;

    /**
     * Окончание раздела 2.2.
     */
    macro endPart22()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table22.
        //     2. Вызвать метод endBottom() у объекта m_table22.

        m_table22.beginBottom("Bottom2");
        m_table22.endBottom();
    end;

    /**
     * Начало обработки колонки по валюте в первом разделе.
     */
    macro beginCurrencyColumn1()
        // Спецификация:
        //     1. Вызвать метод beginRow("CurrencyColumn1") у объекта m_table1.
        //     2. Вызовы setFieldValue реализовать как m_table1.getField(fieldName).value = value.

        m_table1.beginRow("CurrencyColumn1");
        m_table1.setDefaultValue("");
        m_table = m_table1;
    end;

    /**
     * Окончание обработки колонки по валюте в первом разделе.
     */
    macro endCurrencyColumn1()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table1.

        m_table1.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.1.
     */
    macro beginCurrencyRow21()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row21") у объекта m_table21.
        //     2. Вызовы setFieldValue реализовать как m_table21.getField(fieldName).value = value.

        m_table21.beginRow("Row21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки строки по валюте в разделе 2.1.
     */
    macro endCurrencyRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.1.
     */
    macro beginTotalRow21()
        m_table21.beginRow("TotalRow21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.1.
     */
    macro endTotalRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.2.
     */
    macro beginCurrencyRow22()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row22") у объекта m_table22.
        //     2. Вызовы setFieldValue реализовать как m_table22.getField(fieldName).value = value.

        m_table22.beginRow("Row22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.2.
     */
    macro endCurrencyRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.2.
     */
    macro beginTotalRow22()
        m_table22.beginRow("TotalRow22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки колонки по валюте в разделе 2.2.
     */
    macro endTotalRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Установить значение поля отчета.
     *
     * @param     fieldName имя поля представления
     * @param     value значение поля
     */
    macro setFieldValue(fieldName : String, value)
        // Спецификация:
        //     Задать значение поля текущему шаблону.

        m_table.getField(fieldName).value = value;
    end;

    macro getCurrentTableRowsCount()

        if (m_table != null)
            return m_table.getRowsCount();
        end;

        return 0;
    end;
end;

/**
 * Представление формы 601.
 * Используется модифицированный механизм печати по шаблону (prnfrm.d32) для
 * возможности печати таблиц с переменным количеством столбцов или колонок.
 * См. класс ReportBase::TTemplateTable.
 * Библиотека ресурсов F601Template2742.tpl.
 */
class (TPrintableView_2851) TView601_2851()
    /**
     * Конструктор базового объекта
     */
    initTPrintableView_2851("ОТЧЕТ  ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", arrCreate(RCB_PK_HALFYEAR, RCB_PK_QUARTER, RCB_PK_MONTH), DATE_IN_PERIOD_FORMAT);

    /**
     * Признак отчета с нулевыми показателями
     */
    private var m_isEmpty : Bool =  false;

    /**
     * Таблица для реализации setFieldValue, хранит ссылку на текущую таблицу.
     */
    private var m_table : TTemplateTable   = null;
    /**
     * Таблица раздела 1.
     */
    private var m_table0 : TTemplateTable  = null;

    /**
     * Таблица раздела 1.
     */
    private var m_table1 : TTemplateTable  = null;

    /**
     * Таблица раздела 2.1.
     */
    private var m_table21 : TTemplateTable = null;

    /**
     * Таблица раздела 2.2.
     */
    private var m_table22 : TTemplateTable = null;

    /**
     * Получить код ОКАТО
     */
    private macro getOkatoCode()
        var okatoCode : String = "";
        var dataSet;

        //сначала ищем ОКАТО по категории "Справочник ОКАТО" для субъекта
        okatoCode = Код_СОАТО();
        if(okatoCode != "")
            return okatoCode;
        elif(gotoPos())
        //если категория "Справочник ОКАТО" для субъекта не задана, то ищем ОКАТО в юридическом адресе
            dataSet = TRsbDataSet("SELECT adress.t_OKATO OKATO"
                      + "\n" +    "  FROM dadress_dbt adress"
                      + "\n" +    " WHERE adress.t_partyId = " + _param_party.PartyID);
            if (dataSet.next())
                okatoCode = dataSet.OKATO;
            end;
        end;

        return subStr(okatoCode, 1, 4);
    end;

    /**
     * Напечатать зону кодов кредитной организации.
     */
    macro printLendingAgencyCodeZone()
        // Спецификация:
        //     К стандартной таблице кодов (см. реализцию метода базового класса)
        //     добавляется еще одна колонка:
        //
        //     Число филиалов,
        //     осуществлявших операции
        //     с наличной иностранной валютой
        var nBranch = global.getRcbReport().attributeValue("ЧислоФилиалов").current;

        var okato = strAlign(getOkatoCode(),           16, STR_ALIGN_CENTER);
        var okpo  = strAlign(Код_ОКПО,                 9,  STR_ALIGN_CENTER);
        var rnb   = strAlign(РегНомерБанка,            25, STR_ALIGN_CENTER);
        nBranch   = strAlign(String(nvl(nBranch, "")), 23, STR_ALIGN_CENTER);

        println();
        println(strAlign("Банковская отчетность", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("┌────────────────┬───────────────────────────────────┬───────────────────────┐", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│ Код территории │Код кредитной организации (филиала)│    Число филиалов,    │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│    по ОКАТО    ├─────────┬─────────────────────────┤осуществлявших операции│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│                │ по ОКПО │  Регистрационный номер  │с наличной иностранной │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│                │         │    (порядковый номер)   │        валютой        │", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("├────────────────┼─────────┼─────────────────────────┼───────────────────────┤", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("│"  + okato +   "│"+okpo+ "│"   + rnb +             "│"    + nBranch +      "│", m_standardZoneWidth, STR_ALIGN_RIGHT));
        println(strAlign("└────────────────┴─────────┴─────────────────────────┴───────────────────────┘", m_standardZoneWidth, STR_ALIGN_RIGHT));
    end;

    /**
     * Начать печать отчета.
     *
     * @param     isEmpty   пуст ли отчет?
     */
    macro beginReport(isEmpty : bool)
        m_isEmpty = isEmpty;
    end;

    /**
     * Окончание отчета.
     */
    macro endReport()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начать часть по ОКАТО.
     */
    macro beginOkatoPart()
        // Спецификация:
        //     1. Напечатать таблицу кодов КО (printLendingAgencyCodeZone).
        //     2. Напечатать зону наименований отчета (printNamesZone).
        //     3. Загрузить ресурс Description.
        //     4. Вызовы setFieldValue реализовать как задание значений полям
        //        загруженного ресурса.

        m_table0 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table0.beginHead("Description");
        m_table0.setDefaultValue("");
        m_table = m_table0;
    end;

    /**
     * Окончание печати части отчета по ОКАТО.
     */
    macro endOkatoPart()
        // Спецификация:
        //      1. Получить ширину таблиц m_table1, m_table21, m_table21.
        //      2. Выбрать максимальную из них - это будет ширина отчета.
        //      3. Напечатать название раздела 1: <Раздел 1. Операции уполномоченного
        //         банка (его филиала) с наличной иностранной валютой и чеками
        //         в иностранной валюте>, выравненное по середине отчета.
        //      4. Напечатать таблицу m_table1, выровненную по правому краю отчета.
        //      5. Напечатать название раздела 2: <Раздел 2. Справочная информация
        //         об операциях физических лиц с наличной иностранной валютой>,
        //         выровненное по центру отчета.
        //      6. Напечатать название раздела 2.1: <2.1. Поступление в уполномоченный
        //         банк (его филиал) наличной иностранной валюты>, выровненное по
        //         центру отчета.
        //      7. Напечатать таблицу m_table21, выровненную по правому краю отчета.
        //      8. Напечатать название раздела 2.2: <2.2. Расходование уполномоченным
        //         банком (его филиалом) наличной иностранной валюты >, выровненное по
        //         центру отчета.
        //      9. Напечатать таблицу m_table22, выровненную по правому краю отчета.
        //     10. Напечатать зону подписей отчета (printSignatureZone).

        var reportWidth = max(m_table1.getWidth(), max(m_table21.getWidth(), m_table22.getWidth()));

        setReportWidth(reportWidth);

        changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        printLendingAgencyCodeZone();
        excludeAttribute(AC_FORM_UNIT);
        printNamesZone();

        m_table0.endHead();
        m_table0.addTo(null, reportWidth);

        println();
        println(strAlign("Раздел 1. Операции уполномоченного  банка (его филиала) с наличной иностранной валютой и чеками в иностранной валюте", reportWidth, STR_ALIGN_CENTER));
        println(strAlign("тыс. единиц иностранной валюты", reportWidth, STR_ALIGN_RIGHT));
        m_table1.addTo(null,  reportWidth);

        println();
        println(strAlign("Раздел 2. Справочная информация об операциях физических лиц с наличной иностранной валютой", reportWidth, STR_ALIGN_CENTER));
        println();
        println(strAlign("2.1. Поступление в уполномоченный банк (его филиал) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table21.addTo(null, reportWidth);

        println();
        println(strAlign("2.2. Расходование уполномоченным банком (его филиалом) наличной иностранной валюты", reportWidth, STR_ALIGN_CENTER));
        m_table22.addTo(null, reportWidth);

        printSignatureZone();
    end;

    /**
     * Начать раздел 1.
     */
    macro beginPart1()
        // Спецификация:
        //     1. Создать объект m_table1 класса TVerticalTemplateTable.
        //     2. Вызвать у него метод beginHead("IndicatorsNames1").
        //     3. Вызвать у него метод endHead().

        m_table1 = TVerticalTemplateTable("F601Template2742.tpl");
        m_table1.beginHead("IndicatorsNames1");
        m_table1.endHead();
    end;

    /**
     * Окончание печати раздела 1.
     */
    macro endPart1()
        // Спецификация:
        //     1. Вызвать метод beginBottom("VerticalTerminator1") у объекта m_table1.
        //     2. Вызвать метод endBottom() у объекта m_table1.

        m_table1.beginBottom("VerticalTerminator1");
        m_table1.endBottom();
    end;

    /**
     * Начало печати второго раздела.
     */
    macro beginPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Окончание второго раздела.
     */
    macro endPart2()
        // Спецификация:
        //     Пустой метод.
    end;

    /**
     * Начало печати раздела 2.1.
     */
    macro beginPart21()
        // Спецификация:
        //     1. Создать объект m_table21 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head21").
        //     3. Вызвать у него метод endHead().

        m_table21 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table21.beginHead("Head21");
        m_table21.endHead();
    end;

    /**
     * Окончание раздела 2.1.
     */
    macro endPart21()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table21.
        //     2. Вызвать метод endBottom() у объекта m_table21.
        m_table21.beginBottom("Bottom2");
        m_table21.endBottom();
    end;

    /**
     * Начало печати раздела 2.2.
     */
    macro beginPart22()
        // Спецификация:
        //     1. Создать объект m_table22 класса THorizontalTemplateTable.
        //     2. Вызвать у него метод beginHead("Head22").
        //     3. Вызвать у него метод endHead().

        m_table22 = THorizontalTemplateTable("F601Template2742.tpl");
        m_table22.beginHead("Head22");
        m_table22.endHead();
    end;

    /**
     * Окончание раздела 2.2.
     */
    macro endPart22()
        // Спецификация:
        //     1. Вызвать метод beginBottom("Bottom2") у объекта m_table22.
        //     2. Вызвать метод endBottom() у объекта m_table22.

        m_table22.beginBottom("Bottom2");
        m_table22.endBottom();
    end;

    /**
     * Начало обработки колонки по валюте в первом разделе.
     */
    macro beginCurrencyColumn1()
        // Спецификация:
        //     1. Вызвать метод beginRow("CurrencyColumn1") у объекта m_table1.
        //     2. Вызовы setFieldValue реализовать как m_table1.getField(fieldName).value = value.

        m_table1.beginRow("CurrencyColumn1");
        m_table1.setDefaultValue("");
        m_table = m_table1;
    end;

    /**
     * Окончание обработки колонки по валюте в первом разделе.
     */
    macro endCurrencyColumn1()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table1.

        m_table1.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.1.
     */
    macro beginCurrencyRow21()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row21") у объекта m_table21.
        //     2. Вызовы setFieldValue реализовать как m_table21.getField(fieldName).value = value.

        m_table21.beginRow("Row21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки строки по валюте в разделе 2.1.
     */
    macro endCurrencyRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.1.
     */
    macro beginTotalRow21()
        m_table21.beginRow("TotalRow21");
        m_table21.setDefaultValue("");
        m_table = m_table21;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.1.
     */
    macro endTotalRow21()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table21.

        m_table21.endRow();
    end;

    /**
     * Начало обработки строки по валюте в разделе 2.2.
     */
    macro beginCurrencyRow22()
        // Спецификация:
        //     1. Вызвать метод beginRow("Row22") у объекта m_table22.
        //     2. Вызовы setFieldValue реализовать как m_table22.getField(fieldName).value = value.

        m_table22.beginRow("Row22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки итоговой строки в разделе 2.2.
     */
    macro endCurrencyRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Начало обработки итоговой строки в разделе 2.2.
     */
    macro beginTotalRow22()
        m_table22.beginRow("TotalRow22");
        m_table22.setDefaultValue("");
        m_table = m_table22;
    end;

    /**
     * Окончание обработки колонки по валюте в разделе 2.2.
     */
    macro endTotalRow22()
        // Спецификация:
        //     Вызвать метод endRow() у объекта m_table22.

        m_table22.endRow();
    end;

    /**
     * Установить значение поля отчета.
     *
     * @param     fieldName имя поля представления
     * @param     value значение поля
     */
    macro setFieldValue(fieldName : String, value)
        // Спецификация:
        //     Задать значение поля текущему шаблону.

        m_table.getField(fieldName).value = value;
    end;

    macro getCurrentTableRowsCount()

        if (m_table != null)
            return m_table.getRowsCount();
        end;

        return 0;
    end;
end;

class TExcelView601()
    private const WARNING_MESSAGE = "Печать в формате Excel невозможна";

    msgbox(WARNING_MESSAGE);
    RepErrorsQueue().add(0, WARNING_MESSAGE);

    exit(1);
end;

/**
 * Константы для CMakeReport::setWinRepOutput(), которые позволят отличать объект класса, созданный для работы с plain text
 */
private const REP_OUTPUT_TEXT = -1;
private const REP_FORMAT_TXT = -1;

/**
 * CMakeReport с перегруженными методми
 *     GetRegim_LoadNewApplication - для перекрытия настройки BANK_INI\WINDOWS REPORT\LOADNEWAPPLICATION
 *     PrintRep_Sheet - для удаления символа новой страницы после печати подраздела 2.1
 *     addString - для меньшей избыточности кода
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.0
 */
private class (CMakeReport) TMakeReport(_HeaderStr:string, _SepStr:string, _CountStrOnPage:integer, _CurStr:integer)
    initCMakeReport(_HeaderStr, _SepStr, _CountStrOnPage, _CurStr);

    private macro GetRegim_LoadNewApplication()
        return false;
    end;

    private macro PrintRep_Sheet(sheet : Object)
        PrintRep_Sheet(sheet);

        if (    (WinRepOutput == REP_OUTPUT_TEXT)
            and (index(sheet.sheetName, "2.1") == 0)
            and (sheet.SheetNumber != lsSheet.size)
           )
            var oldOutput = setoutput(FileNameDocumentTxt, true);
            println(strFor(12));
            setoutput(oldOutput, true);
        end;
    end;

    macro addString(value : String, width : Integer, precision : Integer, format : String, valueType : Integer, flagPrint : Bool)
        addPrintCell(value, width, precision, format, valueType, flagPrint);
        addStr();
    end;
end;

/**
 * Элемент кеша заголовков таблицы для печатного представления
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.1
 */
private class TTableHeaderCacheElement(_key : Integer, _header : String, _template : Object)
    var key      : Integer = _key;
    var header   : String  = _header;
    var template : Object  = _template;
end;

/**
 * Источник заголовков таблицы для печатного представления
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.0
 */
const PART_1_TABLE_NAME     = "Раздел 1";
const PART_21_TABLE_NAME    = "поступления";
const PART_22_TABLE_NAME    = "расходования";

private class TTableHeaderMaker(currencies : Object)
    private var m_cache : TArray;

    private macro addPart1(currencies : Object, key : Integer) : Object
        var header : String;
        var template  = TCompositeTableField();

        var rowNumberHeader = TTableHeaderField("Номер|строки", 6, STR_ALIGN_CENTER);
        var rowNumberData   = TTableDataField("rowNumber", rowNumberHeader.width, getFormatSpecifier(rowNumberHeader.format));

        var attributeNameHeader = TTableHeaderField("Наименование показателя", 75, STR_ALIGN_LEFT);
        var attributeNameData   = TTableDataField("attributeName", attributeNameHeader.width, getFormatSpecifier(STR_ALIGN_LEFT));

        template.addField(rowNumberHeader, rowNumberData);
        template.addField(attributeNameHeader, attributeNameData);

        for (var currency, currencies)
            var name = "";
            for (var it, strTransferByWord(currency.name, 17))
                name = name + "|" + trim(it);
            end;
            name = substr(name, 2);

            var amountHeader = TTableHeaderField(name, 17, STR_ALIGN_CENTER);
            var amountData   = TTableDataField(currency.code, amountHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

            template.addField(amountHeader, amountData);
        end;

        header = "";
        for (var i, template.getReportHeader(true))
            header = header + "\n" + i;
        end;
        header = substr(header, 2);

        // Добавление в заголовок строки с кодами валют
        var columns = template.getColumns();
        var column : Object;
        var str;

        header = header + "\n";
        header = header + "│" + strAlign("",           columns.value(0).getTableHeaderField().width, STR_ALIGN_CENTER);
        header = header + "│" + strAlign("Код валюты", columns.value(1).getTableHeaderField().width, STR_ALIGN_CENTER);

        i = 2;
        for (currency, currencies)
            column = columns.value(i).getTableHeaderField();
            header = header + "│" + strAlign(currency.code, column.width, STR_ALIGN_CENTER);
            i = i + 1;
        end;

        header = header + "│" + "\n" + "├";

        i = 0;
        while (i < columns.size)
            column = columns.value(i).getTableHeaderField();
            str = mkStr("─", column.width);
            // Вставляем мнимый столбец для отображения номера показателя в колонке 2
            if (i == 1)
                strset(str, 8, "┬");
            end;
            header = header + str + "┼";
            i = i + 1;
        end;

        m_cache.value(key) = TTableHeaderCacheElement(key, header, template);

        return m_cache.value(key);
    end;

    private macro addPart21(key : Integer) : Object
        var header : String;
        var template  = TCompositeTableField();

        var counterHeader = TTableHeaderField("Номер|строки", 7, STR_ALIGN_CENTER);
        var counterData   = TTableDataField("1", counterHeader.width, getFormatSpecifier(counterHeader.format));

        var currencyCodeHeader = TTableHeaderField("Код|валюты", 8, STR_ALIGN_CENTER);
        var currencyCodeData   = TTableDataField("2", currencyCodeHeader.width, getFormatSpecifier(currencyCodeHeader.format));

        var currencyNameHeader = TTableHeaderField("Наименование|валюты", 17, STR_ALIGN_CENTER);
        var currencyNameData   = TTableDataField("3", currencyNameHeader.width, getFormatSpecifier(STR_ALIGN_LEFT));

        var purchasedHeader = TTableHeaderField("Куплено|уполномоченным|банком (его|филиалом),|тысяч единиц|иностранной|валюты", 17, STR_ALIGN_LEFT);
        var purchasedData   = TTableDataField("4", purchasedHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var paidHeader = TTableHeaderField("Уплачено|уполномоченным|банком (его|филиалом),|тысяч рублей", 17, STR_ALIGN_LEFT);
        var paidData   = TTableDataField("5", paidHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var transactionsHeader = TTableHeaderField("Количество|сделок по|покупке,|единиц", 17, STR_ALIGN_LEFT);
        var transactionsData   = TTableDataField("6", transactionsHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var conversionHeader = TTableHeaderField("Принято для|конверсии,|тысяч единиц|иностранной|валюты", 17, STR_ALIGN_LEFT);
        var conversionData   = TTableDataField("7", conversionHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var nonresidentHeader = TTableHeaderField("нерезидентов", 17, STR_ALIGN_CENTER);
        var nonresidentData   = TTableDataField("8", nonresidentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var residentHeader = TTableHeaderField("резидентов", 17, STR_ALIGN_CENTER);
        var residentData   = TTableDataField("9", residentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var operationsHeader = TCompositeTableField();
        operationsHeader.setTableField(TTableField("Количество операций по зачислению|на счета физических лиц, единиц", null, STR_ALIGN_LEFT));
        operationsHeader.addField(nonresidentHeader, nonresidentData);
        operationsHeader.addField(residentHeader, residentData);

        template.addField(counterHeader, counterData);
        template.addField(currencyCodeHeader, currencyCodeData);
        template.addField(currencyNameHeader, currencyNameData);
        template.addField(purchasedHeader, purchasedData);
        template.addField(paidHeader, paidData);
        template.addField(transactionsHeader, transactionsData);
        template.addField(conversionHeader, conversionData);
        template.addField(operationsHeader);

        header = "";
        for (var i, template.getReportHeader(true))
            header = header + "\n" + i;
        end;
        header = substr(header, 2);

        m_cache.value(key) = TTableHeaderCacheElement(key, header, template);

        return m_cache.value(key);
    end;

    private macro addPart22(key : Integer) : Object
        var header : String;
        var template  = TCompositeTableField();

        var counterHeader = TTableHeaderField("Номер|строки", 7, STR_ALIGN_CENTER, 1);
        var counterData   = TTableDataField("1", counterHeader.width, getFormatSpecifier(counterHeader.format));

        var currencyCodeHeader = TTableHeaderField("Код|валюты", 8, STR_ALIGN_CENTER, 2);
        var currencyCodeData   = TTableDataField("2", currencyCodeHeader.width, getFormatSpecifier(currencyCodeHeader.format));

        var currencyNameHeader = TTableHeaderField("Наименование|валюты", 17, STR_ALIGN_CENTER, 3);
        var currencyNameData   = TTableDataField("3", currencyNameHeader.width, getFormatSpecifier(STR_ALIGN_LEFT));

        var salesHeader = TTableHeaderField("Продано|уполномоченным|банком (его|филиалом),|тысяч единиц|иностранной|валюты", 17, STR_ALIGN_LEFT, 10);
        var salesData   = TTableDataField("10", salesHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var receivedHeader = TTableHeaderField("Получено|уполномоченным|банком (его|филиалом),|тысяч рублей", 17, STR_ALIGN_LEFT, 11);
        var receivedData   = TTableDataField("11", receivedHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var transactionsHeader = TTableHeaderField("Количество|сделок по|продаже,|единиц", 17, STR_ALIGN_LEFT, 12);
        var transactionsData   = TTableDataField("12", transactionsHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var conversionHeader = TTableHeaderField("Выдано по|конверсии,|тысяч единиц|иностранной|валюты", 17, STR_ALIGN_LEFT, 13);
        var conversionData   = TTableDataField("13", conversionHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var nonresidentHeader = TTableHeaderField("нерезидентов", 17, STR_ALIGN_CENTER, 14);
        var nonresidentData   = TTableDataField("14", nonresidentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var residentHeader = TTableHeaderField("резидентов", 17, STR_ALIGN_CENTER, 15);
        var residentData   = TTableDataField("15", residentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var operationsHeader = TCompositeTableField();
        operationsHeader.setTableField(TTableField("Количество операций по снятию|со счетов физических лиц, единиц", null, STR_ALIGN_LEFT));
        operationsHeader.addField(nonresidentHeader, nonresidentData);
        operationsHeader.addField(residentHeader, residentData);

        template.addField(counterHeader, counterData);
        template.addField(currencyCodeHeader, currencyCodeData);
        template.addField(currencyNameHeader, currencyNameData);
        template.addField(salesHeader, salesData);
        template.addField(receivedHeader, receivedData);
        template.addField(transactionsHeader, transactionsData);
        template.addField(conversionHeader, conversionData);
        template.addField(operationsHeader);

        header = "";
        for (var i, template.getReportHeader(true))
            header = header + "\n" + i;
        end;
        header = substr(header, 2);

        m_cache.value(key) = TTableHeaderCacheElement(key, header, template);

        return m_cache.value(key);
    end;

    private macro makeKey(name : String) : Integer
        return strlen(name);
    end;

    /**
     * Получить элемент кеша
     * @param tableName Название таблицы отчета
     *
     * @return объект класса TTableHeaderCacheElement или null
     */
    macro get(tableName) : Object
        return m_cache.value(makeKey(tableName));
    end;

    private macro constructor(currencies : Object)
        m_cache = TArray();

        addPart1(currencies, makeKey(PART_1_TABLE_NAME));
        addPart21(makeKey(PART_21_TABLE_NAME));
        addPart22(makeKey(PART_22_TABLE_NAME));
    end;

    constructor(currencies);
end;

class (TTableHeaderMaker) TTableHeaderMaker_4212(currencies : Object)

    private macro addPart21(key : Integer) : Object
        var header : String;
        var template  = TCompositeTableField();

        var counterHeader = TTableHeaderField("Номер|строки", 7, STR_ALIGN_CENTER);
        var counterData   = TTableDataField("1", counterHeader.width, getFormatSpecifier(counterHeader.format));

        var currencyCodeHeader = TTableHeaderField("Код|валюты", 8, STR_ALIGN_CENTER);
        var currencyCodeData   = TTableDataField("2", currencyCodeHeader.width, getFormatSpecifier(currencyCodeHeader.format));

        var currencyNameHeader = TTableHeaderField("Наименование|валюты", 17, STR_ALIGN_CENTER);
        var currencyNameData   = TTableDataField("3", currencyNameHeader.width, getFormatSpecifier(STR_ALIGN_LEFT));

        var purchasedHeader = TTableHeaderField("Куплено|уполномоченным|банком (его|филиалом),|тыс. единиц|иностранной|валюты", 17, STR_ALIGN_LEFT);
        var purchasedData   = TTableDataField("4", purchasedHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var paidHeader = TTableHeaderField("Уплачено|уполномоченным|банком (его|филиалом),|тыс. руб.", 17, STR_ALIGN_LEFT);
        var paidData   = TTableDataField("5", paidHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var transactionsHeader = TTableHeaderField("Количество|сделок по|покупке,|единиц", 17, STR_ALIGN_LEFT);
        var transactionsData   = TTableDataField("6", transactionsHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var conversionHeader = TTableHeaderField("Принято для|конверсии,|тыс. единиц|иностранной|валюты", 17, STR_ALIGN_LEFT);
        var conversionData   = TTableDataField("7", conversionHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var nonresidentHeader = TTableHeaderField("нерезидентов", 17, STR_ALIGN_CENTER);
        var nonresidentData   = TTableDataField("8", nonresidentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var residentHeader = TTableHeaderField("резидентов", 17, STR_ALIGN_CENTER);
        var residentData   = TTableDataField("9", residentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var operationsHeader = TCompositeTableField();
        operationsHeader.setTableField(TTableField("Количество операций по зачислению|на счета физических лиц, единиц", null, STR_ALIGN_LEFT));
        operationsHeader.addField(nonresidentHeader, nonresidentData);
        operationsHeader.addField(residentHeader, residentData);

        template.addField(counterHeader, counterData);
        template.addField(currencyCodeHeader, currencyCodeData);
        template.addField(currencyNameHeader, currencyNameData);
        template.addField(purchasedHeader, purchasedData);
        template.addField(paidHeader, paidData);
        template.addField(transactionsHeader, transactionsData);
        template.addField(conversionHeader, conversionData);
        template.addField(operationsHeader);

        header = "";
        for (var i, template.getReportHeader(true))
            header = header + "\n" + i;
        end;
        header = substr(header, 2);

        m_cache.value(key) = TTableHeaderCacheElement(key, header, template);

        return m_cache.value(key);
    end;

    private macro addPart22(key : Integer) : Object
        var header : String;
        var template  = TCompositeTableField();

        var counterHeader = TTableHeaderField("Номер|строки", 7, STR_ALIGN_CENTER, 1);
        var counterData   = TTableDataField("1", counterHeader.width, getFormatSpecifier(counterHeader.format));

        var currencyCodeHeader = TTableHeaderField("Код|валюты", 8, STR_ALIGN_CENTER, 2);
        var currencyCodeData   = TTableDataField("2", currencyCodeHeader.width, getFormatSpecifier(currencyCodeHeader.format));

        var currencyNameHeader = TTableHeaderField("Наименование|валюты", 17, STR_ALIGN_CENTER, 3);
        var currencyNameData   = TTableDataField("3", currencyNameHeader.width, getFormatSpecifier(STR_ALIGN_LEFT));

        var salesHeader = TTableHeaderField("Продано|уполномоченным|банком (его|филиалом),|тыс. единиц|иностранной|валюты", 17, STR_ALIGN_LEFT, 10);
        var salesData   = TTableDataField("10", salesHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var receivedHeader = TTableHeaderField("Получено|уполномоченным|банком (его|филиалом),|тыс. рубл.", 17, STR_ALIGN_LEFT, 11);
        var receivedData   = TTableDataField("11", receivedHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var transactionsHeader = TTableHeaderField("Количество|сделок по|продаже,|единиц", 17, STR_ALIGN_LEFT, 12);
        var transactionsData   = TTableDataField("12", transactionsHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var conversionHeader = TTableHeaderField("Выдано по|конверсии,|тыс. единиц|иностранной|валюты", 17, STR_ALIGN_LEFT, 13);
        var conversionData   = TTableDataField("13", conversionHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var nonresidentHeader = TTableHeaderField("нерезидентов", 17, STR_ALIGN_CENTER, 14);
        var nonresidentData   = TTableDataField("14", nonresidentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var residentHeader = TTableHeaderField("резидентов", 17, STR_ALIGN_CENTER, 15);
        var residentData   = TTableDataField("15", residentHeader.width, getFormatSpecifier(STR_ALIGN_RIGHT));

        var operationsHeader = TCompositeTableField();
        operationsHeader.setTableField(TTableField("Количество операций по снятию|со счетов физических лиц, единиц", null, STR_ALIGN_LEFT));
        operationsHeader.addField(nonresidentHeader, nonresidentData);
        operationsHeader.addField(residentHeader, residentData);

        template.addField(counterHeader, counterData);
        template.addField(currencyCodeHeader, currencyCodeData);
        template.addField(currencyNameHeader, currencyNameData);
        template.addField(salesHeader, salesData);
        template.addField(receivedHeader, receivedData);
        template.addField(transactionsHeader, transactionsData);
        template.addField(conversionHeader, conversionData);
        template.addField(operationsHeader);

        header = "";
        for (var i, template.getReportHeader(true))
            header = header + "\n" + i;
        end;
        header = substr(header, 2);

        m_cache.value(key) = TTableHeaderCacheElement(key, header, template);

        return m_cache.value(key);
    end;

    private macro constructorTTableHeaderMaker_4212(currencies : Object)
        initTTableHeaderMaker(currencies);

        m_cache = TArray();

        addPart1(currencies, makeKey(PART_1_TABLE_NAME));
        addPart21(makeKey(PART_21_TABLE_NAME));
        addPart22(makeKey(PART_22_TABLE_NAME));
    end;

    constructorTTableHeaderMaker_4212(currencies);
end;

/**
 * Представление ф.601 по 3468-У на основе Windows Reports
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.0
 */
private class TWinRepView_3468()
    private var m_printEngine : Object;
    private var m_reportWidth : Integer;
    private var m_tableWidth  : Integer;

    /**
     * Ширина отчета "по умолчанию". Определяется как ширина, достаточная для вывода данных о количестве ВСП и операционных касс.
     */
    private const DEFAULT_REPORT_WIDTH = 91;

    private var m_isFirstSheet      : Bool;
    private var m_printableView     : TPrintableView;
    private var m_cachedHeaderMaker : Object;//TTableHeaderMaker;

    private macro getTableHeader(name : String) : String
        return m_cachedHeaderMaker.get(name).header;
    end;

    private macro getTableTemplate(name : String) : TCompositeTableField
        return m_cachedHeaderMaker.get(name).template;
    end;

    private macro getSheetCaption(part : String, okatoCode : String)
        var caption = "";
        if (part == "0")
            caption = "Титульный лист";
            part = "";
        else
            caption = "Раздел";
        end;

        return caption + " " + part + " (ОКАТО " + okatoCode + ")";
    end;

    /**
     * Таблица с кодами банков, название отчета, период, название и адрес банка, код формы по ОКУД и периодичность
     */
    macro printHead(isTotal, nBranch, sheetNameOkatoCode)
        var bankCodesTableWidth = 86;//template.getWidth() + template.getColumnCount() - 1;

        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));

        if (m_isFirstSheet)
            m_isFirstSheet = false;
            m_printEngine.init(getTableHeader(PART_1_TABLE_NAME));
            m_printEngine.getCurSheet().setSheetName(getSheetCaption("0", sheetNameOkatoCode));
        else
            m_printEngine.addNewSheetBreak(getSheetCaption( "0", sheetNameOkatoCode), getTableHeader(PART_1_TABLE_NAME));
        end;

        m_tableWidth = m_printEngine.getHeaderWidth();
        m_reportWidth = max(m_tableWidth+1, max(DEFAULT_REPORT_WIDTH, bankCodesTableWidth));

        var shift = "";
        if (bankCodesTableWidth < m_reportWidth)
            shift = mkstr(" ", m_reportWidth - bankCodesTableWidth);
        end;

        var okatoCode = m_printableView.getLendingAgencyCodeZone().getOkato();
        var okpoCode  = m_printableView.getLendingAgencyCodeZone().getOkpo();
        var regNumber = m_printableView.getLendingAgencyCodeZone().getRegistrationNumber();

        m_printEngine.addString("Банковская отчетность", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_RIGHT), REP_ELEM_STR);

        // Таблица с кодами кредитной организации
        m_printEngine.autoscan("[" + shift + "┌────────────────┬─────────────────────────────────────┬─────────────────────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#####################################│#############################│" + "]",
                          "Код территории", "c:ex_B(t)", "Код кредитной организации (филиала)", "c:ex_B(t)", "Число филиалов,", "c:ex_B(t)");
        m_printEngine.autoscan("[" + shift + "│    по ОКАТО    ├─────────────┬───────────────────────┤    осуществлявших операции  │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │   по ОКПО   │ Регистрационный номер │    с наличной иностранной   │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │             │   (порядковый номер)  │           валютой           │" + "]");
        m_printEngine.autoscan("[" + shift + "├────────────────┼─────────────┼───────────────────────┼─────────────────────────────┤" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#############│#######################│#############################│" + "]",
                                           okatoCode, "c:ex_B(BT)",  okpoCode, "c:ex_B(BT)", regNumber, "c:ex_B(BT)", nBranch, "c:ex_B(BT)");
        m_printEngine.autoscan("[" + shift + "└────────────────┴─────────────┴───────────────────────┴─────────────────────────────┘" + "]");

        // Название формы и банка, адрес банка, код формы и периодичность - т.е. TNamesZone.
        // Данные для печати извлекаются из файла, сформированного стандартным вызовом TPrintableView.printNamesZone()
        m_printableView.setReportWidth(m_reportWidth);
        m_printableView.changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        m_printableView.excludeAttribute(AC_FORM_UNIT);
        m_printableView.setOutputFile(false);
        m_printableView.printNamesZone();
        m_printableView.resetOutputFile();
        var outstream = TStreamDoc(m_printableView.getFileName(), "R");
        var str = "";
        while (outstream.readLine(str))
            if (str == "")
                m_printEngine.addEmptyStr();
            else
                m_printEngine.addString(str, m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_LEFT), REP_ELEM_STR);
            end;
        end;

        m_printEngine.addEmptyStr();
    end;

    /**
     * Признак отчета с нулевыми показателями, количество ВСП и касс, код ВСП по ОКАТО
     */
    macro printPart0(emptySymbol, nBranch, nCashbox, okatoCode)
        var shift = "";
        if (DEFAULT_REPORT_WIDTH < m_reportWidth)
            shift = mkstr(" ", m_reportWidth - DEFAULT_REPORT_WIDTH);
        end;

        if ((okatoCode != null) and (okatoCode != ""))
            okatoCode = strRpad(substr(okatoCode, 1, 4), 4, "0");
        else
            okatoCode = "";
        end;

        m_printEngine.autoscan("[" + shift + "                                                                          ┌───────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "                                Признак отчета с нулевыми показателями    │###############│" + "]", emptySymbol, "r:ex_B(BT)");
        m_printEngine.autoscan("[" + shift + "                                                                          └───────────────┘" + "]");

        m_printEngine.addEmptyStr();
        m_printEngine.autoscan("[" + shift + "                                                                          ┌───────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "I.   Количество внутренних структурных подразделений уполномоченного      │###############│" + "]", nBranch, "r:ex_B(T)");
        m_printEngine.autoscan("[" + shift + "     банка (его филиала), совершавших операции с наличной иностранной     │               │" + "]");
        m_printEngine.autoscan("[" + shift + "     валютой и (или) чеками в иностранной валюте в отчетном периоде       │###############│" + "]", "", "ex_B(B)");
        m_printEngine.autoscan("[" + shift + "                                                                          └───────────────┘" + "]");

        m_printEngine.addEmptyStr();
        m_printEngine.autoscan("[" + shift + "                                                                          ┌───────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "II.  Количество операционных касс кассового узла уполномоченного банка    │###############│" + "]", nCashbox, "r:ex_B(T)");
        m_printEngine.autoscan("[" + shift + "     (его филиала), совершавших операции с наличной иностранной валютой и │               │" + "]");
        m_printEngine.autoscan("[" + shift + "     (или) чеками в иностранной валюте в отчетном периоде                 │###############│" + "]", "", "ex_B(B)");
        m_printEngine.autoscan("[" + shift + "                                                                          └───────────────┘" + "]");

        m_printEngine.addEmptyStr();
        m_printEngine.autoscan("[" + shift + "                                                                          ┌───────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "III. Код территории по ОКАТО внутренних структурных подразделений         │###############│" + "]", okatoCode, "r:ex_B(BT)");
        m_printEngine.autoscan("[" + shift + "                                                                          └───────────────┘" + "]");

        m_printEngine.addEmptyStr();
    end;

    private macro printPart1Row(rowCode, name, datasource, cellType, additionalFormatSpecifier)
        var dataset     = datasource.get(rowCode);
        var template    = getTableTemplate(PART_1_TABLE_NAME);
        var dataColumns = template.getDataColumns();

        if (index(rowCode, ".") == 0)
            m_printEngine.addPrintCell(rowCode, 0, 0, dataColumns.value(0).format + additionalFormatSpecifier, cellType);
            m_printEngine.addPrintCell(name, m_printEngine.getWidthBeforeCol(3)-m_printEngine.getWidthBeforeCol(1)-1, 0, dataColumns.value(1).format + additionalFormatSpecifier);
        else
            m_printEngine.addPrintCell(" ", 0, 0, dataColumns.value(0).format + additionalFormatSpecifier, cellType);
            m_printEngine.addPrintCell(rowCode, 0, 0, dataColumns.value(1).format + additionalFormatSpecifier);
            m_printEngine.addPrintCell(name, 0, 0, dataColumns.value(1).format + additionalFormatSpecifier);
        end;

        var i = 2;
        while (i < dataColumns.size)
            m_printEngine.addPrintCell(nvl(dataset.get(dataColumns.value(i).datasourceName), ""), dataColumns.value(i).width, 3, dataColumns.value(i).format + additionalFormatSpecifier);
            i = i + 1;
        end;

        m_printEngine.addStr();
    end;

    private macro getColWidthTable(column)
        throw(TPureVirtualMethodCallException("TWinRepView_3468::getColWidthTable"));
    end;

    private macro addPartHeader(headerId)
        throw(TPureVirtualMethodCallException("TWinRepView_3468::addPart22Header"));
    end;

    macro printPart1(isTotal, datasource, sheetNameOkatoCode, isNeedPartDescription)
        defaultParm(isNeedPartDescription, true);

        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));

        m_printEngine.addNewSheetBreak(getSheetCaption("1", sheetNameOkatoCode), getTableHeader(PART_1_TABLE_NAME));

        if (isNeedPartDescription)
            m_printEngine.addString("Раздел 1. Операции уполномоченного банка (его филиала) с наличной иностранной валютой и чеками в иностранной валюте", m_tableWidth+1, 0, getFormatSpecifier(STR_ALIGN_CENTER), REP_ELEM_STR);
            m_printEngine.addString("тыс. единиц иностранной валюты", m_tableWidth+1, 0, getFormatSpecifier(STR_ALIGN_RIGHT) + ":ex_B(b)", REP_ELEM_STR);
        end;

        addPartHeader(PART_1_TABLE_NAME);

        printPart1Row("1",     "Остаток наличной иностранной валюты и чеков в иностранной валюте на начало отчетного периода", datasource);
        printPart1Row("1.1",   "в том числе остаток наличной иностранной валюты",                                              datasource);
        printPart1Row("2",     "Поступило наличной иностранной валюты, всего\nв том числе:",                                   datasource);
        printPart1Row("2.1",   "ввезено банком в Российскую Федерацию",                                                        datasource);
        printPart1Row("2.2",   "получено от банков-резидентов",                                                                datasource);
        printPart1Row("2.3",   "поступило по межфилиальному обороту",                                                          datasource);
        printPart1Row("2.4",   "куплено у физических лиц и принято по конверсии, всего\nиз них:",                              datasource);
        printPart1Row("2.4.1", "куплено у физических лиц-нерезидентов и принято по конверсии",                                 datasource);
        printPart1Row("2.4.2", "куплено у физических лиц-резидентов и принято по конверсии",                                   datasource);
        printPart1Row("2.5",   "принято для зачисления на счета физических лиц-нерезидентов",                                  datasource);
        printPart1Row("2.6",   "принято для зачисления на счета физических лиц-резидентов",                                    datasource);
        printPart1Row("2.7",   "принято от физических лиц для переводов без открытия счета, всего\nиз них:",                   datasource);
        printPart1Row("2.7.1", "принято от физических лиц-нерезидентов для переводов без открытия счета",                      datasource);
        printPart1Row("2.7.2", "принято от физических лиц-резидентов для переводов без открытия счета",                        datasource);
        printPart1Row("2.8",   "прочие поступления наличной иностранной валюты",                                               datasource);
        printPart1Row("3",     "Поступило  чеков в иностранной валюте, всего\nв том числе:",                                   datasource);
        printPart1Row("3.1",   "куплено у физических лиц-нерезидентов (оплачено физическим лицам-нерезидентам)",               datasource);
        printPart1Row("3.2",   "куплено у физических лиц-резидентов (оплачено физическим лицам-резидентам)",                   datasource);
        printPart1Row("3.3",   "прочие поступления  чеков",                                                                    datasource);
        printPart1Row("4",     "Израсходовано наличной иностранной валюты, всего\nв том числе:",                               datasource);
        printPart1Row("4.1",   "вывезено банком из Российской федерации",                                                      datasource);
        printPart1Row("4.2",   "выдано банкам-резидентам",                                                                     datasource);
        printPart1Row("4.3",   "израсходовано по межфилиальному обороту",                                                      datasource);
        printPart1Row("4.4",   "продано физическим лицам и выдано по конверсии, всего\nиз них:",                               datasource);
        printPart1Row("4.4.1", "продано физическим лицам-нерезидентам и выдано по конверсии",                                  datasource);
        printPart1Row("4.4.2", "продано физическим лицам-резидентам и выдано по конверсии",                                    datasource);
        printPart1Row("4.5",   "выдано со счетов физических лиц-нерезидентов",                                                 datasource);
        printPart1Row("4.6",   "выдано со счетов физических лиц-резидентов",                                                   datasource);
        printPart1Row("4.7",   "выдано физическим лицам переводов без открытия счета, всего\nиз них:",                         datasource);
        printPart1Row("4.7.1", "выдано физическим лицам-нерезидентам переводов без открытия счетов",                           datasource);
        printPart1Row("4.7.2", "выдано физическим лицам-резидентам переводов без открытия счета",                              datasource);
        printPart1Row("4.8",   "прочие расходования наличной иностранной валюты",                                              datasource);
        printPart1Row("5",     "Израсходовано  чеков в иностранной валюте, всего\nв том числе",                                datasource);
        printPart1Row("5.1",   "продано физическим лицам-нерезидентам",                                                        datasource);
        printPart1Row("5.2",   "продано физическим лицам-резидентам",                                                          datasource);
        printPart1Row("5.3",   "прочие расходования  чеков",                                                                   datasource);
        printPart1Row("6",     "Остаток наличной иностранной валюты и чеков в иностранной валюте на конец отчетного периода",  datasource);
        printPart1Row("6.1",   "в том числе остаток наличной иностранной валюты", datasource);

        m_printEngine.addEmptyStr();
    end;

    private macro printPart2(headerId, datasource, columns, totalsWidthCorrection, cellType, additionalFormatSpecifier)
        addPartHeader(headerId);

        var dataColumns = getTableTemplate(headerId).getDataColumns();
        datasource.moveFirst();
        while (not datasource.isDone())
            var currencyData = datasource.currentItem;

            var j = 0;
            for (var i, dataColumns)
                var value = currencyData.get(i.datasourceName);
                var precision = ternary (valType(value) == V_MONEY, 3, 0);
                m_printEngine.addPrintCell(nvl(value, ""), getColWidthTable(j), precision, i.format + additionalFormatSpecifier, cellType);
                j = j + 1;
            end;
            m_printEngine.addStr();

            datasource.moveNext();
        end;

        m_printEngine.addPrintCell(" ", 0, 0, "r" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell("Итого", getColWidthTable(1) + totalsWidthCorrection + getColWidthTable(2), 0, "l" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(" X ", getColWidthTable(3), 0, "c" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(datasource.getTotal(columns.value(0)), getColWidthTable(4), 3, "r" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(datasource.getTotal(columns.value(1)), getColWidthTable(5), 0, "r" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(" X ", getColWidthTable(6), 0, "c" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(datasource.getTotal(columns.value(2)), getColWidthTable(7), 0, "r" + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(datasource.getTotal(columns.value(3)), getColWidthTable(8), 0, "r" + additionalFormatSpecifier, cellType);
        m_printEngine.addStr();

        m_printEngine.addEmptyStr();
    end;

    macro printPart21(datasource, totalsWidthCorrection, cellType, additionalFormatSpecifier)
        m_tableWidth = m_printEngine.getHeaderWidth();
        m_reportWidth = m_tableWidth+1;

        m_printEngine.addString("Раздел 2. Справочная информация об операциях физических лиц с наличной иностранной валютой", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_CENTER), REP_ELEM_STR);
        m_printEngine.addString("2.1 Поступление в уполномоченный банк (его филиал) наличной иностранной валюты", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_LEFT) + ":ex_B(b)", REP_ELEM_STR);

        printPart2(PART_21_TABLE_NAME, datasource, arrCreate("5","6","8","9"), totalsWidthCorrection, cellType, additionalFormatSpecifier);
    end;

    macro printPart22(datasource, totalsWidthCorrection, cellType, additionalFormatSpecifier)
        m_tableWidth = m_printEngine.getHeaderWidth();
        m_reportWidth = m_tableWidth+1;

        m_printEngine.addString("2.2 Расходование уполномоченным банком (его филиалом) наличной иностранной валюты", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_LEFT) + ":ex_B(b)", REP_ELEM_STR);

        printPart2(PART_22_TABLE_NAME, datasource, arrCreate("11","12","14","15"), totalsWidthCorrection, cellType, additionalFormatSpecifier);
    end;

    macro printSignatures()
        // Подписи - т.е. TSignatureZone.
        // Данные для печати извлекаются из файла, сформированного стандартным вызовом TPrintableView.printSignatureZone()
        m_printableView.setReportWidth(DEFAULT_REPORT_WIDTH);
        m_printableView.excludeAttribute(AC_SECOND_PERSON);
        m_printableView.setOutputFile(false);
        m_printableView.printSignatureZone();
        m_printableView.resetOutputFile();
        var outstream = TStreamDoc(m_printableView.getFileName(), "R");
        var str = "";
        while (outstream.readLine(str))
            if (str == "")
                m_printEngine.addEmptyStr();
            else
                m_printEngine.addString(str, DEFAULT_REPORT_WIDTH, 0, getFormatSpecifier(STR_ALIGN_LEFT), REP_ELEM_STR);
            end;
        end;

        m_printEngine.addEmptyStr();
    end;

    macro initialize(currencies : Object)
        m_cachedHeaderMaker = objectFactoryInstance().createTableHeaderMaker(currencies); //TTableHeaderMaker(currencies);
    end;

    private macro constructorTWinRepView_3468()
        m_isFirstSheet  = true;
        m_printableView = TPrintableView_2851("ОТЧЕТ ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", RCB_PK_MONTH, DATE_IN_PERIOD_FORMAT);

        m_printEngine = TMakeReport("", SEP_DEFAULT, 100000);
        m_printEngine.setFlagShowMidSeparator(true);
        m_printEngine.setFlagShowGrid(true);

        flagHighQualityRep = true;
    end;

    constructorTWinRepView_3468();
end;

/**
 * Печатное представление plain text по 3468-У
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.0
 */
class (TWinRepView_3468) TPlainTextView601_3468()
    private macro getColWidthTable(column)
        return m_printEngine.getColWidthTable(column);
    end;

    private macro addPartHeader(headerId)
        return;
    end;

    private macro printPart1Row(rowCode, name, datasource)
        printPart1Row(rowCode, name, datasource, REP_ELEM_TABL, "");
    end;

    macro printPart21(isTotal, datasource, sheetNameOkatoCode)
        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));
        m_printEngine.addNewSheetBreak(getSheetCaption("2.1", sheetNameOkatoCode), getTableHeader(PART_21_TABLE_NAME));
        printPart21(datasource, 1, REP_ELEM_TABL, "");
    end;

    macro printPart22(isTotal, datasource, sheetNameOkatoCode)
        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));
        m_printEngine.addNewSheetBreak(getSheetCaption("2.2", sheetNameOkatoCode), getTableHeader(PART_22_TABLE_NAME));
        printPart22(datasource, 1, REP_ELEM_TABL, "");
    end;

    macro print()
        m_printableView.setOutputFile(false);
        m_printEngine.printRep();
    end;

    macro show()
        m_printableView.show();
    end;

    private macro constructorTPlainTextView601_3468()
        initTWinRepView_3468();

        m_printEngine.setWinRepOutput(REP_OUTPUT_TEXT, REP_FORMAT_TXT);
        m_printEngine.setFlagShowIndicator(false);
        m_printEngine.setFileNameTxt(m_printableView.getFileName());
    end;

    constructorTPlainTextView601_3468();
end;

class (TNamesZone_4212) TNamesZone_4212_601(formName, formOkudCode, formPeriodicity, periodFormat)
    initTNamesZone_4212(formName, formOkudCode, formPeriodicity, periodFormat);

    macro print(reportWidth, bankNameDescription)
        var i = 0;
        var formName : TArray;

        println();

        formName = strTransferByWord(m_formName, reportWidth, STR_ALIGN_CENTER);
        while (i < formName.size)
            println(strAlign(formName[i], reportWidth, STR_ALIGN_CENTER));
            i = i + 1;
        end;

        println();
        println(strAlign(getPeriodName(), reportWidth, STR_ALIGN_CENTER));
        println();

        printLendingAgencyName(reportWidth, bankNameDescription);

        var postAddressDescription = "Адрес (место нахождения) уполномоченного банка (его филиала) ";
        var postAddress : TArray;
        postAddress = strTransferByWord(ternary((m_lendingAgencyPostalAdress == ""), " ", m_lendingAgencyPostalAdress), reportWidth - strLen(postAddressDescription), STR_ALIGN_LEFT);
        i = 1;
        println(strAlign(postAddressDescription + postAddress[0], reportWidth, STR_ALIGN_LEFT));
        while (i < postAddress.size)
            println(strAlign(mkStr(" ", strLen(postAddressDescription)) + postAddress[i], reportWidth, STR_ALIGN_LEFT));
            i = i + 1;
        end;

        println();

        if (not isAttributeExcluded(AC_FORM_OKUD_CODE))
            println(getOkudString(reportWidth));
        end;

        if (not isAttributeExcluded(AC_FORM_PERIODICITY))
            println(strAlign(m_formPeriodicity, reportWidth, STR_ALIGN_RIGHT));
        end;

        printUnitName(reportWidth);

        println();
    end;
end;

class (TPrintableView) TPrintableView_4212_601(formName, formOkudCode, formPeriodicity, periodFormat)
    /**
     *  Виртуальный конструктор для TPrintableView.
     */
    private macro constructorTPrintableReport(formName, formOkudCode, formPeriodicity, periodFormat)
        defineFileName(formOkudCode);

        m_lendingAgencyCodeZone = TLendingAgencyCodeZone_2851();
        m_namesZone             = TNamesZone_4212_601(formName, formOkudCode, formPeriodicity, periodFormat);
        m_signatureZone         = TSignatureZone_4212();

        m_standardZoneWidth = 0;
    end;

    initTPrintableView(formName, formOkudCode, formPeriodicity, periodFormat);
end;

class (TPlainTextView601_3468) TPlainTextView601_4212()

    macro printHead(isTotal, nBranch, sheetNameOkatoCode)
        var bankCodesTableWidth = 86;

        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));

        if (m_isFirstSheet)
            m_isFirstSheet = false;
            m_printEngine.init(getTableHeader(PART_1_TABLE_NAME));
            m_printEngine.getCurSheet().setSheetName(getSheetCaption("0", sheetNameOkatoCode));
        else
            m_printEngine.addNewSheetBreak(getSheetCaption("0", sheetNameOkatoCode), getTableHeader(PART_1_TABLE_NAME));
        end;

        m_tableWidth  = m_printEngine.getHeaderWidth();
        m_reportWidth = max(m_tableWidth+1, max(DEFAULT_REPORT_WIDTH, bankCodesTableWidth));

        var shift = "";
        if (bankCodesTableWidth < m_reportWidth)
            shift = mkstr(" ", m_reportWidth - bankCodesTableWidth);
        end;

        var okatoCode = m_printableView.getLendingAgencyCodeZone().getOkato();
        var okpoCode  = m_printableView.getLendingAgencyCodeZone().getOkpo();
        var regNumber = m_printableView.getLendingAgencyCodeZone().getRegistrationNumber();

        m_printEngine.addString("Банковская отчетность", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_RIGHT), REP_ELEM_STR);

        // Таблица с кодами кредитной организации
        m_printEngine.autoscan("[" + shift + "┌────────────────┬─────────────────────────────────────┬─────────────────────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#####################################│#############################│" + "]",
                          "Код территории", "c:ex_B(t)", "Код кредитной организации (филиала)", "c:ex_B(t)", "Число филиалов,", "c:ex_B(t)");
        m_printEngine.autoscan("[" + shift + "│    по ОКАТО    ├─────────────┬───────────────────────┤    осуществлявших операции  │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │   по ОКПО   │ Регистрационный номер │    с наличной иностранной   │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │             │   (порядковый номер)  │           валютой           │" + "]");
        m_printEngine.autoscan("[" + shift + "├────────────────┼─────────────┼───────────────────────┼─────────────────────────────┤" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#############│#######################│#############################│" + "]",
                                           okatoCode, "c:ex_B(BT)",  okpoCode, "c:ex_B(BT)", regNumber, "c:ex_B(BT)", nBranch, "c:ex_B(BT)");
        m_printEngine.autoscan("[" + shift + "└────────────────┴─────────────┴───────────────────────┴─────────────────────────────┘" + "]");

        // Название формы и банка, адрес банка, код формы и периодичность - т.е. TNamesZone.
        // Данные для печати извлекаются из файла, сформированного стандартным вызовом TPrintableView.printNamesZone()
        m_printableView.setReportWidth(m_reportWidth);
        m_printableView.changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        m_printableView.excludeAttribute(AC_FORM_UNIT);
        m_printableView.setOutputFile(false);
        m_printableView.printNamesZone("Полное или сокращенное фирменное наименование уполномоченного банка (наименование его филиала) ");
        m_printableView.resetOutputFile();
        var outstream = TStreamDoc(m_printableView.getFileName(), "R");
        var str = "";
        while (outstream.readLine(str))
            if (str == "")
                m_printEngine.addEmptyStr();
            else
                m_printEngine.addString(str, m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_LEFT), REP_ELEM_STR);
            end;
        end;

        m_printEngine.addEmptyStr();
    end;

    private macro printPart1Row(rowCode, name, datasource, cellType, additionalFormatSpecifier)
        var dataset = datasource.get(rowCode);

        var template    = getTableTemplate(PART_1_TABLE_NAME);
        var dataColumns = template.getDataColumns();

        m_printEngine.addPrintCell(rowCode, 0, 0, dataColumns.value(0).format + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(name, m_printEngine.getWidthBeforeCol(3)-m_printEngine.getWidthBeforeCol(1)-1, 0, dataColumns.value(1).format + additionalFormatSpecifier);

        var i = 2;
        while (i < dataColumns.size)
            m_printEngine.addPrintCell(nvl(dataset.get(dataColumns.value(i).datasourceName), ""), dataColumns.value(i).width, 3, dataColumns.value(i).format + additionalFormatSpecifier);
            i = i + 1;
        end;

        m_printEngine.addStr();
    end;

    private macro constructorTWinRepView_4212()
        initTPlainTextView601_3468();

        m_printableView = TPrintableView_4212_601("ОТЧЕТ ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", RCB_PK_MONTH, DATE_IN_PERIOD_FORMAT);
    end;

    constructorTWinRepView_4212();
end;

/**
 * Печатное представление Excel по 3468-У
 *
 * @since   v.6.20.031.031
 * @author  ABP
 * @version 1.0
 */
class (TWinRepView_3468) TExcelView601_3468()
    private macro getColWidthTable(column)
        return m_printEngine.getColWidthTable(column) + 1;
    end;

    private macro addPartHeader(headerId)
        var firstRow = 0;
        var lastRow = 0;

        firstRow = m_printEngine.getNumLastStr() + 1;
        m_printEngine.autoscan("[" + getTableHeader(headerId) + "]");
        lastRow = m_printEngine.getNumLastStr();

        var colunmCount = 50;//m_printEngine.getCountColTable();
        var headerFormat = ":ex_FS(" + m_printEngine.getCurSheet().hd_FS + "):ex_BC(" +  m_printEngine.getCurSheet().hd_BkGrColor + ")";

        var i, j;
        i = firstRow;
        while (i <= lastRow)
            j = 0;
            while (j < colunmCount)
                m_printEngine.setCellFormat(i, j, headerFormat);
                j = j + 1;
            end;

            i = i + 1;
        end;
    end;

    private macro printPart1Row(rowCode, name, datasource)
        printPart1Row(rowCode, name, datasource, REP_ELEM_STR, ":ex_B(btlr)");
    end;

    macro printPart21(isTotal, datasource, sheetNameOkatoCode)
        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));
        m_printEngine.addNewSheetBreak(getSheetCaption("2", sheetNameOkatoCode), getTableHeader(PART_21_TABLE_NAME));
        printPart21(datasource, 0, REP_ELEM_STR, ":ex_B(btlr)");
    end;

    macro printPart22(isTotal, datasource, sheetNameOkatoCode)
        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));
        printPart22(datasource, 0, REP_ELEM_STR, ":ex_B(btlr)");
    end;

    macro print()
        m_printEngine.printWinRep();
    end;

    macro show()
        m_printEngine.showWinRep();
    end;

    /**
     *  Конструктор.
     */
    private macro constructorTExcelView601_3468()
        initTWinRepView_3468();

        m_printEngine.setWinRepOutput(WINREP_OUTPUT_EXCEL, WINREP_FORMAT_XLSX);
        m_printEngine.setFlagShowIndicator(false);

        var fName = "";
        splitFile(m_printableView.getFileName(), fName);
        m_printEngine.setFileNameWin(fName);
    end;

    constructorTExcelView601_3468();
end;

class (TExcelView601_3468) TExcelView601_4212()

    macro printHead(isTotal, nBranch, sheetNameOkatoCode)
        var bankCodesTableWidth = 86;

        sheetNameOkatoCode = ternary(isTotal, strRpad(sheetNameOkatoCode, 5, "0"), strRpad(sheetNameOkatoCode, 4, "0"));

        if (m_isFirstSheet)
            m_isFirstSheet = false;
            m_printEngine.init(getTableHeader(PART_1_TABLE_NAME));
            m_printEngine.getCurSheet().setSheetName(getSheetCaption("0", sheetNameOkatoCode));
        else
            m_printEngine.addNewSheetBreak(getSheetCaption("0", sheetNameOkatoCode), getTableHeader(PART_1_TABLE_NAME));
        end;

        m_tableWidth = m_printEngine.getHeaderWidth();
        m_reportWidth = max(m_tableWidth+1, max(DEFAULT_REPORT_WIDTH, bankCodesTableWidth));

        var shift = "";
        if (bankCodesTableWidth < m_reportWidth)
            shift = mkstr(" ", m_reportWidth - bankCodesTableWidth);
        end;

        var okatoCode = m_printableView.getLendingAgencyCodeZone().getOkato();
        var okpoCode  = m_printableView.getLendingAgencyCodeZone().getOkpo();
        var regNumber = m_printableView.getLendingAgencyCodeZone().getRegistrationNumber();

        m_printEngine.addString("Банковская отчетность", m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_RIGHT), REP_ELEM_STR);

        // Таблица с кодами кредитной организации
        m_printEngine.autoscan("[" + shift + "┌────────────────┬─────────────────────────────────────┬─────────────────────────────┐" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#####################################│#############################│" + "]",
                          "Код территории", "c:ex_B(t)", "Код кредитной организации (филиала)", "c:ex_B(t)", "Число филиалов,", "c:ex_B(t)");
        m_printEngine.autoscan("[" + shift + "│    по ОКАТО    ├─────────────┬───────────────────────┤    осуществлявших операции  │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │   по ОКПО   │ Регистрационный номер │    с наличной иностранной   │" + "]");
        m_printEngine.autoscan("[" + shift + "│                │             │   (порядковый номер)  │           валютой           │" + "]");
        m_printEngine.autoscan("[" + shift + "├────────────────┼─────────────┼───────────────────────┼─────────────────────────────┤" + "]");
        m_printEngine.autoscan("[" + shift + "│################│#############│#######################│#############################│" + "]",
                                           okatoCode, "c:ex_B(BT)",  okpoCode, "c:ex_B(BT)", regNumber, "c:ex_B(BT)", nBranch, "c:ex_B(BT)");
        m_printEngine.autoscan("[" + shift + "└────────────────┴─────────────┴───────────────────────┴─────────────────────────────┘" + "]");

        // Название формы и банка, адрес банка, код формы и периодичность - т.е. TNamesZone.
        // Данные для печати извлекаются из файла, сформированного стандартным вызовом TPrintableView.printNamesZone()
        m_printableView.setReportWidth(m_reportWidth);
        m_printableView.changePrintZone(MC_LEADING_AGENCY_NAME_WITH_EMPOWERED_BANK);
        m_printableView.excludeAttribute(AC_FORM_UNIT);
        m_printableView.setOutputFile(false);
        m_printableView.printNamesZone("Полное или сокращенное фирменное наименование уполномоченного банка (наименование его филиала) ");
        m_printableView.resetOutputFile();
        var outstream = TStreamDoc(m_printableView.getFileName(), "R");
        var str = "";
        while (outstream.readLine(str))
            if (str == "")
                m_printEngine.addEmptyStr();
            else
                m_printEngine.addString(str, m_reportWidth, 0, getFormatSpecifier(STR_ALIGN_LEFT), REP_ELEM_STR);
            end;
        end;

        m_printEngine.addEmptyStr();
    end;

    private macro printPart1Row(rowCode, name, datasource, cellType, additionalFormatSpecifier)
        var dataset = datasource.get(rowCode);

        var template = getTableTemplate(PART_1_TABLE_NAME);
        var dataColumns = template.getDataColumns();

        m_printEngine.addPrintCell(rowCode, 0, 0, dataColumns.value(0).format + additionalFormatSpecifier, cellType);
        m_printEngine.addPrintCell(name, m_printEngine.getWidthBeforeCol(3)-m_printEngine.getWidthBeforeCol(1)-1, 0, dataColumns.value(1).format + additionalFormatSpecifier);

        var i = 2;
        while (i < dataColumns.size)
            m_printEngine.addPrintCell(nvl(dataset.get(dataColumns.value(i).datasourceName), ""), dataColumns.value(i).width, 3, dataColumns.value(i).format + additionalFormatSpecifier);
            i = i + 1;
        end;

        m_printEngine.addStr();
    end;

    private macro constructorTExcelView601_4212()
        initTExcelView601_3468();

        m_printableView = TPrintableView_4212_601("ОТЧЕТ ОБ ОПЕРАЦИЯХ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ В ИНОСТРАННОЙ ВАЛЮТЕ", "0409601", RCB_PK_MONTH, DATE_IN_PERIOD_FORMAT);
    end;

    constructorTExcelView601_4212();
end;