/*
$Name:          f601PtkPsdExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 601. Контроллер экспорта
*/

/**
 * Форма 601. Контроллер экспорта данных отчета в АС ПСД.
 *
 * @since   10.05.2012
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

import RcbPtkPsdView;

/**
 * Фильтр для получения итогового значение для подразделов 2.1 и 2.2 раздела 2.
 *
 * @param     columnId   наименование колонки по которой будем считать итог.
*/
private class TPart2ColumnFilter(part : String,columnId : String)
        private var m_columnId = columnId;
        private var m_part = part;

        macro isSuitable(obj : Object)
            return (obj.fieldValue("part").exact       == m_part)
               and (obj.fieldValue("code").exact       == m_columnId)
               and (obj.fieldValue("backOffice").exact == BONothing);
        end;
     end;

/**
 * Операция экспорта в АС ПСД для раздела.
 */
class TPtkPsdExportPartController2742(view, part, head) 
     /**
      * Представление печати.
      */
     private var m_view            = view;
     /**
      * Ссылка на раздел.
      */
     private var m_part            = part;
     /**
      * Заголовок раздела.
      */
     private var m_applicationCode = head;
     
     private macro getPart2ColumnTotalValue(part : String, okatoPart : TOkatoPart, columnId : String)
        var attribute      : Object = null;
        var compositeValue : Object = null;
        var iterator       : Object = okatoPart.getCompositeValue().createValueIterator();
        var fieldId        : String = "";
        var value  = 0;

        iterator.setFilter(TPart2ColumnFilter(part, columnId));
        iterator.moveFirst();
        while (not iterator.isDone())
            compositeValue = iterator.currentItem;
            attribute      = okatoPart.getAttribute(part, compositeValue.fieldValue("code").currentAsString);

            fieldId        = ternary(attribute.getType() == RCB_VT_ITEM, "itemValue", "moneyValue");
            if (valType(compositeValue.fieldValue(fieldId).current) != V_UNDEF)
                value = value + compositeValue.fieldValue(fieldId).current;
            end;
            iterator.moveNext();
        end;

        SetDefPrec(3);
        return String(value:f);

    end;
    
    private class TUserInputSorter()
        macro isLess(v1, v2)
            return v1.fieldValue("code").exact < v2.fieldValue("code").exact;
        end;
    end;

    class TFilterValue(str : String)
        var findStr = str;
        macro isSuitable(curValOfIterator)
            return (curValOfIterator.fieldValue("backOffice").exact == BONothing);
        end;
    end;

     /**
     * Печать раздела в файл экспорта.
     */

    macro execute()
        var codePart1 = TArray();
        codePart1[1] = "10";
        codePart1[11] = "11";
        codePart1[2] = "20";
        codePart1[21] = "21";
        codePart1[22] = "22";
        codePart1[23] = "23";
        codePart1[24] = "24";
        codePart1[241] = "241";
        codePart1[242] = "242";
        codePart1[25] = "25";
        codePart1[26] = "26";
        codePart1[271] = "27";
        codePart1[272] = "28";
        codePart1[28] = "29";
        codePart1[3] = "30";
        codePart1[31] = "31";
        codePart1[32] = "32";
        codePart1[33] = "33";
        codePart1[4] = "40";
        codePart1[41] = "41";
        codePart1[42] = "42";
        codePart1[43] = "43";
        codePart1[44] = "44";
        codePart1[441] = "441";
        codePart1[442] = "442";
        codePart1[45] = "45";
        codePart1[46] = "46";
        codePart1[471] = "47";
        codePart1[472] = "48";
        codePart1[48] = "49";
        codePart1[5] = "50";
        codePart1[51] = "51";
        codePart1[52] = "52";
        codePart1[53] = "53";
        codePart1[6] = "60";
        codePart1[61] = "61";
         
        var codePart21 = TArray();
        codePart21[4] = "4";
        codePart21[5] = "5";
        codePart21[51] = "51";
        codePart21[6] = "6";
        codePart21[61] = "61";
        codePart21[7] = "7";
        codePart21[8] = "8";
        codePart21[9] = "9";
         
        var codePart22 = TArray();
        codePart22[10] = "10";
        codePart22[11] = "11";
        codePart22[111] = "111";
        codePart22[12] = "12";
        codePart22[121] = "121";
        codePart22[13] = "13";
        codePart22[14] = "14";
        codePart22[15] = "15";
         
        var Р2_4_VVV;
        var Р2_10_VVV;
        var tmpVal;
        var tmpIndex;
        var isPrint = false;

        var compositeValue = m_part.getCompositeValue();
        var valueIterator = compositeValue.createValueIterator();
        var fiCodeIterator = rcbApplication().currentReport.attributeValue("КодыФИ").createValueIterator();
        valueIterator.setSortOrder(TUserInputSorter());
        valueIterator.setFilter(TFilterValue());
        valueIterator.moveFirst();
        fiCodeIterator.moveFirst;
        while (not fiCodeIterator.isDone)
            while (not valueIterator.isDone)
                if ((valueIterator.currentItem.fieldValue("code").currentAsString == "2.7") 
                    or (valueIterator.currentItem.fieldValue("code").currentAsString == "4.7"))
                        valueIterator.moveNext();
                        continue;
                end;
                if ((fiCodeIterator.currentItem.fieldValue("code").currentAsString == valueIterator.currentItem.fieldValue("fiCode").currentAsString)
                    and (valueIterator.currentItem.fieldValue("part").currentAsString == "1"))
                        if (isPrint == false)
                            m_view.printRow(m_applicationCode, fiCodeIterator.currentItem.fieldValue("code").currentAsString,
                                        "00", fiCodeIterator.currentItem.fieldValue("code").currentAsString);
                        end;
                        if (Money(tmpVal = valueIterator.currentItem.fieldValue("moneyValue").currentAsString) != 0)
                            m_view.printRow(m_applicationCode, valueIterator.currentItem.fieldValue("fiCode").currentAsString, 
                                            codePart1[StrSubst(valueIterator.currentItem.fieldValue("code").currentAsString, ".", "")], tmpVal);
                            isPrint = true;
                        end;
                end;
                    valueIterator.moveNext();
            end;
            isPrint = false;
            valueIterator.moveFirst();
            fiCodeIterator.moveNext();
        end;
             
        valueIterator.moveFirst();
        fiCodeIterator.moveFirst;
        isPrint = false;
        while (not fiCodeIterator.isDone)
            while (not valueIterator.isDone)
                if ((fiCodeIterator.currentItem.fieldValue("code").currentAsString == valueIterator.currentItem.fieldValue("fiCode").currentAsString)
                    and (valueIterator.currentItem.fieldValue("part").currentAsString == "2.1"))
                        tmpIndex = valueIterator.currentItem.fieldValue("code").currentAsString + 1;
                        if (isPrint == false)
                            m_view.printRow("F601_1", fiCodeIterator.currentItem.fieldValue("code").currentAsString, "2", 
                                fiCodeIterator.currentItem.fieldValue("code").currentAsString);
                        end;
                        if (valueIterator.currentItem.fieldValue("code").currentAsString == "4")
                            Р2_4_VVV = Money(valueIterator.currentItem.fieldValue("moneyValue").currentAsString);
                        end;
                        if ((tmpIndex == "51") or (tmpIndex == "61"))
                            if (tmpIndex == "51")
                                tmpVal = Money(valueIterator.currentItem.fieldValue("moneyValue").currentAsString) / Р2_4_VVV;
                            else
                                tmpVal = Р2_4_VVV * 1000 / Money(valueIterator.currentItem.fieldValue("itemValue").currentAsString);
                            end;
                            if (tmpVal != 0)
                                m_view.printRow("F601_1", valueIterator.currentItem.fieldValue("fiCode").currentAsString, codePart21[tmpIndex], tmpVal);
                            end;
                            valueIterator.moveNext();
                            continue;
                        end;
                        if (Money(tmpVal = valueIterator.currentItem.fieldValue("itemValue").currentAsString) != 0)
                            m_view.printRow("F601_1", valueIterator.currentItem.fieldValue("fiCode").currentAsString, 
                                            codePart21[valueIterator.currentItem.fieldValue("code").currentAsString], tmpVal);
                            isPrint = true;
                        end;
                end;
                valueIterator.moveNext();
            end;
            isPrint = false;
            valueIterator.moveFirst();
            fiCodeIterator.moveNext();
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.1", m_part, "5")) != 0)
            m_view.printRow("F601_1I", "1I", "I", "5", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.1", m_part, "6")) != 0)
            m_view.printRow("F601_1I", "1I", "I", "6", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.1", m_part, "8")) != 0)
            m_view.printRow("F601_1I", "1I", "I", "8", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.1", m_part, "9")) != 0)
            m_view.printRow("F601_1I", "1I", "I", "9", tmpVal);
        end;
        valueIterator.moveFirst();
        fiCodeIterator.moveFirst;
        isPrint = false;
        while (not fiCodeIterator.isDone)
            while (not valueIterator.isDone)
                if ((fiCodeIterator.currentItem.fieldValue("code").currentAsString == valueIterator.currentItem.fieldValue("fiCode").currentAsString)
                    and (valueIterator.currentItem.fieldValue("part").currentAsString == "2.2"))
                        tmpIndex = valueIterator.currentItem.fieldValue("code").currentAsString + 1;
                        if (isPrint == false)
                            m_view.printRow("F601_2", fiCodeIterator.currentItem.fieldValue("code").currentAsString, "2", 
                                fiCodeIterator.currentItem.fieldValue("code").currentAsString);
                        end;
                        if (valueIterator.currentItem.fieldValue("code").currentAsString == "10")
                            Р2_10_VVV = Money(valueIterator.currentItem.fieldValue("moneyValue").currentAsString);
                        end;
                        if ((tmpIndex == "111") or (tmpIndex == "121"))
                            if (tmpIndex == "111")
                                tmpVal = Money(valueIterator.currentItem.fieldValue("moneyValue").currentAsString) / Р2_10_VVV;
                            else
                                tmpVal = Р2_10_VVV * 1000 / Money(valueIterator.currentItem.fieldValue("itemValue").currentAsString);
                            end;
                            if (tmpVal != 0)
                                m_view.printRow("F601_2", valueIterator.currentItem.fieldValue("fiCode").currentAsString, codePart22[tmpIndex], tmpVal);
                            end;
                            valueIterator.moveNext();
                        continue;
                        end;
                        if (Money(tmpVal = valueIterator.currentItem.fieldValue("itemValue").currentAsString) != 0)
                            m_view.printRow("F601_2", valueIterator.currentItem.fieldValue("fiCode").currentAsString, 
                                            codePart22[valueIterator.currentItem.fieldValue("code").currentAsString], tmpVal);
                            isPrint = true;
                        end;
                end; 
                    valueIterator.moveNext();
            end;
                isPrint = false;
                valueIterator.moveFirst();
                fiCodeIterator.moveNext();
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.2", m_part, "11")) != 0)
            m_view.printRow("F601_2I", "2I", "I", "11", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.2", m_part, "12")) != 0)
            m_view.printRow("F601_2I", "2I", "I", "12", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.2", m_part, "14")) != 0)
            m_view.printRow("F601_2I", "2I", "I", "14", tmpVal);
        end;
        if (Money(tmpVal = getPart2ColumnTotalValue("2.2", m_part, "15")) != 0)
            m_view.printRow("F601_2I", "2I", "I", "15", tmpVal);
        end;
    end;
end;        


class  TPtkPsdExportController()

    private var m_ptkPsdExportPartControllers : TArray;

    private var m_ptkPsdView;

    private var m_report;


    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = TPtkPsdView("601", rcbApplication().currentReport.context.period.endDate + 1, "rsansi");
        m_report                      = objectFactoryInstance.createReport();
    end;                                         

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;
        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

/**
 * Операция экспорта в АС ПСД отчета.
 */
class (TPtkPsdExportController)TPtkPsdExportController2742()

    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    private macro TPtkPsdExportController2742constructor()
        initTPtkPsdExportController();
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2742(m_ptkPsdView, m_report.getTotalPart(), "F_601");
    end;                                         

    TPtkPsdExportController2742constructor();
end;