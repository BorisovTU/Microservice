/*
$Name:          f601DataBank.mac
$Module:        Регламентированная отчетность
$Description:   "Форма 601. Классы банка данных.
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 601. Классы банка данных.

   CREATED : 13.12.07 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/**
 *  Общебанковские интеры и модули
 */

import RsbObjFactory;
import globals;
import cb_sql;
import repException;
import rsbDataSet;

import RcbTuneTable;

/**
 *  Интеры и модели подсистемы
 */
import departmentFilter;
import rcbconst;
import rcb_bo;
import rcb_lib;
import f601Global;
import f601Attribute;
import f601TuneTable;

// import testlib;
// var p = tsqlprofiler(gettxtfilename("!601!"));
// p.clear();
// p.on();
/**
 * Базовый класс банка данных.
 * Инкапсулирует получение данных из БД.
 */
class TDataBank()
    private var m_isCached : Bool = false;
    private var m_tuneTable = RcbTuneTable("dt601_dbt");

    /**
     * Очистить кэш данных.
     */
    private macro clear()
    end;

    /**
     * Кэшировать данные.
     */
    private macro cache()
        throw(TPureVirtualMethodCallException("TDataBank::cache"));
    end;

    private macro initializeCache()
        if (not m_isCached)
            clear();
            cache();
            m_isCached = true;
        end;
    end;

    /**
     * Конструктор.
     */
    macro constructor()
        initializeCache();
    end;

    /**
     * Получить список кодов валют, вошедших в отчет.
     */
    macro getReportFiCodes() : TArray
        throw(TPureVirtualMethodCallException("TDataBank::getReportFiCodes"));
    end;

    /**
     * Получить код ОКАТО итоговой части отчета по всему филиалу.
     */
    macro getTotalOkatoCode() : String
        // Спецификация:
        //
        throw(TPureVirtualMethodCallException("TDataBank::getTotalOkatoCode"));
    end;

    /**
     * Получить список кодов ОКАТО, участвующих
     * в расчете, отсортированный по возрастанию.
     */
    macro getOutsideDomainOkatoCodesSortedCollection() : TArray
        throw(TPureVirtualMethodCallException("TDataBank::getOutsideDomainOkatoCodesSortedCollection"));
    end;

    /**
     * Рассчитать значение символа по остаткам.
     *
     * @param     attribute атрибут отчета
     * @param     date  дата, за которую вычислять остаток.
     */
    macro calculateRestAttribute(attribute : TAttribute, date : Date)
        throw(TPureVirtualMethodCallException("TDataBank::calculateRestAttribute"));
    end;

    /**
     * Рассчитать значение атрибута по документам.
     *
     * @param     attribute атрибут отчета
     * @param     isDebet   признак дебетового оборота: если истина, то
     *                      вычисляются обороты по дебету, в противном
     *                      случае - по кредиту
     * @param     isMulticurrency   признак рассмотрения МВП
     */
    macro calculateDocumentAttribute(attribute : TAttribute, isDebet : Bool, isMulticurrency : Bool)
        throw(TPureVirtualMethodCallException("TDataBank::calculateDocumentAttribute"));
    end;

    /**
     * Рассчитать значение атрибута по статистике по операциям по договору.
     *
     * @param     attribute атрибут отчета
     * @param     sqlFilter фильтр на таблицу Vox-объекта
     */
    macro calculateDepositOperationsStatisticsAttribute(attribute : TAttribute, sqlFilter : String)
        throw(TPureVirtualMethodCallException("TDataBank::calculateDepositOperationsStatisticsAttribute"));
    end;

    /**
     * Рассчитать атрибут по статистике по валютно-обменным операциям.
     *
     * @param     attribute атрибут отчета
     * @param     isReceipts    рассматривать приход
     * @param     isReceiptsResult  вычислять сумму дохода
     * @param     sqlFilter фильтр на таблицу Vox-объекта
     */
    macro calculateExchangeStatisticsAttribute(attribute : TAttribute, isReceipts : Bool, isReceiptsResult : Bool, sqlFilter : String)
        throw(TPureVirtualMethodCallException("TDataBank::calculateExchangeStatisticsAttribute"));
    end;

    /**
     * Рассчитать атрибут по статистике по переводам без открытия счета.
     *
     * @param     attribute атрибут отчета
     * @param     sqlFilter фильтр на таблицу Vox-объекта
     */
    macro calculateTransferStatisticsAttributes(attribute : TAttribute, sqlFilter : String)
        throw(TPureVirtualMethodCallException("TDataBank::calculateTransferStatisticsAttributes"));
    end;
end;

/**
 * Банк данныз по 1881-У.
 */
class (TDataBank) TDataBank1881()
    /**
     * Конструктор базового объекта
     */
    initTDataBank();

    m_tuneTable.setInstructionFilter(RCB_I1881_DATE);

    /*
     * Получить маски балансовых счетов
     */
    private macro getBalanceMasks(part : String, code : String, backOffice : Integer) : String
        m_tuneTable.setUserFilter("t_application = " + getSqlString(part)
                           + " AND t_backOfice = " + backOffice
                           + " AND (t_line = " + getSqlString(code)
                           + "   OR t_chapter = " + getSqlString(code)
                           + "     )");

        var dataSet = m_tuneTable.getDataSet();

        if (dataSet.moveNext() and (dataSet.accountMasks != ""))
            return dataSet.accountMasks;
        end;

        return "*";
    end;

    /*
     * Получить маски символов
     */
    private macro getSymbolMasks(part : String, code : String, backOffice : Integer) : String
        var symbolMasks : String;

        m_tuneTable.setUserFilter("t_application = " + getSqlString(part)
                           + " AND t_backOfice = " + backOffice
                           + " AND (t_line = " + getSqlString(code)
                           + "   OR t_chapter = " + getSqlString(code)
                           + "     )");

        var dataSet = m_tuneTable.getDataSet();
        var str = "";

        if (dataSet.moveNext() and (dataSet.symb != ""))
            str = dataSet.symb;
            symbolMasks = "";
            while (index(str, ","))
                symbolMasks = symbolMasks + "," + getSqlString(strLPad(subStr(trim(str), 1, index(str, ",") - 1), 3, " "));

                str = subStr(str, index(str, ",") + 1);
            end;
            symbolMasks = subStr(symbolMasks + "," + getSqlString(strLPad(trim(str), 3, " ")), 2);
        end;

        return symbolMasks;
    end;

    private macro isNeedCalculate(attribute : TAttribute, backOffice : Integer) : Bool
        m_tuneTable.setUserFilter("t_application = " + getSqlString(attribute.getPart())
                           + " AND t_backOfice = " + backOffice
                           + " AND (t_line = " + getSqlString(attribute.getCode())
                           + "   OR t_chapter = " + getSqlString(attribute.getCode())
                           + "     )");

        var dataSet = m_tuneTable.getDataSet();

        return dataSet.moveNext();
    end;

    /**
     * Очистить кэш данных.
     */
    private macro clear()
        sql_execute("call rep_opt.resetDepartmentCodesCache()");
        sql_execute("TRUNCATE TABLE df601cb_tmp");
        sql_execute("TRUNCATE TABLE drcbExchangeStat_tmp");
        sql_execute("TRUNCATE TABLE drcbTransferStat_tmp");
        sql_execute("TRUNCATE TABLE drcbDepositOperStat_tmp");
    end;

    /**
     * Кэшировать данные.
     */

    private macro cacheCbData()
        /*
         *  Маска первой строки первого раздела является объемлющей для всего отчета.
         */
        var balanceMasks = getBalanceMasks("1", "1", BOCB);
        var planNumber   = rcbApplication.parameters.balancePlanNumber;

        var beginReportDate : Date = global.getRcbReport().context.period.beginDate;
        var endReportDate   : Date = global.getRcbReport().context.period.endDate;

        sql_execute("INSERT INTO df601cb_tmp(t_documentApplicationKey,"
            + "\n" +  "                        t_debetBalance, t_creditBalance,"
            + "\n" +  "                        t_documentSum, t_symbolCode, t_symbolValue,"
            + "\n" +  "                        t_okatoCode, t_isMulticurrency, t_debetFiid, t_creditFiid, t_fnCash)"
            + "\n" +  "SELECT "
            + "\n" +  "       accTrn.t_accTrnId                                                                                                 AS t_accTrnId,"
            + "\n" +  "       accblnc_payer.t_balance                                                                                           AS t_debetBalance,"
            + "\n" +  "       accblnc_receiver.t_balance                                                                                        AS t_creditBalance,"
            + "\n" +  "       CASE"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 1"
            + "\n" +  "               THEN accTrn.t_sum_payer"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 2"
            + "\n" +  "               THEN accTrn.t_sum_receiver"
            + "\n" +  "           ELSE accTrn.t_sum_payer"
            + "\n" +  "       END                                                                                                               AS t_documentSum,"
            + "\n" +  "       symbcash.t_symbol                                                                                                 AS t_symbolCode,"
            + "\n" +  "       NVL(symbcash.t_sum, accTrn.t_sum_payer)                                                                           AS t_symbolValue,"
            + "\n" +  "       CASE"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 1"
            + "\n" +  "               THEN NVL(depcode_payer_branch.t_okatocode, depcode_payer_dept.t_okatocode)"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 2"
            + "\n" +  "               THEN NVL(depcode_receiver_branch.t_okatocode, depcode_receiver_dept.t_okatocode)"
            + "\n" +  "           WHEN listsymb.t_type_symbol IS NULL"
            + "\n" +  "               THEN CASE"
            + "\n" +  "                        WHEN INSTR(account_payer.t_type_account, 'А') <> 0"
            + "\n" +  "                            THEN NVL(depcode_payer_branch.t_okatocode, depcode_payer_dept.t_okatocode)"
            + "\n" +  "                        WHEN INSTR(account_receiver.t_type_account, 'А') <> 0"
            + "\n" +  "                            THEN NVL(depcode_receiver_branch.t_okatocode, depcode_receiver_dept.t_okatocode)"
            + "\n" +  "                        ELSE CHR(1)"
            + "\n" +  "                    END"
            + "\n" +  "           ELSE CHR(1)"
            + "\n" +  "       END                                                                                                               AS t_okatocode,         "
            + "\n" +  "       CASE                                                                                                                                      "
            + "\n" +  "           WHEN (accTrn.t_fiid_payer = accTrn.t_fiid_receiver)                                                                                   "
            + "\n" +  "           THEN 0                                                                                                                                "
            + "\n" +  "           ELSE 1                                                                                                                                "
            + "\n" +  "       END                                                                                                               AS t_isMulticurrency,   "
            + "\n" +  "       accTrn.t_fiid_payer                                                                                               AS t_debetFiid,         "
            + "\n" +  "       accTrn.t_fiid_receiver                                                                                            AS t_creditFiid,        "
            + "\n" +  "       CASE                                                                                                                                      "
            + "\n" +  "           WHEN listsymb.t_type_symbol = 1                                                                                                       "
            + "\n" +  "               THEN NVL(depcode_payer_branch.t_departmentCode, depcode_payer_dept.t_departmentCode)                                              "
            + "\n" +  "           WHEN listsymb.t_type_symbol = 2                                                                                                       "
            + "\n" +  "               THEN NVL(depcode_receiver_branch.t_departmentCode, depcode_receiver_dept.t_departmentCode)                                        "
            + "\n" +  "           WHEN listsymb.t_type_symbol IS NULL                                                                                                   "
            + "\n" +  "               THEN CASE                                                                                                                         "
            + "\n" +  "                        WHEN INSTR(account_payer.t_type_account, 'А') <> 0                                                                       "
            + "\n" +  "                            THEN NVL(depcode_payer_branch.t_departmentCode, depcode_payer_dept.t_departmentCode)                                 "
            + "\n" +  "                        WHEN INSTR(account_receiver.t_type_account, 'А') <> 0                                                                    "
            + "\n" +  "                            THEN NVL(depcode_receiver_branch.t_departmentCode, depcode_receiver_dept.t_departmentCode)                           "
            + "\n" +  "                        ELSE 0                                                                                                                   "
            + "\n" +  "                    END                                                                                                                          "
            + "\n" +  "           ELSE 0                                                                                                                                "
            + "\n" +  "       END                                                                                                               AS t_fnCash             "
            + "\n" +  "  FROM daccTrn_dbt     accTrn,                                                                                                                   "
            + "\n" +  "       dsymbcash_dbt   symbcash,                                                                                                                 "
            + "\n" +  "       dlistsymb_dbt   listsymb,                                                                                                                 "
            + "\n" +  "       daccbalance_dbt accblnc_payer,                                                                                                            "
            + "\n" +  "       daccount_dbt    account_payer,                                                                                                            "
            + "\n" +  "       drepdepcode_vw  depcode_payer_dept,                                                                                                       "
            + "\n" +  "       drepdepcode_vw  depcode_payer_branch,                                                                                                     "
            + "\n" +  "       daccbalance_dbt accblnc_receiver,                                                                                                         "
            + "\n" +  "       daccount_dbt    account_receiver,                                                                                                         "
            + "\n" +  "       drepdepcode_vw  depcode_receiver_dept,                                                                                                    "
            + "\n" +  "       drepdepcode_vw  depcode_receiver_branch                                                                                                   "
            + "\n" +  " WHERE accTrn.t_chapter = 1                                                                                                                      "
            + "\n" +  "   AND accTrn.t_date_carry BETWEEN " + getSqlDate(beginReportDate) + " AND " + getSqlDate(endReportDate)
            + "\n" +  "   AND symbcash.t_docKind(+)                       = 7"
            + "\n" +  "   AND symbcash.t_accTrnId(+)                      = accTrn.t_accTrnId "
            + "\n" +  "   AND listsymb.t_docKind(+)                       = 7"
            + "\n" +  "   AND listsymb.t_symb_cash(+)                     = symbcash.t_symbol"
            + "\n" +  "   AND accblnc_payer.t_accountId                   = accTrn.t_accountId_payer"
            + "\n" +  "   AND accblnc_payer.t_numPlan                     = " + planNumber
            + "\n" +  "   AND account_payer.t_chapter                     = 1"
            + "\n" +  "   AND account_payer.t_accountId                   = accTrn.t_accountId_payer"
            + "\n" +  "   AND depcode_payer_dept.t_departmentCode(+)      = account_payer.t_department"
            + "\n" +  "   AND depcode_payer_branch.t_departmentCode(+)    = account_payer.t_branch"

            + "\n" +  "   AND accblnc_receiver.t_accountId                = accTrn.t_accountId_receiver"
            + "\n" +  "   AND accblnc_receiver.t_numPlan                  = " + planNumber
            + "\n" +  "   AND account_receiver.t_chapter                  = 1"
            + "\n" +  "   AND account_receiver.t_accountId                = accTrn.t_accountId_receiver"

            + "\n" +  "   AND depcode_receiver_dept.t_departmentCode(+)   = account_receiver.t_department"
            + "\n" +  "   AND depcode_receiver_branch.t_departmentCode(+) = account_receiver.t_branch"

            + "\n" +  "   AND (    (" + rcbAccountFilter.getAsSqlString("account_receiver") + " AND INSTR(account_receiver.t_type_account, 'А') <> 0)"
            + "\n" +  "         OR (" + rcbAccountFilter.getAsSqlString("account_payer")    + " AND INSTR(account_payer.t_type_account,    'А') <> 0)"
            + "\n" +  "       )"
            + "\n" +  "   AND (    " + convertMaskToSqlFormat(balanceMasks, "accblnc_payer.t_balance")
            + "\n" +  "         OR " + convertMaskToSqlFormat(balanceMasks, "accblnc_receiver.t_balance")
            + "\n" +  "       )"
            + "\n" +  "   AND (    accTrn.t_fiid_payer    <> " + NATCUR
            + "\n" +  "         OR accTrn.t_fiid_receiver <> " + NATCUR
            + "\n" +  "       )"
            + "\n" +  "   AND accTrn.t_result_carry <> " + RCB_DELTARATE_MCD
            + "\n" +  "   AND CASE"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 1 AND " + rcbAccountFilter.getAsSqlString("account_payer")
            + "\n" +  "               THEN 1"
            + "\n" +  "           WHEN listsymb.t_type_symbol = 2 AND " + rcbAccountFilter.getAsSqlString("account_receiver")
            + "\n" +  "               THEN 1"
            + "\n" +  "           WHEN listsymb.t_type_symbol IS NULL"
            + "\n" +  "               THEN 1"
            + "\n" +  "           ELSE 0"
            + "\n" +  "       END = 1"
            );
    end;

    private macro cacheRetailData()
        var filter = "    t_date >= " + getSqlDate(global.getRcbReport().context.period.beginDate)
            + "\n" + "AND t_date <= " + getSqlDate(global.getRcbReport().context.period.endDate)
            + "\n" + "AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("t_branchId","t_branchId");

        /*
         * кеширование данных объекта статистика по валютно-обменным операциям
         */
        sql_execute("INSERT INTO drcbExchangeStat_tmp (t_date,"
            + "\n"+ "                                  t_expenditureCurrencyCode,"
            + "\n"+ "                                  t_expenditureSum,"
            + "\n"+ "                                  t_fnCash,"
            + "\n"+ "                                  t_isCircularChequeOperation,"
            + "\n"+ "                                  t_isClientNotResident,"
            + "\n"+ "                                  t_isPlasticCardOperation,"
            + "\n"+ "                                  t_operationsCount,"
            + "\n"+ "                                  t_receiptsCurrencyCode,"
            + "\n"+ "                                  t_receiptsSum)"
            + "\n"+ "    SELECT t_date,"
            + "\n"+ "           t_expenditureCurrencyCode,"
            + "\n"+ "           t_expenditureSum,"
            + "\n"+ "           t_branchId,"
            + "\n"+ "           DECODE(t_isCircularChequeOperation, 0, CHR(0), 'X') t_isCircularChequeOperation,"
            + "\n"+ "           DECODE(t_isClientNotResident,       0, CHR(0), 'X') t_isClientNotResident,"
            + "\n"+ "           DECODE(t_isPlasticCardOperation,    0, CHR(0), 'X') t_isPlasticCardOperation,"
            + "\n"+ "           t_operationsCount,"
            + "\n"+ "           t_receiptsCurrencyCode,"
            + "\n"+ "           t_receiptsSum"
            + "\n"+ "      FROM repRtlExchStatistics_vw"
            + "\n"+ "     WHERE " + filter);

        /*
         * кеширование данных объекта статистика по переводам без открытия счета
         */
        sql_execute("INSERT INTO drcbTransferStat_tmp (t_clientCountryCode,"
            + "\n"+ "                                  t_currencyCode,"
            + "\n"+ "                                  t_date,"
            + "\n"+ "                                  t_fnCash,"
            + "\n"+ "                                  t_instruction117OperationCode,"
            + "\n"+ "                                  t_isClientNotResident,"
            + "\n"+ "                                  t_isReceipts,"
            + "\n"+ "                                  t_operationsCount,"
            + "\n"+ "                                  t_operationsSum)"
            + "\n"+ "    SELECT t_clientCountryCode,"
            + "\n"+ "           t_currencyCode,"
            + "\n"+ "           t_date,"
            + "\n"+ "           t_branchId,"
            + "\n"+ "           t_instruction117OperationCode,"
            + "\n"+ "           DECODE(t_isClientNotResident, 0, CHR(0), 'X') t_isClientNotResident,"
            + "\n"+ "           DECODE(t_isReceipts,          0, CHR(0), 'X') t_isReceipts,"
            + "\n"+ "           t_operationsCount,"
            + "\n"+ "           t_operationsSum"
            + "\n"+ "     FROM  repRtlTransferStatistics_vw"
            + "\n"+ "    WHERE " + filter);

        /*
         * кеширование данных объекта статистика по операциям по договору
         */
        sql_execute("INSERT INTO drcbDepositOperStat_tmp (t_clientCountryCode,"
            + "\n"+ "                                     t_currencyCode,"
            + "\n"+ "                                     t_date,"
            + "\n"+ "                                     t_fnCash,"
            + "\n"+ "                                     t_instruction117OperationCode,"
            + "\n"+ "                                     t_isCashPayments,"
            + "\n"+ "                                     t_isClientNotResident,"
            + "\n"+ "                                     t_isReceipts,"
            + "\n"+ "                                     t_operationsCount,"
            + "\n"+ "                                     t_operationsSum)"
            + "\n"+ "SELECT t_clientCountryCode,"
            + "\n"+ "       (SELECT currency.t_externalCode"
            + "\n"+ "          FROM ormRtlCurrency currency"
            + "\n"+ "         WHERE currency.t_code_currency = operStatistics.t_currencyCode) t_currencyCodeInAccount,"
            + "\n"+ "       t_date,"
            + "\n"+ "       t_branchId,"
            + "\n"+ "       t_instruction117OperationCode,"
            + "\n"+ "       t_isCashOperation,"
            + "\n"+ "       t_isClientNotResident,"
            + "\n"+ "       DECODE(t_isReceipts, 0, CHR(0), 'X') t_isReceipts,"
            + "\n"+ "       t_operationsCount,"
            + "\n"+ "       t_operationsSum"
            + "\n"+ "  FROM repRtlDepOperateStatistics_vw operStatistics"
            + "\n"+ " WHERE" + filter);
    end;

    private macro cache()
        var filter;
        var departmentList = rcbDepartmentList().getAsSqlSetFull();

        if (departmentList == 0)
            filter = "(  dp_dep.t_date <= " + getSqlDate(global.getRcbReport().context.period.endDate)
                    +"   AND (   dp_dep.t_closeDate >= " + getSqlDate(global.getRcbReport().context.period.beginDate)
                    +"        or dp_dep.t_closeDate = TO_DATE( '01.01.0001', 'DD.MM.YYYY') ))";
        else
            filter = "dp_dep.t_code IN " + departmentList;
        end;

        sql_execute("call rsb_rep_pt.set_selfId(" + {OurBank} + ")");/*только для 917*/
        sql_execute("call rep_opt.cacheDepartmentCodes(" + getSqlDate(global.getRcbReport().context.period.endDate) + ", " + getSqlString(filter) + ")");

        if (TTuneTable("dt601_dbt", "t_backOfice").hasDataFor(TBackOffice(BOCB)))
            cacheCbData();
        end;

        if (TTuneTable("dt601_dbt", "t_backOfice").hasDataFor(TBackOffice(BORETAIL)))
            cacheRetailData();
        end;
    end;

    /**
     * Получить список кодов валют, вошедших в отчет.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     */
    macro getReportFiCodes() : TArray
        var dataSet = TRsbDataSet("SELECT fininstr.t_fi_code                                                                            "
            + "\n" +              "  FROM dfininstr_dbt fininstr                                                                        "
            + "\n" +              " WHERE t_fi_kind =  " + RCB_FIKIND_CURRENCY
            + "\n" +              "   AND t_fiId    <> " + NATCUR
            + "\n" +              "   AND (   EXISTS(SELECT 1                                                                           "
            + "\n" +              "                    FROM drestdate_dbt                                                               "
            + "\n" +              "                   WHERE t_restCurrency     =  fininstr.t_fiid                                       "
            + "\n" +              "                     AND fininstr.t_fi_kind =  " + RCB_FIKIND_CURRENCY
            + "\n" +              "                     AND t_restDate         <= " + getSqlDate(global.getRcbReport().context.period.endDate)
            + "\n" +              "                     AND t_rest             <> 0)                                                    "
            + "\n" +              "        OR EXISTS(SELECT 1                                                                           "
            + "\n" +              "                    FROM drcbExchangeStat_tmp                                                        "
            + "\n" +              "                   WHERE t_receiptsCurrencyCode    = fininstr.t_fi_code                              "
            + "\n" +              "                      OR t_expenditureCurrencyCode = fininstr.t_fi_code)                             "
            + "\n" +              "        OR EXISTS(SELECT 1                                                                           "
            + "\n" +              "                    FROM drcbTransferStat_tmp                                                        "
            + "\n" +              "                   WHERE t_currencyCode = fininstr.t_fi_code)                                        "
            + "\n" +              "        OR EXISTS(SELECT 1                                                                           "
            + "\n" +              "                    FROM drcbDepositOperStat_tmp                                                     "
            + "\n" +              "                   WHERE t_currencyCode = fininstr.t_fi_code)                                        "
            + "\n" +              "        OR EXISTS(SELECT 1                                                                           "
            + "\n" +              "                    FROM daccTrn_dbt                                                                 "
            + "\n" +              "                   WHERE t_chapter = 1                                                               "
            + "\n" +              "                     AND t_date_carry BETWEEN " + getSqlDate(global.getRcbReport().context.period.beginDate)
            + "\n" +              "                                          AND " + getSqlDate(global.getRcbReport().context.period.endDate)
            + "\n" +              "                     AND (   (t_fiid_payer    = fininstr.t_fiid)                                     "
            + "\n" +              "                          OR (t_fiid_receiver = fininstr.t_fiid)) "
            + "\n" +              "                 ) "
            + "\n" +              "       ) "
            + "\n" +              " ORDER BY CASE t_iso_number                                                                          "
            + "\n" +              "              WHEN '840' THEN '0'                                                                    "
            + "\n" +              "              WHEN '978' THEN '1'                                                                    "
            + "\n" +              "              ELSE '2'                                                                               "
            + "\n" +              "          END,                                                                                       "
            + "\n" +              "          t_iso_number                                                                               "
                                 );

        var reportFiCodes : TArray  = TArray();

        while (dataSet.moveNext())
            reportFiCodes[reportFiCodes.size] = dataSet.fi_code;
        end;

        return reportFiCodes;
    end;

    /**
     * Получить код ОКАТО итоговой части отчета по всему филиалу.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     */
    private macro getDepartmentCode() : Integer
        var departmentCode : Integer = global.getRcbReport().context.departmentCode;

        var dataSet = TRsbDataSet("SELECT t_departmentCode"
            + "\n" +              "  FROM drepdepcode_vw"
            + "\n" +              " WHERE t_partyId = " + {OurBank});

        if ((departmentCode == 0) and dataSet.moveNext())
            departmentCode = dataSet.departmentCode;
        end;

        return departmentCode;
    end;

    macro getTotalOkatoCode() : String
        var dataSet = TRsbDataSet("SELECT depcode.t_okatoCode t_totalOkatoCode"
            + "\n" +              "  FROM drepdepcode_vw depcode"
            + "\n" +              " WHERE depcode.t_departmentCode = " + getDepartmentCode());

        var totalOkatoCode : String = " ";
        if (dataSet.moveNext() and (dataSet.totalOkatoCode != null))
            totalOkatoCode = dataSet.totalOkatoCode;
        end;
        return totalOkatoCode;
    end;

    /**
     * Получить список кодов ОКАТО, участвующих
     * в расчете, отсортированный по возрастанию.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     */
    macro getOutsideDomainOkatoCodesSortedCollection() : TArray
        var dataSet = TRsbDataSet("SELECT t_okatoCode"
            + "\n" +              "  FROM drepdepcode_vw depcode"
            + "\n" +              " WHERE depcode.t_departmentCode != " + getDepartmentCode()
            + "\n" +              "   AND depcode.t_okatoCode != " + getSqlString(getTotalOkatoCode())
                   +                  ternary(in(subStr(getTotalOkatoCode(), 1, 2), "45", "46"),
              "\n" +              "   AND SUBSTR(depcode.t_okatoCode, 1, 2) NOT IN ('45', '46')", "")
            + "\n" +              "   AND     EXISTS(SELECT 1"
            + "\n" +              "                    FROM ddp_dep_dbt ddp_dep"
            + "\n" +              "                   WHERE ddp_dep.t_partyid = depcode.t_partyid"
            + "\n" +              "                     AND ddp_dep.t_nodetype = 2)"
            + "\n" +              "   AND (   EXISTS(SELECT 1"
            + "\n" +              "                    FROM df601cb_tmp doc"
            + "\n" +              "                   WHERE doc.t_fnCash = depcode.t_departmentCode)"
            + "\n" +              "        OR EXISTS(SELECT 1"
            + "\n" +              "                    FROM drcbExchangeStat_tmp doc"
            + "\n" +              "                   WHERE doc.t_fnCash = depcode.t_departmentCode)"
            + "\n" +              "        OR EXISTS(SELECT 1"
            + "\n" +              "                    FROM drcbTransferStat_tmp doc"
            + "\n" +              "                   WHERE doc.t_fnCash = depcode.t_departmentCode)"
            + "\n" +              "        OR EXISTS(SELECT 1"
            + "\n" +              "                    FROM drcbDepositOperStat_tmp doc"
            + "\n" +              "                   WHERE doc.t_fnCash = depcode.t_departmentCode))"
            + "\n" +              " GROUP BY t_okatoCode"
            + "\n" +              " ORDER BY t_okatoCode");

        var okatoCodesCollection : TArray = TArray();

        while (dataSet.moveNext())
            okatoCodesCollection[okatoCodesCollection.size] = dataSet.okatoCode;
        end;

        return okatoCodesCollection;
    end;

    /**
     * Рассчитать значение символа по остаткам.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     *
     * @param     attribute атрибут отчета
     * @param     date  дата, за которую вычислять остаток.
     */
    macro calculateRestAttribute(attribute : TAttribute, date : Date)
        if (not isNeedCalculate(attribute, BOCB))
            return;
        end;

        var planNumber = rcbApplication.parameters.balancePlanNumber;

        var dataSet = TRsbDataSet("SELECT fininstr.t_fi_code AS t_fiCode,"
            + "\n" +              "       ABS(NVL(SUM((SELECT restdate.t_rest"
            + "\n" +              "                      FROM drestdate_dbt restdate"
            + "\n" +              "                     WHERE restdate.t_accountId    = account.t_accountId"
            + "\n" +              "                       AND restdate.t_restCurrency = account.t_code_currency"
            + "\n" +              "                       AND restdate.t_restDate IN (SELECT MAX(t_restDate)"
            + "\n" +              "                                                       FROM drestdate_dbt"
            + "\n" +              "                                                      WHERE t_accountId    = account.t_accountId"
            + "\n" +              "                                                        AND t_restCurrency = account.t_code_currency"
            + "\n" +              "                                                        AND t_restDate    <= " + getSqlDate(date) + "))), 0)) AS t_value"
            + "\n" +              "  FROM daccount_dbt account,"
            + "\n" +              "       daccbalance_dbt accblnc,"
            + "\n" +              "       dfininstr_dbt fininstr,"
            + "\n" +              "       drepdepcode_vw  depcode"
            + "\n" +              " WHERE account.t_chapter = 1"
            + "\n" +              "   AND (   account.t_close_date >= " + getSqlDate(global.getRcbReport().context.period.beginDate)
            + "\n" +              "        OR account.t_close_date < account.t_open_date)"
            + "\n" +              "   AND accblnc.t_accountId = account.t_accountId"
            + "\n" +              "   AND accblnc.t_numPlan = " + planNumber
            + "\n" +              "   AND (" + convertMaskToSqlFormat(getBalanceMasks(attribute.getPart(), attribute.getCode(), BOCB), "accblnc.t_balance") + ")"
            + "\n" +              "   AND " + rcbAccountFilter.getAsSqlString("account")
            + "\n" +              "   AND fininstr.t_fiid = account.t_code_currency"
            + "\n" +              "   AND fininstr.t_fiid <> " + NATCUR
            + "\n" +              "   AND fininstr.t_fi_kind = " + RCB_FIKIND_CURRENCY
            + "\n" +              "   AND depcode.t_departmentCode(+) = account.t_department"
            + "\n" +              "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" +              "         OR " + getSqlString(attribute.getOkatoCode()) + " = depcode.t_okatoCode)"
            + "\n" +              " GROUP BY fininstr.t_fi_code");

        while (dataSet.moveNext())
            if (dataSet.value > 0)
                attribute.getValue(dataSet.fiCode, BOCB).exact = dataSet.value;
            end;
        end;
    end;

    /**
     * Рассчитать значение атрибута по документам.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     *
     * @param     attribute
     * @param     isDebet
     * @param     isMulticurrency
     */
    macro calculateDocumentAttribute(attribute : TAttribute, isDebet : Bool, isMulticurrency : Bool, isNatCur : Bool)
        if (not isNeedCalculate(attribute, BOCB))
            return;
        end;

        if (isNatCur == null)
            isNatCur = false;
        end;

        var balanceMasks = getBalanceMasks(attribute.getPart(), attribute.getCode(), BOCB);
        var planNumber   = rcbApplication.parameters.balancePlanNumber;
        var symbolMasks  = getSymbolMasks(attribute.getPart(), attribute.getCode(), BOCB);

        var natFromClause =                   " daccTrn_dbt accTrn,"
            + "\n" + "                          daccbalance_dbt accblnc,"
            + "\n" + "                          daccount_dbt account";

        var natWhereClause =                  " accTrn.t_accTrnId = f601cb.t_documentApplicationKey"
            + "\n" + "                      AND accblnc.t_accountId = " + ternary(isDebet, "accTrn.t_accountId_receiver", "accTrn.t_accountId_payer")
            + "\n" + "                      AND accblnc.t_numPlan = " + planNumber
            + "\n" + "                      AND account.t_chapter = 1"
            + "\n" + "                      AND account.t_accountId = " + ternary(isDebet, "accTrn.t_accountId_receiver", "accTrn.t_accountId_payer")
            + "\n" + "                      AND INSTR(account.t_type_account, 'П') = 0";

        var cmd =    "SELECT (SELECT t_fi_code"
            + "\n" + "          FROM dfininstr_dbt"
            + "\n" + "         WHERE t_fiid = " + ternary(isDebet, "t_debetFiid", "t_creditFiid")
            + "\n" + "           AND t_fi_kind = " + RCB_FIKIND_CURRENCY + ") AS t_fiCode,"
            + "\n" + "       NVL(SUM(" + ternary(isMulticurrency and isNatCur, "accTrn.t_sum_natCur / f601cb.t_documentsum * ", "") + "f601cb.t_symbolValue), 0) AS t_value,"
            + "\n" + "       COUNT(*) AS t_count"
            + "\n" + "  FROM df601cb_tmp f601cb" + ternary(isMulticurrency and isNatCur, ", " + natFromClause, "")
            + "\n" + " WHERE " + ternary(in(symbolMasks, null, ""), "1 = 1", "t_symbolCode IN (" + symbolMasks + ")")
            + "\n" + "   AND (t_isMulticurrency = " + ternary(isMulticurrency, 1, 0) + " OR " + getSqlBoolIdentity(attribute.getPart() == "1") + ")"
            + "\n" + "   AND (    (     " + getSqlBoolIdentity(isDebet)
            + "\n" + "              AND " + convertMaskToSqlFormat(balanceMasks, ternary(isMulticurrency,"t_creditBalance","t_debetBalance"))
            + "\n" + "         OR (     " + getSqlBoolIdentity(not isDebet)
            + "\n" + "              AND " + convertMaskToSqlFormat(balanceMasks, ternary(isMulticurrency,"t_debetBalance","t_creditBalance")) + ")))"
            + "\n" + "   AND " + ternary(isMulticurrency and isNatCur,
                                         natWhereClause,
                                         "(" + getSqlBoolIdentity(not isMulticurrency)
            + "\n" +             "         OR EXISTS(SELECT 1"
            + "\n" +             "                     FROM " + natFromClause
            + "\n" +             "                    WHERE " + natWhereClause + "))")
            + "\n" + "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" + "         OR " + getSqlString(attribute.getOkatoCode()) + " = t_okatoCode)"
            + "\n" + " GROUP BY " + ternary(isDebet, "t_debetFiid", "t_creditFiid");

        var dataSet = TRsbDataSet(cmd);

        while (dataSet.moveNext())
            attribute.getValue(dataSet.fiCode, BOCB).exact = ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
        end;
    end;

    /**
     * Рассчитать значение атрибута по Retail.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     *
     * @param     attribute
     * @param     sqlFilter
     */
    macro calculateDepositOperationsStatisticsAttribute(attribute : TAttribute, sqlFilter : String)
        if (not isNeedCalculate(attribute, BORETAIL))
            return;
        end;

        var dataSet = TRsbDataSet(" SELECT fin.t_fi_code                 AS t_fiCode,"
            + "\n" +              "       NVL(SUM(dep.t_operationsSum),   0) AS t_value,"
            + "\n" +              "       NVL(SUM(dep.t_operationsCount), 0) AS t_count"
            + "\n" +              "  FROM drcbdepositoperstat_tmp dep, dfininstr_dbt fin"
            + "\n" +              " WHERE " + sqlFilter
            + "\n" +              "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" +              "         OR " + getSqlString(attribute.getOkatoCode()) + " = (SELECT t_okatoCode"
            + "\n" +              "                                                                FROM drepdepcode_vw"
            + "\n" +              "                                                               WHERE t_departmentCode = t_fnCash))"
            + "\n" +              "   AND fin.t_codeInAccount = dep.t_currencyCode and fin.t_fi_kind = " + RCB_FIKIND_CURRENCY
            + "\n" +              " GROUP BY fin.t_fi_code");

        while (dataSet.moveNext())
            if (dataSet.value > 0)
                if (attribute.getValue(dataSet.fiCode, BORETAIL).exact == null)
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact = ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                else
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact =
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact + ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                end;
            end;
        end;
    end;

    /**
     * Рассчитать атрибут по статистике по валютно-обменным операциям.
     *
     * @param     attribute
     * @param     isReceipts
     * @param     isReceiptsResult
     * @param     sqlFilter
     */
    macro calculateExchangeStatisticsAttribute(attribute : TAttribute, isReceipts : Bool, isReceiptsResult : Bool, sqlFilter : String)
        if (not isNeedCalculate(attribute, BORETAIL))
            return;
        end;

        var dataSet = TRsbDataSet("SELECT fin.t_fi_code                  AS t_fiCode,"
            + "\n" +              "       NVL(SUM(" + ternary(isReceiptsResult, "exch.t_receiptsSum", "exch.t_expenditureSum") + "),   0) AS t_value,"
            + "\n" +              "       NVL(SUM(exch.t_operationsCount), 0) AS t_count"
            + "\n" +              "  FROM drcbexchangestat_tmp exch, dfininstr_dbt fin"
            + "\n" +              " WHERE " + sqlFilter
            + "\n" +              "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" +              "         OR " + getSqlString(attribute.getOkatoCode()) + " = (SELECT t_okatoCode"
            + "\n" +              "                                                                FROM drepdepcode_vw"
            + "\n" +              "                                                               WHERE t_departmentCode = t_fnCash))"
            + "\n" +              "   AND fin.t_codeInAccount = " + ternary(isreceipts, "exch.t_receiptsCurrencyCode", "exch.t_expenditureCurrencyCode")
            + "\n" +              "   AND fin.t_fi_kind = " + RCB_FIKIND_CURRENCY
            + "\n" +              " GROUP BY fin.t_fi_code");

        while (dataSet.moveNext())
            if (dataSet.value > 0)
                if (attribute.getValue(dataSet.fiCode, BORETAIL).exact == null)
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact = ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                else
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact =
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact + ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                end;
            end;
        end;
    end;

    /**
     * Рассчитать атрибут по статистике по переводам без открытия счета.
     *
     * @param     attribute
     * @param     sqlFilter
     */
    macro calculateTransferStatisticsAttribute(attribute : TAttribute, sqlFilter : String)
      if (not isNeedCalculate(attribute, BORETAIL))
            return;
        end;

        var dataSet = TRsbDataSet("SELECT fin.t_fi_code                        AS t_fiCode,"
            + "\n" +              "       NVL(SUM(trans.t_operationsSum),   0) AS t_value,"
            + "\n" +              "       NVL(SUM(trans.t_operationsCount), 0) AS t_count"
            + "\n" +              "  FROM drcbtransferstat_tmp trans, dfininstr_dbt fin"
            + "\n" +              " WHERE " + sqlFilter
            + "\n" +              "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" +              "         OR " + getSqlString(attribute.getOkatoCode()) + " = (SELECT t_okatoCode"
            + "\n" +              "                                                                FROM drepdepcode_vw"
            + "\n" +              "                                                               WHERE t_departmentCode = t_fnCash))"
            + "\n" +              "   AND fin.t_codeInAccount = trans.t_currencyCode AND fin.t_fi_kind = " + RCB_FIKIND_CURRENCY
            + "\n" +              " GROUP BY fin.t_fi_code");

        while (dataSet.moveNext())
            if (dataSet.value > 0)
                if (attribute.getValue(dataSet.fiCode, BORETAIL).exact == null)
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact = ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                else
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact =
                    attribute.getValue(dataSet.fiCode, BORETAIL).exact + ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
                end;
            end;
        end;
    end;

    /**
     * Получить данные для протокола отчета и вернуть их в виде объекта класса TRsbDataSet.
     * @param   sqlFilter строка с sql фильтром, для применения к запросу данных для протокола
     */
    macro getProtocolDataSet(sqlFilter : String) : Object
        var planNumber = rcbApplication.parameters.balancePlanNumber;

        macro getSource()
            return   "(SELECT *                                                                                                                             "
            + "\n" + "   FROM (SELECT t_fiId,                                                                                                               "
            + "\n" + "                t_okatoCode,                                                                                                          "
            + "\n" + "                t_documentRoubleAmount,                                                                                               "
            + "\n" + "                t_documentAmount,                                                                                                     "
            + "\n" + "                t_payerAccount,                                                                                                       "
            + "\n" + "                t_receiverAccount,                                                                                                    "
            + "\n" + "                t_documentNumber,                                                                                                     "
            + "\n" + "                t_documentGround,                                                                                                     "
            + "\n" + "                t_documentDate,                                                                                                       "
            + "\n" + "                t_isCurrencyConversion,                                                                                               "
            + "\n" + "                t_isMultiCurrency,                                                                                                    "
            + "\n" + "                t_symbolCode,                                                                                                         "
            + "\n" + "                (SELECT t_balance                                                                                                     "
            + "\n" + "                   FROM daccbalance_dbt dacc1                                                                                         "
            + "\n" + "                  WHERE dacc1.t_accountId = t_payerAccountId                                                                          "
            + "\n" + "                    AND dacc1.t_numPlan   = " + planNumber + ")   AS t_payerBalance,                                                  "
            + "\n" + "                (SELECT t_balance                                                                                                     "
            + "\n" + "                   FROM daccbalance_dbt dacc2                                                                                         "
            + "\n" + "                  WHERE dacc2.t_accountId = t_receiverAccountId                                                                       "
            + "\n" + "                    AND dacc2.t_numPlan   = " + planNumber + ")   AS t_receiverBalance                                                "
            + "\n" + "           FROM (SELECT accTrn.t_sum_natCur                                                           AS t_documentRoubleAmount,      "
            + "\n" + "                        CASE                                                                                                          "
            + "\n" + "                            WHEN (NOT f601cb.t_symbolCode IS NULL)                                                                    "
            + "\n" + "                                THEN f601cb.t_symbolValue                                                                             "
            + "\n" + "                            ELSE                                                                                                      "
            + "\n" + "                                CASE                                                                                                  "
            + "\n" + "                                    WHEN (accTrn.t_fiid_payer    = " + NATCUR + ")"
            + "\n" + "                                        THEN accTrn.t_sum_receiver                                                                    "
            + "\n" + "                                    WHEN (accTrn.t_fiid_receiver = " + NATCUR + ")"
            + "\n" + "                                        THEN accTrn.t_sum_payer                                                                       "
            + "\n" + "                                    ELSE accTrn.t_sum_payer                                                                           "
            + "\n" + "                                END                                                                                                   "
            + "\n" + "                        END                                                                           AS t_documentAmount,            "
            + "\n" + "                        CASE                                                                                                          "
            + "\n" + "                            WHEN (accTrn.t_fiid_payer    = " + NATCUR + ")"
            + "\n" + "                                THEN accTrn.t_fiid_receiver                                                                           "
            + "\n" + "                            WHEN (accTrn.t_fiid_receiver = " + NATCUR + ")"
            + "\n" + "                                THEN accTrn.t_fiid_payer                                                                              "
            + "\n" + "                            ELSE CASE                                                                                                 "
            + "\n" + "                                     WHEN TO_NUMBER(SUBSTR(TRIM(f601cb.t_symbolcode), 1, 1)) < 4                                      "
            + "\n" + "                                         THEN accTrn.t_fiid_payer                                                                     "
            + "\n" + "                                     ELSE accTrn.t_fiid_receiver                                                                      "
            + "\n" + "                                 END                                                                                                  "
            + "\n" + "                         END                                                                          AS t_fiId,                      "
            + "\n" + "                         accTrn.t_account_payer                                                       AS t_payerAccount,              "
            + "\n" + "                         accTrn.t_account_receiver                                                    AS t_receiverAccount,           "
            + "\n" + "                         accTrn.t_accountId_payer                                                     AS t_payerAccountId,            "
            + "\n" + "                         accTrn.t_accountId_receiver                                                  AS t_receiverAccountId,         "
            + "\n" + "                         accTrn.t_numb_document                                                       AS t_documentNumber,            "
            + "\n" + "                         accTrn.t_ground                                                              AS t_documentGround,            "
            + "\n" + "                         accTrn.t_date_carry                                                          AS t_documentDate,              "
            + "\n" + "                         CASE                                                                                                         "
            + "\n" + "                             WHEN (    accTrn.t_fiid_payer    <> " + NATCUR
            + "\n" + "                                   AND accTrn.t_fiid_receiver <> " + NATCUR + ")"
            + "\n" + "                                 THEN 1                                                                                               "
            + "\n" + "                             ELSE 0                                                                                                   "
            + "\n" + "                         END                                                                          AS t_isCurrencyConversion,      "
            + "\n" + "                         f601cb.t_isMultiCurrency                                                     AS t_isMultiCurrency,           "
            + "\n" + "                         f601cb.t_symbolCode                                                          AS t_symbolCode,                "
            + "\n" + "                         f601cb.t_okatoCode                                                           AS t_okatoCode,                 "
            + "\n" + "                         f601cb.t_debetFiId                                                           AS t_payerFiId,                 "
            + "\n" + "                         f601cb.t_creditFiId                                                          AS t_receiverFiId               "
            + "\n" + "                    FROM df601cb_tmp f601cb,                                                                                          "
            + "\n" + "                         daccTrn_dbt accTrn                                                                                           "
            + "\n" + "                   WHERE f601cb.t_documentApplicationKey = accTrn.t_accTrnId))                                                        "
            + "\n" + "  WHERE " + sqlFilter + ")";
        end;

        var dataSet = TRsbDataSet("WITH protocolSource                                                                                                      "
            + "\n" +              "AS (" + getSource() + "),"
            + "\n" +              "protocolBase AS                                                                                                          "
            + "\n" +              "(                                                                                                                        "
            + "\n" +              "SELECT *                                                                                                                 "
            + "\n" +              "  FROM (SELECT CASE                                                                                                      "
            + "\n" +              "                   WHEN (GROUPING(t_okatoCode) = 1)                                                                      "
            + "\n" +              "                       THEN 1                                                                                            "
            + "\n" +              "                   ELSE 0                                                                                                "
            + "\n" +              "               END                                           AS t_isGrFiId,                                              "
            + "\n" +              "               CASE                                                                                                      "
            + "\n" +              "                   WHEN (    GROUPING(t_okatoCode)      = 0                                                              "
            + "\n" +              "                         AND GROUPING(t_documentGround) = 1)                                                             "
            + "\n" +              "                       THEN 1                                                                                            "
            + "\n" +              "                   ELSE 0                                                                                                "
            + "\n" +              "               END                                           AS t_isGrOkatoCode,                                         "
            + "\n" +              "               t_fiId,                                                                                                   "
            + "\n" +              "               t_okatoCode,                                                                                              "
            + "\n" +              "               SUM(t_documentRoubleAmount)                   AS t_documentRoubleAmount,                                  "
            + "\n" +              "               SUM(t_documentAmount)                         AS t_documentAmount,                                        "
            + "\n" +              "               t_payerAccount,                                                                                           "
            + "\n" +              "               t_receiverAccount,                                                                                        "
            + "\n" +              "               t_documentNumber,                                                                                         "
            + "\n" +              "               t_documentGround,                                                                                         "
            + "\n" +              "               t_documentDate,                                                                                           "
            + "\n" +              "               t_isCurrencyConversion,                                                                                   "
            + "\n" +              "               t_isMultiCurrency,                                                                                        "
            + "\n" +              "               t_symbolCode,                                                                                             "
            + "\n" +              "               t_payerBalance,                                                                                           "
            + "\n" +              "               t_receiverBalance                                                                                         "
            + "\n" +              "          FROM protocolSource                                                                                            "
            + "\n" +              "        HAVING GROUPING(t_fiId) = 0                                                                                      "
            + "\n" +              "         GROUP BY ROLLUP (t_fiId,                                                                                        "
            + "\n" +              "                          t_okatoCode,                                                                                   "
            + "\n" +              "                          (t_documentRoubleAmount, t_documentAmount, t_payerAccount, t_receiverAccount, t_documentNumber,"
            + "\n" +              "                           t_documentGround, t_documentDate, t_isCurrencyConversion, t_isMultiCurrency, t_symbolCode,    "
            + "\n" +              "                           t_payerBalance, t_receiverBalance                                                             "
            + "\n" +              "                          )                                                                                              "
            + "\n" +              "                         )                                                                                               "
            + "\n" +              "       )                                                                                                                 "
            + "\n" +              ")                                                                                                                        "
            + "\n" +              "SELECT DISTINCT                                                                                                          "
            + "\n" +              "       t_isGrFiId,                                                                                                       "
            + "\n" +              "       t_isGrOkatoCode,                                                                                                  "
            + "\n" +              "       t_fiId,                                                                                                           "
            + "\n" +              "       t_okatoCode,                                                                                                      "
            + "\n" +              "       CASE                                                                                                              "
            + "\n" +              "           WHEN NOT t_documentNumber IS NULL                                                                             "
            + "\n" +              "               THEN SUM(t_documentRoubleAmount) OVER (PARTITION BY t_documentNumber)                                     "
            + "\n" +              "           ELSE t_documentRoubleAmount                                                                                   "
            + "\n" +              "       END                                                                               AS t_documentRoubleAmount,      "
            + "\n" +              "       CASE                                                                                                              "
            + "\n" +              "           WHEN NOT t_documentNumber IS NULL                                                                             "
            + "\n" +              "               THEN SUM(t_documentAmount) OVER (PARTITION BY t_documentNumber)                                           "
            + "\n" +              "       END                                                                               AS t_documentAmount,            "
            + "\n" +              "       t_payerAccount,                                                                                                   "
            + "\n" +              "       t_receiverAccount,                                                                                                "
            + "\n" +              "       t_documentNumber,                                                                                                 "
            + "\n" +              "       t_documentGround,                                                                                                 "
            + "\n" +              "       t_documentDate,                                                                                                   "
            + "\n" +              "       t_isCurrencyConversion,                                                                                           "
            + "\n" +              "       t_isMultiCurrency,                                                                                                "
            + "\n" +              "       LISTAGG(TRIM(protocolBase.t_symbolCode), ',') WITHIN GROUP (ORDER BY protocolBase.t_symbolCode) OVER (PARTITION BY t_documentNumber) AS t_symbolCode,"
            + "\n" +              "       t_payerBalance,                                                                                                   "
            + "\n" +              "       t_receiverBalance                                                                                                 "
            + "\n" +              "  FROM protocolBase                                                                                                      "
            + "\n" +              " ORDER BY t_fiId, t_isGrFiId DESC, t_okatoCode, t_isGrOkatoCode DESC, t_symbolCode, t_documentDate                       "
            );

        dataSet.SetFieldType("t_documentRoubleAmount", V_MONEY);
        dataSet.SetFieldType("t_documentAmount",       V_MONEY);
        dataSet.SetFieldType("t_documentDatae",        V_DATE);

        return dataSet;
    end;
end;

/**
 * Банк данных по 2539-У.
 */
class (TDataBank1881) TDataBank2539()
    initTDataBank1881();

    m_tuneTable.setInstructionFilter(RCB_I2539_DATE);
end;

/**
 * Банк данных по 2835-У.
 */
class (TDataBank2539) TDataBank2835()

    /**
     * Рассчитать значение атрибута по документам.
     *
     * Предусловия:
     *  Метод initializeCache должен быть выполнен.
     *
     * @param attribute Атрибут
     * @param isDebet Признак дебета
     * @param isMulticurrency Признак мультивалютного документа
     * @param isAdditionalCheck_doubleSum Признак дополнительной обработки документа на задвоения сумм (данные из двух подсистем).
     */
    macro calculateDocumentAttribute(attribute : TAttribute, isDebet : Bool, isMulticurrency : Bool, isNatCur : Bool, isAdditionalCheck_doubleSum: Bool)
        /**
         * Признак наличия строки настроечной таблицы для обоих подсистем (Ритейл и ГК)
         */
        var lineInTheSubsystem: Integer = 0;

        if (not isNeedCalculate(attribute, BOCB))
            return;
        end;

        // Строка рассчитывается по Ритейлу
        if (lineInTheSubsystem == global().TUNETABLE_LINE_NOCB_RETAIL)
            return;
        end;

        if (isNatCur == NULL)
            isNatCur = FALSE;
        end;

        if (isAdditionalCheck_doubleSum == NULL)
            isAdditionalCheck_doubleSum = FALSE;
        end;

        if (isAdditionalCheck_doubleSum)
            lineInTheSubsystem = m_tuneTable.lineIncludedInTheSubsystem(attribute.getCode());
        end;

        var paymentFromClause: String  = ", dPmDocs_dbt linkDocumentPayment, dPmPaym_dbt payment";

        var paymentWhereClause: String =
                     " f601cb.t_documentApplicationKey = linkDocumentPayment.t_accTrnId(+)"
            + "\n" + "  AND payment.t_paymentId(+) = linkDocumentPayment.t_paymentId"
            + "\n" + "  AND (NOT ((payment.t_primDocOrigin = " + PD_OR_RETAIL + ") OR (payment.t_primDocOrigin = " + PD_OR_RETAIL_5_50 + ")) OR (payment.t_primDocOrigin IS NULL))";

        var balanceMasks = getBalanceMasks(attribute.getPart(), attribute.getCode(), BOCB);
        var planNumber   = rcbApplication.parameters.balancePlanNumber;
        var symbolMasks  = getSymbolMasks(attribute.getPart(), attribute.getCode(), BOCB);

        var natFromClause =                   " daccTrn_dbt accTrn,"
            + "\n" + "                          daccbalance_dbt accblnc,"
            + "\n" + "                          daccount_dbt account";

        var natWhereClause =                  " accTrn.t_accTrnId = f601cb.t_documentApplicationKey"
            + "\n" + "                      AND accblnc.t_accountId = " + ternary(isDebet, "accTrn.t_accountId_receiver", "accTrn.t_accountId_payer")
            + "\n" + "                      AND accblnc.t_numPlan = " + planNumber
            + "\n" + "                      AND account.t_chapter = 1"
            + "\n" + "                      AND account.t_accountId = " + ternary(isDebet, "accTrn.t_accountId_receiver", "accTrn.t_accountId_payer")
            + "\n" + "                      AND INSTR(account.t_type_account, 'П') = 0";

        var cmd =    "SELECT (SELECT t_fi_code"
            + "\n" + "          FROM dfininstr_dbt"
            + "\n" + "         WHERE t_fiid = " + ternary(isDebet, "t_debetFiid", "t_creditFiid")
            + "\n" + "           AND t_fi_kind = " + RCB_FIKIND_CURRENCY + ") AS t_fiCode,"
            + "\n" + "       NVL(SUM(" + ternary(isMulticurrency and isNatCur, "accTrn.t_sum_natCur / f601cb.t_documentsum * ", "") + "f601cb.t_symbolValue), 0) AS t_value,"
            + "\n" + "       COUNT(*) AS t_count"
            + "\n" + "  FROM df601cb_tmp f601cb" + ternary(isMulticurrency and isNatCur, ", " + natFromClause, "")
            +                ternary(lineInTheSubsystem == global().TUNETABLE_LINE_CB_RETAIL, paymentFromClause, "")
            + "\n" + " WHERE " + ternary(in(symbolMasks, null, ""), "1 = 1", "t_symbolCode IN (" + symbolMasks + ")")
//            + "\n" + "   AND (t_isMulticurrency = " + ternary(isMulticurrency, 1, 0) + " OR " + getSqlBoolIdentity(attribute.getPart() == "1") + ")"
            + "\n" + "   AND (    (     " + getSqlBoolIdentity(isDebet)
            + "\n" + "              AND " + convertMaskToSqlFormat(balanceMasks, ternary(isMulticurrency,"t_creditBalance","t_debetBalance"))
            + "\n" + "         OR (     " + getSqlBoolIdentity(not isDebet)
            + "\n" + "              AND " + convertMaskToSqlFormat(balanceMasks, ternary(isMulticurrency,"t_debetBalance","t_creditBalance")) + ")))"
            + "\n" + "   AND " + ternary(isMulticurrency and isNatCur,
                                         natWhereClause,
                                         "(" + getSqlBoolIdentity(not isMulticurrency)
            + "\n" +             "         OR EXISTS(SELECT 1"
            + "\n" +             "                     FROM " + natFromClause
            + "\n" +             "                    WHERE " + natWhereClause + "))")
            + "\n" + "   AND (    " + getSqlBoolIdentity(attribute.getOkatoPart().isTotal())
            + "\n" + "         OR " + getSqlString(attribute.getOkatoCode()) + " = t_okatoCode)"
            + "\n" + "   AND " + ternary(lineInTheSubsystem == global().TUNETABLE_LINE_CB_RETAIL, paymentWhereClause, " 1 = 1 ")
            + "\n" + " GROUP BY " + ternary(isDebet, "t_debetFiid", "t_creditFiid");

        var dataSet = TRsbDataSet(cmd);

        while (dataSet.moveNext())
            attribute.getValue(dataSet.fiCode, BOCB).exact = ternary(attribute.getType() == RCB_VT_ITEM, dataSet.count, dataSet.value);
        end;
    end;

    macro constructorTDataBank2835()
        initTDataBank2539();
        m_tuneTable = TF601TuneTable_2835();
        m_tuneTable.setInstructionFilter(RCB_I2835_DATE);
    end;

    constructorTDataBank2835();
end;