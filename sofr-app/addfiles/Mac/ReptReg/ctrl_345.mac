
IMPORT ReptCbInter, log_lib;

import RcbCoreInter;

VAR НомерБС = TArray;
    НомерБС(0) = "40803";    НомерБС(7) = "40817";
    НомерБС(1) = "40806";    НомерБС(8) = "40818";
    НомерБС(2) = "40809";    НомерБС(9) = "40819";
    НомерБС(3) = "40812";    НомерБС(10) = "40820";
    НомерБС(4) = "40813";    НомерБС(11) = "47603";
    НомерБС(5) = "40814";    НомерБС(12) = "47605";
    НомерБС(6) = "40815";    НомерБС(13) = "52404";
    НомерБС(14) = "423";
    НомерБС(15) = "426";
    НомерБС(16) = "522";

VAR ВсегоОшибок = 0,
    ЕстьОшибки = FALSE;

VAR Ф345, Ф345t, БнРу, БнРуt, БнПо, БнПоt, i, sub, subt;

var exactSpravSum  = 0;
var currentSpravSum = 0;
var report = rcbApplication().currentReport;
var obligation1    = report.attributeValue("Ф345_Обяз1");
var obligation100  = report.attributeValue("Ф345_Обяз100");
var obligation200  = report.attributeValue("Ф345_Обяз200");
var obligation400  = report.attributeValue("Ф345_Обяз400");
var obligation500  = report.attributeValue("Ф345_Обяз500");
var obligation700  = report.attributeValue("Ф345_Обяз700");
var obligation1000 = report.attributeValue("Ф345_Обяз1000");
var itogo          = report.attributeValue("Ф345_ИТОГО");

VAR ДатаПечати = ПредДатаОтчета;

VAR ЕдиницыИзм,
    НомерФормыБС = 1,
    ИмяФормыБС = "Балансовые счета";

MACRO getNameOper
   FILE pers ( person ); /* Справочник операционистов */
   pers.Oper = {oper};
   if( getEQ( pers ) )
       return trim( pers.Name );
   end;
   return "";
END;

MACRO УстановитьПараметры()

    RECORD ПараметрыФормы(cy_forms,  "cy_files.def");

    if ( not СвойстваОтчетнойФормы( {Название отчета}, ПараметрыФормы) )
      MsgBox( string( "Форма \"", {Название отчета}, "\" не найдена в справочнике форм"));
      Exit( 1);
    end;
    ЕдиницыИзм  =  ПараметрыФормы.iDimension;

    if ( not СвойстваОтчетнойФормы( ИмяФормыБС, ПараметрыФормы) )
      MsgBox( string( "Форма \"", ИмяФормыБС, "\" не найдена в справочнике форм"));
      Exit( 1);
    end;
    НомерФормыБС =  ПараметрыФормы.iFormID;
END;

private MACRO Check()

   if(not ЕстьОшибки)
      ЕстьОшибки = TRUE;
      [┌────┬───────────────┬─────────────────┬───────────────────────────┬─────────────────────────┬─────────────────────────┬────────────────────┬──────────────────────┬─────────────────────┬──────────────┐];
      [│ !  │ Дата проверки │ Объект проверки │  Ф345_БББББ не округл.    │ Сумма баланса не округл.│      Расхождения        │  Ф345_БББББ округл.│ Сумма баланса округл.│    Расхождения      │  Примечание  │];
      [├────┼───────────────┼─────────────────┼───────────────────────────┼─────────────────────────┼─────────────────────────┼────────────────────┼──────────────────────┼─────────────────────┼──────────────┤];
   end;

END;

/*точка входа*/
RECORD cy_rdate ("cy_rdate");

УстановитьПараметры();

SetOutput( GetNameLog( "345c" ) );

[Форма 345.];
[Период отчета с ########## по ##########](ПредДатаОтчета, ДатаОтчета);
[Дата и время выпуска отчета  ########## ##########](date, time);
[Исполнитель: #](getNameOper():l);
[ ПРОТОКОЛ КОНТРОЛЯ ];

    while( ДатаПечати <= ДатаОтчета )
      i = 0;
      ПроверитьСохраненнДаты( НомерПодразделения,
                              ИмяФормыБС,
                              "",
                              ДатаПечати,
                              ДатаПечати,
                              cy_rdate
                              ); 
     if ((cy_rdate.iDimension != ЕдиницыИзм) or (cy_rdate.cCalculated != "X" ))
         Check();
         println(" Данные баланса на ", ДатаПечати, " отсутствуют. Контроль с балансом невозможен");
     else
       while( i < НомерБС.size )

        ПрочитатьПеременную2( БнРу, БнРуt, ДатаПечати, ДатаПечати, НомерФормыБС, "Бн" + НомерБС(i) + "РуП" );
        ПрочитатьПеременную2( БнПо, БнПоt, ДатаПечати, ДатаПечати, НомерФормыБС, "Бн" + НомерБС(i) + "ПоП" );

        if ((БнРуt == NULL) or (БнПоt == NULL))
         Check();
         println("Не определена переменная ","Бн", НомерБС(i)," за ", ДатаПечати);
        else

         if (i < 14)
           ПрочитатьПеременную2( Ф345, Ф345t, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_" + НомерБС(i) );
         else
           ПрочитатьПеременную2( Ф345, Ф345t, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_" + НомерБС(i) + "__" );
         end;

         if(Ф345t == NULL)
           Check();
           msgbox(" Не определена переменная ","Ф345_", НомерБС(i)," за ", ДатаПечати);
         else
           message(НомерБС(i) + "  " + ДатаПечати);

           subt = БнРуt + БнПоt - Ф345t;

           if((БнРу == NULL) or (БнПо == NULL) or (Ф345 == NULL))
             sub  = "";             
           else
             sub  = БнРу + БнПо - Ф345;             
           end;
           if (subt < 0)
              Check();
              [│ #  │   ##########  │  #############  │###########################│#########################│#########################│####################│######################│#####################│##############│]
              ("!", ДатаПечати, НомерБС(i):c:w, Ф345:c:w, (БнРу + БнПо):c:w, sub:w:c, Ф345t:c:w, (БнРуt + БнПоt):c:w, subt:w:c, ("Ошибка. Расхождение данных ф.0409345 с балансом по б/с " + НомерБС(i)):w:c);
              ВсегоОшибок = ВсегоОшибок + 1;
           end;
         end;
         end;
         i = i + 1;
        end;
      end;
       ДатаПечати = ДатаПечати + 1;

     end;

    if ((ДатаОтчета >= RCB_I1841_DATE1-1)and(ДатаОтчета < RCB_I2121_DATE))

        if (    obligation1.isDefined()  
            and obligation100.isDefined()
            and obligation400.isDefined()
            and obligation500.isDefined()
            and obligation700.isDefined()
            and itogo.isDefined());        


            exactSpravSum  = obligation1.exact  + obligation100.exact  + obligation400.exact  + obligation500.exact  + obligation700.exact;
            currentSpravSum = obligation1.current + obligation100.current + obligation400.current + obligation500.current + obligation700.current;

            if  (   (currentSpravSum > itogo.current + 9) 
                 or (currentSpravSum < itogo.current - 9))

                Check();
                [│ #  │   ##########  │  #############  │###########################│#########################│#########################│####################│######################│#####################│##############│]
                ("!", ДатаПечати, "Итого обязательств":w, exactSpravSum:w,   itogo.exact:w,   itogo.exact - exactSpravSum:w, 
                                                          currentSpravSum:w, itogo.current:w, itogo.current - currentSpravSum:w, 
                 "Ошибка. Расхождение итогового значения с данными раздела \"Справочно\"":w);

                ВсегоОшибок = ВсегоОшибок + 1;
            end;
        end;
    end;

    if (ДатаОтчета >= RCB_I2121_DATE)

        if (    obligation1.isDefined()  
            and obligation100.isDefined()
            and obligation200.isDefined()
            and obligation400.isDefined()
            and obligation700.isDefined()
            and obligation1000.isDefined()
            and itogo.isDefined());        


            exactSpravSum  = obligation1.exact  + obligation100.exact  + obligation200.exact  + obligation400.exact  + obligation700.exact + obligation1000.exact;
            currentSpravSum = obligation1.current + obligation100.current + obligation200.current + obligation400.current + obligation700.current + obligation1000.current;

            if  (   (currentSpravSum > itogo.current + 9) 
                 or (currentSpravSum < itogo.current - 9))

                Check();
                [│ #  │   ##########  │  #############  │###########################│#########################│#########################│####################│######################│#####################│##############│]
                ("!", ДатаПечати, "Итого обязательств":w, exactSpravSum:w,   itogo.exact:w,   itogo.exact - exactSpravSum:w, 
                                                          currentSpravSum:w, itogo.current:w, itogo.current - currentSpravSum:w, 
                 "Ошибка. Расхождение итогового значения с данными раздела \"Справочно\"":w);

                ВсегоОшибок = ВсегоОшибок + 1;
            end;
        end;
    end;

  if (not ЕстьОшибки)
   println("Контроль произведен успешно, ошибок в отчете не обнаружено.");
  else
   [└────┴───────────────┴─────────────────┴───────────────────────────┴─────────────────────────┴─────────────────────────┴────────────────────┴──────────────────────┴─────────────────────┴──────────────┘];
   println("Всего ошибок ", ВсегоОшибок);
  end;
