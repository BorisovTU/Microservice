/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6.20.030                                                                 R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 101. Обнуление переменных формы(главы) при расчете по отдельной главе.

  Создан: 5.04.2011 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import cb_sql;
import RcbCoreInter;
import ReptCbInter;

/**
 * Обнулятор переменных 101 формы "Балансовые счета" по главе.
 */
private class TBalanceChapterAttributesZeroizer(chapter:integer)
    private var m_realPlan      :integer;
    private var m_chapter       :integer;
    private var m_report        :object;
    private var m_repContext    :object;
    private var m_isChapterExist:bool;

    private macro isChapterExist(chapter)
        var chapters = TRsbDataSet("SELECT NULL FROM dobchaptr_dbt WHERE t_chapter = " + chapter);
        if (chapters.next())
            return true;
        end;
        return false;
    end;

    //private macro insertValuesWithZeros()
    //    var query =  "INSERT INTO dcy_mreal_dbt(t_IsSummary,"
    //        + "\n" + "                          t_iNumDprt,"
    //        + "\n" + "                          t_bdRepDate,"
    //        + "\n" + "                          t_bdPrevDate,"
    //        + "\n" + "                          t_iFormId,"
    //        + "\n" + "                          t_iVarId,"
    //        + "\n" + "                          t_OrganizationStructure,"
    //        + "\n" + "                          t_IssueMode,"
    //        + "\n" + "                          t_iProcessNum,"
    //        + "\n" + "                          t_Mean1,"
    //        + "\n" + "                          t_Mean2) "
    //        + "\n" + "SELECT " + GetSqlChar(m_repContext.isSummaryMode)    + " t_IsSummary,"
    //        + "\n" + "       " + m_repContext.departmentCode               + " t_iNumDprt, "
    //        + "\n" + "       " + GetSQLDate(m_repContext.period.endDate)   + " t_bdRepDate,"
    //        + "\n" + "       " + GetSQLDate(m_repContext.period.beginDate) + " t_bdPrevDate,"
    //        + "\n" + "       1                                                 t_iFormId,"
    //        + "\n" + "       vd.t_iVarId                                       t_iVarId,"
    //        + "\n" + "       " + m_repContext.organizationStructure        + " t_OrganizationStructure,"
    //        + "\n" + "       " + m_repContext.issueMode                    + " t_IssueMode,"
    //        + "\n" + "       "+"идентификатор выч. процесса(нужно получить)"+" t_iProcessNum,"
    //        + "\n" + "       0                                                 t_Mean1,"
    //        + "\n" + "       0                                                 t_Mean2"
    //        + "\n" + "  FROM dcy_varsd_dbt vd,"
    //        + "\n" + "       dbalance_dbt bl"
    //        + "\n" + " WHERE bl.t_iNumPlan = " + m_realPlan
    //        // определенные переменные должны быть по всем главам
    //        //+ "\n" + "   AND bl.t_chapter = " + m_chapter
    //        + "\n" + "   AND vd.t_iFormId = 1"
    //        + "\n" + "   AND vd.t_szVarName LIKE 'Бн' || bl.t_balance || '%')"
    //        + "\n" + "   AND NOT EXISTS(SELECT NULL"
    //        + "\n" + "                    FROM dcy_mreal_dbt mr"
    //        + "\n" + "                   WHERE mr.t_iFormId = vd.t_iFormId"
    //        + "\n" + "                     AND mr.t_iVarId  = vd.t_iVarId"
    //        + "\n" + "                     AND mr.t_IsSummary = " + GetSqlChar(m_repContext.isSummaryMode)
    //        + "\n" + "                     AND mr.t_OrganizationStructure = " + m_repContext.organizationStructure
    //        + "\n" + "                     AND mr.t_IssueMode = " + m_repContext.issueMode
    //        + "\n" + "                     AND mr.t_iNumDprt = " + m_repContext.departmentCode
    //        + "\n" + "                     AND mr.t_bdRepDate = " + GetSQLDate(m_repContext.period.endDate)
    //        + "\n" + "                     AND mr.t_bdPrevDate = " + GetSQLDate(m_repContext.period.beginDate)
    //        + "\n" + "                 )";
    //
    //    SQL_Execute(query, "Обнуление переменных " + string(m_chapter) + " главы");
    //end;
    //
    //private macro updateValuesWithZeros()
    //    var query =  "UPDATE dcy_mreal_dbt mr"
    //        + "\n" + "   SET mr.t_mean1 = 0,"
    //        + "\n" + "       mr.t_mean2 = 0"
    //        + "\n" + " WHERE mr.t_IsSummary = " + GetSqlChar(m_repContext.isSummaryMode)
    //        + "\n" + "   AND mr.t_OrganizationStructure = " + m_repContext.organizationStructure
    //        + "\n" + "   AND mr.t_IssueMode = " + m_repContext.issueMode
    //        + "\n" + "   AND mr.t_iNumDprt = " + m_repContext.departmentCode
    //        + "\n" + "   AND mr.t_bdRepDate = " + GetSQLDate(m_repContext.period.endDate)
    //        + "\n" + "   AND mr.t_bdPrevDate = " + GetSQLDate(m_repContext.period.beginDate)
    //        + "\n" + "   AND mr.t_iFormId = 1"
    //        + "\n" + "   AND (mr.t_mean1 != 0 OR mr.t_mean2 != 0)"
    //        + "\n" + "   AND mr.t_iVarId IN"
    //        + "\n" + "           (SELECT vd.t_iVarId"
    //        + "\n" + "              FROM dcy_varsd_dbt vd,"
    //        + "\n" + "                   dbalance_dbt bl"
    //        + "\n" + "             WHERE bl.t_iNumPlan = " + m_realPlan
    //        + "\n" + "               AND bl.t_chapter = " + m_chapter
    //        + "\n" + "               AND vd.t_iFormId = 1"
    //        + "\n" + "               AND vd.t_szVarName LIKE 'Бн' || bl.t_balance || '%')";
    //
    //    SQL_Execute(query, "Обнуление переменных " + string(m_chapter) + " главы");
    //end;

    private macro getBalanceFromAttributeName(attributeName:string)
        if (substr(attributeName, 3, 1) == "_")
            return null;
        end;

        return substr(attributeName, 3, 5);
    end;

    private macro zeroChapterValues()
        if (not m_isChapterExist)
            return;
        end;

        var iterator          = null;
        var attribute         = null;
        var attributeValue    = null;
        var lastBalance       = null;
        var balance           = null;
        var isSuitableBalance = false;

        iterator = m_report.createAttributeValueIterator();
        // применение сортировки не оправдалось, быстрее работает без нее
        // (времени на сортировку уходит больше, чем она экономит при проверке атрибутов)

        var cmd;
        var cmdTxt = "SELECT t_balance"
            + "\n" + "  FROM dbalance_dbt"
            + "\n" + " WHERE t_iNumPlan = " + m_realPlan
            + "\n" + "   AND t_chapter = " + m_chapter
            + "\n" + "   AND t_balance = ?";

        var i = 0;

        iterator.moveFirst();
        while (not iterator.isDone())
            i = i + 1;

            attribute = iterator.currentItem.attribute;
            attributeValue = iterator.currentItem;

            if (    (not attribute.isDependent())
                and (attribute.type == RCB_VT_MONEY)
                )
                if (attributeValue.isUndefined())
                    attributeValue.exact = $0;
                    attributeValue.recalculateScaled();
                elif ((attributeValue.exact != 0) or (attributeValue.scaled != 0))
                    balance = getBalanceFromAttributeName(attribute.name);

                    if (balance != null)
                        if (balance == lastBalance)
                            if (isSuitableBalance)
                                attributeValue.exact = $0;
                                attributeValue.recalculateScaled();
                            end;
                        else
                            cmd = RsdCommand(cmdTxt);
                            cmd.addParam("bl", RSDBP_IN, balance);
                            if (TRsbDataset(cmd).next())
                                attributeValue.exact = $0;
                                attributeValue.recalculateScaled();
                                isSuitableBalance = true;
                            else
                                isSuitableBalance = false;
                            end;
                            lastBalance = balance;
                        end;
                    end;
                end;
            end;

            iterator.moveNext();
        end;

        RcbApplication().TransactionManager.commit();
        RcbApplication().currentReport.reload();
    end;

    macro execute()
        if (m_isChapterExist)
            //updateValuesWithZeros();
            //insertValuesWithZeros();
            zeroChapterValues();
        end;
    end;

    private macro constructorTBalanceChapterAttributesZeroizer(chapter:integer)
        m_chapter = chapter;
        m_isChapterExist = isChapterExist(chapter);
        m_realPlan = ternary(m_isChapterExist, ПолучитьРеальныйНомерПлана(ЛогическийПланСчетов,chapter), 0);
        m_report = RcbApplication().currentReport();
        m_repContext = m_report.context;
    end;

    constructorTBalanceChapterAttributesZeroizer(chapter);
end;

macro zeroChapterAttributes()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = int(substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL)));

    TBalanceChapterAttributesZeroizer(chapter).execute();
end;

УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);