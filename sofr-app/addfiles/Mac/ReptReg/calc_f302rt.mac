/*
$Name:          calc_f302rt.mac
$Module:        Регламентируемая отчетность
$Description:   заполнение формы 302 по данным Retail
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   заполнение формы 302 по данным Retail

   CREATED : 28.08.07 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/*
 *  Общебанковские интеры и модули
 */
import rcb_lib;
import cb_sql;
import lib_date;
import testlib;

/*
 *  Интеры и модели подсистемы
 */
import rcb_bo;
import com_f302n;
import DepartmentFilter;
import RCbTuneTable;
import RcbArTuneTable;

/***************************************************************************************************
 *  Класс вставки во временную таблицу
 **************************************************************************************************/
private class TInserter(processor : Object)
    private var m_processor        = processor;

    private macro getRowNumber()
        return "1.2";
    end;

    private macro getColumnNumber()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro execute()
        sql_execute(      " INSERT INTO df302p2_tmp(t_backOffice,         "
                 + "\n" + "                         t_okatoCode,          "
                 + "\n" + "                         t_row,                "
                 + "\n" + "                         t_column,             "
                 + "\n" + "                         t_accountNumber,      "
                 + "\n" + "                         t_roubleSum,          "
                 + "\n" + "                         t_currencySum,        "
                 + "\n" + "                         t_clientCode,         "
                 + "\n" + "                         t_shortName,          "
                 + "\n" + "                         t_recalculateRateDate,"
                 + "\n" + "                         t_clientKind,         "
                 + "\n" + "                         t_currencyId)         "
                 + "\n" + m_processor.getQueryText());
    end;
end;

/***************************************************************************************************
 *  Базовый класс обработчика данных
 **************************************************************************************************/
private class TProcessor(tuneTable : RcbTuneTable)
    private var m_accountMasksList = tuneTable.getdataSet();
    private var m_queryText;

    private macro getAccountMasks(row : String)
        m_accountMasksList.moveFirst();
        m_accountMasksList.movePrev();

        while (m_accountMasksList.moveNext())
            if (m_accountMasksList.row == row)
                return m_accountMasksList.accountMasks;
            end;
        end;

        return "";
    end;

    private macro getAccountMasksClause(row : String, fieldName : String)
        var accountMasks = getAccountMasks(row);

        if (accountMasks == "")
            return "1 = 0";
        else
            return convertMaskToSqlFormat(accountMasks, fieldName);
        end;
    end;

    private macro initializeQueryText()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getQueryText()
        return m_queryText;
    end;

    macro getInformationMessage()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getRowNumber()
        return "3";
    end;

    macro getColumnNumber()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    initializeQueryText();
end;

/***************************************************************************************************
 *  Класс обработчика данных по договорам
 **************************************************************************************************/
private class (TProcessor) TDepositProcessor(tuneTable : RcbTuneTable)
    macro getRowNumber()
        return "1.2";
    end;

    macro getColumnNumber()
        return " case when dep.t_currencyId = 0 then '6' else '7' end ";
    end;

    macro getInformationMessage()
        return "Получение данных по договорам Retail...";
    end;

    private macro initializeQueryText()
        m_queryText =     " SELECT " + BORETAIL + ",                                                                   "
                 + "\n" + "        rpad(substr(party.t_okatoCode, 0, 2), 5, '0'),                                      "
                 + "\n" +          getRowNumber() + ",                                                                 "
                 + "\n" +          getColumnNumber()+ ",                                                               "
                 + "\n" + "        dep.t_cbAccount,                                                                    "
                 + "\n" + "        dep.t_roubleOutRest,                                                                "
                 + "\n" + "        dep.t_outRest,                                                                      "
                 + "\n" + "        (select c.t_code                                                                    "
                 + "\n" + "           from drepPartyCodes_vw c                                                         "
                 + "\n" + "          where dep.t_contragentId = c.t_partyId and c.t_codeKind = 1),                     "
                 + "\n" + "        party.t_shortName,                                                                  "
                 + "\n" + "        (CASE WHEN (    dep.t_closeDate < rep_data.getEndDate()                             "
                 + "\n" + "                    and dep.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))             "
                 + "\n" + "              THEN dep.t_closeDate                                                          "
                 + "\n" + "              ELSE rep_data.getEndDate()                                                    "
                 + "\n" + "         END),                                                                              "
                 + "\n" + "        CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                          "
                 + "\n" + "             WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 0 THEN 'Ф'              "
                 + "\n" + "             WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'              "
                 + "\n" + "             ELSE CHR(1)                                                                    "
                 + "\n" + "        END,                                                                                "
                 + "\n" + "        dep.t_currencyId                                                                    "
                 + "\n" + "   FROM repRtlDeposit_vw dep join drepParty_vw party on dep.t_contragentId = party.t_id     "
                 + "\n" + "  WHERE dep.t_isOpenedAtEndDate = 1                                                         "
                 + "\n" + "    AND " + getAccountMasksClause(getRowNumber(), "dep.t_cbAccount")
                 + "\n" + "    AND party.t_okatoCode IS NOT NULL                                                       "
                 + "\n" + "    AND " + RcbBranchFieldFilter().getAsSqlString("dep.t_branchId");
    end;

    initTProcessor(tuneTable);
end;

/***************************************************************************************************
 *  Класс обработчика данных по договорам по инструкции 2055У
 **************************************************************************************************/
private class (TDepositProcessor) TDepositProcessor2055(tuneTable : RcbTuneTable)
    macro getColumnNumber(currencyId)
        if (currencyId == NATCUR)
            return "4";
        end;
        return "5";
    end;
    initTProcessor(tuneTable);
end;

/***************************************************************************************************
 *  Класс обработчика данных по договорам по инструкции 2742-У
 **************************************************************************************************/
private class (TDepositProcessor) TDepositProcessor2742(tuneTable : RcbTuneTable)
    macro getRowNumber()
        return "1.8";
    end;

    macro getColumnNumber()
        return " case when dep.t_currencyId = 0 then '4' else '5' end ";
    end;

    initTProcessor(tuneTable);
end;

/***************************************************************************************************
 *  Класс обработчика данных по договорам по инструкции 2926-У
 **************************************************************************************************/
private class (TDepositProcessor) TDepositProcessor2926(tuneTable : RcbTuneTable, okatoTuneTable : RcbTuneTable)
    var m_okatoTuneTable = okatoTuneTable;

    macro getRowNumber()
        return "1.9";
    end;

    macro getRowNumberPledge()
        return "1.9_з";
    end;

    private macro initializeQueryText()
        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        m_queryText = " WITH rtlData AS (                                                                                                     "
                 //данные для граф 4_1 и 5_1
                 + "\n" + "         SELECT " + BORETAIL + "                                                         t_backOffice,             "
                 + "\n" + "                NVL((SELECT t_okatocode                                                                            "
                 + "\n" + "                       FROM drepdepcode_tmp                                                                        "
                 + "\n" + "                      WHERE t_departmentcode = dep.t_branchId), '99999')                 t_okatoCode,              "
                 + "\n" + "                '" + getRowNumber() + "'                                                 t_row,                    "
                 + "\n" + "                CASE WHEN dep.t_fininstrumentId = 0 THEN '4' ELSE '5' END                t_column,                 "
                 + "\n" + "                dep.t_cbAccount                                                          t_accountNumber,          "
                 + "\n" + "                dep.t_roubleOutRest                                                      t_roubleSum,              "
                 + "\n" + "                dep.t_outRest                                                            t_currencySum,            "
                 + "\n" + "                (SELECT c.t_code                                                                                   "
                 + "\n" + "                   FROM drepPartyCodes_vw c                                                                        "
                 + "\n" + "                  WHERE dep.t_contragentId = c.t_partyId                                                           "
                 + "\n" + "                    AND c.t_codeKind       = " + PTCK_CONTR + ")                         t_clientCode,             "
                 + "\n" + "                party.t_shortName                                                        t_shortName,              "
                 + "\n" + "                CASE WHEN (    dep.t_closeDate  < rep_data.getEndDate()                                            "
                 + "\n" + "                           AND dep.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                             "
                 + "\n" + "                     THEN dep.t_closeDate                                                                          "
                 + "\n" + "                     ELSE rep_data.getEndDate()                                                                    "
                 + "\n" + "                END                                                                      t_recalculateRateDate,    "
                 + "\n" + "                CASE WHEN party.t_isPhisical = 0                            THEN 'Ю'                               "
                 + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 0 THEN 'Ф'                               "
                 + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 1 THEN 'П'                               "
                 + "\n" + "                     ELSE CHR(1)                                                                                   "
                 + "\n" + "                END                                                                      t_clientKind,             "
                 + "\n" + "                dep.t_fininstrumentId                                                    t_currencyId              "
                 + "\n" + "           FROM repRtlDeposit_vw dep                                                                               "
                 + "\n" + "           JOIN drepParty_vw party                                                                                 "
                 + "\n" + "             ON dep.t_contragentId = party.t_id                                                                    "
                 + "\n" + "          WHERE dep.t_isOpenedAtEndDate = 1                                                                        "
                 + "\n" + "            AND " + getAccountMasksClause(getRowNumber(), "dep.t_cbAccount")
                 + "\n" + "            AND party.t_okatoCode IS NOT NULL                                                                      "
                 + "\n" + "            AND " + RcbBranchFieldFilter().getAsSqlString("dep.t_branchId")
                 + "\n" + "          UNION ALL"
                 //данные для граф 4_2 и 5_2 (мультивалютные договора)
                 + "\n" + "         SELECT " + BORETAIL + "                                                         t_backOffice,             "
                 + "\n" + "                NVL((SELECT t_okatocode                                                                            "
                 + "\n" + "                       FROM drepdepcode_tmp                                                                        "
                 + "\n" + "                      WHERE t_departmentcode = dep.t_branchId), '99999')                 t_okatoCode,              "
                 + "\n" + "                '" + getRowNumber() + "'                                                 t_row,                    "
                 + "\n" + "                CASE WHEN mdParams.t_fiId = 0 THEN '4' ELSE '5' END                      t_column,                 "
                 + "\n" + "                mdParams.t_cbAccount                                                     t_accountNumber,          "
                 + "\n" + "                mdParams.t_roubleRest                                                    t_roubleSum,              "
                 + "\n" + "                mdParams.t_rest                                                          t_currencySum,            "
                 + "\n" + "                (SELECT c.t_code                                                                                   "
                 + "\n" + "                   FROM drepPartyCodes_vw c                                                                        "
                 + "\n" + "                  WHERE dep.t_contragentId = c.t_partyId                                                           "
                 + "\n" + "                    AND c.t_codeKind       = " + PTCK_CONTR + ")                         t_clientCode,             "
                 + "\n" + "                party.t_shortName                                                        t_shortName,              "
                 + "\n" + "                CASE WHEN (    dep.t_closeDate  < rep_data.getEndDate()                                            "
                 + "\n" + "                           AND dep.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                             "
                 + "\n" + "                     THEN dep.t_closeDate                                                                          "
                 + "\n" + "                     ELSE rep_data.getEndDate()                                                                    "
                 + "\n" + "                END                                                                      t_recalculateRateDate,    "
                 + "\n" + "                CASE WHEN party.t_isPhisical = 0                            THEN 'Ю'                               "
                 + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 0 THEN 'Ф'                               "
                 + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 1 THEN 'П'                               "
                 + "\n" + "                     ELSE CHR(1)                                                                                   "
                 + "\n" + "                END                                                                      t_clientKind,             "
                 + "\n" + "                mdParams.t_fiId                                                          t_currencyId              "
                 + "\n" + "           FROM repRtlMdParameters_vw mdParams                                                                     "
                 + "\n" + "           JOIN repRtlDeposit_vw dep                                                                               "
                 + "\n" + "             ON dep.t_contractId = mdParams.t_contractId                                                           "
                 + "\n" + "           JOIN drepParty_vw party                                                                                 "
                 + "\n" + "             ON dep.t_contragentId = party.t_id                                                                    "
                 + "\n" + "          WHERE dep.t_isOpenedAtEndDate = 1                                                                        "
                 + "\n" + "            AND " + getAccountMasksClause(getRowNumber(), "dep.t_cbAccount")
                 + "\n" + "            AND party.t_okatoCode IS NOT NULL                                                                      "
                 + "\n" + "            AND " + RcbBranchFieldFilter().getAsSqlString("dep.t_branchId")
                 + "\n" + "           )                                                                                                       "
                 + "\n" + "SELECT rtlData.t_backOffice,                                                                                       "
                 + "\n" + "       CASE WHEN rtlData.t_okatoCode <> '99999'                                                                    "
                 + "\n" + "                THEN rpad(substr(rtlData.t_okatoCode, 1, 2), 5, '0')                                               "
                 + "\n" + "            ELSE rtlData.t_okatoCode                                                                               "
                 + "\n" + "       END t_okatoCode,                                                                                            "
                 + "\n" + "       TO_CHAR(rtlData.t_row), rtlData.t_column,                                                                   "
                 + "\n" + "       rtlData.t_accountNumber, rtlData.t_roubleSum, rtlData.t_currencySum,                                        "
                 + "\n" + "       rtlData.t_clientCode, rtlData.t_shortName,                                                                  "
                 + "\n" + "       rtlData.t_recalculateRateDate, rtlData.t_clientKind, rtlData.t_currencyId                                   "
                 + "\n" + "  FROM rtlData                                                                                                     "
                 + "\n" + " UNION ALL                                                                                                         "
                 + "\n" + "SELECT rtlData.t_backOffice, okatoTable.t_okato,                                                                   "
                 + "\n" + "       rtlData.t_row, rtlData.t_column,                                                                            "
                 + "\n" + "       rtlData.t_accountNumber, rtlData.t_roubleSum, rtlData.t_currencySum,                                        "
                 + "\n" + "       rtlData.t_clientCode, rtlData.t_shortName,                                                                  "
                 + "\n" + "       rtlData.t_recalculateRateDate, rtlData.t_clientKind, rtlData.t_currencyId                                   "
                 + "\n" + "  FROM rtlData,                                                                                                    "
                 + "\n" + "       (" + okatoTuneTable.getQuery() + ") okatoTable                                                              "
                 + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, rtlData.t_okatoCode) = 1                            "
                 //договоры аренды банковских ячеек
                 + "\n" + " UNION ALL                                                                                                         "
                 + "\n" + "SELECT " + BORETAIL + "                                                                  t_backOffice,             "
                 + "\n" + "       NVL((SELECT rpad(substr(t_okatoCode, 1, 2), 5, '0')                                                         "
                 + "\n" + "              FROM drepdepcode_tmp                                                                                 "
                 + "\n" + "             WHERE t_departmentcode = rtlSafeCellData.t_branch), '99999')                t_okatoCode,              "
                 + "\n" + "       '" + getRowNumberPledge() + "'                                                    t_row,                    "
                 + "\n" + "       CASE WHEN rtlSafeCellData.t_fiId = 0 THEN '4' ELSE '5' END                        t_column,                 "
                 + "\n" + "       rtlSafeCellData.t_contractNumber                                                  t_accountNumber,          "
                 + "\n" + "       rtlSafeCellData.t_guaranteeSumInNatCur                                            t_roubleSum,              "
                 + "\n" + "       rtlSafeCellData.t_guaranteeSum                                                    t_currencySum,            "
                 + "\n" + "       (SELECT c.t_code                                                                                            "
                 + "\n" + "          FROM drepPartyCodes_vw c                                                                                 "
                 + "\n" + "         WHERE rtlSafeCellData.t_clientId = c.t_partyId                                                            "
                 + "\n" + "           AND c.t_codeKind               = " + PTCK_CONTR + ")                          t_clientCode,             "
                 + "\n" + "       rtlSafeCellData.t_clientName                                                      t_shortName,              "
                 + "\n" + "       rep_data.getEndDate                                                               t_recalculateRateDate,    "
                 + "\n" + "       CASE WHEN party.t_isPhisical = 0                             THEN 'Ю'                                       "
                 + "\n" + "            WHEN party.t_isPhisical = 1 AND  party.t_isEmployer = 0 THEN 'Ф'                                       "
                 + "\n" + "            WHEN party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                       "
                 + "\n" + "            ELSE CHR(1)                                                                                            "
                 + "\n" + "       END                                                                               t_clientKind,             "
                 + "\n" + "       rtlSafeCellData.t_fiId                                                            t_currencyId              "
                 + "\n" + "  FROM repRtlSafeCellContract_vw rtlSafeCellData                                                                   "
                 + "\n" + "  JOIN drepParty_vw party                                                                                          "
                 + "\n" + "    ON rtlSafeCellData.t_clientId = party.t_id                                                                     "
                 + "\n" + " WHERE rtlSafeCellData.t_isOpenInEndDate = 1                                                                       "
                 ;
    end;

    initTProcessor(tuneTable);
end;

/***************************************************************************************************
 *  Класс обработчика данных по договорам по инструкции 4637-У
 **************************************************************************************************/
private class (TDepositProcessor2926) TDepositProcessor4637(tuneTable : RcbTuneTable, okatoTuneTable : RcbTuneTable)
    macro getRowNumberPledgeForTuneTable()
        return "1.9_залог";
    end;

    private macro initializeQueryText()
        m_queryText = "";

        if (getAccountMasks(getRowNumber()) != "")
            m_queryText = " WITH rtlData AS (                                                                                                     "
                     //данные для граф 4_1 и 5_1
                     + "\n" + "         SELECT " + BORETAIL + "                                                         t_backOffice,             "
                     + "\n" + "                NVL((SELECT t_okatocode                                                                            "
                     + "\n" + "                       FROM drepdepcode_tmp                                                                        "
                     + "\n" + "                      WHERE t_departmentcode = dep.t_branchId), '99999')                 t_okatoCode,              "
                     + "\n" + "                '" + getRowNumber() + "'                                                 t_row,                    "
                     + "\n" + "                CASE (SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = dep.t_fininstrumentId)    "
                     + "\n" + "                    WHEN '810'                                                                                     "
                     + "\n" + "                        THEN 5                                                                                     "
                     + "\n" + "                    WHEN '643'                                                                                     "
                     + "\n" + "                        THEN 5                                                                                     "
                     + "\n" + "                    WHEN '840'                                                                                     "
                     + "\n" + "                        THEN 6                                                                                     "
                     + "\n" + "                    WHEN '978'                                                                                     "
                     + "\n" + "                        THEN 7                                                                                     "
                     + "\n" + "                    WHEN '156'                                                                                     "
                     + "\n" + "                        THEN 8                                                                                     "
                     + "\n" + "                    ELSE 4                                                                                         "
                     + "\n" + "                END                                                                      t_column,                 "
                     + "\n" + "                dep.t_cbAccount                                                          t_accountNumber,          "
                     + "\n" + "                dep.t_roubleOutRest                                                      t_roubleSum,              "
                     + "\n" + "                dep.t_outRest                                                            t_currencySum,            "
                     + "\n" + "                (SELECT c.t_code                                                                                   "
                     + "\n" + "                   FROM drepPartyCodes_vw c                                                                        "
                     + "\n" + "                  WHERE dep.t_contragentId = c.t_partyId                                                           "
                     + "\n" + "                    AND c.t_codeKind       = " + PTCK_CONTR + ")                         t_clientCode,             "
                     + "\n" + "                party.t_shortName                                                        t_shortName,              "
                     + "\n" + "                CASE WHEN (    dep.t_closeDate  < rep_data.getEndDate()                                            "
                     + "\n" + "                           AND dep.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                             "
                     + "\n" + "                     THEN dep.t_closeDate                                                                          "
                     + "\n" + "                     ELSE rep_data.getEndDate()                                                                    "
                     + "\n" + "                END                                                                      t_recalculateRateDate,    "
                     + "\n" + "                CASE WHEN party.t_isPhisical = 0                            THEN 'Ю'                               "
                     + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 0 THEN 'Ф'                               "
                     + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 1 THEN 'П'                               "
                     + "\n" + "                     ELSE CHR(1)                                                                                   "
                     + "\n" + "                END                                                                      t_clientKind,             "
                     + "\n" + "                dep.t_fininstrumentId                                                    t_currencyId              "
                     + "\n" + "           FROM repRtlDeposit_vw dep                                                                               "
                     + "\n" + "           JOIN drepParty_vw party                                                                                 "
                     + "\n" + "             ON dep.t_contragentId = party.t_id                                                                    "
                     + "\n" + "          WHERE dep.t_isOpenedAtEndDate = 1                                                                        "
                     + "\n" + "            AND " + getAccountMasksClause(getRowNumber(), "dep.t_cbAccount")
                     + "\n" + "            AND party.t_okatoCode IS NOT NULL                                                                      "
                     + "\n" + "            AND " + RcbBranchFieldFilter().getAsSqlString("dep.t_branchId")
                     + "\n" + "          UNION ALL"
                     //данные для граф 4_2 и 5_2 (мультивалютные договора)
                     + "\n" + "         SELECT " + BORETAIL + "                                                         t_backOffice,             "
                     + "\n" + "                NVL((SELECT t_okatocode                                                                            "
                     + "\n" + "                       FROM drepdepcode_tmp                                                                        "
                     + "\n" + "                      WHERE t_departmentcode = dep.t_branchId), '99999')                 t_okatoCode,              "
                     + "\n" + "                '" + getRowNumber() + "'                                                 t_row,                    "
                     + "\n" + "                CASE (SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = mdParams.t_fiId)          "
                     + "\n" + "                    WHEN '810'                                                                                     "
                     + "\n" + "                        THEN 5                                                                                     "
                     + "\n" + "                    WHEN '643'                                                                                     "
                     + "\n" + "                        THEN 5                                                                                     "
                     + "\n" + "                    WHEN '840'                                                                                     "
                     + "\n" + "                        THEN 6                                                                                     "
                     + "\n" + "                    WHEN '978'                                                                                     "
                     + "\n" + "                        THEN 7                                                                                     "
                     + "\n" + "                    WHEN '156'                                                                                     "
                     + "\n" + "                        THEN 8                                                                                     "
                     + "\n" + "                    ELSE 4                                                                                         "
                     + "\n" + "                END                                                                      t_column,                 "
                     + "\n" + "                mdParams.t_cbAccount                                                     t_accountNumber,          "
                     + "\n" + "                mdParams.t_roubleRest                                                    t_roubleSum,              "
                     + "\n" + "                mdParams.t_rest                                                          t_currencySum,            "
                     + "\n" + "                (SELECT c.t_code                                                                                   "
                     + "\n" + "                   FROM drepPartyCodes_vw c                                                                        "
                     + "\n" + "                  WHERE dep.t_contragentId = c.t_partyId                                                           "
                     + "\n" + "                    AND c.t_codeKind       = " + PTCK_CONTR + ")                         t_clientCode,             "
                     + "\n" + "                party.t_shortName                                                        t_shortName,              "
                     + "\n" + "                CASE WHEN (    dep.t_closeDate  < rep_data.getEndDate()                                            "
                     + "\n" + "                           AND dep.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                             "
                     + "\n" + "                     THEN dep.t_closeDate                                                                          "
                     + "\n" + "                     ELSE rep_data.getEndDate()                                                                    "
                     + "\n" + "                END                                                                      t_recalculateRateDate,    "
                     + "\n" + "                CASE WHEN party.t_isPhisical = 0                            THEN 'Ю'                               "
                     + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 0 THEN 'Ф'                               "
                     + "\n" + "                     WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 1 THEN 'П'                               "
                     + "\n" + "                     ELSE CHR(1)                                                                                   "
                     + "\n" + "                END                                                                      t_clientKind,             "
                     + "\n" + "                mdParams.t_fiId                                                          t_currencyId              "
                     + "\n" + "           FROM repRtlMdParameters_vw mdParams                                                                     "
                     + "\n" + "           JOIN repRtlDeposit_vw dep                                                                               "
                     + "\n" + "             ON dep.t_contractId = mdParams.t_contractId                                                           "
                     + "\n" + "           JOIN drepParty_vw party                                                                                 "
                     + "\n" + "             ON dep.t_contragentId = party.t_id                                                                    "
                     + "\n" + "          WHERE dep.t_isOpenedAtEndDate = 1                                                                        "
                     + "\n" + "            AND " + getAccountMasksClause(getRowNumber(), "dep.t_cbAccount")
                     + "\n" + "            AND party.t_okatoCode IS NOT NULL                                                                      "
                     + "\n" + "            AND " + RcbBranchFieldFilter().getAsSqlString("dep.t_branchId")
                     + "\n" + "           )                                                                                                       "
                     + "\n" + "SELECT rtlData.t_backOffice,                                                                                       "
                     + "\n" + "       CASE WHEN rtlData.t_okatoCode <> '99999'                                                                    "
                     + "\n" + "                THEN rpad(substr(rtlData.t_okatoCode, 1, 2), 5, '0')                                               "
                     + "\n" + "            ELSE rtlData.t_okatoCode                                                                               "
                     + "\n" + "       END t_okatoCode,                                                                                            "
                     + "\n" + "       TO_CHAR(rtlData.t_row), rtlData.t_column,                                                                   "
                     + "\n" + "       rtlData.t_accountNumber, rtlData.t_roubleSum, rtlData.t_currencySum,                                        "
                     + "\n" + "       rtlData.t_clientCode, rtlData.t_shortName,                                                                  "
                     + "\n" + "       rtlData.t_recalculateRateDate, rtlData.t_clientKind, rtlData.t_currencyId                                   "
                     + "\n" + "  FROM rtlData                                                                                                     "
                     + "\n" + " UNION ALL                                                                                                         "
                     + "\n" + "SELECT rtlData.t_backOffice, okatoTable.t_okato,                                                                   "
                     + "\n" + "       rtlData.t_row, rtlData.t_column,                                                                            "
                     + "\n" + "       rtlData.t_accountNumber, rtlData.t_roubleSum, rtlData.t_currencySum,                                        "
                     + "\n" + "       rtlData.t_clientCode, rtlData.t_shortName,                                                                  "
                     + "\n" + "       rtlData.t_recalculateRateDate, rtlData.t_clientKind, rtlData.t_currencyId                                   "
                     + "\n" + "  FROM rtlData,                                                                                                    "
                     + "\n" + "       (" + m_okatoTuneTable.getQuery() + ") okatoTable                                                              "
                     + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, rtlData.t_okatoCode) = 1                            ";
        end;

        if (getAccountMasks(getRowNumberPledgeForTuneTable()) != "")  //договоры аренды банковских ячеек
            if (m_queryText != "")
                 m_queryText = m_queryText + "\n" + " UNION ALL ";
            end;

            m_queryText = m_queryText
                 + "\n" + "SELECT " + BORETAIL + "                                                                  t_backOffice,             "
                 + "\n" + "       NVL((SELECT rpad(substr(t_okatoCode, 1, 2), 5, '0')                                                         "
                 + "\n" + "              FROM drepdepcode_tmp                                                                                 "
                 + "\n" + "             WHERE t_departmentcode = rtlSafeCellData.t_branch), '99999')                t_okatoCode,              "
                 + "\n" + "       '" + getRowNumberPledge() + "'                                                    t_row,                    "
                 + "\n" + "       CASE (SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = rtlSafeCellData.t_fiId)            "
                 + "\n" + "           WHEN '810'                                                                                              "
                 + "\n" + "               THEN 5                                                                                              "
                 + "\n" + "           WHEN '643'                                                                                              "
                 + "\n" + "               THEN 5                                                                                              "
                 + "\n" + "           WHEN '840'                                                                                              "
                 + "\n" + "               THEN 6                                                                                              "
                 + "\n" + "           WHEN '978'                                                                                              "
                 + "\n" + "               THEN 7                                                                                              "
                 + "\n" + "           WHEN '156'                                                                                              "
                 + "\n" + "               THEN 8                                                                                              "
                 + "\n" + "           ELSE 4                                                                                                  "
                 + "\n" + "       END                                                                               t_column,                 "
                 + "\n" + "       rtlSafeCellData.t_contractNumber                                                  t_accountNumber,          "
                 + "\n" + "       rtlSafeCellData.t_guaranteeSumInNatCur                                            t_roubleSum,              "
                 + "\n" + "       rtlSafeCellData.t_guaranteeSum                                                    t_currencySum,            "
                 + "\n" + "       (SELECT c.t_code                                                                                            "
                 + "\n" + "          FROM drepPartyCodes_vw c                                                                                 "
                 + "\n" + "         WHERE rtlSafeCellData.t_clientId = c.t_partyId                                                            "
                 + "\n" + "           AND c.t_codeKind               = " + PTCK_CONTR + ")                          t_clientCode,             "
                 + "\n" + "       rtlSafeCellData.t_clientName                                                      t_shortName,              "
                 + "\n" + "       rep_data.getEndDate                                                               t_recalculateRateDate,    "
                 + "\n" + "       CASE WHEN party.t_isPhisical = 0                            THEN 'Ю'                                        "
                 + "\n" + "            WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 0 THEN 'Ф'                                        "
                 + "\n" + "            WHEN party.t_isPhisical = 1 AND party.t_isEmployer = 1 THEN 'П'                                        "
                 + "\n" + "            ELSE CHR(1)                                                                                            "
                 + "\n" + "       END                                                                               t_clientKind,             "
                 + "\n" + "       rtlSafeCellData.t_fiId                                                            t_currencyId              "
                 + "\n" + "  FROM repRtlSafeCellContract_vw rtlSafeCellData                                                                   "
                 + "\n" + "  JOIN drepParty_vw party                                                                                          "
                 + "\n" + "    ON rtlSafeCellData.t_clientId = party.t_id                                                                     "
                 + "\n" + " WHERE rtlSafeCellData.t_isOpenInEndDate = 1                                                                       "
                 ;
        end;
    end;

    initTDepositProcessor2926(tuneTable, okatoTuneTable);
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
macro main()
    var bo_retail = TBackOffice(BORETAIL);
    var tuneTable;
    var okatoTuneTable;

    if (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
        tuneTable = RcbTuneTable("dt302_dbt");
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());
        tuneTable.setInstructionFilter(RCB_I1841_DATE1);

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2055(tuneTable)).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2183_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2055(tuneTable)).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2332_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2055(tuneTable)).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2742_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2470_DATE2);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2055(tuneTable)).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2926_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2742_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2742(tuneTable)).execute();
        end;
    elif  (RcbApplication().currentReport().context().period().endDate() < RCB_I3269_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2926_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2926(tuneTable, okatoTuneTable)).execute();
        end;
    elif  (RcbApplication().currentReport().context().period().endDate() < RCB_I3875_DATE2)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3269_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2926(tuneTable, okatoTuneTable)).execute();
        end;
    elif  (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3875_DATE2);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I3875_DATE2);

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor2926(tuneTable, okatoTuneTable)).execute();
        end;
    else
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I4637_DATE_F302);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_retail.getId());

        okatoTuneTable = RcbArTuneTable_4637();

        if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))
            TInserter(TDepositProcessor4637(tuneTable, okatoTuneTable)).execute();
        end;
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/

    var profiler = TSQLProfiler(getTxtFileName("!calc_f302retail_sqlprof"));
    profiler.clear();
    profiler.on();

main();

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
