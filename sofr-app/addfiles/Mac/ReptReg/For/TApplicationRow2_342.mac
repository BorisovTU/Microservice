/*
$Name:          TApplicationRow2_342.mac
$Module:        Регламентируемая отчетность
$Description:   ФОР. Классы строк приложения2 ФОР по 342-П
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Классы строк приложения2 ФОР по 342-П

  Создан: 19.10.2009 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/***************************************************************************************************
 *  Класc строки 1 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1(applicationName : String)
    initTApplicationRow2(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_1_Gr1(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    local class (TDataSourceFilter) TDataSourceFilter2_1_Gr2(balanceMasks : String, category : String)
        macro makePartDateFilter()
            var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

            m_partDateFilter = "    NOT " + hasAssignedCategory("Строка 2.2")
                +"\n"+ "AND  NOT (" + application6Filter + ")";
        end;

        macro makePartFilter()

            var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + ")";

            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  (   ( " + isNotResident("account.t_contractorId")
                +"\n"+ "          AND (   " + isEmployer("account.t_contractorId")
                +"\n"+ "               OR " + isBank("account.t_contractorId")
                +"\n"+ "               OR NOT " + isNaturalPerson("account.t_contractorId") + "))"
                +"\n"+ "      OR"
                +"\n"+ "         ( " + isNotResident("account.t_clientCode")
                +"\n"+ "          AND (   " + isEmployer("account.t_clientCode")
                +"\n"+ "               OR " + isBank("account.t_clientCode")
                +"\n"+ "               OR NOT " + isNaturalPerson("account.t_clientCode") + ")))"
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "1";
    end;

    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        if (balanceMasks != "")
            balanceMasks = balanceMasks + ",";
        end;

        balanceMasks = balanceMasks + getBalanceMasksForRow("1(1)");

        return balanceMasks;
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_1_Gr1(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ЮЛ_Нерез"));
        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_1_Gr2(getBalanceMasksForRow("1(1)")), m_code, m_applicationName, "1"));
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ЮЛ_Нерез");
    end;

    macro updateBalanceValues()
        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateBalanceValue(dataSet, "ЮЛ_Нерез");
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId(m_applicationName, m_code, "ЮЛ_Нерез"),
                                                                  TBalanceId("Приложение6", "1", "ФОР"),
                                                                  TBalanceId("Приложение6", "2", "ФОР"),
                                                                  TBalanceId("Приложение6", "3", "ФОР")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest,  dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "Расш")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize("408061", "408062"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408061", "408062"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("408091", "408092"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408091", "408092"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("408141", "408142"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408141", "408142"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("408151", "408152"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408151", "408152"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("408181", "408182"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408181", "408182"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("474261", "474262"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("474261", "474262"), false, RCB_RS_EQUAL);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Обязательства перед юридическими", true, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" лицами - нерезидентами", null, null, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Обязательства перед юридическими лицами-нерезидентами", true);
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR2_1", this, "ЮЛ_Нерез", "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_1", this, "Расш", "RV").export();
    end;

    constructor();
end;

class (TApplicationRow342_2_1) TApplicationRow342_2_1_2963(applicationName : String)
    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408061"),
                                                   TDecodingData(m_applicationName, "2", "408062"),
                                                   TDecodingData("Приложение6", "1", "40806"),
                                                   TDecodingData("Приложение6", "2", "40806"),
                                                   TDecodingData("Приложение6", "3", "40806")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408061"),
                                                   TDecodingData(m_applicationName, "2", "408062"),
                                                   TDecodingData("Приложение6", "1", "40806"),
                                                   TDecodingData("Приложение6", "2", "40806"),
                                                   TDecodingData("Приложение6", "3", "40806")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408091"),
                                                   TDecodingData(m_applicationName, "2", "408092"),
                                                   TDecodingData("Приложение6", "1", "40809"),
                                                   TDecodingData("Приложение6", "2", "40809"),
                                                   TDecodingData("Приложение6", "3", "40809")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408091"),
                                                   TDecodingData(m_applicationName, "2", "408092"),
                                                   TDecodingData("Приложение6", "1", "40809"),
                                                   TDecodingData("Приложение6", "2", "40809"),
                                                   TDecodingData("Приложение6", "3", "40809")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408141"),
                                                   TDecodingData(m_applicationName, "2", "408142"),
                                                   TDecodingData("Приложение6", "1", "40814"),
                                                   TDecodingData("Приложение6", "2", "40814"),
                                                   TDecodingData("Приложение6", "3", "40814")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408141"),
                                                   TDecodingData(m_applicationName, "2", "408142"),
                                                   TDecodingData("Приложение6", "1", "40814"),
                                                   TDecodingData("Приложение6", "2", "40814"),
                                                   TDecodingData("Приложение6", "3", "40814")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408151"),
                                                   TDecodingData(m_applicationName, "2", "408152"),
                                                   TDecodingData("Приложение6", "1", "40815"),
                                                   TDecodingData("Приложение6", "2", "40815"),
                                                   TDecodingData("Приложение6", "3", "40815")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408151"),
                                                   TDecodingData(m_applicationName, "2", "408152"),
                                                   TDecodingData("Приложение6", "1", "40815"),
                                                   TDecodingData("Приложение6", "2", "40815"),
                                                   TDecodingData("Приложение6", "3", "40815")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408181"),
                                                   TDecodingData(m_applicationName, "2", "408182"),
                                                   TDecodingData("Приложение6", "1", "40818"),
                                                   TDecodingData("Приложение6", "2", "40818"),
                                                   TDecodingData("Приложение6", "3", "40818")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "408181"),
                                                   TDecodingData(m_applicationName, "2", "408182"),
                                                   TDecodingData("Приложение6", "1", "40818"),
                                                   TDecodingData("Приложение6", "2", "40818"),
                                                   TDecodingData("Приложение6", "3", "40818")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "474261"),
                                                   TDecodingData(m_applicationName, "3", "474262"),
                                                   TDecodingData("Приложение6", "1", "47426"),
                                                   TDecodingData("Приложение6", "2", "47426"),
                                                   TDecodingData("Приложение6", "3", "47426")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "1", "474261"),
                                                   TDecodingData(m_applicationName, "3", "474262"),
                                                   TDecodingData("Приложение6", "1", "47426"),
                                                   TDecodingData("Приложение6", "2", "47426"),
                                                   TDecodingData("Приложение6", "3", "47426")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        global.rowCode = m_code;
        normalizeApplication2Row();
    end;

    private macro constructorTApplicationRow342_2_1_2963(applicationName : String)
        initTApplicationRow342_2_1(applicationName);
    end;

    constructorTApplicationRow342_2_1_2963(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 1.1 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1_1(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "1.1";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ИТОГО");
        printDescriptionRow(" (сумма остатков по строке 1)", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);
        exportValueRow(iterator, "1.1.Итого (сумма остатков по строке 1)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_2", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.2 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1_2(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "1.2";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator("Приложение3", NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "расшифровка", "314440");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Вычитаются:", true, false, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()

        exportDescriptionRow("Вычитается:");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);
        exportValueRow(iterator, "1.2.314440");
    end;

    macro exportToPtkPsd()
        TPtkPsdDecodingExporter("OR2_3", this, "RV", "314440").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.3 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1_3(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "1.3";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1", "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            subtractAndSaveAttributeValue(iterator, "1.1", "1.2");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ВСЕГО (строка 1.1 - 1.2)");
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "1.3.Всего (строка 1.1 - строка 1.2)");
        else
            exportValueRow(iterator, "1.3.ВСЕГО (строка 1.1 - строка 1.2)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_4", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.4 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1_4(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "1.4";
    end;

    macro saveAttributes()

        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.3");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), chronologicAverage.rouble, $0.0, chronologicAverage.scaledRouble, 0.0);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства перед", reportWidth, true);
        printDescriptionRow(" юридическими лицами-", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" нерезидентами в валюте", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Российской Федерации", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (по данным строки 1.3", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" граф \"в рублях\")(2)", null, null, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";


        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("roubleRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("1.4.Обязательства перед юридическими лицами-нерезидентами в валюте РФ(по данным граф ~^в рублях~^ строки 1.3)", value);
        else
            exportSingleValueRow("1.4.Обязательства перед юридическими лицами-нерезидентами в валюте РФ(по данным строки 1.3 граф в рублях)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_4", this, "R").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 1.5 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_1_5(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "1.5";
    end;

    macro saveAttributes()

        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.3");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), $0.0, chronologicAverage.currency, 0.0, chronologicAverage.scaledCurrency);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printSeparator(WIDTH_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства перед юриди-", reportWidth, false);
        printDescriptionRow(" ческими лицами - нерезидентами в", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" иностранной валюте (по данным", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" строки 1.3 граф \"иностранная", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" валюта в рублевом эквиваленте\")(2)", null, null, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";

        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("currencyRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("1.5.Обязательства перед юридическими лицами-нерезидентами в ин. валюте(по данным граф ~^в валюте~^ строки 1.3)", value);
        else
            exportSingleValueRow("1.5.Обязательства перед юридическими лицами-нерезидентами в ин. валюте(по данным строки 1.3 граф в валюте)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdConvertColumnKindExporter("OR2_4", this, "R").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 2 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_2(applicationName : String)
    initTApplicationRow2(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_2_Gr1(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = "    (  " + hasAssignedCategory("Строка 2.2")
                        +"\n"+ "      OR (    NOT " + isEmployer("account.t_contractorId")
                        +"\n"+ "          AND " + isNaturalPerson("account.t_contractorId")
                        +"\n"+ "         )"
                        +"\n"+ "      OR"
                        +"\n"+ "         (    NOT " + isEmployer("account.t_clientCode")
                        +"\n"+ "          AND " + isNaturalPerson("account.t_clientCode")
                        +"\n"+ "         )"
                        +"\n"+"     )"
                        ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    local class (TDataSourceFilter) TDataSourceFilter2_2_Gr2(balanceMasks : String, category : String)
        macro makePartDateFilter()
            var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
                +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

            m_partDateFilter = "     NOT (" + application6Filter + ")"
                        +"\n"+ "     AND (  " + hasAssignedCategory("Строка 2.2")
                        +"\n"+ "      OR (    NOT " + isEmployer("account.t_contractorId")
                        +"\n"+ "          AND " + isNaturalPerson("account.t_contractorId")
                        +"\n"+ "         )"
                        +"\n"+ "      OR"
                        +"\n"+ "         (    NOT " + isEmployer("account.t_clientCode")
                        +"\n"+ "          AND " + isNaturalPerson("account.t_clientCode")
                        +"\n"+ "         )"
                        +"\n"+"      )"
                        ;
        end;

        macro makePartFilter()

            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "2";
    end;


    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_2_Gr1(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ФЛ"));

        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_2_Gr2(getBalanceMasksForRow("2(1)")), m_code, m_applicationName, "1", "Расш1"));

        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_2_Gr2(getBalanceMasksForRow("2(2)")), m_code, m_applicationName, "2", "Расш2"));
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ФЛ");
    end;

    macro updateBalanceValues()
        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateBalanceValue(dataSet, "ФЛ");
    end;

    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        macro unionMasks(masks1, masks2)
            if ((masks1 == "") or (masks2 == ""))
                return masks1 + masks2;
            end;

            return masks1 + "," + masks2;
        end;

        return unionMasks(unionMasks(getBalanceMasksForRow(m_code), getBalanceMasksForRow("2(1)")), getBalanceMasksForRow("2(2)"));
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId(m_applicationName, m_code, "ФЛ"),
                                                                  TBalanceId("Приложение6", "1", "ФОР"),
                                                                  TBalanceId("Приложение6", "2", "ФОР"),
                                                                  TBalanceId("Приложение6", "3", "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest,  dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "Расш1")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "Расш2")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;

        end;
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize("408191", "408192"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("408191", "408192"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("524051", "524052"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("524051", "524052"), false, RCB_RS_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("525011", "525012"), true,  RCB_RS_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("525011", "525012"), false, RCB_RS_EQUAL);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(WIDTH_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Обязательства перед физическими лицами", true, null, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        exportDescriptionRow("2.Обязательства перед физическими лицами");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;


    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR2_5", this, "ФЛ",   "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_5", this, "Расш1", "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_5", this, "Расш2", "RV").export();
    end;

    constructor();
end;

class (TApplicationRow342_2_2) TApplicationRow342_2_2_2963(applicationName : String)
    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "408191"),
                                                   TDecodingData(m_applicationName, "3", "408192"),
                                                   TDecodingData("Приложение6", "1", "40819"),
                                                   TDecodingData("Приложение6", "2", "40819"),
                                                   TDecodingData("Приложение6", "3", "40819")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "408191"),
                                                   TDecodingData(m_applicationName, "3", "408192"),
                                                   TDecodingData("Приложение6", "1", "40819"),
                                                   TDecodingData("Приложение6", "2", "40819"),
                                                   TDecodingData("Приложение6", "3", "40819")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "524051"),
                                                   TDecodingData(m_applicationName, "3", "524052"),
                                                   TDecodingData("Приложение6", "1", "52405"),
                                                   TDecodingData("Приложение6", "2", "52405"),
                                                   TDecodingData("Приложение6", "3", "52405")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "524051"),
                                                   TDecodingData(m_applicationName, "3", "524052"),
                                                   TDecodingData("Приложение6", "1", "52405"),
                                                   TDecodingData("Приложение6", "2", "52405"),
                                                   TDecodingData("Приложение6", "3", "52405")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "525011"),
                                                   TDecodingData(m_applicationName, "3", "525012"),
                                                   TDecodingData("Приложение6", "1", "52501"),
                                                   TDecodingData("Приложение6", "2", "52501"),
                                                   TDecodingData("Приложение6", "3", "52501")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "2", "525011"),
                                                   TDecodingData(m_applicationName, "3", "525012"),
                                                   TDecodingData("Приложение6", "1", "52501"),
                                                   TDecodingData("Приложение6", "2", "52501"),
                                                   TDecodingData("Приложение6", "3", "52501")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );

        global.rowCode = m_code;
        normalizeApplication2Row();
    end;

    private macro constructorTApplicationRow342_2_2_2963(applicationName : String)
        initTApplicationRow342_2_2(applicationName);
    end;

    constructorTApplicationRow342_2_2_2963(applicationName);
end;

class (TApplicationRow342_2_2_2963) TApplicationRow342_2_2_3115(applicationName : String)

    local class (TDataSourceFilter) TDataSourceFilter2_2_Gr1_3115(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " 1 = 1 ";
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_2_Gr1_3115(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ФЛ"));

        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_2_Gr2(getBalanceMasksForRow("2(1)")), m_code, m_applicationName, "1", "Расш1"));

        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_2_Gr2(getBalanceMasksForRow("2(2)")), m_code, m_applicationName, "2", "Расш2"));
    end;

    private macro constructorTApplicationRow342_2_2_3115(applicationName : String)
        initTApplicationRow342_2_2_2963(applicationName);
    end;

    constructorTApplicationRow342_2_2_3115(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 2.1 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_2_1(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "2.1";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ИТОГО");
        printDescriptionRow(" (сумма остатков по строке 2)", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "2.1.Итого (сумма остатков по строке 2)");
        else
            exportValueRow(iterator, "2.1.ИТОГО (сумма остатков по строке 2)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_6", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 2.2 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_2_2(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "2.2";
    end;

    macro saveAttributes()

        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.1");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), chronologicAverage.rouble, $0.0, chronologicAverage.scaledRouble, 0.0);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства перед физическими", reportWidth, true);
        printDescriptionRow(" лицами в валюте Российской  Федерации", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (по данным строки 2.1 граф", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" \"в рублях\")(2)", null, null, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";

        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("roubleRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("2.2.Обязательства перед физическими лицами в валюте РФ(по данным граф ~^в рублях~^ строки 2.1)", value);
        else
            exportSingleValueRow("2.2.Обязательства перед физическими лицами в валюте РФ(по данным строки 2.1 граф в рублях)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_6", this, "R").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 2.3 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_2_3(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "2.3";
    end;

    macro saveAttributes()
        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.1");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), $0.0, chronologicAverage.currency, 0.0, chronologicAverage.scaledCurrency);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(WIDTH_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства перед физическими", reportWidth, false);
        printDescriptionRow(" лицами в иностранной валюте", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (по данным строки 2.1 граф \"иностранная", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" валюта в рублевом эквиваленте\") (2)", null, null, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";

        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("currencyRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("2.3.Обязательства перед физическими лицами в иностранной валюте(по данным граф ~^в валюте~^ строки 2.1)", value);
        else
            exportSingleValueRow("2.3.Обязательства перед физическими лицами в иностранной валюте(по данным строки 2.1 граф в валюте)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdConvertColumnKindExporter("OR2_6", this, "R").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3(applicationName : String)
    initTApplicationRow2(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_3_Gr1(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " " + hasAssignedCategory()
                        ;
        end;

        macro makePartFilter()
            m_partFilter =     " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "3";
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ЮЛ"));
        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow("3(2)")), m_code, m_applicationName, "2"));

        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40108, 40109"), m_code, m_applicationName, "401081","40108", "40109"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40110, 40111"), m_code, m_applicationName, "401101","40110", "40111"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40306, 40308"), m_code, m_applicationName, "403061","40306", "40308"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("47426"), m_code, m_applicationName, "474262"));

        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "F"), m_code, m_applicationName, "603221"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "E"), m_code, m_applicationName, "603222"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "A"), m_code, m_applicationName, "603223"));
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ЮЛ");
    end;

    macro updateBalanceValues()
        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateBalanceValue(dataSet, "ЮЛ");
    end;

    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        if (balanceMasks != "")
            balanceMasks = balanceMasks + ",";
        end;

        balanceMasks = balanceMasks + getBalanceMasksForRow("3(2)");

        return balanceMasks;
    end;

    macro getDecodingBalanceMasks()
        return "40108, 40109, 40110, 40111, 40306, 40308, 47426, 60322";
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId(m_applicationName, m_code, "ЮЛ"),
                                                                  TBalanceId("Приложение6", "1", "ФОР"),
                                                                  TBalanceId("Приложение6", "2", "ФОР"),
                                                                  TBalanceId("Приложение6", "3", "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, max(0, dataSet.roubleRest), max(0, dataSet.currencyRest), max(0, dataSet.roubleScaledRest), max(0, dataSet.currencyScaledRest));
            end;

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId(m_applicationName, m_code, "Расш"),
                                                                  TBalanceId(m_applicationName, "2", "Расш1"),
                                                                  TBalanceId("Приложение6", "1", "ФОР"),
                                                                  TBalanceId("Приложение6", "2", "ФОР"),
                                                                  TBalanceId("Приложение6", "3", "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "расшифровка"), "474262"));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, correctNegativeValue(dataSet.roubleRest, $0), correctNegativeValue(dataSet.currencyRest, $0));
            end;

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId(m_applicationName, m_code, "расшифровка", "474262"),
                                                                  TBalanceId(m_applicationName, "1", "Расш", "474261"),
                                                                  TBalanceId("Приложение6", "1", "ФОР", "47426"),
                                                                  TBalanceId("Приложение6", "2", "ФОР", "47426"),
                                                                  TBalanceId("Приложение6", "3", "ФОР", "47426")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize("401081"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("401081"), false, RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("401101"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("401101"), false, RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("403061"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("403061"), false, RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("603221", "603222", "603223"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("603221", "603222", "603223"), false, RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("403121"), true,  RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("403091"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("403091"), false, RCB_RS_LESS_OR_EQUAL);

        normalizeOneDecoding(RcbArray().initialize("520051"), true,  RCB_RS_LESS_OR_EQUAL);
        normalizeOneDecoding(RcbArray().initialize("520051"), false, RCB_RS_LESS_OR_EQUAL);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(WIDTH_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Иные обязательства", true, null, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        exportDescriptionRow("3.Иные обязательства");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR2_7", this, "ЮЛ",   "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_7", this, "Расш", "RV").export();

        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401081").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401101").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "403061").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "474262").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603221").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603222").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603223").export();
    end;

    constructor();
end;

class (TApplicationRow342_2_3) TApplicationRow342_2_3_2963(applicationName : String)
    initTApplicationRow342_2_3(applicationName);

    macro fillTempTable(tempTable : TTempTable)

        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ЮЛ"));
        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow("3(2)")), m_code, m_applicationName, "2"));

        tempTable.fill(TDecodingDifferenceDataSource3042(TDataSourceFilter2_3_Gr1("30420, 30421"), TDataSourceFilter2_3_Gr1("30416, 30417"), m_code, m_applicationName, "304211",
                                                         TBalanceId("Приложение6", "1", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "1", "ФОР", "30421"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30421"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30421")));

        tempTable.fill(TDecodingDifferenceDataSource3042(TDataSourceFilter2_3_Gr1("30422, 30423"), TDataSourceFilter2_3_Gr1("30418, 30419"), m_code, m_applicationName, "304231",
                                                         TBalanceId("Приложение6", "1", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "1", "ФОР", "30423"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30423"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30423")));

        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40108, 40109"), m_code, m_applicationName, "401081","40108", "40109"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40110, 40111"), m_code, m_applicationName, "401101","40110", "40111"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40306, 40308"), m_code, m_applicationName, "403061","40306", "40308"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("47426"), m_code, m_applicationName, "474262"));


        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "F"), m_code, m_applicationName, "603221"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "E"), m_code, m_applicationName, "603222"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "A"), m_code, m_applicationName, "603223"));

    end;

    macro getDecodingBalanceMasks()
        return "30420, 30416, 30421, 30417, 30422, 30418, 30423, 30419, 40108, 40109, 40110, 40111, 40306, 40308, 47426, 60322";
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3", "603221"),
                                                   TDecodingData(m_applicationName, "3", "603222"),
                                                   TDecodingData(m_applicationName, "3", "603223"),
                                                   TDecodingData("Приложение6", "1", "60322"),
                                                   TDecodingData("Приложение6", "2", "60322"),
                                                   TDecodingData("Приложение6", "3", "60322")
                                                  ),
                             true,
                             RCB_RS_LESS_OR_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3", "603221"),
                                                   TDecodingData(m_applicationName, "3", "603222"),
                                                   TDecodingData(m_applicationName, "3", "603223"),
                                                   TDecodingData("Приложение6", "1", "60322"),
                                                   TDecodingData("Приложение6", "2", "60322"),
                                                   TDecodingData("Приложение6", "3", "60322")
                                                  ),
                             false,
                             RCB_RS_LESS_OR_EQUAL
                            );

        global.rowCode = m_code;
        normalizeApplication2Row();
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR2_7", this, "ЮЛ",   "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_7", this, "Расш", "RV").export();

        TPtkPsdDecodingExporter("OR2_7", this, "RV", "304211").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "304231").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401081").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401101").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "403061").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "474262").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603221").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603222").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603223").export();
    end;

    constructor();
end;

class (TApplicationRow342_2_3_2963) TApplicationRow342_2_3_3115(applicationName : String)
    initTApplicationRow342_2_3_2963(applicationName);

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ЮЛ"));
        tempTable.fill(TBalanceDecodingDataSource(TDataSourceFilter2_3_Gr1(getBalanceMasksForRow("3(2)")), m_code, m_applicationName, "2"));

        tempTable.fill(TDecodingDifferenceDataSource3042(TDataSourceFilter2_3_Gr1("30420, 30421"), TDataSourceFilter2_3_Gr1("30416, 30417"), m_code, m_applicationName, "304211",
                                                         TBalanceId("Приложение6", "1", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30420"),
                                                         TBalanceId("Приложение6", "1", "ФОР", "30421"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30421"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30421")));

        tempTable.fill(TDecodingDifferenceDataSource3042(TDataSourceFilter2_3_Gr1("30422, 30423"), TDataSourceFilter2_3_Gr1("30418, 30419"), m_code, m_applicationName, "304231",
                                                         TBalanceId("Приложение6", "1", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30422"),
                                                         TBalanceId("Приложение6", "1", "ФОР", "30423"),
                                                         TBalanceId("Приложение6", "2", "ФОР", "30423"),
                                                         TBalanceId("Приложение6", "3", "ФОР", "30423")));

        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40108, 40109"), m_code, m_applicationName, "401081","40108", "40109"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40110, 40111"), m_code, m_applicationName, "401101","40110", "40111"));
        tempTable.fill(TDecodingDifferenceDataSource(TDataSourceFilter2_3_Gr1("40306, 40308"), m_code, m_applicationName, "403061","40306", "40308"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("47426"), m_code, m_applicationName, "474262"));


        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "F"), m_code, m_applicationName, "603221"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "E"), m_code, m_applicationName, "603222"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "A"), m_code, m_applicationName, "603223"));

        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_Gr1("60322", "G"), m_code, m_applicationName, "603224"));
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3", "603221"),
                                                   TDecodingData(m_applicationName, "3", "603222"),
                                                   TDecodingData(m_applicationName, "3", "603223"),
                                                   TDecodingData(m_applicationName, "3", "603224"),
                                                   TDecodingData("Приложение6", "1", "60322"),
                                                   TDecodingData("Приложение6", "2", "60322"),
                                                   TDecodingData("Приложение6", "3", "60322")
                                                  ),
                             true,
                             RCB_RS_LESS_OR_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3", "603221"),
                                                   TDecodingData(m_applicationName, "3", "603222"),
                                                   TDecodingData(m_applicationName, "3", "603223"),
                                                   TDecodingData(m_applicationName, "3", "603224"),
                                                   TDecodingData("Приложение6", "1", "60322"),
                                                   TDecodingData("Приложение6", "2", "60322"),
                                                   TDecodingData("Приложение6", "3", "60322")
                                                  ),
                             false,
                             RCB_RS_LESS_OR_EQUAL
                            );

        global.rowCode = m_code;
        normalizeApplication2Row();
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR2_7", this, "ЮЛ",   "RV").export();
        TPtkPsdBalanceGroupExporter("OR2_7", this, "Расш", "RV").export();

        TPtkPsdDecodingExporter("OR2_7", this, "RV", "304211").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "304231").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401081").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "401101").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "403061").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "474262").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603221").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603222").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603223").export();
        TPtkPsdDecodingExporter("OR2_7", this, "RV", "603224").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.1 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_1(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "3.1";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ИТОГО (сумма остатков  по строке 3)");
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "3.1.Итого (сумма остатков по строке 3)");
        else
            exportValueRow(iterator, "3.1.ИТОГО (сумма остатков по строке 3)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_8", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.2 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_2(applicationName : String)
    initTApplicationRow2(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_3_2(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " " + hasAssignedCategory()
                        ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "3.2";
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("40312", "R"), m_code, m_applicationName, "403121", NULL, global.ROUBLE_ONLY));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("47409", "R"), m_code, m_applicationName, "474091"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("52005", "D"), m_code, m_applicationName, "520051"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("52006", "D"), m_code, m_applicationName, "520061"));
    end;

    macro getDecodingBalanceMasks()
        return "40312, 47409, 52005, 520061";
    end;

    macro saveAttributes()
        var compositeValue : Object = NULL;
        var iterator       : Object = NULL;
        var dataSet        : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, "3.2", "расшифровка")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;

            iterator = getAttributeValueIterator("Приложение3", NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.4");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("расшифровка", "410439", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact,  compositeValue.fieldValue("currencyRest").exact,
                                   compositeValue.fieldValue("roubleRest").scaled, compositeValue.fieldValue("currencyRest").scaled);
                iterator.moveNext();
            end;

            iterator = getAttributeValueIterator("Приложение4", NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("расшифровка", "520524", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact,  compositeValue.fieldValue("currencyRest").exact,
                                   compositeValue.fieldValue("roubleRest").scaled, compositeValue.fieldValue("currencyRest").scaled);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        global.rowCode = m_code;

        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Вычитаются:", true, null, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);

        var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT1, DATE(beginDateInBlock), numberDatesInBlock, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "474091");
        printRow(iterator, false, true, false);

        iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT2, DATE(beginDateInBlock), numberDatesInBlock, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "474091");
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        global.rowCode = m_code;

        exportDescriptionRow("3.2.Вычитаются:");

        var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_KLIKO1, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "474091");
        exportRoubleValueRow(iterator);

        iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_KLIKO2, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "474091");
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdDecodingExporter("OR2_9", this, "R", "403121").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "474091").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "410439").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520051").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520061").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520524").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.2 приложения2 по 2341-У
 **************************************************************************************************/
class (TApplicationRow342_2_3_2) TApplicationRow2_3_2__2341(applicationName : String)
    initTApplicationRow342_2_3_2(applicationName);

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("40312", "R"), m_code, m_applicationName, "403121", NULL, global.ROUBLE_ONLY));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("47409", "R"), m_code, m_applicationName, "474091"));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("52005", "D"), m_code, m_applicationName, "520051"));
    end;

    macro exportToPtkPsd()
        TPtkPsdDecodingExporter("OR2_9", this, "R",  "403121").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "474091").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "410439").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520051").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520524").export();
    end;

    macro getDecodingBalanceMasks()
        return "40312, 47409, 52005";
    end;
end;

class (TApplicationRow2_3_2__2341) TApplicationRow342_2_3_2_2963(applicationName : String)
    initTApplicationRow2_3_2__2341(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_3_2_2963(balanceMasks : String, category : String, groupId : Integer)
        private var m_objGroupId = nvl(groupId, RCB_OBJGROUP_REPORT);

        private macro hasAssignedCategory(category : String, groupId : Integer)
            var filter = "";
            var objGroupId = nvl(groupId, RCB_OBJGROUP_REPORT);

            if (nvl(category, m_category) != NULL)
                filter = "EXISTS(SELECT 1"
                  +"\n"+ "         FROM dobjatcor_dbt atc"
                  +"\n"+ "        WHERE atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
                  +"\n"+ "          AND atc.t_GroupID    = " + m_objGroupId
                  +"\n"+ "          AND atc.t_Object     = account.t_accountObjectId"
                  +"\n"+ "          AND atc.t_AttrID = (SELECT att.t_AttrID"
                  +"\n"+ "                                FROM dobjattr_dbt att"
                  +"\n"+ "                               WHERE att.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
                  +"\n"+ "                                 AND att.t_GroupID    = " + m_objGroupId
                  +"\n"+ "                                 AND att.t_codeList = CHR(1)"
                  +"\n"+ "                                 AND att.t_numInList  = " + getSqlString(nvl(category, m_category)) + ")"
                  +"\n"+ "          AND (frd.t_date - 1) BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)";
            else
                filter = "1 = 1";
            end;
            return filter;
        end;

        macro makePartDateFilter()
            m_partDateFilter = " " + hasAssignedCategory(m_category, m_objGroupId)
                        ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TDecodingDataSource4090(TDataSourceFilter2_3_2_2963("40901", "ПА", RCB_OBJGROUP_REPORTKIND), TDataSourceFilter2_3_2_2963("47431", "ПА", RCB_OBJGROUP_REPORTKIND), m_code, m_applicationName, "409011"));
        tempTable.fill(TDecodingDataSource4090(TDataSourceFilter2_3_2_2963("40902", "ПА", RCB_OBJGROUP_REPORTKIND), TDataSourceFilter2_3_2_2963("47410", "ПА", RCB_OBJGROUP_REPORTKIND), m_code, m_applicationName, "409021"));

        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("40312", "R"), m_code, m_applicationName, "403121", NULL, global.ROUBLE_ONLY));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("52005", "D"), m_code, m_applicationName, "520051"));
    end;

    macro getDecodingBalanceMasks()
        return "40901, 40902, 40312, 52005, 47431, 47410";
    end;

    macro normalizeDecoding()
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3.2", "403121"),
                                                   TDecodingData("Приложение6", "1", "40312"),
                                                   TDecodingData("Приложение6", "2", "40312"),
                                                   TDecodingData("Приложение6", "3", "40312")
                                                  ),
                             true,
                             RCB_RS_LESS_OR_EQUAL
                            );

        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3.2", "520051"),
                                                   TDecodingData("Приложение4", "1", "52005"),
                                                   TDecodingData("Приложение6", "1", "52005"),
                                                   TDecodingData("Приложение6", "2", "52005"),
                                                   TDecodingData("Приложение6", "3", "52005")
                                                  ),
                             true,
                             RCB_RS_EQUAL
                            );
        normalizeOneDecoding(RcbArray().initialize(TDecodingData(m_applicationName, "3.2", "520051"),
                                                   TDecodingData("Приложение4", "1", "52005"),
                                                   TDecodingData("Приложение6", "1", "52005"),
                                                   TDecodingData("Приложение6", "2", "52005"),
                                                   TDecodingData("Приложение6", "3", "52005")
                                                  ),
                             false,
                             RCB_RS_EQUAL
                            );
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        global.rowCode = m_code;

        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Вычитаются:", true, null, beginDateInBlock, numberDatesInBlock);
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);

        var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT1, DATE(beginDateInBlock), numberDatesInBlock, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "409011");
        printRow(iterator, false, true, false);
        iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT2, DATE(beginDateInBlock), numberDatesInBlock, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "409011");
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        global.rowCode = m_code;

        exportDescriptionRow("3.2.Вычитаются:");
        var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_KLIKO1, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "409011");
        exportRoubleValueRow(iterator);
        iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
        iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_KLIKO2, "403121", global.rowCode);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "409011");
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "409011").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "409021").export();
        TPtkPsdDecodingExporter("OR2_9", this, "R",  "403121").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "410439").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520051").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520524").export();
    end;

end;

class (TApplicationRow342_2_3_2_2963) TApplicationRow342_2_3_2_3115(applicationName : String)
    initTApplicationRow342_2_3_2_2963(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter2_3_2_3115(balanceMasks : String, category : String, groupId : Integer)
        private var m_objGroupId = nvl(groupId, RCB_OBJGROUP_REPORT);

        private macro hasAssignedCategory(category : String, groupId : Integer)
            var filter = "";
            var objGroupId = nvl(groupId, RCB_OBJGROUP_REPORT);

            if (nvl(category, m_category) != NULL)
                filter = "EXISTS(SELECT 1"
                  +"\n"+ "         FROM dobjatcor_dbt atc"
                  +"\n"+ "        WHERE atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
                  +"\n"+ "          AND atc.t_GroupID    = " + m_objGroupId
                  +"\n"+ "          AND atc.t_Object     = account.t_accountObjectId"
                  +"\n"+ "          AND atc.t_AttrID = (SELECT att.t_AttrID"
                  +"\n"+ "                                FROM dobjattr_dbt att"
                  +"\n"+ "                               WHERE att.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
                  +"\n"+ "                                 AND att.t_GroupID    = " + m_objGroupId
                  +"\n"+ "                                 AND att.t_codeList = CHR(1)"
                  +"\n"+ "                                 AND att.t_numInList  = " + getSqlString(nvl(category, m_category)) + ")"
                  +"\n"+ "          AND (frd.t_date - 1) BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)";
            else
                filter = "1 = 1";
            end;
            return filter;
        end;

        macro makePartDateFilter()
            m_partDateFilter = " " + hasAssignedCategory(m_category, m_objGroupId)
                        ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource4090_Total(
                                                    TDecodingDataSource4090(TDataSourceFilter2_3_2_3115("40901", "ПА", RCB_OBJGROUP_REPORTKIND), TDataSourceFilter2_3_2_3115("47431", "ПА", RCB_OBJGROUP_REPORTKIND), m_code, m_applicationName, "409011"),
                                                    TDecodingDataSource4090(TDataSourceFilter2_3_2_3115("40902", "ПА", RCB_OBJGROUP_REPORTKIND), TDataSourceFilter2_3_2_3115("47410", "ПА", RCB_OBJGROUP_REPORTKIND), m_code, m_applicationName, "409011")
                                                   ));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("40312", "R"), m_code, m_applicationName, "403121", NULL, global.ROUBLE_ONLY));
        tempTable.fill(TDecodingDataSource(TDataSourceFilter2_3_2("52005", "D"), m_code, m_applicationName, "520051"));
    end;

    macro exportToPtkPsd()
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "409011").export();
        TPtkPsdDecodingExporter("OR2_9", this, "R",  "403121").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "410439").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520051").export();
        TPtkPsdDecodingExporter("OR2_9", this, "RV", "520524").export();
    end;
end;

/***************************************************************************************************
 *  Класc строки 3.3 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_3(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "3.3";
    end;

    macro saveAttributes()

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ИТОГО (сумма остатков по кодам");
        printDescriptionRow(" обозначения по строке 3.2)", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "3.3.Итого (сумма остатков по кодам обозначения по строке 3.2)");
        else
            exportValueRow(iterator, "3.3.ИТОГО (сумма остатков по кодам обозначения по строке 3.2)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_91", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.4 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_4(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "3.4";
    end;

    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3.1", "3.3");
            iterator.setSortOrder(SORTER_FOR_DATE);
            subtractAndSaveAttributeValue(iterator, "3.1", "3.3");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " ВСЕГО (строка 3.1 - строка 3.3)");
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "3.4.Итого (строка 3.1 - строка 3.3)");
        else
            exportValueRow(iterator, "3.4.ВСЕГО (строка 3.1 - строка 3.3)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_91", this, "RV").export();
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.5 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_5(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "3.5";
    end;

    macro saveAttributes()

        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3.4");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), chronologicAverage.rouble, $0.0, chronologicAverage.scaledRouble, 0.0);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства в валюте Российской", reportWidth, true);
        printDescriptionRow(" Федерации (по данным строки", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" 3.4 граф \"в рублях\")(2)", null, null, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";

        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("roubleRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("3.5.Иные обязательства в валюте РФ(по данным граф ~^в рублях~^ строки 3.4)", value);
        else
            exportSingleValueRow("3.5.Иные обязательства в валюте РФ(по данным строки 3.4 граф в рублях)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR2_91", this, "R").export();
    end;
    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3.6 приложения2
 **************************************************************************************************/
class (TApplicationRow2) TApplicationRow342_2_3_6(applicationName : String)
    initTApplicationRow2(applicationName);

    private macro constructor()
        m_code = "3.6";
    end;

    macro saveAttributes()

        var chronologicAverage : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3.4");
            chronologicAverage = calculateChronologicAverage(iterator);
            saveAttributeValue("", "", Date(0,0,0), $0.0, chronologicAverage.currency, 0.0, chronologicAverage.scaledCurrency);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(WIDTH_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, null, null);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printSingleValueRow(iterator, " Обязательства в иностранной валюте", reportWidth, false);
        printDescriptionRow(" (по данным строки 3.4 графы", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" \"иностранная валюта в рублевом", null, null, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" эквиваленте\")(2)", null, null, beginDateInBlock, numberDatesInBlock);
        printBottom(false, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator       : Object = getValueIterator();
        var value          : String = "0";

        if (iterator != null)
            iterator.moveFirst();
            value = iterator.currentItem.fieldValue("currencyRest").currentAsString;
        end;

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportSingleValueRow("3.6.Иные обязательства в иностранной валюте(по данным граф ~^в валюте~^ строки 3.4)", value);
        else
            exportSingleValueRow("3.6.Иные обязательства в иностранной валюте(по данным строки 3.4 граф в валюте)", value);
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdConvertColumnKindExporter("OR2_91", this, "R").export();
    end;

    constructor();
end;
