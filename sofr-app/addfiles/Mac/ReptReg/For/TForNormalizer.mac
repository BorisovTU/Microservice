/*
$Name:          TForNormalizer.mac
$Module:        Регламентируемая отчетность
$Description:   ФОР. Нормализатор расшифровок
*/

class TForNormalizer(multiplier)

    private var m_multiplier;
    private var m_normalizerPool:      RcbArray;
    private var m_isFillNormalizePool: bool;
    private var m_rcbValuesPool:       RcbArray;


    /**
     * Констуктор
     */
    macro constructorTForNormalizer(multiplier)
        m_multiplier          = multiplier;
        m_isFillNormalizePool = false;
    end;

    macro getBalanceIterator(applicationName : String) : RcbValueIterator
        class TFilter()
            macro isSuitable(v : Object)
                return ((v.fieldValue("row").current == "3.2")
                        and ((v.fieldValue("balance").current == "409011")
                          or (v.fieldValue("balance").current == "409021"))
                       );
            end;
        end;

        class TFilterOutSide()
            macro isSuitable(v : Object)
                return ((v.fieldValue("row").current == "3.2")
                        and ((v.fieldValue("balance").current == "409011")
                          or (v.fieldValue("balance").current == "409021"))
                        and ((v.fieldValue("date").current == global.parameters.getBeginDate()) or (v.fieldValue("date").current == global.parameters.getEndDate() + 1))
                       );
            end;
        end;

        class TEmptyFilter() /* Класс для возврата пустого итератора */
            macro isSuitable(v : Object)
                return (v.fieldValue("row").current == "1234567890");
            end;
        end;

        class TSorter()
            macro isLess(v1 : Object, v2 : Object)
                return ((v1.fieldValue("balance").current) < (v2.fieldValue("balance").current));
            end;
        end;

        var prevBalance = "";

        if (global.parameters.isDisableNormalization() == 0)
            return TApplicationRow(applicationName).getAttributeValueIterator(applicationName, TEmptyFilter(), TSorter());
        elif (global.parameters.isDisableNormalization() == 1)
            return TApplicationRow(applicationName).getAttributeValueIterator(applicationName, TFilterOutSide(), TSorter());
        else
            return TApplicationRow(applicationName).getAttributeValueIterator(applicationName, TFilter(), TSorter());
        end;

    end;

    /**
     * Добавить отношение
     */
    macro addRelation(decodingNamePool : RcbArray, balancePool: RcbArray, isRouble : Bool, sign : Integer)

        private class TNormalizerValueData(_name : String, _value : Object)
            var name = _name;
            var value = _value;
        end;

        class TFilterOutSide(balance : String, row : String, beginDate : Date, endDate : Date)
            private var m_balance = balance;
            private var m_row = row;
            private var m_beginDate = beginDate;
            private var m_endDate = endDate;

            macro isSuitable(v : Object)
                return (    (v.fieldValue("balance").current == m_balance)
                        and ((m_row == null) or (v.fieldValue("row").current == m_row))
                        and ((v.fieldValue("date").current == m_beginDate) or (v.fieldValue("date").current == m_endDate + 1))
                       );
            end;
        end;

        var iteratorPool = RcbArray();
        var applicationNamePool = RcbArray();

        var synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_FULL_OUTER_JOIN, SORTER_FOR_DATE);

        var iterator;

        var decodingName;
        var applicationName;
        var row;

        decodingNamePool.moveFirst();

        if (global.parameters.isDisableNormalization() == 0)
            return;
        elif (global.parameters.isDisableNormalization() == 1)
            while (decodingNamePool.moveNext())
                decodingName = decodingNamePool.getCurrentItem();
                applicationName = null;
                row = null;
                if (isEqClass("TDecodingData", decodingName))
                    applicationName = decodingName.applicationName;
                    row = decodingName.row;
                    decodingName = decodingName.name;
                end;

                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, TFilterOutSide(decodingName, row, global.parameters.getBeginDate(), global.parameters.getEndDate()));
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        else
            while (decodingNamePool.moveNext())
                decodingName = decodingNamePool.getCurrentItem();
                applicationName = null;
                row = null;
                if (isEqClass("TDecodingData", decodingName))
                    applicationName = decodingName.applicationName;
                    row = decodingName.row;
                    decodingName = decodingName.name;
                end;

                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                iterator.setFilter(FILTER_FOR_NORMALIZER1, decodingName, row);
                iterator.moveFirst();
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        end;

        if (m_normalizerPool.isEmpty())
            m_isFillNormalizePool = true;
        else
            m_normalizerPool.moveFirst();
            m_normalizerPool.moveNext();
        end;

        synchronizer.moveFirst();
        while (not synchronizer.isDone())

            iteratorPool.moveFirst();

            var dateValue : Date;
            var balanceNumber;

            var rcbValuePool = RcbArray();
            var isFirstIterator = true;
            var hasBalanceData = false;
            var relation;

            //формирование левой части отношения
            while (iteratorPool.moveNext())
                if (synchronizer.isNull(iteratorPool.getCurrentItem()))
                    continue;
                end;

                var compositeValue = iteratorPool.getCurrentItem().currentItem;

                if (isFirstIterator)
                    dateValue = Date(trim(compositeValue.fieldValue("date").exactAsString));
                    balanceNumber = substr(compositeValue.fieldValue("balance").exactAsString, 1, 5);
                    isFirstIterator = false;
                    hasBalanceData = global.balanceData.hasData(dateValue);
                end;

                if (hasBalanceData)
                    var value = compositeValue.fieldValue(ternary(isRouble, "roubleRest", "currencyRest"));
                    if (value.exact != $0)
                        var id = global.toAnsiNorm(        applicationNamePool.value(iteratorPool.getCurrentIndex())
                                                   + "_" + compositeValue.fieldValue("row").exactAsString
                                                   + "_" + ternary(isRouble, "Ру", "Ва")
                                                   + "_" + compositeValue.fieldValue("balance").exactAsString
                                                   + "_" + string(dateValue : f),
                                                   true
                                                  );
                        rcbValuePool.push_back(TNormalizerValueData(id, value));
                    end;
                end;
            end;

            //формирование правой части отношения - балансовые счета
            var balancevalues;
            var balanceValue;
            var poolOfConstantValues : RcbArray = RcbArray();
            if (hasBalanceData)
                balancePool.moveFirst();
                while (balancePool.moveNext())
                    balancevalues  = global.balanceData.getValues(balancePool.getCurrentItem(), dateValue);
                    balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                    poolOfConstantValues.push_back(balanceValue);
                end;
            end;

            //добавить нормализатор в пул
            var currentNormalize;
            if (m_isFillNormalizePool)
                m_normalizerPool.push_back(ReportNormalizer(m_multiplier));
                currentNormalize = m_normalizerPool(m_normalizerPool.getCount() - 1);
            else
                currentNormalize = m_normalizerPool.getCurrentItem();
            end;

            relation = ReportLinearRelation(sign);

            //добавить отношение слева
            rcbValuePool.moveFirst();
            if (rcbValuePool.isEmpty())
                synchronizer.moveNext();
                continue;
            end;

            while (rcbValuePool.moveNext())
                var node = currentNormalize.addNode(rcbValuePool.getCurrentItem().name);
                node.setExact(rcbValuePool.getCurrentItem.value.exact);
                node.recalculateScaled();
                relation.lhs.plus(node);
            end;

            //добавить отношение справа
            poolOfConstantValues.moveFirst();
            while (poolOfConstantValues.moveNext())
                relation.rhs.plus(Double(poolOfConstantValues.getCurrentItem()));
            end;

            currentNormalize.addRelation(relation);

            if (not m_isFillNormalizePool)
                m_normalizerPool.moveNext();
            end;

            synchronizer.moveNext();
        end;
        m_rcbValuesPool.push_back(rcbValuePool);

    end;


    /**
     * Нормализация
     */
    macro normalize()
        var rcbValuePool;
        var currentItem;

        m_normalizerPool.moveFirst();
        while (m_normalizerPool.moveNext())
            if (valType(m_normalizerPool.getCurrentItem()) != V_UNDEF)
                m_normalizerPool.getCurrentItem().normalize();
                m_rcbValuesPool.moveFirst();
                if (m_normalizerPool.getCurrentItem().isNormalized())
                    while (m_rcbValuesPool.moveNext())
                        if (valType(m_rcbValuesPool.getCurrentItem()) != V_UNDEF)
                            rcbValuePool = m_rcbValuesPool.getCurrentItem();
                            rcbValuePool.moveFirst();
                            while(rcbValuePool.moveNext())
                                currentItem = rcbValuePool.getCurrentItem();
                                if (valType(m_normalizerPool.getCurrentItem().node(currentItem.name)) != V_UNDEF)
                                    currentItem.value.scaled = m_normalizerPool.getCurrentItem().node(currentItem.name).scaled;
                                    normalizationProtocol.printString(currentItem.name, currentItem.value.exact, currentItem.value.scaled, m_normalizerPool.getCurrentItem().getLogFilePath());
                                end;
                            end;
                        end;
                    end;
                else
                    m_rcbValuesPool.moveFirst();
                    while (m_rcbValuesPool.moveNext())
                        rcbValuePool = m_rcbValuesPool.getCurrentItem();
                        while (rcbValuePool.moveNext())
                            normalizationProtocolWithErrors.printError(rcbValuePool.getCurrentItem().name);
                            normalizationProtocolWithErrors.printNameLog(m_normalizerPool.getCurrentItem().getLogFilePath());
                        end;
                    end;
                end;
            end;
        end;
    end;

    constructorTForNormalizer(multiplier);
end;

class (TForNormalizer) TForNormalizerWithCondition(multiplier)

    macro addRelation(lhsCondition : RcbArray, rhsCondition : RcbArray, conditionSign : Integer,
                      decodingNamePool : RcbArray, balancePool: RcbArray, isRouble : Bool, sign : Integer)

        private class TNormalizerValueData(_name : String, _value : Object)
            var name = _name;
            var value = _value;
        end;

        class TFilterOutSide(balance : String, row : String, beginDate : Date, endDate : Date)
            private var m_balance = balance;
            private var m_row = row;
            private var m_beginDate = beginDate;
            private var m_endDate = endDate;

            macro isSuitable(v : Object)
                return (    (v.fieldValue("balance").current == m_balance)
                        and ((m_row == null) or (v.fieldValue("row").current == m_row))
                        and ((v.fieldValue("date").current == m_beginDate) or (v.fieldValue("date").current == m_endDate + 1))
                       );
            end;
        end;

        var iteratorPool = RcbArray();
        var applicationNamePool = RcbArray();

        var synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_FULL_OUTER_JOIN, SORTER_FOR_DATE);

        var iterator;

        var decodingName;
        var applicationName;
        var row;

        decodingNamePool.moveFirst();

        if (global.parameters.isDisableNormalization() == 0)
            return;
        elif (global.parameters.isDisableNormalization() == 1)
            while (decodingNamePool.moveNext())
                decodingName = decodingNamePool.getCurrentItem();
                applicationName = null;
                row = null;
                if (isEqClass("TDecodingData", decodingName))
                    applicationName = decodingName.applicationName;
                    row = decodingName.row;
                    decodingName = decodingName.name;
                end;

                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, TFilterOutSide(decodingName, row, global.parameters.getBeginDate(), global.parameters.getEndDate()));
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        else
            while (decodingNamePool.moveNext())
                decodingName = decodingNamePool.getCurrentItem();
                applicationName = null;
                row = null;
                if (isEqClass("TDecodingData", decodingName))
                    applicationName = decodingName.applicationName;
                    row = decodingName.row;
                    decodingName = decodingName.name;
                end;

                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                iterator.setFilter(FILTER_FOR_NORMALIZER1, decodingName, row);
                iterator.moveFirst();
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        end;

        synchronizer.moveFirst();
        while (not synchronizer.isDone())

            iteratorPool.moveFirst();

            var dateValue : Date;
            var balanceNumber;
            var balancevalues;
            var balanceValue;

            var rcbValuePool = RcbArray();
            var hasBalanceData = false;
            var relation;

            //формирование левой части отношения
            while (iteratorPool.moveNext())
                if (synchronizer.isNull(iteratorPool.getCurrentItem()))
                    continue;
                end;

                var compositeValue = iteratorPool.getCurrentItem().currentItem;
                var isAddNormalizer = false;
                var isConditionSatisfied = false;
                var lhsValue = 0;
                var rhsValue = 0;

                dateValue = Date(trim(compositeValue.fieldValue("date").exactAsString));
                hasBalanceData = global.balanceData.hasData(dateValue);
                balanceNumber = substr(compositeValue.fieldValue("balance").exactAsString, 1, 5);

                if (hasBalanceData)
                    lhsCondition.moveFirst();
                    while (lhsCondition.moveNext())
                        if (valType(lhsCondition.getCurrentItem()) != V_UNDEF)
                            if (substr(lhsCondition.getCurrentItem(), 1, 1) == "-")
                                balancevalues  = global.balanceData.getValues(substr(lhsCondition.getCurrentItem(), 2, 5), dateValue);
                                balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                                lhsValue = lhsValue - balanceValue;
                            else
                                balancevalues  = global.balanceData.getValues(substr(lhsCondition.getCurrentItem(), 1, 5), dateValue);
                                balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                                lhsValue = lhsValue + balanceValue;
                            end;
                        end;
                    end;

                    rhsCondition.moveFirst();
                    while (rhsCondition.moveNext())
                        if (valType(rhsCondition.getCurrentItem()) != V_UNDEF)
                           if (substr(rhsCondition.getCurrentItem(), 1, 1) == "-")
                                balancevalues  = global.balanceData.getValues(substr(rhsCondition.getCurrentItem(), 2, 5), dateValue);
                                balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                                rhsValue = rhsValue - balanceValue;
                            else
                                balancevalues  = global.balanceData.getValues(substr(rhsCondition.getCurrentItem(), 1, 5), dateValue);
                                balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                                rhsValue = rhsValue + balanceValue;
                            end;
                        end;
                    end;

                    if ((conditionSign == RCB_RS_GREATER) and (lhsValue > rhsValue))
                        isConditionSatisfied = true;
                    elif ((conditionSign == RCB_RS_GREATER_OR_EQUAL) and (lhsValue >= rhsValue))
                        isConditionSatisfied = true;
                    elif ((conditionSign == RCB_RS_LESS) and (lhsValue < rhsValue))
                        isConditionSatisfied = true;
                    elif ((conditionSign == RCB_RS_LESS_OR_EQUAL) and (lhsValue <= rhsValue))
                        isConditionSatisfied = true;
                    elif ((conditionSign == RCB_RS_EQUAL) and (lhsValue == rhsValue))
                        isConditionSatisfied = true;
                    elif ((conditionSign == RCB_RS_NOT_EQUAL) and (lhsValue != rhsValue))
                        isConditionSatisfied = true;
                    end;
                end;

                if (hasBalanceData and isConditionSatisfied)
                    var value = compositeValue.fieldValue(ternary(isRouble, "roubleRest", "currencyRest"));
                    isAddNormalizer = true;

                    if (value.exact != $0)
                        var id = global.toAnsiNorm(        applicationNamePool.value(iteratorPool.getCurrentIndex())
                                                   + "_" + compositeValue.fieldValue("row").exactAsString
                                                   + "_" + ternary(isRouble, "Ру", "Ва")
                                                   + "_" + compositeValue.fieldValue("balance").exactAsString
                                                   + "_" + string(dateValue : f),
                                                   true
                                                  );
                        rcbValuePool.push_back(TNormalizerValueData(id, value));
                    end;
                end;
            end;

            if (isAddNormalizer)
                if (m_normalizerPool.isEmpty())
                    m_isFillNormalizePool = true;
                else
                    m_normalizerPool.moveFirst();
                    m_normalizerPool.moveNext();
                end;

                //формирование правой части отношения - балансовые счета
                var poolOfConstantValues : RcbArray = RcbArray();
                if (hasBalanceData)
                    balancePool.moveFirst();
                    while (balancePool.moveNext())
                        if (substr(balancePool.getCurrentItem(), 1, 1) == "-")
                            balancevalues  = global.balanceData.getValues(substr(balancePool.getCurrentItem(), 2, 5), dateValue);
                            balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                            poolOfConstantValues.push_back(balanceValue * (-1));
                        else
                            balancevalues  = global.balanceData.getValues(substr(balancePool.getCurrentItem(), 1, 5), dateValue);
                            balanceValue   = ternary(isRouble, balancevalues.getRoubleScaledRest(), balancevalues.getCurrencyScaledRest());
                            poolOfConstantValues.push_back(balanceValue);
                        end;
                    end;
                end;

                //добавить нормализатор в пул
                var currentNormalize;
                if (m_isFillNormalizePool)
                    m_normalizerPool.push_back(ReportNormalizer(m_multiplier));
                    currentNormalize = m_normalizerPool(m_normalizerPool.getCount() - 1);
                else
                    currentNormalize = m_normalizerPool.getCurrentItem();
                end;

                relation = ReportLinearRelation(sign);

                //добавить отношение слева
                rcbValuePool.moveFirst();
                if (rcbValuePool.isEmpty())
                    synchronizer.moveNext();
                    continue;
                end;

                while (rcbValuePool.moveNext())
                    var node = currentNormalize.addNode(rcbValuePool.getCurrentItem().name);
                    node.setExact(rcbValuePool.getCurrentItem.value.exact);
                    node.recalculateScaled();
                    relation.lhs.plus(node);
                end;

                //добавить отношение справа
                poolOfConstantValues.moveFirst();
                while (poolOfConstantValues.moveNext())
                    relation.rhs.plus(Double(poolOfConstantValues.getCurrentItem()));
                end;

                currentNormalize.addRelation(relation);

                if (not m_isFillNormalizePool)
                    m_normalizerPool.moveNext();
                end;
            end;

            synchronizer.moveNext();
        end;

        if (isAddNormalizer)
            m_rcbValuesPool.push_back(rcbValuePool);
        end;
    end;

    initTForNormalizer(multiplier);
end;

class (ReportNormalizer) TForReportNormalizer(protocolView)

    private var m_report : Object  = RcbApplication().currentReport;
    private var m_protocolView;

    macro getAttributeValueIterator(attributName : String, filter : Object, sorter : Object)
        var attributeValue = m_report.attributeValue(attributName);
        var iterator = attributeValue.createValueIterator();
        if (filter != NULL)
            iterator.setFilter(filter);
        end;
        if (sorter != NULL)
            iterator.setSortOrder(sorter);
        end;
        iterator.moveFirst();
        return iterator;
    end;

    macro getNodeName(appNumber, lineNumber)
        return "Приложение" + appNumber + "Строка" + lineNumber;
    end;

    macro addRuleRow_5()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_5 = normalizer.addNode(getNodeName("1", "5"));
        var node_51 = normalizer.addNode(getNodeName("1", "5.1"));
        var node_52 = normalizer.addNode(getNodeName("1", "5.2"));
        var node_53 = normalizer.addNode(getNodeName("1", "5.3"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "5");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "5.1", "5.2", "5.3");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_5.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_5.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "5.1")
                        node_51.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_51.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "5.2")
                        node_52.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_52.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "5.3")
                        node_53.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_53.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_5);
                relation.rhs.plus(node_51);
                relation.rhs.plus(node_52);
                relation.rhs.plus(node_53);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_42()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_42 = normalizer.addNode(getNodeName("1", "4.2"));
        var node_210 = normalizer.addNode(getNodeName("1", "2.10"));
        var node_32 = normalizer.addNode(getNodeName("1", "3.2"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "4.2");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.10", "3.2");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_42.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_42.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "2.10")
                        node_210.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_210.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "3.2")
                        node_32.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_32.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_42);
                relation.rhs.plus(node_210);
                relation.rhs.minus(node_32);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_41()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_41 = normalizer.addNode(getNodeName("1", "4.1"));
        var node_26 = normalizer.addNode(getNodeName("1", "2.6"));
        var node_31 = normalizer.addNode(getNodeName("1", "3.1"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "4.1");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.6", "3.1");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_41.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_41.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "2.6")
                        node_26.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_26.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "3.1")
                        node_31.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_31.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_41);
                relation.rhs.plus(node_26);
                relation.rhs.minus(node_31);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_4()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_4 = normalizer.addNode(getNodeName("1", "4"));
        var node_41 = normalizer.node(getNodeName("1", "4.1"));
        var node_42 = normalizer.node(getNodeName("1", "4.2"));
        var lhsIterator;

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "4");

        if (lhsIterator != null)
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_4.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_4.recalculateScaled();

                relation.lhs.plus(node_4);
                relation.rhs.plus(node_41);
                relation.rhs.plus(node_42);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_32()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_32 = normalizer.node(getNodeName("1", "3.2"));
        var node_210 = normalizer.node(getNodeName("1", "2.10"));

        relation.lhs.plus(node_32);
        relation.rhs.plus(node_210);
        relation.rhs.multiply(global.parameters.getReservation().getAveragingCoefficient());

        this.addRelation(relation);
    end;

    macro addRuleRow_31()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_31 = normalizer.node(getNodeName("1", "3.1"));
        var node_26 = normalizer.node(getNodeName("1", "2.6"));

        relation.lhs.plus(node_31);
        relation.rhs.plus(node_26);
        relation.rhs.multiply(global.parameters.getReservation().getAveragingCoefficient());

        this.addRelation(relation);
    end;

    macro addRuleRow_3()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_3 = normalizer.addNode(getNodeName("1", "3"));
        var node_31 = normalizer.node(getNodeName("1", "3.1"));
        var node_32 = normalizer.node(getNodeName("1", "3.2"));
        var lhsIterator;

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3");

        if (lhsIterator != null)
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_3.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_3.recalculateScaled();

                relation.lhs.plus(node_3);
                relation.rhs.plus(node_31);
                relation.rhs.plus(node_32);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_210()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var rhsIterator;
        var node_210 = normalizer.node(getNodeName("1", "2.10"));
        var node_27 = normalizer.addNode(getNodeName("1", "2.7"));
        var node_28 = normalizer.addNode(getNodeName("1", "2.8"));
        var node_29 = normalizer.addNode(getNodeName("1", "2.9"));

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "5.1", "5.2", "5.3");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "2.7")
                    node_27.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_27.recalculateScaled();
                elif (rhsIterator.currentItem().fieldValue("row").exact == "2.8")
                    node_28.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_28.recalculateScaled();
                elif (rhsIterator.currentItem().fieldValue("row").exact == "2.9")
                    node_29.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_29.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_210);
            relation.rhs.plus(node_27);
            relation.rhs.plus(node_28);
            relation.rhs.plus(node_29);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_29()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_29 = normalizer.node(getNodeName("1", "2.9"));
        var node_16 = normalizer.addNode(getNodeName("1", "1.6"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.6");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "1.6")
                    node_16.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_16.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_29);
            relation.rhs.plus(node_16);
            relation.rhs.multiply(global.parameters.getReservation().getOthersCurrency());

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_28()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_28 = normalizer.node(getNodeName("1", "2.8"));
        var node_15 = normalizer.addNode(getNodeName("1", "1.5"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.5");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "1.5")
                    node_15.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_15.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_28);
            relation.rhs.plus(node_15);
            relation.rhs.multiply(global.parameters.getReservation().getNaturalPersonCurrency());

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_27()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_27 = normalizer.node(getNodeName("1", "2.7"));
        var node_14 = normalizer.addNode(getNodeName("1", "1.4"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.4");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "1.4")
                    node_14.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_14.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_27);
            relation.rhs.plus(node_14);
            relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonCurrency());

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_26()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_26 = normalizer.node(getNodeName("1", "2.6"));
        var node_24 = normalizer.addNode(getNodeName("1", "2.4"));
        var node_25 = normalizer.addNode(getNodeName("1", "2.5"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.4", "2.5");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "2.4")
                    node_24.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_24.recalculateScaled();
                elif (rhsIterator.currentItem().fieldValue("row").exact == "2.5")
                    node_25.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                    node_25.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_26);
            relation.rhs.plus(node_24);
            relation.rhs.minus(node_25);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_25()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_25 = normalizer.node(getNodeName("1", "2.5"));
        var node5_5 = normalizer.addNode(getNodeName("1", "2.4"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение5", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "5");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "5")
                    node5_5.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node5_5.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_25);
            relation.rhs.plus(node5_5);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_24()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_24 = normalizer.addNode(getNodeName("1", "2.4"));
        var node_21 = normalizer.addNode(getNodeName("1", "2.1"));
        var node_22 = normalizer.addNode(getNodeName("1", "2.2"));
        var node_23 = normalizer.addNode(getNodeName("1", "2.3"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.4");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.1", "2.2", "2.3");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_24.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_24.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "2.1")
                        node_21.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_21.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "2.2")
                        node_22.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_22.recalculateScaled();
                    elif (rhsIterator.currentItem().fieldValue("row").exact == "2.3")
                        node_23.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_23.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_24);
                relation.rhs.plus(node_21);
                relation.rhs.plus(node_22);
                relation.rhs.plus(node_23);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_23()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_23 = normalizer.addNode(getNodeName("1", "2.3"));
        var node_13 = normalizer.addNode(getNodeName("1", "1.3"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.3");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.3");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_23.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_23.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "1.3")
                        node_13.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_13.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_23);
                relation.rhs.plus(node_13);
                relation.rhs.multiply(global.parameters.getReservation().getOthersRouble());

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_22()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_22 = normalizer.addNode(getNodeName("1", "2.2"));
        var node_12 = normalizer.addNode(getNodeName("1", "1.2"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.2");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_22.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_22.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "1.2")
                        node_12.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_12.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_22);
                relation.rhs.plus(node_12);
                relation.rhs.multiply(global.parameters.getReservation().getNaturalPersonRouble());

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_21()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var lhsIterator, rhsIterator;
        var node_21 = normalizer.addNode(getNodeName("1", "2.1"));
        var node_11 = normalizer.addNode(getNodeName("1", "1.1"));

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.1");

        rhsIterator = getAttributeValueIterator("Приложение1", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");

        if ((lhsIterator != null) and (rhsIterator != null))
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_21.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_21.recalculateScaled();

                rhsIterator.moveFirst();
                while (not rhsIterator.isDone())
                    if (rhsIterator.currentItem().fieldValue("row").exact == "1.1")
                        node_11.setExact(rhsIterator.currentItem().fieldValue("sum").exact);
                        node_11.recalculateScaled();
                    end;

                    rhsIterator.moveNext();
                end;

                relation.lhs.plus(node_21);
                relation.rhs.plus(node_11);
                relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonRouble());

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_2()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_2 = normalizer.addNode(getNodeName("1", "2"));
        var node_26 = normalizer.node(getNodeName("1", "2.6"));
        var node_210 = normalizer.node(getNodeName("1", "2.10"));
        var lhsIterator;

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2");

        if (lhsIterator != null)
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_2.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_2.recalculateScaled();

                relation.lhs.plus(node_2);
                relation.rhs.plus(node_26);
                relation.rhs.plus(node_210);

                this.addRelation(relation);
            end;
        end;
    end;

    macro addRuleRow_16()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var rhsIterator;
        var node_16 = normalizer.node(getNodeName("1", "1.6"));
        var node2_36 = normalizer.addNode(getNodeName("2", "3.6"));

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "3.6");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "3.6")
                    node2_36.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_36.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_16);
            relation.rhs.plus(node2_36);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_15()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_15 = normalizer.node(getNodeName("1", "1.5"));
        var node2_23 = normalizer.addNode(getNodeName("2", "2.3"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.3");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "2.3")
                    node2_23.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_23.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_15);
            relation.rhs.plus(node2_23);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_14()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_14 = normalizer.node(getNodeName("1", "1.4"));
        var node2_15 = normalizer.addNode(getNodeName("2", "1.5"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.5");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "1.5")
                    node2_15.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_15.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_14);
            relation.rhs.plus(node2_15);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_13()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_13 = normalizer.node(getNodeName("1", "1.3"));
        var node2_35 = normalizer.addNode(getNodeName("2", "3.5"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.5");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "3.5")
                    node2_35.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_35.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_13);
            relation.rhs.plus(node2_35);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_12()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_12 = normalizer.node(getNodeName("1", "1.2"));
        var node2_22 = normalizer.addNode(getNodeName("2", "2.2"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "2.2");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "2.2")
                    node2_22.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_22.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_12);
            relation.rhs.plus(node2_22);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_11()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_11 = normalizer.node(getNodeName("1", "1.1"));
        var node2_14 = normalizer.addNode(getNodeName("2", "1.4"));
        var rhsIterator;

        rhsIterator = getAttributeValueIterator("Приложение2", NULL);
        rhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.4");

        if (rhsIterator != null)

            rhsIterator.moveFirst();
            while (not rhsIterator.isDone())
                if (rhsIterator.currentItem().fieldValue("row").exact == "1.4")
                    node2_14.setExact(rhsIterator.currentItem().fieldValue("roubleRest").exact);
                    node2_14.recalculateScaled();
                end;

                rhsIterator.moveNext();
            end;

            relation.lhs.plus(node_11);
            relation.rhs.plus(node2_14);

            this.addRelation(relation);
        end;
    end;

    macro addRuleRow_1()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var node_1 = normalizer.addNode(getNodeName("1", "1"));
        var node_11 = normalizer.node(getNodeName("1", "1.1"));
        var node_12 = normalizer.node(getNodeName("1", "1.2"));
        var node_13 = normalizer.node(getNodeName("1", "1.3"));
        var node_14 = normalizer.node(getNodeName("1", "1.4"));
        var node_15 = normalizer.node(getNodeName("1", "1.5"));
        var node_16 = normalizer.node(getNodeName("1", "1.6"));
        var lhsIterator;

        lhsIterator = getAttributeValueIterator("Приложение1", NULL);
        lhsIterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1");

        if (lhsIterator != null)
            lhsIterator.moveFirst();
            if (not lhsIterator.isDone())
                node_1.setExact(lhsIterator.currentItem().fieldValue("sum").exact);
                node_1.recalculateScaled();

                relation.lhs.plus(node_1);
                relation.rhs.plus(node_11);
                relation.rhs.plus(node_12);
                relation.rhs.plus(node_13);
                relation.rhs.plus(node_14);
                relation.rhs.plus(node_15);
                relation.rhs.plus(node_16);

                this.addRelation(relation);
            end;
        end;
    end;

    private macro saveAttributeValueApplication_1(row, sum : Money, scaledSum : Double)
        var attributeValue = m_report.attributeValue("Приложение1");
        var keyValue = attributeValue.createKeyValue();

        keyValue.fieldValue("row") = row;

        var compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue != null)
            compositeValue.fieldValue("row").exact = row;
            if (sum == null)
                compositeValue.fieldValue("sum").setUndefined();
            else
                compositeValue.fieldValue("sum").exact = sum;
                if (scaledSum == null)
                    compositeValue.fieldValue("sum").recalculateScaled();
                else
                    compositeValue.fieldValue("sum").scaled = scaledSum;
                end;
            end;
        end;
    end;

    private macro saveAttributeValueApplication_25(applicationNumber, row, balanceGroup : String, balance : String, date_: Date, roubleRest : Money, currencyRest : Money, roubleScaledRest : Double, currencyScaledRest : Double)
        var attributeValue = m_report.attributeValue("Приложение" + applicationNumber);
        var keyValue = attributeValue.createKeyValue();

        keyValue.fieldValue("row") = row;
        keyValue.fieldValue("balanceGroup") = balanceGroup;
        keyValue.fieldValue("balance") = balance;
        keyValue.fieldValue("date") = date_;

        var compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue != null)
            compositeValue.fieldValue("row").exact = row;
            compositeValue.fieldValue("balanceGroup").exact = balanceGroup;
            compositeValue.fieldValue("balance").exact = balance;
            compositeValue.fieldValue("date").exact = String(date_);

            if (roubleRest == null)
                compositeValue.fieldValue("roubleRest").setUndefined();
            else
                compositeValue.fieldValue("roubleRest").exact   = roubleRest;
                if (roubleScaledRest == null)
                    compositeValue.fieldValue("roubleRest").recalculateScaled();
                else
                    compositeValue.fieldValue("roubleRest").scaled   = roubleScaledRest;
                end;
            end;
            compositeValue.fieldValue("roubleRest").exact   = roubleRest;
            compositeValue.fieldValue("currencyRest").exact = currencyRest;
            compositeValue.fieldValue("currencyRest").scaled = currencyScaledRest;
        end;
    end;

    macro saveAttributeValue(app, row)
        var node = normalizer.node(getNodeName(app, row));
        var attributeValue = m_report.attributeValue("Приложение" + app);
        var valueIterator = getAttributeValueIterator("Приложение" + app, NULL);

        valueIterator.setFilter(FILTER_FOR_APPLICATION_ROW, row);
        valueIterator.moveFirst();
        if (not valueIterator.isDone())

            if ((valueIterator.currentItem().fieldValue("sum").exact != null) and
                (valueIterator.currentItem().fieldValue("sum").scaled != floor(Double(valueIterator.currentItem().fieldValue("sum").exact) / rcbApplication.currentReport.multiplier + 0.5)))
                if (node != null)
                    if (app == "1")
                        saveAttributeValueApplication_1(valueIterator.currentItem().fieldValue("row").exact, node.getExact(), node.getScaled());
                        m_protocolView.printString(row, valueIterator.currentItem().fieldValue("sum").exact, valueIterator.currentItem().fieldValue("sum").scaled);
                    elif ((app == "2") or (app == "5"))
                        saveAttributeValueApplication_25(app,
                                                         row,
                                                         valueIterator.currentItem().fieldValue("balanceGroup").exact,
                                                         valueIterator.currentItem().fieldValue("balance").exact,
                                                         valueIterator.currentItem().fieldValue("date").exact,
                                                         node.getExact(),
                                                         valueIterator.currentItem().fieldValue("currencyRest").exact,
                                                         node.getScaled(),
                                                         valueIterator.currentItem().fieldValue("currencyRest").scaled
                                                        );
                        m_protocolView.printString(row, valueIterator.currentItem().fieldValue("roubleRest").exact, valueIterator.currentItem().fieldValue("roubleRest").scaled);
                    end;
                end;
            end;
        end;
    end;

    macro addRules()
        addRuleRow_5();
        addRuleRow_42();
        addRuleRow_41();
        addRuleRow_4();
        addRuleRow_32();
        addRuleRow_31();
        addRuleRow_3();
        addRuleRow_210();
        addRuleRow_29();
        addRuleRow_28();
        addRuleRow_27();
        addRuleRow_26();
        addRuleRow_25();
        addRuleRow_24();
        addRuleRow_23();
        addRuleRow_22();
        addRuleRow_21();
        addRuleRow_2();
        addRuleRow_16();
        addRuleRow_15();
        addRuleRow_14();
        addRuleRow_13();
        addRuleRow_12();
        addRuleRow_11();
        addRuleRow_1();
    end;

    macro saveLine()
        saveAttributeValue("1", "1");
        saveAttributeValue("1", "1.1");
        saveAttributeValue("1", "1.2");
        saveAttributeValue("1", "1.3");
        saveAttributeValue("1", "1.4");
        saveAttributeValue("1", "1.5");
        saveAttributeValue("1", "1.6");
        saveAttributeValue("1", "2");
        saveAttributeValue("1", "2.1");
        saveAttributeValue("1", "2.2");
        saveAttributeValue("1", "2.3");
        saveAttributeValue("1", "2.4");
        saveAttributeValue("1", "2.5");
        saveAttributeValue("1", "2.6");
        saveAttributeValue("1", "2.7");
        saveAttributeValue("1", "2.8");
        saveAttributeValue("1", "2.9");
        saveAttributeValue("1", "2.10");
        saveAttributeValue("1", "3");
        saveAttributeValue("1", "3.1");
        saveAttributeValue("1", "3.2");
        saveAttributeValue("1", "4");
        saveAttributeValue("1", "4.1");
        saveAttributeValue("1", "4.2");
        saveAttributeValue("1", "5");
        saveAttributeValue("1", "5.1");
        saveAttributeValue("1", "5.2");
        saveAttributeValue("1", "5.3");
        saveAttributeValue("2", "1.4");
        saveAttributeValue("2", "1.5");
        saveAttributeValue("2", "2.2");
        saveAttributeValue("2", "2.3");
        saveAttributeValue("2", "3.5");
        saveAttributeValue("2", "3.6");
        saveAttributeValue("5", "5");
    end;

     macro execute()
        RcbApplication().TransactionManager().commit();
        addRules();
        normalize();
        saveLine();
        RcbApplication().TransactionManager().commit();
    end;

    macro contructorTForReportNormalizer(protocolView)
        initReportNormalizer(rcbApplication.currentReport.multiplier);
        m_protocolView = protocolView;
    end;

    contructorTForReportNormalizer(protocolView);
end;

private class (ReportNormalizer) TApplication1NormalizerBase(protocolView)
    private var m_protocolView;
    private var m_attributeNamesList : RcbArray;

    private macro getNodeName(appNumber, lineNumber)
        return global.toAnsiNorm("Приложение" + appNumber + "Строка" + lineNumber, true);
    end;

    private macro addNode(application : String, row : String, def : Double)
        const name = getNodeName(application, row);

        def = nvl(def, 1.0);

        var normalizerNode = node(name);
        if (normalizerNode == null)
            var value = null;
            var iterator = RcbApplication().currentReport.attributeValue("Приложение" + application).createValueIterator();
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, row);
            iterator.moveFirst();
            if (not iterator.isDone())
                value = iterator.currentItem().fieldValue(ternary(application == "1", "sum", "roubleRest"));
            else
                value = TValue();
            end;
            normalizerNode = addNode(name);
            normalizerNode.setExact(value.exact);
            normalizerNode.recalculateScaled();
            normalizerNode.setDef(def);

            m_attributeNamesList.push_back(RcbArray().initialize(application, row));
        end;

        return normalizerNode;
    end;

    private macro getAttributeValue(application : String, row : String)
        var value;
        var iterator = RcbApplication().currentReport.attributeValue("Приложение" + application).createValueIterator();
        iterator.setFilter(FILTER_FOR_APPLICATION_ROW, row);
        iterator.moveFirst();
        if (not iterator.isDone())
            value = iterator.currentItem().fieldValue(ternary(application == "1", "sum", "roubleRest"));
        else
            value = TValue();
        end;
        return value.scaled;
    end;

    private macro saveAttributeValueApplication_1(row : String, sum : Money, scaledSum : Double)
        var attributeValue = RcbApplication().currentReport.attributeValue("Приложение1");
        var keyValue = attributeValue.createKeyValue();

        keyValue.fieldValue("row") = row;

        var compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue != null)
            compositeValue.fieldValue("row").exact = row;
            if (sum == null)
                compositeValue.fieldValue("sum").setUndefined();
            else
                compositeValue.fieldValue("sum").exact = sum;
                if (scaledSum == null)
                    compositeValue.fieldValue("sum").recalculateScaled();
                else
                    compositeValue.fieldValue("sum").scaled = scaledSum;
                end;
            end;
        end;
    end;

    private macro saveAttributeValueApplication_25(applicationNumber, row, balanceGroup : String, balance : String, date_: Date, roubleRest : Money, currencyRest : Money, roubleScaledRest : Double, currencyScaledRest : Double)
        var attributeValue = RcbApplication().currentReport.attributeValue("Приложение" + applicationNumber);
        var keyValue = attributeValue.createKeyValue();

        keyValue.fieldValue("row") = row;
        keyValue.fieldValue("balanceGroup") = balanceGroup;
        keyValue.fieldValue("balance") = balance;
        keyValue.fieldValue("date") = date_;

        var compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue != null)
            compositeValue.fieldValue("row").exact = row;
            compositeValue.fieldValue("balanceGroup").exact = balanceGroup;
            compositeValue.fieldValue("balance").exact = balance;
            compositeValue.fieldValue("date").exact = String(date_);

            if (roubleRest == null)
                compositeValue.fieldValue("roubleRest").setUndefined();
            else
                compositeValue.fieldValue("roubleRest").exact   = roubleRest;
                if (roubleScaledRest == null)
                    compositeValue.fieldValue("roubleRest").recalculateScaled();
                else
                    compositeValue.fieldValue("roubleRest").scaled   = roubleScaledRest;
                end;
            end;
            compositeValue.fieldValue("roubleRest").exact   = roubleRest;
            compositeValue.fieldValue("currencyRest").exact = currencyRest;
            compositeValue.fieldValue("currencyRest").scaled = currencyScaledRest;
        end;
    end;

    private macro saveAttributeValue(app, row)
        var node = normalizer.node(getNodeName(app, row));
        var attributeValue = RcbApplication().currentReport.attributeValue("Приложение" + app);
        var valueIterator = TApplicationRow("Приложение" + app).getAttributeValueIterator("Приложение" + app, NULL);

        valueIterator.setFilter(FILTER_FOR_APPLICATION_ROW, row);
        valueIterator.moveFirst();
        if (not valueIterator.isDone())

            if ((valueIterator.currentItem().fieldValue("sum").exact != null) and
                (valueIterator.currentItem().fieldValue("sum").scaled != floor(Double(valueIterator.currentItem().fieldValue("sum").exact) / rcbApplication.currentReport.multiplier + 0.5)))
                if (node != null)
                    if (app == "1")
                        saveAttributeValueApplication_1(valueIterator.currentItem().fieldValue("row").exact, node.getExact(), node.getScaled());
                        m_protocolView.printString(row, valueIterator.currentItem().fieldValue("sum").exact, valueIterator.currentItem().fieldValue("sum").scaled);
                    elif ((app == "2") or (app == "5"))
                        saveAttributeValueApplication_25(app,
                                                         row,
                                                         valueIterator.currentItem().fieldValue("balanceGroup").exact,
                                                         valueIterator.currentItem().fieldValue("balance").exact,
                                                         valueIterator.currentItem().fieldValue("date").exact,
                                                         node.getExact(),
                                                         valueIterator.currentItem().fieldValue("currencyRest").exact,
                                                         node.getScaled(),
                                                         valueIterator.currentItem().fieldValue("currencyRest").scaled
                                                        );
                        m_protocolView.printString(row, valueIterator.currentItem().fieldValue("roubleRest").exact, valueIterator.currentItem().fieldValue("roubleRest").scaled);
                    end;
                end;
            end;
        end;
    end;

    private macro addRules();
    end;

    private macro save()
        m_attributeNamesList.moveFirst();
        while (m_attributeNamesList.moveNext())
            saveAttributeValue(m_attributeNamesList.getCurrentItem().value(0), m_attributeNamesList.getCurrentItem().value(1));
        end;
    end;

    macro normalize()
        m_attributeNamesList.clear();
        RcbApplication().transactionManager.commit();
        addRules();
        normalize();
        save();
        RcbApplication().transactionManager.commit();
    end;

    private macro constructorTApplication1NormalizerBase(protocolView)
        initReportNormalizer(RcbApplication().currentReport.multiplier);
        m_protocolView = protocolView;
        m_attributeNamesList = RcbArray();
    end;

    constructorTApplication1NormalizerBase(protocolView);
end;

// Нормализаторы по 4217-У
/**
 * Нормализатор Приложения 2 по 4217-У. Наследование запрещено
 * Нормализация б/с 40901, 40902 и расшифровки 409011 с ф.101 в рамках одной задачи
 */
class TApplication2Normalizer_4217(multiplier)
    private var m_multiplier;
    private var m_normalizerPool:      RcbArray;
    private var m_isFillNormalizePool: bool;
    private var m_rcbValuesPool:       RcbArray;

    /**
     * Добавить отношение
     */
    private macro addRelationImpl(decodingNamePool : RcbArray, balancePool: RcbArray, isRouble : Bool, sign : Integer)
        class TNormalizerValueData(_name : String, _value : Object)
            var name = _name;
            var value = _value;
        end;

        var iteratorPool = RcbArray();
        var applicationNamePool = RcbArray();

        var synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_FULL_OUTER_JOIN, SORTER_FOR_DATE);

        var iterator;

        var decodingName;
        var applicationName;
        var row;

        decodingNamePool.moveFirst();

        if (global.parameters.getAppl2NormalizationAlgorithm() == 0)
            return;
        elif (global.parameters.getAppl2NormalizationAlgorithm() == 1)
            while (decodingNamePool.moveNext())
                applicationName = decodingNamePool.getCurrentItem().applicationName;
                row = decodingNamePool.getCurrentItem().row;
                decodingName = decodingNamePool.getCurrentItem().name;
                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT1, global.parameters.getEndDate(), 1, decodingName, row);
                iterator.moveFirst();
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        elif (global.parameters.getAppl2NormalizationAlgorithm() == 2)
            while (decodingNamePool.moveNext())
                applicationName = decodingNamePool.getCurrentItem().applicationName;
                row = decodingNamePool.getCurrentItem().row;
                decodingName = decodingNamePool.getCurrentItem().name;
                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                iterator.setFilter(FILTER_FOR_NORMALIZER1, decodingName, row);
                iterator.moveFirst();
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        else
            return;
        end;

        if (m_normalizerPool.isEmpty())
            m_isFillNormalizePool = true;
        else
            m_normalizerPool.moveFirst();
            m_normalizerPool.moveNext();
        end;

        synchronizer.moveFirst();
        while (not synchronizer.isDone())
            iteratorPool.moveFirst();

            var dateValue : Date;
            var balanceNumber;

            var rcbValuePool = RcbArray();
            var isFirstIterator = true;
            var hasBalanceData = false;
            var relation;

            //формирование левой части отношения
            while (iteratorPool.moveNext())
                if (synchronizer.isNull(iteratorPool.getCurrentItem()))
                    continue;
                end;

                var compositeValue = iteratorPool.getCurrentItem().currentItem;

                if (isFirstIterator)
                    dateValue = Date(trim(compositeValue.fieldValue("date").exactAsString));
                    balanceNumber = substr(compositeValue.fieldValue("balance").exactAsString, 1, 5);
                    isFirstIterator = false;
                end;

                var value = compositeValue.fieldValue(ternary(isRouble, "roubleRest", "currencyRest"));
                if (value.exact != $0)
                    var id = global.toAnsiNorm(        applicationNamePool.value(iteratorPool.getCurrentIndex())
                                               + "_" + compositeValue.fieldValue("row").exactAsString
                                               + "_" + ternary(isRouble, "Ру", "Ва")
                                               + "_" + compositeValue.fieldValue("balance").exactAsString
                                               + "_" + string(dateValue : f),
                                               true
                                              );
                    rcbValuePool.push_back(TNormalizerValueData(id, value));
                    hasBalanceData = true;
                end;
            end;

            //формирование правой части отношения - балансовые счета
            var balancevalues;
            var balanceValue;
            var poolOfConstantValues : RcbArray = RcbArray();
            if (hasBalanceData)
                balancePool.moveFirst();
                while (balancePool.moveNext())
                    balancevalues  = global.balanceData.getValues(balancePool.getCurrentItem(), dateValue);
                    if (isRouble)
                        balanceValue = balancevalues.getRoubleScaledRest();
                    else
                        balanceValue = balancevalues.getCurrencyScaledRest();
                    end;
                    poolOfConstantValues.push_back(balanceValue);
                end;
            end;

            //добавить нормализатор в пул
            var currentNormalize;
            if (m_isFillNormalizePool)
                m_normalizerPool.push_back(ReportNormalizer(m_multiplier));
                currentNormalize = m_normalizerPool(m_normalizerPool.getCount() - 1);
            else
                currentNormalize = m_normalizerPool.getCurrentItem();
            end;

            relation = ReportLinearRelation(sign);

            //добавить отношение слева
            rcbValuePool.moveFirst();
            if (rcbValuePool.isEmpty())
                synchronizer.moveNext();
                continue;
            end;

            while (rcbValuePool.moveNext())
                var node = currentNormalize.addNode(rcbValuePool.getCurrentItem().name);
                node.setExact(rcbValuePool.getCurrentItem.value.exact);
                node.recalculateScaled();
                relation.lhs.plus(node);
            end;

            //добавить отношение справа
            poolOfConstantValues.moveFirst();
            while (poolOfConstantValues.moveNext())
                relation.rhs.plus(Double(poolOfConstantValues.getCurrentItem()));
            end;

            currentNormalize.addRelation(relation);

            if (not m_isFillNormalizePool)
                m_normalizerPool.moveNext();
            end;

            m_rcbValuesPool.push_back(rcbValuePool);

            synchronizer.moveNext();
        end;
    end;

    macro addRelation(p1 : Variant, p2 : Variant, p3 : Variant, sign : Integer)
        if (valType(p1) == V_STRING)
            var data = RcbArray();
            for (var attributeName, strcut(p1, "+="))
                var attributeParts = strcut(attributeName, "_|");
                var decodingData = TDecodingData("Приложение"+trim(attributeParts[0]), trim(attributeParts[1]), trim(attributeParts[2]));
                data.push_back(decodingData);
            end;

            var lastToken = data.pop_back();
            if (index(lastToken.applicationName, "E") != 0)
                sign = RCB_RS_EQUAL;
            elif (index(lastToken.applicationName, "L") != 0)
                sign = RCB_RS_LESS_OR_EQUAL;
            else
                sign = RCB_RS_EQUAL;
            end;

            var balancePool = RcbArray();
            var token = data.pop_back();
            while (token.applicationName == "ПриложениеB")
                balancePool.push_back(token.row);
                token = data.pop_back();
            end;
            data.push_back(token);

            if (index(lastToken.applicationName, "R") != 0)
                addRelationImpl(data, balancePool, NATIONAL_CURRENCY, sign);
            end;
            if (index(lastToken.applicationName, "V") != 0)
                addRelationImpl(data, balancePool, FOREIGN_CURRENCY, sign);
            end;
        elif (valType(p3) == V_BOOL)
            addRelationImpl(p1, p2, p3, sign);
        else
            sign = p3;
            addRelationImpl(p1, p2, NATIONAL_CURRENCY, sign);
            addRelationImpl(p1, p2, FOREIGN_CURRENCY,  sign);
        end;
    end;

    /**
     * Нормализация
     */
    macro normalize()
        var rcbValuePool;
        var currentItem;

        m_normalizerPool.moveFirst();
        while (m_normalizerPool.moveNext())
            if (valType(m_normalizerPool.getCurrentItem()) != V_UNDEF)
                m_normalizerPool.getCurrentItem().normalize();
                m_rcbValuesPool.moveFirst();
                if (m_normalizerPool.getCurrentItem().isNormalized())
                    while (m_rcbValuesPool.moveNext())
                        if (valType(m_rcbValuesPool.getCurrentItem()) != V_UNDEF)
                            rcbValuePool = m_rcbValuesPool.getCurrentItem();
                            rcbValuePool.moveFirst();
                            while(rcbValuePool.moveNext())
                                currentItem = rcbValuePool.getCurrentItem();
                                if (valType(m_normalizerPool.getCurrentItem().node(currentItem.name)) != V_UNDEF)
                                    currentItem.value.scaled = m_normalizerPool.getCurrentItem().node(currentItem.name).scaled;
                                    normalizationProtocol.printString(currentItem.name, currentItem.value.exact, currentItem.value.scaled, m_normalizerPool.getCurrentItem().getLogFilePath());
                                end;
                            end;
                        end;
                    end;
                else
                    m_rcbValuesPool.moveFirst();
                    while (m_rcbValuesPool.moveNext())
                        rcbValuePool = m_rcbValuesPool.getCurrentItem();
                        while (rcbValuePool.moveNext())
                            normalizationProtocolWithErrors.printError(rcbValuePool.getCurrentItem().name);
                            normalizationProtocolWithErrors.printNameLog(m_normalizerPool.getCurrentItem().getLogFilePath());
                        end;
                    end;
                end;
            end;
        end;
    end;

    private macro ctor(multiplier)
        m_multiplier          = multiplier;
        m_isFillNormalizePool = false;
    end;

    ctor(multiplier);
end;

/**
 * Нормализатор для приложений 2-6 по 4217-У. Наследование запрещено
 * Нормализация расшифровок с предусловиями
 */
class TForConditionalNormalizer_4217(multiplier : Integer, applicationName : String)
    private var m_multiplier : Integer;
    private var m_normalizerPool : RcbArray;
    private var m_isFillNormalizePool : Bool;
    private var m_rcbValuesPool : RcbArray;
    private var m_applicationName : String;

    private macro getAttributeValue(number : String, dateValue : Date, isRouble : Bool) : Money
        var value : Money = $0.0;
        var signMultiplier : Double;

        var sign = substr(number, 1, 1);
        number = substr(number, 2);
        if (sign == "-")
            signMultiplier = -1.0;
        elif (sign == "+")
            signMultiplier = 1.0;
        else
            // выкинуть исключение, прекратить работу
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        var values;
        var lexemeList = strcut(number, "_|");
        if (lexemeList.value(0) == "B")
            values = global.balanceData.getValues(lexemeList.value(1), dateValue);
            if (isRouble)
                value = values.getRoubleScaledRest();
            else
                value = values.getCurrencyScaledRest();
            end;
        elif (lexemeList.value(0) == "C")
            value = Money(lexemeList.value(1));
        else
            var applicationName = "Приложение" + lexemeList.value(0);
            var row = lexemeList.value(1);
            var decodingName = lexemeList.value(2);
            var iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
            iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT1, dateValue, 1, decodingName, row);
            iterator.moveFirst();
            if (not iterator.isDone())
                if (isRouble)
                    value = iterator.currentItem.fieldValue("roubleRest").current;
                else
                    value = iterator.currentItem.fieldValue("currencyRest").current;
                end;
            else
                value = $0.0;
            end;
        end;

        value = value * signMultiplier;

        return value;
    end;

    private macro addRelationImpl(lhsCondition : RcbArray, rhsCondition : RcbArray, conditionSign : Integer,
                                  decodingNamePool : RcbArray, balancePool: RcbArray, isRouble : Bool, sign : Integer)
        class TNormalizerValueData(_name : String, _value : Object)
            var name = _name;
            var value = _value;
        end;

        var iteratorPool = RcbArray();
        var applicationNamePool = RcbArray();

        var synchronizer = RcbValueIteratorSynchronizer(RCB_ISK_FULL_OUTER_JOIN, SORTER_FOR_DATE);

        var iterator;

        var decodingName;
        var applicationName;
        var row;

        decodingNamePool.moveFirst();

        if (   (m_applicationName == null)
            or (m_applicationName == "Приложение2")
            or (m_applicationName == "Приложение6")
           )
            if (global.parameters.getAppl2NormalizationAlgorithm() == 0)
                return;
            elif (global.parameters.getAppl2NormalizationAlgorithm() == 1)
                while (decodingNamePool.moveNext())
                    applicationName = decodingNamePool.getCurrentItem().applicationName;
                    row = decodingNamePool.getCurrentItem().row;
                    decodingName = decodingNamePool.getCurrentItem().name;
                    iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                    iterator.setFilter(FILTER_FOR_APPLICATION_2_ROW_3_2_PRINT1, global.parameters.getEndDate(), 1, decodingName, row);
                    iterator.moveFirst();
                    iteratorPool.push_back(iterator);
                    applicationNamePool.push_back(applicationName);
                    synchronizer.addIterator(iterator);
                end;
            elif (global.parameters.getAppl2NormalizationAlgorithm() == 2)
                while (decodingNamePool.moveNext())
                    applicationName = decodingNamePool.getCurrentItem().applicationName;
                    row = decodingNamePool.getCurrentItem().row;
                    decodingName = decodingNamePool.getCurrentItem().name;
                    iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                    iterator.setFilter(FILTER_FOR_NORMALIZER1, decodingName, row);
                    iterator.moveFirst();
                    iteratorPool.push_back(iterator);
                    applicationNamePool.push_back(applicationName);
                    synchronizer.addIterator(iterator);
                end;
            else
                return;
            end;
        else
            while (decodingNamePool.moveNext())
                applicationName = decodingNamePool.getCurrentItem().applicationName;
                row = decodingNamePool.getCurrentItem().row;
                decodingName = decodingNamePool.getCurrentItem().name;
                iterator = TApplicationRow(applicationName).getAttributeValueIterator(applicationName, null);
                iterator.setFilter(FILTER_FOR_NORMALIZER1, decodingName, row);
                iterator.moveFirst();
                iteratorPool.push_back(iterator);
                applicationNamePool.push_back(applicationName);
                synchronizer.addIterator(iterator);
            end;
        end;

        synchronizer.moveFirst();
        while (not synchronizer.isDone())
            iteratorPool.moveFirst();

            var dateValue : Date;
            var rcbValuePool = RcbArray();
            var relation;

            //формирование левой части отношения
            while (iteratorPool.moveNext())
                if (synchronizer.isNull(iteratorPool.getCurrentItem()))
                    continue;
                end;

                var compositeValue = iteratorPool.getCurrentItem().currentItem;
                var isAddNormalizer = false;
                var isConditionSatisfied = false;
                var lhsValue = 0;
                var rhsValue = 0;

                dateValue = Date(trim(compositeValue.fieldValue("date").exactAsString));

                lhsCondition.moveFirst();
                while (lhsCondition.moveNext())
                    if (valType(lhsCondition.getCurrentItem()) != V_UNDEF)
                        lhsValue = lhsValue + getAttributeValue(lhsCondition.getCurrentItem(), dateValue, isRouble);
                    end;
                end;

                rhsCondition.moveFirst();
                while (rhsCondition.moveNext())
                    if (valType(rhsCondition.getCurrentItem()) != V_UNDEF)
                        rhsValue = rhsValue + getAttributeValue(rhsCondition.getCurrentItem(), dateValue, isRouble);
                    end;
                end;

                if ((conditionSign == RCB_RS_GREATER) and (lhsValue > rhsValue))
                    isConditionSatisfied = true;
                elif ((conditionSign == RCB_RS_GREATER_OR_EQUAL) and (lhsValue >= rhsValue))
                    isConditionSatisfied = true;
                elif ((conditionSign == RCB_RS_LESS) and (lhsValue < rhsValue))
                    isConditionSatisfied = true;
                elif ((conditionSign == RCB_RS_LESS_OR_EQUAL) and (lhsValue <= rhsValue))
                    isConditionSatisfied = true;
                elif ((conditionSign == RCB_RS_EQUAL) and (lhsValue == rhsValue))
                    isConditionSatisfied = true;
                elif ((conditionSign == RCB_RS_NOT_EQUAL) and (lhsValue != rhsValue))
                    isConditionSatisfied = true;
                end;

                if (isConditionSatisfied)
                    var value = compositeValue.fieldValue(ternary(isRouble, "roubleRest", "currencyRest"));

                    if (value.exact != $0)
                        var id = global.toAnsiNorm(        applicationNamePool.value(iteratorPool.getCurrentIndex())
                                                   + "_" + compositeValue.fieldValue("row").exactAsString
                                                   + "_" + ternary(isRouble, "Ру", "Ва")
                                                   + "_" + compositeValue.fieldValue("balance").exactAsString
                                                   + "_" + string(dateValue : f),
                                                   true
                                                  );
                        rcbValuePool.push_back(TNormalizerValueData(id, value));
                        isAddNormalizer = true;
                    end;
                end;
                // 21.02.2017 ABP Костыль. Если нормализуется один атрибут, то при НЕвыполнении предусловия он зануляется.
                //                При нормализации нескольких атрибутов при НЕвыполнении предусловия они не меняются
                if (not isConditionSatisfied and (decodingNamePool.size <= 1))
                    compositeValue.fieldValue(ternary(isRouble, "roubleRest", "currencyRest")).scaled = $0;
                end;
            end;

            if (isAddNormalizer)
                if (m_normalizerPool.isEmpty())
                    m_isFillNormalizePool = true;
                else
                    m_normalizerPool.moveFirst();
                    m_normalizerPool.moveNext();
                end;

                //формирование правой части отношения: балансовые счета и константные значения атрибутов ФОР
                var poolOfConstantValues : RcbArray = RcbArray();
                balancePool.moveFirst();
                while (balancePool.moveNext())
                    poolOfConstantValues.push_back(getAttributeValue(balancePool.getCurrentItem(), dateValue, isRouble));
                end;

                //добавить нормализатор в пул
                var currentNormalize;
                if (m_isFillNormalizePool)
                    m_normalizerPool.push_back(ReportNormalizer(m_multiplier));
                    currentNormalize = m_normalizerPool(m_normalizerPool.getCount() - 1);
                else
                    currentNormalize = m_normalizerPool.getCurrentItem();
                end;

                relation = ReportLinearRelation(sign);

                //добавить отношение слева
                rcbValuePool.moveFirst();
                if (rcbValuePool.isEmpty())
                    synchronizer.moveNext();
                    continue;
                end;

                while (rcbValuePool.moveNext())
                    var node = currentNormalize.addNode(rcbValuePool.getCurrentItem().name);
                    node.setExact(rcbValuePool.getCurrentItem.value.exact);
                    node.recalculateScaled();
                    relation.lhs.plus(node);
                end;

                //добавить отношение справа
                poolOfConstantValues.moveFirst();
                while (poolOfConstantValues.moveNext())
                    relation.rhs.plus(Double(poolOfConstantValues.getCurrentItem()));
                end;

                currentNormalize.addRelation(relation);

                if (not m_isFillNormalizePool)
                    m_normalizerPool.moveNext();
                end;

                m_rcbValuesPool.push_back(rcbValuePool);
            end;

            synchronizer.moveNext();
        end;
    end;

    macro addRelation(p1 : Variant, p2 : Variant, p3 : Variant, decodingNamePool : RcbArray, balancePool: RcbArray, p6 : Variant, sign : Integer)
        macro getSign(relation : String) : Object
            class TSign(_sign, _position, _length)
                var sign = _sign;
                var position = _position;
                var length = _length;
            end;

            var sign = null;
            var length = 1;
            var idx;
            if (sign == null)
                idx = index(relation, ">=");
                if (idx != 0)
                    sign = RCB_RS_GREATER_OR_EQUAL;
                    length = 2;
                end;
            end;
            if (sign == null)
                idx = index(relation, "<=");
                if (idx != 0)
                    sign = RCB_RS_LESS_OR_EQUAL;
                    length = 2;
                end;
            end;
            if (sign == null)
                idx = index(relation, "<>");
                if (idx == 0)
                    idx = index(relation, "!=");
                end;
                if (idx != 0)
                    sign = RCB_RS_NOT_EQUAL;
                    length = 2;
                end;
            end;
            if (sign == null)
                idx = index(relation, "=");
                if (idx != 0)
                    sign = RCB_RS_EQUAL;
                    length = 1;
                end;
            end;
            if (sign == null)
                idx = index(relation, "<");
                if (idx != 0)
                    sign = RCB_RS_LESS;
                    length = 1;
                end;
            end;
            if (sign == null)
                idx = index(relation, ">");
                if (idx != 0)
                    sign = RCB_RS_GREATER;
                    length = 1;
                end;
            end;
            if (sign == null)
                // выкинуть исключение, прекратить работу
                установитьФлагВозврата(STOP_PROC_FLG);
                exit(1);
            end;

            return TSign(sign, idx, length);
        end;

        macro getAttributeCodeList(combination : String) : RcbArray
            var data = RcbArray();
            combination = trim(combination);
            var idx = strbrk(combination, "+-");
            if (idx != 1)
                combination = "+" + combination;
                idx = strbrk(combination, "+-");
            end;
            while (idx > 0)
                var sign = substr(combination, idx, 1);
                combination = substr(combination, idx+1);
                idx = strbrk(combination, "+-");
                var value = "";
                if (idx > 0)
                    value = sign + trim(substr(combination, 1, idx-1));
                else
                    value = sign + trim(substr(combination, 1));
                end;
                data.push_back(value);
            end;

            return data;
        end;

        macro getDecodingList(combination : String) : RcbArray
            // 21.02.2017 ABP Элементы линейной комбинации всегда складываются.
            //                Знак, указанный в строке для разбора, не учитывается.
            //                Например, "2|1.1|408061 - 2|2|408062" будет рассматриваться
            //                как "2|1.1|408061 + 2|2|408062", а не "2|1.1|408061 + (-2|2|408062)".
            //                Это ограничение реализации TDecodingData
            var data = RcbArray();
            combination = trim(combination);
            var idx = strbrk(combination, "+-");
            if (idx != 1)
                combination = "+" + combination;
                idx = strbrk(combination, "+-");
            end;
            while (idx > 0)
                var sign = substr(combination, idx, 1);
                combination = substr(combination, idx+1);
                idx = strbrk(combination, "+-");
                var value = "";
                if (idx > 0)
                    value = trim(substr(combination, 1, idx-1));
                else
                    value = trim(substr(combination, 1));
                end;
                var attributeParts = strcut(value, "_|");
                var decodingData = TDecodingData("Приложение"+trim(attributeParts[0]), trim(attributeParts[1]), trim(attributeParts[2]));
                data.push_back(decodingData);
            end;

            return data;
        end;

        var lhsCondition = p1;
        var rhsCondition = p2;
        var conditionSign = p3;

        if (valType(p1) == V_STRING)
            var signObject = getSign(p1);
            conditionSign = signObject.sign;
            lhsCondition = getAttributeCodeList(substr(p1, 1, signObject.position-1));
            rhsCondition = getAttributeCodeList(substr(p1, signObject.position+signObject.length));

            signObject = null;
            signObject = getSign(p2);
            sign = signObject.sign;
            decodingNamePool = getDecodingList(substr(p2, 1, signObject.position-1));
            balancePool = getAttributeCodeList(substr(p2, signObject.position+signObject.length));

            if (index(p3, "R") != 0)
                addRelationImpl(lhsCondition, rhsCondition, conditionSign, decodingNamePool, balancePool, NATIONAL_CURRENCY, sign);
            end;
            if (index(p3, "V") != 0)
                addRelationImpl(lhsCondition, rhsCondition, conditionSign, decodingNamePool, balancePool, FOREIGN_CURRENCY,  sign);
            end;
        elif (valType(p6) == V_BOOL)
            addRelationImpl(lhsCondition, rhsCondition, conditionSign, decodingNamePool, balancePool, p6, sign);
        else
            sign = p6;
            addRelationImpl(lhsCondition, rhsCondition, conditionSign, decodingNamePool, balancePool, NATIONAL_CURRENCY, sign);
            addRelationImpl(lhsCondition, rhsCondition, conditionSign, decodingNamePool, balancePool, FOREIGN_CURRENCY,  sign);
        end;
    end;

    /**
     * Нормализация
     */
    macro normalize()
        var rcbValuePool;
        var currentItem;

        m_normalizerPool.moveFirst();
        while (m_normalizerPool.moveNext())
            if (valType(m_normalizerPool.getCurrentItem()) != V_UNDEF)
                m_normalizerPool.getCurrentItem().normalize();
                m_rcbValuesPool.moveFirst();
                if (m_normalizerPool.getCurrentItem().isNormalized())
                    while (m_rcbValuesPool.moveNext())
                        if (valType(m_rcbValuesPool.getCurrentItem()) != V_UNDEF)
                            rcbValuePool = m_rcbValuesPool.getCurrentItem();
                            rcbValuePool.moveFirst();
                            while(rcbValuePool.moveNext())
                                currentItem = rcbValuePool.getCurrentItem();
                                if (valType(m_normalizerPool.getCurrentItem().node(currentItem.name)) != V_UNDEF)
                                    currentItem.value.scaled = m_normalizerPool.getCurrentItem().node(currentItem.name).scaled;
                                    normalizationProtocol.printString(currentItem.name, currentItem.value.exact, currentItem.value.scaled, m_normalizerPool.getCurrentItem().getLogFilePath());
                                end;
                            end;
                        end;
                    end;
                else
                    m_rcbValuesPool.moveFirst();
                    while (m_rcbValuesPool.moveNext())
                        rcbValuePool = m_rcbValuesPool.getCurrentItem();
                        rcbValuePool.moveFirst();
                        while (rcbValuePool.moveNext())
                            normalizationProtocolWithErrors.printError(rcbValuePool.getCurrentItem().name);
                            normalizationProtocolWithErrors.printNameLog(m_normalizerPool.getCurrentItem().getLogFilePath());
                        end;
                    end;
                end;
            end;
        end;
    end;

    private macro ctor(multiplier : Integer, applicationName : String)
        m_multiplier = multiplier;
        m_isFillNormalizePool = false;
        m_applicationName = applicationName;
    end;

    ctor(multiplier, applicationName);
end;

/**
 * Нормализатор Приложения 1 по 5242-У. Наследование запрещено
 */
class (TApplication1NormalizerBase) TApplication1Normalizer_5242(protocolView)
    private macro addRules()
        var relation : Object;

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "4.2"));
        relation.rhs.plus(addNode("1", "2.14"));
        relation.rhs.minus(addNode("1", "3.2"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "4.1"));
        relation.rhs.plus(addNode("1", "2.8"));
        relation.rhs.minus(addNode("1", "3.1"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "4", 0.5));
        relation.rhs.plus(addNode("1", "4.1"));
        relation.rhs.plus(addNode("1", "4.2"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(addNode("1", "3", 0.5));
        relation.rhs.plus(addNode("1", "2", 0.5));
        relation.rhs.multiply(0.8);
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "3.2"));
        relation.rhs.plus(addNode("1", "2.14"));
        relation.rhs.multiply(global.parameters.getReservation().getAveragingCoefficient());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "3.1"));
        relation.rhs.plus(addNode("1", "2.8"));
        relation.rhs.multiply(global.parameters.getReservation().getAveragingCoefficient());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "3"));
        relation.rhs.plus(addNode("1", "3.1"));
        relation.rhs.plus(addNode("1", "3.2"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.14"));
        relation.rhs.plus(addNode("1", "2.9"));
        relation.rhs.plus(addNode("1", "2.10"));
        relation.rhs.plus(addNode("1", "2.11"));
        relation.rhs.plus(addNode("1", "2.12"));
        relation.rhs.plus(addNode("1", "2.13"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.13"));
        relation.rhs.plus(addNode("1", "1.10"));
        relation.rhs.multiply(global.parameters.getReservation().getOthersLongTermCurrency());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.12"));
        relation.rhs.plus(addNode("1", "1.9"));
        relation.rhs.multiply(global.parameters.getReservation().getOthersExceptLongCurrency());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.11"));
        relation.rhs.plus(addNode("1", "1.8"));
        relation.rhs.multiply(global.parameters.getReservation().getNaturalPersonCurrency());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.10"));
        relation.rhs.plus(addNode("1", "1.7"));
        relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonLongTermCurrency());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.9"));
        relation.rhs.plus(addNode("1", "1.6"));
        relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonExceptLongCurrency());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.8"));
        relation.rhs.plus(addNode("1", "2.6"));
        relation.rhs.minus(addNode("1", "2.7"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.7"));
        relation.rhs.plus(getAttributeValue("5", "5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.6"));
        relation.rhs.plus(addNode("1", "2.1"));
        relation.rhs.plus(addNode("1", "2.2"));
        relation.rhs.plus(addNode("1", "2.3"));
        relation.rhs.plus(addNode("1", "2.4"));
        relation.rhs.plus(addNode("1", "2.5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.5"));
        relation.rhs.plus(addNode("1", "1.5"));
        relation.rhs.multiply(global.parameters.getReservation().getOthersLongTermRouble());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.4"));
        relation.rhs.plus(addNode("1", "1.4"));
        relation.rhs.multiply(global.parameters.getReservation().getOthersExceptLongRouble());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.3"));
        relation.rhs.plus(addNode("1", "1.3"));
        relation.rhs.multiply(global.parameters.getReservation().getNaturalPersonRouble());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.2"));
        relation.rhs.plus(addNode("1", "1.2"));
        relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonLongTermRouble());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2.1"));
        relation.rhs.plus(addNode("1", "1.1"));
        relation.rhs.multiply(global.parameters.getReservation().getNotresidentLegalPersonExceptLongRouble());
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "2"));
        relation.rhs.plus(addNode("1", "2.8"));
        relation.rhs.plus(addNode("1", "2.14"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.10"));
        relation.rhs.plus(getAttributeValue("2", "3.2.6"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.9"));
        relation.rhs.plus(getAttributeValue("2", "3.1.6"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.8"));
        relation.rhs.plus(getAttributeValue("2", "2.3"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.7"));
        relation.rhs.plus(getAttributeValue("2", "1.2.6"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.6"));
        relation.rhs.plus(getAttributeValue("2", "1.1.5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.5"));
        relation.rhs.plus(getAttributeValue("2", "3.2.5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.4"));
        relation.rhs.plus(getAttributeValue("2", "3.1.5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.3"));
        relation.rhs.plus(getAttributeValue("2", "2.2"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.2"));
        relation.rhs.plus(getAttributeValue("2", "1.2.5"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1.1"));
        relation.rhs.plus(getAttributeValue("2", "1.1.4"));
        addRelation(relation);

        relation = ReportLinearRelation(RCB_RS_EQUAL);
        relation.lhs.plus(addNode("1", "1", 0.5));
        relation.rhs.plus(addNode("1", "1.1"));
        relation.rhs.plus(addNode("1", "1.2"));
        relation.rhs.plus(addNode("1", "1.3"));
        relation.rhs.plus(addNode("1", "1.4"));
        relation.rhs.plus(addNode("1", "1.5"));
        relation.rhs.plus(addNode("1", "1.6"));
        relation.rhs.plus(addNode("1", "1.7"));
        relation.rhs.plus(addNode("1", "1.8"));
        relation.rhs.plus(addNode("1", "1.9"));
        relation.rhs.plus(addNode("1", "1.10"));
        addRelation(relation);
    end;

    initTApplication1NormalizerBase(protocolView);
end;
