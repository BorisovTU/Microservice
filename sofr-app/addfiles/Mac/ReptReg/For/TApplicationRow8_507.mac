/*
$Name:          TApplicationRow8_507.mac
$Module:        Регламентируемая отчетность
$Description:   ФОР. Классы строк Приложения 8 ФОР по 507-П
*/

class (TApplicationRow8) TApplicationRow507_8(applicationName : String)
    private macro getApplicationBalanceString(applicationName : String)
        var set = global.form.getMasksSetForApplication(applicationName);
        var iterator = set.createIterator();
        var masksString  : String = "";

        iterator.moveFirst();
        while (not iterator.isDone())
            var mask = iterator.getCurrentItem();
            if (mask != "")
                masksString = masksString + "," + mask;
            end;
            iterator.moveNext();
        end;
        masksString = subStr(masksString, 2);

        var dataSet : Object = NULL;
        var balanceString : String = "";

        if (masksString != "")
            dataSet = TRsbDataSet("SELECT DISTINCT t_chapter, t_balance" + global.parameters.getPlanNumber() + " t_balance"
                           +"\n"+ "  FROM daccblnc_dbt"
                           +"\n"+ " WHERE t_chapter = 1 AND " + convertMaskToSqlFormat(masksString, "t_balance"+ global.parameters.getPlanNumber())
                           +"\n"+ "ORDER BY t_chapter, t_balance" + global.parameters.getPlanNumber());

            while (dataSet.moveNext)
                balanceString = balanceString + ", " + dataSet.balance;
            end;

            return subStr(balanceString, 3);
        else
            return "";
        end;
    end;

    macro saveAttributes()
        var structValue    : Object = NULL;
        var iterator       : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator("Приложение2", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение2", getApplicationBalanceString("Приложение2"));
            end;

            iterator = getAttributeValueIterator("Приложение3", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение3", getApplicationBalanceString("Приложение3"));
            end;

            iterator = getAttributeValueIterator("Приложение4", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение4", getApplicationBalanceString("Приложение4"));
            end;

            iterator = getAttributeValueIterator("Приложение6", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение6", getApplicationBalanceString("Приложение6"));
            end;
        end;
    end;

    macro print(printedReport)
        var compositeValue : Object = NULL;
        var iterator       : Object = getAttributeValueIterator(m_applicationName, NULL, NULL);
        var isFirst        : Bool   = true;

        iterator.setSortOrder(SORTER_FOR_APPLICATION);

        iterator.moveFirst();
        while (not iterator.isDone())
            if (not isFirst)
                printedReport.printSeparator();
            end;
            isFirst = false;
            compositeValue = iterator.currentItem();
            printedReport.printStringTransferByWord(compositeValue.fieldValue("row").currentAsString,
                                                    compositeValue.fieldValue("applicationName").currentAsString,
                                                    getApplicationBalanceString(compositeValue.fieldValue("applicationName").current));
            iterator.moveNext();
        end;
        printedReport.printBottom();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_8(applicationName : String)
        initTApplicationRow8(applicationName);

        m_code = "-";
    end;

    constructorTApplicationRow507_8(applicationName);
end;

class (TApplicationRow8) TApplicationRow8_5036(applicationName : String, xlsView)
    private macro getApplicationBalanceString(applicationName : String)
        var set = global.form.getMasksSetForApplication(applicationName);
        var iterator = set.createIterator();
        var masksString  : String = "";

        iterator.moveFirst();
        while (not iterator.isDone())
            var mask = iterator.getCurrentItem();
            if (mask != "")
                masksString = masksString + "," + mask;
            end;
            iterator.moveNext();
        end;
        masksString = subStr(masksString, 2);

        var dataSet : Object = NULL;
        var balanceString : String = "";

        if (masksString != "")
            dataSet = TRsbDataSet("SELECT DISTINCT t_chapter, t_balance" + global.parameters.getPlanNumber() + " t_balance"
                           +"\n"+ "  FROM daccblnc_dbt"
                           +"\n"+ " WHERE t_chapter = 1 AND " + convertMaskToSqlFormat(masksString, "t_balance"+ global.parameters.getPlanNumber())
                           +"\n"+ "ORDER BY t_chapter, t_balance" + global.parameters.getPlanNumber());

            while (dataSet.moveNext)
                balanceString = balanceString + ", " + dataSet.balance;
            end;

            return subStr(balanceString, 3);
        else
            return "";
        end;
    end;

    macro saveAttributes()
        var structValue    : Object = NULL;
        var iterator       : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator("Приложение2", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение2", getApplicationBalanceString("Приложение2"));
            end;

            iterator = getAttributeValueIterator("Приложение3", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение3", getApplicationBalanceString("Приложение3"));
            end;

            iterator = getAttributeValueIterator("Приложение4", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение4", getApplicationBalanceString("Приложение4"));
            end;

            iterator = getAttributeValueIterator("Приложение6", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение6", getApplicationBalanceString("Приложение6"));
            end;
        end;
    end;

    macro print(printedReport)
        var compositeValue : Object = NULL;
        var iterator       : Object = getAttributeValueIterator(m_applicationName, NULL, NULL);
        var isFirst        : Bool   = true;

        iterator.setSortOrder(SORTER_FOR_APPLICATION);

        iterator.moveFirst();
        while (not iterator.isDone())
            if (not isFirst)
                printedReport.printSeparator();
            end;
            isFirst = false;
            compositeValue = iterator.currentItem();
            printedReport.printStringTransferByWord(compositeValue.fieldValue("row").currentAsString,
                                                    compositeValue.fieldValue("applicationName").currentAsString,
                                                    getApplicationBalanceString(compositeValue.fieldValue("applicationName").current));
            iterator.moveNext();
        end;
        printedReport.printBottom();
    end;
	
	macro printExcel(printedReport)
        var compositeValue : Object = NULL;
        var iterator       : Object = getAttributeValueIterator(m_applicationName, NULL, NULL);
        var isFirst        : Bool   = true;

        iterator.setSortOrder(SORTER_FOR_APPLICATION);

        iterator.moveFirst();
        while (not iterator.isDone())
            compositeValue = iterator.currentItem();
			m_xlsView.printRow(RcbArray().initialize(compositeValue.fieldValue("row").currentAsString,
			                                         compositeValue.fieldValue("applicationName").currentAsString,
													 getApplicationBalanceString(compositeValue.fieldValue("applicationName").current)));
            iterator.moveNext();
        end;
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow8_5036(applicationName : String, xlsView)
        initTApplicationRow8(applicationName, xlsView);

        m_code = "-";
    end;

    constructorTApplicationRow8_5036(applicationName, xlsView);
end;
