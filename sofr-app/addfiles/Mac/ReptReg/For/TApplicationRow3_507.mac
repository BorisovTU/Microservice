/*
$Name:          TApplicationRow3_507.mac
$Module:        Регламентируемая отчетность
$Description:   Классы строк Приложения3 ФОР по 507-П
*/
/***************************************************************************************************
 *  Класc строки 1 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow507_3_1(applicationName : String)
    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки (либо их часть) ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" отдельных лицевых счетов балансовых", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету денежных средств,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" привлеченных от юридических лиц и ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" индивидуальных предпринимателей на", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" срок не менее трех лет в соответствии", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" с условиями заключенных  договоров:", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки", true);
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3_1(applicationName : String)
        initTApplicationRow2_7(applicationName);

        m_code = "1";
    end;

    constructorTApplicationRow507_3_1(applicationName);
end;

/***************************************************************************************************
 *  Базовый класс для строк 1.1 и 1.3 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow507_3__1_1__1_3(applicationName : String)
    /*Существует хотя бы один досрочный возврат*/
    class (TDataSourceFilter_3115) TDataSourceFilter3_F1(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " " + isExistsAnticipatedPayment("account.t_account", "account.t_fiId", "account.t_chapter");
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;

        initTDataSourceFilter_3115(balanceMasks, category);
    end;

    /*Фильтр суммы 1*/
    class (TDataSourceFilter) TDataSourceFilter3_Sum1(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;

        macro makePartDateFilter()
            var isPaidCancellation = global.parameters.isPaidCancellation();

            m_partDateFilter = " " + hasAssignedCategory()
                +"\n"+ "      AND (   (    " + getAnticipatoryRepudiationDate() + " IS NULL"
                +"\n"+ "               AND " + getPayingSharesDate() + " IS NULL AND " + getPartialRepaymentDate() + " IS NULL)"
                +"\n"+ "           OR (    (   " + getPayingSharesDate() + " IS NULL"
                +"\n"+ "                    OR rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") > 5)"
                +"\n"+ "               AND (t_date - 1) < " + getAnticipatoryRepudiationDate() + ")"
                +"\n"+ "           OR (    rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") <= 5"
                +"\n"+ "               " + ternary(isPaidCancellation, "OR", "AND") + " (t_date - 1) < " + getAnticipatoryRepudiationDate() + ")"
                +"\n"+ "           OR  " + getPartialRepaymentDate() + " IS NOT NULL"
                +"\n"+ "          )";
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    /* Фильтр суммы 2 */
    class (TDataSourceFilter) TDataSourceFilter3_Sum2(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  " + getAnticipatoryRepudiationDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL"
                +"\n"+ "AND  " + getPayingSharesDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL";
        end;

        macro makePartDateFilter()
            m_partDateFilter = " NOT " + hasAssignedCategory();
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    /*Фильтр для суммы 3*/
    class (TDataSourceFilter) TDataSourceFilter3_Sum3(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
        end;

        macro makePartDateFilter()
            if (global.parameters.isPaidCancellation())
                m_partDateFilter = "  ( rcb_for.getWorkDayCount(" + getAnticipatoryRepudiationDate() + "," + getPayingSharesDate() + ") <= 5 AND " + getPartialRepaymentDate() + " IS NULL)";
            else
                m_partDateFilter = " (frd.t_date - 1) < " + getAnticipatoryRepudiationDate();
            end;

            m_partDateFilter = "( " + m_partDateFilter + " OR " + getPartialRepaymentDate() + " IS NOT NULL OR " + hasAssignedCategory("ДР") + " OR "
                                    + getAnticipatoryRepudiationDate() + " IS NULL)" + "\n" + "AND "
                                    + hasAssignedCategory();
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3__1_1__1_3(applicationName : String)
        initTApplicationRow2_7(applicationName);
    end;

    constructorTApplicationRow507_3__1_1__1_3(applicationName);
end;

class (TApplicationRow507_3__1_1__1_3) TApplicationRow507_3_1_1(applicationName : String)
    /* Фильтр суммы 2.1 */
    class (TDataSourceFilter) TDataSourceFilter3_Sum2_1(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  " + getAnticipatoryRepudiationDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL"
                +"\n"+ "AND  " + getPayingSharesDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL";
        end;

        macro makePartDateFilter()
            m_partDateFilter = " NOT " + hasAssignedCategory();
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    macro fillTempTable(tempTable: TTempTable)
        var dataSet: Object = NULL;
        var dateAnticipatedPayment: Date = Date(0, 0, 0);
        var endDate: Date = Date(0, 0, 0);
        var yearDateAnticipatedPayment;
        var yearEndDate;
        const CODE_ROW_TUNE_TABLE_FOR_SUM_2_1: String = "1.1(1)";

        const MASKS = getBalanceMasksForRow(m_code) + "," + getBalanceMasksForRow("1.3") + "," + getBalanceMasksForRow("1.1(1)") + "," + getBalanceMasksForRow("1.3(1)");
        dataSet = TRsbDataSet(TBalanceDataSource(TDataSourceFilter3_F1(MASKS), m_code, m_applicationName, "ПривлЮЛ_Нерез", true).getQuery());

        dateAnticipatedPayment = global.parameters.getDateAnticipatedPayment();
        endDate = global.parameters.getEndDate();

        dateSplit(dateAnticipatedPayment, NULL, NULL, yearDateAnticipatedPayment);
        dateSplit(endDate, NULL, NULL, yearEndDate);

        if (    (dateAnticipatedPayment != Date("00.00.0000"))
            and (    (dateAnticipatedPayment <= endDate)
                 and (yearDateAnticipatedPayment == yearEndDate)
                )
           )
            // Сумма 1
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum1(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        else
            // Существует хотя бы один досрочный возврат
            if (dataSet.moveNext())
                // Сумма 1
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum1(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
            else
                // Сумма 2
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum2(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
                // Сумма 2.1
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum2_1(getBalanceMasksForRow(CODE_ROW_TUNE_TABLE_FOR_SUM_2_1), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
                // Сумма 3
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum3(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
            end;
        end;
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ПривлЮЛ_Нерез");
    end;

    macro saveAttributes()
        var applicationRow     : Object = null;
        var dataSet            : Object = null;
        var roubleRest         : Money  = $0.0;
        var currencyRest       : Money  = $0.0;
        var scaledRoubleRest   : Double = 0.0;
        var scaledCurrencyRest : Double = 0.0;
        var multiplier = rcbApplication.currentReport.multiplier;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ_Нерез")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" от юридических лиц-нерезидентов:", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportDescriptionRow("1.1.От юридических лиц-нерезидентов");
        else
            exportDescriptionRow("1.1.от юридических лиц-нерезидентов");
        end;

        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_1", this, "ПривлЮЛ_Нерез", "RV").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3_1_1(applicationName : String)
        initTApplicationRow507_3__1_1__1_3(applicationName);

        m_code = "1.1";
    end;

    constructorTApplicationRow507_3_1_1(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 1.2 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow507_3_1_2(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "314440");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, true, true, true, "Итого пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" перед юридическими лицами-нерезидентами,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения - 314440", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "1.2.Итого пас. ост.(код 314440)");
        else
            exportValueRow(iterator, "1.2.ИТОГО пас. ост.(код 314440)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_2", this, "RV").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3_1_2(applicationName : String)
        initTApplicationRow2_7(applicationName);

        m_code = "1.2";
    end;

    constructorTApplicationRow507_3_1_2(applicationName);
end;

class (TApplicationRow507_3__1_1__1_3) TApplicationRow507_3_1_3(applicationName : String)
    /* Фильтр суммы 2.1 */
    class (TDataSourceFilter) TDataSourceFilter3_Sum2_1(balanceMasks : String, category : String)
        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  " + isTermExceedThreeYears("account.t_account", "account.t_fiId", "account.t_chapter")
                +"\n"+ "AND  " + getAnticipatoryRepudiationDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL"
                +"\n"+ "AND  " + getPayingSharesDate("account.t_account", "account.t_fiId", "account.t_chapter") + " IS NULL";
        end;

        macro makePartDateFilter()
            m_partDateFilter = " NOT " + hasAssignedCategory();
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    macro fillTempTable(tempTable: TTempTable)
        var dataSet: Object = NULL;
        var dateAnticipatedPayment: Date = Date(0, 0, 0);
        var endDate: Date = Date(0, 0, 0);
        var yearDateAnticipatedPayment;
        var yearEndDate;
        const CODE_ROW_TUNE_TABLE_FOR_SUM_2_1: String = "1.3(1)";

        const MASKS = getBalanceMasksForRow(m_code) + "," + getBalanceMasksForRow("1.3") + "," + getBalanceMasksForRow("1.1(1)") + "," + getBalanceMasksForRow("1.3(1)");
        dataSet = TRsbDataSet(TBalanceDataSource(TDataSourceFilter3_F1(MASKS), m_code, m_applicationName, "ПривлЮЛ", true).getQuery());

        dateAnticipatedPayment = global.parameters.getDateAnticipatedPayment();
        endDate = global.parameters.getEndDate();

        dateSplit(dateAnticipatedPayment, NULL, NULL, yearDateAnticipatedPayment);
        dateSplit(endDate, NULL, NULL, yearEndDate);

        if (    (dateAnticipatedPayment != Date("00.00.0000"))
            and (    (dateAnticipatedPayment <= endDate)
                 and (yearDateAnticipatedPayment == yearEndDate)
                )
           )
            // Сумма 1
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum1(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
        else
            // Существует хотя бы один досрочный возврат
            if (dataSet.moveNext())
                // Сумма 1
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum1(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
            else
                // Сумма 2
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum2(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
                // Сумма 2.1
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum2_1(getBalanceMasksForRow(CODE_ROW_TUNE_TABLE_FOR_SUM_2_1), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
                // Сумма 3
                tempTable.fill(TBalanceDataSource(TDataSourceFilter3_Sum3(getBalanceMasksForRow(m_code), "СубКредит"), m_code, m_applicationName, "ПривлЮЛ"));
            end;
        end;
    end;

    macro fillTempTableForBalanceData(tempTable : TTempTable)
        fillTempTable(tempTable);

        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));

        updateTempTable(dataSet, "ПривлЮЛ");
    end;

    macro saveAttributes()
        var applicationRow : Object = null;
        var dataSet        : Object = null;
        var roubleRest     : Money  = $0.0;
        var currencyRest   : Money  = $0.0;
        var scaledRoubleRest   : Double = 0.0;
        var scaledCurrencyRest : Double = 0.0;
        var multiplier = rcbApplication.currentReport.multiplier;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);

            end;
        end;
    end;

    macro print(reportWidth: Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" от иных юридических лиц и ", TRUE, TRUE, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" индивидуальных предпринимателей:", FALSE, TRUE, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, FALSE, TRUE, TRUE);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == true)
            exportDescriptionRow("1.3. от иных юридических лиц:");
        elif (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
              or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016"))
            exportDescriptionRow("1.3.От иных юридических лиц и индивидуальных предпринимателей:");
        else
            exportDescriptionRow("1.3. от иных юридических лиц и индивидуальных предпринимателей:");
        end;

        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
        end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлЮЛ", "RV").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3_1_3(applicationName : String)
        initTApplicationRow507_3__1_1__1_3(applicationName);

        m_code = "1.3";
    end;

    constructorTApplicationRow507_3_1_3(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 1.4 приложения3
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow507_3_1_4(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.3");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "410439");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, true, true, true, "Итого пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" иных обязательств, код ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" обозначения 410439", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);

        if (    (global.reportingPeriodIsVror == false)
            and (   (global.klikoExportFile.getDescription() == "for_60.pak от 10.05.2016")
                 or (global.klikoExportFile.getDescription() == "FOR_58.PAK от 26.01.2016")))
            exportValueRow(iterator, "1.4.Итого пас. ост.(код - 410439)");
        else
            exportValueRow(iterator, "1.4.ИТОГО пас. ост.(код - 410439)");
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_4", this, "RV").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_3_1_4(applicationName : String)
        initTApplicationRow2_7(applicationName);

        m_code = "1.4";
    end;

    constructorTApplicationRow507_3_1_4(applicationName);
end;

// Базовый класс строк Приложения 3 по 4217-У
private class (TApplicationRow2_7_4217) TApplicationRow3_4217(applicationName : String)
    private macro constructorTApplicationRow3_4217(applicationName : String)
        initTApplicationRow2_7_4217(applicationName);
    end;

    constructorTApplicationRow3_4217(applicationName);
end;

private class (TDataSourceFilter_4217) TDataSourceFilter2(balanceMasks : String)
    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    macro makePartDateFilter()
        m_partDateFilter = " " + hasAssignedCategory(null, 25);
                         ;
    end;

    initTDataSourceFilter_4217(balanceMasks);
end;

private class (TDataSourceFilter_4217) TDataSourceFilter3(balanceMasks : String)
    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    macro makePartDateFilter()
        m_partDateFilter = "EXISTS(SELECT 1"
               +"\n"+ "              FROM repMmDeals_vw deals"
               +"\n"+ "             WHERE deals.t_mainRestAccount = account.t_account"
               +"\n"+ "               AND deals.t_fiId = account.t_fiId"
               +"\n"+ "               AND deals.t_isOpened = 1"
               +"\n"+ "               AND " + isNotResident("deals.t_contragentId")
               +"\n"+ "               AND " + isBank("deals.t_contragentId")
               +"\n"+ "               AND " + isMmDealsSubordinated()
               +"\n"+ "           ) "
            ;
    end;
    initTDataSourceFilter_4217(balanceMasks);
end;

// Строка 1 Приложения 3
class (TApplicationRow3_4217) TApplicationRow3_1_4217(applicationName : String)
    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов балансовых счетов по учету ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" субординированных кредитов (депозитов,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" займов, облигационных займов) ", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки отдельных л/сч б/сч по учету суборд. кредитов", true);
    end;

    private macro constructorTApplicationRow3_1_4217(applicationName : String)
        initTApplicationRow3_4217(applicationName);

        m_code = "1";
    end;

    constructorTApplicationRow3_1_4217(applicationName);
end;

//Строка 1.1 Приложения 3
class (TApplicationRow3_4217) TApplicationRow3_1_1_4217(applicationName : String)
    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        if (balanceMasks != "")
            balanceMasks = balanceMasks + ",";
        end;

        balanceMasks = balanceMasks + getBalanceMasksForRow("1.1_МБК");

        return balanceMasks;
     end;

    macro fillTempTable(tempTable: TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ_Нерез"));

        if (global.parameters.isMmDealsData())
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        else
            tempTable.fill(TBalanceDataSource(TDataSourceFilter2(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        end;
    end;

//    macro fillTempTableForBalanceData(tempTable : TTempTable)
//        fillTempTable(tempTable);
//        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));
//        updateTempTable(dataSet, "ПривлЮЛ_Нерез");
//    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ_Нерез")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Юридических лиц-нерезидентов", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.1.юридических лиц-нерезидентов");
        else
            exportDescriptionRow("1.1.от юридических лиц-нерезидентов");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_1", this, "ПривлЮЛ_Нерез", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_1_4217(applicationName : String)
        initTApplicationRow3_4217(applicationName);

        m_code = "1.1";
    end;

    constructorTApplicationRow3_1_1_4217(applicationName);
end;

//Строка 1.1.1 Приложения 3
class (TApplicationRow3_4217) TApplicationRow3_1_1_1_4217(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "314440");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, true, true, true, " Итого пассивных остатков, подлежащих");
        printDescriptionRow(" исключению из долгосрочных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" перед юридическими лицами-нерезидентами,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 314440", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var description = "";
        if (global.reportingPeriodIsVror == false)
            description = "1.1.1.Итого пас.ост., подлеж. искл. из долгоср. об-в (код 314440)";
        else
            description = "1.1.1.ИТОГО пас. ост.(код 314440)";
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE, description);
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_2", this, "RV").export();
    end;

    private macro constructorTApplicationRow3_1_1_1_4217(applicationName : String)
        initTApplicationRow3_4217(applicationName);

        m_code = "1.1.1";
    end;

    constructorTApplicationRow3_1_1_1_4217(applicationName);
end;

//Строка 1.2 Приложения 3
class (TApplicationRow3_4217) TApplicationRow3_1_2_4217(applicationName : String)
    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro fillTempTable(tempTable: TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ"));
    end;

//    macro fillTempTableForBalanceData(tempTable : TTempTable)
//        fillTempTable(tempTable);
//        var dataSet = getBalanceDataSet(getBalanceMasksForRow(m_code));
//        updateTempTable(dataSet, "ПривлЮЛ");
//    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth: Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Иных юридических лиц: ", TRUE, TRUE, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, FALSE, TRUE, TRUE);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.2.иных юридических лиц");
        else
            exportDescriptionRow("1.2.Иных юридических лиц:");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлЮЛ", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_2_4217(applicationName : String)
        initTApplicationRow3_4217(applicationName);

        m_code = "1.2";
    end;

    constructorTApplicationRow3_1_2_4217(applicationName);
end;

//Строка 1.2.1 Приложения 3
class (TApplicationRow3_4217) TApplicationRow3_1_2_1_4217(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "411520");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);

        printRow(iterator, true, true, true, " Итого пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" долгосрочных иных обязательств, ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 411520", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var description = "";

        if (global.reportingPeriodIsVror == false)
            description = "1.2.1.Итого пас.ост., подл. искл. из долгоср. иных об-в(код 411520)";
        else
            description = "1.4.ИТОГО пас. ост.(код - 411520)";
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE, description);
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow3_1_2_1_4217(applicationName : String)
        initTApplicationRow3_4217(applicationName);

        m_code = "1.2.1";
    end;

    constructorTApplicationRow3_1_2_1_4217(applicationName);
end;

// Базовый класс строк Приложения 3 по 5036-У
private class (TApplicationRow2_7_5036) TApplicationRow3_5036(applicationName : String, xlsView)
    private macro constructorTApplicationRow3_5036(applicationName : String, xlsView)
        initTApplicationRow2_7_5036(applicationName, xlsView);
    end;

    constructorTApplicationRow3_5036(applicationName, xlsView);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter2_5036(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = " " + hasAssignedCategory(null, RCB_OBJGROUP_SUBORDINATEDLOAN);
                         ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter3_5036(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = "EXISTS(SELECT 1"
               +"\n"+ "              FROM repMmDeals_vw deals"
               +"\n"+ "             WHERE deals.t_mainRestAccount = account.t_account"
               +"\n"+ "               AND deals.t_fiId = account.t_fiId"
               +"\n"+ "               AND deals.t_isOpened = 1"
               +"\n"+ "               AND " + isNotResident("deals.t_contragentId")
               +"\n"+ "               AND " + isBank("deals.t_contragentId")
               +"\n"+ "               AND " + isMmDealsSubordinated()
               +"\n"+ "           ) "
            ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter4_5036(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = " " + hasAssignedCategory(null, RCB_OBJGROUP_SUBORDINATEDLOAN);
                         ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            +"\n"+ "AND  " + isVnesheconombank("account.t_contractorId")
                     ;
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

// Строка 1 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_5036(applicationName : String, xlsView)
    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов балансовых счетов по учету ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" субординированных кредитов (депозитов,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" займов, облигационных займов) ", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printDescriptionRowExcel(RcbArray().initialize(" Пассивные остатки отдельных лицевых ",
                                                       " счетов балансовых счетов по учету ",
                                                       " субординированных кредитов (депозитов,",
                                                       " займов, облигационных займов) "), true, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки отдельных л/сч б/сч по учету суборд. кредитов", true);
    end;

    private macro constructorTApplicationRow3_1_5036(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1";
    end;

    constructorTApplicationRow3_1_5036(applicationName, xlsView);
end;

//Строка 1.1 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_1_5036(applicationName : String, xlsView)
    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        if (balanceMasks != "")
            balanceMasks = balanceMasks + ",";
        end;

        balanceMasks = balanceMasks + getBalanceMasksForRow("1.1_МБК");

        return balanceMasks;
     end;

    macro fillTempTable(tempTable: TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ_Нерез"));

        if (global.parameters.isMmDealsData())
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_5036(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        else
            tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        end;
    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ_Нерез")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        var iterator = getValueIterator(null, global.parameters.getEndDate(), 1);
        iterator.moveFirst();
        while (not iterator.isDone())
            var balance = iterator.currentItem.fieldValue("balance").exact;
            normalizer.addRelation("C|1 = C|1", "3|1.1|"+balance+" <= 2|1.2|"+balance, "RV");
            iterator.moveNext();
        end;
        normalizer.normalize();
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Юридических лиц-нерезидентов", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printDescriptionRowExcel(" Юридических лиц-нерезидентов", true, true, beginDateInBlock, numberDatesInBlock);

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.1.юридических лиц-нерезидентов");
        else
            exportDescriptionRow("1.1.от юридических лиц-нерезидентов");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_1", this, "ПривлЮЛ_Нерез", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_1_5036(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.1";
    end;

    constructorTApplicationRow3_1_1_5036(applicationName, xlsView);
end;

//Строка 1.1.1 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_1_1_5036(applicationName : String, xlsView)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "314440");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, true, true, true, " Итого пассивных остатков, подлежащих");
        printDescriptionRow(" исключению из долгосрочных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" перед юридическими лицами-нерезидентами,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 314440", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, true, true, true, RcbArray().initialize(" Итого пассивных остатков, подлежащих",
                                                                        " исключению из долгосрочных обязательств",
                                                                        " перед юридическими лицами-нерезидентами,",
                                                                        " код обозначения 314440"));
    end;

    macro exportToKliko()
        var description = "";
        if (global.reportingPeriodIsVror == false)
            description = "1.1.1.Итого пас.ост., подлеж. искл. из долгоср. об-в (код 314440)";
        else
            description = "1.1.1.ИТОГО пас. ост.(код 314440)";
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE, description);
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_2", this, "RV").export();
    end;

    private macro constructorTApplicationRow3_1_1_1_5036(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.1.1";
    end;

    constructorTApplicationRow3_1_1_1_5036(applicationName, xlsView);
end;

//Строка 1.2 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_2_5036(applicationName : String, xlsView)
    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro fillTempTable(tempTable: TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ"));
        tempTable.fill(TBalanceDataSource(TDataSourceFilter4_5036(getBalanceMasksForRow("1.2(1)")), m_code, m_applicationName, "ПривлВЭБ"));
    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлВЭБ")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        var iterator = getValueIterator(null, global.parameters.getEndDate(), 1);
        iterator.moveFirst();
        while (not iterator.isDone())
            var balance = iterator.currentItem.fieldValue("balance").exact;
            if (    (balance != "31309")
                and (balance != "31509")
               )
                normalizer.addRelation("C|1 = C|1", "3|1.2|"+balance+" <= 2|3.2|"+balance, "RV");
            end;
            iterator.moveNext();
        end;
        normalizer.addRelation("C|1 = C|1", "3|1.2|31309 <= 2|3.2|313091", "RV");
        normalizer.addRelation("C|1 = C|1", "3|1.2|31509 <= 2|3.2|315091", "RV");
        normalizer.normalize();
    end;

    macro print(reportWidth: Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Иных юридических лиц: ", TRUE, TRUE, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, FALSE, TRUE, TRUE);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printDescriptionRowExcel(RcbArray().initialize(" Иных юридических лиц: "), TRUE, TRUE, beginDateInBlock, numberDatesInBlock);

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, FALSE, TRUE, TRUE);

    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.2.иных юридических лиц");
        else
            exportDescriptionRow("1.2.Иных юридических лиц:");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлЮЛ",  "RV").export();
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлВЭБ", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_2_5036(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.2";
    end;

    constructorTApplicationRow3_1_2_5036(applicationName, xlsView);
end;

//Строка 1.2.1 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_2_1_5036(applicationName : String, xlsView)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator, "", "411520");
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);

        printRow(iterator, true, true, true, " Итого пассивных остатков,");
        printDescriptionRow(" подлежащих исключению из ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" долгосрочных иных обязательств, ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 411520", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);

        printRowExcel(iterator, true, true, true, RcbArray().initialize(" Итого пассивных остатков,",
                                                                        " подлежащих исключению из ",
                                                                        " долгосрочных иных обязательств, ",
                                                                        " код обозначения 411520"));
    end;

    macro exportToKliko()
        var description = "";

        if (global.reportingPeriodIsVror == false)
            description = "1.2.1.Итого пас.ост., подл. искл. из долгоср. иных об-в(код 411520)";
        else
            description = "1.4.ИТОГО пас. ост.(код - 411520)";
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE, description);
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR3_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow3_1_2_1_5036(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.2.1";
    end;

    constructorTApplicationRow3_1_2_1_5036(applicationName, xlsView);
end;

// 5087-У, наследование от 5036-У
private class (TDataSourceFilter_5036) TDataSourceFilter1_5087(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = "EXISTS(SELECT 1"
               +"\n"+ "              FROM repMmDeals_vw deals"
               +"\n"+ "             WHERE deals.t_mainRestAccount = account.t_account"
               +"\n"+ "               AND deals.t_fiId = account.t_fiId"
               +"\n"+ "               AND deals.t_isOpened = 1"
               +"\n"+ "               AND " + isMmDealsSubordinated()
               +"\n"+ "               AND NOT" + isMmDealstNotInCapital()
               +"\n"+ "               AND " + isMmDealsSubordinateDateLessOrEqualReportDate()
               +"\n"+ "           ) "
            ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter2_5087(balanceMasks : String, exclusionFilter : String)
    private var m_exclusionFilter = exclusionFilter;

    macro makePartDateFilter()
        // установлена категория "Субординированный кредит" с любым значением, кроме "СК не включается в капитал"
        m_partDateFilter = " " + hasNoAssignedCategory("СК не включается в капитал", RCB_OBJGROUP_SUBORDINATEDLOAN)
                    +"\n"+ "AND " + hasAssignedCategory(null, RCB_OBJGROUP_SUBORDINATEDLOAN)
                    +"\n"+ "AND (   " + isEmployer("account.t_contractorId")
                    +"\n"+ "     OR " + isBank("account.t_contractorId")
                    +"\n"+ "     OR " + isJuridicalPerson("account.t_contractorId")
                    +"\n"+ "    )"
                    +"\n"+ "AND " + isResident("account.t_contractorId")
                    +"\n"+ m_exclusionFilter
                         ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                     ;
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter3_5087(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = "EXISTS(SELECT 1"
               +"\n"+ "              FROM repMmDeals_vw deals"
               +"\n"+ "             WHERE deals.t_mainRestAccount = account.t_account"
               +"\n"+ "               AND deals.t_fiId = account.t_fiId"
               +"\n"+ "               AND deals.t_isOpened = 1"
               +"\n"+ "               AND " + isNotResident("deals.t_contragentId")
               +"\n"+ "               AND " + isBank("deals.t_contragentId")
               +"\n"+ "               AND " + isMmDealsSubordinated()
               +"\n"+ "               AND NOT" + isMmDealstNotInCapital()
               +"\n"+ "               AND " + isMmDealsSubordinateDateLessOrEqualReportDate()
               +"\n"+ "           ) "
            ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance");
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

//Строка 1.1 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_1_5087(applicationName : String, xlsView)
    macro getBalanceMasks()
        var balanceMasks = getBalanceMasksForRow(m_code);

        if (balanceMasks != "")
            balanceMasks = balanceMasks + ",";
        end;

        balanceMasks = balanceMasks + getBalanceMasksForRow("1.1_МБК");

        return balanceMasks;
     end;

    macro fillTempTable(tempTable: TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036(getBalanceMasksForRow(m_code)), m_code, m_applicationName, "ПривлЮЛ_Нерез"));

        if (global.parameters.isMmDealsData())
            tempTable.fill(TBalanceDataSource(TDataSourceFilter3_5087(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        else
            tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036(getBalanceMasksForRow("1.1_МБК")), m_code, m_applicationName, "ПривлЮЛ_Нерез"));
        end;
    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ_Нерез")));

            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        var iterator = getValueIterator(null, global.parameters.getEndDate(), 1);
        iterator.moveFirst();
        while (not iterator.isDone())
            var balance = iterator.currentItem.fieldValue("balance").exact;
            normalizer.addRelation("C|1 = C|1", "3|1.1|"+balance+" <= 2|1.2|"+balance, "RV");
            iterator.moveNext();
        end;
        normalizer.normalize();
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Юридических лиц-нерезидентов", true, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printDescriptionRowExcel(" Юридических лиц-нерезидентов", true, true, beginDateInBlock, numberDatesInBlock);

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.1.юридических лиц-нерезидентов");
        else
            exportDescriptionRow("1.1.от юридических лиц-нерезидентов");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_1", this, "ПривлЮЛ_Нерез", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_1_5087(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.1";
    end;

    constructorTApplicationRow3_1_1_5087(applicationName, xlsView);
end;

//Строка 1.2 Приложения 3
class (TApplicationRow3_5036) TApplicationRow3_1_2_5087(applicationName : String, xlsView)
    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro fillTempTable(tempTable: TTempTable)
        var exclusionFilter = "";
        if (global.parameters.isMmDealsData())
            var filter = TDataSourceFilter1_5087(getBalanceMasksForRow("1.2(1)_МБК"));
            tempTable.fill(TBalanceDataSource(filter, m_code, m_applicationName, "ПривлЮЛ"));
            exclusionFilter = exclusionFilter + "AND NOT (" + filter.getSqlDateFilter() + ")";
        end;
		var rowMasks = getBalanceMasksForRow(m_code);
		var mbkMasks = getBalanceMasksForRow("1.2(1)_МБК");
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5087(rowMasks + ternary(((rowMasks != "") and (mbkMasks != "")) , ",", "") + mbkMasks, exclusionFilter), m_code, m_applicationName, "ПривлЮЛ"));
        tempTable.fill(TBalanceDataSource(TDataSourceFilter4_5036(getBalanceMasksForRow("1.2(1)")), m_code, m_applicationName, "ПривлВЭБ"));
    end;

    macro saveAttributes()
        var dataSet : Object = null;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлЮЛ")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ПривлВЭБ")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date,
                                   dataSet.roubleRest, dataSet.currencyRest,
                                   dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        var iterator = getValueIterator(null, global.parameters.getEndDate(), 1);
        iterator.moveFirst();
        while (not iterator.isDone())
            var balance = iterator.currentItem.fieldValue("balance").exact;
            if (    (balance != "31309")
                and (balance != "31509")
               )
                normalizer.addRelation("C|1 = C|1", "3|1.2|"+balance+" <= 2|3.2|"+balance, "RV");
            end;
            iterator.moveNext();
        end;
        normalizer.addRelation("C|1 = C|1", "3|1.2|31309 <= 2|3.2|313091", "RV");
        normalizer.addRelation("C|1 = C|1", "3|1.2|31509 <= 2|3.2|315091", "RV");
        normalizer.normalize();
    end;

    macro print(reportWidth: Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Иных юридических лиц: ", TRUE, TRUE, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, FALSE, TRUE, TRUE);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printDescriptionRowExcel(RcbArray().initialize(" Иных юридических лиц: "), TRUE, TRUE, beginDateInBlock, numberDatesInBlock);

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, FALSE, TRUE, TRUE);

    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror == false)
            exportDescriptionRow("1.2.иных юридических лиц");
        else
            exportDescriptionRow("1.2.Иных юридических лиц:");
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлЮЛ",  "RV").export();
        TPtkPsdBalanceGroupExporter("OR3_3", this, "ПривлВЭБ", "RV").export();
    end;

    private macro constructorTApplicationRow3_1_2_5087(applicationName : String, xlsView)
        initTApplicationRow3_5036(applicationName, xlsView);

        m_code = "1.2";
    end;

    constructorTApplicationRow3_1_2_5087(applicationName, xlsView);
end;
