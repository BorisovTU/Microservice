/*
$Name:          TBeginDataController.mac
$Module:        Регламентируемая отчетность
$Description:   ФОР. Класс контроля исходных данных
*/

class TBeginDataController(appNumber)

    private var m_protocolView;
    private var m_table;
    private var m_appNumber = appNumber;
    private var m_currentAccount;
    private var m_maturityDateTable;

    private macro initialize()
        m_protocolView = TProtocolView("ПРОТОКОЛ КОНТРОЛЯ ИСХОДНЫХ ДАННЫХ ПРИЛОЖЕНИЯ " + m_appNumber);

        m_table = CTableReport();
        m_table.addColumn("Строка приложения",                                20, AL_LEFT);
        m_table.addColumn("Лицевой счет",                                     30, AL_LEFT);
        m_table.addColumn("Признак л/счета",                                  60, AL_LEFT);
        m_table.addColumn("Дата начала |действия примечания |(категории)",    14, AL_LEFT);
        m_table.addColumn("Дата окончания |действия примечания |(категории)", 14, AL_LEFT);
        m_table.addColumn("Значение признака л/счета",                        20, AL_LEFT);

        m_maturityDateTable = CTableReport();
        m_maturityDateTable.addColumn("Строка приложения",                    20, AL_LEFT);
        m_maturityDateTable.addColumn("Строка настр.табл. или б/с",           20, AL_LEFT);
        m_maturityDateTable.addColumn("Лицевой счет",                         30, AL_LEFT);

        m_currentAccount = "";
    end;

    private macro getDataSetForApplication()
        if (m_appNumber == 2)
            return TInputControlForApplication2DataSource().getDataSet();
        elif (m_appNumber == 3)
            return TInputControlForApplication3DataSource().getDataSet();
        elif (m_appNumber == 4)
            return TInputControlForApplication4DataSource().getDataSet();
        elif (m_appNumber == 6)
            return TInputControlForApplication6DataSource().getDataSet();
        end;
    end;

    private macro printString(currentRecord, isFirst)

        var tempIsFirst    = isFirst;
        var currentAccount = "";
        var currentRow     = "";

        if (currentRecord.account != m_currentAccount)
            m_currentAccount = currentRecord.account;
            currentAccount   = currentRecord.account;
            currentRow       = currentRecord.row;
        end;

        if ((m_appNumber == 2) OR (m_appNumber == 4) OR (m_appNumber == 6))
            if(not tempIsFirst)
                m_table.printSeparator();
            end;
            m_table.PrintStringTransferByWord(currentRow, currentAccount, currentRecord.category,
                                              Date(currentRecord.fromDate), Date(currentRecord.toDate), currentRecord.value);
        elif (m_appNumber == 3)
            if (currentRecord.valueType == 1)
                if (NOT tempIsFirst)
                    m_table.printSeparator();
                end;

                m_table.PrintStringTransferByWord(currentRow,
                                                  currentAccount,
                                                  "Категория \"" + currentRecord.category + "\"",
                                                  Date(currentRecord.fromDate),
                                                  Date(currentRecord.toDate),
                                                  currentRecord.value);
                tempIsFirst = false;
            elif (currentRecord.valueType == 2)
                if (NOT tempIsFirst)
                    m_table.printSeparator();
                end;
                m_table.PrintStringTransferByWord(currentRow,
                                                  currentAccount,
                                                  "Примечание \"" + currentRecord.category + "\"",
                                                  Date(currentRecord.fromDate),
                                                  Date(currentRecord.toDate),
                                                  Date(currentRecord.valueDate));
                tempIsFirst = false;
            elif (currentRecord.valueType == 3)
                if (NOT tempIsFirst)
                    m_table.printSeparator();
                end;
                m_table.PrintStringTransferByWord(currentRow,
                                                  currentAccount,
                                                  "Примечание \"" + currentRecord.category + "\"",
                                                  Date(currentRecord.fromDate),
                                                  Date(currentRecord.toDate),
                                                  currentRecord.valueMoney);
                tempIsFirst = false;
            end;
        end;
    end;

    private macro executeControlForApplication()
        //выводим название приложения (получаем из заголовка путем удаления переводов строки)
        m_protocolView.printLine("ПРИЛОЖЕНИЕ " + m_appNumber + " \"" + StrSubst(global.getAppTitle(m_appNumber), "\n", " ") + "\"");

        var dataSet = getDataSetForApplication();

        var  isFirst = true;

        while (dataSet.moveNext())
            if(isFirst)
                m_table.printHead();
                printString(dataSet, isFirst);
                isFirst = false;
            else
                printString(dataSet, isFirst);
            end;

        end;

        if(isFirst)
            m_protocolView.printLine("Нет данных.");
        else
            m_table.PrintBottom();
        end;
    end;

    macro execute()

        m_protocolView.setProtocolOutput(false);
        m_protocolView.printHead();

        executeControlForApplication();

        m_protocolView.resetProtocolOutput();
        m_protocolView.show();
    end;

    initialize();
end;

class (TBeginDataController) TBeginDataControllerI2963(appNumber)
    initTBeginDataController(appNumber);

    private macro getDataSetForApplication()
        if (m_appNumber == 2)
            return TInputControlForApplication2DataSourceI2963().getDataSet();
        elif (m_appNumber == 3)
            return TInputControlForApplication3DataSource().getDataSet();
        elif (m_appNumber == 6)
            return TInputControlForApplication6DataSource().getDataSet();
        end;
    end;
end;

class (TBeginDataController) TBeginDataControllerI4217(appNumber)
    private var m_mmDealsDateTable = CTableReport();
    m_mmDealsDateTable.addColumn("Строка приложения",      10, AL_LEFT);
    m_mmDealsDateTable.addColumn("Строка НТ",              10, AL_LEFT);
    m_mmDealsDateTable.addColumn("Номер б/с",              10, AL_LEFT);
    m_mmDealsDateTable.addColumn("№ лицевого счета",       30, AL_LEFT);
    m_mmDealsDateTable.addColumn("Валюта",                 8, AL_CENTER);
    m_mmDealsDateTable.addColumn("Остаток счета в рублях", 20, AL_RIGHT);
    m_mmDealsDateTable.addColumn("Дата открытия счета",    14, AL_CENTER);
    m_mmDealsDateTable.addColumn("Номер сделки МБК",       20, AL_LEFT);
    m_mmDealsDateTable.addColumn("Контрагент по сделке",   40, AL_LEFT);
    m_mmDealsDateTable.addColumn("Признак сделки",         40, AL_LEFT);

    initTBeginDataController(appNumber);

    private macro getDataSetForMaturityDate()
        if (m_appNumber == 2)
            return TRsbDataSet(TInputControlForApplication2DataSourceI4217().getMaturityDateQuery());
        elif (m_appNumber == 4)
            return TRsbDataSet(TInputControlForApplication4DataSource().getMaturityDateQuery());
        else
            return NULL;
        end;
    end;

    private macro getDataSetForMmDealsDate()
        if (m_appNumber == 2)
            return TRsbDataSet(TInputControlForApplication2DataSourceI4217().getMmDealsDateQuery());
        elif (m_appNumber == 3)
            return TRsbDataSet(TInputControlForApplication3DataSourceI4217().getMmDealsDateQuery());
        else
            return NULL;
        end;
    end;

    private macro printStringForMaturityDate(currentRecord, isFirst)
        m_maturityDateTable.PrintStringTransferByWord(currentRecord.row, currentRecord.masks, currentRecord.account);
    end;

    private macro executeControlForApplication()
        //выводим название приложения (получаем из заголовка путем удаления переводов строки)
        m_protocolView.printLine("ПРИЛОЖЕНИЕ " + m_appNumber + "  Список лицевых счетов, на которых не установлено примечание \" Дата погашения\"", "\n", " ");

        var dataSet = getDataSetForMaturityDate();

        if (dataSet != NULL)
            var  isFirst = true;

            while (dataSet.moveNext())
                if(isFirst)
                    m_maturityDateTable.printHead();
                    printStringForMaturityDate(dataSet, isFirst);
                    isFirst = false;
                else
                    printStringForMaturityDate(dataSet, isFirst);
                end;

            end;

            if(isFirst)
                m_protocolView.printLine("Нет данных.");
            else
                m_maturityDateTable.PrintBottom();
            end;
        end;

        if (global.parameters.isMmDealsData())

            dataSet = getDataSetForMmDealsDate();

            if (dataSet != NULL)
                isFirst = true;
                var noteDeals;
                m_protocolView.printLine("ПРИЛОЖЕНИЕ " + m_appNumber + " Данные МБК", "\n", " ");

                while (dataSet.moveNext())
                    if(isFirst)
                        m_mmDealsDateTable.printHead();
                        isFirst = false;
                    end;

                    if (m_appNumber == 2)
                        noteDeals = "Срок с учетом пролонгаций = " + dataSet.term;
                    elif (m_appNumber == 3)
                        noteDeals = "Для сделки установлен флаг \"Субординированный кредит/депозит\"";
                    else
                        noteDeals = "";
                    end;

                    m_mmDealsDateTable.PrintStringTransferByWord(dataSet.row,
                                                                 dataSet.ttRow,
                                                                 dataSet.balance,
                                                                 dataSet.account,
                                                                 dataSet.codeCurrency,
                                                                 dataSet.rest,
                                                                 date(dataSet.openDate),
                                                                 dataSet.dealNumber,
                                                                 dataSet.contragent,
                                                                 noteDeals);
                end;

                if(isFirst)
                    m_protocolView.printLine("Нет данных.");
                else
                    m_mmDealsDateTable.PrintBottom();
                end;
            end;
        end;

        executeControlForApplication();
    end;

    private macro getDataSetForApplication()
        if (m_appNumber == 2)
            return TInputControlForApplication2DataSourceI4217().getDataSet();
        elif (m_appNumber == 3)
            return TInputControlForApplication3DataSourceI4217().getDataSet();
        elif (m_appNumber == 4)
            return TInputControlForApplication4DataSource().getDataSet();
        elif (m_appNumber == 6)
            return TInputControlForApplication6DataSourceI4217().getDataSet();
        end;
    end;
end;

class (TBeginDataController) TBeginDataControllerI5036(appNumber)
    private var m_mmDealsDateTable = CTableReport();
    m_mmDealsDateTable.addColumn("Строка приложения",      10, AL_LEFT);
    m_mmDealsDateTable.addColumn("Строка НТ",              10, AL_LEFT);
    m_mmDealsDateTable.addColumn("Номер б/с",              10, AL_LEFT);
    m_mmDealsDateTable.addColumn("№ лицевого счета",       30, AL_LEFT);
    m_mmDealsDateTable.addColumn("Валюта",                 8, AL_CENTER);
    m_mmDealsDateTable.addColumn("Остаток счета в рублях", 20, AL_RIGHT);
    m_mmDealsDateTable.addColumn("Дата открытия счета",    14, AL_CENTER);
    m_mmDealsDateTable.addColumn("Номер сделки МБК",       20, AL_LEFT);
    m_mmDealsDateTable.addColumn("Контрагент по сделке",   40, AL_LEFT);
    m_mmDealsDateTable.addColumn("Признак сделки",         40, AL_LEFT);

    initTBeginDataController(appNumber);

    private macro getDataSetForMaturityDate()
        if (m_appNumber == 2)
            return TRsbDataSet(TInputControlForApplication2DataSourceI5036().getMaturityDateQuery());
        elif (m_appNumber == 4)
            return TRsbDataSet(TInputControlForApplication4DataSource().getMaturityDateQuery());
        else
            return NULL;
        end;
    end;

    private macro getDataSetForMmDealsDate()
        if (m_appNumber == 2)
            return TRsbDataSet(TInputControlForApplication2DataSourceI5036().getMmDealsDateQuery());
        elif (m_appNumber == 3)
            return TRsbDataSet(TInputControlForApplication3DataSourceI4217().getMmDealsDateQuery());
        else
            return NULL;
        end;
    end;

    private macro printStringForMaturityDate(currentRecord, isFirst)
        m_maturityDateTable.PrintStringTransferByWord(currentRecord.row, currentRecord.masks, currentRecord.account);
    end;

    private macro executeControlForApplication()
        //выводим название приложения (получаем из заголовка путем удаления переводов строки)
        m_protocolView.printLine("ПРИЛОЖЕНИЕ " + m_appNumber + "  Список лицевых счетов, на которых не установлено примечание \" Дата погашения\"", "\n", " ");

        var dataSet = getDataSetForMaturityDate();

        if (dataSet != NULL)
            var  isFirst = true;

            while (dataSet.moveNext())
                if(isFirst)
                    m_maturityDateTable.printHead();
                    printStringForMaturityDate(dataSet, isFirst);
                    isFirst = false;
                else
                    printStringForMaturityDate(dataSet, isFirst);
                end;

            end;

            if(isFirst)
                m_protocolView.printLine("Нет данных.");
            else
                m_maturityDateTable.PrintBottom();
            end;
        end;

        if (global.parameters.isMmDealsData())

            dataSet = getDataSetForMmDealsDate();

            if (dataSet != NULL)
                isFirst = true;
                var noteDeals;
                m_protocolView.printLine("ПРИЛОЖЕНИЕ " + m_appNumber + " Данные МБК", "\n", " ");

                while (dataSet.moveNext())
                    if(isFirst)
                        m_mmDealsDateTable.printHead();
                        isFirst = false;
                    end;

                    if (m_appNumber == 2)
                        noteDeals = "Срок с учетом пролонгаций = " + dataSet.term;
                    elif (m_appNumber == 3)
                        noteDeals = "Для сделки установлен флаг \"Субординированный кредит/депозит\"";
                    else
                        noteDeals = "";
                    end;

                    m_mmDealsDateTable.PrintStringTransferByWord(dataSet.row,
                                                                 dataSet.ttRow,
                                                                 dataSet.balance,
                                                                 dataSet.account,
                                                                 dataSet.codeCurrency,
                                                                 dataSet.rest,
                                                                 date(dataSet.openDate),
                                                                 dataSet.dealNumber,
                                                                 dataSet.contragent,
                                                                 noteDeals);
                end;

                if(isFirst)
                    m_protocolView.printLine("Нет данных.");
                else
                    m_mmDealsDateTable.PrintBottom();
                end;
            end;
        end;

        executeControlForApplication();
    end;

    private macro getDataSetForApplication()
        if (m_appNumber == 2)
            return TInputControlForApplication2DataSourceI5036().getDataSet();
        elif (m_appNumber == 3)
            return TInputControlForApplication3DataSourceI4217().getDataSet();
        elif (m_appNumber == 4)
            return TInputControlForApplication4DataSourceI5036().getDataSet();
        elif (m_appNumber == 6)
            return TInputControlForApplication6DataSourceI4217().getDataSet();
        end;
    end;
end;
