/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Классы строк приложения7 ФОР

  Создан: 20.04.2007 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/***************************************************************************************************
 *  Класc строки 1 приложения7
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow7_1(applicationName : String)
    initTApplicationRow2_7(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter7_1(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " " + hasAssignedCategory()
            ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "1";
    end;


    macro getFilter()
        return TDataSourceFilter7_1(getBalanceMasksForRow(m_code), "N");
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(this.getFilter(), m_code, m_applicationName, "ФОР", true));
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR7_1", this, "ФОР", "RV").export();
    end;

    macro exportToKliko()
        global.klikoExportFile.printID("<F_P7>");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету обязательств, выраженных", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" в не денежной форме, балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 2 приложения7
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow7_2(applicationName : String)
    initTApplicationRow2_7(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter7_2(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " NOT " + hasAssignedCategory("N")
                +"\n"+ "AND NOT " + hasAssignedCategory("Строка2.2")
                +"\n"+ "AND  ((" + isBank("account.t_clientCode")
                +"\n"+ "       AND  NOT " + isNotResident("account.t_clientCode")
                +"\n"+ "       AND  NOT " + isClientBankWithValidLicense("account.t_clientCode")
                +"\n"+ "       AND  NOT " + isClientInDepartmentReference("account.t_clientCode") + ")"
                +"\n"+ " OR  " + hasNotResidentBankOperationContragent2("account.t_account", "account.t_fiId", "account.t_chapter") + ")"
            ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                ;
        end;
        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "2";
    end;


    macro getFilter()
        return TDataSourceFilter7_2(getBalanceMasksForRow(m_code));
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(this.getFilter(), m_code, m_applicationName, "ФОР", true));
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR7_3", this, "ФОР", "RV").export();
    end;

    macro exportToKliko()
        global.klikoExportFile.printID("<F_P7_1>");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету обязательств перед", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" другой кредитной организацией,", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" зарегистрированной в установленном", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" порядке и действующей кредитной ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" организацией, зарегистрированной на", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" основании выданной Банком России", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" лицензии на осуществление банковских", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" операций, Внешэкономбанком, а также", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Банком России, возникающих в результате", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" заключения договоров, балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    constructor();
end;

/***************************************************************************************************
 *  Класc строки 3 приложения7
 **************************************************************************************************/
class (TApplicationRow2_7) TApplicationRow7_3(applicationName : String)
    initTApplicationRow2_7(applicationName);

    local class (TDataSourceFilter) TDataSourceFilter7_3(balanceMasks : String, category : String)
        macro makePartDateFilter()
            m_partDateFilter = " NOT " + hasAssignedCategory()
            ;
        end;

        macro makePartFilter()
            m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
                +"\n"+ "AND  ((    NOT " + isExistsOperationContragent("account.t_account", "account.t_fiId", "account.t_chapter")
                +"\n"+ "       AND NOT " + isDepartmentOwnFunds("account.t_clientCode", "account.t_account")
                +"\n"+ "       AND " + isClientInDepartmentReference("account.t_clientCode") + ")"
                +"\n"+ "           OR   " + hasNotResidentBankOperationContragent3("account.t_account", "account.t_fiId", "account.t_chapter") + ")";
        end;

        initTDataSourceFilter(balanceMasks, category);
    end;

    private macro constructor()
        m_code = "3";
    end;

    macro getFilter()
        return TDataSourceFilter7_3(getBalanceMasksForRow(m_code), "N");
    end;

    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(this.getFilter(), m_code, m_applicationName, "ФОР", true));
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "ФОР")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest);
            end;
        end;
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR7_5", this, "ФОР", "RV").export();
    end;

    macro exportToKliko()
        global.klikoExportFile.printID("<F_P7_2>");
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету обязательств  между", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" обособленными подразделениями кредитной", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" организации, балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    constructor();
end;
