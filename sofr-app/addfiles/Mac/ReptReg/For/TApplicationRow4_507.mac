/*
$Name:          TApplicationRow4_507.mac
$Module:        Регламентируемая отчетность
$Description:   Классы строк Приложения4 ФОР по 507-П
*/

/***************************************************************************************************
 *  Класc строки 1 приложения4
 **************************************************************************************************/
class (TApplicationRow4) TApplicationRow507_4_1(applicationName : String)
    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro getDecodingBalanceMasks()
        return "52005";
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForDifferenceBalanceWithMasks(getBalanceMasksForRow(m_code),
                                                                  TBalanceId("Приложение2", "3", "ЮЛ"),
                                                                  TBalanceId("Приложение6", "1", "ФОР"),
                                                                  TBalanceId("Приложение6", "2", "ФОР"),
                                                                  TBalanceId("Приложение6", "3", "ФОР")));

            while (dataSet.moveNext())
                saveAttributeValue("СобствЦб", dataSet.balance, dataSet.date, dataSet.roubleRest, dataSet.currencyRest,  dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForDifferenceBalance(TBalanceId("Приложение2", "3", "ЮЛ", "52005"),
                                                                  TBalanceId("Приложение2", "3.2", "расшифровка", "520051")));
            while (dataSet.moveNext())
                saveAttributeValue("расшифровка", "52005(2)", dataSet.date, dataSet.roubleRest, dataSet.currencyRest,  dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки отдельных лицевых", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" счетов по учету выпущенных ценных", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" бумаг балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (global.reportingPeriodIsVror)
            exportDescriptionRow("1.Пассивные остатки по учету выпущенных цен. бумаг бал.сч.:", true);
        else
            exportDescriptionRow("1.Пассивные остатки по учету выпущенных ценных бумаг балансовых счетов:", true);
        end;

        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR4_1", this, "СобствЦб", "RV").export();

        TPtkPsdDecodingExporter("OR4_1", this, "RV", "52005(2)").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_4_1(applicationName : String)
        initTApplicationRow4(applicationName);

        m_code = "1";
    end;

    constructorTApplicationRow507_4_1(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 1.1 приложения4
 **************************************************************************************************/
class (TApplicationRow4) TApplicationRow507_4_1_1(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Итого");
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);
        exportValueRow(iterator, "1.1.ИТОГО");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_2", this, "RV").export();
    end;

    macro getExportCode()
        return getCode();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_4_1_1(applicationName : String)
        initTApplicationRow4(applicationName);

        m_code = "1.1";
    end;

    constructorTApplicationRow507_4_1_1(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 2 приложения4
 **************************************************************************************************/
class (TApplicationRow4) TApplicationRow507_4_2(applicationName : String)
    macro saveAttributes()
        var value : Double = global.parameters.getReservation().getCorrectiveCoefficient();
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            saveAttributeValue("Коэффициент", "", Date(0,0,0), value, value);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        macro formatting(v)
            v = String(v:0:9);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var i = getValueIterator();
        var value = 0.0;
        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printSingleValueRow(formatting(value), " Корректировочный коэффициент (3)", reportWidth, true);
    end;

    macro exportToKliko()
        var i = getValueIterator();
        var value = 0.0;

        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;

        exportSingleValueRow("2.Корректировочный коэффициент", String(value:0:4));
    end;

    macro exportToPtkPsd()
        TPtkPsdCoefficientExporter("OR4_2", this, "R").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_4_2(applicationName : String)
        initTApplicationRow4(applicationName);

        m_code = "2";
    end;

    constructorTApplicationRow507_4_2(applicationName);
end;

/***************************************************************************************************
 *  Класc строки 3 приложения4
 **************************************************************************************************/
class (TApplicationRow4) TApplicationRow507_4_3(applicationName : String)
    macro saveAttributes()
        var correctiveCoefficient  = global.parameters.getReservation().getCorrectiveCoefficient();
        var iterator;
        var compositeValue;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("", "", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").exact * correctiveCoefficient,
                                   compositeValue.fieldValue("roubleRest").scaled  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").scaled * correctiveCoefficient);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Всего остатков, подлежащих");
        printDescriptionRow(" исключению из обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (строка 1.1 х корректировочный", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" коэффициент),", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 520524", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        var iterator = getValueIterator(NULL);
        iterator.setSortOrder(SORTER_FOR_DATE);
        exportValueRow(iterator, "3.ВСЕГО остатков (стр1.1 * коррект.коэф.) код  - 520524");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_2", this, "RV").export();
    end;

    macro constructor()
    end;

    private macro constructorTApplicationRow507_4_3(applicationName : String)
        initTApplicationRow4(applicationName);

        m_code = "3";
    end;

    constructorTApplicationRow507_4_3(applicationName);
end;

// Базовый класс строк Приложения 4 по 4217-У
private class (TApplicationRow2_7_4217) TApplicationRow4_4217(applicationName : String)
    private macro exportValueRowExt(iterator : Object, description : String, isPrintRouble : Bool, isPrintCurrency : Bool)
        var valueArray     : Object = getArrayExt(0, isPrintRouble, isPrintCurrency);
        var isFirst        : Bool   = true;
        var currentBalance : String = "no balance";
        var compositeValue : Object = NULL;

        var lastCurrencyValue = "";
        var lastRoubleValue   = "";

        var i : Integer = 0;
        iterator.moveFirst();
        while (not iterator.isDone)
            compositeValue = iterator.currentItem;
            if (currentBalance != global.exportBalanceProcessor.getBalanceNumber(compositeValue))
                if (not isFirst)
                    global.klikoExportFile.printString(valueArray);
                end;
                isFirst = false;
                currentBalance = global.exportBalanceProcessor.getBalanceNumber(compositeValue);
                valueArray = getArrayExt(0, isPrintRouble, isPrintCurrency);
                i = 0;
                if (description == NULL)
                    valueArray[i] = currentBalance + "\",\"";
                else
                    valueArray[i] = description;
                end;
                i = i + 1;
                valueArray[i] = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");

                i = i + 1;
                valueArray[i] = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");
            else
                valueArray[i] = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");

                i = i + 1;
                valueArray[i] = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");
            end;

            lastRoubleValue   = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");
            lastCurrencyValue = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");

            iterator.moveNext();
            i = i + 1;
        end;

        if (iterator.count > 0)
            global.klikoExportFile.printString(valueArray);
        end;

        if ((iterator.count == 0) and (description != NULL))
            valueArray[0] = description;
            global.klikoExportFile.printString(valueArray);
        end;
    end;

    private macro exportValueRow(iterator : Object, description : String)
        if (description != null)
            description = description + "\",\"";
        end;
        exportValueRowExt(iterator, description, true, true);
    end;

    /* Функционал экспорта в ПТК ПСД*/
    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_4217(applicationName : String)
        initTApplicationRow2_7_4217(applicationName);
    end;

    constructorTApplicationRow4_4217(applicationName);
end;

private class (TDataSourceFilter_4217) TDataSourceFilter1(balanceMasks : String, category : String)
    macro makePartDateFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND NOT (" + application6Filter + ")"
                         ;
    end;

    macro makePartFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + ")";

        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            +"\n"+ "AND  " + isTermLessThreeYears("account.t_account", "account.t_fiId", "account.t_chapter")
            +"\n"+ "AND  NOT (" + application6Filter + ")"
            ;
    end;

    initTDataSourceFilter_4217(balanceMasks, category);
end;

private class (TDataSourceFilter_4217) TDataSourceFilter2(balanceMasks : String, category : String)
    macro makePartDateFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND NOT (" + application6Filter + ")"
                         + "\n" + "AND " + hasNoAssignedCategory()
                         ;
    end;

    macro makePartFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + ")";

        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            +"\n"+ "AND  " + isTermEqualThreeYears("account.t_account", "account.t_fiId", "account.t_chapter")
            +"\n"+ "AND  NOT (" + application6Filter + ")"
            ;
    end;

    initTDataSourceFilter_4217(balanceMasks, category);
end;

private class (TDataSourceFilter_4217) TDataSourceFilter3(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND " + hasNoAssignedCategory("507-П пункт 2.5.6_1")
                         + "\n" + "AND " + hasNoAssignedCategory(null, 25) // Субординированный кредит
                         ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            ;
    end;

    initTDataSourceFilter_4217(balanceMasks);
end;

// Строка 1 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_1_4217(applicationName : String)
    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки (либо их часть) ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" отдельных лицевых счетов по учету ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" выпущенных ценных бумаг", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки (либо их часть) отдельных л/сч по учету выпущенных ценных бумаг балансовых счетов", true);
    end;

    private macro constructorTApplicationRow4_1_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "1";
    end;

    constructorTApplicationRow4_1_4217(applicationName);
end;

// Строка 1.1 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_1_1_4217(applicationName : String)
    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter1("52005"), m_code, m_applicationName, "Расш"));
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro getDecodingBalanceMasks()
        return "520051";
    end;

    private macro getDeleterFilter()
        class TFilter()
            macro isSuitable(v : Object) : Bool
                return (    (v.fieldValue("row").exactAsString == "1.1")
                        and (v.fieldValue("balanceGroup").exactAsString == "СобствЦб")
                       );
            end;
        end;

        return TFilter();
    end;

    macro saveAttributes()
        class TFilter(balanceMasks)
            private const m_balanceMasks = balanceMasks;
            macro isSuitable(v : Object)
                return (    (v.fieldValue("row").exactAsString == "3.1")
                        and (v.fieldValue("balanceGroup").exactAsString == "ЮЛ")
                        and (compareStrWithMasks(m_balanceMasks, v.fieldValue("balance").exactAsString) == 0)
                       );
            end;
        end;

        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator("Приложение2", NULL);
            iterator.setFilter(TFilter(getBalanceMasks()));
            iterator.setSortOrder(SORTER_FOR_DATE);
            iterator.moveFirst();
            while (not iterator.isDone())
                var compositeValue = iterator.currentItem();
                saveAttributeValue("СобствЦб", compositeValue.fieldValue("balance").exactAsString,
                                               Date(trim(compositeValue.fieldValue("date").exact)),
                                               compositeValue.fieldValue("roubleRest").exact,
                                               compositeValue.fieldValue("currencyRest").exact,
                                               compositeValue.fieldValue("roubleRest").scaled,
                                               compositeValue.fieldValue("currencyRest").scaled
                                  );
                iterator.moveNext();
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "Расш")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, getDecodingBalanceMasks(), dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        normalizer.addRelation("C|1 = C|1", "4|1.1|520051 = 2|3.1|520051", "RV");
        normalizer.normalize();
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" В части иных обязательств (за", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" исключением долгосрочных)", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (not global.reportingPeriodIsVror)
            exportDescriptionRow("1.1.В части иных обязательств (за исключением долгосрочных)", true);
        else
            exportDescriptionRow("1.1.Пассивные остатки по учету выпущенных цен. бумаг бал.сч.:", true);
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR4_1", this, "СобствЦб", "RV").export();
        TPtkPsdBalanceGroupExporter("OR4_1", this, "Расш",     "RV").export();
    end;

    private macro constructorTApplicationRow4_1_1_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "1.1";
    end;

    constructorTApplicationRow4_1_1_4217(applicationName);
end;

// Строка 1.1.1 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_1_1_1_4217(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Итого (сумма остатков по строке 1.1)");
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "1.1.1.Итого (сумма остатков по строке 1.1)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_2", this, "RV").export();
    end;

    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_1_1_1_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "1.1.1";
    end;

    constructorTApplicationRow4_1_1_1_4217(applicationName);
end;

// Строка 1.2 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_1_2_4217(applicationName : String)
    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2("52005", "507-П пункт 2.5.6_1"), m_code, m_applicationName, "520052 (2)"));
        tempTable.fill(TBalanceDataSource(TDataSourceFilter3("52006"), m_code, m_applicationName, "52006 (3)"));
    end;

//    macro fillTempTableForBalanceData(tempTable : TTempTable)
//        fillTempTable(tempTable);
//
//        var dataSet = getBalanceDataSet("52006");
//
//        updateTempTable(dataSet, "52006 (3)");
//    end;

    macro updateBalanceValues()
        var dataSet = getBalanceDataSet("52006");

        updateBalanceValue(dataSet, "52006 (3)");
    end;

    macro getBalanceMasks()
        return "52006";
    end;

    macro getDecodingBalanceMasks()
        return "520052";
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "520052 (2)")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, "520052 (2)", dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "52006 (3)")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, "52006 (3)", dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" В части долгосрочных иных ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "520052 (2)");
        printRow(iterator, false, true, true);
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        normalizer.addRelation("C|1 = C|1", "4|1.2|520052 = 2|3.2|520052 - 2|3.2.2|520053", "RV");
        normalizer.addRelation("C|1 = C|1", "4|1.2|52006 = 2|3.2|52006 - 3|1.2|52006 - 2|3.2.2|520061", "RV");
        normalizer.normalize();
    end;

    macro exportToKliko()
        if (not global.reportingPeriodIsVror)
            exportDescriptionRow("1.2.В части долгосрочных иных обязательств", true);
        else
            exportDescriptionRow("1.2.В части долгосрочных иных обязательств:", true);
        end;

        var iterator = getValueIterator();
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "520052 (2)");
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR4_3", this, "520052 (2)", "RV").export();
        TPtkPsdBalanceGroupExporter("OR4_3", this, "52006 (3)",  "RV").export();
    end;

    private macro constructorTApplicationRow4_1_2_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "1.2";
    end;

    constructorTApplicationRow4_1_2_4217(applicationName);
end;

// Строка 1.2.1 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_1_2_1_4217(applicationName : String)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Итого (сумма остатков по строке 1.2)");
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "1.2.1.Итого (сумма остатков по строке 1.2)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_1_2_1_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "1.2.1";
    end;

    constructorTApplicationRow4_1_2_1_4217(applicationName);
end;

// Строка 2 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_2_4217(applicationName : String)
    macro saveAttributes()
        var value : Double = global.parameters.getReservation().getCorrectiveCoefficient();
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            saveAttributeValue("Коэффициент", "", Date(0,0,0), value, value, value, value);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        macro formatting(v)
            v = String(v:0:9);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var i = getValueIterator();
        var value = 0.0;
        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printSingleValueRow(formatting(value), " Корректировочный коэффициент (4)", reportWidth, true);
    end;

    macro exportToKliko()
        var i = getValueIterator();
        var value = 0.0;

        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;

        exportSingleValueRow("2.Корректировочный коэффициент", String(value:0:2));
    end;

    macro exportToPtkPsd()
        TPtkPsdCoefficientExporter("OR4_4", this, "R").export();
    end;

    private macro constructorTApplicationRow4_2_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "2";
    end;

    constructorTApplicationRow4_2_4217(applicationName);
end;

// Строка 3.1 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_3_1_4217(applicationName : String)
    macro saveAttributes()
        var correctiveCoefficient  = global.parameters.getReservation().getCorrectiveCoefficient();
        var iterator;
        var compositeValue;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1.1");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("", "", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").exact * correctiveCoefficient,
                                   compositeValue.fieldValue("roubleRest").scaled  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").scaled * correctiveCoefficient);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " Всего остатков, подлежащих");
        printDescriptionRow(" исключению из иных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (за исключением долгосрочных)", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (строка 1.1.1 * корректировочный", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" коэффициент),", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 520524", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "3.1.Всего остатков,подл.искл. (стр1.1.1*коррект.коэф.), код 520524");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow4_3_1_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "3.1";
    end;

    constructorTApplicationRow4_3_1_4217(applicationName);
end;

// Строка 3.2 Приложения 4
class (TApplicationRow4_4217) TApplicationRow4_3_2_4217(applicationName : String)
    macro saveAttributes()
        var correctiveCoefficient  = global.parameters.getReservation().getCorrectiveCoefficient();
        var iterator;
        var compositeValue;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2.1");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("", "", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").exact * correctiveCoefficient,
                                   compositeValue.fieldValue("roubleRest").scaled  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").scaled * correctiveCoefficient);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " Всего остатков, подлежащих");
        printDescriptionRow(" исключению из долгосрочных", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" иных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (строка 1.2.1 * корректировочный", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" коэффициент),", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 520056", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "3.2.Всего остатков,подл.искл. (стр1.2.1*коррект.коэф.), код 520056");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow4_3_2_4217(applicationName : String)
        initTApplicationRow4_4217(applicationName);

        m_code = "3.2";
    end;

    constructorTApplicationRow4_3_2_4217(applicationName);
end;

// Базовый класс строк Приложения 4 по 5036-У
private class (TApplicationRow2_7_5036) TApplicationRow4_5036(applicationName : String, xlsView)
    private macro exportValueRowExt(iterator : Object, description : String, isPrintRouble : Bool, isPrintCurrency : Bool)
        var valueArray     : Object = getArrayExt(0, isPrintRouble, isPrintCurrency);
        var isFirst        : Bool   = true;
        var currentBalance : String = "no balance";
        var compositeValue : Object = NULL;

        var lastCurrencyValue = "";
        var lastRoubleValue   = "";

        var i : Integer = 0;
        iterator.moveFirst();
        while (not iterator.isDone)
            compositeValue = iterator.currentItem;
            if (currentBalance != global.exportBalanceProcessor.getBalanceNumber(compositeValue))
                if (not isFirst)
                    global.klikoExportFile.printString(valueArray);
                end;
                isFirst = false;
                currentBalance = global.exportBalanceProcessor.getBalanceNumber(compositeValue);
                valueArray = getArrayExt(0, isPrintRouble, isPrintCurrency);
                i = 0;
                if (description == NULL)
                    valueArray[i] = currentBalance + "\",\"";
                else
                    valueArray[i] = description;
                end;
                i = i + 1;
                valueArray[i] = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");

                i = i + 1;
                valueArray[i] = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");
            else
                valueArray[i] = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");

                i = i + 1;
                valueArray[i] = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");
            end;

            lastRoubleValue   = ternary(isPrintRouble, compositeValue.fieldValue("roubleRest").currentAsString, "");
            lastCurrencyValue = ternary(isPrintCurrency, compositeValue.fieldValue("currencyRest").currentAsString, "");

            iterator.moveNext();
            i = i + 1;
        end;

        if (iterator.count > 0)
            global.klikoExportFile.printString(valueArray);
        end;

        if ((iterator.count == 0) and (description != NULL))
            valueArray[0] = description;
            global.klikoExportFile.printString(valueArray);
        end;
    end;

    private macro exportValueRow(iterator : Object, description : String)
        if (description != null)
            description = description + "\",\"";
        end;
        exportValueRowExt(iterator, description, true, true);
    end;

    /* Функционал экспорта в ПТК ПСД*/
    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_5036(applicationName : String, xlsView)
        initTApplicationRow2_7_5036(applicationName, xlsView);
    end;

    constructorTApplicationRow4_5036(applicationName, xlsView);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter1_5036(balanceMasks : String, category : String)
    macro makePartDateFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND NOT (" + application6Filter + ")"
                         ;
    end;

    macro makePartFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + ")";

        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            +"\n"+ "AND  " + isTermLessThreeYears("account.t_account", "account.t_fiId", "account.t_chapter")
            +"\n"+ "AND  NOT (" + application6Filter + ")"
            ;
    end;

    initTDataSourceFilter_5036(balanceMasks, category);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter2_5036(balanceMasks : String, category : String)
    macro makePartDateFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("1").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("2").getFilter().getSqlDateFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + " AND " + global.form.getApplication6().getRow("3").getFilter().getSqlDateFilter() + ")";

        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND NOT (" + application6Filter + ")"
                         ;
    end;

    macro makePartFilter()
        var application6Filter = "   (" + global.form.getApplication6().getRow("1").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("2").getFilter().getSqlFilter() + ")"
            +"\n"+               "OR (" + global.form.getApplication6().getRow("3").getFilter().getSqlFilter() + ")";

        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            +"\n"+ "AND  " + isTermEqualThreeYears("account.t_account", "account.t_fiId", "account.t_chapter")
            +"\n"+ "AND  NOT (" + application6Filter + ")"
            ;
    end;

    initTDataSourceFilter_5036(balanceMasks, category);
end;

private class (TDataSourceFilter_5036) TDataSourceFilter3_5036(balanceMasks : String)
    macro makePartDateFilter()
        m_partDateFilter = "  " + isSatisfiesToBalancesMasks("account.t_balance")
                         + "\n" + "AND " + hasNoAssignedCategory(null, RCB_OBJGROUP_SUBORDINATEDLOAN) // Субординированный кредит
                         ;
    end;

    macro makePartFilter()
        m_partFilter = " " + isSatisfiesToBalancesMasks("account.t_balance")
            ;
    end;

    initTDataSourceFilter_5036(balanceMasks);
end;

// Строка 1 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_1_5036(applicationName : String, xlsView)
    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" Пассивные остатки (либо их часть) ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" отдельных лицевых счетов по учету ", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" выпущенных ценных бумаг", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" балансовых счетов:", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printDescriptionRowExcel(RcbArray().initialize(" Пассивные остатки (либо их часть) ",
                                                       " отдельных лицевых счетов по учету ",
                                                       " выпущенных ценных бумаг",
                                                       " балансовых счетов:"), true, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro exportToKliko()
        exportDescriptionRow("1.Пассивные остатки (либо их часть) отдельных л/сч по учету выпущенных ценных бумаг балансовых счетов", true);
    end;

    private macro constructorTApplicationRow4_1_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "1";
    end;

    constructorTApplicationRow4_1_5036(applicationName, xlsView);
end;

// Строка 1.1 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_1_1_5036(applicationName : String, xlsView)
    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter1_5036("52005"), m_code, m_applicationName, "Расш"));
    end;

    macro getBalanceMasks()
        return getBalanceMasksForRow(m_code);
    end;

    macro getDecodingBalanceMasks()
        return "520051";
    end;

    private macro getDeleterFilter()
        class TFilter()
            macro isSuitable(v : Object) : Bool
                return (    (v.fieldValue("row").exactAsString == "1.1")
                        and (v.fieldValue("balanceGroup").exactAsString == "СобствЦб")
                       );
            end;
        end;

        return TFilter();
    end;

    macro saveAttributes()
        class TFilter(balanceMasks)
            private const m_balanceMasks = balanceMasks;
            macro isSuitable(v : Object)
                return (    (v.fieldValue("row").exactAsString == "3.1")
                        and (v.fieldValue("balanceGroup").exactAsString == "ЮЛ")
                        and (compareStrWithMasks(m_balanceMasks, v.fieldValue("balance").exactAsString) == 0)
                       );
            end;
        end;

        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator("Приложение2", NULL);
            iterator.setFilter(TFilter(getBalanceMasks()));
            iterator.setSortOrder(SORTER_FOR_DATE);
            iterator.moveFirst();
            while (not iterator.isDone())
                var compositeValue = iterator.currentItem();
                saveAttributeValue("СобствЦб", compositeValue.fieldValue("balance").exactAsString,
                                               Date(trim(compositeValue.fieldValue("date").exact)),
                                               compositeValue.fieldValue("roubleRest").exact,
                                               compositeValue.fieldValue("currencyRest").exact,
                                               compositeValue.fieldValue("roubleRest").scaled,
                                               compositeValue.fieldValue("currencyRest").scaled
                                  );
                iterator.moveNext();
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "Расш")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, getDecodingBalanceMasks(), dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        normalizer.addRelation("C|1 = C|1", "4|1.1|520051 = 2|3.1|520051", "RV");
        normalizer.normalize();
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" В части иных обязательств (за", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" исключением долгосрочных)", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRow(iterator, false, true, true);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printDescriptionRowExcel(RcbArray().initialize(" В части иных обязательств (за",
                                                       " исключением долгосрочных)"), true, true, beginDateInBlock, numberDatesInBlock);

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_BALANCE_DATE);
        printRowExcel(iterator, false, true, true);
    end;

    macro exportToKliko()
        if (not global.reportingPeriodIsVror)
            exportDescriptionRow("1.1.В части иных обязательств (за исключением долгосрочных)", true);
        else
            exportDescriptionRow("1.1.Пассивные остатки по учету выпущенных цен. бумаг бал.сч.:", true);
        end;

        exportToKliko(SORTER_FOR_BALANCE_DATE);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR4_1", this, "СобствЦб", "RV").export();
        TPtkPsdBalanceGroupExporter("OR4_1", this, "Расш",     "RV").export();
    end;

    private macro constructorTApplicationRow4_1_1_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "1.1";
    end;

    constructorTApplicationRow4_1_1_5036(applicationName, xlsView);
end;

// Строка 1.1.1 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_1_1_1_5036(applicationName : String, xlsView)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Итого (сумма остатков по строке 1.1)");
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRowExcel(iterator, true, true, true, "Итого (сумма остатков по строке 1.1)");
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "1.1.1.Итого (сумма остатков по строке 1.1)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_2", this, "RV").export();
    end;

    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_1_1_1_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "1.1.1";
    end;

    constructorTApplicationRow4_1_1_1_5036(applicationName, xlsView);
end;

// Строка 1.2 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_1_2_5036(applicationName : String, xlsView)
    macro fillTempTable(tempTable : TTempTable)
        tempTable.fill(TBalanceDataSource(TDataSourceFilter2_5036("52005", "507-П пункт 2.5.6_1"), m_code, m_applicationName, "520052 (2)"));
        tempTable.fill(TBalanceDataSource(TDataSourceFilter3_5036("52006"), m_code, m_applicationName, "52006 (3)"));
    end;

    macro updateBalanceValues()
        var dataSet = getBalanceDataSet("52006");

        updateBalanceValue(dataSet, "52006 (3)");
    end;

    macro getBalanceMasks()
        return "52006";
    end;

    macro getDecodingBalanceMasks()
        return "520052";
    end;

    macro saveAttributes()
        var dataSet : Object;
        var i = 0;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "520052 (2)")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, "520052 (2)", dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;

            dataSet = TRsbDataSet(createQueryForBalance(TBalanceId(m_applicationName, m_code, "52006 (3)")));
            while (dataSet.moveNext())
                saveAttributeValue(dataSet.balanceGroup, "52006 (3)", dataSet.date, dataSet.roubleRest, dataSet.currencyRest, dataSet.roubleScaledRest, dataSet.currencyScaledRest);
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" В части долгосрочных иных ", true, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "520052 (2)");
        printRow(iterator, false, true, true);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        printDescriptionRowExcel(RcbArray().initialize(" В части долгосрочных иных ",
                                                       " обязательств"), true, true, beginDateInBlock, numberDatesInBlock);


        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "520052 (2)");
        printRowExcel(iterator, false, true, true);
    end;

    macro normalizeDecoding()
        var normalizer = TForConditionalNormalizer_4217(RcbApplication().currentReport.multiplier, getApplicationName());
        normalizer.addRelation("C|1 = C|1", "4|1.2|52006 = 2|3.2|52006 - 3|1.2|52006 - 2|3.2.2|520061", "RV");
        normalizer.normalize();
    end;

    macro exportToKliko()
        if (not global.reportingPeriodIsVror)
            exportDescriptionRow("1.2.В части долгосрочных иных обязательств", true);
        else
            exportDescriptionRow("1.2.В части долгосрочных иных обязательств:", true);
        end;

        var iterator = getValueIterator();
        iterator.setSortOrder(SORTER_FOR_CHANGED_BALANCE_DATE, "520052 (2)");
        exportValueRow(iterator);
    end;

    macro exportToPtkPsd()
        TPtkPsdBalanceGroupExporter("OR4_3", this, "520052 (2)", "RV").export();
        TPtkPsdBalanceGroupExporter("OR4_3", this, "52006 (3)",  "RV").export();
    end;

    private macro constructorTApplicationRow4_1_2_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "1.2";
    end;

    constructorTApplicationRow4_1_2_5036(applicationName, xlsView);
end;

// Строка 1.2.1 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_1_2_1_5036(applicationName : String, xlsView)
    macro saveAttributes()
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            var iterator = getAttributeValueIterator(m_applicationName, NULL, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2");
            iterator.setSortOrder(SORTER_FOR_DATE);
            summarizeAndSaveAttributeValue(iterator);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, "Итого (сумма остатков по строке 1.2)");
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRowExcel(iterator, true, true, true, "Итого (сумма остатков по строке 1.2)");
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "1.2.1.Итого (сумма остатков по строке 1.2)");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    macro getExportCode()
        return getCode();
    end;

    private macro constructorTApplicationRow4_1_2_1_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "1.2.1";
    end;

    constructorTApplicationRow4_1_2_1_5036(applicationName, xlsView);
end;

// Строка 2 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_2_5036(applicationName : String, xlsView)
    macro saveAttributes()
        var value : Double = global.parameters.getReservation().getCorrectiveCoefficient();
        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            saveAttributeValue("Коэффициент", "", Date(0,0,0), value, value, value, value);
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        macro formatting(v)
            v = String(v:0:9);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var i = getValueIterator();
        var value = 0.0;
        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;
        printSeparator(BOTTOM_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        printSingleValueRow(formatting(value), " Корректировочный коэффициент (4)", reportWidth, true);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        macro formatting(v)
            v = String(v:0:9);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var i = getValueIterator();
        var value = 0.0;
        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;

        printSingleValueRowExcel(formatting(value), " Корректировочный коэффициент (4)", reportWidth, true);
    end;

    macro exportToKliko()
        var i = getValueIterator();
        var value = 0.0;

        i.moveFirst();

        if (not i.isDone())
            value = i.currentitem.fieldValue("roubleRest").exact;
        end;

        exportSingleValueRow("2.Корректировочный коэффициент", String(value:0:2));
    end;

    macro exportToPtkPsd()
        TPtkPsdCoefficientExporter("OR4_4", this, "R").export();
    end;

    private macro constructorTApplicationRow4_2_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "2";
    end;

    constructorTApplicationRow4_2_5036(applicationName, xlsView);
end;

// Строка 3.1 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_3_1_5036(applicationName : String, xlsView)
    macro saveAttributes()
        var correctiveCoefficient  = global.parameters.getReservation().getCorrectiveCoefficient();
        var iterator;
        var compositeValue;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.1.1");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("", "", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").exact * correctiveCoefficient,
                                   compositeValue.fieldValue("roubleRest").scaled  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").scaled * correctiveCoefficient);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(TOP_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " Всего остатков, подлежащих");
        printDescriptionRow(" исключению из иных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (за исключением долгосрочных)", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (строка 1.1.1 * корректировочный", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" коэффициент),", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 520524", false, true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRowExcel(iterator, true, true, true, RcbArray().initialize(" Всего остатков, подлежащих",
                                                                        " исключению из иных обязательств",
                                                                        " (за исключением долгосрочных)",
                                                                        " (строка 1.1.1 * корректировочный",
                                                                        " коэффициент),",
                                                                        " код обозначения 520524"));

    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "3.1.Всего остатков,подл.искл. (стр1.1.1*коррект.коэф.), код 520524");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow4_3_1_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "3.1";
    end;

    constructorTApplicationRow4_3_1_5036(applicationName, xlsView);
end;

// Строка 3.2 Приложения 4
class (TApplicationRow4_5036) TApplicationRow4_3_2_5036(applicationName : String, xlsView)
    macro saveAttributes()
        var correctiveCoefficient  = global.parameters.getReservation().getCorrectiveCoefficient();
        var iterator;
        var compositeValue;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator(m_applicationName, NULL);
            iterator.setFilter(FILTER_FOR_APPLICATION_ROW, "1.2.1");
            iterator.moveFirst();
            while (not iterator.isDone())
                compositeValue = iterator.currentItem();
                saveAttributeValue("", "", Date(trim(compositeValue.fieldValue("date").exact)),
                                   compositeValue.fieldValue("roubleRest").exact  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").exact * correctiveCoefficient,
                                   compositeValue.fieldValue("roubleRest").scaled  * correctiveCoefficient, compositeValue.fieldValue("currencyRest").scaled * correctiveCoefficient);
                iterator.moveNext();
            end;
        end;
    end;

    macro print(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)
        printSeparator(MIDDLE_SEPARATOR, beginDateInBlock, numberDatesInBlock);
        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRow(iterator, true, true, true, " Всего остатков, подлежащих");
        printDescriptionRow(" исключению из долгосрочных", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" иных обязательств", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" (строка 1.2.1 * корректировочный", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" коэффициент),", false, true, beginDateInBlock, numberDatesInBlock);
        printDescriptionRow(" код обозначения 520056", false, true, beginDateInBlock, numberDatesInBlock);
        printBottom(true, beginDateInBlock, numberDatesInBlock);
    end;

    macro printExcel(reportWidth : Integer, beginDateInBlock, numberDatesInBlock)

        var iterator = getValueIterator(NULL, beginDateInBlock, numberDatesInBlock);
        iterator.setSortOrder(SORTER_FOR_DATE);
        printRowExcel(iterator, true, true, true, RcbArray().initialize(" Всего остатков, подлежащих",
                                                                        " исключению из долгосрочных",
                                                                        " иных обязательств",
                                                                        " (строка 1.2.1 * корректировочный",
                                                                        " коэффициент),",
                                                                        " код обозначения 520056"));
    end;

    macro exportToKliko()
        exportToKliko(SORTER_FOR_DATE, "3.2.Всего остатков,подл.искл. (стр1.2.1*коррект.коэф.), код 520056");
    end;

    macro exportToPtkPsd()
        TPtkPsdRowExporter("OR4_4", this, "RV").export();
    end;

    private macro constructorTApplicationRow4_3_2_5036(applicationName : String, xlsView)
        initTApplicationRow4_5036(applicationName, xlsView);

        m_code = "3.2";
    end;

    constructorTApplicationRow4_3_2_5036(applicationName, xlsView);
end;
