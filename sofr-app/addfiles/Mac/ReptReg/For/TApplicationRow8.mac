/*
$Name:          TApplicationRow8.mac
$Module:        Регламентируемая отчетность
$Description:   ФОР. Классы строк Приложения 8 ФОР
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Класс строк приложения :"Отчет об отсутствии остатков на балансовых счетах отдельных расшифровок"

  Создан: 20.04.2007 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
class (TApplicationRow8) TApplicationRow8_N(applicationName : String)
    initTApplicationRow8(applicationName);
    m_code = "-";

    private macro getApplicationBalanceString(applicationName : String)
        var set = global.form.getMasksSetForApplication(applicationName);
        var iterator = set.createIterator();
        var masksString  : String = "";

        iterator.moveFirst();
        while (not iterator.isDone())
            masksString = masksString + ", " + iterator.getCurrentItem();
            iterator.moveNext();
        end;

        masksString = subStr(masksString, 3);
        var dataSet : Object = NULL;
        var balanceString : String = "";

        if (masksString != "")
            dataSet = TRsbDataSet("SELECT DISTINCT t_balance" + global.parameters.getPlanNumber() + " t_balance"
                           +"\n"+ "  FROM daccblnc_dbt"
                           +"\n"+ " WHERE " + convertMaskToSqlFormat(masksString, "t_balance"+ global.parameters.getPlanNumber())
                           +"\n"+ "ORDER BY t_balance" + global.parameters.getPlanNumber());

            while (dataSet.moveNext)
                balanceString = balanceString + ", " + dataSet.balance;
            end;

            return subStr(balanceString, 3);
        else
            return "";
        end;
    end;

    macro saveAttributes()
        var structValue    : Object = NULL;
        var iterator       : Object = NULL;
        var sum6           : Money  = $0.0;
        var sum7           : Money  = $0.0;

        class TFilter()
            macro isSuitable(v : Object)
                return (v.fieldValue("roubleRest").current != $0.0) or (v.fieldValue("currencyRest").current != $0.0);
            end;
        end;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator("Приложение2", TFilter());
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение2", getApplicationBalanceString("Приложение2"));
            end;

            iterator = getAttributeValueIterator("Приложение3", TFilter());
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение3", getApplicationBalanceString("Приложение3"));
            end;

            iterator = getAttributeValueIterator("Приложение5", TFilter());
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение5", getApplicationBalanceString("Приложение5"));
            end;
        end;
    end;

    macro print(printedReport)
        class TSorter()
            macro isLess(v1 : Object, v2 : Object)
                return (Date(trim(v1.fieldValue("applicationName").current)) < Date(trim(v2.fieldValue("applicationName").current)));
            end;
        end;
        var compositeValue : Object = NULL;
        var iterator       : Object = getAttributeValueIterator(m_applicationName, NULL, TSorter());
        var isFirst        : Bool   = true;

        iterator.moveFirst();
        while (not iterator.isDone())
            if (not isFirst)
                printedReport.printSeparator();
            end;
            isFirst = false;
            compositeValue = iterator.currentItem();
            printedReport.printStringTransferByWord(compositeValue.fieldValue("row").currentAsString,
                                                    compositeValue.fieldValue("applicationName").currentAsString,
                                                    getApplicationBalanceString(compositeValue.fieldValue("applicationName").current));
            iterator.moveNext();
        end;
        printedReport.printBottom();
    end;
end;

class (TApplicationRow8) TApplicationRow342_8(applicationName : String)
    initTApplicationRow8(applicationName);

    m_code = "-";

    private macro getApplicationBalanceString(applicationName : String)
        var set = global.form.getMasksSetForApplication(applicationName);
        var iterator = set.createIterator();
        var masksString  : String = "";

        iterator.moveFirst();
        while (not iterator.isDone())
            masksString = masksString + ", " + iterator.getCurrentItem();
            iterator.moveNext();
        end;

        masksString = subStr(masksString, 3);
        var dataSet : Object = NULL;
        var balanceString : String = "";

        if (masksString != "")
            dataSet = TRsbDataSet("SELECT DISTINCT t_chapter, t_balance" + global.parameters.getPlanNumber() + " t_balance"
                           +"\n"+ "  FROM daccblnc_dbt"
                           +"\n"+ " WHERE t_chapter = 1 AND " + convertMaskToSqlFormat(masksString, "t_balance"+ global.parameters.getPlanNumber())
                           +"\n"+ "ORDER BY t_chapter, t_balance" + global.parameters.getPlanNumber());

            while (dataSet.moveNext)
                balanceString = balanceString + ", " + dataSet.balance;
            end;

            return subStr(balanceString, 3);
        else
            return "";
        end;
    end;

    macro saveAttributes()
        var structValue    : Object = NULL;
        var iterator       : Object = NULL;

        if (not isSaved())
            m_isSaved = true;
            saveAttributes();

            iterator = getAttributeValueIterator("Приложение2", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение2", getApplicationBalanceString("Приложение2"));
            end;

            iterator = getAttributeValueIterator("Приложение3", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение3", getApplicationBalanceString("Приложение3"));
            end;

            iterator = getAttributeValueIterator("Приложение4", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение4", getApplicationBalanceString("Приложение4"));
            end;

            iterator = getAttributeValueIterator("Приложение6", NULL);
            iterator.setFilter(FILTER_FOR_NONZERO_REST);
            iterator.moveFirst();
            if (iterator.count == 0)
                saveAttributeValue(sequence.nextVal(), "Приложение6", getApplicationBalanceString("Приложение6"));
            end;
        end;
    end;

    macro print(printedReport)
        var compositeValue : Object = NULL;
        var iterator       : Object = getAttributeValueIterator(m_applicationName, NULL, NULL);
        var isFirst        : Bool   = true;

        iterator.setSortOrder(SORTER_FOR_APPLICATION);

        iterator.moveFirst();
        while (not iterator.isDone())
            if (not isFirst)
                printedReport.printSeparator();
            end;
            isFirst = false;
            compositeValue = iterator.currentItem();
            printedReport.printStringTransferByWord(compositeValue.fieldValue("row").currentAsString,
                                                    compositeValue.fieldValue("applicationName").currentAsString,
                                                    getApplicationBalanceString(compositeValue.fieldValue("applicationName").current));
            iterator.moveNext();
        end;
        printedReport.printBottom();
    end;
end;
