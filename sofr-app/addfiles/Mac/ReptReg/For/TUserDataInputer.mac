/*
$Name:          TUserDataInputer.mac
$Module:        ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
$Description:   ”. ¯à¥¤¥«¥­¨¥ ä ªâ¨ç¥áª®£® ®áâ âª  ®¡ï§ â¥«ì­ëå à¥§¥à¢®¢
*/
/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank V6                                                                        R-Style Softlab
  ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì"

  Š« áá ¤«ï ®¡¥á¯¥ç¥­¨ï ¯®«ì§®¢ â¥«ìáª®£® ¢¢®¤ 

  ‘®§¤ ­: 20.04.2007 - Ser.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
private class (TDataSourceFilter) TDataSourceFilter_UserInput(balanceMasks : String, category : String, alias : String)
    private var m_alias = alias;

    private macro hasAssignedCategory(category : String)
        var objectId  = "rsb_rep_ac.makeAccountId(" + m_alias + ".t_account, " + m_alias + ".t_code_currency, " + m_alias + ".t_chapter, NULL)";

        var filter = "";

        if (nvl(category, m_category) != NULL)
            filter = "EXISTS(SELECT 1"
              +"\n"+ "         FROM dobjatcor_dbt atc"
              +"\n"+ "        WHERE atc.t_ObjectType = " + RCB_OBJTYPE_ACCOUNT
              +"\n"+ "          AND atc.t_GroupID    = " + RCB_OBJGROUP_REPORT
              +"\n"+ "          AND atc.t_Object     = " + objectId
              +"\n"+ "          AND atc.t_AttrID IN (SELECT att.t_AttrID"
              +"\n"+ "                                 FROM dobjattr_dbt att"
              +"\n"+ "                                WHERE att.t_ObjectType = atc.t_ObjectType"
              +"\n"+ "                                  AND att.t_GroupID    = atc.t_GroupID"
              +"\n"+ "                                  AND att.t_numInList  = " + getSqlString(nvl(category, m_category)) + ")"
              +"\n"+ "          AND " + getSqlDate(global.parameters.getEndDate()) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)";
        else
            filter = "1 = 1";
        end;
        return filter;
    end;

    macro makePartFilter()
        var balanceAlias = m_alias + ".t_balance" + ternary(m_alias == "accblnc", global.parameters.getPlanNumber(), "");

        m_partFilter =     " " + isSatisfiesToBalancesMasks(balanceAlias)
            +"\n"+     " AND " + hasAssignedCategory();
    end;
    initTDataSourceFilter(balanceMasks, category);
end;

class TUserDataInputer()
    local class TActualReserveRest(restDate : Date, roubleRest : Money, currencyRest : Money, roubleScaledRest : Double, currencyScaledRest : Double)
        private var m_date           : Date   = restDate;
        private var m_rouble         : Money  = roubleRest;
        private var m_currency       : Money  = currencyRest;
        private var m_scaledRouble   : Double = roubleScaledRest;
        private var m_scaledCurrency : Double = currencyScaledRest;

        macro  getDate()
            return m_date;
        end;

        macro  getRouble()
            return m_rouble;
        end;

        macro  getCurrency()
            return m_currency;
        end;

        macro  getScaledRouble()
            return m_scaledRouble;
        end;

        macro  getScaledCurrency()
            return m_scaledCurrency;
        end;
    end;

    private var m_actualReserveRest : Object = NULL;

    private macro isNotZeroData(actualReserveRest : TActualReserveRest)
        if ((actualReserveRest.getRouble != $0.0) or (actualReserveRest.getCurrency != $0.0))
            return true;
        end;
        return false;
    end;

    private macro getCondition(isCurrency : Bool, tableAlias : String, isOneFilial : Bool)
        var defaultBalanceMasks : String = "";
        var balanceMasks        : String = "";
        var row                 : String = "";
        var category            : String = null;

        if (nvl(isOneFilial, global.parameters.isOneFilial()))

            if (isCurrency)
                row = "1.5.2";
                defaultBalanceMasks = "30204";
            else
                row = "1.5.1";
                defaultBalanceMasks = "30202";
            end;
        else

            if (isCurrency)
                row = "1.5.2(1)";

                if (global.parameters.isHeadDepartment())
                    category = "ƒ‚”";
                else
                    category = "”‚";
                end;
            else
                row = "1.5.1(1)";

                if (global.parameters.isHeadDepartment())
                    category = "ƒ”";
                else
                    category = "”";
                end;
            end;

            defaultBalanceMasks = "303*";
        end;

        var tuneTable = RcbTuneTable("dtFor_dbt");

        tuneTable.setInstructionFilter(global.parameters.getEndDate());

        tuneTable.setUserFilter("t_applicationName = 'à¨«®¦¥­¨¥1' AND t_row = " + getSqlString(row));

        var dataSet = tuneTable.getDataSet();

        while (dataSet.moveNext())
            balanceMasks = balanceMasks + ", " + dataSet.balanceMasks;
        end;

        balanceMasks = subStr(balanceMasks, 3);

        if (balanceMasks == "")
            balanceMasks = defaultBalanceMasks;
        end;

        return TDataSourceFilter_UserInput(balanceMasks, category, tableAlias).getSqlFilter();
    end;

    private macro getQuery(restDate : Date, isOneFilial : Bool)

        var query = "WITH represthist  AS (SELECT --+ MATERIALIZE LEADING (accblnc)"
            +"\n"+  "                             represthist.*, accblnc.t_balance" + global.parameters.getPlanNumber() + " AS t_balance"
            +"\n"+  "                        FROM drestdate_dbt represthist,"
            +"\n"+  "                             daccblnc_dbt  accblnc"
            +"\n"+  "                       WHERE accblnc.t_chapter = 1"
            +"\n"+  "                         AND represthist.t_accountId = accblnc.t_accountId"
            +"\n"+  "                         AND ( (" + getCondition(true, "accblnc", isOneFilial) + ") OR (" + getCondition(false, "accblnc", isOneFilial) + ") )"
            +"\n"+  "                         AND represthist.t_restDate < " + getSqlDate(restDate) + "),"

            +"\n"+  "     roubleRest   AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(false, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency),"

            +"\n"+  "     currencyRest AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_currencyRest,"
            +"\n"+  "                             0 AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(true, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency)"

            +"\n"+  "SELECT NVL(SUM(t_roubleRest),   0) AS t_roubleRest,"
            +"\n"+  "       NVL(SUM(t_currencyRest), 0) AS t_currencyRest"
            +"\n"+  "  FROM (SELECT t_roublerest, NULL t_currencyRest"
            +"\n"+  "          FROM roubleRest"
            +"\n"+  "        UNION ALL"
            +"\n"+  "        SELECT NULL t_roublerest, t_currencyRest"
            +"\n"+  "          FROM currencyRest)";

        return query;
    end;

    private macro getActualReserveRestPerDate(restDate : Date)
        var roubleRest         : Money  = $0.0;
        var currencyRest       : Money  = $0.0;
        var actualReserveRest  : Money  = $0.0;
        var roubleScaledRest   : Double = 0.0;
        var currencyScaledRest : Double = 0.0;
        var dataSet            : Object = NULL;
        var balanceValues      : Object = NULL;

        record dl("d_for", "userrcb.lbr") dialog;

        if (global.parameters.isOneFilial() or not global.parameters.isHeadDepartment())
            dataSet = TRsbDataSet(getQuery(restDate));

            if (dataSet.moveNext())
                roubleRest         = dataSet.roubleRest;
                currencyRest       = dataSet.currencyRest;
                roubleScaledRest   = Double(round(dataSet.roubleRest / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round(dataSet.currencyRest / rcbApplication.currentReport.multiplier, 0));
            end;
        else
            var dataSet1 = TRsbDataSet(getQuery(restDate, true));
            var dataSet2 = TRsbDataSet(getQuery(restDate, false));

            if (dataSet1.moveNext() and dataSet2.moveNext())
                roubleRest         = dataSet1.roubleRest - dataSet2.roubleRest;
                currencyRest       = dataSet1.currencyRest - dataSet2.currencyRest;
                roubleScaledRest   = Double(round((dataSet1.roubleRest - dataSet2.roubleRest) / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round((dataSet1.currencyRest - dataSet2.currencyRest) / rcbApplication.currentReport.multiplier, 0));
            end;
        end;

        return TActualReserveRest(restDate, roubleRest, currencyRest, roubleScaledRest, currencyScaledRest);
    end;

    macro input()
        var restDate : Date = global.parameters.getEndDate() + 1;

        m_actualReserveRest = getActualReserveRestPerDate(restDate);
    end;

    macro getActualReserveRest()
        return  m_actualReserveRest;
    end;
end;

class TUserDataInputer_507()
    local class TActualReserveRest(restDate : Date, roubleRest : Money, currencyRest : Money, legalReserve : Money, roubleScaledRest : Double, currencyScaledRest : Double, legalScaledReserve : Double)
        private var m_date               : Date   = restDate;
        private var m_rouble             : Money  = roubleRest;
        private var m_currency           : Money  = currencyRest;
        private var m_legalReserve       : Money  = legalReserve;
        private var m_scaledRouble       : Double = roubleScaledRest;
        private var m_scaledCurrency     : Double = currencyScaledRest;
        private var m_legalScaledReserve : Double = legalScaledReserve;

        macro  getDate()
            return m_date;
        end;

        macro  getRouble()
            return m_rouble;
        end;

        macro  getCurrency()
            return m_currency;
        end;

        macro  getLegalReserve()
            return m_legalReserve;
        end;

        macro  getScaledRouble()
            return m_scaledRouble;
        end;

        macro  getScaledCurrency()
            return m_scaledCurrency;
        end;

        macro  getScaledLegalReserve()
            return m_legalScaledReserve;
        end;
    end;

    private var m_actualReserveRest : Object = NULL;

    private macro isNotZeroData(actualReserveRest : TActualReserveRest)
        if ((actualReserveRest.getRouble != $0.0) or (actualReserveRest.getCurrency != $0.0))
            return true;
        end;
        return false;
    end;

    private macro getCondition(isCurrency : Bool, tableAlias : String, isOneFilial : Bool)
        var defaultBalanceMasks : String = "";
        var balanceMasks        : String = "";
        var row                 : String = "";
        var category            : String = null;

        if (nvl(isOneFilial, global.parameters.isOneFilial()))

            if (isCurrency == null)
                row = "1.5.3";
                defaultBalanceMasks = "30238";
            else
                if (isCurrency)
                    row = "1.5.2";
                    defaultBalanceMasks = "30204";
                else
                    row = "1.5.1";
                    defaultBalanceMasks = "30202";
                end;
            end;
        else
            if (isCurrency == null)
                if (global.parameters.isHeadDepartment())
                    category = "ƒ”";
                else
                    category = "”";
                end;

                row = "1.5.3(1)";
            else
                if (isCurrency)
                    row = "1.5.2(1)";

                    if (global.parameters.isHeadDepartment())
                        category = "ƒ‚”";
                    else
                        category = "”‚";
                    end;
                else
                    row = "1.5.1(1)";

                    if (global.parameters.isHeadDepartment())
                        category = "ƒ”";
                    else
                        category = "”";
                    end;
                end;
            end;

            defaultBalanceMasks = "303*";
        end;

        var tuneTable = RcbTuneTable("dtFor_dbt");

        tuneTable.setInstructionFilter(global.parameters.getEndDate());

        tuneTable.setUserFilter("t_applicationName = 'à¨«®¦¥­¨¥1' AND t_row = " + getSqlString(row));

        var dataSet = tuneTable.getDataSet();

        while (dataSet.moveNext())
            balanceMasks = balanceMasks + ", " + dataSet.balanceMasks;
        end;

        balanceMasks = subStr(balanceMasks, 3);

        if (balanceMasks == "")
            balanceMasks = defaultBalanceMasks;
        end;

        return TDataSourceFilter_UserInput(balanceMasks, category, tableAlias).getSqlFilter();
    end;

    private macro getQuery(restDate : Date, isOneFilial : Bool)

        var query = "WITH represthist  AS (SELECT --+ MATERIALIZE LEADING (accblnc)"
            +"\n"+  "                             represthist.*, accblnc.t_balance" + global.parameters.getPlanNumber() + " AS t_balance"
            +"\n"+  "                        FROM drestdate_dbt represthist,"
            +"\n"+  "                             daccblnc_dbt  accblnc"
            +"\n"+  "                       WHERE accblnc.t_chapter = 1"
            +"\n"+  "                         AND represthist.t_accountId = accblnc.t_accountId"
            +"\n"+  "                         AND ( (" + getCondition(true, "accblnc", isOneFilial) + ") OR (" + getCondition(false, "accblnc", isOneFilial) + ") OR (" + getCondition(null, "accblnc", isOneFilial) + ") )"
            +"\n"+  "                         AND represthist.t_restDate < " + getSqlDate(restDate) + "),"

            +"\n"+  "     roubleRest   AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(false, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency),"

            +"\n"+  "     currencyRest AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_currencyRest,"
            +"\n"+  "                             0 AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(true, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency),"

            +"\n"+  "     legalReserve   AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_legalReserve"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(null, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency)"

            +"\n"+  "SELECT NVL(SUM(t_roubleRest),   0) AS t_roubleRest,"
            +"\n"+  "       NVL(SUM(t_currencyRest), 0) AS t_currencyRest,"
            +"\n"+  "       NVL(SUM(t_legalReserve), 0) AS t_legalReserve"
            +"\n"+  "  FROM (SELECT t_roublerest, NULL t_currencyRest, NULL t_legalReserve"
            +"\n"+  "          FROM roubleRest"
            +"\n"+  "        UNION ALL"
            +"\n"+  "        SELECT NULL t_roublerest, t_currencyRest, NULL t_legalReserve"
            +"\n"+  "          FROM currencyRest"
            +"\n"+  "        UNION ALL"
            +"\n"+  "        SELECT NULL t_roublerest, NULL t_currencyRest, t_legalReserve"
            +"\n"+  "          FROM legalReserve)";

        return query;
    end;

    private macro getActualReserveRestPerDate(restDate : Date)
        var roubleRest         : Money  = $0.0;
        var currencyRest       : Money  = $0.0;
        var legalReserve       : Money  = $0.0;
        var actualReserveRest  : Money  = $0.0;
        var roubleScaledRest   : Double = 0.0;
        var currencyScaledRest : Double = 0.0;
        var legalReserveScaled : Double = 0.0;
        var dataSet            : Object = NULL;
        var balanceValues      : Object = NULL;

        record dl("d_for", "userrcb.lbr") dialog;

        if (global.parameters.isOneFilial() or not global.parameters.isHeadDepartment())
            dataSet = TRsbDataSet(getQuery(restDate));

            if (dataSet.moveNext())
                roubleRest         = dataSet.roubleRest;
                currencyRest       = dataSet.currencyRest;
                legalReserve       = dataSet.legalReserve;
                roubleScaledRest   = Double(round(dataSet.roubleRest / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round(dataSet.currencyRest / rcbApplication.currentReport.multiplier, 0));
                legalReserveScaled = Double(round(dataSet.legalReserve / rcbApplication.currentReport.multiplier, 0));
            end;
        else
            var dataSet1 = TRsbDataSet(getQuery(restDate, true));
            var dataSet2 = TRsbDataSet(getQuery(restDate, false));

            if (dataSet1.moveNext() and dataSet2.moveNext())
                roubleRest         = dataSet1.roubleRest - dataSet2.roubleRest;
                currencyRest       = dataSet1.currencyRest - dataSet2.currencyRest;
                legalReserve       = dataSet1.legalReserve - dataSet2.legalReserve;
                roubleScaledRest   = Double(round((dataSet1.roubleRest - dataSet2.roubleRest) / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round((dataSet1.currencyRest - dataSet2.currencyRest) / rcbApplication.currentReport.multiplier, 0));
                legalReserveScaled = Double(round((dataSet1.legalReserve - dataSet2.legalReserve) / rcbApplication.currentReport.multiplier, 0));
            end;
        end;

        return TActualReserveRest(restDate, roubleRest, currencyRest, legalReserve, roubleScaledRest, currencyScaledRest, legalReserveScaled);
    end;

    macro input()
        var restDate : Date = global.parameters.getEndDate() + 1;

        m_actualReserveRest = getActualReserveRestPerDate(restDate);
    end;

    macro getActualReserveRest()
        return  m_actualReserveRest;
    end;
end;

class TUserDataInputer_4217()
    local class TActualReserveRest(restDate : Date, roubleRest : Money, currencyRest : Money, legalReserve : Money, roubleScaledRest : Double, currencyScaledRest : Double, legalScaledReserve : Double)
        private var m_date               : Date   = restDate;
        private var m_rouble             : Money  = roubleRest;
        private var m_currency           : Money  = currencyRest;
        private var m_legalReserve       : Money  = legalReserve;
        private var m_scaledRouble       : Double = roubleScaledRest;
        private var m_scaledCurrency     : Double = currencyScaledRest;
        private var m_legalScaledReserve : Double = legalScaledReserve;

        macro  getDate()
            return m_date;
        end;

        macro  getRouble()
            return m_rouble;
        end;

        macro  getCurrency()
            return m_currency;
        end;

        macro  getLegalReserve()
            return m_legalReserve;
        end;

        macro  getScaledRouble()
            return m_scaledRouble;
        end;

        macro  getScaledCurrency()
            return m_scaledCurrency;
        end;

        macro  getScaledLegalReserve()
            return m_legalScaledReserve;
        end;
    end;

    private var m_actualReserveRest : Object = NULL;

    private macro isNotZeroData(actualReserveRest : TActualReserveRest)
        if ((actualReserveRest.getRouble != $0.0) or (actualReserveRest.getCurrency != $0.0))
            return true;
        end;
        return false;
    end;

    private macro getCondition(isCurrency : Bool, tableAlias : String, isOneFilial : Bool)
        var defaultBalanceMasks : String = "";
        var balanceMasks        : String = "";
        var row                 : String = "";
        var category            : String = null;

        if (nvl(isOneFilial, global.parameters.isOneFilial()))

            if (isCurrency == null)
                row = "1.5.3";
                defaultBalanceMasks = "30238";
            else
                if (isCurrency)
                    row = "1.5.2";
                    defaultBalanceMasks = "30204";
                else
                    row = "1.5.1";
                    defaultBalanceMasks = "30202";
                end;
            end;
        else
            if (isCurrency == null)
                if (global.parameters.isHeadDepartment())
                    category = "ƒ”";
                else
                    category = "”";
                end;

                row = "1.5.3(1)";
            else
                if (isCurrency)
                    row = "1.5.2(1)";

                    if (global.parameters.isHeadDepartment())
                        category = "ƒ‚”";
                    else
                        category = "”‚";
                    end;
                else
                    row = "1.5.1(1)";

                    if (global.parameters.isHeadDepartment())
                        category = "ƒ”";
                    else
                        category = "”";
                    end;
                end;
            end;

            defaultBalanceMasks = "303*";
        end;

        var tuneTable = RcbTuneTable("dtFor_dbt");

        tuneTable.setInstructionFilter(global.parameters.getEndDate());

        tuneTable.setUserFilter("t_applicationName = 'à¨«®¦¥­¨¥1' AND t_row = " + getSqlString(row));

        var dataSet = tuneTable.getDataSet();

        while (dataSet.moveNext())
            balanceMasks = balanceMasks + ", " + dataSet.balanceMasks;
        end;

        balanceMasks = subStr(balanceMasks, 3);

        if (balanceMasks == "")
            balanceMasks = defaultBalanceMasks;
        end;

        return TDataSourceFilter_UserInput(balanceMasks, category, tableAlias).getSqlFilter();
    end;

    private macro getQuery(restDate : Date, isOneFilial : Bool)

        var query = "WITH represthist  AS (SELECT --+ MATERIALIZE LEADING (accblnc)"
            +"\n"+  "                             represthist.*, accblnc.t_balance" + global.parameters.getPlanNumber() + " AS t_balance"
            +"\n"+  "                        FROM drestdate_dbt represthist,"
            +"\n"+  "                             daccblnc_dbt  accblnc"
            +"\n"+  "                       WHERE accblnc.t_chapter = 1"
            +"\n"+  "                         AND represthist.t_accountId = accblnc.t_accountId"
            +"\n"+  "                         AND ( (" + getCondition(true, "accblnc", isOneFilial) + ") OR (" + getCondition(false, "accblnc", isOneFilial) + ") OR (" + getCondition(null, "accblnc", isOneFilial) + ") )"
            +"\n"+  "                         AND represthist.t_restDate < " + getSqlDate(restDate) + "),"

            +"\n"+  "     roubleRest   AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(false, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency),"

            +"\n"+  "     currencyRest AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_currencyRest,"
            +"\n"+  "                             0 AS t_roubleRest"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(true, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency),"

            +"\n"+  "     legalReserve   AS (SELECT MAX (DECODE(account.t_kind_account,  '',  1,  -1) * represthist.t_rest)KEEP (DENSE_RANK FIRST ORDER BY account.t_chapter, account.t_account, account.t_code_currency, represthist.t_restDate DESC) AS t_legalReserve"
            +"\n"+  "                        FROM represthist,"
            +"\n"+  "                             daccount_dbt account"
            +"\n"+  "                       WHERE represthist.t_accountId = account.t_accountId"
            +"\n" + "                         AND INSTR(NVL(account.t_userTypeAccount, CHR(1)), '-') = 0"
            +"\n" + "                         AND " + RcbAccountFilter().getAsSqlString("account")
            +"\n"+  "                         AND " + getCondition(null, "account", isOneFilial)
            +"\n"+  "                    GROUP BY account.t_chapter, account.t_account, account.t_code_currency)"

            +"\n"+  "SELECT NVL(SUM(t_roubleRest),   0) AS t_roubleRest,"
            +"\n"+  "       NVL(SUM(t_currencyRest), 0) AS t_currencyRest,"
            +"\n"+  "       NVL(SUM(t_legalReserve), 0) AS t_legalReserve"
            +"\n"+  "  FROM (SELECT t_roublerest, NULL t_currencyRest, NULL t_legalReserve"
            +"\n"+  "          FROM roubleRest"
            +"\n"+  "        UNION ALL"
            +"\n"+  "        SELECT NULL t_roublerest, t_currencyRest, NULL t_legalReserve"
            +"\n"+  "          FROM currencyRest"
            +"\n"+  "        UNION ALL"
            +"\n"+  "        SELECT NULL t_roublerest, NULL t_currencyRest, t_legalReserve"
            +"\n"+  "          FROM legalReserve)";

        return query;
    end;

    private macro getActualReserveRestPerDate(restDate : Date)
        var roubleRest         : Money  = $0.0;
        var currencyRest       : Money  = $0.0;
        var legalReserve       : Money  = $0.0;
        var actualReserveRest  : Money  = $0.0;
        var roubleScaledRest   : Double = 0.0;
        var currencyScaledRest : Double = 0.0;
        var legalReserveScaled : Double = 0.0;
        var dataSet            : Object = NULL;
        var balanceValues      : Object = NULL;

        if (global.parameters.isOneFilial() or not global.parameters.isHeadDepartment())
            dataSet = TRsbDataSet(getQuery(restDate));

            if (dataSet.moveNext())
                roubleRest         = dataSet.roubleRest;
                currencyRest       = dataSet.currencyRest;
                legalReserve       = dataSet.legalReserve;
                roubleScaledRest   = Double(round(dataSet.roubleRest / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round(dataSet.currencyRest / rcbApplication.currentReport.multiplier, 0));
                legalReserveScaled = Double(round(dataSet.legalReserve / rcbApplication.currentReport.multiplier, 0));
            end;
        else
            var dataSet1 = TRsbDataSet(getQuery(restDate, true));
            var dataSet2 = TRsbDataSet(getQuery(restDate, false));

            if (dataSet1.moveNext() and dataSet2.moveNext())
                roubleRest         = dataSet1.roubleRest - dataSet2.roubleRest;
                currencyRest       = dataSet1.currencyRest - dataSet2.currencyRest;
                legalReserve       = dataSet1.legalReserve - dataSet2.legalReserve;
                roubleScaledRest   = Double(round((dataSet1.roubleRest - dataSet2.roubleRest) / rcbApplication.currentReport.multiplier, 0));
                currencyScaledRest = Double(round((dataSet1.currencyRest - dataSet2.currencyRest) / rcbApplication.currentReport.multiplier, 0));
                legalReserveScaled = Double(round((dataSet1.legalReserve - dataSet2.legalReserve) / rcbApplication.currentReport.multiplier, 0));
            end;
        end;

        return TActualReserveRest(restDate, roubleRest, currencyRest, legalReserve, roubleScaledRest, currencyScaledRest, legalReserveScaled);
    end;

    macro input()
        var restDate : Date = global.parameters.getEndDate() + 1;

        m_actualReserveRest = getActualReserveRestPerDate(restDate);
    end;

    macro getActualReserveRest()
        return  m_actualReserveRest;
    end;
end;

/*‘®§¤ ¥¬ ¥¤¨­áâ¢¥­­ë© íª§¥¬¯«ïà ª« áá */
if (RcbApplication.currentReport.context.period.endDate >= RCB_I4217_DATE)
    global.userDataInputer = TUserDataInputer_4217();
elif (RcbApplication.currentReport.context.period.endDate >= RCB_I507_DATE)
    global.userDataInputer = TUserDataInputer_507();
else
    global.userDataInputer = TUserDataInputer();
end;
