/*
$Name:          TForm.mac
$Module:        Регламентируемая отчетность
$Description:   Класс формы ФОР
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Класс формы ФОР

  Создан: 20.04.2007 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

class TForm()
    private var m_balanceMasksSetForApplication1 = NULL;
    private var m_balanceMasksSetForApplication2 = NULL;
    private var m_balanceMasksSetForApplication3 = NULL;
    private var m_balanceMasksSetForApplication5 = NULL;
    private var m_balanceMasksSetForApplication6 = NULL;
    private var m_balanceMasksSetForApplication7 = NULL;
    private var m_balanceMasks     = "no data";
    private var m_rowsDependencies = RcbArray();
    private var m_sourceRows       = RcbArray();

    private var m_application1 = NULL;
    private var m_application2 = NULL;
    private var m_application3 = NULL;
    private var m_application5 = NULL;
    private var m_application6 = NULL;
    private var m_application7 = NULL;
    private var m_application8 = NULL;

    private var m_isRecalculationInProcess = false;

    macro getApplication1()
        return m_application1;
    end;

    macro getApplication2()
        return m_application2;
    end;

    macro getApplication3()
        return m_application3;
    end;

    macro getApplication5()
        return m_application5;
    end;

    macro getApplication6()
        return m_application6;
    end;

    macro getApplication7()
        return m_application7;
    end;

    macro getApplication8()
        return m_application8;
    end;

    private macro initializeSourceRows()
        m_sourceRows[m_sourceRows.size] = m_application1.getRow("5.1");
        m_sourceRows[m_sourceRows.size] = m_application1.getRow("5.2");
        m_sourceRows[m_sourceRows.size] = m_application2.getRow("1");
        m_sourceRows[m_sourceRows.size] = m_application2.getRow("2");
        m_sourceRows[m_sourceRows.size] = m_application2.getRow("3");
        m_sourceRows[m_sourceRows.size] = m_application2.getRow("3.2");
        m_sourceRows[m_sourceRows.size] = m_application3.getRow("1.1");
        m_sourceRows[m_sourceRows.size] = m_application3.getRow("1.3");
        m_sourceRows[m_sourceRows.size] = m_application5.getRow("1");
        m_sourceRows[m_sourceRows.size] = m_application5.getRow("2");
        m_sourceRows[m_sourceRows.size] = m_application6.getRow("1");
        m_sourceRows[m_sourceRows.size] = m_application7.getRow("1");
        m_sourceRows[m_sourceRows.size] = m_application7.getRow("2");
        m_sourceRows[m_sourceRows.size] = m_application7.getRow("3");
    end;

    private macro initializeDependencies()
        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("1.2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application1.getRow("1.3");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[3] = m_application1.getRow("1.4");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[4] = m_application1.getRow("1.5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("2.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1.3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3.5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1.4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.6");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("1.5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("4.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.6");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("2.9");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("2.2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application1.getRow("2.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application6.getRow("5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.6"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.4");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("2.5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.7"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.8"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("1.5");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("2.9"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.7");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("2.8");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("3.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("3.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("3.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.6");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("3.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("3.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.9");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("3.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("3.3"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("4.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("4.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("4.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.6");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("3.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("4.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.9");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("3.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("5.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("5.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("5.1"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("5.2"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("6"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("6.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("6.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("6.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("4.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("5.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("6.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("4.2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("5.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("7"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("7.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("7.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("7.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("5.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("4.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("7.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("5.2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("4.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("8"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("6");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("7");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application1.getRow("9"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("6");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application1.getRow("7");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application7.getRow("1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application7.getRow("2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application7.getRow("3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application3.getRow("1.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application2.getRow("1.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("1.6"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("1.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application7.getRow("1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application7.getRow("2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application7.getRow("3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("2.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("2.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("2.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application7.getRow("1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application7.getRow("2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[3] = m_application7.getRow("3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application3.getRow("1.4");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application5.getRow("3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3.3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3.4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application2.getRow("3.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("3.5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("2.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application2.getRow("3.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application2.getRow("4.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application3.getRow("1"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application3.getRow("1.1"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application3.getRow("1.2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application3.getRow("1.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application3.getRow("1.3"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application3.getRow("1.4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application3.getRow("1.3");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application5.getRow("1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application2.getRow("3.2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application5.getRow("1.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application5.getRow("1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application5.getRow("2"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application5.getRow("2.1"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application5.getRow("2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application5.getRow("3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application5.getRow("1.1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application5.getRow("2.1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application6.getRow("1"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application6.getRow("2"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application6.getRow("1");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application6.getRow("3"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application6.getRow("2");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application6.getRow("4"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application1.getRow("2.4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application6.getRow("5"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application6.getRow("3");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application6.getRow("4");

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application7.getRow("1"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application7.getRow("2"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application7.getRow("3"), TArray());

        m_rowsDependencies[m_rowsDependencies.size]      = TRcbPair(m_application8.getRow("-"), TArray());
        m_rowsDependencies[m_rowsDependencies.size - 1].second[0] = m_application3.getRow("1.2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[1] = m_application3.getRow("1.3");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[2] = m_application5.getRow("3");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[3] = m_application6.getRow("5");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[4] = m_application7.getRow("1");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[5] = m_application7.getRow("2");
        m_rowsDependencies[m_rowsDependencies.size - 1].second[6] = m_application7.getRow("3");
    end;



    private macro makeBalanceMasks()
        var set = TRcbSet();

        macro fillSet(masks : TRcbSet)
            var iterator = masks.createIterator();

            iterator.moveFirst();
            while (not iterator.isDone())
                set.insert(iterator.getCurrentItem());
                iterator.moveNext();
            end;
        end;

        macro makeString()
            var iterator = set.createIterator();
            var masksString  : String = "";

            iterator.moveFirst();
            while (not iterator.isDone())
                masksString = masksString + "," + iterator.getCurrentItem();
                iterator.moveNext();
            end;

            return subStr(masksString, 2);
        end;


        var masksString = "";

        fillSet(m_balanceMasksSetForApplication1);
        fillSet(m_balanceMasksSetForApplication2);
        fillSet(m_balanceMasksSetForApplication3);
        fillSet(m_balanceMasksSetForApplication5);
        fillSet(m_balanceMasksSetForApplication6);
        fillSet(m_balanceMasksSetForApplication7);
        m_balanceMasks = makeString();
    end;

    private macro initializeMasksSet()
        m_balanceMasksSetForApplication1 = m_application1.getBalanceMasksSet();
        m_balanceMasksSetForApplication2 = m_application2.getBalanceMasksSet();
        m_balanceMasksSetForApplication3 = m_application3.getBalanceMasksSet();
        m_balanceMasksSetForApplication5 = m_application5.getBalanceMasksSet();
        m_balanceMasksSetForApplication6 = m_application6.getBalanceMasksSet();
        m_balanceMasksSetForApplication7 = m_application7.getBalanceMasksSet();
    end;

    macro getMasksSetForApplication(applicationName : String)
        if (    (m_balanceMasksSetForApplication1 == NULL)
            and (m_balanceMasksSetForApplication2 == NULL)
            and (m_balanceMasksSetForApplication3 == NULL)
            and (m_balanceMasksSetForApplication5 == NULL)
            and (m_balanceMasksSetForApplication6 == NULL)
            and (m_balanceMasksSetForApplication7 == NULL))
            initializeMasksSet();
        end;

        if (applicationName == "Приложение1")
            return m_balanceMasksSetForApplication1;
        elif (applicationName == "Приложение2")
            return m_balanceMasksSetForApplication2;
        elif (applicationName == "Приложение3")
            return m_balanceMasksSetForApplication3;
        elif (applicationName == "Приложение5")
            return m_balanceMasksSetForApplication5;
        elif (applicationName == "Приложение6")
            return m_balanceMasksSetForApplication6;
        elif (applicationName == "Приложение7")
            return m_balanceMasksSetForApplication7;
        end;
    end;

    private macro constructor()
        m_application1 = TApplication1();

        if (global.parameters.getEndDate() >= RCB_I1951_DATE)
            /*Изменения заключаются в проверке, что на л\счете нет значения категории, поэтому зависимости от Даты_2184-У нет.*/
            m_application2 = TApplication2_2184();

        elif (global.parameters.getEndDate() >= RCB_I1827_DATE)

            m_application2 = TApplication2_1827();
        else
            m_application2 = TApplication2();
        end;

        if (global.parameters.getEndDate() >= RCB_I1951_DATE)

            m_application3 = TApplication3_1951();
        else
            m_application3 = TApplication3();
        end;

        m_application5 = TApplication5();
        m_application6 = TApplication6();
        m_application7 = TApplication7();
        m_application8 = TApplication8();

        initializeDependencies();
    end;

    private macro fillTempTable(tempTable : TTempTable)

        if (global.parameters.isDataBalance())
            m_application7.fillTempTableForBalanceData(tempTable);
            m_application2.fillTempTableForBalanceData(tempTable);
            m_application3.fillTempTableForBalanceData(tempTable);
            m_application5.fillTempTableForBalanceData(tempTable);
            m_application6.fillTempTableForBalanceData(tempTable);
        else
            m_application7.fillTempTable(tempTable);
            m_application2.fillTempTable(tempTable);
            m_application3.fillTempTable(tempTable);
            m_application5.fillTempTable(tempTable);
            m_application6.fillTempTable(tempTable);
        end;
    end;

    macro getRowDependencies(applicationName : String, rowCode : String)
        var i = 0;
        while (i < m_rowsDependencies.size)
            if (    (m_rowsDependencies[i].first.getApplicationName() == applicationName)
                and (m_rowsDependencies[i].first.getCode() == rowCode))
                return m_rowsDependencies[i].second;
            end;
            i = i + 1;
        end;
        return NULL;
    end;

    macro getBalanceMasks()
        if (m_balanceMasks == "no data")
            initializeMasksSet();
            makeBalanceMasks();
        end;
        return m_balanceMasks;
    end;

    private macro isSourceRow(row : Object)
        if (m_sourceRows.size == 0)
            initializeSourceRows();
        end;

        var i : Integer = 0;

        while (i < m_sourceRows.size)
            if ((row.getCode() == m_sourceRows[i].getCode()) and (row.getApplicationName() == m_sourceRows[i].getApplicationName()))
                return true;
            end;
            i = i + 1;
        end;
        return false;
    end;

    macro checkBalance() : Bool
        return global.balanceData.isCalculated();
    end;

    private macro saveAttributes()
        m_application1.saveAttributes();
        m_application2.saveAttributes();
        m_application3.saveAttributes();
        m_application5.saveAttributes();
        m_application6.saveAttributes();
        m_application7.saveAttributes();
        m_application8.saveAttributes();
    end;

    private macro normalizeDecoding()
        m_application1.normalizeDecoding();
        m_application2.normalizeDecoding();
        m_application3.normalizeDecoding();
        m_application5.normalizeDecoding();
        m_application6.normalizeDecoding();
        m_application7.normalizeDecoding();
        m_application8.normalizeDecoding();
    end;

    macro recalculateItogValues(isCalculateMethod : Bool)
        isCalculateMethod = nvl(isCalculateMethod, true);

        m_isRecalculationInProcess = true;

        initProgress(-1, "Удаление итоговых значений", "Удаление итоговых значений");
        var i : Integer = 0;

        while (i < m_rowsDependencies.size)
            if (isSourceRow(m_rowsDependencies[i].first))
                m_rowsDependencies[i].first.setSaved(true);
            else
                m_rowsDependencies[i].first.removeValues();
                m_rowsDependencies[i].first.setSaved(false);
            end;

            i = i + 1;
        end;
        remProgress();

        initProgress(-1, "Нормализация расшифровок", "Нормализация расшифровок");
        normalizeDecoding();
        remProgress();

        initProgress(-1, "Пересчет итоговых значений", "Пересчет итоговых значений");
        saveAttributes();
        remProgress();


        if (not isCalculateMethod)
            initProgress(-1, "Сохранение итоговых значений", "Сохранение итоговых значений");
            rcbApplication().transactionManager.commit();
            remProgress();
        end;

        m_isRecalculationInProcess = false;
    end;

    macro calculate()
        var timeMarker = TTimeMarker(getTxtFileName("ForCalculateTimeMarker"));
        var tempTable  = NULL;

        var sqlProfiler = TSqlProfiler(getTxtFileName("ForSql"));

        sqlProfiler.clear();

        sqlProfiler.on();

        timeMarker.clearFile();

        message("Проверка баланса");
        if (not checkBalance())
            RepErrorsQueue().add(0, global.balanceData.getErrorMessage());
            global.m_calculateProtocol.setProtocolOutput(true);
            global.m_calculateProtocol.printLine(global.balanceData.getErrorMessage());
            global.m_calculateProtocol.resetProtocolOutput();
            global.m_calculateProtocol.show();
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;
        timeMarker.setMark("Проверка баланса                   ");

        message("Заполнение данных о резервах");
        global.userDataInputer.input();
        timeMarker.setMark("Заполнение данных о резервах       ");

        message("Заполнение таблицы первичных данных");
        global.tempTable = TTempTable();
        timeMarker.setMark("Заполнение таблицы первичных данных");

        message("Заполнение таблицы данных по б/с");
        fillTempTable(global.tempTable);
        timeMarker.setMark("Заполнение таблицы данных по б/с   ");

        message("Расчет атрибутов отчета");
        saveAttributes();
        timeMarker.setMark("Расчет атрибутов отчета            ");

        message("Нормализация и пересчет итогов");
        recalculateItogValues(true);
        timeMarker.setMark("Нормализация и пересчет итогов     ");

        message("Сохранение атрибутов отчета");
        rcbApplication().transactionManager.commit();
        timeMarker.setMark("Сохранение атрибутов формы         ");

        timeMarker = null;

        //вывод протоколов нормализации
        normalizationProtocolWithErrors.show();
        normalizationProtocol.show();
    end;

    macro normalize()
        if( not checkBalance())
            RepErrorsQueue().add(0, global.balanceData.getErrorMessage());
            msgbox(global.balanceData.getErrorMessage());

            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        initProgress(-1, "Нормализация расшифровок", "Нормализация расшифровок");
        normalizeDecoding();
        remProgress();

        initProgress(-1, "Сохранение атрибутов отчета", "Сохранение атрибутов отчета");
        rcbApplication().transactionManager.commit();
        remProgress();

        //вывод протоколов нормализации
        normalizationProtocolWithErrors.show();
        normalizationProtocol.show();
    end;

    macro controlBeforeSummation()
        if( not checkBalance())
            rcbApplication.summator.printLogLine(global.balanceData.getErrorMessage());

            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;
    end;

    macro print()
        initProgress(-1, "Печать Приложения 1", "Печать Приложения 1");
        m_application1.print();
        remProgress();

        initProgress(-1, "Печать Приложения 2", "Печать Приложения 2");
        m_application2.print();
        remProgress();

        initProgress(-1, "Печать Приложения 3", "Печать Приложения 3");
        m_application3.print();
        remProgress();

        initProgress(-1, "Печать Приложения 5", "Печать Приложения 5");
        m_application5.print();
        remProgress();

        initProgress(-1, "Печать Приложения 6", "Печать Приложения 6");
        m_application6.print();
        remProgress();

        initProgress(-1, "Печать Приложения 7", "Печать Приложения 7");
        m_application7.print();
        remProgress();

        initProgress(-1, "Печать данных о приложениях, не вошедших в состав отчета", "Печать данных о приложениях, не вошедших в состав отчета");
        m_application8.print();
        remProgress();
    end;

    macro getRecalculateProcessFlag()
        return m_isRecalculationInProcess;
    end;

    constructor();
end;
