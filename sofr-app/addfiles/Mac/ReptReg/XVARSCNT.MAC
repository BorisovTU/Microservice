/*───────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.004.23, 6.020.25                             R-Style Software Lab
  Файл подсистемы "Отчеты ЦБ"

  Распечатка составляющих переменной, если переменная получается вычислением
  суммы других переменных.

└───────────────────────────────────────────────────────────────────────────*/

IMPORT ReptCBInter, cb_sql, rsbDataSet;

private var 
    indent = 2, /* Отступ. Количество пробелов на которое сдвигается описание составляющей */
    depth  = 1; /* Глубина рекурсивного просмотра списка составляющих. 0 - полностью. 
                   По умолчанию depth  = 1, т.е. показываются только непосредственные составляющие
                   переменных текущей формы*/



private var 
    prevDate = ПредДатаОтчета,
    repDate = ДатаОтчета,
    prevRepDate = ДатаОтчетаПП,
    prevPrevDate = ПредДатаОтчетаПП,
    numDprt = НомерПодразделения,
    NotInThousands = РасчетВКопейках,
    OrgStruct =  RcbOrganizationStructure,
    isSummaryMode,
    formName = {Название Отчета},
    VarName = {Имя переменной},
    levelCondition = "",
    VarCondition = "", 
    formId,
    val = NULL;

if(RcbIsSummaryMode) 
    isSummaryMode = "CHR (88)";
else
    isSummaryMode = "CHR (0)";
end;

if (depth != 0)
    levelCondition = " AND LEVEL <= " + depth + " ";
end;


private macro ActiveKind( varKind )
  if ( (varKind == RXVK_BAL_ACTIVE) or (varKind == RXVK_BAL_INACT) )
    return True;
  end;
  return False;
end;


private macro StrFill( Chr, Count)
var
   str = "";

  while ( Count > 0 )
    str = str + Chr;
    Count = Count - 1;
  end;

  return str;
end;

private macro Print35(str)
    if(StrLen(str)<35)
        print(str:35);
    else
        print(str);
    end;
end;

private macro Print55(str)
    if(StrLen(str)<55)
        print(str:55);
    else
        print(str);
    end;
end;

/* Расчет одного значения из списка составляющих переменных  */
/* Возвращает входное значение, умноженное на знак коэффициента */
private MACRO CalcVal
(
  szCoeff, /* Строковый коэффициент */
  lmMean,   /* Входное значение      */
  cVarKind /* Вид переменной - активыный балансовый счет */
)
var
   lastChar = 0,
   len = strlen( szCoeff);

  if ( not len ) /* Нет коэффициента */
    lmMean = 0;
    return lmMean;
  else
    lastChar = Substr( szCoeff, len, 1);
  end;

  if   ( lastChar == "А" )
    if ( ActiveKind( cVarKind) )
      lmMean = -lmMean;
    end;
    if ( lmMean > 0 )
      lmMean = 0.;
    end;
    if ( ActiveKind( cVarKind) )
      lmMean = -lmMean;
    end;
    szCoeff = SubStr( szCoeff, 1, len-1);
  elif ( lastChar == "П" )
    if ( ActiveKind( cVarKind) )
      lmMean = -lmMean;
    end;
    if ( lmMean < 0 )
      lmMean = 0.;
    end;
    if ( ActiveKind( cVarKind) )
      lmMean = -lmMean;
    end;
    szCoeff = SubStr( szCoeff, 1, len-1);
  elif ( lastChar == "." ) /* Нормализуем */
    szCoeff  = szCoeff + "0";
  elif ( index( "0123456789", lastChar) <= 0 )
    MsgBox( "Неверно введен коэффициент");
    Exit( 1);
  end;

  return  lmMean * DoubleL( szCoeff);
END;

private var variableArray = TArray();

private class variableStack
    var iFormId = 0;
    var iVarId = 0;

    macro push(f, v)
        if((f != NULL) and (v != NULL))
            iFormId = f;
            iVarId = v;
        end;
        variableArray[variableArray.size()] = this;
    end;
  
    macro pop()
        var v = variableArray[variableArray.size()-1];
        this.iFormId = v.iFormId;
        this.iVarId = v.iVarId;
        variableArray.size = variableArray.size - 1;
    end;

    macro size()
        return variableArray.size();
    end;

    macro is(f, v)
        return (iFormId == f) and (iVarId == v);
    end;

end;

private macro CorrFunc(level, szCFunction, szCF_Macro, szCF_Parm)
    if ( CodeFor(szCFunction) != 1 )
        print( StrFill( " ", level*indent));
        print( "  Данные корректируются функцией \"", szCFunction, "\"");
        if ( CodeFor(szCF_Macro) != 1 )
            print( " из макроса \"", szCF_Macro, "\"");
        end;
        println;
        if ( CodeFor(szCF_Parm) != 1 )
            print( StrFill( " ", level*indent));
            println( "  Для функции задана строка параметров: \"", szCF_Parm, "\"");
        end;
    end;
end;

private macro Correspondence(iFormId, iVarId, level, cFlagPrevPeriod)
    var pDate, valCorr;
    if((cFlagPrevPeriod == NULL) or (CodeFor(cFlagPrevPeriod) == 0))
        pDate = prevDate;
    else
        pDate = prevPrevDate;
    end;
    var query =
        "SELECT f.t_szformname, v.t_szvarname, c.t_cfirstkind, c.t_cfirstplan,       "+
        "       c.t_szfirstname, c.t_csecondkind, c.t_csecondplan, c.t_szsecondname, "+
        "       c.t_szcoeff, c.t_isort, m.t_mean1, m.t_mean2,                        "+
        "       v.t_cFormat, v.t_iPrecision                                          "+
        "  FROM dcy_cordt_dbt c, dcy_forms_dbt f, dcy_varsd_dbt v, dcy_mturn_dbt m   "+
        " WHERE v.t_iformid = f.t_iformid(+)                                         "+
        "   AND v.t_iformid = c.t_iformid(+)                                         "+
        "   AND v.t_ivarid = c.t_ivarid(+)                                           "+
        "   AND v.t_iformid = " + iFormId + "                                        "+
        "   AND v.t_ivarid = " + iVarId + "                                          "+
        "   AND m.t_issummary(+) = " + isSummaryMode + "                             "+
        "   AND m.t_issuemode(+) = " + RcbIssueMode + "                              "+
        "   AND m.t_organizationstructure(+) = " + OrgStruct + "                     "+
        "   AND m.t_bdprevdate(+) = TO_DATE ('" + pDate + "', 'DD-MM-YYYY')          "+
        "   AND m.t_isort(+) = c.t_isort                                             "+
        "   AND m.t_ivarid(+) = c.t_ivarid                                           "+
        "   AND m.t_iformid(+) = c.t_iformid                                         ";
                                                                                     
                                                                                     
    var rs = TRsbDataSet(query);                                        

    while(rs.moveNext())
        println( StrFill(" ", level*indent),"  ",
                 rs.value("t_szFormName"),
                  ".",
                 rs.value("t_szVarName"),
                 ".",
                 rs.value("t_iSort"));
        print( StrFill(" ", level*indent), "    " );
        Print55(string( rs.value("t_cFirstKind"), 
                        rs.value("t_cFirstPlan"), " : ", 
                        rs.value("t_szFirstName"), " ==> ",
                        rs.value("t_cSecondKind"), 
                        rs.value("t_cSecondPlan") ," : ", 
                        rs.value("t_szSecondName"), " (",
                        rs.value("t_szCoeff"), ")"));
        if(rs.value("t_mean1") == NULL)
            println( "===  Не определено  ===":40:c);
        else
            if ( NotInThousands )
                valCorr = rs.value("t_mean1");
                println( valCorr:19:2);
            else
                valCorr = rs.value("t_mean2");
                CnvToWork2(valCorr, valCorr, rs.value("t_cFormat"), rs.value("t_iPrecision"));
                println( valCorr:16:0);
            end;
        end;
    end;
end;




private macro PrintReport()

var cmd = 
    "SELECT     LEVEL t_level, t.t_iformid t_iformid, t.t_ivarid t_ivarid,                          "+
    "           t.t_iinformid t_iinformid, t.t_iinvarid t_iinvarid,                                 "+
    "           t.t_szcoeff t_szcoeff, t.t_szformname t_szformname, t.t_szvarname t_szvarname,      "+
    "           t.t_szcomment t_szcomment, t.t_szinformname t_szinformname,                         "+
    "           t.t_szinvarname t_szinvarname, t.t_szincomment t_szincomment,                       "+
    "           t.t_cvarkind t_cvarkind, t.t_szCFunction t_szcfunction, t.t_szCF_Macro t_szCF_Macro,"+
    "           t.t_szCF_Parm t_szCF_Parm, t.t_szInCFunction t_szInCFunction,                       "+
    "           t.t_szInCF_Macro t_szInCF_Macro, t.t_szInCF_Parm t_szInCF_Parm,                     "+
    "           t.t_cflagprevperiod t_cflagprevperiod, t.t_cFormat t_cFormat,                       "+
    "           t.t_iPrecision t_iPrecision,                                                        ";
if ( NotInThousands )
    cmd = cmd +
    "           DECODE (t_cflagprevperiod,                                                          "+
    "                   CHR (0), DECODE( t_cconstant, CHR (88),                                     "+
    "                   (SELECT mrcn.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrcn                                         "+
    "                              WHERE mrcn.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrcn.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrcn.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrcn.t_bdprevdate(+) <=                                    "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrcn.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrcn.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrcn.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrcn.t_issuemode(+) = " + RcbIssueMode + "                 "+
    "                                AND (   mrcn.t_bdprevdate IS NULL                              "+
    "                                     OR mrcn.t_bdprevdate =                                    "+
    "                                           (SELECT MAX (t_bdprevdate)                          "+
    "                                              FROM dcy_mreal_dbt                               "+
    "                                             WHERE t_iformid = t_iinformid                     "+
    "                                               AND t_ivarid = t_iinvarid                       "+
    "                                               AND t_inumdprt = " + numDprt + "                "+
    "                                               AND t_bdrepdate =                               "+
    "                                                      TO_DATE ('01.01.0001',                   "+
    "                                                               'DD.MM.YYYY'                    "+
    "                                                              )                                "+
    "                                               AND t_issummary = " + isSummaryMode + "         "+
    "                                               AND t_organizationstructure = " + OrgStruct + " "+
    "                                               AND t_issuemode = " + RcbIssueMode + " )        "+
    "                                    )),                                                        "+
    "                       DECODE(t_cdoubledates, 'X',                                         "+
    "                   (SELECT mrdd.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrdd                                         "+
    "                              WHERE mrdd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrdd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrdd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrdd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('"+ prevDate +"', 'DD.MM.YYYY')             "+
    "                                AND mrdd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrdd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrdd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrdd.t_issuemode(+) = " + RcbIssueMode + "),               "+
    "                   (SELECT mrsd.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrsd                                         "+
    "                              WHERE mrsd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrsd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrsd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrsd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrsd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrsd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrsd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrsd.t_issuemode(+) = " + RcbIssueMode + "))),             "+
    "                            DECODE( t_cconstant, CHR (88),                                     "+
    "                   (SELECT mrcn.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrcn                                         "+
    "                              WHERE mrcn.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrcn.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrcn.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrcn.t_bdprevdate(+) <=                                    "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrcn.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrcn.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrcn.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrcn.t_issuemode(+) = " + RcbIssueMode + "                 "+
    "                                AND (   mrcn.t_bdprevdate IS NULL                              "+
    "                                     OR mrcn.t_bdprevdate =                                    "+
    "                                           (SELECT MAX (t_bdprevdate)                          "+
    "                                              FROM dcy_mreal_dbt                               "+
    "                                             WHERE t_iformid = t.t_iinformid                   "+
    "                                               AND t_ivarid = t.t_iinvarid                     "+
    "                                               AND t_inumdprt = " + numDprt + "                "+
    "                                               AND t_bdrepdate =                               "+
    "                                                      TO_DATE ('01.01.0001',                   "+
    "                                                               'DD.MM.YYYY'                    "+
    "                                                              )                                "+
    "                                               AND t_issummary = " + isSummaryMode + "         "+
    "                                               AND t_organizationstructure = " + OrgStruct + " "+
    "                                               AND t_issuemode = " + RcbIssueMode + " )        "+
    "                                    )),                                                        "+
    "                       DECODE(t_cdoubledates, 'X',                                         "+
    "                   (SELECT mrdd.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrdd                                         "+
    "                              WHERE mrdd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrdd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrdd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrdd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('"+ prevPrevDate +"', 'DD.MM.YYYY')         "+
    "                                AND mrdd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrdd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrdd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrdd.t_issuemode(+) = " + RcbIssueMode + "),               "+
    "                   (SELECT mrsd.t_mean1                                                        "+
    "                               FROM dcy_mreal_dbt mrsd                                         "+
    "                              WHERE mrsd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrsd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrsd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrsd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrsd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrsd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrsd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrsd.t_issuemode(+) = " + RcbIssueMode +")))) t_mean,     ";
else
    cmd = cmd +
    "           DECODE (t_cflagprevperiod,                                                          "+
    "                   CHR (0), DECODE( t_cconstant, CHR (88),                                     "+
    "                   (SELECT mrcn.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrcn                                         "+
    "                              WHERE mrcn.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrcn.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrcn.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrcn.t_bdprevdate(+) <=                                    "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrcn.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrcn.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrcn.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrcn.t_issuemode(+) = " + RcbIssueMode + "                 "+
    "                                AND (   mrcn.t_bdprevdate IS NULL                              "+
    "                                     OR mrcn.t_bdprevdate =                                    "+
    "                                           (SELECT MAX (t_bdprevdate)                          "+
    "                                              FROM dcy_mreal_dbt                               "+
    "                                             WHERE t_iformid = t.t_iinformid                   "+
    "                                               AND t_ivarid = t.t_iinvarid                     "+
    "                                               AND t_inumdprt = " + numDprt + "                "+
    "                                               AND t_bdrepdate =                               "+
    "                                                      TO_DATE ('01.01.0001',                   "+
    "                                                               'DD.MM.YYYY'                    "+
    "                                                              )                                "+
    "                                               AND t_issummary = " + isSummaryMode + "         "+
    "                                               AND t_organizationstructure = " + OrgStruct + " "+
    "                                               AND t_issuemode = " + RcbIssueMode + " )        "+
    "                                    )),                                                        "+
    "                       DECODE(t_cdoubledates, 'X',                                         "+
    "                   (SELECT mrdd.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrdd                                         "+
    "                              WHERE mrdd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrdd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrdd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrdd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('"+ prevDate +"', 'DD.MM.YYYY')             "+
    "                                AND mrdd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrdd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrdd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrdd.t_issuemode(+) = " + RcbIssueMode + "),               "+
    "                   (SELECT mrsd.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrsd                                         "+
    "                              WHERE mrsd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrsd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrsd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrsd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrsd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ repDate +"', 'DD.MM.YYYY')              "+
    "                                AND mrsd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrsd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrsd.t_issuemode(+) = " + RcbIssueMode + "))),             "+
    "                            DECODE( t_cconstant, CHR (88),                                     "+
    "                   (SELECT mrcn.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrcn                                         "+
    "                              WHERE mrcn.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrcn.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrcn.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrcn.t_bdprevdate(+) <=                                    "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrcn.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrcn.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrcn.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrcn.t_issuemode(+) = " + RcbIssueMode + "                 "+
    "                                AND (   mrcn.t_bdprevdate IS NULL                              "+
    "                                     OR mrcn.t_bdprevdate =                                    "+
    "                                           (SELECT MAX (t_bdprevdate)                          "+
    "                                              FROM dcy_mreal_dbt                               "+
    "                                             WHERE t_iformid = t.t_iinformid                   "+
    "                                               AND t_ivarid = t.t_iinvarid                     "+
    "                                               AND t_inumdprt = " + numDprt + "                "+
    "                                               AND t_bdrepdate =                               "+
    "                                                      TO_DATE ('01.01.0001',                   "+
    "                                                               'DD.MM.YYYY'                    "+
    "                                                              )                                "+
    "                                               AND t_issummary = " + isSummaryMode + "         "+
    "                                               AND t_organizationstructure = " + OrgStruct + " "+
    "                                               AND t_issuemode = " + RcbIssueMode + " )        "+
    "                                    )),                                                        "+
    "                       DECODE(t_cdoubledates, 'X',                                         "+
    "                   (SELECT mrdd.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrdd                                         "+
    "                              WHERE mrdd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrdd.t_ivarid(+) = t.t_iinvarid                            "+
    "                                AND mrdd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrdd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('"+ prevPrevDate +"', 'DD.MM.YYYY')         "+
    "                                AND mrdd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrdd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrdd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrdd.t_issuemode(+) = " + RcbIssueMode + "),               "+
    "                   (SELECT mrsd.t_mean2                                                        "+
    "                               FROM dcy_mreal_dbt mrsd                                         "+
    "                              WHERE mrsd.t_iformid(+) = t.t_iinformid                          "+
    "                                AND mrsd.t_ivarid(+) = t_iinvarid                              "+
    "                                AND mrsd.t_inumdprt(+) = " + numDprt + "                       "+
    "                                AND mrsd.t_bdprevdate(+) =                                     "+
    "                                          TO_DATE ('01.01.0001', 'DD.MM.YYYY')                 "+
    "                                AND mrsd.t_bdrepdate(+) =                                      "+
    "                                          TO_DATE ('"+ prevRepDate +"', 'DD.MM.YYYY')          "+
    "                                AND mrsd.t_issummary(+) = " + isSummaryMode + "                "+
    "                                AND mrsd.t_organizationstructure(+) = " + OrgStruct + "        "+
    "                                AND mrsd.t_issuemode(+) = " + RcbIssueMode + ")))) t_mean,    ";
end;
    cmd = cmd +
    "            NVL((SELECT SUM(1) FROM dcy_cordt_dbt c                                            "+
    "             WHERE c.t_iFormId = t.t_iformid AND c.t_iVarId = t.t_iVarId), 0) t_cor,           "+
    "            NVL((SELECT SUM(1) FROM dcy_cordt_dbt c                                            "+
    "             WHERE c.t_iFormId = t.t_iInformid AND c.t_iVarId = t.t_iInVarId), 0) t_corIn      "+
    "      FROM (SELECT DISTINCT v.t_iformid t_iformid, v.t_ivarid t_ivarid,                        "+
    "                            NVL (av.t_iinformid, 0) t_iinformid,                               "+
    "                            NVL (av.t_iinvarid, 0) t_iinvarid,                                 "+
    "                            av.t_cflagprevperiod t_cflagprevperiod,                            "+
    "                            av.t_szcoeff t_szcoeff, v.t_isort t_isort,                         "+
    "                            v.t_szvarname t_szvarname, vi.t_isort t_iinsort,                   "+
    "                            v.t_szcomment t_szcomment,                                         "+
    "                            f.t_szformname t_szformname,                                       "+
    "                            vi.t_szvarname t_szinvarname,                                      "+
    "                            vi.t_szcomment t_szincomment,                                      "+
    "                            vi.t_cvarkind t_cvarkind,                                          "+
    "                            vi.t_cFormat t_cFormat, vi.t_iPrecision t_iPrecision,              "+
    "                            fi.t_szformname t_szinformname,                                    "+
    "                            vi.t_cconstant t_cconstant, vi.t_cdoubledates t_cdoubledates,      "+
    "                            v.t_szCFunction t_szCFunction, v.t_szCF_Macro t_szCF_Macro,        "+
    "                            v.t_szCF_Parm t_szCF_Parm,                                         "+
    "                            vi.t_szCFunction t_szInCFunction,                                  "+
    "                            vi.t_szCF_Macro t_szInCF_Macro, vi.t_szCF_Parm t_szInCF_Parm       "+
    "                       FROM dcy_algv_dbt av,                                                   "+
    "                            dcy_varsd_dbt v,                                                   "+
    "                            dcy_forms_dbt f,                                                   "+
    "                            dcy_varsd_dbt vi,                                                  "+
    "                            dcy_forms_dbt fi                                                   "+
    "                      WHERE v.t_iformid = av.t_iformid(+)                                      "+

    "                        AND v.t_bdInclude <= " + getSqlDate(ДатаОтчета)                         + 
    "                        AND v.t_bdExclude >  " + getSqlDate(ДатаОтчета)                         +

    "                        AND v.t_ivarid = av.t_ivarid(+)                                        "+
    "                        AND v.t_iformid = f.t_iformid                                          "+
    "                        AND vi.t_iformid(+) = av.t_iinformid                                   "+
    "                        AND vi.t_ivarid(+) = av.t_iinvarid                                     "+
    "                        AND vi.t_iformid = fi.t_iformid(+)) t                                  "+
    "     WHERE (   t.t_iinformid != 0                                                              "+
    "            OR t.t_iformid = " + formId + "                                                    "+
    "           )" + levelCondition + "                                                             "+
    "START WITH t.t_iformid = " + formId + " " + VarCondition + "                                   "+
    "CONNECT BY t.t_iformid = PRIOR t.t_iinformid AND t.t_ivarid = PRIOR t.t_iinvarid               ";

    /*
    var txt = strsplit2(cmd, 80);
    var i = 0;
    while (i < txt.size())
        println(txt[i]);
        i = i + 1;
    end;
    exit(0);
    */

    private var rs = TRsbDataSet(cmd);

    var prevVar : variableStack;
    var rootFormId = 0, rootVarId = 0; 

    while( rs.moveNext() )
        if( (prevVar.size() != 0))
            if (not prevVar.is(rs.value("t_iFormId"), rs.value("t_iVarId")))
                prevVar.pop();
            end;
        end;

        if( (prevVar.size() == 0))
            if( (rs.value("t_level") == 1) and ((rootFormId != rs.value("t_iFormId")) or (rootVarId != rs.value("t_iVarId"))))
                rootFormId = rs.value("t_iFormId");
                rootVarId = rs.value("t_iVarId");
                println();
                print(rs.value("t_szVarName"));
                if( CodeFor(rs.value("t_szComment")) != 1 )
                    print( " ",rs.value("t_szComment") );
                end;
                println();
                CorrFunc(rs.value("t_level"), rs.value("t_szCFunction"), rs.value("t_szCF_Macro"), 
                    rs.value("t_szCF_Parm"));
                if(rs.value("t_cor") > 0)
                    Correspondence(rs.value("t_iFormId"), rs.value("t_iVarId"), rs.value("t_level"));
                end;
            end;
            prevVar.push(rs.value("t_iFormId"),rs.value("t_iVarId"));
        end;

        if(prevVar.is(rs.value("t_iFormId"), rs.value("t_iVarId")))
            if( not ((rs.value("t_iInFormId") == 0) and (rs.value("t_iInVarId") == 0)))
                print(StrFill(" ", rs.value("t_level") * indent));
                print35(String(rs.value("t_szInFormName"),".",rs.value("t_szInVarName"))); // Имя переменной

                val = rs.value("t_mean");

                if ( (ValType(val) == V_UNDEF) or (val == NULL) ) /* Не определено значение переменной */
                    val = "Не определено";
                end;

                if( not ( ValType( val) == V_STRING ) )
                    print( " = (");
                    if ( NotInThousands )
                        print( string( val:19:2, " * ", rs.value("t_szCoeff"):4:c, ") = ", 
                            CalcVal( rs.value("t_szCoeff"), val, rs.value("t_cVarKind")):19:2));
                    else
                        CnvToWork2(val, val, rs.value("t_cFormat"), rs.value("t_iPrecision"));
                        print( string( val:16:0, " * ", rs.value("t_szCoeff"):4:c, ") = ", 
                            CalcVal( rs.value("t_szCoeff"), val, rs.value("t_cVarKind")):16:2));
                    end;
                elif ( ValType( val) == V_STRING )
                    print( string( "===  Не определено  ==="):47:c);
                else
                    MsgBox( "Неопределенная ситуация при вычислении значения переменной|\""
                          + rs.value("t_szInFormName") + "." + rs.value("t_szInVarName") + "\"");
                    Exit( 1);
                end;
                
                print(" : ");
                if( CodeFor(rs.value("t_szInComment")) != 1 )
                    print( rs.value("t_szInComment") );
                end;
                println();
                    CorrFunc(rs.value("t_level"), rs.value("t_szInCFunction"), rs.value("t_szInCF_Macro"), 
                             rs.value("t_szInCF_Parm"));
                if(rs.value("t_corIn") > 0)
                    Correspondence(rs.value("t_iInFormId"), rs.value("t_iInVarId"), rs.value("t_level"),
                                   rs.value("t_cflagprevperiod"));
                end;
            else 
                prevVar.pop();
            end;
        end;
    end; /* while(rs.MoveNext()) */
end;



PRIVATE MACRO START()
    VAR
        i = 0, len = 0, maxlen = 0, result = 0;


    ARRAY dir;

    var query = 
        "select d.t_iVarId t_iVarId,                                      "+
        "       v.t_szVarKindName t_szVarKindName,                        "+
        "       f.t_iMultiKind t_iMultiKind,                              "+
        "       f.t_iFormId t_iFormId,                                    "+
        "       v.t_cVarKind t_cVarKind                                   "+
        "  from dcy_varsk_dbt v, dcy_forms_dbt f, dcy_varsd_dbt d         "+
        " where f.t_szFormName = '" + formName + "'                       "+
        "   and v.t_iFormId(+) = f.t_iFormId                              "+
        "   and d.t_iFormId(+) = f.t_iFormId                              "+
        "   and d.t_szVarName(+) = '" + varName + "'                      "+
        "   and ((v.t_cvarkind = d.t_cvarkind) or (v.t_cvarkind is null)) ";

    var rs = TRsbDataSet(query);
    if(not rs.moveNext()) 
        return;
    end;

    formId = rs.value("t_iFormId");
    dir( 0) = "Для одной переменной \"" + varName + "\"";
    dir( 1) = "Для всего приложения \"" + formName + "\"";

    if( rs.value("t_iMultiKind") )
        if ( rs.value("t_szVarKindName") != NULL )
            dir( 2) = "Для вида переменных \"" + rs.value("t_szVarKindName") + "\"";
        end;
    end;
    while ( i < ASize( dir) )
        len = strlen( dir( i));
        if ( len > maxlen )
            maxlen = len;
        end;
        i = i+1;
    end;
    maxlen = maxlen + 6; /* Add spaces to image */
    i = 0;
    while ( i < ASize( dir) )
        len = strlen( dir( i));
        dir( i) =   StrFill( " ", Int( (maxlen - len)/2))
                  + dir( i)
                  + StrFill( " ", Int( (maxlen - len)/2));
        i = i+1;
    end;

    result = Menu( dir, "", "Вид отчета");

    ASize( dir, 0); /* Убрать массив */

    if ( result == 0 )
        varCondition = " AND t_ivarid = " + rs.value("t_iVarId") + " "; 
        PrintReport;
    elif ( result == 1 )
        PrintReport;
    elif ( result == 2 )
        varCondition = " AND t_cVarKind = '" + rs.value("t_cVarKind") + "' "; 
        PrintReport;
    end;
END;



/****************************************************************
 ***                     Точка входа                          ***
 ****************************************************************/


START();

/* eof */