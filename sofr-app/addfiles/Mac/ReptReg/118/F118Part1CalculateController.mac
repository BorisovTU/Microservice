class (F118PartCalculateControllerDecorator) F118Part1CalculateController(partController : Object)
    initF118PartCalculateControllerDecorator(partController);

    private macro getPreprocessAttribute6LoansData()
        var dataSource = m_dataSources.getDataSource("Loans");
        var filter     = m_dataSouceFilters.getFilter("Loans");

        const ATRIBUTE_ID = "6";

        // 2 - Залог ЦБ
        filter.isGuarantyTypeIn("2").op("AND").countryRating(">=", "2").op("AND").op("NOT").isRiskGroupIn("1");
        
        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute7LoansData()
        var dataSource = m_dataSources.getDataSource("Loans");
        var filter     = m_dataSouceFilters.getFilter("Loans");

        const ATRIBUTE_ID = "7";

        /*
          Виды регистров
          1  - Основной долг
          2  - Просроченный ОД
          16 - Неразрешенный ОД
          17 - Просроченный неразрешенный ОД
          62 - Оплаченная гарантия
          64 - Просроченная оплаченная гарантия
         */
        filter.isRegisterTypeIn("1, 2, 16, 17, 62, 64");
        
        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute8LoansData()
        var dataSource = m_dataSources.getDataSource("Loans");
        var filter     = m_dataSouceFilters.getFilter("Loans");

        const ATRIBUTE_ID = "8";
         
        filter.isKrv();

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute6BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "6";


        filter.countryRating(">=", "2").op("AND").isChapterIn("3").op("AND").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), ATRIBUTE_ID, BOCB).getMasks());
        filter.op("AND").op("NOT").guarantyIssuerIsPhysical().op("AND").op("NOT").guarantyIssuerIsBank().op("AND").isGuarantyForAccountFirstQuality();
        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter, "_Иное");
    end;

    private macro getPreprocessAttribute7BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "7";

        filter.isChapterIn("1").op("AND").op("(");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.1", BOCB).getMasks()).op(")");
        
        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.2", BOCB).getMasks()).op("AND").op("NOT").contractorIsBank().op(")");
        
        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.3", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"СубКредит");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"8934").op(")");

        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.4", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").op("NOT").contractorIsBank().op(")");
        
        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.5", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"Вкл");
            filter.op("AND").op("NOT").contractorIsBank().op(")");

        filter.op(")");

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute8BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "8";

        filter.isChapterIn("3").op("AND").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), ATRIBUTE_ID, BOCB).getMasks()).op("AND").op("NOT").contractorIsBank();

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getCalculateAttribute6Data()
        const ATRIBUTE_ID = "6";
        return getPrimaryCalculateAttributeData(ATRIBUTE_ID);
    end;

    private macro getCalculateAttribute7Data()
        const ATRIBUTE_ID = "7";
        return getPrimaryCalculateAttributeData(ATRIBUTE_ID);
    end;

    private macro getCalculateAttribute8Data()
        const ATRIBUTE_ID = "8";
        return getPrimaryCalculateAttributeData(ATRIBUTE_ID);
    end;

    //нельзя делать private
    macro calculateAttribute4(attributeId : String)
        macro getCategory(keyValue : Object)

            var dataSet = TRsbDataSet("SELECT NVL((SELECT TRIM(conStr(LPAD(SUBSTR(t_value, 1, 2), 10, ' ')))"
                +"\n"+                "              FROM drepCategory_vw"
                +"\n"+                "             WHERE t_id = 17" //Код ОКВЭД
                +"\n"+                "               AND t_objectId = drepparty_vw.t_objectId"
                +"\n"+                "               AND t_isInstalledForEndDate = 1"
                +"\n"+                "               AND t_isForParty = 1), CHR(0)) t_category"
                +"\n"+                "  FROM drepparty_vw"
                +"\n"+                " WHERE t_id = " + Int(keyValue.debtor));

            if (dataSet.moveNext())
                return dataSet.category;
            end;

            return "";
        end;

        var keyValuePool = m_part.getAttribute(attributeId).getKeyValuePool();

        keyValuePool.moveFirst();
        while (keyValuePool.moveNext())
            setAttributeValues(attributeId, TRecordValue(keyValuePool.getCurrentItem().debtorsGroup,
                                                         keyValuePool.getCurrentItem().debtor,
                                                         RCB_VT_STRING,
                                                         getCategory(keyValuePool.getCurrentItem())));
        end;

    end;

    private macro getCalculateAttribute4Data(summarizeAttributeId : String)
        const ATRIBUTE_ID = "4";

        return RcbCalculationAttributeData(m_part.getAttribute(ATRIBUTE_ID), 
                                           RcbArray().initialize(RcbCalculationData(r2m(this, "calculateAttribute4"),
                                                                                    RcbArray().initialize(ATRIBUTE_ID))),
                                           RcbDependencesData(RcbArray().initialize(m_part.getAttribute(summarizeAttributeId))));
    end;


    macro execute()

        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute6LoansData());
        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute7LoansData());
        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute8LoansData());
        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute6BoCbData());
        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute7BoCbData());
        m_reportCalculateController.addPreprocessingAttributeData(getPreprocessAttribute8BoCbData());

        const SUMMARIZE_ATTRIBUTE_ID = "6";

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute2Data(SUMMARIZE_ATTRIBUTE_ID));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute3Data(SUMMARIZE_ATTRIBUTE_ID));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute4Data(SUMMARIZE_ATTRIBUTE_ID));
        m_reportCalculateController.addCalculationAttributeData(getCalculateRelationsCharacterAttributeData("5", SUMMARIZE_ATTRIBUTE_ID));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute6Data());
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute7Data());
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute8Data());
        m_reportCalculateController.addCalculationAttributeData(getCalculateUserInputAttributeData("userInput", SUMMARIZE_ATTRIBUTE_ID));

        /* рассчет атрибута "Признак заемщика" */
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeASignOfTheDebtorData(SUMMARIZE_ATTRIBUTE_ID));
        
    end;
end;


/**
 * Класс контроллера расчета первого раздела по 2254-У
 */
class (F118Part1CalculateController) F118Part1CalculateController_2254(partController : Object)
    initF118Part1CalculateController(partController);

    private macro getPreprocessAttribute7BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "7";

        filter.isChapterIn("1").op("AND").op("(");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.1", BOCB).getMasks()).op(")");
        
        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.2", BOCB).getMasks()).op("AND").op("NOT").contractorIsBank().op(")");
        
        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.3", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"СубКредит");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"8934").op(")");

        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.4", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").op("NOT").contractorIsBank().op(")");
        
        filter.op("OR");
        
        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.5", BOCB).getMasks());
            filter.op("AND").op("NOT").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"Искл");
            filter.op("AND").op("NOT").contractorIsBank().op(")");

        filter.op(")");

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;
end;


/**
 * Класс контроллера расчета первого раздела по 2254-У
 */
class (F118Part1CalculateController_2254) F118Part1CalculateController_2332(partController : Object)
    initF118Part1CalculateController_2254(partController);

    macro calculateAttribute4(attributeId : String)
        macro getCategory(keyValue : Object)

            var dataSet = TRsbDataSet("SELECT NVL((SELECT TRIM(conStr(LPAD(SUBSTR(t_value, 1, 2), 10, ' ')))"
                +"\n"+                "              FROM drepCategory_vw"
                +"\n"+                "             WHERE t_id = 17" //Код ОКВЭД
                +"\n"+                "               AND t_objectId = drepparty_vw.t_objectId"
                +"\n"+                "               AND t_isInstalledForEndDate = 1"
                +"\n"+                "               AND t_isForParty = 1"
                +"\n"+                "               AND ROWNUM < 6 ), CHR(0)) t_category"
                +"\n"+                "  FROM drepparty_vw"
                +"\n"+                " WHERE t_id = " + Int(keyValue.debtor)
                +"\n"+                "   AND (t_isPhisical = 0 OR t_isPhisical = 1 AND t_isResident = 1 AND t_isEmployer = 1)" 
                +"\n"+                "   AND t_isSubjectAuthority = 0"
                +"\n"+                "   AND t_isAuthority = 0");

            if (dataSet.moveNext())
                return dataSet.category;
            end;

            return "";
        end;

        var keyValuePool = m_part.getAttribute(attributeId).getKeyValuePool();

        keyValuePool.moveFirst();
        
        while (keyValuePool.moveNext())
            setAttributeValues(attributeId, TRecordValue(keyValuePool.getCurrentItem().debtorsGroup,
                                                         keyValuePool.getCurrentItem().debtor,
                                                         RCB_VT_STRING,
                                                         getCategory(keyValuePool.getCurrentItem())));            
        end;

    end;
end;

/**
 * Класс контроллера расчета первого раздела по 2808-У
 */
class (F118Part1CalculateController_2332) F118Part1CalculateController_2808(partController : Object)
    initF118Part1CalculateController_2332(partController);


    private macro getPreprocessAttribute7LoansData()
        var dataSource = m_dataSources.getDataSource("Loans");
        var filter     = m_dataSouceFilters.getFilter("Loans");

        const ATRIBUTE_ID = "7";

        /*
          Виды регистров
          1  - Основной долг
          2  - Просроченный ОД
          16 - Неразрешенный ОД
          17 - Просроченный неразрешенный ОД
          62 - Оплаченная гарантия
          64 - Просроченная оплаченная гарантия
         */
        filter.isRegisterTypeIn("1, 2, 16, 17, 62, 64").op("AND").op("NOT").hasValidAccessory();

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute8LoansData()
        var dataSource = m_dataSources.getDataSource("Loans");
        var filter     = m_dataSouceFilters.getFilter("Loans");

        const ATRIBUTE_ID = "8";

        filter.isKrv().op("AND").op("NOT").hasValidAccessory();

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;


    private macro getPreprocessAttribute7BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "7";

        filter.isChapterIn("1").op("AND").op("NOT").hasValidAccessory().op("AND").op("(");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.1", BOCB).getMasks()).op(")");

        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.2", BOCB).getMasks()).op("AND").op("NOT").contractorIsBank().op(")");

        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.3", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"СубКредит");
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"8934").op(")");

        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.4", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND,"В");
            filter.op("AND").op("NOT").contractorIsBank().op(")");

        filter.op("OR");

        filter.op("(").isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "7.5", BOCB).getMasks());
            filter.op("AND").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING,"Вкл");
            filter.op("AND").op("NOT").contractorIsBank().op(")");

        filter.op(")");

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;

    private macro getPreprocessAttribute8BoCbData()
        var dataSource = m_dataSources.getDataSource("Account");
        var filter     = m_dataSouceFilters.getFilter("Account");

        const ATRIBUTE_ID = "8";

        filter.isChapterIn("3").op("AND").op("NOT").hasValidAccessory().op("AND").op("NOT").contractorIsBank().op("AND").op("(");
            filter.isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), ATRIBUTE_ID, BOCB).getMasks());
        filter.op("OR").op("(");
            filter.isSatisfiesToMasks(m_tuneTable.setKey(m_part.getId(), "8.1", BOCB).getMasks());
            filter.op("AND").op("NOT").hasAnyAccountAssignedCategory(RCB_OBJGROUP_KRV);
            filter.op("AND").isGoodGuarantyInKRVdate( NOTEKIND_INCLUDE_GUARANTY_KRV);
            filter.op("AND").op("NOT").isGoodGuarantyInKRVdate( NOTEKIND_EXCLUDE_GUARANTY_KRV);
            filter.op(")");
        filter.op(")");

        return getPreprocessAttributeData(ATRIBUTE_ID, dataSource, filter);
    end;
end;

class (F118PartCalculateController) F118Part1FinalCalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    initF118PartCalculateController(reportCalculateController, "1");

    macro execute()
        const SUMMARIZE_ATTRIBUTE_ID = "6";

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute1Data(SUMMARIZE_ATTRIBUTE_ID));

        m_reportCalculateController.addCalculationAttributeData(getFinalCalculateRelationsCharacterAttributeData("5", SUMMARIZE_ATTRIBUTE_ID));

        m_reportCalculateController.addCalculationAttributeData(getCalculateH6AttributeData("10", SUMMARIZE_ATTRIBUTE_ID));

        m_reportCalculateController.addCalculationAttributeData(getFinalCalculateAttributeData(SUMMARIZE_ATTRIBUTE_ID));

        const KRS_ATTRIBUTE_ID = "9";
        m_reportCalculateController.addCalculationAttributeData(getCalculateKrsAttributeData(KRS_ATTRIBUTE_ID));
        
        m_reportCalculateController.addCalculationAttributeData(getCalculateInformationAttributeData("11"));
    end;
end;

class (F118Part1FinalCalculateController) F118Part1FinalCalculateController_2332(reportCalculateController : Object /*TReportCalculateController*/)
    initF118PartCalculateController(reportCalculateController, "1");

    macro execute()
        const SUMMARIZE_ATTRIBUTE_ID = "6";

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttribute1Data(SUMMARIZE_ATTRIBUTE_ID));
        
        m_reportCalculateController.addCalculationAttributeData(getCalculateH6AttributeData("10", SUMMARIZE_ATTRIBUTE_ID));

        m_reportCalculateController.addCalculationAttributeData(getFinalCalculateAttributeData(SUMMARIZE_ATTRIBUTE_ID));

        const KRS_ATTRIBUTE_ID = "9";
        m_reportCalculateController.addCalculationAttributeData(getCalculateKrsAttributeData(KRS_ATTRIBUTE_ID));
        
        m_reportCalculateController.addCalculationAttributeData(getCalculateInformationAttributeData("11"));
    end;
end;

