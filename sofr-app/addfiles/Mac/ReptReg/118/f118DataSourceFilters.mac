const NOTEKIND_INCLUDE_GUARANTY_KRV = 50;
const NOTEKIND_EXCLUDE_GUARANTY_KRV = 51;

class (RcbBoCbDataSourceFilter) F118AccountDataSourceFillter()
    initRcbBoCbDataSourceFilter("Account", "account");

    /**
     * Характер отношений заемщика равен заданному
     *
     * @param relationCharacter Идентификатор характера отношений
     */
    macro isDebtorRelationsCharacterEqualTo(relationCharacter : String)
        m_filter = m_filter + " EXISTS (SELECT 1"
                +"\n"+        "           FROM drepCategory_vw"
                +"\n"+        "          WHERE t_id = rep_const.get().cb.categories.party.relationCharacter"/*Характер отношений с банком*/
                +"\n"+        "            AND t_objectId = TO_CHAR(account.t_contractorId, 'fm0000000000')"
                +"\n"+        "            AND t_value = " + getSqlString(relationCharacter)
                +"\n"+        "            AND t_isInstalledForEndDate = 1"
                +"\n"+        "            AND t_objectType = rep_const.get().cb.objectTypes.party)";

        return this;
    end;

    /**
     * Заемщик является банком
     */
    macro debtorIsBank()
        return contractorIsBank("account.t_contractorId");
    end;

    /**
     * Является обеспечением для счета первой категории качества
     */
    macro isGuarantyForAccountFirstQuality()
        m_filter = m_filter + " EXISTS (SELECT 1"
            +"\n"+            "           FROM acauntsGuaranty,"
            +"\n"+            "                drepCategory_vw"
            +"\n"+            "          WHERE acauntsGuaranty.t_connectObjectId = account.t_objectId"
            +"\n"+            "            AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+            "            AND drepcategory_vw.t_value = '1'"
            +"\n"+            "            AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+            "            AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+            "            AND drepcategory_vw.t_isInstalledForEndDate = 1)";

        return this;
    end;


    /**
     * Страновая оценка эмитента
     */
    macro countryRating(signe : String, value : String)
        m_filter = m_filter +
                   "(SELECT DECODE(repParty.t_countryRating, CHR(0), NULL, repParty.t_countryRating)"
            +"\n"+ "         FROM drepparty_vw repParty"
            +"\n"+ "        WHERE repParty.t_id = account.t_guarantyIssuerId) " + signe + " " + value + "";

        return this;
    end;

    /**
     * Эмитент обеспечения является физическим лицом
     */
    macro guarantyIssuerIsPhysical()
        return contractorIsPhysical("account.t_guarantyIssuerId");
    end;

    /**
     * Эмитент обеспечения является банком
     */
    macro guarantyIssuerIsBank()
        return contractorIsBank("account.t_guarantyIssuerId");
    end;

    // Имеет нужную принадлежность
    macro hasValidAccessory(alias : String)
        m_filter = m_filter + " EXISTS (SELECT 1"
                         +"\n"+ "         FROM drepparty_vw repParty"
                         +"\n"+ "        WHERE repParty.t_id = " + procesAlias(alias, "t_contragentId")
                         +"\n"+ "          AND (repParty.t_isCentralBank  = 1"                 /*Центральным банком*/
                         +"\n"+ "               OR repParty.t_isAuthority = 1"                 /*Органом гос.власти*/
                         +"\n"+ "               OR repParty.t_isFederalExecutiveAuthority = 1" /*Федеральным органом исп.власти*/
                         +"\n"+ "               OR repParty.t_isFinanceMinistry = 1))";         /*Министерством финансов*/

        return this;
    end;

    macro hasAnyAccountAssignedCategory(categoryId : Integer, alias : String)
        m_filter = m_filter +
                   "EXISTS(SELECT 1"
            +"\n"+ "  FROM drepcategory_vw"
            +"\n"+ " WHERE drepcategory_vw.t_isForAccount          = 1"
            +"\n"+ "   AND drepcategory_vw.t_isInstalledForEndDate = 1"
            +"\n"+ "   AND drepcategory_vw.t_objectId              = " + procesAlias(alias, "t_objectId")
            +"\n"+ "   AND drepcategory_vw.t_id                    = " + categoryId + ")";

        return this;
    end;

    macro isGoodGuarantyInKRVdate(noteId : Integer)
        m_filter = m_filter +
               " EXISTS(SELECT 1                                                       "
               "              FROM dnoteText_dbt                                           "
               "             WHERE t_objectType = 4                                        "
               "               AND t_documentId = account.t_objectId                           "
               "               AND t_noteKind   =  " + noteId  +
               "               AND rep_utl.castRawToDate(t_text) <= rep_data.getEndDate() "
               "               AND rep_utl.castRawToDate(t_text) >  to_date('01.01.0001', 'dd.mm.yyyy'))";

        return this;
   end;

end;

class (RcbBoCbDataSourceFilter) F118TempTableDataSourceFillter()
    initRcbBoCbDataSourceFilter("TempTable", "temp");

    //Идентификатор раздела
    macro isPartIdEquialTo(partId : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_partId") + " = " + getSqlString(partId);

        return this;
    end;

    //Идентификатор атрибута
    macro isAttributeIdEquialTo(attributeId : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_columnId") + " = " + getSqlString(attributeId);

        return this;
    end;
end;

class (RcbSqlDataSourceFilter) F118LoansDataSourceFillter()
    initRcbSqlDataSourceFilter("Loans", "");

    /**
     * Характер отношений заемщика равен заданному
     *
     * @param relationCharacter Идентификатор характера отношений
     */
    macro isDebtorRelationsCharacterEqualTo(relationCharacter : String)

        m_filter = m_filter + " EXISTS (SELECT 1"
                +"\n"+        "           FROM drepCategory_vw"
                +"\n"+        "          WHERE t_id = rep_const.get().cb.categories.party.relationCharacter"/*Характер отношений с банком*/
                +"\n"+        "            AND t_objectId = repParty.t_objectId"
                +"\n"+        "            AND t_value = " + getSqlString(relationCharacter)
                +"\n"+        "            AND t_isInstalledForEndDate = 1"
                +"\n"+        "            AND t_objectType = rep_const.get().cb.objectTypes.party)";

        return this;
    end;

    /**
     * Заемщик является банком
     */
    macro debtorIsBank(alias : String)
        m_filter = m_filter + procesAlias(alias, "repParty.t_isBank") + " = 1";

        return this;
    end;

    /**
     * Страновая оценка
     */
    macro countryRating(signe : String, value : String)
        m_filter = m_filter + "DECODE(repParty.t_countryRating, CHR(0), NULL, repParty.t_countryRating)" + " " + signe + " " + value;

        return this;
    end;

    //Определен КРВ
    macro isKrv(alias : String)
        m_filter = m_filter + procesAlias(alias, "t_krv") + " is NOT NULL";

        return this;
    end;

    //Тип договора кредит
    macro isTypeCredit(alias : String)
        m_filter = m_filter + procesAlias(alias, "t_creditType") + " = 1";

        return this;
    end;

    //Тип договора овердрафт
    macro isTypeOverdraft(alias : String)
        m_filter = m_filter + procesAlias(alias, "t_creditType") + " IN (8, 22)";

        return this;
    end;

    //Тип договора гарантия
    macro isTypeGuaranty(alias : String)
        m_filter = m_filter + procesAlias(alias, "t_creditType") + " = 21";

        return this;
    end;

    //Тип выдачи
    macro isIssueTypeIn(types : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_creditIssueType") + " IN (" + types + ")";

        return this;
    end;

    //Вид регистра
    macro isRegisterTypeIn(types : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_registerType") + " IN (" + types + ")";

        return this;
    end;

    //Вид обеспечения
    macro isGuarantyTypeIn(types : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_guarantyType") + " IN (" + types + ")";

        return this;
    end;

    //Группа риска
    macro isRiskGroupIn(value : String, alias : String)
        m_filter = m_filter + procesAlias(alias, "t_riskGroup") + " IN (" + value + ")";

        return this;
    end;

    // Имеет нужную принадлежность
    macro hasValidAccessory(alias : String)
        m_filter = m_filter + "(" + procesAlias(alias, "repParty.t_isCentralBank")               + " = 1"       /*Центральным банком*/
                         + " OR " + procesAlias(alias, "repParty.t_isAuthority")                 + " = 1"       /*Органом гос.власти*/
                         + " OR " + procesAlias(alias, "repParty.t_isFederalExecutiveAuthority") + " = 1"       /*Федеральным органом исп.власти*/
                         + " OR " + procesAlias(alias, "repParty.t_isFinanceMinistry")           + " = 1" + ")";      /*Министерством финансов*/
    end;



end;

class (RcbDataSourceFilters) F118DataSourceFilters()
    initRcbDataSourceFilters();

    macro initialize()
        m_dataSourceFiltersPool.push_back(F118AccountDataSourceFillter());
        m_dataSourceFiltersPool.push_back(F118LoansDataSourceFillter());
        m_dataSourceFiltersPool.push_back(F118TempTableDataSourceFillter());
    end;
end;