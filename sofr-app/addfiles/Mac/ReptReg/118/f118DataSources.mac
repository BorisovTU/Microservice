class (RcbDataSource) F118CapitalDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    class (RcbCapitalData) F118CapitalData(report : RcbReport)
        initRcbCapitalData(report);

        private macro getCapitalDate() : Date
            return m_report.context.period.endDate;
        end;
    end;

    class F118CapitalDataSourceData(dataPool : RcbArray, isEveryDay : Bool)
        private var m_dataPool   = dataPool;

        private var m_isEveryDay = isEveryDay;

        private macro getCapitalData(reportDate : Date) : RcbCapitalData
            m_dataPool.moveFirst();

            while (m_dataPool.moveNext())
                if (not m_isEveryDay)
                    return m_dataPool.getCurrentitem();
                elif (m_dataPool.getCurrentItem().getDate() == reportDate)
                    return m_dataPool.getCurrentitem();
                end;
            end;

            return null;
        end;

        macro getCapital(reportDate : Date) : Money
            var capitalData = getCapitalData(reportDate);

            if (capitalData == null)
                return null;
            end;

            return capitalData.getValue();
        end;

        macro getCapitalDate(reportDate : Date)
            var capitalData = getCapitalData(reportDate);

            if (capitalData == null)
                return null;
            end;

            return capitalData.getDate();
        end;

    end;

    initRcbDataSource("Capital", protocolView, dataSources);

    private var m_capitalDataPool = RcbArray();

    private var m_isEveryDay = false;

    private macro fillCapitalDataPool()

        var daysQuantity = global.getRcbReport().context.period.daysQuantity;
        var endDate      = global.getRcbReport().context.period.endDate;

        var context      = null;
        var currentDate  = null;
        var report       = null;

        if (m_isEveryDay)

            while (daysQuantity >= 0)
                currentDate = endDate - daysQuantity;

                context = RcbReportContext(RcbPeriod(currentDate, currentDate),
                                           global.getRcbReport().context.departmentCode,
                                           global.getRcbReport().context.issueMode,
                                           global.getRcbReport().context.organizationStructure,
                                           global.getRcbReport().context.isSummaryMode);

                report = RcbApplication.objectFactory.createReport(global.getRcbReport().form.id, context);

                m_capitalDataPool.push_back(F118CapitalData(report));

                context = null;
                report  = null;
                daysQuantity = daysQuantity - 1;
            end;
        else
            m_capitalDataPool.push_back(F118CapitalData(global.getRcbReport()));
        end;

        var i = 0;
        while (i < m_capitalDataPool.size)
            m_capitalDataPool[i].findValue();
            i = i + 1;
        end;

        RcbApplication().transactionManager.commit();
    end;

    private macro initialize()
        const REGISTRY_PATH : String = "REPTREG/REP_GROUPS/ФОРМА 118/КАПИТАЛ НА ВНУТРИМЕСЯЧНУЮ ДАТУ";

        var errorCode     : Integer = 0;
        var valueType     : Integer = V_UNDEF;

        valueType = getRegistryValue(REGISTRY_PATH, V_BOOL, m_isEveryday, errorCode);

        if ((errorCode != 0) or (valueType != V_BOOL))
            runError("Ошибка чтения настройки: " + REGISTRY_PATH);
        end;

        fillCapitalDataPool();
    end;

    macro getData() : F118CapitalDataSourceData
        return F118CapitalDataSourceData(m_capitalDataPool, m_isEveryDay);
    end;

    initialize();
end;

class (RcbDataSource) F118H6DataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("H6", protocolView, dataSources);

    private class F118H6Data(debtorsGroupId_ : String, debtorId_ : String, reportDate_ : String, value_ : Money)
        var debtorsGroupId = debtorsGroupId_;
        var debtorId       = debtorId_;
        var reportDate     = reportDate_;
        var value          = value_;
    end;

    private var m_report = objectFactoryInstance.createReport(global.getRcbReport());

    private macro getDateH6AttributeId(partId : String) : String
        return ternary(partId == "1", "11", "10");
    end;

    private macro getValueH6AttributeId(partId : String) : String
        return ternary(partId == "1", "12", "11");
    end;

    private macro getKRZAttributeId(partId : String) : String
        return ternary(partId == "1", "6", "5");
    end;

    private macro insertValues(reportDate : Date, pertId : String, debtorsGroupId : String, debtorId : String, capitalDate : Date, capitalvalue : Money, krzValue : Money)
        sql_execute("INSERT INTO df118_h6_tmp(t_reportDate, t_partId, t_debtorsGroupId, t_debtorId, t_capitalDate, t_capitalValue, t_krzValue)"
            +"\n"+  "     VALUES (" + getSqlDate(reportDate)       + ","
            +"\n"+  "             " + getSqlString(pertId)         + ","
            +"\n"+  "             " + getSqlString(debtorsGroupId) + ","
            +"\n"+  "             " + getSqlString(debtorId)       + ","
            +"\n"+  "             " + getSqlDate(capitalDate)      + ","
            +"\n"+  "             " + capitalvalue                 + ","
            +"\n"+  "             " + nvl(krzValue, "NULL")        + ")");
    end;

    private macro processPart(rcbReport_ : RcbReport, partId : String, capitalDate : Date, capitalValue : Money)
        var report : RcbReportBase = null;

        if (rcbReport_.context.period.endDate() == m_report.getPeriod().endDate())
            report = m_report;
        else
            report = objectFactoryInstance.createReport(rcbReport_, true);
        end;


        var krzAttribute = null;

        if ((report.getRcbReport().isCalculated()) or (report == m_report))
            krzAttribute = report.getPart(partId).getAttribute(getKRZAttributeId(partId));
        end;

        var attributeKeyValuePool = m_report.getPart(partId).getAttribute(getKRZAttributeId(partId)).getKeyValuePool();

        var krzValue = null;

        attributeKeyValuePool.moveFirst();
        while (attributeKeyValuePool.moveNext())
            if (attributeKeyValuePool.getCurrentItem().debtorsGroup == attributeKeyValuePool.getCurrentItem().debtor)
                if (krzAttribute != null)
                    krzValue = krzAttribute.findValue(attributeKeyValuePool.getCurrentItem().debtorsGroup,
                                                      attributeKeyValuePool.getCurrentItem().debtor);
                else
                    krzValue = null;
                end;

                insertValues(report.getPeriod().endDate(),
                             partId,
                             attributeKeyValuePool.getCurrentItem().debtorsGroup,
                             attributeKeyValuePool.getCurrentItem().debtor,
                             capitalDate,
                             capitalValue,
                             krzValue);
            end;
        end;
    end;

    private macro processReport(report : RcbReport)
        var capitalDataSource = m_dataSources.getDataSource("Capital");
        var capitalDate  = capitalDataSource.getData().getCapitalDate(report.context.period.endDate);
        var capitalValue = capitalDataSource.getData().getCapital(report.context.period.endDate);

        processPart(report, "1", capitalDate, capitalValue);
        processPart(report, "2", capitalDate, capitalValue);
    end;

    private macro initialize()

        var daysQuantity = m_report.getPeriod().daysQuantity;
        var endDate      = m_report.getPeriod().endDate;

        var context     = null;
        var currentDate = null;
        var report      = null;

        while (daysQuantity >= 0)
            currentDate = endDate - daysQuantity;

            context = RcbReportContext(RcbPeriod(currentDate, currentDate),
                                       global.getRcbReport().context.departmentCode,
                                       global.getRcbReport().context.issueMode,
                                       global.getRcbReport().context.organizationStructure,
                                       global.getRcbReport().context.isSummaryMode);


            report = RcbApplication.objectFactory.createReport(global.getRcbReport().form.id, context);

            processReport(report);
            context = null;
            report  = null;
            daysQuantity = daysQuantity - 1;
        end;
    end;

    macro getData(attribute : RcbAttributeBase)
        clear();
        initialize();

        var dataSet = TRsbDataSet("WITH data AS (SELECT d.*,"
            +"\n"+                "                     ROUND(t_krzValue/t_capitalValue*100,5) AS t_h6Value"
            +"\n"+                "                FROM df118_h6_tmp d)"
            +"\n"+                "SELECT t_partId,"
            +"\n"+                "       t_debtorsGroupId,"
            +"\n"+                "       t_debtorId,"
            +"\n"+                "       MAX (t_h6Value)        AS t_h6Value,"
            +"\n"+                "       GROUPING(t_reportDate) AS t_isDebtorItog,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING (t_reportdate) = 1"
            +"\n"+                "               THEN "
            +"\n"+                "                   TRIM(SUBSTR(CONSTR(',' || TO_CHAR(t_reportdate, 'DD.MM.YYYY'))KEEP (DENSE_RANK FIRST ORDER BY t_partid, t_debtorid,t_h6value DESC NULLS LAST), 2))"
            +"\n"+                "           ELSE TO_CHAR(t_reportdate, 'DD.MM.YYYY')"
            +"\n"+                "       END AS t_reportdate,"
            +"\n"+                "       MAX(t_capitalDate)  KEEP (DENSE_RANK FIRST ORDER BY t_partid,  t_debtorid, t_h6Value DESC NULLS LAST, t_reportdate DESC) AS t_capitalDate,"
            +"\n"+                "       MAX(t_capitalValue) KEEP (DENSE_RANK FIRST ORDER BY t_partid,  t_debtorid, t_h6Value DESC NULLS LAST, t_reportdate DESC) AS t_capitalValue,"
            +"\n"+                "       MAX(t_krzValue)     KEEP (DENSE_RANK FIRST ORDER BY t_partid,  t_debtorid, t_h6Value DESC NULLS LAST, t_reportdate DESC) AS t_krzValue"
            +"\n"+                "  FROM data"
            +"\n"+                " WHERE t_partId = " + getSqlString(attribute.getPart().getId())
            +"\n"+                " HAVING GROUPING(t_partId) = 0"
            +"\n"+                " GROUP BY ROLLUP ((t_partId, t_debtorsGroupId, t_debtorId), (t_reportDate))");

            var dataPool = RcbArray();

            const LARGE_SPACE : String   = "                    ";
            var dateProcessor = TDateProcessor();
            var dateRanges : String = "";

            m_protocolView.printHead(attribute);

            while (dataSet.moveNext())
                if (dataSet.t_isDebtorItog == 1)
                    m_protocolView.printItog(dataSet);

                    dateRanges = dateProcessor.getRanges(dataSet.reportDate);
                    dateRanges = strSubst(dateRanges, ",", "," + LARGE_SPACE);

                    dataPool.push_back(F118H6Data(dataSet.debtorsGroupId, dataSet.debtorId, dateRanges, dataSet.h6Value));
                else
                    m_protocolView.printString(dataSet);
                end;
            end;

            m_protocolView.printBottom();

            return dataPool;
    end;

    macro clear()
        sql_truncate("df118_h6_tmp");
    end;
end;


class (RcbDataSource) F118DataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    private macro getSourceQuery(filter : RcbDataSourceFilter) : String
        throw(TPureVirtualMethodCallException("F118DataSource::getSourceQuery"));
    end;

    private macro getSpecificFieldsList() : String
        throw(TPureVirtualMethodCallException("F118DataSource::getSpecificFieldList"));
    end;

    private macro isAttributeOthers(attribute : RcbAttributeBase)
        var partId = attribute.getPart().getId();
        var attributeId = attribute.getId();

        if (   ((partId == "1") and (attributeId == "6"))
            or ((partId == "2") and (attributeId == "5")))
            return true;
        end;

        return false;
    end;

    private macro isAttributeKrv(attribute : RcbAttributeBase)
        var partId = attribute.getPart().getId();
        var attributeId = attribute.getId();

        if (   ((partId == "1") and (attributeId == "7"))
            or ((partId == "2") and (attributeId == "6")))
            return true;
        end;

        return false;
    end;

    private macro isAttributeKrz(attribute : RcbAttributeBase)
        var partId = attribute.getPart().getId();
        var attributeId = attribute.getId();

        if (   ((partId == "1") and (attributeId == "8"))
            or ((partId == "2") and (attributeId == "7")))
            return true;
        end;

        return false;
    end;

    private macro getDataSet(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : Object

        filter.op("AND").op("NOT").op("(").debtorIsBank().op("AND").isDebtorRelationsCharacterEqualTo("БГ").op(")");

        var dataSet = TRsbDataSet("SELECT " + getSqlString(attribute.getPart().getId()) + " AS t_partId,"
            +"\n"+                "       " + getSqlString(attribute.getId()) + " AS t_columnId,"
            +"\n"+                "       t_groupId      AS t_debtorGroupId,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_contractorId) AS t_debtorid,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_name) AS t_debtorname,"
            +"\n"+                "       t_account, t_fiId, t_reserve, t_kra, t_krv, t_coefficient1," + getSpecificFieldsList() + ","
            +"\n"+                "       SUM(CASE "
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeOthers(attribute))
            +"\n"+                "                   THEN t_weightedGuaranty"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrv(attribute))
            +"\n"+                "                   THEN t_weightedAssets"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrz(attribute))
            +"\n"+                "                   THEN t_weightedEquivalent"
            +"\n"+                "               ELSE NULL"
            +"\n"+                "           END) AS t_value,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_weightedAssets) = 1 AND GROUPING(t_contractorId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorItog,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_contractorId) = 1 AND GROUPING(t_groupId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorsGroupItog"
            +"\n"+                "  FROM (" + getSourceQuery(filter, attribute) + ")"
            +"\n"+                " HAVING GROUPING(t_groupId) = 0"
            +"\n"+                "GROUP BY ROLLUP(t_groupId,"
            +"\n"+                "               (t_contractorId, t_name),"
            +"\n"+                "               (t_weightedAssets, t_fiId, t_weightedEquivalent, t_account, t_reserve, t_kra, t_krv, t_coefficient1,"
            +"\n"+                "               " + getSpecificFieldsList() + "))");

        return dataSet;
    end;

    private macro insertValues(dataSet : Object)
        sql_execute("INSERT INTO df118_i2055_tmp (t_partId,t_columnId,t_debtorGroupId,t_debtorId,t_debtorName,t_value,t_isDebtorItog,t_isGroupItog)"
            +"\n"+  "     VALUES (" + getSqlString(dataSet.partId) + ","
            +"\n"+  "             " + getSqlString(dataSet.columnId) + ","
            +"\n"+  "             " + getSqlString(dataSet.debtorGroupId) + ","
            +"\n"+  "             " + getSqlString(dataSet.debtorId) + ","
            +"\n"+  "             " + getSqlString(dataSet.debtorName) + ","
            +"\n"+  "             " + dataSet.value + ","
            +"\n"+  "             " + dataSet.isDebtorItog + ","
            +"\n"+  "             " + dataSet.isDebtorsGroupItog + ")");
    end;

    private macro insertValuesASignOfTheDebtor(dataSet : Object, columnId, aSignOfTheDebtor)
        sql_execute("INSERT INTO df118_i2055_tmp (t_partId,t_columnId,t_debtorGroupId,t_debtorId,t_value)"
            +"\n"+  "     VALUES (" + getSqlString(dataSet.partId) + ","
            +"\n"+  "             " + getSqlString(columnId) + ","
            +"\n"+  "             " + getSqlString(dataSet.debtorGroupId)  + ","
            +"\n"+  "             " + getSqlString(dataSet.debtorId) + ","
            +"\n"+  "             " + aSignOfTheDebtor + ")" );
    end;

    macro clear()
        sql_truncate("df118_i2055_tmp");
    end;
end;


class (F118DataSource) F118LoansDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118DataSource("Loans", protocolView, dataSources);

    private macro getSpecificFieldsList() : String
        return "t_creditNumber, t_registerType, t_roubleSum, t_weightedGuaranty";
    end;

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String
        return     "SELECT data.*,"
            +"\n"+ "       data.t_currencyId AS t_fiId,"
            +"\n"+ "       t_weightedAssets * t_krv * t_coefficient1 AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT creditPart.*,"
            +"\n"+ "               NVL((SELECT conStr(t_value)"
            +"\n"+ "                      FROM drepCategory_vw"
            +"\n"+ "                     WHERE t_id         = 20"/*Группа взаимосвязанных субъектов*/
            +"\n"+ "                       AND t_isForParty = 1"
            +"\n"+ "                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                       AND t_objectId   = repParty.t_objectId), t_contractorId) AS t_groupId,"
            +"\n"+ "               repParty.t_name,"
            +"\n"+ "               CASE"
            +"\n"+ "                   WHEN EXISTS(SELECT 1"
            +"\n"+ "                                 FROM drepCategory_vw"
            +"\n"+ "                                WHERE drepCategory_vw.t_id                    = 2"/*характер отношений с банком*/
            +"\n"+ "                                  AND drepCategory_vw.t_isForParty            = 1"
            +"\n"+ "                                  AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                  AND drepCategory_vw.t_objectId              = repParty.t_objectId"
            +"\n"+ "                                  AND drepCategory_vw.t_value                 <> 'ПР')"
            +"\n"+ "                       THEN 1.3"
            +"\n"+ "                   ELSE 1"
            +"\n"+ "               END AS t_coefficient1"/*дурацкое название, но так в ТЗ*/
            +"\n"+ "          FROM drcbCreditPart_tmp creditPart,"
            +"\n"+ "               drepParty_vw       repParty"
            +"\n"+ "         WHERE "  + ternary(isAttributeOthers(attribute), "creditPart.t_guarantyIssuerId", "creditPart.t_contractorId") +" = repParty.t_id"
            +"\n"+ "           AND " + filter.isSuitable() + ") data";

    end;

    macro cacheData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String)
        var fundedKoefficient = 1;

        if (global.getRcbReport.attributeValue("Коэффициент_фондирования").isDefined())
            fundedKoefficient = global.getRcbReport.attributeValue("Коэффициент_фондирования").exact;
        end;

        sql_execute("CALL rcb_f118.initialize(" + fundedKoefficient + ")");

        sql_execute("CALL rcb_loans_creditPart.fillTable()");

        var dataSet = getDataSet(filter, attribute);
        var aSignOfTheDebtor = 0;
        var account;
        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.value == 0)
                null;
            elif ((dataSet.isDebtorItog == 1) or (dataSet.isDebtorsGroupItog == 1))
                m_protocolView.printItog(dataSet);
                insertValues(dataSet);
            else
                account = dataSet.account;
                if ((substr(account, 1, 3) == "501") or (substr(account, 1, 3) == "502") or (substr(account, 1, 3) == "503") or (substr(account, 1, 3) == "504") or 
                    (substr(account, 1, 3) == "505") or (substr(account, 1, 3) == "506") or (substr(account, 1, 3) == "507"))
                    aSignOfTheDebtor = 2;
                else
                    aSignOfTheDebtor = 1;
                end;
                insertValuesASignOfTheDebtor(dataSet, 13, aSignOfTheDebtor);
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();
    end;

    macro clear()
        sql_execute("CALL rcb_loans_creditPart.resetFilled()");
    end;
end;

class (F118LoansDataSource) F118LoansDataSource_2808(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118LoansDataSource(protocolView, dataSources);

    private macro getDataSet(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : Object

        filter.op("AND").op("NOT").op("(").debtorIsBank().op("AND").isDebtorRelationsCharacterEqualTo("БГ").op(")");

        var dataSet = TRsbDataSet("SELECT " + getSqlString(attribute.getPart().getId()) + " AS t_partId,"
            +"\n"+                "       " + getSqlString(attribute.getId()) + " AS t_columnId,"
            +"\n"+                "       t_groupId      AS t_debtorGroupId,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_contractorId) AS t_debtorid,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_name) AS t_debtorname,"
            +"\n"+                "       t_account, t_fiId, t_reserve, t_kra, t_krv, " + getSpecificFieldsList() + ","
            +"\n"+                "       SUM(CASE "
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeOthers(attribute))
            +"\n"+                "                   THEN t_weightedGuaranty"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrv(attribute))
            +"\n"+                "                   THEN t_weightedAssets"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrz(attribute))
            +"\n"+                "                   THEN t_weightedEquivalent"
            +"\n"+                "               ELSE NULL"
            +"\n"+                "           END) AS t_value,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_weightedAssets) = 1 AND GROUPING(t_contractorId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorItog,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_contractorId) = 1 AND GROUPING(t_groupId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorsGroupItog"
            +"\n"+                "  FROM (" + getSourceQuery(filter, attribute) + ")"
            +"\n"+                " HAVING GROUPING(t_groupId) = 0"
            +"\n"+                "GROUP BY ROLLUP(t_groupId,"
            +"\n"+                "               (t_contractorId, t_name),"
            +"\n"+                "               (t_weightedAssets, t_fiId, t_weightedEquivalent, t_account, t_reserve, t_kra, t_krv,"
            +"\n"+                "               " + getSpecificFieldsList() + "))");

        return dataSet;
    end;

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String
        return     "SELECT data.*,"
            +"\n"+ "       data.t_currencyId AS t_fiId,"
            +"\n"+ "       t_weightedAssets * t_krv AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT creditPart.*,"
            +"\n"+ "               NVL((SELECT conStr(t_value)"
            +"\n"+ "                      FROM drepCategory_vw"
            +"\n"+ "                     WHERE t_id         = 20"/*Группа взаимосвязанных субъектов*/
            +"\n"+ "                       AND t_isForParty = 1"
            +"\n"+ "                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                       AND t_objectId   = repParty.t_objectId), t_contractorId) AS t_groupId,"
            +"\n"+ "               repParty.t_name"
            +"\n"+ "          FROM drcbCreditPart_tmp creditPart,"
            +"\n"+ "               drepParty_vw       repParty"
            +"\n"+ "         WHERE "  + ternary(isAttributeOthers(attribute), "creditPart.t_guarantyIssuerId", "creditPart.t_contractorId") +" = repParty.t_id"
            +"\n"+ "           AND " + filter.isSuitable() + ") data";

    end;
end;

class (F118DataSource) F118AccountDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118DataSource("Account", protocolView, dataSources);

    private macro getSpecificFieldsList() : String
        return "t_chapter, t_roubleRest, t_weightedGuaranty";
    end;

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String

            return " WITH"
            /*Счета переоценки*/
            +"\n"+ "     revaluation      AS (SELECT linkedObjects.t_connectObjectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest,"
            +"\n"+ "                                 CASE"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.positiveRevaluation"
            +"\n"+ "                                         THEN 1"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.negativeRevaluation"
            +"\n"+ "                                         THEN -1"
            +"\n"+ "                                     ELSE 0"
            +"\n"+ "                                 END AS t_koefficient"
            +"\n"+ "                            FROM drepaccount_vw       account,"
            +"\n"+ "                                 drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x')"
            +"\n"+ "                             AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                             AND account.t_account = SUBSTR(linkedObjects.t_id, 10)"
            +"\n"+ "                             AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                             AND t_role IN (rep_const.get().cb.objectRoles.account.positiveRevaluation,"
            +"\n"+ "                                            rep_const.get().cb.objectRoles.account.negativeRevaluation)"
            +"\n"+ "                             AND linkedObjects.t_isInstalledForEndDate = 1),"
            /*Счета для которых счет является счетом обеспечения*/
            +"\n"+ "      acauntsGuaranty AS (SELECT linkedObjects.t_id AS t_connectObjectId, t_accountReservePercent,"
            +"\n"+ "                                 account.t_objectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest"
            +"\n"+ "                           FROM drepaccount_vw       account,"
            +"\n"+ "                                drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                          WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x')"
            +"\n"+ "                            AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                            AND account.t_account = SUBSTR(linkedObjects.t_connectObjectId, 10)"
            +"\n"+ "                            AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                            AND linkedObjects.t_isInstalledForEndDate = 1"
            +"\n"+ "                            AND rep_utl.isSuitable(rep_const.get().cb.objectRoles.account.guarantyAccount, TO_CHAR(linkedObjects.t_role)) = 1),"
            /*Эмитент обеспечения*/
            +"\n"+ "      guarantyIssuer  AS (SELECT t_connectObjectId,"
            +"\n"+ "                                 TO_NUMBER(t_id) AS t_id"
            +"\n"+ "                            FROM drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE t_type = rep_const.get().cb.objectTypes.party"
            +"\n"+ "                             AND t_role = rep_const.get().cb.objectRoles.party.issuerGuaranty"
            +"\n"+ "                             AND t_isInstalledForEndDate = 1),"
            +"\n"+ "      repAccount      AS (SELECT drepaccount_vw.*,"
            +"\n"+ "                                 (SELECT guarantyIssuer.t_id"
            +"\n"+ "                                        FROM guarantyIssuer"
            +"\n"+ "                                        WHERE guarantyIssuer.t_connectObjectId = drepaccount_vw.t_objectId)"
            +"\n"+ "                                 AS t_guarantyIssuerId" // идентификатор эмитента обеспечения
            +"\n"+ "                            FROM drepaccount_vw)"
            +"\n"+ "SELECT data.*,"
            +"\n"+ "       t_weightedAssets * t_krv * t_coefficient1 AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT account.*,"
            +"\n"+ "               LEAST(t_contractAmount, t_roubleRest) * t_guarantyReservePercent * 1 AS t_weightedGuaranty,"/*1 - это КРА, хоть он у нас и есть расчитанный, все равно берем 1*/
            +"\n"+ "               (t_demandAmount - t_reserve) * t_kra AS t_weightedAssets"
            +"\n"+ "          FROM (SELECT repAccount.t_chapter,"
            +"\n"+ "                       repAccount.t_account,"
            +"\n"+ "                       repAccount.t_fiId,"
            +"\n"+ "                       repAccount.t_objectId,"
            +"\n"+ "                       repAccount.t_outCoverRest                                    AS t_roubleRest,"
            +"\n"+ "                       NVL((SELECT acauntsGuaranty.t_accountReservePercent"
            +"\n"+ "                              FROM acauntsGuaranty"
            +"\n"+ "                             WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                               AND rowNum < 2), 0)"
            +"\n"+ "                       AS t_guarantyReservePercent," // процент резерва, для расчета взвешенного обеспечения
            +"\n"+ "                       NVL(repReserveAccount.t_endDateReserveAmount, 0)             AS t_reserve,"
            +"\n"+ "                       NVL(repAccount.t_guarantyIssuerId,repAccount.t_contragentId) AS t_contractorId,"
            +"\n"+ "                       repAccount.t_guarantyIssuerId                                AS t_guarantyIssuerId,"
            +"\n"+ "                       repAccount.t_contragentId,"
            +"\n"+ "                       repParty.t_name,"
            +"\n"+ "                       NVL((SELECT conStr(t_value)"
            +"\n"+ "                              FROM drepCategory_vw"
            +"\n"+ "                             WHERE t_id         = 20" /*Группа взаимосвязанных субъектов*/
            +"\n"+ "                               AND t_isForParty = 1"
            +"\n"+ "                               AND t_isinstalledForEndDate = 1"
            +"\n"+ "                               AND t_objectId   = repParty.t_objectId), repParty.t_id) AS t_groupId,"
            +"\n"+ "                       NVL((SELECT MAX(t_value)"
            +"\n"+ "                              FROM drepCategory_vw"
            +"\n"+ "                             WHERE t_id           = 20" /*Коэффициент КРА*/
            +"\n"+ "                               AND t_isForAccount = 1"
            +"\n"+ "                               AND t_isinstalledForEndDate = 1"
            +"\n"+ "                               AND t_objectId     = repAccount.t_objectId), 1) AS t_kra,"
            +"\n"+ "                       NVL((SELECT MAX(t_value)"
            +"\n"+ "                              FROM drepCategory_vw"
            +"\n"+ "                             WHERE t_id           = 21" /*Коэффициент КРВ*/
            +"\n"+ "                               AND t_isForAccount = 1"
            +"\n"+ "                               AND t_isinstalledForEndDate = 1"
            +"\n"+ "                               AND t_objectId     = repAccount.t_objectId), 1) AS t_krv,"
            +"\n"+ "                       CASE"
            +"\n"+ "                           WHEN EXISTS(SELECT 1"
            +"\n"+ "                                         FROM drepCategory_vw"
            +"\n"+ "                                        WHERE t_id         = 2" /*характер отношений с банком*/
            +"\n"+ "                                          AND t_isForParty = 1"
            +"\n"+ "                                          AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                          AND t_objectId   = repParty.t_objectId"
            +"\n"+ "                                          AND t_value NOT IN ('ПР', 'БГ'))"
            +"\n"+ "                               THEN 1.3"
            +"\n"+ "                           ELSE 1"
            +"\n"+ "                       END AS t_coefficient1," /*дурацкое название, но так в ТЗ*/
            +"\n"+ "                       CASE"
            +"\n"+ "                           WHEN t_account like '5%'"
            +"\n"+ "                                THEN t_outCoverRest +"
            +"\n"+ "                                     (SELECT NVL(SUM(revaluation.t_rest * revaluation.t_koefficient), 0)"
            +"\n"+ "                                        FROM revaluation"
            +"\n"+ "                                       WHERE revaluation.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                           ELSE t_outCoverRest"
            +"\n"+ "                       END AS t_demandAmount," // Сумма требования
            +"\n"+ "                       (SELECT NVL(SUM(acauntsGuaranty.t_rest), 0)"
            +"\n"+ "                          FROM acauntsGuaranty"
            +"\n"+ "                         WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                       AS t_contractAmount," // Сумма договора
            +"\n"+ "                       CASE"
            +"\n"+ "                           WHEN (SELECT COUNT(1)"
            +"\n"+ "                                   FROM acauntsGuaranty,"
            +"\n"+ "                                        drepCategory_vw"
            +"\n"+ "                                  WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                    AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+ "                                    AND drepcategory_vw.t_value = '1'"
            +"\n"+ "                                    AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+ "                                    AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+ "                                    AND drepcategory_vw.t_isInstalledForEndDate = 1) = 0"
            +"\n"+ "                               THEN 0"
            +"\n"+ "                           ELSE 1"
            +"\n"+ "                       END AS guarantyForAccountFirstQuality" //является обеспечением для счета первой категории качества
            +"\n"+ "                  FROM repAccount,"
            +"\n"+ "                       drepreserveAccount_vw repReserveAccount,"
            +"\n"+ "                       drepParty_vw          repParty"
            +"\n"+ "                 WHERE repParty.t_id = repAccount.t_guarantyIssuerId"
            +"\n"+ "                   AND repReserveAccount.t_connectAccountId(+) = repAccount.t_accountid"
            +"\n"+ "                   AND NOT EXISTS (SELECT 1"
            +"\n"+ "                                     FROM drcbCreditPart_tmp creditPart"
            +"\n"+ "                                    WHERE creditPart.t_account = repAccount.t_Account)) account"
            +"\n"+ "         WHERE " + filter.isSuitable() + ") data";
    end;

    macro cacheData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String)
        var dataSet = getDataSet(filter, attribute);
        var aSignOfTheDebtor = 0;
        var account;

        m_protocolView.printHead(attribute, description);

        while (dataSet.moveNext())
            if (dataSet.value == 0)
                null;
            elif ((dataSet.isDebtorItog == 1) or (dataSet.isDebtorsGroupItog == 1))
                m_protocolView.printItog(dataSet);
                insertValues(dataSet);
            else
                account = dataSet.account;
                if ((substr(account, 1, 3) == "501") or (substr(account, 1, 3) == "502") or (substr(account, 1, 3) == "503") or (substr(account, 1, 3) == "504") or 
                    (substr(account, 1, 3) == "505") or (substr(account, 1, 3) == "506") or (substr(account, 1, 3) == "507"))
                    aSignOfTheDebtor = 2;
                else
                    aSignOfTheDebtor = 1;
                end;
                insertValuesASignOfTheDebtor(dataSet, 13, aSignOfTheDebtor);
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();
    end;
end;

class (F118AccountDataSource) F118AccountDataSource_2185(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118AccountDataSource(protocolView, dataSources);

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String

            return " WITH"
            /*Счета переоценки*/
            +"\n"+ "     revaluation      AS (SELECT linkedObjects.t_connectObjectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest,"
            +"\n"+ "                                 CASE"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.positiveRevaluation"
            +"\n"+ "                                         THEN 1"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.negativeRevaluation"
            +"\n"+ "                                         THEN -1"
            +"\n"+ "                                     ELSE 0"
            +"\n"+ "                                 END AS t_koefficient"
            +"\n"+ "                            FROM drepaccount_vw       account,"
            +"\n"+ "                                 drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x')"
            +"\n"+ "                             AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                             AND account.t_account = SUBSTR(linkedObjects.t_id, 10)"
            +"\n"+ "                             AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                             AND t_role IN (rep_const.get().cb.objectRoles.account.positiveRevaluation,"
            +"\n"+ "                                            rep_const.get().cb.objectRoles.account.negativeRevaluation)"
            +"\n"+ "                             AND linkedObjects.t_isInstalledForEndDate = 1),"
            /*Счета для которых счет является счетом обеспечения*/
            +"\n"+ "      acauntsGuaranty AS (SELECT linkedObjects.t_id AS t_connectObjectId, t_accountReservePercent,"
            +"\n"+ "                                 account.t_objectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest"
            +"\n"+ "                           FROM drepaccount_vw       account,"
            +"\n"+ "                                drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                          WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x')"
            +"\n"+ "                            AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                            AND account.t_account = SUBSTR(linkedObjects.t_connectObjectId, 10)"
            +"\n"+ "                            AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                            AND linkedObjects.t_isInstalledForEndDate = 1"
            +"\n"+ "                            AND rep_utl.isSuitable(rep_const.get().cb.objectRoles.account.guarantyAccount, TO_CHAR(linkedObjects.t_role)) = 1),"
            /*Эмитент обеспечения*/
            +"\n"+ "      guarantyIssuer  AS (SELECT t_connectObjectId,"
            +"\n"+ "                                 TO_NUMBER(t_id) AS t_id"
            +"\n"+ "                            FROM drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE t_type = rep_const.get().cb.objectTypes.party"
            +"\n"+ "                             AND t_role = rep_const.get().cb.objectRoles.party.issuerGuaranty"
            +"\n"+ "                             AND t_isInstalledForEndDate = 1),"
            +"\n"+ "      repAccount      AS (SELECT drepaccount_vw.*,"
            +"\n"+ "                                 (SELECT guarantyIssuer.t_id"
            +"\n"+ "                                        FROM guarantyIssuer"
            +"\n"+ "                                        WHERE guarantyIssuer.t_connectObjectId = drepaccount_vw.t_objectId)"
            +"\n"+ "                                 AS t_guarantyIssuerId" // идентификатор эмитента обеспечения
            +"\n"+ "                            FROM drepaccount_vw)"
            +"\n"+ "SELECT finalData.*,"
            +"\n"+ "       t_weightedAssets * t_krv * t_coefficient1 AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT data.*,"
            +"\n"+ "               (t_demandAmount - t_reserve) * t_kra AS t_weightedAssets"
            +"\n"+ "          FROM (SELECT account.*,"
            +"\n"+ "                       LEAST(t_contractAmount, t_roubleRest) * t_guarantyReservePercent * 1 AS t_weightedGuaranty,"/*1 - это КРА, хоть он у нас и есть расчитанный, все равно берем 1*/
            +"\n"+ "                       NVL(CASE"
            +"\n"+ "                               WHEN t_account like '301%' AND t_roubleRest = 0"
            +"\n"+ "                                   THEN 0"
            +"\n"+ "                               WHEN t_account like '301%'"
            +"\n"+ "                                   THEN t_demandAmount * t_endDateReserveAmount / t_roubleRest"
            +"\n"+ "                               ELSE t_endDateReserveAmount"
            +"\n"+ "                           END, 0) AS t_reserve"
            +"\n"+ "                  FROM (SELECT repAccount.t_chapter,"
            +"\n"+ "                               repAccount.t_account,"
            +"\n"+ "                               repAccount.t_fiId,"
            +"\n"+ "                               repAccount.t_objectId,"
            +"\n"+ "                               repAccount.t_outCoverRest                                    AS t_roubleRest,"
            +"\n"+ "                               NVL((SELECT acauntsGuaranty.t_accountReservePercent"
            +"\n"+ "                                      FROM acauntsGuaranty"
            +"\n"+ "                                     WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                       AND rowNum < 2), 0)"
            +"\n"+ "                               AS t_guarantyReservePercent," // процент резерва, для расчета взвешенного обеспечения
            +"\n"+ "                               repReserveAccount.t_endDateReserveAmount,"
            +"\n"+ "                               NVL(repAccount.t_guarantyIssuerId,repAccount.t_contragentId) AS t_contractorId,"
            +"\n"+ "                               repAccount.t_guarantyIssuerId                                AS t_guarantyIssuerId,"
            +"\n"+ "                               repAccount.t_contragentId,"
            +"\n"+ "                               repParty.t_name,"
            +"\n"+ "                               NVL((SELECT conStr(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id         = 20" /*Группа взаимосвязанных субъектов*/
            +"\n"+ "                                       AND t_isForParty = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId   = repParty.t_objectId), repParty.t_id) AS t_groupId,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id           = 20" /*Коэффициент КРА*/
            +"\n"+ "                                       AND t_isForAccount = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId     = repAccount.t_objectId), 1) AS t_kra,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id           = 21" /*Коэффициент КРВ*/
            +"\n"+ "                                       AND t_isForAccount = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId     = repAccount.t_objectId), 1) AS t_krv,"
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN EXISTS(SELECT 1"
            +"\n"+ "                                                 FROM drepCategory_vw"
            +"\n"+ "                                                WHERE t_id         = 2" /*характер отношений с банком*/
            +"\n"+ "                                                  AND t_isForParty = 1"
            +"\n"+ "                                                  AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                                  AND t_objectId   = repParty.t_objectId"
            +"\n"+ "                                                  AND t_value NOT IN ('ПР', 'БГ'))"
            +"\n"+ "                                   THEN 1.3"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS t_coefficient1," /*дурацкое название, но так в ТЗ*/
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN t_account like '5%'"
            +"\n"+ "                                        THEN t_outCoverRest +"
            +"\n"+ "                                             (SELECT NVL(SUM(revaluation.t_rest * revaluation.t_koefficient), 0)"
            +"\n"+ "                                                FROM revaluation"
            +"\n"+ "                                               WHERE revaluation.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                                   WHEN t_account like '301%'"
            +"\n"+ "                                        THEN NVL(rep_note.readMinimumRestAmount(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   ELSE t_outCoverRest"
            +"\n"+ "                               END AS t_demandAmount," // Сумма требования
            +"\n"+ "                               (SELECT NVL(SUM(acauntsGuaranty.t_rest), 0)"
            +"\n"+ "                                  FROM acauntsGuaranty"
            +"\n"+ "                                 WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                               AS t_contractAmount," // Сумма договора
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN (SELECT COUNT(1)"
            +"\n"+ "                                           FROM acauntsGuaranty,"
            +"\n"+ "                                                drepCategory_vw"
            +"\n"+ "                                          WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+ "                                            AND drepcategory_vw.t_value = '1'"
            +"\n"+ "                                            AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+ "                                            AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isInstalledForEndDate = 1) = 0"
            +"\n"+ "                                       THEN 0"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS guarantyForAccountFirstQuality" //является обеспечением для счета первой категории качества
            +"\n"+ "                          FROM repAccount,"
            +"\n"+ "                               drepreserveAccount_vw repReserveAccount,"
            +"\n"+ "                               drepParty_vw          repParty"
            +"\n"+ "                         WHERE repParty.t_id = repAccount.t_guarantyIssuerId"
            +"\n"+ "                           AND repReserveAccount.t_connectAccountId(+) = repAccount.t_accountId"
            +"\n"+ "                           AND NOT EXISTS (SELECT 1"
            +"\n"+ "                                             FROM drcbCreditPart_tmp creditPart"
            +"\n"+ "                                            WHERE creditPart.t_account = repAccount.t_Account)) account"
            +"\n"+ "                 WHERE " + filter.isSuitable() + ") data) finalData";
    end;
end;

class (F118AccountDataSource_2185) F118AccountDataSource_2195(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118AccountDataSource_2185(protocolView, dataSources);

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String

            return " WITH"
            /*Счета переоценки*/
            +"\n"+ "     revaluation      AS (SELECT linkedObjects.t_connectObjectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest,"
            +"\n"+ "                                 CASE"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.positiveRevaluation"
            +"\n"+ "                                         THEN 1"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.negativeRevaluation"
            +"\n"+ "                                         THEN -1"
            +"\n"+ "                                     ELSE 0"
            +"\n"+ "                                 END AS t_koefficient"
            +"\n"+ "                            FROM drepaccount_vw       account,"
            +"\n"+ "                                 drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x')"
            +"\n"+ "                             AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                             AND account.t_account = SUBSTR(linkedObjects.t_id, 10)"
            +"\n"+ "                             AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                             AND t_role IN (rep_const.get().cb.objectRoles.account.positiveRevaluation,"
            +"\n"+ "                                            rep_const.get().cb.objectRoles.account.negativeRevaluation)"
            +"\n"+ "                             AND linkedObjects.t_isInstalledForEndDate = 1),"
            /*Счета для которых счет является счетом обеспечения*/
            +"\n"+ "      acauntsGuaranty AS (SELECT linkedObjects.t_id AS t_connectObjectId, t_accountReservePercent,"
            +"\n"+ "                                 account.t_objectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest"
            +"\n"+ "                           FROM drepaccount_vw       account,"
            +"\n"+ "                                drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                          WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x')"
            +"\n"+ "                            AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                            AND account.t_account = SUBSTR(linkedObjects.t_connectObjectId, 10)"
            +"\n"+ "                            AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                            AND linkedObjects.t_isInstalledForEndDate = 1"
            +"\n"+ "                            AND rep_utl.isSuitable(rep_const.get().cb.objectRoles.account.guarantyAccount, TO_CHAR(linkedObjects.t_role)) = 1),"
            /*Эмитент обеспечения*/
            +"\n"+ "      guarantyIssuer  AS (SELECT t_connectObjectId,"
            +"\n"+ "                                 TO_NUMBER(t_id) AS t_id"
            +"\n"+ "                            FROM drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE t_type = rep_const.get().cb.objectTypes.party"
            +"\n"+ "                             AND t_role = rep_const.get().cb.objectRoles.party.issuerGuaranty"
            +"\n"+ "                             AND t_isInstalledForEndDate = 1),"
            +"\n"+ "      repAccount      AS (SELECT drepaccount_vw.*,"
            +"\n"+ "                                 (SELECT guarantyIssuer.t_id"
            +"\n"+ "                                        FROM guarantyIssuer"
            +"\n"+ "                                        WHERE guarantyIssuer.t_connectObjectId = drepaccount_vw.t_objectId)"
            +"\n"+ "                                 AS t_guarantyIssuerId" // идентификатор эмитента обеспечения
            +"\n"+ "                            FROM drepaccount_vw)"
            +"\n"+ "SELECT finalData.*,"
            +"\n"+ "       t_weightedAssets * t_krv * t_coefficient1 AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT data.*,"
            +"\n"+ "               (t_demandAmount - t_reserve) * t_kra AS t_weightedAssets"
            +"\n"+ "          FROM (SELECT account.*,"
            +"\n"+ "                       LEAST(t_contractAmount, t_roubleRest) * t_guarantyReservePercent * 1 AS t_weightedGuaranty,"/*1 - это КРА, хоть он у нас и есть расчитанный, все равно берем 1*/
            +"\n"+ "                       NVL(CASE"
            +"\n"+ "                               WHEN t_account like '301%' AND t_roubleRest = 0"
            +"\n"+ "                                   THEN 0"
            +"\n"+ "                               WHEN t_account like '301%'"
            +"\n"+ "                                   THEN t_demandAmount * t_endDateReserveAmount / t_roubleRest"
            +"\n"+ "                               ELSE t_endDateReserveAmount"
            +"\n"+ "                           END, 0) AS t_reserve"
            +"\n"+ "                  FROM (SELECT repAccount.t_chapter,"
            +"\n"+ "                               repAccount.t_account,"
            +"\n"+ "                               repAccount.t_fiId,"
            +"\n"+ "                               repAccount.t_objectId,"
            +"\n"+ "                               repAccount.t_outCoverRest                                    AS t_roubleRest,"
            +"\n"+ "                               NVL((SELECT acauntsGuaranty.t_accountReservePercent"
            +"\n"+ "                                      FROM acauntsGuaranty"
            +"\n"+ "                                     WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                       AND rowNum < 2), 0)"
            +"\n"+ "                               AS t_guarantyReservePercent," // процент резерва, для расчета взвешенного обеспечения
            +"\n"+ "                               repReserveAccount.t_endDateReserveAmount,"
            +"\n"+ "                               NVL(repAccount.t_guarantyIssuerId,repAccount.t_contragentId) AS t_contractorId,"
            +"\n"+ "                               repAccount.t_guarantyIssuerId                                AS t_guarantyIssuerId,"
            +"\n"+ "                               repAccount.t_contragentId,"
            +"\n"+ "                               repParty.t_name,"
            +"\n"+ "                               NVL((SELECT conStr(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id         = 20" /*Группа взаимосвязанных субъектов*/
            +"\n"+ "                                       AND t_isForParty = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId   = repParty.t_objectId), repParty.t_id) AS t_groupId,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id           = 20" /*Коэффициент КРА*/
            +"\n"+ "                                       AND t_isForAccount = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId     = repAccount.t_objectId), 1) AS t_kra,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE t_id           = 21" /*Коэффициент КРВ*/
            +"\n"+ "                                       AND t_isForAccount = 1"
            +"\n"+ "                                       AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND t_objectId     = repAccount.t_objectId), 1) AS t_krv,"
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN EXISTS(SELECT 1"
            +"\n"+ "                                                 FROM drepCategory_vw"
            +"\n"+ "                                                WHERE t_id         = 2" /*характер отношений с банком*/
            +"\n"+ "                                                  AND t_isForParty = 1"
            +"\n"+ "                                                  AND t_isinstalledForEndDate = 1"
            +"\n"+ "                                                  AND t_objectId   = repParty.t_objectId"
            +"\n"+ "                                                  AND t_value NOT IN ('ПР', 'БГ'))"
            +"\n"+ "                                   THEN 1.3"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS t_coefficient1," /*дурацкое название, но так в ТЗ*/
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN t_account like '5%'"
            +"\n"+ "                                        THEN t_outCoverRest +"
            +"\n"+ "                                             (SELECT NVL(SUM(revaluation.t_rest * revaluation.t_koefficient), 0)"
            +"\n"+ "                                                FROM revaluation"
            +"\n"+ "                                               WHERE revaluation.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                                   WHEN t_account like '301%'"
            +"\n"+ "                                        THEN NVL(rep_note.readMinimumRestAmount(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   WHEN t_account like '47408%'"
            +"\n"+ "                                        THEN rcb_f118.getDemandAmmount47408(repAccount.t_chapter, repAccount.t_fiId, repAccount.t_account)"
            +"\n"+ "                                   ELSE t_outCoverRest"
            +"\n"+ "                               END AS t_demandAmount," // Сумма требования
            +"\n"+ "                               (SELECT NVL(SUM(acauntsGuaranty.t_rest), 0)"
            +"\n"+ "                                  FROM acauntsGuaranty"
            +"\n"+ "                                 WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                               AS t_contractAmount," // Сумма договора
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN (SELECT COUNT(1)"
            +"\n"+ "                                           FROM acauntsGuaranty,"
            +"\n"+ "                                                drepCategory_vw"
            +"\n"+ "                                          WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+ "                                            AND drepcategory_vw.t_value = '1'"
            +"\n"+ "                                            AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+ "                                            AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isInstalledForEndDate = 1) = 0"
            +"\n"+ "                                       THEN 0"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS guarantyForAccountFirstQuality" //является обеспечением для счета первой категории качества
            +"\n"+ "                          FROM repAccount,"
            +"\n"+ "                               drepreserveAccount_vw repReserveAccount,"
            +"\n"+ "                               drepParty_vw          repParty"
            +"\n"+ "                         WHERE repParty.t_id = NVL(repAccount.t_guarantyIssuerId, repAccount.t_contragentId)"
            +"\n"+ "                           AND repReserveAccount.t_connectAccountId(+) = repAccount.t_accountId"
            +"\n"+ "                           AND NOT EXISTS (SELECT 1"
            +"\n"+ "                                             FROM drcbCreditPart_tmp creditPart"
            +"\n"+ "                                            WHERE creditPart.t_account = repAccount.t_Account)) account"
            +"\n"+ "                 WHERE " + filter.isSuitable() + ") data) finalData";
    end;
end;

/**
 * Класс ИД по ГК по 2254-У
 */
class (F118AccountDataSource_2195) F118AccountDataSource_2254(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118AccountDataSource_2195(protocolView, dataSources);

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String

            return " WITH"
            /*Счета переоценки*/
            +"\n"+ "     revaluation      AS (SELECT linkedObjects.t_connectObjectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest,"
            +"\n"+ "                                 CASE"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.positiveRevaluation"
            +"\n"+ "                                         THEN 1"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.negativeRevaluation"
            +"\n"+ "                                         THEN -1"
            +"\n"+ "                                     ELSE 0"
            +"\n"+ "                                 END AS t_koefficient"
            +"\n"+ "                            FROM drepaccount_vw       account,"
            +"\n"+ "                                 drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x')"
            +"\n"+ "                             AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                             AND account.t_account = SUBSTR(linkedObjects.t_id, 10)"
            +"\n"+ "                             AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                             AND t_role IN (rep_const.get().cb.objectRoles.account.positiveRevaluation,"
            +"\n"+ "                                            rep_const.get().cb.objectRoles.account.negativeRevaluation)"
            +"\n"+ "                             AND linkedObjects.t_isInstalledForEndDate = 1),"
            /*Счета для которых счет является счетом обеспечения*/
            +"\n"+ "      acauntsGuaranty AS (SELECT linkedObjects.t_id AS t_connectObjectId, t_accountReservePercent,"
            +"\n"+ "                                 account.t_objectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest"
            +"\n"+ "                           FROM drepaccount_vw       account,"
            +"\n"+ "                                drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                          WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x')"
            +"\n"+ "                            AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                            AND account.t_account = SUBSTR(linkedObjects.t_connectObjectId, 10)"
            +"\n"+ "                            AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                            AND linkedObjects.t_isInstalledForEndDate = 1"
            +"\n"+ "                            AND rep_utl.isSuitable(rep_const.get().cb.objectRoles.account.guarantyAccount, TO_CHAR(linkedObjects.t_role)) = 1),"
            /*Эмитент обеспечения*/
            +"\n"+ "      guarantyIssuer  AS (SELECT t_connectObjectId,"
            +"\n"+ "                                 TO_NUMBER(t_id) AS t_id"
            +"\n"+ "                            FROM drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE t_type = rep_const.get().cb.objectTypes.party"
            +"\n"+ "                             AND t_role = rep_const.get().cb.objectRoles.party.issuerGuaranty"
            +"\n"+ "                             AND t_isInstalledForEndDate = 1),"
            +"\n"+ "      repAccount      AS (SELECT drepaccount_vw.*,"
            +"\n"+ "                                 (SELECT guarantyIssuer.t_id"
            +"\n"+ "                                        FROM guarantyIssuer"
            +"\n"+ "                                        WHERE guarantyIssuer.t_connectObjectId = drepaccount_vw.t_objectId)"
            +"\n"+ "                                 AS t_guarantyIssuerId" // идентификатор эмитента обеспечения
            +"\n"+ "                            FROM drepaccount_vw)"
            +"\n"+ "SELECT finalData.*,"
            +"\n"+ "       t_weightedAssets * t_krv * t_coefficient1 AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT data.*,"
            +"\n"+ "               (t_demandAmount - t_reserve) * t_kra AS t_weightedAssets"
            +"\n"+ "          FROM (SELECT account.*,"
            +"\n"+ "                       LEAST(t_contractAmount, t_roubleRest) * t_guarantyReservePercent * 1 AS t_weightedGuaranty,"/*1 - это КРА, хоть он у нас и есть расчитанный, все равно берем 1*/
            +"\n"+ "                       NVL(CASE"
            +"\n"+ "                               WHEN t_account like '301%' AND t_roubleRest = 0"
            +"\n"+ "                                   THEN 0"
            +"\n"+ "                               WHEN t_account like '301%'"
            +"\n"+ "                                   THEN t_demandAmount * t_endDateReserveAmount / t_roubleRest"
            +"\n"+ "                               ELSE t_endDateReserveAmount"
            +"\n"+ "                           END, 0) AS t_reserve,"
            +"\n"+ "                       rcb_f118.getAccountKra(t_chapter, t_fiId, t_account, t_demandAmount) AS t_kra"
            +"\n"+ "                  FROM (SELECT repAccount.t_chapter,"
            +"\n"+ "                               repAccount.t_account,"
            +"\n"+ "                               repAccount.t_fiId,"
            +"\n"+ "                               repAccount.t_objectId,"
            +"\n"+ "                               repAccount.t_outCoverRest                                    AS t_roubleRest,"
            +"\n"+ "                               NVL((SELECT acauntsGuaranty.t_accountReservePercent"
            +"\n"+ "                                      FROM acauntsGuaranty"
            +"\n"+ "                                     WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                       AND rowNum < 2), 0)"
            +"\n"+ "                               AS t_guarantyReservePercent," // процент резерва, для расчета взвешенного обеспечения
            +"\n"+ "                               repReserveAccount.t_endDateReserveAmount,"
            +"\n"+ "                               NVL(repAccount.t_guarantyIssuerId,repAccount.t_contragentId) AS t_contractorId,"
            +"\n"+ "                               repAccount.t_guarantyIssuerId                                AS t_guarantyIssuerId,"
            +"\n"+ "                               repAccount.t_contragentId,"
            +"\n"+ "                               repParty.t_name,"
            +"\n"+ "                               NVL((SELECT conStr(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE drepCategory_vw.t_id         = 20" /*Группа взаимосвязанных субъектов*/
            +"\n"+ "                                       AND drepCategory_vw.t_isForParty = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_objectId   = repParty.t_objectId), repParty.t_id) AS t_groupId,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE drepCategory_vw.t_id           = 21" /*Коэффициент КРВ*/
            +"\n"+ "                                       AND drepCategory_vw.t_isForAccount = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_objectId     = repAccount.t_objectId), 1) AS t_krv,"
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN EXISTS(SELECT 1"
            +"\n"+ "                                                 FROM drepCategory_vw"
            +"\n"+ "                                                WHERE drepCategory_vw.t_id         = 2" /*характер отношений с банком*/
            +"\n"+ "                                                  AND drepCategory_vw.t_isForParty = 1"
            +"\n"+ "                                                  AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                                  AND drepCategory_vw.t_objectId   = repParty.t_objectId"
            +"\n"+ "                                                  AND drepCategory_vw.t_value NOT IN ('ПР', 'БГ'))"
            +"\n"+ "                                   THEN 1.3"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS t_coefficient1," /*дурацкое название, но так в ТЗ*/
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN t_account like '5%'"
            +"\n"+ "                                        THEN t_outCoverRest +"
            +"\n"+ "                                             (SELECT NVL(SUM(revaluation.t_rest * revaluation.t_koefficient), 0)"
            +"\n"+ "                                                FROM revaluation"
            +"\n"+ "                                               WHERE revaluation.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                                   WHEN t_account like '301%'"
            +"\n"+ "                                        THEN NVL(rep_note.readMinimumRestAmount(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   WHEN t_account like '320%' OR t_account like '322%' OR t_account like '32401%'"
            +"\n"+ "                                        THEN t_outCoverRest - NVL(rep_note.readCompensationSum(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   WHEN t_account like '47408%'"
            +"\n"+ "                                        THEN rcb_f118.getDemandAmmount47408(repAccount.t_chapter, repAccount.t_fiId, repAccount.t_account)"
            +"\n"+ "                                   ELSE t_outCoverRest"
            +"\n"+ "                               END AS t_demandAmount," // Сумма требования
            +"\n"+ "                               (SELECT NVL(SUM(acauntsGuaranty.t_rest), 0)"
            +"\n"+ "                                  FROM acauntsGuaranty"
            +"\n"+ "                                 WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                               AS t_contractAmount," // Сумма договора
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN (SELECT COUNT(1)"
            +"\n"+ "                                           FROM acauntsGuaranty,"
            +"\n"+ "                                                drepCategory_vw"
            +"\n"+ "                                          WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+ "                                            AND drepcategory_vw.t_value = '1'"
            +"\n"+ "                                            AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+ "                                            AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isInstalledForEndDate = 1) = 0"
            +"\n"+ "                                       THEN 0"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS guarantyForAccountFirstQuality" //является обеспечением для счета первой категории качества
            +"\n"+ "                          FROM repAccount,"
            +"\n"+ "                               drepreserveAccount_vw repReserveAccount,"
            +"\n"+ "                               drepParty_vw          repParty"
            +"\n"+ "                         WHERE repParty.t_id = NVL(repAccount.t_guarantyIssuerId, repAccount.t_contragentId)"
            +"\n"+ "                           AND repReserveAccount.t_connectAccountId(+) = repAccount.t_accountId"
            +"\n"+ "                           AND NOT EXISTS (SELECT 1"
            +"\n"+ "                                             FROM drcbCreditPart_tmp creditPart"
            +"\n"+ "                                            WHERE creditPart.t_account = repAccount.t_Account)) account"
            +"\n"+ "                 WHERE " + filter.isSuitable() + ") data) finalData";
    end;
end;

class (F118AccountDataSource_2254) F118AccountDataSource_2808(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF118AccountDataSource_2254(protocolView, dataSources);

    private macro getDataSet(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : Object

        filter.op("AND").op("NOT").op("(").debtorIsBank().op("AND").isDebtorRelationsCharacterEqualTo("БГ").op(")");

        var dataSet = TRsbDataSet("SELECT " + getSqlString(attribute.getPart().getId()) + " AS t_partId,"
            +"\n"+                "       " + getSqlString(attribute.getId()) + " AS t_columnId,"
            +"\n"+                "       t_groupId      AS t_debtorGroupId,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_contractorId) AS t_debtorid,"
            +"\n"+                "       DECODE(GROUPING(t_contractorId), 1, t_groupId, t_name) AS t_debtorname,"
            +"\n"+                "       t_account, t_fiId, t_reserve, t_kra, t_krv, " + getSpecificFieldsList() + ","
            +"\n"+                "       SUM(CASE "
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeOthers(attribute))
            +"\n"+                "                   THEN t_weightedGuaranty"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrv(attribute))
            +"\n"+                "                   THEN t_weightedAssets"
            +"\n"+                "               WHEN " + getSqlBoolIdentity(isAttributeKrz(attribute))
            +"\n"+                "                   THEN t_weightedEquivalent"
            +"\n"+                "               ELSE NULL"
            +"\n"+                "           END) AS t_value,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_weightedAssets) = 1 AND GROUPING(t_contractorId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorItog,"
            +"\n"+                "       CASE"
            +"\n"+                "           WHEN GROUPING(t_contractorId) = 1 AND GROUPING(t_groupId) = 0"
            +"\n"+                "               THEN 1"
            +"\n"+                "           ELSE 0"
            +"\n"+                "       END AS t_isDebtorsGroupItog"
            +"\n"+                "  FROM (" + getSourceQuery(filter, attribute) + ")"
            +"\n"+                " HAVING GROUPING(t_groupId) = 0"
            +"\n"+                "GROUP BY ROLLUP(t_groupId,"
            +"\n"+                "               (t_contractorId, t_name),"
            +"\n"+                "               (t_weightedAssets, t_fiId, t_weightedEquivalent, t_account, t_reserve, t_kra, t_krv,"
            +"\n"+                "               " + getSpecificFieldsList() + "))");

        return dataSet;
    end;

    private macro getSourceQuery(filter : RcbDataSourceFilter, attribute : RcbAttributeBase) : String

            return " WITH"
            /*Счета переоценки*/
            +"\n"+ "     revaluation      AS (SELECT linkedObjects.t_connectObjectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest,"
            +"\n"+ "                                 CASE"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.positiveRevaluation"
            +"\n"+ "                                         THEN 1"
            +"\n"+ "                                     WHEN linkedObjects.t_role = rep_const.get().cb.objectRoles.account.negativeRevaluation"
            +"\n"+ "                                         THEN -1"
            +"\n"+ "                                     ELSE 0"
            +"\n"+ "                                 END AS t_koefficient"
            +"\n"+ "                            FROM drepaccount_vw       account,"
            +"\n"+ "                                 drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x')"
            +"\n"+ "                             AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                             AND account.t_account = SUBSTR(linkedObjects.t_id, 10)"
            +"\n"+ "                             AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                             AND t_role IN (rep_const.get().cb.objectRoles.account.positiveRevaluation,"
            +"\n"+ "                                            rep_const.get().cb.objectRoles.account.negativeRevaluation)"
            +"\n"+ "                             AND linkedObjects.t_isInstalledForEndDate = 1),"
            /*Счета для которых счет является счетом обеспечения*/
            +"\n"+ "      acauntsGuaranty AS (SELECT linkedObjects.t_id AS t_connectObjectId, t_accountReservePercent,"
            +"\n"+ "                                 account.t_objectId,"
            +"\n"+ "                                 t_outCoverRest AS t_rest"
            +"\n"+ "                           FROM drepaccount_vw       account,"
            +"\n"+ "                                drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                          WHERE account.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x')"
            +"\n"+ "                            AND account.t_fiId    = TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx')"
            +"\n"+ "                            AND account.t_account = SUBSTR(linkedObjects.t_connectObjectId, 10)"
            +"\n"+ "                            AND linkedObjects.t_type = rep_const.get().cb.objectTypes.account"
            +"\n"+ "                            AND linkedObjects.t_isInstalledForEndDate = 1"
            +"\n"+ "                            AND rep_utl.isSuitable(rep_const.get().cb.objectRoles.account.guarantyAccount, TO_CHAR(linkedObjects.t_role)) = 1),"
            /*Эмитент обеспечения*/
            +"\n"+ "      guarantyIssuer  AS (SELECT t_connectObjectId,"
            +"\n"+ "                                 TO_NUMBER(t_id) AS t_id"
            +"\n"+ "                            FROM drepLinkedObjects_vw linkedObjects"
            +"\n"+ "                           WHERE t_type = rep_const.get().cb.objectTypes.party"
            +"\n"+ "                             AND t_role = rep_const.get().cb.objectRoles.party.issuerGuaranty"
            +"\n"+ "                             AND t_isInstalledForEndDate = 1),"
            +"\n"+ "      repAccount      AS (SELECT drepaccount_vw.*,"
            +"\n"+ "                                 (SELECT guarantyIssuer.t_id"
            +"\n"+ "                                        FROM guarantyIssuer"
            +"\n"+ "                                        WHERE guarantyIssuer.t_connectObjectId = drepaccount_vw.t_objectId)"
            +"\n"+ "                                 AS t_guarantyIssuerId" // идентификатор эмитента обеспечения
            +"\n"+ "                            FROM drepaccount_vw)"
            +"\n"+ "SELECT finalData.*,"
            +"\n"+ "       t_weightedAssets * t_krv AS t_weightedEquivalent"
            +"\n"+ "  FROM (SELECT data.*,"
            +"\n"+ "               (t_demandAmount - t_reserve) * t_kra AS t_weightedAssets"
            +"\n"+ "          FROM (SELECT account.*,"
            +"\n"+ "                       LEAST(t_contractAmount, t_roubleRest) * t_guarantyReservePercent * 1 AS t_weightedGuaranty,"/*1 - это КРА, хоть он у нас и есть расчитанный, все равно берем 1*/
            +"\n"+ "                       NVL(CASE"
            +"\n"+ "                               WHEN t_account like '301%' AND t_roubleRest = 0"
            +"\n"+ "                                   THEN 0"
            +"\n"+ "                               WHEN t_account like '301%'"
            +"\n"+ "                                   THEN t_demandAmount * t_endDateReserveAmount / t_roubleRest"
            +"\n"+ "                               ELSE t_endDateReserveAmount"
            +"\n"+ "                           END, 0) AS t_reserve,"
            +"\n"+ "                       rcb_f118.getAccountKra(t_chapter, t_fiId, t_account, t_demandAmount) AS t_kra"
            +"\n"+ "                  FROM (SELECT repAccount.t_chapter,"
            +"\n"+ "                               repAccount.t_account,"
            +"\n"+ "                               repAccount.t_fiId,"
            +"\n"+ "                               repAccount.t_objectId,"
            +"\n"+ "                               repAccount.t_outCoverRest                                    AS t_roubleRest,"
            +"\n"+ "                               NVL((SELECT acauntsGuaranty.t_accountReservePercent"
            +"\n"+ "                                      FROM acauntsGuaranty"
            +"\n"+ "                                     WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                       AND rowNum < 2), 0)"
            +"\n"+ "                               AS t_guarantyReservePercent," // процент резерва, для расчета взвешенного обеспечения
            +"\n"+ "                               repReserveAccount.t_endDateReserveAmount,"
            +"\n"+ "                               NVL(repAccount.t_guarantyIssuerId,repAccount.t_contragentId) AS t_contractorId,"
            +"\n"+ "                               repAccount.t_guarantyIssuerId                                AS t_guarantyIssuerId,"
            +"\n"+ "                               repAccount.t_contragentId,"
            +"\n"+ "                               repParty.t_name,"
            +"\n"+ "                               NVL((SELECT conStr(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE drepCategory_vw.t_id         = 20" /*Группа взаимосвязанных субъектов*/
            +"\n"+ "                                       AND drepCategory_vw.t_isForParty = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_objectId   = repParty.t_objectId), repParty.t_id) AS t_groupId,"
            +"\n"+ "                               NVL((SELECT MAX(t_value)"
            +"\n"+ "                                      FROM drepCategory_vw"
            +"\n"+ "                                     WHERE drepCategory_vw.t_id           = 21" /*Коэффициент КРВ*/
            +"\n"+ "                                       AND drepCategory_vw.t_isForAccount = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_isinstalledForEndDate = 1"
            +"\n"+ "                                       AND drepCategory_vw.t_objectId     = repAccount.t_objectId), 1) AS t_krv,"
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN t_account like '5%'"
            +"\n"+ "                                        THEN t_outCoverRest +"
            +"\n"+ "                                             (SELECT NVL(SUM(revaluation.t_rest * revaluation.t_koefficient), 0)"
            +"\n"+ "                                                FROM revaluation"
            +"\n"+ "                                               WHERE revaluation.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                                   WHEN t_account like '301%'"
            +"\n"+ "                                        THEN NVL(rep_note.readMinimumRestAmount(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   WHEN t_account like '320%' OR t_account like '322%' OR t_account like '32401%'"
            +"\n"+ "                                        THEN t_outCoverRest - NVL(rep_note.readCompensationSum(repAccount.t_objectId, rep_data.getEndDate()), 0)"
            +"\n"+ "                                   WHEN t_account like '47408%'"
            +"\n"+ "                                        THEN rcb_f118.getDemandAmmount47408(repAccount.t_chapter, repAccount.t_fiId, repAccount.t_account)"
            +"\n"+ "                                   ELSE t_outCoverRest"
            +"\n"+ "                               END AS t_demandAmount," // Сумма требования
            +"\n"+ "                               (SELECT NVL(SUM(acauntsGuaranty.t_rest), 0)"
            +"\n"+ "                                  FROM acauntsGuaranty"
            +"\n"+ "                                 WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId)"
            +"\n"+ "                               AS t_contractAmount," // Сумма договора
            +"\n"+ "                               CASE"
            +"\n"+ "                                   WHEN (SELECT COUNT(1)"
            +"\n"+ "                                           FROM acauntsGuaranty,"
            +"\n"+ "                                                drepCategory_vw"
            +"\n"+ "                                          WHERE acauntsGuaranty.t_connectObjectId = repAccount.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isForAccount = 1"
            +"\n"+ "                                            AND drepcategory_vw.t_value = '1'"
            +"\n"+ "                                            AND drepcategory_vw.t_id = rep_const.get().cb.categories.account.qualityCategory"
            +"\n"+ "                                            AND drepcategory_vw.t_objectId = acauntsGuaranty.t_objectId"
            +"\n"+ "                                            AND drepcategory_vw.t_isInstalledForEndDate = 1) = 0"
            +"\n"+ "                                       THEN 0"
            +"\n"+ "                                   ELSE 1"
            +"\n"+ "                               END AS guarantyForAccountFirstQuality" //является обеспечением для счета первой категории качества
            +"\n"+ "                          FROM repAccount,"
            +"\n"+ "                               drepreserveAccount_vw repReserveAccount,"
            +"\n"+ "                               drepParty_vw          repParty"
            +"\n"+ "                         WHERE repParty.t_id = NVL(repAccount.t_guarantyIssuerId, repAccount.t_contragentId)"
            +"\n"+ "                           AND repReserveAccount.t_connectAccountId(+) = repAccount.t_accountId"
            +"\n"+ "                           AND NOT EXISTS (SELECT 1"
            +"\n"+ "                                             FROM drcbCreditPart_tmp creditPart"
            +"\n"+ "                                            WHERE creditPart.t_account = repAccount.t_Account)) account"
            +"\n"+ "                 WHERE " + filter.isSuitable() + ") data) finalData";
    end;
end;

class (RcbDataSource) F118TempTableDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("TempTable", protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)

         macro getSummaryColumn(attribute : RcbAttributeBase)
             if (attribute.getPart().getId() == 1)
                return "6";
             end;

             return "5";
         end;

         var recordsCount = ternary(attribute.getPart().getId() == "1", "20", "10");

         /*
            Если калонка КРЗ Всего, то исключаем поле t_columnId из групировки и получаем сумарные значения.
          */
         var columnIdField = ternary(attribute.getId() == getSummaryColumn(attribute), null, ", t_columnId");

         var dataSet = TRsbDataSet("WITH groupNumber    AS (SELECT d.*,"
             +"\n"+                "                               ROW_NUMBER () OVER (PARTITION BY t_partid ORDER BY t_partid, t_value DESC) rn"
             +"\n"+                "                          FROM (SELECT   t_partid, t_debtorgroupid, MAX(t_debtorId) AS t_debtorId,"
             +"\n"+                "                                         SUM (t_value) t_value"
             +"\n"+                "                                    FROM df118_i2055_tmp"
             +"\n"+                "                                   WHERE t_isgroupitog = 1"
             +"\n"+                "                                GROUP BY t_partid, t_debtorgroupid) d),"
             +"\n"+                "     subgroupNumber AS (SELECT d.*,"
             +"\n"+                "                               ROW_NUMBER() OVER (PARTITION BY t_partid, t_debtorgroupid ORDER BY t_partid, t_debtorgroupid, t_value DESC) rn"
             +"\n"+                "                          FROM (SELECT   t_partid, t_debtorgroupid, t_debtorId,"
             +"\n"+                "                                         SUM (t_value) t_value"
             +"\n"+                "                                    FROM df118_i2055_tmp"
             +"\n"+                "                                   WHERE t_isgroupitog = 0"
             +"\n"+                "                                GROUP BY t_partid, t_debtorgroupid, t_debtorId) d),"
             +"\n"+                "     joiningData    AS (SELECT NVL(groupNumber.t_partid, subgroupNumber.t_partid)                AS t_partid,"
             +"\n"+                "                               NVL(groupNumber.t_debtorgroupid, subgroupNumber.t_debtorgroupid)  AS t_debtorgroupid,"
             +"\n"+                "                               NVL(groupNumber.t_debtorId, subgroupNumber.t_debtorId)            AS t_debtorId,"
             +"\n"+                "                               groupNumber.rn                                                    AS t_groupNumber,"
             +"\n"+                "                               subgroupNumber.rn                                                 AS t_subgroupNumber"
             +"\n"+                "                          FROM groupNumber FULL OUTER JOIN subgroupNumber"
             +"\n"+                "                                                        ON groupNumber.t_partid        = subgroupNumber.t_partid"
             +"\n"+                "                                                       AND groupNumber.t_debtorgroupid = subgroupNumber.t_debtorgroupid"
             +"\n"+                "                                                       AND groupNumber.t_debtorid      = subgroupNumber.t_debtorid),"
             +"\n"+                "     dataLimiter    AS (SELECT joiningData.t_partId,"
             +"\n"+                "                               joiningData.t_debtorGroupId,"
             +"\n"+                "                               joiningData.t_debtorId,"
             +"\n"+                "                               CASE"
             +"\n"+                "                                   WHEN joiningData.t_subgroupNumber > 5"
             +"\n"+                "                                       THEN 1"
             +"\n"+                "                                   ELSE 0"
             +"\n"+                "                               END AS t_isOthers,"
             +"\n"+                "                               NVL (joiningData.t_groupNumber, (SELECT rn"
             +"\n"+                "                                                                  FROM groupNumber"
             +"\n"+                "                                                                 WHERE groupNumber.t_partid        = joiningData.t_partid"
             +"\n"+                "                                                                   AND groupNumber.t_debtorgroupid = joiningData.t_debtorgroupid)) AS t_groupNumber,"
             +"\n"+                "                               NVL (joiningData.t_subgroupNumber, -1) AS t_subgroupNumber"
             +"\n"+                "                          FROM joiningData)"
             +"\n"+                "SELECT temp.t_partId,"
             +"\n"+                "       temp.t_columnId,"
             +"\n"+                "       temp.t_debtorGroupId,"
             +"\n"+                "       NVL(temp.t_debtorId, 'Прочие')       AS t_debtorId,"
             +"\n"+                "       NVL(temp.t_debtorName,'Прочие')      AS t_debtorName,"
             +"\n"+                "       SUM(temp.t_value)                    AS t_value,"
             +"\n"+                "       NVL(dataLimiter.t_subgroupNumber, 6) AS t_subgroupNumber,"
             +"\n"+                "       temp.t_isGroupItog,"
             +"\n"+                "       temp.t_isDebtorItog,"
             +"\n"+                "       dataLimiter.t_groupNumber, "
             +"\n"+                "       dataLimiter.t_isOthers"
             +"\n"+                "  FROM (SELECT t_partId" + nvl(columnIdField, ", " + getSummaryColumn(attribute)) + " AS t_columnId, t_debtorGroupId, t_debtorId,"
             +"\n"+                "               t_debtorName, t_isGroupItog, t_isDebtorItog,"
             +"\n"+                "               SUM(t_value) AS t_value"
             +"\n"+                "          FROM df118_i2055_tmp"
             +"\n"+                "        GROUP BY t_partId" + nvl(columnIdField, "") + ", t_debtorGroupId, t_debtorId, t_debtorName, t_isGroupItog, t_isDebtorItog) temp,"
             +"\n"+                "       dataLimiter"
             +"\n"+                " WHERE temp.t_partId        = dataLimiter.t_partId"
             +"\n"+                "   AND temp.t_debtorGroupId = dataLimiter.t_debtorGroupId"
             +"\n"+                "   AND temp.t_debtorId      = dataLimiter.t_debtorId"
             +"\n"+                "   AND NOT (temp.t_debtorid = temp.t_debtorgroupid AND t_isDebtorItog = 1)"
             +"\n"+                "   AND dataLimiter.t_groupNumber <= " + recordsCount
             +"\n"+                "   AND " + filter.isSuitable()
             +"\n"+                "HAVING (GROUPING (temp.t_debtorId) = 0 AND dataLimiter.t_isOthers = 0) OR (GROUPING (temp.t_debtorId) = 1 AND dataLimiter.t_isOthers = 1)"
             +"\n"+                "GROUP BY ROLLUP ((temp.t_partId, temp.t_columnId, temp.t_debtorGroupId, dataLimiter.t_groupNumber, dataLimiter.t_isOthers),"
             +"\n"+                "                 (temp.t_debtorId, temp.t_debtorName, temp.t_value, temp.t_isGroupItog, temp.t_isDebtorItog, dataLimiter.t_subgroupNumber))"
             +"\n"+                "ORDER BY temp.t_partId, temp.t_columnId, dataLimiter.t_groupNumber, dataLimiter.t_subgroupNumber", RSDVAL_CLIENT, RSDVAL_STATIC);

        return dataSet;
    end;
end;

class (RcbDataSources) F118DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F118CapitalDataSource(null, this));
        m_dataSourcePool.push_back(F118LoansDataSource(m_protocolView.getDataProtocolView("Loans"), this));
        m_dataSourcePool.push_back(F118AccountDataSource(m_protocolView.getDataProtocolView("Account"), this));
        m_dataSourcePool.push_back(F118TempTableDataSource(null, this));
        m_dataSourcePool.push_back(F118H6DataSource(m_protocolView.getDataProtocolView("H6"), this));
    end;

end;

class (F118DataSources) F118DataSources_2185(protocolView : RcbCalculateProtocolView)
    initF118DataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F118CapitalDataSource(null, this));
        m_dataSourcePool.push_back(F118LoansDataSource(m_protocolView.getDataProtocolView("Loans"), this));
        m_dataSourcePool.push_back(F118AccountDataSource_2185(m_protocolView.getDataProtocolView("Account"), this));
        m_dataSourcePool.push_back(F118TempTableDataSource(null, this));
        m_dataSourcePool.push_back(F118H6DataSource(m_protocolView.getDataProtocolView("H6"), this));
    end;

end;

class (F118DataSources_2185) F118DataSources_2195(protocolView : RcbCalculateProtocolView)
    initF118DataSources_2185(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F118CapitalDataSource(null, this));
        m_dataSourcePool.push_back(F118LoansDataSource(m_protocolView.getDataProtocolView("Loans"), this));
        m_dataSourcePool.push_back(F118AccountDataSource_2195(m_protocolView.getDataProtocolView("Account"), this));
        m_dataSourcePool.push_back(F118TempTableDataSource(null, this));
        m_dataSourcePool.push_back(F118H6DataSource(m_protocolView.getDataProtocolView("H6"), this));
    end;

end;

/**
 * Класс ИД по 2254-У
 */
class (F118DataSources_2195) F118DataSources_2254(protocolView : RcbCalculateProtocolView)
    initF118DataSources_2195(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F118CapitalDataSource(null, this));
        m_dataSourcePool.push_back(F118LoansDataSource(m_protocolView.getDataProtocolView("Loans"), this));
        m_dataSourcePool.push_back(F118AccountDataSource_2254(m_protocolView.getDataProtocolView("Account"), this));
        m_dataSourcePool.push_back(F118TempTableDataSource(null, this));
        m_dataSourcePool.push_back(F118H6DataSource(m_protocolView.getDataProtocolView("H6"), this));
    end;

end;

/**
 * Класс ИД по 2808-У
 */
class (F118DataSources_2254) F118DataSources_2808(protocolView : RcbCalculateProtocolView)
    initF118DataSources_2254(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F118CapitalDataSource(null, this));
        m_dataSourcePool.push_back(F118LoansDataSource_2808(m_protocolView.getDataProtocolView("Loans"), this));
        m_dataSourcePool.push_back(F118AccountDataSource_2808(m_protocolView.getDataProtocolView("Account"), this));
        m_dataSourcePool.push_back(F118TempTableDataSource(null, this));
        m_dataSourcePool.push_back(F118H6DataSource(m_protocolView.getDataProtocolView("H6"), this));
    end;

end;