/*
$Name:          calc_f251log.mac
$Module:        ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
$Description:    áç¥â ä®à¬ë 251 § ª«îç¨â¥«ì­ë¥ ¤¥©áâ¢¨ï.
*/


/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank V6                                                                        R-Style Softlab
  ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì"

   áç¥â ä®à¬ë 251 § ª«îç¨â¥«ì­ë¥ ¤¥©áâ¢¨ï.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import RsbDataSet, calc_f251;

import RcbProtocolView;

private macro getAccountsCount(accountCount : Integer, accountSum : Money, backOffice : Integer, line : String, column : Integer, isError : Bool) : Integer
    var dataSet = TRsbDataSet("SELECT NVL(SUM(t_doccount), 0) t_accCount, NVL(SUM(t_sumRub), 0) t_sum"
                     + "\n" + "  FROM df251_tmp "
                     + "\n" + " WHERE t_bo        = " + backOffice
                     + "\n" + "   AND t_line   LIKE " + getSqlString(line)
                     + "\n" + "   AND t_column    = " + column
                     + "\n" + "   AND t_errorKind " + ternary(isError, "<>", "=") + " " + ERROR_KIND_NONE);

    if (dataSet.next())
        setParm(0, Int(dataSet.accCount));
        setParm(1, Money(dataSet.sum));
        return;
    end;

    setParm(0,  0);
    setParm(1, $0);
end;

private macro getDocumentsCount(documentsCount : Integer, documentsSum : Money, backOffice : Integer, line : String, column : Integer, isError : Bool) : Integer
    var dataSet = TRsbDataSet("SELECT NVL(SUM(t_doccount), 0) t_docCount, NVL(SUM(t_sumRub), 0) t_sum"
                     + "\n" + "  FROM df251_tmp "
                     + "\n" + " WHERE t_bo        = " + backOffice
                     + "\n" + "   AND t_line   LIKE " + getSqlString(line)
                     + "\n" + "   AND t_column    = " + column
                     + "\n" + "   AND t_errorKind " + ternary(isError, "<>", "=") + " " + ERROR_KIND_NONE);

    if (dataSet.next())
        setParm(0, Int(dataSet.docCount));
        setParm(1, Money(dataSet.sum));
        return;
    end;

    setParm(0,  0);
    setParm(1, $0);
end;

private class (TProtocolView) TProtocol(name)

    initTProtocolView(name);

    private class TAccountsPart(part : Integer)
        private var m_part            = part;
        private var m_shouldPrintHead = false;
        private var m_isHeadPrinted   = false;

        private macro onEmptyReport()
            [¥â ¤ ­­ëå ¤«ï ®âç¥â .];
        end;

        macro isError()
            return false;
        end;

        macro getPart()
            return m_part;
        end;

        macro printHead()
            if ((not m_shouldPrintHead) or m_isHeadPrinted)
                return;
            end;

            m_isHeadPrinted   = true;

            [ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
            [³ íª- ³   ®¬¥à   ³®¬¥à³Š®¤ ¢ «îâë³   ®¬¥à «¨æ¥¢®£® áç¥â   ³  áâ â®ª «¨æ¥¢®£® áç¥â  ³        ‘®ªà é¥­­®¥       ³                    à¨¬¥ç ­¨¥                   ³];
            [³ ä¨á ³   áâà®ª¨  ³£à äë³          ³                         ³                         ³   ­ ¨¬¥­®¢ ­¨¥ ª«¨¥­â    ³                                                 ³];
            [ÃÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        end;

        macro printBottom()
            if (not m_isHeadPrinted)
                onEmptyReport();
                return;
            end;

            [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        end;

        macro printFirstString(dataSet : Object)
            if ((not m_isHeadPrinted) or (not m_shouldPrintHead))
                m_shouldPrintHead = true;
                printHead();
                m_shouldPrintHead = false;
            end;

            [³###### ########### ##### ########## ######################### ######################### ########################## #################################################³]
            (TBackOffice(dataSet.backOffice).getName(),
             dataSet.line,
             dataSet.column,
             dataSet.fiCode,
             dataSet.account,
             dataSet.roubleSum,
             dataSet.clientShortName : w,
             getErrorDescription(dataSet.errorKind) : w);
        end;

        macro printString(dataSet : Object)
            [³###### ########### ##### ########## ######################### ######################### ########################## #################################################³]

            ("",
             "",
             "",
             dataSet.fiCode,
             dataSet.account,
             dataSet.roubleSum,
             dataSet.clientShortName : w,
             getErrorDescription(dataSet.errorKind) : w);
        end;

        macro printItogString(dataSet : Object)
            var accountCount =  0;
            var accountSum   = $0;

            getAccountsCount(accountCount, accountSum, dataSet.backOffice, dataSet.line, dataSet.column, isError());

            [³ˆâ®£® ¯® áâà®ª¥ ############  ª®«¨ç¥áâ¢® áç¥â®¢ ##########     áã¬¬  ##################                                                                             ³]
            (String(dataSet.line + ":"), String(accountCount + ","):r, String(accountSum):r);
            [³                                                                                                                                                                    ³];
        end;

        [ ];
        [ §¤¥« #. ‹¨æ¥¢ë¥ áç¥â .](m_part);
    end;

    private class TDocumentsPart(part : Integer)
        private var m_part            = part;
        private var m_shouldPrintHead = false;
        private var m_isHeadPrinted   = false;

        private macro onEmptyReport()
            [¥â ¤ ­­ëå ¤«ï ®âç¥â .];
        end;

        macro isError()
            return false;
        end;

        macro getPart()
            return m_part;
        end;

        macro printHead()
            if ((not m_shouldPrintHead) or m_isHeadPrinted)
                return;
            end;

            m_isHeadPrinted   = true;

            [ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
            [³ íª- ³   ®¬¥à   ³®¬¥à³     ®¬¥à      ³  „ â     ³       ‘ç¥â ¤¥¡¥â        ³      ‘ç¥â ªà¥¤¨â        ³Š®¤³ ‘ã¬¬  ¢ àã¡«ïå ³ ‘ã¬¬  ¢ ¢ «îâ¥  ³ ˜¨äà ³ ‚¨¤ ®â¯à ¢ª¨  ³                à¨¬¥ç ­¨¥                ³];
            [³ ä¨á ³   áâà®ª¨  ³£à äë³   ¤®ªã¬¥­â     ³¤®ªã¬¥­â  ³                         ³                         ³¢ «³                ³(¢ àã¡. íª¢¨¢ «.)³¤®ª-â ³               ³                                          ³];
            [ÃÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
        end;

        macro printBottom()
            if (not m_isHeadPrinted)
                onEmptyReport();
                return;
            end;

            [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
        end;

        macro printFirstString(dataSet : Object)
            if ((not m_isHeadPrinted) or (not m_shouldPrintHead))
                m_shouldPrintHead = true;
                printHead();
                m_shouldPrintHead = false;
            end;

            [³###### ########### ##### ################ ########## ######################### ######################### ### ################ ################# ###### ############### ##########################################³]
            (nvl(TBackOffice(dataSet.backOffice).getName(),""),
             nvl(dataSet.line,""),
             nvl(dataSet.column,""),
             nvl(dataSet.number,""),
             nvl(dataSet.date : f,""),
             nvl(dataSet.debetAccount,""),
             nvl(dataSet.creditAccount,""),
             nvl(dataSet.fiCode,""),
             nvl(dataSet.roubleSum,""),
             nvl(dataSet.currencySum,""),
             nvl(dataSet.referenceNumber : c,""),
             nvl(dataSet.sendingMode,""),
             nvl(getErrorDescription(dataSet.errorKind) : w,""));
        end;

        macro printItogString(dataSet : Object)
            var documentsCount =  0;
            var documentsSum   = $0;

            getDocumentsCount(documentsCount, documentsSum, dataSet.backOffice, dataSet.line, dataSet.column, isError());

            [³ˆâ®£® ¯® áâà®ª¥ ############            ª®«¨ç¥áâ¢® ¤®ªã¬¥­â®¢ ##########    áã¬¬  ¤®ªã¬¥­â®¢ ##################                                                                                                  ³]
            (String(dataSet.line + ":"), String(documentsCount + ","), String(documentsSum));
            [³                                                                                                                                                                                                                 ³];
        end;

        macro printString(dataSet : Object)
            [³###### ########### ##### ################ ########## ######################### ######################### ### ################ ################# ###### ############### ##########################################³]
            ("",
             "",
             "",
             nvl(dataSet.number,""),
             nvl(dataSet.date : f,""),
             nvl(dataSet.debetAccount,""),
             nvl(dataSet.creditAccount,""),
             nvl(dataSet.fiCode,""),
             nvl(dataSet.roubleSum,""),
             nvl(dataSet.currencySum,""),
             nvl(dataSet.referenceNumber : c,""),
             nvl(dataSet.sendingMode,""),
             nvl(getErrorDescription(dataSet.errorKind) : w,""));
        end;

        [ ];
        [ §¤¥« #. « â¥¦¨.](m_part);
    end;

    private macro printAccountsPart(accountsPart : TAccountsPart)
        var dataSet = TRsbDataSet("SELECT   f251.t_bo            AS t_backOffice,"
                         + "\n" + "         f251.t_line          AS t_line,"
                         + "\n" + "         CASE"
                         + "\n" + "              WHEN f251.t_column = 3"
                         + "\n" + "              THEN '3,5'"
                         + "\n" + "              ELSE '4,6'"
                         + "\n" + "         END  AS t_column,"
                         + "\n" + "         (SELECT t_fi_code"
                         + "\n" + "            FROM dfininstr_dbt"
                         + "\n" + "           WHERE t_fiid = f251.t_fiid) AS t_fiCode,"
                         + "\n" + "         f251.t_account       AS t_account,"
                         + "\n" + "         f251.t_sumRub        AS t_roubleSum,"
                         + "\n" + "         f251.t_errorKind     AS t_errorKind,"
                         + "\n" + "         party.t_shortName    AS t_clientShortName"
                         + "\n" + "    FROM df251_tmp  f251,"
                         + "\n" + "         dparty_dbt party"
                         + "\n" + "   WHERE f251.t_chapter    = " + accountsPart.getPart()
                         + "\n" + "     AND f251.t_errorKind " + ternary(accountsPart.isError(), "<>", " =") + " " + ERROR_KIND_NONE
                         + "\n" + "     AND party.t_partyId   = f251.t_clientCode"
                         + "\n" + "ORDER BY f251.t_bo, f251.t_line, f251.t_fiid, f251.t_account");

        var previousRecord = NULL;

        accountsPart.printHead();

        while (dataSet.next())

            if (    (previousRecord            == NULL)
                 or (previousRecord.backOffice != dataSet.backOffice)
                 or (previousRecord.line       != dataSet.line)
                 or (previousRecord.column     != dataSet.column))
                if (previousRecord != NULL)
                    accountsPart.printItogString(previousRecord);
                end;
                accountsPart.printFirstString(dataSet);
                previousRecord = dataSet.getRecord();
            else
                accountsPart.printString(dataSet);
            end;
        end;

        if (previousRecord != NULL)
            accountsPart.printItogString(previousRecord);
        end;
        accountsPart.printBottom();
    end;

    macro printDocumentsPart(documentsPart : TDocumentsPart)
        var dataSet = TRsbDataSet("SELECT   f251.t_bo            AS t_backOffice,"
                         + "\n" + "         f251.t_line          AS t_line,"
                         + "\n" + "         CASE"
                         + "\n" + "              WHEN f251.t_column = 3"
                         + "\n" + "              THEN '3,5'"
                         + "\n" + "              ELSE '4,6'"
                         + "\n" + "         END  AS t_column,"
                         + "\n" + "         f251.t_numbDocument  AS t_number,"
                         + "\n" + "         f251.t_dateCarry     AS t_date,"
                         + "\n" + "         f251.t_account       AS t_debetAccount,"
                         + "\n" + "         f251.t_accountCredit AS t_creditAccount,"
                         + "\n" + "         (SELECT t_fi_code"
                         + "\n" + "            FROM dfininstr_dbt"
                         + "\n" + "           WHERE t_fiid = f251.t_fiid) AS t_fiCode,"
                         + "\n" + "         DECODE(f251.t_fiid, 0, f251.t_sumRub, 0) AS t_roubleSum,"
                         + "\n" + "         DECODE(f251.t_fiid, 0, 0, f251.t_sumRub) AS t_currencySum,"
                         + "\n" + "         f251.t_shifrDocument AS t_referenceNumber,"
                         + "\n" + "         f251.t_kindA         AS t_sendingMode,"
                         + "\n" + "         f251.t_errorKind     AS t_errorKind"
                         + "\n" + "    FROM df251_tmp  f251"
                         + "\n" + "   WHERE f251.t_chapter    = " + documentsPart.getPart()
                         + "\n" + "     AND f251.t_errorKind " + ternary(documentsPart.isError(), "<>", " =") + " " + ERROR_KIND_NONE
                         + "\n" + "ORDER BY f251.t_bo, f251.t_line, f251.t_fiid, f251.t_dateCarry, f251.t_account, f251.t_sumRub");

        dataSet.setFieldType("t_date",        V_DATE);
        dataSet.setFieldType("t_roubleSum",   V_MONEY);
        dataSet.setFieldType("t_currencySum", V_MONEY);

        var previousRecord = NULL;

        documentsPart.printHead();

        while (dataSet.next())
            if (    (previousRecord            == NULL)
                 or (previousRecord.backOffice != dataSet.backOffice)
                 or (previousRecord.line       != dataSet.line)
                 or (previousRecord.column     != dataSet.column))
                if (previousRecord != NULL)
                    documentsPart.printItogString(previousRecord);
                end;
                documentsPart.printFirstString(dataSet);
                previousRecord = dataSet.getRecord();
            else
                documentsPart.printString(dataSet);
            end;
        end;

        if (previousRecord != NULL)
            documentsPart.printItogString(previousRecord);
        end;

        documentsPart.printBottom();
    end;

    macro printPart1()
        printAccountsPart(TAccountsPart(1));
    end;

    macro printPart2()
        printDocumentsPart(TDocumentsPart(2));
    end;

    macro printPart3()
        printDocumentsPart(TDocumentsPart(3));
    end;

    macro printParts()
        printPart1();
        printPart2();
        printPart3();
    end;
end;

private class (TProtocol) TProtocol_2332(name)
    initTProtocol(name);

    macro printPart4()
        printDocumentsPart(TDocumentsPart(4));
    end;

    macro printParts()
        printPart1();
        printPart2();
        printPart3();
        printPart4();
    end;
end;

private macro printProtocol()

    var protocol;

    if (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
        protocol = TProtocol("’Š‹ €‘—…’€");
    else
        protocol = TProtocol_2332("’Š‹ €‘—…’€");
    end;

    protocol.setProtocolOutput();
    protocol.printHead();
    protocol.printParts();
    protocol.resetProtocolOutput();
end;

ãáâ ­®¢¨âì”« £‚®§¢à â (OK_MACRO_FLAG);
exit(1);
