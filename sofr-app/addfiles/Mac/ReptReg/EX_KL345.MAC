/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank 5.1                                      R-Style Software Lab Ltd
   Файл подсистемы "Отчеты ЦБ"

   Экспорт значений переменных Формы 345 в текстовый файл для программы
   kliko.exe

   CREATED : 21.03.05 Старосельский.

   MODIFICATIONS: 10.08.2006
   NOTES: Добавлены переменные. Добавлен контроль значений. Исправлена выгрузка секции <F345_SPRAV>.

└────────────────────────────────────────────────────────────────────────── */
import reptCBInter, logfile, lib_exp, Chk_regd;

import RcbCoreInter;
import rcbconst;

/*                              Настройка                                   */

CONST ДиректорияПротоколаРаботы = ReturnDirString( "TEXTDIR" );
CONST ИмяПротоколаРаботы        = "ekli_f345.log";

/* ------------------------------------------------------------------------- */
/* FILES */
/* ------------------------------------------------------------------------- */

FILE wrk () TXT write; /* файл экспорта */

/***************************************************************************************/
VAR
    Ф345_40803 = 0,
    Ф345_40813 = 0,
    Ф345_40817 = 0,
    Ф345_40818 = 0,
    Ф345_40819 = 0,
    Ф345_40820 = 0,
    Ф345_423__ = 0,
    Ф345_426__ = 0,
    Ф345_47603 = 0,
    Ф345_47605 = 0,
    Ф345_40806 = 0,
    Ф345_40809 = 0,
    Ф345_40812 = 0,
    Ф345_40814 = 0,
    Ф345_40815 = 0,
    Ф345_522__ = 0,
    Ф345_52404 = 0,
    Ф345_ИТОГО = 0,
    Ф345_S     = 0,
    Ф345_S1  = 0,  
    Ф345_Обяз1 = 0,
    Ф345_S100  = 0,
    Ф345_S200  = 0,
    Ф345_S300  = 0,
    Ф345_Обяз100 = 0,
    Ф345_Обяз200 = 0,
    Ф345_Обяз300 = 0,
    Ф345_Обяз  = 0,
    Ф345_S400    = 0,
    Ф345_S500    = 0,
    Ф345_S700    = 0,
    Ф345_S1000    = 0,
    Ф345_Обяз400 = 0,
    Ф345_Обяз500 = 0,
    Ф345_Обяз700 = 0,
    Ф345_Обяз1000 = 0;

var report = rcbApplication().currentReport;

MACRO nvl( val )

  if (val == NULL)
    return string("\"0\"");
  end;

  return string("\"",val:0:0,"\"");

END;

MACRO ПроверитьПеременные( ДатаПечати )
  var
    res = true;

  if(          ValType(Ф345_40803) == V_UNDEF  ) res = false; end;
  if( res and (ValType(Ф345_40813) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40817) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40818) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40819) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40820) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_423__) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_426__) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_47603) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_47605) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40806) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40809) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40812) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40814) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_40815) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_522__) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_52404) == V_UNDEF) ) res = false; end;
  if( res and (ValType(Ф345_ИТОГО) == V_UNDEF) ) res = false; end;

  if( res == false)
    msgbox("За ", ДатаПечати, " данные отсутствуют.");
    exit(1);
  end;
END;

/* ......................................................................... */
/*                              ENTRY POINT                                  */
/* ......................................................................... */

/* Подготовка к экспорту */

VAR l_filename = substr( string(ДатаОтчета:f), 1, 2 ) +
                 substr( string(ДатаОтчета  ), 4, 2 ) +
                 substr( string(ДатаОтчета  ), 7, 4 ) + ".345";

if( not GetExpFileName( l_filename ) )
   exit(1);
end;

if( not open( wrk, l_filename ) ) 
 msgbox("Невозможно открыть файл экспорта|" + l_filename );
 exit(1);
end;

setoutput( ДиректорияПротоколаРаботы + "\\" + ИмяПротоколаРаботы );
println( date, " ", time, " Протокол экспорта данных Формы 345" );
println( "                    За период с ", ПредДатаОтчета:f, " по ", ДатаОтчета:f );

/* Данные по переменным */
VAR l_str, counter = 0;
VAR ДатаПечати = ПредДатаОтчета;

Message("Ждите. Выполняется экспорт...");

VAR Head = "<F345>";

if( not insert( wrk, Head ) )
 msgbox("Ошибка записи в файл экспорта");
end;

while( ДатаПечати <= ДатаОтчета  )

  ПрочитатьПеременную2( NULL, Ф345_40803, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40803" );//N1
  ПрочитатьПеременную2( NULL, Ф345_40806, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40806" );//N2
  ПрочитатьПеременную2( NULL, Ф345_40809, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40809" );//N3
  ПрочитатьПеременную2( NULL, Ф345_40812, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40812" );//N4
  ПрочитатьПеременную2( NULL, Ф345_40813, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40813" );//N5
  ПрочитатьПеременную2( NULL, Ф345_40814, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40814" );//N6
  ПрочитатьПеременную2( NULL, Ф345_40815, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40815" );//N7
  ПрочитатьПеременную2( NULL, Ф345_40817, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40817" );//N8
  ПрочитатьПеременную2( NULL, Ф345_40818, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40818" );//N8
  ПрочитатьПеременную2( NULL, Ф345_40819, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40819" );//N8
  ПрочитатьПеременную2( NULL, Ф345_40820, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_40820" );//N9
  ПрочитатьПеременную2( NULL, Ф345_423__, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_423__" );//N10
  ПрочитатьПеременную2( NULL, Ф345_426__, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_426__" );//N11
  ПрочитатьПеременную2( NULL, Ф345_47603, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_47603" );//N12
  ПрочитатьПеременную2( NULL, Ф345_47605, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_47605" );//N13
  ПрочитатьПеременную2( NULL, Ф345_522__, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_522__" );//N14
  ПрочитатьПеременную2( NULL, Ф345_52404, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_52404" );//N15
  ПрочитатьПеременную2( NULL, Ф345_ИТОГО, ДатаПечати, ДатаПечати, {Название отчета}, "Ф345_ИТОГО" );//N16   

  ПроверитьПеременные( ДатаПечати );

  l_str=string("\"",ДатаПечати:f,"\",",nvl(Ф345_40803),",",nvl(Ф345_40806),",",nvl(Ф345_40809),",",
                                       nvl(Ф345_40812),",",nvl(Ф345_40813),",",nvl(Ф345_40814),",",
                                       nvl(Ф345_40815),",",nvl(Ф345_40817),",",nvl(Ф345_40818),",",
                                       nvl(Ф345_40819),",",nvl(Ф345_40820),",",nvl(Ф345_423__),",",
                                       nvl(Ф345_426__),",",nvl(Ф345_47603),",",nvl(Ф345_47605),",",
                                       nvl(Ф345_522__),",",nvl(Ф345_52404),",",nvl(Ф345_ИТОГО));

  if( not insert( wrk, l_str ) )
    println( "Ошибка при записи строки " + l_str, TPS_ERROR );
  end;
  message(ДатаПечати);
  counter = counter + 1;
  ДатаПечати = ДатаПечати + 1;

end;

Head = "<F345_SPRAV>";

if( not insert( wrk, Head ) )
 msgbox("Ошибка записи в файл экспорта");
end;

ПрочитатьПеременную2( NULL, Ф345_S1  ,    ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_S1"  );
ПрочитатьПеременную2( NULL, Ф345_S100,    ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_S100");
ПрочитатьПеременную2( NULL, Ф345_S200,    ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_S200" );
ПрочитатьПеременную2( NULL, Ф345_S300,    ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_S300" );
ПрочитатьПеременную2( NULL, Ф345_Обяз1,   ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_Обяз1" );
ПрочитатьПеременную2( NULL, Ф345_Обяз100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_Обяз100" );
ПрочитатьПеременную2( NULL, Ф345_Обяз200, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_Обяз200" );
ПрочитатьПеременную2( NULL, Ф345_Обяз300, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф345_Обяз300" );


if ((ДатаОтчета >= RCB_I1841_DATE1-1) and (ДатаОтчета < RCB_I2121_DATE))       
    Ф345_S500    = report.attributeValue("Ф345_S500").current;    
    Ф345_Обяз500 = report.attributeValue("Ф345_Обяз500").current;
end;

Ф345_S400    = report.attributeValue("Ф345_S400").current;       
Ф345_S700    = report.attributeValue("Ф345_S700").current;       
Ф345_Обяз400 = report.attributeValue("Ф345_Обяз400").current;
Ф345_Обяз700 = report.attributeValue("Ф345_Обяз700").current;

if (ДатаОтчета >= RCB_I2121_DATE)
    Ф345_S1000    = report.attributeValue("Ф345_S1000").current;
    Ф345_Обяз1000 = report.attributeValue("Ф345_Обяз1000").current;    
end;


if (ДатаОтчета < RCB_I1841_DATE1-1)
    l_str=string( nvl(Ф345_S1)+","+ nvl(Ф345_Обяз1)+"\r"+nvl(Ф345_S100)+","+ nvl(Ф345_Обяз100)+"\r"+nvl(Ф345_S200)+","+ nvl(Ф345_Обяз200)+"\r"+nvl(Ф345_S300)+","+ nvl(Ф345_Обяз300));
elif (ДатаОтчета < RCB_I2121_DATE)
    l_str = string(nvl(Ф345_S1)   + "," + nvl(Ф345_Обяз1)   + "\r" + 
                   nvl(Ф345_S100) + "," + nvl(Ф345_Обяз100) + "\r" + 
                   nvl(Ф345_S400) + "," + nvl(Ф345_Обяз400) + "\r" + 
                   nvl(Ф345_S500) + "," + nvl(Ф345_Обяз500) + "\r" + 
                   nvl(Ф345_S700) + "," + nvl(Ф345_Обяз700));
elif (ДатаОтчета >= RCB_I2121_DATE)
    l_str = string(nvl(Ф345_S1)   + "," + nvl(Ф345_Обяз1)   + "\r" + 
                   nvl(Ф345_S100) + "," + nvl(Ф345_Обяз100) + "\r" + 
                   nvl(Ф345_S200) + "," + nvl(Ф345_Обяз200) + "\r" + 
                   nvl(Ф345_S400) + "," + nvl(Ф345_Обяз400) + "\r" + 
                   nvl(Ф345_S700) + "," + nvl(Ф345_Обяз700) + "\r" + 
                   nvl(Ф345_S1000) + "," + nvl(Ф345_Обяз1000));
end;

if( not insert( wrk, l_str ) )
  println( "Ошибка при записи строк:\n" + l_str, TPS_ERROR );
end;

/* Завершение экспорта */
close( wrk );
println( "                    Файл: ", l_filename );
println( date, " ", time, " Выгружено записей: ", counter + 3 );
println( date, " ", time, " Окончание экспорта данных Формы 345." );

/* EoF */
