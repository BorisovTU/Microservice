/*
  Макрос устанавливает активный период действия переменных для формы 301.
*/

import reptCbInter;
import chk_regd;
import rcbconst;

import RcbCoreInter; /*//25 May 07 Fri 10:17:59 Malakhova Irina 103934*/

private const FORM_NAME  = "Форма 301";
private const BEGIN_DATE = date(1,4,2006);/*дата начала действия переменных*/

macro changeValidDate1747(varName)
    var varNameBefore1747 = varName + "_До_1747_У";
    var varNameAfter1747  = varName + "_После_1747_У";

    ChangeVarActivPeriod(FORM_NAME,varNameBefore1747, BEGIN_DATE, (RCB_I1747_DATE-2));
    ChangeVarActivPeriod(FORM_NAME,varNameAfter1747 , (RCB_I1747_DATE-1), date(31,12,9999));
end;

macro changeValidDate1803(varName)
    var varNameBefore1803 = varName + "_До_1803_У";
    var varNameAfter1803  = varName + "_После_1803_У";

    ChangeVarActivPeriod(FORM_NAME,varNameBefore1803, BEGIN_DATE, (RCB_I1803_DATE-2));
    ChangeVarActivPeriod(FORM_NAME,varNameAfter1803 , (RCB_I1803_DATE - 1), date(31,12,9999));
end;

macro changeValidDate1803Itog()
    ChangeVarActivPeriod(FORM_NAME,"СС_ИТОГО_Гр20_После_1747_У",  (RCB_I1747_DATE-1), (RCB_I1803_DATE-2));
    ChangeVarActivPeriod(FORM_NAME,"СС_ИТОГО_Гр20_После_1803_У" , (RCB_I1803_DATE-1), date(31,12,9999));
end;

macro changeValidDate1841(varName)
    var varNameBefore1841 = varName + "_До_1841_У";
    var varNameAfter1841  = varName + "_После_1841_У";

    ChangeVarActivPeriod(FORM_NAME,varNameBefore1841, BEGIN_DATE, (RCB_I1841_DATE1-2));
    ChangeVarActivPeriod(FORM_NAME,varNameAfter1841,  (RCB_I1841_DATE1-1), date(31,12,9999));
end;

macro changeValidDate1841Itog()
    ChangeVarActivPeriod(FORM_NAME,"СС_ИТОГО_Гр20_После_1803_У", (RCB_I1803_DATE-1), (RCB_I1841_DATE1-2));
    ChangeVarActivPeriod(FORM_NAME,"СС_ИТОГО_Гр20_После_1841_У" , (RCB_I1841_DATE1-1), date(31,12,9999));
end;

macro changeValidDate1881(varName)
    var varNameBefore1881 = varName + "_До_1881_У";
    var varNameAfter1881  = varName + "_После_1881_У";

    ChangeVarActivPeriod(FORM_NAME,varNameBefore1881, BEGIN_DATE, (RCB_I1881_DATE-1));
    ChangeVarActivPeriod(FORM_NAME,varNameAfter1881,  RCB_I1881_DATE, date(31,12,9999));
end;

macro changeValidDate1803_1881(varName)
    var varNameAfter1803 = varName + "_После_1803_У";
    var varNameAfter1881 = varName + "_После_1881_У";

    ChangeVarActivPeriod(FORM_NAME, varNameAfter1803, RCB_I1803_DATE, (RCB_I1881_DATE-1));
    ChangeVarActivPeriod(FORM_NAME, varNameAfter1881, RCB_I1881_DATE, date(31,12,9999));
end;

macro changeValidDate1841_1881(varName)
    var varNameAfter1841 = varName + "_После_1841_У";
    var varNameAfter1881 = varName + "_После_1881_У";

    ChangeVarActivPeriod(FORM_NAME, varNameAfter1841, (RCB_I1841_DATE1-1), (RCB_I1881_DATE-1));
    ChangeVarActivPeriod(FORM_NAME, varNameAfter1881, RCB_I1881_DATE, date(31,12,9999));
end;

/*//25 May 07 Fri 10:15:34 Malakhova Irina 103934*/
/*Добавила функцию проверки, рассчитан ли баланс*/
macro isBalanceCalculated()

    var stat;

    var report = RcbApplication().currentReport;

    var BalReport = RcbApplication().objectFactory.CreateReport("Балансовые счета", 
                                                                 RcbReportContext(RcbPeriod(report.context.period.beginDate, report.context.period.endDate), 
                                                                                  report.context.departmentCode,
                                                                                  report.context.issueMode,
                                                                                  report.context.organizationStructure,
                                                                                  report.context.isSummaryMode
                                                                                  )
                                                                );

     if (not BalReport.isCalculated )
         msgbox("Для выпуска отчета необходима рассчитанная форма \"Балансовые счета\". " +
                "Рассчитайте форму \"Балансовые счета\" за период с " +
                string(report.context.period.beginDate:f) + " по " +  
                string(report.context.period.endDate:f)
               );
         stat = FALSE;              
     else
         stat = TRUE;
     end;   

     return stat;
end;

macro main()
    if (not isBalanceCalculated())
       exit(1); 
    end;

    changeValidDate1747("Тр_До____Гр13");
    changeValidDate1747("Тр_До____Гр17");
    changeValidDate1747("Тр_Свыше_Гр13");
    changeValidDate1747("Тр_Свыше_Гр17");
    changeValidDate1747("СС_ИТОГО_Гр20");

    changeValidDate1803("Тр_До____Гр10");
    changeValidDate1803("Тр_До____Гр14");
    changeValidDate1803("Тр_До____Гр11");
    changeValidDate1803("Тр_До____Гр15");
    changeValidDate1803("Тр_До____Гр12");
    changeValidDate1803("Тр_До____Гр16");
    changeValidDate1803Itog();

    changeValidDate1841("ИА_До____Гр18");
    changeValidDate1841("ИП_До____Гр19");
    changeValidDate1841Itog();

    changeValidDate1881("Об_Срочн_Гр3_");
    changeValidDate1881("Об_Срочн_Гр5_");
    changeValidDate1881("ИА_Свыше_Гр18");
    changeValidDate1803_1881("Тр_До____Гр10");
    changeValidDate1803_1881("Тр_До____Гр14");
    changeValidDate1841_1881("ИП_До____Гр19");
    changeValidDate1841_1881("СС_ИТОГО_Гр20");
end;

main();
УстановитьФлагВозврата( OK_MACRO_FLAG);
exit(1); 
