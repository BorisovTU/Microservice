import RcbClassLibInter;
import rcbCoreInter;
import cb_sql;
import lib_lang;
import ReportNormalizer;
import ReportLinearRelation;
import controlExcludedAccounts;
import RcbProtocolView;
import testLib;
import RcbClassLibInter;

/**
 * Настройки!!!
 */

private const NORMALIZE_ROUBLE_TOTAL = true;

private const NORMALIZE_CURRENCY_TOTAL = true;

private const NORMALIZE_IN_REST = true;

private const PRINT_ERROR_PROTOCOL = true;

private const PRINT_CONSTRAINT_PROTOCOL = false;
/*******************************************************
 *Использeтся для перехода с алгоритма "В тысячах СМ"  *
 *в обычном режиме должна быть равна NULL              *
 ******************************************************/
private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER : DOUBLE = null;

if (    (rcbApplication.currentReport.createPreviousReport().normalizationAlgorithm != RCB_NA_MMB)
    and (rcbApplication.currentReport.createPreviousReport().isCalculated()))
    ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER = 5.0;
end;

/******************************************************/

private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_1;
private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_2;
private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_3;
private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_4;
private var ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_5;

private var ACCOUNT_PERMISSIBLE_DESICIONS;
private var MAX_TIME_OF_DESICIONS;

private var PRECISION;
private var ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;

private var IS_ENABLE_ROUNDING_ERROR_CONTROL;

private var IS_SHOW_BALANCE_PROTOCOL;
private var ErrCode;

getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ВКЛЮЧИТЬ КОНТРОЛЬ ПОГРЕШНОСТИ", V_BOOL, IS_ENABLE_ROUNDING_ERROR_CONTROL, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ПОГРЕШНОСТЬ ОКРУГЛЕНИЯ ОБОРОТОВ/ГЛАВА 1", V_DOUBLE,  ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_1, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ПОГРЕШНОСТЬ ОКРУГЛЕНИЯ ОБОРОТОВ/ГЛАВА 2", V_DOUBLE,  ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_2, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ПОГРЕШНОСТЬ ОКРУГЛЕНИЯ ОБОРОТОВ/ГЛАВА 3", V_DOUBLE,  ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_3, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ПОГРЕШНОСТЬ ОКРУГЛЕНИЯ ОБОРОТОВ/ГЛАВА 4", V_DOUBLE,  ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_4, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ПОГРЕШНОСТЬ ОКРУГЛЕНИЯ ОБОРОТОВ/ГЛАВА 5", V_DOUBLE,  ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_5, null);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/ОПТИМАЛЬНОСТЬ РЕШЕНИЯ",                   V_DOUBLE,  ACCOUNT_PERMISSIBLE_DESICIONS,          null);
ACCOUNT_PERMISSIBLE_DESICIONS = int(ACCOUNT_PERMISSIBLE_DESICIONS * 1000);
getRegistryValue("REPORT/FLOOR/НАСТРОЙКА ММБ/МАКСИМАЛЬНОЕ ВРЕМЯ РЕШЕНИЯ",              V_INTEGER, MAX_TIME_OF_DESICIONS,                  null);

getRegistryValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/ТОЧНОСТЬ ДЛЯ ГЛАВЫ Д", V_INTEGER,  PRECISION, null);
ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5 = int("1" + mkstr( "0", PRECISION));

getRegistryValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/ПЕЧАТЬ ПРОТОКОЛА НОРМАЛИЗАЦИИ", V_BOOL, IS_SHOW_BALANCE_PROTOCOL,ErrCode);

if(ErrCode != 0)
   IS_SHOW_BALANCE_PROTOCOL = true;
end;

/**
 * Протокол.
 */
private class (TProtocolView) TBalanceProtocolView(description : String)
    private var m_table = CTableReport();

    initTProtocolView(description);

    macro constructor()
        m_table.addColumn("Имя переменной");
        m_table.addColumn("Точное значение|в нац. валюте", 25);
        m_table.addColumn("Округленное значение|в тысячах");
        m_table.addColumn("Нормализованное значение|в тысячах");
        m_table.addColumn("Погрешность|в тысячах");
        m_table.addColumn("Предупреждение");
    end;

    macro printDescription()
        setProtocolOutput();
        printHead();
        resetProtocolOutput();
    end;

    macro printHeadTable(chapter : String)
        setProtocolOutput(true);
        m_table.printHead();
        resetProtocolOutput();
    end;

    macro printString(variableName, exactValue, oldValue, newValue, def, warning)
        setProtocolOutput(true);
        m_table.printStringTransferByWord(variableName, exactValue, oldValue, newValue, def, warning);
        resetProtocolOutput();
    end;

    macro printStringExt(str : String)
        setProtocolOutput(true);
        m_table.printStringExt(str, m_table.getAColumns().size);
        resetProtocolOutput();
    end;

    macro printSeparator(isTop : Bool)
        setProtocolOutput(true);
        m_table.printSeparatorExt(true, isTop, m_table.getAColumns().size);
        resetProtocolOutput();
    end;

    macro printBottomTable()
        setProtocolOutput(true);
        m_table.printBottom();
        resetProtocolOutput();
    end;

    macro printLine(str)
        setProtocolOutput(true);
        printLine(str);
        resetProtocolOutput();
    end;

    constructor();
end;

private class TColumnKind
    const ACTIVE_IN_REST   : String = "ActiveInRest";
    const PASSIVE_IN_REST  : String = "PassiveInRest";

    const DEBET            : String = "Debet";
    const CREDIT           : String = "Credit";

    const ACTIVE_DEBET     : String = "ActiveDebet";
    const ACTIVE_CREDIT    : String = "ActiveCredit";

    const PASSIVE_DEBET    : String = "PassiveDebet";
    const PASSIVE_CREDIT   : String = "PassiveCredit";

    const ACTIVE_OUT_REST  : String = "ActiveOutRest";
    const PASSIVE_OUT_REST : String = "PassiveOutRest";
end;

private class TRowKind
    const TOTAL    : String = "Total";
    const ROUBLE   : String = "Rouble";
    const CURRENCY : String = "Currency";
end;


private class TChapter(chapter : Integer)

    private var m_chapter = chapter;

    const COLUMN_KIND = TColumnKind();

    const ROW_KIND = TRowKind();

    macro getName() : String
        return "Chapter_" + m_chapter;
    end;

    macro getChapter() : Integer
        return m_chapter;
    end;

    macro isTerminalBalance(balanceNumber : String) : Bool
        if (balanceNumber == getName())
            return false;
        end;

        return true;
    end;

    macro getTopBalance(balanceNumber : String)

        if (balanceNumber == getName())
            return "Root";
        end;

        if ((strLen(balanceNumber) == 5)and(balanceNumber != "99998")and(balanceNumber != "99999"))
            return substr(balanceNumber, 1, 3);
        end;

        return getName();
    end;

end;

private class BalanceValue()
    private const ROW_KIND = TRowKind();

    private var m_rouble = 0.0;
    private var m_currency = 0.0;
    private var m_total = 0.0;

    macro plus(rowKind : String, value : Variant)
        if (rowKind == ROW_KIND.TOTAL)
            m_total = m_total + value;
        elif (rowKind == ROW_KIND.ROUBLE)
            m_rouble = m_rouble + value;
        elif (rowKind == ROW_KIND.CURRENCY)
            m_currency = m_currency + value;
        end;
        return this;
    end;

    macro get(rowKind : String)
        if (rowKind == ROW_KIND.TOTAL)
            return m_total;
        elif (rowKind == ROW_KIND.ROUBLE)
            return m_rouble;
        elif (rowKind == ROW_KIND.CURRENCY)
            return m_currency;
        end;
    end;
end;

private class (ReportNormalizer) TBalanceChapterNormalizer(multipliyer : Double, chapter : Integer, isCalculateInRest : Bool)
    initReportNormalizer(multipliyer);
    var count = 0;

    private var m_chapterActiveInRestValue = BalanceValue();
    private var m_chapterPassiveInRestValue = BalanceValue();
    private var m_activeBalanceSet = TRcbSet();
    private var m_passiveBalanceSet = TRcbSet();



    private const COLUMN_KIND = TColumnKind();

    private const ROW_KIND = TRowKind();

    private var  m_report : RcbReport = rcbApplication.currentReport();

    private var m_previousReport = m_report.createPreviousReport();

    /**
     * Считать входящие остатки
     */
     var m_isCalculateInRest = isCalculateInRest;

    /**
     * Глава по каторой мы производим нормализацию.
     */
    private var m_chapter : TChapter = TChapter(chapter);

    /**
     * Последнее значенее группы для входящих остатков. Данная переменная необходима для задания групп балансовых счетов второго порядка.
     */
    private var m_lastGroupForInPutNodes = 3;
    /**
     * Последнее значенее группы для активных исходящих остатков и оборотов. Данная переменная необходима для задания групп балансовых счетов второго порядка.
     */
    private var m_lastGroupForOtherActiveNodes = 203;
    /**
     * Последнее значенее группы для пассивных исходящих остатков и оборотов. Данная переменная необходима для задания групп балансовых счетов второго порядка.
     */
    private var m_lastGroupForOtherPassiveNodes = 204;
    /**
     * Последнее значенее балансового счета первого порядка. Данная переменная необходима для задания групп балансовых счетов второго порядка.
     */
    private var m_lastFistBalance = "";
    /**
     * Дополнительнst условие для счетов 99998 и 99999 главы 3
     */
    private var m_relationFor99998InputTotal;
    /*private var m_relationFor99998InputCurrency;
    private var m_relationFor99998InputRouble;*/

    private var m_relationFor99999InputTotal;
    /*private var m_relationFor99999InputCurrency;
    private var m_relationFor99999InputRouble;*/

    private var m_relationFor99998OutputTotal;
    /*private var m_relationFor99998OutputCurrency;
    private var m_relationFor99998OutputRouble;*/

    private var m_relationFor99999OutputTotal;
    /*private var m_relationFor99999OutputCurrency;
    private var m_relationFor99999OutputRouble;*/

    private macro initRelationsForAccounts99998And99999(chapter : Integer)
        if (chapter == 3)
            m_relationFor99998InputTotal     = ReportLinearRelation(RCB_RS_EQUAL);
            /*m_relationFor99998InputCurrency  = ReportLinearRelation(RCB_RS_EQUAL);
            m_relationFor99998InputRouble    = ReportLinearRelation(RCB_RS_EQUAL);*/

            m_relationFor99999InputTotal     = ReportLinearRelation(RCB_RS_EQUAL);
            /*m_relationFor99999InputCurrency  = ReportLinearRelation(RCB_RS_EQUAL);
            m_relationFor99999InputRouble    = ReportLinearRelation(RCB_RS_EQUAL);*/

            m_relationFor99998OutputTotal    = ReportLinearRelation(RCB_RS_EQUAL);
            /*m_relationFor99998OutputCurrency = ReportLinearRelation(RCB_RS_EQUAL);
            m_relationFor99998OutputRouble   = ReportLinearRelation(RCB_RS_EQUAL);*/

            m_relationFor99999OutputTotal    = ReportLinearRelation(RCB_RS_EQUAL);
            /*m_relationFor99999OutputCurrency = ReportLinearRelation(RCB_RS_EQUAL);
            m_relationFor99999OutputRouble   = ReportLinearRelation(RCB_RS_EQUAL);*/
        end;
    end;

    macro addRelationsForLoroAccounts()
        this.addRelation(m_relationFor99998InputTotal);
        //this.addRelation(m_relationFor99998InputCurrency);
        //this.addRelation(m_relationFor99998InputRouble);

        this.addRelation(m_relationFor99999InputTotal);
        //this.addRelation(m_relationFor99999InputCurrency);
        //this.addRelation(m_relationFor99999InputRouble);

        this.addRelation(m_relationFor99998OutputTotal);
        //this.addRelation(m_relationFor99998OutputCurrency);
        //this.addRelation(m_relationFor99998OutputRouble);

        this.addRelation(m_relationFor99999OutputTotal);
        //this.addRelation(m_relationFor99999OutputCurrency);
        //this.addRelation(m_relationFor99999OutputRouble);
    end;

    macro getVariableName(balanceNumber : String, columnKind : String, rowKind : String) : String

        var name = "Бн" + balanceNumber;

        if (rowKind == ROW_KIND.ROUBLE)
            name = name + "Ру";
        elif (rowKind == ROW_KIND.CURRENCY)
            name = name + "По";
        elif (rowKind == ROW_KIND.TOTAL)
            name = name + "__";
        end;

        if ((columnKind == COLUMN_KIND.ACTIVE_IN_REST) or (columnKind == COLUMN_KIND.ACTIVE_OUT_REST))
            name = name + "А";
        elif ((columnKind == COLUMN_KIND.PASSIVE_IN_REST) or (columnKind == COLUMN_KIND.PASSIVE_OUT_REST))
            name = name + "П";
        elif (columnKind == COLUMN_KIND.DEBET)
            name = name + "Д";
        elif (columnKind == COLUMN_KIND.CREDIT)
            name = name + "К";
        end;

        return name;
    end;

    macro getValue(balanceNumber : String, columnKind : String, rowKind : String, chapter : Integer) : Money

        var av;

        if (columnKind == COLUMN_KIND.ACTIVE_IN_REST)
            if (m_previousReport.isCalculated())
                av = m_previousReport.attributeValue(getVariableName(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, rowKind));

                if ((av == null) or (av.exact == null))
                    return $0.0;
                end;

                if(chapter == 5)
                    return av.exact * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
                else
                    return av.exact;
                end;

            else
                return getValue(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, rowKind, chapter)
                     - getValue(balanceNumber, COLUMN_KIND.DEBET, rowKind, chapter)
                     + getValue(balanceNumber, COLUMN_KIND.CREDIT, rowKind, chapter);
            end;
        end;

        if (columnKind == COLUMN_KIND.PASSIVE_IN_REST)
            if (m_previousReport.isCalculated())
                av = m_previousReport.attributeValue(getVariableName(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, rowKind));

                if ((av == null) or (av.exact == null))
                       return $0.0;
                end;

                if(chapter == 5)
                    return av.exact * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
                else
                    return av.exact;
                end;
            else
                return getValue(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, rowKind, chapter)
                     + getValue(balanceNumber, COLUMN_KIND.DEBET, rowKind, chapter)
                     - getValue(balanceNumber, COLUMN_KIND.CREDIT, rowKind, chapter);
            end;
        end;

        var name;
        if ((columnKind == COLUMN_KIND.ACTIVE_DEBET) or (columnKind == COLUMN_KIND.PASSIVE_DEBET))
            name = getVariableName(balanceNumber, COLUMN_KIND.DEBET, rowKind);
        elif ((columnKind == COLUMN_KIND.ACTIVE_CREDIT) or (columnKind == COLUMN_KIND.PASSIVE_CREDIT))
            name = getVariableName(balanceNumber, COLUMN_KIND.CREDIT, rowKind);
        else
            name = getVariableName(balanceNumber, columnKind, rowKind);
        end;

        av = m_report.attributeValue(name);

        if ((av == null) or (av.exact == null))
            return $0.0;
        end;

        if(chapter == 5)
            return av.exact * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
        else
            return av.exact;
        end;
    end;

    macro getScaledValue(balanceNumber : String, columnKind : String, rowKind : String, chapter : Integer) : Double

        var av;

        if (columnKind == COLUMN_KIND.ACTIVE_IN_REST)
            if (m_previousReport.isCalculated())
                av = m_previousReport.attributeValue(getVariableName(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, rowKind));

                if ((av == null) or (av.exact == null))
                       return $0.0;
                end;

                if(chapter == 5)
                    return av.scaled * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
                else
                    return av.scaled;
                end;

            else
                return getScaledValue(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, rowKind, chapter)
                     - getScaledValue(balanceNumber, COLUMN_KIND.DEBET, rowKind, chapter)
                     + getScaledValue(balanceNumber, COLUMN_KIND.CREDIT, rowKind, chapter);
            end;
        end;

        if (columnKind == COLUMN_KIND.PASSIVE_IN_REST)
            if (m_previousReport.isCalculated())
                av = m_previousReport.attributeValue(getVariableName(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, rowKind));

                if ((av == null) or (av.exact == null))
                       return $0.0;
                end;

                if(chapter == 5)
                    return av.scaled * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
                else
                    return av.scaled;
                end;
            else
                return getScaledValue(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, rowKind, chapter)
                     + getScaledValue(balanceNumber, COLUMN_KIND.DEBET, rowKind, chapter)
                     - getScaledValue(balanceNumber, COLUMN_KIND.CREDIT, rowKind, chapter);
            end;
        end;


        var name;
        if ((columnKind == COLUMN_KIND.ACTIVE_DEBET) or (columnKind == COLUMN_KIND.PASSIVE_DEBET))
            name = getVariableName(balanceNumber, COLUMN_KIND.DEBET, rowKind);
        elif ((columnKind == COLUMN_KIND.ACTIVE_CREDIT) or (columnKind == COLUMN_KIND.PASSIVE_CREDIT))
            name = getVariableName(balanceNumber, COLUMN_KIND.CREDIT, rowKind);
        else
            name = getVariableName(balanceNumber, columnKind, rowKind);
        end;

        av = m_report.attributeValue(name);

        if ((av == null) or (av.exact == null))
            return 0.0;
        end;

        if(chapter == 5)
            return av.scaled * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
        else
            return av.scaled;
        end;
    end;

    private macro getNodeName(balanceNumber : String, columnKind : String, rowKind : String)
        return balanceNumber + columnKind + rowKind;
    end;

    /**
     * Возвращает верхний логический узел, для заданного узла.
     */
    private macro getTopNode(balanceNumber : String, columnKind : String, rowKind : String)
        if (   (balanceNumber == m_chapter.getName())
            or (columnKind == m_chapter.COLUMN_KIND.DEBET)
            or (columnKind == m_chapter.COLUMN_KIND.CREDIT))
            return this;
        end;

        if (m_chapter.getChapter() == 5)
            return this.node(getNodeName(m_chapter.getName(), columnKind, rowKind));
        else
            return this.node(getNodeName(m_chapter.getTopBalance(balanceNumber), columnKind, rowKind));
        end;


    end;

    /**
     * Возвращает верхний уровень нормализации, для заданного узла.
     */
    private macro addTopNode(balanceNumber : String, columnKind : String, rowKind : String)
        if (   (balanceNumber == m_chapter.getName())
            or (columnKind == m_chapter.COLUMN_KIND.DEBET)
            or (columnKind == m_chapter.COLUMN_KIND.CREDIT))
            return this;
        end;

        //Метод addNode не добавляет новый узел, если он уже содержится в нормализаторе.

        if (m_chapter.getChapter() == 5)
            return this.addNode(getNodeName(m_chapter.getName(), columnKind, rowKind));
        else
            return this.addNode(getNodeName(m_chapter.getTopBalance(balanceNumber), columnKind, rowKind));
        end;
    end;

    macro getChapter()
        return m_chapter;
    end;

    macro getNode(balanceNumber : String, columnKind : String, rowKind : String) : Variant
        //Если предыдущий период рассчитан, то возвращаем константное значение входящего остатка умноженное на множитель
        if (not m_isCalculateInRest)
            if ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST))
                var scaledValue = getScaledValue(balanceNumber, columnKind, rowKind, m_chapter.getChapter());
                var valueId = balanceNumber + rowKind;

                if (strLen(balanceNumber) == 5)
                    if (columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST)

                        if (not m_activeBalanceSet.find(valueId).isValid())
                            m_chapterActiveInRestValue.plus(rowKind, scaledValue);
                        end;
                        m_activeBalanceSet.insert(valueId);
                    elif (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST)

                        if (not m_passiveBalanceSet.find(valueId).isValid())
                            m_chapterPassiveInRestValue.plus(rowKind, scaledValue);
                        end;

                        m_passiveBalanceSet.insert(valueId);
                    end;
                elif (balanceNumber == m_chapter.getName())
                    if (columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST)
                        return m_chapterActiveInRestValue.get(rowKind);
                    elif (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST)
                        return m_chapterPassiveInRestValue.get(rowKind);
                    end;
                    return;
                end;

                return scaledValue;
            end;
        end;

        var topNode = addTopNode(balanceNumber, columnKind, rowKind);

        var node = topNode.addNode(getNodeName(balanceNumber, columnKind, rowKind));

        return node;
    end;

    macro returnNode(balanceNumber : String, columnKind : String, rowKind : String)
        return this.node(getNodeName(balanceNumber, columnKind, rowKind));
    end;

    macro setNodeGroupAndPriority(balanceNumber : String, currentRecord, columnKind : String, rowKind : String)
        count = count + 1;
        var node = this.node(getNodeName(balanceNumber, columnKind, rowKind));

        var group;
        if (balanceNumber == m_chapter.getName())
            if ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST))

                if (m_isCalculateInRest)
                    node.setGroup(0);
                    group = this.getGroup(0);

                    if(rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(100.0);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(50.0);
                    else
                        node.setUserPriority(0.0);
                    end;
                end;
            elif ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_OUT_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_OUT_REST))
                if(rowKind == m_chapter.ROW_KIND.TOTAL)
                    node.setGroup(200);
                elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                    node.setGroup(201);
                    node.setUserPriority(100.0);
                    group = this.getGroup(201);
                    group.setIsAdditionalCheck(true);
                else
                    node.setGroup(201);
                    node.setUserPriority(0.0);
                end;
            else
                if ((not m_isCalculateInRest) and (ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER != null))
                    node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER);
                end;
                node.setGroup(202);
                group = this.getGroup(202);
                if (m_chapter.getChapter() == 1)
                    group.setIsSeparateOnSubgroups(true);
                    group.setIsOptimalDecision(false);
                    group.setMaxNumberOfDecision(ACCOUNT_PERMISSIBLE_DESICIONS);
                end;
                group.setIsAdditionalCheck(true);

                if (rowKind == m_chapter.ROW_KIND.TOTAL)
                    node.setUserPriority(100.0);
                elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                    node.setUserPriority(50.0);
                else
                    node.setUserPriority(0.0);
                end;
            end;

        elif ((strLen(balanceNumber) == 3)or(balanceNumber == "99998")or(balanceNumber == "99999") or (m_chapter.getChapter() == 5))
            if (columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST)
                node.setGroup(1);

                group = this.getGroup(1);

                if (m_isCalculateInRest)
                    group.setIsOptimalDecision(false);
                    group.setMaxNumberOfDecision(ACCOUNT_PERMISSIBLE_DESICIONS);

                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(currentRecord.k);
                    else
                        node.setUserPriority(currentRecord.k);
                    end;
                end;
            elif (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST)
                node.setGroup(2);

                group = this.getGroup(2);

                if (m_isCalculateInRest)
                    group.setIsOptimalDecision(false);
                    group.setMaxNumberOfDecision(ACCOUNT_PERMISSIBLE_DESICIONS);

                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(currentRecord.k);
                    else
                        node.setUserPriority(currentRecord.k);
                    end;
                end;
            else
                node.setGroup(202);

                if ((columnKind == m_chapter.COLUMN_KIND.PASSIVE_OUT_REST)or(columnKind == m_chapter.COLUMN_KIND.ACTIVE_OUT_REST))
                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        if(currentRecord.isTotalExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        if(currentRecord.isRoubleExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    else
                        if(currentRecord.isCurrencyExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    end;
                else
                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(currentRecord.k);
                    else
                        node.setUserPriority(currentRecord.k);
                    end;
                end;
            end;
        else
            if ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_IN_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_IN_REST))

                if (m_lastFistBalance == "")
                    m_lastFistBalance = subStr(balanceNumber, 1, 3);
                elif (subStr(balanceNumber, 1, 3) != m_lastFistBalance)
                    m_lastFistBalance = subStr(balanceNumber, 1, 3);
                    m_lastGroupForInPutNodes = m_lastGroupForInPutNodes + 1;
                    m_lastGroupForOtherActiveNodes = m_lastGroupForOtherActiveNodes + 2;
                    m_lastGroupForOtherPassiveNodes = m_lastGroupForOtherPassiveNodes + 2;
                end;

                node.setGroup(m_lastGroupForInPutNodes);

                group = this.getGroup(m_lastGroupForInPutNodes);

                if (m_isCalculateInRest)
                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(currentRecord.k);
                    else
                        node.setUserPriority(currentRecord.k);
                    end;
                end;
            else
                if (m_lastFistBalance == "")
                    m_lastFistBalance = subStr(balanceNumber, 1, 3);
                elif (subStr(balanceNumber, 1, 3) != m_lastFistBalance)
                    m_lastFistBalance = subStr(balanceNumber, 1, 3);
                    m_lastGroupForInPutNodes = m_lastGroupForInPutNodes + 1;
                    m_lastGroupForOtherActiveNodes = m_lastGroupForOtherActiveNodes + 2;
                    m_lastGroupForOtherPassiveNodes = m_lastGroupForOtherPassiveNodes + 2;
                end;

                if (    (columnKind == m_chapter.COLUMN_KIND.ACTIVE_DEBET) or (columnKind == m_chapter.COLUMN_KIND.ACTIVE_CREDIT)
                     or  (columnKind == m_chapter.COLUMN_KIND.ACTIVE_OUT_REST))
                    node.setGroup(m_lastGroupForOtherActiveNodes);
                else
                    node.setGroup(m_lastGroupForOtherPassiveNodes);
                end;

                if ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_OUT_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_OUT_REST))
                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        if(currentRecord.isTotalExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        if(currentRecord.isRoubleExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    else
                        if(currentRecord.isCurrencyExcluded == 1)
                            node.setDef(0.5);
                        end;
                        node.setUserPriority(currentRecord.k);
                    end;
                else
                    if (rowKind == m_chapter.ROW_KIND.TOTAL)
                        node.setUserPriority(currentRecord.k);
                    elif (rowKind == m_chapter.ROW_KIND.ROUBLE)
                        node.setUserPriority(currentRecord.k);
                    else
                        node.setUserPriority(currentRecord.k);
                    end;
                end;
            end;
        end;

        if ((node != null) and (node.exact == 0.0) and (node.getDef() > 1.0))
            node.setDef(1.0);
        end;
    end;


    macro setNodeValue(currentRecord, columnKind : String, rowKind : String, exactValue : Money, scaledValue : Double)
        var node = getNode(currentRecord.balance, columnKind, rowKind);
/*!!!*/
        if ((strLen(currentRecord.balance) == 3)and((columnKind == m_chapter.COLUMN_KIND.ACTIVE_OUT_REST) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_OUT_REST)))
            node.setDef(2.0);
        end;

        if ((    (columnKind == m_chapter.COLUMN_KIND.ACTIVE_DEBET) or (columnKind == m_chapter.COLUMN_KIND.ACTIVE_CREDIT)
              or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_DEBET) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_CREDIT)
              or (columnKind == m_chapter.COLUMN_KIND.DEBET) or (columnKind == m_chapter.COLUMN_KIND.CREDIT)))
            if(m_chapter.getChapter() == 1)
                node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_1);
            elif(m_chapter.getChapter() == 2)
                node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_2);
            elif(m_chapter.getChapter() == 3)
                node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_3);
            elif(m_chapter.getChapter() == 4)
                node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_4);
            elif(m_chapter.getChapter() == 5)
                node.setDef(ERROR_OF_DEDET_OR_CREDIT_FOR_CHAPTER_5);
            end;
        end;

        var value : Double = nvl(exactValue, 0.0);

        node.setExact(value);

        var topNode;
        var chapterNode;

        if (   (columnKind == m_chapter.COLUMN_KIND.DEBET)
            or (columnKind == m_chapter.COLUMN_KIND.CREDIT))
            if (scaledValue == null)
                node.recalculateScaled();
            else
                node.setScaled(int(scaledValue));
            end;
        else
            if ((strLen(currentRecord.balance) == 3)or(currentRecord.balance == "99998")or(currentRecord.balance == "99999") or (m_chapter.getChapter() == 5))

                topNode = getTopNode(currentRecord.balance, columnKind, rowKind);
                topNode.setExact(topNode.getExact() + Double(value));

                if (scaledValue == null)
                    node.recalculateScaled();
                    topNode.recalculateScaled();
                else
                    node.setScaled(int(scaledValue));
                    topNode.setScaled(topNode.getScaled() + int(scaledValue));
                end;
            else
                node.recalculateScaled();

                if ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_DEBET)  or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_DEBET))
                    node.recalculateScaled();
                    topNode = this.node(getNodeName(subStr(currentRecord.balance, 1, 3), m_chapter.COLUMN_KIND.DEBET, rowKind));
                    if (topNode != null)
                        topNode.setExact(topNode.getExact() + Double(value));
                        topNode.recalculateScaled();
                    end;
                elif ((columnKind == m_chapter.COLUMN_KIND.ACTIVE_CREDIT) or (columnKind == m_chapter.COLUMN_KIND.PASSIVE_CREDIT))
                    node.recalculateScaled();
                    topNode = this.node(getNodeName(subStr(currentRecord.balance, 1, 3), m_chapter.COLUMN_KIND.CREDIT, rowKind));
                    if (topNode != null)
                        topNode.setExact(topNode.getExact() + Double(value));
                        topNode.recalculateScaled();
                    end;
                end;

                topNode = this.node(getNodeName(subStr(currentRecord.balance, 1, 3), columnKind, rowKind));
                topNode.setExact(topNode.getExact() + Double(value));
                topNode.recalculateScaled();

                chapterNode = this.node(getNodeName(m_chapter.getName(), columnKind, rowKind));
                chapterNode.setExact(chapterNode.getExact() + Double(value));
                chapterNode.recalculateScaled();
            end;
        end;

        setNodeGroupAndPriority(currentRecord.balance, currentRecord, columnKind, rowKind);
    end;
    /**
     * Добавляем ограничения по строке ВхОстаток = ИсхОстаток +/- Обороты.
     */
    private macro addRowConstraint(balanceNumber : String, kindAccount : String, rowKind : String)
        var activeInRestNode;
        var passiveInRestNode;

        var activeOutRestNode;
        var passiveOutRestNode;

        var activeDebetNode;
        var passiveDebetNode;

        var activeCreditNode;
        var passiveCreditNode;

        var debetNode;
        var creditNode;

        var relation1;
        var relation2;
        var relation3;
        var relation4;
        var relation5;

        if ((kindAccount == "АП") or (balanceNumber == m_chapter.getName()))

            activeInRestNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST,  rowKind);
            passiveInRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, rowKind);

            activeOutRestNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST,  rowKind);
            passiveOutRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, rowKind);

            activeDebetNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET,  rowKind);
            passiveDebetNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, rowKind);

            activeCreditNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT,  rowKind);
            passiveCreditNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, rowKind);

                relation1 = ReportLinearRelation(RCB_RS_EQUAL);
                relation1.lhs.plus(activeInRestNode).plus(activeDebetNode).minus(activeCreditNode);
                relation1.rhs.plus(activeOutRestNode);
                this.addRelation(relation1);

                relation2 = ReportLinearRelation(RCB_RS_EQUAL);
                relation2.lhs.plus(passiveInRestNode).plus(passiveCreditNode).minus(passiveDebetNode);
                relation2.rhs.plus(passiveOutRestNode);
                this.addRelation(relation2);

            if (kindAccount == "АП")
                debetNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.DEBET,  rowKind);
                creditNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.CREDIT, rowKind);

                relation3 = ReportLinearRelation(RCB_RS_EQUAL);
                relation3.lhs.plus(activeDebetNode).plus(passiveDebetNode);
                relation3.rhs.plus(debetNode);
                this.addRelation(relation3);

                relation4 = ReportLinearRelation(RCB_RS_EQUAL);
                relation4.lhs.plus(activeCreditNode).plus(passiveCreditNode);
                relation4.rhs.plus(creditNode);
                this.addRelation(relation4);
            elif ((balanceNumber == m_chapter.getName()) and (rowKind == m_chapter.ROW_KIND.TOTAL))

                relation3 = ReportLinearRelation(RCB_RS_EQUAL);
                relation3.lhs.plus(passiveInRestNode);
                relation3.rhs.plus(activeInRestNode);
                this.addRelation(relation3);

                relation4 = ReportLinearRelation(RCB_RS_EQUAL);
                relation4.lhs.plus(activeOutRestNode);
                relation4.rhs.plus(passiveOutRestNode);
                this.addRelation(relation4);

                relation5 = ReportLinearRelation(RCB_RS_EQUAL);
                relation5.lhs.plus(activeDebetNode).plus(passiveDebetNode);
                relation5.rhs.plus(activeCreditNode).plus(passiveCreditNode);
                this.addRelation(relation5);
            end;

        elif (kindAccount == "А")
            activeInRestNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, rowKind);
            activeOutRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, rowKind);
            activeDebetNode   = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, rowKind);
            activeCreditNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, rowKind);

            relation1 = ReportLinearRelation(RCB_RS_EQUAL);
            relation1.lhs.plus(activeInRestNode).plus(activeDebetNode).minus(activeCreditNode);
            relation1.rhs.plus(activeOutRestNode);
            this.addRelation(relation1);
        else
            passiveInRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, rowKind);
            passiveOutRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, rowKind);
            passiveDebetNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, rowKind);
            passiveCreditNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, rowKind);

            relation2 = ReportLinearRelation(RCB_RS_EQUAL);
            relation2.lhs.plus(passiveInRestNode).plus(passiveCreditNode).minus(passiveDebetNode);
            relation2.rhs.plus(passiveOutRestNode);
            this.addRelation(relation2);
        end;
    end;

    /**
     * Проверяем наличие счетов с равными остатками. Причем остатки должны округляться без погрешности.
     */
    private macro checkEqualRests(balanceNumber : String, kindAccount : String, rowKind : String)
        var activeInRestNode;
        var passiveInRestNode;

        var activeOutRestNode;
        var passiveOutRestNode;

        var activeDebetNode;
        var passiveDebetNode;

        var activeCreditNode;
        var passiveCreditNode;

        if (not m_isCalculateInRest)
            return;
        end;


        if (kindAccount == "А")
            activeInRestNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, rowKind);
            activeOutRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, rowKind);
            activeDebetNode   = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, rowKind);
            activeCreditNode  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, rowKind);

            if ((activeInRestNode.getExact() == activeOutRestNode.getExact()) and (activeOutRestNode.getDef() == 0.5))
                activeDebetNode.setGroup(202);
                activeCreditNode.setGroup(202);
            end;
        elif (kindAccount == "П")
            passiveInRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, rowKind);
            passiveOutRestNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, rowKind);
            passiveDebetNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, rowKind);
            passiveCreditNode = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, rowKind);

            if ((passiveInRestNode.getExact() == passiveOutRestNode.getExact()) and (passiveOutRestNode.getDef() == 0.5))
                passiveDebetNode.setGroup(202);
                passiveCreditNode.setGroup(202);
            end;
        end;
    end;

     /**
     * Добавляем ограничения, по итогам Рубли + Валюта = Итог.
     */
    private macro addTotalConstraints(balanceNumber : String, columnKind : String)
        var totalNode    = getNode(balanceNumber, columnKind, m_chapter.ROW_KIND.TOTAL);
        var roubleNode   = getNode(balanceNumber, columnKind, m_chapter.ROW_KIND.ROUBLE);
        var currencyNode = getNode(balanceNumber, columnKind, m_chapter.ROW_KIND.CURRENCY);
        /*
        if ((totalNode.getExact() == 0.0)and(roubleNode.getExact() == 0.0)and(currencyNode.getExact() == 0.0))
            return
        end;
        */
        var relation = ReportLinearRelation(RCB_RS_EQUAL);

        relation.lhs.plus(roubleNode).plus(currencyNode);
        relation.rhs.plus(totalNode);
        this.addRelation(relation);
    end;
    /**
     * Добавляем ограничения для корреспонденских счетов 99998 и 99999 главы В.
     */
    private macro addConstraintForLoroAccount(balanceNumber : String, kindAccount : String)

        var inRestNodeTotal;
        var inRestNodeCurrency;
        var inRestNodeRouble;

        var outRestNodeTotal;
        var outRestNodeCurrency;
        var outRestNodeRouble;

        if (kindAccount == "А")
            inRestNodeTotal      = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.TOTAL);
            //inRestNodeCurrency   = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY);
            //inRestNodeRouble     = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE);

            outRestNodeTotal     = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL);
            //outRestNodeCurrency  = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY);
            //outRestNodeRouble    = getNode(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE);
        elif (kindAccount == "П")
            inRestNodeTotal      = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.TOTAL);
            //inRestNodeCurrency   = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY);
            //inRestNodeRouble     = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE);

            outRestNodeTotal     = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL);
            //outRestNodeCurrency  = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY);
            //outRestNodeRouble    = getNode(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE);
        end;

        if (balanceNumber == "99998")
            m_relationFor99998InputTotal.lhs.plus(inRestNodeTotal);
            //m_relationFor99998InputCurrency.lhs.plus(inRestNodeCurrency);
            //m_relationFor99998InputRouble.lhs.plus(inRestNodeRouble);

            m_relationFor99998OutputTotal.lhs.plus(outRestNodeTotal);
            //m_relationFor99998OutputCurrency.lhs.plus(outRestNodeCurrency);
            //m_relationFor99998OutputRouble.lhs.plus(outRestNodeRouble);
        elif (balanceNumber == "99999")
            m_relationFor99999InputTotal.lhs.plus(inRestNodeTotal);
            //m_relationFor99999InputCurrency.lhs.plus(inRestNodeCurrency);
            //m_relationFor99999InputRouble.lhs.plus(inRestNodeRouble);

            m_relationFor99999OutputTotal.lhs.plus(outRestNodeTotal);
            //m_relationFor99999OutputCurrency.lhs.plus(outRestNodeCurrency);
            //m_relationFor99999OutputRouble.lhs.plus(outRestNodeRouble);
        elif (kindAccount == "А")
            m_relationFor99999InputTotal.rhs.plus(inRestNodeTotal);
            //m_relationFor99999InputCurrency.rhs.plus(inRestNodeCurrency);
            //m_relationFor99999InputRouble.rhs.plus(inRestNodeRouble);

            m_relationFor99999OutputTotal.rhs.plus(outRestNodeTotal);
            //m_relationFor99999OutputCurrency.rhs.plus(outRestNodeCurrency);
            //m_relationFor99999OutputRouble.rhs.plus(outRestNodeRouble);
        elif (kindAccount == "П")
            m_relationFor99998InputTotal.rhs.plus(inRestNodeTotal);
            //m_relationFor99998InputCurrency.rhs.plus(inRestNodeCurrency);
            //m_relationFor99998InputRouble.rhs.plus(inRestNodeRouble);

            m_relationFor99998OutputTotal.rhs.plus(outRestNodeTotal);
            //m_relationFor99998OutputCurrency.rhs.plus(outRestNodeCurrency);
            //m_relationFor99998OutputRouble.rhs.plus(outRestNodeRouble);
        end;
    end;

    /**
     * Добавляем ограничения.
     */
    macro addBalance(balanceNumber : String, kindAccount : String)

        if ((kindAccount == "АП") or (balanceNumber == m_chapter.getName()))
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST);
        elif (kindAccount == "А")
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST);
        else
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST);
        end;

        if ((kindAccount == "АП") or (balanceNumber == m_chapter.getName()))
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET);

            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT);

            if (kindAccount == "АП")
                addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.CREDIT);
                addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.DEBET);
            end;
        elif (kindAccount == "А")
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT);
        else
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT);
        end;

        if ((kindAccount == "АП") or (balanceNumber == m_chapter.getName()))
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST);
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST);
        elif (kindAccount == "А")
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST);
        else
            addTotalConstraints(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST);
        end;

        addRowConstraint(balanceNumber, kindAccount, m_chapter.ROW_KIND.TOTAL);
        addRowConstraint(balanceNumber, kindAccount, m_chapter.ROW_KIND.ROUBLE);
        addRowConstraint(balanceNumber, kindAccount, m_chapter.ROW_KIND.CURRENCY);


        if (strLen(balanceNumber) == 5)
            checkEqualRests(balanceNumber, kindAccount, m_chapter.ROW_KIND.TOTAL);
            checkEqualRests(balanceNumber, kindAccount, m_chapter.ROW_KIND.ROUBLE);
            checkEqualRests(balanceNumber, kindAccount, m_chapter.ROW_KIND.CURRENCY);
            if (m_chapter.getChapter() == 3)
                addConstraintForLoroAccount(balanceNumber, kindAccount);
            end;
        end;

    end;
    /**
     * Устанавливаем уровени для каждой вершины данног счета.
     */

    macro setLevelForNode(balanceNumber : String, kindAccount : String)
        var node;

        if((strLen(balanceNumber) == 3)or(balanceNumber == "99998")or(balanceNumber == "99999") or (m_chapter.getChapter() == 5))
            if (kindAccount == "А")
                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(3);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(8);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(13);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(23);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(28);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(33);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);
            elif(kindAccount == "П")
                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(3);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(8);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(13);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(23);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(28);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(33);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);
            elif(kindAccount == "АП")
                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(3);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(8);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(13);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(23);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(28);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(33);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(3);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(8);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(13);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(23);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(28);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(33);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(53);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(58);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(63);
            end;
        elif (strLen(balanceNumber) == 5)
            if (kindAccount == "А")
                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(83);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(88);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(93);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(103);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(108);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(113);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(133);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(138);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(143);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(133);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(138);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.ACTIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(143);
            elif(kindAccount == "П")
                if (m_isCalculateInRest)
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.TOTAL));
                    node.setLevel(83);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.ROUBLE));
                    node.setLevel(88);
                    node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_IN_REST, m_chapter.ROW_KIND.CURRENCY));
                    node.setLevel(93);
                end;

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(103);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(108);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_OUT_REST, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(113);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(133);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(138);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_DEBET, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(143);

                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.TOTAL));
                node.setLevel(133);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.ROUBLE));
                node.setLevel(138);
                node = this.node(getNodeName(balanceNumber, m_chapter.COLUMN_KIND.PASSIVE_CREDIT, m_chapter.ROW_KIND.CURRENCY));
                node.setLevel(143);
            end;
        end;
    end;

    initRelationsForAccounts99998And99999(chapter);

end;

private class TNormalizeBalanceController(chapter, isRecalculateIfNotNormalized)

    private var  m_report : RcbReport = rcbApplication.currentReport();

    private var m_previousReport = m_report.createPreviousReport();

    private const COLUMN_KIND = TColumnKind();

    private const ROW_KIND = TRowKind();

    private var m_protocolView;

    private var m_normalizer;

    /**
     Данная переменная показывает какие главы необходимо нормализовать
     0 - все главы
     1 - 1 глава
     2 - 2 глава
     3 - 3 глава
     4 - 4 глава
     5 - 5 глава
    */
    private var  m_chapter = chapter;

    /**
        Данная переменная показывает текущую главу, по которой происходит нормализация
     */
    private var  m_currentChapter;

    private var m_isRecalculateIfNotNormalized = nvl(isRecalculateIfNotNormalized, false);

    private macro initProtocolView(chapter);
        m_protocolView = TBalanceProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ " + String(chapter) + " ГЛАВЫ");
    end;

    class BalanceInfo(balanceNumber : String, kindAccount: String)

        private var m_balanceNumber = balanceNumber;
        private var m_kindAccount = kindAccount;

        macro getBalanceNumber()
            return m_balanceNumber;
        end;

        macro getKindAccount()
            return m_kindAccount;
        end;
    end;

    macro printParameterReport(chapter)
        var ds = TRsbDataSet("WITH"
        +"\n"+               "-------"
        +"\n"+               "    parameter AS (SELECT t_keyid,"
        +"\n"+               "                         t_type,"
        +"\n"+               "                         SUBSTR(sys_connect_by_path(t_name, '\\'), 2) t_name"
        +"\n"+               "                    FROM dregparm_dbt"
        +"\n"+               "                   START WITH t_parentid = 0"
        +"\n"+               "                  CONNECT BY PRIOR t_keyid = t_parentid"
        +"\n"+               "                               AND ( (PRIOR t_type = 4"
        +"\n"+               "                                      AND (SELECT t_lintvalue"
        +"\n"+               "                                             FROM dregVal_dbt parmValue"
        +"\n"+               "                                            WHERE parmValue.t_keyId = t_parentId) = 88)"
        +"\n"+               "                                OR PRIOR t_type <> 4)), "
        +"\n"+               "-------"
        +"\n"+               "    parameterValue AS (select parameter.t_name t_parameterName,"
        +"\n"+               "                              CASE parameter.t_type"
        +"\n"+               "                                  WHEN 0"
        +"\n"+               "                                      THEN TO_CHAR(parameterValue.t_lintvalue)"
        +"\n"+               "                                  WHEN 1"
        +"\n"+               "                                      THEN TO_CHAR(parameterValue.t_ldoublevalue)"
        +"\n"+               "                                  WHEN 2"
        +"\n"+               "                                      THEN TO_CHAR(rsb_struct.getString(parameterValue.T_FMTBLOBDATA_XXXX))"
        +"\n"+               "                                  WHEN 4"
        +"\n"+               "                                      THEN DECODE(parameterValue.t_lintvalue, 88, 'Yes', 0, 'No', CHR(0))"
        +"\n"+               "                                  ELSE ' '"
        +"\n"+               "                              END t_value"
        +"\n"+               "  FROM parameter,"
        +"\n"+               "       dregval_dbt parameterValue"
        +"\n"+               " WHERE parameterValue.t_keyid = parameter.t_keyid"
        +"\n"+               "   AND parameter.t_name like 'REPORT\\FLOOR\\НАСТРОЙКА ММБ\\%'"
        +"\n"+               "   AND ((parameter.t_name NOT LIKE '%ГЛАВА%') OR (parameter.t_name LIKE '%ГЛАВА " + String(chapter) + "%')))"
        +"\n"+               "-------"
        +"\n"+               "SELECT t_parameterName, DECODE(t_value, CHR(0), 'Значение не заданно', t_value) t_value"
        +"\n"+               "  FROM parameterValue"
        +"\n"+               "ORDER BY t_parameterName");

        while (ds.moveNext())
            m_protocolView.printLine(ds.parameterName + " = " + ds.value);
        end;
    end;

    private macro getVariableName(balanceNumber : String, columnKind : String, rowKind : String) : String
        return m_normalizer.getVariableName(balanceNumber, columnKind, rowKind);
    end;


    private macro getValue(balanceNumber : String, columnKind : String, rowKind : String) : Money
        return m_normalizer.getValue(balanceNumber, columnKind, rowKind, m_currentChapter);
    end;

    private macro getScaledValue(balanceNumber : String, columnKind : String, rowKind : String) : Double
        return m_normalizer.getScaledValue(balanceNumber, columnKind, rowKind, m_currentChapter);
    end;


    private macro loadValue(normalizer : ReportNormalizer, currentRecord, columnKind : String)
        if ((columnKind == COLUMN_KIND.ACTIVE_IN_REST) or (columnKind == COLUMN_KIND.PASSIVE_IN_REST))

            if (m_previousReport.isCalculated())

                return;

                normalizer.setNodeValue(currentRecord,
                                        columnKind,
                                        ROW_KIND.TOTAL,
                                        getValue(currentRecord.balance, columnKind, ROW_KIND.TOTAL),
                                        getScaledValue(currentRecord.balance, columnKind, ROW_KIND.TOTAL));

                normalizer.setNodeValue(currentRecord,
                                        columnKind,
                                        ROW_KIND.ROUBLE,
                                        getValue(currentRecord.balance, columnKind, ROW_KIND.ROUBLE),
                                        getScaledValue(currentRecord.balance, columnKind, ROW_KIND.ROUBLE));


                normalizer.setNodeValue(currentRecord,
                                        columnKind,
                                        ROW_KIND.CURRENCY,
                                        getValue(currentRecord.balance, columnKind, ROW_KIND.CURRENCY),
                                        getScaledValue(currentRecord.balance, columnKind, ROW_KIND.CURRENCY));
            end;

        end;

        if ((strLen(currentRecord.balance) == 3) or (currentRecord.balance == m_normalizer.getChapter().getName()))

            normalizer.setNodeValue(currentRecord,
                                    columnKind,
                                    ROW_KIND.TOTAL,
                                    $0.0);

            normalizer.setNodeValue(currentRecord,
                                    columnKind,
                                    ROW_KIND.ROUBLE,
                                    $0.0);

            normalizer.setNodeValue(currentRecord,
                                    columnKind,
                                    ROW_KIND.CURRENCY,
                                    $0.0);
            return;
        end;
        normalizer.setNodeValue(currentRecord,
                                columnKind,
                                ROW_KIND.TOTAL,
                                getValue(currentRecord.balance, columnKind, ROW_KIND.TOTAL));

        normalizer.setNodeValue(currentRecord,
                                columnKind,
                                ROW_KIND.ROUBLE,
                                getValue(currentRecord.balance, columnKind, ROW_KIND.ROUBLE));

        normalizer.setNodeValue(currentRecord,
                                columnKind,
                                ROW_KIND.CURRENCY,
                                getValue(currentRecord.balance, columnKind, ROW_KIND.CURRENCY));
    end;

    private macro loadBalance(normalizer : ReportNormalizer, currentRecord)

        if (currentRecord.kindAccount == "А")
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_IN_REST);
        elif (currentRecord.kindAccount == "П")
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_IN_REST);
        else
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_IN_REST);
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_IN_REST);
        end;

        if (currentRecord.kindAccount == "А")
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_DEBET);
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_CREDIT);
        elif (currentRecord.kindAccount == "П")
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_DEBET);
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_CREDIT);
        else
            loadValue(normalizer, currentRecord, COLUMN_KIND.DEBET);
            loadValue(normalizer, currentRecord, COLUMN_KIND.CREDIT);

            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_DEBET);
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_CREDIT);

            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_DEBET);
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_CREDIT);
        end;

        if (currentRecord.kindAccount == "А")
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_OUT_REST);
        elif (currentRecord.kindAccount == "П")
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_OUT_REST);
        else
            loadValue(normalizer, currentRecord, COLUMN_KIND.ACTIVE_OUT_REST);
            loadValue(normalizer, currentRecord, COLUMN_KIND.PASSIVE_OUT_REST);
        end;

        normalizer.addBalance(currentRecord.balance, currentRecord.kindAccount);
        normalizer.setLevelForNode(currentRecord.balance, currentRecord.kindAccount);

    end;

    private macro recalculateValue(normalizer : ReportNormalizer, balanceNumber : String, kindAccount : String, columnKind : String, rowKind : String)
        var name = getVariableName(balanceNumber, columnKind, rowKind);

        var av = m_report.attributeValue(name);

        if (av == null)
            return;
        end;

        if(m_currentChapter == 5)
            av.scaled = floor(av.exact * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5)/ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
        else
            av.recalculateScaled();
        end;
    end;

    private macro returnStr(value)
        return execExp("String(value:0:" + PRECISION + ")");
    end;

    private macro saveValue(normalizer : ReportNormalizer, balanceNumber : String, kindAccount : String, columnKind : String, rowKind : String)

        var name = getVariableName(balanceNumber, columnKind, rowKind);

        var av = m_report.attributeValue(name);

        if (av == null)
            return;
        end;

        var node;

        if (columnKind == COLUMN_KIND.DEBET)
            if (kindAccount == "А")
                node = normalizer.returnNode(balanceNumber, COLUMN_KIND.ACTIVE_DEBET, rowKind);
            elif(kindAccount == "П")
                node = normalizer.returnNode(balanceNumber, COLUMN_KIND.PASSIVE_DEBET, rowKind);
            else
                node = normalizer.returnNode(balanceNumber, columnKind, rowKind);
            end;
        elif (columnKind == COLUMN_KIND.CREDIT)
            if (kindAccount == "А")
                node = normalizer.returnNode(balanceNumber, COLUMN_KIND.ACTIVE_CREDIT, rowKind);
            elif(kindAccount == "П")
                node = normalizer.returnNode(balanceNumber, COLUMN_KIND.PASSIVE_CREDIT, rowKind);
            else
                node = normalizer.returnNode(balanceNumber, columnKind, rowKind);
            end;
        else
            node = normalizer.returnNode(balanceNumber, columnKind, rowKind);
        end;

        var exact = av.exact;
        var scaled;
        var normalized;

        if(m_currentChapter == 5)
            scaled = double(floor(av.exact * ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5));
            av.scaled = scaled/ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;
            normalized = node.getScaledInDoubleFormat();
        else
            av.recalculateScaled();
            scaled = av.scaled;
            normalized = node.getScaled();
        end;

        if (scaled != normalized)

            var warning : STRING = "Warning!!! Большая погрешность!";

            if(m_currentChapter == 5)
                av.scaled = normalized / ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5;

                var def = abs (exact - av.scaled);

                if (def < 1.)
                    warning = "";
                end;


                m_protocolView.printString(name,
                                           exact,
                                           int(exact/ADDITIONAL_MULTIPLIER_FOR_CHAPTER_5),
                                           returnStr(av.scaled),
                                           String(def:0:5),
                                           warning);
            else
                def = abs (exact/1000 - normalized);

                if (def < 1.)
                    warning = "";
                end;

                av.scaled = normalized;
                m_protocolView.printString(name,
                                           exact,
                                           int(exact/1000),
                                           normalized,
                                           String(def:0:5),
                                           warning);
            end;
        end;
    end;

    private macro saveColumn(normalizer : ReportNormalizer, balanceNumber : String, kindAccount : String, columnKind : String)
        if(normalizer.isNormalized())
            saveValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.TOTAL);
            saveValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.ROUBLE);
            saveValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.CURRENCY);
        else
            recalculateValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.TOTAL);
            recalculateValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.ROUBLE);
            recalculateValue(normalizer, balanceNumber, kindAccount, columnKind, ROW_KIND.CURRENCY);
        end;
    end;

    private macro saveBalance(normalizer : ReportNormalizer, balInfo : BalanceInfo)

        if (balInfo.getKindAccount() == "А")
            saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.ACTIVE_OUT_REST);
        elif (balInfo.getKindAccount() == "П")
            saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.PASSIVE_OUT_REST);
        else
            saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.ACTIVE_OUT_REST);
            saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.PASSIVE_OUT_REST);
        end;

        saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.DEBET);
        saveColumn(normalizer, balInfo.getBalanceNumber(), balInfo.getKindAccount(), COLUMN_KIND.CREDIT);
    end;

    private macro isExistsBalanceData(normalizer, balanceNumber : String, kindAccount: String ) : Bool
        var inRestA   = $0.0;
        var outRestA  = $0.0;
        var inRestP   = $0.0;;
        var outRestP  = $0.0;;
        var debet     = $0.0;;
        var credit    = $0.0;;

        if (kindAccount == "А")
            inRestA  = getValue(balanceNumber, COLUMN_KIND.ACTIVE_IN_REST,  ROW_KIND.TOTAL);
            outRestA = getValue(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, ROW_KIND.TOTAL);
        elif (kindAccount == "П")
            inRestP  = getValue(balanceNumber, COLUMN_KIND.PASSIVE_IN_REST,  ROW_KIND.TOTAL);
            outRestP = getValue(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, ROW_KIND.TOTAL);
        else
            inRestA  = getValue(balanceNumber, COLUMN_KIND.ACTIVE_IN_REST,  ROW_KIND.TOTAL);
            outRestA = getValue(balanceNumber, COLUMN_KIND.ACTIVE_OUT_REST, ROW_KIND.TOTAL);

            inRestP  = getValue(balanceNumber, COLUMN_KIND.PASSIVE_IN_REST,  ROW_KIND.TOTAL);
            outRestP = getValue(balanceNumber, COLUMN_KIND.PASSIVE_OUT_REST, ROW_KIND.TOTAL);
        end;

        debet  = getValue(balanceNumber, COLUMN_KIND.DEBET,  ROW_KIND.TOTAL);
        credit = getValue(balanceNumber, COLUMN_KIND.CREDIT, ROW_KIND.TOTAL);

        if (   (inRestA != $0.0)
            or (outRestA != $0.0)
            or (inRestP != $0.0)
            or (outRestP != $0.0)
            or (debet != $0.0)
            or (credit != $0.0))
            return true;
        end;

        return false;
    end;

    private macro normilizeChapterByParts(chapter, isOptimal, isNormalizeByGroup)
        m_currentChapter = chapter;

        initProtocolView(chapter);

        m_protocolView.printDescription();

        printParameterReport(chapter);

        m_protocolView.printLine("┌──────────────────────────────────────────────────────────────────────────────────────────┐");
        m_protocolView.printLine("│--------------------------------------ГЛАВА " + chapter + "---------------------------------------------│");
        m_protocolView.printLine("└──────────────────────────────────────────────────────────────────────────────────────────┘");

        if(ExcludedAccountsController().isExistConflictingSetting(chapter, m_protocolView))
            return;
        end;

        var normalizer;

        if (chapter == 5)
            m_normalizer = TBalanceChapterNormalizer(1,                   chapter, not m_previousReport.isCalculated());
        else
            m_normalizer = TBalanceChapterNormalizer(m_report.multiplier, chapter, not m_previousReport.isCalculated());
        end;


        private var balanceList = TRcbSet();

        balanceList.clear();

        var dataSet = TRsbDataSet("WITH tabcoff AS(SELECT --+inline"
                    +"\n"+        "                       rsb_common.getregstrvalue(rsb_common.GetRegKeyPath(val.t_keyId)) t_balancelist,"
                    +"\n"+        "                       TO_NUMBER(subStr(parm.t_name, 11, length(parm.t_name))) t_k"
                    +"\n"+        "                  FROM dregval_dbt val,"
                    +"\n"+        "                       dregparm_dbt parm"
                    +"\n"+        "                 WHERE parm.t_parentId = rsb_common.GetRegParm('REPORT/FLOOR/НАСТРОЙКА ММБ/ЗАДАТЬ ПРИОРИТЕТЫ СЧЕТОВ/ГЛАВА " + chapter +"')"
                    +"\n"+        "                   AND val.t_keyId = parm.t_keyId),"
                    +"\n"+        "  tabexclbal AS(SELECT --+inline"
                    +"\n"+        "                       rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/РУБЛИ')t_roublebalancelist,"
                    +"\n"+        "                       rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/ВАЛЮТА')t_currencybalancelist,"
                    +"\n"+        "                       rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/ИТОГ')t_totalbalancelist"
                    +"\n"+        "                  FROM DUAL),"
                    +"\n"+        "  tabuse     AS(SELECT --+inline"
                    +"\n"+        "                       DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ЗАДАТЬ ПРИОРИТЕТЫ СЧЕТОВ'),CHR (0), 0, 1) t_isusepriority,"
                    +"\n"+        "                       DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ЗАДАТЬ ПРИОРИТЕТЫ СЧЕТОВ/ГЛАВА " + chapter + "'), CHR (0), 0, 1) t_isusepriorityforchapter,"
                    +"\n"+        "                       DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА'), CHR (0), 0, 1) t_isuseexclude,"
                    +"\n"+        "                       DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "'), CHR (0), 0, 1) t_isuseexcludeforchapter"
                    +"\n"+        "                  FROM DUAL)"
                    +"\n"+        "SELECT *"
                    +"\n"+        "  FROM (SELECT " + getSqlString(m_normalizer.getChapter().getName()) + " t_balance,'АП' t_kindaccount, 100 t_k, 0 t_isRoubleExcluded, 0 t_isCurrencyExcluded, 0 t_isTotalExcluded"
                    +"\n"+        "          FROM DUAL"
                    +"\n"+        "         WHERE " + ternary (m_previousReport.isCalculated(), "1=1", "1=0")
                    +"\n"+        "        UNION ALL"
                    +"\n"+        "        SELECT bal.t_balance,"
                    +"\n"+        "               CASE"
                    +"\n"+        "                  WHEN LENGTH (bal.t_balance) = 3"
                    +"\n"+        "                       THEN CASE"
                    +"\n"+        "                            WHEN t_all = t_a"
                    +"\n"+        "                               THEN 'А'"
                    +"\n"+        "                            WHEN t_a IS NULL"
                    +"\n"+        "                               THEN 'П'"
                    +"\n"+        "                            ELSE 'АП'"
                    +"\n"+        "                         END"
                    +"\n"+        "                  ELSE DECODE (bal.t_kind_account, '0', 'АП', bal.t_kind_account)"
                    +"\n"+        "               END AS t_kindaccount,"
                    +"\n"+        "               NVL((SELECT t_k"
                    +"\n"+        "                      FROM tabcoff"
                    +"\n"+        "                     WHERE (SELECT 1"
                    +"\n"+        "                              FROM tabuse"
                    +"\n"+        "                             WHERE t_isusepriority = 1"
                    +"\n"+        "                               AND t_isusepriorityforchapter =1) = 1"
                    +"\n"+        "                       AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                       AND REGEXP_LIKE (tabcoff.t_balancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')"
                    +"\n"+        "                       AND ROWNUM < 2), 50) t_k,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_roublebalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_isroubleexcluded,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_currencybalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_iscurrencyexcluded,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_totalbalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_istotalexcluded"
                    +"\n"+        "          FROM dbalance_dbt bal,"
                    +"\n"+        "               (SELECT SUBSTR(t_balance, 1, 3) t_balance,"
                    +"\n"+        "                       COUNT(*) t_all"
                    +"\n"+        "                  FROM dbalance_dbt"
                    +"\n"+        "                 WHERE t_balance NOT LIKE '%ОВП%'"
                    +"\n"+        "                   AND t_chapter = " + chapter
                    +"\n"+        "                   AND t_inumplan = 0"
                    +"\n"+        "                   AND LENGTH(t_balance) = 5"
                    +"\n"+        "                   AND INSTR(t_type_balance, 'T') = 0"
                    +"\n"+        "              GROUP BY SUBSTR(t_balance, 1, 3)) dall,"
                    +"\n"+        "               (SELECT SUBSTR(t_balance, 1, 3) t_balance,"
                    +"\n"+        "                       COUNT(*) t_a"
                    +"\n"+        "                  FROM dbalance_dbt"
                    +"\n"+        "                 WHERE t_balance NOT LIKE '%ОВП%'"
                    +"\n"+        "                   AND t_chapter = " + chapter
                    +"\n"+        "                   AND t_inumplan = 0"
                    +"\n"+        "                   AND LENGTH(t_balance) = 5"
                    +"\n"+        "                   AND INSTR(t_type_balance, 'T') = 0"
                    +"\n"+        "                   AND (t_kind_account = '0' OR t_kind_account = 'А')"
                    +"\n"+        "              GROUP BY SUBSTR(t_balance, 1, 3)) da"
                    +"\n"+        "         WHERE bal.t_chapter = " + chapter
                    +"\n"+        "           AND bal.t_balance NOT LIKE '%ОВП%'"
                    +"\n"+        "           AND bal.t_inumplan = 0"
                    +"\n"+        "           AND (LENGTH(bal.t_balance) = 5 OR LENGTH(bal.t_balance) = 3)"
                    +"\n"+        "           AND INSTR(bal.t_type_balance, 'T') = 0"
                    +"\n"+        "           AND bal.t_balance = dall.t_balance(+)"
                    +"\n"+        "           AND bal.t_balance = da.t_balance(+))"
                    +"\n"+        "ORDER BY CASE"
                    +"\n"+        "             WHEN INSTR(t_balance, " + getSqlString(m_normalizer.getChapter().getName()) + ") != 0 THEN 999999"
                    +"\n"+        "             ELSE LENGTH(t_balance)"
                    +"\n"+        "         END,"
                    +"\n"+        "         t_balance");



        var i = 0;
        var isExist = false;
        while (dataSet.moveNext())
            if (isExistsBalanceData(m_normalizer, dataSet.balance, dataSet.kindaccount))
                balanceList.insert(BalanceInfo(dataSet.balance, dataSet.kindaccount));
                loadBalance(m_normalizer, dataSet);
                isExist = true;
            end;
            i = i + 1;
        end;

        if (isExist)
            if (chapter == 3)
                m_normalizer.addRelationsForLoroAccounts()
            end;
            /*Добавляем ограничения по главе*/
            m_normalizer.addBalance(m_normalizer.getChapter().getName());
            /*Устанавливаем группы и приоритеты для вершин, относящимся к главе*/
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_IN_REST,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_IN_REST,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_IN_REST,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_IN_REST,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_IN_REST,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_IN_REST,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_OUT_REST,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_OUT_REST,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_OUT_REST,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_OUT_REST,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_OUT_REST,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_OUT_REST,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_DEBET,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_DEBET,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_DEBET,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_DEBET,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_DEBET,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_DEBET,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_CREDIT,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_CREDIT,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.ACTIVE_CREDIT,  ROW_KIND.CURRENCY);

            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_CREDIT,  ROW_KIND.TOTAL);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_CREDIT,  ROW_KIND.ROUBLE);
            m_normalizer.setNodeGroupAndPriority(m_normalizer.getChapter().getName(), null, COLUMN_KIND.PASSIVE_CREDIT,  ROW_KIND.CURRENCY);
       end;


        remProgress();

        if (isOptimal == false)
            m_normalizer.setIsOptimalDecision(false);
        end;

        if (isNormalizeByGroup)
            m_normalizer.setIsNormalizeByGroup(true);
        end;

        m_normalizer.setTimeLimit(MAX_TIME_OF_DESICIONS);

        m_normalizer.normalize();

        m_protocolView.printLine("НОРМАЛИЗАЦИЯ ГЛАВЫ " + chapter);

        m_protocolView.printLine("Период отчета:" + m_report.context.period.beginDate + " - " + m_report.context.period.endDate);

        m_protocolView.printLine("Количество переменных = " + m_normalizer.count);

        var iterator;
        if (not m_normalizer.isNormalized())

            if (m_normalizer.isErrorExact())
                m_protocolView.printLine("Ошибки на неокругленных значениях!");
            end;

            m_protocolView.printLine("Не удалось выполнить нормализацию по главе " + chapter + "(смотри лог-файл:" + m_normalizer.getLogFilePath() + ").");

            if(m_isRecalculateIfNotNormalized)
                iterator = balanceList.createIterator();

                iterator.moveFirst();

                while (not iterator.isDone())
                    saveBalance(m_normalizer, iterator.getCurrentItem());

                    iterator.moveNext();
                end;

                RcbApplication.TransactionManager.commit();
            end;

            return;
        end;

        m_protocolView.printLine("Нормализация выполнена");
        m_protocolView.printLine("лог-файл:" + m_normalizer.getLogFilePath());
        m_protocolView.printLine("Время нормализации (мс): " + m_normalizer.getTimeNormalizationAsString());
        m_protocolView.printHeadTable();

        iterator = balanceList.createIterator();

        iterator.moveFirst();

        i = 0;
        while (not iterator.isDone())
            saveBalance(m_normalizer, iterator.getCurrentItem());

            i = i + 1;

            iterator.moveNext();
        end;

        m_protocolView.printBottomTable(chapter);
        m_protocolView.printLine("");

        RcbApplication.TransactionManager.commit();
    end;

    macro execute()
        if((m_chapter == 0)or(m_chapter == ""))
            normilizeChapterByParts(1, true, false);
            normilizeChapterByParts(2, true, false);
            normilizeChapterByParts(3, true, false);
            normilizeChapterByParts(4, true, false);
            normilizeChapterByParts(5, true, false);
        else
          if (m_chapter == 1)
            normilizeChapterByParts(m_chapter, true, false);
          else
            normilizeChapterByParts(m_chapter, true, false);
          end;
        end;
    end;
end;

macro showBalanceProtocol()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL));

    var protocol = TSummaryProtocolView();

    if (chapter == 0)
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 1 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 2 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 3 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 4 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 5 ГЛАВЫ"));
    else
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ " + String(chapter) + " ГЛАВЫ"));
    end;

    protocol.show();
end;

macro showBalanceProtocolAfterNormalization()
    if (IS_SHOW_BALANCE_PROTOCOL == false)
        return;
    end;

    showBalanceProtocol();
end;

macro executeNormalization()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL));

    if (not IS_ENABLE_ROUNDING_ERROR_CONTROL)
        execMacroFile("alternativBalanceNormalizer.mac", "executeNormalization", chapter);
        return;
    end;

    var profiler = TSQLProfiler(getTxtFileName("!BalanceNormilizeChapter" + chapter + "Profile"));
    profiler.clear();
    profiler.on();

    RcbApplication.currentReport.reload();
    TNormalizeBalanceController(chapter, true).execute();
end;



macro executeNormalizationAndShowProtocol()
    if (not IS_ENABLE_ROUNDING_ERROR_CONTROL)
        execMacroFile("alternativBalanceNormalizer.mac", "executeNormalizationAndShowProtocol");
        return;
    end;


    if (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
        var profiler = TSQLProfiler(getTxtFileName("!BalanceNormilizeProfile"));
        profiler.clear();
        profiler.on();

        /*Нормализация всех глав*/
        RcbApplication.currentReport.reload();

        TNormalizeBalanceController(0, true).execute();

        if (IS_SHOW_BALANCE_PROTOCOL == false)
            return;
        end;


        var protocol = TSummaryProtocolView();

        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 1 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 2 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 3 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 4 ГЛАВЫ"));
        protocol.add(TProtocolView("ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ 5 ГЛАВЫ"));

        protocol.show();
    end;
end;

macro executeChapterNormalizationAndShowProtocol()

    if (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
        executeNormalization(cmdArgs);

        if (IS_SHOW_BALANCE_PROTOCOL == false)
            return;
        end;

        showBalanceProtocol(cmdArgs);
    end;
end;

УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
