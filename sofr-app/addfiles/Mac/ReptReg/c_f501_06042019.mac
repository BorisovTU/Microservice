/*
$Name:          c_f501.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 501. Расчет
*/

import testlib;

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 501.

  Создан: 13.10.2006 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/*
 *  Общебанковские интеры и модули
 */
import balanceInter;
import rsbDataSet;

import cb_sql;
import lib_lang;

import param;/* 19.09.2007 Malakhova 110424*/

/*
 *  Интеры и модули подсистемы
 */
import rcbCoreInter;
import reptCBCommon;

import departmentFilter;
import acc_lib;
import rcbconst;
import RcbTuneTable;
import testLib;
import com_f501;
import RcbLibrary;
import AccNoteFor501;

/***************************************************************************************************
 *  Константы
 **************************************************************************************************/
private const CHAPTER_LEVEL = 0;
private const BALANCE_LEVEL = 1;
private const ACCOUNT_LEVEL = 2;

/*константы для индексов массива масок лицевых счетов*/
const PART_1 = 0; /*1 раздел отчета*/
const PART_2 = 1; /*2 раздел отчета*/
const TYPE_1 = 0; /*тип счета (депозит/кредит)*/
var   type_2 = 1; /*тип счета (корреспондентский), переменная для того чтобы можно было не учитывать корр. счета*/

private const PART_1_CODE = "1";
private const PART_2_CODE = "2";
private const TYPE_1_CODE = "Депозит/кредит";
private const TYPE_2_CODE = "Корреспондентский";

const SQL_PART_1_CODE = GetSqlString(PART_1_CODE);
const SQL_PART_2_CODE = GetSqlString(PART_2_CODE);
const SQL_TYPE_1_CODE = GetSqlString(TYPE_1_CODE);
const SQL_TYPE_2_CODE = GetSqlString(TYPE_2_CODE);

/***************************************************************************************************
 *  Глобальные переменные
 **************************************************************************************************/

private class TGlobal()
    /*
     *  Перменная хранит ссылку на балансовый отчет за текуцщий период.
     *  Используется для процедуры нормализации.
     */
    var balanceReport = NULL;

    macro initializeRepDataPackage(beginDate, endDate)
        sql_truncate("drepdepartment_tmp");

        sql_execute("CALL rep_data.setBalancePlanNumber(" + rcbApplication.parameters.balancePlanNumber + ")");

        sql_execute("CALL rep_data.setBeginDate(" + beginDate + ")");
        sql_execute("CALL rep_data.setEndDate("   + endDate   + ")");

        sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(rcbDepartmentList.getAsSqlSetFilial()) + ", "
                                                       + getSqlString(rcbDepartmentList.getAsSqlSetVsp()) + ")");
        sql_execute("CALL rep_data.initCorrectDocumentParameters(1,"+ beginDate + ","+ endDate +")");

        sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+ beginDate +", 'DD.MM.YYYY')))");

        sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+ endDate +", 'DD.MM.YYYY')))");
    end;
end;

private var global = TGlobal();

/***************************************************************************************************
 *  Блок обработки ошибок
 **************************************************************************************************/

/* Базовый класс исключений */
private class TError(errorMessage : String)
    private var m_errorMessage : String = errorMessage;

    macro What()
        return m_errorMessage;
    end;
end;

/* Запуск макроса вне контекста отчета */
private class (TError) TNullCurrentReportError()
    InitTError("Макрос должен быть запущен в контексте отчета");
end;

/* Неверная форма */
private class (TError) TWrongFormError()
    InitTError("Макрос может быть выполнен только в контексте отчета по форме 501");
end;

/* Неверные единицы измерения отччета */
private class (TError) TWrongDimensionError()
    InitTError("Неверная размерность отчета");
end;

/* Функция-генератор исключений */
private macro Throw(error : TError)
    RunError(error.What(), error);
end;

/***************************************************************************************************
 *  Параметры отчета
 **************************************************************************************************/
class TParameters()
    var m_irReducibleRest = false;
    var m_SortBalance     = false;
    var m_SortClient      = "";
    var m_isMmData        = false;
    var step              = "";
    var m_isUpdateSecuritiesAccount = false;

    private macro Constructor()

        step = cmdargs();
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\НЕСНИЖАЕМЫЙ ОСТАТОК",       V_BOOL,    m_irReducibleRest, NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО БАЛАНСОВЫМ", V_BOOL,    m_SortBalance,     NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО КЛИЕНТАМ",   V_INTEGER, m_SortClient,      NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК",                V_BOOL,    m_isMmData,        NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ SECURITIES",         V_BOOL,    m_isUpdateSecuritiesAccount, NULL);
    end;

    Constructor();
end;

/***************************************************************************************************
 *  Контроллеры расчета
 **************************************************************************************************/
/* Базовый класс "Расчета" */
private class TCalculator(report : RcbReport)

    private var m_report = report;
    private var m_MaskArray = TArray();
    private var m_BalanceList =  "32001, 32010, 32101, 32110, 32201, 32301, 31301, 31310, 31401, 31410, 31501, 31601";
    private var m_BalanceArray = TArray();
                m_BalanceArray[0]  = "32001";
                m_BalanceArray[1]  = "32010";
                m_BalanceArray[2]  = "32101";
                m_BalanceArray[3]  = "32110";
                m_BalanceArray[4]  = "32201";
                m_BalanceArray[5]  = "32301";
                m_BalanceArray[6]  = "31301";
                m_BalanceArray[7]  = "31310";
                m_BalanceArray[8]  = "31401";
                m_BalanceArray[9]  = "31410";
                m_BalanceArray[10] = "31501";
                m_BalanceArray[11] = "31601";

    private const SQL_BEGIN_DATE = getSqlDate(m_report.context.period.beginDate);
    private const SQL_END_DATE   = getSqlDate(m_report.context.period.endDate);
    private const SQL_ZERO_DATE  = getSqlDate(Date(0, 0, 0));

    private var m_tuneTable = RcbTuneTable("dt501_dbt");
    m_tuneTable.setInstructionFilter(m_report.context.period.endDate);

    private macro AnalyzeTurnTable()
        var dataSet;
        m_MaskArray[PART_1] = TArray();
        m_MaskArray[PART_2] = TArray();

        if (TParameters().m_irReducibleRest)
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][type_2] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][type_2] = dataSet.t_AccountMasks;
        else
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_1][type_2] = "";

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_2][type_2] = "";
        end;
    end;

    macro removeVariables()
        private macro RemoveCompositValues(name:string)

            var iterator = m_report.AttributeValue(name).CreateValueIterator();
            var idList = TArray();
            var i;

            i = 0;
            iterator.moveFirst();
            while(not iterator.isDone())
                if( iterator.currentItem.valueId != 0 )
                    idList(i) = iterator.currentItem.valueId;
                    i = i + 1;
                end;
                iterator.moveNext();
            end;

            i = 0;
            while(i < idList.size())
                m_report.AttributeValue(name).removeValue(idList(i));
                i = i + 1;
            end;
        end;
        RemoveCompositValues("Ф501_1");
        RemoveCompositValues("Ф501_2");
        RcbApplication().transactionManager.Commit();
    end;

    private macro isOnDemandBalanceAccount(balance)
        var i = 0;
        while (i < m_BalanceArray.size)
            if (m_BalanceArray[i] == balance)
                return true;
            end;
            i = i + 1;
        end;

        return false;
    end;

    macro SaveVariables( parameters:TParameters)

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();

                CompositeValue.fieldValue("ПризнакРЕПО").exact = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакИП").exact   = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact     = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact     = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact  = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact    = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact    = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact    = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact   = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact   = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact  = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact  = dataSet.EndRest;
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
    end;

    private macro InBalanceArray( balance )
        var i =0;
        while( i < m_BalanceArray.size )
            if( m_BalanceArray[i] == balance )
                return TRUE;
            end;
            i = i + 1;
        end;
        return FALSE;
    end;

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account      account,"
                   + "\n" + "       acc.t_accountId    accountId,"
                   + "\n" + "       acc.t_fiid         fiid,"
                   + "\n" + "       acc.t_kind         kindAccount,"
                   + "\n" + "       acc.t_chapter      chapter,"
                   + "\n" + "       acc.t_balance      balance,"
                   + "\n" + "       prt.t_id           partyId,"
                   + "\n" + "       prt.t_name         name,"
                   + "\n" + "       prt.t_isResident   isResident,"
                   + "\n" + "       prt.t_countryCode  nrCountry,"
                   + "\n" + "       acc.t_inCoverRest BegRest,"
                   + "\n" + "       acc.t_outCoverRest EndRest,"
                   + "\n" + "       NVL((SELECT sum(doc.t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_debetaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Debet,"
                   + "\n" + "       NVL((SELECT sum(t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_creditaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Credit,"
                   + "\n" + "       acc.t_objectId objectId, "
                   + "\n" + "       acc.t_part part, "
                   + "\n" + "       acc.t_typeAccount typeAccount, "
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd operationEndDate, "
                   + "\n" + "       rep_data.isExistsCorrectionalDocument() isexistcorrect,"
                   + "\n" + "       CASE"
                   + "\n" + "            WHEN prt.t_isresident = 1 "
                   + "\n" + "            THEN"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN reppartycodes.t_code like '%/%'"
                   + "\n" + "                    THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/')-1)"
                   + "\n" + "                    ELSE NVL(reppartycodes.t_code, CHR(1))"
                   + "\n" + "                END"
                   + "\n" + "            ELSE"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN prt.t_isswift = 1"
                   + "\n" + "                    THEN NVL(reppartycodes.t_code, 'НР')"
                   + "\n" + "                    ELSE 'НР'"
                   + "\n" + "            END"
                   + "\n" + "       END AS regNumber"
                   + "\n" + "  FROM accountTable  acc,"//Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
                   + "\n" + "       drepparty_vw    prt,"
                   + "\n" + "       (SELECT *"
                   + "\n" + "          FROM dreppartycodes_vw partyсode,"
                   + "\n" + "               drepparty_vw      repparty_"
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId"
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                   + "\n" + "           AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'"
                   + "\n" + "               OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = NVL(DECODE(acc.t_partyId, "
                   + "\n" + "                         " + {OurBank} + ", "
                   + "\n" + "                             acc.t_contragentId),"
                   + "\n" + "                             acc.t_partyId)"
                   + "\n" + "   AND prt.t_id  = reppartycodes.t_partyid (+)";
        return QueryForData;
    end;

    private macro getQueryForCategory()
        var queryForCategory =         "SELECT atc.t_object"
                      + "\n" + "          FROM dobjattr_dbt  att,"
                      + "\n" + "               dobjatcor_dbt atc"
                      + "\n" + "         WHERE atc.t_attrId      = att.t_attrId"
                      + "\n" + "           AND atc.t_objectType  = att.t_objectType"
                      + "\n" + "           AND atc.t_groupId     = att.t_groupId"
                      + "\n" + "           AND att.t_numinlist = 'РЕПО'"
                      + "\n" + "           AND " + SQL_END_DATE + " BETWEEN atc.t_validFromDate AND atc.t_validToDate";
        return queryForCategory;
    end;

    private macro addRelationsQuery()
        var query;

        if (rcbApplication().currentReport().context.period.EndDate < RCB_I2121_DATE)

            query = "  FROM ("+ getQueryForData() + ")";

         else
            query =          ","
             + "\n" + "       CASE"
             + "\n" + "           WHEN (objectId = category.t_object)"
             + "\n" + "               THEN 1"
             + "\n" + "           ELSE 0"
             + "\n" + "       END isRepoAccount"
             + "\n" + "  FROM ("+ getQueryForData() + "), ("+ getQueryForCategory() + ") category"
             + "\n" + " WHERE objectId = category.t_object(+)";
         end;
         return query;
    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN NVL((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       NVL(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                2 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_2_CODE
             + "\n" + "                            AND (" + ternary(TParameters().m_irReducibleRest,ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_2], "acc.t_account"),"0=1") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                2 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_2_CODE
             + "\n" + "                            AND (" + ternary(TParameters().m_irReducibleRest,ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_2], "acc.t_account"),"0=1") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro FillTempTable()

         SQL_Truncate("DF501_TMP");

         var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);

         var dataSet = TRsbDataSet(getQuery());

         while ( dataSet.Next() )
             message(dataSet.PartyID);

             temp501.AddNew();

             if (rcbApplication().currentReport().context.period.EndDate >= RCB_I2121_DATE)
                temp501.IsRepoAccount = dataSet.isRepoAccount;
             end;
             temp501.Account = dataSet.account;
             temp501.AccountId = dataSet.accId;
             temp501.Balance = dataSet.bal;
             temp501.PrintedAccount = dataSet.prAcc;
             temp501.ClientName = dataSet.name;
             temp501.RegNumber = dataSet.regNumber;
             temp501.CountryCode = dataSet.countryCode;
             temp501.ClientCode = dataSet.partyID;
             temp501.PartReport = dataSet.part;
             temp501.KindAccount = dataSet.kindAccount;
             temp501.TypeAccount = dataSet.typeAccount;
             temp501.PerfomanceDate = NVL(dataSet.perfomanceDate, date(0,0,0));
             temp501.Rate = dataSet.rate;
             temp501.BeginRest = dataSet.BegRest;
             temp501.EndRest   = dataSet.EndRest;
             temp501.Debet     = dataSet.Debet;
             temp501.Credit    = dataSet.Credit;
             temp501.isexistcorrect = dataSet.isexistcorrect;

             temp501.BeginRestTh = RCB_FloorTerm( temp501.BeginRest );
             temp501.EndRestTh   = RCB_FloorTerm( temp501.EndRest   );
             temp501.DebetTh     = RCB_FloorTerm( temp501.Debet     );
             temp501.CreditTh    = RCB_FloorTerm( temp501.Credit    );

             temp501.update();
         end;
    end;
end;

private class (TCalculator) TCalculator_2332(report : RcbReport)
    initTCalculator(report);

    private macro AnalyzeTurnTable()
        var dataSet;
        m_MaskArray[PART_1] = TArray();
        m_MaskArray[PART_2] = TArray();

        dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
        dataSet.Next();
        m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

        dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
        dataSet.Next();
        m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN NVL((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       NVL(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro SaveVariables( parameters:TParameters)
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
            profiler.clear();
            profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();

                CompositeValue.fieldValue("ПризнакРЕПО").exact = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact   = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакИП").exact   = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact     = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact     = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact  = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact    = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact    = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact    = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact   = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact   = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact  = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact  = dataSet.EndRest;
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =      "SELECT                                                        "
                + "\n" +     "    data.t_id,                                                "
                + "\n" +     "    data.t_name,                                              "
                + "\n" +     "    data.t_shortName,                                         "
                + "\n" +     "    data.t_code,                                              "
                + "\n" +     "    data.t_countryCode,                                       "
                + "\n" +     "    CASE                                                      "
                + "\n" +     "        WHEN data.t_isResident = 1                            "
                + "\n" +     "        THEN                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN t_regNumber like '%/%'                   "
                + "\n" +     "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)"
                + "\n" +     "                ELSE NVL(t_regNumber, CHR(1))                 "
                + "\n" +     "            END                                               "
                + "\n" +     "        ELSE                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN data.t_isswift = 1                       "
                + "\n" +     "                THEN NVL(t_regNumber, 'НР')                   "
                + "\n" +     "                ELSE 'НР'                                     "
                + "\n" +     "            END                                               "
                + "\n" +     "    END AS t_regNumber                                        "
                + "\n" +     "FROM                                                          "
                + "\n" +     "   (SELECT                                                    "
                + "\n" +     "        party.t_id,                                           "
                + "\n" +     "        party.t_name,                                         "
                + "\n" +     "        party.t_shortName,                                    "
                + "\n" +     "        party.t_isResident,                                   "
                + "\n" +     "        party.t_isswift,                                      "
                + "\n" +     "        codes.t_code as t_code,                               "
                + "\n" +     "        codes.t_name as t_nameCode,                           "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN (party.t_isResident = 0)                     "
                + "\n" +     "                THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" +     "                ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
                + "\n" +     "        END t_countryCode,                                    "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                ELSE CHR(1)                                   "
                + "\n" +     "        END as t_regNumber                                    "
                + "\n" +     "    FROM                                                      "
                + "\n" +     "        dRepParty_vw      party,                              "
                + "\n" +     "        dRepPartyCodes_vw codes,                              "
                + "\n" +     "        dCountry_dbt      country                             "
                + "\n" +     "    WHERE                                                     "
                + "\n" +     "        party.t_id = (select                                  "
                + "\n" +     "                             codes.t_partyId                  "
                + "\n" +     "                        from                                  "
                + "\n" +     "                             dRepPartyCodes_vw codes          "
                + "\n" +     "                       where                                  "
                + "\n" +     "                             codes.t_code ='" + customerCode + "'"
                + "\n" +     "                             AND codes.t_name = 'Код') "
                + "\n" +     "        and codes.t_name = 'Код'                              "
                + "\n" +     "        and codes.t_partyId = party.t_id                      "
                + "\n" +     "        AND country.t_codeLat3 = party.t_countrycode          "
                + "\n" +     ") data                                                        ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current = NVL(dataSet.name, "");
                    compositeValue.currentItem.fieldValue("РегНом").current = NVL(dataSet.regNumber, "");
                    compositeValue.currentItem.fieldValue("КодСтр").current = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current  = NVL(dataSet.id, "");
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled;
                compositeValue.moveNext();
            end;

        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
        savePartForManualInput( 1, parameters );
        savePartForManualInput( 2, parameters );
    end;

    private macro getQueryForCategory()
        var queryForCategory =         "SELECT atc.t_object,"
                      + "\n" + "               CASE"
                      + "\n" + "                   WHEN  (att.t_numinlist = 'РЕПО')"
                      + "\n" + "                   THEN 1"
                      + "\n" + "                   ELSE 2"
                      + "\n" + "               END t_category"
                      + "\n" + "          FROM dobjattr_dbt  att,"
                      + "\n" + "               dobjatcor_dbt atc"
                      + "\n" + "         WHERE atc.t_attrId      = att.t_attrId"
                      + "\n" + "           AND atc.t_objectType  = att.t_objectType"
                      + "\n" + "           AND atc.t_groupId     = att.t_groupId"
                      + "\n" + "           AND ((att.t_numinlist = 'РЕПО') OR (att.t_numinlist    = 'ГД'))"
                      + "\n" + "           AND " + SQL_END_DATE + " BETWEEN atc.t_validFromDate AND atc.t_validToDate";
        return queryForCategory;
    end;

    private macro addRelationsQuery()
        var query;

        query =          ","
         + "\n" + "       CASE"
         + "\n" + "           WHEN ((objectId = category.t_object) AND (category.t_category = 1))"
         + "\n" + "               THEN 1"
         + "\n" + "           ELSE 0"
         + "\n" + "       END isRepoAccount,"
         + "\n" + "       CASE"
         + "\n" + "           WHEN ((objectId = category.t_object) AND (category.t_category = 2))"
         + "\n" + "               THEN 1"
         + "\n" + "           ELSE 0"
         + "\n" + "       END isGD"
         + "\n" + "  FROM ("+ getQueryForData() + "), (" + getQueryForCategory() + ") category"
         + "\n" + " WHERE objectId = category.t_object(+)";

        return query;
    end;

    macro FillTempTable()

         SQL_Truncate("DF501_TMP");

         var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);
         temp501.setFieldType("t_isGD",  V_INTEGER);

         var dataSet = TRsbDataSet(getQuery());

         while ( dataSet.Next() )
             message(dataSet.PartyID);

             temp501.AddNew();

             temp501.IsRepoAccount  = dataSet.isRepoAccount;
             temp501.Account        = dataSet.account;
             temp501.AccountId      = dataSet.accId;
             temp501.Balance        = dataSet.bal;
             temp501.PrintedAccount = dataSet.prAcc;
             temp501.ClientName     = dataSet.name;
             temp501.RegNumber      = dataSet.regNumber;
             temp501.CountryCode    = dataSet.countryCode;
             temp501.ClientCode     = dataSet.partyID;
             temp501.PartReport     = dataSet.part;
             temp501.KindAccount    = dataSet.kindAccount;
             temp501.TypeAccount    = dataSet.typeAccount;
             temp501.PerfomanceDate = NVL(dataSet.perfomanceDate, date(0,0,0));
             temp501.Rate           = dataSet.rate;
             temp501.BeginRest      = dataSet.BegRest;
             temp501.EndRest        = dataSet.EndRest;
             temp501.Debet          = dataSet.Debet;
             temp501.Credit         = dataSet.Credit;
             temp501.isGD           = dataSet.isGD;

             temp501.BeginRestTh    = RCB_FloorTerm( temp501.BeginRest );
             temp501.EndRestTh      = RCB_FloorTerm( temp501.EndRest   );
             temp501.DebetTh        = RCB_FloorTerm( temp501.Debet     );
             temp501.CreditTh       = RCB_FloorTerm( temp501.Credit    );

             temp501.isexistcorrect = dataSet.isexistcorrect;

             temp501.update();
         end;
    end;
end;

private class (TCalculator_2332) TCalculator_3129(report : RcbReport)
    initTCalculator_2332(report);

    private macro getObjectCode(tableName : String, chapter : String, fiid : String, account : String) : String
        return   "(  TO_CHAR (" + tableName + "." + chapter + ", 'FM0x')"
        + "\n" + "|| TO_CHAR (" + tableName + "." + fiid    + ", 'FM0xxxxxx')"
        + "\n" + "||          " + tableName + "." + account + ")";
    end;

    private macro addRelationsQuery()
        var query;

        query =          ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 1,  'РЕПО',"        + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isRepoAccount,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 1,  'ГД',"          + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isGD,                                                                                                                                                                                                  "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isThirdPerson,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN '*'                                                                                                                                                                                           "
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END singDepending,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN (rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "                 AND rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") IS NOT NULL)       "
        + "\n" + "                            THEN ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " +
                                                                                                                getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 2, 1)) * 256 +                             "
        + "\n" + "                                 ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " +
                                                                                                                getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 1, 1))                                     "
        + "\n" + "           ELSE -1                                                                                                                                                                                                 "
        + "\n" + "       END prolongationAmount,                                                                                                                                                                                    "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 104, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + "))"
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END explanation,                                                                                                                                                                                           "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN isResident <> 0                                                                                                                                                                                   "
        + "\n" + "               THEN RSI_RSBPARTY.PT_GetPartyCode(partyId, 3)                                                                                                                                                      "
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END BIC                                                                                                                                                                                                    "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN NVL((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       NVL(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                            AND (rsb_rep_ac.CheckObjAttrPresenceByNum(4,1,'РЕПО ч/з ЦК не КО'," + getObjectCode("acc","t_chapter","t_fiId","t_account") +", " +
                                                                                             getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0)"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                            AND (rsb_rep_ac.CheckObjAttrPresenceByNum(4,1,'РЕПО ч/з ЦК не КО', " + getObjectCode("acc","t_chapter","t_fiId","t_account") +", " +
                                                                                             getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0)"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro SaveVariables( parameters:TParameters)
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
            profiler.clear();
            profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("ПризнакРЕПО").exact           = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact             = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакТретьеЛицо").exact     = dataSet.isThirdPerson;
                CompositeValue.fieldValue("ПризнакИП").exact             = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact                 = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact                 = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact              = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact                = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact                = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact                = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact               = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact               = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact              = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact              = dataSet.EndRest;
                CompositeValue.fieldValue("ПризнакЗависимости").exact    = string(NVL(dataSet.singDepending, ""));
                CompositeValue.fieldValue("КолПролонгаций").exact        = NVL(dataSet.prolongationAmount, -1);
                CompositeValue.fieldValue("Пояснения").exact             = string(NVL(dataSet.explanation, ""));
                CompositeValue.fieldValue("БИК").exact                   = string(NVL(dataSet.BIC, ""));
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =      "SELECT                                                        "
                + "\n" +     "    data.t_id,                                                "
                + "\n" +     "    data.t_name,                                              "
                + "\n" +     "    data.t_shortName,                                         "
                + "\n" +     "    data.t_code,                                              "
                + "\n" +     "    data.t_countryCode,                                       "
                + "\n" +     "    CASE                                                      "
                + "\n" +     "        WHEN data.t_isResident = 1                            "
                + "\n" +     "        THEN                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN t_regNumber like '%/%'                   "
                + "\n" +     "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)"
                + "\n" +     "                ELSE NVL(t_regNumber, CHR(1))                 "
                + "\n" +     "            END                                               "
                + "\n" +     "        ELSE                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN data.t_isswift = 1                       "
                + "\n" +     "                THEN NVL(t_regNumber, 'НР')                   "
                + "\n" +     "                ELSE 'НР'                                     "
                + "\n" +     "            END                                               "
                + "\n" +     "    END AS t_regNumber                                        "
                + "\n" +     "FROM                                                          "
                + "\n" +     "   (SELECT                                                    "
                + "\n" +     "        party.t_id,                                           "
                + "\n" +     "        party.t_name,                                         "
                + "\n" +     "        party.t_shortName,                                    "
                + "\n" +     "        party.t_isResident,                                   "
                + "\n" +     "        party.t_isswift,                                      "
                + "\n" +     "        codes.t_code as t_code,                               "
                + "\n" +     "        codes.t_name as t_nameCode,                           "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN (party.t_isResident = 0)                     "
                + "\n" +     "                THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" +     "                ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
                + "\n" +     "        END t_countryCode,                                    "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                ELSE CHR(1)                                   "
                + "\n" +     "        END as t_regNumber                                    "
                + "\n" +     "    FROM                                                      "
                + "\n" +     "        dRepParty_vw      party,                              "
                + "\n" +     "        dRepPartyCodes_vw codes,                              "
                + "\n" +     "        dCountry_dbt      country                             "
                + "\n" +     "    WHERE                                                     "
                + "\n" +     "        party.t_id = (  select                                "
                + "\n" +     "                                    codes.t_partyId           "
                + "\n" +     "                                from                          "
                + "\n" +     "                                    dRepPartyCodes_vw codes   "
                + "\n" +     "                                where                         "
                + "\n" +     "                                    codes.t_code ='" + customerCode + "'"
                + "\n" +     "                                    AND codes.t_name = 'Код') "
                + "\n" +     "        and codes.t_name = 'Код'                              "
                + "\n" +     "        and codes.t_partyId = party.t_id                      "
                + "\n" +     "        AND country.t_codeLat3 = party.t_countrycode          "
                + "\n" +     ") data                                                        ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current = NVL(dataSet.name, "");
                    compositeValue.currentItem.fieldValue("РегНом").current = NVL(dataSet.regNumber, "");
                    compositeValue.currentItem.fieldValue("КодСтр").current = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current  = NVL(dataSet.id, "");
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled;
                compositeValue.moveNext();
            end;

        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
        savePartForManualInput( 1, parameters );
        savePartForManualInput( 2, parameters );
    end;

    macro FillTempTable()

         SQL_Truncate("DF501_TMP");

         var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);
         temp501.setFieldType("t_isGD",  V_INTEGER);

         var dataSet = TRsbDataSet(getQuery());

         while ( dataSet.Next() )
             message(dataSet.PartyID);

             temp501.AddNew();

             temp501.IsRepoAccount      = dataSet.isRepoAccount;
             temp501.Account            = dataSet.account;
             temp501.AccountId          = dataSet.accId;
             temp501.Balance            = dataSet.bal;
             temp501.PrintedAccount     = dataSet.prAcc;
             temp501.ClientName         = dataSet.name;
             temp501.RegNumber          = dataSet.regNumber;
             temp501.CountryCode        = dataSet.countryCode;
             temp501.ClientCode         = dataSet.partyID;
             temp501.PartReport         = dataSet.part;
             temp501.KindAccount        = dataSet.kindAccount;
             temp501.TypeAccount        = dataSet.typeAccount;
             temp501.PerfomanceDate     = NVL(dataSet.perfomanceDate, date(0,0,0));
             temp501.Rate               = dataSet.rate;
             temp501.BeginRest          = dataSet.BegRest;
             temp501.EndRest            = dataSet.EndRest;
             temp501.Debet              = dataSet.Debet;
             temp501.Credit             = dataSet.Credit;
             temp501.isGD               = dataSet.isGD;
             temp501.isThirdPerson      = dataSet.isThirdPerson;
             temp501.singDepending      = dataSet.singDepending;
             temp501.prolongationAmount = dataSet.prolongationAmount;
             temp501.explanation        = dataSet.explanation;
             temp501.BIC                = dataSet.BIC;

             temp501.BeginRestTh        = RCB_FloorTerm( temp501.BeginRest );
             temp501.EndRestTh          = RCB_FloorTerm( temp501.EndRest   );
             temp501.DebetTh            = RCB_FloorTerm( temp501.Debet     );
             temp501.CreditTh           = RCB_FloorTerm( temp501.Credit    );

             temp501.isexistcorrect     = dataSet.isexistcorrect;

             temp501.update();
         end;
    end;
end;

private class (TCalculator_3129) TCalculator_3269(report : RcbReport)
    initTCalculator_3129(report);

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN NVL((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN NVL(rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE NVL(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       NVL(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;
end;

private class (TCalculator_3269) TCalculator_4212(report : RcbReport)
    initTCalculator_3269(report);

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account                                                       account,"
                   + "\n" + "       acc.t_accountId                                                     accountId,"
                   + "\n" + "       acc.t_fiid                                                          fiid,"
                   + "\n" + "       acc.t_kind                                                          kindAccount,"
                   + "\n" + "       acc.t_chapter                                                       chapter,"
                   + "\n" + "       acc.t_balance                                                       balance,"
                   + "\n" + "       prt.t_id                                                            partyId,"
                   + "\n" + "       DECODE(prt.t_isResident, 1,prt.t_name, NVL((SELECT pn.t_name FROM dPartyName_dbt pn WHERE pn.t_partyId = prt.t_id AND pn.t_nameTypeId = 3  AND ROWNUM < 2), prt.t_name)) AS name, "
                   + "\n" + "       prt.t_isResident                                                    isResident,"
                   + "\n" + "       NVL((SELECT adr.t_country FROM dAdress_dbt adr WHERE adr.t_partyId = prt.t_id AND adr.t_type = 2 AND adr.t_country != CHR(1)), prt.t_countryCode) nrCountry,"
                   + "\n" + "       acc.t_inCoverRest                                                   BegRest,"
                   + "\n" + "       acc.t_outCoverRest                                                  EndRest,"
                   + "\n" + "       NVL((SELECT sum(doc.t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_debetaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Debet,"
                   + "\n" + "       NVL((SELECT sum(t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_creditaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0)                     Credit,"
                   + "\n" + "       acc.t_objectId                                                      objectId, "
                   + "\n" + "       acc.t_part                                                          part, "
                   + "\n" + "       acc.t_typeAccount                                                   typeAccount, "
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd                               operationEndDate, "
                   + "\n" + "       CASE                                                                                "
                   + "\n" + "           WHEN EXISTS (SELECT 1                                                           "
                   + "\n" + "                          FROM drepCorrectionalDocument_vw iscorrect                       "
                   + "\n" + "                         WHERE iscorrect.t_creditaccount = acc.t_account)                  "
                   + "\n" + "           THEN 1                                                                          "
                   + "\n" + "           ELSE 0                                                                          "
                   + "\n" + "       END AS                                                               isexistcorrect,"
                   + "\n" + "       CASE"
                   + "\n" + "            WHEN prt.t_isresident = 1 "
                   + "\n" + "            THEN"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN reppartycodes.t_code like '%/%'"
                   + "\n" + "                        THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                   + "\n" + "                    ELSE NVL(reppartycodes.t_code, CHR(1))"
                   + "\n" + "                END"
                   + "\n" + "            ELSE"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN prt.t_isswift = 1"
                   + "\n" + "                        THEN NVL(reppartycodes.t_code, 'НР')"
                   + "\n" + "                    ELSE 'НР'"
                   + "\n" + "                END"
                   + "\n" + "       END AS                                                              regNumber,"
                   //графа 13
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId, "
                                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN '11'" //Признак обременения первая цифра, остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                               WHEN NOT (party.t_isPhisical = 1 AND  party.t_isResident = 0)"
                   + "\n" + "                                   THEN '9' || party.t_name"
                   + "\n" + "                               ELSE '0'"
                   + "\n" + "                            END as t_name"
                   + "\n" + "                       FROM dRepParty_vw party,"
                   + "\n" + "                            dRepLinkedObjects_vw objLink"
                   + "\n" + "                      WHERE party.t_objectId                = objLink.t_id"
                   + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
                   + "\n" + "                        AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
                   + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "                        AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "                    ),"
                   + "\n" + "                    '0'"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                             onerousClaim,"
                   //графа 14
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId," +
                                                                                  getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN 'XYYY'" //Условный код первая цифра (если X - значит не заполяется), следующие 3 цифры - это код SWIFT (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (SELECT CASE"
                   + "\n" + "                                                     WHEN INSTR(codes.t_code, '/', 1, 1) != 0"
                   + "\n" + "                                                         THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
                   + "\n" + "                                                     WHEN codes.t_code = ''"
                   + "\n" + "                                                         THEN 'X' || 'YYY' || codes.t_code"
                   + "\n" + "                                                     ELSE '2' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 END"
                   + "\n" + "                                            FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                           WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
                   + "\n" + "                                             AND codes.t_partyId  = party.t_id)"

                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN (NVL((SELECT CASE"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 8"
                   + "\n" + "                                                              THEN '4' || 'XXX' || codes.t_code || 'XXX'"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 11"
                   + "\n" + "                                                              THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
                   + "\n" + "                                                          ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
                   + "\n" + "                                                      END t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '1' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isEmployer = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '6' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN '3'|| 'YYY' || 'HP'"
                   + "\n" + "                                WHEN party.t_isPhisical = 1 AND party.t_isResident = 1 AND party.t_isEmployer = 0"
                   + "\n" + "                                    THEN (NVL((SELECT '5' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_INN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
                   + "\n" + "                                ELSE 'X' || 'YYY' || ''"
                   + "\n" + "                            END t_identifier"
                   + "\n" + "                        FROM dRepLinkedObjects_vw link,"
                   + "\n" + "                             dRepParty_vw party"
                   + "\n" + "                       WHERE acc.t_objectId               = link.t_connectObjectId"
                   + "\n" + "                         AND party.t_objectId             = link.t_id"
                   + "\n" + "                         AND link.t_isInstalledForEndDate = 1"
                   + "\n" + "                         AND link.t_connectObjectType     = 4"
                   + "\n" + "                         AND link.t_type                  = 3"
                   + "\n" + "                         AND link.t_role                  = 59"
                   + "\n" + "                    ),"
                   + "\n" + "                    'X' || 'YYY' || ''"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                                 identifier,"
                   //графа 15
                   + "\n" + "       (SELECT CASE category.t_value"
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда")             + " THEN " + getSqlString("1")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит")           + " THEN " + getSqlString("2")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз")          + " THEN " + getSqlString("4")
                   + "\n" + "                    ELSE " + getSqlString("")
                   + "\n" + "               END"
                   + "\n" + "          FROM dRepCategory_vw category,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE category.t_id = " + RCB_OBJGROUP_FOR_REPORTING
                   + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND category.t_value = ANY(" + getSqlString("Обрем_Ссуда") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_Депозит") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ДолгОбязательство") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ИноеОбяз") + ""
                   + "\n" + "                                     )"
                   + "\n" + "           AND category.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND category.t_objectId              = objLink.t_id"
                   + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1"
                   + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId"
                   + "\n" + "       ) onerousClaimCategory,"
                   //графа 16
                   + "\n" + "       (SELECT acc2.t_outCoverRest"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) restLinkedAccount,"
                   //графа 17
                   + "\n" + "       (SELECT TO_CHAR(rep_note.getDateAccountNote(acc2.t_objectId, 16, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + "), 'DD.MM.YYYY')"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) redemptionDate";
//                   + "\n" + "       ) redemptionDate,";
//
//        if (TParameters().m_isMmData)
//            queryForData = queryForData
//                   + "\n" + "       (SELECT MAX(deals.t_id)"
//                   + "\n" + "          FROM repMmDeals_vw deals    "
//                   + "\n" + "         WHERE (   deals.t_mainRestAccount = acc.t_account"
//                   + "\n" + "                OR deals.t_delaydMainRestAcc = acc.t_account"
//                   + "\n" + "               )"
//                   + "\n" + "           AND deals.t_kind IN ('Размещение ', 'Привлечение')"
//                   + "\n" + "           AND deals.t_isOpened = 1"
//                   + "\n" + "           AND deals.t_plannedFinishDate = (SELECT MAX(d.t_plannedFinishDate)"
//                   + "\n" + "                                              FROM repMmDeals_vw d "
//                   + "\n" + "                                             WHERE (   d.t_mainRestAccount = acc.t_account"
//                   + "\n" + "                                                    OR d.t_delaydMainRestAcc = acc.t_account"
//                   + "\n" + "                                                   )"
//                   + "\n" + "                                               AND d.t_kind IN ('Размещение ', 'Привлечение')"
//                   + "\n" + "                                               AND d.t_isOpened = 1"
//                   + "\n" + "                                           )"
//                   + "\n" + "       ) AS t_dealId";
//        else
//            queryForData = queryForData
//                   + "\n" + "       NULL AS t_dealId";
//        end;

        queryForData = queryForData
                   + "\n" + "  FROM accountTable acc,"//Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
                   + "\n" + "       drepparty_vw prt,"
                   + "\n" + "       (SELECT *"
                   + "\n" + "          FROM dreppartycodes_vw partyсode,"
                   + "\n" + "               drepparty_vw      repparty_"
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId"
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                   + "\n" + "           AND (  (    repparty_.t_isResident = 0"
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_SWIFT + ")"
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'"
                   + "\n" + "               OR (    repparty_.t_isResident = 1"
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_BANKREGNUM + "))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = NVL(DECODE(acc.t_partyId, "
                   + "\n" + "                         " + {OurBank} + ", "
                   + "\n" + "                             acc.t_contragentId),"
                   + "\n" + "                             acc.t_partyId)"
                   + "\n" + "   AND prt.t_id = reppartycodes.t_partyid(+)"
                   ;

        return QueryForData;
    end;

    private macro addRelationsQuery()
        var query;

        query =  ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isRepoAccount,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isGD,                                                                                                                                                                     "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isThirdPerson,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN '*'                                                                                                                                                              "
        + "\n" + "           ELSE ''                                                                                                                                                                   "
        + "\n" + "       END singDepending,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN (rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                      + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "                 AND rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "
                                                            + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") IS NOT NULL)       "
        + "\n" + "                            THEN ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, "
                                                                                                              + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                              + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 2, 1)) * 256  "
        + "\n" + "                               + ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId,              "
                                                                                                              + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                              + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 1, 1))        "
        + "\n" + "           ELSE -1                                                                                                                                                                   "
        + "\n" + "       END prolongationAmount,                                                                                                                                                       "
        + "\n" + "       rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ",  data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", "
                                                                             + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")) AS explanation,                                                                                                                                                              "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN isResident <> 0                                                                                                                                                      "
        + "\n" + "               THEN RSI_RSBPARTY.PT_GetPartyCode(partyId, 3)                                                                                                                         "
        + "\n" + "           ELSE ''                                                                                                                                                                   "
        + "\n" + "       END BIC,                                                                                                                                                                      "
        + "\n" + "       SUBSTR(onerousClaim, 2) onerousClaim,                                                                                                                                         "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(onerousClaim, 1, 1) = 'X'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(onerousClaim, 1, 1)"
        + "\n" + "       END onerousSign,"

        + "\n" + "       SUBSTR(identifier, 5) identifier,                                                                                                                                             "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 2, 3) = 'YYY'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 2, 3)"
        + "\n" + "       END swiftDepartment,"

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 1, 1) = 'X'                                                                                                                                       "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 1, 1)"
        + "\n" + "       END conditionalCode,"

        + "\n" + "       NVL(onerousClaimCategory, " + getSqlString("") + ") onerousClaimCategory,                                                                                                                                                         "

        + "\n" + "       CASE"
        + "\n" + "           WHEN     onerousClaimCategory IS NOT NULL"
        + "\n" + "                AND onerousClaimCategory = '4'"
        + "\n" + "           THEN NVL((SELECT rep_note.getTextAccountNote(objLink.t_id, 69, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
        + "\n" + "                       FROM dRepLinkedObjects_vw objLink"
        + "\n" + "                      WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
        + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_connectObjectId       = data.objectId"
        + "\n" + "                    ),"
        + "\n" + "                    CHR(1)"
        + "\n" + "                   )"
        + "\n" + "           ELSE " + getSqlString("")
        + "\n" + "       END otherDecoding,"

        + "\n" + "       restLinkedAccount,                                                                                                                                                            "
        + "\n" + "       redemptionDate                                                                                                                                                                "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    private macro getQuery()
        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

//        AnalyzeTurnTable();

        var query =  "SELECT account,"
            + "\n" + "       accountId accId,"
            + "\n" + "       SUBSTR(balance, 1, 5) bal,"
            + "\n" + "       account AS prAcc,"
            + "\n" + "       name,"
            + "\n" + "       regNumber,"
            + "\n" + "       DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry)) countryCode,"
            + "\n" + "       begRest,"
            + "\n" + "       debet,"
            + "\n" + "       credit,"
            + "\n" + "       endRest,"
            + "\n" + "       objectId,"
            + "\n" + "       operationEndDate,"
            + "\n" + "       partyID,"
            + "\n" + "       part,"
            + "\n" + "       typeAccount,"
            + "\n" + "       kindAccount,"
            + "\n" + "       chapter,"
            + "\n" + "       isexistcorrect,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN NULL"
            + "\n" + "           ELSE CASE"
            + "\n" + "                    WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1"
            + "\n" + "                                           FROM mmDeals"
            + "\n" + "                                          WHERE mmDeals.t_part = part"
            + "\n" + "                                            AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )"
            + "\n" + "                         )"
            + "\n" + "                    THEN NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "), NVL(operationEndDate," + getSqlDate(Date(0,0,0)) + "))"
            + "\n" + "                    ELSE NVL((SELECT MAX(mmDeals.t_plannedFinishDate)"
            + "\n" + "                                FROM mmDeals"
            + "\n" + "                               WHERE mmDeals.t_part = part"
            + "\n" + "                                 AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                             )," + getSqlDate(Date(0,0,0))
            + "\n" + "                            )"
            + "\n" + "                END"
            + "\n" + "       END AS perfomanceDate,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN CASE"
            + "\n" + "                    WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1"
            + "\n" + "                                           FROM mmDeals"
            + "\n" + "                                          WHERE mmDeals.t_part = part"
            + "\n" + "                                            AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )"
            + "\n" + "                         )"
            + "\n" + "                    THEN CASE"
            + "\n" + "                             WHEN endRest = 0"
            + "\n" + "                              AND (   (begRest != 0)"
            + "\n" + "                                   OR (credit != 0)"
            + "\n" + "                                   OR (debet != 0)"
            + "\n" + "                                  )"
            + "\n" + "                             THEN NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + ")," + getSqlDate(Date(0,0,0)) + ") --при отсутствии примечания в переменной будет '', в экспорте будет 0"
            + "\n" + "                             WHEN endRest != 0"
            + "\n" + "                             THEN NULL --использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
            + "\n" + "                         END"
            + "\n" + "                    ELSE CASE"
            + "\n" + "                             WHEN endRest = 0"
            + "\n" + "                              AND (   (begRest != 0)"
            + "\n" + "                                   OR (credit != 0)"
            + "\n" + "                                   OR (debet != 0)"
            + "\n" + "                                  )"
            + "\n" + "                             THEN NVL((SELECT MAX(mmDeals.t_plannedFinishDate)"
            + "\n" + "                                         FROM mmDeals"
            + "\n" + "                                        WHERE mmDeals.t_part = part"
            + "\n" + "                                          AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                      ), " + getSqlDate(Date(0,0,0))
            + "\n" + "                                     )  --при отсутствии сделки или нулевой даты в переменной будет '', в экспорте будет 0"
            + "\n" + "                             WHEN endRest != 0"
            + "\n" + "                             THEN NULL --в экспорте использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
            + "\n" + "                         END"
            + "\n" + "                END"
            + "\n" + "           ELSE NULL --в экспорте использовать perfomanceDate"
            + "\n" + "       END AS perfomanceDateKliko,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN NULL"
            + "\n" + "           WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1"
            + "\n" + "                                  FROM mmDeals"
            + "\n" + "                                 WHERE mmDeals.t_part = part"
            + "\n" + "                                   AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                               )"
            + "\n" + "                )"
            + "\n" + "           THEN NVL(rep_note.readRate(data.objectId," + SQL_END_DATE + "), 0)"
            + "\n" + "           ELSE (SELECT CASE"
            + "\n" + "                            WHEN mmDeals.t_isOverNight = 1"
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount"
            + "\n" + "                                             *(SELECT rateHistory.t_rate"
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory    "
            + "\n" + "                                                WHERE rateHistory.t_dealId = deals.t_id"
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7"
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                                 WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7"
            + "\n" + "                                                                                   AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                               )"
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                                         rateHistory.t_rate"
            + "\n" + "                                              )"
            + "\n" + "                                            )"
            + "\n" + "                                       / SUM(deals.t_dealAmount)"
            + "\n" + "                                    FROM repMmDeals_vw deals"
            + "\n" + "                                   WHERE deals.t_kind = mmDeals.t_kind"
            + "\n" + "                                     AND deals.t_isOverNight = mmDeals.t_isOverNight"
            + "\n" + "                                     AND (   (mmDeals.t_mainRestAccount = deals.t_mainRestAccount)"
            + "\n" + "                                          OR (mmDeals.t_delaydMainRestAcc = deals.t_delaydMainRestAcc)"
            + "\n" + "                                         )"
            + "\n" + "                                     AND deals.t_contragentId = mmDeals.t_contragentId"
            + "\n" + "                                     AND (   deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                          OR (    deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                              AND deals.t_isProlonged = " + getSqlString("YES")
            + "\n" + "                                             )"
            + "\n" + "                                         )"
            + "\n" + "                                 )"
            + "\n" + "                            WHEN mmDeals.t_isOverNight != 1"
            + "\n" + "                             AND mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount"
            + "\n" + "                                             *(SELECT rateHistory.t_rate"
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory"
            + "\n" + "                                                WHERE rateHistory.t_dealId = deals.t_id"
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7"
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                                 WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7"
            + "\n" + "                                                                                   AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                               )"
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                                         rateHistory.t_rate"
            + "\n" + "                                              )"
            + "\n" + "                                            )"
            + "\n" + "                                       / SUM(deals.t_dealAmount)"
            + "\n" + "                                    FROM repMmDeals_vw deals"
            + "\n" + "                                   WHERE (   (   deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )"
            + "\n" + "                                          OR deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                         )"
            + "\n" + "                                 CONNECT BY PRIOR deals.t_id = deals.t_prolongingDealId"
            + "\n" + "                                   START WITH deals.t_prolongingDealId = mmDeals.t_id"
            + "\n" + "                                 )"
            + "\n" + "                            ELSE (SELECT rateHistory.t_rate"
            + "\n" + "                                    FROM repMmDealRateHistory_vw rateHistory"
            + "\n" + "                                   WHERE rateHistory.t_dealId = mmDeals.t_id"
            + "\n" + "                                     AND rateHistory.t_percentKind = 7"
            + "\n" + "                                     AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                     FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                    WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                      AND rh.t_percentKind = 7"
            + "\n" + "                                                                      AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                  )"
            + "\n" + "                                   GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                            rateHistory.t_rate"
            + "\n" + "                                 )"
            + "\n" + "                        END t_rate"
            + "\n" + "                   FROM mmDeals"
            + "\n" + "                  WHERE mmDeals.t_part = part"
            + "\n" + "                    AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                    AND mmDeals.t_id = (SELECT MAX(maxId.t_id)"
            + "\n" + "                                          FROM mmDeals maxId"
            + "\n" + "                                         WHERE maxId.t_part = mmDeals.t_part"
            + "\n" + "                                           AND (   (mmDeals.t_mainRestAccount = maxId.t_mainRestAccount)"
            + "\n" + "                                                OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc)"
            + "\n" + "                                               )"
            + "\n" + "                                           AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)"
            + "\n" + "                                                                              FROM mmDeals maxDate"
            + "\n" + "                                                                             WHERE maxDate.t_part = maxId.t_part"
            + "\n" + "                                                                               AND (   (maxId.t_mainRestAccount = maxDate.t_mainRestAccount)"
            + "\n" + "                                                                                    OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc)"
            + "\n" + "                                                                                   )"
            + "\n" + "                                                                           )"
            + "\n" + "                                       )"
            + "\n" + "                )"
            + "\n" + "       END AS rate";

            query = query + addRelationsQuery();

            var authorizedRepresentativeForm501Filter;
            if (isAuthorizedRepresentativeForm501())
               authorizedRepresentativeForm501Filter =
                     "         AND EXISTS (SELECT 1"
            + "\n" + "                       FROM drestdate_dbt turns"
            + "\n" + "                      WHERE turns.t_restDate = " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
            + "\n" + "                        AND (   turns.t_debet <> 0"
            + "\n" + "                             OR turns.t_credit <> 0"
            + "\n" + "                            )"
            + "\n" + "                    )"
            + "\n" + "         AND acc.t_outCoverRest > " + TF501ThresholdMmDeal().getThreshold(RcbApplication().currentReport.context.period.endDate)
            ;
            else
                authorizedRepresentativeForm501Filter =
                     "         AND 1 = 1"
            ;
            end;

            query =  ""
            + "\n" + "WITH tune"
            + "\n" + "  AS (" + m_tuneTable.getQuery() + "),"
            + "\n" + "  accountSrcTable"
            + "\n" + "  AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "             acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
            + "\n" + "             t501.t_Part t_part,"
            + "\n" + "             CASE t501.t_TypeAccount"
            + "\n" + "                 WHEN " + SQL_TYPE_1_CODE + " THEN 1"
            + "\n" + "                 ELSE 2"
            + "\n" + "             END t_typeAccount"
            + "\n" + "        FROM drepaccount_vw acc,"
            + "\n" + "             tune t501"
            + "\n" + "       WHERE acc.t_isOpened = 1"
            + "\n" + "         AND acc.t_chapter = 1"
            + "\n" + "         AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, acc.t_account) = 1"
            + "\n" + "         AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО ч/з ЦК', acc.t_objectId, "
                                                                       + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                       + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND (SELECT party.t_isBank FROM dRepParty_vw party WHERE party.t_id = acc.t_contragentId) = 1"
            + "\n" + "         AND NOT EXISTS(SELECT 1"
            + "\n" + "                          FROM dBankDprtRstr_dbt bnkRstr"
            + "\n" + "                         WHERE bnkRstr.t_partyId = acc.t_contragentId"
            + "\n" + "                           AND bnkRstr.t_rstr = 'LWRS'"
            + "\n" + "                           AND bnkRstr.t_rstrDate <= " + SQL_END_DATE
            + "\n" + "                        )"
            + "\n" +           authorizedRepresentativeForm501Filter
            + "\n" + "     ),"
                   + ternary(TParameters().m_isMmData,
              "\n" + "  mmDeals"
            + "\n" + "  AS (SELECT deals.t_id,"
            + "\n" + "             deals.t_mainRestAccount,"
            + "\n" + "             deals.t_delaydMainRestAcc,"
            + "\n" + "             deals.t_plannedFinishDate,"
            + "\n" + "             deals.t_isOverNight,"
            + "\n" + "             deals.t_kind,"
            + "\n" + "             deals.t_contragentId,"
            + "\n" + "             deals.t_isProlongingDeal,"
            + "\n" + "             CASE deals.t_kind"
            + "\n" + "                 WHEN 'Размещение ' THEN 1"
            + "\n" + "                 WHEN 'Привлечение' THEN 2"
            + "\n" + "                 ELSE 0"
            + "\n" + "             END t_part"
            + "\n" + "        FROM repMmDeals_vw deals"
            + "\n" + "       WHERE deals.t_kind IN ('Размещение ', 'Привлечение')"
            + "\n" + "         AND deals.t_isOpened = 1"
            + "\n" + "     ),",
                     ""
                            )
            + "\n" + "  accountTable"
            + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *"
            + "\n" + "        FROM accountSrcTable"
            + "\n" + "     )"
            + "\n" + "SELECT *"
            + "\n" + "  FROM (" + query + ")"
            + "\n" + " WHERE begRest <> 0"
            + "\n" + "    OR debet   <> 0"
            + "\n" + "    OR credit  <> 0"
            + "\n" + "    OR endRest <> 0";

        return query;
    end;

    macro FillTempTable()
        // 25.03.2019 ABP Использование RsbSQLInsert смысла не имеет, производительность не меняется

        var dataSet = TRsbDataSet(getQuery());
        SQL_Truncate("DF501_TMP");

        while (dataset.moveNext())
            message(dataSet.PartyID);
            var insertClause = "INSERT INTO df501_tmp"
                      + "\n" + "("
                      + "\n" + " t_isRepoAccount,"
                      + "\n" + " t_account,"
                      + "\n" + " t_accountId,"
                      + "\n" + " t_balance,"
                      + "\n" + " t_printedAccount,"
                      + "\n" + " t_clientName,"
                      + "\n" + " t_regNumber,"
                      + "\n" + " t_countryCode,"
                      + "\n" + " t_clientCode,"
                      + "\n" + " t_partReport,"
                      + "\n" + " t_kindAccount,"
                      + "\n" + " t_typeAccount,"
                      + "\n" + " t_perfomanceDate,"
                      + "\n" + " t_perfomanceDateKliko,"
                      + "\n" + " t_rate,"
                      + "\n" + " t_beginRest,"
                      + "\n" + " t_endRest,"
                      + "\n" + " t_debet,"
                      + "\n" + " t_credit,"
                      + "\n" + " t_isGD,"
                      + "\n" + " t_isThirdPerson,"
                      + "\n" + " t_singDepending,"
                      + "\n" + " t_prolongationAmount,"
                      + "\n" + " t_explanation,"
                      + "\n" + " t_BIC,"
                      + "\n" + " t_onerousClaim,"
                      + "\n" + " t_identifier,"
                      + "\n" + " t_onerousClaimCategory,"
                      + "\n" + " t_restLinkedAccount,"
                      + "\n" + " t_redemptionDate,"
                      + "\n" + " t_onerousSign,"
                      + "\n" + " t_swiftDepartment,"
                      + "\n" + " t_conditionalCode,"
                      + "\n" + " t_otherDecoding,"
                      + "\n" + " t_beginRestTh,"
                      + "\n" + " t_endRestTh,"
                      + "\n" + " t_debetTh,"
                      + "\n" + " t_creditTh,"
                      + "\n" + " t_restLinkedAccountTh,"
                      + "\n" + " t_isExistCorrect"
                      + "\n" + ")"
                      + "\n" + "VALUES"
                      + "\n" + "("
                      + "\n" + " " +  nvl(dataSet.isRepoAccount, "NULL") + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.account, "")) + ","
                      + "\n" + " " +  nvl(dataSet.accId, "NULL") + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.bal, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.prAcc, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.name, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.regNumber, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.countryCode, "")) + ","
                      + "\n" + " " +  nvl(dataSet.partyID, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.part, "NULL") + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.kindAccount, "")) + ","
                      + "\n" + " " +  nvl(dataSet.typeAccount, "NULL") + ","
                      + "\n" + " " +  ternary(dataSet.perfomanceDate == null, "NULL", getSqlDate(dataSet.perfomanceDate)) + ","
                      + "\n" + " " +  ternary(dataSet.perfomanceDateKliko == null, "NULL", getSqlDate(dataSet.perfomanceDateKliko)) + ","
                      + "\n" + " " +  nvl(dataSet.rate, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.BegRest, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.EndRest, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.Debet, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.Credit, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.isGD, "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.isThirdPerson, "NULL") + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.singDepending, "")) + ","
                      + "\n" + " " +  nvl(dataSet.prolongationAmount, "NULL") + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.explanation, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.BIC, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.onerousClaim, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.identifier, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.onerousClaimCategory, "")) + ","
                      + "\n" + " " +  nvl(dataSet.restLinkedAccount, "NULL") + ","
                      + "\n" + " " +  getSqlDate(ternary(dataSet.redemptionDate != null, date(dataSet.redemptionDate), date(0,0,0))) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.onerousSign, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.swiftDepartment, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.conditionalCode, "")) + ","
                      + "\n" + " " +  getSqlString(nvl(dataSet.otherDecoding, "")) + ","
                      + "\n" + " " +  nvl(RCB_FloorTerm(dataSet.BegRest), "NULL") + ","
                      + "\n" + " " +  nvl(RCB_FloorTerm(dataSet.EndRest), "NULL") + ","
                      + "\n" + " " +  nvl(RCB_FloorTerm(dataSet.Debet), "NULL") + ","
                      + "\n" + " " +  nvl(RCB_FloorTerm(dataSet.Credit), "NULL") + ","
                      + "\n" + " " +  nvl(RCB_FloorTerm(ternary(dataSet.restLinkedAccount == null, 0.0, dataSet.restLinkedAccount)), "NULL") + ","
                      + "\n" + " " +  nvl(dataSet.isExistCorrect, "NULL")
                      + "\n" + ")"
                             ;
            sql_execute(insertClause);
        end;

        sql_execute("COMMIT");
    end;

    macro SaveVariables( parameters:TParameters)
        var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
        profiler.clear();
        profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            dataSet.setFieldType("perfomanceDateKliko", V_DATE);
            dataSet.setFieldType("redemptionDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("ПризнакРЕПО").exact           = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact             = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакТретьеЛицо").exact     = dataSet.isThirdPerson;
                CompositeValue.fieldValue("ПризнакИП").exact             = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact                 = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact                 = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact              = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact                = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact                = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact                = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact               = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact               = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact              = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact              = dataSet.EndRest;
                CompositeValue.fieldValue("ПризнакЗависимости").exact    = string(NVL(dataSet.singDepending, ""));
                CompositeValue.fieldValue("КолПролонгаций").exact        = NVL(dataSet.prolongationAmount, -1);
                CompositeValue.fieldValue("Пояснения").exact             = string(NVL(dataSet.explanation, ""));
                CompositeValue.fieldValue("БИК").exact                   = string(NVL(dataSet.BIC, ""));
                CompositeValue.fieldValue("ЛицоПоОбрем").exact           = string(NVL(dataSet.onerousClaim, ""));
                CompositeValue.fieldValue("ИдентификаторОбрем").exact    = string(NVL(dataSet.identifier, ""));
                CompositeValue.fieldValue("ВидОбрем").exact              = string(NVL(dataSet.onerousClaimCategory, ""));
                CompositeValue.fieldValue("ОстатокПоСчетуОбрем").exact   = NVL(dataSet.restLinkedAccount, 0.0);
                CompositeValue.fieldValue("ОстатокПоСчетуОбрем").scaled  = ternary(dataSet.restLinkedAccountTh == null, 0.0, dataSet.restLinkedAccountTh);
                CompositeValue.fieldValue("ДатаПогашения").exact         = string(NVL(dataSet.redemptionDate, ""));
                if (dataSet.PerfomanceDate == null)
                    CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = String(ternary(dataSet.PerfomanceDate != Date(0,0,0), dataSet.PerfomanceDate, ""));
                end;
                if (dataSet.PerfomanceDateKliko == null)
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = CompositeValue.fieldValue("ДатаИспОб").exact;
                else
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = String(ternary(dataSet.PerfomanceDateKliko != Date(0,0,0), dataSet.PerfomanceDateKliko, ""));
                end;
                CompositeValue.fieldValue("ПрСтавка").exact              = NVL(dataSet.Rate, 0.0);
                CompositeValue.fieldValue("КодКО").exact                 = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact                 = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact                 = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled              = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled              = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled             = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled             = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
                CompositeValue.fieldValue("ПризнакОбременения").exact    = string(NVL(dataSet.onerousSign, ""));
                CompositeValue.fieldValue("ФилиалСВИФТ").exact           = string(NVL(dataSet.swiftDepartment, ""));
                CompositeValue.fieldValue("УсловныйКод").exact           = string(NVL(dataSet.conditionalCode, ""));
                CompositeValue.fieldValue("ИноеРасшифровка").exact       = string(NVL(dataSet.otherDecoding, ""));
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =  "SELECT                                                                                                                                               "
                + "\n" + "    data.t_id,                                                                                                                                       "
                + "\n" + "    data.t_name,                                                                                                                                     "
                + "\n" + "    data.t_shortName,                                                                                                                                "
                + "\n" + "    data.t_code,                                                                                                                                     "
                + "\n" + "    data.t_countryCode,                                                                                                                              "
                + "\n" + "    CASE                                                                                                                                             "
                + "\n" + "        WHEN data.t_isResident = 1                                                                                                                   "
                + "\n" + "        THEN                                                                                                                                         "
                + "\n" + "            CASE                                                                                                                                     "
                + "\n" + "                WHEN t_regNumber like '%/%'                                                                                                          "
                + "\n" + "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)                                                                               "
                + "\n" + "                ELSE NVL(t_regNumber, CHR(1))                                                                                                        "
                + "\n" + "            END                                                                                                                                      "
                + "\n" + "        ELSE                                                                                                                                         "
                + "\n" + "            CASE                                                                                                                                     "
                + "\n" + "                WHEN data.t_isswift = 1                                                                                                              "
                + "\n" + "                THEN NVL(t_regNumber, 'НР')                                                                                                          "
                + "\n" + "                ELSE 'НР'                                                                                                                            "
                + "\n" + "            END                                                                                                                                      "
                + "\n" + "    END AS t_regNumber                                                                                                                               "
                + "\n" + "FROM                                                                                                                                                 "
                + "\n" + "   (SELECT                                                                                                                                           "
                + "\n" + "        party.t_id,                                                                                                                                  "
                + "\n" + "        DECODE(party.t_isResident, 1,party.t_name, NVL((SELECT pn.t_name FROM dPartyName_dbt pn WHERE pn.t_partyId = party.t_id AND pn.t_nameTypeId = 3 AND ROWNUM < 2), party.t_name)) AS t_name, "
                + "\n" + "        party.t_shortName,                                                                                                                           "
                + "\n" + "        party.t_isResident,                                                                                                                          "
                + "\n" + "        party.t_isswift,                                                                                                                             "
                + "\n" + "        codes.t_code as t_code,                                                                                                                      "
                + "\n" + "        codes.t_name as t_nameCode,                                                                                                                  "
                + "\n" + "        NVL((SELECT country.t_CodeNum3 FROM dcountry_dbt country WHERE country.t_CodeLat3 =(SELECT adr.t_country FROM dAdress_dbt adr WHERE adr.t_partyId = party.t_id AND adr.t_type = 2)),"
                + "\n" + "            (CASE                                                                                                                                         "
                + "\n" + "                WHEN (party.t_isResident = 0)                                                                                                            "
                + "\n" + "                    THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" + "                    ELSE NVL((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))                                                     "
                + "\n" + "            END)) t_countryCode,                                                                                                                           "
                + "\n" + "        CASE                                                                                                                                         "
                + "\n" + "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" + "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')   "
                + "\n" + "                ELSE CHR(1)                                                                                                                          "
                + "\n" + "        END as t_regNumber                                                                                                                           "
                + "\n" + "    FROM                                                                                                                                             "
                + "\n" + "        dRepParty_vw      party,                                                                                                                     "
                + "\n" + "        dRepPartyCodes_vw codes,                                                                                                                     "
                + "\n" + "        dCountry_dbt      country                                                                                                                    "
                + "\n" + "    WHERE                                                                                                                                            "
                + "\n" + "        party.t_id = (  select                                                                                                                       "
                + "\n" + "                                    codes.t_partyId                                                                                                  "
                + "\n" + "                                from                                                                                                                 "
                + "\n" + "                                    dRepPartyCodes_vw codes                                                                                          "
                + "\n" + "                                where                                                                                                                "
                + "\n" + "                                    codes.t_code ='" + customerCode + "'"
                + "\n" + "                                    AND codes.t_name = 'Код')                                                                                        "
                + "\n" + "        AND codes.t_name       = 'Код'                                                                                                               "
                + "\n" + "        AND codes.t_partyId    = party.t_id                                                                                                          "
                + "\n" + "        AND country.t_codeLat3 = party.t_countrycode                                                                                                 "
                + "\n" + ") data                                                                                                                                               ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current = NVL(dataSet.name, "");
                    compositeValue.currentItem.fieldValue("РегНом").current = NVL(dataSet.regNumber, "");
                    compositeValue.currentItem.fieldValue("КодСтр").current = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current  = NVL(dataSet.id, "");
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled;
                compositeValue.moveNext();
            end;

        end;

        SavePart(1, parameters);
        SavePart(2, parameters);
        savePartForManualInput(1, parameters);
        savePartForManualInput(2, parameters);
    end;

    macro updateSecuritiesAccount()
        if (TParameters().m_isUpdateSecuritiesAccount)
            ActualAccNoteFor501(rcbApplication().currentReport().context.period.BeginDate, rcbApplication().currentReport().context.period.EndDate);
        end;
    end;
end;

/***************************************************************************************************
 *  Класс управления расчетом
 **************************************************************************************************/
private class TCalculatorController( )

    private var m_report = RcbApplication().currentReport;
    private var m_calculator;

    private macro initialize()
        m_calculator = TCalculator(m_report);
    end;

    private macro CheckReport()

        if (m_report == NULL)
            Throw(TNullCurrentReportError());
        end;

        if (    (m_report.form.id != "Форма 501")
            and (m_report.form.id != "Форма 501-УП")
           )
            Throw(TWrongFormError());
        end;

        /*if (m_report.form.dimension != m_report.dimension)
            Throw(TWrongDimensionError());
        end;*/
    end;

    private macro Calculate(parameters : TParameters)

        if( parameters.step == "FillData")
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfile"));
            profiler.clear();
            profiler.on();
            SQL_Truncate("df501_tmp");
            m_calculator.removeVariables();
            m_calculator.FillTempTable( );
        elif( parameters.step == "SaveVariable")
            m_calculator.saveVariables();
        elif( parameters.step == "UpdateSecuritiesAccount")
            m_calculator.updateSecuritiesAccount();
        end;
    end;

    macro execute(parameters : TParameters)

        CheckReport();
        Calculate(parameters);

        if( parameters.step == "SaveVariable")
            RcbApplication().transactionManager.Commit();
        end;
    end;

    initialize();
end;

private class (TCalculatorController) TCalculatorController_2332()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_2332(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_3129()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_3129(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_3269()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_3269(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_4212()
    initTCalculatorController();

    private macro initialize()
        m_calculator = TCalculator_4212(m_report);
    end;
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()

    if   (rcbApplication().currentReport().context.period.EndDate < RCB_I2332_DATE)
        TCalculatorController().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate < RCB_I3129_DATE)
        TCalculatorController_2332().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate < RCB_I3269_DATE)
        TCalculatorController_3129().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate < RCB_I4212_DATE)
        TCalculatorController_3269().Execute(TParameters());
    else
        TCalculatorController_4212().Execute(TParameters());
    end;
end;
/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/
main();
УстановитьФлагВозврата( OK_MACRO_FLAG);
exit(1);
