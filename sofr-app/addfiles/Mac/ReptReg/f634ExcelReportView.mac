/*
$Name:          f634ExcelReportView.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 634. Печатное представление отчета в Excel
*/

import ExcelReportView;

const ADD_ROW_DATA        = null;
const ADD_ROW_TOTAL       = 2;
const ADD_ROW_CAPITAL_TOP = 3;
const ADD_ROW_CAPITAL_BOT = 4;

class (TSignatureZone) TF634ExcelSignatureZone()
	initTSignatureZone();
	
	macro getBossName()
		return m_firstPersonName;
	end;
	
	macro getBookName()
		return m_secondPersonName;
	end;
	
	macro getExecutor()
		return m_executorName;
	end;
	
	macro getPhone()
		return m_executorPhoneNumber;
	end;
	
	macro getDate()
		return string(m_reportIssueDate : f );
	end;
end;


/**
 * Представление основной части отчета в Excel
 *
 * @since 28.06.2019
 * @version 6.20.031.058
 */
class (TBasePartExcelView) TF634Part1ExcelView(partName, tableName, printEngine, sheetNumber, report)
	private var m_report     = RcbApplication().currentReport;
	private var m_parameters = TParameters(m_report);
	private var m_currentReport = report;
	
	macro makeRowCSV(dataset, rowType)
		var datasetArray = RcbArray();
		if (dataset == null)
			addCellToCurRow(cell("Нет данных").setHorMerged(18).setRowHeight(1));
			addEmptyCellToCurRow(17);
		else
			if  (rowType == ADD_ROW_DATA       )
				addCellToCurRow(cell(dataset[0]));
				addCellToCurRow(cell(dataset[1]));
				addCellToCurRow(cell(strSubst(dataset[2] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[3] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[4] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[5] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[6] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[7] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[8] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[9] ,".",",")));
				addCellToCurRow(cell(strSubst(dataset[10],".",",")));
				addCellToCurRow(cell(strSubst(dataset[11],".",",")));
				addCellToCurRow(cell(strSubst(dataset[12],".",",")));
				addCellToCurRow(cell(strSubst(dataset[13],".",",")));
				addCellToCurRow(cell(ternary(dataset[14] == "X", "X", strSubst(string(double(dataset[14])/100),".",","))));
				addCellToCurRow(cell(ternary(dataset[15] == "X", "X", strSubst(string(double(dataset[15])/100),".",","))));
				addCellToCurRow(cell(ternary(dataset[16] == "X", "X", strSubst(string(double(dataset[16])/100),".",","))));
				addCellToCurRow(cell(ternary(dataset[17] == "X", "X", strSubst(string(double(dataset[17])/100),".",","))));
			
			elif(rowType == ADD_ROW_TOTAL      )
				addCellToCurRow(cell(dataset[0]));
		        addCellToCurRow(cell(dataset[1]).setHorMerged(11));
				addEmptyCellToCurRow(10);
		        addCellToCurRow(cell(strSubst(dataset[2],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[3],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[4],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[5],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[6],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[7],".",",")));
			
			elif(rowType == ADD_ROW_CAPITAL_TOP)
				addCellToCurRow(cell(dataset[0]).setHorMerged(6).setVerMerged(2));
				addEmptyCellToCurRow(5);
				addCellToCurRow(cell(dataset[1]).setHorMerged(6));
				addEmptyCellToCurRow(5);
  				addCellToCurRow(cell(strSubst(dataset[2],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[3],".",",")));
  				addCellToCurRow(cell(strSubst(string(double(dataset[4])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[5])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[6])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[7])/100),".",",")));
			
			elif(rowType == ADD_ROW_CAPITAL_BOT)
				addCellToCurRow(cell(dataset[0]).setHorMerged(6));
				addEmptyCellToCurRow(5);
				addCellToCurRow(cell(dataset[1]).setHorMerged(6));
				addEmptyCellToCurRow(5);
  				addCellToCurRow(cell(strSubst(dataset[2],".",",")));
  				addCellToCurRow(cell(strSubst(dataset[3],".",",")));
  				addCellToCurRow(cell(strSubst(string(double(dataset[4])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[5])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[6])/100),".",",")));
				addCellToCurRow(cell(strSubst(string(double(dataset[7])/100),".",",")));
		    end;		    
		end;         
	end;
	
	macro printTotalRow(dataset)
		printRow(dataset, ADD_ROW_TOTAL);                
	end;
	
	macro printCapitalRow(dataset, top)
		if(top)
			printRow(dataset, ADD_ROW_CAPITAL_TOP);
		else
			printRow(dataset, ADD_ROW_CAPITAL_BOT);
		end;
	end;
	

	private macro getPeriodicityString()
        private macro getPeriodicityName(kind)
            var nameKind;

            if (kind == RCB_PK_DAY)
                nameKind = "Суточная";
            elif (kind == RCB_PK_MONTH)
                nameKind = "Месячная";
            elif (kind == RCB_PK_QUARTER)
                nameKind = "Квартальная";
            else nameKind = "Период";
            end;

            return nameKind;
        end;

        var formPeriodicityAll = arrCreate(RCB_PK_PERIOD,
                                           RCB_PK_DAY,   RCB_PK_FIVE_DAYS,  RCB_PK_WEEK,        RCB_PK_TEN_DAYS,
                                           RCB_PK_MONTH, RCB_PK_QUARTER,    RCB_PK_HALFYEAR,    RCB_PK_YEAR);
        var sizePeriod = formPeriodicityAll.size;
        var formPeriodicityName = "";
        var i = 0;

        while (i < sizePeriod)
            if (formPeriodicityAll[i] == m_report.context.period.kind)
              formPeriodicityName = getPeriodicityName(formPeriodicityAll[i]);
              i = sizePeriod;
            end;
            i = i + 1;
        end;

        return formPeriodicityName;
    end;
	
	macro printHead(lendingAgencyCodeZone : Object, namesZone : Object)
		var date = string((m_currentReport.context.period.enddate/*m_parameters.getEndDate()*/ + 1):m:f);
        date = "\"" + SubStr(date, 1, 2) + "\"" + SubStr(date, 3);
        var period = "по состоянию на " + date;
	
		m_printEngine.SetValue_NameCell("okatoCode",   TLendingAgencyCodeZone().getOkato());
		m_printEngine.SetValue_NameCell("okpoCode",    strLpad(Код_ОКПО,8,"0"));
		m_printEngine.SetValue_NameCell("regNumber",   РегНомерБанка);
		m_printEngine.SetValue_NameCell("formName",    "ОТЧЕТ ОБ ОТКРЫТЫХ ВАЛЮТНЫХ ПОЗИЦИЯХ");
		m_printEngine.SetValue_NameCell("period",      period);
		m_printEngine.SetValue_NameCell("bankName",    TZone().party.rec.shortname);
		m_printEngine.SetValue_NameCell("address",     TNamesZone().getLendingAgencyPostalAdress());
		m_printEngine.SetValue_NameCell("okud",        "Код формы по ОКУД 0409634");
		m_printEngine.SetValue_NameCell("periodicity", getPeriodicityString());
	end;
	
	macro printSignature(signatureZone : Object)
		signatureZone = TF634ExcelSignatureZone();
		m_printEngine.SetValue_NameCell("boss",     signatureZone.getBossName());
		m_printEngine.SetValue_NameCell("book",     signatureZone.getBookName());
		m_printEngine.SetValue_NameCell("executor", signatureZone.getExecutor());
		m_printEngine.SetValue_NameCell("phone",    signatureZone.getPhone());
		m_printEngine.SetValue_NameCell("date",     signatureZone.getDate());
	end;
	
	private macro constructorTF634Part1ExcelView(partName, tableName, printEngine, sheetNumber, report)
		initTBasePartExcelView(partName, tableName, printEngine, sheetNumber);
	end;
	constructorTF634Part1ExcelView(partName, tableName, printEngine, sheetNumber, report);
end;


/**
 * Представление раздела справочно отчета в Excel
 *
 * @since 28.06.2019
 * @version 6.20.031.058
 */
class (TBasePartExcelView) TF634PartRefExcelView(partName, tableName, printEngine, sheetNumber)
	
	macro makeRowCSV(dataset)
		var datasetArray = RcbArray();
		if (dataset == null)
			addCellToCurRow(cell("Нет данных").setHorMerged(4).setRowHeight(1));
			addEmptyCellToCurRow(3);
		else
		    addCellToCurRow(cell(dataset[0]));
			addEmptyCellToCurRow();
			addCellToCurRow(cell(dataset[1]));
		end;
		                   
	end;
		
	macro printHead(lendingAgencyCodeZone : Object, namesZone : Object)
	end;
	
	macro printSignature(signatureZone : Object)
	end;
	
	private macro constructorTF634PartRefExcelView(partName, tableName, printEngine, sheetNumber)
		initTBasePartExcelView(partName, tableName, printEngine, sheetNumber);
	end;
	constructorTF634PartRefExcelView(partName, tableName, printEngine, sheetNumber);
end;


/**
 * Представление отчета в Excel
 *
 * @since 28.06.2019
 * @version 6.20.031.058
 */
class (TReportExcelView) TF634ReportExcelView(protocolView, report)
	private var m_currentReport;
	macro initializePartViews()
	   m_partViews[m_partViews.size] = TF634Part1ExcelView  ("Отчет", "part1_table", this, 1, m_currentReport);
		m_partViews[m_partViews.size] = TF634PartRefExcelView("Отчет", "ref_table",   this, 1);
	end;
	
	macro show()
		if (not m_protocolView.isEmpty())
            m_protocolView.show();
        end;
		
		var ext      : String;
		var filename : String;
        splitFile(TPrinterController("f634form").getReportFileName(), filename, ext);
		save(filename);
	end;
	
	private macro constructorTF634ReportExcelView(protocolView, report)
		m_currentReport = report;
		var templateName = "634" + "_tpl.xlsx";
		//На случай разного форматирования в нацвалюте и ед.измерения
		//if((rcbApplication().currentReport.multiplier != 1.0) OR (rcbApplication().currentReport.dimension != 0))
		//    templateName = "___" + "_tpl1000.xlsx";
		//end;
		initTReportExcelView(protocolView, templateName);
		protocolView.printHead();
	end;
	constructorTF634ReportExcelView(protocolView, report);
end;