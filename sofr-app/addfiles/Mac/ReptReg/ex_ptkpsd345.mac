/*
$Name: ex_ptkpsd345.mac
$Module: Регламентируемая отчетность
$Description: Форма 345. Контроллер экспорта данных отчета в АС ПСД.
*/

//import reptCBInter,logfile, lib_exp, Chk_regd;
import lib_lang;
import rcbCoreInter;
import RcbProtocolView;
import RcbPtkPsdView;

/*Экспортируемые данные*/
class exportData()
    /*
    codeStr - Дата отчета в формате ГГГГ.ММ.ГГ;
    curDate - Дата отчета в формате ДД.ММ.ГГГГ;
    F345_40803 - счет 40803;
    F345_40806 - счет 40806;
    F345_40809 - счет 40809;
    F345_40812 - счет 40812;
    F345_40813 - счет 40813;
    F345_40814 - счет 40814;
    F345_40815 - счет 40815;
    F345_40817 - счет 40817;
    F345_40818 - счет 40818;
    F345_40819 - счет 40819;
    F345_40820 - счет 40820;
    F345_423__ - счет 423;
    F345_426__ - счет 426;
    F345_47603 - счет 47603;
    F345_47605 - счет 47605;
    F345_522__ - счет 522;
    F345_52404 - счет 52404;
    F345_Itogo - Итого вкладов.
    */
    var codeStr;
    var curDate;
    var F345_40803;
    var F345_40806;
    var F345_40809;
    var F345_40812;
    var F345_40813;
    var F345_40814;
    var F345_40815;
    var F345_40817;
    var F345_40818;
    var F345_40819;
    var F345_40820;
    var F345_423__;
    var F345_426__;
    var F345_47603;
    var F345_47605;
    var F345_522__;
    var F345_52404;
    var F345_Itogo;
    
    var F345_S1;
    var F345_S100;
    var F345_S200;
    var F345_S400;
    var F345_S700;
    var F345_S1000;
    var F345_Обяз1;
    var F345_Обяз100;
    var F345_Обяз200;
    var F345_Обяз400;
    var F345_Обяз700;
    var F345_Обяз1000;
    
end;

/*Экспорт данных*/
class ExportPtkPsdPOperation()

    /* Текущий отчёт*/
    private var report = RcbApplication.currentReport;
    /*Текущее представление*/
    private var ptkPsdView;
        
    /*Инициализация представления*/
    private macro initPtkPsdView()
        ptkPsdView = TPtkPsdView("345", report.context.period.endDate+1);
        ptkPsdView.setOutputFile(false);
    end;

    /*Экспорт строк в файл*/
    private macro exportStringsIntoFile(expData)
        PtkPsdView.printRow("F345_1",expData.codeStr,"1",String(Date(expData.curDate):f));
        PtkPsdView.printRow("F345_1",expData.codeStr,"2",Int(nvl(expData.F345_40803,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"3",Int(nvl(expData.F345_40806,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"4",Int(nvl(expData.F345_40809,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"5",Int(nvl(expData.F345_40812,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"6",Int(nvl(expData.F345_40813,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"7",Int(nvl(expData.F345_40814,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"8",Int(nvl(expData.F345_40815,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"9",Int(nvl(expData.F345_40817,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"18",Int(nvl(expData.F345_40818,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"19",Int(nvl(expData.F345_40819,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"10",Int(nvl(expData.F345_40820,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"11",Int(nvl(expData.F345_423__,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"12",Int(nvl(expData.F345_426__,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"13",Int(nvl(expData.F345_47603,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"14",Int(nvl(expData.F345_47605,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"15",Int(nvl(expData.F345_522__,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"16",Int(nvl(expData.F345_52404,1)));
        PtkPsdView.printRow("F345_1",expData.codeStr,"17",Int(nvl(expData.F345_Itogo,1)));
        
    end;

    private macro exportStringsIntoFileSpr(expData)
        PtkPsdView.printRow("F345_SPR","str1","2",Int(nvl(expData.F345_S1,0)));
        PtkPsdView.printRow("F345_SPR","str1","3",Int(nvl(expData.F345_Обяз1,0)));
        PtkPsdView.printRow("F345_SPR","str2","2",Int(nvl(expData.F345_S100,0)));
        PtkPsdView.printRow("F345_SPR","str2","3",Int(nvl(expData.F345_Обяз100,0)));
        PtkPsdView.printRow("F345_SPR","str3","2",Int(nvl(expData.F345_S200,0)));
        PtkPsdView.printRow("F345_SPR","str3","3",Int(nvl(expData.F345_Обяз200,0)));
        PtkPsdView.printRow("F345_SPR","str4","2",Int(nvl(expData.F345_S400,0)));
        PtkPsdView.printRow("F345_SPR","str4","3",Int(nvl(expData.F345_Обяз400,0)));
        PtkPsdView.printRow("F345_SPR","str5","2",Int(nvl(expData.F345_S700,0)));
        PtkPsdView.printRow("F345_SPR","str5","3",Int(nvl(expData.F345_Обяз700,0)));
        PtkPsdView.printRow("F345_SPR","str6","2",Int(nvl(expData.F345_S1000,0)));
        PtkPsdView.printRow("F345_SPR","str6","3",Int(nvl(expData.F345_Обяз1000,0)));
    end;
    /*Получить дату отчёта в формате ГГГГММДД*/
    private macro getDateInFormatYYYYMMDD(cDate) 

        var dateInStringFormat;
        dateInStringFormat = StrSubst(String(Date(cDate):f),".","");
        return SubStr(dateInStringFormat,5,4) + SubStr(dateInStringFormat,3,2) + SubStr(dateInStringFormat,1,2);
    end;

    /*Данные по переменным на указанную дату*/
    private macro getExportDataMeans(curDate)
        
        private var expData = exportData();
        private var contextOnGivenDate = RcbReportContext(RcbPeriod(curDate, curDate),
                                                    report.context.departmentCode,
                                                    report.context.issueMode,
                                                    report.context.organizationStructure,
                                                    report.context.isSummaryMode);
        private var reportOnGivenDate = RcbApplication.objectFactory.createReport(report.form.id,
                                                                            contextOnGivenDate);


        private var curAttributeValue;

        expData.codeStr = getDateInFormatYYYYMMDD(curDate);
        expData.curDate = curDate;

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40803");
        expData.F345_40803 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
    
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40806");
        expData.F345_40806 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40809");
        expData.F345_40809 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40812");
        expData.F345_40812 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40813");
        expData.F345_40813 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40814");
        expData.F345_40814 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40815");
        expData.F345_40815 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40817");
        expData.F345_40817 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
    
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40818");
        expData.F345_40818 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40819");
        expData.F345_40819 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_40820");
        expData.F345_40820 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_423__");
        expData.F345_423__ = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_426__");
        expData.F345_426__ = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_47603");
        expData.F345_47603 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_47605");
        expData.F345_47605 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_522__");
        expData.F345_522__ = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_52404");
        expData.F345_52404 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_ИТОГО");
        expData.F345_Itogo = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        return expData;
    end;
    /*Данные по разделу справочно*/
    private macro getExportDataSpr()
        private var expData = exportData();
        private var contextOnGivenDate = RcbReportContext(RcbPeriod(report.context.period.beginDate, report.context.period.endDate),
                                                    report.context.departmentCode,
                                                    report.context.issueMode,
                                                    report.context.organizationStructure,
                                                    report.context.isSummaryMode);
        private var reportOnGivenDate = RcbApplication.objectFactory.createReport(report.form.id,
                                                                            contextOnGivenDate);

        private var curAttributeValue;

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S1");
        expData.F345_S1 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S100");
        expData.F345_S100 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S200");
        expData.F345_S200 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S400");
        expData.F345_S400 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S700");
        expData.F345_S700 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_S1000");
        expData.F345_S1000 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);

        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз1");
        expData.F345_Обяз1 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз100");
        expData.F345_Обяз100 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз200");
        expData.F345_Обяз200 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз400");
        expData.F345_Обяз400 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз700");
        expData.F345_Обяз700 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);
        curAttributeValue = reportOnGivenDate.attributeValue("Ф345_Обяз1000");
        expData.F345_Обяз1000 = ternary(curAttributeValue.isDefined, curAttributeValue.currentAsString,0);


        return expData;
    end;
    /*Запись в файл экспорта*/
    private macro fillExportFile()
        

        initPtkPsdView();

        /*Текущие эспортируемые данные*/
        var currentExportData = exportData();

        /*Дата взятия значений*/
        var currentDate = report.context.period.beginDate;

        while (currentDate <= report.context.period.endDate)
            currentExportData = getExportDataMeans(currentDate);
            exportStringsIntoFile(currentExportData);  
            currentDate = currentDate + 1;
        end;                 
        
        currentExportData = getExportDataSpr();
        exportStringsIntoFileSpr(currentExportData);
    end;

    /*Протокол экспорта в АС ПСД*/
    private macro getProtocolView()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");
    
        protocolView.setProtocolOutput();
        protocolView.printHead();
            
        protocolView.printLine("Выгружено строк: " + ptkPsdView.getRowsCount());
        protocolView.printLine("   Количество содержательных строк: " + ptkPsdView.getRowsCount());
        protocolView.printLine("   Количество служебных строк: " + "0");
        protocolView.printLine("Файл экспорта: " + ptkPsdView.getFileName());
        protocolView.resetProtocolOutput();
        showProtocol();

    end;
    /*Выполнение экспорта*/
    macro execute()
        fillExportFile();
        getProtocolView();
    end;

end;

var exportPtkPsd = ExportPtkPsdPOperation();
exportPtkPsd.execute();
установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);









