/*
$Name: exp_f302kliko.mac
$Module: Регламентированная отчетность
$Description:  Экспорт в kliko.exe данных отчета. Форма 302
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Экспорт в kliko.exe данных отчета. Форма 302

   CREATED : 22.01.08 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/**
 *  Общебанковские интеры и модули
 */

/**
 *  Интеры и модели подсистемы
 */
import RcbCoreInter;
import RcbProtocolView;
import RcbKlikoView;
import rcbconst;

class (TRcbKlikoView) F302KlikoView(fileExtension : String, reportDate : Date)
    private macro constructorTF302PartKlikoView(fileExtension, reportDate)
        initTRcbKlikoView(fileExtension, reportDate);

        var day;
        var month;
        var year;

        dateSplit(m_reportDate + 1, day, month, year);

        m_name = получитьКаталогЭкспорта() + "\\" + strLpad(String(day),   2, "0")
                                                  + strLpad(String(month), 2, "0")
                                                  + String(year)
                                                  + "Kliko"
                                                  + "." + m_fileExtension;
    end;

    constructorTF302PartKlikoView(fileExtension, reportDate);
end;

/***************************************************************************************************
 *  Класс для сортировки итератора по значениям переменной раздела
 **************************************************************************************************/
private class TSorter
    /*
     * Количество символов в группе (между разделителями)
     */
    const m_amountNumberInGroup = 2;

    /*
     * Поиск количества вхождений символа symbol в строку str
     */
    private macro findSymbolStr(str : String, symbol : String)
        var lenStr = strLen(str);
        var i = 1;
        var res = 0;
        while(i <= lenStr)
            if(subStr(str, i, 1) == symbol)
                res = res + 1;
            end;
        i = i + 1;
        end;
        return res;
    end;

    /*
     * Нормализация строки: строка разбивается на группы по разделителю
     * Каждая группа дополняется символом "0" слева до длины countNumberInGroup
     * Возвращает строку, собранную уже из коректных групп без разделителя
     */
    private macro correctRowNumber(rowNumber : String, amountGroup : Integer)
        var i;
        var arr = TArray;
        arr = strCut(rowNumber, ".");
        i = 0;
        while(i < amountGroup)
            if(valType(arr[i]) == V_UNDEF)
                arr[i] = "";
            end;
            arr[i] = strLpad(arr[i], m_amountNumberInGroup, "0");
            i = i + 1;
        end;
        return strAssemble(arr);
    end;

    /*
     * Функция сравнения строк
     * amountGroup - количество групп для сравнения строк
     */
    private macro compareStr(rowNumber1 : String, rowNumber2 : String)
        var amountGroupInRowNumber1 = findSymbolStr(rowNumber1, ".") + 1;
        var amountGroupInRowNumber2 = findSymbolStr(rowNumber2, ".") + 1;
        var amountGroup             = ternary(amountGroupInRowNumber1 > amountGroupInRowNumber2, amountGroupInRowNumber1, amountGroupInRowNumber2);

        return correctRowNumber(rowNumber1, amountGroup) < correctRowNumber(rowNumber2, amountGroup)
    end;

    /*
     * Функция сортировки
     */
    macro isLess(v1, v2)
        return (   v1.fieldValue("okatoCode").currentAsString < v2.fieldValue("okatoCode").currentAsString)
                or (    (v1.fieldValue("okatoCode").currentAsString == v2.fieldValue("okatoCode").currentAsString)
                    and (compareStr(v1.fieldValue("row").currentAsString, v2.fieldValue("row").currentAsString)));
    end;
end;

/***************************************************************************************************
 *  Класс строки экспорта
 **************************************************************************************************/
private class TRow(id : Integer, code : String, description : String)
    private var m_valuesList  : TArray  = TArray();
    private var m_id          : Integer = id;
    private var m_code        : String  = code;
    private var m_description : String  = description;

    /* Количество строк, определяемых при инициализации массива m_valuesList
       Необходимо во избежание роста размера массива, когда в отчете участвует несколько кодов ОКАТО.
       (При повторном добавлении значений из переменных в массив, значения добавлялись в конец массива.
       В экспорт попада строка с предыдущими значениями и присоединенными к ним новыми значениями)
    */
    private var m_number : Integer = 2;

    private macro initialize()
        m_valuesList[m_valuesList.size] = m_code;
        m_valuesList[m_valuesList.size] = m_description;
    end;

    macro getNum()
        return m_number;
    end;

    macro addValue(value : String)
        m_valuesList[m_valuesList.size] = value;
    end;

    macro setSize()
        m_valuesList.size = m_number;
    end;

    macro getSize()
        return m_valuesList.size;
    end;

    macro getValuesList() : TArray
        return m_valuesList;
    end;

    macro getId()
        return m_id;
    end;

    macro getCode() : String
        return m_code;
    end;

    macro getDescription() : String
        return m_description;
    end;

    initialize();
end;

/***************************************************************************************************
 *  Базовый класс экспорта
 **************************************************************************************************/
private class TExporter()
    private var m_report    : RcbReport     = RcbApplication.currentReport;
    private var m_klikoView : TRcbKlikoView = null;
    private var m_rowsList  : TArray        = TArray();

    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);
    end;

    private macro getRow(rowCode : String) : TRow
        var i : Integer = 0;
        while (i < m_rowsList.size)
            if (m_rowsList[i].getCode() == rowCode)
                return m_rowsList[i];
            end;
            i = i + 1;
        end;

        return null;
    end;

    macro getFileName()
        return m_klikoView.getFileName();
    end;

    macro getRowsCount()
        return m_klikoView.getRowsCount();
    end;

    macro execute()
    end;

    initialize();
end;

/***************************************************************************************************
 *  Класс экспорта первого раздела
 **************************************************************************************************/
private class (TExporter) TPart1Exporter()
    private macro initialize()
        initialize();

        m_rowsList[m_rowsList.size] = TRow(1,  "1","Предоставлено кредитов - всего, в том числе:");
        m_rowsList[m_rowsList.size] = TRow(1,  "2","Юридическим лицам и индивидуальным предпринимателям (стр.2.1+2.2), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(2,  "2.1","по видам экономической деятельности:");
        m_rowsList[m_rowsList.size] = TRow(3,  "2.1.1","добыча полезных ископаемых, из них:");
        m_rowsList[m_rowsList.size] = TRow(4,  "2.1.1.1","добыча топливно-энергетических полезных ископаемых");
        m_rowsList[m_rowsList.size] = TRow(5,  "2.1.2","обрабатывающие производства");
        m_rowsList[m_rowsList.size] = TRow(6,  "2.1.3","производство и распределение электроэнергии, газа и воды");
        m_rowsList[m_rowsList.size] = TRow(7,  "2.1.4","сельское хозяйство, охота и лесное хозяйство");
        m_rowsList[m_rowsList.size] = TRow(8,  "2.1.5","строительство");
        m_rowsList[m_rowsList.size] = TRow(9,  "2.1.6","транспорт и связь");
        m_rowsList[m_rowsList.size] = TRow(10, "2.1.7","оптовая и розничная торговля; ремонт автотранспортных средств, мотоциклов, бытовых изделий и предметов личного пользования");
        m_rowsList[m_rowsList.size] = TRow(11, "2.1.8","операции с недвижимым имуществом, аренда и предоставление услуг");
        m_rowsList[m_rowsList.size] = TRow(12, "2.1.9","прочие виды деятельности");
        m_rowsList[m_rowsList.size] = TRow(13, "2.2","на завершение расчетов");
        m_rowsList[m_rowsList.size] = TRow(14, "2.3","из общей величины кредитов, предоставленных юр.лицам и инд.предпринимателям, кредиты субъектам малого и среднего предпринимательства, из них");
        m_rowsList[m_rowsList.size] = TRow(15, "2.3.1","индивидуальным предпринимателям");
        m_rowsList[m_rowsList.size] = TRow(16, "3","Физическим лицам");
        m_rowsList[m_rowsList.size] = TRow(17, "4","Справочно: Предоставлено кредитов операционными офисами");
    end;

    private macro processNullRow(row : TRow, okatoCode : String)
        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(ternary(row.getCode() == "2", okatoCode, ""));
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue(ternary(row.getCode() == "1", "1", "2"));
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro processRow(compositeValue : RcbCompositeValue)
        var row = getRow(compositeValue.fieldValue("row").currentAsString);

        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(ternary(row.getCode() == "2", compositeValue.fieldValue("okatoCode").currentAsString, ""));
        row.addValue(compositeValue.fieldValue("roubleSum").currentAsString);
        row.addValue(compositeValue.fieldValue("currencySum").currentAsString);
        row.addValue(compositeValue.fieldValue("roubleDebt").currentAsString);
        row.addValue(compositeValue.fieldValue("currencyDebt").currentAsString);
        row.addValue(compositeValue.fieldValue("roubleDelayedDebt").currentAsString);
        row.addValue(compositeValue.fieldValue("currencyDelayedDebt").currentAsString);
        row.addValue(ternary(row.getCode() == "1", "1", "2"));
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro isNullData(compositeValue)
        if(   (compositeValue.fieldValue("roubleSum").scaled           != 0)
           or (compositeValue.fieldValue("currencySum").scaled         != 0)
           or (compositeValue.fieldValue("roubleDebt").scaled          != 0)
           or (compositeValue.fieldValue("currencyDebt").scaled        != 0)
           or (compositeValue.fieldValue("roubleDelayedDebt").scaled   != 0)
           or (compositeValue.fieldValue("currencyDelayedDebt").scaled != 0))
            return false;
        else
            return true;
        end;
    end;

    private macro processOkato(compositeValue : RcbCompositeValue)
        var i                  = 1;
        var iterator           = compositeValue.createValueIterator();

        iterator.setSortOrder(TSorter());

        iterator.moveFirst();
        while (not iterator.isDone())

            compositeValue = iterator.currentItem;
            /*size - 1, т.к. печать строки 4 происходит вне данного метода*/
            while ((i < m_rowsList.size - 1) and (m_rowsList[i].getCode() != compositeValue.fieldValue("row").currentAsString))
                processNullRow(m_rowsList[i], compositeValue.fieldValue("okatoCode").currentAsString);
                i = i + 1;
            end;

            processRow(compositeValue);

            i = i + 1;
            iterator.moveNext();
        end;

        while (i < m_rowsList.size)
            processNullRow(m_rowsList[i], compositeValue.fieldValue("okatoCode").currentAsString);
            i = i + 1;
        end;
    end;

    macro execute()
        m_klikoView.setOutputFile();
        m_klikoView.printHead("F302");
        var keyValue;
        var row4Attribute;

        var iterator = m_report.attributeValue("Раздел1").createValueIterator();
        iterator.moveFirst();

        if (not iterator.isDone())
            if (not isNullData(iterator.currentItem()))
                processRow(iterator.currentItem());

                iterator = iterator.currentItem().createValueIterator();

                iterator.setSortOrder(TSorter());
                iterator.moveFirst();
                while (not iterator.isDone())
                    if (   (not isNullData(iterator.currentItem()))
                        or ((row4Attribute != null) and (not isNullData(row4Attribute))))
                        processOkato(iterator.currentItem());
                    end;
                    iterator.moveNext();
                end;
            end;
        end;

        m_klikoView.resetOutputFile();
    end;

    initTExporter();
end;

/***************************************************************************************************
 *  Класс экспорта первого раздела
 **************************************************************************************************/
private class (TPart1Exporter) TPart1Exporter2183()
    private macro initialize()

        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1,  "1","Предоставлено кредитов - всего, в том числе:");
        m_rowsList[m_rowsList.size] = TRow(1,  "2","Юридическим лицам и индивидуальным предпринимателям (стр.2.1+2.2), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(2,  "2.1","по видам экономической деятельности:");
        m_rowsList[m_rowsList.size] = TRow(3,  "2.1.1","добыча полезных ископаемых, из них:");
        m_rowsList[m_rowsList.size] = TRow(4,  "2.1.1.1","добыча топливно-энергетических полезных ископаемых");
        m_rowsList[m_rowsList.size] = TRow(5,  "2.1.2","обрабатывающие производства, из них:");
        m_rowsList[m_rowsList.size] = TRow(6,  "2.1.2.1","производство пищевых продуктов, включая напитки, и табака");
        m_rowsList[m_rowsList.size] = TRow(7,  "2.1.2.2","обработка древесины и производство изделий из дерева");
        m_rowsList[m_rowsList.size] = TRow(8,  "2.1.2.3","целлюлозно-бумажное производство; издательская и полиграфическая деятельность");
        m_rowsList[m_rowsList.size] = TRow(9,  "2.1.2.4","производство кокса, нефтепродуктов и ядерных материалов");
        m_rowsList[m_rowsList.size] = TRow(10, "2.1.2.5","химическое производство");
        m_rowsList[m_rowsList.size] = TRow(11, "2.1.2.6","производство прочих неметаллических минеральных продуктов");
        m_rowsList[m_rowsList.size] = TRow(12, "2.1.2.7","металлургическое производство и производство готовых металлических изделий");
        m_rowsList[m_rowsList.size] = TRow(13, "2.1.2.8","производство машин и оборудования, в том числе:");
        m_rowsList[m_rowsList.size] = TRow(14, "2.1.2.8.1","производство машин и оборудования для сельского и лесного хозяйства");
        m_rowsList[m_rowsList.size] = TRow(15, "2.1.2.9","производство транспортных средств и оборудования, в том числе:");
        m_rowsList[m_rowsList.size] = TRow(16, "2.1.2.9.1","производство автомобилей");
        m_rowsList[m_rowsList.size] = TRow(17, "2.1.3","производство и распределение электроэнергии, газа и воды");
        m_rowsList[m_rowsList.size] = TRow(18, "2.1.4","сельское хозяйство, охота и лесное хозяйство, в том числе:");
        m_rowsList[m_rowsList.size] = TRow(19, "2.1.4.1","сельское хозяйство, охота и предоставление услуг в этих областях");
        m_rowsList[m_rowsList.size] = TRow(20, "2.1.5","строительство, из них:");
        m_rowsList[m_rowsList.size] = TRow(21, "2.1.5.1","строительство зданий и сооружений");
        m_rowsList[m_rowsList.size] = TRow(22, "2.1.6","транспорт и связь, из них:");
        m_rowsList[m_rowsList.size] = TRow(23, "2.1.6.1","деятельность воздушного транспорта, подчиняющегося и не подчиняющегося расписанию");
        m_rowsList[m_rowsList.size] = TRow(24, "2.1.7","оптовая и розничная торговля; ремонт автотранспортных средств, мотоциклов, бытовых изделий и предметов личного пользования");
        m_rowsList[m_rowsList.size] = TRow(25, "2.1.8","операции с недвижимым имуществом, аренда и предоставление услуг");
        m_rowsList[m_rowsList.size] = TRow(26, "2.1.9","прочие виды деятельности");
        m_rowsList[m_rowsList.size] = TRow(27, "2.2","на завершение расчетов");
        m_rowsList[m_rowsList.size] = TRow(28, "2.3","из общей величины кредитов, предоставленных юр.лицам и инд.предпринимателям, кредиты субъектам малого и среднего предпринимательства, из них");
        m_rowsList[m_rowsList.size] = TRow(29, "2.3.1","индивидуальным предпринимателям");
        m_rowsList[m_rowsList.size] = TRow(30, "3","Физическим лицам");
        m_rowsList[m_rowsList.size] = TRow(31, "4","Справочно: Предоставлено кредитов операционными офисами");
    end;
    initTPart1Exporter;
end;

/***************************************************************************************************
 *  Класс экспорта первого раздела
 **************************************************************************************************/
private class (TPart1Exporter2183) TPart1Exporter2332()
    private macro initialize()

        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1,  "1","Предоставлено кредитов - всего (стр.2+стр.3), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(1,  "2","Юридическим лицам и индивидуальным предпринимателям (стр.2.1+2.2), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(2,  "2.1","по видам экономической деятельности:");
        m_rowsList[m_rowsList.size] = TRow(3,  "2.1.1","добыча полезных ископаемых, из них:");
        m_rowsList[m_rowsList.size] = TRow(4,  "2.1.1.1","добыча топливно-энергетических полезных ископаемых");
        m_rowsList[m_rowsList.size] = TRow(5,  "2.1.2","обрабатывающие производства, из них:");
        m_rowsList[m_rowsList.size] = TRow(6,  "2.1.2.1","производство пищевых продуктов, включая напитки, и табака");
        m_rowsList[m_rowsList.size] = TRow(7,  "2.1.2.2","обработка древесины и производство изделий из дерева");
        m_rowsList[m_rowsList.size] = TRow(8,  "2.1.2.3","целлюлозно-бумажное производство, издательская и полиграфическая деятельность");
        m_rowsList[m_rowsList.size] = TRow(9,  "2.1.2.4","производство кокса, нефтепродуктов и ядерных материалов");
        m_rowsList[m_rowsList.size] = TRow(10, "2.1.2.5","химическое производство");
        m_rowsList[m_rowsList.size] = TRow(11, "2.1.2.6","производство прочих неметаллических минеральных продуктов");
        m_rowsList[m_rowsList.size] = TRow(12, "2.1.2.7","металлургическое производство и производство готовых металлических изделий");
        m_rowsList[m_rowsList.size] = TRow(13, "2.1.2.8","производство машин и оборудования, из них:");
        m_rowsList[m_rowsList.size] = TRow(14, "2.1.2.8.1","производство машин и оборудования для сельского и лесного хозяйства");
        m_rowsList[m_rowsList.size] = TRow(15, "2.1.2.9","производство транспортных средств и оборудования, из них:");
        m_rowsList[m_rowsList.size] = TRow(16, "2.1.2.9.1","производство автомобилей");
        m_rowsList[m_rowsList.size] = TRow(17, "2.1.3","производство и распределение электроэнергии, газа и воды");
        m_rowsList[m_rowsList.size] = TRow(18, "2.1.4","сельское хозяйство, охота и лесное хозяйство, из них:");
        m_rowsList[m_rowsList.size] = TRow(19, "2.1.4.1","сельское хозяйство, охота и предоставление услуг в этих областях");
        m_rowsList[m_rowsList.size] = TRow(20, "2.1.5","строительство, из них:");
        m_rowsList[m_rowsList.size] = TRow(21, "2.1.5.1","строительство зданий и сооружений");
        m_rowsList[m_rowsList.size] = TRow(22, "2.1.6","транспорт и связь, из них:");
        m_rowsList[m_rowsList.size] = TRow(23, "2.1.6.1","деятельность воздушного транспорта, подчиняющегося и не подчиняющегося расписанию");
        m_rowsList[m_rowsList.size] = TRow(24, "2.1.7","оптовая и розничная торговля, ремонт автотранспортных средств, мотоциклов, бытовых изделий и предметов личного пользования");
        m_rowsList[m_rowsList.size] = TRow(25, "2.1.8","операции с недвижимым имуществом, аренда и предоставление услуг");
        m_rowsList[m_rowsList.size] = TRow(26, "2.1.9","прочие виды деятельности");
        m_rowsList[m_rowsList.size] = TRow(27, "2.2","на завершение расчетов");
        m_rowsList[m_rowsList.size] = TRow(28, "2.3","из общей величины кредитов, предоставленных юр.лицам и инд.предпринимателям, кредиты субъектам малого и среднего предпринимательства, из них:");
        m_rowsList[m_rowsList.size] = TRow(29, "2.3.1","индивидуальным предпринимателям");
        m_rowsList[m_rowsList.size] = TRow(30, "3","Физическим лицам");
        m_rowsList[m_rowsList.size] = TRow(31, "4","Справочно: Предоставлено кредитов операционными офисами");
    end;
    initTPart1Exporter2183;
end;

/**
 * Класс экспорта первого раздела отчета в соответствии с 2470-У
 *
 * @since v.6.20.029.153
 * @version 1.0
 * @author ABP
 */
private class (TPart1Exporter2332) TPart1Exporter2470()
    private macro constructorTPart1Exporter2470()
        initTPart1Exporter2332();
    end;

    constructorTPart1Exporter2470();
end;

/**
 * Класс экспорта первого раздела отчета в соответствии с 2742-У
 *
 * @since v.6.20.030.050
 * @version 1.0
 * @author ABP
 */
private class (TPart1Exporter2470) TPart1Exporter2742()
    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1,  "1","Предоставлено кредитов - всего (стр.2+стр.3), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(1,  "2","Юридическим лицам и индивидуальным предпринимателям (стр.2.1+2.2), в том числе:");
        m_rowsList[m_rowsList.size] = TRow(2,  "2.1","по видам экономической деятельности:");
        m_rowsList[m_rowsList.size] = TRow(3,  "2.1.1","добыча полезных ископаемых, из них:");
        m_rowsList[m_rowsList.size] = TRow(4,  "2.1.1.1","добыча топливно-энергетических полезных ископаемых");
        m_rowsList[m_rowsList.size] = TRow(5,  "2.1.2","обрабатывающие производства, из них:");
        m_rowsList[m_rowsList.size] = TRow(6,  "2.1.2.1","производство пищевых продуктов, включая напитки, и табака");
        m_rowsList[m_rowsList.size] = TRow(7,  "2.1.2.2","обработка древесины и производство изделий из дерева");
        m_rowsList[m_rowsList.size] = TRow(8,  "2.1.2.3","целлюлозно-бумажное производство, издательская и полиграфическая деятельность");
        m_rowsList[m_rowsList.size] = TRow(9,  "2.1.2.4","производство кокса, нефтепродуктов и ядерных материалов");
        m_rowsList[m_rowsList.size] = TRow(10, "2.1.2.5","химическое производство");
        m_rowsList[m_rowsList.size] = TRow(11, "2.1.2.6","производство прочих неметаллических минеральных продуктов");
        m_rowsList[m_rowsList.size] = TRow(12, "2.1.2.7","металлургическое производство и производство готовых металлических изделий");
        m_rowsList[m_rowsList.size] = TRow(13, "2.1.2.8","производство машин и оборудования, из них:");
        m_rowsList[m_rowsList.size] = TRow(14, "2.1.2.8.1","производство машин и оборудования для сельского и лесного хозяйства");
        m_rowsList[m_rowsList.size] = TRow(15, "2.1.2.9","производство транспортных средств и оборудования, из них:");
        m_rowsList[m_rowsList.size] = TRow(16, "2.1.2.9.1","производство автомобилей");
        m_rowsList[m_rowsList.size] = TRow(17, "2.1.3","производство и распределение электроэнергии, газа и воды");
        m_rowsList[m_rowsList.size] = TRow(18, "2.1.4","сельское хозяйство, охота и лесное хозяйство, из них:");
        m_rowsList[m_rowsList.size] = TRow(19, "2.1.4.1","сельское хозяйство, охота и предоставление услуг в этих областях");
        m_rowsList[m_rowsList.size] = TRow(20, "2.1.5","строительство, из них:");
        m_rowsList[m_rowsList.size] = TRow(21, "2.1.5.1","строительство зданий и сооружений");
        m_rowsList[m_rowsList.size] = TRow(22, "2.1.6","транспорт и связь, из них:");
        m_rowsList[m_rowsList.size] = TRow(23, "2.1.6.1","деятельность воздушного транспорта, подчиняющегося и не подчиняющегося расписанию");
        m_rowsList[m_rowsList.size] = TRow(24, "2.1.7","оптовая и розничная торговля, ремонт автотранспортных средств, мотоциклов, бытовых изделий и предметов личного пользования");
        m_rowsList[m_rowsList.size] = TRow(25, "2.1.8","операции с недвижимым имуществом, аренда и предоставление услуг");
        m_rowsList[m_rowsList.size] = TRow(26, "2.1.9","прочие виды деятельности");
        m_rowsList[m_rowsList.size] = TRow(27, "2.2","на завершение расчетов");
        m_rowsList[m_rowsList.size] = TRow(28, "2.3","из общей величины кредитов, предоставленных юр.лицам и инд.предпринимателям, кредиты субъектам малого и среднего предпринимательства, из них:");
        m_rowsList[m_rowsList.size] = TRow(29, "2.3.1","индивидуальным предпринимателям");
        m_rowsList[m_rowsList.size] = TRow(30, "3","Физическим лицам");
    end;

    private macro constructorTPart1Exporter2742()
        initTPart1Exporter2470();
    end;

    constructorTPart1Exporter2742();
end;

/***************************************************************************************************
 *  Класс экспорта второго раздела
 **************************************************************************************************/
private class (TExporter) TPart2Exporter()
    private macro initialize()
        initialize();

        m_rowsList[m_rowsList.size] = TRow(1, "1","Средства клиентов (некредитных организаций)");
        m_rowsList[m_rowsList.size] = TRow(2, "1.1","Депозиты юридических лиц");
        m_rowsList[m_rowsList.size] = TRow(3, "1.2","Вклады (депозиты) физических лиц");
    end;

    private macro processNullRow(row : TRow, okatoCode : String)
        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(ternary(row.getCode() == "1", okatoCode, ""));
        row.addValue("0");
        row.addValue("0");
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro processRow(compositeValue : RcbCompositeValue)
        var row = getRow(compositeValue.fieldValue("row").currentAsString);

        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(ternary(row.getCode() == "1", compositeValue.fieldValue("okatoCode").currentAsString, ""));
        row.addValue(compositeValue.fieldValue("rubObtainedFundsRest").currentAsString);
        row.addValue(compositeValue.fieldValue("curObtainedFundsRest").currentAsString);
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro processOkato(compositeValue : RcbCompositeValue)
        var i        = 0;
        var iterator = compositeValue.createValueIterator();

        iterator.setSortOrder(TSorter());

        iterator.moveFirst();
        while (not iterator.isDone())
            compositeValue = iterator.currentItem;
            while ((i < m_rowsList.size) and (m_rowsList[i].getCode() != compositeValue.fieldValue("row").currentAsString))
                processNullRow(m_rowsList[i], compositeValue.fieldValue("okatoCode").currentAsString);

                i = i + 1;
            end;

            processRow(compositeValue);

            i = i + 1;
            iterator.moveNext();
        end;

        while (i < m_rowsList.size)
            processNullRow(m_rowsList[i], compositeValue.fieldValue("okatoCode").currentAsString);

            i = i + 1;
        end;
    end;

    macro execute()
        m_klikoView.setOutputFile(true);
        m_klikoView.printHead("F302_2");

        var iterator = m_report.attributeValue("Раздел2").createValueIterator();
        iterator.moveFirst();

        while (not iterator.isDone())
            processOkato(iterator.currentItem());
            iterator.moveNext();
        end;

        m_klikoView.resetOutputFile();
    end;

    initTExporter();
end;

/***************************************************************************************************
 *  Класс экспорта второго раздела
 **************************************************************************************************/
private class (TPart2Exporter) TPart2Exporter2183()
    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1, "1","Средства на счетах юридических лиц и индивидуальных предпринимателей");
        m_rowsList[m_rowsList.size] = TRow(2, "1.1","Депозиты юридических лиц");
        m_rowsList[m_rowsList.size] = TRow(3, "1.2","Вклады (депозиты) физических лиц");
    end;
    initTPart2Exporter;
end;
/***************************************************************************************************
 *  Класс экспорта второго раздела
 **************************************************************************************************/
private class (TPart2Exporter2183) TPart2Exporter2332()
    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1, "1","Средства клиентов, не являющихся кредитными организациями, из них:");
        m_rowsList[m_rowsList.size] = TRow(2, "1.1","Депозиты юридических лиц");
        m_rowsList[m_rowsList.size] = TRow(3, "1.2","Вклады (депозиты) физических лиц");
    end;
    initTPart2Exporter2183;
end;

/**
 * Класс экспорта второго раздела отчета в соответствии с 2470-У
 *
 * @since v.6.20.029.153
 * @version 1.0
 * @author ABP
 */
private class (TPart2Exporter2332) TPart2Exporter2470()

    private macro constructorTPart2Exporter2470()
        initTPart2Exporter2332();
    end;

    constructorTPart2Exporter2470();
end;

/**
 * Класс экспорта второго раздела отчета в соответствии с 2742-У
 *
 * @since v.6.20.030.050
 * @version 1.0
 * @author ABP
 */
private class (TPart2Exporter2470) TPart2Exporter2742()

    private macro processNullRow(row : TRow, okatoCode : String)
        if (row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(okatoCode);
        row.addValue("0");
        row.addValue("0");
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro processRow(compositeValue : RcbCompositeValue)
        var row = getRow(compositeValue.fieldValue("row").currentAsString);

        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(compositeValue.fieldValue("okatoCode").currentAsString);
        row.addValue(compositeValue.fieldValue("rubObtainedFundsRest").currentAsString);
        row.addValue(compositeValue.fieldValue("curObtainedFundsRest").currentAsString);
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1, "1","Средства клиентов, не являющихся кредитными организациями, из них:");
        m_rowsList[m_rowsList.size] = TRow(2, "1.1","Средства федерального бюджета");
        m_rowsList[m_rowsList.size] = TRow(3, "1.2","Средства бюджетов субъектов Российской Федерации и местных бюджетов");
        m_rowsList[m_rowsList.size] = TRow(4, "1.3","Прочие бюджетные средства");
        m_rowsList[m_rowsList.size] = TRow(5, "1.4","Средства внебюджетных фондов");
        m_rowsList[m_rowsList.size] = TRow(6, "1.5","Средства на счетах государственных организаций");
        m_rowsList[m_rowsList.size] = TRow(7, "1.6","Средства на счетах негосударственных организаций");
        m_rowsList[m_rowsList.size] = TRow(8, "1.7","Депозиты юридических лиц");
        m_rowsList[m_rowsList.size] = TRow(9, "1.8","Вклады (депозиты) физических лиц");
    end;

    private macro constructorTPart2Exporter2742()
        initTPart2Exporter2470();
    end;

    constructorTPart2Exporter2742();
end;

/**
 * Класс экспорта второго раздела отчета в соответствии с 2926-У
 *
 * @since v.6.20.030.057
 * @version 1.0
 * @author GWW
 */
private class (TPart2Exporter2742) TPart2Exporter2926()

    private macro initialize()
        m_klikoView = F302KlikoView("302", RcbApplication.currentReport.context.period.endDate);

        m_rowsList[m_rowsList.size] = TRow(1, "1","Средства клиентов, не являющихся кредитными организациями, из них:");
        m_rowsList[m_rowsList.size] = TRow(2, "1.1","Средства федерального бюджета");
        m_rowsList[m_rowsList.size] = TRow(3, "1.2","Средства бюджетов субъектов Российской Федерации и местных бюджетов");
        m_rowsList[m_rowsList.size] = TRow(4, "1.3","Прочие бюджетные средства");
        m_rowsList[m_rowsList.size] = TRow(5, "1.4","Средства внебюджетных фондов");
        m_rowsList[m_rowsList.size] = TRow(6, "1.5","Средства на счетах государственных организаций");
        m_rowsList[m_rowsList.size] = TRow(7, "1.6","Средства на счетах негосударственных организаций");
        m_rowsList[m_rowsList.size] = TRow(8, "1.7","Средства индивидуальных предпринимателей");
        m_rowsList[m_rowsList.size] = TRow(9, "1.8","Депозиты юридических лиц");
        m_rowsList[m_rowsList.size] = TRow(10,"1.9","Вклады (депозиты) физических лиц");
    end;

    private macro constructorTPart2Exporter2926()
        initTPart2Exporter2742();
    end;

    constructorTPart2Exporter2926();
end;

private class (TPart2Exporter2926) TPart2Exporter4637()
    private macro processNullRow(row : TRow, okatoCode : String)
        if (row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(okatoCode);
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("0");
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro processRow(compositeValue : RcbCompositeValue)
        var row = getRow(compositeValue.fieldValue("row").currentAsString);

        if(row.getSize() != row.getNum())
            row.setSize();
        end;

        row.addValue(compositeValue.fieldValue("okatoCode").currentAsString);
        row.addValue(compositeValue.fieldValue("obtainedFundsRestTotal").currentAsString);
        row.addValue(compositeValue.fieldValue("obtainedFundsRest_643").currentAsString);
        row.addValue(compositeValue.fieldValue("obtainedFundsRest_840").currentAsString);
        row.addValue(compositeValue.fieldValue("obtainedFundsRest_978").currentAsString);
        row.addValue(compositeValue.fieldValue("obtainedFundsRest_156").currentAsString);
        row.addValue("1");
        row.addValue(row.getId());
        row.addValue("");

        m_klikoView.printRow(row.getValuesList());
    end;

    private macro constructorTPart2Exporter4637()
        initTPart2Exporter2926();
    end;

    constructorTPart2Exporter4637();
end;

/***************************************************************************************************
 *  Класс операции экспорта
 **************************************************************************************************/
private class TExportKlikoOperation()
    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter();
        var part2Exporter = TPart2Exporter();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));
    end;
end;

private class TExportKlikoOperation2183()
    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2183();
        var part2Exporter = TPart2Exporter2183();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));
    end;
end;

private class TExportKlikoOperation2332()
    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2332();
        var part2Exporter = TPart2Exporter2332();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));
    end;
end;

private class TExportKlikoOperation2470()
    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2470();
        var part2Exporter = TPart2Exporter2470();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));
    end;
end;

private class TExportKlikoOperation2742()
    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2742();
        var part2Exporter = TPart2Exporter2742();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));
    end;
end;

private class TExportKlikoOperation2926()
    private macro getDescriptorInfo()
        return "F301_26.PAK от 20.08.2014";
    end;

    macro execute()
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2742();
        var part2Exporter = TPart2Exporter2926();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;

private class (TExportKlikoOperation2926) TExportKlikoOperation_Т1_30_1_01_9946()
    private macro getDescriptorInfo()
        return "f302_32.PAK от 26.01.2017";
    end;
end;

private class (TExportKlikoOperation_Т1_30_1_01_9946) TExportKlikoOperation4637()
    private macro getDescriptorInfo()
        return "f302_39.PAK от 26.01.2018";
    end;

    macro execute()
        var m_protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В Kliko.exe");

        if (not rcbApplication().currentReport.isCalculated)
            m_protocolView.checkCalculateReport("kliko.exe");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;
    
        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        var part1Exporter = TPart1Exporter2742();
        var part2Exporter = TPart2Exporter4637();

        part1Exporter.execute();
        part2Exporter.execute();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + TPart1Exporter().getFileName());
        protocolView.printLine("Количество выгруженных записей: " + String(part1Exporter.getRowsCount() + part2Exporter.getRowsCount()));

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/

if   (RcbApplication.currentReport.context.period.endDate < RCB_I2183_DATE + 1)
    TExportKlikoOperation().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_I2332_DATE)
    TExportKlikoOperation2183().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_I2470_DATE2)
    TExportKlikoOperation2332().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_I2742_DATE)
    TExportKlikoOperation2470().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_I2926_DATE)
    TExportKlikoOperation2742().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_Т1_30_1_01_9946_DATE)
    TExportKlikoOperation2926().execute();
elif (RcbApplication.currentReport.context.period.endDate < RCB_I4637_DATE_F302)
    TExportKlikoOperation_Т1_30_1_01_9946().execute();
else
    TExportKlikoOperation4637().execute();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
