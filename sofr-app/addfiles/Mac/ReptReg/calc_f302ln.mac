/*
$Name:          calc_f302ln.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 302. Заполнение по данным Loans
*/

/* ──────────────────────────────────────────────────────────────────────────┐
    RS-Bank V6                                                 R-Style Softlab
    Файл подсистемы "Регламентированная отчетность"

    заполнение формы 302 по данным Loans

    CREATED : 28.08.07 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/*
*  Общебанковские интеры и модули
*/
import ReptCbInter;
import rcb_lib;
import cb_sql;
import lib_date;
import lib_lang;
import rcbimport;

/*
*  Интеры и модели подсистемы
*/
import rcb_bo;
import tReport;
import rcbconst;
import DepartmentFilter;
import sbCrdInter;

import testLib;

import com_f302n;
import RcbArTuneTable;

const PAYMENT   = 2; /*Тип операции выдача*/
const REPAYMENT = 3; /*Тип операции погашение*/
/*
private var profiler = TSQLProfiler(getTxtFileName("!calc_f302ln_sqlprof"));
profiler.clear();
profiler.on();
*/
/***************************************************************************************************
*  Класс последовательности (для задания автоинкремента)
**************************************************************************************************/
private class  TSequence(start)
    private var m_start = start;

    macro nextVal()
        m_start = m_start + 1;
        return m_start - 1;
    end;
end;

private var sequence = TSequence(1);
/***************************************************************************************************
*  Класс вставки во временную таблицу
**************************************************************************************************/
private class TInserter()
    private var m_processor : Object = NULL;
    private var m_inserter  : Object = TRsbDataSet("SELECT * FROM df302p1_tmp WHERE 1=0", RSDVAL_CLIENT, RSDVAL_STATIC);
    private var m_okatoCodes;

    private macro initOkatoCodes()
        var tuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        tuneTable.setInstructionFilter(RCB_I2332_DATE);

        m_okatoCodes = tuneTable.getDataSet();
    end;

    initOkatoCodes();

    /*Проверка является ли округ автономным округом.*/
    private macro checkRegion(okato)
        m_okatoCodes.moveFirst;
        m_okatoCodes.movePrev;

        while(m_okatoCodes.moveNext)
            if ((compareStrWithMasks(m_okatoCodes.okatoMasks, okato) == 0))
                return m_okatoCodes.okato;
            end;
        end;

        return null;
    end;

    macro insertRecord(row : String, column : Integer)
        if (m_processor.getRoubleSum(column) == $0)
            return;
        end;

        if ((column > "9") and (subStr(row, 1, 3) != "4.1"))
            return;
        end;

        var okatoCode;

        if (row == "4")
            okatoCode = m_processor.getDataSet().branchOkatoCode;
        else
            okatoCode = m_processor.getDataSet().okatoCode
        end;

        var additionalOkato = checkRegion(okatoCode);

        if(additionalOkato != null)

            m_inserter.addNew();
            m_inserter.okatoCode               = additionalOkato;
            m_inserter.row                 = row;
            m_inserter.column              = string(column);
            m_inserter.creditNumber        = m_processor.getDataSet().creditNumberForReport;
            m_inserter.creditDate          = m_processor.getDataSet().creditOpenDate;
            m_inserter.trancheKind         = m_processor.getDataSet().trancheKind;
            m_inserter.trancheNumber       = m_processor.getDataSet().trancheNumber;
            m_inserter.trancheIssueDate    = m_processor.getDataSet().trancheIssueDate;
            m_inserter.operationIssueDate  = Date(m_processor.getDataSet().operationIssueDate);
            m_inserter.currencyId          = m_processor.getDataSet().currencyId;
            m_inserter.roubleSum           = m_processor.getRoubleSum();
            m_inserter.clientCode          = m_processor.getDataSet().clientCode;
            m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
            m_inserter.currencySum         = m_processor.getSum();
            m_inserter.backOffice          = 2;
            m_inserter.branch              = m_processor.getDataSet().branchId;

            if (in(row, "4.1", "4.1.1"))
                m_inserter.term = CPeriod(m_processor.getDataSet().trancheIssueDate, m_processor.getDataSet().term).getMonths();
                m_inserter.initialInterestRate  = m_processor.getDataSet().initialInterestRate;
            elif (in(column, "4", "5") )
                m_inserter.operationId = m_processor.getDataSet().id;
            end;

            m_inserter.Update();
        end;

        m_inserter.addNew();
        if (okatoCode == "99999")
            m_inserter.okatoCode       = String(okatoCode);
        else
            m_inserter.okatoCode       = strRPad(subStr(String(okatoCode), 1, 2), 5, "0");
        end;
        m_inserter.row                 = row;
        m_inserter.column              = string(column);
        m_inserter.creditNumber        = m_processor.getDataSet().creditNumberForReport;
        m_inserter.creditDate          = m_processor.getDataSet().creditOpenDate;
        m_inserter.trancheKind         = m_processor.getDataSet().trancheKind;
        m_inserter.trancheNumber       = m_processor.getDataSet().trancheNumber;
        m_inserter.trancheIssueDate    = m_processor.getDataSet().trancheIssueDate;
        m_inserter.operationIssueDate  = Date(m_processor.getDataSet().operationIssueDate);
        m_inserter.currencyId          = m_processor.getDataSet().currencyId;
        m_inserter.roubleSum           = m_processor.getRoubleSum();
        m_inserter.clientCode          = m_processor.getDataSet().clientCode;
        m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
        m_inserter.currencySum         = m_processor.getSum();
        m_inserter.backOffice          = 2;
        m_inserter.branch              = m_processor.getDataSet().branchId;

        if (in(row, "4.1", "4.1.1"))
            m_inserter.term = CPeriod(m_processor.getDataSet().trancheIssueDate, m_processor.getDataSet().term).getMonths();
            m_inserter.initialInterestRate  = m_processor.getDataSet().initialInterestRate;
        elif (in(column, "4", "5") )
            m_inserter.operationId = m_processor.getDataSet().id;
        end;

        m_inserter.Update();
    end;

    macro initialize(processor : Object)
        m_processor = processor;
    end;
end;

/**
* Класс вставки во временную в соответствии с 2470-У
*
* @since v.6.20.029.153
* @version 1.0
* @author ABP
*/
private class (TInserter) TInserter2470()
    private macro initOkatoCodes()
        var tuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        tuneTable.setInstructionFilter(RCB_I2470_DATE2);

        m_okatoCodes = tuneTable.getDataSet();
    end;

    private macro constructorTInserter2470()
        initTInserter();
    end;

    constructorTInserter2470();
end;


/**
* Класс вставки во временную в соответствии с 2627-У
*
*/
private class (TInserter2470) TInserter2627()
    private macro constructorTInserter2627()
        initTInserter2470();
    end;

    constructorTInserter2627();
end;

/***************************************************************************************************
*  Базовый класс обработчика данных
**************************************************************************************************/
private class TProcessor(inserter : Object, dataSet:object)
    private var rowMasks      = TRsbDataSet("SELECT * FROM dt302_dbt WHERE t_part = 1 AND t_backOffice = 2", RSDVAL_CLIENT, RSDVAL_STATIC);
    private var m_dataSet     = dataSet;
    private var m_rowsArray   = TArray();
    private var m_columnArray = TArray();
    private var m_inserter    = inserter;

    macro initializeRowsArray()
        macro selectRowsForLegal()
            rowMasks.moveFirst();
            rowMasks.movePrev();
            m_rowsArray.size = 0;

            while(rowMasks.MoveNext())
                if (   (compareStrWithMasks(rowMasks.okvedMasks,   m_dataSet.okvedCode) == 0)
                    or (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.cbAccountNumber) == 0))
                    m_rowsArray[m_rowsArray.size] = rowMasks.row;
                end;
            end;

            if (m_rowsArray.size == 0)
                m_rowsArray[m_rowsArray.size] = "2.9";
            end;
        end;

        macro selectRowsForPhysical()
            m_rowsArray.size = 0;

            if (m_dataSet.clientType == RCB_JURIDICAL_PERSON_CREDIT)
                m_rowsArray[0] = "3";
            elif (m_dataSet.clientType == RCB_NATURAL_PERSON_CREDIT)
                m_rowsArray[0] = "4";

                if (index(m_dataSet.aim, "Ж") != 0)  /*на покупку жилья*/
                    m_rowsArray[m_rowsArray.size] = "4.1";
                end;

                if (index(m_dataSet.aim, "И") != 0)  /*ипотека*/
                    m_rowsArray[m_rowsArray.size] = "4.1.1";
                end;
            end;
        end;

        if (m_dataSet.isPhysical)
            selectRowsForPhysical();
        else
            selectRowsForLegal();
        end;
    end;

    private macro initializeColumnArray()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getSum()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getRoubleSum()
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getDataSet()
        return m_dataSet;
    end;

    macro getRowsArray()
        return m_rowsArray;
    end;

    macro getColumnArray()
        return m_columnArray;
    end;

    macro getInserter()
        return m_inserter;
    end;
end;
/***************************************************************************************************
*  Класс обработчика данных по 2055У
**************************************************************************************************/
private class (TProcessor)TProcessor2055 (inserter : Object, dataSet:object)
    private var m_accountMasks = TRsbDataSet("SELECT * FROM dt302_dbt WHERE t_part = 1 AND t_backOffice = 2 AND t_row = '2.2'", RSDVAL_CLIENT, RSDVAL_STATIC);
    macro isМСП(partyId)
        var reportDate = rcbApplication.currentReport.context.period.endDate;
        var isМСП = TRsbDataSet("SELECT 1"
                    "\n"+   "FROM   DUAL"
                    "\n"+   "WHERE  rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП',rcb_objattr.makePartyId(" + partyId + ")," + getSqlDate(reportDate) + ") >0");
        if(isМСП.MoveNext)
            return true;
        else
            return false;
        end;
    end;

    macro initializeRowsArray()
        macro selectRowsForLegal()
            rowMasks.moveFirst();
            rowMasks.movePrev();
            m_rowsArray.size = 0;

            if(m_dataSet.clientType == RCB_NATURAL_PERSON_CREDIT)
                m_rowsArray[m_rowsArray.size] = "3";
            end;

            while(rowMasks.MoveNext())
                if (    (m_dataSet.okvedCode != NULL)
                    and (   (compareStrWithMasks(rowMasks.okvedMasks,  m_dataSet.okvedCode) == 0)
                        or (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.cbAccountNumber) == 0)
                        )
                    and (   (m_dataSet.isPhysical == FALSE)
                        or (    (m_dataSet.isPhysical == TRUE)
                            and (m_dataSet.isEmployer == TRUE)
                            )
                        )
                    )
                    if(substr(rowMasks.row, 1, 3) == "2.1")
                        m_accountMasks.moveFirst();
                        if(compareStrWithMasks(m_accountMasks.accountMasks, m_dataSet.cbAccountNumber) == 1)
                            m_rowsArray[m_rowsArray.size] = rowMasks.row;
                        end;
                    elif((rowMasks.row == "2.2") and (m_dataSet.isPhysical == FALSE))
                        m_rowsArray[m_rowsArray.size] = rowMasks.row;
                    elif((rowMasks.row == "2.3") and isМСП(m_dataSet.contractorId))
                        m_rowsArray[m_rowsArray.size] = rowMasks.row;
                    elif((rowMasks.row == "2.3.1") and (m_dataSet.clientType == RCB_JURIDICAL_PERSON_CREDIT) and (m_dataSet.isEmployer == TRUE))
                        m_rowsArray[m_rowsArray.size] = rowMasks.row;
                    end;
                end;
            end;

            if (    (m_rowsArray.size == 0)
                and (   (m_dataSet.isPhysical == FALSE)
                    or (    (m_dataSet.isPhysical == TRUE)
                        and (m_dataSet.isEmployer == TRUE)
                        )
                    )
                )
                m_rowsArray[m_rowsArray.size] = "2.1.9";
            end;
        end;

        selectRowsForLegal();
    end;
    initTProcessor(inserter, dataSet);
end;

private class TRowArrayMember()
    var row : String;
    var column : Integer;
end;

/***************************************************************************************************
*  Класс обработчика данных по 2183У
**************************************************************************************************/
private class (TProcessor2055)TProcessor2183 (inserter : Object, dataSet:object, columns : String, alias : String, instructionDate)
    initTProcessor2055(inserter, dataSet);

    m_rowsArray   = RcbArray(TRowArrayMember());

    /*Название столбца масок л./с.*/
    private var m_alias = alias;

    rowMasks      =             TRsbDataSet("WITH balanceTuneTable AS (SELECT tune.*"
                        "\n"+                                  "FROM dt302balanceaccounts_dbt tune,"
                        "\n"+                                       "(SELECT t_part, t_row, t_columns, t_backoffice,"
                        "\n"+                                               "MAX (t_instructiondate) KEEP (DENSE_RANK FIRST ORDER BY t_part, t_row, t_columns, t_backoffice DESC) t_instructiondate"
                        "\n"+                                          "FROM dt302balanceaccounts_dbt"
                        "\n"+                                         "WHERE t_instructiondate <= " + getSqlDate(instructionDate)+
                        "\n"+                                      "GROUP BY t_part, t_row, t_columns, t_backoffice) tempTune"
                        "\n"+                                 "WHERE tune.t_part = tempTune.t_part"
                        "\n"+                                   "AND tune.t_row = tempTune.t_row"
                        "\n"+                                   "AND tune.t_columns = tempTune.t_columns"
                        "\n"+                                   "AND tune.t_backoffice = tempTune.t_backoffice"
                        "\n"+                                   "AND tune.t_instructiondate = tempTune.t_instructiondate"
                        "\n"+                              "ORDER BY t_sort)"
                        "\n"+             "SELECT *"
                        "\n"+               "FROM (SELECT okvedMasks_dbt.t_row,"
                        "\n"+                            "balanceAccounts_dbt.t_columns,"
                        "\n"+                            "okvedMasks_dbt.t_okvedmasks,"
                        "\n"+                            "balanceAccounts_dbt." + m_alias + " AS t_accountmasks,"
                        "\n"+                            "okvedMasks_dbt.t_sort"
                        "\n"+                       "FROM dt302OkvedMasks_dbt okvedMasks_dbt,"
                        "\n"+                            "( SELECT *"
                        "\n"+                                "FROM balanceTuneTable"
                        "\n"+                               "WHERE t_part = 1"
                        "\n"+                                 "AND t_row  =  '2.1.1* - 2.1.9*'"
                        "\n"+                                 "AND t_backoffice = 2) balanceAccounts_dbt"
                        "\n"+                      "UNION"
                        "\n"+                     "SELECT '2.1.9' as t_row,"
                        "\n"+                            "balanceTuneTable.t_columns,"
                        "\n"+                            "(SELECT SUBSTR(conStr(','||t_okvedmasks), 2)"
                        "\n"+                               "FROM dt302OkvedMasks_dbt) as t_okvedmasks,"
                        "\n"+                            "balanceTuneTable." + m_alias + " AS t_accountmasks,"
                        "\n"+                            "240  as t_sort"
                        "\n"+                       "FROM balanceTuneTable"
                        "\n"+                      "WHERE t_part = 1"
                        "\n"+                        "AND t_row  =  '2.1.1* - 2.1.9*'"
                        "\n"+                        "AND t_backoffice = 2"
                        "\n"+                      "UNION"
                        "\n"+                     "SELECT balanceTuneTable.t_row,"
                        "\n"+                            "balanceTuneTable.t_columns,"
                        "\n"+                            "'' as t_okvedmasks,"
                        "\n"+                            "balanceTuneTable." + m_alias + " AS t_accountmasks,"
                        "\n"+                            "250+balanceTuneTable.t_sort as t_sort"
                        "\n"+                       "FROM balanceTuneTable"
                        "\n"+                      "WHERE t_part = 1"
                        "\n"+                        "AND t_row  <>  '2.1.1* - 2.1.9*'"
                        "\n"+                        "AND t_backoffice = 2 ) tuneTable_dbt"
                        "\n"+              "WHERE " + ternary(strLen(columns) == 3, "t_columns = '" + columns + "'", "t_columns = '" + subStr(columns,1,3) + "' OR t_columns = '" + subStr(columns,5,3) + "'") +
                        "\n"+              "ORDER BY t_sort", RSDVAL_CLIENT, RSDVAL_STATIC);

    macro initializeRowsAndColumnArray()
        macro selectRowsForLegal()
            rowMasks.moveFirst();
            rowMasks.movePrev();
            m_rowsArray.size = 0;

            while(rowMasks.MoveNext())
                if (compareStrWithMasks(rowMasks.accountMasks, nvl(m_dataSet.cbAccountNumber,"")) == 0)
                    if((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okvedCode,"")) == 0))
                        m_rowsArray[m_rowsArray.size] = TRowArrayMember();
                        m_rowsArray[m_rowsArray.size - 1].row = rowMasks.row;
                        if (m_dataSet.currencyId == NATCUR)
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif ((rowMasks.row == "2.1.9") and ((m_dataSet.okvedCode == NULL) or (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okvedCode,"")) == 1)))
                        m_rowsArray[m_rowsArray.size] = TRowArrayMember();
                        m_rowsArray[m_rowsArray.size - 1].row = rowMasks.row;
                        if (m_dataSet.currencyId == NATCUR)
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif((rowMasks.row == "2.3") and (isМСП(m_dataSet.contractorId) or (m_dataSet.isPhysical and m_dataSet.isEmployer)))
                        m_rowsArray[m_rowsArray.size] = TRowArrayMember();
                        m_rowsArray[m_rowsArray.size - 1].row = rowMasks.row;
                        if (m_dataSet.currencyId == NATCUR)
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif ((rowMasks.row == "2.2") or (rowMasks.row == "2.3.1") or (rowMasks.row == "3"))
                        m_rowsArray[m_rowsArray.size] = TRowArrayMember();
                        m_rowsArray[m_rowsArray.size - 1].row = rowMasks.row;
                        if (m_dataSet.currencyId == NATCUR)
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif ((rowMasks.row == "4") and (m_dataSet.isOperOffice))
                        m_rowsArray[m_rowsArray.size] = TRowArrayMember();
                        m_rowsArray[m_rowsArray.size - 1].row = rowMasks.row;
                        if (m_dataSet.currencyId == NATCUR)
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[m_rowsArray.size - 1].column = int(substr(rowMasks.columns,3,1));
                        end;
                    end;
                end;
            end;
        end;

        selectRowsForLegal();
    end;
end;

/**
* Класс обработчика данных в соответствии с 2470-У
*
* @since v.6.20.029.153
* @version 1.0
* @author ABP
*/
private class (TProcessor2183) TProcessor2470(inserter : Object, dataSet : Object, columns : String, alias : String)
    private macro constructorTProcessor2470(inserter : Object, dataSet : Object, columns : String, alias : String)
        initTProcessor2183(inserter, dataSet, columns, alias, RCB_I2470_DATE2)
    end;

    constructorTProcessor2470(inserter, dataSet, columns, alias);
end;

/**
* Класс обработчика данных в соответствии с 2627-У
*
*/
private class (TProcessor2470) TProcessor2627(dataQuery : String, columns : String, accountMasksField : String)
    private var m_dataQuery         = dataQuery;
    private var m_columns           = columns;
    private var m_accountMasksField = accountMasksField;

    private macro getOkatoTuneTableQuery() : String
        var tuneTable;

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I4637_DATE_F302)
            tuneTable = RcbArTuneTable_4637();
        else
            tuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            tuneTable.setInstructionFilter(rcbApplication.currentReport.context.period.endDate());
        end;

        return tuneTable.getQuery();
    end;

    private macro getTuneTableQuery() : String
        return    "SELECT t_row, t_columns, t_okvedmasks, t_sort,"
            "\n"+ "       " + m_accountMasksField +" t_accountmasks"
            "\n"+ "  FROM df302tuneTable_tmp"
            "\n"+ " WHERE " + ternary(strLen(m_columns) == 3, "t_columns = '" + m_columns + "'", "t_columns = '" + subStr(m_columns,1,3) + "' OR t_columns = '" + subStr(m_columns,5,3) + "'") +
            "\n"+ "   AND t_backOffice = " + BOLoans +
            "\n"+ "ORDER BY t_sort";
    end;

    macro getQuery()
        return     "INSERT INTO df302p1_tmp(t_okatocode,"
            +"\n"+ "                        t_row,"
            +"\n"+ "                        t_column,"
            +"\n"+ "                        t_creditnumber,"
            +"\n"+ "                        t_creditdate,"
            +"\n"+ "                        t_tranchekind,"
            +"\n"+ "                        t_tranchenumber,"
            +"\n"+ "                        t_trancheissuedate,"
            +"\n"+ "                        t_operationissuedate,"
            +"\n"+ "                        t_currencyid,"
            +"\n"+ "                        t_roublesum,"
            +"\n"+ "                        t_clientcode,"
            +"\n"+ "                        t_recalculateratedate,"
            +"\n"+ "                        t_currencysum,"
            +"\n"+ "                        t_backoffice,"
            +"\n"+ "                        t_branch,"
            +"\n"+ "                        t_operationid)"
            +"\n"+ "SELECT CASE"
            +"\n"+ "           WHEN multiplier.t_isAdditionalOkato = 1"
            +"\n"+ "                THEN TO_CHAR(DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode))"
            +"\n"+ "            ELSE TO_CHAR(DECODE(data.t_okatoCode, '99999', '99999', RPAD(SUBSTR(data.t_okatoCode, 1, 2), 5, '0')))"
            +"\n"+ "       END t_okatoCode,"
            +"\n"+ "       REPLACE(REPLACE(rowMask.t_row, '3_овер', '3'), '3_кред', '3') t_row,"
            +"\n"+ "       TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1))) t_column,"
            +"\n"+ "       data.t_creditNumberForReport t_creditNumber,"
            +"\n"+ "       data.t_creditOpenDate t_creditDate,"
            +"\n"+ "       data.t_trancheKind t_trancheKind,"
            +"\n"+ "       data.t_trancheNumber t_trancheNumber,"
            +"\n"+ "       data.t_trancheIssueDate t_trancheIssueDate,"
            +"\n"+ "       DECODE(data.t_operationIssueDate, CHR(1), TO_DATE('01-01-0001', 'DD-MM-YYYY'), data.t_operationIssueDate) t_operationIssueDate,"
            +"\n"+ "       data.t_currencyId t_currencyId,"
            +"\n"+ "       data.t_roubleSum t_roubleSum,"
            +"\n"+ "       data.t_clientCode t_clientCode,"
            +"\n"+ "       data.t_recalculateRateDate t_recalculateRateDate,"
            +"\n"+ "       data.t_sum t_currencySum,"
            +"\n"+ "       2 t_backOffice,"
            +"\n"+ "       data.t_branchId t_branchId,"
            +"\n"+ "       CASE"
            +"\n"+ "            WHEN rowMask.t_row IN ('4', '5')"
            +"\n"+ "                THEN data.t_id"
            +"\n"+ "       END t_operationId"
            +"\n"+ "  FROM (" + m_dataQuery + ") data,"
            +"\n"+ "       (SELECT 0 t_isAdditionalOkato FROM DUAL"
            +"\n"+ "       UNION ALL"
            +"\n"+ "        SELECT 1 t_isAdditionalOkato FROM DUAL) multiplier,"
            +"\n"+ "       (" + getTuneTableQuery() + ") rowMask"
            +"\n"+ " WHERE (t_isAdditionalOkato = 0 OR EXISTS (SELECT 1"
            +"\n"+ "                                             FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                                            WHERE rsb_mask.compareStringWithMask(okatoCodes.t_okatoMasks, DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1))"
            +"\n"+ "   AND rsb_mask.compareStringWithMask(rowMask.t_accountMasks, data.t_cbAccountNumber) = 1"
            +"\n"+ "   AND data.t_sum != 0"
            +"\n"+ "   AND (CASE"
            +"\n"+ "            --1"
            +"\n"+ "            WHEN SUBSTR(rowMask.t_row, 1, 3) = '2.1' AND rowMask.t_row != '2.1.9' AND rsb_mask.compareStringWithMask(rowMask.t_okvedMasks, data.t_okvedCode) = 1"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --2"
            +"\n"+ "            WHEN rowMask.t_row = '2.1.9' AND rsb_mask.compareStringWithMask(rowMask.t_okvedMasks, data.t_okvedCode) = 0"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --3"
            +"\n"+ "            WHEN rowMask.t_row = '2.3' AND (data.t_isMsp = 1  OR (data.t_isPhysical= 1 AND data.t_isEmployer = 1))"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --4"
            +"\n"+ "            WHEN rowMask.t_row = '2.2' AND data.t_contractType = " + LO_OVERDRAFT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --5"
            +"\n"+ "            WHEN rowMask.t_row = '2.3.1' OR rowMask.t_row =  '3_кред'"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --6"
            +"\n"+ "            WHEN rowMask.t_row = '3_овер' AND data.t_contractType = " + LO_KARTA
            +"\n"+ "                THEN 1"
            +"\n"+ "            --7"
            +"\n"+ "            WHEN rowMask.t_row = '4' AND data.t_isOperOffice = 1"
            +"\n"+ "                THEN 1"
            +"\n"+ "            ELSE 0"
            +"\n"+ "        END = 1)";
    end;
end;

/**
* Класс обработчика данных в соответствии с 3129-У
*
*/
private class(TProcessor2627) TProcessor3129(dataQuery : String, columns : String, accountMasksField : String)
    initTProcessor2627(dataQuery, columns, accountMasksField);

    macro getQuery()
        return     "INSERT INTO df302p1_tmp(t_okatocode,"
            +"\n"+ "                        t_row,"
            +"\n"+ "                        t_column,"
            +"\n"+ "                        t_creditnumber,"
            +"\n"+ "                        t_creditdate,"
            +"\n"+ "                        t_tranchekind,"
            +"\n"+ "                        t_tranchenumber,"
            +"\n"+ "                        t_trancheissuedate,"
            +"\n"+ "                        t_operationissuedate,"
            +"\n"+ "                        t_currencyid,"
            +"\n"+ "                        t_roublesum,"
            +"\n"+ "                        t_clientcode,"
            +"\n"+ "                        t_recalculateratedate,"
            +"\n"+ "                        t_currencysum,"
            +"\n"+ "                        t_backoffice,"
            +"\n"+ "                        t_branch,"
            +"\n"+ "                        t_operationid)"
            +"\n"+ "SELECT CASE"
            +"\n"+ "           WHEN multiplier.t_isAdditionalOkato = 1"
            +"\n"+ "                THEN (SELECT t_okato"
            +"\n"+ "                        FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                       WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1)"
            +"\n"+ "            ELSE TO_CHAR(DECODE(data.t_okatoCode, '99999', '99999', RPAD(SUBSTR(data.t_okatoCode, 1, 2), 5, '0')))"
            +"\n"+ "       END t_okatoCode,"
            +"\n"+ "       REPLACE(REPLACE(rowMask.t_row, '3_овер', '3'), '3_кред', '3') t_row,"
            +"\n"+ "       TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1))) t_column,"
            +"\n"+ "       data.t_creditNumberForReport t_creditNumber,"
            +"\n"+ "       data.t_creditOpenDate t_creditDate,"
            +"\n"+ "       data.t_trancheKind t_trancheKind,"
            +"\n"+ "       data.t_trancheNumber t_trancheNumber,"
            +"\n"+ "       data.t_trancheIssueDate t_trancheIssueDate,"
            +"\n"+ "       DECODE(data.t_operationIssueDate, CHR(1), TO_DATE('01-01-0001', 'DD-MM-YYYY'), data.t_operationIssueDate) t_operationIssueDate,"
            +"\n"+ "       data.t_currencyId t_currencyId,"
            +"\n"+ "       data.t_roubleSum t_roubleSum,"
            +"\n"+ "       data.t_clientCode t_clientCode,"
            +"\n"+ "       data.t_recalculateRateDate t_recalculateRateDate,"
            +"\n"+ "       data.t_sum t_currencySum,"
            +"\n"+ "       2 t_backOffice,"
            +"\n"+ "       data.t_branchId t_branchId,"
            +"\n"+ "       CASE"
            +"\n"+ "            WHEN rowMask.t_row IN ('4', '5')"
            +"\n"+ "                THEN data.t_id"
            +"\n"+ "       END t_operationId"
            +"\n"+ "  FROM (" + m_dataQuery + ") data,"
            +"\n"+ "       (SELECT 0 t_isAdditionalOkato FROM DUAL"
            +"\n"+ "       UNION ALL"
            +"\n"+ "        SELECT 1 t_isAdditionalOkato FROM DUAL) multiplier,"
            +"\n"+ "       (" + getTuneTableQuery() + ") rowMask"
            +"\n"+ " WHERE (t_isAdditionalOkato = 0 OR EXISTS (SELECT 1"
            +"\n"+ "                                             FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                                            WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "   AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_accountMasks, ' ', ''), data.t_cbAccountNumber) = 1"
            +"\n"+ "   AND data.t_sum != 0"
            +"\n"+ "   AND (CASE"
            +"\n"+ "            --1"
            +"\n"+ "            WHEN SUBSTR(rowMask.t_row, 1, 3) = '2.1' AND rowMask.t_row != '2.1.9' AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okvedMasks, ' ', ''), data.t_okvedCode) = 1 AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --2"
            +"\n"+ "            WHEN rowMask.t_row = '2.1.9' AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okvedMasks, ' ', ''), data.t_okvedCode) = 0"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --3"
            +"\n"+ "            WHEN rowMask.t_row = '2.3' AND (data.t_isMsp = 1 OR (data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --4"
            +"\n"+ "            WHEN rowMask.t_row = '2.2' AND data.t_contractType = " + LO_OVERDRAFT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --5"
            +"\n"+ "            WHEN rowMask.t_row = '2.3.1' AND ((data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --6"
            +"\n"+ "            WHEN rowMask.t_row = '3_кред' AND (data.t_contractType = " + LO_CREDIT + " OR data.t_contractType = " + LO_KARTA + ")"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --7"
            +"\n"+ "            WHEN rowMask.t_row = '3_овер' AND data.t_contractType = " + LO_KARTA
            +"\n"+ "                THEN 1"
            +"\n"+ "            --8"
            +"\n"+ "            WHEN rowMask.t_row = '4' AND data.t_isOperOffice = 1"
            +"\n"+ "                THEN 1"
            +"\n"+ "            ELSE 0"
            +"\n"+ "        END = 1)";
    end;
end;

/**
* Класс обработчика данных в соответствии с ОКВЭД2
*
*/
private class(TProcessor3129) TProcessor_Okved(dataQuery : String, columns : String, accountMasksField : String)
    initTProcessor3129(dataQuery, columns, accountMasksField);

    private macro getTuneTableQuery() : String
        return    "SELECT t_row, t_columns, t_okvedmasks, t_okved2masks, t_sort,"
            "\n"+ "       " + m_accountMasksField +" t_accountmasks"
            "\n"+ "  FROM df302tuneTable_tmp"
            "\n"+ " WHERE " + ternary(strLen(m_columns) == 3, "t_columns = '" + m_columns + "'", "t_columns = '" + subStr(m_columns,1,3) + "' OR t_columns = '" + subStr(m_columns,5,3) + "'") +
            "\n"+ "   AND t_backOffice = " + BOLoans +
            "\n"+ " ORDER BY t_sort";
    end;

    macro getQuery()
        return     "INSERT INTO df302p1_tmp(t_okatocode,"
            +"\n"+ "                        t_row,"
            +"\n"+ "                        t_column,"
            +"\n"+ "                        t_creditnumber,"
            +"\n"+ "                        t_creditdate,"
            +"\n"+ "                        t_tranchekind,"
            +"\n"+ "                        t_tranchenumber,"
            +"\n"+ "                        t_trancheissuedate,"
            +"\n"+ "                        t_operationissuedate,"
            +"\n"+ "                        t_currencyid,"
            +"\n"+ "                        t_roublesum,"
            +"\n"+ "                        t_clientcode,"
            +"\n"+ "                        t_recalculateratedate,"
            +"\n"+ "                        t_currencysum,"
            +"\n"+ "                        t_backoffice,"
            +"\n"+ "                        t_branch,"
            +"\n"+ "                        t_operationid)"
            +"\n"+ "SELECT "
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN multiplier.t_isAdditionalOkato = 1"
            +"\n"+ "                THEN (SELECT t_okato"
            +"\n"+ "                        FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                       WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1)"
            +"\n"+ "            ELSE TO_CHAR(DECODE(data.t_okatoCode, '99999', '99999', RPAD(SUBSTR(data.t_okatoCode, 1, 2), 5, '0')))"
            +"\n"+ "       END t_okatoCode,"
            +"\n"+ "       REPLACE(REPLACE(rowMask.t_row, '3_овер', '3'), '3_кред', '3') t_row,"
            +"\n"+ "       TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1))) t_column,"
            +"\n"+ "       data.t_creditNumberForReport t_creditNumber,"
            +"\n"+ "       data.t_creditOpenDate t_creditDate,"
            +"\n"+ "       data.t_trancheKind t_trancheKind,"
            +"\n"+ "       data.t_trancheNumber t_trancheNumber,"
            +"\n"+ "       data.t_trancheIssueDate t_trancheIssueDate,"
            +"\n"+ "       DECODE(data.t_operationIssueDate, CHR(1), TO_DATE('01-01-0001', 'DD-MM-YYYY'), data.t_operationIssueDate) t_operationIssueDate,"
            +"\n"+ "       data.t_currencyId t_currencyId,"
            +"\n"+ "       data.t_roubleSum t_roubleSum,"
            +"\n"+ "       data.t_clientCode t_clientCode,"
            +"\n"+ "       data.t_recalculateRateDate t_recalculateRateDate,"
            +"\n"+ "       data.t_sum t_currencySum,"
            +"\n"+ "       2 t_backOffice,"
            +"\n"+ "       data.t_branchId t_branchId,"
            +"\n"+ "       CASE"
            +"\n"+ "            WHEN TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1))) IN ('4', '5')"
            +"\n"+ "                THEN data.t_id"
            +"\n"+ "       END t_operationId"
            +"\n"+ "  FROM (" + m_dataQuery + " data2) data,"
            +"\n"+ "       (SELECT 0 t_isAdditionalOkato FROM DUAL"
            +"\n"+ "         UNION ALL"
            +"\n"+ "        SELECT 1 t_isAdditionalOkato FROM DUAL) multiplier,"
            +"\n"+ "       (" + getTuneTableQuery() + ") rowMask"
            +"\n"+ " WHERE (t_isAdditionalOkato = 0 OR EXISTS (SELECT 1"
            +"\n"+ "                                             FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                                            WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1))"
            +"\n"+ "   AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_accountMasks, ' ', ''), data.t_cbAccountNumber) = 1"
            +"\n"+ "   AND data.t_sum != 0"
            +"\n"+ "   AND (CASE"
            +"\n"+ "            --1"
            +"\n"+ "            WHEN     SUBSTR(rowMask.t_row, 1, 3) = '2.1'"
            +"\n"+ "                 AND rowMask.t_row != '2.1.9' "
            +"\n"+ "                 AND (   rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okved2Masks, ' ', ''), data.t_okved2Code) = 1 "
            +"\n"+ "                      OR (    data.t_okved2Code IS NULL "
            +"\n"+ "                          AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okvedMasks, ' ', ''), data.t_okvedCode) = 1 "
            +"\n"+ "                         ) "
            +"\n"+ "                     ) "
            +"\n"+ "                 AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --2"
            +"\n"+ "            WHEN rowMask.t_row = '2.1.9' AND ((data.t_okvedCode IS NOT NULL AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okvedMasks, ' ', ''), data.t_okvedCode) = 0) OR (data.t_okved2Code IS NOT NULL AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okved2Masks, ' ', ''), data.t_okved2Code) = 0) OR (data.t_okvedCode IS NULL AND data.t_okved2Code IS NULL)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --3"
            +"\n"+ "            WHEN rowMask.t_row = '2.3' AND (data.t_isMsp = 1 OR (data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --4"
            +"\n"+ "            WHEN rowMask.t_row = '2.2' AND data.t_contractType = " + LO_OVERDRAFT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --5"
            +"\n"+ "            WHEN rowMask.t_row = '2.3.1' AND ((data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --6"
            +"\n"+ "            WHEN    rowMask.t_row = '3_кред'"
            +"\n"+ "                AND (   data.t_contractType = " + LO_CREDIT
            +"\n"+ "                     OR (    data.t_contractType = " + LO_KARTA
            +"\n"+ "                         AND data.t_issueType    = " + CF_CREDKARTA
            +"\n"+ "                        )"
            +"\n"+ "                    )"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --7"
            +"\n"+ "            WHEN     rowMask.t_row       = '3_овер'"
            +"\n"+ "                 AND data.t_contractType = " + LO_KARTA
            +"\n"+ "                 AND data.t_issueType    = " + CF_CALCKARTA
            +"\n"+ "                THEN 1"
            +"\n"+ "            --8"
            +"\n"+ "            WHEN rowMask.t_row = '4' AND data.t_isOperOffice = 1"
            +"\n"+ "                THEN 1"
            +"\n"+ "            ELSE 0"
            +"\n"+ "        END = 1)";
    end;
end;

private class(TProcessor_Okved) TProcessor_Okved_Т1_56_15_38_43598(dataQuery : String, columns : String, accountMasksField : String)
    initTProcessor_Okved(dataQuery, columns, accountMasksField);

    macro getQuery()
        return     "INSERT INTO df302p1_tmp(t_okatocode,"
            +"\n"+ "                        t_row,"
            +"\n"+ "                        t_column,"
            +"\n"+ "                        t_creditnumber,"
            +"\n"+ "                        t_creditdate,"
            +"\n"+ "                        t_tranchekind,"
            +"\n"+ "                        t_tranchenumber,"
            +"\n"+ "                        t_trancheissuedate,"
            +"\n"+ "                        t_operationissuedate,"
            +"\n"+ "                        t_currencyid,"
            +"\n"+ "                        t_roublesum,"
            +"\n"+ "                        t_clientcode,"
            +"\n"+ "                        t_recalculateratedate,"
            +"\n"+ "                        t_currencysum,"
            +"\n"+ "                        t_backoffice,"
            +"\n"+ "                        t_branch,"
            +"\n"+ "                        t_operationid)"
            +"\n"+ "SELECT "
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN multiplier.t_isAdditionalOkato = 1"
            +"\n"+ "                THEN (SELECT t_okato"
            +"\n"+ "                        FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                       WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1)"
            +"\n"+ "            ELSE TO_CHAR(DECODE(data.t_okatoCode, '99999', '99999', RPAD(SUBSTR(data.t_okatoCode, 1, 2), 5, '0')))"
            +"\n"+ "       END                                                                                                          t_okatoCode,"
            +"\n"+ "       REPLACE(REPLACE(rowMask.t_row, '3_овер', '3'), '3_кред', '3')                                                t_row,"
            +"\n"+ "       TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1)))        t_column,"
            +"\n"+ "       data.t_creditNumberForReport                                                                                 t_creditNumber,"
            +"\n"+ "       data.t_creditOpenDate                                                                                        t_creditDate,"
            +"\n"+ "       data.t_trancheKind                                                                                           t_trancheKind,"
            +"\n"+ "       data.t_trancheNumber                                                                                         t_trancheNumber,"
            +"\n"+ "       data.t_trancheIssueDate                                                                                      t_trancheIssueDate,"
            +"\n"+ "       DECODE(data.t_operationIssueDate, CHR(1), TO_DATE('01-01-0001', 'DD-MM-YYYY'), data.t_operationIssueDate)    t_operationIssueDate,"
            +"\n"+ "       data.t_currencyId                                                                                            t_currencyId,"
            +"\n"+ "       data.t_roubleSum                                                                                             t_roubleSum,"
            +"\n"+ "       data.t_clientCode                                                                                            t_clientCode,"
            +"\n"+ "       data.t_recalculateRateDate                                                                                   t_recalculateRateDate,"
            +"\n"+ "       data.t_sum                                                                                                   t_currencySum,"
            +"\n"+ "       2                                                                                                            t_backOffice,"
            +"\n"+ "       data.t_branchId                                                                                              t_branchId,"
            +"\n"+ "       CASE"
            +"\n"+ "            WHEN TO_NUMBER(DECODE(data.t_currencyId, 0, substr(rowMask.t_columns,1,1), substr(rowMask.t_columns,3,1))) IN ('4', '5')"
            +"\n"+ "                THEN data.t_id"
            +"\n"+ "       END                                                                                                          t_operationId"
            +"\n"+ "  FROM (" + m_dataQuery + " data2) data,"
            +"\n"+ "       (SELECT 0 t_isAdditionalOkato FROM DUAL"
            +"\n"+ "         UNION ALL"
            +"\n"+ "        SELECT 1 t_isAdditionalOkato FROM DUAL) multiplier,"
            +"\n"+ "       (" + getTuneTableQuery() + ") rowMask"
            +"\n"+ " WHERE (t_isAdditionalOkato = 0 OR EXISTS (SELECT 1"
            +"\n"+ "                                             FROM (" + getOkatoTuneTableQuery() + ") okatoCodes"
            +"\n"+ "                                            WHERE rsb_mask.compareStringWithMask(REPLACE(okatoCodes.t_okatoMasks, ' ', ''), DECODE (rowMask.t_row, '4', data.t_branchOkatoCode, data.t_okatoCode)) = 1))"
            +"\n"+ "   AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_accountMasks, ' ', ''), data.t_cbAccountNumber) = 1"
            +"\n"+ "   AND data.t_sum != 0"
            +"\n"+ "   AND (CASE"
            +"\n"+ "            --1"
            +"\n"+ "            WHEN     SUBSTR(rowMask.t_row, 1, 3) = '2.1'"
            +"\n"+ "                 AND rowMask.t_row != '2.1.9' "
            +"\n"+ "                 AND (   rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okved2Masks, ' ', ''), data.t_okved2Code) = 1 "
            +"\n"+ "                     ) "
            +"\n"+ "                 AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --2"
            +"\n"+ "            WHEN     rowMask.t_row = '2.1.9'"
            +"\n"+ "                 AND (    (    data.t_okved2Code IS NOT NULL "
            +"\n"+ "                           AND rsb_mask.compareStringWithMask(REPLACE(rowMask.t_okved2Masks, ' ', ''), data.t_okved2Code) = 0 "
            +"\n"+ "                          ) "
            +"\n"+ "                       OR (data.t_okved2Code IS NULL) "
            +"\n"+ "                     ) "
            +"\n"+ "                 AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --3"
            +"\n"+ "            WHEN rowMask.t_row = '2.3' AND (data.t_isMsp = 1 OR (data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --4"
            +"\n"+ "            WHEN rowMask.t_row = '2.2' AND data.t_contractType = " + LO_OVERDRAFT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --5"
            +"\n"+ "            WHEN rowMask.t_row = '2.3.1' AND ((data.t_isPhysical= 1 AND data.t_isEmployer = 1)) AND data.t_contractType = " + LO_CREDIT
            +"\n"+ "                THEN 1"
            +"\n"+ "            --6"
            +"\n"+ "            WHEN    rowMask.t_row = '3_кред'"
            +"\n"+ "                AND (   data.t_contractType = " + LO_CREDIT
            +"\n"+ "                     OR (    data.t_contractType = " + LO_KARTA
            +"\n"+ "                         AND data.t_issueType    = " + CF_CREDKARTA
            +"\n"+ "                        )"
            +"\n"+ "                    )"
            +"\n"+ "                THEN 1"
            +"\n"+ "            --7"
            +"\n"+ "            WHEN     rowMask.t_row       = '3_овер'"
            +"\n"+ "                 AND data.t_contractType = " + LO_KARTA
            +"\n"+ "                 AND data.t_issueType    = " + CF_CALCKARTA
            +"\n"+ "                THEN 1"
            +"\n"+ "            --8"
            +"\n"+ "            WHEN rowMask.t_row = '4' AND data.t_isOperOffice = 1"
            +"\n"+ "                THEN 1"
            +"\n"+ "            ELSE 0"
            +"\n"+ "        END = 1)";
    end;
end;

/***************************************************************************************************
*  Промежуточный класс обработчика данных
**************************************************************************************************/
private class TProcessorDecorator(processor : Object)
    private var m_processor = processor;

    private macro initializeRowsArray()
        return m_processor.initializeRowsArray();
    end;

    private macro initializeColumnArray()
        return m_processor.initializeColumnArray();
    end;

    private macro getRowsArray()
        return m_processor.getRowsArray();
    end;

    private macro getColumnArray()
        return m_processor.getColumnArray();
    end;

    macro getSum()
        return m_processor.getSum();
    end;

    macro getRoubleSum()
        return m_processor.getRoubleSum();
    end;

    macro getDataSet()
        return m_processor.getDataSet();
    end;

    macro execute()
        macro processRow()
            initializeRowsArray();
            initializeColumnArray();
            var i = 0;
            var j = 0;
            while (i < m_processor.getRowsArray().size)
                j = 0;
                while (j < m_processor.getColumnArray().size)
                    m_processor.getInserter().insertRecord(getRowsArray()[i], getColumnArray()[j]);
                    j = j + 1;
                end;
                i = i + 1;
            end;
        end;

        while (getDataSet().next())
            processRow();
        end;
    end;

    m_processor.getInserter().initialize(this);
end;


/***************************************************************************************************
*  Класс обработчика данных по операциям
**************************************************************************************************/
private class (TProcessorDecorator) TOperationProcessorImpl(processor : Object)

    private macro initializeColumnArray()
        if (m_processor.getDataSet().currencyId == NATCUR)
            m_processor.getColumnArray()[0] = "4";
            m_processor.getColumnArray()[1] = "10";
            m_processor.getColumnArray()[2] = "12";
        else
            m_processor.getColumnArray()[0] = "5";
            m_processor.getColumnArray()[1] = "11";
            m_processor.getColumnArray()[2] = "13";
        end;
    end;

    macro getSum()
        return m_processor.getDataSet().sum;
    end;

    macro getRoubleSum()
        return m_processor.getDataSet().roubleSum;
    end;

    initTProcessorDecorator(processor);
end;

/***************************************************************************************************
*  Класс обработчика данных по операциям по 2055У
**************************************************************************************************/
private class (TOperationProcessorImpl) TOperationProcessorImpl2055(processor : Object)
    private macro initializeColumnArray()
        if (m_processor.getDataSet().currencyId == NATCUR)
            m_processor.getColumnArray()[0] = "4";
        else
            m_processor.getColumnArray()[0] = "5";
        end;
    end;
    initTOperationProcessorImpl(processor);
end;

/***************************************************************************************************
*  Класс обработчика данных по операциям по 2183У
**************************************************************************************************/
private class (TOperationProcessorImpl) TOperationProcessorImpl2183(processor : Object)

    private macro initializeRowsAndColumnArray()
        return m_processor.initializeRowsAndColumnArray();
    end;

    macro execute()
        macro processRow()
            initializeRowsAndColumnArray();
            var i = 0;
            while (i < m_processor.getRowsArray().size)
                m_processor.getInserter().insertRecord(getRowsArray()[i].row, getRowsArray()[i].column);
                i = i + 1;
            end;
        end;

        while (getDataSet().next())
            processRow();
        end;
    end;

    initTOperationProcessorImpl(processor);
end;

/**
* Класс обработчика данных по операциям в соответствии с 2470-У
*
* @since v.6.20.029.153
* @version 1.0
* @author ABP
*/
private class (TOperationProcessorImpl2183) TOperationProcessorImpl2470(processor : Object)

    private macro constructorTOperationProcessorImpl2470(processor : Object)
        initTOperationProcessorImpl2183(processor);
    end;

    constructorTOperationProcessorImpl2470(processor);

end;


/**
* Класс обработчика данных по операциям в соответствии с 2627-У
*
*/
private class (TOperationProcessorImpl2470) TOperationProcessorImpl2627(processor : Object)
    m_processor = processor;
    macro execute()
        sql_execute(m_processor.getQuery());

    end;
end;

/***************************************************************************************************
*  Класс обработчика данных по траншам
**************************************************************************************************/
private class (TProcessorDecorator) TTrancheProcessorImpl(processor : Object)
    private macro initializeColumnArray()
        if (m_processor.getDataSet().currencyId == NATCUR)
            m_processor.getColumnArray()[0] = "6";
            m_processor.getColumnArray()[1] = "8";
        else
            m_processor.getColumnArray()[0] = "7";
            m_processor.getColumnArray()[1] = "9";
        end;
    end;

    macro getSum()
        return m_processor.getDataSet().sum;
    end;

    macro getRoubleSum()
        return m_processor.getDataSet().roubleSum;
    end;

    initTProcessorDecorator(processor);
end;

/***************************************************************************************************
*  Класс обработчика данных по траншам для 2183У
**************************************************************************************************/
private class (TTrancheProcessorImpl) TTrancheProcessorImpl2183(processor : Object)

    private macro initializeRowsAndColumnArray()
        return m_processor.initializeRowsAndColumnArray();
    end;

    macro execute()
        macro processRow()
            initializeRowsAndColumnArray();
            var i = 0;
            while (i < m_processor.getRowsArray().size)
                m_processor.getInserter().insertRecord(getRowsArray()[i].row, getRowsArray()[i].column);
                i = i + 1;
            end;
        end;

        while (getDataSet().next())
            processRow();
        end;
    end;

    initTTrancheProcessorImpl(processor);
end;

/**
* Класс обработчика данных по траншам в соответствии с 2470-У
*
* @since v.6.20.029.153
* @version 1.0
* @author ABP
*/
private class (TTrancheProcessorImpl2183) TTrancheProcessorImpl2470(processor : Object)

    private macro constructorTTrancheProcessorImpl2470(processor : Object)
        initTTrancheProcessorImpl2183(processor);
    end;

    constructorTTrancheProcessorImpl2470(processor);

end;

/**
* Класс обработчика данных по траншам в соответствии с 2627-У
*
*/
private class (TTrancheProcessorImpl2470) TTrancheProcessorImpl2627(processor : Object)
    m_processor = processor;
    macro execute()
        sql_execute(m_processor.getQuery());
    end;
end;

/***************************************************************************************************
*  Обслуживающая функция
**************************************************************************************************/
private macro fillTempTable(instructionDate)

    sql_truncate("df302_tmp");

    /*Для строк 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                          "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT SUM(reg.t_roubleRest) FROM repLnsRegister_vw reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                          "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice"
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        var tranche = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        if (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
            TTrancheProcessorImpl(TProcessor2055(TInserter(), tranche)).execute();
        elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
            TTrancheProcessorImpl2183(TProcessor2183(TInserter(), tranche, "6,7", "t_accountmasks", instructionDate)).execute();
        else
            TTrancheProcessorImpl2470(TProcessor2470(TInserter2470(), tranche, "6,7", "t_accountmasks")).execute();
        end;
    end;
    /*Для строк 6,7,8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_cbAccount          AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM repLnsRegister_vw reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT SUM(reg.t_roubleRest) FROM repLnsRegister_vw reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice"
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND substr(acc.t_cbAccount,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        var tranche = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);


        if (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
            TTrancheProcessorImpl(TProcessor2055(TInserter(), tranche)).execute();
        elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
            TTrancheProcessorImpl2183(TProcessor2183(TInserter(), tranche, "6,7,8,9", "t_accountmasksfor_8_9", instructionDate)).execute();
        else
            TTrancheProcessorImpl2470(TProcessor2470(TInserter2470(), tranche, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
        end;
    end;
    /*Для строк 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id         AS t_id,                                                                                    " //gww
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice"
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       repLnsOperation_vw oper,                                                                                                    "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind                                                                                    "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        var creditOperation = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        if (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
            TOperationProcessorImpl2055(TProcessor2055(TInserter(), creditOperation)).execute();
        elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
            TOperationProcessorImpl2183(TProcessor2183(TInserter(), creditOperation, "4,5", "t_accountmasks", instructionDate)).execute();
        else
            TOperationProcessorImpl2470(TProcessor2470(TInserter2470(), creditOperation, "4,5", "t_accountmasks")).execute();
        end;

    end;

    processTranche_6_7();
    processTranche_8_9();
    processCreditOperation();
end;

/***************************************************************************************************
*  Обслуживающая функция по 2627-У
**************************************************************************************************/
private macro fillTempTable2627()

    const PAYMENT = 2; /*Тип операции выдача*/
    sql_truncate("df302_tmp");

    /*Для строк 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                        "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                          "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                          "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7", "t_accountmasks")).execute();
    end;

    macro processTranche_6_7_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                        "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                          "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                          "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'                                                                                                        "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для строк 8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                        "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_cbAccount          AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                          "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND substr(acc.t_cbAccount,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro processTranche_8_9_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                        "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                          "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                          "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else p.t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'З'                                                                                                        "
            + "\n" + "    AND substr(acc.t_cbAccount,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId");

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    /*Для строк 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,  "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,"
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,"
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                              "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
            + "\n" + "        END                                                                        t_roubleSum,          "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,"
            + "\n" + "        t_isOperOffice, t_contractType"
            + "\n" + "   FROM (SELECT "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(t_currencyId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id         AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                          "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,       "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                          "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       repLnsOperation_vw oper,                                                                                                    "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TOperationProcessorImpl2627(TProcessor2627(query, "4,5", "t_accountmasks")).execute();

    end;

    macro processCreditOperation_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,  "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,"
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,"
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                              "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
            + "\n" + "        END                                                                        t_roubleSum,          "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,"
            + "\n" + "        t_isOperOffice, t_contractType"
            + "\n" + "   FROM (SELECT "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(t_currencyId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id         AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okvedCode  AS t_okvedCode,                                                                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_okatoCode  AS t_okatoCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       repLnsOperation_vw oper,                                                                                                    "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               case when p.t_okatoCode is NULL or p.t_okatoCode = CHR(0)                                                           "
            + "\n" + "                    then '99999'                                                                                                   "
            + "\n" + "                    else t_okatoCode                                                                                               "
            + "\n" + "               end t_okatoCode,                                                                                                    "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 17                                                                                               "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okvedCode,                                                            "
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND (party.t_isPhisical = 1 OR party.t_okvedCode is not NULL)                                                                  "
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'     "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind                                                                                        "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TOperationProcessorImpl2627(TProcessor2627(query, "4,5", "t_accountmasks")).execute();
    end;

    processTranche_6_7();
    processTranche_6_7_Contract();
    processTranche_8_9();
    processTranche_8_9_Contract();
    processCreditOperation();
    processCreditOperation_Contract();
end;


private class fillTempTable2835()

    const PAYMENT = 2; /*Тип операции выдача*/
    sql_truncate("df302_tmp");

    var m_dateExpression = "NVL((SELECT MAX(oper.t_date)"
        + "\n" + "                 FROM repLnsOperation_vw oper                 "
        + "\n" + "                WHERE oper.t_contractId = credit.t_id         "
        + "\n" + "                  AND oper.t_trancheNumber = tranche.t_number "
        + "\n" + "                  AND oper.t_trancheKind = tranche.t_kind     "
        + "\n" + "                  AND oper.t_type = " + PAYMENT
        + "\n" + "                  AND oper.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                  AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "                  ), " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + ")";

    var dateExpression69 = "NVL((SELECT MAX(oper.t_date)"
        + "\n" + "                                                         FROM repLnsOperation_vw oper,                   "
        + "\n" + "                                                              repLnsContract_vw doc,                     "
        + "\n" + "                                                              dRepParty_vw party                         "
        + "\n" + "                                                        WHERE doc.t_id = oper.t_contractId               "
        + "\n" + "                                                          AND doc.t_contragentId = credit.t_contragentId "
        + "\n" + "                                                          AND doc.t_isOpened = 1                         "
        + "\n" + "                                                          AND doc.t_type = " + LO_CREDIT
        + "\n" + "                                                          AND party.t_id = doc.t_contragentId            "
        + "\n" + "                                                          AND party.t_isResident = 1                     "
        + "\n" + "                                                          AND oper.t_trancheKind = tranche.t_kind        "
        + "\n" + "                                                          AND oper.t_type = " + PAYMENT
        + "\n" + "                                                          AND oper.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                                          AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "                                                          ), " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + ")";


    private macro getOkatoSubQuery45(objectField : String, dateExpression : String)

        return " NVL(("
               "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "    FROM dobjattr_dbt att,                          "
               "\n" + "         dobjatcor_dbt atc,                         "
               "\n" + "         drepparty_vw repparty                      "
               "\n" + "   WHERE atc.t_groupId      = 12                    "
               "\n" + "     AND atc.t_object         = repparty.t_objectId "
               "\n" + "     AND atc.t_objectType     = 3                   "
               "\n" + "     AND atc.t_general        = 'X'                 "
               "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               "\n" + "     AND atc.t_validFromDate <= " + dateExpression +
               "\n" + "     AND atc.t_validToDate   >= " + dateExpression +
               "\n" + "     AND rownum < 2                                 "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               "\n" + "               FROM dadress_dbt address"
               "\n" + "              WHERE address.t_partyId = " + objectField +
               "\n" + "                AND address.t_type = 1"
               "\n" + "            ), '99999'"
               "\n" + "           )"
               "\n" + "    )";
    end;

    private macro getOkatoSubQuery(objectField : String, dateExpression : String, dateExpression69 : String)
        return        "        CASE"
               "\n" + "            WHEN credit.t_type NOT IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
               "\n" + "                THEN "
               "\n" + "                    NVL(("
               "\n" + "                    SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "                      FROM dobjattr_dbt att,                          "
               "\n" + "                           dobjatcor_dbt atc,                         "
               "\n" + "                           drepparty_vw repparty                      "
               "\n" + "                     WHERE atc.t_groupId      = 12                    "
               "\n" + "                       AND atc.t_object         = repparty.t_objectId "
               "\n" + "                       AND atc.t_objectType     = 3                   "
               "\n" + "                       AND atc.t_general        = 'X'                 "
               "\n" + "                       AND atc.t_attrId         = att.t_attrId        "
               "\n" + "                       AND atc.t_objectType     = att.t_objectType    "
               "\n" + "                       AND atc.t_groupId        = att.t_groupId       "
               "\n" + "                       AND atc.t_validFromDate <= " + dateExpression69 +
               "\n" + "                       AND atc.t_validToDate   >= " + dateExpression69 +
               "\n" + "                       AND rownum < 2                                 "
               "\n" + "                       AND credit.t_type NOT IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
               "\n" + "                       AND repparty.t_id = " + objectField +
               "\n" + "                       ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               "\n" + "                                 FROM dadress_dbt address"
               "\n" + "                                WHERE address.t_partyId = " + objectField +
               "\n" + "                                  AND address.t_type = 1"
               "\n" + "                              ), '99999'"
               "\n" + "                             )"
               "\n" + "                      )"
               "\n" + "                ELSE"
               "\n" + "                    NVL(("
               "\n" + "                    SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "                      FROM dobjattr_dbt att,                          "
               "\n" + "                           dobjatcor_dbt atc,                         "
               "\n" + "                           drepparty_vw repparty                      "
               "\n" + "                     WHERE atc.t_groupId      = 12                    "
               "\n" + "                       AND atc.t_object         = repparty.t_objectId "
               "\n" + "                       AND atc.t_objectType     = 3                   "
               "\n" + "                       AND atc.t_general        = 'X'                 "
               "\n" + "                       AND atc.t_attrId         = att.t_attrId        "
               "\n" + "                       AND atc.t_objectType     = att.t_objectType    "
               "\n" + "                       AND atc.t_groupId        = att.t_groupId       "
               "\n" + "                       AND atc.t_validFromDate <= " + dateExpression +
               "\n" + "                       AND atc.t_validToDate   >= " + dateExpression +
               "\n" + "                       AND rownum < 2                                 "
               "\n" + "                       AND repparty.t_id = " + objectField +
               "\n" + "                       ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               "\n" + "                                 FROM dadress_dbt address"
               "\n" + "                                WHERE address.t_partyId = " + objectField +
               "\n" + "                                  AND address.t_type = 1"
               "\n" + "                              ), '99999'"
               "\n" + "                             )"
               "\n" + "                      )"
               "\n" + "        END"
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "    FROM dobjattr_dbt att,                          "
               "\n" + "         dobjatcor_dbt atc,                         "
               "\n" + "         drepparty_vw repparty                      "
               "\n" + "   WHERE atc.t_groupId      = 17                    "
               "\n" + "     AND atc.t_object         = repparty.t_objectId "
               "\n" + "     AND atc.t_objectType     = 3                   "
               "\n" + "     AND atc.t_general        = 'X'                 "
               "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               "\n" + "     AND atc.t_validFromDate <= " + dateExpression  +
               "\n" + "     AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "     AND rownum < 2                                 "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    /*Для строк 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT"
            + "\n" + "       null                     AS t_id,                                                                                           "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                          "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression, dateExpression69) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")"
            + "\n" + "    WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                           ";

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7", "t_accountmasks")).execute();
    end;

    macro processTranche_6_7_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                          "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression, dateExpression69) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3,38,'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'                                                                                                           "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId")+ ")"
            + "\n" + "    WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                           ";

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для строк 8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_cbAccount          AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression, dateExpression69) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND substr(acc.t_cbAccount,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")"
            + "\n" + "    WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                            ";

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro processTranche_8_9_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression, dateExpression69) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3,38,'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")"
            + "\n" + "    WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                            "
            + "\n" + "      AND substr(t_cbAccountNumber,1,5) IN ('45805', '45806', '45807', '45808',                                                    "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                            '45813', '45814', '45815')                                                             ";

        TTrancheProcessorImpl2627(TProcessor2627(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    /*Для строк 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                              "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                   "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                            "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0)                                  "
            + "\n" + "        END                                                                        t_roubleSum,                                    "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                        "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                    "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(t_currencyId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id         AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + getOkatoSubQuery45("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       repLnsOperation_vw oper,                                                                                                    "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3,38,'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")"
            + "\n" + "  WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                              ";

        TOperationProcessorImpl2627(TProcessor2627(query, "4,5", "t_accountmasks")).execute();
    end;

    macro processCreditOperation_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                              "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                   "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                            "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0)                                  "
            + "\n" + "        END                                                                        t_roubleSum,                                    "
            + "\n" + "        t_clientCode, t_okvedCode, t_okonhCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                        "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                    "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(t_currencyId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id                AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + "       party.t_okonhCode  AS t_okonhCode,                                                                                          "
            + "\n" + getOkatoSubQuery45("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       repLnsOperation_vw oper,                                                                                                    "
            + "\n" + "       repLnsAccount_vw  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3,38,'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp,"
            + "\n" + "               (select t_value                                                                                                     "
            + "\n" + "                  from drepCategory_vw cat                                                                                         "
            + "\n" + "                 where cat.t_objectId = TO_CHAR(p.t_id, 'fm0000000000')                                                            "
            + "\n" + "                   and cat.t_id = 7                                                                                                "
            + "\n" + "                   and cat.t_isInstalledForEndDate = 1) AS t_okonhCode                                                             "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND acc.t_contractId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'     "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind                                                                                        "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")"
            + "\n" + "  WHERE (t_isPhysical = 1 OR t_okvedCode is not NULL)                                                                  ";

        TOperationProcessorImpl2627(TProcessor2627(query, "4,5", "t_accountmasks")).execute();
    end;

    macro execute()
        processTranche_6_7();
        processTranche_6_7_Contract();
        processTranche_8_9();
        processTranche_8_9_Contract();
        processCreditOperation();
        processCreditOperation_Contract();
    end;
end;

private class(fillTempTable2835) fillTempTable3129()
    initfillTempTable2835();

    m_dateExpression   = getSqlDate(RcbApplication().currentReport.context.period.endDate);

    private macro getOkatoSubQuery(objectField : String, dateExpression : String)
         return " NVL(("
               + "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               + "\n" + "    FROM dobjattr_dbt att,                          "
               + "\n" + "         dobjatcor_dbt atc                         "
               + "\n" + "   WHERE atc.t_groupId      = 12                    "
               + "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM drepparty_vw repParty WHERE repParty.t_id = " + objectField + ")"
               + "\n" + "     AND atc.t_objectType     = 3                   "
               + "\n" + "     AND atc.t_general        = 'X'                 "
               + "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               + "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               + "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               + "\n" + "     AND atc.t_validFromDate <= " + dateExpression
               + "\n" + "     AND atc.t_validToDate   >= " + dateExpression
               + "\n" + "     AND rownum < 2                                 "
               + "\n" + "     ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               + "\n" + "               FROM dadress_dbt address"
               + "\n" + "              WHERE address.t_partyId = " + objectField
               + "\n" + "                AND address.t_type = 1"
               + "\n" + "            ), '99999'"
               + "\n" + "           )"
               + "\n" + "    )";
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
              + "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
              + "\n" + "    FROM dobjattr_dbt att,"
              + "\n" + "         dobjatcor_dbt atc                         "
              + "\n" + "   WHERE atc.t_groupId        = 17                          "
              + "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM drepparty_vw repParty WHERE repParty.t_id = " + objectField + ")"
              + "\n" + "     AND atc.t_objectType     = 3                           "
              + "\n" + "     AND atc.t_general        = 'X'                         "
              + "\n" + "     AND atc.t_attrId         = att.t_attrId                "
              + "\n" + "     AND atc.t_objectType     = att.t_objectType            "
              + "\n" + "     AND atc.t_groupId        = att.t_groupId               "
              + "\n" + "     AND atc.t_validFromDate <= " + dateExpression
              + "\n" + "             AND atc.t_validToDate   >= " + dateExpression
              + "\n" + "     AND rownum < 2                                         "
              + "\n" + "     ), NULL)";
    end;

    /*Для строк 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT"
            + "\n" + "       null                     AS t_id,                                                                                           "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                          "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                       "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp                                                            "
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TTrancheProcessorImpl2627(TProcessor3129(query, "6,7", "t_accountmasks")).execute();
    end;

    macro processTranche_6_7_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END)                    AS t_recalculateRateDate,                                                                          "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (1, 16) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       df302Accounts_tmp  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp"
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
            + "\n" + "    AND acc.t_creditId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'                                                                                                           "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId")+ ")";

        TTrancheProcessorImpl2627(TProcessor3129(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для строк 8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,               "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       df302Accounts_tmp  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp"
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
//---------------------------------------------------------
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND acc.t_creditId = credit.t_id                                                                                             "
            + "\n" + "    AND substr(acc.t_account,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TTrancheProcessorImpl2627(TProcessor3129(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro processTranche_8_9_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,       "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                 "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum,                                     "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                            "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                            "
            + "\n" + "       null          AS t_id,                                                                                                      "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       (CASE WHEN ( credit.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS') "
            + "\n" + "                   AND credit.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                  "
            + "\n" + "             THEN credit.t_closeDate                                                                                               "
            + "\n" + "             ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                        "
            + "\n" + "        END) AS t_recalculateRateDate,                                                                                             "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       credit.t_fiId            AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       (NVL((SELECT SUM(reg.t_rest) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_sum, "
            + "\n" + "       (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate()) FROM F302REGISTER_VW reg WHERE reg.t_type IN (2, 17) and reg.t_trancheKind = tranche.t_kind and reg.t_trancheNumber = tranche.t_number), 0)) AS t_roubleSum, "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", m_dateExpression) + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,"
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw tranche,                                                                                                  "
            + "\n" + "       repLnsContract_vw credit,                                                                                                   "
            + "\n" + "       df302Accounts_tmp  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp"
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND acc.t_creditId = credit.t_id                                                                                             "
            + "\n" + "    AND substr(acc.t_Account,1,5) IN ('45805', '45806', '45807', '45808',                                                        "
            + "\n" + "                                        '45809', '45810', '45811', '45812',                                                        "
            + "\n" + "                                        '45813', '45814', '45815')                                                                 "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TTrancheProcessorImpl2627(TProcessor3129(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    /*Для строк 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                              "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                   "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                            "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0)                                  "
            + "\n" + "        END                                                                        t_roubleSum,                                    "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                        "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                    "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       tranche.t_cbAccount      AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(tranche.t_fiId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id         AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       F302operation_tmp oper,                                                                                                     "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp"
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_CREDIT + ")"
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TOperationProcessorImpl2627(TProcessor3129(query, "4,5", "t_accountmasks")).execute();
    end;

    macro processCreditOperation_Contract()
        var query =  " SELECT                                                                                                                            "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                "
            + "\n" + "        t_cbAccountNumber, t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                              "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                   "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                            "
            + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_sum, t_currencyId," + NATCUR +", t_recalculateRateDate,0)                                  "
            + "\n" + "        END                                                                        t_roubleSum,                                    "
            + "\n" + "        t_clientCode, t_okvedCode, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                        "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                             "
            + "\n" + "   FROM (SELECT                                                                                                                    "
            + "\n" + "       credit.t_number          AS t_creditNumberForReport,                                                                        "
            + "\n" + "       credit.t_branchId        AS t_branchId,                                                                                     "
            + "\n" + "       credit.t_openDate        AS t_creditOpenDate,                                                                               "
            + "\n" + "       credit.t_aim             AS t_aim,                                                                                          "
            + "\n" + "       credit.t_clientType      AS t_clientType,                                                                                   "
            + "\n" + "       credit.t_contragentId    AS t_contractorId,                                                                                 "
            + "\n" + "       acc.t_Account            AS t_cbAccountNumber,                                                                              "
            + "\n" + "       DECODE(tranche.t_fiId, " + NATCUR + ", rep_data.getEndDate(), rcb_f302.getCreditRecalculateRateDate(credit.t_Id))   t_recalculateRateDate, "
            + "\n" + "       tranche.t_kind           AS t_trancheKind,                                                                                  "
            + "\n" + "       tranche.t_number         AS t_trancheNumber,                                                                                "
            + "\n" + "       tranche.t_lastIssueDate  AS t_trancheIssueDate,                                                                             "
            + "\n" + "       CHR(1)                   AS t_operationIssueDate,                                                                           "
            + "\n" + "       tranche.t_fiId           AS t_currencyId,                                                                                   "
            + "\n" + "       tranche.t_term           AS t_term,                                                                                         "
            + "\n" + "       tranche.t_initialInterestRate AS t_initialInterestRate,                                                                     "
            + "\n" + "       oper.t_sum               AS t_sum,                                                                                          "
            + "\n" + "       oper.t_roubleSum         AS t_roubleSum,                                                                                    "
            + "\n" + "       oper.t_id                AS t_id,                                                                                                  "
            + "\n" + "       (select c.t_code                                                                                                            "
            + "\n" + "          from drepPartyCodes_vw c                                                                                                 "
            + "\n" + "         where credit.t_contragentId = c.t_partyId and c.t_codeKind = 1) AS t_clientCode,                                          "
            + "\n" + getOkatoSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okatoCode,"
            + "\n" + getOkvedSubQuery("TO_CHAR(credit.t_contragentId, 'fm0000000000')", "oper.t_date") + " AS t_okvedCode,"
            + "\n" + "       party.t_isPhisical AS t_isPhysical,                                                                                         "
            + "\n" + "       party.t_isEmployer AS t_isEmployer,                                                                                         "
            + "\n" + "       party.t_isMsp AS t_isMsp,                                                                                                   "
            + "\n" + "       NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = credit.t_branchId), '99999') AS t_branchOkatoCode,    "
            + "\n" + "       NVL ((SELECT 1 FROM ddp_dep_dbt WHERE t_code = credit.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice, "
            + "\n" + "       credit.t_type AS t_contractType                                                                                             "
            + "\n" + "  FROM repLnsTranches_vw  tranche,                                                                                                 "
            + "\n" + "       repLnsContract_vw  credit,                                                                                                  "
            + "\n" + "       F302operation_tmp oper,                                                                                                    "
            + "\n" + "       df302Accounts_tmp  acc,                                                                                                      "
            + "\n" + "       (select p.t_id,                                                                                                             "
            + "\n" + "               p.t_isPhisical,                                                                                                     "
            + "\n" + "               p.t_isEmployer,                                                                                                     "
            + "\n" + "               CASE"
            + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', p.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
            + "\n" + "                       THEN 1"
            + "\n" + "                   ELSE 0"
            + "\n" + "               END t_isMsp"
            + "\n" + "          from drepParty_vw p) party                                                                                               "
            + "\n" + "  WHERE tranche.t_contractId = credit.t_id                                                                                         "
            + "\n" + "    AND party.t_id = credit.t_contragentId                                                                                         "
                        // Договор Открыт(Дата начала о.п., Дата окончания о.п.)
            + "\n" + "    AND credit.t_isOpened = 1"
                        // Тип договора = "Кредитный договор" или "Кредит по карте" или "Договор овердрафтного кредитования юр. лиц"
            + "\n" + "    AND credit.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "    AND oper.t_contractId = credit.t_id                                                                                            "
            + "\n" + "    AND acc.t_creditId = credit.t_id                                                                                             "
            + "\n" + "    AND acc.t_type = 'С'     "
            + "\n" + "    AND oper.t_trancheNumber = tranche.t_number                                                                                    "
            + "\n" + "    AND oper.t_trancheKind = tranche.t_kind                                                                                        "
            + "\n" + "    AND oper.t_type = " + PAYMENT
            + "\n" + "    AND oper.t_date >= rep_data.getBeginDate()                                                                                     "
            + "\n" + "    AND oper.t_date <= rep_data.getEndDate()                                                                                       "
            + "\n" + "    AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") + ")";

        TOperationProcessorImpl2627(TProcessor3129(query, "4,5", "t_accountmasks")).execute();
    end;
end;

//получить фильтр по маскам б/с просроченной задолженности по бэкофису
private macro getOverdueDebtMasks(alias : String, backOffice : Integer) : String
    var query =  "SELECT rep_account.convertMasksToSqlFormat(t_masks, " + getSqlString(alias) + ") AS t_overdueDebtMasks  "
        + "\n" + "  FROM (SELECT LISTAGG(t_accountMasksFor_8_9, ',') WITHIN GROUP (ORDER BY t_accountmasksFor_8_9) t_masks"
        + "\n" + "          FROM (SELECT DISTINCT                                                                         "
        + "\n" + "                       t_accountMasksFor_8_9                                                            "
        + "\n" + "                  FROM df302tuneTable_tmp                                                               "
        + "\n" + "                 WHERE NOT t_accountMasksFor_8_9 IS NULL                                                "
        + "\n" + "                   AND t_backOffice = " + backOffice
        + "\n" + "                )                                                                                       "
        + "\n" + "       )                                                                                                "
        ;

    var dataSet = TRsbDataSet(query);

    if (dataSet.MoveNext())
        return dataSet.overdueDebtMasks;
    else
        return "'(1 = 1)'";
    end;
end;

private class(fillTempTable3129) fillTempTable_Okved()
    initfillTempTable3129();

    m_dateExpression = getSqlDate(RcbApplication().currentReport.context.period.endDate);

    private macro getOkatoSubQuery(objectField : String, dateExpression : String)
         return " NVL(("
               + "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               + "\n" + "    FROM dobjattr_dbt att,                          "
               + "\n" + "         dobjatcor_dbt atc                          "
               + "\n" + "   WHERE atc.t_groupId        = 12                  "
               + "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM drepparty_vw repParty WHERE repParty.t_id = " + objectField + ")"
               + "\n" + "     AND atc.t_objectType     = 3                   "
               + "\n" + "     AND atc.t_general        = 'X'                 "
               + "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               + "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               + "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               + "\n" + "     AND atc.t_validFromDate <= " + dateExpression
               + "\n" + "     AND atc.t_validToDate   >= " + dateExpression
               + "\n" + "     AND rownum < 2                                 "
               + "\n" + "     ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               + "\n" + "               FROM dadress_dbt address"
               + "\n" + "              WHERE address.t_partyId = " + objectField
               + "\n" + "                AND address.t_type = 1"
               + "\n" + "            ), '99999'"
               + "\n" + "           )"
               + "\n" + "    )";
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
              + "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
              + "\n" + "    FROM dobjattr_dbt att,"
              + "\n" + "         dobjatcor_dbt atc                         "
              + "\n" + "   WHERE atc.t_groupId        = 17                          "
              + "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM drepparty_vw repParty WHERE repParty.t_id = " + objectField + ")"
              + "\n" + "     AND atc.t_objectType     = 3                           "
              + "\n" + "     AND atc.t_general        = 'X'                         "
              + "\n" + "     AND atc.t_attrId         = att.t_attrId                "
              + "\n" + "     AND atc.t_objectType     = att.t_objectType            "
              + "\n" + "     AND atc.t_groupId        = att.t_groupId               "
              + "\n" + "     AND atc.t_validFromDate <= " + dateExpression
              + "\n" + "             AND atc.t_validToDate   >= " + dateExpression
              + "\n" + "     AND rownum < 2                                         "
              + "\n" + "     ), NULL)";
    end;

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return " NVL(("
              + "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
              + "\n" + "    FROM dobjattr_dbt att,"
              + "\n" + "         dobjatcor_dbt atc                         "
              + "\n" + "   WHERE atc.t_groupId        = 64                          "
              + "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM drepparty_vw repParty WHERE repParty.t_id = " + objectField + ")"
              + "\n" + "     AND atc.t_objectType     = 3                           "
              + "\n" + "     AND atc.t_general        = 'X'                         "
              + "\n" + "     AND atc.t_attrId         = att.t_attrId                "
              + "\n" + "     AND atc.t_objectType     = att.t_objectType            "
              + "\n" + "     AND atc.t_groupId        = att.t_groupId               "
              + "\n" + "     AND atc.t_validFromDate <= " + dateExpression
              + "\n" + "             AND atc.t_validToDate   >= " + dateExpression
              + "\n" + "     AND rownum < 2                                         "
              + "\n" + "     ), NULL)";
    end;

    /*Для граф 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                                               "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                                   "
            + "\n" + "        t_cbAccountNumber,                                                                                                                            "
            + "\n" + "        CASE                                                                                                                                          "
            + "\n" + "            WHEN t_regsRest != 0                                                                                                                      "
            + "\n" + "                THEN rep_data.getEndDate()                                                                                                            "
            + "\n" + "            ELSE t_recalculateRateDate                                                                                                                "
            + "\n" + "        END t_recalculateRateDate,                                                                                                                    "
            + "\n" + "        t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                                           "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                                      "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "                 THEN t_sum                                                                                                                           "
            + "\n" + "             ELSE CASE                                                                                                                                "
            + "\n" + "                      WHEN t_regsRest != 0                                                                                                            "
            + "\n" + "                          THEN rsb_fiinstr.ConvSum(t_sum, t_currencyId, 0, rep_data.getEndDate(), 0)                                 "//алгоритм Сумма выданного кредита по договору по ОКАТО на дату выдачи
            + "\n" + "                      ELSE NVL((SELECT SUM(rsb_fiinstr.ConvSum(operation.t_sum, data2.t_currencyId, 0,  operation.t_date,0))                          "
            + "\n" + "                                  FROM F302operation_tmp operation                                                                                    "
            + "\n" + "                                 WHERE operation.t_trancheNumber = data2.t_trancheNumber                                                              "
            + "\n" + "                                   AND operation.t_trancheKind   = data2.t_trancheKind                                                                "
            + "\n" + "                                   AND operation.t_date         >= rep_data.getBeginDate()                                                            "
            + "\n" + "                                   AND operation.t_date         <= rep_data.getEndDate()                                                              "
            + "\n" + "                                   AND operation.t_type          = " + REPAYMENT + "), 0)                                                             "
            + "\n" + "                  END                                                                                                                                 "
            + "\n" + "        END t_roubleSum,                                                                                                                              "
            + "\n" + "        t_issueType, t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                             "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                "
            + "\n" + "   FROM (SELECT tranche.t_creditNumberForReport                                                                       AS t_creditNumberForReport,     "
            + "\n" + "                tranche.t_branchId                                                                                    AS t_branchId,                  "
            + "\n" + "                tranche.t_openDate                                                                                    AS t_creditOpenDate,            "
            + "\n" + "                tranche.t_aim                                                                                         AS t_aim,                       "
            + "\n" + "                tranche.t_clientType                                                                                  AS t_clientType,                "
            + "\n" + "                tranche.t_contragentId                                                                                AS t_contractorId,              "
            + "\n" + "                tranche.t_cbAccount                                                                                   AS t_cbAccountNumber,           "
            + "\n" + "                CASE                                                                                                                                  "
            + "\n" + "                    WHEN tranche.t_fiId = " + NATCUR
            + "\n" + "                        THEN rep_data.getEndDate()                                                                                                    "
            + "\n" + "                    ELSE CASE                                                                                                                         "
            + "\n" + "                             WHEN tranche.t_contractType = 2                                                                                          "
            + "\n" + "                                 THEN rcb_f302.getCreditRecalculateRateDate(tranche.t_contractId)                                                     "
            + "\n" + "                             ELSE oper.t_date                                                                                                         "
            + "\n" + "                         END                                                                                                                          "
            + "\n" + "                END                                                                                                   AS t_recalculateRateDate,       "
            + "\n" + "                (SELECT NVL(SUM(regs.t_rest), 0)                                                                                                      "
            + "\n" + "                   FROM F302REGISTER_VW regs                                                                                                          "
            + "\n" + "                  WHERE regs.t_trancheNumber = tranche.t_trancheNumber                                                                                "
            + "\n" + "                    AND regs.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                    AND regs.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ")                                  "
            + "\n" + "                )                                                                                                     AS t_regsRest,  --если 0, то Выданный кредит погашен в отчетном периоде (см. ТЗ), иначе не погашен"
            + "\n" + "                tranche.t_trancheKind                                                                                 AS t_trancheKind,               "
            + "\n" + "                tranche.t_trancheNumber                                                                               AS t_trancheNumber,             "
            + "\n" + "                tranche.t_lastIssueDate                                                                               AS t_trancheIssueDate,          "
            + "\n" + "                CHR(1)                                                                                                AS t_operationIssueDate,        "
            + "\n" + "                tranche.t_fiId                                                                                        AS t_currencyId,                "
            + "\n" + "                tranche.t_term                                                                                        AS t_term,                      "
            + "\n" + "                tranche.t_initialInterestRate                                                                         AS t_initialInterestRate,       "
            + "\n" + "                oper.t_sum                                                                                            AS t_sum,                       "
            + "\n" + "                oper.t_roubleSum                                                                                      AS t_roubleSum,                 "
            + "\n" + "                oper.t_id                                                                                             AS t_id,                        "
            + "\n" + "                contract.t_issueType                                                                                  AS t_issueType,                 "
            + "\n" + "                (SELECT c.t_code                                                                                                                      "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                           "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                          "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                  AS t_clientCode,                "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date")  + "           AS t_okatoCode,                 "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date")  + "           AS t_okvedCode,                 "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date") + "           AS t_okved2Code,                "
            + "\n" + "                tranche.t_isPhisical                                                                                  AS t_isPhysical,                "
            + "\n" + "                tranche.t_isEmployer                                                                                  AS t_isEmployer,                "
            + "\n" + "                tranche.t_isMsp                                                                                       AS t_isMsp,                     "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')   AS t_branchOkatoCode,           "
            + "\n" + "                NVL((SELECT 1                                                                                                                         "
            + "\n" + "                       FROM drepdpdep_vw                                                                                                              "
            + "\n" + "                      WHERE t_nodeId     = tranche.t_branchId                                                                                         "
            + "\n" + "                        AND t_nodetype   = 2                                                                                                          "
            + "\n" + "                        AND t_branchtype = 3), 0)                                                                     AS t_isOperOffice,              "
            + "\n" + "                tranche.t_contractType                                                                                AS t_contractType               "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                            "
            + "\n" + "                repLnsContract_vw contract,                                                                                                           "
            + "\n" + "                F302operation_tmp oper                                                                                                                "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_CREDIT + ")"
            + "\n" + "            AND oper.t_contractId    = tranche.t_contractId                                                                                           "
            + "\n" + "            AND oper.t_trancheNumber = tranche.t_trancheNumber                                                                                        "
            + "\n" + "            AND oper.t_trancheKind   = tranche.t_trancheKind                                                                                          "
            + "\n" + "            AND oper.t_contractId    = contract.t_id                                                                                                  "
            + "\n" + "            AND oper.t_type          = " + PAYMENT
            + "\n" + "            AND oper.t_date         >= rep_data.getBeginDate()                                                                                        "
            + "\n" + "            AND oper.t_date         <= rep_data.getEndDate()                                                                                          "
            + "\n" + "        )";

        TOperationProcessorImpl2627(TProcessor_Okved(query, "4,5", "t_accountmasks")).execute();
    end;

    macro processCreditOperation_Contract()
        var query =  " SELECT                                                                                                                                          "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                              "
            + "\n" + "        t_cbAccountNumber,                                                                                                                       "
            + "\n" + "        CASE                                                                                                                                     "
            + "\n" + "            WHEN t_regsRest != 0                                                                                                                 "
            + "\n" + "                THEN rep_data.getEndDate()                                                                                                       "
            + "\n" + "            ELSE t_recalculateRateDate                                                                                                           "
            + "\n" + "        END t_recalculateRateDate,                                                                                                               "
            + "\n" + "        t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                                      "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                                 "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                                          "
            + "\n" + "             ELSE CASE                                                                                                                           "
            + "\n" + "                      WHEN t_regsRest != 0                                                                                                       "
            + "\n" + "                          THEN rsb_fiinstr.ConvSum(t_sum, t_currencyId, 0, rep_data.getEndDate(), 0)                                 "//алгоритм Сумма выданного кредита по договору по ОКАТО на дату выдачи
            + "\n" + "                      ELSE NVL((SELECT SUM(rsb_fiinstr.ConvSum(operation.t_sum, data2.t_currencyId, 0,  operation.t_date,0))                     "
            + "\n" + "                                  FROM F302operation_tmp operation                                                                               "
            + "\n" + "                                 WHERE operation.t_trancheNumber = data2.t_trancheNumber                                                         "
            + "\n" + "                                   AND operation.t_trancheKind   = data2.t_trancheKind                                                           "
            + "\n" + "                                   AND operation.t_date         >= rep_data.getBeginDate()                                                       "
            + "\n" + "                                   AND operation.t_date         <= rep_data.getEndDate()                                                         "
            + "\n" + "                                   and operation.t_type          = " + REPAYMENT + "), 0)                                                        "
            + "\n" + "                  END                                                                                                                            "
            + "\n" + "        END t_roubleSum,                                                                                                                         "
            + "\n" + "        t_issueType, t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                        "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                           "
            + "\n" + "   FROM (SELECT tranche.t_creditNumberForReport                                                                       AS t_creditNumberForReport,"
            + "\n" + "                tranche.t_branchId                                                                                    AS t_branchId,             "
            + "\n" + "                tranche.t_openDate                                                                                    AS t_creditOpenDate,       "
            + "\n" + "                tranche.t_aim                                                                                         AS t_aim,                  "
            + "\n" + "                tranche.t_clientType                                                                                  AS t_clientType,           "
            + "\n" + "                tranche.t_contragentId                                                                                AS t_contractorId,         "
            + "\n" + "                acc.t_Account                                                                                         AS t_cbAccountNumber,      "
            + "\n" + "                CASE                                                                                                                             "
            + "\n" + "                    WHEN tranche.t_fiId = " + NATCUR
            + "\n" + "                        THEN rep_data.getEndDate()                                                                                               "
            + "\n" + "                    ELSE CASE                                                                                                                    "
            + "\n" + "                             WHEN tranche.t_contractType = 2                                                                                     "
            + "\n" + "                                 THEN rcb_f302.getCreditRecalculateRateDate(tranche.t_contractId)                                                "
            + "\n" + "                             ELSE oper.t_date                                                                                                    "
            + "\n" + "                         END                                                                                                                     "
            + "\n" + "                END                                                                                                   AS t_recalculateRateDate,  "
            + "\n" + "                (SELECT NVL(SUM(regs.t_rest), 0)                                                                                                 "
            + "\n" + "                   FROM F302REGISTER_VW regs                                                                                                     "
            + "\n" + "                  WHERE regs.t_trancheNumber = tranche.t_trancheNumber                                                                           "
            + "\n" + "                    AND regs.t_trancheKind   = tranche.t_trancheKind                                                                             "
            + "\n" + "                    AND regs.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ")                             "
            + "\n" + "                )                                                                                                     AS t_regsRest,  --если 0, то Выданный кредит погашен в отчетном периоде (см. ТЗ), иначе не погашен"
            + "\n" + "                tranche.t_trancheKind                                                                                 AS t_trancheKind,          "
            + "\n" + "                tranche.t_trancheNumber                                                                               AS t_trancheNumber,        "
            + "\n" + "                tranche.t_lastIssueDate                                                                               AS t_trancheIssueDate,     "
            + "\n" + "                CHR(1)                                                                                                AS t_operationIssueDate,   "
            + "\n" + "                tranche.t_fiId                                                                                        AS t_currencyId,           "
            + "\n" + "                tranche.t_term                                                                                        AS t_term,                 "
            + "\n" + "                tranche.t_initialInterestRate                                                                         AS t_initialInterestRate,  "
            + "\n" + "                oper.t_sum                                                                                            AS t_sum,                  "
            + "\n" + "                oper.t_roubleSum                                                                                      AS t_roubleSum,            "
            + "\n" + "                oper.t_id                                                                                             AS t_id,                   "
            + "\n" + "                contract.t_issueType                                                                                  AS t_issueType,            "
            + "\n" + "                (SELECT c.t_code                                                                                                                 "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                      "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                     "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                  AS t_clientCode,           "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date")  + "           AS t_okatoCode,            "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date")  + "           AS t_okvedCode,            "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", "oper.t_date") + "           AS t_okved2Code,           "
            + "\n" + "                tranche.t_isPhisical                                                                                  AS t_isPhysical,           "
            + "\n" + "                tranche.t_isEmployer                                                                                  AS t_isEmployer,           "
            + "\n" + "                tranche.t_isMsp                                                                                       AS t_isMsp,                "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')   AS t_branchOkatoCode,      "
            + "\n" + "                NVL((SELECT 1                                                                                                                    "
            + "\n" + "                       FROM drepdpdep_vw                                                                                                         "
            + "\n" + "                      WHERE t_nodeId     = tranche.t_branchId                                                                                    "
            + "\n" + "                        AND t_nodetype   = 2                                                                                                     "
            + "\n" + "                        AND t_branchtype = 3), 0)                                                                     AS t_isOperOffice,         "
            + "\n" + "                tranche.t_contractType                                                                                AS t_contractType          "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                       "
            + "\n" + "                F302operation_tmp oper,                                                                                                          "
            + "\n" + "                repLnsContract_vw contract,                                                                                                      "
            + "\n" + "                df302Accounts_tmp acc                                                                                                            "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "            AND oper.t_contractId    = tranche.t_contractId                                                                                      "
            + "\n" + "            AND acc.t_creditId       = tranche.t_contractId                                                                                      "
            + "\n" + "            AND acc.t_creditId       = contract.t_id                                                                                             "
            + "\n" + "            AND acc.t_type           = 'С'                                                                                                       "
            + "\n" + "            AND oper.t_trancheNumber = tranche.t_trancheNumber                                                                                   "
            + "\n" + "            AND oper.t_trancheKind   = tranche.t_trancheKind                                                                                     "
            + "\n" + "            AND oper.t_type          = " + PAYMENT
            + "\n" + "            AND oper.t_date         >= rep_data.getBeginDate()                                                                                   "
            + "\n" + "            AND oper.t_date         <= rep_data.getEndDate()                                                                                     "
            + "\n" + "      )";

        TOperationProcessorImpl2627(TProcessor_Okved(query, "4,5", "t_accountmasks")).execute();
    end;

    /*Для граф 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                     "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                tranche.t_cbAccount                                                                                           AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                              "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ") "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                   "
            + "\n" + "                (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate())                                       "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ") "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okvedCode,             "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_CREDIT + ")"
            + "\n" + "            AND contract.t_id = tranche.t_contractId                                                                                                      "
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для граф 6,7,8,9 (для счетов просрочки, привязанных к договору, а не траншу)*/
    macro processArrearsByContract_6_7_8_9()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                     "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                acc.t_account                                                                                                 AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                ABS(acc.t_outRest)                                                                                            AS t_sum,                   "
            + "\n" + "                ABS(RSB_FIINSTR.ConvSum (acc.t_outRest, acc.T_fiID, 0, rep_data.GetEndDate()))                                AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okvedCode,             "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                    "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE acc.t_creditId      = tranche.t_contractId                                                                                                "
            + "\n" + "            AND acc.t_trancheNumber = acc.t_creditId                                                                                                      "
            + "\n" + "            AND acc.t_trancheNumber = tranche.t_trancheNumber                                                                                             "
            + "\n" + "            AND contract.t_id       = tranche.t_contractId                                                                                                "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_CREDIT  + ", " + LO_KARTA + ")"
            + "\n" + "        )";

        TTrancheProcessorImpl2627(TProcessor_Okved(query, "6,7,8,9", "t_accountmasksFor_8_9")).execute();
    end;

    macro processTranche_6_7_Contract()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                     "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                acc.t_Account                                                                                                 AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                              "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", " + TDR_LIM + ")                                                                        "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                   "
            + "\n" + "                (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate())                                       "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", " + TDR_LIM + ")                                                                        "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okvedCode,             "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                    "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                               "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                             "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                            "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                            "
            + "\n" + "            AND acc.t_type              = 'С'                                                                                                             "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для граф 8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                                                  "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                             "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                       "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                              "
            + "\n" + "        t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                    "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                   "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                   "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport,"
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,             "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,       "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                  "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,           "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,         "
            + "\n" + "                acc.t_Account                                                                                                 AS t_cbAccountNumber,      "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')         "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                              "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                       "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                     "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,  "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,          "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,        "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,     "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,   "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,           "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                 "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,  "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                             "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                         "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                         "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                 "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                  "
            + "\n" + "                (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate())                                      "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                         "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                         "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                 "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,            "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,            "
            + "\n" + "                (SELECT c.t_code                                                                                                                         "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                              "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                             "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,           "
            + "\n" + "                " + getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okatoCode,            "
            + "\n" + "                " + getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                AS t_okvedCode,            "
            + "\n" + "                " + getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression) + "                AS t_okved2Code,           "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,           "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,           "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,      "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,         "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType          "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                               "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                   "
            + "\n" + "                repLnsContract_vw contract                                                                                                               "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                              "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                            "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                           "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                           "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_CREDIT + ")"
//            + "\n" + "            AND NOT acc.t_account IS NULL                                                                                                                "
//            + "\n" + "            AND acc.t_account <> CHR(1)                                                                                                                  "
            + "\n" + "            AND " + getOverdueDebtMasks("acc.t_balance", BOLoans)
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro processTranche_8_9_Contract()
        var query =  " SELECT                                                                                                                                                    "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                               "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                         "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                                "
            + "\n" + "        t_clientCode, t_okvedCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                      "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                     "
            + "\n" + "   FROM (SELECT null                                                                                                           AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                                AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                             AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                             AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                  AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                           AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                         AS t_contractorId,          "
            + "\n" + "                acc.t_Account                                                                                                  AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')           "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                                "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                         "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                       "
            + "\n" + "                 END)                                                                                                          AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                          AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                        AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                        AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                         AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                 AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                 AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                  AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                               "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                           "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                           "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                   "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                               AS t_sum,                   "
            + "\n" + "                (NVL((SELECT RSB_FIINSTR.ConvSum (SUM(reg.t_rest), MAX(reg.T_CURRENCYID), 0, rep_data.GetEndDate())                                        "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                           "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                           "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                   "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                               AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                           AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                           "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                                "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                               "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                           AS t_clientCode,            "
            + "\n" +                  getOkatoSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                     AS t_okatoCode,             "
            + "\n" +                  getOkvedSubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression)  + "                     AS t_okvedCode,             "
            + "\n" +                  getOkved2SubQuery("TO_CHAR(tranche.t_contragentId, 'fm0000000000')", m_dateExpression) + "                     AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                           AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                           AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                                AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')            AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0)  AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                         AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                 "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                     "
            + "\n" + "                repLnsContract_vw contract                                                                                                                 "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                                "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                              "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                             "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                             "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
//            + "\n" + "            AND NOT acc.t_account IS NULL                                                                                                                  "
//            + "\n" + "            AND acc.t_account <> CHR(1)                                                                                                                    "
            + "\n" + "            AND " + getOverdueDebtMasks("acc.t_balance", BOLoans)
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro execute()
        processTranche_6_7();
        processTranche_6_7_Contract();
        processArrearsByContract_6_7_8_9();
        processTranche_8_9();
        processTranche_8_9_Contract();
        processCreditOperation();
        processCreditOperation_Contract();
    end;
end;

private class(fillTempTable_Okved) fillTempTable_Okved_Т1_56_15_38_43598()
    initfillTempTable_Okved();

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return "NVL(("
           "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
           "\n" + "    FROM dobjattr_dbt att,                              "   // GWW  Правильнее, конечно использовать вьюху dRepCategory_vw, но тогда очень сильно замедляется расчет,
           "\n" + "         dobjatcor_dbt atc                              "   //      поэтому здесь используем таблицы напрямую. Не переделывать!
           "\n" + "   WHERE atc.t_groupId        = " + RCB_OBJGROUP_OKVED2_FOR_F302 +
           "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM dRepParty_vw repParty WHERE repParty.t_id = " + objectField + ")"
           "\n" + "     AND atc.t_objectType     = " + RCB_OBJTYPE_PARTY   +
           "\n" + "     AND atc.t_general        = 'X'                     "
           "\n" + "     AND atc.t_attrId         = att.t_attrId            "
           "\n" + "     AND atc.t_objectType     = att.t_objectType        "
           "\n" + "     AND atc.t_groupId        = att.t_groupId           "
           "\n" + "     AND atc.t_validFromDate <= " + dateExpression      +
           "\n" + "     AND atc.t_validToDate   >= " + dateExpression      +
           "\n" + "     AND rownum               = 1                       "
           "\n" + " ), "
           "\n" + " ("
           "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
           "\n" + "    FROM dobjattr_dbt att,                              "   // GWW  Правильнее, конечно использовать вьюху dRepCategory_vw, но тогда очень сильно замедляется расчет,
           "\n" + "         dobjatcor_dbt atc                              "   //      поэтому здесь используем таблицы напрямую. Не переделывать!
           "\n" + "   WHERE atc.t_groupId        = " + RCB_OBJGROUP_OKVED2 +
           "\n" + "     AND atc.t_object         = (SELECT repParty.t_objectId FROM dRepParty_vw repParty WHERE repParty.t_id = " + objectField + ")"
           "\n" + "     AND atc.t_objectType     = " + RCB_OBJTYPE_PARTY   +
           "\n" + "     AND atc.t_general        = 'X'                     "
           "\n" + "     AND atc.t_attrId         = att.t_attrId            "
           "\n" + "     AND atc.t_objectType     = att.t_objectType        "
           "\n" + "     AND atc.t_groupId        = att.t_groupId           "
           "\n" + "     AND atc.t_validFromDate <= " + dateExpression      +
           "\n" + "     AND atc.t_validToDate   >= " + dateExpression      +
           "\n" + "     AND rownum               = 1                       "
           "\n" + " )) "
    end;

    /*Для граф 4,5*/
    macro processCreditOperation()
        var query =  " SELECT                                                                                                                                               "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                                   "
            + "\n" + "        t_cbAccountNumber,                                                                                                                            "
            + "\n" + "        CASE                                                                                                                                          "
            + "\n" + "            WHEN t_regsRest != 0                                                                                                                      "
            + "\n" + "                THEN rep_data.getEndDate()                                                                                                            "
            + "\n" + "            ELSE t_recalculateRateDate                                                                                                                "
            + "\n" + "        END t_recalculateRateDate,                                                                                                                    "
            + "\n" + "        t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                                           "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                                      "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "                 THEN t_sum                                                                                                                           "
            + "\n" + "             ELSE CASE                                                                                                                                "
            + "\n" + "                      WHEN t_regsRest != 0                                                                                                            "
            + "\n" + "                          THEN rsb_fiinstr.ConvSumType(t_sum, t_currencyId, " + NATCUR + ", 7, rep_data.getEndDate())                                 "//алгоритм Сумма выданного кредита по договору по ОКАТО на дату выдачи
            + "\n" + "                      ELSE NVL((SELECT SUM(rsb_fiinstr.ConvSumType(operation.t_sum, data2.t_currencyId, " + NATCUR + ", 7, operation.t_date))         "
            + "\n" + "                                  FROM F302operation_tmp operation                                                                                    "
            + "\n" + "                                 WHERE operation.t_trancheNumber = data2.t_trancheNumber                                                              "
            + "\n" + "                                   AND operation.t_trancheKind   = data2.t_trancheKind                                                                "
            + "\n" + "                                   AND operation.t_date         >= rep_data.getBeginDate()                                                            "
            + "\n" + "                                   AND operation.t_date         <= rep_data.getEndDate()                                                              "
            + "\n" + "                                   AND operation.t_type          = " + REPAYMENT + "), 0)                                                             "
            + "\n" + "                  END                                                                                                                                 "
            + "\n" + "        END t_roubleSum,                                                                                                                              "
            + "\n" + "        t_issueType, t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                                          "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                "
            + "\n" + "   FROM (SELECT tranche.t_creditNumberForReport                                                                       AS t_creditNumberForReport,     "
            + "\n" + "                tranche.t_branchId                                                                                    AS t_branchId,                  "
            + "\n" + "                tranche.t_openDate                                                                                    AS t_creditOpenDate,            "
            + "\n" + "                tranche.t_aim                                                                                         AS t_aim,                       "
            + "\n" + "                tranche.t_clientType                                                                                  AS t_clientType,                "
            + "\n" + "                tranche.t_contragentId                                                                                AS t_contractorId,              "
            + "\n" + "                tranche.t_cbAccount                                                                                   AS t_cbAccountNumber,           "
            + "\n" + "                CASE                                                                                                                                  "
            + "\n" + "                    WHEN tranche.t_fiId = " + NATCUR
            + "\n" + "                        THEN rep_data.getEndDate()                                                                                                    "
            + "\n" + "                    ELSE CASE                                                                                                                         "
            + "\n" + "                             WHEN tranche.t_contractType = 2                                                                                          "
            + "\n" + "                                 THEN rcb_f302.getCreditRecalculateRateDate(tranche.t_contractId)                                                     "
            + "\n" + "                             ELSE oper.t_date                                                                                                         "
            + "\n" + "                         END                                                                                                                          "
            + "\n" + "                END                                                                                                   AS t_recalculateRateDate,       "
            + "\n" + "                (SELECT NVL(SUM(regs.t_rest), 0)                                                                                                      "
            + "\n" + "                   FROM F302REGISTER_VW regs                                                                                                          "
            + "\n" + "                  WHERE regs.t_trancheNumber = tranche.t_trancheNumber                                                                                "
            + "\n" + "                    AND regs.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                    AND regs.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ")                                  "
            + "\n" + "                )                                                                                                     AS t_regsRest,  --если 0, то Выданный кредит погашен в отчетном периоде (см. ТЗ), иначе не погашен"
            + "\n" + "                tranche.t_trancheKind                                                                                 AS t_trancheKind,               "
            + "\n" + "                tranche.t_trancheNumber                                                                               AS t_trancheNumber,             "
            + "\n" + "                tranche.t_lastIssueDate                                                                               AS t_trancheIssueDate,          "
            + "\n" + "                CHR(1)                                                                                                AS t_operationIssueDate,        "
            + "\n" + "                tranche.t_fiId                                                                                        AS t_currencyId,                "
            + "\n" + "                tranche.t_term                                                                                        AS t_term,                      "
            + "\n" + "                tranche.t_initialInterestRate                                                                         AS t_initialInterestRate,       "
            + "\n" + "                oper.t_sum                                                                                            AS t_sum,                       "
            + "\n" + "                oper.t_roubleSum                                                                                      AS t_roubleSum,                 "
            + "\n" + "                oper.t_id                                                                                             AS t_id,                        "
            + "\n" + "                contract.t_issueType                                                                                  AS t_issueType,                 "
            + "\n" + "                (SELECT c.t_code                                                                                                                      "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                           "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                          "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                  AS t_clientCode,                "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", "oper.t_date")  + "           AS t_okatoCode,                 "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", "oper.t_date") + "           AS t_okved2Code,                "
            + "\n" + "                tranche.t_isPhisical                                                                                  AS t_isPhysical,                "
            + "\n" + "                tranche.t_isEmployer                                                                                  AS t_isEmployer,                "
            + "\n" + "                tranche.t_isMsp                                                                                       AS t_isMsp,                     "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')   AS t_branchOkatoCode,           "
            + "\n" + "                NVL((SELECT 1                                                                                                                         "
            + "\n" + "                       FROM drepdpdep_vw                                                                                                              "
            + "\n" + "                      WHERE t_nodeId     = tranche.t_branchId                                                                                         "
            + "\n" + "                        AND t_nodetype   = 2                                                                                                          "
            + "\n" + "                        AND t_branchtype = 3), 0)                                                                     AS t_isOperOffice,              "
            + "\n" + "                tranche.t_contractType                                                                                AS t_contractType               "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                            "
            + "\n" + "                repLnsContract_vw contract,                                                                                                           "
            + "\n" + "                F302operation_tmp oper                                                                                                                "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_CREDIT + ")"
            + "\n" + "            AND oper.t_contractId    = tranche.t_contractId                                                                                           "
            + "\n" + "            AND oper.t_trancheNumber = tranche.t_trancheNumber                                                                                        "
            + "\n" + "            AND oper.t_trancheKind   = tranche.t_trancheKind                                                                                          "
            + "\n" + "            AND oper.t_contractId    = contract.t_id                                                                                                  "
            + "\n" + "            AND oper.t_type          = " + PAYMENT
            + "\n" + "            AND oper.t_date         >= rep_data.getBeginDate()                                                                                        "
            + "\n" + "            AND oper.t_date         <= rep_data.getEndDate()                                                                                          "
            + "\n" + "        )";

        TOperationProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "4,5", "t_accountmasks")).execute();
    end;

    macro processCreditOperation_Contract()
        var query =  " SELECT                                                                                                                                          "
            + "\n" + "        t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId,                                              "
            + "\n" + "        t_cbAccountNumber,                                                                                                                       "
            + "\n" + "        CASE                                                                                                                                     "
            + "\n" + "            WHEN t_regsRest != 0                                                                                                                 "
            + "\n" + "                THEN rep_data.getEndDate()                                                                                                       "
            + "\n" + "            ELSE t_recalculateRateDate                                                                                                           "
            + "\n" + "        END t_recalculateRateDate,                                                                                                               "
            + "\n" + "        t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                                      "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_id, t_isMsp,                                                 "
            + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
            + "\n" + "             THEN t_sum                                                                                                                          "
            + "\n" + "             ELSE CASE                                                                                                                           "
            + "\n" + "                      WHEN t_regsRest != 0                                                                                                       "
            + "\n" + "                          THEN rsb_fiinstr.ConvSumType(t_sum, t_currencyId, " + NATCUR + ", 7, rep_data.getEndDate())                            "//алгоритм Сумма выданного кредита по договору по ОКАТО на дату выдачи
            + "\n" + "                      ELSE NVL((SELECT SUM(rsb_fiinstr.ConvSumType(operation.t_sum, data2.t_currencyId, " + NATCUR + ", 7, operation.t_date))    "
            + "\n" + "                                  FROM F302operation_tmp operation                                                                               "
            + "\n" + "                                 WHERE operation.t_trancheNumber = data2.t_trancheNumber                                                         "
            + "\n" + "                                   AND operation.t_trancheKind   = data2.t_trancheKind                                                           "
            + "\n" + "                                   AND operation.t_date         >= rep_data.getBeginDate()                                                       "
            + "\n" + "                                   AND operation.t_date         <= rep_data.getEndDate()                                                         "
            + "\n" + "                                   and operation.t_type          = " + REPAYMENT + "), 0)                                                        "
            + "\n" + "                  END                                                                                                                            "
            + "\n" + "        END t_roubleSum,                                                                                                                         "
            + "\n" + "        t_issueType, t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_branchOkatoCode,                                     "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                           "
            + "\n" + "   FROM (SELECT tranche.t_creditNumberForReport                                                                       AS t_creditNumberForReport,"
            + "\n" + "                tranche.t_branchId                                                                                    AS t_branchId,             "
            + "\n" + "                tranche.t_openDate                                                                                    AS t_creditOpenDate,       "
            + "\n" + "                tranche.t_aim                                                                                         AS t_aim,                  "
            + "\n" + "                tranche.t_clientType                                                                                  AS t_clientType,           "
            + "\n" + "                tranche.t_contragentId                                                                                AS t_contractorId,         "
            + "\n" + "                acc.t_Account                                                                                         AS t_cbAccountNumber,      "
            + "\n" + "                CASE                                                                                                                             "
            + "\n" + "                    WHEN tranche.t_fiId = " + NATCUR
            + "\n" + "                        THEN rep_data.getEndDate()                                                                                               "
            + "\n" + "                    ELSE CASE                                                                                                                    "
            + "\n" + "                             WHEN tranche.t_contractType = 2                                                                                     "
            + "\n" + "                                 THEN rcb_f302.getCreditRecalculateRateDate(tranche.t_contractId)                                                "
            + "\n" + "                             ELSE oper.t_date                                                                                                    "
            + "\n" + "                         END                                                                                                                     "
            + "\n" + "                END                                                                                                   AS t_recalculateRateDate,  "
            + "\n" + "                (SELECT NVL(SUM(regs.t_rest), 0)                                                                                                 "
            + "\n" + "                   FROM F302REGISTER_VW regs                                                                                                     "
            + "\n" + "                  WHERE regs.t_trancheNumber = tranche.t_trancheNumber                                                                           "
            + "\n" + "                    AND regs.t_trancheKind   = tranche.t_trancheKind                                                                             "
            + "\n" + "                    AND regs.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ")                             "
            + "\n" + "                )                                                                                                     AS t_regsRest,  --если 0, то Выданный кредит погашен в отчетном периоде (см. ТЗ), иначе не погашен"
            + "\n" + "                tranche.t_trancheKind                                                                                 AS t_trancheKind,          "
            + "\n" + "                tranche.t_trancheNumber                                                                               AS t_trancheNumber,        "
            + "\n" + "                tranche.t_lastIssueDate                                                                               AS t_trancheIssueDate,     "
            + "\n" + "                CHR(1)                                                                                                AS t_operationIssueDate,   "
            + "\n" + "                tranche.t_fiId                                                                                        AS t_currencyId,           "
            + "\n" + "                tranche.t_term                                                                                        AS t_term,                 "
            + "\n" + "                tranche.t_initialInterestRate                                                                         AS t_initialInterestRate,  "
            + "\n" + "                oper.t_sum                                                                                            AS t_sum,                  "
            + "\n" + "                oper.t_roubleSum                                                                                      AS t_roubleSum,            "
            + "\n" + "                oper.t_id                                                                                             AS t_id,                   "
            + "\n" + "                contract.t_issueType                                                                                  AS t_issueType,            "
            + "\n" + "                (SELECT c.t_code                                                                                                                 "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                      "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                     "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                  AS t_clientCode,           "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", "oper.t_date")  + "           AS t_okatoCode,            "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", "oper.t_date") + "           AS t_okved2Code,           "
            + "\n" + "                tranche.t_isPhisical                                                                                  AS t_isPhysical,           "
            + "\n" + "                tranche.t_isEmployer                                                                                  AS t_isEmployer,           "
            + "\n" + "                tranche.t_isMsp                                                                                       AS t_isMsp,                "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')   AS t_branchOkatoCode,      "
            + "\n" + "                NVL((SELECT 1                                                                                                                    "
            + "\n" + "                       FROM drepdpdep_vw                                                                                                         "
            + "\n" + "                      WHERE t_nodeId     = tranche.t_branchId                                                                                    "
            + "\n" + "                        AND t_nodetype   = 2                                                                                                     "
            + "\n" + "                        AND t_branchtype = 3), 0)                                                                     AS t_isOperOffice,         "
            + "\n" + "                tranche.t_contractType                                                                                AS t_contractType          "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                       "
            + "\n" + "                F302operation_tmp oper,                                                                                                          "
            + "\n" + "                repLnsContract_vw contract,                                                                                                      "
            + "\n" + "                df302Accounts_tmp acc                                                                                                            "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "            AND oper.t_contractId    = tranche.t_contractId                                                                                      "
            + "\n" + "            AND acc.t_creditId       = tranche.t_contractId                                                                                      "
            + "\n" + "            AND acc.t_creditId       = contract.t_id                                                                                             "
            + "\n" + "            AND acc.t_type           = 'С'                                                                                                       "
            + "\n" + "            AND oper.t_trancheNumber = tranche.t_trancheNumber                                                                                   "
            + "\n" + "            AND oper.t_trancheKind   = tranche.t_trancheKind                                                                                     "
            + "\n" + "            AND oper.t_type          = " + PAYMENT
            + "\n" + "            AND oper.t_date         >= rep_data.getBeginDate()                                                                                   "
            + "\n" + "            AND oper.t_date         <= rep_data.getEndDate()                                                                                     "
            + "\n" + "      )";

        TOperationProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "4,5", "t_accountmasks")).execute();
    end;

    /*Для граф 6,7*/
    macro processTranche_6_7()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                                  "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                tranche.t_cbAccount                                                                                           AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                              "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ") "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                   "
            + "\n" + "                (NVL((SELECT rsb_fiinstr.ConvSumType(SUM(reg.t_rest), MAX(reg.T_CURRENCYID), " + NATCUR + ", 7, rep_data.GetEndDate())                    "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", "  + TDR_EXPREST + ", " + TDR_LIM + ", " + TDR_OV + ") "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE tranche.t_contractType IN (" + LO_CREDIT + ")"
            + "\n" + "            AND contract.t_id = tranche.t_contractId                                                                                                      "
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для граф 6,7,8,9 (для счетов просрочки, привязанных к договору, а не траншу)*/
    macro processArrearsByContract_6_7_8_9()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                                  "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                acc.t_account                                                                                                 AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                ABS(acc.t_outRest)                                                                                            AS t_sum,                   "
            + "\n" + "                ABS(rsb_fiinstr.ConvSumType(acc.t_outRest, acc.T_fiID, " + NATCUR + ", 7, rep_data.GetEndDate()))             AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                    "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE acc.t_creditId      = tranche.t_contractId                                                                                                "
            + "\n" + "            AND acc.t_trancheNumber = acc.t_creditId                                                                                                      "
            + "\n" + "            AND acc.t_trancheNumber = tranche.t_trancheNumber                                                                                             "
            + "\n" + "            AND contract.t_id       = tranche.t_contractId                                                                                                "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_CREDIT  + ", " + LO_KARTA + ")"
            + "\n" + "        )";

        TTrancheProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "6,7,8,9", "t_accountmasksFor_8_9")).execute();
    end;

    macro processTranche_6_7_Contract()
        var query =  " SELECT                                                                                                                                                   "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                              "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                        "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                               "
            + "\n" + "        t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                                  "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                    "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,          "
            + "\n" + "                acc.t_Account                                                                                                 AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')          "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                               "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                        "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                      "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                              "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", " + TDR_LIM + ")                                                                        "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                   "
            + "\n" + "                (NVL((SELECT rsb_fiinstr.ConvSumType(SUM(reg.t_rest), MAX(reg.T_CURRENCYID), " + NATCUR + ", 7, rep_data.GetEndDate())                    "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                          "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_MAINREST + ", " + TDR_LIM + ")                                                                        "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                  "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                          "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                               "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                              "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,            "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", m_dateExpression)  + "                AS t_okatoCode,             "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", m_dateExpression) + "                AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                    "
            + "\n" + "                repLnsContract_vw contract                                                                                                                "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                               "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                             "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                            "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                            "
            + "\n" + "            AND acc.t_type              = 'С'                                                                                                             "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "6,7", "t_accountmasks")).execute();
    end;

    /*Для граф 8,9 (Просроченная задолженность)*/
    macro processTranche_8_9()
        var query =  " SELECT                                                                                                                                                  "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                             "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                       "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                              "
            + "\n" + "        t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                                 "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                   "
            + "\n" + "   FROM (SELECT null                                                                                                          AS t_id,                   "
            + "\n" + "                tranche.t_creditNumberForReport                                                                               AS t_creditNumberForReport,"
            + "\n" + "                tranche.t_branchId                                                                                            AS t_branchId,             "
            + "\n" + "                tranche.t_openDate                                                                                            AS t_creditOpenDate,       "
            + "\n" + "                tranche.t_aim                                                                                                 AS t_aim,                  "
            + "\n" + "                tranche.t_clientType                                                                                          AS t_clientType,           "
            + "\n" + "                tranche.t_contragentId                                                                                        AS t_contractorId,         "
            + "\n" + "                acc.t_Account                                                                                                 AS t_cbAccountNumber,      "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')         "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                              "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                       "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                     "
            + "\n" + "                 END)                                                                                                         AS t_recalculateRateDate,  "
            + "\n" + "                tranche.t_trancheKind                                                                                         AS t_trancheKind,          "
            + "\n" + "                tranche.t_trancheNumber                                                                                       AS t_trancheNumber,        "
            + "\n" + "                tranche.t_lastIssueDate                                                                                       AS t_trancheIssueDate,     "
            + "\n" + "                CHR(1)                                                                                                        AS t_operationIssueDate,   "
            + "\n" + "                tranche.t_fiId                                                                                                AS t_currencyId,           "
            + "\n" + "                tranche.t_term                                                                                                AS t_term,                 "
            + "\n" + "                tranche.t_initialInterestRate                                                                                 AS t_initialInterestRate,  "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                             "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                         "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                         "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                 "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_sum,                  "
            + "\n" + "                (NVL((SELECT rsb_fiinstr.ConvSumType(SUM(reg.t_rest), MAX(reg.T_CURRENCYID), " + NATCUR + ", 7, rep_data.GetEndDate())                   "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                         "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                         "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                 "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                              AS t_roubleSum,            "
            + "\n" + "                contract.t_issueType                                                                                          AS t_issueType,            "
            + "\n" + "                (SELECT c.t_code                                                                                                                         "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                              "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                             "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                          AS t_clientCode,           "
            + "\n" + "                " + getOkatoSubQuery("tranche.t_contragentId", m_dateExpression)  + "                AS t_okatoCode,            "
            + "\n" + "                " + getOkved2SubQuery("tranche.t_contragentId", m_dateExpression) + "                AS t_okved2Code,           "
            + "\n" + "                tranche.t_isPhisical                                                                                          AS t_isPhysical,           "
            + "\n" + "                tranche.t_isEmployer                                                                                          AS t_isEmployer,           "
            + "\n" + "                tranche.t_isMsp                                                                                               AS t_isMsp,                "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')           AS t_branchOkatoCode,      "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0) AS t_isOperOffice,         "
            + "\n" + "                tranche.t_contractType                                                                                        AS t_contractType          "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                               "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                   "
            + "\n" + "                repLnsContract_vw contract                                                                                                               "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                              "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                            "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                           "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                           "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_CREDIT + ")"
            + "\n" + "            AND " + getOverdueDebtMasks("acc.t_balance", BOLoans)
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;

    macro processTranche_8_9_Contract()
        var query =  " SELECT                                                                                                                                                    "
            + "\n" + "        t_id, t_creditNumberForReport, t_branchId, t_creditOpenDate, t_aim, t_clientType, t_contractorId, t_cbAccountNumber,                               "
            + "\n" + "        t_recalculateRateDate, t_trancheKind, t_trancheNumber, t_trancheIssueDate,                                                                         "
            + "\n" + "        t_operationIssueDate, t_currencyId, t_term, t_initialInterestRate, t_sum, t_roubleSum, t_issueType,                                                "
            + "\n" + "        t_clientCode, t_okved2Code, t_okatoCode, t_isPhysical, t_isEmployer, t_isMsp, t_branchOkatoCode,                                                   "
            + "\n" + "        t_isOperOffice, t_contractType                                                                                                                     "
            + "\n" + "   FROM (SELECT null                                                                                                           AS t_id,                    "
            + "\n" + "                tranche.t_creditNumberForReport                                                                                AS t_creditNumberForReport, "
            + "\n" + "                tranche.t_branchId                                                                                             AS t_branchId,              "
            + "\n" + "                tranche.t_openDate                                                                                             AS t_creditOpenDate,        "
            + "\n" + "                tranche.t_aim                                                                                                  AS t_aim,                   "
            + "\n" + "                tranche.t_clientType                                                                                           AS t_clientType,            "
            + "\n" + "                tranche.t_contragentId                                                                                         AS t_contractorId,          "
            + "\n" + "                acc.t_Account                                                                                                  AS t_cbAccountNumber,       "
            + "\n" + "                (CASE WHEN (    tranche.t_CloseDate <  TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')           "
            + "\n" + "                            AND tranche.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                                "
            + "\n" + "                          THEN tranche.t_closeDate                                                                                                         "
            + "\n" + "                      ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                                       "
            + "\n" + "                 END)                                                                                                          AS t_recalculateRateDate,   "
            + "\n" + "                tranche.t_trancheKind                                                                                          AS t_trancheKind,           "
            + "\n" + "                tranche.t_trancheNumber                                                                                        AS t_trancheNumber,         "
            + "\n" + "                tranche.t_lastIssueDate                                                                                        AS t_trancheIssueDate,      "
            + "\n" + "                CHR(1)                                                                                                         AS t_operationIssueDate,    "
            + "\n" + "                tranche.t_fiId                                                                                                 AS t_currencyId,            "
            + "\n" + "                tranche.t_term                                                                                                 AS t_term,                  "
            + "\n" + "                tranche.t_initialInterestRate                                                                                  AS t_initialInterestRate,   "
            + "\n" + "                (NVL((SELECT SUM(reg.t_rest)                                                                                                               "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                           "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                           "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                   "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                               AS t_sum,                   "
            + "\n" + "                (NVL((SELECT rsb_fiinstr.ConvSumType(SUM(reg.t_rest), MAX(reg.T_CURRENCYID), " + NATCUR + ", 7, rep_data.GetEndDate())                     "
            + "\n" + "                        FROM F302REGISTER_VW reg                                                                                                           "
            + "\n" + "                       WHERE reg.t_type IN (" + TDR_EXPREST + ", " + TDR_OV + ")                                                                           "
            + "\n" + "                         AND reg.t_trancheKind   = tranche.t_trancheKind                                                                                   "
            + "\n" + "                         AND reg.t_trancheNumber = tranche.t_trancheNumber), 0))                                               AS t_roubleSum,             "
            + "\n" + "                contract.t_issueType                                                                                           AS t_issueType,             "
            + "\n" + "                (SELECT c.t_code                                                                                                                           "
            + "\n" + "                   FROM drepPartyCodes_vw c                                                                                                                "
            + "\n" + "                  WHERE tranche.t_contragentId = c.t_partyId                                                                                               "
            + "\n" + "                    AND c.t_codeKind           = " + PTCK_CONTR + ")                                                           AS t_clientCode,            "
            + "\n" +                  getOkatoSubQuery("tranche.t_contragentId", m_dateExpression)  + "                     AS t_okatoCode,             "
            + "\n" +                  getOkved2SubQuery("tranche.t_contragentId", m_dateExpression) + "                     AS t_okved2Code,            "
            + "\n" + "                tranche.t_isPhisical                                                                                           AS t_isPhysical,            "
            + "\n" + "                tranche.t_isEmployer                                                                                           AS t_isEmployer,            "
            + "\n" + "                tranche.t_isMsp                                                                                                AS t_isMsp,                 "
            + "\n" + "                NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = tranche.t_branchId), '99999')            AS t_branchOkatoCode,       "
            + "\n" + "                NVL((SELECT 1 FROM ddp_dep_dbt WHERE t_code = tranche.t_branchId AND t_nodetype = 2 AND t_branchtype = 3), 0)  AS t_isOperOffice,          "
            + "\n" + "                tranche.t_contractType                                                                                         AS t_contractType           "
            + "\n" + "           FROM df302Tranches_tmp tranche,                                                                                                                 "
            + "\n" + "                df302Accounts_tmp acc,                                                                                                                     "
            + "\n" + "                repLnsContract_vw contract                                                                                                                 "
            + "\n" + "          WHERE tranche.t_trancheKind   = acc.t_trancheKind                                                                                                "
            + "\n" + "            AND tranche.t_trancheNumber = acc.t_trancheNumber                                                                                              "
            + "\n" + "            AND acc.t_creditId          = tranche.t_contractId                                                                                             "
            + "\n" + "            AND contract.t_id           = tranche.t_contractId                                                                                             "
            + "\n" + "            AND tranche.t_contractType IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
            + "\n" + "            AND " + getOverdueDebtMasks("acc.t_balance", BOLoans)
            + "\n" + "      )";

        TTrancheProcessorImpl2627(TProcessor_Okved_Т1_56_15_38_43598(query, "6,7,8,9", "t_accountmasksfor_8_9")).execute();
    end;
end;

class TDepositsF302()
    var m_tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");

    macro getBalanceMasks()
        var dataSet;

        m_tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BODeposits);
        m_tuneTable.setInstructionFilter(RCB_I2539_DATE);

        dataSet = m_tuneTable.getDataSet();

        if (dataSet.moveNext())
            return dataSet.accountMasks;
        else
            return "";
        end;
    end;

    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        strQuery = "SELECT " + BODeposits + "                                      t_backoffice,         "
          + "\n" + "       CASE WHEN t_branchOkatoCode <> '99999'                                        "
          + "\n" + "            THEN rpad(substr(t_branchOkatoCode, 1, 2), 5, '0')                       "
          + "\n" + "            ELSE t_branchOkatoCode                                                   "
          + "\n" + "       END                                                     t_okatoCode,          "
          + "\n" + "       '1.1'                                                   t_row,                "
          + "\n" + "                                                               t_column,             "
          + "\n" + "                                                               t_number,             "
          + "\n" + "        CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "             THEN t_roubleSum                                                        "
          + "\n" + "             ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "        END                                                    t_roubleSum,          "
          + "\n" + "                                                               t_currencySum,        "
          + "\n" + "                                                               t_contractorId,       "
          + "\n" + "                                                               t_clientCode,         "
          + "\n" + "                                                               t_shortName,          "
          + "\n" + "                                                               t_recalculateRateDate,"
          + "\n" + "                                                               t_clientKind,         "
          + "\n" + "                                                               t_currencyId          "
          + "\n" + "  FROM ( SELECT                                                                                                                   "
          + "\n" + "               NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')  t_branchOkatoCode,    "
          + "\n" + "               CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                    THEN 4                                                                                                           "
          + "\n" + "                    ELSE 5                                                                                                           "
          + "\n" + "               END                                                                                             t_column,             "
          + "\n" + "               lc.t_number                                                                                     t_number,             "
          + "\n" + "               la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "               la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "               lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "               (select c.t_code                                                                                                      "
          + "\n" + "                  from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                 where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "               (select c.t_shortName                                                                                                 "
          + "\n" + "                  from drepParty_vw c                                                                                                "
          + "\n" + "                 where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "               CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                          AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                    THEN lc.t_closeDate                                                                                              "
          + "\n" + "                    ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "               END                                                                                             t_recalculateRateDate,"
          + "\n" + "               (SELECT                                                                                                               "
          + "\n" + "                     CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                          WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 0 THEN 'Ф'                                          "
          + "\n" + "                          WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                          ELSE CHR(1)                                                                                                "
          + "\n" + "                      END                                                                                                            "
          + "\n" + "                  FROM drepParty_vw party                                                                                            "
          + "\n" + "                 WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "              la.t_fiId                                                                                        t_currencyId          "
          + "\n" + "         FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                       "
          + "\n" + "        WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "          AND la.t_type = 'Д'                                                                                                        "
          + "\n" + "          AND la.t_isTechnical != 'X'                                                                                                "
          + "\n" + "          AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "          AND lc.t_isopened = 1                                                                                                      "
          + "\n" + "          AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "          AND NOT EXISTS (SELECT 1                                                                                                   "
          + "\n" + "                            FROM repLnsUserField_vw lu                                                                               "
          + "\n" + "                           WHERE lu.t_objectNumber = lc.t_id                                                                         "
          + "\n" + "                             AND lu.t_value = 'X'                                                                                    "
          + "\n" + "                             AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + " WHERE t_roubleSum != 0                                                                                                              ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;
end;

// Расчет по данным Депозитов, 2742-У
class (TDepositsF302) TDepositProcessor2742()

    macro getBalanceMasks()
        var dataSet;

        m_tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        m_tuneTable.setInstructionFilter(RCB_I2742_DATE);

        dataSet = m_tuneTable.getDataSet();

        if (dataSet.moveNext())
            return dataSet.accountMasks;
        else
            return "";
        end;
    end;

    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        strQuery = "SELECT " + BODeposits + "                                      t_backoffice,         "
          + "\n" + "       CASE WHEN t_branchOkatoCode <> '99999'                                        "
          + "\n" + "            THEN rpad(substr(t_branchOkatoCode, 1, 2), 5, '0')                       "
          + "\n" + "            ELSE t_branchOkatoCode                                                   "
          + "\n" + "       END                                                     t_okatoCode,          "
          + "\n" + "       '1.7'                                                   t_row,                "
          + "\n" + "       t_column,             "
          + "\n" + "       t_number,             "
          + "\n" + "       CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "            THEN t_roubleSum                                                        "
          + "\n" + "            ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "       END                                                     t_roubleSum,          "
          + "\n" + "       t_currencySum,        "
          + "\n" + "       t_contractorId,       "
          + "\n" + "       t_clientCode,         "
          + "\n" + "       t_shortName,          "
          + "\n" + "       t_recalculateRateDate,"
          + "\n" + "       t_clientKind,         "
          + "\n" + "       t_currencyId          "
          + "\n" + "  FROM (SELECT NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')  t_branchOkatoCode,    "
          + "\n" + "               CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                    THEN 4                                                                                                           "
          + "\n" + "                    ELSE 5                                                                                                           "
          + "\n" + "               END                                                                                             t_column,             "
          + "\n" + "               lc.t_number                                                                                     t_number,             "
          + "\n" + "               la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "               la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "               lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "               (select c.t_code                                                                                                      "
          + "\n" + "                  from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                 where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "               (select c.t_shortName                                                                                                 "
          + "\n" + "                  from drepParty_vw c                                                                                                "
          + "\n" + "                 where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "               CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                          AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                    THEN lc.t_closeDate                                                                                              "
          + "\n" + "                    ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "               END                                                                                             t_recalculateRateDate,"
          + "\n" + "               (SELECT                                                                                                               "
          + "\n" + "                     CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                          WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 0 THEN 'Ф'                                          "
          + "\n" + "                          WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                          ELSE CHR(1)                                                                                                "
          + "\n" + "                      END                                                                                                            "
          + "\n" + "                  FROM drepParty_vw party                                                                                            "
          + "\n" + "                 WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "               la.t_fiId                                                                                       t_currencyId          "
          + "\n" + "          FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                       "
          + "\n" + "         WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "           AND la.t_type = 'Д'                                                                                                        "
          + "\n" + "           AND la.t_isTechnical != 'X'                                                                                                "
          + "\n" + "           AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "           AND lc.t_isopened = 1                                                                                                      "
          + "\n" + "           AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "           AND NOT EXISTS (SELECT 1                                                                                                   "
          + "\n" + "                             FROM repLnsUserField_vw lu                                                                               "
          + "\n" + "                            WHERE lu.t_objectNumber = lc.t_id                                                                         "
          + "\n" + "                              AND lu.t_value = 'X'                                                                                    "
          + "\n" + "                              AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + " WHERE t_roubleSum != 0                                                                                                              ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;

    initTDepositsF302();
end;

class (TDepositProcessor2742) TDepositProcessor2926()
    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        strQuery = "WITH depData AS (                                                                                            "
          + "\n" + "      SELECT " + BODeposits + "                                      t_backoffice,                           "
          + "\n" + "             t_branchOkatoCode                                       t_okatoCode,                            "
          + "\n" + "             '1.7'                                                   t_row,                                  "
          + "\n" + "             t_column,                                                                                       "
          + "\n" + "             t_number,                                                                                       "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                           "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "             END                                                     t_roubleSum,                            "
          + "\n" + "             t_currencySum,                                                                                  "
          + "\n" + "             t_contractorId,                                                                                 "
          + "\n" + "             t_clientCode,                                                                                   "
          + "\n" + "             t_shortName,                                                                                    "
          + "\n" + "             t_recalculateRateDate,                                                                          "
          + "\n" + "             t_clientKind,                                                                                   "
          + "\n" + "             t_currencyId                                                                                    "
          + "\n" + "        FROM (SELECT NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')  t_branchOkatoCode,    "
          + "\n" + "                     CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                          THEN 4                                                                                                           "
          + "\n" + "                          ELSE 5                                                                                                           "
          + "\n" + "                     END                                                                                             t_column,             "
          + "\n" + "                     lc.t_number                                                                                     t_number,             "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "                     (select c.t_code                                                                                                      "
          + "\n" + "                        from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                       where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "                     (select c.t_shortName                                                                                                 "
          + "\n" + "                        from drepParty_vw c                                                                                                "
          + "\n" + "                       where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "                     CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                          THEN lc.t_closeDate                                                                                              "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,"
          + "\n" + "                     (SELECT                                                                                                               "
          + "\n" + "                           CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 0 THEN 'Ф'                                          "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                                ELSE CHR(1)                                                                                                "
          + "\n" + "                            END                                                                                                            "
          + "\n" + "                        FROM drepParty_vw party                                                                                            "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId          "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                      "
          + "\n" + "               WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type = 'Д'                                                                                                       "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                               "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened = 1                                                                                                     "
          + "\n" + "                 AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "                 AND NOT EXISTS (SELECT 1                                                                                                  "
          + "\n" + "                                   FROM repLnsUserField_vw lu                                                                              "
          + "\n" + "                                  WHERE lu.t_objectNumber = lc.t_id                                                                        "
          + "\n" + "                                    AND lu.t_value = 'X'                                                                                   "
          + "\n" + "                                    AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + "       WHERE t_roubleSum != 0 )                                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + "UNION ALL                                                                                             "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "    FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                      "
          + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1             ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;
    initTDepositProcessor2742();
end;

class (TDepositProcessor2926) TDepositProcessor3269()
    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        strQuery = "WITH depData AS (                                                                                            "
          + "\n" + "      SELECT " + BODeposits + "                                      t_backoffice,                           "
          + "\n" + "             t_branchOkatoCode                                       t_okatoCode,                            "
          + "\n" + "             CASE WHEN t_clientKind = 'П'"
          + "\n" + "                  THEN '1.7'                                                                           "
          + "\n" + "                  ELSE '1.8'"
          + "\n" + "             END                                                     t_row,                            "
          + "\n" + "             t_column,                                                                                       "
          + "\n" + "             t_number,                                                                                       "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                           "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "             END                                                     t_roubleSum,                            "
          + "\n" + "             t_currencySum,                                                                                  "
          + "\n" + "             t_contractorId,                                                                                 "
          + "\n" + "             t_clientCode,                                                                                   "
          + "\n" + "             t_shortName,                                                                                    "
          + "\n" + "             t_recalculateRateDate,                                                                          "
          + "\n" + "             t_clientKind,                                                                                   "
          + "\n" + "             t_currencyId                                                                                    "
          + "\n" + "        FROM (SELECT NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')  t_branchOkatoCode,    "
          + "\n" + "                     CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                          THEN 4                                                                                                           "
          + "\n" + "                          ELSE 5                                                                                                           "
          + "\n" + "                     END                                                                                             t_column,             "
          + "\n" + "                     lc.t_number                                                                                     t_number,             "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "                     (select c.t_code                                                                                                      "
          + "\n" + "                        from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                       where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "                     (select c.t_shortName                                                                                                 "
          + "\n" + "                        from drepParty_vw c                                                                                                "
          + "\n" + "                       where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "                     CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                          THEN lc.t_closeDate                                                                                              "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,"
          + "\n" + "                     (SELECT                                                                                                               "
          + "\n" + "                           CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                                ELSE CHR(1)                                                                                                "
          + "\n" + "                            END                                                                                                            "
          + "\n" + "                        FROM drepParty_vw party                                                                                            "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId          "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                      "
          + "\n" + "               WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type = 'Д'                                                                                                       "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                               "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened = 1                                                                                                     "
          + "\n" + "                 AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "                 AND NOT EXISTS (SELECT 1                                                                                                  "
          + "\n" + "                                   FROM repLnsUserField_vw lu                                                                              "
          + "\n" + "                                  WHERE lu.t_objectNumber = lc.t_id                                                                        "
          + "\n" + "                                    AND lu.t_value = 'X'                                                                                   "
          + "\n" + "                                    AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + "       WHERE t_roubleSum != 0                                                                                                              "
          + "\n" + "         AND t_clientKind IN ('Ю', 'П') )                                                                                                  "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + "UNION ALL                                                                                             "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "    FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                      "
          + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1             ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;
    initTDepositProcessor2926();
end;

class (TDepositProcessor3269) TDepositProcessor3468()
    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        strQuery = "WITH depData AS (                                                                                            "
          + "\n" + "      SELECT " + BODeposits + "                                      t_backoffice,                           "
          + "\n" + "             t_branchOkatoCode                                       t_okatoCode,                            "
          + "\n" + "             CASE WHEN t_clientKind = 'П'"
          + "\n" + "                  THEN '1.7'                                                                                 "
          + "\n" + "                  ELSE '1.8'"
          + "\n" + "             END                                                     t_row,                                  "
          + "\n" + "             t_column,                                                                                       "
          + "\n" + "             t_number,                                                                                       "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                           "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "             END                                                     t_roubleSum,                            "
          + "\n" + "             t_currencySum,                                                                                  "
          + "\n" + "             t_contractorId,                                                                                 "
          + "\n" + "             t_clientCode,                                                                                   "
          + "\n" + "             t_shortName,                                                                                    "
          + "\n" + "             t_recalculateRateDate,                                                                          "
          + "\n" + "             t_clientKind,                                                                                   "
          + "\n" + "             t_currencyId                                                                                    "
          + "\n" + "        FROM (SELECT CASE                                                                                                                  "
          + "\n" + "                         WHEN lc.t_okatoTsOpenDep = CHR(1)"
          + "\n" + "                         THEN NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')"
          + "\n" + "                         ELSE lc.t_okatoTsOpenDep"
          + "\n" + "                     END                                                                                             t_branchOkatoCode,    "
          + "\n" + "                     CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                          THEN 4                                                                                                           "
          + "\n" + "                          ELSE 5                                                                                                           "
          + "\n" + "                     END                                                                                             t_column,             "
          + "\n" + "                     lc.t_number                                                                                     t_number,             "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "                     (select c.t_code                                                                                                      "
          + "\n" + "                        from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                       where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "                     (select c.t_shortName                                                                                                 "
          + "\n" + "                        from drepParty_vw c                                                                                                "
          + "\n" + "                       where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "                     CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                          THEN lc.t_closeDate                                                                                              "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,"
          + "\n" + "                     (SELECT                                                                                                               "
          + "\n" + "                           CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                                ELSE CHR(1)                                                                                                "
          + "\n" + "                            END                                                                                                            "
          + "\n" + "                        FROM drepParty_vw party                                                                                            "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId          "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                      "
          + "\n" + "               WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type = 'Д'                                                                                                       "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                               "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened = 1                                                                                                     "
          + "\n" + "                 AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "                 AND NOT EXISTS (SELECT 1                                                                                                  "
          + "\n" + "                                   FROM repLnsUserField_vw lu                                                                              "
          + "\n" + "                                  WHERE lu.t_objectNumber = lc.t_id                                                                        "
          + "\n" + "                                    AND lu.t_value = 'X'                                                                                   "
          + "\n" + "                                    AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + "       WHERE t_roubleSum != 0                                                                                                              "
          + "\n" + "         AND t_clientKind IN ('Ю', 'П') )                                                                                                  "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + "UNION ALL                                                                                             "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "    FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                      "
          + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1             ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;
    initTDepositProcessor3269();
end;

class (TDepositProcessor3468) TDepositProcessor_Okved()
    macro fillTempTableDeposit()
        var accountMasks = getBalanceMasks();
        var strQuery;

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_OKVED_DATE);

        strQuery = "WITH depData AS (                                                                                            "
          + "\n" + "      SELECT " + BODeposits + "                                      t_backoffice,                           "
          + "\n" + "             t_branchOkatoCode                                       t_okatoCode,                            "
          + "\n" + "             CASE WHEN t_clientKind = 'П'"
          + "\n" + "                  THEN '1.7'                                                                                 "
          + "\n" + "                  ELSE '1.8'"
          + "\n" + "             END                                                     t_row,                                  "
          + "\n" + "             t_column,                                                                                       "
          + "\n" + "             t_number,                                                                                       "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                           "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "             END                                                     t_roubleSum,                            "
          + "\n" + "             t_currencySum,                                                                                  "
          + "\n" + "             t_contractorId,                                                                                 "
          + "\n" + "             t_clientCode,                                                                                   "
          + "\n" + "             t_shortName,                                                                                    "
          + "\n" + "             t_recalculateRateDate,                                                                          "
          + "\n" + "             t_clientKind,                                                                                   "
          + "\n" + "             t_currencyId                                                                                    "
          + "\n" + "        FROM (SELECT CASE                                                                                                                  "
          + "\n" + "                         WHEN lc.t_okatoTsOpenDep = CHR(1)"
          + "\n" + "                         THEN NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')"
          + "\n" + "                         ELSE lc.t_okatoTsOpenDep"
          + "\n" + "                     END                                                                                             t_branchOkatoCode,    "
          + "\n" + "                     CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                          THEN 4                                                                                                           "
          + "\n" + "                          ELSE 5                                                                                                           "
          + "\n" + "                     END                                                                                             t_column,             "
          + "\n" + "                     lc.t_number                                                                                     t_number,             "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "                     (select c.t_code                                                                                                      "
          + "\n" + "                        from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                       where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "                     (select c.t_shortName                                                                                                 "
          + "\n" + "                        from drepParty_vw c                                                                                                "
          + "\n" + "                       where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "                     CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                          THEN lc.t_closeDate                                                                                              "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,"
          + "\n" + "                     (SELECT                                                                                                               "
          + "\n" + "                           CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                                ELSE CHR(1)                                                                                                "
          + "\n" + "                            END                                                                                                            "
          + "\n" + "                        FROM drepParty_vw party                                                                                            "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId          "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                      "
          + "\n" + "               WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type = 'Д'                                                                                                       "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                               "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened = 1                                                                                                     "
          + "\n" + "                 AND " + convertMaskToSqlFormat(accountMasks, "la.t_account")
          + "\n" + "                 AND NOT EXISTS (SELECT 1                                                                                                  "
          + "\n" + "                                   FROM repLnsUserField_vw lu                                                                              "
          + "\n" + "                                  WHERE lu.t_objectNumber = lc.t_id                                                                        "
          + "\n" + "                                    AND lu.t_value = 'X'                                                                                   "
          + "\n" + "                                    AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + "       WHERE t_roubleSum != 0                                                                                                              "
          + "\n" + "         AND t_clientKind IN (" + ternary(isBackofficeSet(BOLoans, RCB_OKVED_DATE, "2", "1.8", "4,5"), "'Ю'", "''") + ","
                                                    + ternary(isBackofficeSet(BOLoans, RCB_OKVED_DATE, "2", "1.7", "4,5"), "'П'", "''") + "))"
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + "UNION ALL                                                                                             "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "    FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                      "
          + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1             ";

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;

    initTDepositProcessor3468();
end;

class (TDepositProcessor_Okved) TDepositProcessor_Okved_XXXX4(instruction)
    var m_instruction = instruction;

    macro getBalanceMasks(instruction, row)
        var dataSet;
        var masks  = "";
        var filter = "t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId() + ternary(row != null, " AND t_row = " + row, "");

        m_tuneTable.setUserFilter(filter);
        m_tuneTable.setInstructionFilter(instruction);

        dataSet = m_tuneTable.getDataSet();

        if (dataSet.moveNext())
            masks = dataSet.accountMasks;

            while (dataSet.moveNext())
                masks = masks + "," + dataSet.accountMasks;
            end;

            return masks;
        else
            return "";
        end;
    end;

    //на объекте установлена категория
    private macro hasAssignedCategory(objectType : Integer, objectId : String, groupID : Integer, listCategory : String) : String
        var filter = "";
        if (listCategory != NULL)
            filter = "EXISTS (SELECT 1"
              +"\n"+ "          FROM dRepCategory_vw atc"
              +"\n"+ "         WHERE atc.t_objectType = " + objectType
              +"\n"+ "           AND atc.t_id         = " + groupID
              +"\n"+ "           AND atc.t_ObjectId   = " + objectId
              +"\n"+ "           AND atc.t_value IN (" + listCategory + ")"
              +"\n"+ "           AND atc.t_isInstalledOverPeriod = 1)";
        else
            filter = "1 = 1";
        end;
        return filter;
    end;

    /**
     *  Установлена категория на субъекта экономики.
     *  @param     accountAlias  наименование поля "код клиента"
     *  @param     category      категория объекта
     *  @param     groupID       группа категорий объекта
     */
    macro hasAssignedPartyCategory(clientCodeAlias : String, listCategory : String, groupID : Integer) : String
        return hasAssignedCategory(RCB_OBJTYPE_PARTY,
                                   clientCodeAlias,
                                   groupID,
                                   listCategory);
    end;

    macro fillTempTableDeposit()
        var strQuery;
        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");

        okatoTuneTable.setInstructionFilter(RCB_OKVED_DATE);

        strQuery = "WITH depData AS (                                                                                            "
          + "\n" + "      SELECT " + BODeposits + "                                      t_backoffice,                           "
          + "\n" + "             t_branchOkatoCode                                       t_okatoCode,                            "
          + "\n" + "             CASE WHEN t_clientKind = 'П'"
          + "\n" + "                  THEN '1.7'                                                                                 "
          + "\n" + "                  ELSE '1.8'"
          + "\n" + "             END                                                     t_row,                                  "
          + "\n" + "             t_column,                                                                                       "
          + "\n" + "             t_number,                                                                                       "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                           "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSum(t_roubleSum, t_currencyId," + NATCUR +", t_recalculateRateDate,0) "
          + "\n" + "             END                                                     t_roubleSum,                            "
          + "\n" + "             t_currencySum,                                                                                  "
          + "\n" + "             t_contractorId,                                                                                 "
          + "\n" + "             t_clientCode,                                                                                   "
          + "\n" + "             t_shortName,                                                                                    "
          + "\n" + "             t_recalculateRateDate,                                                                          "
          + "\n" + "             t_clientKind,                                                                                   "
          + "\n" + "             t_currencyId,                                                                                   "
          + "\n" + "             t_account                                                                                       "
          + "\n" + "        FROM (SELECT CASE                                                                                                                  "
          + "\n" + "                         WHEN lc.t_okatoTsOpenDep = CHR(1)"
          + "\n" + "                         THEN NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')"
          + "\n" + "                         ELSE lc.t_okatoTsOpenDep"
          + "\n" + "                     END                                                                                             t_branchOkatoCode,    "
          + "\n" + "                     CASE WHEN la.t_fiId = " + NATCUR
          + "\n" + "                          THEN 4                                                                                                           "
          + "\n" + "                          ELSE 5                                                                                                           "
          + "\n" + "                     END                                                                                             t_column,             "
          + "\n" + "                     lc.t_number                                                                                     t_number,             "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,          "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,        "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,       "
          + "\n" + "                     (select c.t_code                                                                                                      "
          + "\n" + "                        from drepPartyCodes_vw c                                                                                           "
          + "\n" + "                       where lc.t_contragentId = c.t_partyId and c.t_codeKind = 1)                                   t_clientCode,         "
          + "\n" + "                     (select c.t_shortName                                                                                                 "
          + "\n" + "                        from drepParty_vw c                                                                                                "
          + "\n" + "                       where lc.t_contragentId = c.t_id)                                                             t_shortName,          "
          + "\n" + "                     CASE WHEN ( lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                 "
          + "\n" + "                          THEN lc.t_closeDate                                                                                              "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                   "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,"
          + "\n" + "                     (SELECT                                                                                                               "
          + "\n" + "                           CASE WHEN  party.t_isPhisical = 0 THEN 'Ю'                                                                      "
          + "\n" + "                                WHEN  party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                          "
          + "\n" + "                                ELSE CHR(1)                                                                                                "
          + "\n" + "                            END                                                                                                            "
          + "\n" + "                        FROM drepParty_vw party                                                                                            "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,         "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId,         "
          + "\n" + "                     la.t_account                                                                                    t_account             "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                      "
          + "\n" + "               WHERE lc.t_type = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type = 'Д'                                                                                                       "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                               "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened = 1                                                                                                     "
          + "\n" + "                 AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction), "la.t_account")
          + "\n" + "                 AND NOT EXISTS (SELECT 1                                                                                                  "
          + "\n" + "                                   FROM repLnsUserField_vw lu                                                                              "
          + "\n" + "                                  WHERE lu.t_objectNumber = lc.t_id                                                                        "
          + "\n" + "                                    AND lu.t_value = 'X'                                                                                   "
          + "\n" + "                                    AND lu.t_name = 'Субординированный депозит' ))"
          + "\n" + "       WHERE t_roubleSum != 0)                                                                                                             "
          //выборка по строке 1
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       '1', depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, '1', depData.t_column, depData.t_number,             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          //выборка по строке 1.7
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE depData.t_clientKind = 'П'                                                                     "
          + "\n" + "   AND NOT " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND depData.t_clientKind = 'П'"
          + "\n" + "   AND NOT " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          //выборка по строке 1.8
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE depData.t_clientKind = 'Ю'"
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.8")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND depData.t_clientKind = 'Ю'"
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.8")), "t_account");

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;

    initTDepositProcessor_Okved();
end;

class (TDepositProcessor_Okved_XXXX4) TDepositProcessor_Okved_4637(instruction)
    macro fillTempTableDeposit()
        var strQuery;
        var okatoTuneTable = RcbArTuneTable_4637();

        strQuery = "WITH depData AS (                                                                                                                             "
          + "\n" + "      SELECT " + BODeposits + "                                                                                 t_backoffice,                 "
          + "\n" + "             t_branchOkatoCode                                                                                  t_okatoCode,                  "
          + "\n" + "             CASE WHEN t_clientKind = 'П'                                                                                                     "
          + "\n" + "                  THEN '1.7'                                                                                                                  "
          + "\n" + "                  ELSE '1.8'                                                                                                                  "
          + "\n" + "             END                                                                                                t_row,                        "
          + "\n" + "             t_column,                                                                                                                        "
          + "\n" + "             t_number,                                                                                                                        "
          + "\n" + "             CASE WHEN t_currencyId = " + NATCUR
          + "\n" + "                  THEN t_roubleSum                                                                                                            "
          + "\n" + "                  ELSE rsb_fiinstr.ConvSumType(t_roubleSum, t_currencyId, " + NATCUR + ", 7, t_recalculateRateDate)                           "
          + "\n" + "             END                                                                                                t_roubleSum,                  "
          + "\n" + "             t_currencySum,                                                                                                                   "
          + "\n" + "             t_contractorId,                                                                                                                  "
          + "\n" + "             t_clientCode,                                                                                                                    "
          + "\n" + "             t_shortName,                                                                                                                     "
          + "\n" + "             t_recalculateRateDate,                                                                                                           "
          + "\n" + "             t_clientKind,                                                                                                                    "
          + "\n" + "             t_currencyId,                                                                                                                    "
          + "\n" + "             t_account                                                                                                                        "
          + "\n" + "        FROM (SELECT CASE                                                                                                                     "
          + "\n" + "                         WHEN lc.t_okatoTsOpenDep = CHR(1)                                                                                    "
          + "\n" + "                         THEN NVL((SELECT t_okatocode FROM drepdepcode_tmp WHERE t_departmentcode = lc.t_branchId), '99999')                  "
          + "\n" + "                         ELSE lc.t_okatoTsOpenDep                                                                                             "
          + "\n" + "                     END                                                                                             t_branchOkatoCode,       "
          + "\n" + "                     CASE (SELECT fi.t_isoNumber FROM dRepFinInstrument_vw fi WHERE fi.t_id = la.t_fiId)"
          + "\n" + "                         WHEN '643'                                                                                                           "
          + "\n" + "                             THEN 5                                                                                                           "
          + "\n" + "                         WHEN '840'                                                                                                           "
          + "\n" + "                             THEN 6                                                                                                           "
          + "\n" + "                         WHEN '978'                                                                                                           "
          + "\n" + "                             THEN 7                                                                                                           "
          + "\n" + "                         WHEN '156'                                                                                                           "
          + "\n" + "                             THEN 8                                                                                                           "
          + "\n" + "                         ELSE 4                                                                                                               "
          + "\n" + "                     END                                                                                             t_column,                "
          + "\n" + "                     lc.t_number                                                                                     t_number,                "
          + "\n" + "                     la.t_outRest                                                                                    t_roubleSum,             "
          + "\n" + "                     la.t_outRest                                                                                    t_currencySum,           "
          + "\n" + "                     lc.t_contragentId                                                                               t_contractorId,          "
          + "\n" + "                     (SELECT c.t_code                                                                                                         "
          + "\n" + "                        FROM drepPartyCodes_vw c                                                                                              "
          + "\n" + "                       WHERE lc.t_contragentId = c.t_partyId                                                                                  "
          + "\n" + "                         AND c.t_codeKind      = " + PTCK_CONTR + ")                                                 t_clientCode,            "
          + "\n" + "                     (SELECT c.t_shortName                                                                                                    "
          + "\n" + "                        FROM drepParty_vw c                                                                                                   "
          + "\n" + "                       WHERE lc.t_contragentId = c.t_id)                                                             t_shortName,             "
          + "\n" + "                     CASE WHEN (    lc.t_CloseDate < TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')"
          + "\n" + "                                AND lc.t_closeDate != TO_DATE('01-01-0001', 'DD-MM-YYYY'))                                                    "
          + "\n" + "                          THEN lc.t_closeDate                                                                                                 "
          + "\n" + "                          ELSE TO_DATE(UTL_RAW.CAST_TO_VARCHAR2(RSVOXPRM.GetPrmVal('EndDate')), 'DD MM YYYY HH24:MI:SS')                      "
          + "\n" + "                     END                                                                                             t_recalculateRateDate,   "
          + "\n" + "                     (SELECT                                                                                                                  "
          + "\n" + "                           CASE WHEN party.t_isPhisical = 0                             THEN 'Ю'                                              "
          + "\n" + "                                WHEN party.t_isPhisical = 1 AND  party.t_isEmployer = 1 THEN 'П'                                              "
          + "\n" + "                                ELSE CHR(1)                                                                                                   "
          + "\n" + "                            END                                                                                                               "
          + "\n" + "                        FROM drepParty_vw party                                                                                               "
          + "\n" + "                       WHERE lc.t_contragentId = party.t_id)                                                         t_clientKind,            "
          + "\n" + "                     la.t_fiId                                                                                       t_currencyId,            "
          + "\n" + "                     la.t_account                                                                                    t_account                "
          + "\n" + "                FROM replnscontract_vw lc INNER JOIN replnsaccount_vw la ON la.t_contractId = lc.t_id                                         "
          + "\n" + "               WHERE lc.t_type         = " + LO_DEPOSIT
          + "\n" + "                 AND la.t_type         = 'Д'                                                                                                  "
          + "\n" + "                 AND la.t_isTechnical != 'X'                                                                                                  "
          + "\n" + "                 AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
          + "\n" + "                 AND lc.t_isopened     = 1                                                                                                    "
          + "\n" + "                 AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction), "la.t_account")
          + "\n" + "                 AND NVL(lc.t_subordinatedDeposit, 0) = 0 )                                                                                   "
          + "\n" + "       WHERE t_roubleSum != 0)                                                                                                                "
          //выборка по строке 1
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       '1', depData.t_column, depData.t_number,                                                       "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, '1', depData.t_column, depData.t_number,             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          //выборка по строке 1.7
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE depData.t_clientKind = 'П'                                                                     "
          + "\n" + "   AND NOT " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND depData.t_clientKind = 'П'"
          + "\n" + "   AND NOT " + hasAssignedPartyCategory("t_contractorId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.7")), "t_account")
          //выборка по строке 1.8
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, "
          + "\n" + "       CASE WHEN depData.t_okatoCode <> '99999'                                                       "
          + "\n" + "            THEN RPAD(substr(depData.t_okatoCode, 1, 2), 5, '0')                                      "
          + "\n" + "            ELSE depData.t_okatoCode                                                                  "
          + "\n" + "       END                                                     t_okatoCode,                           "
          + "\n" + "       depData.t_row, depData.t_column, depData.t_number,                                             "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData                                                                                        "
          + "\n" + " WHERE depData.t_clientKind = 'Ю'"
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.8")), "t_account")
          + "\n" + " UNION ALL                                                                                            "
          + "\n" + "SELECT depData.t_backOffice, okatoTable.t_okato, depData.t_row, depData.t_column, depData.t_number,   "
          + "\n" + "       depData.t_roubleSum, depData.t_currencySum, depData.t_contractorId, depData.t_clientCode,      "
          + "\n" + "       depData.t_shortName, depData.t_recalculateRateDate, depData.t_clientKind, depData.t_currencyId "
          + "\n" + "  FROM depData, (" + okatoTuneTable.getQuery() + ") okatoTable                                        "
          + "\n" + " WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, depData.t_okatoCode) = 1               "
          + "\n" + "   AND depData.t_clientKind = 'Ю'"
          + "\n" + "   AND " + convertMaskToSqlFormat(getBalanceMasks(m_instruction, getSqlString("1.8")), "t_account");

        sql_execute(" INSERT INTO df302p2_tmp(t_backOffice,         "
           + "\n" + "                         t_okatoCode,          "
           + "\n" + "                         t_row,                "
           + "\n" + "                         t_column,             "
           + "\n" + "                         t_accountNumber,      "
           + "\n" + "                         t_roubleSum,          "
           + "\n" + "                         t_currencySum,        "
           + "\n" + "                         t_contractorId,       "
           + "\n" + "                         t_clientCode,         "
           + "\n" + "                         t_shortName,          "
           + "\n" + "                         t_recalculateRateDate,"
           + "\n" + "                         t_clientKind,         "
           + "\n" + "                         t_currencyId)         "
           + "\n" + strQuery);
    end;

    private macro constructor(instruction)
        initTDepositProcessor_Okved_XXXX4(instruction);
    end;

    constructor(instruction);
end;

macro cashContractsAndTranches()
    sql_truncate("df302Tranches_tmp");

    sql_execute("INSERT INTO df302Tranches_tmp(t_contractId, t_creditNumberForReport, t_contractType, t_trancheKind, t_trancheNumber, t_openDate, t_closeDate, t_fiId, t_cbAccount, "
            + "\n" + "                         t_clientType, t_contragentId, t_isMsp, t_isPhisical, t_isEmployer, t_aim, t_lastIssueDate, t_term, t_initialInterestRate, t_branchId)"
            + "\n" + "SELECT contract.t_id,"
            + "\n" + "       contract.t_number,"
            + "\n" + "       contract.t_type,"
            + "\n" + "       tranche.t_kind,"
            + "\n" + "       tranche.t_number,"
            + "\n" + "       contract.t_openDate,"
            + "\n" + "       contract.t_closeDate,"
            + "\n" + "       contract.t_fiId,"
            + "\n" + "       tranche.t_cbAccount,"
            + "\n" + "       contract.t_clientType,"
            + "\n" + "       contract.t_contragentId,"
            + "\n" + "       CASE                     "
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', party.t_objectId," + getSqlDate(RcbApplication().currentReport.context.period.endDate()) + ") > 0"
            + "\n" + "               THEN 1  "
            + "\n" + "           ELSE 0      "
            + "\n" + "       END t_isMsp,     "
            + "\n" + "       party.t_isPhisical,"
            + "\n" + "       party.t_isEmployer,"
            + "\n" + "       contract.t_aim,"
            + "\n" + "       tranche.t_lastIssueDate,"
            + "\n" + "       0,"
            + "\n" + "       0,"
            + "\n" + "       contract.t_branchId"
            + "\n" + "  FROM repLnsContract_vw contract,"
            + "\n" + "       repLnsTranches_vw tranche,"
            + "\n" + "       drepParty_vw party"
            + "\n" + " WHERE contract.t_id = tranche.t_contractId"
            + "\n" + "   AND tranche.t_isFictive = 0"
            + "\n" + "   AND party.t_id = contract.t_contragentId"
            + "\n" + "   AND contract.t_isOpened = 1"
            + "\n" + "   AND contract.t_type IN (" + LO_CREDIT + "," + LO_KARTA + ", " + LO_OVERDRAFT +")"
            + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
            );
end;

macro cacheOperationTable()
    sql_truncate("F302operation_tmp");

    sql_execute("DECLARE "
       + "\n" + "  TYPE curtype IS REF CURSOR;                                                      "
       + "\n" + "  curvar          curtype;                                                         "
       + "\n" + "  TYPE F302operation IS TABLE OF F302operation_tmp%ROWTYPE;                        "
       + "\n" + "  operationsArray F302operation;                                                   "
       + "\n" + "  v_queryText VARCHAR2(32000);                                                     "
       + "\n" + "  saverThreshold CONSTANT PLS_INTEGER := 10000;                                    "
       + "\n" + "BEGIN                                                                              "
       + "\n" + "  v_queryText := 'SELECT t_sum,                                                    "
       + "\n" + "                         t_roubleSum,                                              "
       + "\n" + "                         t_ID,                                                     "
       + "\n" + "                         t_contractId,                                             "
       + "\n" + "                         t_trancheNumber,                                          "
       + "\n" + "                         t_trancheKind,                                            "
       + "\n" + "                         t_type,                                                   "
       + "\n" + "                         CASE                                                      "
       + "\n" + "                             WHEN operation.t_history = ''К''                      "
       + "\n" + "                             THEN operation.t_correctionDate                       "
       + "\n" + "                             ELSE operation.t_date                                 "
       + "\n" + "                         END AS t_date                                             "
       + "\n" + "                    FROM repLnsOperation_vw operation                              "
       + "\n" + "                   WHERE CASE                                                      "
       + "\n" + "                             WHEN operation.t_history = ''К''                      "
       + "\n" + "                             THEN operation.t_correctionDate                       "
       + "\n" + "                             ELSE operation.t_date                                 "
       + "\n" + "                         END BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
       + "\n" + "                     AND operation.t_type IN (" + PAYMENT + "," + REPAYMENT + ")   "
       + "\n" + "                     AND EXISTS(SELECT 1                                           "
       + "\n" + "                                  FROM df302Tranches_tmp crd                       "
       + "\n" + "                                 WHERE crd.t_contractId = operation.t_contractId)';"
       + "\n" + "                                                                                   "
       + "\n" + "  OPEN curvar FOR v_queryText;                                                     "
       + "\n" + "  LOOP                                                                             "
       + "\n" + "      FETCH curvar BULK COLLECT INTO operationsArray LIMIT saverThreshold;         "
       + "\n" + "      EXIT WHEN operationsArray.COUNT = 0;                                         "
       + "\n" + "                                                                                   "
       + "\n" + "      FORALL counter IN operationsArray.FIRST..operationsArray.LAST                "
       + "\n" + "          INSERT INTO F302operation_tmp VALUES operationsArray(counter);           "
       + "\n" + "                                                                                   "
       + "\n" + "      operationsArray.DELETE();                                                    "
       + "\n" + "  END LOOP;                                                                        "
       + "\n" + "  CLOSE curvar;                                                                    "
       + "\n" + "                                                                                   "
       + "\n" + "  COMMIT;                                                                          "
       + "\n" + "                                                                                   "
       + "\n" + "END;    "
            );
end;

macro cashAccountsTable()
    sql_truncate("df302Accounts_tmp");

    sql_execute("INSERT INTO df302Accounts_tmp(t_creditId, t_type, t_account, t_balance, t_trancheKind, t_trancheNumber, t_fiId, t_chapter, t_outRest)"
            + "\n" + "SELECT t_contractId,"
            + "\n" + "       t_type,"
            + "\n" + "       t_cbAccount,"
            + "\n" + "       t_balance,"
            + "\n" + "       t_objectId,"
            + "\n" + "       t_objectNumber,"
            + "\n" + "       t_fiId,"
            + "\n" + "       t_chapter,"
            + "\n" + "       t_outRest"
            + "\n" + "  FROM repLnsAccount_vw acc"
            + "\n" + " WHERE (   t_type IN ('З', 'С')"
            + "\n" + "        OR " + getOverdueDebtMasks("t_balance", BOLoans) + ")"
            + "\n" + "   AND acc.t_cbAccount <> CHR(1)                                                                                                                    "
            + "\n" + "   AND acc.t_isValidAccount = 1"
            + "\n" + "   AND EXISTS(SELECT 1 "
            + "\n" + "                FROM df302Tranches_tmp crd"
            + "\n" + "               WHERE crd.t_contractId = acc.t_contractId)"
            );
end;

/***************************************************************************************************
*  Основная функция
**************************************************************************************************/
macro main()
    var tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");

    if   (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
        if (TTuneTable("dt302_dbt", "t_backOffice").hasDataFor(TBackOffice(BOLOANS)))
            fillTempTable();
        end;

    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
        tuneTable.setInstructionFilter(RCB_I2183_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable(RCB_I2183_DATE);
        end;

    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
        tuneTable.setInstructionFilter(RCB_I2332_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable(RCB_I2332_DATE);
        end;

    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2627_DATE)
        tuneTable.setInstructionFilter(RCB_I2470_DATE2);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable(RCB_I2470_DATE2);
        end;

    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2742_DATE)
        tuneTable.setInstructionFilter(RCB_I2627_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable2627();
        end;

        TDepositsF302().fillTempTableDeposit();

    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2835_DATE)
        tuneTable.setInstructionFilter(RCB_I2742_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable2627();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor2742().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2926_DATE)
        tuneTable.setInstructionFilter(RCB_I2742_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable2835();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor2742().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3129_DATE)
        tuneTable.setInstructionFilter(RCB_I2926_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            fillTempTable2835().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor2926().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3269_DATE)
        tuneTable.setInstructionFilter(RCB_I3129_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable3129().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor2926().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3468_DATE)
        tuneTable.setInstructionFilter(RCB_I3269_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable3129().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor3269().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_OKVED_DATE)
        tuneTable.setInstructionFilter(RCB_I3468_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable3129().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor3468().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3875_DATE2)
        tuneTable.setInstructionFilter(RCB_OKVED_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable_Okved().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor_Okved().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_IXXXX_DATE4)
        tuneTable.setInstructionFilter(RCB_I3875_DATE2);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable_Okved().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor_Okved().fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_Т1_56_15_38_43598_DATE)
        tuneTable.setInstructionFilter(RCB_I3875_DATE2);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cashContractsAndTranches();
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable_Okved().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor_Okved_XXXX4(RCB_I3875_DATE2).fillTempTableDeposit();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
        tuneTable.setInstructionFilter(RCB_Т1_56_15_38_43598_DATE);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cashContractsAndTranches();
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable_Okved_Т1_56_15_38_43598().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor_Okved_XXXX4(RCB_Т1_56_15_38_43598_DATE).fillTempTableDeposit();
        end;
    else
        tuneTable.setInstructionFilter(RCB_I4637_DATE_F302);

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BOLOANS).getId());
        if (tuneTable.hasDataFor(TBackOffice(BOLOANS), "t_backOffice"))
            cashContractsAndTranches();
            cacheOperationTable();
            cashAccountsTable();
            fillTempTable_Okved_Т1_56_15_38_43598().execute();
        end;

        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + TBackOffice(BODeposits).getId());
        if (tuneTable.hasDataFor(TBackOffice(BODeposits), "t_backOffice"))
            TDepositProcessor_Okved_4637(RCB_I4637_DATE_F302).fillTempTableDeposit();
        end;
    end;
end;

/***************************************************************************************************
*  Точка входа
**************************************************************************************************/
main();

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
