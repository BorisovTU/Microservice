/*
$Name:          f115CalculationPart4Controller.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 115. Контроллер расчета. Раздел 4.
*/

/**
 * Форма 115. Контроллер расчета.
 * 
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import f115CalculationPartController;

/**
 *  Расчет переменных по 2061-У.
 *
 */
class (TCalculationPartController) TCalculationPart4Controller2061(dataSource, tuneTable, protocol, report)

    /**
     * Источник данных по счетам в ГК.
     */
    private var m_cbAccountsDataSource;

    /**
     * Источник данных по договорам в Loans-е.
     */
    private var m_loansCreditDataSource;

    /**
     * Источник данных по траншам в Loans-е.
     */
    private var m_loansTrancheDataSource;

    /**
     * Конструктор.
     */
    private macro constructor(dataSource, tuneTable, protocol, report)
        initTCalculationPartController(dataSource, tuneTable, protocol, report);

        m_loansTrancheDataSource = m_dataSource.getLoansTrancheDataSource();
        m_loansCreditDataSource  = m_dataSource.getLoansCreditDataSource();
        m_cbAccountsDataSource   = m_dataSource.getCbAccountsDataSource();
    end;


    private macro setLineValue(attribute : TAttribute, dataSet, backOffice)
            attribute.setValue(dataSet, null, backOffice);
    end;

    private macro setSubPart4LineValue(attribute : TAttribute, dataSet, backOffice)
        attribute.setValue(dataSet.rest, "3", backOffice);
        attribute.setValue(dataSet.reserveAmount, "4", backOffice);
    end;

    private macro setLineUserValue(attribute : TAttribute)
        attribute.setValue(m_report.getUserAttributeValue(attribute.getName(), null), null, BOUser);
    end;


    private macro addLineValue(attribute : TAttribute, dataSet, backOffice)
        attribute.plus(dataSet,   backOffice);
    end;

    var accountFilter;
    var overdueAccountFilter;

    private macro setAccountMasks()
        accountFilter =
                m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                m_tuneTable.getAccountMasks("1", "1.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.5", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.6", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.1", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.5", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.1", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.4", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.5", BOCB));
    end;

    /*1*/
    private macro calculateAttribute1(attribute)
		addAttribute(attribute, m_report.getPart("4").getAttribute("1.1"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("1.2"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("1.3"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("1.4"));
    end;   

    /*1.1*/
    private macro calculateAttribute1_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Ж")
                                                               ),
                    BOLoans);

        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   

    /*1.2*/
    private macro calculateAttribute1_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   

    /*1.3*/
    private macro calculateAttribute1_3(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("А")
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   

    /*1.4*/
    private macro calculateAttribute1_4(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Н"),
                                                     m_loansTrancheDataSource.getFilter().hasCreditType(LO_KARTA)
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;

    /*2*/
    private macro calculateAttribute2(attribute)
		addAttribute(attribute, m_report.getPart("4").getAttribute("2.1"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("2.2"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("2.3"));
		addAttribute(attribute, m_report.getPart("4").getAttribute("2.4"));
    end;   

    /*2.1*/
    private macro calculateAttribute2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Ж")
                                                               ),
                    BOLoans);

    end;   

    /*2.2*/
    private macro calculateAttribute2_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                               ),
                    BOLoans);

    end;   

    /*2.3*/
    private macro calculateAttribute2_3(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("А")
                                                               ),
                    BOLoans);

    end;   

    /*2.4*/
    private macro calculateAttribute2_4(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Н"),
                                                     m_loansTrancheDataSource.getFilter().hasCreditType(LO_KARTA)
                                                               ),
                    BOLoans);

    end;

    /*3.1*/
    private macro calculateAttribute3_1(attribute)
        setAccountMasks();
        setLineValue(attribute, 
                     m_loansCreditDataSource.getCalcReserveData(
                                                      m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA)
                                                      + m_loansCreditDataSource.getFilter().hasRiskGroup(3, 4, 5),
                                                      m_loansCreditDataSource.getFilter().hasKindRegister(
                                                                                                tdr_mainrest, /*основной долг*/
                                                                                                tdr_exprest,  /*просроченная задолженность*/
                                                                                                tdr_lim)      /*история неразрешенного ОД*/
                                                               ),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getCalcReserveData(
                                                     accountFilter
                                                   + m_cbAccountsDataSource.getFilter().hasRiskGroup(3, 4, 5)
                                                   + m_cbAccountsDataSource.getFilter().isAccountNotInСase()
                                                               ),
                    BOCb);

        attribute.setValue(m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;

    /*3.2*/
    private macro calculateAttribute3_2(attribute)
        setAccountMasks();
        setLineValue(attribute, 
                     m_loansCreditDataSource.getCalcReserveSecData(
                                                     m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA)
                                                    +m_loansCreditDataSource.getFilter().hasRiskGroup(3, 4, 5),
                                                    m_loansCreditDataSource.getFilter().hasKindRegister(/*данная проверка добавлена исключительно для корректного вида протокола, те же регистры что и для 3.1*/
                                                                                                tdr_mainrest, /*основной долг*/
                                                                                                tdr_exprest,  /*просроченная задолженность*/
                                                                                                tdr_lim)      /*история неразрешенного ОД*/
                                                               ),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getCalcReserveSecData(
                                                     accountFilter
                                                   + m_cbAccountsDataSource.getFilter().hasRiskGroup(3, 4, 5)
                                                   + m_cbAccountsDataSource.getFilter().isAccountNotInСase()
                                                               ),
                    BOCb);
        attribute.setValue(m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end; 

    /*3.3*/
    private macro calculateAttribute3_3(attribute)
	    m_protocol.printUserDataCopyMessage();
        attribute.setValue(m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end; 

    /*3.4*/
    private macro calculateAttribute3_4(attribute)
	    m_protocol.printUserDataCopyMessage();
        attribute.setValue(m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end; 



    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 
            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 
            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT);

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 
        end;
    end;

    constructor(dataSource, tuneTable, protocol, report);
end;

   
/**
 *  Расчет переменных по 2539-У.
 *
 */
class (TCalculationPart4Controller2061) TCalculationPart4Controller2539(dataSource, tuneTable, protocol, report)
    initTCalculationPart4Controller2061(dataSource, tuneTable, protocol, report);

    /*1.1*/
    private macro calculateAttribute1_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("Ж,И,З")
                                                     + m_loansTrancheDataSource.getFilter().isNotRegisteredHypothec()
                                                               ),                             
                    BOLoans);

        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   

    /*1.2*/
    private macro calculateAttribute1_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И,З")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   

    /*1.2.1*/
    private macro calculateAttribute1_2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttributeValue(attribute.getName(), ""), null, BOUser);
    end;   


    /*2.1*/
    private macro calculateAttribute2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("Ж,И,З")
                                                     + m_loansTrancheDataSource.getFilter().isNotRegisteredHypothec()
                                                               ),
                    BOLoans);

    end;   

    /*2.2*/
    private macro calculateAttribute2_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И,З")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);

    end;   

    /*2.2.1*/
    private macro calculateAttribute2_2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);

    end;   

    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 
            m_protocol.printReportLineNumber("1.2.1");
            calculateAttribute1_2_1(part.getAttribute("1.2.1")); 
            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 
            m_protocol.printReportLineNumber("2.2.1");
            calculateAttribute2_2_1(part.getAttribute("2.2.1")); 
            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT);

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 
        end;
    end;
end;


/**
 *  Расчет переменных по 2742-У.
 */
class (TCalculationPart4Controller2539) TCalculationPart4Controller2742(dataSource, tuneTable, protocol, report)
    initTCalculationPart4Controller2539(dataSource, tuneTable, protocol, report);

    /*4.1*/
    private macro calculateAttribute4_1(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4", "4", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(10,20),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.2*/
    private macro calculateAttribute4_2(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4", "4", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(20,35),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.3*/
    private macro calculateAttribute4_3(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4", "4", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(35,50),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.4*/
    private macro calculateAttribute4_4(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4", "4", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(50,75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.5*/
    private macro calculateAttribute4_5(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4", "4", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    macro calculateAttribute5(attribute)
        setLineValue(attribute, 
                     m_loansCreditDataSource.getPart4SubPart5Data(            m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA, LO_GUARANTEE) 
                                                                  + " AND " + m_loansCreditDataSource.getFilter().hasAccount("60315*", true)
                                                                  /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/,
                                                                  masksMerger(m_tuneTable.getRegisterNumber(     "1", "2.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.6.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.6.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.7", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.7", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.8", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.8", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.2", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.2", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.3", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.3", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.4", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.4", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.5.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.5.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.6", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.6", BOLoans))),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getPart4SubPart5Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1", "1.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.7", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.4", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.5", BOCB))
                                                                 /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/),
                     BOCb);
    
    end;


    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 
            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 
            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            m_protocol.printReportLineNumber("4.1");                   
            calculateAttribute4_1(part.getAttribute("4.1"));                   
            m_protocol.printReportLineNumber("4.2");
            calculateAttribute4_2(part.getAttribute("4.2"));
            m_protocol.printReportLineNumber("4.3");
            calculateAttribute4_3(part.getAttribute("4.3"));
            m_protocol.printReportLineNumber("4.4");
            calculateAttribute4_4(part.getAttribute("4.4"));
            m_protocol.printReportLineNumber("4.5");
            calculateAttribute4_5(part.getAttribute("4.5"));

            m_protocol.printReportLineNumber("5");
            calculateAttribute5(part.getAttribute("5"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();
            part.getAttribute("4").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT);

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 
        end;
    end;
end;

/**
 *  Расчет переменных по 2835-У.
 */

class (TCalculationPart4Controller2742) TCalculationPart4Controller2835(dataSource, tuneTable, protocol, report)
    initTCalculationPart4Controller2742(dataSource, tuneTable, protocol, report);

    /*4.1*/
    private macro calculateAttribute1(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(10,20),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.2*/
    private macro calculateAttribute2(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(20,35),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.3*/
    private macro calculateAttribute3(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(35,50),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.4*/
    private macro calculateAttribute4(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(50,75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.5*/
    private macro calculateAttribute5(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1");                   
            calculateAttribute1(part.getAttribute("1"));                   
            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2"));
            m_protocol.printReportLineNumber("3");
            calculateAttribute3(part.getAttribute("3"));
            m_protocol.printReportLineNumber("4");
            calculateAttribute4(part.getAttribute("4"));
            m_protocol.printReportLineNumber("5");
            calculateAttribute5(part.getAttribute("5"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT);
        end;
    end;
end;

/**
 *  Расчет переменных по 2926-У.
 */
class (TCalculationPart4Controller2835) TCalculationPart4Controller2926(dataSource, tuneTable, protocol, report)
    initTCalculationPart4Controller2835(dataSource, tuneTable, protocol, report);

    /*4.1*/
    private macro calculateAttribute1(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(0,10),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.2*/
    private macro calculateAttribute2(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(10,20),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.3*/
    private macro calculateAttribute3(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(20,35),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.4*/
    private macro calculateAttribute4(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(35,50),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.5*/
    private macro calculateAttribute5(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(50,75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.6*/
    private macro calculateAttribute6(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(75),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    /*4.7*/
    private macro calculateAttribute7(attribute)
        setSubPart4LineValue(attribute, 
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                                                                            m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                                                                            m_tuneTable.getAccountMasks("4", "6", BOCB))
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercentGreater(20),
                                                                         attribute.getName()),
                             BOCb);
    end; 

    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1");                   
            calculateAttribute1(part.getAttribute("1")); 
                  
            m_protocol.printReportLineNumber("2");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2012))
                calculateAttribute2(part.getAttribute("2"));
            else
                part.getAttribute("2").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("3");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2013))
                calculateAttribute3(part.getAttribute("3"));
            else
                part.getAttribute("3").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("4");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2014))
                calculateAttribute4(part.getAttribute("4"));
            else
                part.getAttribute("4").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("5");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2015))
                calculateAttribute5(part.getAttribute("5"));
            else
                part.getAttribute("5").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("6");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2016))
                calculateAttribute6(part.getAttribute("6"));
            else
                part.getAttribute("6").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("7");
            calculateAttribute7(part.getAttribute("7"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT);
        end;
    end;
end;

/**
 *  Расчет переменных по 4099-У.
 */
class (TCalculationPart4Controller2926) TCalculationPart4Controller4099(dataSource, tuneTable, protocol, report)
    initTCalculationPart4Controller2926(dataSource, tuneTable, protocol, report);

    private var m_accoutnsMask;
    private var m_creditMaskFor_47901;
    private var m_commonFilter;

    /*4.1*/
    private macro calculateAttribute1(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(0, 10)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.2*/
    private macro calculateAttribute2(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(10, 20)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.3*/
    private macro calculateAttribute3(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(20, 35)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.4*/
    private macro calculateAttribute4(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(35, 50)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.5*/
    private macro calculateAttribute5(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(50, 75)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.6*/
    private macro calculateAttribute6(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercent(75)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    /*4.7*/
    private macro calculateAttribute7(attribute)
        setSubPart4LineValue(attribute,
                             m_cbAccountsDataSource.getPart4SubPart4Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_accoutnsMask)
                                                                         + "AND " + m_cbAccountsDataSource.getFilter().hasReservePercentGreater(20)
                                                                         + m_commonFilter,
                                                                         attribute.getName()),
                             BOCb);
    end;

    macro calculate(part : TPart)
        if (part.getNumber() == 4)
            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1"));

            m_protocol.printReportLineNumber("2");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2012))
                calculateAttribute2(part.getAttribute("2"));
            else
                part.getAttribute("2").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("3");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2013))
                calculateAttribute3(part.getAttribute("3"));
            else
                part.getAttribute("3").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("4");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2014))
                calculateAttribute4(part.getAttribute("4"));
            else
                part.getAttribute("4").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("5");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2015))
                calculateAttribute5(part.getAttribute("5"));
            else
                part.getAttribute("5").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("6");
            if (rcbApplication().currentReport.context.period.endDate >= Date(31, 01, 2016))
                calculateAttribute6(part.getAttribute("6"));
            else
                part.getAttribute("6").setUndefinedValue();
            end;

            m_protocol.printReportLineNumber("7");
            calculateAttribute7(part.getAttribute("7"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT);
        end;
    end;

    private macro constructor(dataSource, tuneTable, protocol, report)

        constructor(dataSource, tuneTable, protocol, report);

        m_accoutnsMask = m_tuneTable.getAccountMasks("4", "1", BOCB) + "," +
                         m_tuneTable.getAccountMasks("4", "2", BOCB) + "," +
                         m_tuneTable.getAccountMasks("4", "3", BOCB) + "," +
                         m_tuneTable.getAccountMasks("4", "4", BOCB) + "," +
                         m_tuneTable.getAccountMasks("4", "5", BOCB) + "," +
                         m_tuneTable.getAccountMasks("4", "6", BOCB);

        m_creditMaskFor_47901 = StrSubst (m_accoutnsMask,        "47901*,", "");
        m_creditMaskFor_47901 = StrSubst (m_creditMaskFor_47901, "47901*",  "");

        m_commonFilter = "AND NOT (  ( " + m_cbAccountsDataSource.getFilter().isSatisfiesToMasks("acc.t_account", "60401*")
                       + "         OR "  + m_cbAccountsDataSource.getFilter().isSatisfiesToMasks("acc.t_account", "60404*") + ") "
                                + m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'ОС в аренде'", RCB_OBJGROUP_ACTIVEKIND) + ")"
                       + "AND NOT (" + m_cbAccountsDataSource.getFilter().isSatisfiesToMasks("acc.t_account", "60415*")
                                + m_cbAccountsDataSource.getFilter().hasNotAssignedAccountCategory(RCB_OBJGROUP_ACTIVEKIND, "'Недвиж, не принятая в качестве ОС'") + ")"
                       + "AND NOT (" + m_cbAccountsDataSource.getFilter().isSatisfiesToMasks("acc.t_account", "60415*")
                                + m_cbAccountsDataSource.getFilter().hasNotAssignedAccountCategory(RCB_OBJGROUP_ACTIVEKIND, "'Материалы, не использ. в банк. деят'") + ")"
                       + "AND " + m_cbAccountsDataSource.getFilter().hasDocumentsForAccount("47901*", m_creditMaskFor_47901, RCB_ACSDCL_DEBET, "acc.t_account", "47901", "acc.t_balance");
    end;
end;
