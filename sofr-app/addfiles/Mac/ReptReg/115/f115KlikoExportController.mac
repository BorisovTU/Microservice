/*
$Name:          f115KlikoExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 115. Контроллер экспорта.
*/

/**
 * Форма 115. Контроллер экспорта.
 *
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import RcbProtocolView;
import f115Report;

/**
 * Операция печати.
 */
class TKlikoExportController2061()

    /**
     * Ссылка на отчет.
     */
    private var m_report  : TReport = null;

    /**
     * Ссылка на представление печатной формы kliko.
     */
    private var m_view : Object    = null;


    /**
     * Конструктор.
     */
    private macro constructor()
        m_view   = objectFactoryInstance.createKlikoView();
        m_report = objectFactoryInstance.createReport();

    end;

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer)

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        attributes = m_report.getPart(partNumber).getAttributes();
        i          = 0;
        j          = beginColumn;

        m_view.printHead(partDescription);

        while (i < attributes.size)

            valueArray = TArray();

            valueArray[0] = attributes[i].getName();

            if (beginColumn != null)
                j = beginColumn;
                while ( j <= endColumn )
                    valueArray[valueArray.size] = attributes[i].getStringValue(string(j));
                    j = j + 1;
                end;
            else
                valueArray[valueArray.size] = attributes[i].getStringValue();
            end;

            if (partNumber == 3)
                if ((attributes[i].getStringValue(string(3)) == stringUndefined)
                    and
                    (substr(valueArray[0], 1, 2) == "1.")
                   )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                    valueArray[valueArray.size-2] = "0";
                    valueArray[valueArray.size-1] = "0";
                    valueArray[valueArray.size] = "*";
                else
                    valueArray[valueArray.size] = "";
                end;
            end;

            j = 0;
            while (j < valueArray.size)
                if (valueArray[j] == stringUndefined)
                    valueArray[j] = "";
                end;
                j = j + 1;
            end;

            m_view.printRow(valueArray);

            i = i + 1;
        end;
    end;

    private macro printFile()
        m_view.setOutputFile();

        printPart(1, "F115A_1", 3, 19);
        printPart(2, "F115A_2", 3,  4);
        printPart(3, "F115A_3", 3,  4);
        printPart(4, "F115A_4");

        m_view.resetOutputFile();
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    /**
     * Выполнить печать.
     */
    macro execute()

        printFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String(m_view.getHeadsCount() + m_view.getRowsCount()) + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: " + m_view.getHeadsCount());
        protocolView.printLine("    количество содержательных строк:" + m_view.getRowsCount());

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;

    constructor();
end;

/**
 * Операция печати.
 */
class (TKlikoExportController2061) TKlikoExportController2332()
    initTKlikoExportController2061();

    private macro printFile()
        m_view.setOutputFile();

        if (rcbApplication.currentReport.context.period.kind == RCB_PK_MONTH)
            printPart(1, "F115A_1", 3, 19);
            printPart(2, "F115A_2", 3,  4);
            printPart(3, "F115A_3", 3,  4);
            printPart(4, "F115A_4");
        else
            printPart(1, "F115D_1", 3, 19);
            printPart(2, "F115D_2", 3,  4);
            printPart(3, "F115D_3", 3,  4);
            printPart(4, "F115D_4");
        end;

        m_view.resetOutputFile();
    end;

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer)

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        attributes = m_report.getPart(partNumber).getAttributes();
        i          = 0;
        j          = beginColumn;

        m_view.printHead(partDescription);

        while (i < attributes.size)

            valueArray = TArray();

            valueArray[0] = attributes[i].getName();

            if (beginColumn != null)
                j = beginColumn;
                while ( j <= endColumn )
                    valueArray[valueArray.size] = attributes[i].getStringValue(string(j));
                    j = j + 1;
                end;
            else
                valueArray[valueArray.size] = attributes[i].getStringValue();
            end;

            if (partNumber == 3)
                if ((attributes[i].getStringValue(string(3)) == stringUndefined)
                    and
                    (substr(valueArray[0], 1, 2) == "1.")
                   )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                    valueArray[valueArray.size-2] = "0";
                    valueArray[valueArray.size-1] = "0";
                end;
            end;


            j = 0;
            while (j < valueArray.size)
                if (valueArray[j] == stringUndefined)
                    valueArray[j] = "";
                end;
                j = j + 1;
            end;

            m_view.printRow(valueArray);

            i = i + 1;
        end;
    end;
end;


/**
 * Операция печати.
 */
class (TKlikoExportController2332) TKlikoExportController2742()
    initTKlikoExportController2332();

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer)

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        attributes = m_report.getPart(partNumber).getAttributes();
        i          = 0;
        j          = beginColumn;

        m_view.printHead(partDescription);

        while (i < attributes.size)

            valueArray = TArray();

            valueArray[valueArray.size] = attributes[i].getName();

            if (partNumber == 4)
                if (in(attributes[i].getName(), "4.1", "4.2", "4.3", "4.4", "4.5"))
                    valueArray[valueArray.size] = attributes[i].getStringValue("3");
                    valueArray[valueArray.size] = attributes[i].getStringValue("4");
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                    valueArray[valueArray.size] = "";
                end;
            elif (beginColumn != null)
                j = beginColumn;
                while ( j <= endColumn )
                    valueArray[valueArray.size] = attributes[i].getStringValue(string(j));
                    j = j + 1;
                end;
            else
                valueArray[valueArray.size] = attributes[i].getStringValue();
            end;

            if (partNumber == 3)
                if ((attributes[i].getStringValue(string(3)) == stringUndefined)
                    and
                    (substr(valueArray[0], 1, 2) == "1.")
                   )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                    valueArray[valueArray.size-2] = "0";
                    valueArray[valueArray.size-1] = "0";
                end;
            end;


            j = 0;
            while (j < valueArray.size)
                if (valueArray[j] == stringUndefined)
                    valueArray[j] = "";
                end;
                j = j + 1;
            end;

            m_view.printRow(valueArray);

            i = i + 1;
        end;
    end;
end;

/**
 * Операция печати.
 */
class (TKlikoExportController2742) TKlikoExportController2835()
    initTKlikoExportController2742();

    private macro printFile()
        m_view.setOutputFile();

        var stringBeginDate = String(rcbApplication.currentReport.context.period.beginDate);
        var stringEndDate   = String(rcbApplication.currentReport.context.period.EndDate);
            /* note: внутримесячная дата - год и месяц начала и окончания периода равны */
        var isIntraMonth = (substr(stringBeginDate, 4, 2) == substr(stringEndDate, 4, 2)) and
                           (substr(stringBeginDate, 7, 4) == substr(stringEndDate, 7, 4));

        if ((isIntraMonth) AND (rcbApplication.currentReport.context.period.kind != RCB_PK_MONTH))
            printPart(1, "F115D_1", 3, 19, true);
            printPart(2, "F115D_2", 3,  4, true);
            printPart(3, "F115D_3", 3,  4, true);
            printPart(5, "F115D_4", 0,  0, true);
            printPart(4, "",        3,  4);
            printPart(7, "");
        else
            printPart(1, "F115A_1",     3, 19, true);
            printPart(2, "F115A_2",     3,  4, true);
            printPart(3, "F115A_3",     3,  4, true);
            printPart(4, "F115A_4",     3,  4, true);
            printPart(5, "F115A_SP123", 0,  0, true);
            printPart(6, "F115A_SP4",   0,  0, true);
            printPart(7, "F115A_SP5",   0,  0, true);
            printPart(8, "F115A_PRP",   0,  0, true);
        end;

        m_view.resetOutputFile();
    end;

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     isPrintHead           признак печати служебной строки
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer, isPrintHead)

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/
        const ATTRIBUTEPART5ITEM5 = 17;

        if (isPrintHead)
            m_view.printHead(partDescription);
        end;

        if (partNumber == 8)
            valueArray = TArray();
            if (rcbApplication.currentReport.context.period.kind == RCB_PK_MONTH)
                m_view.printRow("1");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                m_view.printRow("2");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR)
                m_view.printRow("3");
            else
                m_view.printRow("0");
            end;
            return;
        end;

        if (partNumber == 7)
            valueArray = TArray();
            attributes = m_report.getPart(5).getAttributes();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getName();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getStringValue();
            m_view.printRow(valueArray);
        end;

        if (partNumber < 6)
            attributes = m_report.getPart(partNumber).getAttributes();
            i          = 0;
            j          = beginColumn;

            while (i < attributes.size)

                valueArray = TArray();

                if ((partNumber == 4) and (not isPrintHead))
                    valueArray[valueArray.size] = "4." + attributes[i].getName();
                else
                    valueArray[valueArray.size] = attributes[i].getName();
                end;

                if (partNumber == 4)
                    valueArray[valueArray.size] = attributes[i].getStringValue("3");
                    valueArray[valueArray.size] = attributes[i].getStringValue("4");
                elif (partNumber == 5)
                    if (i == ATTRIBUTEPART5ITEM5)
                        i = i + 1;
                        continue;
                    end;
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                elif ((beginColumn != null)and ((partNumber == 1) or (partNumber == 2) or (partNumber == 3)))
                    j = beginColumn;
                    while ( j <= endColumn )
                        valueArray[valueArray.size] = attributes[i].getStringValue(string(j));
                        j = j + 1;
                    end;
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                end;

                if (partNumber == 3)
                    if ((attributes[i].getStringValue(string(3)) == stringUndefined)
                        and
                        (substr(valueArray[0], 1, 2) == "1.")
                       )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                        valueArray[valueArray.size-2] = "0";
                        valueArray[valueArray.size-1] = "0";
                    end;
                end;


                j = 0;
                while (j < valueArray.size)
                    if (valueArray[j] == stringUndefined)
                        valueArray[j] = "";
                    end;
                    j = j + 1;
                end;

                m_view.printRow(valueArray);

                i = i + 1;
            end;
        end;
        if (partNumber == 6)
            var iterator = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            i = 1;
            iterator.moveFirst();
            while (not iterator.isDone())
                valueArray = TArray();
                valueArray[valueArray.size] = i;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("isNotResident").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("name").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("inn").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("iLicense").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("nSecurities").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("bookValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("presentValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve283").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve2732").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve").scaledAsString;
                i = i + 1;
                iterator.moveNext();
                m_view.printRow(valueArray);
            end;
        end;
    end;
end;

/**
 * Операция печати по 2926-У.
 */
class (TKlikoExportController2835) TKlikoExportController2926()
    initTKlikoExportController2835();

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     isPrintHead           признак печати служебной строки
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer, isPrintHead)

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        const ATTRIBUTEPART5ITEM5 = 15;

        if (isPrintHead)
            m_view.printHead(partDescription);
        end;

        if (partNumber == 8)   /* F115A_PRP */
            valueArray = TArray();
            if (rcbApplication.currentReport.context.period.kind   == RCB_PK_MONTH)
                m_view.printRow("1");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                m_view.printRow("2");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR)
                m_view.printRow("3");
            else
                m_view.printRow("0");
            end;
            return;
        end;

        if (partNumber == 7)   /* F115A_SP5 */
            valueArray = TArray();
            attributes = m_report.getPart(5).getAttributes();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getName();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getStringValue();
            m_view.printRow(valueArray);
        end;

        if (partNumber < 6)
            attributes = m_report.getPart(partNumber).getAttributes();
            i = 0;
            j = beginColumn;

            while (i < attributes.size)

                valueArray = TArray();

                if ((partNumber == 4) and (not isPrintHead))
                    valueArray[valueArray.size] = "4." + attributes[i].getName();
                else
                    valueArray[valueArray.size] = attributes[i].getName();
                end;

                if (partNumber == 4)    /* F115A_4 */
                    valueArray[valueArray.size] = attributes[i].getStringValue("3");
                    valueArray[valueArray.size] = attributes[i].getStringValue("4");
                elif (partNumber == 5)  /* F115A_SP123 */
                    if (i == ATTRIBUTEPART5ITEM5)
                        i = i + 1;
                        continue;
                    end;
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                elif (    (beginColumn != null)
                      and (   (partNumber == 1)
                           or (partNumber == 2)
                           or (partNumber == 3)))
                    j = beginColumn;
                    while ( j <= endColumn )
                        valueArray[valueArray.size] = attributes[i].getStringValue(string(j));
                        j = j + 1;
                    end;
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                end;

                if (partNumber == 3)   /* F115A_3 */
                    if ((attributes[i].getStringValue(string(3)) == stringUndefined)
                        and
                        (substr(valueArray[0], 1, 2) == "1.")
                       )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                        valueArray[valueArray.size-2] = "0";
                        valueArray[valueArray.size-1] = "0";
                    end;
                end;

                j = 0;
                while (j < valueArray.size)
                    if (valueArray[j] == stringUndefined)
                        valueArray[j] = "";
                    end;
                    j = j + 1;
                end;

                m_view.printRow(valueArray);

                i = i + 1;
            end;
        end;
        if (partNumber == 6)   /* F115A_SP4 */
            var iterator = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            i = 1;
            iterator.moveFirst();
            while (not iterator.isDone())
                valueArray = TArray();
                valueArray[valueArray.size] = i;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("isNotResident").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("name").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("inn").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("iLicense").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("nSecurities").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("bookValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("presentValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve283").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve2732").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve").scaledAsString;
                i = i + 1;
                iterator.moveNext();
                m_view.printRow(valueArray);
            end;
        end;
    end;
end;

class (TKlikoExportController2926) TKlikoExportController3129()
    initTKlikoExportController2926();

    private macro printFile()
        m_view.setOutputFile();

        var stringBeginDate = String(rcbApplication.currentReport.context.period.beginDate);
        var stringEndDate   = String(rcbApplication.currentReport.context.period.EndDate);
            /* note: внутримесячная дата - год и месяц начала и окончания периода равны */
        var isIntraMonth = (substr(stringBeginDate, 4, 2) == substr(stringEndDate, 4, 2)) and
                           (substr(stringBeginDate, 7, 4) == substr(stringEndDate, 7, 4));
        var y;
        dateSplit(rcbApplication.currentReport.context.period.EndDate, NULL, NULL, y);

        if ((isIntraMonth) AND (rcbApplication.currentReport.context.period.kind != RCB_PK_MONTH))
            printPart(1, "F115D_1", 3, 19, true);
            printPart(2, "F115D_2", 3,  4, true);
            printPart(3, "F115D_3", 3,  4, true);
            printPart(5, "F115D_4", 0,  0, true);
            printPart(4, "",        3,  4);
            printPart(7, "");
        else
            printPart(1, "F115A_1",     3, 19, true);
            printPart(2, "F115A_2",     3,  4, true);
            printPart(3, "F115A_3",     3,  4, true);
            printPart(4, "F115A_4",     3,  4, true);
            printPart(5, "F115A_SP123", 0,  0, true);
            printPart(6, "F115A_SP4",   0,  0, true);
            printPart(7, "F115A_SP5",   0,  0, true);
            if ((rcbApplication.currentReport.context.period.EndDate == Date(31, 03, y)) or
                (rcbApplication.currentReport.context.period.EndDate == Date(30, 06, y)) or
                (rcbApplication.currentReport.context.period.EndDate == Date(30, 09, y)) or
                (rcbApplication.currentReport.context.period.EndDate == Date(31, 12, y))
               )
                printPart(8, "F115A_SP6",  0,  0, true);
            end;
            printPart(9, "F115A_PRP",   0,  0, true);
        end;

        m_view.resetOutputFile();
    end;

    /**
     * Печать раздела в файл экспорта.
     * @param     partNumber            номер строки
     * @param     partDescription       наименование строки
     * @param     beginColumn           начальная позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     endColumn             конечная  позиция(номер графы) расчитываемых значений для строки данного раздела
     * @param     isPrintHead           признак печати служебной строки
     */
    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer, isPrintHead)
        macro setNullArray(arr)
            var j = 0;
            while (j < arr.size)
                if ((arr[j] == stringUndefined) or (arr[j] == null))
                    arr[j] = "";
                end;
                j = j + 1;
            end;
        end;

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        const ATTRIBUTEPART5ITEM5 = 15;

        if (isPrintHead)
            m_view.printHead(partDescription);
        end;

        if (partNumber == 9)   /* F115A_PRP */
            valueArray = TArray();
            if (rcbApplication.currentReport.context.period.kind   == RCB_PK_MONTH)
                m_view.printRow("1");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                m_view.printRow("2");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR)
                m_view.printRow("3");
            else
                m_view.printRow("0");
            end;
            return;
        end;

        if (partNumber == 8)   /* F115A_SP6 */
            var m_attributeItem_6_1_Value   = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1").createValueIterator();
            var m_attributeItem_6_1_1_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1").createValueIterator();
            var m_attributeItem_6_1_2_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2").createValueIterator();

            m_attributeItem_6_1_Value.moveFirst();
            m_attributeItem_6_1_1_Value.moveFirst();
            m_attributeItem_6_1_2_Value.moveFirst();

            valueArray = TArray();
            if (not m_attributeItem_6_1_Value.isDone())
                valueArray[valueArray.size] = "1";
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("reserve").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_1_Value.isDone())
                valueArray[valueArray.size] = "1.1";
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_2_Value.isDone())
                valueArray[valueArray.size] = "1.2";
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            return;
        end;

        if (partNumber == 7)   /* F115A_SP5 */
            valueArray = TArray();
            attributes = m_report.getPart(5).getAttributes();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getName();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getStringValue();
            m_view.printRow(valueArray);
        end;

        if (partNumber < 6)
            attributes = m_report.getPart(partNumber).getAttributes();
            i = 0;
            j = beginColumn;

            while (i < attributes.size)

                valueArray = TArray();

                if ((partNumber == 4) and (not isPrintHead))
                    valueArray[valueArray.size] = "4." + attributes[i].getName();
                else
                    valueArray[valueArray.size] = attributes[i].getName();
                end;

                if (partNumber == 4)    /* F115A_4 */
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("3") != "0", attributes[i].getStringValue("3"), "");
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("4") != "0", attributes[i].getStringValue("4"), "");
                elif (partNumber == 5)  /* F115A_SP123 */
                    if (i == ATTRIBUTEPART5ITEM5)
                        i = i + 1;
                        continue;
                    end;
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                elif (    (beginColumn != null)
                      and (   (partNumber == 1)
                           or (partNumber == 2)
                           or (partNumber == 3)))

                    j = beginColumn;
                    while (j <= endColumn)
                        if   (    (partNumber == 3)
                              and (attributes[i].getName() == "2.1")
                              and (j == endColumn))
                            valueArray[valueArray.size] = "";
                        else
                            valueArray[valueArray.size] = ternary(attributes[i].getStringValue(string(j)) != "", attributes[i].getStringValue(string(j)), "0"); //nvl(attributes[i].getStringValue(string(j)), "0");
                        end;
                        j = j + 1;
                    end;
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                end;

                if (partNumber == 3)   /* F115A_3 */
                    if (    (attributes[i].getStringValue(string(3)) == stringUndefined)
                        and
                            (substr(valueArray[0], 1, 2) == "1.")
                       )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                        valueArray[valueArray.size-2] = "0";
                        valueArray[valueArray.size-1] = "0";
                    end;
                end;

                setNullArray(valueArray);

                m_view.printRow(valueArray);

                i = i + 1;
            end;
        end;

        if (partNumber == 6)   /* F115A_SP4 */
            var iterator = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            i = 1;
            iterator.moveFirst();
            while (not iterator.isDone())
                valueArray = TArray();
                valueArray[valueArray.size] = i;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("isNotResident").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("name").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("inn").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("iLicense").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("nSecurities").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("bookValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("presentValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve283").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve2732").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve").scaledAsString;
                i = i + 1;
                iterator.moveNext();
                m_view.printRow(valueArray);
            end;
        end;
    end;

    private macro getDescriptorInfo()
        return "F115_42.PAK от 27.08.2013";
    end;
end;

class (TKlikoExportController3129) TKlikoExportController_4212()
    initTKlikoExportController3129();

    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer, isPrintHead)
        macro setNullArray(arr)
            var j = 0;
            while (j < arr.size)
                if ((arr[j] == stringUndefined) or (arr[j] == null))
                    arr[j] = "";
                end;
                j = j + 1;
            end;
        end;

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        const ATTRIBUTEPART5ITEM5 = 15;

        if (isPrintHead)
            m_view.printHead(partDescription);
        end;

        if (partNumber == 9)   /* F115A_PRP */
            valueArray = TArray();
            if (rcbApplication.currentReport.context.period.kind   == RCB_PK_MONTH)
                m_view.printRow("1");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                m_view.printRow("2");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR)
                m_view.printRow("3");
            else
                m_view.printRow("0");
            end;
            return;
        end;

        if (partNumber == 8)   /* F115A_SP6 */
            var m_attributeItem_6_1_Value   = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1").createValueIterator();
            var m_attributeItem_6_1_1_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1").createValueIterator();
            var m_attributeItem_6_1_2_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2").createValueIterator();

            m_attributeItem_6_1_Value.moveFirst();
            m_attributeItem_6_1_1_Value.moveFirst();
            m_attributeItem_6_1_2_Value.moveFirst();

            valueArray = TArray();
            if (not m_attributeItem_6_1_Value.isDone())
                valueArray[valueArray.size] = "1";
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = "";
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_1_Value.isDone())
                valueArray[valueArray.size] = "1.1";
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_2_Value.isDone())
                valueArray[valueArray.size] = "1.2";
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            return;
        end;

        if (partNumber == 7)   /* F115A_SP5 */
            valueArray = TArray();
            attributes = m_report.getPart(5).getAttributes();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getName();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getStringValue();
            m_view.printRow(valueArray);
        end;

        if (partNumber < 6)
            attributes = m_report.getPart(partNumber).getAttributes();
            i = 0;
            j = beginColumn;

            while (i < attributes.size)

                valueArray = TArray();

                if ((partNumber == 4) and (not isPrintHead))
                    valueArray[valueArray.size] = "4." + attributes[i].getName();
                else
                    valueArray[valueArray.size] = attributes[i].getName();
                end;

                if (partNumber == 4)    /* F115A_4 */
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("3") != "0", attributes[i].getStringValue("3"), "");
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("4") != "0", attributes[i].getStringValue("4"), "");
                elif (partNumber == 5)  /* F115A_SP123 */
                    if (i == ATTRIBUTEPART5ITEM5)
                        i = i + 1;
                        continue;
                    end;
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                elif (    (beginColumn != null)
                      and (   (partNumber == 1)
                           or (partNumber == 2)
                           or (partNumber == 3)))

                    j = beginColumn;
                    while (j <= endColumn)
                        if   (    (partNumber == 3)
                              and (attributes[i].getName() == "2.1")
                              and (j == endColumn))
                            valueArray[valueArray.size] = "";
                        elif (  (partNumber == 1)
                              and (   (    (attributes[i].getName() == "1.1")
                                       and ((j == 9) or (j == 10) or (j == 11) or (j == 12) or (j == 14)))
                                   or (    (attributes[i].getName() == "1.8")
                                       and ((j == 13) or (j == 14)))
                                   or (    (attributes[i].getName() == "2.7")
                                       and ((j == 13) or (j == 14)))
                                   or (    (attributes[i].getName() == "3.6")
                                       and ((j == 13) or (j == 14)))
                                   or (    (attributes[i].getName() == "4.1.1.1")
                                       and ((j == 8) or (j == 12) or (j == 19)))
                                   or (    (attributes[i].getName() == "4.1.2.1")
                                       and ((j == 8) or (j == 12) or (j == 19)))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        elif (  (partNumber == 2)
                              and (   (    (attributes[i].getName() == "1.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "3")
                                       and ((j == 3) or (j == 4)))
                                   or (    (attributes[i].getName() == "4.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "5.1")
                                       and (j == 4))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        elif (  (partNumber == 3)
                              and (    (attributes[i].getName() == "2")
                                       and ((j == 3) or (j == 4))
                                   or (    (attributes[i].getName() == "2.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "3.1")
                                       and (j == 4))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        else
                            valueArray[valueArray.size] = ternary(attributes[i].getStringValue(string(j)) != "", attributes[i].getStringValue(string(j)), "0");
                        end;
                        j = j + 1;
                    end;
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                end;

                if (partNumber == 3)   /* F115A_3 */
                    if (    (attributes[i].getStringValue(string(3)) == stringUndefined)
                        and
                            (substr(valueArray[0], 1, 2) == "1.")
                       )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                        valueArray[valueArray.size-2] = "0";
                        valueArray[valueArray.size-1] = "0";
                    end;
                end;

                setNullArray(valueArray);

                m_view.printRow(valueArray);

                i = i + 1;
            end;
        end;

        if (partNumber == 6)   /* F115A_SP4 */
            var iterator = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            i = 1;
            iterator.moveFirst();
            while (not iterator.isDone())
                valueArray = TArray();
                valueArray[valueArray.size] = i;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("isNotResident").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("name").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("inn").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("iLicense").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("nSecurities").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("bookValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("presentValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve283").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve2732").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve").scaledAsString;
                i = i + 1;
                iterator.moveNext();
                m_view.printRow(valueArray);
            end;
        end;
    end;

    private macro getDescriptorInfo()
        return "F115_46.PAK от 12.01.2017";
    end;
end;

class (TKlikoExportController_4212) TKlikoExportController_4637()
    initTKlikoExportController_4212();

    macro printPart(partNumber : Integer, partDescription : String, beginColumn : Integer, endColumn : Integer, isPrintHead)
        macro setNullArray(arr)
            var j = 0;
            while (j < arr.size)
                if ((arr[j] == stringUndefined) or (arr[j] == null))
                    arr[j] = "";
                end;
                j = j + 1;
            end;
        end;

        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var valueArray : TArray;  /*массив значений для строки отчета*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/

        const ATTRIBUTEPART5ITEM5 = 15;

        if (isPrintHead)
            m_view.printHead(partDescription);
        end;

        if (partNumber == 9)   /* F115A_PRP */
            valueArray = TArray();
            if (rcbApplication.currentReport.context.period.kind   == RCB_PK_MONTH)
                m_view.printRow("1");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                m_view.printRow("2");
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR)
                m_view.printRow("3");
            else
                m_view.printRow("0");
            end;
            return;
        end;

        if (partNumber == 8)   /* F115A_SP6 */
            var m_attributeItem_6_1_Value   = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1").createValueIterator();
            var m_attributeItem_6_1_1_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1").createValueIterator();
            var m_attributeItem_6_1_2_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2").createValueIterator();

            m_attributeItem_6_1_Value.moveFirst();
            m_attributeItem_6_1_1_Value.moveFirst();
            m_attributeItem_6_1_2_Value.moveFirst();

            valueArray = TArray();
            if (not m_attributeItem_6_1_Value.isDone())
                valueArray[valueArray.size] = "1";
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = "";
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_1_Value.isDone())
                valueArray[valueArray.size] = "1.1";
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_1_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            valueArray = TArray();
            if (not m_attributeItem_6_1_2_Value.isDone())
                valueArray[valueArray.size] = "1.2";
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("demandAmount").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("reserve").currentAsString;
                valueArray[valueArray.size] = m_attributeItem_6_1_2_Value.currentItem.fieldValue("justCost").currentAsString;
                setNullArray(valueArray);
                m_view.printRow(valueArray);
            end;

            return;
        end;

        if (partNumber == 7)   /* F115A_SP5 */
            valueArray = TArray();
            attributes = m_report.getPart(5).getAttributes();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getName();
            valueArray[valueArray.size] = attributes[ATTRIBUTEPART5ITEM5].getStringValue();
            m_view.printRow(valueArray);
        end;

        if (partNumber < 6)
            attributes = m_report.getPart(partNumber).getAttributes();
            i = 0;
            j = beginColumn;

            while (i < attributes.size)
                valueArray = TArray();

                if ((partNumber == 4) and (not isPrintHead))
                    valueArray[valueArray.size] = "4." + attributes[i].getName();
                else
                    valueArray[valueArray.size] = attributes[i].getName();
                end;

                if (partNumber == 4)    /* F115A_4 */
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("3") != "0", attributes[i].getStringValue("3"), "");
                    valueArray[valueArray.size] = ternary(attributes[i].getStringValue("4") != "0", attributes[i].getStringValue("4"), "");
                elif (partNumber == 5)  /* F115A_SP123 */
                    if (i == ATTRIBUTEPART5ITEM5)
                        i = i + 1;
                        continue;
                    end;
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                elif (    (beginColumn != null)
                      and (   (partNumber == 1)
                           or (partNumber == 2)
                           or (partNumber == 3)))

                    j = beginColumn;
                    while (j <= endColumn)
                        if   (    (partNumber == 3)
                              and (attributes[i].getName() == "2.1")
                              and (j == endColumn))
                            valueArray[valueArray.size] = "";
                        elif (  (partNumber == 1)
                              and (   (    (attributes[i].getName() == "1.1")
                                       and ((j == 9) or (j == 10) or (j == 11) or (j == 12) or (j == 14)))
                                   or (    (attributes[i].getName() == "4.1.1.1")
                                       and ((j == 8) or (j == 12) or (j == 19)))
                                   or (    (attributes[i].getName() == "4.1.2.1")
                                       and ((j == 8) or (j == 12) or (j == 19)))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        elif (  (partNumber == 2)
                              and (   (    (attributes[i].getName() == "1.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "3")
                                       and ((j == 3) or (j == 4)))
                                   or (    (attributes[i].getName() == "4.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "5.1")
                                       and (j == 4))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        elif (  (partNumber == 3)
                              and (    (attributes[i].getName() == "2")
                                       and ((j == 3) or (j == 4))
                                   or (    (attributes[i].getName() == "2.1")
                                       and (j == 4))
                                   or (    (attributes[i].getName() == "3.1")
                                       and (j == 4))
                                  )
                             )
                             valueArray[valueArray.size] = "";
                        else
                            valueArray[valueArray.size] = ternary(attributes[i].getStringValue(string(j)) != "", attributes[i].getStringValue(string(j)), "0");
                        end;
                        j = j + 1;
                    end;
                else
                    valueArray[valueArray.size] = attributes[i].getStringValue();
                end;

                if (partNumber == 3)   /* F115A_3 */
                    if (    (attributes[i].getStringValue(string(3)) == stringUndefined)
                        and
                            (substr(valueArray[0], 1, 2) == "1.")
                       )/*т.е. global.parameters.getRegistry().getOldDebtAllowances() == true*/
                        valueArray[valueArray.size-2] = "0";
                        valueArray[valueArray.size-1] = "0";
                    end;
                end;

                setNullArray(valueArray);
                m_view.printRow(valueArray);
                i = i + 1;
            end;
        end;

        if (partNumber == 6)   /* F115A_SP4 */
            var iterator = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            i = 1;
            iterator.moveFirst();
            while (not iterator.isDone())
                valueArray = TArray();
                valueArray[valueArray.size] = i;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("isNotResident").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("name").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("inn").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("iLicense").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("nSecurities").current;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("bookValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("presentValue").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve283").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve2732").scaledAsString;
                valueArray[valueArray.size] = iterator.currentItem.fieldValue("madeReserve").scaledAsString;
                i = i + 1;
                iterator.moveNext();
                m_view.printRow(valueArray);
            end;
        end;
    end;

    private macro getDescriptorInfo()
        return "Изменения внесены по \"интуиции\" в рамках доработки по Проекту изменений в Указание № 4212-У от 24.10.2017";
    end;
end;
