/*
$Name:          f115CalculationPart5Controller.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 115. Контроллер расчета. Раздел 5.
*/

/**
 * Форма 115. Контроллер расчета.
 */
import f115CalculationPartController;

/**
 *  Расчет переменных по 2835-У.
 *
 */
class (TCalculationPartController)  TCalculationPart5Controller2835(dataSource, tuneTable, protocol, report)

    /**
     * Источник данных по счетам в ГК.
     */
    private var m_cbAccountsDataSource;

    /**
     * Источник данных по договорам в Loans-е.
     */
    private var m_loansCreditDataSource;

    /**
     * Источник данных по траншам в Loans-е.
     */
    private var m_loansTrancheDataSource;

    /**
     * Конструктор.
     */
    private macro constructor(dataSource, tuneTable, protocol, report)
        initTCalculationPartController(dataSource, tuneTable, protocol, report);

        m_loansTrancheDataSource = m_dataSource.getLoansTrancheDataSource();
        m_loansCreditDataSource  = m_dataSource.getLoansCreditDataSource();
        m_cbAccountsDataSource   = m_dataSource.getCbAccountsDataSource();
    end;


    private macro setLineValue(attribute : TAttribute, dataSet, backOffice)
            attribute.setValue(dataSet, null, backOffice);
    end;

    private macro setSubPart4LineValue(attribute : TAttribute, dataSet, backOffice)
        attribute.setValue(dataSet.rest, "3", backOffice);
        attribute.setValue(dataSet.reserveAmount, "4", backOffice);
    end;

    private macro setLineUserValue(attribute : TAttribute)
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), null).getExactValue(), null, BOUser);
    end;


    private macro addLineValue(attribute : TAttribute, dataSet, backOffice)
        attribute.plus(dataSet,   backOffice);
    end;

    var accountFilter;
    var overdueAccountFilter;

    private macro setAccountMasks()
        accountFilter =
                m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(
                m_tuneTable.getAccountMasks("1", "1.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.5", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "1.6", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.1", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "2.5", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.1", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.2", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.3", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.4", BOCB)
        + "," + m_tuneTable.getAccountMasks("1", "3.5", BOCB));
    end;

    /*1*/
    private macro calculateAttribute1(attribute)
		addAttribute(attribute, m_report.getPart("5").getAttribute("1.1"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("1.2"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("1.3"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("1.4"));
    end;   

    /*1.3*/
    private macro calculateAttribute1_3(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("А")
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;   

    /*1.4*/
    private macro calculateAttribute1_4(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Н")
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist(),
                                                     m_loansTrancheDataSource.getFilter().hasCreditType(LO_KARTA)
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;

    /*2*/
    private macro calculateAttribute2(attribute)
		addAttribute(attribute, m_report.getPart("5").getAttribute("2.1"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("2.2"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("2.3"));
		addAttribute(attribute, m_report.getPart("5").getAttribute("2.4"));
    end;   

    /*2.3*/
    private macro calculateAttribute2_3(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("А")
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);

    end;   

    /*2.4*/
    private macro calculateAttribute2_4(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                     m_loansTrancheDataSource.getFilter().hasCreditAim("Н")
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist(),
                                                     m_loansTrancheDataSource.getFilter().hasCreditType(LO_KARTA)
                                                   + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);

    end;

    /*3.1*/
    private macro calculateAttribute3_1(attribute)
        setAccountMasks();
        setLineValue(attribute, 
                     m_loansCreditDataSource.getCalcReserveData(
                                                      m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA)
                                                      + m_loansCreditDataSource.getFilter().hasRiskGroup(3, 4, 5),
                                                      m_loansCreditDataSource.getFilter().hasKindRegister(
                                                                                                tdr_mainrest, /*основной долг*/
                                                                                                tdr_exprest,  /*просроченная задолженность*/
                                                                                                tdr_lim)      /*история неразрешенного ОД*/
                                                               ),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getCalcReserveData(
                                                     accountFilter
                                                   + m_cbAccountsDataSource.getFilter().hasRiskGroup(3, 4, 5)
                                                   + m_cbAccountsDataSource.getFilter().isAccountNotInСase()
                                                               ),
                    BOCb);

        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;

    /*3.2*/
    private macro calculateAttribute3_2(attribute)
        setAccountMasks();
        setLineValue(attribute, 
                     m_loansCreditDataSource.getCalcReserveSecData(
                                                     m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA)
                                                    +m_loansCreditDataSource.getFilter().hasRiskGroup(3, 4, 5),
                                                    m_loansCreditDataSource.getFilter().hasKindRegister(/*данная проверка добавлена исключительно для корректного вида протокола, те же регистры что и для 3.1*/
                                                                                                tdr_mainrest, /*основной долг*/
                                                                                                tdr_exprest,  /*просроченная задолженность*/
                                                                                                tdr_lim)      /*история неразрешенного ОД*/
                                                               ),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getCalcReserveSecData(
                                                     accountFilter
                                                   + m_cbAccountsDataSource.getFilter().hasRiskGroup(3, 4, 5)
                                                   + m_cbAccountsDataSource.getFilter().isAccountNotInСase()
                                                               ),
                    BOCb);
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end; 

    /*3.3*/
    private macro calculateAttribute3_3(attribute)
	    m_protocol.printUserDataCopyMessage();
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end; 

    /*3.4*/
    private macro calculateAttribute3_4(attribute)
	    m_protocol.printUserDataCopyMessage();
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end; 



    constructor(dataSource, tuneTable, protocol, report);

    /*1.1*/
    private macro calculateAttribute1_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("Ж,И,З")
                                                     + m_loansTrancheDataSource.getFilter().isNotRegisteredHypothec()
                                                     + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),                             
                    BOLoans);

        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;   

    /*1.2*/
    private macro calculateAttribute1_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И,З")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                     + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);
        attribute.setValue(m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;   

    /*1.2.1*/
    private macro calculateAttribute1_2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);
        attribute.setValue(- m_report.getUserAttribute(attribute.getName(), "").getExactValue(), null, BOUser);
    end;   


    /*2.1*/
    private macro calculateAttribute2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("Ж,И,З")
                                                     + m_loansTrancheDataSource.getFilter().isNotRegisteredHypothec()
                                                     + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);

    end;   

    /*2.2*/
    private macro calculateAttribute2_2(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И,З")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                     + m_loansTrancheDataSource.getFilter().isChangedRegHist()
                                                               ),
                    BOLoans);

    end;   

    /*2.2.1*/
    private macro calculateAttribute2_2_1(attribute)
        setLineValue(attribute, 
                     m_loansTrancheDataSource.getDelayedDebtsAmountData(
                                                       m_loansTrancheDataSource.getFilter().hasCreditAim("И")
                                                     + m_loansTrancheDataSource.getFilter().isRegisteredHypothec()
                                                               ),
                    BOLoans);

    end;   

    macro calculateAttribute5(attribute)
        setLineValue(attribute, 
                     m_loansCreditDataSource.getPart4SubPart5Data(            m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA, LO_GUARANTEE) 
                                                                  + " AND " + m_loansCreditDataSource.getFilter().hasAccount("60315*", true)
                                                                  /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/,
                                                                  masksMerger(m_tuneTable.getRegisterNumber(     "1", "2.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.6.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.6.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.7", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.7", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.8", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.8", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.2", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.2", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.3", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.3", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.4", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.4", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.5.1", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.5.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.6", BOLoans), 
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.6", BOLoans))),
                    BOLoans);

        setLineValue(attribute, 
                     m_cbAccountsDataSource.getPart4SubPart5Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1", "1.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.7", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.4", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.5", BOCB))
                                                                 /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/),
                     BOCb);
    
    end;

    /* note: раздел "РазделСправочноПункт4", копипуем из раздела РазделСправочноПункт4Ввод */
    macro calculateAttributesPart5Item4()
        var m_attributeItem4Value    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4");
        var m_userIteratorItem4Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4Ввод").createValueIterator();
        m_userIteratorItem4Value.moveFirst();
        while (not m_userIteratorItem4Value.isDone)
            if(not m_userIteratorItem4Value.currentItem.isCompleteDefined())
                m_protocol.printLine("Расчет раздела 6 не выполнен.");
                m_protocol.printLine("У переменной РазделСправочноПункт4Ввод есть структурные значения с незаполненными полями.");
                return;
            end;

            m_userIteratorItem4Value.moveNext();
        end;

        m_userIteratorItem4Value.moveFirst();
        while (not m_userIteratorItem4Value.isDone())
            if (valType(m_attributeItem4Value.fieldValue("name").current) == V_UNDEF)
                var keyValue               = m_attributeItem4Value.createKeyValue();
                keyValue.fieldValue("inn") = m_userIteratorItem4Value.currentItem.fieldValue("inn").current;
                var lineCompositeValue     = m_attributeItem4Value.findValue(keyValue);
                if (lineCompositeValue == null)
                    lineCompositeValue = m_attributeItem4Value.addValue();
                    lineCompositeValue.fieldValue("name").current          = m_userIteratorItem4Value.currentItem.fieldValue("name").currentAsString;
                    lineCompositeValue.fieldValue("inn").current           = m_userIteratorItem4Value.currentItem.fieldValue("inn").currentAsString;
                    lineCompositeValue.fieldValue("iLicense").current      = m_userIteratorItem4Value.currentItem.fieldValue("iLicense").currentAsString;
                    lineCompositeValue.fieldValue("nSecurities").current   = m_userIteratorItem4Value.currentItem.fieldValue("nSecurities").current;
                    lineCompositeValue.fieldValue("bookValue").exact       = m_userIteratorItem4Value.currentItem.fieldValue("bookValue").exact;
                    lineCompositeValue.fieldValue("presentValue").exact    = m_userIteratorItem4Value.currentItem.fieldValue("presentValue").exact;
                    lineCompositeValue.fieldValue("madeReserve283").exact  = m_userIteratorItem4Value.currentItem.fieldValue("madeReserve283").exact;
                    lineCompositeValue.fieldValue("madeReserve2732").exact = m_userIteratorItem4Value.currentItem.fieldValue("madeReserve2732").exact;
                    lineCompositeValue.fieldValue("madeReserve").exact     = m_userIteratorItem4Value.currentItem.fieldValue("madeReserve2732").exact
                                                                             + m_userIteratorItem4Value.currentItem.fieldValue("madeReserve283").exact;
                    lineCompositeValue.fieldValue("isNotResident").current = m_userIteratorItem4Value.currentItem.fieldValue("isNotResident").current;
                    lineCompositeValue.fieldValue("bookValue").recalculateScaled();
                    lineCompositeValue.fieldValue("presentValue").recalculateScaled();
                    lineCompositeValue.fieldValue("madeReserve283").recalculateScaled();
                    lineCompositeValue.fieldValue("madeReserve2732").recalculateScaled();
                    lineCompositeValue.fieldValue("madeReserve").recalculateScaled();
                end;
            end;
            m_userIteratorItem4Value.moveNext();
        end;
    end;

    macro calculate(part : TPart)
        if (part.getNumber() == 5)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 

            m_protocol.printReportLineNumber("1.2.1");
            calculateAttribute1_2_1(part.getAttribute("1.2.1")); 

            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 

            m_protocol.printReportLineNumber("2.2.1");
            calculateAttribute2_2_1(part.getAttribute("2.2.1")); 

            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            m_protocol.printReportLineNumber("5");
            calculateAttribute5(part.getAttribute("5"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT);

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 
        elif (part.getNumber() == 6)
            calculateAttributesPart5Item4();
        end;
    end;
end;


/**
 *  Расчет переменных по 2926-У.
 *
 */
class (TCalculationPart5Controller2835)  TCalculationPart5Controller2926(dataSource, tuneTable, protocol, report)
    initTCalculationPart5Controller2835(dataSource, tuneTable, protocol, report);

    macro calculate(part : TPart)
        if (part.getNumber() == 5)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 
            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 
            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            m_protocol.printReportLineNumber("5");
            calculateAttribute5(part.getAttribute("5"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT);

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 
        elif (part.getNumber() == 6)
            calculateAttributesPart5Item4();
        end;
    end;
end;

class (TCalculationPart5Controller2926)  TCalculationPart5Controller3129_2(dataSource, tuneTable, protocol, report)
    initTCalculationPart5Controller2926(dataSource, tuneTable, protocol, report);

    /* note: раздел "РазделСправочноПункт6_1", копипуем из раздела РазделСправочноПункт6_1Ввод */
    macro calculateAttributesPart5Item6_1()
        var m_attributeItem_6_1_Value    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1");
        var m_userIteratorItem_6_1_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1Ввод").createValueIterator();
        var lineCompositeValue;

        m_userIteratorItem_6_1_Value.moveFirst();
        if (not m_userIteratorItem_6_1_Value.isDone())
            if (m_userIteratorItem_6_1_Value.currentItem.isDefined())
                lineCompositeValue = m_attributeItem_6_1_Value.addValue();
                lineCompositeValue.fieldValue("demandAmount").exact = NVL(m_userIteratorItem_6_1_Value.currentItem.fieldValue("demandAmount").exact, 0);
                lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
                lineCompositeValue.fieldValue("reserve").exact    = NVL(m_userIteratorItem_6_1_Value.currentItem.fieldValue("reserve").exact, 0);
                lineCompositeValue.fieldValue("reserve").recalculateScaled();
                return;
            end;
        end;

        lineCompositeValue = m_attributeItem_6_1_Value.addValue();
        lineCompositeValue.fieldValue("demandAmount").exact = 0.0;
        lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
        lineCompositeValue.fieldValue("reserve").exact    = 0.0;
        lineCompositeValue.fieldValue("reserve").recalculateScaled();
        return;
    end;

    macro calculateAttributesPart5Item6_1_1()
        var m_attributeItem_6_1_1_Value    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1");
        var m_userIteratorItem_6_1_1_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1Ввод").createValueIterator();
        var lineCompositeValue;

        m_userIteratorItem_6_1_1_Value.moveFirst();
        if (not m_userIteratorItem_6_1_1_Value.isDone())
            if (m_userIteratorItem_6_1_1_Value.currentItem.isDefined())
                lineCompositeValue = m_attributeItem_6_1_1_Value.addValue();
                lineCompositeValue.fieldValue("demandAmount").exact = NVL(m_userIteratorItem_6_1_1_Value.currentItem.fieldValue("demandAmount").exact, 0);
                lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
                lineCompositeValue.fieldValue("reserve").exact    = NVL(m_userIteratorItem_6_1_1_Value.currentItem.fieldValue("reserve").exact, 0);
                lineCompositeValue.fieldValue("reserve").recalculateScaled();
                lineCompositeValue.fieldValue("justCost").exact    = NVL(m_userIteratorItem_6_1_1_Value.currentItem.fieldValue("justCost").exact, 0);
                lineCompositeValue.fieldValue("justCost").recalculateScaled();
                return;
            end;
        end;

        lineCompositeValue = m_attributeItem_6_1_1_Value.addValue();
        lineCompositeValue.fieldValue("demandAmount").exact = 0.0;
        lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
        lineCompositeValue.fieldValue("reserve").exact    = 0.0;
        lineCompositeValue.fieldValue("reserve").recalculateScaled();
        lineCompositeValue.fieldValue("justCost").exact    = 0.0;
        lineCompositeValue.fieldValue("justCost").recalculateScaled();
        return;
    end;

    macro calculateAttributesPart5Item6_1_2()
        var m_attributeItem_6_1_2_Value    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2");
        var m_userIteratorItem_6_1_2_Value = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2Ввод").createValueIterator();
        var lineCompositeValue;

        m_userIteratorItem_6_1_2_Value.moveFirst();
        if (not m_userIteratorItem_6_1_2_Value.isDone())
            if (m_userIteratorItem_6_1_2_Value.currentItem.isDefined())
                lineCompositeValue = m_attributeItem_6_1_2_Value.addValue();
                lineCompositeValue.fieldValue("demandAmount").exact = NVL(m_userIteratorItem_6_1_2_Value.currentItem.fieldValue("demandAmount").exact, 0);
                lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
                lineCompositeValue.fieldValue("reserve").exact    = NVL(m_userIteratorItem_6_1_2_Value.currentItem.fieldValue("reserve").exact, 0);
                lineCompositeValue.fieldValue("reserve").recalculateScaled();
                lineCompositeValue.fieldValue("justCost").exact    = NVL(m_userIteratorItem_6_1_2_Value.currentItem.fieldValue("justCost").exact, 0);
                lineCompositeValue.fieldValue("justCost").recalculateScaled();
                return;
            end;
        end;

        lineCompositeValue = m_attributeItem_6_1_2_Value.addValue();
        lineCompositeValue.fieldValue("demandAmount").exact = 0.0;
        lineCompositeValue.fieldValue("demandAmount").recalculateScaled();
        lineCompositeValue.fieldValue("reserve").exact    = 0.0;
        lineCompositeValue.fieldValue("reserve").recalculateScaled();
        lineCompositeValue.fieldValue("justCost").exact    = 0.0;
        lineCompositeValue.fieldValue("justCost").recalculateScaled();
        return;
    end;

private class TFilter(param : string)
private var m_attribute = param;

    macro isSuitable(v)
        if (m_attribute == "1")
            return in(v.fieldValue("line").exact, "1.1", "1.2", "1.3", "1.4");
        elif (m_attribute == "2")
            return in(v.fieldValue("line").exact, "2.1", "2.2", "2.3", "2.4");
        elif (m_attribute == "3")
            return in(v.fieldValue("line").exact, "3.1", "3.2", "3.3", "3.4");
        elif (m_attribute == "5")
            return in(v.fieldValue("line").exact, "5");
        end;
    end;
end;

    macro calculate(part : TPart)
        if (part.getNumber() == 5)
            m_protocol.printReportLineNumber("1.1");
            calculateAttribute1_1(part.getAttribute("1.1")); 
            m_protocol.printReportLineNumber("1.2");
            calculateAttribute1_2(part.getAttribute("1.2")); 
            m_protocol.printReportLineNumber("1.3");
            calculateAttribute1_3(part.getAttribute("1.3")); 
            m_protocol.printReportLineNumber("1.4");
            calculateAttribute1_4(part.getAttribute("1.4")); 

            m_protocol.printReportLineNumber("2.1");
            calculateAttribute2_1(part.getAttribute("2.1")); 
            m_protocol.printReportLineNumber("2.2");
            calculateAttribute2_2(part.getAttribute("2.2")); 
            m_protocol.printReportLineNumber("2.3");
            calculateAttribute2_3(part.getAttribute("2.3")); 
            m_protocol.printReportLineNumber("2.4");
            calculateAttribute2_4(part.getAttribute("2.4")); 

            m_protocol.printReportLineNumber("3.1");                   
            calculateAttribute3_1(part.getAttribute("3.1"));                   
            m_protocol.printReportLineNumber("3.2");
            calculateAttribute3_2(part.getAttribute("3.2"));
            m_protocol.printReportLineNumber("3.3");
            calculateAttribute3_3(part.getAttribute("3.3"));
            m_protocol.printReportLineNumber("3.4");
            calculateAttribute3_4(part.getAttribute("3.4"));

            m_protocol.printReportLineNumber("5");
            calculateAttribute5(part.getAttribute("5"));

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();

            part.getValue().summarizeDependentValues(RCB_SU_EXACT,TFilter("1"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT,TFilter("2"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT,TFilter("3"));
            part.getValue().summarizeDependentValues(RCB_SU_EXACT,TFilter("5"));

            m_protocol.printReportLineNumber("1");
            calculateAttribute1(part.getAttribute("1")); 

            m_protocol.printReportLineNumber("2");
            calculateAttribute2(part.getAttribute("2")); 

            /*это переменные, которые не должны были расчитываться*/
            part.getAttribute("3").setUndefinedValue();       
        elif (part.getNumber() == 6)
            calculateAttributesPart5Item4();
        elif (part.getNumber() == 7)
            calculateAttributesPart5Item6_1()();
        elif (part.getNumber() == 8)
            calculateAttributesPart5Item6_1_1();
        elif (part.getNumber() == 9)
            calculateAttributesPart5Item6_1_2();
        end;
    end;
end;

class (TCalculationPart5Controller3129_2)  TCalculationPart5ControllerF115_43_PAK(dataSource, tuneTable, protocol, report)
    initTCalculationPart5Controller3129_2(dataSource, tuneTable, protocol, report);

    macro calculateAttribute5(attribute)
        setLineValue(attribute,
                     m_loansCreditDataSource.getPart4SubPart5Data(            m_loansCreditDataSource.getFilter().hasType(LO_CREDIT, LO_OVERDRAFT, LO_KARTA, LO_GUARANTEE)
                                                                  + " AND " + m_loansCreditDataSource.getFilter().hasAccount("60315*", true)
                                                                  /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/,
                                                                  masksMerger(m_tuneTable.getRegisterNumber(     "1", "2.1", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.6.1", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.6.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.7", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.7", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "2.8", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "2.8", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.1", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.2", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.2", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.3", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.3", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.4", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.4", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.5.1", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.5.1", BOLoans),
                                                                              m_tuneTable.getRegisterNumber(     "1", "3.6", BOLoans),
                                                                              m_tuneTable.getDelayRegisterNumber("1", "3.6", BOLoans))),
                    BOLoans);

        setLineValue(attribute,
                     m_cbAccountsDataSource.getPart5SubPart5Data(m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1", "1.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "1.7", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.5", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "2.6", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.1", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.2", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.3", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.4", BOCB)
                                                                                                                      + "," + m_tuneTable.getAccountMasks("1", "3.5", BOCB))
                                                                 /*условие "максимальный срок просрочки больше 90 дней", проверяется в источнике данных*/,
                                                                 m_cbAccountsDataSource.getFilter().isSatisfiesToAccountMasks("91605*,91606*")
                                                               + m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'Просрочка свыше 90 дней'", RCB_OBJGROUP_FOR_REPORTING)),
                     BOCb);

    end;
end;