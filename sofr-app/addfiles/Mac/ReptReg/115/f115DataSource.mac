/*
$Name:          f115DataSource.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 115. Источники данных для расчета атрибутов.
*/

/**
 * Форма 115. Источники данных для расчета атрибутов.
 *
 * @since   01.06.2008
 * @author  Ivkina Olga
 * @version 6.00.020.28
 */
import rcb_lib;
import RsbDataSet;

import f115Global;
import f115DataSourceProtocols;
import f115DataSourceFilters;

const ADD_AC_NONE             = 0; /*никакой*/
const ADD_AC_DEBT             = 1; /*"счет срочной задолженности"*/
const ADD_AC_ACCRUED_INTEREST = 2; /*"счет начисленных процентов"*/

/**
 * Базовый класс источников данных.
 *
 */
class TDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol, backOffice : Integer)
    private macro RcbDataSet(text, cursorLocation, cursorType)

        if (not protocolIsOn())
           var cmd = RsdCommand("{ ? = CALL rep_utl.excludeFromQueryDetailedRows(?) }");
           cmd.AddParam( "newText",  RSDBP_RETVAL, V_STRING, 32000);
           cmd.addParam( "",         RSDBP_IN,     text);

           cmd.execute;
           text  = cmd.value( "newText" );
           cmd.close();
        end;
        return TRsbDataSet(text, cursorLocation, cursorType);
        OnError(er);
            msgbox( cmd, "Ошибка.", er.message );
            RepErrorsQueue().add(0, string(er.message));
            return text;
    end;

    /**
     * Фильтр для источника данных.
     */
    private var m_filter : TDataSourceFilters;

    /**
     * Протокол источника данных.
     */
    private var m_protocol : TDataSourceProtocol;

    /**
     * Бэк-офис.
     */
    private var m_backOffice : TBackOffice;

    /**
     * Конструктор.
     */
    macro constructor(filter: TDataSourceFilters, protocol : TDataSourceProtocol, backOffice)
        m_filter   = filter;
        if (protocol != NULL)
            m_protocol = protocol;
        end;
        m_backOffice = TBackOffice(NVL(backOffice, BONothing));
    end;

    /**
     * Получить бэк-офис.
     */
    macro getBackOffice() : TBackOffice
        return m_backOffice;
    end;

    /**
     * Получить объект с фильтрами для источника данных.
     */
    macro getFilter() : TDataSourceFilters
        return  m_filter;
    end;

    /**
     * Удаление закешированных данных.
     */
    macro clear()
    end;

    /**
     * Кеширование данных.
     */
    private macro cacheData()
    end;

    /**
     * Кеширование данных.
     */
    macro cache(tuneTable)
        clear();
        if (tuneTable.hasDataFor(m_backOffice))
            cacheData(tuneTable);
        end;
    end;

    constructor(filter, protocol, backOffice);
end;

/**
 * Источник данных по ГК.
 */
class (TDataSource) TCbDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    initTDataSource(filter, protocol, BOCB);
end;
/**
 * Источник данных по Лоанс.
 */
class (TDataSource) TLoansDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    initTDataSource(filter, protocol, BOLoans);
end;

/**
 * Класс источника данных "Лицевые счета ГК".
 */
class (TCbDataSource) TCbAccountsDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(filter,   TCbAccountsDataSourceFilters());
    defaultParm(protocol, TCbAccountsProtocol());
    initTCbDataSource(filter, protocol);

    /**
     * Удаление кешированных данных.
     */
    macro clear()
/*        sql_execute("TRUNCATE TABLE drepReserveAccount_tmp");*/
    end;

    /**
     * Кеширование данных.
     */
    macro cacheData()
/*        sql_execute("INSERT INTO drepReserveAccount_tmp (select * from drepReserveAccount_vw)");*/
    end;

    /**
     * Определение вида контрагента счета.
     */
    private macro typeAccountContragent()
        return            " CASE                                                             "
                 + "\n" + " WHEN contragent.t_isBank = 1                                     "
                 + "\n" + "    THEN 'КО'                                                     "
                 + "\n" + " WHEN contragent.t_isPhisical = 1 and contragent.t_isEmployer = 0 "
                 + "\n" + "    THEN 'ФЛ'                                                     "
                 + "\n" + "    ELSE 'ЮЛ'                                                     "
                 + "\n" + "END                                                               ";
    end;

    /**
     * Срок просрочки(Дата)
     */
    private macro overdueTerm(chargeCommission)
        defaultParm(chargeCommission, global.parameters.getRegistry().getChargeCommission().getValue());

        var oldDebtAllowances = global.parameters.getRegistry().getOldDebtAllowances().getValue();
        var overdueDate = "";

        if (chargeCommission)
             return        " CASE                                                                                "
                  + "\n" + " WHEN rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account,            "
                  + "\n" + "                                rep_data.getEndDate()) > 0                           "
                  + "\n" + " THEN rep_account.getMaxTerm(acc.t_fiId, acc.t_chapter, acc.t_account,               "
                  + "\n" + "                             rep_data.getEndDate())                                  "
                  + "\n" + " ELSE rep_data.getEndDate() - NVL(rep_note.readMaturityDate(acc.t_chapter,           "
                 + "\n" + "                                                            acc.t_account,           "
                 + "\n" + "                                                            acc.t_fiId,              "
                 + "\n" + "                                                            rep_data.getEndDate()),  "
                 + "\n" + "                                  rep_data.getEndDate())                             "
                  + "\n" + " END                                                                                 "
         else
             if (oldDebtAllowances)
             overdueDate = "       CASE                                                                          "
                 + "\n" + "          WHEN acc.t_outcoverRest = 0                                                     "
                 + "\n" + "             THEN rep_data.getEndDate ()                                             "
                 + "\n" + "          ELSE NVL((SELECT MAX (t_date)                                              "
                 + "\n" + "                  FROM (SELECT SUM (doc.t_incoversum) OVER (partition by               "
                 + "\n" + "                                doc.t_debetAccountId                                  "
                 + "\n" + "                                ORDER BY t_date DESC) t_debet_sum,                   "
                 + "\n" + "                               doc.*                                                 "
                 + "\n" + "                          FROM drepDocument_vw doc) doc                              "
                 + "\n" + "                 WHERE doc.t_debetAccountId = acc.t_accountId                            "
                 + "\n" + "                   AND acc.t_outcoverRest <= t_debet_sum), rep_data.getEndDate())                                   "
                 + "\n" + "       END                                                                           ";
            else
         overdueDate = " SELECT NVL(MAX(t_restdate), rep_data.getEndDate())                                "
                 + "\n" + "   FROM dRestDate_dbt restdate                                                       "
                 + "\n" + "  WHERE restdate.t_accountid       = acc.t_accountid                                     "
                 + "\n" + "    AND restdate.t_restCurrency = acc.t_fiId                                        "
                 + "\n" + "    AND restdate.t_restDate   <= rep_data.getEndDate()                             "
                 + "\n" + "    AND t_restDate > NVL((SELECT MAX(t_restdate)                                 "
                 + "\n" + "                                 FROM dRestDate_dbt maxDate                             "
                 + "\n" + "                               WHERE maxDate.t_restCurrency = restdate.t_restCurrency"
                 + "\n" + "                                 AND maxDate.t_accountid       = restdate.t_accountid      "
                 + "\n" + "                                 AND maxDate.t_rest_date   <= rep_data.getEndDate()   "
                 + "\n" + "                           to_date('01.01.0001', 'dd.mm.yyyy'))                      ";
             end;
            return "(rep_data.getEndDate() - (" + overdueDate + ") )";
         end;
    end;

    /**
     * Сумма прочрочки для 47423*.
     */
    private macro commissionOverdueRequirements(chargeCommission)
        defaultParm(chargeCommission, global.parameters.getRegistry().getChargeCommission().getValue());
        var overdueRequirements;

        if (chargeCommission)
            overdueRequirements = "NVL((case when rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account, rep_data.getEndDate()) > 0         "
                 + "\n" + "                then      rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account, rep_data.getEndDate())             "
                 + "\n" + "                else null end                                                                                              "
                 + "\n" + "               ),                                                                                                          "
                 + "\n" + "               NVL(rep_note.readAccOverdueRequirements115(acc.t_chapter, acc.t_account, acc.t_fiId, rep_data.getEndDate()),      "
                 + "\n" + "                NVL(rep_note.readAccountOverdueRequirements(acc.t_chapter, acc.t_account, acc.t_fiId, rep_data.getEndDate()), "
                 + "\n" + "                    0)                                                                                                  "
                 + "\n" + "               )                                                                                                        "
                 + "\n" + "           )                                                                                                            ";
        else
            overdueRequirements = " acc.t_outCoverRest                                                             ";
        end;

        return overdueRequirements;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * @param     filter                 общий фильтр на выборку
     * @param     overdueAccountFilter   фильтр для счетов просроченной задолжности
     *
     */
    private macro getData(selectText : String, accountTableText : String, filter : String, overdueAccountFilter: String)
        var commandText = " SELECT  " +selectText
                 + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                 + "\n" + "         drepReserveAccount_vw  reserveAcc,                                                   "
                 + "\n" + "         drepParty_vw           contragent                                                    "
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)                                     "
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1                   --открыт за дату окончания о.п         "
                 + "\n" + "     AND acc.t_outRest != 0                            -- имеет ненулевой остаток за дату окончания о.п                "
                 + "\n" + "     AND acc.t_chapter = 1                                                                    "
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                 "
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account)      "
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((acc.t_qualityCategory,                                                      "
                 + "\n" + "                  acc.t_account,                                                              "
                 + "\n" + "                  acc.t_contragentId,                                                         "
                 + "\n" + "                  reserveAcc.t_reserveAccount,                                                "
                 + "\n" + "                  contragent.t_isBank,                                                        "
                 + "\n" + "                  contragent.t_isPhisical,                                                    "
                 + "\n" + "                  contragent.t_isEmployer,                                                    "
                 + "\n" + "                  acc.t_overdueTerm                                                           "
                 + "\n" + "                 ))                                                                           "
                 + "\n" + "ORDER BY GROUPING (acc.t_qualityCategory) DESC,                                               "
                 + "\n" + "         acc.t_qualityCategory,                                                               "
                 + "\n" + "         acc.t_overdueTerm,                                                                   "
                 + "\n" + "         acc.t_account                                                                        ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    private macro columns4_8(overdueRequirements : Bool)
        if (overdueRequirements)
             return   "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_4, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_5, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_6, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_7, "
             + "\n" + "         SUM ( CASE WHEN  acc.t_qualityCategory = 5             THEN acc.t_outCoverRest                       "
             + "\n" + "                    WHEN  acc.t_qualityCategory IN (1, 2, 3, 4) THEN acc.t_overdueRequirements"
             + "\n" + "                                                                ELSE 0                        "
             + "\n" + "               END                                                                            "
             + "\n" + "             ) column_8,                          -- остаток графы 8 + просрочка граф 4,5,6,7 "
        else
            return    "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest, 0)) column_4,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest, 0)) column_5,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest, 0)) column_6,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest, 0)) column_7,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, acc.t_outCoverRest, 0)) column_8,                  ";
        end;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк, кроме 1.7, 2.6, 3.5пр, 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
    */
    macro getBasicRequirementsData(filter : String, overdueAccountFilter : String)
        var selectText;
        var accountTableText;
        selectText =      "         acc.t_qualityCategory             qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                     "
                 +                  columns4_8(false)
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 1 and 30                                      "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 31 and 90                                     "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 91 and 180                                    "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm >= 181                                                "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_enddateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_enddateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_enddateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_enddateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveacc.t_reserveAccount, ' ') reserveAccount,                               "
                 + "\n" + "         acc.t_overdueTerm overdueTerm                                                        ";

        accountTableText =" select acc.*,                                                                                "
                 + "\n" +          overdueTerm(false)+" t_overdueTerm                                                    "
                 + "\n" + "          from drepAccount_vw acc                                                             ";

        return getData(selectText, accountTableText, filter, overdueAccountFilter);
    end;


    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк 1.7, 2.6, 3.5пр, 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
    */
    macro getOtherRequirementsData(filter : String, overdueAccountFilter: String, overdueRequirements : Bool)

        var selectText;
        var accountTableText;

        defaultParm(overdueRequirements, true);

        selectText =      "         acc.t_qualityCategory  qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                     "
                 +                  columns4_8(overdueRequirements)
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 1 and 30                                      "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 31 and 90                                     "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 91 and 180                                    "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm >= 181                                                "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_endDateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_endDateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_endDateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_endDateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveAcc.t_reserveAccount, ' ') reserveAccount,                               "
                 + "\n" + "         acc.t_overdueTerm overdueTerm                                                        ";

        accountTableText =" SELECT acc.*,                                                                                "
                 + "\n" +          overdueTerm()                   + " t_overdueTerm,                                    "
                 + "\n" +          commissionOverdueRequirements() + " t_commisOverdueRequirements,                      "
                 + "\n" + "        NVL(rep_note.readAccountOverdueRequirements(acc.t_chapter,                            "
                 + "\n" + "                                                    acc.t_account,                            "
                 + "\n" + "                                                    acc.t_fiId,                               "
                 + "\n" + "                                                    rep_data.getEndDate()),                   "
                 + "\n" + "            0)                                                          t_overdueRequirements "
                 + "\n" + " FROM drepAccount_vw acc                                                                      ";

        return getData(selectText, accountTableText, filter, overdueAccountFilter);
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * @param     filter                 общий фильтр на выборку
     * @param     overdueAccountFilter   фильтр для счетов просроченной задолжности
     *
     */
    private macro getReferenceValueData(selectText : String, accountTableText : String, filter : String)

        var commandText = " SELECT  " +selectText
                 + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                 + "\n" + "         drepReserveAccount_vw reserveAcc,                                                    "
                 + "\n" + "         drepParty_vw           contragent                                                    "
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)                                   "
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1                   --открыт за дату окончания о.п         "
                 + "\n" + "     AND acc.t_outRest != 0                            -- имеет ненулевой остаток за дату окончания о.п                "
                 + "\n" + "     AND acc.t_chapter = 1                                                                    "
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                 "
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account)      "
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((acc.t_qualityCategory,                                                      "
                 + "\n" + "                  acc.t_account,                                                              "
                 + "\n" + "                  acc.t_contragentId,                                                         "
                 + "\n" + "                  reserveacc.t_reserveAccount,                                                "
                 + "\n" + "                  contragent.t_isBank,                                                        "
                 + "\n" + "                  contragent.t_isPhisical,                                                    "
                 + "\n" + "                  contragent.t_isEmployer,                                                    "
                 + "\n" + "                  acc.t_overdueTerm                                                           "
                 + "\n" + "                 ))                                                                           "
                 + "\n" + "ORDER BY GROUPING (acc.t_qualityCategory) DESC,                                               "
                 + "\n" + "         acc.t_qualityCategory,                                                               "
                 + "\n" + "         acc.t_overdueTerm,                                                                   "
                 + "\n" + "         acc.t_account                                                                        ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printReferenceValueProtocol(data, hasData);

        data.moveFirst();

        return data.sum;
     end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строки 3.1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * getReferenceValueData
    */
    macro  getCalcReserveData(filter : String)
        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualitycategory,                                  "
                 + "\n" + "         acc.t_account                     account,                                          "
                 + "\n" + "         (" + typeAccountContragent() + ") typeaccountcontragent,                            "
                 + "\n" + "         SUM (acc.t_outrest)                                       column_3,                 "
                 + "\n" + "         '-' column_4,                                                                       "
                 + "\n" + "         '-' column_5,                                                                       "
                 + "\n" + "         '-' column_6,                                                                       "
                 + "\n" + "         '-' column_7,                                                                       "
                 + "\n" + "         '-' column_8,                                                                       "
                 + "\n" + "         '-' column_9,                                                                       "
                 + "\n" + "         '-' column_10,                                                                      "
                 + "\n" + "         '-' column_11,                                                                      "
                 + "\n" + "         '-' column_12,                                                                      "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) sum,                                      "
                 + "\n" + "         '-' column_14,                                                                      "
                 + "\n" + "         '-' column_15,                                                                      "
                 + "\n" + "         '-' column_16,                                                                      "
                 + "\n" + "         '-' column_17,                                                                      "
                 + "\n" + "         '-' column_18,                                                                      "
                 + "\n" + "         '-' column_19,                                                                      "
                 + "\n" + "         '-' reserveAccount,                                                                 "
                 + "\n" + "         '-' overdueTerm                                                                     ";

        accountTableText =" select acc.*,                                                                               "
                 + "\n" + "               (rep_data.getEndDate()-acc.t_openDate) t_overdueTerm                          "
                 + "\n" + "          from drepaccount_vw acc                                                            ";

        return getReferenceValueData(selectText, accountTableText, filter);
    end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строки 3.1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * getReferenceValueData
    */
    macro  getCalcReserveSecData(filter : String)
        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualitycategory,                                  "
                 + "\n" + "         acc.t_account                     account,                                          "
                 + "\n" + "         (" + typeAccountContragent() + ") typeaccountcontragent,                            "
                 + "\n" + "         SUM (acc.t_outrest)                                       column_3,                 "
                 + "\n" + "         '-' column_4,                                                                       "
                 + "\n" + "         '-' column_5,                                                                       "
                 + "\n" + "         '-' column_6,                                                                       "
                 + "\n" + "         '-' column_7,                                                                       "
                 + "\n" + "         '-' column_8,                                                                       "
                 + "\n" + "         '-' column_9,                                                                       "
                 + "\n" + "         '-' column_10,                                                                      "
                 + "\n" + "         '-' column_11,                                                                      "
                 + "\n" + "         '-' column_12,                                                                      "
                 + "\n" + "         '-' column_13,                                                                      "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) sum,                                      "
                 + "\n" + "         '-' column_15,                                                                      "
                 + "\n" + "         '-' column_16,                                                                      "
                 + "\n" + "         '-' column_17,                                                                      "
                 + "\n" + "         '-' column_18,                                                                      "
                 + "\n" + "         '-' column_19,                                                                      "
                 + "\n" + "         '-' reserveaccount,                                                                 "
                 + "\n" + "         '-' overdueTerm                                                                     ";

        accountTableText =" select acc.*,                                                                               "
                 + "\n" + "               (rep_data.getEndDate()-acc.t_openDate) t_overdueTerm                          "
                 + "\n" + "          from drepaccount_vw acc                                                            ";

        return getReferenceValueData(selectText, accountTableText, filter);
    end;
end;

/**
 * Источник данных по договорам Loans.
 *
 */
class (TLoansDataSource) TLoansCreditDataSource(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(filter,   TLoansCreditDataSourceFilter());
    defaultParm(protocol, TLoansCreditProtocol());
    initTLoansDataSource(filter, protocol);

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df115credit_tmp");
        sql_execute("TRUNCATE TABLE df115register_tmp");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()
        var register;

        if (global.parameters.getRegistry().getOldDebtAllowances().getValue())
           /* register = rcbGetObject("RcbRegister115_2");*/
            register = " SELECT t_trancheKind, "
                       "        t_trancheNumber, "
                       "        t_type, "
                       "        (SELECT MAX (t_credoperdate)    "
                       "           FROM (SELECT chreg.*, "
                       "                        SUM (chreg.t_prihod)  "
                       "                        OVER (PARTITION BY chreg.t_objectid, chreg.t_objectnumber, chreg.t_regid  "
                       "                        ORDER BY chreg.t_credoperdate DESC) "
                       "                        t_sum "
                       "                   FROM $(obj:RsLns_ChangeRegSum) chreg "
                       "                  WHERE t_credoperdate <= "+rcbApplication().currentReport.context.period.endDate+") chreg "
                       "          WHERE chreg.t_objectid     = register.t_objectid "
                       "            AND chreg.t_objectnumber = register.t_objectnumber "
                       "            AND chreg.t_regid        = register.t_typereg "
                       "            AND register.t_regrest <= chreg.t_sum) t_date, "
                       "        t_fiId, "
                       "        t_rest, "
                       "        t_roubleRest "
                       "   FROM $(obj:RcbRegistryHistory) register "
                       "  WHERE t_date = (SELECT MAX (r.t_date) "
                       "                    FROM $(obj:RcbRegistryHistory) r"
                       "                   WHERE r.t_trancheKind   = register.t_trancheKind "
                       "                     AND r.t_trancheNumber = register.t_trancheNumber "
                       "                     AND r.t_type          = register.t_type "
                       "                     AND r.t_date         <= "+rcbApplication().currentReport.context.period.endDate+")";
        else
            register = "repLnsRegister_vw";
        end;

/*        register.setSqlFilter("$(isTrancheOpenedAtEndDate) = 1 AND $(roubleRest) <> 0");*/

        sql_execute("INSERT INTO df115register_tmp (t_overdueTerm,  "
           + "\n" + "                               t_creditId,     "
           + "\n" + "                               t_restDate,     "
           + "\n" + "                               t_rest,         "
           + "\n" + "                               t_type)         "
           + "\n" + "SELECT DISTINCT                                "
           + "\n" + "       " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " - reg.t_date, "
           + "\n" + "       tranch.t_contractId,                    "
           + "\n" + "       reg.t_date,                             "
           + "\n" + "       reg.t_roubleRest,                       "
           + "\n" + "       reg.t_type                              "
           + "\n" + "  FROM repLnsRegister_vw reg,                  "
           + "\n" + "       repLnsTranches_vw tranch                "
           + "\n" + " WHERE tranch.t_kind    =  reg.t_trancheKind   "
           + "\n" + "   AND tranch.t_number  =  reg.t_trancheNumber "
           + "\n" + "   AND reg.t_roubleRest <> 0                   "
           + "\n" + "   AND tranch.t_isOpenedAtEndDate = 1 ");

        var querySource =   "SELECT t_id   AS a_creditNumber,   "
                   + "\n" + "       t_type AS a_type            "
                   + "\n" + "  FROM repLnsContract_vw           "
                   + "\n" + " WHERE (    t_briefCaseId = 0      "
                   + "\n" + "        AND t_isOpeneDatEndDate = 1"
                   + "\n" + "        AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId")
                   + "\n" + "       ) ";
        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);
        command.execute();

        sql_execute("INSERT INTO df115credit_tmp (t_id,                         t_number,                      "
           + "\n" + "                             t_kksRiseDate,                t_isHigherKks,                 "
           + "\n" + "                             t_aim,                        t_riskGroup,                   "
           + "\n" + "                             t_type,                       t_clientType,                  "
           + "\n" + "                             t_contragentId,               t_rvpsReservePercent,          "
           + "\n" + "                             t_rvpsAmount,                 t_delayedRvpsAmount,           "
           + "\n" + "                             t_calcRvpsAmount,             t_percRvpAmount,               "
           + "\n" + "                             t_expPercRvpAmount,           t_delayedCalculatedRvpsAmount, "
           + "\n" + "                             t_commissionRvpAmount,        t_issueType,                   "
           + "\n" + "                             t_mortgageRegDate,                                           "
           + "\n" + "                             t_rightsOfClaimContractId)                                   "
           + "\n" + "SELECT contract.t_id,                         t_number,                      "
           + "\n" + "       contract.t_qualityCategoryRaisingDate, t_isQualityCategoryRaising,    "
           + "\n" + "       contract.t_aim,                        t_rvpsQualityCategory,         "
           + "\n" + "       contract.t_type,                       t_clientType,                  "
           + "\n" + "       contract.t_contragentId,               t_rvpsReservePercent,          "
           + "\n" + "       reserve.t_rvpsSum,                     t_delayedRvpsSum,              "
           + "\n" + "       reserve.t_calcRvpsSum,                 t_percentRvpSum,               "
           + "\n" + "       reserve.t_delayedPercentRvpSum,        t_calcDelayedRvpsSum,          "
           + "\n" + "       reserve.t_commissionRvpSum,            t_issueType,                   "
           + "\n" + "       t_mortgageRegDate,                                                    "
           + "\n" + "       contract.t_rightsOfClaimContractId                                    "
           + "\n" + "  FROM repLnsContract_vw contract,                                           "
           + "\n" + "       repLnsReserve_vw  reserve                                             "
           + "\n" + " WHERE contract.t_id   = reserve.t_objectNumber                              "
           + "\n" + "   AND contract.t_type = reserve.t_objectTypeid                              ");

        sql_execute(" INSERT INTO drcbBackOfficeAccount_tmp (t_backOfficeId,                             "
           + "\n" + "                                        t_chapter,                                  "
           + "\n" + "                                        t_creditId,                                 "
           + "\n" + "                                        t_fiId,                                     "
           + "\n" + "                                        t_cbAccountNumber)                          "
           + "\n" + " SELECT " + BoLoans + ",                                                            "
           + "\n" + "        t_chapter,                                                                  "
           + "\n" + "        t_contractId,                                                               "
           + "\n" + "        t_fiId,                                                                     "
           + "\n" + "        t_cbAccount                                                                 "
           + "\n" + "   FROM replnsAccount_vw lnsAccount                                                 "
           + "\n" + "  WHERE (EXISTS(SELECT 1 FROM df115credit_tmp WHERE t_id = lnsAccount.t_contractId))");
    end;

    macro getTableRegisters(takeRegistryValue : BOOL)
        if (takeRegistryValue and (not global.parameters.getRegistry().getIncludeOffBalance().getValue()))
          return          "(SELECT                                                                                                    "
                 + "\n" + "     CASE WHEN LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)        "
                 + "\n" + "               LIKE to_char(regName.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  to_char(regName.t_name) ||                                                                 "
                 + "\n" + "                ' - '||LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)"
                 + "\n" + "          ELSE  to_char(regname.t_name)                                                                    "
                 + "\n" + "      END    t_name,                                                                                       "
                 + "\n" + "      CASE WHEN LEAD(regname.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)       "
                 + "\n" + "               LIKE to_char(regname.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  register.t_rest                                                                            "
                 + "\n" + "               - LEAD(register.t_rest) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)     "
                 + "\n" + "          ELSE  register.t_rest                                                                            "
                 + "\n" + "      END      t_rest,                                                                                     "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm,                                                                                       "
                 + "\n" + "      0 t_overdueTermMax                                                                                   "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
       else
          return          "(SELECT                                                                                                    "
                 + "\n" + "      t_name,                                                                                              "
                 + "\n" + "      t_rest,                                                                                              "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm,                                                                                       "
                 + "\n" + "      0 t_overdueTermMax                                                                                   "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
        end;
    end;


    private macro calcReserveSelectText()

        var rvpsAmount = "t_calculatedRvpsAmount";

        return            " CASE                                                                        "
                 + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 1  "
                 + "\n" + "        THEN SUM( GROUPING (REGISTER.t_type) * "+rvpsAmount+") OVER ()       "
                 + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 0  "
                 + "\n" + "        THEN " + rvpsAmount
                 + "\n" + "     ELSE 0                                                                  "
                 + "\n" + " END                                                                         ";
    end;


    private macro reserveSelectText(riskGroup : Integer)

        var rvpAmount = ternary(riskGroup == 0,
                                "t_rvpAmount",
                                "DECODE (credit.t_riskGroup,"+riskGroup+", t_rvpAmount,0)");

        return            " CASE                                                                        "
                 + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 1  "
                 + "\n" + "        THEN SUM( GROUPING (REGISTER.t_type) * "+rvpAmount+") OVER ()        "
                 + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 0  "
                 + "\n" + "        THEN " + rvpAmount
                 + "\n" + "     ELSE 0                                                                  "
                 + "\n" + " END                                                                         ";
    end;

    private macro overdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter)
        var overdueTermFilter;
        if (overdueTermEnd == null)
           overdueTermFilter = "register.t_overdueTerm <= " + overdueTermBegin;
        elif (overdueTermBegin == null)
           overdueTermFilter = "register.t_overdueTerm >= " + overdueTermEnd;
        else
           overdueTermFilter = "register.t_overdueTerm between "+ overdueTermBegin+" and " + overdueTermEnd;
        end;
        return            " SUM (CASE                                                                   "
                 + "\n" + "      WHEN " + overdueFilter + " and " + overdueTermFilter
                 + "\n" + "      THEN register.t_rest                                                   "
                 + "\n" + "      ELSE 0                                                                 "
                 + "\n" + "      END)                                                                   ";
    end;

    private macro percentOverdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter)
        return overdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter);
    end;

    private macro getData(selectText : String)
        selectText = selectText
                 + "\n" + " GROUP BY ROLLUP ((credit.t_number,                                             "
                 + "\n" + "                   register.t_creditId,                                      "
                 + "\n" + "                   credit.t_riskGroup,                                       "
                 + "\n" + "                   credit.t_clientType,                                      "
                 + "\n" + "                   credit.t_type,                                            "
                 + "\n" + "                   t_rvpAmount,                                              "
                 + "\n" + "                   credit.t_rvpsreservepercent ,                             "
                 + "\n" + "                   credit.t_calculatedrvpsamount),                           "
                 + "\n" + "                  (register.t_type,                                          "
                 + "\n" + "                   register.t_name,                                            "
                 + "\n" + "                   credit.t_rvpsAmount,                                      "
                 + "\n" + "                   credit.t_delayedRvpsAmount,                               "
                 + "\n" + "                   register.t_overdueTermMax)                                 "
                 + "\n" + "                  )                                                           "
                 + "\n" + " ORDER BY GROUPING (credit.t_number) DESC,                                   "
                 + "\n" + "                    credit.t_riskGroup,                                      "
                 + "\n" + "                    credit.t_number,                                         "
                 + "\n" + "                    GROUPING (register.t_type),                              "
                 + "\n" + "                    overdueTerm,                                             "
                 + "\n" + "                    creditNumber                                             ";

        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для строк 2.7, 3.6.
     * @param     selectText       текст выборки
     * @qualityCategoryFilter      фильтр для 4-8 графы
     * @overdueFilter              фильтр для граф по просрочке(9-12)
      */
    macro getPercentRequirementsData(filter : String, qualityCategoryFilter : String, overdueFilter : String)

        var creditTable = "(SELECT c.*,                                                                            "
                 + "\n" + "        c.t_percRvpAmount + c.t_expPercRvpAmount + c.t_commissionRvpAmount t_rvpAmount, "
                 + "\n" + "        0                                       t_calculatedrvpsamount                    "
                 + "\n" + "            FROM df115credit_tmp c )                                                    ";

        var commandText = " SELECT  SUM (register.t_rest) column_3,                                            "
                 + "\n" + "         register.t_type  registerType,                                             "
                 + "\n" + "         register.t_name   registerKind,                                            "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 1      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_4,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 2      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_5,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 3      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_6,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 4      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_7,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 5      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_8,                                                        "
                 + "\n" + "         "+percentOverdueSelectText( 1,    30, overdueFilter, qualityCategoryFilter)+" column_9, "
                 + "\n" + "         "+percentOverdueSelectText(31,    90, overdueFilter, qualityCategoryFilter)+" column_10,"
                 + "\n" + "         "+percentOverdueSelectText(91,   180, overdueFilter, qualityCategoryFilter)+" column_11,"
                 + "\n" + "         "+percentOverdueSelectText(null, 181, overdueFilter, qualityCategoryFilter)+" column_12,"
                 + "\n" + "         '-'   column_13,                                                           "
                 + "\n" + "         '-'   column_14,                                                           "
                 + "\n" + "         "+reserveSelectText(0)+" column_15,                                        "
                 + "\n" + "         "+reserveSelectText(2)+" column_16,                                        "
                 + "\n" + "         "+reserveSelectText(3)+" column_17,                                        "
                 + "\n" + "         "+reserveSelectText(4)+" column_18,                                        "
                 + "\n" + "         "+reserveSelectText(5)+" column_19,                                        "
                 + "\n" + "         credit.t_number creditNumber,                                              "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, 'Овердрафт', 21, 'Договор гарантии')  creditType,   "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')  clientType,                 "
                 + "\n" + "         CASE                                                                       "
                 + "\n" + "              WHEN " + overdueFilter
                 + "\n" + "              THEN MAX(register.t_overdueTerm)                                      "
                 + "\n" + "              ELSE 0                                                                "
                 + "\n" + "         END  overdueTerm,                                                          "
                 + "\n" + "         register.t_overdueTermMax overdueTermMax                                   "
                 + "\n" + "FROM     " + creditTable   + " credit,                                              "
                 + "\n" + "         " + getTableRegisters(true, overdueFilter) + " register                    "
                 + "\n" + "   WHERE credit.t_id = register.t_creditId AND credit.t_caseId is null              "
                 + "\n" + "       " + filter
                 + "\n" + "     AND (" + qualityCategoryFilter + " OR " + overdueFilter + ")";

        return getData(commandText);
    end;


    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк, кроме 2.7, 3.6.
     * @param     selectText             текст выборки
     */
    macro getBasicRequirementsData(filter : String, qualityCategoryFilter : String, overdueFilter : String)

        var creditTable = "(SELECT c.*,                                                     "
                 + "\n" + "        c.t_rvpsamount + c.t_delayedrvpsamount               t_rvpAmount,          "
                 + "\n" + "        c.t_calcRvpsAmount + c.t_delayedCalculatedRvpsAmount t_calculatedRvpsAmount"
                 + "\n" + "            FROM df115credit_tmp c )                             ";

        var commandText = " SELECT  SUM (register.t_rest)    column_3,                                         "
                 + "\n" + "         register.t_type          registerType,                                     "
                 + "\n" + "         register.t_name          registerKind,                                     "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 1      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_4,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 2      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_5,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 3      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_6,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 4      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_7,                                                        "
                 + "\n" + "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + qualityCategoryFilter + " and credit.t_riskGroup = 5      "
                 + "\n" + "                    THEN register.t_rest                                            "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END) column_8,                                                        "
                 + "\n" + "         "+overdueSelectText( 1,    30, overdueFilter, qualityCategoryFilter)+" column_9, "
                 + "\n" + "         "+overdueSelectText(31,    90, overdueFilter, qualityCategoryFilter)+" column_10,"
                 + "\n" + "         "+overdueSelectText(91,   180, overdueFilter, qualityCategoryFilter)+" column_11,"
                 + "\n" + "         "+overdueSelectText(null, 181, overdueFilter, qualityCategoryFilter)+" column_12,"
                 + "\n" + "         sum(round(credit.t_rvpsreservepercent * (case when "+qualityCategoryFilter+" then REGISTER.t_rest else 0 end)/100, 2))  column_13,"
                 + "\n" + "         "+calcReserveSelectText()+" column_14,                                     "
                 + "\n" + "         "+reserveSelectText(0)+" column_15,                                        "
                 + "\n" + "         "+reserveSelectText(2)+" column_16,                                        "
                 + "\n" + "         "+reserveSelectText(3)+" column_17,                                        "
                 + "\n" + "         "+reserveSelectText(4)+" column_18,                                        "
                 + "\n" + "         "+reserveSelectText(5)+" column_19,                                        "
                 + "\n" + "         credit.t_number creditNumber,                                              "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, 'Овердрафт', 21, 'Договор гарантии')  creditType,     "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')  clientType,                 "
                 + "\n" + "         case                                                                       "
                 + "\n" + "              when " + overdueFilter
                 + "\n" + "              then max(register.t_overdueTerm)                                      "
                 + "\n" + "              else 0                                                                "
                 + "\n" + "         end  overdueTerm,                                                          "
                 + "\n" + "         register.t_overdueTermMax overdueTermMax                                   "
                 + "\n" + "FROM     " + creditTable   + " credit,                                              "
                 + "\n" + "         " + getTableRegisters(false, overdueFilter) + " register                                             "
                 + "\n" + "   WHERE credit.t_id = register.t_creditId AND credit.t_caseId is null              "
                 + "\n" + "       " + filter
                 + "\n" + "     AND (" + qualityCategoryFilter + " OR " + overdueFilter + ")";

        return getData(commandText);
    end;


    private macro getReferenceValueData(selectText : String)
        selectText = selectText
                 + "\n" + "                 GROUP BY ROLLUP ((credit.t_number,                                 "
                 + "\n" + "                  credit.t_clientType,                                              "
                 + "\n" + "                  credit.t_type,                                                    "
                 + "\n" + "                  credit.t_calculatedrvpsamount,                                    "
                 + "\n" + "                  credit.t_rvpsreservepercent),                                     "
                 + "\n" + "                  (REGISTER.t_type, regName.t_name)                                 "
                 + "\n" + "                 )                                                                  "
                 + "\n" + "  ORDER BY GROUPING (credit.t_number) DESC,                                         "
                 + "\n" + "                     credit.t_number,                                               "
                 + "\n" + "                     GROUPING (register.t_type),                                    "
                 + "\n" + "                     overdueTerm,                                                   "
                 + "\n" + "                     creditNumber                                                   ";


        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printReferenceValueProtocol(data, hasData);

        data.moveFirst();

        return data.sum;
    end;


    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строкри 3.1.
     * @param     selectText             текст выборки
     */
    macro getCalcReserveData(filter : String, registerFilter : String)

        var creditTable = "(SELECT c.*,                                                                        "
                 + "\n" + "        0 t_calculatedRvpsAmount                                                    "
                 + "\n" + "   FROM df115credit_tmp c )                                                         ";

        var commandText = " SELECT  SUM (register.t_rest) column_3,                                            "
                 + "\n" + "         register.t_type  registerType,                                             "
                 + "\n" + "         regName.t_name   registerKind,                                             "
                 + "\n" + "         '-'  column_4,                                                             "
                 + "\n" + "         '-'  column_5,                                                             "
                 + "\n" + "         '-'  column_6,                                                             "
                 + "\n" + "         '-'  column_7,                                                             "
                 + "\n" + "         '-'  column_8,                                                             "
                 + "\n" + "         '-'  column_9,                                                             "
                 + "\n" + "         '-'  column_10,                                                            "
                 + "\n" + "         '-'  column_11,                                                            "
                 + "\n" + "         '-'  column_12,                                                            "
                 + "\n" + "         sum(round(credit.t_rvpsReservePercent * register.t_rest/100, 2)) column_13,"
                 + "\n" + "         sum(round(credit.t_rvpsReservePercent * register.t_rest/100, 2)) sum,      "
                 + "\n" + "         '-'  column_14,                                                            "
                 + "\n" + "         '-'  column_15,                                                            "
                 + "\n" + "         '-'  column_16,                                                            "
                 + "\n" + "         '-'  column_17,                                                            "
                 + "\n" + "         '-'  column_18,                                                            "
                 + "\n" + "         '-'  column_19,                                                            "
                 + "\n" + "         credit.t_number creditNumber,                                              "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, '')  creditType,                 "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')  clientType,                 "
                 + "\n" + "         '-'  overdueTerm                                                           "
                 + "\n" + "FROM     "+creditTable+"   credit,                                                  "
                 + "\n" + "         df115register_tmp register,                                                "
                 + "\n" + "         dspr_reg_dbt      regName                                                  "
                 + "\n" + "   WHERE credit.t_id = register.t_creditId AND credit.t_caseId is null              "
                 + "\n" + "     AND regName.t_regid = register.t_type                                          "
                 + "\n" + "       " + filter + " AND " + registerFilter;

        return getReferenceValueData(commandText);
    end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строкри 3.2.
     * @param     selectText             текст выборки
     */
    macro getCalcReserveSecData(filter : String, registerFilter : String)

        var creditTable = "(SELECT c.*,                                                                        "
                 + "\n" + "        c.t_calcRvpsAmount + c.t_delayedCalculatedRvpsAmount t_calculatedRvpsAmount "
                 + "\n" + "            FROM df115credit_tmp c )                                                ";


        var commandText = " SELECT  SUM (register.t_rest) column_3,                                            "
                 + "\n" + "         register.t_type  registerType,                                             "
                 + "\n" + "         regName.t_name   registerKind,                                             "
                 + "\n" + "         '-'  column_4,                                                             "
                 + "\n" + "         '-'  column_5,                                                             "
                 + "\n" + "         '-'  column_6,                                                             "
                 + "\n" + "         '-'  column_7,                                                             "
                 + "\n" + "         '-'  column_8,                                                             "
                 + "\n" + "         '-'  column_9,                                                             "
                 + "\n" + "         '-'  column_10,                                                            "
                 + "\n" + "         '-'  column_11,                                                            "
                 + "\n" + "         '-'  column_12,                                                            "
                 + "\n" + "         '-'  column_13,                                                            "
                 + "\n" + "         "+calcReserveSelectText()+"   column_14,                                   "
                 + "\n" + "         "+calcReserveSelectText()+"   sum,                                         "
                 + "\n" + "         '-'  column_15,                                                            "
                 + "\n" + "         '-'  column_16,                                                            "
                 + "\n" + "         '-'  column_17,                                                            "
                 + "\n" + "         '-'  column_18,                                                            "
                 + "\n" + "         '-'  column_19,                                                            "
                 + "\n" + "         credit.t_number creditNumber,                                              "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, 'Овердрафт', 21, 'Договор гарантии')  creditType,                 "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')  clientType,                 "
                 + "\n" + "         '-'  overdueTerm                                                           "
                 + "\n" + "FROM     "+creditTable+"   credit,                                                  "
                 + "\n" + "         df115register_tmp register,                                                "
                 + "\n" + "         dspr_reg_dbt      regName                                                  "
                 + "\n" + "   WHERE credit.t_id = register.t_creditid AND credit.t_caseId is null              "
                 + "\n" + "     AND regName.t_regid = register.t_type                                          "
                 + "\n" + "       " + filter + " AND " + registerFilter;
       return getReferenceValueData(commandText);
    end;

/*    constructor();*/
end;



/**
 * Источник данных по портфелям Loans.
 *
 */
class (TLoansDataSource) TLoansCaseDataSource(loansRegisterDataSource, filter)

    private var m_registerDataSource = loansRegisterDataSource;

    initTLoansDataSource(NVL(filter, TLoansCaseDataSourceFilter()), TLoansCaseProtocol());

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df115case_tmp");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()

        sql_execute("       INSERT INTO df115case_tmp (t_overdueTerm,                t_secured, "
                    "                                  t_contractorKind,             t_creditAim, "
                    "                                  t_delayedDebtsReservePercSum, t_delayedDebtsReserveSum, "
                    "                                  t_delayedDebtsRest,           t_demandsRest, "
                    "                                  t_depriciatedDemandsGroup,    t_commissionReserveSum, "
                    "                                  t_id,                         t_number, "
                    "                                  t_reservePercSum,             t_reservePercent, "
                    "                                  t_reserveSum,                 t_qualityCategory, "
                    "                                  t_type) "
                    "                           SELECT CASE "
                                                      + ternary(global.parameters.getRegistry().getConsolidateLoans().getValue(),
                    "                                  WHEN $(depreciatedDemandsGroup) = 0 THEN 30    ",
                    "                                  WHEN $(depreciatedDemandsGroup) = 0 THEN 0     "
                                                           )+
                    "                                  WHEN $(depreciatedDemandsGroup) = 1   THEN 30  "
                    "                                  WHEN $(depreciatedDemandsGroup) = 2   THEN 90  "
                    "                                  WHEN $(depreciatedDemandsGroup) = 3   THEN 180 "
                    "                                  WHEN $(depreciatedDemandsGroup) = 4   THEN 181 END, "
                    "                                  t_securitySum, "
                    "                                  t_contragentkind,               t_creditAim,             "
                    "                                  t_percentDelayedDebtReserveSum, t_delayedDebtReserveSum, "
                    "                                  t_delayedDebtRest,              t_demandsRest,"
                    "                                  t_depreciatedDemandsGroup,      t_commissionReserveSum, "
                    "                                  t_id,                           t_number, "
                    "                                  t_percentReserveSum,            t_reservePercent, "
                    "                                  t_reserveSum,                   t_qualityCategory, "
                    "                                  t_type "
                    "                             FROM repLnsCase_vw case "
                    "                             WHERE t_type = 1 AND (t_demandsRest + t_delayedDebtRest) <> 0  "
                    "                               AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId"));


        sql_execute(" INSERT INTO df115credit_tmp (t_id,                         t_caseId,                           "
                    "                              t_number,                     t_contragentId)                     "
                    "                       SELECT t_id,                         t_briefCaseId,                      "
                    "                              t_number,                     t_contragentId                      "
                    "                         FROM repLnsContract_vw  c                                              "
                    "                        WHERE (    t_briefCaseId <> 0                                           "
                    "                               AND EXISTS (SELECT 1 FROM df115case_tmp case WHERE case.t_id = c.t_briefCaseId) "
                    "                               AND t_isOpeneDatEndDate = 1                                      "
                            /*фильтр по терструктуре не нужен, т.к. работаем по портфелям
                    "                               AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId") +*/
                    "                              ) ");
    end;

    private macro getData(column3SelectText : String, column4SelectText : String, filter : String)

        var commandText = " SELECT                                                                "
                 + "\n" + "        case.t_number                                         ,        "
                 + "\n" + "        DECODE(case.t_type, 1, 'Ссуды')                 type,          "
                 + "\n" + "        DECODE(case.t_contractorKind, 1, 'ЮЛ', 2, 'ФЛ') clientType,    "
                 + "\n" + "        SUM(" + column3SelectText + ")                  column_3,      "
                 + "\n" + "        SUM(" + column4SelectText + ")                  column_4       "
                 + "\n" + " FROM  df115case_tmp case                                              "
                 + "\n" + " WHERE 1 = 1 " + filter
                 + "\n" + " GROUP BY ROLLUP ((case.t_number, case.t_type, case.t_contractorKind)) "
                 + "\n" + " ORDER BY GROUPING (case.t_number) DESC,                               "
                 + "\n" + "                    case.t_number                                      ";


        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
     * Получение данных для строки отчета раздела 2.
     * Используется для строк 1.1-1.4
     * @param     filter             фильтр
     */
    macro getRequirementsData(filter : String)
        return getData("case.t_demandsRest + case.t_delayedDebtsRest",
                       "case.t_reserveSum  + case.t_delayedDebtsReserveSum",
                       filter);
    end;

    /**
     * Получение данных для строки отчета раздела 2, 3.
     * Используется для строк 4 и 4.1
     * @param     filter             фильтр
     */
    macro getPercentRequirementsData(filter : String, registerKinds : String)
        var registerKindsFilter;
        if ((registerKinds != "") and (registerKinds != NULL) and (registerKinds != "EMPTY_MASKS"))
            registerKindsFilter = " register.t_type IN (" + registerKinds + ")";
        else
            registerKindsFilter = "(1 = 0)";
        end;

        var column3SelectText =
                           " (select nvl(sum(register.t_rest), 0)                     "
                           " from df115credit_tmp   credit,                           "
                           "      "+m_registerDataSource.getTableRegisters(true)+" register                          "
                           " where credit.t_caseId = case.t_id                        "
                           "   and credit.t_id = register.t_creditId                  "
                           "   and " + registerKindsFilter +
                           " )";
        return getData(column3SelectText,
                       "case.t_reservePercSum  + case.t_delayedDebtsReservePercSum + case.t_commissionReserveSum",
                       filter);
    end;
end;


/**
 * Класс источника данных "Портфели ГК".
 */
class (TCbDataSource) TCbCaseDataSource()
    /**
     * Конструктор базового объекта.
     */
    initTCbDataSource(TCbCaseDataSourceFilters(), TCbCaseProtocol());

    /**
     * Удаление кешированных данных.
     */
    macro clear()
    end;

    /**
     * Кеширование данных.
     */
    macro cacheData()
    end;

    /**
     * Определение вида контрагента счета.
     */
    private macro typeAccountContragent()
        return            " CASE                                                             "
                 + "\n" + " WHEN contragent.t_isBank = 1                                     "
                 + "\n" + "    THEN 'КО'                                                     "
                 + "\n" + " WHEN contragent.t_isPhisical = 1 and contragent.t_isEmployer = 0 "
                 + "\n" + "    THEN 'ФЛ'                                                     "
                 + "\n" + "    ELSE 'ЮЛ'                                                     "
                 + "\n" + "END                                                               ";
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     filter                 общий фильтр на выборку
     */
    private macro getData(selectText : String, filter : String)

       var commandText =  selectText
                 + "\n" + "  FROM drepCase_vw case,                                                     "
                 + "\n" + "       drepSubCase_vw subCase                                                "
                 + "\n" + " WHERE case.t_caseId = subCase.t_caseId                                      "
                 + "\n" +         ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((case.t_caseid,                                             "
                 + "\n" + "                  case.t_name, subCase.t_caseReserveKind),                   "
                 + "\n" + "                 (case.t_endDateReservePercent,                              "
                 + "\n" + "                  subcase.t_reserveAccount,                                  "
                 + "\n" + "                  case.t_outCoverRest,                                       "
                 + "\n" + "                  case.t_clientType)                                         "
                 + "\n" + "                )                                                            "
                 + "\n" + "ORDER BY grouping(case.t_caseid) desc,                                       "
                 + "\n" + "         case.t_caseid,                                                      "
                 + "\n" + "         grouping(case.t_endDateReservePercent)                              ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
     * Получение данных для строки отчета раздела 2.
     * @param     filter                 общий фильтр на выборку
     */
    macro getJuridicalPersonData(filter : String)

        var selectText  = "SELECT case.t_caseId                                           caseNumber,                "
                 + "\n" + "       1                                                       type,                      "
                 + "\n" + "       DECODE (subcase.t_caseReserveKind, 1, 'РВП', 2, 'РВПС') reserveKind,               "
                 + "\n" + "       case.t_clientType                                       clientType,                "
                 + "\n" + "       decode( grouping(subCase.t_reserveAccount), 1, sum(case.t_outCoverRest)) column_3, "
                 + "\n" + "       case.t_endDateReservePercent                            reservePercent,            "
                 + "\n" + "       nvl(subCase.t_reserveAccount, ' ')                      reserveAccount,            "
                 + "\n" + "       sum(subCase.t_reserveAmount)                            column_4                   ";

        return getData(selectText, filter);
    end;

    /**
     * Получение данных для строки отчета раздела 3.
     * @param     filter                 общий фильтр на выборку
     */
    macro getPhysicalPersonData(filter : String)

        var selectText  = "SELECT case.t_caseId                                           caseNumber,                "
                 + "\n" + "       case.t_name                                             name,                      "
                 + "\n" + "       DECODE (subcase.t_casereservekind, 1, 'РВП', 2, 'РВПС') reservekind,               "
                 + "\n" + "       case.t_clientType                                       clientType,                "
                 + "\n" + "       decode( grouping(subcase.t_reserveaccount), 1, sum(case.t_outCoverRest)) column_3, "
                 + "\n" + "       case.t_enddatereservepercent                            reservePercent,            "
                 + "\n" + "       nvl(subcase.t_reserveaccount, ' ')                      reserveaccount,            "
                 + "\n" + "       sum(subcase.t_reserveamount)                            column_4                   ";

        return getData(selectText, filter);
    end;
end;

/**
 * Класс источника данных "Счета процентов ГК".
 */
class (TCbDataSource) TCbInterestAccountDataSource()
    /**
     * Конструктор базового объекта.
     */
    initTCbDataSource(TCbInterestAccountDataSourceFilters(), TCbInterestAccountProtocol());

    /**
     * Определение вида контрагента счета.
     */
    private macro typeAccountContragent()
        return            " CASE                                                             "
                 + "\n" + " WHEN contragent.t_isBank = 1                                     "
                 + "\n" + "    THEN 'КО'                                                     "
                 + "\n" + " WHEN contragent.t_isPhisical = 1 and contragent.t_isEmployer = 0 "
                 + "\n" + "    THEN 'ФЛ'                                                     "
                 + "\n" + " WHEN contragent.t_isEmployer = 1                                 "
                 + "\n" + "    THEN 'П'                                                      "
                 + "\n" + "    ELSE 'ЮЛ'                                                     "
                 + "\n" + "END                                                               ";
    end;

    /**
     * Получение данных для строки отчета 4, 4.1 раздела 2 и 4, 4.1 раздела 3.
     * @param     filter                 общий фильтр на выборку
     */
    macro getData(filter : String)
        var commandText = "SELECT case.t_name||'/'||percentAcc.t_account         t_number,                       "
                 + "\n" + "       SUM(percentAcc.t_outCoverRest)               column_3,                         "
                 + "\n" + "       case.t_clientType                            clientType,                       "
                 + "\n" + "       NVL(reserveAcc.t_reserveAccount, ' ')        reserveAccount,                   "
                 + "\n" + "       SUM(NVL(reserveAcc.t_endDateReserveAmount, 0)) column_4,                       "
                 + "\n" + "       NVL(percentacc.t_accountreservepercent,0)    reservePercent                    "
                 + "\n" + "  FROM drepAccount_vw                 percentAcc, --л/с процентов                     "
                 + "\n" + "       drepAccountPercentAccounts_vw  connectAcc, --привязка л/с процентов            "
                 + "\n" + "       drepReserveAccount_vw          reserveAcc, --счет резерва                      "
                 + "\n" + "       drepCase_vw                         case, --портфель                           "
                 + "\n" + "       drepAccount_vw                       acc  --л/с, принадлежащий портфелю        "
                 + "\n" + " WHERE percentAcc.t_account = connectAcc.t_account                                    "
                 + "\n" + "   AND percentAcc.t_fiid    = connectAcc.t_fiid                                       "
                 + "\n" + "   AND percentAcc.t_chapter = connectAcc.t_chapter                                    "
                 + "\n" + "   AND acc.t_account = connectAcc.t_connectAccount                                    "
                 + "\n" + "   AND acc.t_fiid    = connectAcc.t_connectFiid                                       "
                 + "\n" + "   AND acc.t_chapter = connectAcc.t_connectChapter                                    "
                 + "\n" + "   AND case.t_caseId = acc.t_caseId                                                   "
                 + "\n" + "   AND percentAcc.t_accountId = reserveAcc.t_connectAccountId(+)                      "
                 + "\n" + "   AND (case.t_reserveKind = 2 OR (case.t_reserveKind = 1 AND acc.t_chapter = 1))     "
                        +     filter
                 + "\n" + "GROUP BY ROLLUP ((case.t_name,                                                        "
                 + "\n" + "                  case.t_clientType,                                                  "
                 + "\n" + "                  reserveAcc.t_reserveAccount,                                        "
                 + "\n" + "                  percentAcc.t_account,                                               "
                 + "\n" + "                  percentacc.t_accountreservepercent)                                 "
                 + "\n" + "                )                                                                     "
                 + "\n" + "ORDER BY grouping(case.t_name) desc,                                                  "
                 + "\n" + "         case.t_name                                                                  ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
     * Получение данных для строки отчета 4, 4.1 раздела 2 и 2, 2.1 раздела 3.
     * @param     filter                 общий фильтр на выборку
     */
    macro getCommissionData(filter : String)

        var commandText = "SELECT percentAcc.t_account                         t_number,                "
                 + "\n" + "       SUM(percentAcc.t_outCoverRest)               column_3,                "
                 +                typeAccountContragent() + "                  clientType,              "
                 + "\n" + "       NVL(reserveAcc.t_reserveAccount, ' ')        reserveAccount,          "
                 + "\n" + "       SUM(NVL(reserveAcc.t_endDateReserveAmount, 0)) column_4,              "
                 + "\n" + "       NVL(percentacc.t_accountreservepercent,0)    reservePercent           "
                 + "\n" + "  FROM drepAccount_vw          percentAcc,                                   "
                 + "\n" + "       drepReserveAccount_vw   reserveacc,                                   "
                 + "\n" + "       drepparty_vw            contragent                                    "
                 + "\n" + " WHERE percentAcc.t_accountId = reserveAcc.t_connectAccountId(+)             "
                 + "\n" + "   AND contragent.t_id = percentAcc.t_contragentid                           "
                 +                filter
                 + "\n" + "GROUP BY ROLLUP ((percentAcc.t_account,                                      "
                 + "\n" + "                  contragent.t_isPhisical,                                   "
                 + "\n" + "                  contragent.t_isBank,                                       "
                 + "\n" + "                  contragent.t_isEmployer,                                   "
                 + "\n" + "                  reserveAcc.t_reserveAccount,                               "
                 + "\n" + "                  percentacc.t_accountreservepercent)                        "
                 + "\n" + "                )                                                            "
                 + "\n" + "ORDER BY grouping(percentAcc.t_account) desc,                                "
                 + "\n" + "         percentAcc.t_account                                                ";


        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;
end;

/**
 * Источник данных по траншам Loans.
 *
 */
class (TLoansDataSource) TLoansTrancheDataSource()
    initTLoansDataSource(TLoansTrancheDataSourceFilter(), TLoansTrancheProtocol());

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df115tranche_tmp");
    end;

    private macro getTrancheSqlText()
        private macro registerRestSqlText(registerType, restType)
              return        "    NVL((SELECT reg.t_"+ternary(restType == "in", "in", "")+"Rest "
                 + "\n" + "          FROM repLnsRegister_vw reg                              "
                 + "\n" + "         WHERE reg.t_type       = " + registerType
                 + "\n" + "           AND tranche.t_kind   = reg.t_trancheKind               "
                 + "\n" + "           AND tranche.t_number = reg.t_trancheNumber             "
                 + "\n" + "        ),0)                                                      ";
        end;

        private macro expenseOperationSummaSqlText(registerType, operationKind, currencyId)
              return        "      NVL((SELECT -SUM(hr.t_" + ternary(currencyId == 0, "rouble", "") + "expense)                 "
                 + "\n" + "             FROM REPLNSREGCHANGEHISTORY_VW hr                                                    "
                 + "\n" + "            WHERE tranche.t_kind     = hr.t_trancheKind                                           "
                 + "\n" + "              AND tranche.t_number   = hr.t_trancheNumber                                         "
                 + "\n" + "              AND hr.t_regKind       = " + registerType
                 + "\n" + "              AND hr.t_operationKind = " + operationKind
                 + "\n" + "              AND hr.t_operationDate BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()),  "
                 + "\n" + "          0)                                                                                      ";
        end;

        private macro receiptOperationSummaSqlText(registerType, operationKind, currencyId)
              return        "      NVL((SELECT SUM(hr.t_" + ternary(currencyId == 0, "rouble", "") + "receipt)                 "
                 + "\n" + "             FROM REPLNSREGCHANGEHISTORY_VW hr                                                    "
                 + "\n" + "            WHERE tranche.t_kind     = hr.t_trancheKind                                           "
                 + "\n" + "              AND tranche.t_number   = hr.t_trancheNumber                                         "
                 + "\n" + "              AND hr.t_regKind       = " + registerType
                 + "\n" + "              AND hr.t_operationKind = " + operationKind
                 + "\n" + "              AND hr.t_operationDate BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()),  "
                 + "\n" + "          0)                                                                                      ";
        end;


        return            " SELECT                                                                                           "
                 + "\n" + " contract.t_id                      AS t_id,                                                      "
                 + "\n" + " contract.t_departmentId            AS t_FNCash,                                                  "
                 + "\n" + " contract.t_departmentId            AS t_TerritorialStruct,/*!!!*/                                "
                 + "\n" + " contract.t_aim                     AS t_aim,                                                     "
                 + "\n" + " contract.t_clientType              AS t_creditClientType,                                        "
                 + "\n" + " contract.t_mortgageRegDate         AS t_creditMortgageRegDate,                                   "
                 + "\n" + " contract.t_number                  AS t_creditNumberForReport,                                   "
                 + "\n" + " contract.t_type                    AS t_creditType,                                              "
                 + "\n" + " tranche.t_contractId               AS t_creditId,                                                "
                 + "\n" + " tranche.t_kind                     AS t_kind,                                                    "
                 + "\n" + " tranche.t_number                   AS t_number,                                                  "
                 + "\n" + " tranche.t_fiId                     AS t_currencyId,                                              "
                 + "\n" + " tranche.t_lastIssueDate            AS t_issueDate,                                               "
                 + "\n" + " tranche.t_plannedLastRepaymentDate AS t_repaymentDate,                                           "
                 + "\n" + " (null)                             AS t_repaymentOverdueDebtsOldSumR,                            "
                 + "\n" + registerRestSqlText(1, "in")  + "    AS t_beginDateRegRest,    /*остаток регистра ОД на ДНОП*/                           "
                 + "\n" + registerRestSqlText(1, "out") + "    AS t_endDateRegRest,      /*остаток регистра ОД на ДООП*/                           "
                 + "\n" + registerRestSqlText(2, "in")  + "    AS t_beginDateRegRestPr,  /*остаток регистра Проср. ОД на ДНОП*/                    "
                 + "\n" + registerRestSqlText(2, "out") + "    AS t_endDateRegRestPr,    /*остаток регистра Проср. ОД на ДООП*/                    "
                 + "\n" + expenseOperationSummaSqlText(1,3)  +"AS t_debtsAmountSO3,      /*расход ОД по операции <Погашение>*/                     "
                 + "\n" + expenseOperationSummaSqlText(1,3,0)+"AS t_roubleDebtsAmountSO3,/*расход в рублях ОД по операции <Погашение>*/            "
                 + "\n" + expenseOperationSummaSqlText(1,4)  +"AS t_debtsAmountSO4,      /*расход ОД по операции <Вынесение на просрочку>*/        "
                 + "\n" + expenseOperationSummaSqlText(2,3)  +"AS t_expenseSum,          /*расход Проср. ОД по операции <Погашение>*/              "
                 + "\n" + expenseOperationSummaSqlText(2,42) +"AS t_debtsAmountSO42Pr,   /*расход Проср. ОД по операции <Списание задолжности>*/   "
                 + "\n" + receiptOperationSummaSqlText(2,4)  +"AS t_receiptSum,          /*приход Проср. ОД по операции <Вынесение на просрочку>*/ "
                 + "\n" + "NVL((SELECT SUM(CASE                                                          "
                 + "\n" + "                   WHEN SUM(gr.t_plannedPaySum) = 0 OR SUM(gr.t_plannedPaySum) IS NULL                                                               "
                 + "\n" + "                     THEN 0                                                                "
                 + "\n" + "                   ELSE                                                                "
                 + "\n" + "                     rcb_f115.getTrancheBaseDebtsAmount(tranche.t_number,"
                 + "\n" + "                                                        tranche.t_kind,"
                 + "\n" + "                                                        rep_data.getBeginDate(),"
                 + "\n" + "                                                        rep_data.getEndDate(),"
                 + "\n" + "                                                        gr.t_plannedPayDate,"
                 + "\n" + "                                                        tranche.t_fiId,"
                 + "\n" + "                                                        SUM(gr.t_plannedPaySum))"
                 + "\n" + "                END)"
                 + "\n" + "       FROM repLnsPlanRepaymentSchedule_vw gr                                               "
                 + "\n" + "      WHERE tranche.t_kind   = gr.t_trancheKind                                             "
                 + "\n" + "        AND tranche.t_number = gr.t_trancheNumber                                           "
                 + "\n" + "        AND gr.t_representationSum = 'Абсолютные суммы'                                     "
                 + "\n" + "        AND gr.t_constructionDate <=  rep_data.getEndDate()                                "
                 + "\n" + "        AND gr.t_plannedPayDate >= rep_data.getBeginDate()                                  "
                 + "\n" + "        AND gr.t_plannedPayDate <= rep_data.getEndDate()                                    "
                 + "\n" + "      GROUP BY gr.t_plannedPayDate                                    "
                 + "\n" + "      ), 0)                        AS t_liquidationOfDebtsSumR,"
                 + "\n" + "    (CASE WHEN (INSTR(t_aim, 'Н') <> 0) THEN 1 ELSE 0 END) AS t_isUrgentNeeds, /*цель-неотложные нужды*/ "
                 + "\n" + "    NVL((SELECT COUNT(1)                 "
                 + "\n" + "           FROM REPLNSREGCHANGEHISTORY_VW hr                                                    "
                 + "\n" + "          WHERE tranche.t_kind     = hr.t_trancheKind                                           "
                 + "\n" + "            AND tranche.t_number   = hr.t_trancheNumber                                         "
                 + "\n" + "            AND hr.t_regKind       = 1"
                 + "\n" + "            AND hr.t_operationDate BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()),  "
                 + "\n" + "        0)                          AS t_iChangedRegHist"
                 + "\n" + "FROM repLnsTranches_vw tranche JOIN REPLNSCONTRACT_VW contract                                    "
                 + "\n" + "  ON tranche.t_contractId = contract.t_id                                                         "
                 + "\n" + "WHERE contract.t_clientType = " + RCB_PTLEGF_PERSN
                 + "\n" + "  AND contract.t_type IN ( " + LO_CREDIT + " , " + LO_KARTA + " ) "
                 + "\n" + "  AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId");
    end;

    /**
     *  Кеширование данных.
     */
    macro cacheData()
        var tranche;

        var allowances = global.parameters.getRegistry().getOldDebtAllowances().getValue();

        /**
         * Задолженность, погаш. в ОП по просроченному ОД
         */
        macro repaymentOverdueDebtsOldSumRSqlText()
            if (allowances)
            /*2*/
                return    " NVL(rsb_fiinstr.ConvSum(t_beginDateRegRestPr - t_expenseSum,          "
                 + "\n" + "                             t_currencyId,                                 "
                 + "\n" + "                             0,                                            "
                 + "\n" + "                             rep_data.getEndDate()),                       "
                 + "\n" + "    0)                                                                     ";
            else
            /*1*/
                   return    "    null                                                                   ";
            end;
        end;

        /**
         * Просрочка переведенная по курсу за ДООП
         */
        macro delayedDebtsSumRSqlText()
            if (allowances)
            /*2*/
                return    "  NVL((CASE WHEN ((t_beginDateRegRestPr - t_expenseSum) >= 0)              "
                 + "\n" + "            THEN rsb_fiinstr.ConvSum(t_receiptSum,                     "
                 + "\n" + "                                         t_currencyId,                     "
                 + "\n" + "                                         0,                                "
                 + "\n" + "                                         rep_data.getEndDate())            "
                 + "\n" + "            ELSE rsb_fiinstr.ConvSum(t_beginDateRegRestPr - t_expenseSum + t_receiptSum,"
                 + "\n" + "                                          t_currencyId,                    "
                 + "\n" + "                                          0,                               "
                 + "\n" + "                                          rep_data.getEndDate())           "
                 + "\n" + "       END), 0)                                                            ";
            else
            /*1*/
                   return    "    (NVL((CASE WHEN ((t_receiptSum - t_expenseSum) > 0)                    "
                 + "\n" + "               THEN rsb_fiinstr.ConvSum((t_receiptSum - t_expenseSum), "
                 + "\n" + "                                            t_currencyId,                  "
                 + "\n" + "                                            0,                             "
                 + "\n" + "                                            rep_data.getEndDate())         "
                 + "\n" + "               ELSE 0 END), 0) )                                           ";
            end;
        end;

        sql_execute(" INSERT INTO df115tranche_tmp (t_creditNumber,"
           + "\n" + "                               t_creditType,"
           + "\n" + "                               t_creditAim,"
           + "\n" + "                               t_creditMortgageRegDate,"
           + "\n" + "                               t_currencyId,"
           + "\n" + "                               t_liquidationOfDebtsSumR,"
           + "\n" + "                               t_liquidOfOverdueDebtsSumR,"
           + "\n" + "                               t_notLiquidOfOverdueDebtsSumR,"
           + "\n" + "                               t_overdueDebtsSumR,"
           + "\n" + "                               t_repaymentOverdueDebtsSumR,"
           + "\n" + "                               t_repaymentOverdueDebtsOldSumR,"
           + "\n" + "                               t_delayedDebtsSumR, "
           + "\n" + "                               t_iChangedRegHist) "
           + "\n" + "SELECT                                                                                                           "
           + "\n" + "  t_creditNumberForReport,                                                                                       "
           + "\n" + "  t_creditType,                                                                                                  "
           + "\n" + "  t_aim,                                                                                                         "
           + "\n" + "  t_creditMortgageRegDate,                                                                                       "
           + "\n" + "  t_currencyId,                                                                                                  "
           + "\n" + "/*Объем задолжности, погашенной в отчетном периоде --сумма требований в отчетном периоде  */                     "
           + "\n" + "  t_liquidationOfDebtsSumR,                     "
           + "\n" + "/*Задолженность, погаш. и спис. в ОП по просроченному ОД*/                                                       "
           + "\n" + " (NVL((CASE NVL((CASE WHEN t_debtsAmountSO4 != 0                                                                 "
           + "\n" + "                      THEN (CASE  WHEN t_beginDateRegRestPr = 0                                                  "
           + "\n" + "                                  THEN (CASE WHEN t_endDateRegRestPr = t_debtsAmountSO4 THEN 1 ELSE 2 END)       "
           + "\n" + "                                  ELSE 3                                                                         "
           + "\n" + "                            END)                                                                                 "
           + "\n" + "                      ELSE 0                                                                                     "
           + "\n" + "                 END), 0)/*t_numberAlgorithm*/                                                                   "
           + "\n" + "            WHEN 1 THEN 0                                                                                        "
           + "\n" + "            WHEN 2 THEN t_expenseSum + t_debtsAmountSO42Pr                                                       "
           + "\n" + "            WHEN 3 THEN rcb_f115.getTrancheDebtsAmount_"+ternary(allowances, "2","1")+"_1803(t_id,t_kind,    "
           + "\n" + "                                                                  rep_data.getBeginDate(), rep_data.getEndDate(),"
           + "\n" + "                                                                  t_currencyId,                                  "
           + "\n" + "                                                                  t_debtsAmountSO4,                              "
                                                                                      +ternary(allowances, "t_beginDateRegRestPr,","")
           + "\n" + "                                                                  1)                                             "
           + "\n" + "            ELSE 0                                                                                               "
           + "\n" + "        END), 0) ) AS t_liquidOfOverdueDebtsSumR,           --Объем задолжности погашенной в ОП                  "
           + "\n" + "/*Задолженность, не погаш. в ОП по просроченному ОД*/                                                            "
           + "\n" + " (NVL((CASE NVL((CASE  WHEN t_debtsAmountSO4 != 0                                                                "
           + "\n" + "                       THEN (CASE  WHEN t_beginDateRegRestPr = 0                                                 "
           + "\n" + "                                   THEN (CASE WHEN t_endDateRegRestPr = t_debtsAmountSO4 THEN 1 ELSE 2 END)      "
           + "\n" + "                                   ELSE 3                                                                        "
           + "\n" + "                             END)                                                                                "
           + "\n" + "                       ELSE 0                                                                                    "
           + "\n" + "                 END), 0)/*t_numberAlgorithm*/                                                                   "
           + "\n" + "      WHEN 1 THEN rsb_fiinstr.ConvSum(t_debtsAmountSO4,                                                          "
           + "\n" + "                                          t_currencyId,                                                          "
           + "\n" + "                                          0,                                                                     "
           + "\n" + "                                          rep_data.getEndDate())                                                 "
           + "\n" + "      WHEN 2 THEN rsb_fiinstr.ConvSum(t_debtsAmountSO4 - (NVL((t_expenseSum + t_debtsAmountSO42Pr),0)),          "
           + "\n" + "                                          t_currencyId,                                                          "
           + "\n" + "                                          0,                                                                     "
           + "\n" + "                                          rep_data.getEndDate())                                                 "
           + "\n" + "      WHEN 3 THEN rcb_f115.getTrancheDebtsAmount_"+ternary(allowances, "2","1")+"_1803(t_id, t_kind,         "
           + "\n" + "                                                            rep_data.getBeginDate(), rep_data.getEndDate(),      "
           + "\n" + "                                                            t_currencyId,                                        "
           + "\n" + "                                                            t_debtsAmountSO4,                                    "
                                                                                +ternary(allowances, "t_beginDateRegRestPr,","")
           + "\n" + "                                                            2)                                                   "
           + "\n" + "      ELSE 0                                                                                                     "
           + "\n" + "      END), 0)) AS t_notLiquidOfOverdueDebtsSumR,                                                                "
           + "\n" + "/*Просрочка по просроченному ОД по курсу за ДООП*/                                                               "
           + "\n" + "  (NVL(rsb_fiinstr.ConvSum(t_receiptSum,                                                                         "
           + "\n" + "                               t_currencyId,                                                                     "
           + "\n" + "                               0,                                                                                "
           + "\n" + "                               rep_data.getEndDate()),                                                           "
           + "\n" + "                               0) ) AS t_overdueDebtsSumR,                                                       "
           + "\n" + "/*Погашение (по просроченному ОД по курсу за ДООП)*/                                                             "
           + "\n" + " (NVL(rsb_fiinstr.ConvSum(t_expenseSum,                                                                          "
           + "\n" + "                              t_currencyId,                                                                      "
           + "\n" + "                              0,                                                                                 "
           + "\n" + "                              rep_data.getEndDate()),                                                            "
           + "\n" + "                              0) ) AS t_repaymentOverdueDebtsSumR,                                               "
           + "\n" + "/*Задолженность, погаш. в ОП по просроченному ОД.*/                                                              "
           + "\n" + repaymentOverdueDebtsOldSumRSqlText() + "AS  repaymentOverdueDebtsOldSumR,                                        "
           + "\n" + "/*Просрочка переведенная по курсу за ДООП*/                                                                      "
           + "\n" + delayedDebtsSumRSqlText() + " AS t_delayedDebtsSumR,                                                              "
           + "\n" + "t_iChangedRegHist                                                                                               "
/*           + "\n" + "--номер алгоритма                                                                                              +
           + "\n" + " ,( NVL((CASE  WHEN t_debtsAmountSO4 != 0                                                                        "
           + "\n" + "               THEN (CASE  WHEN t_beginDateRegRestPr = 0                                                         "
           + "\n" + "                           THEN (CASE WHEN t_endDateRegRestPr = t_debtsAmountSO4                                 "
           + "\n" + "                                      THEN 1                                                                     "
           + "\n" + "                                      ELSE 2                                                                     "
           + "\n" + "                                END)                                                                             "
           + "\n" + "                           ELSE 3                                                                                "
           + "\n" + "                      END)                                                                                       "
           + "\n" + "                ELSE 0                                                                                           "
           + "\n" + "          END), 0)                                                                                               "
           + "\n" + "  ) AS t_numberAlgorithm    */
           + "\n" + " FROM ( " + getTrancheSqlText() + ") tr");
    end;


    private macro getData(selectText : String)
        selectText = selectText
                 + "\n" + "GROUP BY ROLLUP ((tr.t_creditNumber,                                       "
                 + "\n" + "                  tr.t_creditType,                                         "
                 + "\n" + "                  tr.t_creditAim,                                          "
                 + "\n" + "                  fi.t_code))                                              "
                 + "\n" + "ORDER BY GROUPING (tr.t_creditNumber) DESC,                                "
                 + "\n" + "         tr.t_creditNumber,                                                "
                 + "\n" + "         fi.t_code                                                         ";

        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();
        var sum     = data.sum;

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        return sum;
    end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строк 1, 1.1, 1.2, 1.3, 1.4.
     * @param     selectText             текст выборки
     */
    macro getDebtsAmountData(filter : String, filter1 : String)
        var commandText = "SELECT tr.t_creditnumber                creditNumber,                      "
                 + "\n" + "       DECODE(tr.t_creditType, 1, 'Кредит', 8, 'Кредит по карте')  creditType,"
                 + "\n" + "       tr.t_creditAim                   creditAim,                         "
                 + "\n" + "       fi.t_code                        currencyCode,                      "
                 + "\n" + " SUM (tr.t_liquidationOfDebtsSumR)      liquidationOfDebtsSumR,            "
                 + "\n" + " SUM (tr.t_liquidOfOverdueDebtsSumR)    liquidOfOverdueDebtsSumR,          "
                 + "\n" + " SUM (tr.t_notLiquidofoverdueDebtsSumR) notLiquidOfOverdueDebtsSumR,       "
/*                 + "\n" + " SUM (tr.t_prolongationsumr)            prolongationSumR,                  "*/
                 + "\n" + " 0                                      overdueDebtsSumR,                  "
                 + "\n" + " 0                                      repaymentOverdueDebtsSumR,         "
                 + "\n" + " 0                                      repaymentOverdueDebtsOldSumR,      "
                 + "\n" + " 0                                      delayedDebtsSumR,                  "
                 + "\n" + " SUM (  tr.t_liquidationOfDebtsSumR                                        "
                 + "\n" + "      + tr.t_liquidOfOverdueDebtsSumR                                      "
                 + "\n" + "      + tr.t_notLiquidOfOverdueDebtsSumR                                   "
/*                 + "\n" + "      + tr.t_prolongationSumR                                              "*/
                 + "\n" + "             )                          sum                                "
                 + "\n" + "    FROM df115tranche_tmp tr JOIN drepFininstrument_vw fi                  "
                 + "\n" + "         ON tr.t_currencyId = fi.t_id                                      "
                 + "\n" + "   WHERE (1 = 1 "+ filter + " ) "
                        + ternary((filter1 == NULL) or (filter1 == ""), "", "OR (1 = 1 " + filter1 + " ) ");

        return getData(commandText);
    end;


    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строк 2, 2.1, 2.2, 2.3, 2.4.
     * @param     filter             текст фильтра
     */
    macro getDelayedDebtsAmountData(filter : String, filter1 : String)
        var commandText = "SELECT   tr.t_creditNumber                       creditNumber,                "
                 + "\n" + "         DECODE(tr.t_creditType, 1, 'Кредит', 8, 'Кредит по карте') creditType,"
                 + "\n" + "         tr.t_creditAim                          creditAim,                   "
                 + "\n" + "         fi.t_code                               currencyCode,                "
                 + "\n" + "         0                                       liquidationOfDebtsSumR,      "
                 + "\n" + "         0                                       liquidOfOverdueDebtsSumR,    "
                 + "\n" + "         0                                       notLiquidOfOverdueDebtsSumR, "
                 + "\n" + "         0                                       prolongationSumR,            "
                 + "\n" + "         SUM (tr.t_overdueDebtsSumR)             overdueDebtsSumR,            "
                 + "\n" + "         SUM (tr.t_repaymentOverdueDebtsSumR)    repaymentOverdueDebtsSumR,   "
                 + "\n" + "         SUM (tr.t_repaymentOverdueDebtsOldSumR) repaymentOverdueDebtsOldSumR,"
                 + "\n" + "         SUM (tr.t_delayedDebtsSumR)             delayedDebtsSumR,            "
                 + "\n" + "         SUM (tr.t_delayeddebtsSumR)             sum                          "
                 + "\n" + "    FROM df115tranche_tmp tr JOIN drepfininstrument_vw fi                     "
                 + "\n" + "         ON tr.t_currencyid = fi.t_id                                         "
                 + "\n" + "   WHERE (1 = 1 "+ filter + " ) "
                        + ternary((filter1 == NULL) or (filter1 == ""), "", "OR (1 = 1 " + filter1 + " ) ");

        return getData(commandText);
    end;
end;


/**
 * Источник данных формы 110 от 2061-У.
 */
class (TDataSource) TDataSource2061()

    /**
     * Источник данных по счетам в ГК.
     */
    private var m_cbAccountsDataSource;

    /**
     * Источник данных по договорам в Loans-е.
     */
    private var m_loansCreditDataSource;

    /**
     * Источник данных по портфелям в Loans-е.
     */
    private var m_loansCaseDataSource;

    /**
     * Источник данных по порфелям в ГК.
     */
    private var m_cbCaseDataSource;

    /**
     * Источик данных по счетам процентов в ГК.
     */
    private var m_cbInterestAccountDataSource;

    /**
     * Источник данных по траншам в Loans-е.
     */
    private var m_loansTrancheDataSource;

    /**
     * Конструктор.
     */
    private macro constructor()
        m_cbAccountsDataSource        = TCbAccountsDataSource();
        m_loansCreditDataSource       = TLoansCreditDataSource();
        m_loansCaseDataSource         = TLoansCaseDataSource(m_loansCreditDataSource);
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;

    macro cacheData(tuneTable)
        m_cbAccountsDataSource.cache(tuneTable);
        m_loansCreditDataSource.cache(tuneTable);
        m_loansCaseDataSource.cache(tuneTable);
        m_cbCaseDataSource.cache(tuneTable);
        m_cbInterestAccountDataSource.cache(tuneTable);
        m_loansTrancheDataSource.cache(tuneTable);
    end;

    /**
     * Источник данных по счетам в ГК.
     */
    macro getCbAccountsDataSource()
        return m_cbAccountsDataSource;
    end;

    /**
     * Источник данных по договорам в Loans-е.
     */
    macro getLoansCreditDataSource()
         return m_loansCreditDataSource;
    end;

    /**
     * Источник данных по портфелям в Loans-е.
     */
    macro getLoansCaseDataSource()
        return m_loansCaseDataSource;
    end;

    /**
     * Источник данных по порфелям в ГК.
     */
    macro getCbCaseDataSource()
        return m_cbCaseDataSource;
    end;

    /**
     * Источик данных по счетам процентов в ГК.
     */
    macro getCbInterestAccountDataSource()
        return m_cbInterestAccountDataSource;
    end;

    /**
     * Источник данных по траншам в Loans.
     */
    macro getLoansTrancheDataSource()
        return m_loansTrancheDataSource;
    end;

    constructor();
end;

class (TCbAccountsDataSource) TCbAccountsDataSource2332(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(protocol, TCbAccountsProtocol2332());
    initTCbAccountsDataSource(filter, protocol);

    /**
     * Сумма прочрочки для 47423*.
     */
    private macro commissionOverdueRequirements(chargeCommission, includeTermInDelayAmount)
        defaultParm(chargeCommission,         global.parameters.getRegistry().getChargeCommission().getValue());
        defaultParm(includeTermInDelayAmount, global.parameters.getRegistry().getIncludeTermInDelayAmount().getValue());
        var overdueRequirements;

        if (chargeCommission and (not includeTermInDelayAmount))
            overdueRequirements = "NVL((case when rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account, rep_data.getEndDate()) > 0         "
                 + "\n" + "                then      rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account, rep_data.getEndDate())             "
                 + "\n" + "                else null end                                                                                              "
                 + "\n" + "               ),                                                                                                          "
                 + "\n" + "               NVL(rep_note.readAccOverdueRequirements115(acc.t_chapter, acc.t_account, acc.t_fiId, rep_data.getEndDate()),      "
                 + "\n" + "                NVL(rep_note.readAccountOverdueRequirements(acc.t_chapter, acc.t_account, acc.t_fiId, rep_data.getEndDate()), "
                 + "\n" + "                    0)                                                                                                  "
                 + "\n" + "               )                                                                                                        "
                 + "\n" + "           )                                                                                                            ";
        else
            overdueRequirements = " acc.t_outCoverRest                                                             ";
        end;

        return overdueRequirements;
    end;


    /**
     * Срок просрочки(Дата)
     */
    private macro overdueTerm(chargeCommission)
        defaultParm(chargeCommission, global.parameters.getRegistry().getChargeCommission().getValue());

        var oldDebtAllowances = global.parameters.getRegistry().getOldDebtAllowances().getValue();
        var overdueDate = "";

        if (chargeCommission)
             return        " CASE                                                                                "
                  + "\n" + " WHEN rep_account.getOverdueSum(acc.t_fiId, acc.t_chapter, acc.t_account,            "
                  + "\n" + "                                rep_data.getEndDate()) > 0                           "
                  + "\n" + " THEN rep_account.getMaxTerm(acc.t_fiId, acc.t_chapter, acc.t_account,               "
                  + "\n" + "                             rep_data.getEndDate())                                  "
                  + "\n" + " ELSE rep_data.getEndDate() - NVL(rep_note.readMaturityDate(acc.t_chapter,           "
                 + "\n" + "                                                            acc.t_account,           "
                 + "\n" + "                                                            acc.t_fiId,              "
                 + "\n" + "                                                            rep_data.getEndDate()),  "
                 + "\n" + "                                  rep_data.getEndDate())                             "
                  + "\n" + " END                                                                                 "
         else
             if (oldDebtAllowances)
             overdueDate = "       CASE                                                                          "
                 + "\n" + "          WHEN acc.t_outcoverRest = 0                                                     "
                 + "\n" + "             THEN rep_data.getEndDate ()                                             "
                 + "\n" + "          ELSE NVL((SELECT MAX (t_date)                                              "
                 + "\n" + "                  FROM (SELECT SUM (doc.t_incoversum) OVER (partition by               "
                 + "\n" + "                                doc.t_debetAccountId                                   "
                 + "\n" + "                                ORDER BY t_date DESC) t_debet_sum,                   "
                 + "\n" + "                               doc.*                                                 "
                 + "\n" + "                          FROM drepDocument_vw doc) doc                              "
                 + "\n" + "                 WHERE doc.t_debetAccountId = acc.t_accountId                            "
                 + "\n" + "                   AND acc.t_outcoverRest <= t_debet_sum), rep_data.getEndDate())         "
                 + "\n" + "       END                                                                           ";
            else
             overdueDate = " SELECT NVL(MAX(t_restdate), rep_data.getEndDate())                                "
                 + "\n" + "   FROM dRestDate_dbt restdate                                                       "
                 + "\n" + "  WHERE restdate.t_accountid       = acc.t_accountid                                     "
                 + "\n" + "    AND restdate.t_restCurrency = acc.t_fiId                                        "
                 + "\n" + "    AND restdate.t_restDate   <= rep_data.getEndDate()                             "
                 + "\n" + "    AND t_restDate > NVL((SELECT MAX(t_restdate)                                 "
                 + "\n" + "                                 FROM dRestDate_dbt maxDate                             "
                 + "\n" + "                               WHERE maxDate.t_restCurrency = restdate.t_restCurrency"
                 + "\n" + "                                 AND maxDate.t_accountid       = restdate.t_accountid      "
                 + "\n" + "                                 AND maxDate.t_restdate   <= rep_data.getEndDate()   "
                 + "\n" + "                                 AND maxDate.t_rest = 0),                              "
                 + "\n" + "                           to_date('01.01.0001', 'dd.mm.yyyy'))                      ";
             end;
            return "(rep_data.getEndDate() - (" + overdueDate + ") )";
         end;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * @param     filter                 общий фильтр на выборку
     * @param     overdueAccountFilter   фильтр для счетов просроченной задолжности
     *
     */
    private macro getData(selectText : String, accountTableText : String, filter : String, overdueAccountFilter: String)
        var commandText = " SELECT  " +selectText
                 + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                 + "\n" + "         drepReserveAccount_vw reserveAcc,                                                    "
                 + "\n" + "         drepParty_vw           contragent                                                    "
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)                                   "
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1             --открыт за дату окончания о.п               "
                 + "\n" + "     AND (acc.t_outRest+t_debtsAccountRest) != 0 -- имеет ненулевой остаток за дату окончания о.п "
                 + "\n" + "     AND acc.t_chapter = 1                                                                    "
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                 "
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account) "
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((acc.t_qualityCategory,                                                      "
                 + "\n" + "                  acc.t_account,                                                              "
                 + "\n" + "                  acc.t_contragentId,                                                         "
                 + "\n" + "                  reserveAcc.t_reserveAccount,                                                "
                 + "\n" + "                  contragent.t_isBank,                                                        "
                 + "\n" + "                  contragent.t_isPhisical,                                                    "
                 + "\n" + "                  contragent.t_isEmployer,                                                    "
                 + "\n" + "                  acc.t_overdueTerm,                                                          "
                 + "\n" + "                  acc.t_debtsAccount,                                                         "
                 + "\n" + "                  acc.t_debtsAccountRest                                                      "
                 + "\n" + "                 ))                                                                           "
                 + "\n" + "ORDER BY GROUPING (acc.t_qualityCategory) DESC,                                               "
                 + "\n" + "         acc.t_qualityCategory,                                                               "
                 + "\n" + "         acc.t_overdueTerm,                                                                   "
                 + "\n" + "         acc.t_account                                                                        ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;


    private macro columns4_8(overdueRequirements : Bool)
        if (overdueRequirements)
             return   "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_4, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_5, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_6, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_7, "
             + "\n" + "         SUM ( CASE WHEN  acc.t_qualityCategory = 5             THEN acc.t_outCoverRest                       "
             + "\n" + "                    WHEN  acc.t_qualityCategory IN (1, 2, 3, 4) THEN acc.t_overdueRequirements"
             + "\n" + "                                                                ELSE 0                        "
             + "\n" + "               END                                                                            "
             + "\n" + "             ) column_8,                          -- остаток графы 8 + просрочка граф 4,5,6,7 "
        else
            return    "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest, 0)) column_4,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest, 0)) column_5,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest, 0)) column_6,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest, 0)) column_7,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, acc.t_outCoverRest, 0)) column_8,                  ";
        end;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк, кроме 1.7, 2.6, 3.5пр, 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
    */
    macro getBasicRequirementsData(filter : String, overdueAccountFilter : String, additionAccountsType : Integer)
        defaultParm(additionAccountsType, ADD_AC_NONE);

        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                     "
                 +                  columns4_8()
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 1 and 30                                      "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest + acc.t_debtsAccountRest                          "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 31 and 90                                     "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest + acc.t_debtsAccountRest                          "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 91 and 180                                    "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest + acc.t_debtsAccountRest                          "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm >= 181                                                "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_outCoverRest + acc.t_debtsAccountRest                          "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_enddateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_enddateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_enddateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_enddateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveacc.t_reserveAccount, ' ') reserveAccount,                               "
                 + "\n" + "         acc.t_overdueTerm                      overdueTerm,                                  "
                 + "\n" + "         acc.t_debtsAccount                     debtsAccount,                                 "
                 + "\n" + "         acc.t_debtsAccountRest                 debtsAccountRest                              ";


        if (additionAccountsType == ADD_AC_NONE)
        accountTableText =" select acc.*,                                                   "
                 + "\n" + "        CHR(1)               t_debtsAccount,                     "
                 + "\n" + "        0                    t_debtsAccountRest,                 "
                 + "\n" +          overdueTerm(false)+" t_overdueTerm                       "
                 + "\n" + "          from drepAccount_vw acc                                ";
        elif (additionAccountsType == ADD_AC_DEBT)
        /*По информации от АО м.б. только один "Счёт срочной задолженности" для л/с в один момент времени*/
        accountTableText ="SELECT NVL (al.t_account, CHR(1))   t_debtsAccount,              "
                 + "\n" + "       NVL (al.t_outcoverrest, 0)   t_debtsAccountRest,          "
                 + "\n" +         overdueTerm(false, "NVL (al.t_account, CHR(1))")+" t_overdueTerm,"
                 + "\n" + "       acc.*                                                     "
                 + "\n" + "FROM   drepaccount_vw acc                                        "
                 + "\n" + "       LEFT JOIN                                                 "
                 + "\n" + "       (drepLinkedObjects_vw LINK JOIN drepAccount_vw al         "
                 + "\n" + "        ON al.t_objectid = link.t_id                             "
                 + "\n" + "        AND link.t_connectobjecttype     = " + RCB_OBJTYPE_ACCOUNT
                 + "\n" + "        AND link.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                 + "\n" + "        AND link.t_role                  = 54                    "
                 + "\n" + "        AND link.t_isinstalledforenddate = 1                     "
                 + "\n" + "       )                                                         "
                 + "\n" + "       ON link.t_connectobjectid = acc.t_objectid                ";

        elif (additionAccountsType == ADD_AC_ACCRUED_INTEREST)
        accountTableText ="SELECT NVL (al.t_account, CHR(1)) t_debtsAccount,                "
                 + "\n" + "       NVL (al.t_outcoverRest, 0) t_debtsAccountRest,            "
                 + "\n" +         overdueTerm(false) +" t_overdueTerm,"
                 + "\n" + "       acc.*                                                     "
                 + "\n" + "FROM   drepAccount_vw acc                                        "
                 + "\n" + "       LEFT JOIN                                                 "
                 + "\n" + "       (                                                         "
                 + "\n" + "        drepAccount_vw al                                        "
                 + "\n" + "         JOIN                                                    "
                 + "\n" + "        (drepAccountPercentAccounts_vw     perc1                 "
                 + "\n" + "        JOIN drepAccountPercentAccounts_vw perc2                 "
                 + "\n" + "        ON perc2.t_contractId = perc1.t_contractId               "
                 + "\n" + "       and perc2.t_accountTypeId = 2                             "
                 + "\n" + "       and perc1.t_accountTypeId = 1)                            "
                 + "\n" + "       on  perc1.t_account = al.t_account                        "
                 + "\n" + "       AND perc1.t_fiId    = al.t_fiId                           "
                 + "\n" + "       AND perc1.t_chapter = al.t_chapter                        "
                 + "\n" + "       )                                                         "
                 + "\n" + "       ON  perc2.t_account = acc.t_account                       "
                 + "\n" + "       AND perc2.t_fiId    = acc.t_fiId                          "
                 + "\n" + "       AND perc2.t_chapter = acc.t_chapter                       ";
        end;

        return getData(selectText, accountTableText, filter, overdueAccountFilter);
    end;


    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
    */
    macro getOtherRequirementsData(filter : String, overdueAccountFilter: String, overdueRequirements : Bool)

        var selectText;
        var accountTableText;

        defaultParm(overdueRequirements, true);

        selectText =      "         acc.t_qualityCategory             qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)          column_3,                                          "
                 +                  columns4_8(overdueRequirements)
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 1 and 30                                      "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisoverduerequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 31 and 90                                     "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 91 and 180                                    "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm >= 181                                                "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_endDateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_endDateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_endDateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_endDateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveAcc.t_reserveAccount, ' ') reserveAccount,                               "
                 + "\n" + "         acc.t_overdueTerm                      overdueTerm,                                  "
                 + "\n" + "         acc.t_debtsAccount                     debtsAccount,                                 "
                 + "\n" + "         acc.t_debtsAccountRest                 debtsAccountRest                              ";


        accountTableText =" SELECT acc.*,                                                                                "
                 + "\n" + "        CHR(1)                              t_debtsAccount,                                   "
                 + "\n" + "        0                                   t_debtsAccountRest,                                  "
                 + "\n" +          overdueTerm()                   + " t_overdueTerm,                                    "
                 + "\n" +          commissionOverdueRequirements() + " t_commisOverdueRequirements,                      "
                 + "\n" + "        NVL(rep_note.readAccountOverdueRequirements(acc.t_chapter,                            "
                 + "\n" + "                                                    acc.t_account,                            "
                 + "\n" + "                                                    acc.t_fiId,                               "
                 + "\n" + "                                                    rep_data.getEndDate()),                   "
                 + "\n" + "            0)                                                          t_overdueRequirements "
                 + "\n" + " FROM drepAccount_vw acc                                                                      ";

        return getData(selectText, accountTableText, filter, overdueAccountFilter);
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * @param     filter                 общий фильтр на выборку
     * @param     overdueAccountFilter   фильтр для счетов просроченной задолжности
     *
     */
    private macro getReferenceValueData(selectText : String, accountTableText : String, filter : String)

        var commandText = " SELECT  " +selectText
                 + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                 + "\n" + "         drepReserveAccount_vw  reserveAcc,                                                   "
                 + "\n" + "         drepParty_vw           contragent                                                    "
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)                                   "
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1                   --открыт за дату окончания о.п         "
                 + "\n" + "     AND acc.t_outCoverRest != 0                            -- имеет ненулевой остаток за дату окончания о.п  "
                 + "\n" + "     AND acc.t_chapter = 1                                                                    "
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                 "
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account)      "
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((acc.t_qualityCategory,                                                      "
                 + "\n" + "                  acc.t_account,                                                              "
                 + "\n" + "                  acc.t_contragentId,                                                         "
                 + "\n" + "                  reserveacc.t_reserveAccount,                                                "
                 + "\n" + "                  contragent.t_isBank,                                                        "
                 + "\n" + "                  contragent.t_isPhisical,                                                    "
                 + "\n" + "                  contragent.t_isEmployer,                                                    "
                 + "\n" + "                  acc.t_overdueTerm                                                           "
                 + "\n" + "                 ))                                                                           "
                 + "\n" + "ORDER BY GROUPING (acc.t_qualityCategory) DESC,                                               "
                 + "\n" + "         acc.t_qualityCategory,                                                               "
                 + "\n" + "         acc.t_overdueTerm,                                                                   "
                 + "\n" + "         acc.t_account                                                                        ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printReferenceValueProtocol(data, hasData);

        data.moveFirst();

        return data.sum;
     end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строки 3.1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * getReferenceValueData
    */
    macro  getCalcReserveData(filter : String)
        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualitycategory,                                  "
                 + "\n" + "         acc.t_account                     account,                                          "
                 + "\n" + "         (" + typeAccountContragent() + ") typeaccountcontragent,                            "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                    "
                 + "\n" + "         '-' column_4,                                                                       "
                 + "\n" + "         '-' column_5,                                                                       "
                 + "\n" + "         '-' column_6,                                                                       "
                 + "\n" + "         '-' column_7,                                                                       "
                 + "\n" + "         '-' column_8,                                                                       "
                 + "\n" + "         '-' column_9,                                                                       "
                 + "\n" + "         '-' column_10,                                                                      "
                 + "\n" + "         '-' column_11,                                                                      "
                 + "\n" + "         '-' column_12,                                                                      "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) sum,                                      "
                 + "\n" + "         '-' column_14,                                                                      "
                 + "\n" + "         '-' column_15,                                                                      "
                 + "\n" + "         '-' column_16,                                                                      "
                 + "\n" + "         '-' column_17,                                                                      "
                 + "\n" + "         '-' column_18,                                                                      "
                 + "\n" + "         '-' column_19,                                                                      "
                 + "\n" + "         '-' reserveAccount,                                                                 "
                 + "\n" + "         '-' overdueTerm                                                                     ";

        accountTableText =" select acc.*,                                                                               "
                 + "\n" + "               (rep_data.getEndDate()-acc.t_openDate) t_overdueTerm                          "
                 + "\n" + "          from drepaccount_vw acc                                                            ";

        return getReferenceValueData(selectText, accountTableText, filter);
    end;

    /**
     * Получение данных для строки отчета раздела Справочно.
     * Используется для строки 3.1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * getReferenceValueData
    */
    macro  getCalcReserveSecData(filter : String)
        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualitycategory,                                  "
                 + "\n" + "         acc.t_account                     account,                                          "
                 + "\n" + "         (" + typeAccountContragent() + ") typeaccountcontragent,                            "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                         "
                 + "\n" + "         '-' column_4,                                                                       "
                 + "\n" + "         '-' column_5,                                                                       "
                 + "\n" + "         '-' column_6,                                                                       "
                 + "\n" + "         '-' column_7,                                                                       "
                 + "\n" + "         '-' column_8,                                                                       "
                 + "\n" + "         '-' column_9,                                                                       "
                 + "\n" + "         '-' column_10,                                                                      "
                 + "\n" + "         '-' column_11,                                                                      "
                 + "\n" + "         '-' column_12,                                                                      "
                 + "\n" + "         '-' column_13,                                                                      "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) sum,                                      "
                 + "\n" + "         '-' column_15,                                                                      "
                 + "\n" + "         '-' column_16,                                                                      "
                 + "\n" + "         '-' column_17,                                                                      "
                 + "\n" + "         '-' column_18,                                                                      "
                 + "\n" + "         '-' column_19,                                                                      "
                 + "\n" + "         '-' reserveaccount,                                                                 "
                 + "\n" + "         '-' overdueTerm                                                                     ";

        accountTableText =" select acc.*,                                                                               "
                 + "\n" + "               (rep_data.getEndDate()-acc.t_openDate) t_overdueTerm                          "
                 + "\n" + "          from drepaccount_vw acc                                                            ";

        return getReferenceValueData(selectText, accountTableText, filter);
    end;
end;


/**
 * Источник данных по договорам Loans.
 *
 */
class (TLoansCreditDataSource) TLoansCreditDataSource2332(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(protocol, TLoansCreditProtocol2332());
    initTLoansCreditDataSource(filter, protocol);

    macro getTableRegisters(takeRegistryValue : BOOL, overdueFilter)
        var overdueTermMax;

        if ((overdueFilter == null) or (trim(overdueFilter) == "") or (overdueFilter == "EMPTY_MASKS"))
            overdueTermMax = " 0 ";
        else
            overdueTermMax = "(select nvl(max(r.t_overdueterm), 0)                  "
                 + "\n" + "     from df115register_tmp r                            "
                 + "\n" + "    where register.t_creditId = r.t_creditId             "
                 + "\n" + "      and "+strSubst(overdueFilter, "register.", "r.")+")";
        end;

        if (takeRegistryValue and (not global.parameters.getRegistry().getIncludeOffBalance().getValue()))
          return          "(SELECT                                                                                                    "
                 + "\n" + "     CASE WHEN LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)        "
                 + "\n" + "               LIKE to_char(regName.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  to_char(regName.t_name) ||                                                                 "
                 + "\n" + "                ' - '||LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)"
                 + "\n" + "          ELSE  to_char(regname.t_name)                                                                    "
                 + "\n" + "      END    t_name,                                                                                       "
                 + "\n" + "      CASE WHEN LEAD(regname.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)       "
                 + "\n" + "               LIKE to_char(regname.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  register.t_rest                                                                            "
                 + "\n" + "               - LEAD(register.t_rest) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)     "
                 + "\n" + "          ELSE  register.t_rest                                                                            "
                 + "\n" + "      END      t_rest,                                                                                     "
                 + "\n" + "      "+overdueTermMax+" t_overdueTermMax,                                                                 "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm                                                                                        "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
        else
          return          "(SELECT                                                                                                    "
                 + "\n" + "      t_name,                                                                                              "
                 + "\n" + "      t_rest,                                                                                              "
                 + "\n" + "      "+overdueTermMax+" t_overdueTermMax,                                                                 "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm                                                                                        "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
        end;
    end;

    private macro overdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter, isPercent)
        var overdueTermFilter;
        if (overdueTermEnd == null)
           overdueTermFilter = "register.t_overdueTermMax <= " + overdueTermBegin;
        elif (overdueTermBegin == null)
           overdueTermFilter = "register.t_overdueTermMax >= " + overdueTermEnd;
        else
           overdueTermFilter = "register.t_overdueTermMax between "+ overdueTermBegin+" and " + overdueTermEnd;
        end;

        var includeTermInDelayAmount = global.parameters.getRegistry().getIncludeTermInDelayAmount().getValue();

         return           "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + overdueTermFilter + " AND                              "
                 + "\n" + "                      (   ( "+ overdueFilter + " )                                  "
                 + "\n" +          ternary((isPercent and (not includeTermInDelayAmount)),
                                           " ", " or (register.t_overdueTermMax > 0 and " + qualityCategoryFilter +")")
                 + "\n" + "                      )                                                             "
                 + "\n" + "                 THEN register.t_rest                                               "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END)                                                                  ";
    end;

    private macro percentOverdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter)
        return overdueSelectText(overdueTermBegin, overdueTermEnd, overdueFilter, qualityCategoryFilter, true)
    end;

end;

/**
 * Источник данных по портфелям Loans.
 *
 */
class (TLoansCaseDataSource) TLoansCaseDataSource2332(loansRegisterDataSource, filter)
    initTLoansCaseDataSource(loansRegisterDataSource, NVL(filter, NULL));

    /**
     *  Кеширование данных.
     */
    macro cacheData()

        sql_execute("INSERT INTO df115case_tmp (t_overdueTerm,                t_secured,                  "
           + "\n" + "                           t_contractorKind,             t_creditAim,                "
           + "\n" + "                           t_delayedDebtsReservePercSum, t_delayedDebtsReserveSum,   "
           + "\n" + "                           t_delayedDebtsRest,           t_demandsRest,              "
           + "\n" + "                           t_depriciatedDemandsGroup,    t_commissionReserveSum,     "
           + "\n" + "                           t_id,                         t_number,                   "
           + "\n" + "                           t_reservePercSum,             t_reservePercent,           "
           + "\n" + "                           t_reserveSum,                 t_qualityCategory,          "
           + "\n" + "                           t_type,                                                   "
           + "\n" + "                           t_isHigherKks,                                            "
           + "\n" + "                           t_kksRiseDate)                                            "
           + "\n" + "SELECT CASE                                                                  "
                  + ternary(global.parameters.getRegistry().getConsolidateLoans().getValue(),
             "\n" + "           WHEN t_depreciatedDemandsGroup = 0 AND t_contragentkind  = 1 THEN  30 "
           + "\n" + "           WHEN t_depreciatedDemandsGroup = 0 AND t_contragentkind != 1 THEN   0 ",
             "\n" + "           WHEN t_depreciatedDemandsGroup = 0                           THEN   0 "
                           )
           + "\n" + "           WHEN t_depreciatedDemandsGroup IN (1, 5, 11)                 THEN  30 "
           + "\n" + "           WHEN t_depreciatedDemandsGroup IN (2, 6, 12)                 THEN  90 "
           + "\n" + "           WHEN t_depreciatedDemandsGroup IN (3, 7, 13)                 THEN 180 "
           + "\n" + "           WHEN t_depreciatedDemandsGroup IN (4, 8, 14)                 THEN 360 "
           + "\n" + "           WHEN t_depreciatedDemandsGroup = 15                          THEN 720 "
           + "\n" + "       END, "
           + "\n" + "       t_securitySum, "
           + "\n" + "       t_contragentkind,               t_aim,"
           + "\n" + "       t_percentDelayedDebtReserveSum, t_delayedDebtReserveSum, "
           + "\n" + "       t_delayedDebtRest,              t_demandsRest,"
           + "\n" + "       t_depreciatedDemandsGroup,      t_commissionReserveSum, "
           + "\n" + "       t_id,                           t_number, "
           + "\n" + "       t_percentReserveSum,            t_reservePercent, "
           + "\n" + "       t_reserveSum,                   t_qualityCategory, "
           + "\n" + "       t_type,"
           + "\n" + "       t_isHigherKks,"
           + "\n" + "       t_kksRiseDate "
           + "\n" + "  FROM repLnsCase_vw case "
           + "\n" + " WHERE t_type = 1 AND (t_demandsRest + t_delayedDebtRest) <> 0  "
           + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId"));

        var querySource =   "SELECT t_id   AS a_creditNumber,"
                   + "\n" + "       t_type AS a_type         "
                   + "\n" + "  FROM repLnsContract_vw contract        "
                   + "\n" + " WHERE (    t_briefCaseId <> 0                                           "
                   + "\n" + "        AND EXISTS (SELECT 1 FROM df115case_tmp case WHERE case.t_id = contract.t_briefCaseId) "
                   + "\n" + "        AND t_isOpeneDatEndDate = 1                                      "
                            /*фильтр по терструктуре не нужен, т.к. работаем по портфелям
                    "                               AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId") +*/
                   + "\n" + "       ) ";
        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);
        command.execute();

        sql_execute(" INSERT INTO df115credit_tmp (t_id,             "
           + "\n" + "                              t_caseId,         "
           + "\n" + "                              t_number,         "
           + "\n" + "                              t_contragentId,   "
           + "\n" + "                              t_type,           "
           + "\n" + "                              t_issuetype,      "
           + "\n" + "                              t_aim,            "
           + "\n" + "                              t_rvpsAmount)     "
           + "\n" + " SELECT contract.t_id,                          "
           + "\n" + "        t_briefCaseId,                          "
           + "\n" + "        contract.t_number,                      "
           + "\n" + "        t_contragentId,                         "
           + "\n" + "        contract.t_type,                        "
           + "\n" + "        t_issuetype,                            "
           + "\n" + "        contract.t_aim,                         "
           + "\n" + "        reserve.t_rvpsSum                       "
           + "\n" + "   FROM repLnsContract_vw contract,             "
           + "\n" + "        repLnsReserve_vw  reserve               "
           + "\n" + "  WHERE contract.t_id   = reserve.t_objectNumber"
           + "\n" + "    AND contract.t_type = reserve.t_objectTypeid");

        //устанавливаем актуальные значения сформированных резервов в таблице портфелей по данным таблицы кредитных договоров
        sql_execute("UPDATE df115case_tmp case_"
           + "\n" + "   SET case_.t_reserveSum             = (SELECT NVL(SUM(t_rvpsAmount), 0) FROM df115credit_tmp contract WHERE contract.t_caseId = case_.t_id),"
           + "\n" + "       case_.t_delayedDebtsReserveSum = (SELECT NVL(SUM(t_delayedRvpsAmount), 0) FROM df115credit_tmp contract WHERE contract.t_caseId = case_.t_id)");
    end;

    /**
     * Получение данных для строки отчета раздела 3.
     * Используется для строк 1.1.1.1, 1.2.1.1, 1.3.1.1, 1.4.1.1.
     * @param     filter             фильтр
     */
    macro getNotOverdueRequirementsData(filter : String, registerKinds : String, overdueRegister)

        if ((registerKinds == "EMPTY_MASKS") OR (registerKinds == null))
            registerKinds = "null";
        end;

        var column3SelectText =
              "\n" + " (select nvl(sum(DISTINCT register.t_rest), 0)              "
            + "\n" + "    from df115credit_tmp credit,                            "
            + "\n" + "      " + m_registerDataSource.getTableRegisters(true, m_registerDataSource.getFilter().hasKindRegister(overdueRegister)) +" register "
            + "\n" + "   where credit.t_caseId           = case.t_id              "
            + "\n" + "     and credit.t_id               = register.t_creditId    "
            + "\n" + "     and register.t_overdueTermMax = 0                      "
            + "\n" + "     and register.t_type IN ( " + registerKinds + " )       "
            + "\n" + " )";

        var column4SelectText =
              "\n" + " (select nvl(sum(credit.t_rvpsAmount), 0)                   "
            + "\n" + "    from df115credit_tmp credit                             "
            + "\n" + "   where credit.t_caseId = case.t_id                        "
            + "\n" + "     and exists ( select 1                                  "
            + "\n" + "                    from " + m_registerDataSource.getTableRegisters(true, m_registerDataSource.getFilter().hasKindRegister(overdueRegister)) + " register "
            + "\n" + "                   where register.t_overdueTermMax = 0      "
            + "\n" + "                     and credit.t_id               = register.t_creditId  "
            + "\n" + "                )                                           "
            + "\n" + " )";

        return getData(column3SelectText,
                       column4SelectText,
                       filter);
    end;
end;

/**
 * Класс источника данных "Портфели ГК".
 */
class (TCbCaseDataSource) TCbCaseDataSource2332()
    /**
     * Конструктор базового объекта.
     */
    initTCbCaseDataSource();

    /**
     * Определение вида контрагента счета.
     */
    private macro typeAccountContragent()
        return            " CASE                                                             "
                 + "\n" + " WHEN contragent.t_isBank = 1                                     "
                 + "\n" + "    THEN 'КО'                                                     "
                 + "\n" + " WHEN contragent.t_isPhisical = 1 and contragent.t_isEmployer = 0 "
                 + "\n" + "    THEN 'ФЛ'                                                     "
                 + "\n" + "    ELSE 'ЮЛ'                                                     "
                 + "\n" + "END                                                               ";
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     filter                 общий фильтр на выборку
     */
    private macro getData(selectText : String, filter : String)

       var commandText =  selectText
                 + "\n" + "  FROM drepCase_vw case,                                                     "
                 + "\n" + "       drepSubCase_vw subCase                                                "
                 + "\n" + " WHERE case.t_caseId = subCase.t_caseId                                      "
                 + "\n" +         ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((case.t_caseid,                                             "
                 + "\n" + "                  case.t_name, subCase.t_caseReserveKind),                   "
                 + "\n" + "                 (case.t_endDateReservePercent,                              "
                 + "\n" + "                  subcase.t_reserveAccount,                                  "
                 + "\n" + "                  case.t_outCoverRest,                                       "
                 + "\n" + "                  case.t_clientType)                                         "
                 + "\n" + "                )                                                            "
                 + "\n" + "ORDER BY grouping(case.t_caseid) desc,                                       "
                 + "\n" + "         case.t_caseid,                                                      "
                 + "\n" + "         grouping(case.t_endDateReservePercent)                              ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
     * Получение данных для строки отчета раздела 2.
     * @param     filter                 общий фильтр на выборку
     */
    macro getJuridicalPersonData(filter : String)

        var selectText  = "SELECT case.t_caseId                                           caseNumber,                "
                 + "\n" + "       1                                                       type,                      "
                 + "\n" + "       DECODE (subcase.t_caseReserveKind, 1, 'РВП', 2, 'РВПС') reserveKind,               "
                 + "\n" + "       case.t_clientType                                       clientType,                "
                 + "\n" + "       decode( grouping(subCase.t_reserveAccount), 1, sum(case.t_outCoverRest)) column_3, "
                 + "\n" + "       case.t_endDateReservePercent                            reservePercent,            "
                 + "\n" + "       nvl(subCase.t_reserveAccount, ' ')                      reserveAccount,            "
                 + "\n" + "       sum(subCase.t_reserveAmount)                            column_4                   ";

        return getData(selectText, filter);
    end;

    /**
     * Получение данных для строки отчета раздела 3.
     * @param     filter                 общий фильтр на выборку
     */
    macro getPhysicalPersonData(filter : String)
        var selectText  = "SELECT case.t_caseId                                           caseNumber,                "
                 + "\n" + "       case.t_name                                             name,                      "
                 + "\n" + "       DECODE (subcase.t_casereservekind, 1, 'РВП', 2, 'РВПС') reservekind,               "
                 + "\n" + "       case.t_clientType                                       clientType,                "
                 + "\n" + "       decode( grouping(subcase.t_reserveaccount), 1, sum(case.t_outCoverRest)) column_3, "
                 + "\n" + "       case.t_enddatereservepercent                            reservePercent,            "
                 + "\n" + "       nvl(subcase.t_reserveaccount, ' ')                      reserveaccount,            "
                 + "\n" + "       sum(subcase.t_reserveamount)                            column_4                   ";

        return getData(selectText, filter);
    end;
end;

/**
 * Источник данных формы 110 от 2061-У.
 */
class (TDataSource2061) TDataSource2332()
    initTDataSource2061();
    /**
     * Конструктор.
     */
    private macro constructor()
        m_cbAccountsDataSource        = TCbAccountsDataSource2332();
        m_loansCreditDataSource       = TLoansCreditDataSource2332();
        m_loansCaseDataSource         = TLoansCaseDataSource2332(m_loansCreditDataSource);
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;
end;

class (TCbAccountsDataSource2332) TCbAccountsDataSource2539(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(protocol, TCbAccountsProtocol2539());
    initTCbAccountsDataSource2332(filter, protocol);

    /**
     * Получение данных для строки отчета раздела 1.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     * @param     filter                 общий фильтр на выборку
     * @param     overdueAccountFilter   фильтр для счетов просроченной задолжности
     */
    private macro getData(selectText : String, accountTableText : String, filter : String, overdueAccountFilter: String)
        var commandText = " SELECT  " +selectText
                 + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                 + "\n" + "         drepReserveAccount_vw reserveAcc,                                                    "
                 + "\n" + "         drepParty_vw           contragent                                                    "
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)                                   "
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1                   --открыт за дату окончания о.п         "
                 + "\n" + "     AND acc.t_outRest != 0                            -- имеет ненулевой остаток за дату окончания о.п                "
                 + "\n" + "     AND acc.t_chapter = 1                                                                    "
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                 "
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account)      "
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP ((acc.t_qualityCategory,                                                      "
                 + "\n" + "                  acc.t_account,                                                              "
                 + "\n" + "                  acc.t_contragentId,                                                         "
                 + "\n" + "                  reserveAcc.t_reserveAccount,                                                "
                 + "\n" + "                  contragent.t_isBank,                                                        "
                 + "\n" + "                  contragent.t_isPhisical,                                                    "
                 + "\n" + "                  contragent.t_isEmployer,                                                    "
                 + "\n" + "                  acc.t_overdueTerm,                                                          "
                 + "\n" + "                  acc.t_overdueTermMax,                                                       "
                 + "\n" + "                  acc.t_accountDebts,                                                         "
                 + "\n" + "                  acc.t_accountMain                                                           "
                 + "\n" + "                 ))                                                                           "
                 + "\n" + "ORDER BY GROUPING (acc.t_qualityCategory) DESC,                                               "
                 + "\n" + "         acc.t_qualityCategory,                                                               "
                 + "\n" + "         acc.t_overdueTermMax,                                                                "
                 + "\n" + "         acc.t_overdueTerm,                                                                   "
                 + "\n" + "         acc.t_account                                                                        ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    private macro columns4_8(overdueRequirements : Bool)
        if (overdueRequirements)
             return   "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_4, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_5, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_6, "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest - acc.t_overdueRequirements, 0)) column_7, "
             + "\n" + "         SUM ( CASE WHEN  acc.t_qualityCategory = 5             THEN acc.t_outCoverRest                       "
             + "\n" + "                    WHEN  acc.t_qualityCategory IN (1, 2, 3, 4) THEN acc.t_overdueRequirements"
             + "\n" + "                                                                ELSE 0                        "
             + "\n" + "               END                                                                            "
             + "\n" + "             ) column_8,                          -- остаток графы 8 + просрочка граф 4,5,6,7 "
        else
            return    "         SUM (DECODE (acc.t_qualityCategory, 1, acc.t_outCoverRest, 0)) column_4,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, acc.t_outCoverRest, 0)) column_5,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, acc.t_outCoverRest, 0)) column_6,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, acc.t_outCoverRest, 0)) column_7,                  "
             + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, acc.t_outCoverRest, 0)) column_8,                  ";
        end;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк, кроме 1.7, 2.6, 3.5пр, 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
     */
    macro getBasicRequirementsData(filter : String, termAccountFilter : String, overdueAccountFilter : String, accountsType : Integer, overdueRequirements : Bool)
        defaultParm(accountsType, ADD_AC_NONE);
        defaultParm(overdueRequirements,  false);

        var selectText;
        var accountTableText;

        termAccountFilter    = "(1=1 "+termAccountFilter+")";
        overdueAccountFilter = "(1=1 "+overdueAccountFilter+")";

        selectText =      "         acc.t_qualityCategory             qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)          column_3,                                          "
                 +                  columns4_8(overdueRequirements)
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 1 and 30                                   "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 31 and 90                                  "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 91 and 180                                 "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTermMax >= 181                                             "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                   "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_enddateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_enddateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_enddateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_enddateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveacc.t_reserveAccount, ' ')                                reserveAccount,"
                 + "\n" + "         acc.t_overdueTerm                                                     overdueTerm,   "
                 + "\n" + "         acc.t_overdueTermMax                                                  overdueTermMax,"
                 + "\n" + "         DECODE(acc.t_account, acc.t_accountMain,  ' ',                                       "
                 + "\n" + "                               acc.t_accountDebts, acc.t_accountMain,                         "
                 + "\n" + "                                                   acc.t_accountDebts)         debtsAccount   ";

        accountTableText ="WITH repAccount  AS                                                                "
                 + "\n" + "(SELECT/*+INLINE*/                                                                 "
                 + "\n" + "       case when " + overdueAccountFilter + "                                      "
                 + "\n" + "            then -1--просроченная задолженность                                    "
                 + "\n" + "            else  0--срочная задолженность                                         "
                 + "\n" + "       end as t_debtType,                                                          "
                 + "\n" + "       acc.*                                                                       "
                 + "\n" + "   FROM drepAccount_vw acc,                                                        "
                 + "\n" + "        drepParty_vw   contragent                                                  "
                 + "\n" + "  WHERE (   " + termAccountFilter
                 + "\n" + "         OR " + overdueAccountFilter
                 + "\n" + "        )                                                                          "
                 + "\n" + "      " + filter
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                      "
                 + "\n" + "),                                                                                 "
                 + "\n" + "account  as                                                                        "
                 + "\n" + "(SELECT/*+INLINE*/                                                                 "
                 + "\n" + "       (nvl((select al.t_account                                                   "
                 + "\n" + "               from drepLinkedObjects_vw link,                                     "
                 + "\n" + "               repAccount                al                                        "
                 + "\n" + "              where acc.t_objectid = link.t_connectobjectid                        "
                 + "\n" + "                and link.t_connectobjecttype     =  4                              "
                 + "\n" + "                and link.t_type                  =  4                              "
                 + "\n" + "                and link.t_role                  = 54                              "
                 + "\n" + "                and link.t_isinstalledforenddate =  1                              "
                 + "\n" + "                and link.t_id = al.t_objectid                                      "
                 + "\n" + "                and al.t_debtType  =  0                                            "
                 + "\n" + "                and acc.t_debtType = -1                                            "
                 + "\n" + "            ), acc.t_account)) t_accountMain,                                      "
                 + "\n" + "       acc.t_account as t_accountDebts,                                            "
                 + "\n" + "       acc.*                                                                       "
                 + "\n" + "  FROM repAccount acc                                                              "
                 + "\n" + "),                                                                                 "
                 + "\n" + "percAccount as                                                                     "
                 + "\n" + "(SELECT/*+INLINE*/                                                                 "
                 + "\n" + "       a.t_accountMain,                                                            "
                 + "\n" + "       a.t_account as t_accountDebts,                                              "
                 + "\n" + "       perc.t_accountTypeId as t_debtType,--1-%,2-пр%,5-%внебал,6-пр%внебал        "
                 + "\n" + "       percAcc.*                                                                   "
                 + "\n" + "  FROM account a,                                                                  "
                 + "\n" + "       drepAccountPercentAccounts_vw perc,                                         "
                 + "\n" + "       drepAccount_vw percAcc                                                      "
                 + "\n" + " WHERE perc.t_account = percAcc.t_account                                          "
                 + "\n" + "   AND perc.t_chapter = percAcc.t_chapter                                          "
                 + "\n" + "   AND perc.t_fiid    = percAcc.t_fiId                                             "
                 + "\n" + "   AND perc.t_isOpenedAtEndDate = 1                                                "
                 + "\n" + "   AND perc.t_connectAccount = a.t_account                                         "
                 + "\n" + "   AND perc.t_connectChapter = a.t_chapter                                         "
                 + "\n" + "   AND perc.t_connectFiId    = a.t_fiId                                            "
                 + "\n" + "   AND perc.t_account is not null --счета процентов                                "
                 + "\n" + "   AND perc.t_accounttypeid in (1, 2, 6)                                           "
                 + "\n" + ")                                                                                  "
                 + "\n" + "SELECT                                                                             "
                 + "\n" + "      MAX(a.t_overdueTerm) over(partition by a.t_accountMain) as t_overdueTermMax, "
                 + "\n" + "      NVL(rep_note.readAccountOverdueRequirements(a.t_chapter,                     "
                 + "\n" + "                                                  a.t_account,                     "
                 + "\n" + "                                                  a.t_fiId,                        "
                 + "\n" + "                                                  rep_data.getEndDate()),          "
                 + "\n" + "          0) as t_overdueRequirements,                                             "
                 + "\n" + "      a.*                                                                          "
                 + "\n" + "FROM (select                                                                       "
                 + "\n" + "            case when t_debtType in (-1, 2, 6)/*просрочка, пр %, пр %внебал*/      "
                 + "\n" + "                 then ("+overdueTerm()+")                                          "
                 + "\n" + "                 else 0                                                            "
                 + "\n" + "            end t_overdueTerm,                                                     "
                 + "\n" + "            acc.*                                                                  "
                 + "\n" + "        from (          select * from account                                      "
                 + "\n" + "              union all select * from percAccount)acc) a                           ";


        if (accountsType == ADD_AC_ACCRUED_INTEREST)
            filter = " AND t_debtType IN ( 1, 2) ";
        else
            filter = " AND t_debtType IN (-1, 0) ";
        end;

        return getData(selectText, accountTableText, filter);
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк 1.8комисс, 2.7комисс, 3.6комисс.
     * @param     selectText             текст выборки
     * @param     accountTableText       таблица счетов
    */
    macro getOtherRequirementsData(filter : String, overdueAccountFilter: String)

        var selectText;
        var accountTableText;

        selectText =      "         acc.t_qualityCategory             qualityCategory,                                   "
                 + "\n" + "         acc.t_account                     account,                                           "
                 + "\n" + "         (" + typeAccountContragent() + ") typeAccountContragent,                             "
                 + "\n" + "         SUM (acc.t_outCoverRest)               column_3,                                     "
                 +                  columns4_8()
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 1 and 30                                      "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisoverduerequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END) column_9,                                                                  "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 31 and 90                                     "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_10,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm between 91 and 180                                    "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_11,                                                                     "
                 + "\n" + "         SUM (CASE                                                                            "
                 + "\n" + "                 WHEN acc.t_overdueTerm >= 181                                                "
                 + "\n" +                        overdueAccountFilter
                 + "\n" + "                    THEN acc.t_commisOverdueRequirements                                      "
                 + "\n" + "                 ELSE 0                                                                       "
                 + "\n" + "              END                                                                             "
                 + "\n" + "             ) column_12,                                                                     "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0)) column_13,                                 "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0)) column_14,                                 "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0)) column_15,                                 "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_endDateReserveAmount, 0), 0)) column_16,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_endDateReserveAmount, 0), 0)) column_17,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_endDateReserveAmount, 0), 0)) column_18,"
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_endDateReserveAmount, 0), 0)) column_19,"
                 + "\n" + "         NVL (reserveAcc.t_reserveAccount, ' ') reserveAccount,                               "
                 + "\n" + "         acc.t_overdueTerm                      overdueTerm,                                  "
                 + "\n" + "         acc.t_overdueTermMax                   overdueTermMax,                               "
                 + "\n" + "         acc.t_accountDebts                     debtsAccount                                  ";


        accountTableText =" SELECT acc.*,                                                                                "
                 + "\n" + "        CHR(1)                              t_accountDebts,                                   "
                 + "\n" + "        CHR(1)                              t_accountMain,                                    "
                 + "\n" +          overdueTerm()                   + " t_overdueTerm,                                    "
                 + "\n" +          commissionOverdueRequirements() + " t_commisOverdueRequirements,                      "
                 + "\n" + "        0                                   t_overdueTermMax,                                 "
                 + "\n" + "        NVL(rep_note.readAccountOverdueRequirements(acc.t_chapter,                            "
                 + "\n" + "                                                    acc.t_account,                            "
                 + "\n" + "                                                    acc.t_fiId,                               "
                 + "\n" + "                                                    rep_data.getEndDate()),                   "
                 + "\n" + "            0)                                                          t_overdueRequirements "
                 + "\n" + " FROM drepAccount_vw acc                                                                      ";

        return getData(selectText, accountTableText, filter, overdueAccountFilter);
    end;
end;

/**
 * Источник данных по договорам Loans.
 *
 */
class (TLoansCreditDataSource2332) TLoansCreditDataSource2539(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    /**
     * Конструктор базового объекта.
     */
    defaultParm(protocol, TLoansCreditProtocol2332());
    initTLoansCreditDataSource2332(filter, protocol);

    var m_delayRegisterList;

    macro cacheData(tuneTable)
        m_delayRegisterList = tuneTable.getDelayRegisterNumber("1", "*", BOLoans);
        if ((m_delayRegisterList == "EMPTY_MASKS") OR (m_delayRegisterList == null))
            m_delayRegisterList = "null";
        end;

        cacheData();
    end;

    macro getTableRegisters(takeRegistryValue : BOOL)

        var overdueTermMax =
                          "(select nvl(max(r.t_overdueterm), 0)                                   "
                 + "\n" + "     from df115register_tmp r                                          "
                 + "\n" + "    where register.t_creditId = r.t_creditId                           "
                 + "\n" + "      and r.t_type IN (" + m_delayRegisterList +"))";

        if (takeRegistryValue)
          return          "(SELECT                                                                                                    "
                 + "\n" + "     CASE WHEN LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)        "
                 + "\n" + "               LIKE to_char(regName.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  to_char(regName.t_name) ||                                                                 "
                 + "\n" + "                ' - '||LEAD(regName.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)"
                 + "\n" + "          ELSE  to_char(regname.t_name)                                                                    "
                 + "\n" + "      END    t_name,                                                                                       "
                 + "\n" + "      CASE WHEN LEAD(regname.t_name) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)       "
                 + "\n" + "               LIKE to_char(regname.t_name) || '%внебаланс%'                                               "
                 + "\n" + "          THEN  register.t_rest                                                                            "
                 + "\n" + "               - LEAD(register.t_rest) OVER (PARTITION BY register.t_creditId ORDER BY regName.t_name)     "
                 + "\n" + "          ELSE  register.t_rest                                                                            "
                 + "\n" + "      END      t_rest,                                                                                     "
                 + "\n" + "      "+overdueTermMax+" t_overdueTermMax,                                                                 "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm                                                                                        "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
        else
          return          "(SELECT                                                                                                    "
                 + "\n" + "      t_name,                                                                                              "
                 + "\n" + "      t_rest,                                                                                              "
                 + "\n" + "      "+overdueTermMax+" t_overdueTermMax,                                                                 "
                 + "\n" + "      t_creditId,                                                                                          "
                 + "\n" + "      t_type,                                                                                              "
                 + "\n" + "      t_restDate,                                                                                          "
                 + "\n" + "      t_overdueTerm                                                                                        "
                 + "\n" + " FROM df115register_tmp register,                                                                          "
                 + "\n" + "      dspr_reg_dbt      regname                                                                            "
                 + "\n" + " WHERE regname.t_regid = register.t_type)                                                                  ";
        end;
    end;

    private macro overdueSelectText(overdueTermBegin, overdueTermEnd)
        var overdueTermFilter;
        if (overdueTermEnd == null)
           overdueTermFilter = "register.t_overdueTermMax <= " + overdueTermBegin;
        elif (overdueTermBegin == null)
           overdueTermFilter = "register.t_overdueTermMax >= " + overdueTermEnd;
        else
           overdueTermFilter = "register.t_overdueTermMax between "+ overdueTermBegin+" and " + overdueTermEnd;
        end;

         return           "         SUM (CASE                                                                  "
                 + "\n" + "                 WHEN " + overdueTermFilter
                 + "\n" + "                  THEN register.t_rest                                              "
                 + "\n" + "                 ELSE 0                                                             "
                 + "\n" + "              END)                                                                  ";
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для строк 2.7, 3.6.
     * @param     selectText       текст выборки
     * @qualityCategoryFilter      фильтр для 4-8 графы
     * @overdueFilter              фильтр для граф по просрочке(9-12)
      */
    macro getPercentRequirementsData(filter : String, qualityCategoryFilter : String, overdueFilter : String)

        var creditTable = "(SELECT c.*,                                                                            "
                 + "\n" + "        c.t_percRvpAmount + c.t_expPercRvpAmount + c.t_commissionRvpAmount t_rvpAmount, "
                 + "\n" + "        0                                       t_calculatedrvpsamount                    "
                 + "\n" + "            FROM df115credit_tmp c )                                                    ";

        var commandText = " SELECT  SUM (register.t_rest)                                                      column_3,      "
                 + "\n" + "         register.t_type                                                            registerType,  "
                 + "\n" + "         register.t_name                                                            registerKind,  "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 1, register.t_rest, 0))                    column_4,      "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 2, register.t_rest, 0))                    column_5,      "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 3, register.t_rest, 0))                    column_6,      "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 4, register.t_rest, 0))                    column_7,      "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 5, register.t_rest, 0))                    column_8,      "
                 + "\n" + "         "+overdueSelectText( 1,    30)+"                                           column_9,      "
                 + "\n" + "         "+overdueSelectText(31,    90)+"                                           column_10,     "
                 + "\n" + "         "+overdueSelectText(91,   180)+"                                           column_11,     "
                 + "\n" + "         "+overdueSelectText(null, 181)+"                                           column_12,     "
                 + "\n" + "         '-'                                                                        column_13,     "
                 + "\n" + "         '-'                                                                        column_14,     "
                 + "\n" + "         "+reserveSelectText(0)+"                                                   column_15,     "
                 + "\n" + "         "+reserveSelectText(2)+"                                                   column_16,     "
                 + "\n" + "         "+reserveSelectText(3)+"                                                   column_17,     "
                 + "\n" + "         "+reserveSelectText(4)+"                                                   column_18,     "
                 + "\n" + "         "+reserveSelectText(5)+"                                                   column_19,     "
                 + "\n" + "         credit.t_number                                                            creditNumber,  "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, 'Овердрафт', 21, 'Договор гарантии')  creditType,    "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')                              clientType,    "
                 + "\n" + "         CASE                                                                                      "
                 + "\n" + "              WHEN " + overdueFilter
                 + "\n" + "              THEN MAX(register.t_overdueTerm)                                                     "
                 + "\n" + "              ELSE 0                                                                               "
                 + "\n" + "         END                                                                        overdueTerm,   "
                 + "\n" + "         MAX(register.t_overdueTermMax)                                             overdueTermMax "
                 + "\n" + "FROM     " + creditTable   + " credit,                                                             "
                 + "\n" + "         " + getTableRegisters(true) + " register                                                  "
                 + "\n" + "   WHERE credit.t_id = register.t_creditId AND credit.t_caseId is null                             "
                 + "\n" + "       " + filter
                 + "\n" + "     AND (" + qualityCategoryFilter + " OR " + overdueFilter + ")";

        return getData(commandText);
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для всех строк, кроме 2.7, 3.6.
     * @param     selectText             текст выборки
     */
    macro getBasicRequirementsData(filter : String, qualityCategoryFilter : String, overdueFilter : String)

        var creditTable = "(SELECT c.*,                                                                       "
                 + "\n" + "        c.t_rvpsamount + c.t_delayedrvpsamount               t_rvpAmount,          "
                 + "\n" + "        c.t_calcRvpsAmount + c.t_delayedCalculatedRvpsAmount t_calculatedRvpsAmount"
                 + "\n" + "            FROM df115credit_tmp c )                                               ";

        var commandText = " SELECT  SUM (register.t_rest)                                                      column_3,     "
                 + "\n" + "         register.t_type                                                            registerType, "
                 + "\n" + "         register.t_name                                                            registerKind, "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 1, register.t_rest, 0))                    column_4,     "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 2, register.t_rest, 0))                    column_5,     "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 3, register.t_rest, 0))                    column_6,     "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 4, register.t_rest, 0))                    column_7,     "
                 + "\n" + "         SUM (DECODE(credit.t_riskGroup, 5, register.t_rest, 0))                    column_8,     "
                 + "\n" + "         "+overdueSelectText( 1,    30)+"                                           column_9,     "
                 + "\n" + "         "+overdueSelectText(31,    90)+"                                           column_10,    "
                 + "\n" + "         "+overdueSelectText(91,   180)+"                                           column_11,    "
                 + "\n" + "         "+overdueSelectText(null, 181)+"                                           column_12,    "
                 + "\n" + "         sum(round(credit.t_rvpsreservepercent * register.t_rest/100, 2))           column_13,    "
                 + "\n" + "         "+calcReserveSelectText()+"                                                column_14,    "
                 + "\n" + "         "+reserveSelectText(0)+"                                                   column_15,    "
                 + "\n" + "         "+reserveSelectText(2)+"                                                   column_16,    "
                 + "\n" + "         "+reserveSelectText(3)+"                                                   column_17,    "
                 + "\n" + "         "+reserveSelectText(4)+"                                                   column_18,    "
                 + "\n" + "         "+reserveSelectText(5)+"                                                   column_19,    "
                 + "\n" + "         credit.t_number                                                            creditNumber, "
                 + "\n" + "         DECODE(credit.t_type, 1, 'Кредит', 8, 'Кредит по карте', 22, 'Овердрафт', 21, 'Договор гарантии')  creditType,   "
                 + "\n" + "         DECODE(credit.t_clientType, 1, 'ЮЛ', 2, 'ФЛ')                              clientType,   "
                 + "\n" + "         case                                                                                     "
                 + "\n" + "              when " + overdueFilter
                 + "\n" + "              then max(register.t_overdueTerm)                                                    "
                 + "\n" + "              else 0                                                                              "
                 + "\n" + "         end                                                                        overdueTerm,  "
                 + "\n" + "         register.t_overdueTermMax                                                  overdueTermMax"
                 + "\n" + "FROM     " + creditTable              + " credit,                                                 "
                 + "\n" + "         " + getTableRegisters(false) + " register                                                "
                 + "\n" + "   WHERE credit.t_id = register.t_creditId AND credit.t_caseId is null                            "
                 + "\n" + "       " + filter
                 + "\n" + "     AND (" + qualityCategoryFilter + " OR " + overdueFilter + ")";

        return getData(commandText);
    end;

end;

/**
 * Источник данных формы 115 от 2539-У.
 */
class (TDataSource2332) TDataSource2539()
    initTDataSource2332();
    /**
     * Конструктор.
     */
    private macro constructor()
        m_cbAccountsDataSource        = TCbAccountsDataSource2539();
        m_loansCreditDataSource       = TLoansCreditDataSource2539();
        m_loansCaseDataSource         = TLoansCaseDataSource2332(m_loansCreditDataSource);
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;
end;

class (TCbAccountsDataSource2539) TCbAccountsDataSource2742(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    initTCbAccountsDataSource2539(filter, protocol);

    macro getPart4SubPart4Data(filter : String, attributeId : String)
        var commandText = " SELECT --Данные ГК"
                 + "\n" + "        --Раздел 4, подраздел 4, строка " + attributeId
                 + "\n" + "        acc.t_account,"
                 + "\n" + "        SUM(acc.t_outCoverRest) t_rest,"
                 + "\n" + "        SUM(reserveAcc.t_endDateReserveAmount) AS t_reserveAmount"
                 + "\n" + "    FROM drepaccount_vw acc,"
                 + "\n" + "         drepReserveAccount_vw  reserveAcc"
                 + "\n" + "   WHERE acc.t_accountId = reserveAcc.t_connectAccountId(+)"
                 + "\n" + "     AND acc.t_isOpenedatEndDate = 1"
                 + "\n" + "     AND acc.t_outRest != 0"
                 + "\n" + "     AND acc.t_chapter = 1"
                 + "\n" + "     AND not exists (select 1 from drcbBackOfficeAccount_tmp where  t_cbAccountNumber =  acc.t_account)"
                 + "\n" +       ternary(filter == null, " ", filter)
                 + "\n" + "GROUP BY ROLLUP (acc.t_account)"
                 + "\n" + "ORDER BY GROUPING(acc.t_account) DESC, acc.t_account";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printPart4_4_Protocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    macro getPart4SubPart5Data(filter : String)

        var commandText = "SELECT --Данные ГК"
                 + "\n" + "       --Раздел 4, подраздел 5"
                 + "\n" + "       t_overdueAccouns,t_percentAccount,t_overdueTerm, SUM(t_rest) t_rest"
                 + "\n" + "  FROM (SELECT t_overdueAccouns,t_percentAccount,t_overdueTerm,"
                 + "\n" + "       (SELECT SUM((SELECT t_outCoverRest"
                 + "\n" + "                      FROM drepAccount_vw account"
                 + "\n" + "                     WHERE account.t_chapter = percentAcc.t_chapter"
                 + "\n" + "                       AND account.t_fiId = percentAcc.t_fiId"
                 + "\n" + "                       AND account.t_account = percentAcc.t_account))"
                 + "\n" + "          FROM drepAccountPercentAccounts_vw percentAcc"
                 + "\n" + "         WHERE percentAcc.t_accountTypeId IN (6) --пр %внебал"
                 + "\n" + "           AND percentAcc.t_connectChapter = acc.t_chapter"
                 + "\n" + "           AND percentAcc.t_connectFiId    = acc.t_fiId"
                 + "\n" + "           AND percentAcc.t_connectAccount = acc.t_account) AS t_rest"
                 + "\n" + "  FROM (SELECT t_connectChapter AS t_chapter,"
                 + "\n" + "               t_connectFiId    AS t_fiId,"
                 + "\n" + "               t_connectAccount AS t_account,"
                 + "\n" + "               t_chapter        AS t_percentChapter,"
                 + "\n" + "               t_fiId           AS t_percentFiId,"
                 + "\n" + "               t_account        AS t_percentAccount"
                 + "\n" + "          FROM drepAccountPercentAccounts_vw"
                 + "\n" + "         WHERE t_accountTypeId IN (6)) acc,"
                 + "\n" + "       (WITH linkedAccounts AS (SELECT TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x') t_chapter,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx') t_fiId,"
                 + "\n" + "                                       SUBSTR(linkedObjects.t_id, 10) t_account,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x') t_mainChapter,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx') t_mainFiId,"
                 + "\n" + "                                       SUBSTR(linkedObjects.t_connectObjectId, 10) t_mainAccount"
                 + "\n" + "                                  FROM drepLinkedObjects_vw linkedObjects"
                 + "\n" + "                                 WHERE linkedObjects.t_connectobjecttype = 4"
                 + "\n" + "                                   AND linkedObjects.t_type = 4"
                 + "\n" + "                                   AND linkedObjects.t_role = 54"
                 + "\n" + "                                   AND linkedObjects.t_isinstalledforenddate = 1),"
                 + "\n" + "             sourceAccounts AS (SELECT t_chapter, t_fiId, t_account, t_chapter t_mainChapter, t_fiId t_mainFiId, t_account t_mainAccount"
                 + "\n" + "                                  FROM drepAccount_vw),"
                 + "\n" + "             account        AS (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount"
                 + "\n" + "                                  FROM (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM linkedAccounts"
                 + "\n" + "                                        UNION ALL"
                 + "\n" + "                                        SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM sourceAccounts)),"
                 + "\n" + "            percentAccounts AS (SELECT percent.t_chapter, percent.t_fiId, percent.t_account, account.t_mainChapter, account.t_mainFiId, account.t_mainAccount"
                 + "\n" + "                                  FROM drepAccountPercentAccounts_vw percent,"
                 + "\n" + "                                       account"
                 + "\n" + "                                 WHERE percent.t_accountTypeId IN (5,6) /*пр %, пр %внебал*/"
                 + "\n" + "                                   AND percent.t_connectChapter = account.t_chapter"
                 + "\n" + "                                   AND percent.t_connectFiId    = account.t_fiId"
                 + "\n" + "                                   AND percent.t_connectAccount = account.t_account),"
                 + "\n" + "            allAccounts     AS (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM percentAccounts"
                 + "\n" + "                                UNION"
                 + "\n" + "                                SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM account)"
                 + "\n" + "        SELECT t_mainChapter, t_mainFiId, t_mainAccount,"
                 + "\n" + "               MAX(rep_account.getMaxTerm(allAccounts.t_fiId, allAccounts.t_chapter, allAccounts.t_account, rep_data.getEndDate())) t_overdueTerm,"
                 + "\n" + "               SUBSTR(CONSTR(','||DECODE(t_account, t_mainAccount, '', t_account)), 2) t_overdueAccouns"
                 + "\n" + "          FROM allAccounts"
                 + "\n" + "      GROUP BY t_mainChapter, t_mainFiId, t_mainAccount) overdueTerm"
                 + "\n" + " WHERE acc.t_chapter = overdueTerm.t_mainChapter"
                 + "\n" + "   AND acc.t_fiId = overdueTerm.t_mainFiId"
                 + "\n" + "   AND acc.t_account = overdueTerm.t_mainAccount"
                 + "\n" + "   AND overdueTerm.t_overdueTerm > 90  " + ternary(filter == null, " ", filter) + ") data"
                 + "\n" + " WHERE t_rest != 0"
                 + "\n" + " GROUP BY ROLLUP ((t_overdueAccouns,t_percentAccount,t_overdueTerm))"
                 + "\n" + " ORDER BY GROUPING(t_overdueAccouns) DESC, t_overdueAccouns";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printPart4_5_Protocol(data, hasData);

        data.moveFirst();

        return data.rest;
    end;
end;

class (TCbAccountsDataSource2742) TCbAccountsDataSourceF115_43_PAK(filter: TDataSourceFilters, protocol : TDataSourceProtocol)
    initTCbAccountsDataSource2742(filter, protocol);

    macro getPart5SubPart5Data(filterSum1 : String, filterSum2 : String)
        var commandText = "SELECT --Данные ГК"
                 + "\n" + "       --Раздел 5, подраздел 5"
                 + "\n" + "       t_overdueAccouns,t_percentAccount,t_overdueTerm, SUM(t_rest) t_rest, t_note"
                 + "\n" + "  FROM (SELECT t_overdueAccouns,t_percentAccount,t_overdueTerm,"
                 + "\n" + "       (SELECT SUM((SELECT t_outCoverRest"
                 + "\n" + "                      FROM drepAccount_vw account"
                 + "\n" + "                     WHERE account.t_chapter = percentAcc.t_chapter"
                 + "\n" + "                       AND account.t_fiId = percentAcc.t_fiId"
                 + "\n" + "                       AND account.t_account = percentAcc.t_account))"
                 + "\n" + "          FROM drepAccountPercentAccounts_vw percentAcc"
                 + "\n" + "         WHERE percentAcc.t_accountTypeId IN (6) --пр %внебал"
                 + "\n" + "           AND percentAcc.t_connectChapter = acc.t_chapter"
                 + "\n" + "           AND percentAcc.t_connectFiId    = acc.t_fiId"
                 + "\n" + "           AND percentAcc.t_connectAccount = acc.t_account) AS t_rest,"
                 + "\n" + "       null AS t_note"
                 + "\n" + "  FROM (SELECT t_connectChapter AS t_chapter,"
                 + "\n" + "               t_connectFiId    AS t_fiId,"
                 + "\n" + "               t_connectAccount AS t_account,"
                 + "\n" + "               t_chapter        AS t_percentChapter,"
                 + "\n" + "               t_fiId           AS t_percentFiId,"
                 + "\n" + "               t_account        AS t_percentAccount"
                 + "\n" + "          FROM drepAccountPercentAccounts_vw"
                 + "\n" + "         WHERE t_accountTypeId IN (6)) acc,"
                 + "\n" + "       (WITH linkedAccounts AS (SELECT TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x') t_chapter,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx') t_fiId,"
                 + "\n" + "                                       SUBSTR(linkedObjects.t_id, 10) t_account,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 1, 2), 'FM0x') t_mainChapter,"
                 + "\n" + "                                       TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectId, 3, 7), 'FM0xxxxxx') t_mainFiId,"
                 + "\n" + "                                       SUBSTR(linkedObjects.t_connectObjectId, 10) t_mainAccount"
                 + "\n" + "                                  FROM drepLinkedObjects_vw linkedObjects"
                 + "\n" + "                                 WHERE linkedObjects.t_connectobjecttype = 4"
                 + "\n" + "                                   AND linkedObjects.t_type = 4"
                 + "\n" + "                                   AND linkedObjects.t_role = 54"
                 + "\n" + "                                   AND linkedObjects.t_isinstalledforenddate = 1),"
                 + "\n" + "             sourceAccounts AS (SELECT t_chapter, t_fiId, t_account, t_chapter t_mainChapter, t_fiId t_mainFiId, t_account t_mainAccount"
                 + "\n" + "                                  FROM drepAccount_vw),"
                 + "\n" + "             account        AS (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount"
                 + "\n" + "                                  FROM (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM linkedAccounts"
                 + "\n" + "                                        UNION ALL"
                 + "\n" + "                                        SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM sourceAccounts)),"
                 + "\n" + "            percentAccounts AS (SELECT percent.t_chapter, percent.t_fiId, percent.t_account, account.t_mainChapter, account.t_mainFiId, account.t_mainAccount"
                 + "\n" + "                                  FROM drepAccountPercentAccounts_vw percent,"
                 + "\n" + "                                       account"
                 + "\n" + "                                 WHERE percent.t_accountTypeId IN (5,6) /*пр %, пр %внебал*/"
                 + "\n" + "                                   AND percent.t_connectChapter = account.t_chapter"
                 + "\n" + "                                   AND percent.t_connectFiId    = account.t_fiId"
                 + "\n" + "                                   AND percent.t_connectAccount = account.t_account),"
                 + "\n" + "            allAccounts     AS (SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM percentAccounts"
                 + "\n" + "                                UNION"
                 + "\n" + "                                SELECT t_chapter, t_fiId, t_account, t_mainChapter, t_mainFiId, t_mainAccount FROM account)"
                 + "\n" + "        SELECT t_mainChapter, t_mainFiId, t_mainAccount,"
                 + "\n" + "               MAX(rep_account.getMaxTerm(allAccounts.t_fiId, allAccounts.t_chapter, allAccounts.t_account, rep_data.getEndDate())) t_overdueTerm,"
                 + "\n" + "               SUBSTR(CONSTR(','||DECODE(t_account, t_mainAccount, '', t_account)), 2) t_overdueAccouns"
                 + "\n" + "          FROM allAccounts"
                 + "\n" + "      GROUP BY t_mainChapter, t_mainFiId, t_mainAccount) overdueTerm"
                 + "\n" + " WHERE acc.t_chapter = overdueTerm.t_mainChapter"
                 + "\n" + "   AND acc.t_fiId = overdueTerm.t_mainFiId"
                 + "\n" + "   AND acc.t_account = overdueTerm.t_mainAccount"
                 + "\n" + "   AND overdueTerm.t_overdueTerm > 90  " + ternary(filterSum1 == null, " ", filterSum1)
                 + "\n" + "UNION ALL"
                 + "\n" + "SELECT null t_overdueAccouns, "
                 + "\n" + "       acc.t_account t_percentAccount, "
                 + "\n" + "       null t_overdueTerm, "
                 + "\n" + "       acc.t_outCoverRest t_rest, "
                 + "\n" + "       'На счете установлена категория \"Категория для отчетности/Для Формы 115/Максимальный срок просрочки по ОД и процентам свыше 90 дней\"' as t_note "
                 + "\n" + "  FROM dRepAccount_vw acc "
                 + "\n" + " WHERE 1=1" + ternary(filterSum2 == null, " ", filterSum2)
                 + "\n" + ") data"
                 + "\n" + " WHERE t_rest != 0"
                 + "\n" + " GROUP BY ROLLUP ((t_overdueAccouns,t_percentAccount,t_overdueTerm, t_note))"
                 + "\n" + " ORDER BY GROUPING(t_overdueAccouns) DESC, t_overdueAccouns";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printPart5_5_Protocol(data, hasData);

        data.moveFirst();

        return data.rest;
    end;

    /**
     * Получение данных для строки отчета раздела 1.
     * Используется для строки 2.7
     */
    macro getPercentRequirementsData(filter : String, termAccountFilter : String, overdueAccountFilter : String, accountsType : Integer, overdueRequirements : Bool)
        defaultParm(accountsType, ADD_AC_NONE);
        defaultParm(overdueRequirements,  false);

        var selectText;
        var accountTableText;

        termAccountFilter    = "(1=1 "+termAccountFilter   +")";
        overdueAccountFilter = "(1=1 "+overdueAccountFilter+")";

        selectText =      "         acc.t_qualityCategory                                                      qualityCategory,                     "
                 + "\n" + "         acc.t_account                                                              account,                             "
                 + "\n" + "         (" + typeAccountContragent() + ")                                          typeAccountContragent,               "
                 + "\n" + "         SUM (acc.t_outCoverRest)                                                   column_3,                            "
                 +                  columns4_8(overdueRequirements)
                 + "\n" + "         SUM (CASE                                                                                                       "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 1 and 30                                                              "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                                              "
                 + "\n" + "                 ELSE 0                                                                                                  "
                 + "\n" + "              END)                                                                  column_9,                            "
                 + "\n" + "         SUM (CASE                                                                                                       "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 31 and 90                                                             "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                                              "
                 + "\n" + "                 ELSE 0                                                                                                  "
                 + "\n" + "              END                                                                                                        "
                 + "\n" + "             )                                                                      column_10,                           "
                 + "\n" + "         SUM (CASE                                                                                                       "
                 + "\n" + "                 WHEN acc.t_overdueTermMax between 91 and 180                                                            "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                                              "
                 + "\n" + "                 ELSE 0                                                                                                  "
                 + "\n" + "              END                                                                                                        "
                 + "\n" + "             )                                                                      column_11,                           "
                 + "\n" + "         SUM (CASE                                                                                                       "
                 + "\n" + "                 WHEN acc.t_overdueTermMax >= 181                                                                        "
                 + "\n" + "                    THEN acc.t_outCoverRest                                                                              "
                 + "\n" + "                 ELSE 0                                                                                                  "
                 + "\n" + "              END                                                                                                        "
                 + "\n" + "             )                                                                      column_12,                           "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0))                                  column_13,                           "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0))                                  column_14,                           "
                 + "\n" + "         SUM (NVL (t_enddatereserveamount,     0))                                  column_15,                           "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_enddateReserveAmount, 0), 0)) column_16,                           "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_enddateReserveAmount, 0), 0)) column_17,                           "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_enddateReserveAmount, 0), 0)) column_18,                           "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_enddateReserveAmount, 0), 0)) column_19,                           "
                 + "\n" + "         NVL (reserveacc.t_reserveAccount, ' ')                                     reserveAccount,                      "
                 + "\n" + "         acc.t_overdueTerm                                                          overdueTerm,                         "
                 + "\n" + "         acc.t_overdueTermMax                                                       overdueTermMax,                      "
                 + "\n" + "         DECODE(acc.t_account, acc.t_accountMain,  ' ',                                                                  "
                 + "\n" + "                               acc.t_accountDebts, acc.t_accountMain,                                                    "
                 + "\n" + "                                                   acc.t_accountDebts)              debtsAccount                         "
                 ;

        accountTableText ="WITH repAccountBase  AS                                                                                                  "
                 + "\n" + "(SELECT/*+INLINE*/                                                                                                       "
                 + "\n" + "       acc.*                                                                                                             "
                 + "\n" + "   FROM drepAccount_vw acc,                                                                                              "
                 + "\n" + "        drepParty_vw   contragent                                                                                        "
                 + "\n" + "  WHERE (   " + termAccountFilter
                 + "\n" + "         OR " + overdueAccountFilter
                 + "\n" + "        )                                                                                                                "
                 + "\n" + "      " + filter
                 + "\n" + "     AND contragent.t_id = acc.t_contragentId                                                                            "
                 + "\n" + "),                                                                                                                       "
                 + "\n" + "repAccount AS                                                                                                            "
                 + "\n" + "(                                                                                                                        "
                 + "\n" + "SELECT CASE WHEN " + overdueAccountFilter + "                                                                            "
                 + "\n" + "            THEN -1  --просроченная задолженность                                                                        "
                 + "\n" + "            ELSE  0  --срочная задолженность                                                                             "
                 + "\n" + "       END AS t_debtType,                                                                                                "
                 + "\n" + "       acc.*                                                                                                             "
                 + "\n" + "  FROM drepAccount_vw acc,                                                                                               "
                 + "\n" + "       repAccountBase                                                                                                    "
                 + "\n" + " WHERE acc.t_account IN (SELECT percAccount.t_account                                                                    "
                 + "\n" + "                           FROM repPercentAccounts_vw percAccount                                                        "
                 + "\n" + "                          WHERE percAccount.t_contractId IN (SELECT percContract.t_id                                    "
                 + "\n" + "                                                               FROM repPercentContract_vw percContract                   "
                 + "\n" + "                                                              WHERE percContract.t_accountId = repAccountBase.t_accountId"
                 + "\n" + "                                                            )                                                            "
                 + "\n" + "                            AND percAccount.t_accountTypeName IN ('Счет срочных процентов для балансового учета',        "
                 + "\n" + "                                                                  'Счет просроченных процентов для балансового учета'    "
                 + "\n" + "                                                                 )                                                       "
                 + "\n" + "                        )                                                                                                "
                 + "\n" + "),                                                                                                                       "
                 + "\n" + "account  AS                                                                                                              "
                 + "\n" + "(SELECT/*+INLINE*/                                                                                                       "
                 + "\n" + "       (nvl((SELECT al.t_account                                                                                         "
                 + "\n" + "               FROM drepLinkedObjects_vw link,                                                                           "
                 + "\n" + "                    repAccount           al                                                                              "
                 + "\n" + "              WHERE acc.t_objectid               = link.t_connectobjectid                                                "
                 + "\n" + "                AND link.t_connectobjecttype     =  4                                                                    "
                 + "\n" + "                AND link.t_type                  =  4                                                                    "
                 + "\n" + "                AND link.t_role                  = 54                                                                    "
                 + "\n" + "                AND link.t_isinstalledforenddate =  1                                                                    "
                 + "\n" + "                AND link.t_id                    = al.t_objectid                                                         "
                 + "\n" + "                AND al.t_debtType                =  0                                                                    "
                 + "\n" + "                AND acc.t_debtType               = -1                                                                    "
                 + "\n" + "            ), acc.t_account)) AS t_accountMain,                                                                         "
                 + "\n" + "       acc.t_account           AS t_accountDebts,                                                                        "
                 + "\n" + "       acc.*                                                                                                             "
                 + "\n" + "  FROM repAccount acc                                                                                                    "
                 + "\n" + "),                                                                                                                       "
                 + "\n" + "percAccount AS                                                                                                           "
                 + "\n" + "(SELECT/*+INLINE*/                                                                                                       "
                 + "\n" + "       a.t_accountMain,                                                                                                  "
                 + "\n" + "       a.t_account          AS t_accountDebts,                                                                           "
                 + "\n" + "       perc.t_accountTypeId AS t_debtType,--1-%,2-пр%,5-%внебал,6-пр%внебал                                              "
                 + "\n" + "       percAcc.*                                                                                                         "
                 + "\n" + "  FROM account                       a,                                                                                  "
                 + "\n" + "       drepAccountPercentAccounts_vw perc,                                                                               "
                 + "\n" + "       drepAccount_vw                percAcc                                                                             "
                 + "\n" + " WHERE perc.t_account           = percAcc.t_account                                                                      "
                 + "\n" + "   AND perc.t_chapter           = percAcc.t_chapter                                                                      "
                 + "\n" + "   AND perc.t_fiid              = percAcc.t_fiId                                                                         "
                 + "\n" + "   AND perc.t_isOpenedAtEndDate = 1                                                                                      "
                 + "\n" + "   AND perc.t_connectAccount    = a.t_account                                                                            "
                 + "\n" + "   AND perc.t_connectChapter    = a.t_chapter                                                                            "
                 + "\n" + "   AND perc.t_connectFiId       = a.t_fiId                                                                               "
                 + "\n" + "   AND perc.t_account IS NOT NULL --счета процентов                                                                      "
                 + "\n" + "   AND perc.t_accountTypeId IN (1, 2, 6)                                                                                 "
                 + "\n" + ")                                                                                                                        "
                 + "\n" + "SELECT MAX(a.t_overdueTerm) OVER(partition by a.t_accountMain)               AS t_overdueTermMax,                        "
                 + "\n" + "       NVL(rep_note.readAccountOverdueRequirements(a.t_chapter,                                                          "
                 + "\n" + "                                                   a.t_account,                                                          "
                 + "\n" + "                                                   a.t_fiId,                                                             "
                 + "\n" + "                                                   rep_data.getEndDate()),                                               "
                 + "\n" + "           0)                                                                AS t_overdueRequirements,                   "
                 + "\n" + "       a.*                                                                                                               "
                 + "\n" + "  FROM (SELECT CASE WHEN t_debtType IN (-1, 2, 6)/*просрочка, пр %, пр %внебал*/                                         "
                 + "\n" + "                    THEN ("+overdueTerm()+")                                                                             "
                 + "\n" + "                    ELSE 0                                                                                               "
                 + "\n" + "               END t_overdueTerm,                                                                                        "
                 + "\n" + "               acc.*                                                                                                     "
                 + "\n" + "          FROM (          SELECT * FROM account                                                                          "
                 + "\n" + "                UNION ALL SELECT * FROM percAccount)acc) a                                                               ";

        if (accountsType == ADD_AC_ACCRUED_INTEREST)
            filter = " AND t_debtType IN ( 1, 2) ";
        else
            filter = " AND t_debtType IN (-1, 0) ";
        end;

        return getData(selectText, accountTableText, filter);
    end;
end;

class (TLoansCreditDataSource2539) TLoansCreditDataSource2742()
    initTLoansCreditDataSource2539();

    macro getPart4SubPart5Data(filter : String, registerTypeMasks : String)
        var selectText = "WITH registerOverdue AS (SELECT --Данные Loans"
            + "\n" +     "                                --Раздел 4, подраздел 5"
            + "\n" +     "                                credit.t_number t_creditNumber,"
            + "\n" +     "                                credit.t_type t_creditType,"
            + "\n" +     "                                registr.t_creditId,"
            + "\n" +     "                                CASE registr.t_type"
            + "\n" +     "                                    WHEN 3"
            + "\n" +     "                                        THEN 76"
            + "\n" +     "                                    WHEN 4"
            + "\n" +     "                                        THEN 75"
            + "\n" +     "                                    WHEN 18"
            + "\n" +     "                                        THEN 78"
            + "\n" +     "                                    WHEN 19"
            + "\n" +     "                                        THEN 77"
            + "\n" +     "                                    WHEN 63"
            + "\n" +     "                                        THEN 80"
            + "\n" +     "                                    WHEN 65"
            + "\n" +     "                                        THEN 81"
            + "\n" +     "                                    ELSE NULL"
            + "\n" +     "                                END t_offBalanceType,"
            + "\n" +     "                                (SELECT MAX(reg.t_overdueTerm)"
            + "\n" +     "                                   FROM df115register_tmp reg"
            + "\n" +     "                                  WHERE reg.t_creditId = registr.t_creditId"
            + "\n" +     "                                    AND " + convertMaskToSqlFormat(registerTypeMasks, "reg.t_type") + ") t_maxOverdueTerm"
            + "\n" +     "                           FROM df115register_tmp registr,"
            + "\n" +     "                                df115credit_tmp credit"
            + "\n" +     "                          WHERE credit.t_id = registr.t_creditId"
            + "\n" +     "                            " + filter
            + "\n" +     "                            AND " + convertMaskToSqlFormat(registerTypeMasks, "registr.t_type") + "),"
            + "\n" +     "     registerTable   AS (SELECT overdue.t_creditNumber, overdue.t_creditType, overdue.t_maxOverdueTerm, reg.t_type, reg.t_rest,"
            + "\n" +     "                                (SELECT t_name"
            + "\n" +     "                                   FROM dspr_reg_dbt regName"
            + "\n" +     "                                  WHERE regName.t_regId = reg.t_type) t_name"
            + "\n" +     "                           FROM df115register_tmp reg,"
            + "\n" +     "                                registerOverdue   overdue"
            + "\n" +     "                          WHERE reg.t_creditId =  overdue.t_creditId"
            + "\n" +     "                            AND reg.t_type = overdue.t_offBalanceType"
            + "\n" +     "                            AND overdue.t_maxOverdueTerm > 90)"
            + "\n" +     "SELECT t_creditNumber, t_creditType, t_type, t_maxOverdueTerm, t_name, SUM(t_rest) t_rest"
            + "\n" +     "  FROM registerTable"
            + "\n" +     "GROUP BY ROLLUP ((t_creditNumber, t_creditType, t_type, t_name, t_maxOverdueTerm))"
            + "\n" +     "ORDER BY GROUPING(t_name) DESC, t_name";

        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printPart4_5_Protocol(data, hasData);

        data.moveFirst();

        return data.rest;
    end;

end;
/**
 * Источник данных формы 115 от 2742-У.
 */
class (TDataSource2539) TDataSource2742()
    initTDataSource2539();
    /**
     * Конструктор.
     */
    private macro constructor()
        m_cbAccountsDataSource        = TCbAccountsDataSource2742();
        m_loansCreditDataSource       = TLoansCreditDataSource2742();
        m_loansCaseDataSource         = TLoansCaseDataSource2332(m_loansCreditDataSource);
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;
end;

/**
 * Источник данных формы 115 от 3129-У
 */
class (TDataSource2742) TDataSource3129()
    /**
     * Конструктор базового класса.
     */
    initTDataSource2742();

    /**
     * Конструктор.
     */
    private macro constructorTDataSource3129()
        m_cbAccountsDataSource        = TCbAccountsDataSource2742();
        m_loansCreditDataSource       = TLoansCreditDataSource2742();
        m_loansCaseDataSource         = TLoansCaseDataSource2332(m_loansCreditDataSource, TLoansCaseDataSourceFilter3129());
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;

    constructorTDataSource3129();
end;

/**
 * Источник данных формы 115 от 3129-У
 */
class (TDataSource3129) TDataSourceF115_43_PAK()
    /**
     * Конструктор базового класса.
     */
    initTDataSource3129();

    /**
     * Конструктор.
     */
    private macro constructorTDataSourceF115_43_PAK()
        m_cbAccountsDataSource        = TCbAccountsDataSourceF115_43_PAK(null, TCbAccountsProtocolF115_43_PAK());
        m_loansCreditDataSource       = TLoansCreditDataSource2742();
        m_loansCaseDataSource         = TLoansCaseDataSource2332(m_loansCreditDataSource, TLoansCaseDataSourceFilter3129());
        m_cbCaseDataSource            = TCbCaseDataSource();
        m_cbInterestAccountDataSource = TCbInterestAccountDataSource();
        m_loansTrancheDataSource      = TLoansTrancheDataSource();
    end;

    constructorTDataSourceF115_43_PAK();
end;
