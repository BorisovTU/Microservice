/*
$Name:          f115PtkPsdExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 115. Контроллер экспорта АС ПСД.
*/


import RcbProtocolView;
import f115Report;
/**
 * Операция экспорта в АС ПСД для раздела.
 */
class TPtkPsdExportPartController2742(view, partNumber, partDescription, beginColumn, endColumn) 
    private var m_view            = view;
    private var m_report : TReport = null;
    private var m_part            = partNumber;
    private var m_partDescription = partDescription;
    private var m_beginColumn     = beginColumn;
    private var m_endColumn       = endColumn;

    private macro printPtkPsdString(name, columnId, value, m_partDescriptionFormal)
        if ((value != stringUndefined) and (value != 0))
            if (valtype(m_partDescriptionFormal) == V_STRING)
                m_partDescription = m_partDescriptionFormal;
            end;
            m_view.printRow(m_partDescription,                   //Код приложения
                            name,                                //код строки
                            columnId,                            //код колонки
                            value);                              //значение
        end;
    end;
 
    macro execute()
        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/
        var columnCode : string;  /*код колонки*/
        var tempStr    : string;
        var attrName   : string;  

        m_report   = objectFactoryInstance.createReport();
        attributes = m_report.getPart(m_part).getAttributes();
        i          = 0;

        while (i < attributes.size)
            if (m_part == 4) /*справочно*/
                if (in(attributes[i].getName(), "4.1", "4.2", "4.3", "4.4", "4.5"))
                    printPtkPsdString(attributes[i].getName(), "3", attributes[i].getStringValue(string(3)), "7_SPR2");
                    printPtkPsdString(attributes[i].getName(), "4", attributes[i].getStringValue(string(4)), "7_SPR2");
                else
                    printPtkPsdString(attributes[i].getName(), "summ", attributes[i].getStringValue(), "7_SPR");
                end;
            else
                j = m_beginColumn;
                while (j <= m_endColumn)
                    if (m_part == 1)
                        columnCode = "c" + j;
                    else
                        columnCode = string(j);
                    end;
                    printPtkPsdString(attributes[i].getName(), string(columnCode), attributes[i].getStringValue(string(j)));
                    j = j+1;
                end;
            end;
            i = i+1;
        end;
    end;
end;        

class TPtkPsdExportPartController2835(view, partNumber, partDescription, beginColumn, endColumn) 
    private var m_view            = view;
    private var m_report : TReport = null;
    private var m_part            = partNumber;
    private var m_partDescription = partDescription;
    private var m_beginColumn     = beginColumn;
    private var m_endColumn       = endColumn;

    private macro printPtkPsdString(name, columnId, value, m_partDescriptionFormal)
        if ((value != stringUndefined) and (value != 0) and (value != ""))
            if (valtype(m_partDescriptionFormal) == V_STRING)
                m_partDescription = m_partDescriptionFormal;
            end;
            m_view.printRow(m_partDescription,                   //Код приложения
                            name,                                //код строки
                            columnId,                            //код колонки
                            value);                              //значение
        end;
    end;
 
    macro execute()
        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/
        var columnCode : string;  /*код колонки*/
        var tempStr    : string;
        var attrName   : string;  

        m_report   = objectFactoryInstance.createReport();
        attributes = m_report.getPart(m_part).getAttributes();
        i          = 0;

        while (i < attributes.size)
            if (m_part == 4)  // раздел 4
                if (in(attributes[i].getName(), "1", "2", "3", "4", "5", "6", "7"))
                    printPtkPsdString("4." + attributes[i].getName(), "3", attributes[i].getStringValue(string(3)), "7_SPR2");
                    printPtkPsdString("4." + attributes[i].getName(), "4", attributes[i].getStringValue(string(4)), "7_SPR2");
                end;
            elif (m_part == 5) //раздел "Справочно"
                printPtkPsdString(attributes[i].getName(), "summ", attributes[i].getStringValue(), "7_SPR");
            elif (m_part != 5) //разделы 1,2,3
                j = m_beginColumn;
                while (j <= m_endColumn)
                    if (m_part == 1)
                        columnCode = "c" + j;
                    else
                        columnCode = string(j);
                    end;
                    printPtkPsdString(attributes[i].getName(), string(columnCode), attributes[i].getStringValue(string(j)));
                    j = j+1;
                end;
            end;
            i = i+1;
        end;
        if (m_part == 5) // Раздел "Справочно" по строкам, входящим в строку 4
            var k = 1;
            var iteratorPart5Item4 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            var codeString = 0;
            iteratorPart5Item4.moveFirst();
            while (not iteratorPart5Item4.isDone())
                if ((k > 9) and (k < 100))
                    codeString = "0000" + k;
                elif (k > 99) 
                    codeString = "000" + k;
                elif (k > 999) 
                    codeString = "00" + k;
                else
                    codeString = "00000" + k;
                end;

                printPtkPsdString(codeString, "nom", k,"7_SPR4");
                m_view.printRow("7_SPR4", codeString, "rez", iteratorPart5Item4.currentItem.fieldValue("isNotResident").currentAsString);  //т.к. нужно вывести нулевое значение                   
                printPtkPsdString(codeString, "2",  iteratorPart5Item4.currentItem.fieldValue("name").currentAsString           ,"7_SPR4");
                printPtkPsdString(codeString, "3",  iteratorPart5Item4.currentItem.fieldValue("inn").currentAsString            ,"7_SPR4");
                printPtkPsdString(codeString, "4",  iteratorPart5Item4.currentItem.fieldValue("iLicense").currentAsString       ,"7_SPR4");
                printPtkPsdString(codeString, "5",  iteratorPart5Item4.currentItem.fieldValue("nSecurities").currentAsString    ,"7_SPR4");
                printPtkPsdString(codeString, "6",  iteratorPart5Item4.currentItem.fieldValue("bookValue").currentAsString      ,"7_SPR4");
                printPtkPsdString(codeString, "7",  iteratorPart5Item4.currentItem.fieldValue("presentValue").currentAsString   ,"7_SPR4");
                printPtkPsdString(codeString, "8",  iteratorPart5Item4.currentItem.fieldValue("madeReserve283").currentAsString ,"7_SPR4");
                printPtkPsdString(codeString, "9",  iteratorPart5Item4.currentItem.fieldValue("madeReserve2732").currentAsString,"7_SPR4");
                printPtkPsdString(codeString, "10", iteratorPart5Item4.currentItem.fieldValue("madeReserve").currentAsString    ,"7_SPR4");

                k = k + 1;
                iteratorPart5Item4.moveNext();                        
            end;
        elif (m_part == 6) //информативный раздел
            if (rcbApplication.currentReport.context.period.kind == RCB_PK_MONTH)
                printPtkPsdString(1, 1, 1);
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                printPtkPsdString(1, 1, 2);
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR) 
                printPtkPsdString(1, 1, 3);
            end;                                                                                        
        end;

    end;
end;

class (TPtkPsdExportPartController2835) TPtkPsdExportPartController3129_2(view, partNumber, partDescription, beginColumn, endColumn) 
    initTPtkPsdExportPartController2835(view, partNumber, partDescription, beginColumn, endColumn);

    macro execute()
        var attributes : TArray;  /*атрибуты раздела (строки)*/
        var i          : Integer; /*счетчик строк*/
        var j          : Integer; /*счетчик позиции(графы) для i-ой строки отчета*/
        var columnCode : string;  /*код колонки*/
        var tempStr    : string;
        var attrName   : string;  

        m_report   = objectFactoryInstance.createReport();
        attributes = m_report.getPart(m_part).getAttributes();
        i          = 0;

        while (i < attributes.size)
            if (m_part == 4)  // раздел 4
                if (in(attributes[i].getName(), "1", "2", "3", "4", "5", "6", "7"))
                    printPtkPsdString("4." + attributes[i].getName(), "3", attributes[i].getStringValue(string(3)), "7_SPR2");
                    printPtkPsdString("4." + attributes[i].getName(), "4", attributes[i].getStringValue(string(4)), "7_SPR2");
                end;
            elif (m_part == 5) //раздел "Справочно"
                printPtkPsdString(attributes[i].getName(), "summ", attributes[i].getStringValue(), "7_SPR");
            elif (m_part != 5) //разделы 1,2,3
                j = m_beginColumn;
                while (j <= m_endColumn)
                    if (m_part == 1)
                        columnCode = "c" + j;
                    else
                        columnCode = string(j);
                    end;
                    printPtkPsdString(attributes[i].getName(), string(columnCode), attributes[i].getStringValue(string(j)));
                    j = j+1;
                end;
            end;
            i = i+1;
        end;
        if (m_part == 5) // Раздел "Справочно" по строкам, входящим в строку 4
            var k = 1;
            var iteratorPart5Item4 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт4").createValueIterator();
            var codeString = 0;
            iteratorPart5Item4.moveFirst();
            while (not iteratorPart5Item4.isDone())
                if ((k > 9) and (k < 100))
                    codeString = "0000" + k;
                elif (k > 99) 
                    codeString = "000" + k;
                elif (k > 999) 
                    codeString = "00" + k;
                else
                    codeString = "00000" + k;
                end;

                printPtkPsdString(codeString, "nom", k,"7_SPR4");
                m_view.printRow("7_SPR4", codeString, "rez", iteratorPart5Item4.currentItem.fieldValue("isNotResident").currentAsString);  //т.к. нужно вывести нулевое значение                   
                printPtkPsdString(codeString, "2",  iteratorPart5Item4.currentItem.fieldValue("name").currentAsString           ,"7_SPR4");
                printPtkPsdString(codeString, "3",  iteratorPart5Item4.currentItem.fieldValue("inn").currentAsString            ,"7_SPR4");
                printPtkPsdString(codeString, "4",  iteratorPart5Item4.currentItem.fieldValue("iLicense").currentAsString       ,"7_SPR4");
                printPtkPsdString(codeString, "5",  iteratorPart5Item4.currentItem.fieldValue("nSecurities").currentAsString    ,"7_SPR4");
                printPtkPsdString(codeString, "6",  iteratorPart5Item4.currentItem.fieldValue("bookValue").currentAsString      ,"7_SPR4");
                printPtkPsdString(codeString, "7",  iteratorPart5Item4.currentItem.fieldValue("presentValue").currentAsString   ,"7_SPR4");
                printPtkPsdString(codeString, "8",  iteratorPart5Item4.currentItem.fieldValue("madeReserve283").currentAsString ,"7_SPR4");
                printPtkPsdString(codeString, "9",  iteratorPart5Item4.currentItem.fieldValue("madeReserve2732").currentAsString,"7_SPR4");
                printPtkPsdString(codeString, "10", iteratorPart5Item4.currentItem.fieldValue("madeReserve").currentAsString    ,"7_SPR4");

                k = k + 1;
                iteratorPart5Item4.moveNext();                        
            end;
        elif (m_part == 6) //информативный раздел
            if (rcbApplication.currentReport.context.period.kind == RCB_PK_MONTH)
                printPtkPsdString(1, 1, 1);
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_QUARTER)
                printPtkPsdString(1, 1, 2);
            elif (rcbApplication.currentReport.context.period.kind == RCB_PK_HALFYEAR) 
                printPtkPsdString(1, 1, 3);
            end;
        elif (m_part == 7)
            var iteratorPart5Item6_1 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1").createValueIterator();
            iteratorPart5Item6_1.moveFirst();
            printPtkPsdString("1", "3",  iteratorPart5Item6_1.currentItem.fieldValue("demandAmount").currentAsString);
            printPtkPsdString("1", "4",  iteratorPart5Item6_1.currentItem.fieldValue("reserve").currentAsString);
        elif (m_part == 8)
            var iteratorPart5Item6_1_1 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_1").createValueIterator();
            iteratorPart5Item6_1_1.moveFirst();
            printPtkPsdString("1.1", "3",  iteratorPart5Item6_1_1.currentItem.fieldValue("demandAmount").currentAsString);
            printPtkPsdString("1.1", "4",  iteratorPart5Item6_1_1.currentItem.fieldValue("reserve").currentAsString);
            printPtkPsdString("1.1", "5",  iteratorPart5Item6_1_1.currentItem.fieldValue("justCost").currentAsString);

        elif (m_part == 9)
            var iteratorPart5Item6_1_2 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт6_1_2").createValueIterator();
            iteratorPart5Item6_1_2.moveFirst();
            printPtkPsdString("1.2", "3",  iteratorPart5Item6_1_2.currentItem.fieldValue("demandAmount").currentAsString);
            printPtkPsdString("1.2", "4",  iteratorPart5Item6_1_2.currentItem.fieldValue("reserve").currentAsString);
            printPtkPsdString("1.2", "5",  iteratorPart5Item6_1_2.currentItem.fieldValue("justCost").currentAsString);
        end;

    end;
end;

/**
 * Операция экспорта в АС ПСД отчета.
 */
class  TPtkPsdExportController2742()

    private var m_ptkPsdExportPartControllers  : TArray;
    private var m_ptkPsdView;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2742(m_ptkPsdView, 1, "7", 3, 19);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2742(m_ptkPsdView, 2, "7_2", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2742(m_ptkPsdView, 3, "7_3", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2742(m_ptkPsdView, 4, "7_SPR");
    end;                                         

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;

        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class  TPtkPsdExportController2835()

    private var m_ptkPsdExportPartControllers  : TArray;
    private var m_ptkPsdView;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 1, "7", 3, 19);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 2, "7_2", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 3, "7_3", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 4, "7_SPR");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 5, "7_SPR4");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2835(m_ptkPsdView, 6, "7_inf");
    end;                                         

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;

        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class  TPtkPsdExportController3129_2()

    private var m_ptkPsdExportPartControllers  : TArray;
    private var m_ptkPsdView;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 6, "7_inf");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 1, "7", 3, 19);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 2, "7_2", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 3, "7_3", 3, 4);
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 4, "7_SPR");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 5, "7_SPR4");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 7, "7_SPR6");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 8, "7_SPR6");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController3129_2(m_ptkPsdView, 9, "7_SPR6");
    end; 

    private macro testPossibility()
        var m_report   = objectFactoryInstance.createReport();
        
        if (not m_report.getRcbReport().isCalculated())
            RepErrorsQueue().add(0, "Экспорт в АС ПСД может быть выполнен только после выполнения операции \"Расчет\"");
            msgBox("Экспорт в АС ПСД может быть выполнен только после выполнения операции \"Расчет\"");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;
    end;

    private macro getDescriptorInfo()
        return "fr2__2_115 от 10.01.2014";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        testPossibility();
        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;

        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class (TPtkPsdExportController3129_2) TPtkPsdExportController3468()

    initTPtkPsdExportController3129_2();

    private macro getDescriptorInfo()
        return "Alb2__2_4 от 01.10.2014";
    end;
end;