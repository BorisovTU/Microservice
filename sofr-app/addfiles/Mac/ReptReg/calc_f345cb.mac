/*───────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                  R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 345 по ГК.
└───────────────────────────────────────────────────────────────────────────*/
import calc_f345;

/*──────────────────────────────────────────────────*/
/* Данные из формы "Балансовые счета"               */
/*──────────────────────────────────────────────────*/
MACRO ПроверитьРегДатуФормыБС( Дата )

    cy_rdate.IsSummary   = RcbCharBool(RcbIsSummaryMode);
    cy_rdate.OrganizationStructure =RcbOrganizationStructure;
    cy_rdate.IssueMode   = RcbIssueMode;
    cy_rdate.iNumDprt    = НомерПодразделения;
    cy_rdate.iFormId     = НомерФормыБС;
    cy_rdate.cVarKind    = "";
    cy_rdate.bdRepDate   = Дата;
    cy_rdate.bdPrevDate  = Дата;
    if ( GetEQ( cy_rdate ) and ( cy_rdate.cCalculated == "X" )
          and ( cy_rdate.iDimension == ЕдиницыИзм)
       )
        return TRUE;
    end;
    return FALSE;
END;

/*──────────────────────────────────────────────────*/
Macro ПолучитьДатуБаланса( day_in, day_out )
  var stat = true;

  day_out = day_in;

  if( not ПроверитьРегДатуФормыБС( day_out ) )
         if ( IsWorkDay( day_out ) )
           stat = false;
         else
           day_out = day_out - 1;  /* Нет зарегистр.даты для выходного - берем предыдущий день */
           while ( not ПроверитьРегДатуФормыБС( day_out) and not IsWorkDay( day_out ) )
             day_out = day_out - 1;
           end;
           if( not ПроверитьРегДатуФормыБС( day_out ) and IsWorkDay( day_out ) )
             stat = false;
           end;
         end;
  end;
  setparm( 1, day_out );

  return stat;
End;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
MACRO РасчетПеременных
  keynum(ЛицБалР, НомерПлана);
  keynum(ЛицБалВ, НомерПлана);

  while( ДатаРасчета <= ДатаОтчета + 1 )

    if( ВалютаПоКурсу )
      УстановитьДатыВалюты();
    end;

    if( ДанныеБаланса )
      if( ПолучитьДатуБаланса( ДатаРасчета-1, ДатаБаланса )  )
        РассчитатьПеременные( FALSE );              /* Собственно расчет */
      else
        msgbox("Не рассчитаны данные формы \"",ИмяФормыБС,"\"| в единицах измерения формы за дату "+string(ДатаБаланса:f) );
        exit(1);
      end;
    else
      РассчитатьПеременные( FALSE  );               /* Собственно расчет */
    end;

    if ( not АнонсироватьДаты( НомерПодразделения, {Название отчета}, {Вид переменной},
                                      ДатаРасчета, ДатаРасчета, true ) )
      MsgBox( "Анонс дат|Ошибка регистрации вычисленных значений");
      Exit(1);
    end;

    ДатаРасчета = ДатаРасчета + 1;

  end;

  if ( not АнонсироватьДаты( НомерПодразделения, {Название отчета}, {Вид переменной},
                                      ДатаОтчета, ПредДатаОТчета, true) )
    MsgBox( "Анонс дат|Ошибка регистрации вычисленных значений");
    Exit(1);
  end;

END;
/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/

расчетПеременных();

установитьФлагВозврата( OK_MACRO_FLAG );
exit(1);
