/*
$Name: exp_f301.mac
$Module: Регламентируемая отчетность
$Description: Экспорт значений переменных формы 301.
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank 5.1                                      R-Style Software Lab Ltd
   Файл подсистемы "Отчеты ЦБ"

   Экспорт значений переменных Формы 301 в текстовый файл

   CREATED : 13.09.01 Zorina

   MODIFICATIONS:
   NOTES:

└────────────────────────────────────────────────────────────────────────── */
/*                              Настройка                                   */

var ИмяПротоколаРаботы        = "exp_f301.log";

/* ------------------------------------------------------------------------- */
/* FILES */
/* ------------------------------------------------------------------------- */
import reptCBInter, param, lib_exp, chk_regd;
import exp_lib;
import RcbWebCommon;

//FILE pers  ( person   );

FILE wrk () TXT write; /* файл экспорта */

FILE tout () TXT;

/* ------------------------------------------------------------------------- */
/* GLOBALS */
/* ......................................................................... */

/*ДиректорияФайлаЭкспорта   = ReturnDirString( "TEXTDIR", "TXTFILE");*/
var ДиректорияПротоколаРаботы = ReturnDirString( "TEXTDIR", "TXTFILE"),

    counter = 0; /* количество выгруженных записей */

VAR Дата1_1660У;
GetRegistryValue( "REPTREG\\REP_GROUPS\\COMMON\\Дата1_1660У", V_STRING, Дата1_1660У, NULL );

CheckRegDate(Дата1_1660У, Дата1_1660У);

if( (Дата1_1660У == date(0, 0, 0)) or (Дата1_1660У == NULL) )
    Дата1_1660У = date( 1, 4, 2006 );
end;

/* ------------------------------------------------------------------------- */
/* MACROS */
/* ......................................................................... */

MACRO getNameOper
 pers.Oper = {Oper};
 if( not getEQ( pers ) )
  return "";
 end;
 return trim( pers.Name );
END;

/* ......................................................................... */

/*
MACRO around( val )
 var l_coeff;

 if( not РасчетВКопейках )
  l_coeff = 1000;
  val = int( floor( ( double( val )/l_coeff + 0.5 ) ) );
 end;
 return val;
END;
*/
/* ......................................................................... */
MACRO AddExp( str, val )

 if( val != 0 )
  if( insert( wrk, str + string( val:0:0 ) ) )
   counter = counter + 1;
  else
   println( "!!! Ошибка выгрузки строки ", str + string( val ) );
  end;
 end;

END;

/* ......................................................................... */
/*                              ENTRY POINT                                  */
/* ......................................................................... */

var l_day, l_month, l_filename, l_regn,
    А13 = $0,       А24 = $0,       А35 = $0,       А47 = $0,    А59 = $0,
    А14 = $0,       А25 = $0,       А36 = $0,       А48 = $0,    А60 = $0,
    А15 = $0,       А26 = $0,       А37 = $0,       А50 = $0,
    А16 = $0,       А27 = $0,       А39 = $0,       А51 = $0,
    А17 = $0,       А28 = $0,       А40 = $0,       А52 = $0,
    А18 = $0,       А29 = $0,       А41 = $0,       А53 = $0,
    А19 = $0,       А30 = $0,       А42 = $0,       А54 = $0,
    А20 = $0,       А31 = $0,       А43 = $0,       А55 = $0,
    А21 = $0,       А32 = $0,       А44 = $0,       А56 = $0,
    А22 = $0,       А33 = $0,       А45 = $0,       А57 = $0,
    А23 = $0,       А34 = $0,       А46 = $0,       А58 = $0,

    Атр301_13 = $0, Атр301_30 = $0, Атр301_41 = $0,
    Атр301_14 = $0, Атр301_31 = $0, Атр301_42 = $0,
    Атр301_15 = $0, Атр301_32 = $0, Атр301_43 = $0,
    Атр301_16 = $0, Атр301_33 = $0, Атр301_44 = $0,
    Атр301_18 = $0, Атр301_34 = $0, Атр301_45 = $0,
    Атр301_19 = $0, Атр301_35 = $0, Атр301_46 = $0,
    Атр301_20 = $0, Атр301_36 = $0, Атр301_47 = $0,
    Атр301_21 = $0, Атр301_37 = $0, Атр301_48 = $0,
    Атр301_28 = $0, Атр301_39 = $0, Атр301_60 = $0,
    Атр301_29 = $0, Атр301_40 = $0,

    Об_ДВ____Гр3_ = $0,    Об_ДВ____Гр4_ = $0,
    Об_ДВ____Гр5_ = $0,    Об_ДВ____Гр6_ = $0,
    Об_Срочн_Гр3_ = $0,    Об_Срочн_Гр4_ = $0,
    Об_Срочн_Гр5_ = $0,    Об_Срочн_Гр6_ = $0,
    Об_ИТОГО_Гр3_ = $0,    Об_ИТОГО_Гр4_ = $0,
    Об_ИТОГО_Гр5_ = $0,    Об_ИТОГО_Гр6_ = $0,
    Об_ИТОГО_Гр7_ = $0,    Тр_До____Гр10 = $0,
    Тр_До____Гр11 = $0,    Тр_До____Гр12 = $0,
    Тр_До____Гр13 = $0,    Тр_До____Гр14 = $0,
    Тр_До____Гр15 = $0,    Тр_До____Гр16 = $0,
    Тр_До____Гр17 = $0,    ИА_До____Гр18 = $0,
    ИП_До____Гр19 = $0,    Тр_Свыше_Гр10 = $0,
    Тр_Свыше_Гр11 = $0,    Тр_Свыше_Гр12 = $0,
    Тр_Свыше_Гр13 = $0,    Тр_Свыше_Гр14 = $0,
    Тр_Свыше_Гр15 = $0,    Тр_Свыше_Гр16 = $0,
    Тр_Свыше_Гр17 = $0,    ИА_Свыше_Гр18 = $0,
    ИП_Свыше_Гр19 = $0,    СС_ИТОГО_Гр20 = $0;

/* Подготовка к экспорту */
datesplit( ДатаОтчета, l_day, l_month, NULL );
l_month = mkStr( "0", 2 - strlen( string( l_month ) ) ) + l_month;
l_day = mkStr( "0", 2 - strlen( string( l_day ) ) ) + l_day;

l_filename = /*ДиректорияФайлаЭкспорта + */"301_" + string( l_day ) +
                                                string( l_month ) +
                                                ".txt";
  if( not GetExpFileName( l_filename ) )
   exit(1);
  end;

/*if( not selectfile( l_filename, l_filename, "Введите имя файла экспорта" ) )
 exit(1);
end;
if( existFile( l_filename ) )
 if( not getTrue( TRUE, "Файл экспорта " + l_filename + " уже существует. \nПерезаписать?" ) )
  exit(1);
 end;
end;
*/
if( not open( wrk, l_filename ) )
 msgbox("Невозможно открыть файл экспорта|" + l_filename );
 exit(1);
end;

setoutput( ДиректорияПротоколаРаботы + ИмяПротоколаРаботы );
println( date, " ", time, " Протокол экспорта данных Формы 301." );
println( "                    За период с ", ПредДатаОтчета, " по ", ДатаОтчета );

counter   = 0;

/* Данные по переменным */
insert( wrk, "[F301]" );

if( not ПрочитатьЗначенияПеременных(1) )
 exit(1);
end;
if(ДатаОтчета < Дата1_1660У)
А13 = Атр301_13;         AddExp( "S1_3 ", А13 );
А14 = Атр301_14;         AddExp( "S1_4 ", А14 );
А15 = Атр301_15;         AddExp( "S1_5 ", А15 );
А16 = Атр301_16;         AddExp( "S1_6 ", А16 );
А17 = А13 + А14 + А15 + А16;     AddExp( "S1_7 ", А17 );

А18 = Атр301_18;         AddExp( "S2_3 ", А18 );
А19 = Атр301_19;         AddExp( "S2_4 ", А19 );
А20 = Атр301_20;         AddExp( "S2_5 ", А20 );
А21 = Атр301_21;         AddExp( "S2_6 ", А21 );
А22 = А18 + А19 + А20 + А21;     AddExp( "S2_7 ", А22 );

А23 = А13 + А18;                 AddExp( "S3_3 ", А23 );
А24 = А14 + А19;                 AddExp( "S3_4 ", А24 );
А25 = А15 + А20;                 AddExp( "S3_5 ", А25 );
А26 = А16 + А21;                 AddExp( "S3_6 ", А26 );
А27 = А17 + А22;                 AddExp( "S3_7 ", А27 );

А28 = Атр301_28;         AddExp( "S1_10 ", А28 );
А29 = Атр301_29;         AddExp( "S1_11 ", А29 );
А30 = Атр301_30;         AddExp( "S1_12 ", А30 );
А31 = Атр301_31;         AddExp( "S1_13 ", А31 );
А32 = Атр301_32;             AddExp( "S1_14 ", А32 );
А33 = Атр301_33;         AddExp( "S1_15 ", А33 );
А34 = Атр301_34;         AddExp( "S1_16 ", А34 );
А35 = Атр301_35;         AddExp( "S1_17 ", А35 );
А36 = Атр301_36;         AddExp( "S1_18 ", А36 );
А37 = Атр301_37;         AddExp( "S1_19 ", А37 );

А39 = Атр301_39;         AddExp( "S2_10 ", А39 );
А40 = Атр301_40;         AddExp( "S2_11 ", А40 );
А41 = Атр301_41;         AddExp( "S2_12 ", А41 );
А42 = Атр301_42;         AddExp( "S2_13 ", А42 );
А43 = Атр301_43;         AddExp( "S2_14 ", А43 );
А44 = Атр301_44;         AddExp( "S2_15 ", А44 );
А45 = Атр301_45;         AddExp( "S2_16 ", А45 );
А46 = Атр301_46;         AddExp( "S2_17 ", А46 );
А47 = Атр301_47;         AddExp( "S2_18 ", А47 );
А48 = Атр301_48;         AddExp( "S2_19 ", А48 );

А50 = А28 + А39;                 AddExp( "S3_10 ", А50 );
А51 = А29 + А40;                 AddExp( "S3_11 ", А51 );
А52 = А30 + А41;                 AddExp( "S3_12 ", А52 );
А53 = А31 + А42;                 AddExp( "S3_13 ", А53 );
А54 = А32 + А43;                 AddExp( "S3_14 ", А54 );
А55 = А33 + А44;                 AddExp( "S3_15 ", А55 );
А56 = А34 + А45;                 AddExp( "S3_16 ", А56 );
А57 = А35 + А46;                 AddExp( "S3_17 ", А57 );
А58 = А36 + А47;                 AddExp( "S3_18 ", А58 );
А59 = А37 + А48;                 AddExp( "S3_19 ", А59 );

А60 = Атр301_60;         AddExp( "S3_20 ", А60 );
else
А13 = Об_ДВ____Гр3_;         AddExp( "S1_3 ", А13 );
А14 = Об_ДВ____Гр4_;         AddExp( "S1_4 ", А14 );
А15 = Об_ДВ____Гр5_;         AddExp( "S1_5 ", А15 );
А16 = Об_ДВ____Гр6_;         AddExp( "S1_6 ", А16 );
А17 = А13 + А14 + А15 + А16;     AddExp( "S1_7 ", А17 );

А18 = Об_Срочн_Гр3_;         AddExp( "S2_3 ", А18 );
А19 = Об_Срочн_Гр4_;         AddExp( "S2_4 ", А19 );
А20 = Об_Срочн_Гр5_;         AddExp( "S2_5 ", А20 );
А21 = Об_Срочн_Гр6_;         AddExp( "S2_6 ", А21 );
А22 = А18 + А19 + А20 + А21;     AddExp( "S2_7 ", А22 );

А23 = А13 + А18;                 AddExp( "S3_3 ", А23 );
А24 = А14 + А19;                 AddExp( "S3_4 ", А24 );
А25 = А15 + А20;                 AddExp( "S3_5 ", А25 );
А26 = А16 + А21;                 AddExp( "S3_6 ", А26 );
А27 = А17 + А22;                 AddExp( "S3_7 ", А27 );

А28 = Тр_До____Гр10;         AddExp( "S1_10 ", А28 );
А29 = Тр_До____Гр11;         AddExp( "S1_11 ", А29 );
А30 = Тр_До____Гр12;         AddExp( "S1_12 ", А30 );
А31 = Тр_До____Гр13;         AddExp( "S1_13 ", А31 );
А32 = Тр_До____Гр14;         AddExp( "S1_14 ", А32 );
А33 = Тр_До____Гр15;         AddExp( "S1_15 ", А33 );
А34 = Тр_До____Гр16;         AddExp( "S1_16 ", А34 );
А35 = Тр_До____Гр17;         AddExp( "S1_17 ", А35 );
А36 = ИА_До____Гр18;         AddExp( "S1_18 ", А36 );
А37 = ИП_До____Гр19;         AddExp( "S1_19 ", А37 );

А39 = Тр_Свыше_Гр10;         AddExp( "S2_10 ", А39 );
А40 = Тр_Свыше_Гр11;         AddExp( "S2_11 ", А40 );
А41 = Тр_Свыше_Гр12;         AddExp( "S2_12 ", А41 );
А42 = Тр_Свыше_Гр13;         AddExp( "S2_13 ", А42 );
А43 = Тр_Свыше_Гр14;         AddExp( "S2_14 ", А43 );
А44 = Тр_Свыше_Гр15;         AddExp( "S2_15 ", А44 );
А45 = Тр_Свыше_Гр16;         AddExp( "S2_16 ", А45 );
А46 = Тр_Свыше_Гр17;         AddExp( "S2_17 ", А46 );
А47 = ИА_Свыше_Гр18;         AddExp( "S2_18 ", А47 );
А48 = ИП_Свыше_Гр19;         AddExp( "S2_19 ", А48 );

А50 = А28 + А39;                 AddExp( "S3_10 ", А50 );
А51 = А29 + А40;                 AddExp( "S3_11 ", А51 );
А52 = А30 + А41;                 AddExp( "S3_12 ", А52 );
А53 = А31 + А42;                 AddExp( "S3_13 ", А53 );
А54 = А32 + А43;                 AddExp( "S3_14 ", А54 );
А55 = А33 + А44;                 AddExp( "S3_15 ", А55 );
А56 = А34 + А45;                 AddExp( "S3_16 ", А56 );
А57 = А35 + А46;                 AddExp( "S3_17 ", А57 );
А58 = А36 + А47;                 AddExp( "S3_18 ", А58 );
А59 = А37 + А48;                 AddExp( "S3_19 ", А59 );

А60 = СС_ИТОГО_Гр20;         AddExp( "S3_20 ", А60 );
end;
/* Реквизиты */
l_regn = string( РегНомерБанка );
if( НомерПодразделения != {Numdprt} )
 l_regn = l_regn + string( "/", НомерПодразделения );
end;
insert( wrk, "[REKW]" );
insert( wrk, "ADDRESS {" + {Post_Addr}           + "}" );
insert( wrk, "BIC {"     + rcbGetBic()           + "}" ); /* 17.10.2007 Malakhova 110424 - заменила {MFO_Bank} на rcbGetBic()*/
insert( wrk, "DOL_BG {"  + {Name_Book}           + "}" );
insert( wrk, "DOL_IS {"  + Должность_Исполнителя + "}" );
insert( wrk, "DOL_PR {"  + {Name_Boss}           + "}" );
insert( wrk, "FIO_BG {"  + {FIO_Book}            + "}" );
insert( wrk, "FIO_IS {"  + getNameOper           + "}" );
insert( wrk, "FIO_PR {"  + {FIO_Boss}            + "}" );
insert( wrk, "NAME {"    + {Name_Bank}           + "}" );
insert( wrk, "OKPO {"    + Код_ОКПО              + "}" );
insert( wrk, "REGN {"    + l_regn                + "}" );
insert( wrk, "SOATO {"   + Код_СОАТО             + "}" );
insert( wrk, "TEL_IS {"  + Номер_телефона        + "}" );

/* Завершение экспорта */
close( wrk );
println( "                    Файл: ", l_filename );
println( date, " ", time, " Выгружено записей: ", counter );
println( date, " ", time, " Окончание экспорта данных Формы 301." );

open( tout, setoutput( NULL, TRUE ) );
RepTxtFilesQueue().add(setoutput( NULL, TRUE ));
viewFile( tout );
exit(1);

/* EoF */
