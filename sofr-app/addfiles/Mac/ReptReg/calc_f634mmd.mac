/*
$Name:        calc_f634mmd.mac
$Module:      Регламентируемая отчетность
$Description: Формирование данных по МБК
*/

import testLib;
import calc_f634com;

/**
 *  Параметры расчета по МБК
 */
private class (TParameters) TParametersMmd(report : Object)
    private macro constructorTParametersMmd(report : Object)
        initTParameters(report);
    end;

    constructorTParametersMmd(report);
end;

private class TDataSourceMmdReservesQueryTextMaker(parameters : TParametersMmd)
    private var m_parameters : TParameters;
    private var m_reportDate : String;

    private macro getParameters()
        return m_parameters;
    end;

    macro getQueryText_f634rez_bal_mbk()
        var commandText : String;

        commandText = "   SELECT deals.t_id                                                                                         AS t_dealid,                    "
             + "\n" + "          deals.t_number                                                                                     AS t_dealnumber,                "
             + "\n" + "          deals.t_openDate                                                                                   AS t_dealdate,                  "
             + "\n" + "          deals.t_fiId                                                                                       AS t_dealFiId,                  "
             + "\n" + "          NVL(reserves.t_rvpsSum, 0)                                                                         AS t_rvpsSum,                   "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(deals.t_fiId,                                                                                             "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserves.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                            "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0)                                                                        AS t_rvpsRate,                  "
             + "\n" + "          NVL(reserves.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                      AS t_rvpsRateDate,              "
             + "\n" + "          NVL(reserves.t_rvpsDelayedSum, 0)                                                                  AS t_rvpsDelayedSum,            "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(deals.t_fiId,                                                                                             "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserves.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                     "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0)                                                                        AS t_rvpsDelayedRate,           "
             + "\n" + "          NVL(reserves.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                               AS t_rvpsDelayedRateDate,       "
             + "\n" + "          NVL(reserves.t_rvpPercentSum, 0)                                                                   AS t_rvpPercentSum,             "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(deals.t_fiId,                                                                                             "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserves.t_rvpPercentDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                      "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0)                                                                        AS t_rvpPercentRate,            "
             + "\n" + "          NVL(reserves.t_rvpPercentDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                AS t_rvpPercentRateDate,        "
             + "\n" + "          NVL(reserves.t_rvpDelayedPercentSum, 0)                                                            AS t_rvpDelayedPercentSum,      "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(deals.t_fiId,                                                                                             "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserves.t_rvpDelayedPercentDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                               "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0)                                                                        AS t_rvpDelayedPercentRate,     "
             + "\n" + "          NVL(reserves.t_rvpDelayedPercentDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                         AS t_rvpDelayedPercentRateDate, "
             + "\n" + "          NVL(reserves.t_rvpPenaltySum, 0)                                                                   AS t_rvpPenaltySum,             "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(deals.t_fiId,                                                                                             "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserves.t_rvpPenaltyDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                      "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0,                                                                                                        "
             + "\n" + "                                   0)                                                                        AS t_rvpPenaltyRate,            "
             + "\n" + "          NVL(reserves.t_rvpPenaltyDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                AS t_rvpPenaltyRateDate         "
             + "\n" + "     FROM repMmDeals_vw       deals                                                                                                          "
             + "\n" + "LEFT JOIN repMmDealReserve_vw reserves                                                                                                       "
             + "\n" + "       ON reserves.t_dealId = deals.t_id                                                                                                     "
             + "\n" + "    WHERE deals.t_kind              = 'Размещение '                                                                                          "
             + "\n" + "      AND deals.t_isOpenedAtEndDate = 1                                                                                                      "
        ;

        return commandText;
    end;

    private macro constructorTDataSourceMmdReservesQueryTextMaker(parameters : TParametersMmd)
        m_parameters = parameters;
        m_reportDate = getSqlDate(m_parameters.getendDate());
    end;

    constructorTDataSourceMmdReservesQueryTextMaker(parameters);
end;

private class TDataSourceMmdGuaranteeQueryTextMaker(parameters : TParametersMmd)
    private var m_parameters : TParameters;
    private var m_reportDate : String;

    private macro getParameters()
        return m_parameters;
    end;

    macro getQueryText_f634Garantiipolu4_mbk()
        var commandText : String;

        commandText = "   SELECT deals.t_id                                                                                         AS t_dealid,              "
             + "\n" + "          deals.t_number                                                                                     AS t_dealnumber,          "
             + "\n" + "          deals.t_openDate                                                                                   AS t_dealdate,            "
             + "\n" + "          deals.t_fiId                                                                                       AS t_dealFiId,            "
             + "\n" + "          guarantee.t_fiId                                                                                   AS t_guaranteeFiId,       "
             + "\n" + "          guarantee.t_kind,                                                                                                            "
             + "\n" + "          guarantee.t_number                                                                                 AS t_contractNumber,      "
             + "\n" + "          guarantee.t_currencyCost,                                                                                                    "
             + "\n" + "          guarantee.t_roubleCost,                                                                                                      "
             + "\n" + "          NVL(reserve.t_calcRvps, 0)                                                                         AS t_calcRvpsSum,         "
             + "\n" + "          NVL(reserve.t_rvpsSum, 0)                                                                          AS t_rvpsSum,             "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(guarantee.t_fiId,                                                                                   "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserve.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                       "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0)                                                                        AS t_rvpsRate,            "
             + "\n" + "          NVL(reserve.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                       AS t_rvpsRateDate,        "
             + "\n" + "          NVL(reserve.t_calcRvpsDelayedWithEnsure, 0)                                                        AS t_calcRvpsDelayedSum,  "
             + "\n" + "          NVL(reserve.t_rvpsDelayedSum, 0)                                                                   AS t_rvpsDelayedSum,      "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(guarantee.t_fiId, "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserve.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0)                                                                        AS t_rvpsDelayedRate,     "
             + "\n" + "          NVL(reserve.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                AS t_rvpsDelayedRateDate, "
             + "\n" + "          deals.t_mainRestRoubleAmount                                                                       AS t_mainDebtSum,         "
             + "\n" + "          deals.t_delaydMainRestRoubleAmount                                                                 AS t_delayedMainDebtSum,  "
             + "\n" + "          guarantee.t_secissuer,                                                                                                       "
             + "\n" + "          NVL((SELECT t_value                                                                                                          "
             + "\n" + "                 FROM drepcategory_vw                                                                                                  "
             + "\n" + "                WHERE t_objectType            = " + OBJTYPE_PARTY
             + "\n" + "                  AND t_id                    = " + RCB_OBJGROUP_DEBTOR_FINANCIAL_STATE
             + "\n" + "                  AND t_isInstalledForEndDate = 1                                                                                      "
             + "\n" + "                  AND t_objectid              = RSB_REP_PT.MAKEPARTYID(guarantee.t_secissuer)),                                        "
             + "\n" + "              0)                                                                                             AS t_financialState,      "
             + "\n" + "          " + m_reportDate + " -                                                                                                       "
             + "\n" + "          NVL((SELECT t_validFromDate                                                                                                  "
             + "\n" + "                 FROM drepcategory_vw                                                                                                  "
             + "\n" + "                WHERE t_objectType            = " + OBJTYPE_PARTY
             + "\n" + "                  AND t_id                    = " + RCB_OBJGROUP_DEBTOR_FINANCIAL_STATE
             + "\n" + "                  AND t_isInstalledForEndDate = 1                                                                                      "
             + "\n" + "                  AND t_objectid              = RSB_REP_PT.MAKEPARTYID(guarantee.t_secissuer)),                                        "
             + "\n" + "              " + m_reportDate + ")                                                                          AS t_termHardState,       "
             + "\n" + "          " + getSqlString(m_parameters.getCode_vvv_garantiipolu4_mbk()) + "                                 AS t_usedByPosition       "
             + "\n" + "     FROM repMmDealGuarantee_vw guarantee,                                                                                             "
             + "\n" + "          repMmDeals_vw         deals                                                                                                  "
             + "\n" + "LEFT JOIN repMmDealReserve_vw   reserve                                                                                                "
             + "\n" + "       ON reserve.t_dealId = deals.t_id                                                                                                "
             + "\n" + "    WHERE guarantee.t_dealId        = deals.t_id                                                                                       "
             + "\n" + "      AND guarantee.t_kind          = 'Г'                                                                                              "
             + "\n" + "      AND deals.t_isOpenedAtEndDate = 1                                                                                                "
             + "\n" + "      AND deals.t_fiId             <> " + NATCUR
        ;

        return commandText;
    end;

    macro getQueryText_f634Zalog_mbk()
        var commandText : String;

        commandText = "   SELECT deals.t_id                                                                                         AS t_dealid,              "
             + "\n" + "          deals.t_number                                                                                     AS t_dealnumber,          "
             + "\n" + "          deals.t_openDate                                                                                   AS t_dealdate,            "
             + "\n" + "          deals.t_fiId                                                                                       AS t_dealFiId,            "
             + "\n" + "          guarantee.t_fiId                                                                                   AS t_guaranteeFiId,       "
             + "\n" + "          guarantee.t_kind,                                                                                                            "
             + "\n" + "          guarantee.t_number                                                                                 AS t_contractNumber,      "
             + "\n" + "          guarantee.t_currencyCost,                                                                                                    "
             + "\n" + "          guarantee.t_roubleCost,                                                                                                      "
             + "\n" + "          NVL(reserve.t_calcRvps, 0)                                                                         AS t_calcRvpsSum,         "
             + "\n" + "          NVL(reserve.t_rvpsSum, 0)                                                                          AS t_rvpsSum,             "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(guarantee.t_fiId,                                                                                   "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserve.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                       "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0)                                                                        AS t_rvpsRate,            "
             + "\n" + "          NVL(reserve.t_rvpsDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                       AS t_rvpsRateDate,        "
             + "\n" + "          NVL(reserve.t_calcRvpsDelayedWithEnsure, 0)                                                        AS t_calcRvpsDelayedSum,  "
             + "\n" + "          NVL(reserve.t_rvpsDelayedSum, 0)                                                                   AS t_rvpsDelayedSum,      "
             + "\n" + "          rsb_fiinstr.FI_GetRateMP(guarantee.t_fiId, "
             + "\n" + "                                   " + NATCUR + ","
             + "\n" + "                                   " + RATETYPE_CB + ","
             + "\n" + "                                   NVL(reserve.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')),                                "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0,                                                                                                  "
             + "\n" + "                                   0)                                                                        AS t_rvpsDelayedRate,     "
             + "\n" + "          NVL(reserve.t_rvpsDelayedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                AS t_rvpsDelayedRateDate, "
             + "\n" + "          deals.t_mainRestRoubleAmount                                                                       AS t_mainDebtSum,         "
             + "\n" + "          deals.t_delaydMainRestRoubleAmount                                                                 AS t_delayedMainDebtSum,  "
             + "\n" + "          guarantee.t_secissuer,                                                                                                       "
             + "\n" + "          NVL((SELECT t_value                                                                                                          "
             + "\n" + "                 FROM drepcategory_vw                                                                                                  "
             + "\n" + "                WHERE t_objectType            = " + OBJTYPE_PARTY
             + "\n" + "                  AND t_id                    = " + RCB_OBJGROUP_DEBTOR_FINANCIAL_STATE
             + "\n" + "                  AND t_isInstalledForEndDate = 1                                                                                      "
             + "\n" + "                  AND t_objectid              = RSB_REP_PT.MAKEPARTYID(guarantee.t_secissuer)),                                        "
             + "\n" + "              0)                                                                                             AS t_financialState,      "
             + "\n" + "          " + m_reportDate + " -                                                                                                       "
             + "\n" + "          NVL((SELECT t_validFromDate                                                                                                  "
             + "\n" + "                 FROM drepcategory_vw                                                                                                  "
             + "\n" + "                WHERE t_objectType            = " + OBJTYPE_PARTY
             + "\n" + "                  AND t_id                    = " + RCB_OBJGROUP_DEBTOR_FINANCIAL_STATE
             + "\n" + "                  AND t_isInstalledForEndDate = 1                                                                                      "
             + "\n" + "                  AND t_objectid              = RSB_REP_PT.MAKEPARTYID(guarantee.t_secissuer)),                                        "
             + "\n" + "              " + m_reportDate + ")                                                                          AS t_termHardState,       "
             + "\n" + "          " + getSqlString(m_parameters.getCode_vvv_zalog_mbk()) + "                                         AS t_usedByPosition       "
             + "\n" + "     FROM repMmDealGuarantee_vw guarantee,                                                                                             "
             + "\n" + "          repMmDeals_vw         deals                                                                                                  "
             + "\n" + "LEFT JOIN repMmDealReserve_vw   reserve                                                                                                "
             + "\n" + "       ON reserve.t_dealId = deals.t_id                                                                                                "
             + "\n" + "    WHERE guarantee.t_dealId         = deals.t_id                                                                                      "
             + "\n" + "      AND guarantee.t_kind          <> 'Г'                                                                                             "
             + "\n" + "      AND deals.t_isOpenedAtEndDate  = 1                                                                                               "
        ;

        return commandText;
    end;

    private macro constructorTDataSourceMmdGuaranteeQueryTextMaker(parameters : TParametersMmd)
        m_parameters = parameters;
        m_reportDate = getSqlDate(m_parameters.getendDate());
    end;

    constructorTDataSourceMmdGuaranteeQueryTextMaker(parameters);
end;

/**
 *  Источник данных по резервам МБК по инструкции 4927-У
 */
private class (TDataSourceBase) TDataSourceMmdReserves_4927(parameters : TParametersMmd)
    private macro createDataset(queryText) : Object
        var dataset = TRsbDataset(queryText);

        dataset.setFieldType("t_dealId",                    V_INTEGER);
        dataset.setFieldType("t_dealNumber",                V_STRING);
        dataset.setFieldType("t_dealDate",                  V_DATE);
        dataset.setFieldType("t_dealFiId",                  V_INTEGER);
        dataset.setFieldType("t_guaranteeFiId",             V_INTEGER);
        dataset.setFieldType("t_rvpsSum",                   V_MONEY);
        dataset.setFieldType("t_rvpsRate",                  V_MONEY);
        dataset.setFieldType("t_rvpsRateDate",              V_DATE);
        dataset.setFieldType("t_rvpsDelayedSum",            V_MONEY);
        dataset.setFieldType("t_rvpsDelayedRate",           V_MONEY);
        dataset.setFieldType("t_rvpsDelayedRateDate",       V_DATE);
        dataset.setFieldType("t_rvpPercentSum",             V_MONEY);
        dataset.setFieldType("t_rvpPercentRate",            V_MONEY);
        dataset.setFieldType("t_rvpPercentRateDate",        V_DATE);
        dataset.setFieldType("t_rvpDelayedPercentSum",      V_MONEY);
        dataset.setFieldType("t_rvpDelayedPercentRate",     V_MONEY);
        dataset.setFieldType("t_rvpDelayedPercentRateDate", V_DATE);
        dataset.setFieldType("t_rvpPenaltySum",             V_MONEY);
        dataset.setFieldType("t_rvpPenaltyRate",            V_MONEY);
        dataset.setFieldType("t_rvpPenaltyRateDate",        V_DATE);

        return dataset;
    end;

    private macro constructorTDataSourceMmd(parameters : TParameters)
        initTDataSourceBase(BOIBC, parameters);

        var queryText = TDataSourceMmdReservesQueryTextMaker(parameters);

        // Текст запроса для отбора данных по атрибуту VVV_рез_бал_МБК
        m_container[m_container.size] = queryText.getQueryText_f634rez_bal_mbk();
    end;

    constructorTDataSourceMmd(parameters);
end;

/**
 *  Источник данных по гарантиям/залогам МБК по инструкции 4927-У
 */
private class (TDataSourceBase) TDataSourceMmdGuarantee_4927(parameters : TParametersMmd)
    private macro createDataset(queryText) : Object
        var dataset = TRsbDataset(queryText);

        dataset.setFieldType("t_dealId",              V_INTEGER);
        dataset.setFieldType("t_dealNumber",          V_STRING);
        dataset.setFieldType("t_dealDate",            V_DATE);
        dataset.setFieldType("t_dealFiId",            V_INTEGER);
        dataset.setFieldType("t_guaranteeFiId",       V_INTEGER);
        dataset.setFieldType("t_kind",                V_STRING);
        dataset.setFieldType("t_contractNumber",      V_STRING);
        dataset.setFieldType("t_currencyCost",        V_MONEY);
        dataset.setFieldType("t_roubleCost",          V_MONEY);
        dataset.setFieldType("t_calcRvpsSum",         V_MONEY);
        dataset.setFieldType("t_rvpsSum",             V_MONEY);
        dataset.setFieldType("t_rvpsRate",            V_MONEY);
        dataset.setFieldType("t_rvpsRateDate",        V_DATE);
        dataset.setFieldType("t_calcRvpsDelayedSum",  V_MONEY);
        dataset.setFieldType("t_rvpsDelayedSum",      V_MONEY);
        dataset.setFieldType("t_rvpsDelayedRate",     V_MONEY);
        dataset.setFieldType("t_rvpsDelayedRateDate", V_DATE);
        dataset.setFieldType("t_mainDebtSum",         V_MONEY);
        dataset.setFieldType("t_delayedMainDebtSum",  V_MONEY);
        dataset.setFieldType("t_secissuer",           V_INTEGER);
        dataset.setFieldType("t_financialState",      V_INTEGER);
        dataset.setFieldType("t_termHardState",       V_INTEGER);
        dataset.setFieldType("t_usedByPosition",      V_STRING);

        return dataset;
    end;

    private macro constructorTDataSourceMmd(parameters : TParameters)
        initTDataSourceBase(BOIBC, parameters);

        var queryText = TDataSourceMmdGuaranteeQueryTextMaker(parameters);

        // Текст запроса для отбора данных по атрибуту VVV_ГарантииПолуч_МБК
        m_container[m_container.size] = queryText.getQueryText_f634Garantiipolu4_mbk();
        // Текст запроса для отбора данных по атрибуту VVV_Залог_МБК
        m_container[m_container.size] = queryText.getQueryText_f634Zalog_mbk();
    end;

    constructorTDataSourceMmd(parameters);
end;

/**
 *  Контроллер извлечения данных
 */
private class TDataExtractionController_4927(parameters : TParametersMmd)
    private var m_extractantReserves;
    private var m_extractantGuarantee;

    macro process()
        m_extractantGuarantee.extract();
        m_extractantReserves.extract();
    end;

    private macro constructor(parameters : TParametersMmd)
        m_extractantGuarantee = TDataExtractant(TTempTableMmdGuarantee(), TDataSourceMmdGuarantee_4927(parameters));
        m_extractantReserves  = TDataExtractant(TTempTableMmdReserves(), TDataSourceMmdReserves_4927(parameters));
    end;

    constructor(parameters);
end;

/**
 *  Основная функция
 */
macro main(report : Object)

    var profiler = TSqlProfiler(getTxtFileName("!calc_f634mm_sqlprofile"));
    profiler.clear();
    profiler.on();

    var parameters = TParametersMmd(report);

    begAction(2000, "Получение данных МБК (" + string(parameters.getEndDate() : f) + ")");

    if   (rcbApplication().currentReport().context.period.EndDate >= RCB_I4927_DATE)
        TDataExtractionController_4927(parameters).process();
    end;

    endAction(1);

    profiler.off();

    onError(error)
        exceptionMessage(error);
        profiler.off();
        exit(1);
end;
