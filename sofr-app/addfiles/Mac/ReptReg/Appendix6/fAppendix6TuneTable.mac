/*
$Name:        fAppendix6TuneTable.mac
$Module:      Регламентированная отчетность
$Description: Насторечная таблица отчета Приложение 6
*/
/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Приложение 6. Насторечная таблица.

   CREATED : 24.09.2014 ABP.
└────────────────────────────────────────────────────────────────────────── */
class (RcbTuneTable) TFAppendix6TuneTable(/*instructionDate : Date*/)
    macro getMasks() : String
        return getMasks("t_szChapters");
    end;

    private macro constructorTFAppendix6TuneTable(/*instructionDate : Date*/)
        initRcbTuneTable("dtAppendix6_dbt");
    end;

    /**
     * Получить список полей настроечной таблицы.
     * Так как для веб-интерфейса не используем ресурсы (lbr), информацию
     * о полях необходимо описывать здесь.
     *
     * @return Массив объектов TMetaInformation в формате xml.
     */
    macro getMetadataTuneTableWeb(): TArray
        /**
         * Результат - массив полей.
         */
        var result: TArray = TArray();
        /**
         * Статус выполнения.
         */
        var stat: Integer = 0;

        //TMetaInformation(id, name, nameHead, isReadOnly, isVisible)
        result[result.size] = TMetaInformation(1, "T_SZCHAPTERS", "Главы плана счетов", FALSE, TRUE);

        return result;
    end;

    constructorTFAppendix6TuneTable(/*instructionDate*/);
end;

                    /***************************\
                     *      Web-интерфейс      *
                    \***************************/

/**
 * Создать и вернуть объект настроечной таблицы.
 *
 * @param attribute Атрибут выбранного в дереве настроечной табилицы (указание\раздел).
 *
 * @return Объект настроечной таблицы в формате xml.
 */
macro getObjectTuneTableWeb(attribute /* : TRcbTuneTableItemTree */): String
    /**
     * Результат - объект в формате xml.
     */
    var resultXml: String = "";
    /**
     * Статус выполнения.
     */
    var stat: Integer = 0;
    /**
     * Объект настроечной таблицы.
     */
    var tuneTable: Variant = null;

    tuneTable = TFAppendix6TuneTable();

    /**
     * Метаинформация
     */
    var metadataList: TArray = tuneTable.getMetadataTuneTableWeb();

    //сохраняем данные и метаинформацию в переменных
    tuneTable.saveMetadataTuneTable(metadataList);
    tuneTable.saveDataTuneTable();

    stat = ConvertToXML(tuneTable, NULL, resultXml);

    if (stat != 0)
        RunError("Ошибка преобразования объекта настроечной таблицы в XML");
    end;

    return resultXml;
end;

/**
 * Получить массив указаний\разделов для настроечной таблицы.
 *
 * Если используются только указания, то формируем простой массив указаний.
 * Если используются и указания и разделы, то формируем сложный массив, по аналогии:
 * var arrayList = TArray();
 * arrayList[arrayList.size] = "Указание 1";
 * var arrayPart = TArray();
 * arrayPart[arrayPart.size] = "Раздел 1";
 * arrayPart[arrayPart.size] = "Раздел 2";
 * arrayList[arrayList.size] = arrayPart;
 * Будет сформировано дерево настроечной таблицы (web):
 *   - Указание 1
 *       - Раздел 1
 *       - Раздел 2
 *
 * @return TArray Массив указаний\разделов.
 */
macro getDestinationTuneTableWeb(): String
    /**
     * Результат - массив указаний.
     */
    var result: TArray = TArray();
    /**
     * Результат - массив указаний в формате xml.
     */
    var resultXml: String = "";
    /**
     * Статус выполнения.
     */
    var stat: Integer = 0;

    result[result.size] = NAME_DESTINATION_3129U;

    stat = ConvertToXml(result, NULL, resultXml);

    if (stat != 0)
        RunError("Ошибка преобразования списка указаний\разделов в XML");
    end;

    return resultXml;
end;
