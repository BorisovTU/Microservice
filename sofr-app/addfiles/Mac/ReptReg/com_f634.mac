/*
$Name:        com_f634.mac
$Module:      Регламентируемая отчетность
$Description: Общие классы для расчета формы 634
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 634. Общее: глобализмы, фильтр по дате, фильтр валют с открытыми счетами, параметры отчета, капитал банка

  Создан: 24.07.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

/**
 *  Общебанковские интеры и модули
 */
import BankInter;
import RsbDataSet;
import RsbObjFactory;

import cb_sql;
import globals;

/**
 *  Интеры и модули подсистемы
 */
import ReptcbInter;
import RcbCoreInter;
import repException;
import departmentFilter;

import rcbGlobal;
import rcb_bo;
import rcbconst;
import rcb_lib;

import rcbCapitalData;
import Календарь;

import rcbimport;
import param;
import log_lib;
/**
 *  Имена переменных
 */
const DATE_CAPITAL      = "ДатаКапитала";
const PREV_DATE_CAPITAL = "ПредДатаКапитала";
const CAPITAL           = "Капитал";
const OCP_DATA          = "ОВП";
const USER_INPUT        = "ПользовательскийВвод";
const USER_INPUT_LIMITS = "ПользовательскийВводЛим";
const TOTALS_DATA       = "Итоги";
const DEALS_DATA        = "Сделки";

/**
 *  Неинициализирован список позиций
 */
private class (TException) TPositionCodeListNotInitializedException()
    initTException("Неинициализирован список кодов позиций");
end;

class (TGlobalBase) F634Global(report : RcbReport)
    initTGlobalBase();

    private var m_rcbReport = report;

    macro getRcbReport() : RcbReport
        return m_rcbReport;
    end;

    macro isOperationDay(curdate)

        var query = "SELECT t_nodeType FROM ddp_dep_dbt ddp"
           + "\n" + "  WHERE ddp.t_code = " + RcbApplication().currentReport.context.departmentCode;

        var data = TRsbDataSet(query);
        data.moveNext();
        if (data.nodeType == 2) /* Наш узел - ВСП. Ищем вышестоящий филиал */
            if ((RcbApplication().currentReport.context.issueMode == 1) or (RcbApplication().currentReport.context.issueMode == 2))
                query = "SELECT t_branch FROM dcurdate_dbt curdate,"
               + "\n" + "              (SELECT ddp.t_code, ddp.t_nodeType FROM drepdpdep_vw ddp"
               + "\n" + "                 WHERE ddp.t_nodeType = 1 AND ddp.t_status != 3 AND rownum < 2"
               + "\n" + "                 START WITH ddp.t_code = " + RcbApplication().currentReport.context.departmentCode
               + "\n" + "                 CONNECT BY ddp.t_code = PRIOR ddp.t_parentNodeId) dep"
               + "\n" + "  WHERE curdate.t_branch = dep.t_code AND curdate.t_curdate = " + getSqlDate(curdate) + " AND dep.t_code IN" + rcbDepartmentList().getAsSqlSetFull();
            else /* Режим выпуска "Банк". Ищем все связанные узлы */
                query = "SELECT t_branch FROM dcurdate_dbt curdate,"
               + "\n" + "              (SELECT ddp.t_code, ddp.t_nodeType FROM drepdpdep_vw ddp"
               + "\n" + "                 WHERE ddp.t_nodeType = 1 AND ddp.t_status != 3"
               + "\n" + "                 START WITH ddp.t_code = " + RcbApplication().currentReport.context.departmentCode
               + "\n" + "                 CONNECT BY ddp.t_code = PRIOR ddp.t_parentNodeId"
               + "\n" + "                UNION"
               + "\n" + "               SELECT ddp.t_code, ddp.t_nodeType FROM drepdpdep_vw ddp"
               + "\n" + "                 WHERE ddp.t_nodeType = 1 AND ddp.t_status != 3"
               + "\n" + "                 START WITH ddp.t_code = " + RcbApplication().currentReport.context.departmentCode
               + "\n" + "                 CONNECT BY PRIOR ddp.t_code = ddp.t_parentNodeId)"
               + "\n" + "  WHERE curdate.t_branch = dep.t_code AND curdate.t_curdate = " + getSqlDate(curdate) + " AND dep.t_code IN" + rcbDepartmentList().getAsSqlSetFull();
            end;
        else /* Наш узел - Филиал */
            if ((RcbApplication().currentReport.context.issueMode == 1) or (RcbApplication().currentReport.context.issueMode == 2))
                query = "SELECT curdate.t_branch FROM dcurdate_dbt curdate"
               + "\n" + "  WHERE curdate.t_branch = " + RcbApplication().currentReport.context.departmentCode + " AND curdate.t_curdate = " + getSqlDate(curdate) + " AND curdate.t_branch IN" + rcbDepartmentList().getAsSqlSetFull();
            else /* Режим выпуска "Банк". Ищем все связанные узлы */
                query = "SELECT t_branch FROM dcurdate_dbt curdate,"
               + "\n" + "              (SELECT ddp.t_code, ddp.t_nodeType FROM drepdpdep_vw ddp"
               + "\n" + "                 WHERE ddp.t_nodeType = 1 AND ddp.t_status != 3"
               + "\n" + "                 START WITH ddp.t_code = " + RcbApplication().currentReport.context.departmentCode
               + "\n" + "                 CONNECT BY ddp.t_code = PRIOR ddp.t_parentNodeId"
               + "\n" + "                UNION"
               + "\n" + "               SELECT ddp.t_code, ddp.t_nodeType FROM drepdpdep_vw ddp"
               + "\n" + "                 WHERE ddp.t_nodeType = 1 AND ddp.t_status != 3"
               + "\n" + "                 START WITH ddp.t_code = " + RcbApplication().currentReport.context.departmentCode
               + "\n" + "                 CONNECT BY PRIOR ddp.t_code = ddp.t_parentNodeId) dep"
               + "\n" + "  WHERE curdate.t_branch = dep.t_code AND curdate.t_curdate = " + getSqlDate(curdate) + " AND dep.t_code IN" + rcbDepartmentList().getAsSqlSetFull();
            end;
        end;

        data = TRsbDataSet(query);

        return data.moveNext();
    end;

    macro inListOperationDay(day : Date)
        var it = RcbApplication().currentReport.attributeValue("СписокОперационныхДней").createValueIterator();
        it.moveFirst();

        while(not it.isDone())
            if (it.currentItem.fieldValue("operationDay").exact == String(day))
                return true;
            end;

            it.moveNext();
        end;

        return false;
    end;

    initializeRepDataPackage(m_rcbReport);
end;

macro global(report)
    v_global = F634Global(report);
    return v_global;
end;

/**
 *  Фильтр по дате, универсальный
 */
class TFilterByReportDate(reportDate)
    private var m_reportDate = reportDate;

    macro isSuitable(v)
        return (date(v.fieldValue("Отчетная дата").exact) == m_reportDate);
    end;
end;

/**
 *  Фильтр валют с открытыми счетами
 *  @since 6.00.020.28
 *  @author ABP
 */
class (TFilterByReportDate) TOpenedAccountFilter(reportDate)
    macro isSuitable(v)
        return isSuitable(v) and (v.fieldValue("Открытые л/с").current > 0);
    end;

    private macro constructor(reportDate)
        initTFilterByReportDate(reportDate);
    end;

    constructor(reportDate);
end;

///**
// *  Фильтр валют с открытыми счетами
// */
//private class (TFilterByReportDate) TOpenedAccountFilter(reportDate)
//
//    var m_hasOpenedAccountCommand : Object;
//
//    macro isSuitable(v)
//
//        var hasData = false;
//
//        if (isSuitable(v))
//
//            m_hasOpenedAccountCommand.addParam("fiCode", RSDBP_IN, v.fieldValue("Код валюты").currentAsString);
//
//            m_hasOpenedAccountCommand.execute();
//
//            hasData = TRsbDataset(m_hasOpenedAccountCommand).next();
//
//        end;
//
//        return hasData;
//
//    end;
//
//    private macro constructor(reportDate)
//        initTFilterByReportDate(reportDate);
//
//        m_hasOpenedAccountCommand = RsdCommand(         "SELECT 1"
//                                               + "\n" + "  FROM DUAL"
//                                               + "\n" + "  WHERE EXISTS (SELECT /*+FIRST_ROWS*/ 1"
//                                               + "\n" + "                  FROM daccount$_dbt account,"
//                                               + "\n" + "                       v_rcb_f634_fininstr fininstr"
//                                               + "\n" + "                 WHERE fininstr.t_code = ?"
//                                               + "\n" + "                  AND fininstr.t_id = account.t_code_currency"
//                                               + "\n" + "                  AND (    account.t_open_date <= " + getSqlDate(reportDate)
//                                               + "\n" + "                       AND (    account.t_close_date > " + getSqlDate(m_reportDate)
//                                               + "\n" + "                            OR account.t_close_date = " + getSqlDate(Date(0,0,0))
//                                               + "\n" + "                           )"
//                                               + "\n" + "                      )"
//                                               + "\n" + "              )"
//                                              );
//    end;
//
//    constructor(reportDate);
//
//end;

/**
 *  Параметры отчета
 */
class TParameters(report : Object)
    private const TYPE_MAIN      = "M";
    private const TYPE_PERCENT   = "P";
    private const TYPE_SECURITY  = "S";
    private const TYPE_GUARANTEE = "G";

    private var m_beginDate;
    private var m_endDate;
    private var m_planNumber;
    private var m_positionCodeList;

    private var m_accountKindActive;
    private var m_accountKindPassive;
    private var m_isEveryDay = null;

    private macro initializePositionCodeList()

        if ((m_positionCodeList != null) and (m_positionCodeList.size > 0))
            return;
        end;

        var i;
        var dataSource;
        var query;

        query =          "SELECT rcb_f634.getCode_vvv_3(),"
                + "\n" + "       rcb_f634.getCode_vvv_4(),"
                + "\n" + "       rcb_f634.getCode_vvv_5(),"
                + "\n" + "       rcb_f634.getCode_vvv_10(),"
                + "\n" + "       rcb_f634.getCode_vvv_rez_bal_gk(),"
                + "\n" + "       rcb_f634.getCode_vvv_rez_bal_gk_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_garantiipolu4(),"
                + "\n" + "       rcb_f634.getCode_vvv_akkreditiv(),"
                + "\n" + "       rcb_f634.getCode_vvv_3_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_4_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_5_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_garpolu4_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_rez_bal_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_gar_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_garrez_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_zalog_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_3_810_eq(),"
                + "\n" + "       rcb_f634.getCode_vvv_4_810_eq(),"
                + "\n" + "       rcb_f634.getCode_vvv_5_810_eq(),"
                + "\n" + "       rcb_f634.getCode_vvv_garantiipolu4_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_garpolu4_810_eq(),"
                + "\n" + "       rcb_f634.getCode_vvv_garpolu4_k_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_10_k(),"
                + "\n" + "       rcb_f634.getCode_vvv_akkreditiv_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_gar_gk(),"
                + "\n" + "       rcb_f634.getCode_vvv_gar_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_garrez_gk(),"
                + "\n" + "       rcb_f634.getCode_vvv_zalog_810(),"
                + "\n" + "       rcb_f634.getCode_vvv_zalog_gk(),"
                + "\n" + "       rcb_f634.getCode_vvv_3_810_reval(),"
                + "\n" + "       rcb_f634.getCode_vvv_rez_bal_mbk(),"
                + "\n" + "       rcb_f634.getCode_vvv_garantiipolu4_mbk(),"
                + "\n" + "       rcb_f634.getCode_vvv_zalog_mbk()"
                + "\n" + "  FROM dual";

        dataSource = TRsbDataset(query);

        if (not dataSource.next())
            throw(TPositionCodeListNotInitializedException());
        end;

        m_positionCodeList = TArray();

        i = 0;
        while (i < dataSource.fldCount)
            m_positionCodeList[i] = dataSource.value(i);
            i = i + 1;
        end;

    end;

    private macro initializeAccountKind()
        var dataSource;

        if (m_accountKindActive != null)
            return;
        end;

        dataSource = TRsbDataset(         "SELECT rcb_f634.getKindActive() t_kindActive,"
                                 + "\n" + "       rcb_f634.getKindPassive() t_kindPassive"
                                 + "\n" + "  FROM DUAL");

        if (dataSource.next())
            m_accountKindActive  = dataSource.t_kindActive;
            m_accountKindPassive = dataSource.t_kindPassive;
        end;
    end;

    macro getBeginDate()
        return m_beginDate;
    end;

    macro getEndDate()
        return m_endDate;
    end;

    macro getPlanNumber()
        return m_planNumber;
    end;

    macro getAccountTypeMain()
        return TYPE_MAIN;
    end;

    macro getAccountTypePercent()
        return TYPE_PERCENT;
    end;

    macro getAccountTypeSecurity()
        return TYPE_SECURITY;
    end;

    macro getAccountTypeGuarantee()
        return TYPE_GUARANTEE;
    end;

    macro getAccountKindActive()
        initializeAccountKind();
        return m_accountKindActive;
    end;

    macro getAccountKindPassive()
        initializeAccountKind();
        return m_accountKindPassive;
    end;

    macro getCode_vvv_3()
        initializePositionCodeList();
        return m_positionCodeList[0];
    end;

    macro getCode_vvv_4()
        initializePositionCodeList();
        return m_positionCodeList[1];
    end;

    macro getCode_vvv_5()
        initializePositionCodeList();
        return m_positionCodeList[2];
    end;

    macro getCode_vvv_10()
        initializePositionCodeList();
        return m_positionCodeList[3];
    end;

    macro getCode_vvv_rez_bal_gk()
        initializePositionCodeList();
        return m_positionCodeList[4];
    end;

    macro getCode_vvv_rez_bal_gk_810()
        initializePositionCodeList();
        return m_positionCodeList[5];
    end;

    macro getCode_vvv_garantiipolu4()
        initializePositionCodeList();
        return m_positionCodeList[6];
    end;

    macro getCode_vvv_akkreditiv()
        initializePositionCodeList();
        return m_positionCodeList[7];
    end;

    macro getCode_vvv_3_810()
        initializePositionCodeList();
        return m_positionCodeList[8];
    end;

    macro getCode_vvv_4_810()
        initializePositionCodeList();
        return m_positionCodeList[9];
    end;

    macro getCode_vvv_5_810()
        initializePositionCodeList();
        return m_positionCodeList[10];
    end;

    macro getCode_vvv_garpolu4_810()
        initializePositionCodeList();
        return m_positionCodeList[11];
    end;

    macro getCode_vvv_rez_bal_k()
        initializePositionCodeList();
        return m_positionCodeList[12];
    end;

    macro getCode_vvv_gar_k()
        initializePositionCodeList();
        return m_positionCodeList[13];
    end;

    macro getCode_vvv_garrez_k()
        initializePositionCodeList();
        return m_positionCodeList[14];
    end;

    macro getCode_vvv_zalog_k()
        initializePositionCodeList();
        return m_positionCodeList[15];
    end;

    macro getCode_vvv_3_810_eq()
        initializePositionCodeList();
        return m_positionCodeList[16];
    end;

    macro getCode_vvv_4_810_eq()
        initializePositionCodeList();
        return m_positionCodeList[17];
    end;

    macro getCode_vvv_5_810_eq()
        initializePositionCodeList();
        return m_positionCodeList[18];
    end;

    macro getCode_vvv_garantiipolu4_k()
        initializePositionCodeList();
        return m_positionCodeList[19];
    end;

    macro getCode_vvv_garpolu4_810_eq()
        initializePositionCodeList();
        return m_positionCodeList[20];
    end;

    macro getCode_vvv_garpolu4_k_810()
        initializePositionCodeList();
        return m_positionCodeList[21];
    end;

    macro getCode_vvv_10_k()
        initializePositionCodeList();
        return m_positionCodeList[22];
    end;

    macro getCode_vvv_akkreditiv_810()
        initializePositionCodeList();
        return m_positionCodeList[23];
    end;

    macro getCode_vvv_gar_gk()
        initializePositionCodeList();
        return m_positionCodeList[24];
    end;

    macro getCode_vvv_gar_810()
        initializePositionCodeList();
        return m_positionCodeList[25];
    end;

    macro getCode_vvv_garrez_gk()
        initializePositionCodeList();
        return m_positionCodeList[26];
    end;

    macro getCode_vvv_zalog_810()
        initializePositionCodeList();
        return m_positionCodeList[27];
    end;

    macro getCode_vvv_zalog_gk()
        initializePositionCodeList();
        return m_positionCodeList[28];
    end;

    macro getCode_vvv_3_810_reval()
        initializePositionCodeList();
        return m_positionCodeList[29];
    end;

    macro getCode_vvv_rez_bal_mbk()
        initializePositionCodeList();
        return m_positionCodeList[30];
    end;

    macro getCode_vvv_garantiipolu4_mbk()
        initializePositionCodeList();
        return m_positionCodeList[31];
    end;

    macro getCode_vvv_zalog_mbk()
        initializePositionCodeList();
        return m_positionCodeList[32];
    end;

    macro isEveryDay()
        return m_isEveryDay;
    end;

    private macro constructorTParameters(report : Object)
        m_beginDate  = report.context.period.beginDate;
        m_endDate    = report.context.period.endDate;
        m_planNumber = RcbApplication().parameters.balancePlanNumber;

        m_accountKindActive = null;
        m_accountKindPassive = null;

        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 634/РАСЧЕТ ЗА КАЖДЫЙ ДЕНЬ", V_BOOL, m_isEveryDay, null);
    end;

    constructorTParameters(report);
end;

/**
 *  Контроллер печати
 */
class TPrinterController(prefix : String)
    private var m_fileName;
    private var m_oldOutput;

    macro create()
        m_oldOutput = setOutput(m_fileName);
    end;

    macro show()
        viewFileLog(m_fileName);
    end;

    macro add(partFileName)
        FILE partFile() txt;

        open(partFile, partFileName);

        while (next(partFile))
            println(partFile.str);
        end;

        println();
        println();

        close(partFile);
    end;

    macro getReportFileName()
        return m_fileName;
    end;

    private macro constructor(prefix : String)
        m_fileName = getNameLog(prefix);
    end;

    private macro destructor()
        setOutput(m_oldOutput, true);
    end;

    constructor(prefix);
end;

class TCapitalData(report : RcbReport)
    private var m_currentReport  = RcbApplication.currentReport;
    private var m_report         = report;
    private var m_compositeValue = null;
    private var m_isEveryday = false;
    private var m_isFoundExistentCompositeValue = false;

    private macro initialize()
        const REGISTRY_PATH : String = "REPTREG/REP_GROUPS/ФОРМА 634/КАПИТАЛ НА ВНУТРИМЕСЯЧНУЮ ДАТУ";

        var errorCode     : Integer = 0;
        var valueType     : Integer = V_UNDEF;

        valueType = getRegistryValue(REGISTRY_PATH, V_BOOL, m_isEveryday, errorCode);

        if ((errorCode != 0) or (valueType != V_BOOL))
            runError("Ошибка чтения настройки: " + REGISTRY_PATH);
        end;
    end;

    private macro getCapitalDate()
        var day   = 0;
        var month = 0;
        var year  = 0;

        dateSplit(m_report.context.period.endDate(), day, month, year);

        if (in(m_currentReport.context.period.kind, RCB_PK_DAY, RCB_PK_TEN_DAYS))
            if (m_isEveryday)
                return Date(day, month, year);
            end;
            return Date(1, month, year);
        end;

        if (month == 12)
            return Date(1, 1, year + 1);
        end;

        return Date(1, month + 1, year);
    end;

    private macro getCompositeValue()
        if (m_compositeValue != null)
            return m_compositeValue;
        end;

        var capitalDate = getCapitalDate();
        var av = m_currentReport.attributeValue("ДанныеКапитала");
        var keyValue = av.createKeyValue();

        keyValue.fieldValue("date") = strSubst(String(capitalDate), " ", "0");

        m_compositeValue = av.findValue(keyValue);

        if (m_compositeValue == null)
            m_compositeValue = av.addValue();
            m_compositeValue.reset();
            m_compositeValue.fieldValue("date").exact = strSubst(String(capitalDate), " ", "0");
        else
            m_isFoundExistentCompositeValue = true;
        end;

        return m_compositeValue;
    end;

    // возвращает getCapitalDate через вызов getCompositeValue, который получает дату из того же getCapitalDate
    // побочный "эффект" - создается(если ее еще нет) структурная переменная с этой датой
    macro getDate() : Date
        return Date(strSubst(getCompositeValue().fieldValue("date").currentAsString, " ", "0"));
    end;

    // побочные "эффекты" - аналогично getDate(), собственно он же и вызывается
    macro getPreviousDate() : Date
        return ternary(m_isEveryday, this.getDate(), Date("01" + SubStr(String(this.getDate()), 3)));
    end;

    // существующая (или вновь создаенная) структурная переменная за дату getCapitalDate()
    // превращается в переменную за дату capitalDate
    // значение за убиваемую дату(если оно было) остается с новой датой
    macro setDate(capitalDate)
        getCompositeValue().fieldValue("date").exact = strSubst(String(capitalDate), " ", "0");
    end;

    // получаем значение капитала за дату getCapitalDate()
    // если переменной еще нет, getCompositeValue создает ее нулевой и молча дает ею пользоваться
    macro getValue() : RcbValue
        return getCompositeValue().fieldValue("value");
    end;

    macro setValue(capitalValue : Variant)
        var value = getCompositeValue().fieldValue("value");

        if (ValType(capitalValue) == V_MONEY)
            value.exact = capitalValue;
            value.recalculateScaled();
        else
            value.exact = capitalValue.exact;
            value.scaled = capitalValue.scaled;
        end;
    end;

    macro findValue()
        var context = RcbReportContext(RcbPeriod(getPreviousDate(), this.getDate()),
                                       m_currentReport.context.departmentCode,
                                       m_currentReport.context.issueMode,
                                       m_currentReport.context.organizationStructure,
                                       m_currentReport.context.isSummaryMode);

        var report = RcbApplication().objectFactory().createReport("Форма 134", context);

        if (not report.isRecorded())
            report.multiplier = m_currentReport.multiplier;

            report.dimension  = m_currentReport.dimension;

            report.registration();

            RcbApplication.TransactionManager.commit();

            report.reload();
        end;

        var av = report.attributeValue("ДанныеОтчета");
        var keyValue = av.createKeyValue();

        keyValue.fieldValue("part") = "1";
        keyValue.fieldValue("code") = "EqК";

        var compositeValue = av.findValue(keyValue);

        if (compositeValue == null)

            var value = $0.0;

            if (m_isFoundExistentCompositeValue)
                value = getValue();
            else
                while (value == $0)
                    if (getMoney(value, "Введите значение капитала за " + this.getDate(), 25))

                        if (value == $0)
                            if (not getTrue(true, "Введено нулевое значение капитала.|Повторить?"))
                                break;
                            end;
                        end;

                    else
                        RepErrorsQueue().add(0, "Значение капитала не определено|Расчет будет прерван");
                        msgbox("Значение капитала не определено|Расчет будет прерван");
                        установитьФлагВозврата(STOP_PROC_FLG);
                        exit(1, "Значение капитала не определено");
                    end;
                end;
            end;

            compositeValue = av.addValue();
            compositeValue.fieldValue("part").exact = "1";
            compositeValue.fieldValue("code").exact = "EqК";
            compositeValue.fieldvalue("moneyValue").exact = value;
        end;

        setValue(compositeValue.fieldvalue("moneyValue").exact);
        RcbApplication.TransactionManager.commit();
    end;

    /**
     * Пользовательский ввод значения капитала.
     */
    macro inputUserValue()
        var value = $0.0;
        while (value == $0)
            if (getMoney(value, "Введите значение капитала, действующее по состоянию на " + this.getDate(), 25))
                if (value == $0)
                    if (not getTrue(true, "Введено нулевое значение капитала.|Повторить?"))
                        break;
                    end;
                end;
            else
                RepErrorsQueue().add(0, "Значение капитала не определено|Расчет будет прерван");
                msgbox("Значение капитала не определено|Расчет будет прерван");
                установитьФлагВозврата(STOP_PROC_FLG);
                exit(1, "Значение капитала не определено");
            end;
        end;
        setValue(value);
        RcbApplication.TransactionManager.commit();
    end;

    /**
     * Установить значение капитала из системного справочника.
     */
    macro setValueOfCapital()
        var sumOfCapital = RcbCapital().getValue(this.getDate());

        if ((sumOfCapital != NULL) and (sumOfCapital != 0))
            setValue(sumOfCapital);
        else

            var printerController = TPrinterController(getExtendedPrefixForNameLogObject());
            printerController.create();
            var beginDate = RcbApplication().currentReport.context.period.beginDate();
            var endDate   = RcbApplication().currentReport.context.period.endDate();

            println();
            println("Форма 634. Отчет об открытых валютных позициях на конец операционного дня " + string(endDate:f));
            println("ПРОТОКОЛ РАСЧЕТА");
            println();
            println("   Период отчета с ", beginDate:f, " по ", endDate:f);
            println("   Исполнитель: ", Исполнитель);
            println("   Дата и время выпуска отчета ", Date():f, "  ", Time());
            println();

            println("В справочнике 'Размер собственных средств (капитал) банка'  на дату " + getCapitalDate() + " отсутствует значение капитала. " +
               "Необходимо ввести значение капитала на " + getCapitalDate() + " в справочник и после этого повторить расчет");

            printerController.show();

            exit(1, "Значение капитала не определено");
        end;
    end;

    macro getSettingIsEveryday()
        return m_isEveryday;
    end;

    initialize();
end;

class (TCapitalData) TCapitalData_3468(report : RcbReport)
    private macro constructorTCapitalData_3468(report : RcbReport)
        initTCapitalData(report);
    end;

    private macro getCapitalDate()
        var day   = 0;
        var month = 0;
        var year  = 0;

        dateSplit(m_report.context.period.endDate(), day, month, year);

        if (in(m_currentReport.context.period.kind, RCB_PK_DAY) or
           (in(m_currentReport.context.period.kind, RCB_PK_PERIOD) and (m_currentReport.context.period.endDate != Date(getDaysInMonth(m_report.context.period.endDate()), month, year))))
            if (m_isEveryday)
                return Date(day, month, year);
            end;

            return Date(1, month, year);
        end;

        if (month == 12)
            return Date(1, 1, year + 1);
        end;

        return Date(1, month + 1, year);
    end;

    constructorTCapitalData_3468(report);
end;
