/*
$Name:        f664Normalizer.mac
$Module:      Регламентируемая отчетность
$Description: Форма 664. Нормализация
*/

import Календарь;
import RcbLibrary;
import RcbProtocolView;
import rcbconst;
import ReptcbCommon;
import ReportNormalizer;
import ReportLinearRelation;
import RcbGlobal;
import balanceAttribute;

private class (ReportNormalizer) TF664PartReportNormalizer(multiplier)
    initReportNormalizer(multiplier);

    private var m_partNumber;
    private var m_attributeValue;
    private var m_attributeValueIteratorForTotal;
    private var m_protocolView;
    private var m_precisionMultiplier = multiplier;

    private macro getRcbReport()
        return RcbApplication().currentReport;
    end;

    private macro isLastDayInMonth(day : Date)
        var d;

        dateSplit(day + 1, d, NULL, NULL);

        return d == 1;
    end;

    /* за декаду и за месяц ДНОП всегда равно 1 числу отчетного месяца */
    private macro getPreviousReport()
        var day, month, year;
        var context;
        var previousReport;

        datesplit(rcbApplication().currentReport.context.period.endDate, day, month, year);

        if (((rcbApplication.currentReport.context.period.kind == RCB_PK_TEN_DAYS) and (day == 20)))
            context = RcbReportContext(RcbPeriod(date(1, month, year), date(day - 10, month, year)),
                                       getRcbReport().context.departmentCode,
                                       getRcbReport().context.issueMode,
                                       getRcbReport().context.organizationStructure,
                                       getRcbReport().context.isSummaryMode);

            previousReport = rcbApplication().objectFactory.createReport(getRcbReport().form.id, context);

        elif ((rcbApplication.currentReport.context.period.kind == RCB_PK_MONTH) and (isLastDayInMonth(RcbApplication().currentReport.context.period.endDate)))
            dateSplit(RcbApplication().currentReport.context.period.beginDate - 1, day, month, year);
            context = RcbReportContext(RcbPeriod(date(1, month, year), date(day, month, year)),
                                       getRcbReport().context.departmentCode,
                                       getRcbReport().context.issueMode,
                                       getRcbReport().context.organizationStructure,
                                       getRcbReport().context.isSummaryMode);

            previousReport = rcbApplication().objectFactory.createReport(getRcbReport().form.id, context);
        end;

        if (previousReport != null)
            if (previousReport.isCalculated)
                return previousReport;
            else
                m_protocolView.printFreeString("Отсутствует рассчитанная форма 664 за период с " + context.period.beginDate + " по " + context.period.endDate + ". Нормализация данных текущего отчетного периода с указанным периодом не выполнялась.");
            end;
        end;

        return null;
    end;
end;

class (TF664PartReportNormalizer) TF664Part_1_3_ReportNormalizer(partNumber, protocolView)
    private class TPart1Sorter()
        macro isLess(v1, v2)
            return ((v1.fieldValue("Код вида операции").exact <= v2.fieldValue("Код вида операции").exact)
                and (v1.fieldValue("Цифровой ISO-код валюты").exact < v2.fieldValue("Цифровой ISO-код валюты").exact)
                and (v1.fieldValue("Направление").exact < v2.fieldValue("Направление").exact));
        end;
    end;

    private class TFilterForTotalData()
        macro isSuitable(obj)
            return (obj.fieldValue("Код вида операции").currentAsString != "Остатки на начало отчетного периода")
               and (obj.fieldValue("Код вида операции").currentAsString != "Остатки на конец отчетного периода")
        end;
    end;

    private class TFilterForBeginData()
        macro isSuitable(obj)
            return (obj.fieldValue("Код вида операции").currentAsString == "Остатки на начало отчетного периода")
        end;
    end;

    private class TFilterForEndData()
        macro isSuitable(obj)
            return (obj.fieldValue("Код вида операции").currentAsString == "Остатки на конец отчетного периода")
        end;
    end;

    private class TFilterForRestsData(currency : String)
        private var m_currency = currency;

        macro isSuitable(obj)
            return ((obj.fieldValue("Код вида операции").currentAsString == "Остатки на начало отчетного периода") or (obj.fieldValue("Код вида операции").currentAsString == "Остатки на конец отчетного периода"))
               and (obj.fieldValue("Цифровой ISO-код валюты").currentAsString == m_currency)
        end;
    end;

    private class TFilterCurrencyKindDirection(currency : String, direction : String)
        private var m_currency  = currency;
        private var m_direction = direction;

        macro isSuitable(obj)
            return ((obj.fieldValue("Код вида операции").currentAsString != "Остатки на начало отчетного периода") and (obj.fieldValue("Код вида операции").currentAsString != "Остатки на конец отчетного периода"))
               and (obj.fieldValue("Направление").currentAsString == m_direction)
               and (obj.fieldValue("Цифровой ISO-код валюты").currentAsString == m_currency)
        end;
    end;

    private macro constructorTF664Part_1_3_ReportNormalizer(partNumber, protocolView)
        initTF664PartReportNormalizer(rcbApplication.currentReport.multiplier);

        m_partNumber = partNumber;
        if (m_partNumber == "1")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_1");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        elif (m_partNumber == "3БН")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_3_БН");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        elif (m_partNumber == "3ЮН")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_3_ЮН");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        end;

        m_attributeValueIteratorForTotal.setSortOrder(TPart1Sorter());
        m_attributeValueIteratorForTotal.setFilter(TFilterForTotalData());
        m_protocolView = protocolView;
    end;

    private macro getNodename(codeOperation, currencyCode, directionCode)
        return "Node_" + codeOperation + "_" + currencyCode + "_" + directionCode;
    end;

    private macro getPreviousReportAttributeValue()
        var attributeValue;
        var prevReport = getPreviousReport();

        if (prevReport != null)
            if (m_partNumber == "1")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_1");
            elif (m_partNumber == "3БН")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_3_БН");
            elif (m_partNumber == "3ЮН")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_3_ЮН");
            end;
        end;

        return attributeValue;
    end;

    private macro addRelationsForTotal()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var currentCurrency;

        m_attributeValueIteratorForTotal.moveFirst();

        while(not m_attributeValueIteratorForTotal.isDone())
            currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
            relation.rhs.plus(m_attributeValueIteratorForTotal.currentItem.fieldValue("Сумма").scaled * m_precisionMultiplier);
            var node = normalizer.addNode(getNodename(m_attributeValueIteratorForTotal.currentItem.fieldValue("Код вида операции").exact,
                                                      m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                      m_attributeValueIteratorForTotal.currentItem.fieldValue("Направление").exact));
            node.setExact(m_attributeValueIteratorForTotal.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
            node.recalculateScaled();
            relation.lhs.plus(node);

            m_attributeValueIteratorForTotal.moveNext();

            if (not m_attributeValueIteratorForTotal.isDone())
                if (currentCurrency != m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact)
                    this.addRelation(relation);
                    relation = ReportLinearRelation(RCB_RS_EQUAL);
                    currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                end;
            else
                this.addRelation(relation);
            end;
        end;
    end;

    private macro addRelationsForEndRests()
        var relation = ReportLinearRelation(RCB_RS_EQUAL);
        var currentCurrency;
        var nextCurrency;
        var attributeValueIteratorForRests;

        m_attributeValueIteratorForTotal.moveFirst();

        while(not m_attributeValueIteratorForTotal.isDone())
            if (m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact != "810")
                currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                var node = normalizer.addNode(getNodename(m_attributeValueIteratorForTotal.currentItem.fieldValue("Код вида операции").exact,
                                                          m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                          m_attributeValueIteratorForTotal.currentItem.fieldValue("Направление").exact));
                node.setExact(m_attributeValueIteratorForTotal.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                node.recalculateScaled();
                if (m_attributeValueIteratorForTotal.currentItem.fieldValue("Направление").exact == 1)
                    relation.lhs.plus(node);
                else
                    relation.lhs.minus(node);
                end;

                m_attributeValueIteratorForTotal.moveNext();

                if (not m_attributeValueIteratorForTotal.isDone())
                    nextCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                else
                    nextCurrency = null;
                end;

                if (currentCurrency != nextCurrency)
                    attributeValueIteratorForRests = m_attributeValue.createValueIterator();
                    attributeValueIteratorForRests.setFilter(TFilterForRestsData(currentCurrency));
                    attributeValueIteratorForRests.moveFirst();
                    while (not attributeValueIteratorForRests.isDone())
                        if (attributeValueIteratorForRests.currentItem.fieldValue("Код вида операции").currentAsString == "Остатки на начало отчетного периода")
                            relation.rhs.minus(attributeValueIteratorForRests.currentItem.fieldValue("Сумма").scaled * m_precisionMultiplier);
                        elif (attributeValueIteratorForRests.currentItem.fieldValue("Код вида операции").currentAsString == "Остатки на конец отчетного периода")
                            relation.rhs.plus(attributeValueIteratorForRests.currentItem.fieldValue("Сумма").scaled * m_precisionMultiplier);
                        end;
                        attributeValueIteratorForRests.moveNext()
                    end;

                    this.addRelation(relation);
                    relation = ReportLinearRelation(RCB_RS_EQUAL);
                    currentCurrency = nextCurrency;
                end;
            else
                m_attributeValueIteratorForTotal.moveNext();
            end;
        end;
    end;

    private macro addRelationsForMonthsQuart()
        var atributeValueWriteOffIterator; // списание
        var atributeValueEnrollIterator;   // зачисление
        var currentCurrency;
        var nextCurrency;
        var node;
        var relation;
        var sum;

        m_attributeValueIteratorForTotal.moveFirst();
        while(not m_attributeValueIteratorForTotal.isDone())
            currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;

            m_attributeValueIteratorForTotal.moveNext();
            if (not m_attributeValueIteratorForTotal.isDone())
                nextCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
            else
                nextCurrency = null;
            end;

            if (currentCurrency != nextCurrency)
                atributeValueWriteOffIterator = m_attributeValue.createValueIterator();
                atributeValueWriteOffIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "0"));
                atributeValueEnrollIterator = m_attributeValue.createValueIterator();
                atributeValueEnrollIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "1"));

                if (atributeValueWriteOffIterator.count > 0)
                    sum = 0;
                    atributeValueWriteOffIterator.moveFirst();
                    relation = ReportLinearRelation(RCB_RS_EQUAL);
                    while(not atributeValueWriteOffIterator.isDone)
                        node = normalizer.addNode(getNodename(atributeValueWriteOffIterator.currentItem.fieldValue("Код вида операции").exact,
                                                              atributeValueWriteOffIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                              atributeValueWriteOffIterator.currentItem.fieldValue("Направление").exact));
                        node.setExact(atributeValueWriteOffIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                        node.recalculateScaled();
                        relation.lhs.plus(node);

                        sum = sum + atributeValueWriteOffIterator.currentItem.fieldValue("Сумма").scaled * m_precisionMultiplier;

                        atributeValueWriteOffIterator.moveNext();
                    end;
                    relation.rhs.plus(sum);
                    this.addRelation(relation);
                end;
                if (atributeValueEnrollIterator.count > 0)
                    sum = 0;
                    atributeValueEnrollIterator.moveFirst();
                    relation = ReportLinearRelation(RCB_RS_EQUAL);
                    while(not atributeValueEnrollIterator.isDone)
                        node = normalizer.addNode(getNodename(atributeValueEnrollIterator.currentItem.fieldValue("Код вида операции").exact,
                                                              atributeValueEnrollIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                              atributeValueEnrollIterator.currentItem.fieldValue("Направление").exact));
                        node.setExact(atributeValueEnrollIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                        node.recalculateScaled();
                        relation.lhs.plus(node);

                        sum = sum + atributeValueEnrollIterator.currentItem.fieldValue("Сумма").scaled * m_precisionMultiplier;

                        atributeValueEnrollIterator.moveNext();
                    end;
                    relation.rhs.plus(sum);
                    this.addRelation(relation);
                end;

                currentCurrency = nextCurrency;
            end;
        end;
    end;

    private macro addRulesRestsForPreviousReport()
        var prevReport = getPreviousReport();
        var beginRestsIterator;
        var endRestsIterator;
        var currentCurrency;
        var nextCurrency;
        var node;
        var relation;

        if (prevReport != null)
            m_attributeValueIteratorForTotal.moveFirst();
            while(not m_attributeValueIteratorForTotal.isDone())
                currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;

                m_attributeValueIteratorForTotal.moveNext();

                if (not m_attributeValueIteratorForTotal.isDone())
                    nextCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                else
                    nextCurrency = null;
                end;

                if (currentCurrency != nextCurrency)
                    beginRestsIterator = m_attributeValue.createValueIterator();
                    beginRestsIterator.setFilter(TFilterForBeginData);
                    endRestsIterator = getPreviousReportAttributeValue().createValueIterator();
                    if (endRestsIterator != null)
                        endRestsIterator.setFilter(TFilterForEndData);

                        if ((beginRestsIterator != null) and (endRestsIterator != null))
                            if ((beginRestsIterator.count > 0) and (endRestsIterator.count > 0))
                                beginRestsIterator.moveFirst();
                                relation = ReportLinearRelation(RCB_RS_EQUAL);
                                while(not beginRestsIterator.isDone)
                                    node = normalizer.addNode(getNodename(beginRestsIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                          beginRestsIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                          beginRestsIterator.currentItem.fieldValue("Направление").exact));
                                    node.setExact(beginRestsIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                    node.recalculateScaled();
                                    relation.lhs.plus(node);
                                    beginRestsIterator.moveNext();
                                end;

                                endRestsIterator.moveFirst();
                                while(not endRestsIterator.isDone)
                                    node = normalizer.addNode(getNodename(endRestsIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                          endRestsIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                          endRestsIterator.currentItem.fieldValue("Направление").exact));
                                    node.setExact(endRestsIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                    node.recalculateScaled();
                                    relation.rhs.plus(node);
                                    endRestsIterator.moveNext();
                                end;

                                this.addRelation(relation);
                            end;
                        end;
                    end;

                    currentCurrency = nextCurrency;
                end;
            end;
        end;
    end;

    macro addRuslesForThirdQuartAndMonth()
        var prevReport = getPreviousReport();
        var atributeValueWriteOffIterator;          // списание
        var atributeValueWriteOffPreviousIterator;  // списание с предыдущего периода
        var atributeValueEnrollIterator;            // зачисление
        var atributeValueEnrollPreviousIterator;    // зачисление с предыдущего периода
        var beginRestsIterator;
        var beginPreviousRestsIterator;
        var currentCurrency;
        var nextCurrency;
        var node;
        var relation;

        if (prevReport != null)
            m_attributeValueIteratorForTotal.moveFirst();
            while(not m_attributeValueIteratorForTotal.isDone())
                currentCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;

                m_attributeValueIteratorForTotal.moveNext();

                if (not m_attributeValueIteratorForTotal.isDone())
                    nextCurrency = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                else
                    nextCurrency = null;
                end;

                if (currentCurrency != nextCurrency)
                    atributeValueWriteOffIterator = m_attributeValue.createValueIterator();
                    atributeValueWriteOffIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "0"));
                    atributeValueWriteOffPreviousIterator = getPreviousReportAttributeValue().createValueIterator();
                    if (atributeValueWriteOffPreviousIterator != null)
                        atributeValueWriteOffPreviousIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "0"));

                        if ((atributeValueWriteOffIterator.count > 0) and (atributeValueWriteOffPreviousIterator.count > 0))
                             atributeValueWriteOffIterator.moveFirst();
                             relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                            while(not atributeValueWriteOffIterator.isDone)
                                node = normalizer.addNode(getNodename(atributeValueWriteOffIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                      atributeValueWriteOffIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                      atributeValueWriteOffIterator.currentItem.fieldValue("Направление").exact));
                                node.setExact(atributeValueWriteOffIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                node.recalculateScaled();
                                relation.lhs.plus(node);
                                atributeValueWriteOffIterator.moveNext();
                            end;

                            atributeValueWriteOffPreviousIterator.moveFirst();
                            while(not atributeValueWriteOffPreviousIterator.isDone)
                                node = normalizer.addNode(getNodename(atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                      atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                      atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Направление").exact));
                                node.setExact(atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                node.recalculateScaled();
                                relation.rhs.plus(node);
                                atributeValueWriteOffPreviousIterator.moveNext();
                            end;

                            this.addRelation(relation);
                        end;
                    end;

                    atributeValueEnrollIterator = m_attributeValue.createValueIterator();
                    atributeValueEnrollIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "0"));
                    atributeValueEnrollPreviousIterator = getPreviousReportAttributeValue().createValueIterator();
                    if (atributeValueEnrollPreviousIterator != null)
                        atributeValueEnrollPreviousIterator.setFilter(TFilterCurrencyKindDirection(currentCurrency, "0"));

                        if ((atributeValueEnrollIterator.count > 0) and (atributeValueEnrollPreviousIterator.count > 0))
                             atributeValueEnrollIterator.moveFirst();
                             relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                            while(not atributeValueEnrollIterator.isDone)
                                node = normalizer.addNode(getNodename(atributeValueEnrollIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                      atributeValueEnrollIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                      atributeValueEnrollIterator.currentItem.fieldValue("Направление").exact));
                                node.setExact(atributeValueEnrollIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                node.recalculateScaled();
                                relation.lhs.plus(node);
                                atributeValueEnrollIterator.moveNext();
                            end;

                            atributeValueEnrollPreviousIterator.moveFirst();
                            while(not atributeValueEnrollPreviousIterator.isDone)
                                node = normalizer.addNode(getNodename(atributeValueEnrollPreviousIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                      atributeValueEnrollPreviousIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                      atributeValueEnrollPreviousIterator.currentItem.fieldValue("Направление").exact));
                                node.setExact(atributeValueEnrollPreviousIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                node.recalculateScaled();
                                relation.rhs.plus(node);
                                atributeValueEnrollPreviousIterator.moveNext();
                            end;

                            this.addRelation(relation);
                        end;
                    end;

                    beginRestsIterator = m_attributeValue.createValueIterator();
                    beginRestsIterator.setFilter(TFilterForBeginData);
                    beginPreviousRestsIterator = getPreviousReportAttributeValue().createValueIterator();
                    if (beginPreviousRestsIterator != null)
                        beginPreviousRestsIterator.setFilter(TFilterForBeginData);

                        if ((beginRestsIterator != null) and (beginPreviousRestsIterator != null))
                            if ((beginRestsIterator.count > 0) and (beginPreviousRestsIterator.count > 0))
                                beginRestsIterator.moveFirst();
                                relation = ReportLinearRelation(RCB_RS_EQUAL);
                                while(not beginRestsIterator.isDone)
                                    node = normalizer.addNode(getNodename(beginRestsIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                          beginRestsIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                          beginRestsIterator.currentItem.fieldValue("Направление").exact));
                                    node.setExact(beginRestsIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                    node.recalculateScaled();
                                    relation.lhs.plus(node);
                                    beginRestsIterator.moveNext();
                                end;

                                beginPreviousRestsIterator.moveFirst();
                                while(not beginPreviousRestsIterator.isDone)
                                    node = normalizer.addNode(getNodename(beginPreviousRestsIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                          beginPreviousRestsIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                          beginPreviousRestsIterator.currentItem.fieldValue("Направление").exact));
                                    node.setExact(beginPreviousRestsIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                                    node.recalculateScaled();
                                    relation.rhs.plus(node);
                                    beginPreviousRestsIterator.moveNext();
                                end;

                                this.addRelation(relation);
                            end;
                        end;
                    end;
                    currentCurrency = nextCurrency;
                end;
            end;
        end;
    end;

    private macro save()
        var attributeValueIterator = m_attributeValue.createValueIterator();

        attributeValueIterator.moveFirst();
        while(not attributeValueIterator.isDone())
            var nodeName = getNodename(attributeValueIterator.currentItem.fieldValue("Код вида операции").exact,
                                       attributeValueIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                       attributeValueIterator.currentItem.fieldValue("Направление").exact);
            var node     = normalizer.node(nodeName);

            if (node != null)
                m_protocolView.printString(nodeName, attributeValueIterator.currentItem.fieldValue("Сумма").exact, attributeValueIterator.currentItem.fieldValue("Сумма").scaled, node.getScaled() / m_precisionMultiplier);
                attributeValueIterator.currentItem.fieldValue("Сумма").scaled = node.getScaled() * 55 / m_precisionMultiplier;
            end;

            attributeValueIterator.moveNext();
        end;
    end;

    macro execute()
        if (   (RcbApplication().currentReport.context.period.kind == RCB_PK_TEN_DAYS)
            or (RcbApplication().currentReport.context.period.kind == RCB_PK_MONTH))
            addRelationsForTotal();
            addRelationsForEndRests();
            addRelationsForMonthsQuart();
            addRuslesForThirdQuartAndMonth();
            addRulesRestsForPreviousReport();

            normalize();

            if (isNormalized())
                save();
            else
                m_protocolView.printBottom();
                m_protocolView.printLine("Данные нормализовать не удалось.(смотри лог-файл:" + getLogFilePath() + ").");
            end;

            RcbApplication().transactionManager.commit();
        end;
    end;

    constructorTF664Part_1_3_ReportNormalizer(partNumber, protocolView);
end;

class (TF664PartReportNormalizer) TF664Part_2_4_ReportNormalizer(partNumber, protocolView)

    private class TPartSorter()
        macro isLess(v1, v2)
            return (    (v1.fieldValue("Код страны").exact <= v2.fieldValue("Код страны").exact)
                    and (v1.fieldValue("Цифровой ISO-код валюты").exact < v2.fieldValue("Цифровой ISO-код валюты").exact)
                    and (v1.fieldValue("Код вида операции").exact < v2.fieldValue("Код вида операции").exact)
                    and (v1.fieldValue("Направление").exact < v2.fieldValue("Направление").exact));
        end;
    end;

    private class TFilter(country : String, currency : String, codeOperation : String, direction : String)
        private var m_country = country;
        private var m_currency = currency;
        private var m_codeOperation = codeOperation;
        private var m_direction = direction;

        macro isSuitable(obj)
            return (obj.fieldValue("Код страны").currentAsString == m_country)
               and (obj.fieldValue("Код вида операции").currentAsString == m_codeOperation)
               and (obj.fieldValue("Направление").currentAsString == m_direction)
               and (obj.fieldValue("Цифровой ISO-код валюты").currentAsString == m_currency)
        end;
    end;

    private macro constructorTF664Part_2_4_ReportNormalizer(partNumber, protocolView)
        initTF664PartReportNormalizer(rcbApplication.currentReport.multiplier);

        m_partNumber = partNumber;
        if (m_partNumber == "2")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_2");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        elif (m_partNumber == "4БН")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_4_БН");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        elif (m_partNumber == "4ЮН")
            m_attributeValue = RcbApplication().currentReport.attributeValue("Ф664_Раздел_4_ЮН");
            m_attributeValueIteratorForTotal = m_attributeValue.createValueIterator();
        end;

        m_attributeValueIteratorForTotal.setSortOrder(TPartSorter());
        m_protocolView = protocolView;
    end;

    private macro getPreviousReportAttributeValue()
        var attributeValue;
        var prevReport = getPreviousReport();

        if (prevReport != null)
            if (m_partNumber == "2")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_2");
            elif (m_partNumber == "4БН")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_4_БН");
            elif (m_partNumber == "4ЮН")
                attributeValue = prevReport.attributeValue("Ф664_Раздел_4_ЮН");
            end;
        end;

        return attributeValue;
    end;

    private macro getNodeName(country, currencyCode, codeOperation, directionCode)
        return "Node_" + country + "_" + currencyCode + "_" + codeOperation + "_" + directionCode;
    end;

    macro addRuslesForThirdQuartAndMonth()
        var prevReport = getPreviousReport();
        var atributeValueWriteOffIterator;          // списание
        var atributeValueWriteOffPreviousIterator;  // списание с предыдущего периода
        var atributeValueEnrollIterator;            // зачисление
        var atributeValueEnrollPreviousIterator;    // зачисление с предыдущего периода
        var currentCountry;
        var currentCurrency;
        var currentCode;
        var currentDirection;
        var node;
        var relation;

        if (prevReport != null)
            m_attributeValueIteratorForTotal.moveFirst();
            while(not m_attributeValueIteratorForTotal.isDone())
                currentCountry   = m_attributeValueIteratorForTotal.currentItem.fieldValue("Код страны").exact;
                currentCurrency  = m_attributeValueIteratorForTotal.currentItem.fieldValue("Цифровой ISO-код валюты").exact;
                currentCode      = m_attributeValueIteratorForTotal.currentItem.fieldValue("Код вида операции").exact;
                currentDirection = m_attributeValueIteratorForTotal.currentItem.fieldValue("Направление").exact;

                atributeValueWriteOffIterator = m_attributeValue.createValueIterator();
                atributeValueWriteOffIterator.setFilter(TFilter(currentCountry, currentCurrency, currentCode, currentDirection));
                atributeValueWriteOffPreviousIterator = getPreviousReportAttributeValue().createValueIterator();
                if (atributeValueWriteOffPreviousIterator != null)
                    atributeValueWriteOffPreviousIterator.setFilter(TFilter(currentCountry, currentCurrency, currentCode, currentDirection));

                    if ((atributeValueWriteOffIterator.count > 0) and (atributeValueWriteOffPreviousIterator.count > 0))
                         atributeValueWriteOffIterator.moveFirst();
                         relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                        while(not atributeValueWriteOffIterator.isDone)
                            node = normalizer.addNode(getNodename(atributeValueWriteOffIterator.currentItem.fieldValue("Код страны").exact,
                                                                  atributeValueWriteOffIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                  atributeValueWriteOffIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                  atributeValueWriteOffIterator.currentItem.fieldValue("Направление").exact));
                            node.setExact(atributeValueWriteOffIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                            node.recalculateScaled();
                            relation.lhs.plus(node);
                            atributeValueWriteOffIterator.moveNext();
                        end;

                        atributeValueWriteOffPreviousIterator.moveFirst();
                        while(not atributeValueWriteOffPreviousIterator.isDone)
                            node = normalizer.addNode(getNodename(atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Код страны").exact,
                                                                  atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                  atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                  atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Направление").exact));
                            node.setExact(atributeValueWriteOffPreviousIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                            node.recalculateScaled();
                            relation.rhs.plus(node);
                            atributeValueWriteOffPreviousIterator.moveNext();
                        end;

                        this.addRelation(relation);
                    end;
                end;

                atributeValueEnrollIterator = m_attributeValue.createValueIterator();
                atributeValueEnrollIterator.setFilter(TFilter(currentCountry, currentCurrency, currentCode, currentDirection));
                atributeValueEnrollPreviousIterator = getPreviousReportAttributeValue().createValueIterator();
                if (atributeValueEnrollPreviousIterator != null)
                    atributeValueEnrollPreviousIterator.setFilter(TFilter(currentCountry, currentCurrency, currentCode, currentDirection));

                    if ((atributeValueEnrollIterator.count > 0) and (atributeValueEnrollPreviousIterator.count > 0))
                         atributeValueEnrollIterator.moveFirst();
                         relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                        while(not atributeValueEnrollIterator.isDone)
                            node = normalizer.addNode(getNodename(atributeValueEnrollIterator.currentItem.fieldValue("Код страны").exact,
                                                                  atributeValueEnrollIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                  atributeValueEnrollIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                  atributeValueEnrollIterator.currentItem.fieldValue("Направление").exact));
                            node.setExact(atributeValueEnrollIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                            node.recalculateScaled();
                            relation.lhs.plus(node);
                            atributeValueEnrollIterator.moveNext();
                        end;

                        atributeValueEnrollPreviousIterator.moveFirst();
                        while(not atributeValueEnrollPreviousIterator.isDone)
                            node = normalizer.addNode(getNodename(atributeValueEnrollPreviousIterator.currentItem.fieldValue("Код страны").exact,
                                                                  atributeValueEnrollPreviousIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                                                  atributeValueEnrollPreviousIterator.currentItem.fieldValue("Код вида операции").exact,
                                                                  atributeValueEnrollPreviousIterator.currentItem.fieldValue("Направление").exact));
                            node.setExact(atributeValueEnrollPreviousIterator.currentItem.fieldValue("Сумма").exact * m_precisionMultiplier);
                            node.recalculateScaled();
                            relation.rhs.plus(node);
                            atributeValueEnrollPreviousIterator.moveNext();
                        end;

                        this.addRelation(relation);
                    end;
                end;

                m_attributeValueIteratorForTotal.moveNext();
            end;
        end;
    end;

    private macro save()
        var attributeValueIterator = m_attributeValue.createValueIterator();

        attributeValueIterator.moveFirst();

        while(not attributeValueIterator.isDone())
            var nodeName = getNodename(attributeValueIterator.currentItem.fieldValue("Код страны").exact,
                                       attributeValueIterator.currentItem.fieldValue("Цифровой ISO-код валюты").exact,
                                       attributeValueIterator.currentItem.fieldValue("Код вида операции").exact,
                                       attributeValueIterator.currentItem.fieldValue("Направление").exact);
            var node = normalizer.node(nodeName);

            if (node != null)
                m_protocolView.printString(nodeName, attributeValueIterator.currentItem.fieldValue("Сумма").exact, attributeValueIterator.currentItem.fieldValue("Сумма").scaled, node.getScaled() / m_precisionMultiplier);
                attributeValueIterator.currentItem.fieldValue("Сумма").scaled = node.getScaled() / m_precisionMultiplier;
            end;

            attributeValueIterator.moveNext();
        end;
    end;

    macro execute()
        if (   (RcbApplication().currentReport.context.period.kind == RCB_PK_TEN_DAYS)
            or (RcbApplication().currentReport.context.period.kind == RCB_PK_MONTH))
            addRuslesForThirdQuartAndMonth();
            normalize();

            if (isNormalized())
                save();
            else
                m_protocolView.printBottom();
                m_protocolView.printLine("Данные нормализовать не удалось.(смотри лог-файл:" + getLogFilePath() + ").");
            end;

            RcbApplication().transactionManager.commit();
        end;
    end;

    constructorTF664Part_2_4_ReportNormalizer(partNumber, protocolView);
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);