/*
$Name:          f664Global.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 664. Класс глобализмов
*/
/**
 * Форма 664. Класс глобализмов.
 *
 * @since   03.10.2012
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

/**
 * Глобальные данные для формы
 */
class (TGlobalBase) TGlobal()

    private var m_rcbReport;

    macro getRcbReport() : RcbReport
        return m_rcbReport;
    end;

    macro initializeRepDataPackage(report : RcbReport)
        var tenDayBeginDate;
        var month, year;

        dateSplit(report.context.period.beginDate, null, month, year);
        tenDayBeginDate = Date(01, month, year);

        defaultParm(report, rcbApplication.currentReport);

        sql_truncate("drepdepartment_tmp");

        sql_execute("CALL rep_data.setBalancePlanNumber(" + rcbApplication.parameters.balancePlanNumber + ")");

        if (report.context.period.kind == RCB_PK_TEN_DAYS)
            sql_execute("CALL rep_data.setBeginDate(" + getSqlDate(tenDayBeginDate) + ")");
            sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(tenDayBeginDate)+", 'DD.MM.YYYY')))");
        else
            sql_execute("CALL rep_data.setBeginDate(" + getSqlDate(report.context.period.beginDate) + ")");
            sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.beginDate)+", 'DD.MM.YYYY')))");
        end;

        sql_execute("CALL rep_data.setEndDate("   + getSqlDate(report.context.period.endDate)   + ")");
        sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.endDate)+", 'DD.MM.YYYY')))");

        sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(rcbDepartmentList.getAsSqlSetFilial()) + ", "
                                                       + getSqlString(rcbDepartmentList.getAsSqlSetVsp()) + ")");

    end;

    private macro constructor()
        initTGlobalBase();
        m_rcbReport = rcbApplication.currentReport;
        initializeRepDataPackage(m_rcbReport);
    end;

    constructor();

end;

macro global()
    if (v_global == null)
        v_global = TGlobal();
    end;
    return v_global;
end;
