/**
 * Форма 664. Контроллер расчета отчета.
 *
 * @since   03.10.2012
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

/**
 *  Контроллер расчета разделов 1 и 2
 */
class TCalculateIssue12(parameters : TParameters)

    private var m_parameters;

    macro constructorTCalculateIssue12(parameters : TParameters);
        m_parameters = parameters;
    end;

    macro calculate(tunetable)
        var rests = TDataSourceCbRestsIssue12(m_parameters);
        var turns = TDataSourceCbTurnsIssue12(m_parameters, rests.getTempTable(), tuneTable);

        rests.fillTempTable();
        turns.fillTempTable();
    end;

    constructorTCalculateIssue12(parameters)
end;

/**
 *  Контроллер расчета разделов 3 и 4
 */
class TCalculateIssue34(parameters : TParameters)

    private var m_parameters;

    macro constructorTCalculateIssue34(parameters : TParameters)
        m_parameters = parameters;
    end;

    macro calculate(tuneTable1 : RcbTuneTable, tuneTable2 : RcbTuneTable)
        var rests = TDataSourceCbRestsIssue34(m_parameters, tuneTable1);
        var turns = TDataSourceCbTurnsIssue34(m_parameters, rests.getTempTable(), tuneTable2);

        rests.fillTempTable();
        turns.fillTempTable();
    end;

    constructorTCalculateIssue34(parameters);
end;

/**
 *  Контроллер расчета
 */
class TReportCalculateController_2867()

    macro calculate()
        TRestsTempTable().truncate();
        TTurnsTempTable().truncate();
        global();

        var parameters = TParametersCbIssue12();
        var tunetable2 = RcbTuneTable("dt664cp_dbt");

        // настроечная таблица <Комиссии и проценты по проводкам>
        tunetable2.setInstructionFilter(RCB_I2867_DATE);

        BegAction(2000, "Расчет переменных разделов 1 и 2 по данным ГКБО");
            TCalculateIssue12(parameters).calculate(tunetable2);
        EndAction(1000);

        // настроечная таблица <Счета нерезидентов для 3 и 4 разделов>
        var tunetable1 = RcbTuneTable("dt664h_dbt");
        tunetable1.setInstructionFilter(RCB_I2867_DATE);
        var bo_cb = TBackOffice(BOCB);

        if (tuneTable1.hasDataFor(bo_cb, "t_backOffice"))
            BegAction(2000, "Расчет переменных разделов 3 и 4 (БН) по данным ГКБО");
            TCalculateIssue34(TParametersCbIssue34(ACCOUNT_KIND_BN)).calculate(tuneTable1, tunetable2);
            EndAction(1000);

            BegAction(2000, "Расчет переменных разделов 3 и 4 (ЮН) по данным ГКБО");
            TCalculateIssue34(TParametersCbIssue34(ACCOUNT_KIND_UN)).calculate(tuneTable1, tunetable2);
            EndAction(1000);
        end;

        // сохранение переменных
        TVariablesSaverController().save();

        // печать протокола 
        TProtocolPrintController_2867().view();
    end;

end;






















