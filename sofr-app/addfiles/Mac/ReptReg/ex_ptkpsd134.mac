/*
$Name: ex_ptkpsd134.mac
$Module: Регламентируемая отчетность
$Description: Форма 134. Контроллер экспорта данных отчета в АС ПСД.
*/

import RcbProtocolView;
import RcbPtkPsdView;

class (TPtkPsdView) T134PtkPsdView()
    initTPtkPsdView("134", RcbApplication.currentReport.context.period.endDate+1);
end;

/**
 * Операция экспорта в ПТК ПСД для раздела.
 */
class TPtkPsdExportPartController(view, part, head) 

    private const m_columnCode       = "7";
    private var   m_view             = view;         //представление печати
    private var   m_part             = part;         //раздел
    private var   m_applicationCode  = head;         //заголовок раздела
    private var   m_stringCode       = TArray;       //массив возможных значений кода строки
    private var   m_variableName     = TArray;       //массив имен переменных формы

    private var m_report = rcbApplication.currentReport;

    private macro arrayInitialize()
        m_stringCode[m_stringCode.size] = "000";    m_variableName[m_variableName.size] = "EqК";
        m_stringCode[m_stringCode.size] = "101";    m_variableName[m_variableName.size] = "Eq2_1_1__2_1_2";
        m_stringCode[m_stringCode.size] = "102";    m_variableName[m_variableName.size] = "Eq2_1_3__2_1_4";
        m_stringCode[m_stringCode.size] = "103";    m_variableName[m_variableName.size] = "Eq2_1_5";
        m_stringCode[m_stringCode.size] = "104";    m_variableName[m_variableName.size] = "Eq2_1_6";
        m_stringCode[m_stringCode.size] = "104.1";  m_variableName[m_variableName.size] = "Eq2_1_6переоценка";
        m_stringCode[m_stringCode.size] = "105";    m_variableName[m_variableName.size] = "Eq2_1_7";
        m_stringCode[m_stringCode.size] = "106";    m_variableName[m_variableName.size] = "Eq2_1_11";
        m_stringCode[m_stringCode.size] = "107";    m_variableName[m_variableName.size] = "Eq2_1_12";
        m_stringCode[m_stringCode.size] = "108";    m_variableName[m_variableName.size] = "EqИстОсн";
        m_stringCode[m_stringCode.size] = "109";    m_variableName[m_variableName.size] = "Eq2_2_1";
        m_stringCode[m_stringCode.size] = "110";    m_variableName[m_variableName.size] = "Eq2_2_2__2_2_3";
        m_stringCode[m_stringCode.size] = "111";    m_variableName[m_variableName.size] = "Eq2_2_4";
        m_stringCode[m_stringCode.size] = "112";    m_variableName[m_variableName.size] = "Eq2_2_5";
        m_stringCode[m_stringCode.size] = "112.1";  m_variableName[m_variableName.size] = "Eq2_2_5переоценка";
        m_stringCode[m_stringCode.size] = "113";    m_variableName[m_variableName.size] = "Eq2_2_6";
        m_stringCode[m_stringCode.size] = "114";    m_variableName[m_variableName.size] = "Eq2_2_8";
        m_stringCode[m_stringCode.size] = "115";    m_variableName[m_variableName.size] = "Eq2_2_9";
        m_stringCode[m_stringCode.size] = "116";    m_variableName[m_variableName.size] = "EqОсн";
        m_stringCode[m_stringCode.size] = "201";    m_variableName[m_variableName.size] = "Eq3_1";
        m_stringCode[m_stringCode.size] = "202";    m_variableName[m_variableName.size] = "Eq3_3";
        m_stringCode[m_stringCode.size] = "203";    m_variableName[m_variableName.size] = "Eq3_4";
        m_stringCode[m_stringCode.size] = "203.1";  m_variableName[m_variableName.size] = "Eq3_4переоценка";
        m_stringCode[m_stringCode.size] = "204";    m_variableName[m_variableName.size] = "Eq3_5";
        m_stringCode[m_stringCode.size] = "205";    m_variableName[m_variableName.size] = "Eq3_6";
        m_stringCode[m_stringCode.size] = "206";    m_variableName[m_variableName.size] = "Eq3_7";
        m_stringCode[m_stringCode.size] = "207";    m_variableName[m_variableName.size] = "Eq3_9";
        m_stringCode[m_stringCode.size] = "208";    m_variableName[m_variableName.size] = "Eq3_10";
        m_stringCode[m_stringCode.size] = "209";    m_variableName[m_variableName.size] = "EqИстДоп";
        m_stringCode[m_stringCode.size] = "210";    m_variableName[m_variableName.size] = "EqДоп";
        m_stringCode[m_stringCode.size] = "301";    m_variableName[m_variableName.size] = "Eq4_1";
        m_stringCode[m_stringCode.size] = "302";    m_variableName[m_variableName.size] = "Eq4_2";
        m_stringCode[m_stringCode.size] = "303";    m_variableName[m_variableName.size] = "Eq4_3";
        m_stringCode[m_stringCode.size] = "304";    m_variableName[m_variableName.size] = "Eq4_5";
        m_stringCode[m_stringCode.size] = "305";    m_variableName[m_variableName.size] = "Eq4_6";
        m_stringCode[m_stringCode.size] = "400";    m_variableName[m_variableName.size] = "EqПром";
        m_stringCode[m_stringCode.size] = "501";    m_variableName[m_variableName.size] = "Eq5_1";
        m_stringCode[m_stringCode.size] = "502";    m_variableName[m_variableName.size] = "Eq5_2";
        m_stringCode[m_stringCode.size] = "503";    m_variableName[m_variableName.size] = "Eq5_3";
    end;

    macro execute()
        var attributeValue;
        var i;
        arrayInitialize();
        if (m_part == 1)
            i = 0;
            while (i < m_variableName.size)
                attributeValue = m_report.attributeValue(m_variableName[i]);
                if (attributeValue != null)
                    m_view.printRow(m_applicationCode,             
                                    m_stringCode[i], 
                                    m_columnCode,          
                                    attributeValue.scaledAsString);  
                end;
                i=i+1;
            end;          
        end;
    end; 
end;  

/**
 * Операция экспорта в АС ПСД отчета.
 */
class  T134PtkPsdExportController()

    private var m_ptkPsdExportPartControllers : TArray;
    private var m_ptkPsdView;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = genObject("T134PtkPsdView"); 
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView, 1, "F134");
    end;                                         

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;
        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

private macro executePtkPsdExportOperation()
    T134PtkPsdExportController().execute();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);









