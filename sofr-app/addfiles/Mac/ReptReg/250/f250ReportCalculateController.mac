/*
$Name:          f250ReportCalculateController.mac
$Module:        ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
$Description:   ”®à¬  250. Š®­âà®««¥à à áç¥â  ®âç¥â 
*/

/**
 * @since   02.10.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (RcbReportCalculateController) TF250ReportCalculateController()
    initRcbReportCalculateController();

    m_protocolView = objectFactoryInstance.createCalculateProtocolView("’Š‹ €‘—…’€");

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF250Part1SubPart1CalculateController(this));
        m_partCalculateControllers.push_back(TF250Part1SubPart2CalculateController(this));
        m_partCalculateControllers.push_back(TF250Part2CalculateController(this));
    end;

    macro initialize() : Bool
        global().initializeRepDataPackage(global().getRcbReport());
        global.getRcbReport().attributeValue(" §¤¥«1_®¤à §¤¥«1").removeAllValues();
        global.getRcbReport().attributeValue(" §¤¥«1_®¤à §¤¥«2").removeAllValues();
        global.getRcbReport().attributeValue(" §¤¥«2").removeAllValues();

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;

    private macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        var calculationDataPool = calculationAttributeData.getCalculationDataPool();

        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationDataPool.getCurrentItem().calculate();
        end;

        calculationAttributeData.setCalculated();
    end;

    macro service()
        var dataSource = getDataSources().getDataSource("1.1").getPaymentSystem();

        global.getRcbReport().attributeValue(" §¤¥«1_®¤à §¤¥«1_‚¢®¤").removeAllValues();
        global.getRcbReport().attributeValue(" §¤¥«2_‚¢®¤").removeAllValues();

        getReport().getPart("1.1").defineUserAtribute(dataSource);

        dataSource = getDataSources().getDataSource("2").getPaymentSystem();

        getReport().getPart("2").defineUserAtribute(dataSource);
    end;

    macro calculate() : Bool
        initialize();

        m_protocolView.setProtocolOutput(m_isUseAvailableReport);

        if (not m_isUseAvailableReport)
            m_protocolView.printHead();
        end;

        m_protocolView.printLine(getProtocolText());


        initProgress(m_partCalculateControllers.getCount(), "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ", "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå", "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_calculationDataPool.getCount(), "‚ë¯®«­¥­¨¥ à áç¥â ", "‚ë¯®«­¥­¨¥ à áç¥â ");
        m_calculationDataPool.moveFirst();

        remProgress();

        if (not m_isUseAvailableReport)
            m_protocolView.resetProtocolOutput();
        end;

        initProgress(-1, "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå", "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå");
        RcbApplication.TransactionManager.commit();
        remProgress();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;
end;