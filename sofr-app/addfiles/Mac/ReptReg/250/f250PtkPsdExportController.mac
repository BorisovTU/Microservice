/*
$Name:          f250PtkPsdExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 250. Контроллер экспорта в АС ПСД
*/

/**
 * @since   02.10.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (TPtkPsdView) TF250PtkPsdView(fileExtension : String, reportDate : Date, encoding : String)
    initTPtkPsdView(fileExtension, reportDate, encoding);
    EOL = "";
end;

class (RcbPtkPsdExportController) TF250PtkPsdExportController()
    initRcbPtkPsdExportController("250", objectFactoryInstance.createReport(RcbApplication.currentReport), "Форма 250");
    m_view = TF250PtkPsdView("250", m_report.getPeriod().endDate, "rsansi");

    private macro printStringPart11(applCode : String, codeLine : String, rowNumber, attribute, okato)

        okato = okato + MkStr("0", 5 - strlen(String(okato))) ;

        if ((applCode == "F250_R1_1") and (attribute.getCodePaymentSystem() == ""))
            return;
        end;

        if (applCode == "F250_R1_1")
            m_view.printRow(applCode, codeLine, "1", rowNumber, okato);

            if   (attribute.getLineDescribe() == m_report.getPart("1.1").TOTAL_FOR)
                m_view.printRow(applCode, codeLine, "3", "0", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").PAYMENT_CARDS)
                m_view.printRow(applCode, codeLine, "3", "1", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").PAYMENT_CARDS_OVERDRAFT)
                m_view.printRow(applCode, codeLine, "3", "11", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").CREDIT_CARDS)
                m_view.printRow(applCode, codeLine, "3", "3", okato);
            end;

            m_view.printRow(applCode, codeLine, "$name$", attribute.getCodePaymentSystem(), okato);
        end;

        m_view.printRow(applCode, codeLine,  "4", attribute.getNumbClientPaymentSystem(), okato);
        m_view.printRow(applCode, codeLine,  "5", attribute.getNumbPCEndDate(), okato);
        m_view.printRow(applCode, codeLine,  "6", attribute.getNumbPCUsingReportPeriod(), okato);
        m_view.printRow(applCode, codeLine,  "7", attribute.getSumPCHoldersCash(), okato);
        m_view.printRow(applCode, codeLine,  "8", attribute.getSumPCHoldersCredit(), okato);
        m_view.printRow(applCode, codeLine,  "9", attribute.getNumbPCObtainCashRF(), okato);
        m_view.printRow(applCode, codeLine, "10", attribute.getSumPCObtainCashRF(), okato);
        m_view.printRow(applCode, codeLine, "11", attribute.getNumbPCObtainCashAbroad(), okato);
        m_view.printRow(applCode, codeLine, "12", attribute.getSumPCObtainCashAbroad(), okato);
        m_view.printRow(applCode, codeLine, "13", attribute.getTotalNumbNonCashOp(), okato);
        m_view.printRow(applCode, codeLine, "14", attribute.getTotalSumNonCashOp(), okato);
        m_view.printRow(applCode, codeLine, "15", attribute.getNumbNonCashInternetOp(), okato);
        m_view.printRow(applCode, codeLine, "16", attribute.getSumNonCashInternetOp(), okato);
        m_view.printRow(applCode, codeLine, "17", attribute.getNumbNonCashMobilOp(), okato);
        m_view.printRow(applCode, codeLine, "18", attribute.getSumNonCashMobilOp(), okato);
        m_view.printRow(applCode, codeLine, "19", attribute.getNumbNonCashOpRF(), okato);
        m_view.printRow(applCode, codeLine, "20", attribute.getSumNonCashOpRF(), okato);
        m_view.printRow(applCode, codeLine, "21", attribute.getNumbNonCashOpAbroad(), okato);
        m_view.printRow(applCode, codeLine, "22", attribute.getSumNonCashOpAbroad(), okato);
        m_view.printRow(applCode, codeLine, "23", attribute.getNumbNonCashOpOnlineStore(), okato);
        m_view.printRow(applCode, codeLine, "24", attribute.getSumNonCashOpOnlineStore(), okato);
        m_view.printRow(applCode, codeLine, "25", attribute.getNumbNonCashOpCustoms(), okato);
        m_view.printRow(applCode, codeLine, "26", attribute.getSumNonCashOpCustoms(), okato);
        m_view.printRow(applCode, codeLine, "27", attribute.getNumbNonCashOpOther(), okato);
        m_view.printRow(applCode, codeLine, "28", attribute.getSumNonCashOpOther(), okato);
    end;

    private macro printStringPart2(applCode : String, codeLine : String, rowNumber, attribute, okato)

        okato = okato + MkStr("0", 5 - strlen(String(okato))) ;
        m_view.printRow(applCode, codeLine, "1", rowNumber, okato);
        m_view.printRow(applCode, codeLine, "$name$", attribute.getCodePaymentSystem(), okato);
        m_view.printRow(applCode, codeLine, "4", attribute.getTotalNumbATM(), okato);
        m_view.printRow(applCode, codeLine, "5", attribute.getTotalNumbAtmCashMoney(), okato);
        m_view.printRow(applCode, codeLine, "6", attribute.getNumbATMFuncPayment(), okato);
        m_view.printRow(applCode, codeLine, "7", attribute.getTotalNumbCashReceipt(), okato);
        m_view.printRow(applCode, codeLine, "8", attribute.getNumbCashReceiptNonPC(), okato);
        m_view.printRow(applCode, codeLine, "9", attribute.getNumbCashReceiptPC(), okato);
        m_view.printRow(applCode, codeLine, "10", attribute.getNumbPOSTermService(), okato);
        m_view.printRow(applCode, codeLine, "11", attribute.getNumbPOSTermRemote(), okato);
        m_view.printRow(applCode, codeLine, "12", attribute.getNumbPOSTermEncashment(), okato);
        m_view.printRow(applCode, codeLine, "13", attribute.getNumbImprintersService(), okato);
        m_view.printRow(applCode, codeLine, "14", attribute.getNumbImprintersEncashment(), okato);

    end;

    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    private macro printDataPart11()
        var part              = m_report.getPart("1.1");
        var dataSources       = objectFactoryInstance.createDataSources(objectFactoryInstance.createCalculateProtocolView());
        var dataPaymentSystem = dataSources.getDataSource("1.1").getPaymentSystem();
        var dataOkato         = dataSources.getDataSource("1.1").getOkato();
        var i                 = 1;
        var currentOkato;
        var attribute;
        var codeLine;
        var NNNNN;

        if (part.isEmpty())
            return;
        end;

        while(not dataOkato.EOF)
            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_FOR_OKATO);
            codeLine = "ii";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_PAYMENT_CARDS_FOR_OKATO);
            codeLine = "i1";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_PAYMENT_CARDS_OVERDRAFT_FOR_OKATO);
            codeLine = "i11";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_CREDIT_CARDS_FOR_OKATO);
            codeLine = "i2";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            dataOkato.moveNext();
        end;

        while(not dataPaymentSystem.EOF)
            NNNNN = MkStr("0", 5 - strlen(String(i))) + i;
            currentOkato = dataPaymentSystem.okato;
            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.TOTAL_FOR);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_0";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.PAYMENT_CARDS);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_1";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.PAYMENT_CARDS_OVERDRAFT);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_11";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.CREDIT_CARDS);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_3";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            dataPaymentSystem.moveNext();

            if (currentOkato != dataPaymentSystem.okato)
                i = i + 1;
            end;
        end;
    end;

    private macro printDataPart2()
        var part = m_report.getPart("2");
        var dataSources = objectFactoryInstance.createDataSources(objectFactoryInstance.createCalculateProtocolView());
        var dataPaymentSystem = dataSources.getDataSource("2").getPaymentSystem();
        var i = 1;
        var attribute;
        var codeLine;
        var NNNNN = MkStr("0", 5 - strlen(String(i))) + i;
        var currentCodeTerritory;

        if (part.isEmpty())
            return;
        end;

        while(not dataPaymentSystem.EOF)
            currentCodeTerritory = dataPaymentSystem.codeTerritory;
            attribute = part.getAttribute(dataPaymentSystem.codeTerritory, dataPaymentSystem.codePaymentSystem, "");
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem;
            printStringPart2("F250_R2", codeLine, i, attribute, dataPaymentSystem.codeTerritory);

            dataPaymentSystem.moveNext();
            if (currentCodeTerritory != dataPaymentSystem.codeTerritory)
                i = i + 1;
            end;
        end;
    end;

    macro printOTS()
        var part11 = m_report.getPart("1.1");
        var part2 = m_report.getPart("2");
        var reportNotEmpty = false;

        if (part11.isEmpty())
            m_view.printRow("F250_ots", "$name$", "1", "1", "$empty$");
        else
            m_view.printRow("F250_ots", "$name$", "1", "0", "$empty$");
            reportNotEmpty = true;
        end;

        if (part2.isEmpty())
            m_view.printRow("F250_ots", "$name$", "2", "1", "$empty$");
        else
            m_view.printRow("F250_ots", "$name$", "2", "0", "$empty$");
            reportNotEmpty = true;
        end;

        m_view.printRow("F250_ots", "$name$", "3", "1", "$empty$");
        if (reportNotEmpty)
            m_view.printRow("F250_ots", "$name$", "5", "0", "$empty$");
        else
            m_view.printRow("F250_ots", "$name$", "5", "1", "$empty$");
        end;
    end;

    private macro printDataZone()
        m_view.setOutputFile();
        printDataPart11();
        printDataPart2();
        printOTS();
        m_view.resetOutputFile();
    end;

    macro execute()
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", m_reportName);

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String( m_view.getRowsCount()) + ".");

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;

class (TF250PtkPsdExportController) TF250PtkPsdExportController_4637()
    initTF250PtkPsdExportController();

    private macro printStringPart11(applCode : String, codeLine : String, rowNumber, attribute, okato)
        okato = okato + MkStr("0", 5 - strlen(String(okato))) ;

        if ((applCode == "F250_R1_1") and (attribute.getCodePaymentSystem() == ""))
            return;
        end;

        if (applCode == "F250_R1_1")
            m_view.printRow(applCode, codeLine, "1", rowNumber, okato);

            if   (attribute.getLineDescribe() == m_report.getPart("1.1").TOTAL_FOR)
                m_view.printRow(applCode, codeLine, "3", "0", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").PAYMENT_CARDS)
                m_view.printRow(applCode, codeLine, "3", "1", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").PAYMENT_CARDS_OVERDRAFT)
                m_view.printRow(applCode, codeLine, "3", "11", okato);
            elif (attribute.getLineDescribe() == m_report.getPart("1.1").CREDIT_CARDS)
                m_view.printRow(applCode, codeLine, "3", "3", okato);
            end;

            m_view.printRow(applCode, codeLine, "$name$", attribute.getCodePaymentSystem(), okato);
        end;

        m_view.printRow(applCode, codeLine,  "4", attribute.getNumbClientPaymentSystem(),  okato);
        m_view.printRow(applCode, codeLine,  "5", attribute.getNumbPCEndDate(),            okato);
        m_view.printRow(applCode, codeLine,  "6", attribute.getNumbPCUsingReportPeriod(),  okato);
        //Итого по кредитным картам кроме графы 7
        if (codeLine != "i2")
            m_view.printRow(applCode, codeLine,  "7", attribute.getSumPCHoldersCash(), okato);
        end;
        m_view.printRow(applCode, codeLine,  "8", attribute.getSumPCHoldersCredit(),       okato);
        m_view.printRow(applCode, codeLine,  "9", attribute.getNumbPCObtainCashRF(),       okato);
        m_view.printRow(applCode, codeLine, "10", attribute.getSumPCObtainCashRF(),        okato);
        m_view.printRow(applCode, codeLine, "11", attribute.getNumbPCObtainCashAbroad(),   okato);
        m_view.printRow(applCode, codeLine, "12", attribute.getSumPCObtainCashAbroad(),    okato);
        m_view.printRow(applCode, codeLine, "13", attribute.getTotalNumbNonCashOp(),       okato);
        m_view.printRow(applCode, codeLine, "14", attribute.getTotalSumNonCashOp(),        okato);
        m_view.printRow(applCode, codeLine, "15", attribute.getNumbNonCashInternetOp(),    okato);
        m_view.printRow(applCode, codeLine, "16", attribute.getSumNonCashInternetOp(),     okato);
        m_view.printRow(applCode, codeLine, "17", attribute.getNumbNonCashMobilOp(),       okato);
        m_view.printRow(applCode, codeLine, "18", attribute.getSumNonCashMobilOp(),        okato);
        m_view.printRow(applCode, codeLine, "19", attribute.getNumbNonCashOpRF(),          okato);
        m_view.printRow(applCode, codeLine, "20", attribute.getSumNonCashOpRF(),           okato);
        m_view.printRow(applCode, codeLine, "21", attribute.getNumbNonCashOpAbroad(),      okato);
        m_view.printRow(applCode, codeLine, "22", attribute.getSumNonCashOpAbroad(),       okato);
        m_view.printRow(applCode, codeLine, "23", attribute.getNumbNonCashOpOnlineStore(), okato);
        m_view.printRow(applCode, codeLine, "24", attribute.getSumNonCashOpOnlineStore(),  okato);
        m_view.printRow(applCode, codeLine, "25", attribute.getNumbNonCashOpCustoms(),     okato);
        m_view.printRow(applCode, codeLine, "26", attribute.getSumNonCashOpCustoms(),      okato);
        m_view.printRow(applCode, codeLine, "27", attribute.getNumbNonCashOpOther(),       okato);
        m_view.printRow(applCode, codeLine, "28", attribute.getSumNonCashOpOther(),        okato);
    end;

    //итоги по бесконтактным платежным картам / технологии
    private macro printStringPart11Contactless(applCode : String, codeLine : String, rowNumber, attribute, endLineMarker)
        if (codeLine != "i5")
            m_view.printRow(applCode, codeLine,  "4", attribute.getNumClients(),               endLineMarker);
            m_view.printRow(applCode, codeLine,  "5", attribute.getNumCards(),                 endLineMarker);
            m_view.printRow(applCode, codeLine,  "6", attribute.getNumCardsWithTransactions(), endLineMarker);
        end;
        m_view.printRow(applCode, codeLine,  "9", attribute.getNumTransactInRf(),          endLineMarker);
        m_view.printRow(applCode, codeLine, "10", attribute.getSumTransactInRf(),          endLineMarker);
        m_view.printRow(applCode, codeLine, "11", attribute.getNumTransactAbroad(),        endLineMarker);
        m_view.printRow(applCode, codeLine, "12", attribute.getSumTransactAbroad(),        endLineMarker);
        m_view.printRow(applCode, codeLine, "13", attribute.getNumNoncashTransactions(),   endLineMarker);
        m_view.printRow(applCode, codeLine, "14", attribute.getSumNoncashTransactions(),   endLineMarker);
        m_view.printRow(applCode, codeLine, "19", attribute.getNumNoncashTransactInRf(),   endLineMarker);
        m_view.printRow(applCode, codeLine, "20", attribute.getSumNoncashTransactInRf(),   endLineMarker);
        m_view.printRow(applCode, codeLine, "21", attribute.getNumNoncashTransactAbroad(), endLineMarker);
        m_view.printRow(applCode, codeLine, "22", attribute.getSumNoncashTransactAbroad(), endLineMarker);
        m_view.printRow(applCode, codeLine, "25", attribute.getNumNoncashCustomsPayment(), endLineMarker);
        m_view.printRow(applCode, codeLine, "26", attribute.getSumNoncashCustomsPayment(), endLineMarker);
        m_view.printRow(applCode, codeLine, "27", attribute.getNumNoncashOtherPayment(),   endLineMarker);
        m_view.printRow(applCode, codeLine, "28", attribute.getSumNoncashOtherPayment(),   endLineMarker);
    end;

    private macro printDataPart11()
        var part              = m_report.getPart("1.1");
        var dataSources       = objectFactoryInstance.createDataSources(objectFactoryInstance.createCalculateProtocolView());
        var dataPaymentSystem = dataSources.getDataSource("1.1").getPaymentSystem();
        var dataOkato         = dataSources.getDataSource("1.1").getOkato();
        var i                 = 1;
        var currentOkato;
        var attribute;
        var codeLine;
        var NNNNN;
        var lineDescribe;

        if (part.isEmpty())
            return;
        end;

        while(not dataOkato.EOF)
            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_FOR_OKATO);
            codeLine = "ii";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_PAYMENT_CARDS_FOR_OKATO);
            codeLine = "i1";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_PAYMENT_CARDS_OVERDRAFT_FOR_OKATO);
            codeLine = "i11";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            attribute = part.getAttribute(dataOkato.okato, "", part.TOTAL_CREDIT_CARDS_FOR_OKATO);
            codeLine = "i2";
            printStringPart11("F250_R1_I", codeLine, i, attribute, dataOkato.okato);

            dataOkato.moveNext();
        end;

        while(not dataPaymentSystem.EOF)
            NNNNN = MkStr("0", 5 - strlen(String(i))) + i;
            currentOkato = dataPaymentSystem.okato;
            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.TOTAL_FOR);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_0";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.PAYMENT_CARDS);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_1";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.PAYMENT_CARDS_OVERDRAFT);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_11";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            attribute = part.getAttribute(dataPaymentSystem.okato, dataPaymentSystem.codePaymentSystem, part.CREDIT_CARDS);
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem + "_3";
            printStringPart11("F250_R1_1", codeLine, i, attribute, dataPaymentSystem.okato);

            dataPaymentSystem.moveNext();

            if (currentOkato != dataPaymentSystem.okato)
                i = i + 1;
            end;
        end;

        //Итоги по КО
        attribute = part.getAttribute("", "", part.TOTAL_PAYMENT_CARDS_FOR_CREDIT_ORG);
        codeLine = "i1";
        printStringPart11("F250_R1_IKO", codeLine,  i, attribute, "$empty$");

        attribute = part.getAttribute("", "", part.TOTAL_CREDIT_CARDS_FOR_CREDIT_ORG);
        codeLine = "i2";
        printStringPart11("F250_R1_IKO", codeLine,  i, attribute, "$empty$");

        attribute = part.getContactlessUserAttribute(part.TOTAL_CONTACTLESS_CARDS_FOR_CREDIT_ORG);
        codeLine = "i4";
        printStringPart11Contactless("F250_R1_IKO", codeLine,  i, attribute, "$empty$");

        attribute = part.getContactlessUserAttribute(part.TOTAL_CONTACTLESS_TECHNOLOGY_FOR_CREDIT_ORG);
        codeLine = "i5";
        printStringPart11Contactless("F250_R1_IKO", codeLine,  i, attribute, "$empty$");

        attribute = part.getAttribute("", "", part.TOTAL_FOR_CREDIT_ORG);
        codeLine = "ii";
        printStringPart11("F250_R1_IKO", codeLine,  i, attribute, "$empty$");
    end;

    private macro printStringPart2(applCode : String, codeLine : String, rowNumber, attribute, okato)
        okato = okato + MkStr("0", 5 - strlen(String(okato))) ;
        m_view.printRow(applCode, codeLine,  "1",      rowNumber,                               okato);
        m_view.printRow(applCode, codeLine,  "$name$", attribute.getCodePaymentSystem(),        okato);
        m_view.printRow(applCode, codeLine,  "4",      attribute.getTotalNumbATM(),             okato);
        m_view.printRow(applCode, codeLine,  "5",      attribute.getTotalNumbAtmCashMoney(),    okato);
        m_view.printRow(applCode, codeLine,  "6",      attribute.getNumbATMFuncPayment(),       okato);
        m_view.printRow(applCode, codeLine,  "7",      attribute.getTotalNumbCashReceipt(),     okato);
        m_view.printRow(applCode, codeLine,  "9",      attribute.getNumbCashReceiptPC(),        okato);
        m_view.printRow(applCode, codeLine, "11",      attribute.getNumbPOSTermService(),       okato);
        m_view.printRow(applCode, codeLine, "12",      attribute.getNumbPOSTermRemote(),        okato);
        m_view.printRow(applCode, codeLine, "13",      attribute.getNumbPOSTermEncashment(),    okato);
        m_view.printRow(applCode, codeLine, "14",      attribute.getNumbImprintersService(),    okato);
        m_view.printRow(applCode, codeLine, "15",      attribute.getNumbImprintersEncashment(), okato);
    end;

    private macro printTotalStringPart2(applCode : String, codeLine : String, attribute, endLineMarker)
        m_view.printRow(applCode, codeLine,  "4", attribute.getTotalNumbATM(),             endLineMarker);
        m_view.printRow(applCode, codeLine,  "5", attribute.getTotalNumbAtmCashMoney(),    endLineMarker);
        m_view.printRow(applCode, codeLine,  "6", attribute.getNumbATMFuncPayment(),       endLineMarker);
        m_view.printRow(applCode, codeLine,  "7", attribute.getTotalNumbCashReceipt(),     endLineMarker);
        if (codeLine == "ii")
            m_view.printRow(applCode, codeLine,  "8", attribute.getNumbCashReceiptNonPC(), endLineMarker);
        end;
        m_view.printRow(applCode, codeLine,  "9", attribute.getNumbCashReceiptPC(),        endLineMarker);
        if (codeLine == "ii")
            m_view.printRow(applCode, codeLine, "10", attribute.getNumbPosTermBillRecycling(), endLineMarker);
        end;
        m_view.printRow(applCode, codeLine, "11", attribute.getNumbPOSTermService(),       endLineMarker);
        m_view.printRow(applCode, codeLine, "12", attribute.getNumbPOSTermRemote(),        endLineMarker);
        m_view.printRow(applCode, codeLine, "13", attribute.getNumbPOSTermEncashment(),    endLineMarker);
        m_view.printRow(applCode, codeLine, "14", attribute.getNumbImprintersService(),    endLineMarker);
        m_view.printRow(applCode, codeLine, "15", attribute.getNumbImprintersEncashment(), endLineMarker);
    end;

    private macro printDataPart2()
        var part              = m_report.getPart("2");
        var dataSources       = objectFactoryInstance.createDataSources(objectFactoryInstance.createCalculateProtocolView());
        var dataPaymentSystem = dataSources.getDataSource("2").getPaymentSystem();
        var i                 = 1;
        var NNNNN             = MkStr("0", 5 - strlen(String(i))) + i;
        var attribute;
        var codeLine;
        var currentCodeTerritory;

        if (part.isEmpty())
            return;
        end;

        while(not dataPaymentSystem.EOF)
            currentCodeTerritory = dataPaymentSystem.codeTerritory;
            attribute = part.getAttribute(dataPaymentSystem.codeTerritory, dataPaymentSystem.codePaymentSystem, "");
            codeLine = NNNNN + "_" + dataPaymentSystem.codePaymentSystem;
            printStringPart2("F250_R2", codeLine, i, attribute, dataPaymentSystem.codeTerritory);

            dataPaymentSystem.moveNext();
            if (currentCodeTerritory != dataPaymentSystem.codeTerritory)
                i = i + 1;
            end;
        end;

        attribute = part.getAttribute("", "", part.TOTAL_FOR_CREDIT_ORG);
        codeLine = "ii";
        printTotalStringPart2("F250_R2_IKO", codeLine, attribute, "$empty$");

        attribute = part.getAttribute("", "", part.TOTAL_CONTACTLESS_TECHNOLOGY_FOR_CREDIT_ORG);
        codeLine = "i5";
        printTotalStringPart2("F250_R2_IKO", codeLine, attribute, "$empty$");
    end;

    private macro getInstruction()
        return "4637-У";
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", m_reportName);

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine(getSourceFormat());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");
        protocolView.printLine("Выгружено строк: " + String( m_view.getRowsCount()) + ".");

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;