/*
$Name:          ex_ptkpsd501.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 501. Контроллер экспорта
*/

import rcbImport;
import cb_sql;
import rcbCoreInter;
import RcbProtocolView;
import RcbPtkPsdView;

import p_f501;      //для совместного использования классов фильтрации и сортировки

private var rowNumbers = TArray();   //глобальная переменная с номерами строк для (код колонки npp) приложения F501_1_OBR

class (TPtkPsdView) T501PtkPsdView()
    initTPtkPsdView(strsubst(RcbApplication().currentReport.form.id, "Форма ", ""), RcbApplication.currentReport.context.period.endDate + 1, "rsansi"); //ДООП+1
end;

/**
 * Операция экспорта в ПТК ПСД для раздела.
 */
class TPtkPsdExportPartController(view, part, head)
    private var m_view                              = view;       //представление печати
    private var m_part                              = part;       //раздел
    private var m_applicationCode                   = head;       //заголовок раздела
    private var m_sumPartNotResidentArray : TArray;
    private var m_stringVariableArray     : TArray;               //массив возможных значений кодов строки (период)

    private macro initStringVariableArray()
        m_stringVariableArray[m_stringVariableArray.size] = "НаимКО";
        m_stringVariableArray[m_stringVariableArray.size] = "РегНом";
        m_stringVariableArray[m_stringVariableArray.size] = "КодСтр";
        m_stringVariableArray[m_stringVariableArray.size] = "НомБС";
        m_stringVariableArray[m_stringVariableArray.size] = "НомЛС";
        m_stringVariableArray[m_stringVariableArray.size] = "ОстВход";
        m_stringVariableArray[m_stringVariableArray.size] = "ОбДебет";
        m_stringVariableArray[m_stringVariableArray.size] = "ОбКредит";
        m_stringVariableArray[m_stringVariableArray.size] = "ОстИсход";
        m_stringVariableArray[m_stringVariableArray.size] = "ДатаИспОб";
        m_stringVariableArray[m_stringVariableArray.size] = "ПрСтавка";
    end;

    //в атрибутах не сохраняется наименование страны
    private macro getCountryName(countryCode)
        var sqlStr = "SELECT t_name"
            + "\n" + "  FROM dcountry_dbt"
            + "\n" + " WHERE t_codenum3 = '" + countryCode + "'";
        var ds = TrsbDataSet(sqlStr);
        if (ds.moveNext())
           return ds.name;
        end;
        return "";
    end;

    private macro getDate(perfDate)
        var day, month, year;
        var dayStr, monthStr, yearStr;

        if(perfDate == "д/в")
            return "-1";
        else
            DateSplit(Date(trim(perfDate)), day, month, year);
            dayStr   = String(day:2:o);
            monthStr = String(month:2:o);
            yearStr  = String(year:4:o);
            return yearStr+monthStr+dayStr;
        end;
    end;

    macro getDate_YYYYMMDD(_date : string) : string
        return SubStr(_date, 7) + SubStr(_date, 4, 2) + ternary(int(SubStr(_date, 1, 2)) < 10, "0" + trim(SubStr(_date, 1, 2)), trim(SubStr(_date, 1, 2)));
    end;

    private macro findNewNotResident(notResidentAttribute, notResidentArray)
        var l = 0;

        while (l < notResidentArray.size)
            if (notResidentAttribute.fieldValue("КодКО").scaledAsString == notResidentArray[l].fieldValue("КодКО").scaledAsString)
                return l;
            end;
                l = l+1;
        end;
        return -1;
    end;

    private macro printExportString(exportRow, exportColumn, exportValue)
        m_view.printRow(m_applicationCode,      //код приложения
                        exportRow,              //код строки
                        exportColumn,           //код колонки
                        exportValue);           //значение
    end;

    private macro printPartExportString(varName : String)
        var formVariable     = RcbApplication.CurrentReport.attributeValue(varName);
        var row              = 1;          /*номер строки раздела*/
        var curItemValues;
        var perfDate;
        var gdepIndication;
        var n;

        if ( varName != "" )
        //F501_1, F501_2
            var valueIterator = formVariable.createValueIterator();
            valueIterator.moveFirst();
            while (not valueIterator.isDone())
                curItemValues = valueIterator.currentItem();
                //ищем нерезидентов
                if (curItemValues.fieldValue(m_stringVariableArray[2]).scaledAsString != "643")
                     var posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                     if (posNotResident == -1)
                         posNotResident = m_sumPartNotResidentArray.size;
                         m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                     end;
                     printExportString(string(row:4:o), "res", posNotResident+1);
                else
                     printExportString(string(row:4:o), "res", 0);  //признак резидента = 0
                end;

                n = 1;
                var curColumn = 0;
                while (n <= m_stringVariableArray.size)
                    if (n == 6)
                        n = n+1;
                    end;
                    if ((curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact != "") and
                        (curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString != stringUndefined))
                        if (curColumn == 9) //дата исп. обяз.
                            perfDate = getDate(curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                            printExportString(string(row:4:o), string(n), perfDate);
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                        end;
                    end;
                    n = n+1;
                    curColumn = curColumn+1;
                end;
                //печатаем процентную ставку (12 столбец)
                gdepIndication = curItemValues.fieldValue("ПризнакГД").scaledAsString;
                if (gdepIndication != 1)
                    printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact:0:2));
                end;
                printExportString(string(row:4:o), "repo", curItemValues.fieldValue("ПризнакРЕПО").scaledAsString);
                printExportString(string(row:4:o), "gdep", gdepIndication);

                row = row+1;
                valueIterator.moveNext();
            end;
        else
           /*  справочное приложение F501_N  */
            n = 0;
            while (n < m_sumPartNotResidentArray.size)
                printExportString(string(n+1:3:o), "CODE",  n+1);
                printExportString(string(n+1:3:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);
                printExportString(string(n+1:3:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);
                printExportString(string(n+1:3:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);
                printExportString(string(n+1:3:o), "CNAME", getCountryName(m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact));
                n=n+1;
            end;
        end;
    end;

    macro execute(allPartNotResidentArray)
         m_stringVariableArray       = TArray();
         m_sumPartNotResidentArray   = allPartNotResidentArray;

         initStringVariableArray();
         if (m_part == 3)
             //справочно
             printPartExportString("");
         elif (m_part == 1)
             printPartExportString("Ф501_1");
         elif (m_part == 2)
             printPartExportString("Ф501_2");
         end;
         return m_sumPartNotResidentArray;
    end;
end;

class (TPtkPsdExportPartController) TPtkPsdExportPartController_I2332(view, part, head)
    initTPtkPsdExportPartController(view, part, head);

    private var m_sumPartNotResidentArrayManualInput : TArray;
    private var m_stringVariableArrayManualInput     : TArray;                 //массив возможных значений кодов строки (период) - пользовательский ввод

    private macro initStringVariableArrayManualInput()
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НаимКО";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "РегНом";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "КодСтр";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НомБС_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НомЛС_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОстВход_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОбДебет_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОбКредит_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОстИсход_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ДатаИспОб_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ПрСтавка_ввод";
    end;

    private macro printPartExportString(varName : String)
        var formVariable            = RcbApplication.CurrentReport.attributeValue(varName);
        var formVariableManualInput = RcbApplication.CurrentReport.attributeValue(varName + "ввод");
        var row                     = 1;          /*номер строки раздела*/
        var curItemValues;
        var perfDate;
        var gdepIndication;
        var n;
        var posNotResident;
        var isResident : bool;
        var curColumn;

        if ( varName != "" )
        //F501_1, F501_2
            var valueIterator            = formVariable.createValueIterator();
            var valueIteratorManualInput = formVariableManualInput.createValueIterator();
            valueIterator.moveFirst();
            while (not valueIterator.isDone())
                curItemValues = valueIterator.currentItem();
                //ищем нерезидентов
                if (curItemValues.fieldValue(m_stringVariableArray[2]).scaledAsString != "643")
                     posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                     if (posNotResident == -1)
                         posNotResident = m_sumPartNotResidentArray.size;
                         m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                     end;
                     printExportString(string(row:4:o), "res", posNotResident+1);
                     isResident = false;
                else
                     printExportString(string(row:4:o), "res", 0);  //признак резидента = 0
                     isResident = true;
                end;

                n = 1;
                curColumn = 0;
                while (n <= m_stringVariableArray.size)
                    if (n == 6)
                        n = n + 1;
                    end;
                    if (n == 3)
                        if (isResident)
                            printExportString(string(row:4:o), string(n), ternary(curItemValues.fieldValue("БИК").scaledAsString == "Undefined", "", curItemValues.fieldValue("БИК").scaledAsString));
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    elif ((curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact != "") and
                        (curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString != stringUndefined))
                        if (curColumn == 9) //дата исп. обяз.
                            perfDate = getDate(curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                            printExportString(string(row:4:o), string(n), perfDate);
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                        end;
                    end;
                    n = n+1;
                    curColumn = curColumn+1;
                end;
                //печатаем процентную ставку (12 столбец)
                gdepIndication = curItemValues.fieldValue("ПризнакГД").scaledAsString;
                if (gdepIndication != 1)
                    printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact:0:2));
                end;
                printExportString(string(row:4:o), "repo", curItemValues.fieldValue("ПризнакРЕПО").scaledAsString);
                printExportString(string(row:4:o), "gdep", gdepIndication);

                if ((varName == "Ф501_1") and (curItemValues.fieldValue("ПризнакЗависимости").scaledAsString == "*"))
                    printExportString(string(row:4:o), "pz", 1);

                    var valueExportString: String = "";
                    if ((valType(curItemValues.fieldValue("КолПролонгаций").exact) == V_UNDEF) OR
                        (int(curItemValues.fieldValue("КолПролонгаций").exact) < 0) OR
                        (int(curItemValues.fieldValue("КолПролонгаций").exact) > 32767))
                        valueExportString = "";
                    else
                        valueExportString = curItemValues.fieldValue("КолПролонгаций").scaledAsString;
                    end;

                    printExportString(string(row:4:o), "pz1", valueExportString);
                    printExportString(string(row:4:o), "pzt", ternary((curItemValues.fieldValue("Пояснения").scaledAsString == "Undefined"), "", curItemValues.fieldValue("Пояснения").scaledAsString));
                end;

                row = row+1;
                valueIterator.moveNext();
            end;

            valueIteratorManualInput.setFilter(TFilterManualInput());
            valueIteratorManualInput.setSortOrder(TSorterManualInput());
            valueIteratorManualInput.moveFirst();
            while (not valueIteratorManualInput.isDone())
                curItemValues = valueIteratorManualInput.currentItem();
                if (curItemValues.fieldValue(m_stringVariableArrayManualInput[2]).scaledAsString != "643")
                     posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                     if (posNotResident == -1)
                         posNotResident = m_sumPartNotResidentArray.size;
                         m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                     end;
                     printExportString(string(row:4:o), "res", posNotResident+1);
                     isResident = false;
                else
                     printExportString(string(row:4:o), "res", 0);  //признак резидента = 0
                     isResident = true;
                end;
                n = 1;
                curColumn = 0;
                while (n <= m_stringVariableArrayManualInput.size)
                    if (n == 6)
                        n = n + 1;
                    end;
                    if   (n == 3)
                        if (isResident)
                            printExportString(string(row:4:o), string(n), ternary(curItemValues.fieldValue("БИК_ввод").scaledAsString == "Undefined", "", curItemValues.fieldValue("БИК_ввод").scaledAsString));
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    elif ((curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).exact != "") and
                        (curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString != stringUndefined))
                        if (curColumn == 9) //дата исп. обяз.
                            perfDate = getDate(curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                            printExportString(string(row:4:o), string(n), perfDate);
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    end;
                    n = n + 1;
                    curColumn = curColumn+1;
                end;
                //печатаем процентную ставку (12 столбец)
                printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).exact:0:2));
                printExportString(string(row:4:o), "repo", 0);
                printExportString(string(row:4:o), "gdep", 0);

                if ((varName == "Ф501_1") and (curItemValues.fieldValue("ххх_ввод").scaledAsString == "***"))
                    printExportString(string(row:4:o), "pz", 1);
                    if ((valType(curItemValues.fieldValue("КолПролонгаций_ввод").exact) == V_UNDEF) OR
                        (int(curItemValues.fieldValue("КолПролонгаций_ввод").exact) < 0) OR
                        (int(curItemValues.fieldValue("КолПролонгаций_ввод").exact) > 32767))
                        valueExportString = "";
                    else
                        valueExportString = curItemValues.fieldValue("КолПролонгаций_ввод").scaledAsString;
                    end;
                    printExportString(string(row:4:o), "pz1", valueExportString);
                    printExportString(string(row:4:o), "pzt", ternary((curItemValues.fieldValue("Пояснения_ввод").scaledAsString == "Undefined"), "", curItemValues.fieldValue("Пояснения_ввод").scaledAsString));
                end;

                row = row + 1;
                valueIteratorManualInput.moveNext();
            end;

        else
           /*  справочное приложение F501_N  */
            n = 0;
            while (n < m_sumPartNotResidentArray.size)
                printExportString(string(n+1:3:o), "CODE",  n+1);
                printExportString(string(n+1:3:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);
                printExportString(string(n+1:3:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);
                printExportString(string(n+1:3:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);
                printExportString(string(n+1:3:o), "CNAME", getCountryName(m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact));
                n=n+1;
            end;
            /*var i = 0;*/
            /*while (i < m_sumPartNotResidentArray.size)*/
                /*printExportString(string(n+1:3:o), "CODE",  n+1);*/
                /*printExportString(string(n+1:3:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);                            */
                /*printExportString(string(n+1:3:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);  */
                /*printExportString(string(n+1:3:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);*/
                /*printExportString(string(n+1:3:o), "CNAME", getCountryName(m_sumPartNotResidentArray[i].fieldValue("КодСтр").exact));                            */
                /*n = n + 1;*/
                /*i = i + 1;*/
            /*end;*/
        end;
    end;

    macro execute(allPartNotResidentArray)
         m_stringVariableArray            = TArray();
         m_stringVariableArrayManualInput = TArray();
         m_sumPartNotResidentArray        = allPartNotResidentArray;

         initStringVariableArray();
         initStringVariableArrayManualInput();
         if (m_part == 3)
             //справочно
             printPartExportString("");
         elif (m_part == 1)
             printPartExportString("Ф501_1");
         elif (m_part == 2)
             printPartExportString("Ф501_2");
         end;
         return m_sumPartNotResidentArray;
    end;
end;

class (TPtkPsdExportPartController_I2332) TPtkPsdExportPartController_I4212(view, part, head)
    initTPtkPsdExportPartController_I2332(view, part, head);

    private macro initStringVariableArray()
        m_stringVariableArray[m_stringVariableArray.size] = "НаимКО";
        m_stringVariableArray[m_stringVariableArray.size] = "РегНом";
        m_stringVariableArray[m_stringVariableArray.size] = "КодСтр";
        m_stringVariableArray[m_stringVariableArray.size] = "НомБС";
        m_stringVariableArray[m_stringVariableArray.size] = "НомЛС";
        m_stringVariableArray[m_stringVariableArray.size] = "ОстВход";
        m_stringVariableArray[m_stringVariableArray.size] = "ОбДебет";
        m_stringVariableArray[m_stringVariableArray.size] = "ОбКредит";
        m_stringVariableArray[m_stringVariableArray.size] = "ОстИсход";
        m_stringVariableArray[m_stringVariableArray.size] = "ДатаИспОб";
        m_stringVariableArray[m_stringVariableArray.size] = "ПрСтавка";
        m_stringVariableArray[m_stringVariableArray.size] = "ЛицоПоОбрем";
        m_stringVariableArray[m_stringVariableArray.size] = "ИдентификаторОбрем";
        m_stringVariableArray[m_stringVariableArray.size] = "ВидОбрем";
        m_stringVariableArray[m_stringVariableArray.size] = "ОстатокПоСчетуОбрем";
        m_stringVariableArray[m_stringVariableArray.size] = "ДатаПогашения";
    end;

    private macro initStringVariableArrayManualInput()
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НаимКО";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "РегНом";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "КодСтр";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НомБС_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "НомЛС_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОстВход_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОбДебет_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОбКредит_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОстИсход_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ДатаИспОб_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ПрСтавка_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ЛицоПоОбрем_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ИдентификаторОбрем_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ВидОбрем_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ОстатокПоСчетуОбрем_ввод";
        m_stringVariableArrayManualInput[m_stringVariableArrayManualInput.size] = "ДатаПогашения_ввод";
    end;

    private macro printPartExportString(varName : String)
        var formVariable            = RcbApplication.CurrentReport.attributeValue(varName);
        var formVariableManualInput = RcbApplication.CurrentReport.attributeValue(varName + "ввод");
        var row                     = 1;          /*номер строки раздела*/
        var curItemValues;
        var perfDate;
        var gdepIndication;
        var n;
        var posNotResident;
        var isResident : bool;
        var curColumn;
        var onerousKind;            //вид обременения для текущей строки

        if (varName != "")
            //F501_1, F501_2
            var valueIterator            = formVariable.createValueIterator();
            var valueIteratorManualInput = formVariableManualInput.createValueIterator();
            valueIterator.moveFirst();
            while (not valueIterator.isDone())
                curItemValues = valueIterator.currentItem();
                //ищем нерезидентов
                if (curItemValues.fieldValue(m_stringVariableArray[2]).scaledAsString != "643")
                     posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                     if (posNotResident == -1)
                         posNotResident = m_sumPartNotResidentArray.size;
                         m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                     end;
                     printExportString(string(row:4:o), "res", posNotResident+1);
                     isResident = false;
                else
                     printExportString(string(row:4:o), "res", 0);  //признак резидента = 0
                     isResident = true;
                end;

                n = 1;
                curColumn = 0;
                while (n <= m_stringVariableArray.size + 1)
                    //графы, связанные с обременением (13..17) выводятся только для Раздела 1
                    if (    (varName != "Ф501_1")
                        and (n > 12))
                        n = n + 1;
                        continue;
                    end;

                    if (n == 6)
                        n = n + 1;
                    end;

                    if   (n == 3)
                        if (isResident)
                            printExportString(string(row:4:o), string(n), ternary(curItemValues.fieldValue("БИК").scaledAsString == "Undefined", "", curItemValues.fieldValue("БИК").scaledAsString));
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    elif (    (curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact != "")
                          and (curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString != stringUndefined))
                        //Дата исполнения обязательства или Срок погашения
                        if   (   (curColumn == 9)
                              or (curColumn == 17))
                            perfDate = getDate(curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                            printExportString(string(row:4:o), string(n), perfDate);
                        //процентная ставка (графа 12)
                        elif (n == 12)
                            gdepIndication = curItemValues.fieldValue("ПризнакГД").scaledAsString;

                            if (gdepIndication != 1)
                                printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact:0:2));
                            end;
                        //стоимость (графа 16)
                        elif (n == 16)
                            onerousKind = curItemValues.fieldValue("ВидОбрем").scaledAsString;

                            if (onerousKind != "")
                                printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArray[curColumn]).exact:0:2));
                            end;
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArray[curColumn]).scaledAsString);
                        end;
                    end;

                    n = n + 1;
                    curColumn = curColumn + 1;
                end;

                printExportString(string(row:4:o), "repo", curItemValues.fieldValue("ПризнакРЕПО").scaledAsString);
                printExportString(string(row:4:o), "gdep", gdepIndication);

                if (    (varName == "Ф501_1")
                    and (curItemValues.fieldValue("ПризнакЗависимости").scaledAsString == "*"))

                    printExportString(string(row:4:o), "pz", 1);

                    var valueExportString: String = "";
                    if ((valType(curItemValues.fieldValue("КолПролонгаций").exact) == V_UNDEF) OR
                        (int(curItemValues.fieldValue("КолПролонгаций").exact) < 0) OR
                        (int(curItemValues.fieldValue("КолПролонгаций").exact) > 32767))
                        valueExportString = "";
                    else
                        valueExportString = curItemValues.fieldValue("КолПролонгаций").scaledAsString;
                    end;

                    printExportString(string(row:4:o), "pz1", valueExportString);
                    printExportString(string(row:4:o), "pzt", ternary((curItemValues.fieldValue("Пояснения").scaledAsString == "Undefined"), "", curItemValues.fieldValue("Пояснения").scaledAsString));
                end;

                row = row + 1;
                valueIterator.moveNext();
            end;

            valueIteratorManualInput.setFilter(TFilterManualInput());
            valueIteratorManualInput.setSortOrder(TSorterManualInput());
            valueIteratorManualInput.moveFirst();
            while (not valueIteratorManualInput.isDone())
                curItemValues = valueIteratorManualInput.currentItem();
                if (curItemValues.fieldValue(m_stringVariableArrayManualInput[2]).scaledAsString != "643")
                    posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                    if (posNotResident == -1)
                        posNotResident = m_sumPartNotResidentArray.size;
                        m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                    end;
                    printExportString(string(row:4:o), "res", posNotResident+1);
                    isResident = false;
                else
                    printExportString(string(row:4:o), "res", 0);  //признак резидента = 0
                    isResident = true;
                end;

                n = 1;
                curColumn = 0;
                while (n <= m_stringVariableArrayManualInput.size + 1)
                    //графы, связанные с обременением (13..17) выводятся только для Раздела 1
                    if (    (varName != "Ф501_1")
                        and (n > 12))
                        n = n + 1;
                        continue;
                    end;

                    if (n == 6)
                        n = n + 1;
                    end;

                    if   (n == 3)
                        if (isResident)
                            printExportString(string(row:4:o), string(n), ternary(curItemValues.fieldValue("БИК_ввод").scaledAsString == "Undefined", "", curItemValues.fieldValue("БИК_ввод").scaledAsString));
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    elif (    (curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).exact != "")
                          and (curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString != stringUndefined))
                        //Дата исполнения обязательства или Срок погашения
                        if   (   (curColumn == 9)
                              or (curColumn == 17))
                            perfDate = getDate(curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                            printExportString(string(row:4:o), string(n), perfDate);
                        //процентная ставка (графа 12)
                        elif (n == 12)
                            printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).exact:0:2));
                        //стоимость (графа 16)
                        elif (n == 16)
                            onerousKind = curItemValues.fieldValue("ВидОбрем_ввод").scaledAsString;
                            if (    (onerousKind != "")
                                and (onerousKind != stringUndefined))
                                printExportString(string(row:4:o), string(n), string(curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString:0:2));
                            end;
                        else
                            printExportString(string(row:4:o), string(n), curItemValues.fieldValue(m_stringVariableArrayManualInput[curColumn]).scaledAsString);
                        end;
                    end;

                    n = n + 1;
                    curColumn = curColumn + 1;
                end;

                printExportString(string(row:4:o), "repo", 0);
                printExportString(string(row:4:o), "gdep", 0);

                if (    (varName == "Ф501_1")
                    and (curItemValues.fieldValue("ххх_ввод").scaledAsString == "***"))

                    printExportString(string(row:4:o), "pz", 1);

                    if (   (valType(curItemValues.fieldValue("КолПролонгаций_ввод").exact) == V_UNDEF)
                        or (int(curItemValues.fieldValue("КолПролонгаций_ввод").exact) < 0)
                        or (int(curItemValues.fieldValue("КолПролонгаций_ввод").exact) > 32767))
                        valueExportString = "";
                    else
                        valueExportString = curItemValues.fieldValue("КолПролонгаций_ввод").scaledAsString;
                    end;

                    printExportString(string(row:4:o), "pz1", valueExportString);
                    printExportString(string(row:4:o), "pzt", ternary((curItemValues.fieldValue("Пояснения_ввод").scaledAsString == "Undefined"), "", curItemValues.fieldValue("Пояснения_ввод").scaledAsString));
                end;

                row = row + 1;
                valueIteratorManualInput.moveNext();
            end;
        else
            /*  справочное приложение F501_N  */
            n = 0;
            while (n < m_sumPartNotResidentArray.size)
                printExportString(string(n+1:3:o), "CODE",  n+1);
                printExportString(string(n+1:3:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);
                printExportString(string(n+1:3:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);
                printExportString(string(n+1:3:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);
                printExportString(string(n+1:3:o), "CNAME", getCountryName(m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact));
                n=n+1;
            end;
        end;
    end;
end;

class TRecord(columnCode : String, field : String, addField : String)
    var m_columnCode   : String = columnCode;
    var m_fieldName    : String = field;
    var m_addFieldName : String = addField;
end;

private class (RcbArray) TCodes()
    macro getColumnCode()
        return getCurrentItem().m_columnCode;
    end;

    macro getFieldName()
        return getCurrentItem().m_fieldName;
    end;

    macro getAddFieldName()
        return getCurrentItem().m_addFieldName;
    end;
end;

class (TPtkPsdExportPartController_I4212) TPtkPsdExportPartController_0MW1G(view, part, head)
    private var m_fieldsIterator          : TCodes;
    private var m_fieldsUserInputIterator : TCodes;

    private macro printExportString(exportRow, exportColumn, exportValue)
        if (    (exportValue != null)
            and (exportValue != stringUndefined)
            and (exportValue != "")
           )
            m_view.printRow(m_applicationCode,      //код приложения
                            exportRow,              //код строки
                            exportColumn,           //код колонки
                            exportValue);           //значение
        end;
    end;

    private macro rowNumberToString(rowNumber) : String
        if (m_applicationCode != "F501_1_OBR")
            return String(rowNumber:6:o);
        else
            return String(rowNumber:6:o) + "_01";
        end;
    end;

    private class TObremFilter()
        macro isSuitable(obj : Object)
            return (    (obj.fieldValue("ПризнакОбременения").scaledAsString != "0")
                    and (obj.fieldValue("ПризнакОбременения").scaledAsString != null)
                   )
                   or
                   (    (obj.fieldValue("ВидОбрем").scaledAsString != "")
                    and (obj.fieldValue("ВидОбрем").scaledAsString != null)
                   )
        end;
    end;

    private class TObremInputFilter()
        macro isSuitable(obj : Object)
            return (    (obj.fieldValue("ПризнакОбременения_ввод").scaledAsString != "0")
                    and (obj.fieldValue("ПризнакОбременения_ввод").scaledAsString != null)
//                    and (obj.fieldValue("ПризнакОбременения_ввод").scaledAsString != "")
                    and (obj.fieldValue("ПризнакОбременения_ввод").scaledAsString != "Undefined")
                    or
                        (obj.fieldValue("ВидОбрем_ввод").scaledAsString != "")
                    and (obj.fieldValue("ВидОбрем_ввод").scaledAsString != null)
                   )
        end;
    end;

    private macro getFieldName(c : Tcodes, code : String) : String
        c.moveFirst();
        while (c.moveNext())
            if (c.getColumnCode() == code)
                return c.getFieldName();
            end;
        end;

        return null;
    end;

    private macro processCompositeValue(c : Tcodes, curItemValues, row, rowNum)
        var gdepIndication;
        var posNotResident;
        var isResident : bool;
        var onerousKind;                             //вид обременения для текущей строки
        var temp;
        var d,m,y;
        var fieldName_kod_obr = getFieldName(c, "kod_obr");  //имя поля структурной переменной для кода колонки kod_obr
        var fieldName_vid_obz = getFieldName(c, "vid_obz");  //имя поля структурной переменной для кода колонки vid_obz

        //запоминаем номера строк с обременением для F501_1_OBR
        if (m_applicationCode == "F501_1")
            if (    (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != "0")
                and (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != null)
                and (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != stringUndefined)
               )
                rowNumbers[rowNumbers.size] = row;
            end;
        end;

        if (m_applicationCode == "F501_1")
            if (    (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != "0")
                and (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != null)
                and (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != "")
               )
                rowNumbers[rowNumbers.size] = row;
            end;
        end;

        c.moveFirst();
        while (c.moveNext())
            //графы, связанные с обременением (13..17) выводятся только для приложения с кодом F501_1_OBR
            if (   (    (m_applicationCode != "F501_1_OBR")
                    and (in(c.getColumnCode(), "nom", "kod_obr", "npers_obr", "kpers_obr", "res_obr", "2_obr", "vid_obz", "sum_obz", "date_obz", "prim_obz"))
                   )
                or (    (m_applicationCode == "F501_1_OBR")
                    and (in(c.getColumnCode(), "res", "1", "2", "3", "4", "5", "7", "8", "9", "10", "11", "12", "repo", "gdep", "pzt"))
                   )
               )
                continue;
            end;

            if   (c.getColumnCode() == "res")
                if (curItemValues.fieldValue("КодСтр").scaledAsString != "643")
                    posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                    if (posNotResident == -1)
                        posNotResident = m_sumPartNotResidentArray.size;
                        m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                    end;
                    printExportString(rowNumberToString(row), "res", posNotResident + 1);

                    isResident = false;
                else
                    printExportString(rowNumberToString(row), "res", 0);  //признак резидента = 0
                    isResident = true;
                end;

            elif   (c.getColumnCode() == 3)
                if (isResident)
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), ternary(curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == "Undefined", "", curItemValues.fieldValue(c.getAddFieldName()).scaledAsString));
                else
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Дата исполнения обязательства (графа 11)
            elif (c.getColumnCode() == 11)
                if (curItemValues.fieldValue(c.getFieldName()).scaledAsString != "Undefined")
                    if (curItemValues.fieldValue(c.getFieldName()).scaledAsString == "д/в")
                        printExportString(rowNumberToString(row), string(c.getColumnCode()), "-1");
                    else
                        temp = Date(Trim(curItemValues.fieldValue(c.getFieldName()).scaledAsString));
                        DateSplit(temp, d, m, y);

                        if ((d != 0) and (m != 0) and (y != 0))
                            printExportString(rowNumberToString(row), string(c.getColumnCode()), string(y:4:o) + string(m:2:o) + string(d:2:o));
                        end;
                    end;
                end;

            //процентная ставка (графа 12)
            elif (c.getColumnCode() == 12)
                //F501_1
                if (c.getAddFieldName() != "")
                    gdepIndication = curItemValues.fieldValue(c.getAddFieldName()).scaledAsString;

                    if (gdepIndication != 1)
                        printExportString(rowNumberToString(row), string(c.getColumnCode()), string(curItemValues.fieldValue(c.getFieldName()).exact:0:2));
                    end;
                //F501_1_vvod
                else
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), string(curItemValues.fieldValue(c.getFieldName()).exact:0:2));
                end;

            //Пояснения о характере сделки
            elif (c.getColumnCode() == "pzt")
                if (   (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == 1)                                          //
                    or (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == "***"))                                     //пользовательский ввод
                    printExportString(rowNumberToString(row), "pzt", curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Порядковый номер строки в печатной форме (графа 1)
            elif (c.getColumnCode() == "npp")
                printExportString(rowNumberToString(row), "npp", rowNum);

            //Номер обременения по лицевому счету
            elif (c.getColumnCode() == "nom")
                printExportString(rowNumberToString(row), "nom", "1");

            //npers_obr/ для обременения по л/с /Пустое значение не выгружается
            elif (c.getColumnCode() == "npers_obr")
                if (curItemValues.fieldValue(c.getFieldName()).scaledAsString != "0")
                    printExportString(rowNumberToString(row), "npers_obr", curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Номер пункта п/п банка-нерезидента
            elif (c.getColumnCode() == "res_obr")
                if (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == 4)
                    printExportString(rowNumberToString(row), "res_obr", posNotResident);
                end;

            //стоимость (графа 16)
            elif (c.getColumnCode() == "sum_obz")
                onerousKind = curItemValues.fieldValue(c.getAddFieldName()).scaledAsString;

                if (    (onerousKind != "")
                    and (onerousKind != stringUndefined))
                    printExportString(rowNumberToString(row), "sum_obz", string(curItemValues.fieldValue(c.getFieldName()).scaledAsString));
                end;

            //Срок погашения обремененного обязательства (графа 17) Формат экспорта: ГГГГММДД
            elif (c.getColumnCode() == "date_obz")
                if (curItemValues.fieldValue(c.getFieldName()).currentAsString != "")
                    printExportString(rowNumberToString(row), "date_obz", getDate_YYYYMMDD(curItemValues.fieldValue(c.getFieldName()).currentAsString));
                end;

            //обработка колонок по умолчанию
            else
                printExportString(rowNumberToString(row), string(c.getColumnCode()), curItemValues.fieldValue(c.getFieldName()).scaledAsString);
            end;
        end;
    end;

    private macro printPartExportString(varName : String)
        var formVariable            = RcbApplication.CurrentReport.attributeValue(varName);
        var formVariableManualInput = RcbApplication.CurrentReport.attributeValue(varName + "ввод");
        var row                     = 1;          /*номер строки раздела*/
        var rowNum                  = 1;          /*номер строки в печатной форме*/
        var structValue;
        var structValueManualInput;
        var n;
        var i = 0;

        if (varName != "")
            //F501_1, F501_2
            var valueIterator            = formVariable.createValueIterator();
            var valueIteratorManualInput = formVariableManualInput.createValueIterator();

            valueIterator.setFilter(TFilter());
            valueIterator.setSortOrder(TSorter());
            valueIterator.moveFirst();

            valueIteratorManualInput.setFilter(TFilterManualInput());
            valueIteratorManualInput.setSortOrder(TSorterManualInput());
            valueIteratorManualInput.moveFirst();

            if (m_applicationCode == "F501_1_OBR")
                valueIterator.setFilter(TObremFilter());
                valueIteratorManualInput.setFilter(TObremInputFilter());
            end;

            while (not valueIterator.isDone())
                structValue            = valueIterator.currentItem();
                structValueManualInput = valueIteratorManualInput.currentItem();

                while (    (not valueIteratorManualInput.isDone())
                       and (not isFirstRecordLess(structValue, structValueManualInput)))

                    if (m_applicationCode != "F501_1_OBR")
                        processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, row, rowNum);
                    else
                        processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, rowNumbers[i], rowNum);
                        i = i + 1;
                    end;

                    row    = row + 1;
                    rowNum = rowNum + 1;
                    valueIteratorManualInput.moveNext();
                    structValueManualInput = valueIteratorManualInput.currentItem();
                end;

                if (m_applicationCode != "F501_1_OBR")
                    processCompositeValue(m_fieldsIterator, structValue, row, rowNum);
                else
                    processCompositeValue(m_fieldsIterator, structValue, rowNumbers[i], rowNum);
                    i = i + 1;
                end;

                row    = row + 1;
                rowNum = rowNum + 1;
                valueIterator.moveNext();
            end;

            while (not valueIteratorManualInput.isDone())
                structValueManualInput = valueIteratorManualInput.currentItem();

                if (m_applicationCode != "F501_1_OBR")
                    processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, row, rowNum);
                else
                    processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, rowNumbers[i], rowNum);
                    i = i + 1;
                end;
                row    = row + 1;
                rowNum = rowNum + 1;
                valueIteratorManualInput.moveNext();
            end;
        else
            /*  справочное приложение F501_N  */
            n = 0;
            while (n < m_sumPartNotResidentArray.size)
                printExportString(string(n+1:9:o), "CODE",  n+1);
                printExportString(string(n+1:9:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);
                printExportString(string(n+1:9:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);
                printExportString(string(n+1:9:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);
                printExportString(string(n+1:9:o), "CNAME", getCountryName(m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact));
                n=n+1;
            end;
        end;
    end;

    private macro constructor(view, part, head)
        initTPtkPsdExportPartController_I4212(view, part, head);

        if (m_applicationCode == "F501_1")
            rowNumbers.size = 0;
        end;

        m_fieldsIterator.initialize(         TRecord("npp",       "",                          ""                 ),
                                             TRecord("res",       "",                          "УсловныйКод"      ),
                                             TRecord("1",         "НаимКО",                    ""                 ),
                                             TRecord("2",         "РегНом",                    ""                 ),
                                             TRecord("3",         "КодСтр",                    "БИК"              ),
                                             TRecord("4",         "НомБС",                     ""                 ),
                                             TRecord("5",         "НомЛС",                     ""                 ),
                                             TRecord("7",         "ОстВход",                   ""                 ),
                                             TRecord("8",         "ОбДебет",                   ""                 ),
                                             TRecord("9",         "ОбКредит",                  ""                 ),
                                             TRecord("10",        "ОстИсход",                  ""                 ),
                                             TRecord("11",        "ДатаИспОб",                 ""                 ),
                                             TRecord("12",        "ПрСтавка",                  "ПризнакГД"        ),
                                             TRecord("repo",      "ПризнакРЕПО",               ""                 ),
                                             TRecord("gdep",      "ПризнакГД",                 ""                 ),
                                             TRecord("pzt",       "Пояснения",                 "ПризнакТретьеЛицо"),
                                             TRecord("nom",       "",                          ""                 ),
                                             TRecord("kod_obr",   "ПризнакОбременения",        ""                 ),
                                             TRecord("npers_obr", "ЛицоПоОбрем",               ""                 ),
                                             TRecord("kpers_obr", "УсловныйКод",               ""                 ),
                                             TRecord("res_obr",   "",                          "УсловныйКод"      ),
                                             TRecord("2_obr",     "ИдентификаторОбрем",        ""                 ),
                                             TRecord("vid_obz",   "ВидОбрем",                  ""                 ),
                                             TRecord("sum_obz",   "ОстатокПоСчетуОбрем",       "ВидОбрем"         ),
                                             TRecord("date_obz",  "ДатаПогашения",             ""                 ),
                                             TRecord("prim_obz",  "ИноеРасшифровка",           ""                 )
                                   );

        m_fieldsUserInputIterator.initialize(TRecord("npp",       "",                          ""                 ),
                                             TRecord("res",       "",                          "УсловныйКод_ввод" ),
                                             TRecord("1",         "НаимКО",                    ""                 ),
                                             TRecord("2",         "РегНом",                    ""                 ),
                                             TRecord("3",         "КодСтр",                    "БИК_ввод"         ),
                                             TRecord("4",         "НомБС_ввод",                ""                 ),
                                             TRecord("5",         "НомЛС_ввод",                ""                 ),
                                             TRecord("7",         "ОстВход_ввод",              ""                 ),
                                             TRecord("8",         "ОбДебет_ввод",              ""                 ),
                                             TRecord("9",         "ОбКредит_ввод",             ""                 ),
                                             TRecord("10",        "ОстИсход_ввод",             ""                 ),
                                             TRecord("11",        "ДатаИспОб_ввод",            ""                 ),
                                             TRecord("12",        "ПрСтавка_ввод",             ""                 ),
                                             TRecord("pzt",       "Пояснения_ввод",            "ххх_ввод"         ),
                                             TRecord("nom",       "",                          ""                 ),
                                             TRecord("kod_obr",   "ПризнакОбременения_ввод",   ""                 ),
                                             TRecord("npers_obr", "ЛицоПоОбрем_ввод",          ""                 ),
                                             TRecord("kpers_obr", "УсловныйКод_ввод",          ""                 ),
                                             TRecord("res_obr",   "",                          "УсловныйКод_ввод" ),
                                             TRecord("2_obr",     "ИдентификаторОбрем_ввод",   ""                 ),
                                             TRecord("vid_obz",   "ВидОбрем_ввод",             ""                 ),
                                             TRecord("sum_obz",   "ОстатокПоСчетуОбрем_ввод",  "ВидОбрем_ввод"    ),
                                             TRecord("date_obz",  "ДатаПогашения_ввод",        ""                 ),
                                             TRecord("prim_obz",  "ИноеРасшифровка_ввод",      ""                 )
                                            );

    end;

    constructor(view, part, head);
end;

class (TPtkPsdExportPartController_0MW1G) TPtkPsdExportPartController_I5456(view, part, head)
    private macro processCompositeValue(c : Tcodes, curItemValues, row, rowNum)
        var gdepIndication;
        var posNotResident;
        var isResident : bool;
        var onerousKind;                             //вид обременения для текущей строки
        var temp;
        var d,m,y;
        var fieldName_kod_obr = getFieldName(c, "kod_obr");  //имя поля структурной переменной для кода колонки kod_obr
        var fieldName_vid_obz = getFieldName(c, "vid_obz");  //имя поля структурной переменной для кода колонки vid_obz

        //запоминаем номера строк с обременением для F501_1_OBR
        if (m_applicationCode == "F501_1")
            if (    (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != "0")
                and (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != null)
                and (curItemValues.fieldValue(fieldName_kod_obr).scaledAsString != stringUndefined)
               )
                rowNumbers[rowNumbers.size] = row;
            end;
        end;

        if (m_applicationCode == "F501_1")
            if (    (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != "0")
                and (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != null)
                and (curItemValues.fieldValue(fieldName_vid_obz).scaledAsString != "")
               )
                rowNumbers[rowNumbers.size] = row;
            end;
        end;

        c.moveFirst();
        while (c.moveNext())
            //графы, связанные с обременением (13..17) выводятся только для приложения с кодом F501_1_OBR
            if (   (    (m_applicationCode != "F501_1_OBR")
                    and (in(c.getColumnCode(), "nom", "kod_obr", "npers_obr", "kpers_obr", "res_obr", "2_obr", "vid_obz", "sum_obz", "date_obz", "prim_obz"))
                   )
                or (    (m_applicationCode == "F501_1_OBR")
                    and (in(c.getColumnCode(), "res", "1", "2", "3", "4", "5", "7", "8", "9", "10", "11", "12", "repo", "gdep", "pzt"))
                   )
                or (
                        (m_applicationCode == "F501_3")
                    and (in(c.getColumnCode(), "8", "9", "11", "12"))
                   )
               )
                continue;
            end;

            if   (c.getColumnCode() == "res")
                if (curItemValues.fieldValue("КодСтр").scaledAsString != "643")
                    posNotResident = findNewNotResident(curItemValues, m_sumPartNotResidentArray);
                    if (posNotResident == -1)
                        posNotResident = m_sumPartNotResidentArray.size;
                        m_sumPartNotResidentArray[m_sumPartNotResidentArray.size] = curItemValues;
                    end;
                    printExportString(rowNumberToString(row), "res", posNotResident + 1);

                    isResident = false;
                else
                    printExportString(rowNumberToString(row), "res", 0);  //признак резидента = 0
                    isResident = true;
                end;

            elif   (c.getColumnCode() == 3)
                if (isResident)
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), ternary(curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == "Undefined", "", curItemValues.fieldValue(c.getAddFieldName()).scaledAsString));
                else
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Дата исполнения обязательства (графа 11)
            elif (c.getColumnCode() == 11)
                if (curItemValues.fieldValue(c.getFieldName()).scaledAsString != "Undefined")
                    if (curItemValues.fieldValue(c.getFieldName()).scaledAsString == "д/в")
                        printExportString(rowNumberToString(row), string(c.getColumnCode()), "-1");
                    else
                        temp = Date(Trim(curItemValues.fieldValue(c.getFieldName()).scaledAsString));
                        DateSplit(temp, d, m, y);

                        if ((d != 0) and (m != 0) and (y != 0))
                            printExportString(rowNumberToString(row), string(c.getColumnCode()), string(y:4:o) + string(m:2:o) + string(d:2:o));
                        end;
                    end;
                end;

            //процентная ставка (графа 12)
            elif (c.getColumnCode() == 12)
                //F501_1
                if (c.getAddFieldName() != "")
                    gdepIndication = curItemValues.fieldValue(c.getAddFieldName()).scaledAsString;

                    if (gdepIndication != 1)
                        printExportString(rowNumberToString(row), string(c.getColumnCode()), string(curItemValues.fieldValue(c.getFieldName()).exact:0:2));
                    end;
                //F501_1_vvod
                else
                    printExportString(rowNumberToString(row), string(c.getColumnCode()), string(curItemValues.fieldValue(c.getFieldName()).exact:0:2));
                end;

            //Пояснения о характере сделки
            elif (c.getColumnCode() == "pzt")
                if (   (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == 1)                                          //
                    or (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == "***"))                                     //пользовательский ввод
                    printExportString(rowNumberToString(row), "pzt", curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Порядковый номер строки в печатной форме (графа 1)
            elif (c.getColumnCode() == "npp")
                printExportString(rowNumberToString(row), "npp", rowNum);

            //Номер обременения по лицевому счету
            elif (c.getColumnCode() == "nom")
                printExportString(rowNumberToString(row), "nom", "1");

            //npers_obr/ для обременения по л/с /Пустое значение не выгружается
            elif (c.getColumnCode() == "npers_obr")
                if (curItemValues.fieldValue(c.getFieldName()).scaledAsString != "0")
                    printExportString(rowNumberToString(row), "npers_obr", curItemValues.fieldValue(c.getFieldName()).scaledAsString);
                end;

            //Номер пункта п/п банка-нерезидента
            elif (c.getColumnCode() == "res_obr")
                if (curItemValues.fieldValue(c.getAddFieldName()).scaledAsString == 4)
                    printExportString(rowNumberToString(row), "res_obr", posNotResident);
                end;

            //стоимость (графа 16)
            elif (c.getColumnCode() == "sum_obz")
                onerousKind = curItemValues.fieldValue(c.getAddFieldName()).scaledAsString;

                if (    (onerousKind != "")
                    and (onerousKind != stringUndefined))
                    printExportString(rowNumberToString(row), "sum_obz", string(curItemValues.fieldValue(c.getFieldName()).scaledAsString));
                end;

            //Срок погашения обремененного обязательства (графа 17) Формат экспорта: ГГГГММДД
            elif (c.getColumnCode() == "date_obz")
                if (curItemValues.fieldValue(c.getFieldName()).currentAsString != "")
                    printExportString(rowNumberToString(row), "date_obz", getDate_YYYYMMDD(curItemValues.fieldValue(c.getFieldName()).currentAsString));
                end;

            //обработка колонок по умолчанию
            else
                printExportString(rowNumberToString(row), string(c.getColumnCode()), curItemValues.fieldValue(c.getFieldName()).scaledAsString);
            end;
        end;
    end;

    private macro printPartExportString(varName : String)
        var formVariable            = RcbApplication.CurrentReport.attributeValue(varName);
        var formVariableManualInput;
        if (varName != "Ф501_3")
            formVariableManualInput = RcbApplication.CurrentReport.attributeValue(varName + "ввод");
        end;
        var row                     = 1;          /*номер строки раздела*/
        var rowNum                  = 1;          /*номер строки в печатной форме*/
        var structValue;
        var structValueManualInput;
        var n;
        var i = 0;

        if (varName != "")
            //F501_1, F501_2, F501_3
            var valueIterator            = formVariable.createValueIterator();
            if (varName != "Ф501_3")
                var valueIteratorManualInput = formVariableManualInput.createValueIterator();
            end;

            valueIterator.setFilter(TFilter());
            valueIterator.setSortOrder(TSorter());
            valueIterator.moveFirst();

            if (varName != "Ф501_3")
                valueIteratorManualInput.setFilter(TFilterManualInput());
                valueIteratorManualInput.setSortOrder(TSorterManualInput());
                valueIteratorManualInput.moveFirst();
            end;

            if (m_applicationCode == "F501_1_OBR")
                valueIterator.setFilter(TObremFilter());
                if (varName != "Ф501_3")
                    valueIteratorManualInput.setFilter(TObremInputFilter());
                end;
            end;

            while (not valueIterator.isDone())
                structValue            = valueIterator.currentItem();
                if (varName != "Ф501_3")
                    structValueManualInput = valueIteratorManualInput.currentItem();

                    while (    (not valueIteratorManualInput.isDone())
                        and (not isFirstRecordLess(structValue, structValueManualInput)))

                        if (m_applicationCode != "F501_1_OBR")
                            processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, row, rowNum);
                        else
                            processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, rowNumbers[i], rowNum);
                            i = i + 1;
                        end;

                        row    = row + 1;
                        rowNum = rowNum + 1;
                        valueIteratorManualInput.moveNext();
                        structValueManualInput = valueIteratorManualInput.currentItem();
                    end;
                end;

                if (m_applicationCode != "F501_1_OBR")
                    processCompositeValue(m_fieldsIterator, structValue, row, rowNum);
                else
                    processCompositeValue(m_fieldsIterator, structValue, rowNumbers[i], rowNum);
                    i = i + 1;
                end;

                row    = row + 1;
                rowNum = rowNum + 1;
                valueIterator.moveNext();
            end;

            if (varName != "Ф501_3")
                while (not valueIteratorManualInput.isDone())
                    structValueManualInput = valueIteratorManualInput.currentItem();

                    if (m_applicationCode != "F501_1_OBR")
                        processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, row, rowNum);
                    else
                        processCompositeValue(m_fieldsUserInputIterator, structValueManualInput, rowNumbers[i], rowNum);
                        i = i + 1;
                    end;
                    row    = row + 1;
                    rowNum = rowNum + 1;
                    valueIteratorManualInput.moveNext();
                end;
            end;
        else
            /*  справочное приложение F501_N  */
            n = 0;
            while (n < m_sumPartNotResidentArray.size)
                printExportString(string(n+1:9:o), "CODE",  n+1);
                printExportString(string(n+1:9:o), "SWIFT", m_sumPartNotResidentArray[n].fieldValue("РегНом").exact);
                printExportString(string(n+1:9:o), "NAME",  m_sumPartNotResidentArray[n].fieldValue("НаимКО").exact);
                printExportString(string(n+1:9:o), "ISO",   m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact);
                printExportString(string(n+1:9:o), "CNAME", getCountryName(m_sumPartNotResidentArray[n].fieldValue("КодСтр").exact));
                n=n+1;
            end;
        end;
    end;

    macro execute(allPartNotResidentArray)
         m_stringVariableArray            = TArray();
         m_stringVariableArrayManualInput = TArray();
         m_sumPartNotResidentArray        = allPartNotResidentArray;

         initStringVariableArray();
         if(m_part != 3)
            initStringVariableArrayManualInput();
         end;

         if (m_part == 10)
             //справочно
             printPartExportString("");
         elif (m_part == 1)
             printPartExportString("Ф501_1");
         elif (m_part == 2)
             printPartExportString("Ф501_2");
         elif (m_part == 3)
             printPartExportString("Ф501_3");
         end;
         return m_sumPartNotResidentArray;
    end;

    private macro constructor(view, part, head)
        initTPtkPsdExportPartController_0MW1G(view, part, head);

        m_fieldsIterator.clear();
        m_fieldsUserInputIterator.clear();

        if (m_applicationCode == "F501_1")
            rowNumbers.size = 0;
        end;

        m_fieldsIterator.initialize(         TRecord("npp",       "",                          ""                 ),
                                             TRecord("res",       "",                          "УсловныйКод"      ),
                                             TRecord("1",         "НаимКО",                    ""                 ),
                                             TRecord("2",         "РегНом",                    ""                 ),
                                             TRecord("3",         "КодСтр",                    "БИК"              ),
                                             TRecord("4",         "НомБС",                     ""                 ),
                                             TRecord("5",         "НомЛС",                     ""                 ),
                                             TRecord("7",         "ОстВход",                   ""                 ),
                                             TRecord("8",         "ОбДебет",                   ""                 ),
                                             TRecord("9",         "ОбКредит",                  ""                 ),
                                             TRecord("10",        "ОстИсход",                  ""                 ),
                                             TRecord("11",        "ДатаИспОб",                 ""                 ),
                                             TRecord("12",        "ПрСтавка",                  "ПризнакГД"        ),
                                             TRecord("repo",      "ПризнакРЕПО",               ""                 ),
                                             TRecord("gdep",      "ПризнакГД",                 ""                 ),
                                             TRecord("pzt",       "Пояснения",                 "ПризнакТретьеЛицо"),
                                             TRecord("nom",       "",                          ""                 ),
                                             TRecord("kod_obr",   "ПризнакОбременения",        ""                 ),
                                             TRecord("npers_obr", "ЛицоПоОбрем",               ""                 ),
                                             TRecord("kpers_obr", "УсловныйКод",               ""                 ),
                                             TRecord("res_obr",   "",                          "УсловныйКод"      ),
                                             TRecord("2_obr",     "ИдентификаторОбрем",        ""                 ),
                                             TRecord("vid_obz",   "ВидОбрем",                  ""                 ),
                                             TRecord("sum_obz",   "ОстатокПоСчетуОбрем",       "ВидОбрем"         ),
                                             TRecord("date_obz",  "ДатаПогашения",             ""                 ),
                                             TRecord("prim_obz",  "ИноеРасшифровка",           ""                 )
                                   );

        m_fieldsUserInputIterator.initialize(TRecord("npp",       "",                          ""                 ),
                                             TRecord("res",       "",                          "УсловныйКод_ввод" ),
                                             TRecord("1",         "НаимКО",                    ""                 ),
                                             TRecord("2",         "РегНом",                    ""                 ),
                                             TRecord("3",         "КодСтр",                    "БИК_ввод"         ),
                                             TRecord("4",         "НомБС_ввод",                ""                 ),
                                             TRecord("5",         "НомЛС_ввод",                ""                 ),
                                             TRecord("7",         "ОстВход_ввод",              ""                 ),
                                             TRecord("8",         "ОбДебет_ввод",              ""                 ),
                                             TRecord("9",         "ОбКредит_ввод",             ""                 ),
                                             TRecord("10",        "ОстИсход_ввод",             ""                 ),
                                             TRecord("11",        "ДатаИспОб_ввод",            ""                 ),
                                             TRecord("12",        "ПрСтавка_ввод",             ""                 ),
                                             TRecord("pzt",       "Пояснения_ввод",            "ххх_ввод"         ),
                                             TRecord("nom",       "",                          ""                 ),
                                             TRecord("kod_obr",   "ПризнакОбременения_ввод",   ""                 ),
                                             TRecord("npers_obr", "ЛицоПоОбрем_ввод",          ""                 ),
                                             TRecord("kpers_obr", "УсловныйКод_ввод",          ""                 ),
                                             TRecord("res_obr",   "",                          "УсловныйКод_ввод" ),
                                             TRecord("2_obr",     "ИдентификаторОбрем_ввод",   ""                 ),
                                             TRecord("vid_obz",   "ВидОбрем_ввод",             ""                 ),
                                             TRecord("sum_obz",   "ОстатокПоСчетуОбрем_ввод",  "ВидОбрем_ввод"    ),
                                             TRecord("date_obz",  "ДатаПогашения_ввод",        ""                 ),
                                             TRecord("prim_obz",  "ИноеРасшифровка_ввод",      ""                 )
                                            );

    end;

    constructor(view, part, head);
end;

/**
 * Операция экспорта в АС ПСД отчета.
 */
class  T501PtkPsdExportController()
    private var m_ptkPsdExportPartControllers : TArray;
    private var m_allPartNotResidentArray     : TArray;
    private var m_ptkPsdView;
    private var m_report;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_allPartNotResidentArray     = TArray();
        m_ptkPsdView                  = genObject("T501PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "1", "F501_1");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "2", "F501_2");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "3", "F501_N");
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", RcbApplication().currentReport.form.id);

       if (not RcbApplication().currentReport.isCalculated)
            protocolView.checkCalculateReport("АС ПСД");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        while ( i < m_ptkPsdExportPartControllers.size)
            m_allPartNotResidentArray = m_ptkPsdExportPartControllers[i].execute(m_allPartNotResidentArray);
            i = i + 1;
        end;
        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class  (T501PtkPsdExportController) T501PtkPsdExportController_I2332()
    initT501PtkPsdExportController();

    private macro getDescriptorInfo()
        return "fr2_2_501.docx от 07.02.2014";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_allPartNotResidentArray     = TArray();
        m_ptkPsdView                  = genObject("T501PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I2332(m_ptkPsdView,  "1", "F501_1");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I2332(m_ptkPsdView,  "2", "F501_2");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I2332(m_ptkPsdView,  "3", "F501_N");
    end;
end;

class (T501PtkPsdExportController_I2332) T501PtkPsdExportController_I4212()
    initT501PtkPsdExportController_I2332();

    private macro getDescriptorInfo()
        return "Формат экспорта в АС ПСД доработан \"по интуиции\" в соответствии с требованиями Указания № 4212-У";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_allPartNotResidentArray     = TArray();
        m_ptkPsdView                  = genObject("T501PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I4212(m_ptkPsdView,  "1", "F501_1");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I4212(m_ptkPsdView,  "2", "F501_2");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I4212(m_ptkPsdView,  "3", "F501_N");
    end;
end;

class (T501PtkPsdExportController_I4212) T501PtkPsdExportController_0MW1G()
    initT501PtkPsdExportController_I4212();

    private macro getDescriptorInfo()
        return "Формат экспорта доработан по метаданным 0mw1g, загруженным в АС ПСД";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_allPartNotResidentArray     = TArray();
        m_ptkPsdView                  = genObject("T501PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_0MW1G(m_ptkPsdView,  "1", "F501_1");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_0MW1G(m_ptkPsdView,  "1", "F501_1_OBR");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_0MW1G(m_ptkPsdView,  "2", "F501_2");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_0MW1G(m_ptkPsdView,  "3", "F501_N");
    end;
end;

class (T501PtkPsdExportController_I4212) T501PtkPsdExportController_I5456()
    initT501PtkPsdExportController_I4212();

    private macro getDescriptorInfo()
        return "Формат экспорта доработан по Указанию № 5456-У";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_allPartNotResidentArray     = TArray();
        m_ptkPsdView                  = genObject("T501PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I5456(m_ptkPsdView,  "1", "F501_1");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I5456(m_ptkPsdView,  "1", "F501_1_OBR");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I5456(m_ptkPsdView,  "2", "F501_2");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I5456(m_ptkPsdView,  "3", "F501_3");
        // Справочное приложение F501_N. Список банков - нерезидентов
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_I5456(m_ptkPsdView,  "10", "F501_N");
    end;
end;

private macro executePtkPsdExportOperation()
    if   (   (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE) 
          or (is5456RSHBChangesProject() and (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE_F501)))
        T501PtkPsdExportController_I5456().execute();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_0MW1G_DATE)
        T501PtkPsdExportController_0MW1G().execute();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I4212_DATE)
        T501PtkPsdExportController_I4212().execute();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I2332_DATE)
        T501PtkPsdExportController_I2332().execute();
    else
        T501PtkPsdExportController().execute();
    end;
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
