/*
$Name:          f410DataSourceFilters.mac
$Module:        Отчеты ЦБ
$Description:   Форма 410. Фильтры источников данных.
*/

/**
 * Форма 410. Фильтр ИД ГКБО.
 *
 * @since 08.10.2018
 * @version 6.20.031.052
 */
class (RcbBoCbDataSourceFilter) TCbDatasourceFilter(id : String)
    macro create()
        return genObject(genClassName(this), getId());
    end;

    macro isSatisfiesToMasks(masks : String, alias : String)
        if (masks == "")
            masks = strfor(255);
        end;

        return isSatisfiesToMasks(masks, alias);
    end;

    /**
     * Буквенный код ФИ по ISO входит в список заданных кодов
     */
    macro isFiIsoCodeIn(fiIsoCodes : String, alias : String)
        var sqllist = "";

        for (var i, strcut(fiIsoCodes))
            if ((i != null) and (trim(i) != ""))
                sqllist = sqllist + "," + getSqlString(trim(i));
            end;
        end;

        if (sqllist != "")
            sqllist = substr(sqllist, 2);
        end;

        m_filter = m_filter +
                   "EXISTS (SELECT 1"
            +"\n"+ "          FROM drepFinInstrument_vw"
            +"\n"+ "         WHERE    drepFinInstrument_vw.t_ccy = " + procesAlias(alias, "t_iso_code")
            +"\n"+ "              AND drepFinInstrument_vw.t_ccy IN (" + sqllist + ")"
            +"\n"+ "       )"
            ;

        return this;
    end;

    macro contractorIsResident(alias : String)
        m_filter = m_filter + " (" + NVL(alias, "party.t_isResident") + " = 1) ";
        return this;
    end;

    private macro constructorTCbDatasourceFilter(id : String)
        initRcbBoCbDataSourceFilter(id, "account");
    end;

    constructorTCbDatasourceFilter(id);
end;

class (RcbDataSourceFilters) TF410DataSourceFilters()
    private macro initialize()
        m_dataSourceFiltersPool.push_back(TCbDatasourceFilter("cb"));
    end;

    private macro constructorTF410DataSourceFilters()
        initRcbDataSourceFilters();
    end;

    constructorTF410DataSourceFilters();
end;