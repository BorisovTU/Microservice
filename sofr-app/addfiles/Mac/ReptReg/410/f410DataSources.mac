/*
$Name:          f410DataSources.mac
$Module:        Отчеты ЦБ
$Description:   Форма 410. Источники данных.
*/

import lib_str;
import rcb_bo;

/**
 * Форма 410. Данные по разделу
 *
 * @since 03.10.2018
 * @version 6.20.031.052
 */
private class (RcbDataSource) TPartData(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
    /**
     * Фильтр
     */
    private var m_filter : Object = objectFactoryInstance.createDataSourceFilters().getFilter("cb");

    /**
     *  Ресурсы ИД
     */
    private var m_resource : Object = objectFactoryInstance.createResource().getDataSource();

    /**
     *  Код сектора кредитора (дебитора) нерезидента / резидента (код категории)
     */
    private var m_creditorSector = null;

    /**
     * Фильтр для раздела
     */
    private macro setPartFilter()
        m_filter.clear();
    end;

    /**
     * Получения текста запроса для базовых данных
     */
    private macro getBaseQuery()
        if (m_creditorSector == null)
            throw(TUnspecifiedValueException("TPartData::m_creditorSector", "m_creditorSector"));
        end;

        var baseQuery =
                     "SELECT deals.t_number,"
            + "\n" + "                             deals.t_id,"
            + "\n" + "                             deals.t_openDate,"
            + "\n" + "                             account.t_account,"
            + "\n" + "                             account.t_fiId,"
            + "\n" + "                             rsb_fiinstr.convSumType(account.t_outRest,"
            + "\n" + "                                                     account.t_fiId,"
            + "\n" + "                                                     " + m_resource.dollarCode +","
            + "\n" + "                                                     " + m_resource.RATETYPE_CB +","
            + "\n" + "                                                     rep_data.getEndDate())     AS t_value,"
            + "\n" + "                             account.t_outRest,"
            + "\n" + "                             account.t_outCoverRest,"
            + "\n" + "                             (SELECT CASE"
            + "\n" + "                                         WHEN t_isoNumber IN (" + m_resource.currencyList + ")"
            + "\n" + "                                             THEN t_isoNumber"
            + "\n" + "                                         WHEN t_isoNumber = " + m_resource.roubleCodeIso
            + "\n" + "                                             THEN '643'"
            + "\n" + "                                         ELSE " + m_resource.otherCode
            + "\n" + "                                     END AS t_isoNumber"
            + "\n" + "                                FROM drepFinInstrument_vw"
            + "\n" + "                               WHERE    drepFinInstrument_vw.t_ccy = account.t_iso_code"
            + "\n" + "                                    AND t_id = account.t_fiId)                          AS t_currency,"
            + "\n" + "                             NVL((SELECT atc.t_value"
            + "\n" + "                                    FROM drepcategory_vw atc"
            + "\n" + "                                   WHERE     atc.t_id                    = " + m_creditorSector
            + "\n" + "                                         AND atc.t_objectType            = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                         AND atc.t_objectId              = party.t_objectid"
            + "\n" + "                                         AND atc.t_isInstalledForEndDate = 1"
            + "\n" + "                                  )," + getSQLChar("") + ")                                             AS t_sectorCode,"
            + "\n" + "                             NVL((SELECT atc.t_value"
            + "\n" + "                                   FROM drepcategory_vw atc"
            + "\n" + "                                  WHERE     atc.t_id                    = " + RCB_OBJGROUP_PT_CHARACTER 
            + "\n" + "                                        AND atc.t_objectType            = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                        AND atc.t_objectId              = party.t_objectid"
            + "\n" + "                                        AND atc.t_isInstalledForEndDate = 1"
            + "\n" + "                                  ), " + getSQLChar("") + ")                                            AS t_relationsBank,"
            + "\n" + "                             NVL((SELECT atc.t_value"
            + "\n" + "                                    FROM drepcategory_vw atc"
            + "\n" + "                                   WHERE     atc.t_id                    = " + RCB_OBJGROUP_REPORTING_COUNTRY
            + "\n" + "                                         AND atc.t_objectType            = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                         AND atc.t_objectId              = party.t_superior"
            + "\n" + "                                         AND atc.t_isInstalledForEndDate = 1"
            + "\n" + "                                  ), " + getSQLChar("") + ")                                            AS t_reportCountrySuperior,"
            + "\n" + "                             NVL((SELECT atc.t_value"
            + "\n" + "                                    FROM drepcategory_vw atc"
            + "\n" + "                                   WHERE     atc.t_id                    = " + RCB_OBJGROUP_REPORTING_COUNTRY
            + "\n" + "                                         AND atc.t_objectType            = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                         AND atc.t_objectId              = party.t_objectid"
            + "\n" + "                                         AND atc.t_isInstalledForEndDate = 1"
            + "\n" + "                                  ), " + getSQLChar("") + ")                                            AS t_reportCountryContragent,"
            + "\n" + "                             NVL((SELECT atc.t_value"
            + "\n" + "                                    FROM drepcategory_vw atc"
            + "\n" + "                                   WHERE     atc.t_id                    = " + RCB_OBJGROUP_COUNTRY_GROUP
            + "\n" + "                                         AND atc.t_objectType            = " + RCB_OBJTYPE_COUNTRY
            + "\n" + "                                         AND atc.t_objectId              = party.t_countryCode"
            + "\n" + "                                         AND atc.t_isInstalledForEndDate = 1"
            + "\n" + "                                  ), " + getSQLChar("") + ")                                            AS t_countryIdentity,"
            + "\n" + "                             party.t_name,"
            + "\n" + "                             party.t_countryHistoryCode                                 AS t_countryCode,"
            + "\n" + "                             (SELECT NVL(pt.t_countryHistoryCode, " + getSQLChar("") + ")"
            + "\n" + "                                FROM dRepParty_vw pt"
            + "\n" + "                               WHERE pt.t_id = party.t_superior)                        AS t_superior,"
            + "\n" + "                             party.t_isBank,"
            + "\n" + "                             party.t_isPhisical,"
            + "\n" + "                             party.t_isCentralBank,"
            + "\n" + "                             party.t_isInternationalCorporation,"
            + "\n" + "                             party.t_isWorldDevelopmentBank,"
            + "\n" + "                             party.t_isEvrasianDevelopmentBank,"
            + "\n" + "                             party.t_isBlackSeaDevelopmentBank,"
            + "\n" + "                             party.t_isVneshEconomBank,"
            + "\n" + "                             party.t_isInternationSettlementsBank,"
            + "\n" + "                             party.t_isEuropeanCentralBank,"
            + "\n" + "                             party.t_isInternalFinanceCorporation,"
            + "\n" + "                             party.t_isForeignBranch,"
            + "\n" + "                             party.t_isResident,"
            + "\n" + "                             RANK() OVER(PARTITION BY account.t_account"
            + "\n" + "                                    ORDER BY deals.t_id,"
            + "\n" + "                                             deals.t_number,"
            + "\n" + "                                             account.t_account)                         AS rankAccount"
            + "\n" + "                        FROM dRepAccount_vw account"
            + "\n" + "                  INNER JOIN (SELECT d.t_id, d.t_number, d.t_contragentId, d.t_mainRestAccount, d.t_delaydMainRestAcc, d.t_accruedInterestAccount, d.t_delaydPercentAcc, d.t_plannedFinishDate, d.t_openDate, d.t_isOpenedAtEndDate, a.t_accountId  FROM repMmDeals_vw d,  dRepAccount_vw a WHERE a.t_chapter = 1 AND a.t_account = d.t_mainRestAccount"
            + "\n" + "                              UNION"
            + "\n" + "                              SELECT d.t_id, d.t_number, d.t_contragentId, d.t_mainRestAccount, d.t_delaydMainRestAcc, d.t_accruedInterestAccount, d.t_delaydPercentAcc, d.t_plannedFinishDate, d.t_openDate, d.t_isOpenedAtEndDate, a.t_accountId FROM repMmDeals_vw d,  dRepAccount_vw a WHERE a.t_chapter = 1 AND a.t_account = d.t_delaydMainRestAcc"
            + "\n" + "                              UNION"
            + "\n" + "                              SELECT d.t_id, d.t_number, d.t_contragentId, d.t_mainRestAccount, d.t_delaydMainRestAcc, d.t_accruedInterestAccount, d.t_delaydPercentAcc, d.t_plannedFinishDate, d.t_openDate, d.t_isOpenedAtEndDate, a.t_accountId FROM repMmDeals_vw d,  dRepAccount_vw a WHERE a.t_chapter = 1 AND a.t_account = d.t_accruedInterestAccount"
            + "\n" + "                              UNION"
            + "\n" + "                              SELECT d.t_id, d.t_number, d.t_contragentId, d.t_mainRestAccount, d.t_delaydMainRestAcc, d.t_accruedInterestAccount, d.t_delaydPercentAcc, d.t_plannedFinishDate, d.t_openDate, d.t_isOpenedAtEndDate, a.t_accountId FROM repMmDeals_vw d,  dRepAccount_vw a WHERE a.t_chapter = 1 AND a.t_account = d.t_delaydPercentAcc) deals"
            + "\n" + "                          ON (deals.t_accountId = account.t_accountId),"
            + "\n" + "                             dRepParty_vw party"
            + "\n" + "                       WHERE account.t_chapter = 1"
            + "\n" + "                         AND deals.t_contragentId = party.t_id"
            + "\n" + "                         AND deals.t_plannedFinishDate = (SELECT MAX(d.t_plannedFinishDate)"
            + "\n" + "                                                            FROM repMmDeals_vw d"
            + "\n" + "                                                           WHERE    (   d.t_mainRestAccount        = account.t_account"
            + "\n" + "                                                                     OR d.t_delaydMainRestAcc      = account.t_account"
            + "\n" + "                                                                     OR d.t_accruedInterestAccount = account.t_account"
            + "\n" + "                                                                     OR d.t_delaydPercentAcc       = account.t_account)"
            + "\n" + "                                                                 AND d.t_isOpened = 1)"
            + "\n" + "                         AND deals.t_isOpenedAtEndDate = 1"
            + "\n" + "                         /*FILTER_BEGIN*/"
            + "\n" + "                         AND " + m_filter.isSuitable()
            + "\n" + "                         /*FILTER_END*/";
        return baseQuery;
    end;

    /**
     * Получения текста запроса для калькуляции раздела на основе базовых данных
     */
    private macro getCalculateQuery()
        throw(TPureVirtualMethodCallException("TPartData::getCalculateQuery"));
    end;

    /**
     * Итерфейс взаимодействия с ИД, компановка sql текста запроса, фильтров
     *
     * param Object               currentCode - TRsbDataset c параметрами для запроса
     * param RcbDataSourceFilters filter      - фильтр
     *
     * return Object              dataset     - TRsbDataset результат выборки
     */
    macro getData(currentCode : Object, filter : RcbDataSourceFilters) : Object
        if (currentCode != null)
            m_resource.initialize(currentCode);
        else
            throw(TUnspecifiedValueException("TPartData::currentCode", "currentCode"));
        end;

        setPartFilter();

        m_filter.op("AND").accountIsOpened();
        m_filter.op("AND").op("(");
            m_filter.isSatisfiesToMasks(NVL(m_resource.getAccountMasks(), ""));
            m_filter.op("OR").op("(");
                m_filter.op("(");
                    m_filter.isSatisfiesToMasks(NVL(m_resource.getAccountMasks(), ""), "deals.t_mainRestAccount");
                    m_filter.op("OR").isSatisfiesToMasks(NVL(m_resource.getAccountMasks(), ""), "deals.t_delaydMainRestAcc");
                m_filter.op(")");
            m_filter.op("AND").isSatisfiesToMasks(NVL(m_resource.getAccountPercentMasks(), ""));
            m_filter.op(")");
        m_filter.op(")");

        if (filter != null)
            m_filter.add(filter);
        end;

        var query =  "       SELECT t_symbol,"
            + "\n" + "              t_sector,"
            + "\n" + "              t_country,"
            + "\n" + "              t_currency,"
            + "\n" + "              SUM(t_restInRate)                     AS t_value,"
            + "\n" + "              SUM(t_rest)                           AS t_rest,"
            + "\n" + "              SUM(t_coverRest)                      AS t_coverRest,"
            + "\n" + "              t_rate,"
            + "\n" + "              t_openDate,"
            + "\n" + "              t_numberDeal,"
            + "\n" + "              t_account,"
            + "\n" + "              t_addInfo,"
            + "\n" + "              t_partId"
            + "\n" + "         FROM (" + getCalculateQuery() + ")"
            + "\n" + "GROUP BY ROLLUP (t_symbol,"
            + "\n" + "                 t_sector,"
            + "\n" + "                 t_country,"
            + "\n" + "                 t_currency,"
            + "\n" + "                 t_partId,"
            + "\n" + "                 (t_openDate,"
            + "\n" + "                  t_numberDeal,"
            + "\n" + "                  t_account,"
            + "\n" + "                  t_addInfo,"
            + "\n" + "                  t_rest,"
            + "\n" + "                  t_coverRest,"
            + "\n" + "                  t_rate,"
            + "\n" + "                  t_restInRate))"
            + "\n" + "       HAVING (    GROUPING (t_symbol) = 0"
            + "\n" + "               AND GROUPING (t_sector) = 0"
            + "\n" + "               AND GROUPING (t_country) = 0"
            + "\n" + "               AND GROUPING (t_currency) = 0"
            + "\n" + "               AND GROUPING (t_partId) = 0)"
            + "\n" + "     ORDER BY t_symbol,"
            + "\n" + "              t_sector,"
            + "\n" + "              t_country,"
            + "\n" + "              t_currency";

        var dataset = TRsbDataset(query, RSDVAL_CLIENT, RSDVAL_STATIC);
            dataset.setFieldType("t_partId",     V_STRING);
            dataset.setFieldType("t_symbol",     V_STRING);
            dataset.setFieldType("t_sector",     V_STRING);
            dataset.setFieldType("t_country",    V_STRING);
            dataset.setFieldType("t_currency",   V_STRING);
            dataset.setFieldType("t_openDate",   V_DATE);
            dataset.setFieldType("t_numberDeal", V_STRING);
            dataset.setFieldType("t_account",    V_STRING);
            dataset.setFieldType("t_addInfo",    V_STRING);
            dataset.setFieldType("t_rest",       V_MONEY);
            dataset.setFieldType("t_restInRate", V_MONEY);
            dataset.setFieldType("t_coverRest",  V_MONEY);
            dataset.setFieldType("t_rate",       V_DOUBLE);
            dataset.setFieldType("t_value",      V_MONEY);

        return dataset;
    end;

    /**
     * Конструктор
     */
    private macro constructorTPartData(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
        initRcbDataSource(id, protocolView, datasources);
    end;

    constructorTPartData(id, protocolView, datasources);
end;

/**
 * Форма 410. Источник данных значения атрибута для раздела 1.
 *
 * @since 03.10.2018
 * @version 6.20.031.052
 */
class (TPartData) TPart1Data(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
    private macro setPartFilter()
        setPartFilter();
        m_filter.op("(").op("NOT").contractorIsResident().op(")");
    end;

    /**
     * Собираем дополнительную строку для выгруки в БИСквит
     */
    private macro setAddInfo()
        return
                     "                      -- ТИП СТРАНЫ + РЕЗИДЕНТНОСТЬ + ТИП КЛИЕНТА  + ОСТАТОК"
            + "\n" + "                      ((CASE"
            + "\n" + "                            WHEN (data.t_countryCode = " + m_resource.value_rus + ")"
            + "\n" + "                                THEN 'Р'"
            + "\n" + "                            WHEN (   data.t_countryIdentity = " + m_resource.value_cis
            + "\n" + "                                  OR data.t_countryIdentity = " + m_resource.value_far_abroad + ")"
            + "\n" + "                                THEN 'С'"
            + "\n" + "                            ELSE     'Д'"
            + "\n" + "                        END)"
            + "\n" + "                       || DECODE(data.t_isResident, 1, 'Р', 'Н')"
            + "\n" + "                       || (CASE"
            + "\n" + "                              WHEN (data.t_isBank = 1)"
            + "\n" + "                                  THEN 'Б'"
            + "\n" + "                              WHEN (data.t_isPhisical = 1)"
            + "\n" + "                                  THEN 'Ф'"
            + "\n" + "                              WHEN (data.t_isPhisical = 0)"
            + "\n" + "                                  THEN 'Ю'"
            + "\n" + "                           END)"
            + "\n" + "                       || DECODE(data.t_value, 0, '0', '+')"
            + "\n" + "                      )                                                       AS t_addInfo"
    end;

    private macro getCalculateQuery()
        var calculateQuery =
                     "SELECT " + m_resource.getPartId() + "                             AS t_partId,"
            + "\n" + "                      " + m_resource.getCode() + "                            AS t_symbol,"
            + "\n" + "                      CASE"
            + "\n" + "                          WHEN (data.t_isBank = 1 OR data.t_sectorCode = " + m_resource.SECTOR_100 + ")"
            + "\n" + "                              THEN " + m_resource.SECTOR_100
            + "\n" + "                          WHEN (data.t_isCentralBank = 1 OR data.t_isEuropeanCentralBank = 1 OR data.t_sectorCode = " + m_resource.SECTOR_200 + ")"
            + "\n" + "                              THEN " + m_resource.SECTOR_200
            + "\n" + "                          WHEN (  (    data.t_isInternationalCorporation    = 1"
            + "\n" + "                                    OR data.t_isWorldDevelopmentBank        = 1"
            + "\n" + "                                    OR data.t_isEvrasianDevelopmentBank     = 1"
            + "\n" + "                                    OR data.t_isBlackSeaDevelopmentBank     = 1"
            + "\n" + "                                    OR data.t_isInternationSettlementsBank  = 1"
            + "\n" + "                                    OR data.t_isInternalFinanceCorporation  = 1)"
            + "\n" + "                                OR data.t_sectorCode = " + m_resource.SECTOR_400 + ")"
            + "\n" + "                              THEN " + m_resource.SECTOR_400
            + "\n" + "                      END                                                       AS t_sector,"
            + "\n" + "                      NVL(CASE"
            + "\n" + "                              WHEN (data.t_isForeignBranch = 1)"
            + "\n" + "                                  THEN CASE"
            + "\n" + "                                           WHEN (data.t_superior != 'RUS')"
            + "\n" + "                                               THEN data.t_countryCode"
            + "\n" + "                                           WHEN (data.t_superior = 'RUS' AND t_reportCountrySuperior != " + getSQLChar("") + ")"
            + "\n" + "                                               THEN t_reportCountrySuperior"
            + "\n" + "                                           WHEN (   (data.t_superior = " + getSQLChar("") + " OR data.t_superior = 'RUS')"
            + "\n" + "                                                 AND t_reportCountrySuperior = " + getSQLChar("") + ")"
            + "\n" + "                                               THEN '997'"
            + "\n" + "                                           END"
            + "\n" + "                              WHEN (data.t_isForeignBranch = 0)"
            + "\n" + "                                  THEN CASE"
            + "\n" + "                                           WHEN (data.t_countryCode != 'RUS')"
            + "\n" + "                                               THEN data.t_countryCode"
            + "\n" + "                                           WHEN (data.t_countryCode = " + getSQLChar("") + ")"
            + "\n" + "                                               THEN '999'"
            + "\n" + "                                           WHEN (data.t_countryCode = 'RUS' AND data.t_reportCountryContragent != " + getSQLChar("") + ")"
            + "\n" + "                                               THEN data.t_reportCountryContragent"
            + "\n" + "                                       END"
            + "\n" + "                          END,  " + getSQLChar("") + ")                                         AS t_country,"
            + "\n" + "                      data.t_outRest                                            AS t_rest,"
            + "\n" + "                      data.t_outCoverRest                                     AS t_coverRest,"
            + "\n" + "                      decode(data.t_value,0,0,data.t_value  /data.t_outRest )   AS t_rate,"
            + "\n" + "                      data.t_value                                              AS t_restInRate,"
            + "\n" + "                      data.t_number                                             AS t_numberDeal,"
            + "\n" + "                      data.t_openDate,"
            + "\n" + "                      data.t_account,"
            + "\n" + "                      data.t_currency,"
            + "\n" +                        setAddInfo()
            + "\n" + "                 FROM (" + getBaseQuery()
            + "\n" + "                      ) data"
            + "\n" + "                WHERE data.rankAccount < 2";

        return calculateQuery;
    end;

    private macro constructorTPart1Data(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
        initTPartData(id, protocolView, datasources);

        m_creditorSector = RCB_OBJGROUP_CREDITOR_SECTOR_CODE;
    end;

    constructorTPart1Data(id, protocolView, datasources);
end;

/**
 * Форма 410. Источник данных значения атрибута для раздела 2.
 *
 * @since 03.10.2018
 * @version 6.20.031.052
 */
class (TPartData) TPart2Data(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
    private macro setPartFilter()
        setPartFilter();
        m_filter.contractorIsResident();
    end;

    /**
     * Собираем дополнительную строку для выгруки в БИСквит
     */
    private macro setAddInfo()
        return
                     "                      -- ТИП КЛИЕНТА"
            + "\n" + "                      (CASE"
            + "\n" + "                              WHEN (data.t_isBank = 1)"
            + "\n" + "                                  THEN 'Б'"
            + "\n" + "                              WHEN (data.t_isPhisical = 1)"
            + "\n" + "                                  THEN 'Ф'"
            + "\n" + "                              WHEN (data.t_isPhisical = 0)"
            + "\n" + "                                  THEN 'Ю'"
            + "\n" + "                           END)                                               AS t_addInfo"
    end;

    private macro getCalculateQuery()
        var calculateQuery =
                     "SELECT " + m_resource.getPartId() + "                             AS t_partId,"
            + "\n" + "                      " + m_resource.getCode() + "                            AS t_symbol,"
            + "\n" + "                      CASE"
            + "\n" + "                          WHEN (   (    (data.t_isBank = 1 OR data.t_isVneshEconomBank = 1)"
            + "\n" + "                                    AND (data.t_relationsBank = " + getSQLChar("") + "))"
            + "\n" + "                                OR data.t_sectorCode = " + m_resource.SECTOR_600 + ")"
            + "\n" + "                              THEN " + m_resource.SECTOR_600
            + "\n" + "                          WHEN (   (    (data.t_isBank = 1)"
            + "\n" + "                                    AND (data.t_relationsBank != " + getSQLChar("") + "))"
            + "\n" + "                                OR data.t_sectorCode = " + m_resource.SECTOR_660 + ")"
            + "\n" + "                              THEN " + m_resource.SECTOR_660
            + "\n" + "                          WHEN (data.t_isCentralBank = 1)"
            + "\n" + "                              THEN " + m_resource.SECTOR_700
            + "\n" + "                      END                                                 AS t_sector,"
            + "\n" + "                      NVL(CASE"
            + "\n" + "                              WHEN (data.t_isForeignBranch = 1)"
            + "\n" + "                                  THEN CASE"
            + "\n" + "                                           WHEN (data.t_superior != 'RUS')"
            + "\n" + "                                               THEN data.t_countryCode"
            + "\n" + "                                           WHEN (data.t_superior = 'RUS' AND t_reportCountrySuperior != " + getSQLChar("") + ")"
            + "\n" + "                                               THEN t_reportCountrySuperior"
            + "\n" + "                                           WHEN (   (data.t_superior = " + getSQLChar("") + " OR data.t_superior = 'RUS')"
            + "\n" + "                                                 AND t_reportCountrySuperior = " + getSQLChar("") + ")"
            + "\n" + "                                               THEN '997'"
            + "\n" + "                                       END"
            + "\n" + "                              WHEN (data.t_isForeignBranch = 0)"
            + "\n" + "                                  THEN CASE"
            + "\n" + "                                           WHEN (data.t_countryCode != 'RUS')"
            + "\n" + "                                               THEN data.t_countryCode"
            + "\n" + "                                           WHEN (data.t_countryCode = " + getSQLChar("") + ")"
            + "\n" + "                                               THEN '999'"
            + "\n" + "                                           WHEN (data.t_countryCode = 'RUS' AND data.t_reportCountryContragent != " + getSQLChar("") + ")"
            + "\n" + "                                               THEN data.t_reportCountryContragent"
            + "\n" + "                                           WHEN (data.t_countryCode = 'RUS' AND data.t_reportCountryContragent = " + getSQLChar("") + ")"
            + "\n" + "                                               THEN data.t_countryCode"
            + "\n" + "                                       END"
            + "\n" + "                          END, " + getSQLChar("") + ")                                           AS t_country,"
            + "\n" + "                      data.t_outRest                                          AS t_rest,"
            + "\n" + "                      data.t_outCoverRest                                     AS t_coverRest,"
            + "\n" + "                      decode(data.t_value,0,0,data.t_value  /data.t_outRest)  AS t_rate,"
            + "\n" + "                      data.t_value                                            AS t_restInRate,"
            + "\n" + "                      data.t_number                                           AS t_numberDeal,"
            + "\n" + "                      data.t_openDate,"
            + "\n" + "                      data.t_account,"
            + "\n" + "                      data.t_currency,"
            + "\n" +                        setAddInfo()
            + "\n" + "                FROM (" + getBaseQuery()
            + "\n" + "                     ) data"
            + "\n" + "               WHERE data.rankAccount < 2";

        return calculateQuery;
    end;

    private macro constructorTPart2Data(id : String, protocolView : RcbDataProtocolView, datasources : RcbDataSources)
        initTPartData(id, protocolView, datasources);

        m_creditorSector = RCB_OBJGROUP_CREDITOR_SECTOR_CODE_RESIDENT;
    end;

    constructorTPart2Data(id, protocolView, datasources);
end;

/**
 * Форма 410. Контейнер ИД
 *
 * @since 02.10.2018
 * @version 6.20.031.052
 */
class (RcbDataSources) TF410DataSources(protocolView : RcbCalculateProtocolView)
    /**
     * Настроечная таблица
     */
    private var m_tuneTable : RcbTuneTable;

    /**
     *  Интерфейс получения настроечной таблице
     */
    macro getTuneTable()
        return m_tuneTable;
    end;

    /**
     *  Интерфейс получения протокола
     */
    macro getProtocolView()
        return m_protocolView;
    end;

    /**
     *  Инициализация пула ИД
     */
    private macro initialize()
        m_dataSourcePool.push_back(TPart1Data("part1", m_protocolView.getDataProtocolView("part1"), this));
        m_dataSourcePool.push_back(TPart2Data("part2", m_protocolView.getDataProtocolView("part2"), this));
    end;

    /**
     *  Конструктор
     */
    private macro constructorTF410DataSources(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);

        m_tuneTable = objectFactoryInstance.createTuneTable();
    end;

    constructorTF410DataSources(protocolView);
end;
