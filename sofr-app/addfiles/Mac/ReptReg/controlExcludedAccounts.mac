/*
$Name:          controlExcludedAccounts.mac
$Module:        Регламентируемая отчетность
$Description:   Форма Балансовые счета. Контроль настроек исключения счетов из нормализации
*/

import RcbClassLibInter;
import rcbCoreInter;
import cb_sql;
import lib_lang;

/**
 * Настройки!!!
 */
class ExcludedAccountsController()

    private var m_isExist = false;

    private macro printString(balanceNumber)
        println("Для балансового счета " + balanceNumber + " из нормализации исключены все три составляющие(валюта,рубли,итог).");
    end;

    macro check(chapter, protocolView, excludedAccountsRouble, excludedAccountsForeign, excludedAccountsTotal, isExcludeAccounts, isExcludeAccountsForChapter)

        if (excludedAccountsRouble == null)
            excludedAccountsRouble = "rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/РУБЛИ')";
        end;

        if (excludedAccountsForeign == null)
            excludedAccountsForeign = "rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/ВАЛЮТА')";
        end;

        if (excludedAccountsTotal == null)
            excludedAccountsTotal = "rsb_common.getregstrvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "/ИТОГ')";
        end;

        if (isExcludeAccounts == null)
            isExcludeAccounts = "DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА'),CHR (0), 0, 1)";
        end;

        if (isExcludeAccountsForChapter == null)
            isExcludeAccountsForChapter = "DECODE(rsb_common.getregflagvalue('REPORT/FLOOR/НАСТРОЙКА ММБ/ИСКЛЮЧИТЬ СЧЕТА/ГЛАВА " + chapter + "'),CHR (0), 0, 1)";
        end;

        var dataSet = TRsbDataSet("WITH tabexclbal AS(SELECT --+inline"
                    +"\n"+        "                      " + excludedAccountsRouble + " t_roublebalancelist,"
                    +"\n"+        "                      " + excludedAccountsForeign + " t_currencybalancelist,"
                    +"\n"+        "                      " + excludedAccountsTotal + " t_totalbalancelist"
                    +"\n"+        "                     FROM DUAL),"
                    +"\n"+        "       tabuse AS (SELECT --+inline"
                    +"\n"+        "                      " + isExcludeAccounts + " t_isuseexclude,"
                    +"\n"+        "                      " + isExcludeAccountsForChapter + " t_isuseexcludeforchapter"
                    +"\n"+        "                    FROM DUAL)"
                    +"\n"+        "SELECT t_balance"
                    +"\n"+        "  FROM (SELECT bal.t_balance,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_roublebalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_isroubleexcluded,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_currencybalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_iscurrencyexcluded,"
                    +"\n"+        "               NVL ((SELECT 1"
                    +"\n"+        "                       FROM tabexclbal"
                    +"\n"+        "                      WHERE (SELECT 1"
                    +"\n"+        "                               FROM tabuse"
                    +"\n"+        "                              WHERE t_isuseexclude = 1"
                    +"\n"+        "                                AND t_isuseexcludeforchapter =1) = 1"
                    +"\n"+        "                        AND LENGTH (bal.t_balance) = 5"
                    +"\n"+        "                        AND REGEXP_LIKE (tabexclbal.t_totalbalancelist, '([^[:digit:]]|^)('|| bal.t_balance || '|' || SUBSTR (bal.t_balance, 1, 2) || '|' || SUBSTR (bal.t_balance, 1, 3) || ')([^[:digit:]]|$)')), 0) t_istotalexcluded"
                    +"\n"+        "          FROM dbalance_dbt bal"
                    +"\n"+        "         WHERE bal.t_chapter = " + chapter
                    +"\n"+        "           AND bal.t_balance NOT LIKE '%ОВП%'"
                    +"\n"+        "           AND bal.t_inumplan = 0"
                    +"\n"+        "           AND LENGTH(bal.t_balance) = 5"
                    +"\n"+        "           AND INSTR(bal.t_type_balance, 'T') = 0)"
                    +"\n"+        "WHERE ((t_isroubleexcluded + t_iscurrencyexcluded + t_istotalexcluded) = 3)"
                    +"\n"+        "ORDER BY t_balance");


        protocolView.printLine("КОНТРОЛЬ НАСТРОЕК ИСКЛЮЧЕННЫХ СЧЕТОВ ГЛАВЫ " + chapter);
        var isExist = false;

        var i = 0;

        while (dataSet.moveNext())
            isExist = true;
            protocolView.printLine("Для балансового счета " + dataSet.balance + " из нормализации исключены все три составляющие(валюта,рубли,итог).");
        end;

        m_isExist = isExist;

        if(isExist)
            protocolView.printLine("Нормализация данной главы невозможна!!!");
            protocolView.printLine("");
        else
            protocolView.printLine("Контроль прошёл успешно.");
        end;
    end;

    macro isExistConflictingSetting(chapter, protocolView)
        check(chapter, protocolView);
        return m_isExist;
    end;
end;
