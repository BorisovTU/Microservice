/*
$Name:          f129PartCalculateController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 129. Управление расчетом разделов формы
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 129. Управление расчетом разделов формы.

  Создан: 2.12.2010 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/

class CalculationKind()
    const CK_BASIC           = 0;
    const CK_AFTER_SUMMARIZE = 1;
end;

/**
 * Набор данных для расчета атрибутa
 */
class (RcbCalculationAttributeData) T129CalculationAttributeData(attribute, calculationKind)

    var m_calculationKind : RcbArray;

    /**
     * Добавить значения атрибутов.
     *
     * @param     data  данные для записи в список расчитываемых атрибутов(m_attributes)
     */
    macro addAttributesValue(data /*: TValue*/)
        if (data != null)
            m_attribute.setExactValue(data.exact);
            m_attribute.setScaledValue(data.scaled);
        end;
    end;

    macro hasCalculationKind(calculationKind /*: CalculationKind*/) : bool
        m_calculationKind.moveFirst();
        while (m_calculationKind.moveNext())
            if (m_calculationKind.getCurrentItem() == calculationKind)
                return true;
            end;
        end;
        return false;
    end;

    /**
     * Конструктор.
     *
     * @param     attributes
     */
    private macro constructorT129CalculationAttributeData(attribute, p_calculationKind)
        defaultParm(p_calculationKind, RcbArray().initialize(CalculationKind().CK_BASIC));

        initRcbCalculationAttributeData(attribute, RcbArray(), RcbDependencesData(RcbArray()));
        m_calculationKind = p_calculationKind;
    end;

    constructorT129CalculationAttributeData(attribute, calculationKind);
end;

/**
 * Набор данных для расчета группы атрибутов
 */
class (T129CalculationAttributeData) T129CalculationAttributesGroupData(attributes : RcbArray, calculationKind)
    /**
     * Список расчитываемых атрибутов.
     */
    private var m_attributes : RcbArray;

    /**
     * Добавить значения атрибутов.
     *
     * @param     data  данные для записи в список расчитываемых атрибутов(m_attributes)
     */
    macro addAttributesValue(data /*: TRsbDataSet*/)
        if (data != null)
            m_attributes.moveFirst();

            while(m_attributes.moveNext())
                execExp("m_attributes.getCurrentItem().setExactValue(data." + m_attributes.getCurrentItem().getValueFieldName() + "_"+ strSubst(m_attributes.getCurrentItem().getLine(), ".", "_") + ")");
            end;
        end;
    end;

    /**
     * Конструктор.
     *
     * @param     attributes
     */
    private macro constructorT129CalculationAttributesGroupData(attributes : RcbArray, calculationKind)
        initT129CalculationAttributeData(null, calculationKind);
        m_attributes = attributes;
    end;

    constructorT129CalculationAttributesGroupData(attributes, calculationKind);
end;

class (T129CalculationAttributesGroupData) T129CalculationAttributesGroupData4637(attributes : RcbArray, calculationKind)
    macro addAttributesValue(data /*: TRsbDataSet*/)
        if (    (data != null)
            and (data.size > 0))
            m_attributes.moveFirst();
            while(m_attributes.moveNext())
                execExp("m_attributes.getCurrentItem().setExactValue(data[0].m_" + m_attributes.getCurrentItem().getValueFieldName() + "_"+ strSubst(m_attributes.getCurrentItem().getLine(), ".", "_") + ")");
            end;
        end;
    end;

    private macro constructorT129CalculationAttributesGroupData4637(attributes : RcbArray, calculationKind)
        initT129CalculationAttributesGroupData(attributes, calculationKind);
    end;

    constructorT129CalculationAttributesGroupData4637(attributes, calculationKind);
end;

class (RcbPartCalculateController) T129PartCalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
    private var m_currencyCode;
    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    /*Расчет суммы по атрибутам*/
    macro getAttributesSum(attributes : RcbArray)
        var summData = TValue(0, 0);

        attributes.moveFirst();
        while (attributes.moveNext())
            summData.exact  = summData.exact  + attributes.getCurrentItem().getExactValue();
            summData.scaled = summData.scaled + attributes.getCurrentItem().getScaledValue();
        end;

        return summData;
    end;

    /*Расчет суммарно процента по атрибутам*/
    macro getAttributesPercSum(attributes : RcbArray)
        var summData = TValue();
        var sum      = TValue(0, 0);
        var sumPerc  = TValue(0, 0);
        var attribute;
        var percentAttribute;

        attributes.moveFirst();
        while (attributes.moveNext())
            percentAttribute  = attributes.getCurrentItem();
            attribute         = m_part.getAttribute(percentAttribute.getLine(), int(percentAttribute.getColumn()) + 1);

            sum.exact      = sum.exact      + attribute.getExactValue();
            sumPerc.exact  = sumPerc.exact  + ( attribute.getExactValue()  * percentAttribute.getExactValue() );
            sum.scaled     = sum.scaled     + attribute.getScaledValue();
            sumPerc.scaled = sumPerc.scaled + ( attribute.getScaledValue() * percentAttribute.getScaledValue() );
        end;

        if (sum.exact != 0)
            summData.exact  = sumPerc.exact/sum.exact;
        end;

        if (sum.scaled !=0)
            summData.scaled = sumPerc.scaled/sum.scaled;
        end;

        return summData;
    end;

    /**
     * Получение данных по вкладам физических лиц.
     *
     * @param     attributes
     */
    macro getCalculatePhysicalPersonDeposits(attributes : RcbArray)
        // Спецификация:
        //     Получить данные по операциям п/с "Ритейл"
        //     фильтры: код валюты = m_currencyCode,
        //              контрагент по операции является физ. лицом,
        //              маска счета соответствует настроечной таблице "ФЛ".
        var dataSource = m_dataSources.getDataSource("Ритейл");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                          RcbArray().initialize(  dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                                                + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ФЛ")),
                                                                m_report.getPart(m_partId).getAttributeName() + ". Вклады и депозиты физических лиц",
                                                                m_currencyCode)
                                    ));
    end;

    /**
     * @param     attributes
     */
    macro getCalculateJuridicalPersonDeposits(attributes : RcbArray)
        // Спецификация:
        //     Получить данные по операциям п/с "Депозиты"
        //     фильтры: код валюты = m_currencyCode,
        //              контрагент по операции является юридическим лицом и не является КО,
        //              маска счета соответствует настроечной таблице "ЮЛ".
        var dataSource = m_dataSources.getDataSource("Депозиты");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                          RcbArray().initialize(  dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                                                + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ЮЛ")),
                                                                m_report.getPart(m_partId).getAttributeName() + ". Вклады и депозиты нефинансовых организаций",
                                                                m_currencyCode)
                                  ));
    end;

    /**
     * @param     attributes
     */
    macro getCalculateBankDeposits(attributes : RcbArray)
        // Спецификация:
        //     Получить пользовательские данные
        var dataSource = m_dataSources.getDataSource("USER");

        var lines = RcbArray().initialize("1", "1.1", "1.2", "1.3", "1.4", "2", "3", "4", "5", "6");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                      RcbArray().initialize(  dataSource.getFilter().isInPart(m_partId)
                                                            + dataSource.getFilter().isInLine(lines)
                                                            + dataSource.getFilter().isInColumn("6-7"),
                                                            lines,
                                    m_report.getPart(m_partId).getAttributeName() + ". Привлеченные кредиты и депозиты кредитных организаций",
                                                            m_currencyCode)
                                    ));
    end;

    /**
     * Получение общей суммы по 1.1-1.4.
     *
     * @param     attribute
     */
    macro getSummaCalculateAttributeData(attribute, calculationKind)
        return
            T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                RcbCalculationData(r2m(this, "getAttributesSum"),
                                   RcbArray().initialize( RcbArray().initialize(
                                                          m_part.getAttribute("1.1", attribute.getColumn()),
                                                          m_part.getAttribute("1.2", attribute.getColumn()),
                                                          m_part.getAttribute("1.3", attribute.getColumn()),
                                                          m_part.getAttribute("1.4", attribute.getColumn())))
                                  ));
    end;

    /**
     * Получение процента по 1.1-1.4.
     *
     * @param     attribute
     */
    macro getPercentSummaCalculateAttributeData(attribute, calculationKind)
        return
            T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                RcbCalculationData(r2m(this, "getAttributesPercSum"),
                                   RcbArray().initialize( RcbArray().initialize(
                                                          m_part.getAttribute("1.1", attribute.getColumn()),
                                                          m_part.getAttribute("1.2", attribute.getColumn()),
                                                          m_part.getAttribute("1.3", attribute.getColumn()),
                                                          m_part.getAttribute("1.4", attribute.getColumn())))
                                  ));
    end;

    /**
     * Получение общей суммы по 1-6.
     *
     * @param     attribute
     */
    macro getSummaItogCalculateAttributeData(attribute, calculationKind)
        return
            T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                RcbCalculationData(r2m(this, "getAttributesSum"),
                                   RcbArray().initialize( RcbArray().initialize(
                                                          m_part.getAttribute("1", attribute.getColumn()),
                                                          m_part.getAttribute("2", attribute.getColumn()),
                                                          m_part.getAttribute("3", attribute.getColumn()),
                                                          m_part.getAttribute("4", attribute.getColumn()),
                                                          m_part.getAttribute("5", attribute.getColumn()),
                                                          m_part.getAttribute("6", attribute.getColumn())))
                                  ));
    end;

    /**
     * Получение сводных данных для атрибута по формуле средневзвешенного процента.
     */
    macro getWeightedAveragePercentSummableReports(attribute, calculationKind)
        var dataSource = m_dataSources.getDataSource("SummableReports");

        return T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getWeightedAveragePercentData"),
                                          RcbArray().initialize(attribute)));
    end;

    macro execute()
        m_part.addAttribute("1",     "2");
        m_part.addAttribute("1",     "3");
        var attributes = RcbArray().initialize(m_part.getAttribute("6",   "2"), m_part.getAttribute("6",     "3"),
                                               m_part.getAttribute("5",   "2"), m_part.getAttribute("5",     "3"),
                                               m_part.getAttribute("4",   "2"), m_part.getAttribute("4",     "3"),
                                               m_part.getAttribute("3",   "2"), m_part.getAttribute("3",     "3"),
                                               m_part.getAttribute("2",   "2"), m_part.getAttribute("2",     "3"),
                                               m_part.getAttribute("1.4", "2"), m_part.getAttribute("1.4",   "3"),
                                               m_part.getAttribute("1.3", "2"), m_part.getAttribute("1.3",   "3"),
                                               m_part.getAttribute("1.2", "2"), m_part.getAttribute("1.2",   "3"),
                                               m_part.getAttribute("1.1", "2"), m_part.getAttribute("1.1",   "3"));
        m_reportCalculateController.addCalculationAttributeData(getCalculatePhysicalPersonDeposits(attributes));
        m_part.addAttribute("Итого", "3");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));


        m_part.addAttribute("1",     "4");
        m_part.addAttribute("1",     "5");
        attributes =     RcbArray().initialize(m_part.getAttribute("6",   "4"), m_part.getAttribute("6",     "5"),
                                               m_part.getAttribute("5",   "4"), m_part.getAttribute("5",     "5"),
                                               m_part.getAttribute("4",   "4"), m_part.getAttribute("4",     "5"),
                                               m_part.getAttribute("3",   "4"), m_part.getAttribute("3",     "5"),
                                               m_part.getAttribute("2",   "4"), m_part.getAttribute("2",     "5"),
                                               m_part.getAttribute("1.4", "4"), m_part.getAttribute("1.4",   "5"),
                                               m_part.getAttribute("1.3", "4"), m_part.getAttribute("1.3",   "5"),
                                               m_part.getAttribute("1.2", "4"), m_part.getAttribute("1.2",   "5"),
                                               m_part.getAttribute("1.1", "4"), m_part.getAttribute("1.1",   "5"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateJuridicalPersonDeposits(attributes));
        m_part.addAttribute("Итого", "5");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));


        m_part.addAttribute("1",     "6");
        m_part.addAttribute("1",     "7");
        attributes =     RcbArray().initialize(m_part.getAttribute("6",   "6"), m_part.getAttribute("6",     "7"),
                                               m_part.getAttribute("5",   "6"), m_part.getAttribute("5",     "7"),
                                               m_part.getAttribute("4",   "6"), m_part.getAttribute("4",     "7"),
                                               m_part.getAttribute("3",   "6"), m_part.getAttribute("3",     "7"),
                                               m_part.getAttribute("2",   "6"), m_part.getAttribute("2",     "7"),
                                               m_part.getAttribute("1.4", "6"), m_part.getAttribute("1.4",   "7"),
                                               m_part.getAttribute("1.3", "6"), m_part.getAttribute("1.3",   "7"),
                                               m_part.getAttribute("1.2", "6"), m_part.getAttribute("1.2",   "7"),
                                               m_part.getAttribute("1.1", "6"), m_part.getAttribute("1.1",   "7"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateBankDeposits(attributes));
        m_part.addAttribute("Итого", "7");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "6"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));


        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "2"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "3"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "3"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "4"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "5"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "5"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "6"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "7"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "7"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        RcbApplication.TransactionManager.commit();
    end;

    /**
     * Конструктор.
     *
     * @param     reportCalculateController    ссылка на контроллер расчета формы
     * @param     partId                       идентификатор раздела
     * @param     currencyCode                 валюта раздела
     */
    macro constructorT129PartCalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_currencyCode = currencyCode;
    end;

    constructorT129PartCalculateController(reportCalculateController, partId, currencyCode);
end;

class (T129PartCalculateController) T129PartCalculateController4212(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
    initT129PartCalculateController(reportCalculateController, partId, currencyCode);

    macro getCalculatePhysicalPersonDeposits(attributes : RcbArray)
        // Спецификация:
        //     Получить данные по операциям п/с "Ритейл"
        //     фильтры: код валюты = m_currencyCode,
        //              контрагент по операции является физ. лицом,
        //              маска счета соответствует настроечной таблице "ФЛ",
        //              свойство счета Залоговый счет = "Нет"
        //              для Контрагента по договору НЕ задано значение категории "Аффилированные лица кредитной организации"
        var dataSource = m_dataSources.getDataSource("Ритейл");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                          RcbArray().initialize(  dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                                                + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ФЛ"))
                                                                + "\nAND" + dataSource.getFilter().isPledgeAccount(false)
                                                                + "\nAND" + dataSource.getFilter().isContragentHasCategoryByName("rdd.t_contragentId", RCB_OBJGROUP_AFFILIATES_CREDIT_ORG, "Аффилированные лица кредитной организации", false),
                                                                m_report.getPart(m_partId).getAttributeName() + ". Вклады (депозиты) физических лиц",
                                                                m_currencyCode)
                                    ));
    end;

    macro getCalculateJuridicalPersonDeposits(attributes : RcbArray)
        // Спецификация:
        //     Получить данные по операциям п/с "Депозиты"
        //     фильтры: код валюты = m_currencyCode,
        //              контрагент по операции является юридическим лицом и не является КО,
        //              маска счета соответствует настроечной таблице "ЮЛ".
        //              для Контрагента по договору НЕ задано значение категории "Аффилированные лица кредитной организации"
        //              на Договоре отсутствует Пользовательское поле с Наименованием поля = "Субординированный депозит", действующее за ДООП
        //              для Договора задано свойство Гарантийный депозит (ДООП)= "Нет"
        var dataSource = m_dataSources.getDataSource("Депозиты");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                          RcbArray().initialize(  dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                                                + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ЮЛ"))
                                                                + "\nAND" + dataSource.getFilter().isContragentHasCategoryByName("lc.t_contragentId", RCB_OBJGROUP_AFFILIATES_CREDIT_ORG, "Аффилированные лица кредитной организации", false)
                                                                + "\nAND" + dataSource.getFilter().isContractHasUserFieldByName("Субординированный депозит", false)
                                                                + "\nAND" + dataSource.getFilter().isContractHasUserFieldByName("Гарантийный депозит", false),
                                                                m_report.getPart(m_partId).getAttributeName() + ". Депозиты нефинансовых организаций",
                                                                m_currencyCode)
                                  ));
    end;

    macro execute()
        m_part.addAttribute("1",     "2");
        m_part.addAttribute("1",     "3");
        var attributes = RcbArray().initialize(m_part.getAttribute("6",   "2"), m_part.getAttribute("6",     "3"),
                                               m_part.getAttribute("5",   "2"), m_part.getAttribute("5",     "3"),
                                               m_part.getAttribute("4",   "2"), m_part.getAttribute("4",     "3"),
                                               m_part.getAttribute("3",   "2"), m_part.getAttribute("3",     "3"),
                                               m_part.getAttribute("2",   "2"), m_part.getAttribute("2",     "3"),
                                               m_part.getAttribute("1.4", "2"), m_part.getAttribute("1.4",   "3"),
                                               m_part.getAttribute("1.3", "2"), m_part.getAttribute("1.3",   "3"),
                                               m_part.getAttribute("1.2", "2"), m_part.getAttribute("1.2",   "3"),
                                               m_part.getAttribute("1.1", "2"), m_part.getAttribute("1.1",   "3"));
        m_reportCalculateController.addCalculationAttributeData(getCalculatePhysicalPersonDeposits(attributes));
        m_part.addAttribute("Итого", "3");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_part.addAttribute("1",     "4");
        m_part.addAttribute("1",     "5");
        attributes =     RcbArray().initialize(m_part.getAttribute("6",   "4"), m_part.getAttribute("6",     "5"),
                                               m_part.getAttribute("5",   "4"), m_part.getAttribute("5",     "5"),
                                               m_part.getAttribute("4",   "4"), m_part.getAttribute("4",     "5"),
                                               m_part.getAttribute("3",   "4"), m_part.getAttribute("3",     "5"),
                                               m_part.getAttribute("2",   "4"), m_part.getAttribute("2",     "5"),
                                               m_part.getAttribute("1.4", "4"), m_part.getAttribute("1.4",   "5"),
                                               m_part.getAttribute("1.3", "4"), m_part.getAttribute("1.3",   "5"),
                                               m_part.getAttribute("1.2", "4"), m_part.getAttribute("1.2",   "5"),
                                               m_part.getAttribute("1.1", "4"), m_part.getAttribute("1.1",   "5"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateJuridicalPersonDeposits(attributes));
        m_part.addAttribute("Итого", "5");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "4"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "2"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "3"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "3"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "4"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "5"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "5"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        RcbApplication.TransactionManager.commit();
    end;
end;

class (T129PartCalculateController4212) T129PartCalculateController4637(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
    initT129PartCalculateController4212(reportCalculateController, partId, currencyCode);

    /**
     * Получение общей суммы по 2-7.
     * @param     attribute
     */
    macro getSummaItogCalculateAttributeData(attribute, calculationKind)
        return
            T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                RcbCalculationData(r2m(this, "getAttributesSum"),
                                   RcbArray().initialize( RcbArray().initialize(
                                                          m_part.getAttribute("2", attribute.getColumn(), attribute.getOkato()),
                                                          m_part.getAttribute("3", attribute.getColumn(), attribute.getOkato()),
                                                          m_part.getAttribute("4", attribute.getColumn(), attribute.getOkato()),
                                                          m_part.getAttribute("5", attribute.getColumn(), attribute.getOkato()),
                                                          m_part.getAttribute("6", attribute.getColumn(), attribute.getOkato()),
                                                          m_part.getAttribute("7", attribute.getColumn(), attribute.getOkato())))
                                  ));
    end;

    macro execute()
        var totalRetail  = m_part.getAttribute("1", "5", "0");
        var totalDeposit = m_part.getAttribute("1", "6", "0");
        var dataSource = m_dataSources.getDataSource("Ритейл");
        var data = dataSource.getData(dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                          + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ФЛ"))
                                          + "\nAND" + dataSource.getFilter().isPledgeAccount(false)
                                          + "\nAND" + dataSource.getFilter().isContragentHasCategoryByName("rdd.t_contragentId", RCB_OBJGROUP_AFFILIATES_CREDIT_ORG, "Аффилированные лица кредитной организации", false),
                                          m_report.getPart(m_partId).getAttributeName() + ". Вклады (депозиты) физических лиц",
                                          m_currencyCode);
        if (data != null)
            var i = 0;
            while (i < data.size())
                if (data[i].m_okato != null)
                    m_part.getAttribute("2",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_2);
                    m_part.getAttribute("2",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_2);
                    m_part.getAttribute("2.1", "5", data[i].m_okato).setExactValue(data[i].m_sumValue_2_1);
                    m_part.getAttribute("2.1", "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_2_1);
                    m_part.getAttribute("3",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_3);
                    m_part.getAttribute("3",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_3);
                    m_part.getAttribute("4",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_4);
                    m_part.getAttribute("4",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_4);
                    m_part.getAttribute("5",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_5);
                    m_part.getAttribute("5",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_5);
                    m_part.getAttribute("6",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_6);
                    m_part.getAttribute("6",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_6);
                    m_part.getAttribute("7",   "5", data[i].m_okato).setExactValue(data[i].m_sumValue_7);
                    m_part.getAttribute("7",   "5", data[i].m_okato).setPercentValue(data[i].m_percentValue_7);

                    m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData(m_part.getAttribute("Итого", "4", data[i].m_okato), RcbArray().initialize(CalculationKind().CK_BASIC)));
                else
                    totalRetail.setExactValue(data[i].m_sumValue_2 + data[i].m_sumValue_3 + data[i].m_sumValue_4 + data[i].m_sumValue_5 + data[i].m_sumValue_6 + data[i].m_sumValue_7);
                end;

                i = i + 1;
            end;
        end;

        dataSource = m_dataSources.getDataSource("Депозиты");
        data = dataSource.getData(dataSource.getFilter().hasCurrencyCode(m_currencyCode)
                                      + dataSource.getFilter().isSatisfiesToBalanceMasks(m_tuneTable.getAccountMasks("ЮЛ"))
                                      + "\nAND" + dataSource.getFilter().isContragentHasCategoryByName("lc.t_contragentId", RCB_OBJGROUP_AFFILIATES_CREDIT_ORG, "Аффилированные лица кредитной организации", false)
                                      + "\nAND" + dataSource.getFilter().isContractHasUserFieldByName("Субординированный депозит", false)
                                      + "\nAND" + dataSource.getFilter().isContractHasUserFieldByName("Гарантийный депозит", false),
                                      m_report.getPart(m_partId).getAttributeName() + ". Депозиты нефинансовых организаций",
                                      m_currencyCode);

        if (data != null)
            i = 0;
            while (i < data.size())
                if (data[i].m_okato != null)
                    m_part.getAttribute("2",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_2);
                    m_part.getAttribute("2",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_2);
                    m_part.getAttribute("2.1", "6", data[i].m_okato).setExactValue(data[i].m_sumValue_2_1);
                    m_part.getAttribute("2.1", "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_2_1);
                    m_part.getAttribute("3",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_3);
                    m_part.getAttribute("3",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_3);
                    m_part.getAttribute("4",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_4);
                    m_part.getAttribute("4",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_4);
                    m_part.getAttribute("5",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_5);
                    m_part.getAttribute("5",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_5);
                    m_part.getAttribute("6",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_6);
                    m_part.getAttribute("6",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_6);
                    m_part.getAttribute("7",   "6", data[i].m_okato).setExactValue(data[i].m_sumValue_7);
                    m_part.getAttribute("7",   "6", data[i].m_okato).setPercentValue(data[i].m_percentValue_7);

                    m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData (m_part.getAttribute("Итого", "6", data[i].m_okato), RcbArray().initialize(CalculationKind().CK_BASIC)));
                else
                    totalDeposit.setExactValue(data[i].m_sumValue_2 + data[i].m_sumValue_3 + data[i].m_sumValue_4 + data[i].m_sumValue_5 + data[i].m_sumValue_6 + data[i].m_sumValue_7);
                end;

                i = i + 1;
            end;
        end;

        RcbApplication.TransactionManager.commit();
    end;
end;
