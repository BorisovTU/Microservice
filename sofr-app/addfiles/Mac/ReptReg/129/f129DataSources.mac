/*
 $Name: f129DataSources.mac
 $Module: Регламентируемая отчетность
 $Description:   Форма 129. Источники данных формы.
 */

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 129. Источники данных формы.

  Создан: 2.12.2010 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import SbCrdInter;
import f129DataSourceProtocols;
import f129DataSourceFilters;

/**************************************************************************************************
 * Классы реализации по указанию 2332
 **************************************************************************************************/

/**
 * Источник данных.
 */
class (RcbDataSource) TDataSource(id : String, dataSources : Object /*RcbDataSources*/)
    /**
     * Фильтр данных.
     */
    private var m_filter /*: TDataSourceFilter*/;

    /**
     * Протокол источника данных.
     */
    private var m_protocol /*: TDataSourceProtocol*/;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceFilter"));
    end;

    /**
     * Создать пртокол.
     */
    private macro createDataSourceProtocol() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceProtocol"));
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(currencyCode : string) //: string
        throw (TPureVirtualMethodCallException("TDataSource::getDataflowQuery"));
    end;

    /**
     * Получить фильтр.
     */
    macro getFilter() /*: TDataSourceFilter*/
        return m_filter;
    end;

    /**
     * Получить данные для отчета.
     *
     * @param     currencyCode     код валюты
     * @param     attributeName    ссылка на атрибут для протокола
     */
    macro getData(filter : String, attributeName : String) //: TRsbDataSet
        private macro getRoubleSumText(termText)
           return "SUM(CASE WHEN ("+termText+") THEN t_roubleSum ELSE 0 END)";
        end;

        private macro getPercentRateText(termText)
           return "NVL(SUM(CASE WHEN ("+termText+") THEN t_roubleSum * t_percentRate ELSE 0 END) /"
                + " NULLIF(SUM(CASE WHEN ("+termText+") THEN t_roubleSum ELSE 0 END), 0), 0)";
        end;

        var query =  "WITH dataflow AS ("
            + "\n" + getDataflowQuery(filter)
            + "\n" + ")"
            + "\n" + "SELECT " +   getRoubleSumText("t_term <= 0")                                                                                                + " t_sumValue_1_1,"
            + "\n" + "       " +   getRoubleSumText("t_term  = 1")                                                                                                + " t_sumValue_1_2,"
            + "\n" + "       " +   getRoubleSumText("t_term > 1   AND t_term <= 7")                                                                               + " t_sumValue_1_3,"
            + "\n" + "       " +   getRoubleSumText("t_term > 7   AND t_term <= 30")                                                                              + " t_sumValue_1_4,"
            + "\n" + "       " +   getRoubleSumText("t_term > 30  AND t_term <= 90")                                                                              + " t_sumValue_2,"
            + "\n" + "       " +   getRoubleSumText("t_term > 90  AND t_term <= 180 ")                                                                            + " t_sumValue_3,"
            + "\n" + "       " +   getRoubleSumText("t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year))")                                       + " t_sumValue_4,"
            + "\n" + "       " +   getRoubleSumText("(t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year))") + " t_sumValue_5,"
            + "\n" + "       " +   getRoubleSumText("(t_date + t_term) >= (t_date + (interval '3' year))")                                                        + " t_sumValue_6,"
            + "\n" + "       " + getPercentRateText("t_term <= 0")                                                                                                + " t_percentValue_1_1,"
            + "\n" + "       " + getPercentRateText("t_term  = 1")                                                                                                + " t_percentValue_1_2,"
            + "\n" + "       " + getPercentRateText("t_term > 1   AND t_term <= 7")                                                                               + " t_percentValue_1_3,"
            + "\n" + "       " + getPercentRateText("t_term > 7   AND t_term <= 30")                                                                              + " t_percentValue_1_4,"
            + "\n" + "       " + getPercentRateText("t_term > 30  AND t_term <= 90")                                                                              + " t_percentValue_2,"
            + "\n" + "       " + getPercentRateText("t_term > 90  AND t_term <= 180 ")                                                                            + " t_percentValue_3,"
            + "\n" + "       " + getPercentRateText("t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year))")                                       + " t_percentValue_4,"
            + "\n" + "       " + getPercentRateText("(t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year))") + " t_percentValue_5,"
            + "\n" + "       " + getPercentRateText("(t_date + t_term) >= (t_date + (interval '3' year))")                                                        + " t_percentValue_6,"
            + "\n" + "       t_date                                                                                            t_date,"
            + "\n" + "       t_term                                                                                            t_term,"
            + "\n" + "       t_cbAccount                                                                                       t_cbAccount,"
            + "\n" + "       t_operationType                                                                                   t_operationType,"
            + "\n" + "       grouping(t_roubleSum)                                                                             t_isTotal"
            + "\n" + "  FROM dataflow"
            + "\n" + " GROUP BY ROLLUP((t_roubleSum,"
            + "\n" + "                  t_percentRate,"
            + "\n" + "                  t_date,"
            + "\n" + "                  t_term,"
            + "\n" + "                  t_cbAccount,"
            + "\n" + "                  t_operationType))";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("term",  V_INTEGER);
        dataSet.setFieldType("date",  V_DATE);

        return m_protocol.printProtocol(dataSet, attributeName);
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructor(id : String, dataSources : Object /*RcbDataSources*/)
        initRcbDataSource(id, null, dataSources);
        createDataSourceFilter();
        createDataSourceProtocol();
    end;

    constructor(id, dataSources);
end;

/**
 * Источник данных по операциям п/с "Ритейл".
 */
class (TDataSource) T129RetailOperationsDataSource(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129RetailOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129RetailOperationsDataSourceProtocol();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT rdd.t_percentRate            t_percentRate, "
            + "\n" + "       rdd.t_roubleSum              t_roubleSum, "
            + "\n" + "       rdd.t_date                   t_date,"
            + "\n" + "       rdd.t_term                   t_term,"
            + "\n" + "       NVL(rdd.t_account, CHR(1)) t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rdd.t_isopening = 1      THEN 'Открытие'"
            + "\n" + "           WHEN rdd.t_isprolongation = 1 THEN 'Пролонгация'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM reprtldepdocument_vw rdd,"
            + "\n" + "       repRtlDepAccount_vw rda"
                         //Операция выполнена в одном из подразделений, по которым выпускается отчет
            + "\n" + " WHERE " + RcbBranchFieldFilter().getAsSqlString("rdd.t_branchId")
                         //Дата начала отчетного периода <= Дата операции  <= Дата окончания отчетного периода
            + "\n" + "   AND rep_data.getBeginDate() <= rdd.t_date"
            + "\n" + "   AND rep_data.getEndDate()   >= rdd.t_date"
                         //Операции соответствует счет
            + "\n" + "   AND rda.t_referenc = rdd.t_referenc"
                         //Вид операции открытие или пролонгация
            + "\n" + "   AND (    rdd.t_isopening = 1"
            + "\n" + "        OR  rdd.t_isprolongation = 1)"
                         //Сумма по операции не равна нулю
            + "\n" + "   AND rdd.t_roubleSum != 0"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND rdd.t_percentrate != 0"

            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129RetailOperationsDataSource(dataSources : Object /*RcbDataSources*/)
        initTDataSource("Ритейл", dataSources);
    end;

    constructorT129RetailOperationsDataSource(dataSources);
end;

/**
 * Источник данных по операциям п/с "Депозиты"
 */
class (TDataSource) T129DepositsOperationsDataSource(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129DepositsOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129DepositsOperationsDataSourceProtocol();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT lo.t_interestRate            t_percentRate, "
            + "\n" + "       lo.t_roubleSum               t_roubleSum,"
            + "\n" + "       lo.t_date                    t_date,"
            + "\n" + "       lo.t_term                    t_term,"
            + "\n" + "       la.t_cbAccount               t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_type = 59 THEN 'Пролонгация депозита'"
            + "\n" + "           WHEN lo.t_type = 54 THEN 'Взнос по депозиту'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM replnsoperation_vw lo,"
            + "\n" + "       replnscontract_vw lc,"
            + "\n" + "       replnsaccount_vw la,"
            + "\n" + "       replnsdocument_vw ld"
                         //Операция принадлежит договору
            + "\n" + " WHERE lc.t_id = lo.t_contractid"
                         //Тип договора = "Договор депозита"
            + "\n" + "   AND lc.t_type = " + LO_DEPOSIT
                         //Договор принадлежит одному из подразделений, по которыму выпускается отчет
            + "\n" + "   AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
                         //Открыт хотя бы один день в отчетном периоде
            + "\n" + "   AND lc.t_isopened = 1"
                         //Тип операции "Пролонгация депозита" или самый первый "Взнос по депозиту" по договору
            + "\n" + "   AND (   lo.t_type = 59"
            + "\n" + "        or (    lo.t_type = 54"
            + "\n" + "            AND lo.t_date = (select min(temp.t_date)"
            + "\n" + "                               from replnsoperation_vw temp"
            + "\n" + "                              where temp.t_contractid = lo.t_contractid"
            + "\n" + "                                and temp.t_type = 54)"
            + "\n" + "           )"
            + "\n" + "       )"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.beginDate()) + " <= t_date"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.endDate())   + " >= t_date"
                         //Сумма по операции не равна нулю
            + "\n" + "   AND lo.t_roubleSum != 0"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND lo.t_interestRate != 0"
                         //К операции привязан документ по счету
            + "\n" + "   AND lo.t_id = ld.t_operationId"
            + "\n" + "   AND ld.t_accountId     = la.t_id"
                         //который соответствует счету кредита
            + "\n" + "   AND ld.t_creditAccount = la.t_account"

            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129DepositsOperationsDataSource(dataSources : Object /*RcbDataSources*/)
        initTDataSource("Депозиты", dataSources);
    end;

    constructorT129DepositsOperationsDataSource(dataSources);
end;

/**
 * Данные пользовательского ввода (базовый класс).
 */
class (TDataSource) T129UserInputDataSource(dataSources : Object /*RcbDataSources*/, id : String)
    private var m_rcbCompositeValue;
    private var m_userData;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129UserDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = objectFactoryInstance.createT129UserPartDataSourceProtocol();
        return true;
    end;

    /**
     *
     */
    private macro getUserDataAsQueryText()
        var query = "(SELECT * "
                   + "  FROM(\n"
                   + "       SELECT null t_part, null t_line, null t_column, null t_sumValue, null t_percentValue "
                   + "         FROM dual "
                   + "        WHERE (0 = 1)";

        var valueIterator = m_rcbCompositeValue.createValueIterator();
        valueIterator.moveFirst();

        while (not valueIterator.isDone())
            query = query + "\nUNION ALL\nSELECT "
                          + getSqlString(valueIterator.currentItem.fieldValue("part"        ).currentAsString) + " t_part, "
                          + getSqlString(valueIterator.currentItem.fieldValue("line"        ).currentAsString) + " t_line, "
                          + getSqlString(valueIterator.currentItem.fieldValue("column"      ).currentAsString) + " t_column, "
                          +          nvl(valueIterator.currentItem.fieldValue("sumValue"    ).exact, "0")      + " t_sumValue, "
                          +          nvl(valueIterator.currentItem.fieldValue("percentValue").exact, "0")      + " t_percentValue "
                          + "FROM dual";
            valueIterator.moveNext();
        end;

        return query + "\n))";
    end;

    /**
     * Получить данные для отчета.
     *
     * @param     partId    идентификатор раздела.
     */
    macro getData(filter : String, line : RcbArray, attributeName : String, codeCurrency : String) //: TRsbDataSet
        var lineNumber;
        var sumName;
        var perName;

        var query =  "WITH dataflow AS"
            + "\n" + m_userData
            + "\n" + ", data1 as (SELECT";

        line.moveFirst();
        while (line.moveNext())
            lineNumber = strSubst(line.getCurrentItem(), ".", "_");

            query = query
                + "\n" + "       CASE WHEN (t_line = '" + line.getCurrentItem() + "') THEN t_sumValue     ELSE 0 END t_sumValue_"     + lineNumber + ","
                + "\n" + "       CASE WHEN (t_line = '" + line.getCurrentItem() + "') THEN t_percentValue ELSE 0 END t_percentValue_" + lineNumber + ",";
        end;

        query = query
            + "\n" + "          t_sumValue,"
            + "\n" + "          t_percentValue,"
            + "\n" + "          t_line,"
            + "\n" + "          t_column,"
            + "\n" + "          t_part"
            + "\n" + "  FROM dataflow"
            + "\n" + " WHERE (1 = 1) " + nvl(filter, " ") + ")";

        query = query
        + "\n" + "SELECT ";

        line.moveFirst();
        while (line.moveNext())
            lineNumber = strSubst(line.getCurrentItem(), ".", "_");
            sumName = "t_sumValue_" + lineNumber;
            perName = "t_percentValue_" + lineNumber;

            query = query
            + "\n" + "       SUM(t_sumValue_"     + lineNumber + ") t_sumValue_"     + lineNumber + ","
            + "\n" + "       SUM(" + sumName + " * " + perName + ") / DECODE(SUM(" + sumName + "), 0, 1, SUM(" + sumName + ")) " + perName + ",";
        end;

        query = query
            + "\n" + "       grouping(t_sumValue) t_isTotal,"
            + "\n" + "       'Данные пользователя' t_cbAccount"
            + "\n" + "  FROM data1"
            + "\n" + " GROUP BY ROLLUP((t_sumValue,"
            + "\n" + "                  t_percentValue,"
            + "\n" + "                  t_line,"
            + "\n" + "                  t_column,"
            + "\n" + "                  t_part))";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        return m_protocol.printProtocol(dataSet, attributeName, codeCurrency);
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129UserInputDataSource(dataSources : Object /*RcbDataSources*/, id : String)
        defaultParm(id, "USER");
        initTDataSource(id, dataSources);

        m_rcbCompositeValue = RcbApplication().currentReport.attributeValue("ПользовательскийВвод");
        m_userData          = getUserDataAsQueryText();
    end;

    constructorT129UserInputDataSource(dataSources, id);
end;

/**
 * Данные пользовательского ввода по справочным строкам (раздел 1, строки
 * 7.1. Средняя ставка по остаткам средств на счетах нефинансовых организаций
 * 7.2. Средняя ставка по остаткам средств на корреспондентских счетах кредитной организации)
 */
class (T129UserInputDataSource) T129InfDataSource(dataSources : Object /*RcbDataSources*/)

    private macro createDataSourceProtocol() : bool
        m_protocol = T129UserInfDataSourceProtocol();
        return true;
    end;

    /**
     * Получить данные для отчета.
     *
     * @param     partId    идентификатор раздела.
     */
    macro getData(filter : String, line : RcbArray, attributeName : String, codeCurrency : String) //: TRsbDataSet
        var lineNumber;
        var sumName;
        var perName;

        var query =  "WITH dataflow AS"
            + "\n" + m_userData
            + "\n" + ", data1 as (SELECT";

        line.moveFirst();
        while (line.moveNext())
            lineNumber = strSubst(line.getCurrentItem(), ".", "_");

            query = query
                + "\n" + "       CASE WHEN (t_line = '" + line.getCurrentItem() + "') THEN t_sumValue     ELSE 0 END t_sumValue_"     + lineNumber + ","
                + "\n" + "       CASE WHEN (t_line = '" + line.getCurrentItem() + "') THEN t_percentValue ELSE 0 END t_percentValue_" + lineNumber + ",";
        end;

        query = query
            + "\n" + "          t_sumValue,"
            + "\n" + "          t_percentValue,"
            + "\n" + "          t_line,"
            + "\n" + "          t_column,"
            + "\n" + "          t_part"
            + "\n" + "  FROM dataflow"
            + "\n" + " WHERE (1 = 1) " + nvl(filter, " ") + ")";

        query = query
        + "\n" + "SELECT ";

        line.moveFirst();
        while (line.moveNext())
            lineNumber = strSubst(line.getCurrentItem(), ".", "_");
            sumName = "t_sumValue_" + lineNumber;
            perName = "t_percentValue_" + lineNumber;

            query = query
            + "\n" + "       SUM(t_sumValue_"     + lineNumber + ") t_sumValue_"     + lineNumber + ","
            + "\n" + "       SUM(" + perName + ") " + perName + ",";
        end;

        query = query
            + "\n" + "       grouping(t_sumValue) t_isTotal,"
            + "\n" + "       'Данные пользователя' t_cbAccount"
            + "\n" + "  FROM data1"
            + "\n" + " GROUP BY ROLLUP((t_sumValue,"
            + "\n" + "                  t_percentValue,"
            + "\n" + "                  t_line,"
            + "\n" + "                  t_column,"
            + "\n" + "                  t_part))";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        return m_protocol.printProtocol(dataSet, attributeName, codeCurrency);
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129InfDataSource(dataSources : Object /*RcbDataSources*/)
        initT129UserInputDataSource(dataSources, "INF");
    end;

    constructorT129InfDataSource(dataSources);
end;

class (T129UserInputDataSource) T129UserInputDataSource4637(dataSources : Object /*RcbDataSources*/, id : String)

    private macro createDataSourceProtocol() : bool
        m_protocol = objectFactoryInstance.createT129UserPartDataSourceProtocol();
        return true;
    end;

    private macro constructorT129UserInputDataSource4637(dataSources : Object /*RcbDataSources*/, id : String)
        defaultParm(id, "USER");
        initT129UserInputDataSource(dataSources, id);
//        m_rcbCompositeValue = RcbApplication().currentReport.attributeValue("ПользовательскийВвод");
//        m_userData = getUserDataAsQueryText();
    end;

    constructorT129UserInputDataSource4637(dataSources, id);
end;

class (T129InfDataSource) T129InfDataSource_4212(dataSources : Object /*RcbDataSources*/)
    initT129InfDataSource(dataSources);

    private macro createDataSourceProtocol() : bool
        m_protocol = T129UserInfDataSourceProtocol_4212();
        return true;
    end;
end;

/**
 * Источник данных.
 */
class (RcbDataSource) T129SummableReportsDataSource2332(dataSources : Object /*RcbDataSources*/)

    var m_summarizedReportsList; //Список суммируемых RcbReport-ов.

    /**
     * Получить сводные данные для атрибута по формуле средневзвешенного процента.
     */
    macro getWeightedAveragePercentData(attribute /*: T129Attribute*/) //: TValue
        var partCompositeValueName = attribute.getPart().getAttributeName();
        var line   = attribute.getLine();
        var column = attribute.getColumn();
        var column_;

        if (mod(int(column), 2) == 0)
            column_ = string(column, "-", int(column)+1);
        else
            column_ = string(int(column)-1, "-", column);
        end;

        var listedReportPartCompositeValue;
        var compositeValue;
        var keyValue;

        var weightedPercent = TValue(0, 0);
        var weight          = TValue(0, 0);

        var compositeWeightedPercent;
        var compositeWeight;

        var i = 0;
        while (i < m_summarizedReportsList.size)

            listedReportPartCompositeValue = m_summarizedReportsList[i].attributeValue(partCompositeValueName);

            keyValue = listedReportPartCompositeValue.createKeyValue();
            keyValue.fieldValue("line")   = line;
            keyValue.fieldValue("column") = column_;

            compositeValue = listedReportPartCompositeValue.findValue(keyValue);

            if (compositeValue != null)
                compositeWeightedPercent = TValue(compositeValue.fieldValue("percentValue").exact
                                     * compositeValue.fieldValue("sumValue").exact,
                                       compositeValue.fieldValue("percentValue").scaled
                                     * compositeValue.fieldValue("sumValue").scaled);

                weightedPercent.plus(compositeWeightedPercent);

                compositeWeight = TValue(compositeValue.fieldValue("sumValue").exact,
                            compositeValue.fieldValue("sumValue").scaled);
                weight.plus(compositeWeight);
            end;

            i = i + 1;
        end;

        if (weight.exact == 0)
            return TValue(0, 0);
        elif (weight.scaled == 0)
            return TValue(weightedPercent.exact /weight.exact,
                          0);
        else
            return TValue(weightedPercent.exact /weight.exact,
                          weightedPercent.scaled/weight.scaled);
        end;
    end;

    /**
     * Получить сводные данные для атрибута, как среднеарифметическое по сводимым значениям.
     */
    macro getSimpleAveragePercentData(attribute /*: T129Attribute*/) //: TValue
        var partCompositeValueName = attribute.getPart().getAttributeName();
        var line   = attribute.getLine();

        var listedReportPartCompositeValue;
        var compositeValue;
        var keyValue;

        var CompositeValueWeightedPercent;
        var weightedPercent = TValue(0, 0);
        var weight          = 0;

        var i = 0;
        while (i < m_summarizedReportsList.size)

            listedReportPartCompositeValue = m_summarizedReportsList[i].attributeValue(partCompositeValueName);
            keyValue = listedReportPartCompositeValue.createKeyValue();
            keyValue.fieldValue("line")   = line;
            compositeValue = listedReportPartCompositeValue.findValue(keyValue);

            if (compositeValue != null)

                CompositeValueWeightedPercent = TValue(compositeValue.fieldValue("percentValue").exact,
                                     compositeValue.fieldValue("percentValue").scaled);
                weightedPercent.plus(CompositeValueWeightedPercent);
                weight = weight + 1;
            end;

            i = i + 1;
        end;

        if (weight == 0)
            return TValue(0, 0);
        else
            return TValue(weightedPercent.exact /weight,
                          weightedPercent.scaled/weight);
        end;
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructor(dataSources : Object /*RcbDataSources*/)
        initRcbDataSource("SummableReports", null, dataSources);
        m_summarizedReportsList = RcbApplication().summator.getSummarizedReportsList(RcbApplication().currentReport);
    end;

    constructor(dataSources);
end;

/**
 * Источники данных 129 формы по 2332-У.
 */
class (RcbDataSources) T129DataSources2332(protocolView : RcbCalculateProtocolView)

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource(this));
        m_dataSourcePool.push_back(T129UserInputDataSource(this));
        m_dataSourcePool.push_back(T129InfDataSource(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;

    /**
     * Конструктор.
     */
    macro constructorT129DataSources2332(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorT129DataSources2332(protocolView);
end;

/**************************************************************************************************
 * Классы реализации по указанию 2539
 **************************************************************************************************/

/**
 * Источник данных по 2539-У.
 */
class (TDataSource) TDataSource2539(id : String, dataSources : Object /*RcbDataSources*/)
    macro getCentralBankLimitRest(currencyCode)
        if (   (currencyCode == "810")
            or (currencyCode == "643"))
            return "1000";
        elif (currencyCode == "840")
            return "30";
        elif (currencyCode == "978")
            return "30";
        else
            return "";
        end;
    end;

    /**
     * Получить данные для отчета.
     *
     * @param     currencyCode     код валюты
     * @param     attributeName    ссылка на атрибут для протокола
     */
    macro getData(filter : String, attributeName : String, currencyCode : String) //: TRsbDataSet
        private const includeLimit = 0;
        private const excludeLimit = 1;

        private macro limitClause(limitIncluding)
            if (limitIncluding == includeLimit)
                return " OR (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            elif (limitIncluding == excludeLimit)
                return " AND NOT (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            else
                return "";
            end;
        end;

        private macro getSumText(termText);
            return "SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END)";
        end;

        private macro getPercentRateText(termText)
            return "NVL(SUM(CASE WHEN ("+termText+") THEN t_sum * t_percentRate ELSE 0 END) /"
                 + " NULLIF(SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END), 0), 0)";
        end;

        var query =  "WITH dataflow AS ("
            + "\n" + getDataflowQuery(filter)
            + "\n" + ")"
            + "\n" + "SELECT " +         getSumText("(t_term <= 0)"                                                                                                + limitClause(includeLimit)) + " t_sumValue_1_1,"
            + "\n" + "       " +         getSumText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_sumValue_1_2,"
            + "\n" + "       " +         getSumText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_sumValue_1_3,"
            + "\n" + "       " +         getSumText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_1_4,"
            + "\n" + "       " +         getSumText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_2,"
            + "\n" + "       " +         getSumText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_sumValue_3,"
            + "\n" + "       " +         getSumText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_sumValue_4,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_sumValue_5,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_sumValue_6,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0)"                                                                                                + limitClause(includeLimit)) + " t_percentValue_1_1,"
            + "\n" + "       " + getPercentRateText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_percentValue_1_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_percentValue_1_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_1_4,"
            + "\n" + "       " + getPercentRateText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_percentValue_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_percentValue_4,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_percentValue_5,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_percentValue_6,"
            + "\n" + "       t_date                                                                                            t_date,"
            + "\n" + "       t_term                                                                                            t_term,"
            + "\n" + "       t_limitRest                                                                                       t_limitRest,"
            + "\n" + "       t_cbAccount                                                                                       t_cbAccount,"
            + "\n" + "       t_operationType                                                                                   t_operationType,"
            + "\n" + "       grouping(t_sum)                                                                                   t_isTotal"
            + "\n" + "  FROM dataflow"
            + "\n" + " GROUP BY ROLLUP((t_sum,"
            + "\n" + "                  t_percentRate,"
            + "\n" + "                  t_date,"
            + "\n" + "                  t_term,"
            + "\n" + "                  t_limitRest,"
            + "\n" + "                  t_cbAccount,"
            + "\n" + "                  t_operationType))";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("term",  V_INTEGER);
        dataSet.setFieldType("date",  V_DATE);

        return m_protocol.printProtocol(dataSet, attributeName);
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorTDataSource2539(id : String, dataSources : Object /*RcbDataSources*/)
        initTDataSource(id, null, dataSources);
    end;

    constructorTDataSource2539(id, dataSources);
end;

/**
 * Источник данных по операциям п/с "Ритейл" по 2539-У.
 */
class (TDataSource2539) T129RetailOperationsDataSource2539(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129RetailOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129RetailOperationsDataSourceProtocol2539();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT rdd.t_percentRate            t_percentRate, "
            + "\n" + "       rdd.t_sum                    t_sum, "
            + "\n" + "       rdd.t_date                   t_date,"
            + "\n" + "       rdd.t_term                   t_term,"
            + "\n" + "       NVL(rda.t_limitRest, 0)      t_limitRest,"
            + "\n" + "       NVL(rdd.t_account, CHR(1)) t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rdd.t_isopening = 1      THEN 'Открытие'"
            + "\n" + "           WHEN rdd.t_isprolongation = 1 THEN 'Пролонгация'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM reprtldepdocument_vw rdd,"
            + "\n" + "       repRtlDepAccount_vw rda"
                         //Операция выполнена в одном из подразделений, по которым выпускается отчет
            + "\n" + " WHERE " + RcbBranchFieldFilter().getAsSqlString("rdd.t_branchId")
                         //Дата начала отчетного периода <= Дата операции  <= Дата окончания отчетного периода
            + "\n" + "   AND rep_data.getBeginDate() <= rdd.t_date"
            + "\n" + "   AND rep_data.getEndDate()   >= rdd.t_date"
                         //Операции соответствует счет
            + "\n" + "   AND rda.t_referenc = rdd.t_referenc"
                         //Вид операции открытие или пролонгация
            + "\n" + "   AND (    rdd.t_isopening = 1"
            + "\n" + "        OR  rdd.t_isprolongation = 1)"
                         //Сумма по операции не равна нулю
            + "\n" + "   AND rdd.t_sum != 0"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND rdd.t_percentrate != 0"
            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129RetailOperationsDataSource2539(dataSources : Object /*RcbDataSources*/)
        initTDataSource2539("Ритейл", dataSources);
    end;

    constructorT129RetailOperationsDataSource2539(dataSources);
end;

/**
 * Источник данных по операциям п/с "Депозиты" по 2539-У.
 */
class (TDataSource2539) T129DepositsOperationsDataSource2539(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129DepositsOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129DepositsOperationsDataSourceProtocol2539();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT lo.t_interestRate            t_percentRate, "
            + "\n" + "       lo.t_sum                     t_sum,"
            + "\n" + "       lo.t_date                    t_date,"
            + "\n" + "       lo.t_term                    t_term,"
            + "\n" + "       NVL(lc.t_limitRest, 0)       t_limitRest,"
            + "\n" + "       la.t_cbAccount               t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_type = 59 THEN 'Пролонгация депозита'"
            + "\n" + "           WHEN lo.t_type = 54 THEN 'Взнос по депозиту'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM replnsoperation_vw lo,"
            + "\n" + "       replnscontract_vw lc,"
            + "\n" + "       replnsaccount_vw la"
                         //Операция принадлежит договору
            + "\n" + " WHERE lc.t_id = lo.t_contractid"
                         //Тип договора = "Договор депозита"
            + "\n" + "   AND lc.t_type = " + LO_DEPOSIT
                         //Договор принадлежит одному из подразделений, по которыму выпускается отчет
            + "\n" + "   AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
                         //Открыт хотя бы один день в отчетном периоде
            + "\n" + "   AND lc.t_isopened = 1"
                         //Тип операции "Пролонгация депозита" или самый первый "Взнос по депозиту" по договору
            + "\n" + "   AND (   lo.t_type = 59"
            + "\n" + "        or (    lo.t_type = 54"
            + "\n" + "            AND lo.t_date = (select min(temp.t_date)"
            + "\n" + "                               from replnsoperation_vw temp"
            + "\n" + "                              where temp.t_contractid = lo.t_contractid"
            + "\n" + "                                and temp.t_type = 54)"
            + "\n" + "           )"
            + "\n" + "       )"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.beginDate()) + " <= t_date"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.endDate())  + " >= t_date"
                         //Сумма по операции не равна нулю
            + "\n" + "   AND lo.t_sum != 0"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND lo.t_interestRate != 0"
                         //К операции привязан документ по счету
            + "\n" + "   AND EXISTS (SELECT 1 "
            + "\n" + "                 FROM replnsdocument_vw ld "
            + "\n" + "                WHERE lo.t_id = ld.t_operationId"
            + "\n" + "                  AND ld.t_accountId = la.t_id"
                         //который соответствует счету кредита
            + "\n" + "                  AND ld.t_creditAccount = la.t_account)"

            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129DepositsOperationsDataSource2539(dataSources : Object /*RcbDataSources*/)
        initTDataSource2539("Депозиты", dataSources);
    end;

    constructorT129DepositsOperationsDataSource2539(dataSources);
end;

/**
 * Источники данных 129 формы по 2539-У.
 */
class (RcbDataSources) T129DataSources2539(protocolView : RcbCalculateProtocolView)

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource2539(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource2539(this));
        m_dataSourcePool.push_back(T129UserInputDataSource(this));
        m_dataSourcePool.push_back(T129InfDataSource(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;

    /**
     * Конструктор.
     */
    macro constructorT129DataSources2539(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorT129DataSources2539(protocolView);
end;

/**************************************************************************************************
 * Классы реализации по указанию 2835
 **************************************************************************************************/

/**
 * Источник данных по операциям п/с "Ритейл" по 2835-У.
 */
class (T129RetailOperationsDataSource2539) T129RetailOperationsDataSource2835(dataSources : Object /*RcbDataSources*/)

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT rdd.t_percentRate            t_percentRate, "
            + "\n" + "       rdd.t_sum                    t_sum, "
            + "\n" + "       rdd.t_date                   t_date,"
            + "\n" + "       rdd.t_term                   t_term,"
            + "\n" + "       NVL(rda.t_limitRest, 0)      t_limitRest,"
            + "\n" + "       NVL(rdd.t_account, CHR(1)) t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rdd.t_isopening = 1      THEN 'Открытие'"
            + "\n" + "           WHEN rdd.t_isprolongation = 1 THEN 'Пролонгация'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM reprtldepdocument_vw rdd,"
            + "\n" + "       repRtlDepAccount_vw rda"
                         //Операция выполнена в одном из подразделений, по которым выпускается отчет
            + "\n" + " WHERE " + RcbBranchFieldFilter().getAsSqlString("rdd.t_branchId")
                         //Дата начала отчетного периода <= Дата операции  <= Дата окончания отчетного периода
            + "\n" + "   AND rep_data.getBeginDate() <= rdd.t_date"
            + "\n" + "   AND rep_data.getEndDate()   >= rdd.t_date"
                         //Операции соответствует счет
            + "\n" + "   AND rda.t_referenc = rdd.t_referenc"
                         //Вид операции открытие или пролонгация
            + "\n" + "   AND (    rdd.t_isopening = 1"
            + "\n" + "        OR  rdd.t_isprolongation = 1)"
                         //Сумма по операции > 500 единиц ВалютыОперации()
            + "\n" + "   AND rdd.t_sum > 500"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND rdd.t_percentrate != 0"
            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129RetailOperationsDataSource2835(dataSources : Object /*RcbDataSources*/)
        initT129RetailOperationsDataSource2539(dataSources);
    end;

    constructorT129RetailOperationsDataSource2835(dataSources);
end;

/**
 * Источник данных по операциям п/с "Депозиты" по 2835-У.
 */
class (T129DepositsOperationsDataSource2539) T129DepositsOperationsDataSource2835(dataSources : Object /*RcbDataSources*/)

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT lo.t_interestRate            t_percentRate, "
            + "\n" + "       lo.t_sum                     t_sum,"
            + "\n" + "       lo.t_date                    t_date,"
            + "\n" + "       lo.t_term                    t_term,"
            + "\n" + "       NVL(lc.t_limitRest, 0)       t_limitRest,"
            + "\n" + "       la.t_cbAccount               t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_type = 59 THEN 'Пролонгация депозита'"
            + "\n" + "           WHEN lo.t_type = 54 THEN 'Взнос по депозиту'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM replnsoperation_vw lo,"
            + "\n" + "       replnscontract_vw lc,"
            + "\n" + "       replnsaccount_vw la"
                         //Операция принадлежит договору
            + "\n" + " WHERE lc.t_id = lo.t_contractid"
                         //Тип договора = "Договор депозита"
            + "\n" + "   AND lc.t_type = " + LO_DEPOSIT
                         //Договор принадлежит одному из подразделений, по которыму выпускается отчет
            + "\n" + "   AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")
                         //Открыт хотя бы один день в отчетном периоде
            + "\n" + "   AND lc.t_isopened = 1"
                         //Тип операции "Пролонгация депозита" или самый первый "Взнос по депозиту" по договору
            + "\n" + "   AND (   lo.t_type = 59"
            + "\n" + "        or (    lo.t_type = 54"
            + "\n" + "            AND lo.t_date = (select min(temp.t_date)"
            + "\n" + "                               from replnsoperation_vw temp"
            + "\n" + "                              where temp.t_contractid = lo.t_contractid"
            + "\n" + "                                and temp.t_type = 54)"
            + "\n" + "           )"
            + "\n" + "       )"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.beginDate()) + " <= t_date"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.endDate())  + " >= t_date"
                         //Сумма по операции > 500 единиц Вылюты операции
            + "\n" + "   AND lo.t_sum > 500"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND lo.t_interestRate != 0"
            + "\n" + "   AND lo.t_tarifType ! 2"
                         //К операции привязан документ по счету
            + "\n" + "   AND EXISTS (SELECT 1 "
            + "\n" + "                 FROM replnsdocument_vw ld "
            + "\n" + "                WHERE lo.t_id = ld.t_operationId"
            + "\n" + "                  AND ld.t_accountId = la.t_id"
                         //который соответствует счету кредита
            + "\n" + "                  AND ld.t_creditAccount = la.t_account)"

            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129DepositsOperationsDataSource2835(dataSources : Object /*RcbDataSources*/)
        initT129DepositsOperationsDataSource2539(dataSources);
    end;

    constructorT129DepositsOperationsDataSource2835(dataSources);
end;


/**
 * Источники данных 129 формы по 2835-У.
 */
class (RcbDataSources) T129DataSources2835(protocolView : RcbCalculateProtocolView)

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource2835(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource2835(this));
        m_dataSourcePool.push_back(T129UserInputDataSource(this));
        m_dataSourcePool.push_back(T129InfDataSource(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;

    /**
     * Конструктор.
     */
    macro constructorT129DataSources2835(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorT129DataSources2835(protocolView);
end;

class (TDataSource2539) TDataSource2926(id : String, dataSources : Object /*RcbDataSources */)

    /**
     * Получить данные для отчета.
     *
     * @param     currencyCode     код валюты
     * @param     attributeName    ссылка на атрибут для протокола
     */
    macro getData(filter : String, attributeName : String, currencyCode : String) //: TRsbDataSet
        private const includeLimit = 0;
        private const excludeLimit = 1;

        private macro limitClause(limitIncluding)
            if (limitIncluding == includeLimit)
                return " OR (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            elif (limitIncluding == excludeLimit)
                return " AND NOT (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            else
                return "";
            end;
        end;

        private macro getSumText(termText);
            return "SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END)";
        end;

        private macro getPercentRateText(termText)
            return "NVL(SUM(CASE WHEN ("+termText+") THEN t_sum * t_percentRate ELSE 0 END) /"
                 + " NULLIF(SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END), 0), 0)";
        end;

        var query =  "WITH dataflow AS ("
            + "\n" + getDataflowQuery(filter)
            + "\n" + "),"
            + "\n" + "exclude as ("
            + "\n" + "SELECT "
            + "\n" + "      CASE WHEN (SUM(dataflow.t_sum) > 500) THEN dataflow.t_sum ELSE 0 END  t_sum,"
            + "\n" + "      dataflow.t_percentRate                                                t_percentRate,"
            + "\n" + "      dataflow.t_date                                                       t_date,"
            + "\n" + "      dataflow.t_term                                                       t_term,"
            + "\n" + "      dataflow.t_limitRest                                                  t_limitRest,"
            + "\n" + "      dataflow.t_cbAccount                                                  t_cbAccount,"
            + "\n" + "      dataflow.t_operationType                                              t_operationType"
            + "\n" + "  FROM dataflow"
            + "\n" + "GROUP BY (t_sum, t_percentRate, t_date, t_term, t_limitRest, t_cbAccount, t_operationType)"
            + "\n" + ")"
            + "\n" + "SELECT " +         getSumText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_sumValue_1,"
            + "\n" + "       " +         getSumText("(t_term = 0) OR (t_term is NULL)"                                                                              + limitClause(includeLimit)) + " t_sumValue_1_1,"
            + "\n" + "       " +         getSumText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_sumValue_1_2,"
            + "\n" + "       " +         getSumText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_sumValue_1_3,"
            + "\n" + "       " +         getSumText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_1_4,"
            + "\n" + "       " +         getSumText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_2,"
            + "\n" + "       " +         getSumText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_sumValue_3,"
            + "\n" + "       " +         getSumText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_sumValue_4,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_sumValue_5,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_sumValue_6,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_percentValue_1,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0)"                                                                                                + limitClause(includeLimit)) + " t_percentValue_1_1,"
            + "\n" + "       " + getPercentRateText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_percentValue_1_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_percentValue_1_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_1_4,"
            + "\n" + "       " + getPercentRateText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_percentValue_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_percentValue_4,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_percentValue_5,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_percentValue_6,"
            + "\n" + "       t_date                                                                                            t_date,"
            + "\n" + "       t_term                                                                                            t_term,"
            + "\n" + "       t_limitRest                                                                                       t_limitRest,"
            + "\n" + "       t_cbAccount                                                                                       t_cbAccount,"
            + "\n" + "       t_operationType                                                                                   t_operationType,"
            + "\n" + "       grouping(t_sum)                                                                                   t_isTotal"
            + "\n" + "  FROM exclude"
            + "\n" + "  WHERE t_sum > 0"
            + "\n" + " GROUP BY ROLLUP((t_sum,"
            + "\n" + "                  t_percentRate,"
            + "\n" + "                  t_date,"
            + "\n" + "                  t_term,"
            + "\n" + "                  t_limitRest,"
            + "\n" + "                  t_cbAccount,"
            + "\n" + "                  t_operationType))"
            + "\n" + " ORDER BY t_date, t_sum";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("term",  V_INTEGER);
        dataSet.setFieldType("date",  V_DATE);

        return m_protocol.printProtocol(dataSet, attributeName, currencyCode);
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorTDataSource2926(id : String, dataSources : Object /*RcbDataSources */)
        initTDataSource2539(id, dataSources);
    end;

    constructorTDataSource2926(id, dataSources);
end;

/**
 * Источник данных по операциям п/с "Ритейл" по 2926-У.
 */
class (TDataSource2926) T129RetailOperationsDataSource2926(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129RetailOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129RetailOperationsDataSourceProtocol2926();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT rdd.t_percentRate            t_percentRate, "
            + "\n" + "       rdd.t_sum                    t_sum, "
            + "\n" + "       rdd.t_date                   t_date,"
            + "\n" + "       rdd.t_term                   t_term,"
            + "\n" + "       NVL(rda.t_limitRest, 0)      t_limitRest,"
            + "\n" + "       NVL(rdd.t_account, CHR(1)) t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rdd.t_isopening = 1      THEN 'Открытие'"
            + "\n" + "           WHEN rdd.t_isprolongation = 1 THEN 'Пролонгация'"
            + "\n" + "       END                          t_operationType"
            + "\n" + "  FROM reprtldepdocument_vw rdd,"
            + "\n" + "       repRtlDepAccount_vw rda"
                         //Операция выполнена в одном из подразделений, по которым выпускается отчет
            + "\n" + " WHERE " + RcbBranchFieldFilter().getAsSqlString("rdd.t_branchId")
                         //Дата начала отчетного периода <= Дата операции  <= Дата окончания отчетного периода
            + "\n" + "   AND rep_data.getBeginDate() <= rdd.t_date"
            + "\n" + "   AND rep_data.getEndDate()   >= rdd.t_date"
                         //Операции соответствует счет
            + "\n" + "   AND rda.t_referenc = rdd.t_referenc"
                         //Вид операции открытие или пролонгация
            + "\n" + "   AND (    rdd.t_isopening = 1"
            + "\n" + "        OR  rdd.t_isprolongation = 1)"
                         //Процентная ставка  не равна нулю
            + "\n" + "   AND rdd.t_percentrate != 0"
            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129RetailOperationsDataSource2926(dataSources : Object /*RcbDataSources */)
        initTDataSource2926("Ритейл", dataSources);
    end;

    constructorT129RetailOperationsDataSource2926(dataSources);
end;

class (T129RetailOperationsDataSource2926) T129RetailOperationsDataSource4212(dataSources : Object /*RcbDataSources*/)
    initT129RetailOperationsDataSource2926(dataSources);

    private macro createDataSourceProtocol() : bool
        m_protocol = T129RetailOperationsDataSourceProtocol4212();
        return true;
    end;
end;

/**
 * Источник данных по операциям п/с "Депозиты" по 2926-У.
 */
class (TDataSource2926) T129DepositsOperationsDataSource2926(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129DepositsOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129DepositsOperationsDataSourceProtocol2926();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT lo.t_interestRate            t_percentRate, "
            + "\n" + "       lo.t_sum                     t_sum,"
            + "\n" + "       lo.t_date                    t_date,"
            + "\n" + "       lo.t_term                    t_term,"
            + "\n" + "       NVL(lc.t_limitRest, 0)       t_limitRest,"
            + "\n" + "       la.t_cbAccount               t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_type = " + CS_DEPO_PROL + " THEN 'Пролонгация депозита'"
            + "\n" + "           WHEN lo.t_type = " + CS_DEPOPAYM  + " THEN 'Взнос по депозиту'"
            + "\n" + "       END                          t_operationType,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_history = 'К'"
            + "\n" + "              THEN 1"
            + "\n" + "           ELSE 0"
            + "\n" + "       END                          t_isCorrection,"
            + "\n" + "       lo.t_correctionDate          t_correctionDate"
            + "\n" + "  FROM replnsoperation_vw lo,"
            + "\n" + "       replnscontract_vw  lc,"
            + "\n" + "       replnsaccount_vw   la"
            + "\n" + " WHERE lc.t_id              = lo.t_contractid"                                        //Операция принадлежит договору
            + "\n" + "   AND lc.t_type            = " + LO_DEPOSIT                                          //Тип договора = "Договор депозита"
            + "\n" + "   AND t_isguaranteedeposit = 0"
            + "\n" + "   AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")                     //Договор принадлежит одному из подразделений, по которыму выпускается отчет
            + "\n" + "   AND lc.t_isopened        = 1"                                                      //Открыт хотя бы один день в отчетном периоде
            + "\n" + "   AND (   lo.t_type = " + CS_DEPO_PROL                                               //Тип операции "Пролонгация депозита"
            + "\n" + "        or (    lo.t_type = " + CS_DEPOPAYM                                           //или самый первый "Взнос по депозиту" по договору
            + "\n" + "            AND lo.t_date = (SELECT MIN(temp.t_date)"
            + "\n" + "                               FROM replnsoperation_vw temp"
            + "\n" + "                              WHERE temp.t_contractid = lo.t_contractid"
            + "\n" + "                                AND temp.t_type       = " + CS_DEPOPAYM + ")"
            + "\n" + "           )"
            + "\n" + "       )"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.beginDate()) + " <= t_date"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.endDate())   + " >= t_date"
            + "\n" + "   AND lo.t_interestRate != 0"                                                        //Процентная ставка  не равна нулю
            + "\n" + "   AND lo.t_tarifType    != 2"
            + "\n" + "   AND EXISTS (SELECT 1 "                                                             //К операции привязан документ по счету
            + "\n" + "                 FROM replnsdocument_vw ld "
            + "\n" + "                WHERE lo.t_id            = ld.t_operationId"
            + "\n" + "                  AND ld.t_accountId     = la.t_id"
            + "\n" + "                  AND ld.t_creditAccount = la.t_account)"                             //который соответствует счету кредита
            + "\n" +     NVL(filter , " ");
    end;

    macro getData(filter : String, attributeName : String, currencyCode : String) //: TRsbDataSet
        private const includeLimit = 0;
        private const excludeLimit = 1;

        private macro limitClause(limitIncluding)
            if (limitIncluding == includeLimit)
                return " OR (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            elif (limitIncluding == excludeLimit)
                return " AND NOT (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            else
                return "";
            end;
        end;

        private macro getSumText(termText);
            return "SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END)";
        end;

        private macro getPercentRateText(termText)
            return "NVL(SUM(CASE WHEN ("+termText+") THEN t_sum * t_percentRate ELSE 0 END) /"
                 + " NULLIF(SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END), 0), 0)";
        end;

        var query =  "WITH dataflow AS ("
            + "\n" + getDataflowQuery(filter)
            + "\n" + "),"
            + "\n" + "exclude as ("
            + "\n" + "SELECT "
            + "\n" + "      CASE WHEN (SUM(dataflow.t_sum) > 500) THEN dataflow.t_sum ELSE 0 END  t_sum,"
            + "\n" + "      dataflow.t_percentRate                                                t_percentRate,"
            + "\n" + "      dataflow.t_date                                                       t_date,"
            + "\n" + "      dataflow.t_term                                                       t_term,"
            + "\n" + "      dataflow.t_limitRest                                                  t_limitRest,"
            + "\n" + "      dataflow.t_cbAccount                                                  t_cbAccount,"
            + "\n" + "      dataflow.t_operationType                                              t_operationType,"
            + "\n" + "      dataflow.t_isCorrection                                               t_isCorrection,"
            + "\n" + "      dataflow.t_correctionDate                                             t_correctionDate"
            + "\n" + "  FROM dataflow"
            + "\n" + "GROUP BY (t_sum, t_percentRate, t_date, t_term, t_limitRest, t_cbAccount, t_operationType, t_isCorrection, t_correctionDate)"
            + "\n" + ")"
            + "\n" + "SELECT " +         getSumText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_sumValue_1,"
            + "\n" + "       " +         getSumText("(t_term = 0) OR (t_term is NULL)"                                                                              + limitClause(includeLimit)) + " t_sumValue_1_1,"
            + "\n" + "       " +         getSumText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_sumValue_1_2,"
            + "\n" + "       " +         getSumText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_sumValue_1_3,"
            + "\n" + "       " +         getSumText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_1_4,"
            + "\n" + "       " +         getSumText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_2,"
            + "\n" + "       " +         getSumText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_sumValue_3,"
            + "\n" + "       " +         getSumText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_sumValue_4,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_sumValue_5,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_sumValue_6,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_percentValue_1,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0)"                                                                                                + limitClause(includeLimit)) + " t_percentValue_1_1,"
            + "\n" + "       " + getPercentRateText("(t_term  = 1)"                                                                                                + limitClause(excludeLimit)) + " t_percentValue_1_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 1   AND t_term <= 7)"                                                                               + limitClause(excludeLimit)) + " t_percentValue_1_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 7   AND t_term <= 30)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_1_4,"
            + "\n" + "       " + getPercentRateText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_2,"
            + "\n" + "       " + getPercentRateText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_percentValue_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_percentValue_4,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_percentValue_5,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_percentValue_6,"
            + "\n" + "       t_date                                                                                            t_date,"
            + "\n" + "       t_term                                                                                            t_term,"
            + "\n" + "       t_limitRest                                                                                       t_limitRest,"
            + "\n" + "       t_cbAccount                                                                                       t_cbAccount,"
            + "\n" + "       t_operationType                                                                                   t_operationType,"
            + "\n" + "       t_isCorrection,                                                                                   t_isCorrection,"
            + "\n" + "       t_correctionDate                                                                                  t_correctionDate,"
            + "\n" + "       grouping(t_sum)                                                                                   t_isTotal"
            + "\n" + "  FROM exclude"
            + "\n" + "  WHERE t_sum > 0"
            + "\n" + " GROUP BY ROLLUP((t_sum,"
            + "\n" + "                  t_percentRate,"
            + "\n" + "                  t_date,"
            + "\n" + "                  t_term,"
            + "\n" + "                  t_limitRest,"
            + "\n" + "                  t_cbAccount,"
            + "\n" + "                  t_operationType,"
            + "\n" + "                  t_isCorrection,"
            + "\n" + "                  t_correctionDate))"
            + "\n" + " ORDER BY t_date, t_sum";

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("term",  V_INTEGER);
        dataSet.setFieldType("date",  V_DATE);

        return m_protocol.printProtocol(dataSet, attributeName, currencyCode);
    end;
    /**
     * Конструктор.
     *
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129DepositsOperationsDataSource2926(dataSources : Object /*RcbDataSources */)
        initTDataSource2926("Депозиты", dataSources);
    end;

    constructorT129DepositsOperationsDataSource2926(dataSources);
end;

class (T129DepositsOperationsDataSource2926) T129DepositsOperationsDataSource4212(dataSources : Object /*RcbDataSources*/)
    initT129DepositsOperationsDataSource2926(dataSources);

    private macro createDataSourceProtocol() : bool
        m_protocol = T129DepositsOperationsDataSourceProtocol4212();
        return true;
    end;
end;

class (TDataSource2926) TDataSource4637(id : String, dataSources : Object /*RcbDataSources */)

    /**
     * запрос данных из НТ "Коды ОКАТО автономных округов"
     */
    private macro getAoOkatoTable()
        const s1 = "select ";
        const f1 = " as t_okatoCode,\n";
        const f2 = " as t_okatoMasks\n";
        const s2 = "  from dual\n";
        const s3 = " union\n";

        var tune = RcbTuneTable("dtAoOkatoCodes_dbt");
        var query;
        var ds;

        tune.setInstructionFilter(RCB_I4637_DATE_F129);

        ds = tune.getDataSet();
        if (ds.moveNext())
            query = s1 + getSqlString(ds.okato) + f1 + "       " + getSqlString(ds.okatoMasks) + f2 + s2;

            while (ds.moveNext())
                query = query + s3 + s1 + getSqlString(ds.okato) + f1 + "       " + getSqlString(ds.okatoMasks) + f2 + s2;
            end;
        else
            query = s1 + getSqlString("0") + f1 + "       " + getSqlString("0") + f2 + s2;
        end;

        return query;
    end;

    /**
     * Получить данные для отчета.
     *
     * @param     currencyCode     код валюты
     * @param     attributeName    ссылка на атрибут для протокола
     */
    macro getData(filter : String, attributeName : String, currencyCode : String) //: TRsbDataSet
        private const includeLimit = 0;
        private const excludeLimit = 1;

        private macro limitClause(limitIncluding)
            if (limitIncluding == includeLimit)
                return " OR (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            elif (limitIncluding == excludeLimit)
                return " AND NOT (t_limitRest > 0 AND t_limitRest <= " + getCentralBankLimitRest(currencyCode) + ")";
            else
                return "";
            end;
        end;

        private macro getSumText(termText);
            return "SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END)";
        end;

        private macro getPercentRateText(termText)
            return "NVL(SUM(CASE WHEN ("+termText+") THEN t_sum * t_percentRate ELSE 0 END) /"
                 + " NULLIF(SUM(CASE WHEN ("+termText+") THEN t_sum ELSE 0 END), 0), 0)";
        end;

        var query =  "WITH                                                                                                                                          "
            //коды ОКАТО АО                                                                                                                                         "
            + "\n" + "okatoAo AS                                                                                                                                    "
            + "\n" + "(                                                                                                                                             "
            + "\n" + getAoOkatoTable()
            + "\n" + "),                                                                                                                                            "
            //все коды ОКАТО АО одной строкой
            + "\n" + "okatoAoSuitable AS                                                                                                                            "
            + "\n" + "(                                                                                                                                             "
            + "\n" + "SELECT LISTAGG(okatoAo.t_okatoMasks, ',') WITHIN GROUP (ORDER BY okatoAo.t_okatoCode) AS t_okatoAoSuitable                                    "
            + "\n" + "  FROM okatoAo                                                                                                                                "
            + "\n" + "),                                                                                                                                            "
            //коды ОКАТО для каждого субъекта
            + "\n" + "okato AS                                                                                                                                      "
            + "\n" + "(                                                                                                                                             "
            + "\n" + "SELECT dep.t_id                                                                       t_contragentId,                                         "
            + "\n" + "       CASE                                                                                                                                   "
            + "\n" + "           WHEN not dep.t_okatoCode IS NULL                                                                                                   "
            + "\n" + "               THEN CASE                                                                                                                      "
            + "\n" + "                        WHEN rsb_mask.CompareStringWithMask(NVL((SELECT t_okatoAoSuitable FROM okatoAoSuitable), '') , dep.t_okatoCode) = 1   "
            + "\n" + "                            THEN NVL((SELECT okatoAo.t_okatoCode                                                                              "
            + "\n" + "                                        FROM okatoAo                                                                                          "
            + "\n" + "                                       WHERE rsb_mask.CompareStringWithMask(okatoAo.t_okatoMasks, dep.t_okatoCode) = 1                        "
            + "\n" + "                                         AND rownum                                                                = 1),                      "
            + "\n" + "                                     '99999')                                                                                                 "
            + "\n" + "                        ELSE CONCAT(SUBSTR(dep.t_okatoCode, 1, 2), '000')                                                                     "
            + "\n" + "                    END                                                                                                                       "
            + "\n" + "           ELSE '99999'                                                                                                                       "
            + "\n" + "       END                                                                           t_okato                                                  "
            + "\n" + "  FROM dRepParty_vw dep                                                                                                                       "
            + "\n" + " UNION                                                                                                                                        "
            + "\n" + "SELECT dep.t_id                                                                      t_contragentId,                                          "
            + "\n" + "       CONCAT(SUBSTR(dep.t_okatoCode, 1, 2), '000')                                  t_okato                                                  "
            + "\n" + "  FROM dRepParty_vw dep                                                                                                                       "
            + "\n" + " WHERE NOT dep.t_okatoCode IS NULL                                                                                                            "
            + "\n" + "   AND rsb_mask.CompareStringWithMask(NVL((SELECT t_okatoAoSuitable FROM okatoAoSuitable), '') , dep.t_okatoCode) = 1                         "
            + "\n" + "),                                                                                                                                            "
            + "\n" + "dataflow AS                                                                                                                                   "
            + "\n" + "(                                                                                                                                             "
            + "\n" + getDataflowQuery(filter)
            + "\n" + "),                                                                                                                                            "
            + "\n" + "exclude as                                                                                                                                    "
            + "\n" + "(                                                                                                                                             "
            + "\n" + "SELECT                                                                                                                                        "
            + "\n" + "      CASE                                                                                                                                    "
            + "\n" + "          WHEN (SUM(dataflow.t_sum) > 500)                                                                                                    "
            + "\n" + "              THEN dataflow.t_sum                                                                                                             "
            + "\n" + "          ELSE 0                                                                                                                              "
            + "\n" + "      END                                                                  t_sum,                                                             "
            + "\n" + "      CASE                                                                                                                                    "
            + "\n" + "          WHEN (SUM(dataflow.t_sum) > 500)                                                                                                    "
            + "\n" + "              THEN dataflow.t_percentRate                                                                                                     "
            + "\n" + "          ELSE 0                                                                                                                              "
            + "\n" + "      END                                                                  t_percentRate,                                                     "
            + "\n" + "      dataflow.t_date                                                      t_date,                                                            "
            + "\n" + "      dataflow.t_term                                                      t_term,                                                            "
            + "\n" + "      dataflow.t_limitRest                                                 t_limitRest,                                                       "
            + "\n" + "      dataflow.t_cbAccount                                                 t_cbAccount,                                                       "
            + "\n" + "      dataflow.t_operationType                                             t_operationType,                                                   "
            + "\n" + "      dataflow.t_okato                                                     t_okato,                                                           "
            + "\n" + "      dataflow.t_isCorrection                                              t_isCorrection,                                                    "
            + "\n" + "      dataflow.t_correctionDate                                            t_correctionDate                                                   "
            + "\n" + "  FROM dataflow                                                                                                                               "
            + "\n" + " GROUP BY (t_okato, t_sum, t_percentRate, t_date, t_term, t_limitRest, t_cbAccount, t_operationType, t_isCorrection, t_correctionDate)        "
            + "\n" + ")                                                                                                                                             "
            + "\n" + "SELECT " +         getSumText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_sumValue_2,"
            + "\n" + "       " +         getSumText("(t_term = 0) OR (t_term is NULL)"                                                                             + limitClause(includeLimit)) + " t_sumValue_2_1,"
            + "\n" + "       " +         getSumText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_sumValue_3,"
            + "\n" + "       " +         getSumText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_sumValue_4,"
            + "\n" + "       " +         getSumText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_sumValue_5,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_sumValue_6,"
            + "\n" + "       " +         getSumText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_sumValue_7,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0 OR t_term <= 30)"                                                                                + limitClause(includeLimit)) + " t_percentValue_2,"
            + "\n" + "       " + getPercentRateText("(t_term <= 0)"                                                                                                + limitClause(includeLimit)) + " t_percentValue_2_1,"
            + "\n" + "       " + getPercentRateText("(t_term > 30  AND t_term <= 90)"                                                                              + limitClause(excludeLimit)) + " t_percentValue_3,"
            + "\n" + "       " + getPercentRateText("(t_term > 90  AND t_term <= 180)"                                                                             + limitClause(excludeLimit)) + " t_percentValue_4,"
            + "\n" + "       " + getPercentRateText("(t_term > 180 AND (t_date + t_term) <  (t_date + (interval '1' year)))"                                       + limitClause(excludeLimit)) + " t_percentValue_5,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '1' year)) AND (t_date + t_term) < (t_date + (interval '3' year)))" + limitClause(excludeLimit)) + " t_percentValue_6,"
            + "\n" + "       " + getPercentRateText("((t_date + t_term) >= (t_date + (interval '3' year)))"                                                        + limitClause(excludeLimit)) + " t_percentValue_7,"
            + "\n" + "       t_date                                                              t_date,                                                            "
            + "\n" + "       t_term                                                              t_term,                                                            "
            + "\n" + "       t_limitRest                                                         t_limitRest,                                                       "
            + "\n" + "       t_cbAccount                                                         t_cbAccount,                                                       "
            + "\n" + "       t_operationType                                                     t_operationType,                                                   "
            + "\n" + "       t_okato                                                             t_okato,                                                           "
            + "\n" + "       t_isCorrection                                                      t_isCorrection,                                                    "
            + "\n" + "       t_correctionDate                                                    t_correctionDate,                                                  "
            + "\n" + "       grouping(t_sum)                                                     t_isTotal,                                                         "
            + "\n" + "       grouping(t_okato)                                                   t_isTotalOkato                                                     "
            + "\n" + "  FROM exclude                                                                                                                                "
            + "\n" + " GROUP BY ROLLUP(t_okato,                                                                                                                     "
            + "\n" + "                 (t_sum,                                                                                                                      "
            + "\n" + "                  t_percentRate,                                                                                                              "
            + "\n" + "                  t_date,                                                                                                                     "
            + "\n" + "                  t_term,                                                                                                                     "
            + "\n" + "                  t_limitRest,                                                                                                                "
            + "\n" + "                  t_cbAccount,                                                                                                                "
            + "\n" + "                  t_operationType,                                                                                                            "
            + "\n" + "                  t_isCorrection,                                                                                                             "
            + "\n" + "                  t_correctionDate))                                                                                                          "
            + "\n" + " ORDER BY t_okato, t_date, t_sum                                                                                                              "
            ;

        var dataSet = RcbDataSet(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("term",  V_INTEGER);
        dataSet.setFieldType("date",  V_DATE);

        return m_protocol.printProtocol(dataSet, attributeName, currencyCode);
    end;

    /**
     * Конструктор.
     *
     * @param     id              идентификатор источника данных
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorTDataSource4637(id : String, dataSources : Object /*RcbDataSources */)
        initTDataSource2926(id, dataSources);
    end;

    constructorTDataSource4637(id, dataSources);
end;

class (TDataSource4637) T129RetailOperationsDataSource4637(dataSources : Object /*RcbDataSources*/)
    private macro createDataSourceFilter() : bool
        m_filter = T129RetailOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129RetailOperationsDataSourceProtocol4637();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT rdd.t_percentRate                                    t_percentRate, "
            + "\n" + "       rdd.t_sum                                            t_sum, "
            + "\n" + "       rdd.t_date                                           t_date,"
            + "\n" + "       rdd.t_term                                           t_term,"
            + "\n" + "       NVL(rda.t_limitRest, 0)                              t_limitRest,"
            + "\n" + "       NVL(rdd.t_account, CHR(1))                           t_cbAccount,"
            + "\n" + "       CASE                                                                   "
            + "\n" + "           WHEN rdd.t_isOpening      = 1 THEN 'Открытие'"
            + "\n" + "           WHEN rdd.t_isProlongation = 1 THEN 'Пролонгация'"
            + "\n" + "       END                                                  t_operationType,"
            + "\n" + "       okato.t_okato                                        t_okato,"
            + "\n" + "       0                                                    t_isCorrection,"
            + "\n" + "       TO_DATE('01.01.0001', 'dd.mm.yyyy')                  t_correctionDate"
            + "\n" + "  FROM reprtldepdocument_vw rdd,"
            + "\n" + "       repRtlDepAccount_vw  rda,"
            + "\n" + "       repRtlDeposit_vw     dep,"
            + "\n" + "       okato"
            + "\n" + " WHERE " + RcbBranchFieldFilter().getAsSqlString("rdd.t_branchId")                 //Операция выполнена в одном из подразделений, по которым выпускается отчет
            + "\n" + "   AND rep_data.getBeginDate()       <= rdd.t_date"                                //Дата начала отчетного периода <= Дата операции  <= Дата окончания отчетного периода
            + "\n" + "   AND rep_data.getEndDate()         >= rdd.t_date"
            + "\n" + "   AND rdd.t_isProlongationOnSameCond = 0"                                         //Пролонгация на тех же условиях = "Нет"
            + "\n" + "   AND rda.t_contractId               = dep.t_contractId"
            + "\n" + "   AND rda.t_branchId                 = dep.t_branchId"
            + "\n" + "   AND okato.t_contragentId           = (SELECT party.t_partyId"                   //выборка ОКАТО по подразделению, в котором открыт договор
            + "\n" + "                                           FROM dRepDpDep_vw party"
            + "\n" + "                                          WHERE party.t_nodeId = dep.t_branchId)"
            + "\n" + "   AND rda.t_referenc                 = dep.t_referenc"
            + "\n" + "   AND rdd.t_referenc                 = rda.t_referenc"                            //Операции соответствует счет
            + "\n" + "   AND (    rdd.t_isOpening      = 1"                                              //Вид операции открытие или пролонгация
            + "\n" + "        OR  rdd.t_isProlongation = 1)"
            + "\n" + "   AND rdd.t_percentRate             != 0"                                         //Процентная ставка  не равна нулю
            + "\n" +     NVL(filter , " ");
    end;

    /**
     * Конструктор.
     * @param     dataSources     ссылка на контейнер
     */
    private macro constructorT129RetailOperationsDataSource4637(dataSources : Object /*RcbDataSources */)
        initTDataSource4637("Ритейл", dataSources);
    end;

    constructorT129RetailOperationsDataSource4637(dataSources);
end;

/**
 * Источник данных по операциям п/с "Депозиты" по 4637-У.
 */
class (TDataSource4637) T129DepositsOperationsDataSource4637(dataSources : Object /*RcbDataSources*/)

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T129DepositsOperationDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = T129DepositsOperationsDataSourceProtocol4637();
        return true;
    end;

    /**
     * Получить текст запроса данных раздела.
     *
     * @param     currencyCode     код валюты
     */
    private macro getDataflowQuery(filter : string) //: string
        return       "SELECT lo.t_interestRate                                                      t_percentRate, "
            + "\n" + "       lo.t_sum                                                               t_sum,"
            + "\n" + "       lo.t_date                                                              t_date,"
            + "\n" + "       lo.t_termRaising                                                       t_term,"
            + "\n" + "       NVL(lc.t_limitRest, 0)                                                 t_limitRest,"
            + "\n" + "       la.t_cbAccount                                                         t_cbAccount,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_type = " + CS_DEPO_PROL + " THEN 'Пролонгация депозита'"
            + "\n" + "           WHEN lo.t_type = " + CS_DEPOPAYM  + " THEN 'Взнос по депозиту'"
            + "\n" + "       END                                                                    t_operationType,"
            + "\n" + "       okato.t_okato                                                          t_okato,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN lo.t_history = 'К'"
            + "\n" + "               THEN 1"
            + "\n" + "           ELSE 0"
            + "\n" + "       END                                                                    t_isCorrection,"
            + "\n" + "       lo.t_correctionDate                                                    t_correctionDate"
            + "\n" + "  FROM repLnsOperation_vw lo,"
            + "\n" + "       repLnsContract_vw  lc,"
            + "\n" + "       repLnsAccount_vw   la,"
            + "\n" + "       okato"
            + "\n" + " WHERE lc.t_id              = lo.t_contractId"                                        //Операция принадлежит договору
            + "\n" + "   AND lc.t_type            = " + LO_DEPOSIT                                          //Тип договора = "Договор депозита"
            + "\n" + "   AND (   lc.t_subordinatedDeposit = 0"                                              //свойство "Субординированный депозит", действующее за (ДООП) = Нет
            + "\n" + "        OR lc.t_subordinatedDeposit IS NULL)"
            + "\n" + "   AND (   lc.t_isGuaranteeDeposit = 0"                                               //свойство "Гарантийный депозит", действующее за (ДООП) = Нет
            + "\n" + "        OR lc.t_isGuaranteeDeposit IS NULL)"
            + "\n" + "   AND okato.t_contragentId = (SELECT party.t_partyId"                                //выборка ОКАТО по подразделению, в котором открыт договор
            + "\n" + "                                 FROM dRepDpDep_vw party"
            + "\n" + "                                WHERE party.t_nodeId = lc.t_branchId)"
            + "\n" + "   AND " + RcbBranchFieldFilter().getAsSqlString("lc.t_branchId")                     //Договор принадлежит одному из подразделений, по которыму выпускается отчет
            + "\n" + "   AND lc.t_isOpened        = 1"                                                      //Открыт хотя бы один день в отчетном периоде
            + "\n" + "   AND (   lo.t_type = " + CS_DEPO_PROL                                               //Тип операции "Пролонгация депозита"
            + "\n" + "           AND UPPER(lo.t_isProlongationOnSameCond) = 'НЕТ'"                          //Пролонгация на тех же условиях = Нет
            + "\n" + "        OR (    lo.t_type = " + CS_DEPOPAYM                                           //или самый первый "Взнос по депозиту" по договору
            + "\n" + "            AND lo.t_date = (SELECT MIN(temp.t_date)"
            + "\n" + "                               FROM repLnsOperation_vw temp"
            + "\n" + "                              WHERE temp.t_contractId = lo.t_contractId"
            + "\n" + "                                AND temp.t_type       = " + CS_DEPOPAYM + ")"
            + "\n" + "           )"
            + "\n" + "       )"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.beginDate()) + " <= t_date"
            + "\n" + "   AND " + getSqlDate(RcbApplication.currentReport.context.period.endDate())   + " >= t_date"
            + "\n" + "   AND lo.t_interestRate != 0"                                                        //Процентная ставка  не равна нулю
            + "\n" + "   AND lo.t_tarifType    != 2"
            + "\n" + "   AND EXISTS (SELECT 1 "                                                             //К операции привязан документ по счету
            + "\n" + "                 FROM repLnsDocument_vw ld "
            + "\n" + "                WHERE lo.t_id            = ld.t_operationId"
            + "\n" + "                  AND ld.t_accountId     = la.t_id"
            + "\n" + "                  AND ld.t_creditAccount = la.t_account)"                             //который соответствует счету кредита
            + "\n" +     NVL(filter , " ");
    end;

    private macro constructorT129DepositsOperationsDataSource4637(dataSources : Object /*RcbDataSources */)
        initTDataSource4637("Депозиты", dataSources);
    end;

    constructorT129DepositsOperationsDataSource4637(dataSources);
end;

/**
 * Источники данных 129 формы по 2835-У.
 */
class (RcbDataSources) T129DataSources2926(protocolView : RcbCalculateProtocolView)

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource2926(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource2926(this));
        m_dataSourcePool.push_back(T129UserInputDataSource(this));
        m_dataSourcePool.push_back(T129InfDataSource(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;

    /**
     * Конструктор.
     */
    macro constructorT129DataSources2926(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorT129DataSources2926(protocolView);
end;

/**
 * Источники данных 129 формы по 4212-У.
 */
class (T129DataSources2926) T129DataSources4212(protocolView : RcbCalculateProtocolView)
    initT129DataSources2926(protocolView);

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource4212(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource4212(this));
        m_dataSourcePool.push_back(T129UserInputDataSource(this));
        m_dataSourcePool.push_back(T129InfDataSource_4212(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;
end;

class (T129DataSources4212) T129DataSources4637(protocolView : RcbCalculateProtocolView)
    initT129DataSources4212(protocolView);

    /**
     * Инициализация источников данных.
     */
    private macro initialize()
        m_dataSourcePool.push_back(T129RetailOperationsDataSource4637(this));
        m_dataSourcePool.push_back(T129DepositsOperationsDataSource4637(this));
        m_dataSourcePool.push_back(T129UserInputDataSource4637(this));
        m_dataSourcePool.push_back(T129SummableReportsDataSource2332(this));
    end;
end;
