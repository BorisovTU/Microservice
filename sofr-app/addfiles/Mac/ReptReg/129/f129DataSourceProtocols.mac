/*
$Name:          f129DataSourceProtocols.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 129. Протоколы источников данных
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 129. Протоколы источников данных.

  Создан: 2.12.2010 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import lib_lang;

/**************************************************************************************************
 * Классы реализации по указанию 2332
 **************************************************************************************************/

/**
 * Протокол источников данных
 */
class (RcbDataProtocolView) T129DataSourceProtocol(id)

    /**
     * Печать заголовка таблицы протокола.
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    macro printHead(dataPurpose : String)
        println(dataPurpose);
        println(m_id);
        [┌─────────────────────────┬────────┬────────────┬────────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │         Номер счета     │  Срок  │    Дата    │      Вид операции      │                                                                                  Сроки привлечения                                                                                                                             │
         │                         │договора│  операции  │                        ├────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┤
         │                         │        │            │                        │    до востребования    │      на 1 день         │        от 2 до 7 дней  │       от 8 до 30 дней  │    от 31 до 90 дней    │   от 91 до 180 дней    │  от 181 дня до 1 года  │   от 1 года до 3 лет   │      свыше 3 лет       │
         │                         │        │            │                        ├───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┼───────┬────────────────┤
         │                         │        │            │                        │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │%ставка│ сумма операции │
         ├─────────────────────────┴────────┴────────────┴────────────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┴───────┴────────────────┤];
    end;

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName)
        m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                            nvl(data.term, ""),
                            nvl(data.date, ""),
                            nvl(data.operationType, ""),
                            string(data.percentValue_1_1:0:3), data.sumValue_1_1,
                            string(data.percentValue_1_2:0:3), data.sumValue_1_2,
                            string(data.percentValue_1_3:0:3), data.sumValue_1_3,
                            string(data.percentValue_1_4:0:3), data.sumValue_1_4,
                            string(data.percentValue_2:0:3), data.sumValue_2,
                            string(data.percentValue_3:0:3), data.sumValue_3,
                            string(data.percentValue_4:0:3), data.sumValue_4,
                            string(data.percentValue_5:0:3), data.sumValue_5,
                            string(data.percentValue_6:0:3), data.sumValue_6);
    end;

    macro printBottom()
        m_table.printBottom();
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
        m_table.addColumn("Счет",  23);
        m_table.addColumn("Срок",  6);
        m_table.addColumn("Дата", 10, AL_RIGHT);
        m_table.addColumn("Вид",  22);

        m_table.addColumn("1.1 %",   5, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",   5, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",   5, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",   5, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",   5, AL_RIGHT);
        m_table.addColumn("2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",   5, AL_RIGHT);
        m_table.addColumn("3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("4 %",   5, AL_RIGHT);
        m_table.addColumn("4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("5 %",   5, AL_RIGHT);
        m_table.addColumn("5 Сумма", 14, AL_RIGHT);

        m_table.addColumn("6 %",   5, AL_RIGHT);
        m_table.addColumn("6 Сумма", 14, AL_RIGHT);
    end;

    macro printProtocol(dataSet, dataPurpose : String)

        printHead(dataPurpose);

        while (dataSet.next() and (dataSet.isTotal == 0))
            printString(dataSet);
        end;

        if (dataSet.EOF)
            m_table.printString("Нет данных");
            printBottom();
            println();
            return null;
        else
            printString(dataSet, "Итого");
            printBottom();
            println();
            return dataSet;
        end;
    end;

    /**
     * Конструктор.
     */
    private macro constructorT129DataSourceProtocol(id)
        initRcbDataProtocolView(id, false /*isInnerBorders*/, 0 /*offset*/);
    end;

    constructorT129DataSourceProtocol(id);
end;

/**
 * Протокол по операциям п/с "Ритейл"
 */
class (T129DataSourceProtocol) T129RetailOperationsDataSourceProtocol()

    private macro constructorT129RetailOperationsDataSourceProtocol()
        initT129DataSourceProtocol("Подсистема: Ритейл");
    end;

    constructorT129RetailOperationsDataSourceProtocol();
end;

/**
 * Протокол по операциям п/с "Депозиты"
 */
class (T129DataSourceProtocol) T129DepositsOperationsDataSourceProtocol()

    private macro constructorT129DepositsOperationsDataSourceProtocol()
        initT129DataSourceProtocol("Подсистема: Депозиты");
    end;

    constructorT129DepositsOperationsDataSourceProtocol();
end;

/**
 * Протокол по данным пользовательского ввода
 */
class (T129DataSourceProtocol) T129UserPartDataSourceProtocol()

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName)
        m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                            "",
                            "",
                            "",
                            string(data.percentValue_1_1:0:3), data.sumValue_1_1,
                            string(data.percentValue_1_2:0:3), data.sumValue_1_2,
                            string(data.percentValue_1_3:0:3), data.sumValue_1_3,
                            string(data.percentValue_1_4:0:3), data.sumValue_1_4,
                            string(data.percentValue_2:0:3), data.sumValue_2,
                            string(data.percentValue_3:0:3), data.sumValue_3,
                            string(data.percentValue_4:0:3), data.sumValue_4,
                            string(data.percentValue_5:0:3), data.sumValue_5,
                            string(data.percentValue_6:0:3), data.sumValue_6);
    end;

    private macro constructorT129UserPartDataSourceProtocol()
        initT129DataSourceProtocol("ПользовательскийВвод");
    end;

    constructorT129UserPartDataSourceProtocol();
end;

/**
 * Протокол по данным пользовательского ввода
 */
class (RcbDataProtocolView) T129UserInfDataSourceProtocol()

    macro printProtocol(dataSet, dataPurpose : String)

        while (dataSet.next() and (dataSet.isTotal == 0))
        end;

        println("Раздел 1. Раздел \"Справочно\"");
        println("Валюта: Российский рубль");
        println("Пользовательский ввод");

        if (dataSet.EOF)

            [┌─────────────────┬────────────────┐  ];
            [│  Номер строки   │     Сумма      │  ];
            [├─────────────────┴────────────────┤  ];
            [│  Нет данных                      │  ];
            [└──────────────────────────────────┘  ];
            println();
            return null;
        else

            [┌─────────────────┬────────────────┐  ];
            [│   Номер строки  │     Сумма      │  ];
            [├─────────────────┼────────────────┤  ];
            [│       7.1       │   ##########   │  ](dataSet.t_sumvalue_7_1);
            [├─────────────────┼────────────────┤  ];
            [│       7.2       │   ##########   │  ](dataSet.t_sumvalue_7_2);
            [└─────────────────┴────────────────┘  ];
            println();
            return dataSet;
        end;
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
    end;

    private macro constructorT129UserInfDataSourceProtocol()
        initRcbDataProtocolView(null, false /*isInnerBorders*/, 0 /*offset*/);
    end;

    constructorT129UserInfDataSourceProtocol();
end;

class (T129UserInfDataSourceProtocol) T129UserInfDataSourceProtocol_4212()
    initT129UserInfDataSourceProtocol();

    macro printProtocol(dataSet, dataPurpose : String)

        while (dataSet.next() and (dataSet.isTotal == 0))
        end;

        println("Раздел 1. Раздел \"Справочно\"");
        println("Валюта: Российский рубль");
        println("Пользовательский ввод");

        if (dataSet.EOF)
            [┌─────────────────┬────────────────┐  ];
            [│  Номер строки   │     Сумма      │  ];
            [├─────────────────┴────────────────┤  ];
            [│  Нет данных                      │  ];
            [└──────────────────────────────────┘  ];
            println();
            return null;
        else
            [┌─────────────────┬────────────────┐  ];
            [│   Номер строки  │     Сумма      │  ];
            [├─────────────────┼────────────────┤  ];
            [│       7.1       │ ############## │  ](dataSet.t_sumvalue_7_1);
            [└─────────────────┴────────────────┘  ];
            println();
            return dataSet;
        end;
    end;
end;

class (T129UserInfDataSourceProtocol) T129UserInfDataSourceProtocol_4637()
    initT129UserInfDataSourceProtocol();

    macro printProtocol(dataSet, dataPurpose : String)
        while (dataSet.next() and (dataSet.isTotal == 0))
        end;

        println();
        println("Раздел 1. Раздел \"Справочно\"");
        println("Валюта: Российский рубль");
        println("Пользовательский ввод");

        if (dataSet.EOF)
            [┌──────────────────┬────────────────┐  ];
            [│ Номер и наимено- │     Сумма      │  ];
            [│   вание строки   │                │  ];
            [├──────────────────┴────────────────┤  ];
            [│    Нет данных                     │  ];
            [└───────────────────────────────────┘  ];
            return null;
        else
            [┌──────────────────┬────────────────┐  ];
            [│ Номер и наимено- │     Сумма      │  ];
            [│   вание строки   │                │  ];
            [├──────────────────┼────────────────┤  ];
            [│       8.1        │ ############## │  ](dataSet.t_percentValue_8_1:0:3);
            [└──────────────────┴────────────────┘  ];
            return dataSet;
        end;
    end;
end;

/**************************************************************************************************
 * Классы реализации по указанию 2539
 **************************************************************************************************/

/**
 * Протокол источников данных
 */
class (RcbDataProtocolView) T129DataSourceProtocol2539(id)

    /**
     * Вставка пробела между словом "Раздел" и номером раздела
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    private macro getPartHead(dataPurpose : String) : String
        var temp;

        temp = StrSubst(dataPurpose, "Раздел1", "Раздел 1");
        temp = StrSubst(temp,        "Раздел2", "Раздел 2");
        temp = StrSubst(temp,        "Раздел3", "Раздел 3");

        return temp;
    end;

    /**
     * Печать заголовка таблицы протокола.
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    macro printHead(dataPurpose : String)
        println(dataPurpose);
        println(m_id);
        [┌─────────────────────────┬─────────────────┬────────────┬────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │         Номер счета     │   Неснижаемый   │    Дата    │      Вид операции      │                                                                                                                Сроки привлечения                                                                                                                 │
         │                         │     остаток     │  операции  │                        ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │                 │            │                        │     до востребования     │       на 1 день          │         от 2 до 7 дней   │        от 8 до 30 дней   │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │                 │            │                        ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │                 │            │                        │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴─────────────────┴────────────┴────────────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName)
        m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                            string((nvl(data.limitRest, "")):0:2),
                            nvl(data.date, ""),
                            nvl(data.operationType, ""),
                            string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                            string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                            string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                            string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                            string(data.percentValue_2:0:3), string(data.sumValue_2:0:2),
                            string(data.percentValue_3:0:3), string(data.sumValue_3:0:2),
                            string(data.percentValue_4:0:3), string(data.sumValue_4:0:2),
                            string(data.percentValue_5:0:3), string(data.sumValue_5:0:2),
                            string(data.percentValue_6:0:3), string(data.sumValue_6:0:2));
    end;

    macro printBottom()
        m_table.printBottom();
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
        m_table.addColumn("Счет",  23);
        m_table.addColumn("Н.О.",  15, AL_RIGHT);
        m_table.addColumn("Дата", 10, AL_RIGHT);
        m_table.addColumn("Вид",  22);

        m_table.addColumn("1.1 %",   7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",   7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",   7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",   7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",   7, AL_RIGHT);
        m_table.addColumn("2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",   7, AL_RIGHT);
        m_table.addColumn("3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("4 %",   7, AL_RIGHT);
        m_table.addColumn("4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("5 %",   7, AL_RIGHT);
        m_table.addColumn("5 Сумма", 14, AL_RIGHT);

        m_table.addColumn("6 %",   7, AL_RIGHT);
        m_table.addColumn("6 Сумма", 14, AL_RIGHT);
    end;

    macro printProtocol(dataSet, dataPurpose : String, codeCurrency : String)

        printHead(dataPurpose, codeCurrency);

        while (dataSet.next() and (dataSet.isTotal == 0))
            printString(dataSet);
        end;

        if (dataSet.EOF)
            m_table.printString("Нет данных");
            printBottom();
            println();
            return null;
        else
            printString(dataSet, "Итого");
            printBottom();
            println();
            return dataSet;
        end;
    end;

    macro getCurrencyName(currencyCode)
        if (   (currencyCode == 810)
            or (currencyCode == 643))
            return "рублей";
        elif (currencyCode == 840)
            return "долларов США";
        elif (currencyCode == 978)
            return "евро";
        end;
    end;

    macro printCurrency(currencyCode)
        if (   (currencyCode == 810)
            or (currencyCode == 643))
            println("Валюта: Российский рубль");
        elif (currencyCode == 840)
            println("Валюта: Доллар Соединенных Штатов Америки");
        elif (currencyCode == 978)
            println("Валюта: Евро");
        end;
    end;

    /**
     * Конструктор.
     */
    private macro constructorT129DataSourceProtocol2539(id)
        initRcbDataProtocolView(id, false /*isInnerBorders*/, 0 /*offset*/);
    end;

    constructorT129DataSourceProtocol2539(id);
end;

/**
 * Протокол по данным пользовательского ввода
 */
class (T129DataSourceProtocol2539) T129UserPartDataSourceProtocol2539()

     /**
     * Печать заголовка таблицы пользовательского протокола.
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    macro printHead(dataPurpose : String, codeCurrency)
        println(getPartHead(dataPurpose));
        printCurrency(codeCurrency);
        println(m_id);
        [┌─────────────────────────┬─────────────────┬────────────┬──────────────┬──────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │         Номер счета     │   Неснижаемый   │    Дата    │     Срок     │    Вид операции      │                                                                                                                                           Сроки привлечения                                                                                                                 │
         │                         │     остаток     │  операции  │   операции   │                      ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │                 │            │              │                      │         до 30 дней       │     до востребования     │       на 1 день          │         от 2 до 7 дней   │        от 8 до 30 дней   │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │                 │            │              │                      ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │                 │            │              │                      │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴─────────────────┴────────────┴──────────────┴──────────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName)
        m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                            "",
                            "",
                            "",
                            "",
                            string(data.percentValue_1:0:3), string(data.sumValue_1:0:2),
                            string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                            string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                            string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                            string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                            string(data.percentValue_2:0:3), string(data.sumValue_2:0:2),
                            string(data.percentValue_3:0:3), string(data.sumValue_3:0:2),
                            string(data.percentValue_4:0:3), string(data.sumValue_4:0:2),
                            string(data.percentValue_5:0:3), string(data.sumValue_5:0:2),
                            string(data.percentValue_6:0:3), string(data.sumValue_6:0:2));
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
        m_table.addColumn("Счет",  23);
        m_table.addColumn("Н.О.", 15, AL_RIGHT);
        m_table.addColumn("Дата", 10);
        m_table.addColumn("Срок", 10, AL_RIGHT);
        m_table.addColumn("Вид",  22);

        m_table.addColumn("1 %",   7, AL_RIGHT);
        m_table.addColumn("1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.1 %",   7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",   7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",   7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",   7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",   7, AL_RIGHT);
        m_table.addColumn("2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",   7, AL_RIGHT);
        m_table.addColumn("3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("4 %",   7, AL_RIGHT);
        m_table.addColumn("4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("5 %",   7, AL_RIGHT);
        m_table.addColumn("5 Сумма", 14, AL_RIGHT);

        m_table.addColumn("6 %",   7, AL_RIGHT);
        m_table.addColumn("6 Сумма", 14, AL_RIGHT);
    end;

    private macro constructorT129UserPartDataSourceProtocol2539()
        initT129DataSourceProtocol2539("ПользовательскийВвод");
    end;

    constructorT129UserPartDataSourceProtocol2539();
end;

/**
 * Протокол по операциям п/с "Ритейл"
 */
class (T129DataSourceProtocol2539) T129RetailOperationsDataSourceProtocol2539()

    private macro constructorT129RetailOperationsDataSourceProtocol2539()
        initT129DataSourceProtocol2539("Подсистема: Ритейл");
    end;

    constructorT129RetailOperationsDataSourceProtocol2539();
end;

/**
 * Протокол по операциям п/с "Депозиты"
 */
class (T129DataSourceProtocol2539) T129DepositsOperationsDataSourceProtocol2539()

    private macro constructorT129DepositsOperationsDataSourceProtocol2539()
        initT129DataSourceProtocol2539("Подсистема: Депозиты");
    end;

    constructorT129DepositsOperationsDataSourceProtocol2539();
end;

class (T129DataSourceProtocol2539) T129DataSourceProtocol2926(id)

    /**
     * Печать заголовка таблицы протокола.
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    macro printHead(dataPurpose : String, currencyCode)
        println(dataPurpose);
        printCurrency(currencyCode);
        println(m_id);
        [┌─────────────────────────┬─────────────────┬────────────┬──────────────┬──────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │         Номер счета     │   Неснижаемый   │    Дата    │     Срок     │    Вид операции      │                                                                                                                                           Сроки привлечения                                                                                                                 │
         │                         │     остаток     │  операции  │   операции   │                      ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │                 │            │              │                      │         до 30 дней       │     до востребования     │       на 1 день          │         от 2 до 7 дней   │        от 8 до 30 дней   │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │                 │            │              │                      ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │                 │            │              │                      │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴─────────────────┴────────────┴──────────────┴──────────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName, currencyCode)
        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_1:0:3), ternary(data.sumValue_1 < 500, msg, string(data.sumValue_1:0:2)),
                                              string(data.percentValue_1_1:0:3), ternary(data.sumValue_1_1 < 500, msg, string(data.sumValue_1_1:0:2)),
                                              string(data.percentValue_1_2:0:3), ternary(data.sumValue_1_2 < 500, msg, string(data.sumValue_1_2:0:2)),
                                              string(data.percentValue_1_3:0:3), ternary(data.sumValue_1_3 < 500, msg, string(data.sumValue_1_3:0:2)),
                                              string(data.percentValue_1_4:0:3), ternary(data.sumValue_1_4 < 500, msg, string(data.sumValue_1_4:0:2)),
                                              string(data.percentValue_2:0:3), ternary(data.sumValue_2 < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_3:0:3), ternary(data.sumValue_3 < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3), ternary(data.sumValue_4 < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3), ternary(data.sumValue_5 < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3), ternary(data.sumValue_6 < 500, msg, string(data.sumValue_6:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                string((nvl(data.limitRest, "")):0:2),
                                nvl(data.date, ""),
                                nvl(data.term, ""),
                                nvl(data.operationType, ""),
                                string(data.percentValue_1:0:3), string(data.sumValue_1:0:2),
                                string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                                string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                                string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                                string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                                string(data.percentValue_2:0:3), string(data.sumValue_2:0:2),
                                string(data.percentValue_3:0:3), string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3), string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3), string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3), string(data.sumValue_6:0:2));
        end;
    end;

    macro printBottom()
        m_table.printBottom();
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
        m_table.addColumn("Счет",  23);
        m_table.addColumn("Н.О.",  15, AL_RIGHT);
        m_table.addColumn("Дата", 10, AL_RIGHT);
        m_table.addColumn("Срок", 10, AL_RIGHT);
        m_table.addColumn("Вид",  22);

        m_table.addColumn("1 %",   7, AL_RIGHT);
        m_table.addColumn("1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.1 %",   7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",   7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",   7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",   7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",   7, AL_RIGHT);
        m_table.addColumn("2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",   7, AL_RIGHT);
        m_table.addColumn("3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("4 %",   7, AL_RIGHT);
        m_table.addColumn("4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("5 %",   7, AL_RIGHT);
        m_table.addColumn("5 Сумма", 14, AL_RIGHT);

        m_table.addColumn("6 %",   7, AL_RIGHT);
        m_table.addColumn("6 Сумма", 14, AL_RIGHT);
    end;

    macro printProtocol(dataSet, dataPurpose : String, currencyCode)

        printHead(dataPurpose, currencyCode);

        while (dataSet.next() and (dataSet.isTotal == 0))
            printString(dataSet);
        end;

        if (dataSet.EOF)
            m_table.printString("Нет данных");
            printBottom();
            println();
            return null;
        else
            printString(dataSet, "Итого", currencyCode);
            printBottom();
            println();
            return dataSet;
        end;
    end;

    /**
     * Конструктор.
     */
    private macro constructorT129DataSourceProtocol2926(id)
        initRcbDataProtocolView(id, false /*isInnerBorders*/, 0 /*offset*/);
    end;

    constructorT129DataSourceProtocol2926(id);
end;

/**
 * Протокол по операциям п/с "Ритейл"
 */
class (T129DataSourceProtocol2926) T129RetailOperationsDataSourceProtocol2926()

    private macro constructorT129RetailOperationsDataSourceProtocol2926()
        initT129DataSourceProtocol2926("Подсистема: Ритейл");
    end;

    constructorT129RetailOperationsDataSourceProtocol2926();
end;

class (T129RetailOperationsDataSourceProtocol2926) T129RetailOperationsDataSourceProtocol4212()
    initT129RetailOperationsDataSourceProtocol2926();

    macro printHead(dataPurpose : String, currencyCode)
        println(getPartHead(dataPurpose));
        printCurrency(currencyCode);
        println(m_id);
        [┌─────────────────────────┬────────────┬──────────────────────┬─────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │       Номер счета       │    Дата    │     Вид операции     │   Неснижаемый   │                                                                                                                              Сроки привлечения                                                                                                                              │
         │                         │  операции  │                      │     остаток     ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │            │                      │                 │        до 30 дней        │     до востребования     │         на 1 день        │      от 2 до 7 дней      │     от 8 до 30 дней      │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │            │                      │                 ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │            │                      │                 │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴────────────┴──────────────────────┴─────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    macro printString(data, totalStringName, currencyCode)
        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_1:0:3),   ternary(data.sumValue_1   < 500, msg, string(data.sumValue_1:0:2)),
                                              string(data.percentValue_1_1:0:3), ternary(data.sumValue_1_1 < 500, msg, string(data.sumValue_1_1:0:2)),
                                              string(data.percentValue_1_2:0:3), ternary(data.sumValue_1_2 < 500, msg, string(data.sumValue_1_2:0:2)),
                                              string(data.percentValue_1_3:0:3), ternary(data.sumValue_1_3 < 500, msg, string(data.sumValue_1_3:0:2)),
                                              string(data.percentValue_1_4:0:3), ternary(data.sumValue_1_4 < 500, msg, string(data.sumValue_1_4:0:2)),
                                              string(data.percentValue_2:0:3),   ternary(data.sumValue_2   < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_3:0:3),   ternary(data.sumValue_3   < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3),   ternary(data.sumValue_4   < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3),   ternary(data.sumValue_5   < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3),   ternary(data.sumValue_6   < 500, msg, string(data.sumValue_6:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                nvl(data.date, ""),
                                nvl(data.operationType, ""),
                                string((nvl(data.limitRest, "")):0:2),
                                string(data.percentValue_1:0:3),   string(data.sumValue_1:0:2),
                                string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                                string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                                string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                                string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                                string(data.percentValue_2:0:3),   string(data.sumValue_2:0:2),
                                string(data.percentValue_3:0:3),   string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3),   string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3),   string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3),   string(data.sumValue_6:0:2));
        end;
    end;

    private macro initialize()
        m_table.addColumn("Счет",      23          );
        m_table.addColumn("Дата",      10, AL_RIGHT);
        m_table.addColumn("Вид",       20          );
        m_table.addColumn("Н.О.",      15, AL_RIGHT);

        m_table.addColumn("1 %",        7, AL_RIGHT);
        m_table.addColumn("1 Сумма",   14, AL_RIGHT);

        m_table.addColumn("1.1 %",      7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",      7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",      7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",      7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",        7, AL_RIGHT);
        m_table.addColumn("2 Сумма",   14, AL_RIGHT);

        m_table.addColumn("3 %",        7, AL_RIGHT);
        m_table.addColumn("3 Сумма",   14, AL_RIGHT);

        m_table.addColumn("4 %",        7, AL_RIGHT);
        m_table.addColumn("4 Сумма",   14, AL_RIGHT);

        m_table.addColumn("5 %",        7, AL_RIGHT);
        m_table.addColumn("5 Сумма",   14, AL_RIGHT);

        m_table.addColumn("6 %",        7, AL_RIGHT);
        m_table.addColumn("6 Сумма",   14, AL_RIGHT);
    end;
end;

class (T129RetailOperationsDataSourceProtocol4212) T129RetailOperationsDataSourceProtocol4637()
    initT129RetailOperationsDataSourceProtocol4212();

    macro printTableHead()
        [┌─────────────────────────┬────────────┬──────────────────────┬─────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │       Номер счета       │    Дата    │     Вид операции     │   Неснижаемый   │                                                                                     Сроки привлечения                                                                                      │
         │                         │  операции  │                      │     остаток     ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │            │                      │                 │        до 30 дней        │     до востребования     │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │            │                      │                 ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │            │                      │                 │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴────────────┴──────────────────────┴─────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    macro printHead(dataPurpose : String, currencyCode)
        println(getPartHead(dataPurpose));
        printCurrency(currencyCode);
        println(m_id);
    end;

    macro printString(data, totalStringName, currencyCode)
        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_2:0:3),   ternary(data.sumValue_2   < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_2_1:0:3), ternary(data.sumValue_2_1 < 500, msg, string(data.sumValue_2_1:0:2)),
                                              string(data.percentValue_3:0:3),   ternary(data.sumValue_3   < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3),   ternary(data.sumValue_4   < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3),   ternary(data.sumValue_5   < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3),   ternary(data.sumValue_6   < 500, msg, string(data.sumValue_6:0:2)),
                                              string(data.percentValue_7:0:3),   ternary(data.sumValue_7   < 500, msg, string(data.sumValue_7:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                nvl(data.date, ""),
                                nvl(data.operationType, ""),
                                string((nvl(data.limitRest, "")):0:2),
                                string(data.percentValue_2:0:3),   string(data.sumValue_2:0:2),
                                string(data.percentValue_2_1:0:3), string(data.sumValue_2_1:0:2),
                                string(data.percentValue_3:0:3),   string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3),   string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3),   string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3),   string(data.sumValue_6:0:2),
                                string(data.percentValue_7:0:3),   string(data.sumValue_7:0:2)
                                );
        end;
    end;

    private macro initialize()
        m_table.addColumn("Счет",      23          );
        m_table.addColumn("Дата",      10, AL_RIGHT);
        m_table.addColumn("Вид",       20          );
        m_table.addColumn("Н.О.",      15, AL_RIGHT);

        m_table.addColumn("2 %",        7, AL_RIGHT);
        m_table.addColumn("2 Сумма",   14, AL_RIGHT);

        m_table.addColumn("2.1 %",      7, AL_RIGHT);
        m_table.addColumn("2.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",        7, AL_RIGHT);
        m_table.addColumn("3 Сумма",   14, AL_RIGHT);

        m_table.addColumn("4 %",        7, AL_RIGHT);
        m_table.addColumn("4 Сумма",   14, AL_RIGHT);

        m_table.addColumn("5 %",        7, AL_RIGHT);
        m_table.addColumn("5 Сумма",   14, AL_RIGHT);

        m_table.addColumn("6 %",        7, AL_RIGHT);
        m_table.addColumn("6 Сумма",   14, AL_RIGHT);

        m_table.addColumn("7 %",        7, AL_RIGHT);
        m_table.addColumn("7 Сумма",   14, AL_RIGHT);
    end;

    macro printProtocol(dataSet, dataPurpose : String, currencyCode)
        private var data         = TArray();
        private var correctData  = TReportInfo(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, "", 1);    //для накопления корректировки по строке 1 - исключаем из нее данные с ОКАТО, не подходящие под шаблон "**000"
        private var currentOkato = "";

        if (dataSet.EOF)
            printHead(dataPurpose, currencyCode);
            m_table.printString("Нет данных");
            println();
            return null;
        else
            while (dataSet.next())
                if (dataSet.isTotal == 0)
                    if (currentOkato != dataSet.okato)
                        currentOkato = dataSet.okato;
                        println();
                        printHead(dataPurpose, currencyCode);
                        println("Код ОКАТО: " + currentOkato);
                        printTableHead();
                    end;

                    printString(dataSet);
                else
                    if (    (dataSet.okato != null)
                        and (dataSet.okato != "99999")
                        and (SubStr(dataSet.okato, 3, 3) != "000")
                       )
                        correctData.m_sumValue_2 = correctData.m_sumValue_2 + dataSet.sumValue_2;
                        correctData.m_sumValue_3 = correctData.m_sumValue_3 + dataSet.sumValue_3;
                        correctData.m_sumValue_4 = correctData.m_sumValue_4 + dataSet.sumValue_4;
                        correctData.m_sumValue_5 = correctData.m_sumValue_5 + dataSet.sumValue_5;
                        correctData.m_sumValue_6 = correctData.m_sumValue_6 + dataSet.sumValue_6;
                        correctData.m_sumValue_7 = correctData.m_sumValue_7 + dataSet.sumValue_7;
                    end;
                                                                                                         //dataSet.okato == null - итоговая строка по разделу
                    data[data.size] = TReportInfo(dataSet.percentValue_2,   dataSet.sumValue_2   - ternary(dataSet.okato == null, correctData.m_sumValue_2, 0),
                                                  dataSet.percentValue_2_1, dataSet.sumValue_2_1,
                                                  dataSet.percentValue_3,   dataSet.sumValue_3   - ternary(dataSet.okato == null, correctData.m_sumValue_3, 0),
                                                  dataSet.percentValue_4,   dataSet.sumValue_4   - ternary(dataSet.okato == null, correctData.m_sumValue_4, 0),
                                                  dataSet.percentValue_5,   dataSet.sumValue_5   - ternary(dataSet.okato == null, correctData.m_sumValue_5, 0),
                                                  dataSet.percentValue_6,   dataSet.sumValue_6   - ternary(dataSet.okato == null, correctData.m_sumValue_6, 0),
                                                  dataSet.percentValue_7,   dataSet.sumValue_7   - ternary(dataSet.okato == null, correctData.m_sumValue_7, 0),
                                                  dataSet.okato,
                                                  dataSet.isTotal * dataSet.isTotalOkato);

                    //пропускаем общий итог по разделу
                    if (dataSet.isTotalOkato == 0)
                        printString(dataSet, "Итого", currencyCode);
                        printBottom();
                    end;
                end;
            end;

            return data;
        end;
    end;
end;

/**
 * Протокол по операциям п/с "Депозиты"
 */
class (T129DataSourceProtocol2926) T129DepositsOperationsDataSourceProtocol2926()

    private macro constructorT129DepositsOperationsDataSourceProtocol2926()
        initT129DataSourceProtocol2926("Подсистема: Депозиты");
    end;

    /**
     * Печать заголовка таблицы протокола.
     *
     * @param     dataPurpose   наименование раздела протокола
     */
    macro printHead(dataPurpose : String, currencyCode)
        println(dataPurpose);
        printCurrency(currencyCode);
        println(m_id);
        [┌─────────────────────────┬─────────────────┬────────────┬──────────────┬──────────────────────┬───────────────────────┬────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │         Номер счета     │   Неснижаемый   │    Дата    │     Срок     │    Вид операции      │     Корректирующая    │  Дата, за которую  │                                                                                                                                           Сроки привлечения                                                                                                                 │
         │                         │     остаток     │  операции  │   операции   │                      │        операция       │      проведена     ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │                 │            │              │                      │                       │    корр. операция  │         до 30 дней       │     до востребования     │       на 1 день          │         от 2 до 7 дней   │        от 8 до 30 дней   │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │                 │            │              │                      │                       │                    ├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │                 │            │              │                      │                       │                    │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴─────────────────┴────────────┴──────────────┴──────────────────────┴───────────────────────┴────────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    /**
     * Печать строки таблицы протокола.
     *
     * @param     data   строка данных
     */
    macro printString(data, totalStringName, currencyCode)
        var dt;
        var tm;
        DtTmSplit ( data.correctionDate, dt, tm );

        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_1:0:3), ternary(data.sumValue_1 < 500, msg, string(data.sumValue_1:0:2)),
                                              string(data.percentValue_1_1:0:3), ternary(data.sumValue_1_1 < 500, msg, string(data.sumValue_1_1:0:2)),
                                              string(data.percentValue_1_2:0:3), ternary(data.sumValue_1_2 < 500, msg, string(data.sumValue_1_2:0:2)),
                                              string(data.percentValue_1_3:0:3), ternary(data.sumValue_1_3 < 500, msg, string(data.sumValue_1_3:0:2)),
                                              string(data.percentValue_1_4:0:3), ternary(data.sumValue_1_4 < 500, msg, string(data.sumValue_1_4:0:2)),
                                              string(data.percentValue_2:0:3), ternary(data.sumValue_2 < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_3:0:3), ternary(data.sumValue_3 < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3), ternary(data.sumValue_4 < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3), ternary(data.sumValue_5 < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3), ternary(data.sumValue_6 < 500, msg, string(data.sumValue_6:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                string((nvl(data.limitRest, "")):0:2),
                                nvl(data.date, ""),
                                nvl(data.term, ""),
                                nvl(data.operationType, ""),
                                ternary(data.isCorrection == 1, "X", ""),
                                ternary(data.isCorrection == 1, dt, ""),
                                string(data.percentValue_1:0:3), string(data.sumValue_1:0:2),
                                string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                                string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                                string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                                string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                                string(data.percentValue_2:0:3), string(data.sumValue_2:0:2),
                                string(data.percentValue_3:0:3), string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3), string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3), string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3), string(data.sumValue_6:0:2));
        end;
    end;

    /**
     * Инициализация таблицы протокола.
     */
    private macro initialize()
        m_table.addColumn("Счет",  23);
        m_table.addColumn("Н.О.",  15, AL_RIGHT);
        m_table.addColumn("Дата", 10, AL_RIGHT);
        m_table.addColumn("Срок", 10, AL_RIGHT);
        m_table.addColumn("Вид",  22);
        m_table.addColumn("Корр. операция",  23);
        m_table.addColumn("Дата корр. операции",  20);

        m_table.addColumn("1 %",   7, AL_RIGHT);
        m_table.addColumn("1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.1 %",   7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.2 %",   7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.3 %",   7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("1.4 %",   7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("2 %",   7, AL_RIGHT);
        m_table.addColumn("2 Сумма", 14, AL_RIGHT);

        m_table.addColumn("3 %",   7, AL_RIGHT);
        m_table.addColumn("3 Сумма", 14, AL_RIGHT);

        m_table.addColumn("4 %",   7, AL_RIGHT);
        m_table.addColumn("4 Сумма", 14, AL_RIGHT);

        m_table.addColumn("5 %",   7, AL_RIGHT);
        m_table.addColumn("5 Сумма", 14, AL_RIGHT);

        m_table.addColumn("6 %",   7, AL_RIGHT);
        m_table.addColumn("6 Сумма", 14, AL_RIGHT);
    end;

    constructorT129DepositsOperationsDataSourceProtocol2926();
end;

class (T129DepositsOperationsDataSourceProtocol2926) T129DepositsOperationsDataSourceProtocol4212()
    initT129DepositsOperationsDataSourceProtocol2926();

    macro printHead(dataPurpose : String, currencyCode)
        println(getPartHead(dataPurpose));
        printCurrency(currencyCode);
        println(m_id);
        [┌─────────────────────────┬────────────┬──────────────────────┬─────────────────┬───────────────────────┬─────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │       Номер счета       │    Дата    │     Вид операции     │   Неснижаемый   │    Корректирующая     │    Дата,    │                                                                                                                              Сроки привлечения                                                                                                                              │
         │                         │  операции  │                      │     остаток     │       операция        │ за которую  ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │            │                      │                 │                       │  проведена  │        до 30 дней        │     до востребования     │         на 1 день        │      от 2 до 7 дней      │     от 8 до 30 дней      │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │            │                      │                 │                       │корр.операция├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │            │                      │                 │                       │             │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴────────────┴──────────────────────┴─────────────────┴───────────────────────┴─────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    macro printString(data, totalStringName, currencyCode)
        var dt;
        var tm;
        DtTmSplit(data.correctionDate, dt, tm);

        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_1:0:3),   ternary(data.sumValue_1   < 500, msg, string(data.sumValue_1:0:2)),
                                              string(data.percentValue_1_1:0:3), ternary(data.sumValue_1_1 < 500, msg, string(data.sumValue_1_1:0:2)),
                                              string(data.percentValue_1_2:0:3), ternary(data.sumValue_1_2 < 500, msg, string(data.sumValue_1_2:0:2)),
                                              string(data.percentValue_1_3:0:3), ternary(data.sumValue_1_3 < 500, msg, string(data.sumValue_1_3:0:2)),
                                              string(data.percentValue_1_4:0:3), ternary(data.sumValue_1_4 < 500, msg, string(data.sumValue_1_4:0:2)),
                                              string(data.percentValue_2:0:3),   ternary(data.sumValue_2   < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_3:0:3),   ternary(data.sumValue_3   < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3),   ternary(data.sumValue_4   < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3),   ternary(data.sumValue_5   < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3),   ternary(data.sumValue_6   < 500, msg, string(data.sumValue_6:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                nvl(data.date, ""),
                                nvl(data.operationType, ""),
                                string((nvl(data.limitRest, "")):0:2),
                                ternary(data.isCorrection == 1, "X", ""),
                                ternary(data.isCorrection == 1, dt, ""),
                                string(data.percentValue_1:0:3),   string(data.sumValue_1:0:2),
                                string(data.percentValue_1_1:0:3), string(data.sumValue_1_1:0:2),
                                string(data.percentValue_1_2:0:3), string(data.sumValue_1_2:0:2),
                                string(data.percentValue_1_3:0:3), string(data.sumValue_1_3:0:2),
                                string(data.percentValue_1_4:0:3), string(data.sumValue_1_4:0:2),
                                string(data.percentValue_2:0:3),   string(data.sumValue_2:0:2),
                                string(data.percentValue_3:0:3),   string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3),   string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3),   string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3),   string(data.sumValue_6:0:2));
        end;
    end;

    private macro initialize()
        m_table.addColumn("Счет",           23          );
        m_table.addColumn("Дата",           10, AL_RIGHT);
        m_table.addColumn("Вид",            20          );
        m_table.addColumn("Н.О.",           15, AL_RIGHT);
        m_table.addColumn("Корр. операция", 21          );
        m_table.addColumn("ДатаКоррОп",     11          );

        m_table.addColumn("1 %",             7, AL_RIGHT);
        m_table.addColumn("1 Сумма",        14, AL_RIGHT);

        m_table.addColumn("1.1 %",           7, AL_RIGHT);
        m_table.addColumn("1.1 Сумма",      14, AL_RIGHT);

        m_table.addColumn("1.2 %",           7, AL_RIGHT);
        m_table.addColumn("1.2 Сумма",      14, AL_RIGHT);

        m_table.addColumn("1.3 %",           7, AL_RIGHT);
        m_table.addColumn("1.3 Сумма",      14, AL_RIGHT);

        m_table.addColumn("1.4 %",           7, AL_RIGHT);
        m_table.addColumn("1.4 Сумма",      14, AL_RIGHT);

        m_table.addColumn("2 %",             7, AL_RIGHT);
        m_table.addColumn("2 Сумма",        14, AL_RIGHT);

        m_table.addColumn("3 %",             7, AL_RIGHT);
        m_table.addColumn("3 Сумма",        14, AL_RIGHT);

        m_table.addColumn("4 %",             7, AL_RIGHT);
        m_table.addColumn("4 Сумма",        14, AL_RIGHT);

        m_table.addColumn("5 %",             7, AL_RIGHT);
        m_table.addColumn("5 Сумма",        14, AL_RIGHT);

        m_table.addColumn("6 %",             7, AL_RIGHT);
        m_table.addColumn("6 Сумма",        14, AL_RIGHT);
    end;
end;

class (T129DepositsOperationsDataSourceProtocol4212) T129DepositsOperationsDataSourceProtocol4637()
    initT129DepositsOperationsDataSourceProtocol4212();

    macro printTableHead()
        [┌─────────────────────────┬────────────┬──────────────────────┬─────────────────┬─────────┬─────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
         │       Номер счета       │    Дата    │     Вид операции     │   Неснижаемый   │Корректи-│    Дата,    │                                                                                     Сроки привлечения                                                                                      │
         │                         │  операции  │                      │     остаток     │ рующая  │ за которую  ├──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┬──────────────────────────┤
         │                         │            │                      │                 │операция │  проведена  │        до 30 дней        │     до востребования     │     от 31 до 90 дней     │    от 91 до 180 дней     │   от 181 дня до 1 года   │    от 1 года до 3 лет    │       свыше 3 лет        │
         │                         │            │                      │                 │         │корр.операция├─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┼─────────┬────────────────┤
         │                         │            │                      │                 │         │             │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │ %ставка │ сумма операции │
         ├─────────────────────────┴────────────┴──────────────────────┴─────────────────┴─────────┴─────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────┤];
    end;

    macro printHead(dataPurpose : String, currencyCode)
        println(getPartHead(dataPurpose));
        printCurrency(currencyCode);
        println(m_id);
    end;

    macro printString(data, totalStringName, currencyCode)
        var dt;
        var tm;
        DtTmSplit(data.correctionDate, dt, tm);

        var msg = "Итоговая сумма по строке < 500 " + getCurrencyName(currencyCode) + ", в отчет по строке выводится 0";
        if (totalStringName == "Итого")
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              "",
                                              "",
                                              string(data.percentValue_2:0:3),   ternary(data.sumValue_2   < 500, msg, string(data.sumValue_2:0:2)),
                                              string(data.percentValue_2_1:0:3), ternary(data.sumValue_2_1 < 500, msg, string(data.sumValue_2_1:0:2)),
                                              string(data.percentValue_3:0:3),   ternary(data.sumValue_3   < 500, msg, string(data.sumValue_3:0:2)),
                                              string(data.percentValue_4:0:3),   ternary(data.sumValue_4   < 500, msg, string(data.sumValue_4:0:2)),
                                              string(data.percentValue_5:0:3),   ternary(data.sumValue_5   < 500, msg, string(data.sumValue_5:0:2)),
                                              string(data.percentValue_6:0:3),   ternary(data.sumValue_6   < 500, msg, string(data.sumValue_6:0:2)),
                                              string(data.percentValue_7:0:3),   ternary(data.sumValue_7   < 500, msg, string(data.sumValue_7:0:2)));
        elif (global().getParameters().isCalculateProtocol() == true)
            m_table.printString(nvl(totalStringName, nvl(data.cbAccount, "")),
                                nvl(data.date, ""),
                                nvl(data.operationType, ""),
                                string((nvl(data.limitRest, "")):0:2),
                                ternary(data.isCorrection == 1, "X", ""),
                                ternary(data.isCorrection == 1, dt, ""),
                                string(data.percentValue_2:0:3),   string(data.sumValue_2:0:2),
                                string(data.percentValue_2_1:0:3), string(data.sumValue_2_1:0:2),
                                string(data.percentValue_3:0:3),   string(data.sumValue_3:0:2),
                                string(data.percentValue_4:0:3),   string(data.sumValue_4:0:2),
                                string(data.percentValue_5:0:3),   string(data.sumValue_5:0:2),
                                string(data.percentValue_6:0:3),   string(data.sumValue_6:0:2),
                                string(data.percentValue_7:0:3),   string(data.sumValue_7:0:2)
                                );
        end;
    end;

    private macro initialize()
        m_table.addColumn("Счет",       23           );
        m_table.addColumn("Дата",       10, AL_RIGHT );
        m_table.addColumn("Вид",        20           );
        m_table.addColumn("Н.О.",       15, AL_RIGHT );
        m_table.addColumn("КоррОп",      7, AL_CENTER);
        m_table.addColumn("ДатаКоррОп", 11           );

        m_table.addColumn("2 %",         7, AL_RIGHT );
        m_table.addColumn("2 Сумма",    14, AL_RIGHT );

        m_table.addColumn("2.1 %",       7, AL_RIGHT );
        m_table.addColumn("2.1 Сумма",  14, AL_RIGHT );

        m_table.addColumn("3 %",         7, AL_RIGHT );
        m_table.addColumn("3 Сумма",    14, AL_RIGHT );

        m_table.addColumn("4 %",         7, AL_RIGHT );
        m_table.addColumn("4 Сумма",    14, AL_RIGHT );

        m_table.addColumn("5 %",         7, AL_RIGHT );
        m_table.addColumn("5 Сумма",    14, AL_RIGHT );

        m_table.addColumn("6 %",         7, AL_RIGHT );
        m_table.addColumn("6 Сумма",    14, AL_RIGHT );

        m_table.addColumn("7 %",         7, AL_RIGHT );
        m_table.addColumn("7 Сумма",    14, AL_RIGHT );
    end;

    macro printProtocol(dataSet, dataPurpose : String, currencyCode)
        private var data         = TArray();
        private var correctData  = TReportInfo(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, "", 1);    //для накопления корректировки по строке 1 - исключаем из нее данные с ОКАТО, не подходящие под шаблон "**000"
        private var currentOkato = "";

        if (dataSet.EOF)
            printHead(dataPurpose, currencyCode);
            m_table.printString("Нет данных");
            println();
            return null;
        else
            while (dataSet.next())
                if (dataSet.isTotal == 0)
                    if (currentOkato != dataSet.okato)
                        currentOkato = dataSet.okato;
                        println();
                        printHead(dataPurpose, currencyCode);
                        println("Код ОКАТО: " + currentOkato);
                        printTableHead();
                    end;

                    printString(dataSet);
                else
                    if (    (dataSet.okato != null)
                        and (dataSet.okato != "99999")
                        and (SubStr(dataSet.okato, 3, 3) != "000")
                       )
                        correctData.m_sumValue_2 = correctData.m_sumValue_2 + dataSet.sumValue_2;
                        correctData.m_sumValue_3 = correctData.m_sumValue_3 + dataSet.sumValue_3;
                        correctData.m_sumValue_4 = correctData.m_sumValue_4 + dataSet.sumValue_4;
                        correctData.m_sumValue_5 = correctData.m_sumValue_5 + dataSet.sumValue_5;
                        correctData.m_sumValue_6 = correctData.m_sumValue_6 + dataSet.sumValue_6;
                        correctData.m_sumValue_7 = correctData.m_sumValue_7 + dataSet.sumValue_7;
                    end;
                                                                                                         //dataSet.okato == null - итоговая строка по разделу
                    data[data.size] = TReportInfo(dataSet.percentValue_2,   dataSet.sumValue_2   - ternary(dataSet.okato == null, correctData.m_sumValue_2, 0),
                                                  dataSet.percentValue_2_1, dataSet.sumValue_2_1,
                                                  dataSet.percentValue_3,   dataSet.sumValue_3   - ternary(dataSet.okato == null, correctData.m_sumValue_3, 0),
                                                  dataSet.percentValue_4,   dataSet.sumValue_4   - ternary(dataSet.okato == null, correctData.m_sumValue_4, 0),
                                                  dataSet.percentValue_5,   dataSet.sumValue_5   - ternary(dataSet.okato == null, correctData.m_sumValue_5, 0),
                                                  dataSet.percentValue_6,   dataSet.sumValue_6   - ternary(dataSet.okato == null, correctData.m_sumValue_6, 0),
                                                  dataSet.percentValue_7,   dataSet.sumValue_7   - ternary(dataSet.okato == null, correctData.m_sumValue_7, 0),
                                                  dataSet.okato,
                                                  dataSet.isTotal * dataSet.isTotalOkato);

                    //пропускаем общий итог по разделу
                    if (dataSet.isTotalOkato == 0)
                        printString(dataSet, "Итого", currencyCode);
                        printBottom();
                    end;
                end;
            end;

            return data;
        end;
    end;
end;
