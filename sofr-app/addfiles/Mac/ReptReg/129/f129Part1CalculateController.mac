/*
$Name:          f129Part1CalculateController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 129. Управление расчетом разделов формы
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Форма 129. Управление расчетом разделов формы.

  Создан: 2.12.2010 - Shestakov Dmitry
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
class (T129PartCalculateController) T129Part1CalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)

    /**
     * @param     attributes
     */
    macro getCalculateBills(attributes : RcbArray)
        // Спецификация:
        //     Получить пользовательские данные
        var dataSource = m_dataSources.getDataSource("USER");

        var lines = RcbArray().initialize("1", "1.1", "1.2", "1.3", "1.4", "2", "3", "4", "5", "6");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                      RcbArray().initialize(  dataSource.getFilter().isInPart(m_partId)
                                                            + dataSource.getFilter().isInLine(lines)
                                                            + dataSource.getFilter().isInColumn("8-9"),
                                                            lines,
                                                            m_report.getPart(m_partId).getAttributeName() + ". Размещенные векселя",
                                                            m_currencyCode)
                   )
               );
    end;

    /**
     * Выполнение расчета раздела формы.
     */
    macro execute()
        execute();

        m_part.addAttribute("1",     "8");
        m_part.addAttribute("1",     "9");
        m_reportCalculateController.addCalculationAttributeData(
            getCalculateBills(
                RcbArray().initialize(
                    m_part.getAttribute("6",   "8"), m_part.getAttribute("6",     "9"),
                    m_part.getAttribute("5",   "8"), m_part.getAttribute("5",     "9"),
                    m_part.getAttribute("4",   "8"), m_part.getAttribute("4",     "9"),
                    m_part.getAttribute("3",   "8"), m_part.getAttribute("3",     "9"),
                    m_part.getAttribute("2",   "8"), m_part.getAttribute("2",     "9"),
                    m_part.getAttribute("1.4", "8"), m_part.getAttribute("1.4",   "9"),
                    m_part.getAttribute("1.3", "8"), m_part.getAttribute("1.3",   "9"),
                    m_part.getAttribute("1.2", "8"), m_part.getAttribute("1.2",   "9"),
                    m_part.getAttribute("1.1", "8"), m_part.getAttribute("1.1",   "9")
                )
            )
        );
        m_part.addAttribute("Итого", "9");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.1", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.2", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.3", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("1.4", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6", "8"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));


        m_reportCalculateController.addCalculationAttributeData(getPercentSummaCalculateAttributeData(m_part.getAttribute("1",     "8"), RcbArray().initialize(CalculationKind().CK_BASIC, CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSummaCalculateAttributeData       (m_part.getAttribute("1",     "9"), RcbArray().initialize(CalculationKind().CK_BASIC)));
        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "9"), RcbArray().initialize(CalculationKind().CK_BASIC)));
    end;

    /**
     * Конструктор.
     *
     * @param     reportCalculateController    ссылка на контроллер расчета формы
     * @param     partId                       идентификатор раздела
     * @param     currencyCode                 валюта раздела
     */
    macro constructorT129Part1CalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
        initT129PartCalculateController(reportCalculateController, partId, currencyCode);
    end;

    constructorT129Part1CalculateController(reportCalculateController, partId, currencyCode);
end;

class (T129PartCalculateController4212) T129Part1CalculateController4212(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
    initT129PartCalculateController4212(reportCalculateController, partId, currencyCode);

    macro execute()
        execute();
    end;
end;

class (T129PartCalculateController4637) T129Part1CalculateController4637(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)

    /**
     * Выполнение расчета раздела формы.
     */
    macro execute()
        execute();

        m_part.addAttribute("1", "8", "0");
        m_part.addAttribute("1", "9", "0");
        m_part.addAttribute("Итого", "9", "0");

        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2.1", "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("2",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("3",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("4",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("5",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("6",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getWeightedAveragePercentSummableReports(m_part.getAttribute("7",   "8", "0"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));

        m_reportCalculateController.addCalculationAttributeData(getSummaItogCalculateAttributeData   (m_part.getAttribute("Итого", "9", "0"), RcbArray().initialize(CalculationKind().CK_BASIC)));

        //Получить пользовательские данные (только для печати в протокол)
        m_part.getUserInputPercentValue("8.1");
        m_dataSources.getDataSource("USER").getData(null,
                                                    RcbArray().initialize("8.1"),
                                                    m_report.getPart(m_partId).getAttributeName() + ". Справочная информация");
    end;

    /**
     * Конструктор.
     *
     * @param     reportCalculateController    ссылка на контроллер расчета формы
     * @param     partId                       идентификатор раздела
     * @param     currencyCode                 валюта раздела
     */
    macro constructorT129Part1CalculateController4637(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String, currencyCode : String)
        initT129PartCalculateController4637(reportCalculateController, partId, currencyCode);
    end;

    constructorT129Part1CalculateController4637(reportCalculateController, partId, currencyCode);
end;

class (RcbPartCalculateController) T129Part1InfCalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String)

    /**
     * @param     attributes
     */
    macro getCalculateAverageRates(attributes : RcbArray)
        // Спецификация:
        //     Получить пользовательские данные
        var dataSource = m_dataSources.getDataSource("INF");
        var lines = RcbArray().initialize("7.1", "7.2");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                     RcbArray().initialize(  dataSource.getFilter().isInPart(int(m_partId))
                                                           + dataSource.getFilter().isInLine(lines),
                                                           lines,
                                                           m_report.getPart(m_partId).getAttributeName() + ". Справочная информация")
                   )
               );
    end;

    /**
     * Получение сводных данных для атрибута, как среднеарифметическое по сводимым значениям.
     */
    macro getSimpleAveragePercentSummableReports(attribute, calculationKind)
        var dataSource = m_dataSources.getDataSource("SummableReports");

        return T129CalculationAttributeData(attribute, calculationKind).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getSimpleAveragePercentData"),
                                          RcbArray().initialize(attribute)));
    end;

    macro execute()
        var attributes = RcbArray().initialize(m_part.getAttribute("7.2"),
                                               m_part.getAttribute("7.1"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAverageRates(attributes));

        m_reportCalculateController.addCalculationAttributeData(getSimpleAveragePercentSummableReports(m_part.getAttribute("7.1"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
        m_reportCalculateController.addCalculationAttributeData(getSimpleAveragePercentSummableReports(m_part.getAttribute("7.2"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
    end;

    /**
     * Конструктор.
     *
     * @param     reportCalculateController    ссылка на контроллер расчета формы
     * @param     partId                       идентификатор раздела
     */
    macro constructorT129PartInfCalculateController(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
    end;

    constructorT129PartInfCalculateController(reportCalculateController, partId);
end;

class (T129Part1InfCalculateController) T129Part1InfCalculateController4212(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String)

    macro getCalculateAverageRates(attributes : RcbArray)
        // Спецификация:
        //     Получить пользовательские данные
        var dataSource = m_dataSources.getDataSource("INF");
        var lines = RcbArray().initialize("7.1");

        return T129CalculationAttributesGroupData(attributes).addCalculationData(
                   RcbCalculationData(r2m(dataSource, "getData"),
                                     RcbArray().initialize(  dataSource.getFilter().isInPart(int(m_partId))
                                                           + dataSource.getFilter().isInLine(lines),
                                                           lines,
                                                           m_report.getPart(m_partId).getAttributeName() + ". Справочная информация")
                   )
               );
    end;

    macro execute()
        var attributes = RcbArray().initialize(m_part.getAttribute("7.1"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAverageRates(attributes));

        m_reportCalculateController.addCalculationAttributeData(getSimpleAveragePercentSummableReports(m_part.getAttribute("7.1"), RcbArray().initialize(CalculationKind().CK_AFTER_SUMMARIZE)));
    end;

    macro constructorT129PartInfCalculateController4212(reportCalculateController : Object /*RcbReportCalculateController*/, partId : String)
        initT129Part1InfCalculateController(reportCalculateController, partId);
    end;

    constructorT129PartInfCalculateController4212(reportCalculateController, partId);
end;
