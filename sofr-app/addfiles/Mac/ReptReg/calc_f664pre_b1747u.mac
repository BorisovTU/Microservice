/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 664. Предварительные действия.

  Создан: 29.01.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import calc_f664_b1747u;
import print_f664_b1747u;

/**
 *  Запуск макроса вне контекста отчета
 */
private class (TException) TNullCurrentReportException()
    initTException("Макрос должен быть запущен в контексте отчета");
end;

/**
 *  Неверная форма
 */
private class (TException) TWrongFormException()
    initTException("Макрос может быть выполнен только в контексте отчета по форме 664");
end;

/**
 *  Макрос запущен в режиме свода
 */
private class (TException) TSummaryModeException()
    initTException("Макрос не может быть запущен для сводного отчета");
end;

/**
 *  Основная функция
 */
private macro main()

    private macro CheckReport()
        if (RcbApplication().currentReport == NULL)
            throw(TNullCurrentReportException());
        end;

        if (RcbApplication().currentReport.form.id != "Форма 664")
            throw(TWrongFormException());
        end;

        if (RcbApplication().currentReport.context.departmentCode == 0)
            throw(TSummaryModeException());
        end;
    end;

    TRestsTempTable().truncate();

    TTurnsTempTable().truncate();

    CheckReport();

    global();

end;

/**
 *  Точка входа
 */
main();
// 13.02.2007 ABP Пока нижеследущие строки закомментированы. А вообще от практики использования exit(1) нужно отказываться
//УстановитьФлагВозврата(OK_MACRO_FLAG);
//exit(1);

OnError(error)
    exceptionMessage(error);
    exit(1);
