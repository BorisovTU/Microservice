/*
$Name:          ex_kl128.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 128. Экспорт в клико
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Экспорт формы 128 в kliko.exe

   CREATED : 15.06.06 Luzgin

   MODIFICATIONS:
   NOTES:

└─────────────────────────────────────────────────────────────────────────- */

import logfile;
import log_lib;
import lib_exp;
import RcbCoreInter;
import lib_arr;
import rcbconst;
import rcbImport;
import Календарь;

/* ============================= Декларации =============================== */

/* ------------------------ Файлы, структуры, диалоги --------------------- */
/* -------------------------- Классы и переменные ------------------------- */

private const RUR_CODE = "810";
private const RUR_PART = 1;

private const USD_CODE = "840";
private const USD_PART = 2;

private const EUR_CODE = "978";
private const EUR_PART = 3;

private const KWD_DOP  = 4;         //раздел Дополнительные сведения

private const ЮЛ = "ЮЛ";
private const ФЛ = "ФЛ";
private const КО = "КО";
private const НФ = "НФ";

private var SrokShifr = TArray();
SrokShifr( 1) = "1__";
SrokShifr( 2) = "1_1";
SrokShifr( 3) = "1_2";
SrokShifr( 4) = "1_3";
SrokShifr( 5) = "1_4";
SrokShifr( 6) = "2__";
SrokShifr( 7) = "3__";
SrokShifr( 8) = "4__";
SrokShifr( 9) = "5__";
SrokShifr(10) = "6__";
SrokShifr(11) = "И__";
SrokShifr(12) = "71_";
SrokShifr(13) = "72_";

VAR ExpFileName, ИмяФайлаПротоколаЭксп = getNameLog(getExtendedPrefixForNameLogObject()+"e");
FILE wrk () txt write;      // Файл экспорта

class ExportController()

    VAR Counter;

    VAR SrokNumber = TArray();
        SrokNumber( 1 ) = "1";
        SrokNumber( 2 ) = "1.1";
        SrokNumber( 3 ) = "1.2";
        SrokNumber( 4 ) = "1.3";
        SrokNumber( 5 ) = "1.4";
        SrokNumber( 6 ) = "2";
        SrokNumber( 7 ) = "3";
        SrokNumber( 8 ) = "4";
        SrokNumber( 9 ) = "5";
        SrokNumber( 10 ) = "6";
        SrokNumber( 11 ) = "7";

    /* ========================= Вспомогательные функции ====================== */

    // Вывести отформатированную строку в файл экспорта
    private
    MACRO PrintExpString( arr )
        var str = "";
        var param, i = 0;
        while( i < arr.size )
            param = arr[i];
            if( ValType(param) != V_STRING )
                param = string( param:0:4 );
            end;
            param = StrSubst( param, "\"", "''" );
            str = str + ",\"" + param + "\"";
            i = i + 1;
        end;
        str = SubStr( str, 2 );
        if( insert( wrk, str ) )
            Counter = Counter + 1;
            return true;
        else
            return false;
        end;
    END;

    MACRO ExportLine( Part, Srok )

      macro GetVarName( Contragent, NameColumn )
        Var VarName =  "Ф128_";

        if  ( Part == RUR_PART ) VarName = VarName + "810_";
        elif( Part == USD_PART ) VarName = VarName + "840_";
        elif( Part == EUR_PART ) VarName = VarName + "978_";
        end;

        if  ( Contragent == ФЛ ) VarName = VarName + ФЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif( Contragent == ЮЛ ) VarName = VarName + ЮЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif( Contragent == КО ) VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_МК";
        end;

        return VarName;
      end;

      macro Variable( Contragent, NameColumn, prec )
        var val, valT;

        if( NameColumn == "%_" ) /* проценты */
          if( ПрочитатьПеременную2( val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn)) )
            val = valT * 100;
          end;
        else
          ПрочитатьПеременную( val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn));
        end;

        if( ValType( val ) == V_UNDEF )
            val = 0.0;
        end;
        if( prec == 0 )
            return string( val:0:0 );
        elif( prec == 1 )
            return string( val:0:1 );
        elif( prec == 3 )
            return string( val:0:3 );
        end;
      end;

      if  ( Srok == 2 ) /* до востребования */
        PrintExpString( ArrCreate(  SrokNumber(Srok),
            Variable( ФЛ, "%_", 3 ), "", Variable( ФЛ, "С_", 0 ),
            Variable( ЮЛ, "%_", 3 ), "", Variable( ЮЛ, "С_", 0 ),
            Variable( КО, "%_", 3 ), "", Variable( КО, "С_", 0 ) ) );
      elif( Srok == 11 ) /* итого */
        PrintExpString( ArrCreate(  SrokNumber(Srok),
            "" , "", Variable( ФЛ, "С_", 0 ),
            "" , "", Variable( ЮЛ, "С_", 0 ),
            "" , "", Variable( КО, "С_", 0 ) ) );
      else
        PrintExpString( ArrCreate(  SrokNumber(Srok),
            Variable( ФЛ, "%_", 3 ), Variable( ФЛ, "СР", 1 ), Variable( ФЛ, "С_", 0 ),
            Variable( ЮЛ, "%_", 3 ), Variable( ЮЛ, "СР", 1 ), Variable( ЮЛ, "С_", 0 ),
            Variable( КО, "%_", 3 ), Variable( КО, "СР", 1 ), Variable( КО, "С_", 0 ) ) );
      end;

    END;

    /* ================== Процедура экспорта ================================== */

    MACRO ExportPart( PartNumber )
      var Header, i;

        if( PartNumber == 1 )
            Header = "<F128C>";
        else
            Header = "<F128C/" + string( PartNumber ) + ">";
        end;
        insert( wrk, Header );

        i = 1;
        while( i <= 11 )
            ExportLine( PartNumber, i );
            i = i + 1;
        end;
    END;
end;

class (ExportController) ExportController_2332()
    initExportController();

    MACRO ExportLine( Part, Srok)

      macro GetVarName( Contragent, NameColumn, columnNumber )
        Var VarName =  "Ф128_";

        if  ( Part == RUR_PART ) VarName = VarName + "810_";
        elif( Part == USD_PART ) VarName = VarName + "840_";
        elif( Part == EUR_PART ) VarName = VarName + "978_";
        end;

        if  ( Contragent == ФЛ )
            VarName = VarName + ФЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif( Contragent == ЮЛ )
            VarName = VarName + ЮЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif(( Contragent == КО )and((columnNumber == 6)or(columnNumber == 7)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_МК";
        elif(( Contragent == КО )and((columnNumber == 10)or(columnNumber == 11)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_УВ";
        end;

        return VarName;
      end;

      macro Variable( Contragent, NameColumn, prec, columnNumber )
        var val, valT;

        if( NameColumn == "%_" ) /* проценты */
          if( ПрочитатьПеременную2( val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber)) )
            val = valT * 100;
          end;
        else
          ПрочитатьПеременную( val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber));
        end;

        if( ValType( val ) == V_UNDEF )
            val = 0.0;
        end;
        if( prec == 0 )
            return string( val:0:0 );
        elif( prec == 1 )
            return string( val:0:1 );
        elif( prec == 3 )
            return string( val:0:3 );
        end;
      end;

      if( Srok == 11 ) /* итого */
        if  ( Part == RUR_PART )
            PrintExpString( ArrCreate(  SrokNumber(Srok),
                "" , Variable( ФЛ, "С_", 0    ),
                "" , Variable( ЮЛ, "С_", 0    ),
                "" , Variable( КО, "С_", 0,  7),
                "" , Variable( НФ, "С_", 0    ),
                "" , Variable( КО, "С_", 0, 11)));
        else
            PrintExpString( ArrCreate(  SrokNumber(Srok),
                "" , Variable( ФЛ, "С_", 0    ),
                "" , Variable( ЮЛ, "С_", 0    ),
                "" , Variable( КО, "С_", 0,  7)));
        end;
      else
        if  ( Part == RUR_PART )
            PrintExpString( ArrCreate(  SrokNumber(Srok),
                Variable( ФЛ, "%_", 3    ), Variable( ФЛ, "С_", 0    ),
                Variable( ЮЛ, "%_", 3    ), Variable( ЮЛ, "С_", 0    ),
                Variable( КО, "%_", 3,  6), Variable( КО, "С_", 0,  7),
                Variable( НФ, "%_", 3    ), Variable( НФ, "С_", 0    ),
                Variable( КО, "%_", 3, 10), Variable( КО, "С_", 0, 11)));
        else
            PrintExpString( ArrCreate(  SrokNumber(Srok),
                Variable( ФЛ, "%_", 3    ), Variable( ФЛ, "С_", 0    ),
                Variable( ЮЛ, "%_", 3    ), Variable( ЮЛ, "С_", 0    ),
                Variable( КО, "%_", 3,  6), Variable( КО, "С_", 0,  7)));
        end;
      end;
    END;
end;

macro klikoExportF128()
    setoutput( ИмяФайлаПротоколаЭксп );
    println( "Дата и время начала выгрузки:", date, " ", time, " Протокол экспорта данных Формы 128 на" );
    println( ДатаОтчета );

    message( "Заполнение файлов экспорта" );
    var i = 1;
    var expController;
    while( i <= 3 )
        if (rcbApplication.currentReport.context.period.endDate < RCB_I2332_DATE)
            expController = ExportController();
        else
            expController = ExportController_2332();
        end;
        ExpFileName = "128_" + substr( string(ДатаОтчета:f), 1, 2 ) +
                substr( string(ДатаОтчета), 4, 2 ) +
                substr( string(ДатаОтчета), 7, 4 ) + "_" + string(i) + ".txt";

        if( not GetExpFileName( ExpFileName ) )
            exit(1);
        end;

        if( not open(wrk, ExpFileName ) )
            msgBox("Невозможно открыть файл экспорта|" + ExpFileName );
            exit(1);
        end;

        expController.Counter = 0;

        expController.ExportPart(i);

        close( wrk );
        println( "Файл: ...\TXTFILE\\", ExpFileName );
        println( "Выгружено записей: ", expController.Counter );

        i = i + 1;
    end;

    println( "Дата и время окончания выгрузки: ", date, " ", time );
    ViewFileLog( ИмяФайлаПротоколаЭксп );
end;

class (ExportController_2332) F128KlikoExporter()
    initExportController_2332();

    SrokNumber( 11 ) = "И";
    SrokNumber( 12 ) = "7";
    SrokNumber( 13 ) = "7.1";
    SrokNumber( 14 ) = "7.2";

    macro GetVarName( Contragent, NameColumn, columnNumber, part, srok)
        Var VarName =  "Ф128_";

        if  ( part == RUR_PART ) VarName = VarName + "810_";
        elif( part == USD_PART ) VarName = VarName + "840_";
        elif( part == EUR_PART ) VarName = VarName + "978_";
        end;

        if  ( Contragent == ФЛ )
            VarName = VarName + ФЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif( Contragent == ЮЛ )
            VarName = VarName + ЮЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif(( Contragent == КО )and((columnNumber == 6)or(columnNumber == 7)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_МК";
        elif(( Contragent == КО )and((columnNumber == 10)or(columnNumber == 11)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_УВ";
        end;

        return VarName;
    end;

    macro Variable(part, srok, Contragent, NameColumn, prec, columnNumber)
        var val, valT;

        if( NameColumn == "%_" ) /* проценты */
          if( ПрочитатьПеременную2( val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok)) )
            val = valT * 100;
          end;
        else
          ПрочитатьПеременную( val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok));
        end;

        if( ValType( val ) == V_UNDEF )
            val = 0.0;
        end;
        if( prec == 0 )
            return string( val:0:0 );
        elif( prec == 1 )
            return string( val:0:1 );
        elif( prec == 3 )
            return string( val:0:3 );
        end;
    end;

    macro getLine( Part, Srok)
        if (Srok == 11)
          if  ( Part == RUR_PART )
              return ArrCreate(  SrokNumber(Srok),
                  "" , Variable(part, srok, ФЛ, "С_", 0    ),
                  "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0,  7),
                  "" , Variable(part, srok, НФ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0, 11));
          else
              return ArrCreate(  SrokNumber(Srok),
                  "" , Variable(part, srok, ФЛ, "С_", 0    ),
                  "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0,  7));
          end;
        elif (srok > 12)
           if  ( Part == RUR_PART )
                   return ArrCreate(  SrokNumber(Srok),
                   "" , Variable(part, srok, ФЛ, "С_", 0    ),
                   "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                   "" , Variable(part, srok, КО, "С_", 0,  7),
                   "" , "",
                   "" , "");
           else
                   return ArrCreate(  SrokNumber(Srok),
                   "" , Variable(part, srok, ФЛ, "С_", 0    ),
                   "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                   "" , Variable(part, srok, КО, "С_", 0,  7));
           end;
        elif (Srok == 12)
          if  ( Part == RUR_PART )
              return ArrCreate("7","","","","","","","","","","")
          else
              return ArrCreate("7","","","","","","")
          end;
        else
          if  ( Part == RUR_PART )
              return ArrCreate(  SrokNumber(Srok),
                  Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                  Variable(part, srok, ЮЛ, "%_", 3    ), Variable(part, srok, ЮЛ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3,  6), Variable(part, srok, КО, "С_", 0,  7),
                  Variable(part, srok, НФ, "%_", 3    ), Variable(part, srok, НФ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3, 10), Variable(part, srok, КО, "С_", 0, 11));
          else
              return ArrCreate(  SrokNumber(Srok),
                  Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                  Variable(part, srok, ЮЛ, "%_", 3    ), Variable(part, srok, ЮЛ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3,  6), Variable(part, srok, КО, "С_", 0,  7));
          end;
      end;
    END;
end;

class (F128KlikoExporter) F128KlikoExporter2835()
    initF128KlikoExporter();

    SrokNumber( 11 ) = "И";
    SrokNumber( 12 ) = "7";
    SrokNumber( 13 ) = "7.1";
    SrokNumber( 14 ) = "7.2";
    SrokNumber( 15 ) = "7.3";

    macro GetVarName( Contragent, NameColumn, columnNumber, part, srok)
        Var VarName =  "Ф128_";

        if  ( part == RUR_PART ) VarName = VarName + "810_";
        elif( part == USD_PART ) VarName = VarName + "840_";
        elif( part == EUR_PART ) VarName = VarName + "978_";
        end;

        if  ( Contragent == ФЛ )
            VarName = VarName + ФЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif( Contragent == ЮЛ )
            VarName = VarName + ЮЛ + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_К_";
        elif(( Contragent == КО )and((columnNumber == 6)or(columnNumber == 7)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_МК";
        elif(( Contragent == КО )and((columnNumber == 10)or(columnNumber == 11)))
            VarName = VarName + КО + "_" + SrokShifr( Srok ) + "_" + NameColumn + "_УВ";
        end;

        return VarName;
    end;

    macro Variable(part, srok, Contragent, NameColumn, prec, columnNumber)
        var val, valT;

        if( NameColumn == "%_" ) /* проценты */
          if( ПрочитатьПеременную2( val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok)) )
            val = valT * 100;
          end;
        else
          ПрочитатьПеременную( val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok));
        end;

        if( ValType( val ) == V_UNDEF )
            val = 0.0;
        end;
        if( prec == 0 )
            return string( val:0:0 );
        elif( prec == 1 )
            return string( val:0:1 );
        elif( prec == 3 )
            return string( val:0:3 );
        end;
    end;

    macro getLine( Part, Srok)
        if (Srok == 15)                     /* note: строка 7.3 */
          if  ( Part == RUR_PART )
              return ArrCreate(  SrokNumber(Srok),
                  Variable(part, srok, ФЛ, "%_", 3, 0),
                  Variable(part, srok, ФЛ, "С_", 0, 0),
                  Variable(part, srok, ЮЛ, "%_", 3, 0),
                  Variable(part, srok, ЮЛ, "С_", 0, 0),
                  "", "", "", "", "", "");
          end;
        elif (Srok == 11)
          if  ( Part == RUR_PART )
              return ArrCreate(  SrokNumber(Srok),
                  "" , Variable(part, srok, ФЛ, "С_", 0    ),
                  "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0,  7),
                  "" , Variable(part, srok, НФ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0, 11));
          else
              return ArrCreate(  SrokNumber(Srok),
                  "" , Variable(part, srok, ФЛ, "С_", 0    ),
                  "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                  "" , Variable(part, srok, КО, "С_", 0,  7));
          end;
        elif (srok > 12)
           if  ( Part == RUR_PART )
                   return ArrCreate(  SrokNumber(Srok),
                   "" , Variable(part, srok, ФЛ, "С_", 0    ),
                   "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                   "" , Variable(part, srok, КО, "С_", 0,  7),
                   "" , "",
                   "" , "");
           else
                   return ArrCreate(  SrokNumber(Srok),
                   "" , Variable(part, srok, ФЛ, "С_", 0    ),
                   "" , Variable(part, srok, ЮЛ, "С_", 0    ),
                   "" , Variable(part, srok, КО, "С_", 0,  7));
           end;
        elif (Srok == 12)
          if  ( Part == RUR_PART )
              return ArrCreate("7","","","","","","","","","","")
          else
              return ArrCreate("7","","","","","","")
          end;
        else
          if  ( Part == RUR_PART )
              return ArrCreate(  SrokNumber(Srok),
                  Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                  Variable(part, srok, ЮЛ, "%_", 3    ), Variable(part, srok, ЮЛ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3,  6), Variable(part, srok, КО, "С_", 0,  7),
                  Variable(part, srok, НФ, "%_", 3    ), Variable(part, srok, НФ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3, 10), Variable(part, srok, КО, "С_", 0, 11));
          else
              return ArrCreate(  SrokNumber(Srok),
                  Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                  Variable(part, srok, ЮЛ, "%_", 3    ), Variable(part, srok, ЮЛ, "С_", 0    ),
                  Variable(part, srok, КО, "%_", 3,  6), Variable(part, srok, КО, "С_", 0,  7));
          end;
      end;
    end;
end;

class (F128KlikoExporter2835) F128KlikoExporter3006()
    initF128KlikoExporter2835();

    macro Variable(part, srok, Contragent, NameColumn, prec, columnNumber)
        var val, valT;

        if((NameColumn == "%_") or (NameColumn == "%П") or (NameColumn == "%А")) /* проценты */
          if( ПрочитатьПеременную2( val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok)) )
            val = valT * 100;
          end;
        else
          ПрочитатьПеременную( val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok));
        end;

        if( ValType( val ) == V_UNDEF )
            val = 0.0;
        end;
        if( prec == 0 )
            return string( val:0:0 );
        elif( prec == 1 )
            return string( val:0:1 );
        elif( prec == 3 )
            return string( val:0:3 );
        end;
    end;

    macro getLine( Part, Srok)
        if (Srok == 15)                     /* note: строка 7.3 */
            if  ( Part == RUR_PART )
                return ArrCreate(  SrokNumber(Srok),
                    Variable(part, srok, ФЛ, "%_", 3, 0),
                    Variable(part, srok, ФЛ, "С_", 0, 0),
                    "","",
                    Variable(part, srok, ЮЛ, "%_", 3, 0),
                    Variable(part, srok, ЮЛ, "С_", 0, 0),
                    "", "", "", "", "", "", "","");
            end;
        elif (Srok == 11)
            if  ( Part == RUR_PART )
                return ArrCreate(  SrokNumber(Srok),
                    "" , Variable(part, srok, ФЛ, "С_", 0    ),
                    "" , Variable(part, srok, ФЛ, "СА", 0    ),
                    "" , Variable(part, srok, ЮЛ, "С_", 0,  7),
                    "" , Variable(part, srok, ЮЛ, "СП", 0    ),
                    "" , Variable(part, srok, КО, "С_", 0, 11),
                    "" , Variable(part, srok, НФ, "С_", 0    ),
                    "" , Variable(part, srok, КО, "С_", 0    ));
            else
                return ArrCreate(  SrokNumber(Srok),
                    "" , Variable(part, srok, ФЛ, "С_", 0    ),
                    "" , Variable(part, srok, ФЛ, "СА", 0    ),
                    "" , Variable(part, srok, ЮЛ, "С_", 0,  7),
                    "" , Variable(part, srok, ЮЛ, "СП", 0    ),
                    "" , Variable(part, srok, КО, "С_", 0, 11));
            end;
        elif (srok > 12)
            if  ( Part == RUR_PART )
                    return ArrCreate(  SrokNumber(Srok),
                    "" , Variable(part, srok, ФЛ, "С_", 0    ),
                    "" , Variable(part, srok, ФЛ, "СА", 0    ),
                    "" , Variable(part, srok, ЮЛ, "С_", 0,  7),
                    "" , Variable(part, srok, ЮЛ, "СП", 0    ),
                    "" , Variable(part, srok, КО, "С_", 0, 11),
                    "" , "",
                    "" , "");
            else
                    return ArrCreate(  SrokNumber(Srok),
                    "" , Variable(part, srok, ФЛ, "С_", 0    ),
                    "" , Variable(part, srok, ФЛ, "СА", 0    ),
                    "" , Variable(part, srok, ЮЛ, "С_", 0,  7),
                    "" , Variable(part, srok, ЮЛ, "СП", 0    ),
                    "" , Variable(part, srok, КО, "С_", 0, 11));
            end;
        elif (Srok == 12)
            if  ( Part == RUR_PART )
                return ArrCreate("7","","","","","","","","","","","","","","")
            else
                return ArrCreate("7","","","","","","","","","","")
            end;
        else
            if  ( Part == RUR_PART )
                return ArrCreate(  SrokNumber(Srok),
                    Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                    Variable(part, srok, ФЛ, "%А", 3    ), Variable(part, srok, ФЛ, "СА", 0    ),
                    Variable(part, srok, ЮЛ, "%_", 3,  6), Variable(part, srok, ЮЛ, "С_", 0,  7),
                    Variable(part, srok, ЮЛ, "%П", 3    ), Variable(part, srok, ЮЛ, "СП", 0    ),
                    Variable(part, srok, КО, "%_", 3, 10), Variable(part, srok, КО, "С_", 0, 11),
                    Variable(part, srok, НФ, "%_", 3    ), Variable(part, srok, НФ, "С_", 0    ),
                    Variable(part, srok, КО, "%_", 3    ), Variable(part, srok, КО, "С_", 0    ));
            else
                return ArrCreate(  SrokNumber(Srok),
                    Variable(part, srok, ФЛ, "%_", 3    ), Variable(part, srok, ФЛ, "С_", 0    ),
                    Variable(part, srok, ФЛ, "%А", 3    ), Variable(part, srok, ФЛ, "СА", 0    ),
                    Variable(part, srok, ЮЛ, "%_", 3,  6), Variable(part, srok, ЮЛ, "С_", 0,  7),
                    Variable(part, srok, ЮЛ, "%П", 3    ), Variable(part, srok, ЮЛ, "СП", 0    ),
                    Variable(part, srok, КО, "%_", 3, 10), Variable(part, srok, КО, "С_", 0, 11));
            end;
        end;
    end;
end;

class (F128KlikoExporter3006) F128KlikoExporter4212()
    initF128KlikoExporter3006();

    macro Variable(part, srok, Contragent, NameColumn, prec, columnNumber)
        var val, valT;

        if ((NameColumn == "%_") or (NameColumn == "%П") or (NameColumn == "%А")) /* проценты */
            if (ПрочитатьПеременную2(val, valT, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok)))
                val = valT * 100;
            end;
        else
            ПрочитатьПеременную(val, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(Contragent, NameColumn, columnNumber, part, srok));
        end;

        if (ValType(val) == V_UNDEF)
            val = 0.0;
        end;

        if   (prec == 0)
            return string(val:0:0);
        elif (prec == 1)
            return string(val:0:1);
        elif (prec == 3)
            return string(val:0:3);
        end;
    end;

    macro getLine( Part, Srok)
        if (Srok == 15)                     /* note: строка 7.3 */
            if  ( Part == RUR_PART )
                return ArrCreate(  SrokNumber(Srok),
                    Variable(part, srok, ФЛ, "%_", 3, 0),
                    Variable(part, srok, ФЛ, "С_", 0, 0),
                    "","",
                    Variable(part, srok, ЮЛ, "%_", 3, 0),
                    Variable(part, srok, ЮЛ, "С_", 0, 0),
                    "", "");
            end;
        elif (Srok == 11)
            return ArrCreate(  SrokNumber(Srok),
                "" , Variable(part, srok, ФЛ, "С_", 0   ),
                "" , Variable(part, srok, ФЛ, "СА", 0   ),
                "" , Variable(part, srok, ЮЛ, "С_", 0, 7),
                "" , Variable(part, srok, ЮЛ, "СП", 0   ));
        elif (srok > 12)
                return ArrCreate(  SrokNumber(Srok),
                "" , Variable(part, srok, ФЛ, "С_", 0   ),
                "" , Variable(part, srok, ФЛ, "СА", 0   ),
                "" , Variable(part, srok, ЮЛ, "С_", 0, 7),
                "" , Variable(part, srok, ЮЛ, "СП", 0   ));
        elif (Srok == 12)
            return ArrCreate("7","","","","","","","","")
        else
            return ArrCreate(  SrokNumber(Srok),
                Variable(part, srok, ФЛ, "%_", 3   ), Variable(part, srok, ФЛ, "С_", 0   ),
                Variable(part, srok, ФЛ, "%А", 3   ), Variable(part, srok, ФЛ, "СА", 0   ),
                Variable(part, srok, ЮЛ, "%_", 3, 6), Variable(part, srok, ЮЛ, "С_", 0, 7),
                Variable(part, srok, ЮЛ, "%П", 3   ), Variable(part, srok, ЮЛ, "СП", 0   ));
        end;
    end;
end;

class (RcbKlikoExportController) F128KlikoExportController(part : integer)
    var m_part     = part;
    var fileExt    = "128C";
    var m_partName = "F128C";

    if (part != 1)
        fileExt = fileExt + part;
        m_partName = m_partName + "/" + part;
    end;

    initRcbKlikoExportController(fileExt, RcbReportBase(null, true), null);

    macro printDataZone()
        var i = 1;
        var klikoExp = F128KlikoExporter();
        var sizeSrokShifr = 0;
        m_view.printHead(m_partName);
        while (i < 15)
            m_view.printRow(klikoExp.getLine(m_part, i));
            i = i + 1;
        end;
    end;

    macro execute(appendprotocol, showprotocol)
    // appendprotocol - если true дополняет старый протол, в противном случае создаёт новый
    // showprotocol - если true показывает протокол
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe", m_reportName);

        protocolView.setProtocolOutput( appendprotocol );
        if (appendprotocol == true)
            protocolView.printLine(" ");
        end;
        protocolView.printHead();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String(m_view.getHeadsCount() + m_view.getRowsCount()) + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: " + m_view.getHeadsCount());
        protocolView.printLine("    количество содержательных строк:" + m_view.getRowsCount());

        protocolView.resetProtocolOutput();

        if( showprotocol )
            protocolView.show();
        end;
    end;
end;

class (F128KlikoExportController) F128KlikoExportController2835(part : integer)
    initF128KlikoExportController(part);

    macro printDataZone()
        var i = 1;
        var klikoExp = F128KlikoExporter2835();
        var sizeSrokShifr = 0;
        m_view.printHead(m_partName);
        if (m_part == 1)    /* note: выводим строку 7.3 только для первого раздела */
            sizeSrokShifr = srokShifr.size;
        else
            sizeSrokShifr = srokShifr.size - 1;
        end;
        while (i < sizeSrokShifr)
            m_view.printRow(klikoExp.getLine(m_part, i));
            i = i + 1;
        end;
    end;
end;

class (F128KlikoExportController) F128KlikoExportController3006(part : integer)
    initF128KlikoExportController(part);

    private macro getDescriptorInfo()
        return "f128_16.pak от 20.09.2013"
    end;

    macro printDataZone()
        var i = 1;
        var klikoExp = F128KlikoExporter3006();
        var sizeSrokShifr = 0;
        m_view.printHead(m_partName);
        if (m_part == 1)    /* note: выводим строку 7.3 только для первого раздела */
            sizeSrokShifr = srokShifr.size;
        else
            sizeSrokShifr = srokShifr.size - 1;
        end;
        while (i < sizeSrokShifr)
            m_view.printRow(klikoExp.getLine(m_part, i));
            i = i + 1;
        end;
    end;
end;

class TPart(code : Integer, name : String)
    var m_code = code;
    var m_name = name;
end;

class (RcbKlikoExportController) F128KlikoExportController4212(parts : RcbArray)
    var m_fileExt;
    var m_endDate;
    var m_departmentCode;
    var m_isCalendarWeekends;
    var m_parts;

    private macro getDescriptorInfo()
        return "f128_25.pak от 01.02.2017"
    end;

    //значение поля "Ставка" справочника "Ключевые ставки ЦБ"
    private macro getCbKeyRate(day : Date)
        var sqlStr = "SELECT rates.t_rate                "
            + "\n" + "  FROM dCbKeyRate_dbt rates        "
            + "\n" + " WHERE rates.t_dateFrom =          "
            + "\n" + "       (SELECT max (r.t_dateFrom)  "
            + "\n" + "          FROM dCbKeyRate_dbt r    "
            + "\n" + "         WHERE r.t_dateFrom <=" + getSqlDate(day) + ")";
        var ds = TRsbDataSet(sqlStr);

        if (ds.moveNext())
            return String(ds.rate:0:2);
        end;

        return "0.00";
    end;

    //ставка налогооблагаемой базы для средств в иностранной валюте
    private macro getTaxableBaseRate(day : Date)
        return String((RcbFactor("Ставка налогооблагаемой базы для средств в иностранной валюте").getValue(day).max):0:2);
    end;

    private macro isWorkDate(day : Date) : Bool
        var serviceKind;
        var isBalance = false;
        var res;

        if (m_isCalendarWeekends == true)
            return isWorkDayBranch(day, m_departmentCode) == 1;
        else
            res = getDateAttr(day, serviceKind, isBalance, m_departmentCode);
            return isBalance;
        end;
    end;

    //Дата последнего Рабочего дня в отчетном периоде
    private macro getNearPreviosWorkDay(day : Date)
        var previosWorkDay = day;

        while (not isWorkDate(previosWorkDay))
            previosWorkDay = previosWorkDay - 1;
        end;

        return previosWorkDay;
    end;

    macro printDataZone(part : TPart)
        var i             = 1;
        var klikoExp      = F128KlikoExporter4212();
        var sizeSrokShifr = 0;

        m_view.printHead(part.m_name);

        if (part.m_code != KWD_DOP)
            if (part.m_code == RUR_PART)    /* note: выводим строку 7.3 только для первого раздела */
                sizeSrokShifr = srokShifr.size;
            else
                sizeSrokShifr = srokShifr.size - 1;
            end;

            while (i < sizeSrokShifr)
                m_view.printRow(klikoExp.getLine(part.m_code, i));
                i = i + 1;
            end;
        else
            //печать раздела "Дополнительные сведения"
            m_view.printRow(ArrCreate(getCbKeyRate(m_endDate),       ""));
            m_view.printRow(ArrCreate(getTaxableBaseRate(m_endDate), ""));
            m_view.printRow(ArrCreate("",                            String(getNearPreviosWorkDay(m_endDate):f)));
        end;
    end;

    macro execute()
        m_view.setoutputFile();

        //выводим все заданные разделы
        m_parts.moveFirst();
        while (m_parts.moveNext())
            printDataZone(m_parts.getCurrentItem());
        end;

        m_view.resetoutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe", m_reportName);

        protocolView.setProtocolOutput(/*appendprotocol*/);

        protocolView.printHead();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: "  + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: "                    + String(m_view.getHeadsCount() + m_view.getRowsCount()) + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: "     + m_view.getHeadsCount());
        protocolView.printLine("    количество содержательных строк:" + m_view.getRowsCount());

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;

    private macro constructor(parts : RcbArray)
        m_endDate        = RcbApplication.currentReport.context.period.endDate;
        m_departmentCode = RcbApplication.currentReport.context.departmentCode;
        m_fileExt        = "128C";
        m_parts          = parts;
        getRegistryValue("REPTREG/REP_GROUPS/ФОР/ВЫХОДН. И РАБ. ДНИ ПО КАЛЕНДАРЮ", V_BOOL, m_isCalendarWeekends, NULL);

        initRcbKlikoExportController(m_fileExt, RcbReportBase(null, true), null);
    end;

    constructor(parts);
end;

macro klikoExportF128_2539()
    SrokShifr(12) = "7";
    SrokShifr(13) = "71_";
    SrokShifr(14) = "72_";

    F128KlikoExportController(RUR_PART).execute();
    F128KlikoExportController(USD_PART).execute( true );
    F128KlikoExportController(EUR_PART).execute( true ,true );
end;

macro klikoExportF128_2835()
    SrokShifr(12) = "7";
    SrokShifr(13) = "71_";
    SrokShifr(14) = "72_";
    SrokShifr(15) = "73_";

    F128KlikoExportController2835(RUR_PART).execute();
    F128KlikoExportController2835(USD_PART).execute( true );
    F128KlikoExportController2835(EUR_PART).execute( true ,true );
end;

macro klikoExportF128_3006()
    SrokShifr(12) = "7";
    SrokShifr(13) = "71_";
    SrokShifr(14) = "72_";
    SrokShifr(15) = "73_";

    F128KlikoExportController3006(RUR_PART).execute();
    F128KlikoExportController3006(USD_PART).execute( true );
    F128KlikoExportController3006(EUR_PART).execute( true ,true );
end;

macro klikoExportF128_4212()
    SrokShifr(12) = "7";
    SrokShifr(13) = "71_";
    SrokShifr(14) = "72_";
    SrokShifr(15) = "73_";

    F128KlikoExportController4212(RcbArray().initialize(TPart(RUR_PART, "F128C"),
                                                        TPart(USD_PART, "F128C/2"),
                                                        TPart(EUR_PART, "F128C/3"),
                                                        TPart(KWD_DOP,  "KWD_DOP"))).execute();
end;

/*═════════════════════════╗
║ Точка входа в программу  ║
╚═════════════════════════*/
if (not rcbApplication().currentReport.isCalculated)
    TProtocolView("ПРОТОКОЛ ЭКСПОРТА В Kliko.exe").checkCalculateReport("kliko.exe");
    установитьФлагВозврата(STOP_PROC_FLG);
    exit(1);
end;

if   (rcbApplication.currentReport.context.period.endDate >= RCB_I4212_DATE)
    klikoExportF128_4212();
ELif (rcbApplication.currentReport.context.period.endDate >= RCB_I3006_DATE2)
    klikoExportF128_3006();
elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2835_DATE4)
    klikoExportF128_2835();
elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2539_DATE)
    klikoExportF128_2539();
else
    klikoExportF128();
end;

УстановитьФлагВозврата( OK_MACRO_FLAG );
exit(1);
