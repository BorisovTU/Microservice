/*
$Name:          c_f501.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 501. Расчет
*/

import testlib;

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 501.

  Создан: 13.10.2006 - Ser.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/*
 *  Общебанковские интеры и модули
 */
import balanceInter;
import rsbDataSet;

import cb_sql;
import lib_lang;

import param;/* 19.09.2007 Malakhova 110424*/

/*
 *  Интеры и модули подсистемы
 */
import rcbCoreInter;
import reptCBCommon;

import departmentFilter;
import acc_lib;
import rcbconst;
import RcbTuneTable;
import testLib;
import com_f501;
import RcbLibrary;
import AccNoteFor501;

PRIVATE MACRO CheckCategoryForAccount(AccountId, CatName)
    var query =   "SELECT 1                                     "
                + "  FROM daccount_dbt  acc,                    "
                + "       dmcaccdoc_dbt mcacc,                  "
                + "       dmccateg_dbt  cat                     "
                + " WHERE CAT.T_CODE       = " + getSqlString(CatName)
                + "   AND ACC.T_ACCOUNTID  = " + AccountId
                + "   AND MCACC.T_ACCOUNT  = ACC.T_ACCOUNT      "
                + "   AND MCACC.T_CURRENCY = ACC.T_CODE_CURRENCY"
                + "   AND MCACC.T_CHAPTER  = ACC.T_CHAPTER      "
                + "   AND MCACC.T_CATID    = CAT.T_ID           ";

    var dataSet = TRsbDataSet( query );
    if( dataSet.moveNext() )
        return true;
    end;

    return false;
END;

/***************************************************************************************************
 *  Константы
 **************************************************************************************************/
private const CHAPTER_LEVEL = 0;
private const BALANCE_LEVEL = 1;
private const ACCOUNT_LEVEL = 2;

/*константы для индексов массива масок лицевых счетов*/
const PART_1 = 0; /*1 раздел отчета*/
const PART_2 = 1; /*2 раздел отчета*/
const TYPE_1 = 0; /*тип счета (депозит/кредит)*/
var   type_2 = 1; /*тип счета (корреспондентский), переменная для того чтобы можно было не учитывать корр. счета*/

private const PART_1_CODE = "1";
private const PART_2_CODE = "2";
private const TYPE_1_CODE = "Депозит/кредит";
private const TYPE_2_CODE = "Корреспондентский";

const SQL_PART_1_CODE = GetSqlString(PART_1_CODE);
const SQL_PART_2_CODE = GetSqlString(PART_2_CODE);
const SQL_TYPE_1_CODE = GetSqlString(TYPE_1_CODE);
const SQL_TYPE_2_CODE = GetSqlString(TYPE_2_CODE);

/***************************************************************************************************
 *  Глобальные переменные
 **************************************************************************************************/

private class TGlobal()
    /*
     *  Перменная хранит ссылку на балансовый отчет за текуцщий период.
     *  Используется для процедуры нормализации.
     */
    var balanceReport = NULL;

    macro initializeRepDataPackage(beginDate, endDate)
        sql_truncate("drepdepartment_tmp");

        sql_execute("CALL rep_data.setBalancePlanNumber(" + rcbApplication.parameters.balancePlanNumber + ")");

        sql_execute("CALL rep_data.setBeginDate(" + beginDate + ")");
        sql_execute("CALL rep_data.setEndDate("   + endDate   + ")");

        sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(rcbDepartmentList.getAsSqlSetFilial()) + ", "
                                                       + getSqlString(rcbDepartmentList.getAsSqlSetVsp()) + ")");
        sql_execute("CALL rep_data.initCorrectDocumentParameters(1,"+ beginDate + ","+ endDate +")");

        sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+ beginDate +", 'DD.MM.YYYY')))");

        sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+ endDate +", 'DD.MM.YYYY')))");
    end;
end;

private var global = TGlobal();

/***************************************************************************************************
 *  Блок обработки ошибок
 **************************************************************************************************/

/* Базовый класс исключений */
private class TError(errorMessage : String)
    private var m_errorMessage : String = errorMessage;

    macro What()
        return m_errorMessage;
    end;
end;

/* Запуск макроса вне контекста отчета */
private class (TError) TNullCurrentReportError()
    InitTError("Макрос должен быть запущен в контексте отчета");
end;

/* Неверная форма */
private class (TError) TWrongFormError()
    InitTError("Макрос может быть выполнен только в контексте отчета по форме 501");
end;

/* Неверные единицы измерения отччета */
private class (TError) TWrongDimensionError()
    InitTError("Неверная размерность отчета");
end;

/* Функция-генератор исключений */
private macro Throw(error : TError)
    RunError(error.What(), error);
end;

/***************************************************************************************************
 *  Параметры отчета
 **************************************************************************************************/
class TParameters()
    var m_irReducibleRest  = false;
    var m_SortBalance      = false;
    var m_SortClient       = "";
    var m_isMmData         = false;
    var step               = "";
    var m_isSecuritiesData = false;

    private macro Constructor()
        step = cmdargs();
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\НЕСНИЖАЕМЫЙ ОСТАТОК",       V_BOOL,    m_irReducibleRest,  NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО БАЛАНСОВЫМ", V_BOOL,    m_SortBalance,      NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО КЛИЕНТАМ",   V_INTEGER, m_SortClient,       NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК",                V_BOOL,    m_isMmData,         NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ SECURITIES",         V_BOOL,    m_isSecuritiesData, NULL);
    end;

    Constructor();
end;

class (TParameters) TParameters_5586()
    var m_isExcludeDiscountByPpt = false;     //ИСКЛЮЧИТЬ ДИСКОНТ ПО ППТ
    var m_isExcludeBonusByPpt    = false;     //ИСКЛЮЧИТЬ ПРЕМИЮ ПО ППТ

    private macro Constructor()
        step = cmdargs();
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\НЕСНИЖАЕМЫЙ ОСТАТОК",       V_BOOL,    m_irReducibleRest,        NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО БАЛАНСОВЫМ", V_BOOL,    m_SortBalance,            NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\СОРТИРОВКА\\ПО КЛИЕНТАМ",   V_INTEGER, m_SortClient,             NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК",                V_BOOL,    m_isMmData,               NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ SECURITIES",         V_BOOL,    m_isSecuritiesData,       NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ИСКЛЮЧИТЬ ДИСКОНТ ПО ППТ",  V_BOOL,    m_isExcludeDiscountByPpt, NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 501\\ИСКЛЮЧИТЬ ПРЕМИЮ ПО ППТ",   V_BOOL,    m_isExcludeBonusByPpt,    NULL);
    end;

    Constructor();
end;

/***************************************************************************************************
 *  Класс настроечной таблицы
 **************************************************************************************************/
class (RcbTuneTable) TF501TuneTable(name : String, instructionDate : Date)
    private macro constructorTF501TuneTable(name : String, instructionDate : Date)
        initRcbTuneTable(name);
        setInstructionFilter(instructionDate);
    end;

    constructorTF501TuneTable(name, instructionDate);
end;

/***************************************************************************************************
 *  Контроллеры расчета
 **************************************************************************************************/
/* Базовый класс "Расчета" */
private class TCalculator(report : RcbReport)

    private var m_report = report;
    private var m_MaskArray = TArray();
    private var m_BalanceList =  "32001, 32010, 32101, 32110, 32201, 32301, 31301, 31310, 31401, 31410, 31501, 31601";
    private var m_BalanceArray = TArray();
                m_BalanceArray[0]  = "32001";
                m_BalanceArray[1]  = "32010";
                m_BalanceArray[2]  = "32101";
                m_BalanceArray[3]  = "32110";
                m_BalanceArray[4]  = "32201";
                m_BalanceArray[5]  = "32301";
                m_BalanceArray[6]  = "31301";
                m_BalanceArray[7]  = "31310";
                m_BalanceArray[8]  = "31401";
                m_BalanceArray[9]  = "31410";
                m_BalanceArray[10] = "31501";
                m_BalanceArray[11] = "31601";

    private const SQL_BEGIN_DATE = getSqlDate(m_report.context.period.beginDate);
    private const SQL_END_DATE   = getSqlDate(m_report.context.period.endDate);
    private const SQL_ZERO_DATE  = getSqlDate(Date(0, 0, 0));

    private var m_tuneTable = RcbTuneTable("dt501_dbt");
    m_tuneTable.setInstructionFilter(m_report.context.period.endDate);

    private macro AnalyzeTurnTable()
        var dataSet;
        m_MaskArray[PART_1] = TArray();
        m_MaskArray[PART_2] = TArray();

        if (TParameters().m_irReducibleRest)
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][type_2] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][type_2] = dataSet.t_AccountMasks;
        else
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_1][type_2] = "";

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_2][type_2] = "";
        end;
    end;

    macro removeVariables()
        private macro RemoveCompositValues(name:string)

            var iterator = m_report.AttributeValue(name).CreateValueIterator();
            var idList = TArray();
            var i;

            i = 0;
            iterator.moveFirst();
            while(not iterator.isDone())
                if( iterator.currentItem.valueId != 0 )
                    idList(i) = iterator.currentItem.valueId;
                    i = i + 1;
                end;
                iterator.moveNext();
            end;

            i = 0;
            while(i < idList.size())
                m_report.AttributeValue(name).removeValue(idList(i));
                i = i + 1;
            end;
        end;
        RemoveCompositValues("Ф501_1");
        RemoveCompositValues("Ф501_2");
        RcbApplication().transactionManager.Commit();
    end;

    private macro isOnDemandBalanceAccount(balance)
        var i = 0;
        while (i < m_BalanceArray.size)
            if (m_BalanceArray[i] == balance)
                return true;
            end;
            i = i + 1;
        end;

        return false;
    end;

    macro SaveVariables( parameters:TParameters)

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();

                CompositeValue.fieldValue("ПризнакРЕПО").exact = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакИП").exact   = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact     = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact     = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact  = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact    = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact    = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact    = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact   = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact   = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact  = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact  = dataSet.EndRest;
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
    end;

    private macro InBalanceArray( balance )
        var i =0;
        while( i < m_BalanceArray.size )
            if( m_BalanceArray[i] == balance )
                return TRUE;
            end;
            i = i + 1;
        end;
        return FALSE;
    end;

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account      account,"
                   + "\n" + "       acc.t_accountId    accountId,"
                   + "\n" + "       acc.t_fiid         fiid,"
                   + "\n" + "       acc.t_kind         kindAccount,"
                   + "\n" + "       acc.t_chapter      chapter,"
                   + "\n" + "       acc.t_balance      balance,"
                   + "\n" + "       prt.t_id           partyId,"
                   + "\n" + "       prt.t_name         name,"
                   + "\n" + "       prt.t_isResident   isResident,"
                   + "\n" + "       prt.t_countryCode  nrCountry,"
                   + "\n" + "       acc.t_inCoverRest BegRest,"
                   + "\n" + "       acc.t_outCoverRest EndRest,"
                   + "\n" + "       COALESCE((SELECT sum(doc.t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_debetaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Debet,"
                   + "\n" + "       COALESCE((SELECT sum(t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_creditaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Credit,"
                   + "\n" + "       acc.t_objectId objectId, "
                   + "\n" + "       acc.t_part part, "
                   + "\n" + "       acc.t_typeAccount typeAccount, "
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd operationEndDate, "
                   + "\n" + "       rep_data.isExistsCorrectionalDocument() isexistcorrect,"
                   + "\n" + "       CASE"
                   + "\n" + "            WHEN prt.t_isresident = 1 "
                   + "\n" + "            THEN"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN reppartycodes.t_code like '%/%'"
                   + "\n" + "                    THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/')-1)"
                   + "\n" + "                    ELSE COALESCE(reppartycodes.t_code, CHR(1))"
                   + "\n" + "                END"
                   + "\n" + "            ELSE"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN prt.t_isswift = 1"
                   + "\n" + "                    THEN COALESCE(reppartycodes.t_code, 'НР')"
                   + "\n" + "                    ELSE 'НР'"
                   + "\n" + "            END"
                   + "\n" + "       END AS regNumber"
                   + "\n" + "  FROM accountTable  acc,"//Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
                   + "\n" + "       drepparty_vw    prt,"
                   + "\n" + "       (SELECT *"
                   + "\n" + "          FROM dreppartycodes_vw partyсode,"
                   + "\n" + "               drepparty_vw      repparty_"
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId"
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                   + "\n" + "           AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'"
                   + "\n" + "               OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = COALESCE(DECODE(acc.t_partyId, "
                   + "\n" + "                         " + {OurBank} + ", "
                   + "\n" + "                             acc.t_contragentId),"
                   + "\n" + "                             acc.t_partyId)"
                   + "\n" + "   AND prt.t_id  = reppartycodes.t_partyid (+)";
        return QueryForData;
    end;

    private macro getQueryForCategory()
        var queryForCategory =         "SELECT atc.t_object"
                      + "\n" + "          FROM dobjattr_dbt  att,"
                      + "\n" + "               dobjatcor_dbt atc"
                      + "\n" + "         WHERE atc.t_attrId      = att.t_attrId"
                      + "\n" + "           AND atc.t_objectType  = att.t_objectType"
                      + "\n" + "           AND atc.t_groupId     = att.t_groupId"
                      + "\n" + "           AND att.t_numinlist = 'РЕПО'"
                      + "\n" + "           AND " + SQL_END_DATE + " BETWEEN atc.t_validFromDate AND atc.t_validToDate";
        return queryForCategory;
    end;

    private macro addRelationsQuery()
        var query;

        if (rcbApplication().currentReport().context.period.EndDate < RCB_I2121_DATE)

            query = "  FROM ("+ getQueryForData() + ")";

         else
            query =          ","
             + "\n" + "       CASE"
             + "\n" + "           WHEN (objectId = category.t_object)"
             + "\n" + "               THEN 1"
             + "\n" + "           ELSE 0"
             + "\n" + "       END isRepoAccount"
             + "\n" + "  FROM ("+ getQueryForData() + "), ("+ getQueryForCategory() + ") category"
             + "\n" + " WHERE objectId = category.t_object(+)";
         end;
         return query;
    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN COALESCE((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       COALESCE(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                2 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_2_CODE
             + "\n" + "                            AND (" + ternary(TParameters().m_irReducibleRest,ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_2], "acc.t_account"),"0=1") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                2 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_2_CODE
             + "\n" + "                            AND (" + ternary(TParameters().m_irReducibleRest,ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_2], "acc.t_account"),"0=1") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro FillTempTable()
        SQL_Truncate("DF501_TMP");

        var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);

        var dataSet = TRsbDataSet(getQuery());

        while ( dataSet.Next() )
            message(dataSet.PartyID);

            temp501.AddNew();

            if (rcbApplication().currentReport().context.period.EndDate >= RCB_I2121_DATE)
                temp501.IsRepoAccount = dataSet.isRepoAccount;
            end;
            temp501.Account = dataSet.account;
            temp501.AccountId = dataSet.accId;
            temp501.Balance = dataSet.bal;
            temp501.PrintedAccount = dataSet.prAcc;
            temp501.ClientName = dataSet.name;
            temp501.RegNumber = dataSet.regNumber;
            temp501.CountryCode = dataSet.countryCode;
            temp501.ClientCode = dataSet.partyID;
            temp501.PartReport = dataSet.part;
            temp501.KindAccount = dataSet.kindAccount;
            temp501.TypeAccount = dataSet.typeAccount;
            temp501.PerfomanceDate = NVL(dataSet.perfomanceDate, date(0,0,0));
            // 272109
            if ( CheckCategoryForAccount(dataSet.accId, "-МС") OR CheckCategoryForAccount(dataSet.accId, "+МС") )
                temp501.Rate = IIF(dataSet.rate < 0, 0, dataSet.rate);
            else
                temp501.Rate = dataSet.rate;
            end;
            temp501.BeginRest = dataSet.BegRest;
            temp501.EndRest   = dataSet.EndRest;
            temp501.Debet     = dataSet.Debet;
            temp501.Credit    = dataSet.Credit;
            temp501.isexistcorrect = dataSet.isexistcorrect;

            temp501.BeginRestTh = RCB_FloorTerm( temp501.BeginRest );
            temp501.EndRestTh   = RCB_FloorTerm( temp501.EndRest   );
            temp501.DebetTh     = RCB_FloorTerm( temp501.Debet     );
            temp501.CreditTh    = RCB_FloorTerm( temp501.Credit    );

            temp501.update();
        end;
    end;
end;

private class (TCalculator) TCalculator_2332(report : RcbReport)
    initTCalculator(report);

    private macro AnalyzeTurnTable()
        var dataSet;
        m_MaskArray[PART_1] = TArray();
        m_MaskArray[PART_2] = TArray();

        dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
        dataSet.Next();
        m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

        dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
        dataSet.Next();
        m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN COALESCE((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       COALESCE(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro SaveVariables( parameters:TParameters)
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
            profiler.clear();
            profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();

                CompositeValue.fieldValue("ПризнакРЕПО").exact = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact   = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакИП").exact   = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact     = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact     = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact  = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact    = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact    = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact    = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact   = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact   = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact  = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact  = dataSet.EndRest;
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =      "SELECT                                                        "
                + "\n" +     "    data.t_id,                                                "
                + "\n" +     "    data.t_name,                                              "
                + "\n" +     "    data.t_shortName,                                         "
                + "\n" +     "    data.t_code,                                              "
                + "\n" +     "    data.t_countryCode,                                       "
                + "\n" +     "    CASE                                                      "
                + "\n" +     "        WHEN data.t_isResident = 1                            "
                + "\n" +     "        THEN                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN t_regNumber like '%/%'                   "
                + "\n" +     "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)"
                + "\n" +     "                ELSE COALESCE(t_regNumber, CHR(1))            "
                + "\n" +     "            END                                               "
                + "\n" +     "        ELSE                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN data.t_isswift = 1                       "
                + "\n" +     "                THEN COALESCE(t_regNumber, 'НР')              "
                + "\n" +     "                ELSE 'НР'                                     "
                + "\n" +     "            END                                               "
                + "\n" +     "    END AS t_regNumber                                        "
                + "\n" +     "FROM                                                          "
                + "\n" +     "   (SELECT                                                    "
                + "\n" +     "        party.t_id,                                           "
                + "\n" +     "        party.t_name,                                         "
                + "\n" +     "        party.t_shortName,                                    "
                + "\n" +     "        party.t_isResident,                                   "
                + "\n" +     "        party.t_isswift,                                      "
                + "\n" +     "        codes.t_code as t_code,                               "
                + "\n" +     "        codes.t_name as t_nameCode,                           "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN (party.t_isResident = 0)                     "
                + "\n" +     "                THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" +     "                ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
                + "\n" +     "        END t_countryCode,                                    "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                ELSE CHR(1)                                   "
                + "\n" +     "        END as t_regNumber                                    "
                + "\n" +     "    FROM                                                      "
                + "\n" +     "        dRepParty_vw      party,                              "
                + "\n" +     "        dRepPartyCodes_vw codes,                              "
                + "\n" +     "        dCountry_dbt      country                             "
                + "\n" +     "    WHERE                                                     "
                + "\n" +     "        party.t_id = (select                                  "
                + "\n" +     "                             codes.t_partyId                  "
                + "\n" +     "                        from                                  "
                + "\n" +     "                             dRepPartyCodes_vw codes          "
                + "\n" +     "                       where                                  "
                + "\n" +     "                             codes.t_code ='" + customerCode + "'"
                + "\n" +     "                             AND codes.t_name = 'Код') "
                + "\n" +     "        and codes.t_name = 'Код'                              "
                + "\n" +     "        and codes.t_partyId = party.t_id                      "
                + "\n" +     "        AND country.t_codeLat3 = party.t_countrycode          "
                + "\n" +     ") data                                                        ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current = NVL(dataSet.name, "");
                    compositeValue.currentItem.fieldValue("РегНом").current = NVL(dataSet.regNumber, "");
                    compositeValue.currentItem.fieldValue("КодСтр").current = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current  = NVL(dataSet.id, "");
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled;
                compositeValue.moveNext();
            end;

        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
        savePartForManualInput( 1, parameters );
        savePartForManualInput( 2, parameters );
    end;

    private macro getQueryForCategory()
        var queryForCategory =         "SELECT atc.t_object,"
                      + "\n" + "               CASE"
                      + "\n" + "                   WHEN  (att.t_numinlist = 'РЕПО')"
                      + "\n" + "                   THEN 1"
                      + "\n" + "                   ELSE 2"
                      + "\n" + "               END t_category"
                      + "\n" + "          FROM dobjattr_dbt  att,"
                      + "\n" + "               dobjatcor_dbt atc"
                      + "\n" + "         WHERE atc.t_attrId      = att.t_attrId"
                      + "\n" + "           AND atc.t_objectType  = att.t_objectType"
                      + "\n" + "           AND atc.t_groupId     = att.t_groupId"
                      + "\n" + "           AND ((att.t_numinlist = 'РЕПО') OR (att.t_numinlist    = 'ГД'))"
                      + "\n" + "           AND " + SQL_END_DATE + " BETWEEN atc.t_validFromDate AND atc.t_validToDate";
        return queryForCategory;
    end;

    private macro addRelationsQuery()
        var query;

        query =          ","
         + "\n" + "       CASE"
         + "\n" + "           WHEN ((objectId = category.t_object) AND (category.t_category = 1))"
         + "\n" + "               THEN 1"
         + "\n" + "           ELSE 0"
         + "\n" + "       END isRepoAccount,"
         + "\n" + "       CASE"
         + "\n" + "           WHEN ((objectId = category.t_object) AND (category.t_category = 2))"
         + "\n" + "               THEN 1"
         + "\n" + "           ELSE 0"
         + "\n" + "       END isGD"
         + "\n" + "  FROM ("+ getQueryForData() + "), (" + getQueryForCategory() + ") category"
         + "\n" + " WHERE objectId = category.t_object(+)";

        return query;
    end;

    macro FillTempTable()
        SQL_Truncate("DF501_TMP");

        var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);
        temp501.setFieldType("t_isGD",  V_INTEGER);

        var dataSet = TRsbDataSet(getQuery());

        while ( dataSet.Next() )
            message(dataSet.PartyID);

            temp501.AddNew();

            temp501.IsRepoAccount  = dataSet.isRepoAccount;
            temp501.Account        = dataSet.account;
            temp501.AccountId      = dataSet.accId;
            temp501.Balance        = dataSet.bal;
            temp501.PrintedAccount = dataSet.prAcc;
            temp501.ClientName     = dataSet.name;
            temp501.RegNumber      = dataSet.regNumber;
            temp501.CountryCode    = dataSet.countryCode;
            temp501.ClientCode     = dataSet.partyID;
            temp501.PartReport     = dataSet.part;
            temp501.KindAccount    = dataSet.kindAccount;
            temp501.TypeAccount    = dataSet.typeAccount;
            temp501.PerfomanceDate = NVL(dataSet.perfomanceDate, date(0,0,0));
            // 272109
            if (CheckCategoryForAccount(dataSet.accId, "-МС") OR CheckCategoryForAccount(dataSet.accId, "+МС"))
                temp501.Rate        = IIF(dataSet.rate < 0, 0, dataSet.rate);
            else
                temp501.Rate        = dataSet.rate;
            end;

            temp501.BeginRest      = dataSet.BegRest;
            temp501.EndRest        = dataSet.EndRest;
            temp501.Debet          = dataSet.Debet;
            temp501.Credit         = dataSet.Credit;
            temp501.isGD           = dataSet.isGD;

            temp501.BeginRestTh    = RCB_FloorTerm( temp501.BeginRest );
            temp501.EndRestTh      = RCB_FloorTerm( temp501.EndRest   );
            temp501.DebetTh        = RCB_FloorTerm( temp501.Debet     );
            temp501.CreditTh       = RCB_FloorTerm( temp501.Credit    );

            temp501.isexistcorrect = dataSet.isexistcorrect;

            temp501.update();
        end;
    end;
end;

private class (TCalculator_2332) TCalculator_3129(report : RcbReport)
    initTCalculator_2332(report);

    private macro getObjectCode(tableName : String, chapter : String, fiid : String, account : String) : String
        return   "(  TO_CHAR (" + tableName + "." + chapter + ", 'FM0x')"
        + "\n" + "|| TO_CHAR (" + tableName + "." + fiid    + ", 'FM0xxxxxx')"
        + "\n" + "||          " + tableName + "." + account + ")";
    end;

    private macro addRelationsQuery()
        var query;

        query =          ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 1,  'РЕПО',"        + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isRepoAccount,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 1,  'ГД',"          + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isGD,                                                                                                                                                                                                  "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                                             "
        + "\n" + "           ELSE 0                                                                                                                                                                                                 "
        + "\n" + "       END isThirdPerson,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN '*'                                                                                                                                                                                           "
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END singDepending,                                                                                                                                                                                         "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN (rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "                 AND rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") IS NOT NULL)       "
        + "\n" + "                            THEN ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " +
                                                                                                                getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 2, 1)) * 256 +                             "
        + "\n" + "                                 ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 105, " +
                                                                                                                getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 1, 1))                                     "
        + "\n" + "           ELSE -1                                                                                                                                                                                                 "
        + "\n" + "       END prolongationAmount,                                                                                                                                                                                    "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("data","chapter","fiId","account") +", " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(4, " + getObjectCode("data","chapter","fiId","account") +", 104, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + "))"
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END explanation,                                                                                                                                                                                           "
        + "\n" + "       CASE                                                                                                                                                                                                       "
        + "\n" + "           WHEN isResident <> 0                                                                                                                                                                                   "
        + "\n" + "               THEN RSI_RSBPARTY.PT_GetPartyCode(partyId, 3)                                                                                                                                                      "
        + "\n" + "           ELSE ''                                                                                                                                                                                                "
        + "\n" + "       END BIC                                                                                                                                                                                                    "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN COALESCE((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       COALESCE(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                            AND (rsb_rep_ac.CheckObjAttrPresenceByNum(4,1,'РЕПО ч/з ЦК не КО'," + getObjectCode("acc","t_chapter","t_fiId","t_account") +", " +
                                                                                             getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0)"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                            AND (rsb_rep_ac.CheckObjAttrPresenceByNum(4,1,'РЕПО ч/з ЦК не КО', " + getObjectCode("acc","t_chapter","t_fiId","t_account") +", " +
                                                                                             getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0)"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;

    macro SaveVariables( parameters:TParameters)
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
            profiler.clear();
            profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport=" + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " , t_ClientCode, t_PrintedAccount";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " , t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY  ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate", V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("ПризнакРЕПО").exact           = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact             = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакТретьеЛицо").exact     = dataSet.isThirdPerson;
                CompositeValue.fieldValue("ПризнакИП").exact             = dataSet.isExistCorrect;
                CompositeValue.fieldValue("НомЛС").exact                 = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact                 = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact              = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact                = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact                = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact                = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact               = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact               = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact              = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact              = dataSet.EndRest;
                CompositeValue.fieldValue("ПризнакЗависимости").exact    = string(NVL(dataSet.singDepending, ""));
                CompositeValue.fieldValue("КолПролонгаций").exact        = NVL(dataSet.prolongationAmount, -1);
                CompositeValue.fieldValue("Пояснения").exact             = string(NVL(dataSet.explanation, ""));
                CompositeValue.fieldValue("БИК").exact                   = string(NVL(dataSet.BIC, ""));
                if (dataSet.PerfomanceDate == date(0,0,0))
                    if (isOnDemandBalanceAccount(dataSet.balance))
                        CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                    else
                        CompositeValue.fieldValue("ДатаИспОб").exact = "";
                    end;
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = string(dataSet.PerfomanceDate);
                end;

                CompositeValue.fieldValue("ПрСтавка").exact  = dataSet.Rate;
                CompositeValue.fieldValue("КодКО").exact     = dataSet.ClientCode;
                CompositeValue.fieldValue("ТипЛС").exact     = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact     = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ОстВход").scaled  = ternary(dataSet.BeginRestTh == null, 0.0, dataSet.BeginRestTh);
                CompositeValue.fieldValue("ОбДебет").scaled  = ternary(dataSet.debetTh == null, 0.0, dataSet.debetTh);
                CompositeValue.fieldValue("ОбКредит").scaled = ternary(dataSet.creditTh == null, 0.0, dataSet.creditTh);
                CompositeValue.fieldValue("ОстИсход").scaled = ternary(dataSet.EndRestTh == null, 0.0, dataSet.EndRestTh);
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =      "SELECT                                                        "
                + "\n" +     "    data.t_id,                                                "
                + "\n" +     "    data.t_name,                                              "
                + "\n" +     "    data.t_shortName,                                         "
                + "\n" +     "    data.t_code,                                              "
                + "\n" +     "    data.t_countryCode,                                       "
                + "\n" +     "    CASE                                                      "
                + "\n" +     "        WHEN data.t_isResident = 1                            "
                + "\n" +     "        THEN                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN t_regNumber like '%/%'                   "
                + "\n" +     "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)"
                + "\n" +     "                ELSE COALESCE(t_regNumber, CHR(1))            "
                + "\n" +     "            END                                               "
                + "\n" +     "        ELSE                                                  "
                + "\n" +     "            CASE                                              "
                + "\n" +     "                WHEN data.t_isswift = 1                       "
                + "\n" +     "                THEN COALESCE(t_regNumber, 'НР')              "
                + "\n" +     "                ELSE 'НР'                                     "
                + "\n" +     "            END                                               "
                + "\n" +     "    END AS t_regNumber                                        "
                + "\n" +     "FROM                                                          "
                + "\n" +     "   (SELECT                                                    "
                + "\n" +     "        party.t_id,                                           "
                + "\n" +     "        party.t_name,                                         "
                + "\n" +     "        party.t_shortName,                                    "
                + "\n" +     "        party.t_isResident,                                   "
                + "\n" +     "        party.t_isswift,                                      "
                + "\n" +     "        codes.t_code as t_code,                               "
                + "\n" +     "        codes.t_name as t_nameCode,                           "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN (party.t_isResident = 0)                     "
                + "\n" +     "                THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" +     "                ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
                + "\n" +     "        END t_countryCode,                                    "
                + "\n" +     "        CASE                                                  "
                + "\n" +     "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" +     "                ELSE CHR(1)                                   "
                + "\n" +     "        END as t_regNumber                                    "
                + "\n" +     "    FROM                                                      "
                + "\n" +     "        dRepParty_vw      party,                              "
                + "\n" +     "        dRepPartyCodes_vw codes,                              "
                + "\n" +     "        dCountry_dbt      country                             "
                + "\n" +     "    WHERE                                                     "
                + "\n" +     "        party.t_id = (  select                                "
                + "\n" +     "                                    codes.t_partyId           "
                + "\n" +     "                                from                          "
                + "\n" +     "                                    dRepPartyCodes_vw codes   "
                + "\n" +     "                                where                         "
                + "\n" +     "                                    codes.t_code ='" + customerCode + "'"
                + "\n" +     "                                    AND codes.t_name = 'Код') "
                + "\n" +     "        and codes.t_name = 'Код'                              "
                + "\n" +     "        and codes.t_partyId = party.t_id                      "
                + "\n" +     "        AND country.t_codeLat3 = party.t_countrycode          "
                + "\n" +     ") data                                                        ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current = NVL(dataSet.name, "");
                    compositeValue.currentItem.fieldValue("РегНом").current = NVL(dataSet.regNumber, "");
                    compositeValue.currentItem.fieldValue("КодСтр").current = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current  = NVL(dataSet.id, "");
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled;
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled;
                compositeValue.moveNext();
            end;

        end;

        SavePart( 1, parameters );
        SavePart( 2, parameters );
        savePartForManualInput( 1, parameters );
        savePartForManualInput( 2, parameters );
    end;

    macro FillTempTable()
        SQL_Truncate("DF501_TMP");

        var temp501 = TRsbDataSet("SELECT * FROM DF501_TMP", RSDVAL_CLIENT, RSDVAL_STATIC);
        temp501.setFieldType("t_isGD",  V_INTEGER);

        var dataSet = TRsbDataSet(getQuery());

        while ( dataSet.Next() )
            message(dataSet.PartyID);

            temp501.AddNew();

            temp501.IsRepoAccount      = dataSet.isRepoAccount;
            temp501.Account            = dataSet.account;
            temp501.AccountId          = dataSet.accId;
            temp501.Balance            = dataSet.bal;
            temp501.PrintedAccount     = dataSet.prAcc;
            temp501.ClientName         = dataSet.name;
            temp501.RegNumber          = dataSet.regNumber;
            temp501.CountryCode        = dataSet.countryCode;
            temp501.ClientCode         = dataSet.partyID;
            temp501.PartReport         = dataSet.part;
            temp501.KindAccount        = dataSet.kindAccount;
            temp501.TypeAccount        = dataSet.typeAccount;
            temp501.PerfomanceDate     = NVL(dataSet.perfomanceDate, date(0,0,0));
            // 272109
            if (CheckCategoryForAccount(dataSet.accId, "-МС") OR CheckCategoryForAccount(dataSet.accId, "+МС"))
                temp501.Rate           = IIF(dataSet.rate < 0, 0, dataSet.rate);
            else
                temp501.Rate           = dataSet.rate;
            end;

            temp501.BeginRest          = dataSet.BegRest;
            temp501.EndRest            = dataSet.EndRest;
            temp501.Debet              = dataSet.Debet;
            temp501.Credit             = dataSet.Credit;
            temp501.isGD               = dataSet.isGD;
            temp501.isThirdPerson      = dataSet.isThirdPerson;
            temp501.singDepending      = dataSet.singDepending;
            temp501.prolongationAmount = dataSet.prolongationAmount;
            temp501.explanation        = dataSet.explanation;
            temp501.BIC                = dataSet.BIC;

            temp501.BeginRestTh        = RCB_FloorTerm( temp501.BeginRest );
            temp501.EndRestTh          = RCB_FloorTerm( temp501.EndRest   );
            temp501.DebetTh            = RCB_FloorTerm( temp501.Debet     );
            temp501.CreditTh           = RCB_FloorTerm( temp501.Credit    );

            temp501.isexistcorrect     = dataSet.isexistcorrect;

            temp501.update();
        end;
    end;
end;

private class (TCalculator_3129) TCalculator_3269(report : RcbReport)
    initTCalculator_3129(report);

    private macro getQuery()

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        AnalyzeTurnTable();

         var query =  "SELECT account,"
             + "\n" + "       accountId accId,"
             + "\n" + "       SUBSTR(balance, 1, 5) bal,"
             + "\n" + "       CASE WHEN ( (Part = 1) AND (TypeAccount = 2) )"
             + "\n" + "              THEN COALESCE((SELECT t_CorAccount FROM dcorschem_dbt cor WHERE cor.t_Account = account), CHR(1))"
             + "\n" + "            ELSE account"
             + "\n" + "       END prAcc,"
             + "\n" + "       name,"
             + "\n" + "       regNumber,"
             + "\n" + "       CASE"
             + "\n" + "           WHEN (isResident = 0)"
             + "\n" + "               THEN DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry))"
             + "\n" + "           ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))"
             + "\n" + "       END countryCode,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0), fiid, 0," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_BEGIN_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE begRest"
             + "\n" + "       END begRest,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE debet"
             + "\n" + "       END debet,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN 0"
             + "\n" + "             ELSE credit"
             + "\n" + "       END credit,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN typeAccount = 2"
             + "\n" + "             THEN"
             + "\n" + "                  CASE"
             + "\n" + "                       WHEN fiid <> 0"
             + "\n" + "                       THEN COALESCE(rsb_fiinstr.convsum(COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0), fiid, 0," + SQL_END_DATE + "), 0)"
             + "\n" + "                       ELSE COALESCE(rep_note.readconstantrest(objectId," + SQL_END_DATE + "), 0)"
             + "\n" + "                  END"
             + "\n" + "             ELSE endRest"
             + "\n" + "       END endRest,"
             + "\n" + "       objectId,"
             + "\n" + "       operationEndDate,"
             + "\n" + "       partyID,"
             + "\n" + "       part,"
             + "\n" + "       typeAccount,"
             + "\n" + "       kindAccount,"
             + "\n" + "       chapter,"
             + "\n" + "       isexistcorrect,"
             + "\n" + "       CASE"
             + "\n" + "             WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
             + "\n" + "             THEN NULL"
             + "\n" + "             ELSE COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "),operationEndDate)"
             + "\n" + "       END perfomanceDate,"
             + "\n" + "       COALESCE(rep_note.readRate(objectId," + SQL_END_DATE + "), 0) rate";

             query = query + addRelationsQuery();

             query =  ""
             + "\n" + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                1 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                          UNION"
             + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
             + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
             + "\n" + "                                2 t_part,"
             + "\n" + "                                1 t_typeAccount"
             + "\n" + "                           FROM drepaccount_vw acc,"
             + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
             + "\n" + "                          WHERE acc.t_isOpened = 1"
             + "\n" + "                            AND acc.t_chapter = 1"
             + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
             + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
             + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
             + "\n" + "                        ),"
             + "\n" + "     accountTable AS (SELECT --+MATERIALIZE"
             + "\n" + "                             *"
             + "\n" + "                        FROM accountSrcTable)"
             + "\n" + "SELECT *"
             + "\n" + "  FROM (" + query + ")"
             + "\n" + " WHERE begRest <> 0"
             + "\n" + "    OR debet   <> 0"
             + "\n" + "    OR credit  <> 0"
             + "\n" + "    OR endRest <> 0";

             return query;
    end;
end;

private class (TCalculator_3269) TCalculator_4212(report : RcbReport)
    initTCalculator_3269(report);

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account                                              account,     "
                   + "\n" + "       acc.t_accountId                                            accountId,   "
                   + "\n" + "       acc.t_fiid                                                 fiid,        "
                   + "\n" + "       acc.t_kind                                                 kindAccount, "
                   + "\n" + "       acc.t_chapter                                              chapter,     "
                   + "\n" + "       acc.t_balance                                              balance,     "
                   + "\n" + "       prt.t_id                                                   partyId,     "
                   + "\n" + "       DECODE(prt.t_isResident, 1, prt.t_name, COALESCE((SELECT pn.t_name                                   "
                   + "\n" + "                                                           FROM dPartyName_dbt pn                           "
                   + "\n" + "                                                          WHERE pn.t_partyId    = prt.t_id                  "
                   + "\n" + "                                                            AND pn.t_nameTypeId = 3                         "
                   + "\n" + "                                                            AND ROWNUM          < 2), prt.t_name)) AS name, "
                   + "\n" + "       prt.t_isResident                                                    isResident,                 "
                   + "\n" + "       COALESCE((SELECT adr.t_country                                          "
                   + "\n" + "                   FROM dAdress_dbt adr                                        "
                   + "\n" + "                  WHERE adr.t_partyId  = prt.t_id                              "
                   + "\n" + "                    AND adr.t_type     = 2                                     "
                   + "\n" + "                    AND adr.t_country != CHR(1)), prt.t_countryCode)   nrCountry,"
                   + "\n" + "       acc.t_inCoverRest                                          BegRest,     "
                   + "\n" + "       acc.t_outCoverRest                                         EndRest,     "
                   + "\n" + "       COALESCE((SELECT sum(doc.t_incoversum)                                  "
                   + "\n" + "                   FROM drepdocumentwithcorrection_vw doc                      "
                   + "\n" + "                  WHERE doc.t_chapter      = acc.t_chapter                     "
                   + "\n" + "                    AND doc.t_debetaccount = acc.t_Account                     "
                   + "\n" + "                    AND doc.t_date        >= rep_data.getbegindate()           "
                   + "\n" + "                    AND doc.t_date        <= rep_data.getenddate()),0) Debet,  "
                   + "\n" + "       COALESCE((SELECT sum(t_incoversum)                                      "
                   + "\n" + "                   FROM drepdocumentwithcorrection_vw doc                      "
                   + "\n" + "                  WHERE doc.t_chapter       = acc.t_chapter                    "
                   + "\n" + "                    AND doc.t_creditaccount = acc.t_Account                    "
                   + "\n" + "                    AND doc.t_date         >= rep_data.getbegindate()          "
                   + "\n" + "                    AND doc.t_date         <= rep_data.getenddate()),0) Credit,"
                   + "\n" + "       acc.t_objectId                                              objectId,   "
                   + "\n" + "       acc.t_part                                                  part,       "
                   + "\n" + "       acc.t_typeAccount                                           typeAccount,"
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd                       operationEndDate,"
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN EXISTS (SELECT 1                                               "
                   + "\n" + "                          FROM drepCorrectionalDocument_vw iscorrect           "
                   + "\n" + "                         WHERE iscorrect.t_creditaccount = acc.t_account)      "
                   + "\n" + "           THEN 1                                                              "
                   + "\n" + "           ELSE 0                                                              "
                   + "\n" + "       END                                                      AS isexistcorrect,"
                   + "\n" + "       acc.t_isCategoryMarginSum                                   isCategoryMarginSum,"
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN prt.t_isresident = 1                                           "
                   + "\n" + "           THEN                                                                "
                   + "\n" + "               CASE                                                            "
                   + "\n" + "                   WHEN reppartycodes.t_code like '%/%'                        "
                   + "\n" + "                       THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                   + "\n" + "                   ELSE COALESCE(reppartycodes.t_code, CHR(1))                 "
                   + "\n" + "               END                                                             "
                   + "\n" + "           ELSE                                                                "
                   + "\n" + "               CASE                                                            "
                   + "\n" + "                   WHEN prt.t_isswift = 1                                      "
                   + "\n" + "                       THEN COALESCE(reppartycodes.t_code, 'НР')               "
                   + "\n" + "                   ELSE 'НР'                                                   "
                   + "\n" + "               END                                                             "
                   + "\n" + "       END                                                      AS regNumber,  "
                   //графа 13
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT     + ", "
                                                                                    + RCB_OBJGROUP_ACTIVEKIND + ", "
                                                                                    + "'Собств_Обременение',       "
                                                                                    + "acc.t_objectId,             "
                                                                                    + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN '11'                                                       " //Признак обременения первая цифра, остальное значение графы
                   + "\n" + "           ELSE COALESCE((SELECT CASE                                          "
                   + "\n" + "                                     WHEN NOT (    party.t_isPhisical = 1      "
                   + "\n" + "                                               AND party.t_isResident = 0)     "
                   + "\n" + "                                         THEN '9' || party.t_name              "
                   + "\n" + "                                     ELSE '0'                                  "
                   + "\n" + "                                 END AS t_name                                 "
                   + "\n" + "                            FROM dRepParty_vw         party,                   "
                   + "\n" + "                                 dRepLinkedObjects_vw objLink                  "
                   + "\n" + "                           WHERE party.t_objectId                = objLink.t_id"
                   + "\n" + "                             AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
                   + "\n" + "                             AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
                   + "\n" + "                             AND objLink.t_isInstalledForEndDate = 1           "
                   + "\n" + "                             AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "                             AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "                         ),                                                    "
                   + "\n" + "                         '0'                                                   "
                   + "\n" + "                        )                                                      "
                   + "\n" + "       END                                                         onerousClaim,"
                   //графа 14
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT     + ", "
                                                                                    + RCB_OBJGROUP_ACTIVEKIND + ", "
                                                                                    + "'Собств_Обременение',       "
                                                                                    + "acc.t_objectId,             "
                                                                                    + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   //Условный код первая цифра (если X - значит не заполяется), следующие 3 цифры - это код SWIFT (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
                   + "\n" + "               THEN 'XYYY'                                                          "
                   + "\n" + "           ELSE COALESCE((SELECT CASE                                               "
                   + "\n" + "                                     WHEN     party.t_isBank     = 1                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                         THEN (SELECT CASE                          "
                   + "\n" + "                                                          WHEN INSTR(codes.t_code, '/', 1, 1) != 0           "
                   + "\n" + "                                                              THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
                   + "\n" + "                                                          WHEN codes.t_code = ''                             "
                   + "\n" + "                                                              THEN 'X' || 'YYY' || codes.t_code              "
                   + "\n" + "                                                          ELSE '2' || 'YYY' || codes.t_code                  "
                   + "\n" + "                                                      END                           "
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes       "
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id)"

                   + "\n" + "                                     WHEN     party.t_isBank     = 1                "
                   + "\n" + "                                          AND party.t_isResident = 0                "
                   + "\n" + "                                         THEN (COALESCE((SELECT CASE                "
                   + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 8                             "
                   + "\n" + "                                                                        THEN '4' || 'XXX' || codes.t_code || 'XXX'            "
                   + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 11                            "
                   + "\n" + "                                                                        THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
                   + "\n" + "                                                                    ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
                   + "\n" + "                                                                END t_code                                                    "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes  "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))         "

                   + "\n" + "                                     WHEN     party.t_isPhisical = 0                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                         THEN (COALESCE((SELECT '1' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

                   + "\n" + "                                     WHEN party.t_isEmployer = 1                    "
                   + "\n" + "                                         THEN (COALESCE((SELECT '6' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

                   + "\n" + "                                     WHEN     party.t_isPhisical = 0                "
                   + "\n" + "                                          AND party.t_isResident = 0                "
                   + "\n" + "                                         THEN '3'|| 'YYY' || 'HP'                   "
                   + "\n" + "                                     WHEN     party.t_isPhisical = 1                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                          AND party.t_isEmployer = 0                "
                   + "\n" + "                                         THEN (COALESCE((SELECT '5' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_INN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
                   + "\n" + "                                     ELSE 'X' || 'YYY' || ''                        "
                   + "\n" + "                                 END t_identifier                                   "
                   + "\n" + "                             FROM dRepLinkedObjects_vw link,                        "
                   + "\n" + "                                  dRepParty_vw         party                        "
                   + "\n" + "                            WHERE acc.t_objectId               = link.t_connectObjectId"
                   + "\n" + "                              AND party.t_objectId             = link.t_id          "
                   + "\n" + "                              AND link.t_isInstalledForEndDate = 1                  "
                   + "\n" + "                              AND link.t_connectObjectType     = 4                  "
                   + "\n" + "                              AND link.t_type                  = 3                  "
                   + "\n" + "                              AND link.t_role                  = 59                 "
                   + "\n" + "                         ),                                                         "
                   + "\n" + "                         'X' || 'YYY' || ''                                         "
                   + "\n" + "                        )                                                           "
                   + "\n" + "       END                                                                 identifier,"
                   //графа 15
                   + "\n" + "       (SELECT CASE category.t_value                                           "
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда")             + " THEN " + getSqlString("1")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит")           + " THEN " + getSqlString("2")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз")          + " THEN " + getSqlString("4")
                   + "\n" + "                    ELSE " + getSqlString("")
                   + "\n" + "               END                                                             "
                   + "\n" + "          FROM dRepCategory_vw      category,                                  "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE category.t_id         = " + RCB_OBJGROUP_FOR_REPORTING
                   + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND category.t_value = ANY(" + getSqlString("Обрем_Ссуда")             + ","
                   + "\n" + "                                      " + getSqlString("Обрем_Депозит")           + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ДолгОбязательство") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ИноеОбяз")          + ""
                   + "\n" + "                                     )"
                   + "\n" + "           AND category.t_isInstalledForEndDate = 1                            "
                   + "\n" + "           AND category.t_objectId              = objLink.t_id                 "
                   + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1                            "
                   + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId               "
                   + "\n" + "       ) onerousClaimCategory,                                                 "
                   //графа 16
                   + "\n" + "       (SELECT acc2.t_outCoverRest                                             "
                   + "\n" + "          FROM dRepAccount_vw       acc2,                                      "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))          "
                   + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                       "
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) restLinkedAccount,                                                    "
                   + "\n" + "       (SELECT SUBSTR(objLink.t_id, 10)                                        "
                   + "\n" + "          FROM dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) linkedAccount,                                                        "
                   //графа 17
                   + "\n" + "       (SELECT rep_note.getDateAccountNote(acc2.t_objectId, 16,                "
                                                                        + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
                   + "\n" + "          FROM dRepAccount_vw       acc2,                                      "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))          "
                   + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                       "
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) redemptionDate                                                        "
                          ;

        //Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
        queryForData = queryForData
                   + "\n" + "  FROM accountTable acc,                                                       "
                   + "\n" + "       drepparty_vw prt,                                                       "
                   + "\n" + "       (SELECT *                                                               "
                   + "\n" + "          FROM dreppartycodes_vw partyсode,                                    "
                   + "\n" + "               drepparty_vw      repparty_                                     "
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId                            "
                   + "\n" + "               -- для центробанка БИК (ЦБ РФ)                                  "
                   + "\n" + "           AND (  (    repparty_.t_isCentralBank = 1                           "
                   + "\n" + "                   AND partyсode.t_codekind      = " + RCB_PTCK_BIC + ")       "
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'   "
                   + "\n" + "           OR (  (     repparty_.t_isResident = 0                              "
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_SWIFT + ")        "
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'              "
                   + "\n" + "               OR (    repparty_.t_isResident    = 1                           "
                   + "\n" + "                   AND repparty_.t_isCentralBank = 0                           "
                   + "\n" + "                   AND partyсode.t_codekind      = " + RCB_PTCK_BANKREGNUM + ")))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = acc.t_contragentId                                           "
                   + "\n" + "   AND prt.t_id = reppartycodes.t_partyid(+)                                   "
                   ;

        return QueryForData;
    end;

    private macro addRelationsQuery()
        var query;

        query =  ","
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО', data.objectId, "
                                                                         + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0         "
        + "\n" + "               THEN 1                                                          "
        + "\n" + "           ELSE 0                                                              "
        + "\n" + "       END isRepoAccount,                                                      "
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, "
                                                                         + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0       "
        + "\n" + "               THEN 1                                                          "
        + "\n" + "           ELSE 0                                                              "
        + "\n" + "       END isGD,                                                               "
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                         + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0             "
        + "\n" + "               THEN 1                                                          "
        + "\n" + "           ELSE 0                                                              "
        + "\n" + "       END isThirdPerson,                                                      "
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                         + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0             "
        + "\n" + "               THEN '*'                                                        "
        + "\n" + "           ELSE ''                                                             "
        + "\n" + "       END singDepending,                                                      "
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN (    rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                              + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0             "
        + "\n" + "                 AND rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "
                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") IS NOT NULL"
        + "\n" + "                )                                                              "
        + "\n" + "               THEN   ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, "
                                                                                                       + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                       + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 2, 1)) * 256 "
        + "\n" + "                    + ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, "
                                                                                                       + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                       + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 1, 1))"
        + "\n" + "           ELSE -1                                                             "
        + "\n" + "       END prolongationAmount,                                                 "
        + "\n" + "       rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ",  data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", "
                                                                             + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")) AS explanation,"
        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN isResident <> 0                                                "
        + "\n" + "               THEN RSI_RSBPARTY.PT_GetPartyCode(partyId, 3)                   "
        + "\n" + "           ELSE ''                                                             "
        + "\n" + "       END BIC,                                                                "
        + "\n" + "       SUBSTR(onerousClaim, 2) onerousClaim,                                   "

        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN SUBSTR(onerousClaim, 1, 1) = 'X'                               "
        + "\n" + "               THEN ''                                                         "
        + "\n" + "           ELSE SUBSTR(onerousClaim, 1, 1)                                     "
        + "\n" + "       END onerousSign,                                                        "

        + "\n" + "       SUBSTR(identifier, 5) identifier,                                       "

        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN SUBSTR(identifier, 2, 3) = 'YYY'                               "
        + "\n" + "               THEN ''                                                         "
        + "\n" + "           ELSE SUBSTR(identifier, 2, 3)                                       "
        + "\n" + "       END swiftDepartment,                                                    "

        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN SUBSTR(identifier, 1, 1) = 'X'                                 "
        + "\n" + "               THEN ''                                                         "
        + "\n" + "           ELSE SUBSTR(identifier, 1, 1)                                       "
        + "\n" + "       END conditionalCode,                                                    "

        + "\n" + "       COALESCE(onerousClaimCategory, " + getSqlString("") + ") onerousClaimCategory,"

        + "\n" + "       CASE                                                                    "
        + "\n" + "           WHEN     onerousClaimCategory IS NOT NULL                           "
        + "\n" + "                AND onerousClaimCategory = '4'                                 "
        + "\n" + "           THEN COALESCE((SELECT rep_note.getTextAccountNote(objLink.t_id, 69, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
        + "\n" + "                            FROM dRepLinkedObjects_vw objLink                  "
        + "\n" + "                           WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                             AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "                             AND objLink.t_isInstalledForEndDate = 1           "
        + "\n" + "                             AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                             AND objLink.t_connectObjectId       = data.objectId"
        + "\n" + "                         ),                                                    "
        + "\n" + "                         CHR(1)                                                "
        + "\n" + "                        )                                                      "
        + "\n" + "           ELSE " + getSqlString("")
        + "\n" + "       END otherDecoding,                                                      "

        + "\n" + "       restLinkedAccount,                                                      "
        + "\n" + "       linkedAccount,                                                          "
        + "\n" + "       redemptionDate                                                          "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    private macro getQuery()
        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        var query =  "SELECT account,                                                                   "
            + "\n" + "       accountId,                                                                 "
            + "\n" + "       SUBSTR(balance, 1, 5) bal,                                                 "
            + "\n" + "       name,                                                                      "
            + "\n" + "       regNumber,                                                                 "
            + "\n" + "       DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry)) countryCode,"
            + "\n" + "       begRest,                                                                   "
            + "\n" + "       debet,                                                                     "
            + "\n" + "       credit,                                                                    "
            + "\n" + "       endRest,                                                                   "
            + "\n" + "       objectId,                                                                  "
            + "\n" + "       operationEndDate,                                                          "
            + "\n" + "       partyID,                                                                   "
            + "\n" + "       part,                                                                      "
            + "\n" + "       typeAccount,                                                               "
            + "\n" + "       kindAccount,                                                               "
            + "\n" + "       chapter,                                                                   "
            + "\n" + "       isexistcorrect,                                                            "
            + "\n" + "       isCategoryMarginSum,                                                       "
            + "\n" + "       isResident,                                                                "
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN    (" + convertMaskToSQLFormat(m_BalanceList, "balance")  + ")"
            + "\n" + "                OR (" + convertMaskToSQLFormat("32401, 32402", "balance") + ")"
            + "\n" + "           THEN CASE                                                              "
            + "\n" + "                    WHEN endRest = 0                                              "
            + "\n" + "                         AND (   (begRest != 0)                                   "
            + "\n" + "                              OR (credit != 0)                                    "
            + "\n" + "                              OR (debet != 0)                                     "
            + "\n" + "                             )                                                    "
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)                                  "
            + "\n" + "                            FROM drepdocument_vw doc                              "
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND ((    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId)      "
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId)       "
            + "\n" + "                                 )                                                "
            + "\n" + "                         )                                                        "
            + "\n" + "                    WHEN endRest != 0                                             "
            + "\n" + "                    THEN NULL                                                     "
            + "\n" + "                END                                                               "
            + "\n" + "           ELSE CASE                                                              "
            + "\n" + "                    WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1                                 "
            + "\n" + "                                           FROM mmDeals                           "
            + "\n" + "                                          WHERE mmDeals.t_part = part             "
            + "\n" + "                                            AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )                                         "
            + "\n" + "                         )                                                        "
            + "\n" + "                    THEN COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "), operationEndDate," + getSqlDate(Date(0,0,0)) + ")"
            + "\n" + "                    ELSE COALESCE((SELECT MAX(mmDeals.t_plannedFinishDate)             "
            + "\n" + "                                FROM mmDeals                                      "
            + "\n" + "                               WHERE mmDeals.t_part = part                        "
            + "\n" + "                                 AND account        = mmDeals.t_mainRestAccount   "
            + "\n" + "                             )," + getSqlDate(Date(0,0,0))
            + "\n" + "                            )                                                     "
            + "\n" + "                END                                                               "
            + "\n" + "       END                                                                  AS perfomanceDate,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ") OR (" + convertMaskToSQLFormat("32401, 32402", "balance") + ")"
            + "\n" + "           THEN 0                                                                 "
            + "\n" + "           ELSE CASE                                                              "
            + "\n" + "                    WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1                                 "
            + "\n" + "                                           FROM mmDeals                           "
            + "\n" + "                                          WHERE mmDeals.t_part = part             "
            + "\n" + "                                            AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )                                         "
            + "\n" + "                         )                                                        "
            + "\n" + "                    THEN 0                                                        "
            + "\n" + "                    ELSE COALESCE((SELECT deal.t_id                               "
            + "\n" + "                                     FROM mmDeals deal                            "
            + "\n" + "                                    WHERE deal.t_part              = part         "
            + "\n" + "                                      AND deal.t_mainRestAccount   = account      "
            + "\n" + "                                      AND deal.t_plannedFinishDate = COALESCE((SELECT MAX(maxDate.t_plannedFinishDate)                  "
            + "\n" + "                                                                                 FROM mmDeals maxDate                                   "
            + "\n" + "                                                                                WHERE maxDate.t_part            = deal.t_part           "
            + "\n" + "                                                                                  AND maxDate.t_mainRestAccount = deal.t_mainRestAccount"
            + "\n" + "                                                                              )," + getSqlDate(Date(0,0,0))
            + "\n" + "                                                                             )    "
            + "\n" + "                                  ), 0)                                           "
            + "\n" + "                END                                                               "
            + "\n" + "       END                                                                  AS perfomanceDateDealId,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN CASE                                                              "
            + "\n" + "                    WHEN     endRest = 0                                          "
            + "\n" + "                         AND (   (begRest != 0)                                   "
            + "\n" + "                              OR (credit  != 0)                                   "
            + "\n" + "                              OR (debet   != 0)                                   "
            + "\n" + "                             )                                                    "
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)                                  "
            + "\n" + "                            FROM drepdocument_vw doc                              "
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND (   (    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId)"
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId)"
            + "\n" + "                                 )                                                "
            + "\n" + "                         )                                                        "
            + "\n" + "                    WHEN endRest != 0                                             "
            + "\n" + "                    THEN NULL --использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
            + "\n" + "                END                                                               "
            + "\n" + "           ELSE NULL --в экспорте использовать perfomanceDate                     "
            + "\n" + "       END                                                                  AS perfomanceDateKliko,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN NULL                                                              "
            + "\n" + "           WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1                                          "
            + "\n" + "                                  FROM mmDeals                                    "
            + "\n" + "                                 WHERE mmDeals.t_part = part                      "
            + "\n" + "                                   AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                               )                                                  "
            + "\n" + "                )                                                                 "
            + "\n" + "           THEN COALESCE(rep_note.readRate(data.objectId," + SQL_END_DATE + "), 0)"
            + "\n" + "           ELSE (SELECT CASE                                                      "
            + "\n" + "                            WHEN mmDeals.t_isOverNight = 1                        "
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount                  "
            + "\n" + "                                             *(SELECT rateHistory.t_rate          "
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory                                "
            + "\n" + "                                                WHERE rateHistory.t_dealId      = deals.t_id                             "
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7                                      "
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh        "
            + "\n" + "                                                                                 WHERE rh.t_dealId      = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7              "
            + "\n" + "                                                                                   AND rh.t_rateDate   <= " + SQL_END_DATE
            + "\n" + "                                                                               )                                         "
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,                                           "
            + "\n" + "                                                         rateHistory.t_rate                                              "
            + "\n" + "                                              )                                                                          "
            + "\n" + "                                            )                                                                            "
            + "\n" + "                                       / SUM(deals.t_dealAmount)                                                         "
            + "\n" + "                                    FROM repMmDeals_vw deals                                                             "
            + "\n" + "                                   WHERE deals.t_kind = mmDeals.t_kind                                                   "
            + "\n" + "                                     AND (   (mmDeals.t_mainRestAccount   = deals.t_mainRestAccount)                     "
            + "\n" + "                                          OR (mmDeals.t_delaydMainRestAcc = deals.t_delaydMainRestAcc))                  "
            + "\n" + "                                     AND deals.t_contragentId = mmDeals.t_contragentId                                   "
            + "\n" + "                                     AND (   deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                          OR (    deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )                                                                           "
            + "\n" + "                                         )                                                                               "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                            WHEN     mmDeals.t_isOverNight     != 1                                                      "
            + "\n" + "                                 AND mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount                                                         "
            + "\n" + "                                             *(SELECT rateHistory.t_rate                                                 "
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory                                "
            + "\n" + "                                                WHERE rateHistory.t_dealId      = deals.t_id                             "
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7                                      "
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh        "
            + "\n" + "                                                                                 WHERE rh.t_dealId      = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7              "
            + "\n" + "                                                                                   AND rh.t_rateDate   <= " + SQL_END_DATE
            + "\n" + "                                                                               )                                         "
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,                                           "
            + "\n" + "                                                         rateHistory.t_rate                                              "
            + "\n" + "                                              )                                                                          "
            + "\n" + "                                            )                                                                            "
            + "\n" + "                                       / SUM(deals.t_dealAmount)                                                         "
            + "\n" + "                                    FROM repMmDeals_vw deals                                                             "
            + "\n" + "                                   WHERE (   (   deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )                                                                           "
            + "\n" + "                                          OR deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                         )                                                                               "
            + "\n" + "                                     AND deals.t_mainRestAccount = mmDeals.t_mainRestAccount                             "
            + "\n" + "                                 CONNECT BY PRIOR deals.t_id = deals.t_prolongingDealId                                  "
            + "\n" + "                                   START WITH deals.t_id     = mmDeals.t_id                                              "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                            ELSE (SELECT rateHistory.t_rate                                                              "
            + "\n" + "                                    FROM repMmDealRateHistory_vw rateHistory                                             "
            + "\n" + "                                   WHERE rateHistory.t_dealId      = mmDeals.t_id                                        "
            + "\n" + "                                     AND rateHistory.t_percentKind = 7                                                   "
            + "\n" + "                                     AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                             "
            + "\n" + "                                                                     FROM repMmDealRateHistory_vw rh                     "
            + "\n" + "                                                                    WHERE rh.t_dealId      = rateHistory.t_dealId        "
            + "\n" + "                                                                      AND rh.t_percentKind = 7                           "
            + "\n" + "                                                                      AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                  )                                                      "
            + "\n" + "                                   GROUP BY rateHistory.t_dealId,                                                        "
            + "\n" + "                                            rateHistory.t_rate                                                           "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                        END AS t_rate"
            + "\n" + "                   FROM mmDeals                                                                                          "
            + "\n" + "                  WHERE mmDeals.t_part = part                                                                            "
            + "\n" + "                    AND account        = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)                    "
            + "\n" + "                    AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                                           "
            + "\n" + "                                          FROM mmDeals maxId                                                             "
            + "\n" + "                                         WHERE maxId.t_part = mmDeals.t_part                                             "
            + "\n" + "                                           AND (   (mmDeals.t_mainRestAccount   = maxId.t_mainRestAccount)               "
            + "\n" + "                                                OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc))            "
            + "\n" + "                                           AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)      "
            + "\n" + "                                                                              FROM mmDeals maxDate                       "
            + "\n" + "                                                                             WHERE maxDate.t_part = maxId.t_part         "
            + "\n" + "                                                                               AND (   (maxId.t_mainRestAccount   = maxDate.t_mainRestAccount)   "
            + "\n" + "                                                                                    OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc))"
            + "\n" + "                                                                           )                                             "
            + "\n" + "                                       )                                                                                 "
            + "\n" + "                )                                                                                                        "
            + "\n" + "       END                                                                  AS rate,                                     "
            + "\n" + "       CASE                                                                                                              "
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN 0                                                                                                        "
            + "\n" + "           WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1                                                                                 "
            + "\n" + "                                  FROM mmDeals                                                                           "
            + "\n" + "                                 WHERE mmDeals.t_part = part                                                             "
            + "\n" + "                                   AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)             "
            + "\n" + "                               )                                                                                         "
            + "\n" + "                )                                                                                                        "
            + "\n" + "           THEN 0                                                                                                        "
            + "\n" + "           ELSE COALESCE((SELECT mmDeals.t_id                                                                            "
            + "\n" + "                            FROM mmDeals                                                                                 "
            + "\n" + "                           WHERE mmDeals.t_part = part                                                                   "
            + "\n" + "                             AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)                   "
            + "\n" + "                             AND (   mmDeals.t_isOverNight      = 1                                                      "
            + "\n" + "                                  OR mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                             AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                                  "
            + "\n" + "                                                   FROM mmDeals maxId                                                    "
            + "\n" + "                                                  WHERE maxId.t_part = mmDeals.t_part                                    "
            + "\n" + "                                                    AND (   (mmDeals.t_mainRestAccount   = maxId.t_mainRestAccount)      "
            + "\n" + "                                                         OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc))   "
            + "\n" + "                                                    AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)"
            + "\n" + "                                                                                       FROM mmDeals maxDate              "
            + "\n" + "                                                                                      WHERE maxDate.t_part = maxId.t_part"
            + "\n" + "                                                                                        AND (   (maxId.t_mainRestAccount   = maxDate.t_mainRestAccount)   "
            + "\n" + "                                                                                             OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc))"
            + "\n" + "                                                                                    )                                    "
            + "\n" + "                                                )                                                                        "
            + "\n" + "                         ), 0)                                                                                           "
            + "\n" + "       END                                                                  AS rateDealId                                "
                   ;

            query = query + addRelationsQuery();

            // Начало запроса. Формирование подзапросов на представления ГК и МБК. Отбор данных по условиям соответствия
            query =  ""
            + "\n" + "WITH tune                                                             "
            + "\n" + "  AS (" + m_tuneTable.getQuery() + "),"
            + "\n" + "  accountSrcTable                                                     "
            + "\n" + "  AS (SELECT acc.t_chapter,      acc.t_account,                       "
            + "\n" + "             acc.t_accountId,    acc.t_fiId,                          "
            + "\n" + "             acc.t_kind,         acc.t_balance,                       "
            + "\n" + "             acc.t_inCoverRest,  acc.t_outCoverRest,                  "
            + "\n" + "             acc.t_objectId,     acc.t_operationDate,                 "
            + "\n" + "             acc.t_daysToEnd,    acc.t_partyId,                       "
            + "\n" + "             acc.t_contragentId, t501.t_Part,                         "
            + "\n" + "             CASE t501.t_TypeAccount                                  "
            + "\n" + "                 WHEN " + SQL_TYPE_1_CODE
            + "\n" + "                 THEN 1                                               "
            + "\n" + "                 ELSE 2                                               "
            + "\n" + "             END t_typeAccount,                                       "
            + "\n" + "             COALESCE(accWithCatMarginSum.t_isCategoryMarginSum, 0) t_isCategoryMarginSum"
            + "\n" + "        FROM drepaccount_vw                        acc,               "
            + "\n" + "             tune                                  t501,              "
            // 272109
            // аналог функции CheckCategoryForAccount, только интегрированной в основной запрос
            // поле t_isCategoryMarginSum будет проверяться и если значение в этом поле будет равно 1, то если процентная ставка
            // будет меньше нуля, она будет записана, как 0.
            + "\n" + "             (SELECT acc2.t_accountId,                                "
            + "\n" + "                     1 AS t_isCategoryMarginSum                       "
            + "\n" + "                FROM daccount_dbt                  acc2,              "
            + "\n" + "                     (SELECT mcacc.t_account,                         "
            + "\n" + "                             mcacc.t_currency,                        "
            + "\n" + "                             mcacc.t_chapter                          "
            + "\n" + "                        FROM dmcaccdoc_dbt mcacc,                     "
            + "\n" + "                             dmccateg_dbt  cat                        "
            + "\n" + "                       WHERE (   cat.t_code = '-МС'                   "
            + "\n" + "                              OR cat.t_code = '+МС')                  "
            + "\n" + "                         AND mcacc.t_catId  = cat.t_id) mcaccwithcat  "
            + "\n" + "               WHERE mcaccwithcat.t_account  = acc2.t_account         "
            + "\n" + "                 AND mcaccwithcat.t_currency = acc2.t_code_currency   "
            + "\n" + "                 AND mcaccwithcat.t_chapter  = acc2.t_chapter         "
            + "\n" + "            GROUP BY acc2.t_accountId)              accWithCatMarginSum"
            + "\n" + "       WHERE acc.t_accountId = accWithCatMarginSum.t_accountId(+)     "
            + "\n" + "         AND acc.t_isOpened       = 1                                 "
            + "\n" + "         AND acc.t_chapter        = 1                                 "
            + "\n" + "         AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, acc.t_account) = 1"
            + "\n" + "         AND rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT        + ", "
                                                                          + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО ч/з ЦК', acc.t_objectId, "
                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT        + ", "
                                                                          + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND (   (    (SELECT party.t_isBank                          "
            + "\n" + "                         FROM dRepParty_vw party                      "
            + "\n" + "                        WHERE party.t_id = acc.t_contragentId         "
            + "\n" + "                      ) = 1                                           "
            + "\n" + "                   AND EXISTS(SELECT 1                                "
            + "\n" + "                                FROM dRepParty_vw party               "
            + "\n" + "                               WHERE party.t_id = acc.t_contragentId  "
            + "\n" + "                                 AND party.t_bankRegNumber IS NOT NULL" // код "Рег. номер кред. орг-ции" в представлении dRepParty_vw равен NULL, если дата закрытия <= ДООП
            + "\n" + "                             )                                        "
            + "\n" + "                 )                                                    "
            + "\n" + "              OR (SELECT party.t_isBank                               "
            + "\n" + "                    FROM dRepParty_vw party                           "
            + "\n" + "                   WHERE party.t_id         = acc.t_contragentId      "
            + "\n" + "                     AND party.t_isResident = 0                       "
            + "\n" + "                 ) = 1                                                "
            + "\n" + "              OR (SELECT party.t_isCentralBank                        "
            + "\n" + "                    FROM dRepParty_vw party                           "
            + "\n" + "                   WHERE party.t_id = acc.t_contragentId              "
            + "\n" + "                 ) = 1                                                "
            + "\n" + "             )                                                        "
            + "\n" + "     ),                                                               "
            + "\n" + "  mmDeals                                                             "
                   + ternary(TParameters().m_isMmData,
              "\n" + "  AS (SELECT deals.t_id,                                             "
            + "\n" + "             deals.t_mainRestAccount,                                "
            + "\n" + "             deals.t_delaydMainRestAcc,                              "
            + "\n" + "             deals.t_plannedFinishDate,                              "
            + "\n" + "             deals.t_isOverNight,                                    "
            + "\n" + "             deals.t_kind,                                           "
            + "\n" + "             deals.t_contragentId,                                   "
            + "\n" + "             deals.t_isProlongingDeal,                               "
            + "\n" + "             CASE deals.t_kind                                       "
            + "\n" + "                 WHEN 'Размещение ' THEN 1                           "
            + "\n" + "                 WHEN 'Привлечение' THEN 2                           "
            + "\n" + "                 ELSE 0                                              "
            + "\n" + "             END t_part                                              "
            + "\n" + "        FROM repMmDeals_vw deals                                     "
            + "\n" + "       WHERE deals.t_kind IN ('Размещение ', 'Привлечение')          "
            + "\n" + "         AND deals.t_isOpened = 1                                    "
            + "\n" + "     ),                                                              ",
              "\n" + "  AS (SELECT 0                                AS t_id,               "
            + "\n" + "             CHR(1)                           AS t_mainRestAccount,  "
            + "\n" + "             CHR(1)                           AS t_delaydMainRestAcc,"
            + "\n" + "         " + getSQLDate(Date(0, 0, 0)) + "    AS t_plannedFinishDate,"
            + "\n" + "             0                                AS t_isOverNight,      "
            + "\n" + "             CHR(1)                           AS t_kind,             "
            + "\n" + "             0                                AS t_contragentId,     "
            + "\n" + "             CHR(1)                           AS t_isProlongingDeal, "
            + "\n" + "             0                                AS t_part              "
            + "\n" + "        FROM DUAL                                                    "
            + "\n" + "     ),                                                              ")
            + "\n" + "  accountTable                                                       "
            + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *                                     "
            + "\n" + "        FROM accountSrcTable                                         "
            + "\n" + "     )                                                               "
            + "\n" + "SELECT *                                                             "
            + "\n" + "  FROM (" + query + ")"
            + "\n" + " WHERE begRest <> 0                                                  "
            + "\n" + "    OR debet   <> 0                                                  "
            + "\n" + "    OR credit  <> 0                                                  "
            + "\n" + "    OR endRest <> 0                                                  ";

            // еще одно перечисление полей, для более удобного использования и наглядности
            // плюс идет одно условие, которое перешло из функции FillTempTable(), связанное с процентами
            // В ТЗ Securities оно звучит примерно так: Если в результате расчета значение средневзвешенной процентной ставки < 0, то в отчет  выводится значение 0
            // Такая проверка необходима, только если на счете присутствует категория учета "+МС" или "-МС", поэтому
            // было приятно решение реализовать это условие в рамках основного запроса
        query =      "SELECT account              AS t_account,             "
            + "\n" + "       accountId            AS t_accountId,           "
            + "\n" + "       bal                  AS t_balance,             "
            + "\n" + "       account              AS t_printedAccount,      "
            + "\n" + "       name                 AS t_clientName,          "
            + "\n" + "       regNumber            AS t_regNumber,           "
            + "\n" + "       countryCode          AS t_countryCode,         "
            + "\n" + "       begRest              AS t_beginRest,           "
            + "\n" + "       debet                AS t_debet,               "
            + "\n" + "       credit               AS t_credit,              "
            + "\n" + "       endRest              AS t_endRest,             "
            + "\n" + "       perfomanceDate       AS t_perfomanceDate,      "
            + "\n" + "       perfomanceDateDealId AS t_perfomanceDateDealId,"
            + "\n" + "       perfomanceDateKliko  AS t_perfomanceDateKliko, "
            + "\n" + "       CASE                                           "
            + "\n" + "           WHEN isCategoryMarginSum = 1               "
            + "\n" + "           THEN CASE                                  "
            + "\n" + "                    WHEN rate > 0                     "
            + "\n" + "                    THEN rate                         "
            + "\n" + "                    ELSE 0                            "
            + "\n" + "                END                                   "
            + "\n" + "           ELSE rate                                  "
            + "\n" + "       END                  AS t_rate,                "
            + "\n" + "       rateDealId           AS t_rateDealId,          "
            + "\n" + "       partyID              AS t_clientCode,          "
            + "\n" + "       part                 AS t_partReport,          "
            + "\n" + "       typeAccount          AS t_typeAccount,         "
            + "\n" + "       kindAccount          AS t_kindAccount,         "
            + "\n" + "       part                 AS t_part,                "
            + "\n" + "       isRepoAccount        AS t_isRepoAccount,       "
            + "\n" + "       isGD                 AS t_isGD,                "
            + "\n" + "       isResident           AS t_isClientResident,    "
            + "\n" + "       isExistCorrect       AS t_isExistCorrect,      "
            + "\n" + "       isThirdPerson        AS t_isThirdPerson,       "
            + "\n" + "       singDepending        AS t_singDepending,       "
            + "\n" + "       prolongationAmount   AS t_prolongationAmount,  "
            + "\n" + "       explanation          AS t_explanation,         "
            + "\n" + "       BIC                  AS t_BIC,                 "
            + "\n" + "       onerousClaim         AS t_onerousClaim,        "
            + "\n" + "       identifier           AS t_identifier,          "
            + "\n" + "       onerousClaimCategory AS t_onerousClaimCategory,"
            + "\n" + "       restLinkedAccount    AS t_restLinkedAccount,   "
            + "\n" + "       CASE                                           "
            + "\n" + "           WHEN redemptionDate IS NULL                "
            + "\n" + "           THEN " + getSqlDate(date(0,0,0))
            + "\n" + "           ELSE redemptionDate                        "
            + "\n" + "       END                  AS t_redemptionDate,      "
            + "\n" + "       linkedAccount        AS t_linkedAccount,       "
            + "\n" + "       onerousSign          AS t_onerousSign,         "
            + "\n" + "       swiftDepartment      AS t_swiftDepartment,     "
            + "\n" + "       conditionalCode      AS t_conditionalCode,     "
            + "\n" + "       otherDecoding        AS t_otherDecoding        "
            + "\n" + "  FROM (" + query + ")";
        return query;
    end;

    macro FillTempTable()
        SQL_Truncate("df501_tmp");

        var query = "INSERT INTO df501_tmp   "
           + "\n" + "(t_account,             "
           + "\n" + " t_accountId,           "
           + "\n" + " t_balance,             "
           + "\n" + " t_printedAccount,      "
           + "\n" + " t_clientName,          "
           + "\n" + " t_regNumber,           "
           + "\n" + " t_countryCode,         "
           + "\n" + " t_beginRest,           "
           + "\n" + " t_debet,               "
           + "\n" + " t_credit,              "
           + "\n" + " t_endRest,             "
           + "\n" + " t_perfomanceDate,      "
           + "\n" + " t_perfomanceDateDealId,"
           + "\n" + " t_perfomanceDateKliko, "
           + "\n" + " t_rate,                "
           + "\n" + " t_rateDealId,          "
           + "\n" + " t_clientCode,          "
           + "\n" + " t_partReport,          "
           + "\n" + " t_typeAccount,         "
           + "\n" + " t_kindAccount,         "
           + "\n" + " t_part,                "
           + "\n" + " t_isRepoAccount,       "
           + "\n" + " t_isGD,                "
           + "\n" + " t_isClientResident,    "
           + "\n" + " t_isExistCorrect,      "
           + "\n" + " t_isThirdPerson,       "
           + "\n" + " t_singDepending,       "
           + "\n" + " t_prolongationAmount,  "
           + "\n" + " t_explanation,         "
           + "\n" + " t_BIC,                 "
           + "\n" + " t_onerousClaim,        "
           + "\n" + " t_identifier,          "
           + "\n" + " t_onerousClaimCategory,"
           + "\n" + " t_restLinkedAccount,   "
           + "\n" + " t_redemptionDate,      "
           + "\n" + " t_linkedAccount,       "
           + "\n" + " t_onerousSign,         "
           + "\n" + " t_swiftDepartment,     "
           + "\n" + " t_conditionalCode,     "
           + "\n" + " t_otherDecoding        "
           + "\n" + ")                       "
           + "\n" + getQuery();

        sql_execute(query);
    end;

    macro SaveVariables( parameters:TParameters)
        var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
        profiler.clear();
        profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "SELECT * FROM df501_tmp WHERE t_PartReport = " + NumPart;
            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + ", t_ClientCode, t_PrintedAccount ";
                elif( parameters.m_SortClient == 5)
                    Query = Query + ", t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account ";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate",      V_DATE);
            dataSet.setFieldType("perfomanceDateKliko", V_DATE);
            dataSet.setFieldType("redemptionDate",      V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("ПризнакРЕПО").exact           = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакГД").exact             = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакТретьеЛицо").exact     = dataSet.isThirdPerson;
                CompositeValue.fieldValue("ПризнакИП").exact             = dataSet.isExistCorrect;
                CompositeValue.fieldValue("ПризнакРезидентности").exact  = dataSet.isClientResident;
                CompositeValue.fieldValue("НомЛС").exact                 = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact                 = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact              = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact                = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact                = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact                = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact               = dataSet.BeginRest;
                CompositeValue.fieldValue("ОбДебет").exact               = dataSet.debet;
                CompositeValue.fieldValue("ОбКредит").exact              = dataSet.credit;
                CompositeValue.fieldValue("ОстИсход").exact              = dataSet.EndRest;
                CompositeValue.fieldValue("ПризнакЗависимости").exact    = string(NVL(dataSet.singDepending,        ""));
                CompositeValue.fieldValue("КолПролонгаций").exact        = NVL(dataSet.prolongationAmount,          -1);
                CompositeValue.fieldValue("Пояснения").exact             = string(NVL(dataSet.explanation,          ""));
                CompositeValue.fieldValue("БИК").exact                   = string(NVL(dataSet.BIC,                  ""));
                CompositeValue.fieldValue("ЛицоПоОбрем").exact           = string(NVL(dataSet.onerousClaim,         ""));
                CompositeValue.fieldValue("ИдентификаторОбрем").exact    = string(NVL(dataSet.identifier,           ""));
                CompositeValue.fieldValue("ВидОбрем").exact              = string(NVL(dataSet.onerousClaimCategory, ""));
                CompositeValue.fieldValue("ОстатокПоСчетуОбрем").exact   = NVL(dataSet.restLinkedAccount,           0.0);
                CompositeValue.fieldValue("ДатаПогашения").exact         = string(NVL(dataSet.redemptionDate,       ""));
                if (dataSet.PerfomanceDate == null)
                    CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = String(ternary(dataSet.PerfomanceDate != Date(0,0,0), dataSet.PerfomanceDate,                ""));
                end;
                if (dataSet.PerfomanceDateKliko == null)
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = CompositeValue.fieldValue("ДатаИспОб").exact;
                else
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = String(ternary(dataSet.PerfomanceDateKliko != Date(0,0,0), dataSet.PerfomanceDateKliko, ""));
                end;
                CompositeValue.fieldValue("ПрСтавка").exact              = NVL(dataSet.Rate, 0.0);
                CompositeValue.fieldValue("КодКО").exact                 = NVL(dataSet.ClientCode,             "");
                CompositeValue.fieldValue("ТипЛС").exact                 = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact                 = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ПризнакОбременения").exact    = string(NVL(dataSet.onerousSign,     ""));
                CompositeValue.fieldValue("ФилиалСВИФТ").exact           = string(NVL(dataSet.swiftDepartment, ""));
                CompositeValue.fieldValue("УсловныйКод").exact           = string(NVL(dataSet.conditionalCode, ""));
                CompositeValue.fieldValue("ИноеРасшифровка").exact       = string(NVL(dataSet.otherDecoding,   ""));

                compositeValue.fieldValue("ОстатокПоСчетуОбрем").recalculateScaled();
                compositeValue.fieldValue("ОстВход").recalculateScaled();
                compositeValue.fieldValue("ОбДебет").recalculateScaled();
                compositeValue.fieldValue("ОбКредит").recalculateScaled();
                compositeValue.fieldValue("ОстИсход").recalculateScaled();
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =  "SELECT                                                                                            "
                + "\n" + "       data.t_id,                                                                                 "
                + "\n" + "       data.t_name,                                                                               "
                + "\n" + "       data.t_shortName,                                                                          "
                + "\n" + "       data.t_code,                                                                               "
                + "\n" + "       data.t_countryCode,                                                                        "
                + "\n" + "       data.t_isResident,                                                                         "
                + "\n" + "       CASE                                                                                       "
                + "\n" + "           WHEN data.t_isCentralBank = 1                                                          "
                + "\n" + "               THEN (SELECT t_code                                                                "
                + "\n" + "                       FROM dRepPartyCodes_vw codes                                               "
                + "\n" + "                      WHERE codes.t_partyId = data.t_id                                           "
                + "\n" + "                        AND codes.t_name    = 'БИК (ЦБ РФ)')                                      "
                + "\n" + "               WHEN data.t_isResident = 1                                                         "
                + "\n" + "               THEN                                                                               "
                + "\n" + "                   CASE                                                                           "
                + "\n" + "                       WHEN t_regNumber like '%/%'                                                "
                + "\n" + "                       THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)                     "
                + "\n" + "                       ELSE COALESCE(t_regNumber, CHR(1))                                         "
                + "\n" + "                   END                                                                            "
                + "\n" + "           ELSE                                                                                   "
                + "\n" + "               CASE                                                                               "
                + "\n" + "                   WHEN data.t_isswift = 1                                                        "
                + "\n" + "                       THEN COALESCE(t_regNumber, 'НР')                                           "
                + "\n" + "                       ELSE 'НР'                                                                  "
                + "\n" + "               END                                                                                "
                + "\n" + "       END AS t_regNumber                                                                         "
                + "\n" + "FROM                                                                                              "
                + "\n" + "   (SELECT                                                                                        "
                + "\n" + "           party.t_id,                                                                            "
                + "\n" + "           DECODE(party.t_isResident, 1, party.t_name, COALESCE((SELECT pn.t_name                 "
                + "\n" + "                                                                   FROM dPartyName_dbt pn         "
                + "\n" + "                                                                  WHERE pn.t_partyId    = party.t_id"
                + "\n" + "                                                                    AND pn.t_nameTypeId = 3       "
                + "\n" + "                                                                    AND ROWNUM < 2), party.t_name)) AS t_name,"
                + "\n" + "           party.t_shortName,                                                                     "
                + "\n" + "           party.t_isResident,                                                                    "
                + "\n" + "           party.t_isCentralBank,                                                                 "
                + "\n" + "           party.t_isswift,                                                                       "
                + "\n" + "           codes.t_code AS t_code,                                                                "
                + "\n" + "           codes.t_name AS t_nameCode,                                                            "
                + "\n" + "           COALESCE((SELECT country.t_CodeNum3                                                    "
                + "\n" + "                       FROM dcountry_dbt country                                                  "
                + "\n" + "                      WHERE country.t_CodeLat3 = (SELECT adr.t_country                            "
                + "\n" + "                                                    FROM dAdress_dbt adr                          "
                + "\n" + "                                                   WHERE adr.t_partyId = party.t_id               "
                + "\n" + "                                                     AND adr.t_type    = 2)),                     "
                + "\n" + "                    (CASE                                                                         "
                + "\n" + "                         WHEN (party.t_isResident = 0)                                            "
                + "\n" + "                             THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3"
                + "\n" + "                                                                                FROM dcountry_dbt "
                + "\n" + "                                                                               WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" + "                             ELSE COALESCE((SELECT t_CodeNum3                                     "
                + "\n" + "                                              FROM dcountry_dbt                                   "
                + "\n" + "                                             WHERE t_CodeLat3 = 'RUS'), CHR(1))                   "
                + "\n" + "                     END)) AS t_countryCode,                                                      "
                + "\n" + "           CASE                                                                                   "
                + "\n" + "               WHEN EXISTS (SELECT t_code FROM dRepPartyCodes_vw codes WHERE codes.t_partyId = party.t_id AND codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" + "                   THEN    (SELECT t_code FROM dRepPartyCodes_vw codes WHERE codes.t_partyId = party.t_id AND codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" + "                   ELSE CHR(1)                                                                    "
                + "\n" + "           END AS t_regNumber                                                                     "
                + "\n" + "      FROM dRepParty_vw      party,                                                               "
                + "\n" + "           dRepPartyCodes_vw codes,                                                               "
                + "\n" + "           dCountry_dbt      country                                                              "
                + "\n" + "     WHERE party.t_id = (SELECT codes.t_partyId                                                   "
                + "\n" + "                           FROM dRepPartyCodes_vw codes                                           "
                + "\n" + "                          WHERE codes.t_code = '" + customerCode + "'"
                + "\n" + "                            AND codes.t_name = 'Код')                                             "
                + "\n" + "       AND codes.t_name       = 'Код'                                                             "
                + "\n" + "       AND codes.t_partyId    = party.t_id                                                        "
                + "\n" + "       AND country.t_codeLat3 = party.t_countrycode                                               "
                + "\n" + ") data                                                                                            ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current               = NVL(dataSet.name,             "");
                    compositeValue.currentItem.fieldValue("РегНом").current               = NVL(dataSet.regNumber,        "");
                    compositeValue.currentItem.fieldValue("КодСтр").current               = NVL(dataSet.countryCode,      "");
                    compositeValue.currentItem.fieldValue("КодКО").current                = NVL(dataSet.id,               "");
                    compositeValue.currentItem.fieldValue("ПризнакРезидентности").current = NVL(dataSet.isClientResident, 1 );
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled();
                compositeValue.moveNext();
            end;

        end;

        SavePart(1, parameters);
        SavePart(2, parameters);
        savePartForManualInput(1, parameters);
        savePartForManualInput(2, parameters);
    end;

    macro updateSecuritiesAccount()
        if (TParameters().m_isSecuritiesData)
            ActualAccNoteFor501(rcbApplication().currentReport().context.period.BeginDate, rcbApplication().currentReport().context.period.EndDate);
        end;
    end;
end;

private class (TCalculator_4212) TCalculator_5586(report : RcbReport, tuneTable : RcbTuneTable, params : TParameters)
    initTCalculator_4212(report);

    private var m_parameters = params;

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account                                              account,     "
                   + "\n" + "       acc.t_accountId                                            accountId,   "
                   + "\n" + "       acc.t_fiid                                                 fiid,        "
                   + "\n" + "       acc.t_kind                                                 kindAccount, "
                   + "\n" + "       acc.t_chapter                                              chapter,     "
                   + "\n" + "       acc.t_balance                                              balance,     "
                   + "\n" + "       prt.t_id                                                   partyId,     "
                   + "\n" + "       DECODE(prt.t_isResident, 1, prt.t_name, COALESCE((SELECT pn.t_name                                  "
                   + "\n" + "                                                           FROM dPartyName_dbt pn                          "
                   + "\n" + "                                                          WHERE pn.t_partyId    = prt.t_id                 "
                   + "\n" + "                                                            AND pn.t_nameTypeId = 3                        "
                   + "\n" + "                                                            AND ROWNUM          < 2), prt.t_name)) AS name,"
                   + "\n" + "       prt.t_isResident                                           isResident,  "
                   + "\n" + "       COALESCE((SELECT adr.t_country                                          "
                   + "\n" + "                   FROM dAdress_dbt adr                                        "
                   + "\n" + "                  WHERE adr.t_partyId  = prt.t_id                              "
                   + "\n" + "                    AND adr.t_type     = 2                                     "
                   + "\n" + "                    AND adr.t_country != CHR(1)), prt.t_countryCode) nrCountry,"
                   + "\n" + "       acc.t_inCoverRest                                          BegRest,     "
                   + "\n" + "       acc.t_outCoverRest                                         EndRest,     "
                   + "\n" + "       COALESCE((SELECT sum(doc.t_incoversum)                                  "
                   + "\n" + "                   FROM drepdocumentwithcorrection_vw doc                      "
                   + "\n" + "                  WHERE doc.t_chapter      = acc.t_chapter                     "
                   + "\n" + "                    AND doc.t_debetaccount = acc.t_Account                     "
                   + "\n" + "                    AND doc.t_date        >= rep_data.getbegindate()           "
                   + "\n" + "                    AND doc.t_date        <= rep_data.getenddate()),0) Debet,  "
                   + "\n" + "       COALESCE((SELECT sum(t_incoversum)                                      "
                   + "\n" + "                   FROM drepdocumentwithcorrection_vw doc                      "
                   + "\n" + "                  WHERE doc.t_chapter       = acc.t_chapter                    "
                   + "\n" + "                    AND doc.t_creditaccount = acc.t_Account                    "
                   + "\n" + "                    AND doc.t_date         >= rep_data.getbegindate()          "
                   + "\n" + "                    AND doc.t_date         <= rep_data.getenddate()),0) Credit,"
                   + "\n" + "       acc.t_objectId                                              objectId,   "
                   + "\n" + "       acc.t_part                                                  part,       "
                   + "\n" + "       acc.t_typeAccount                                           typeAccount,"
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd                       operationEndDate,"
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN EXISTS (SELECT 1                                               "
                   + "\n" + "                          FROM drepCorrectionalDocument_vw iscorrect           "
                   + "\n" + "                         WHERE iscorrect.t_creditaccount = acc.t_account)      "
                   + "\n" + "           THEN 1                                                              "
                   + "\n" + "           ELSE 0                                                              "
                   + "\n" + "       END                                                      AS isexistcorrect,"
                   + "\n" + "       acc.t_isCategoryMarginSum                                   isCategoryMarginSum,"
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN prt.t_isresident = 1                                           "
                   + "\n" + "           THEN                                                                "
                   + "\n" + "               CASE                                                            "
                   + "\n" + "                   WHEN reppartycodes.t_code like '%/%'                        "
                   + "\n" + "                       THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                   + "\n" + "                   ELSE COALESCE(reppartycodes.t_code, CHR(1))                 "
                   + "\n" + "               END                                                             "
                   + "\n" + "           ELSE                                                                "
                   + "\n" + "               CASE                                                            "
                   + "\n" + "                   WHEN prt.t_isswift = 1                                      "
                   + "\n" + "                       THEN COALESCE(reppartycodes.t_code, 'НР')               "
                   + "\n" + "                   ELSE 'НР'                                                   "
                   + "\n" + "               END                                                             "
                   + "\n" + "       END                                                      AS regNumber,  "
                   //графа 13
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT     + ", "
                                                                                    + RCB_OBJGROUP_ACTIVEKIND + ", "
                                                                                    + "'Собств_Обременение',       "
                                                                                    + "acc.t_objectId,             "
                                                                                    + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN '11'                                                       " //Признак обременения первая цифра, остальное значение графы
                   + "\n" + "           ELSE COALESCE((SELECT CASE                                          "
                   + "\n" + "                                     WHEN NOT (    party.t_isPhisical = 1      "
                   + "\n" + "                                               AND party.t_isResident = 0)     "
                   + "\n" + "                                         THEN '9' || party.t_name              "
                   + "\n" + "                                     ELSE '0'                                  "
                   + "\n" + "                                 END AS t_name                                 "
                   + "\n" + "                            FROM dRepParty_vw         party,                   "
                   + "\n" + "                                 dRepLinkedObjects_vw objLink                  "
                   + "\n" + "                           WHERE party.t_objectId                = objLink.t_id"
                   + "\n" + "                             AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
                   + "\n" + "                             AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
                   + "\n" + "                             AND objLink.t_isInstalledForEndDate = 1           "
                   + "\n" + "                             AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "                             AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "                         ),                                                    "
                   + "\n" + "                         '0'                                                   "
                   + "\n" + "                        )                                                      "
                   + "\n" + "       END                                                         onerousClaim,"
                   //графа 14
                   + "\n" + "       CASE                                                                    "
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT     + ", "
                                                                                    + RCB_OBJGROUP_ACTIVEKIND + ", "
                                                                                    + "'Собств_Обременение',       "
                                                                                    + "acc.t_objectId,             "
                                                                                    + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   //Условный код первая цифра (если X - значит не заполяется), следующие 3 цифры - это код SWIFT (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
                   + "\n" + "               THEN 'XYYY'                                                          "
                   + "\n" + "           ELSE COALESCE((SELECT CASE                                               "
                   + "\n" + "                                     WHEN     party.t_isBank     = 1                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                         THEN (SELECT CASE                          "
                   + "\n" + "                                                          WHEN INSTR(codes.t_code, '/', 1, 1) != 0           "
                   + "\n" + "                                                              THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
                   + "\n" + "                                                          WHEN codes.t_code = ''                             "
                   + "\n" + "                                                              THEN 'X' || 'YYY' || codes.t_code              "
                   + "\n" + "                                                          ELSE '2' || 'YYY' || codes.t_code                  "
                   + "\n" + "                                                      END                           "
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes       "
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id)"

                   + "\n" + "                                     WHEN     party.t_isBank     = 1                "
                   + "\n" + "                                          AND party.t_isResident = 0                "
                   + "\n" + "                                         THEN (COALESCE((SELECT CASE                "
                   + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 8                             "
                   + "\n" + "                                                                        THEN '4' || 'XXX' || codes.t_code || 'XXX'            "
                   + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 11                            "
                   + "\n" + "                                                                        THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
                   + "\n" + "                                                                    ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
                   + "\n" + "                                                                END t_code                                                    "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes  "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))         "

                   + "\n" + "                                     WHEN     party.t_isPhisical = 0                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                         THEN (COALESCE((SELECT '1' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

                   + "\n" + "                                     WHEN party.t_isEmployer = 1                    "
                   + "\n" + "                                         THEN (COALESCE((SELECT '6' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

                   + "\n" + "                                     WHEN     party.t_isPhisical = 0                "
                   + "\n" + "                                          AND party.t_isResident = 0                "
                   + "\n" + "                                         THEN '3'|| 'YYY' || 'HP'                   "
                   + "\n" + "                                     WHEN     party.t_isPhisical = 1                "
                   + "\n" + "                                          AND party.t_isResident = 1                "
                   + "\n" + "                                          AND party.t_isEmployer = 0                "
                   + "\n" + "                                         THEN (COALESCE((SELECT '5' || 'YYY' || codes.t_code                        "
                   + "\n" + "                                                           FROM dRepPartyCodes_vw codes                             "
                   + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_INN
                   + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
                   + "\n" + "                                     ELSE 'X' || 'YYY' || ''                        "
                   + "\n" + "                                 END t_identifier                                   "
                   + "\n" + "                             FROM dRepLinkedObjects_vw link,                        "
                   + "\n" + "                                  dRepParty_vw         party                        "
                   + "\n" + "                            WHERE acc.t_objectId               = link.t_connectObjectId"
                   + "\n" + "                              AND party.t_objectId             = link.t_id          "
                   + "\n" + "                              AND link.t_isInstalledForEndDate = 1                  "
                   + "\n" + "                              AND link.t_connectObjectType     = 4                  "
                   + "\n" + "                              AND link.t_type                  = 3                  "
                   + "\n" + "                              AND link.t_role                  = 59                 "
                   + "\n" + "                         ),                                                         "
                   + "\n" + "                         'X' || 'YYY' || ''                                         "
                   + "\n" + "                        )                                                           "
                   + "\n" + "       END                                                                 identifier,"
                   //графа 15
                   + "\n" + "       (SELECT CASE category.t_value                                           "
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда")             + " THEN " + getSqlString("1")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит")           + " THEN " + getSqlString("2")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз")          + " THEN " + getSqlString("4")
                   + "\n" + "                    ELSE " + getSqlString("")
                   + "\n" + "               END                                                             "
                   + "\n" + "          FROM dRepCategory_vw      category,                                  "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE category.t_id         = " + RCB_OBJGROUP_FOR_REPORTING
                   + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND category.t_value = ANY(" + getSqlString("Обрем_Ссуда")             + ","
                   + "\n" + "                                      " + getSqlString("Обрем_Депозит")           + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ДолгОбязательство") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ИноеОбяз")          + ""
                   + "\n" + "                                     )"
                   + "\n" + "           AND category.t_isInstalledForEndDate = 1                            "
                   + "\n" + "           AND category.t_objectId              = objLink.t_id                 "
                   + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1                            "
                   + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId               "
                   + "\n" + "       ) onerousClaimCategory,                                                 "
                   //графа 16
                   + "\n" + "       (SELECT acc2.t_outCoverRest                                             "
                   + "\n" + "          FROM dRepAccount_vw       acc2,                                      "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))          "
                   + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                       "
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) restLinkedAccount,                                                    "
                   + "\n" + "       (SELECT SUBSTR(objLink.t_id, 10)                                        "
                   + "\n" + "          FROM dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) linkedAccount,                                                        "
                   //графа 17
                   + "\n" + "       (SELECT rep_note.getDateAccountNote(acc2.t_objectId, 16,                "
                                                                        + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
                   + "\n" + "          FROM dRepAccount_vw       acc2,                                      "
                   + "\n" + "               dRepLinkedObjects_vw objLink                                    "
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))          "
                   + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                       "
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                             "
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                "
                   + "\n" + "       ) redemptionDate                                                        "
                          ;

        //Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
        queryForData = queryForData
                   + "\n" + "  FROM accountTable acc,                                                       "
                   + "\n" + "       drepparty_vw prt,                                                       "
                   + "\n" + "       (SELECT *                                                               "
                   + "\n" + "          FROM dreppartycodes_vw partyсode,                                    "
                   + "\n" + "               drepparty_vw      repparty_                                     "
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId                            "
                   + "\n" + "               -- для центробанка БИК (ЦБ РФ)                                  "
                   + "\n" + "           AND (  (    repparty_.t_isCentralBank = 1                           "
                   + "\n" + "                   AND partyсode.t_codekind      = " + RCB_PTCK_BIC + ")       "
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'   "
                   + "\n" + "           OR (  (     repparty_.t_isResident = 0                              "
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_SWIFT + ")        "
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'              "
                   + "\n" + "               OR (    repparty_.t_isResident    = 1                           "
                   + "\n" + "                   AND repparty_.t_isCentralBank = 0                           "
                   + "\n" + "                   AND partyсode.t_codekind      = " + RCB_PTCK_BANKREGNUM + ")))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = acc.t_contragentId                                           "
                   + "\n" + "   AND prt.t_id = reppartycodes.t_partyid(+)                                   "
                   // Специфичные условия для разных разделов отчета
                   + "\n" + "   AND (        acc.t_part              = 1                                             "
                   + ternary(m_parameters.m_isExcludeDiscountByPpt,
                     "\n" + "            AND CASE                                                                    "
                   + "\n" + "                    WHEN acc.t_balance IN ('32030','32130','32230','32330')             "
                   + "\n" + "                        THEN CASE                                                       "
                   + "\n" + "                                 WHEN     SUBSTR(acc.t_account,15,1) = '2'              "
                   + "\n" + "                                      AND acc.t_isCategoryDiscount   =  1               "
                   + "\n" + "                                     THEN 0                                             "
                   + "\n" + "                                 WHEN acc.t_isRepCategDiscount != 0                     "
                   + "\n" + "                                     THEN 0                                             "
                   + "\n" + "                                 ELSE 1                                                 "
                   + "\n" + "                             END                                                        "
                   + "\n" + "                    ELSE 1                                                              "
                   + "\n" + "                END = 1                                                                 ",
                     "\n" + "            AND 1=1                                                                     ")
                   + ternary(m_parameters.m_isExcludeBonusByPpt,
                     "\n" + "            AND CASE                                                                    "
                   + "\n" + "                    WHEN acc.t_balance IN ('32030','32130','32230','32330')             "
                   + "\n" + "                        THEN CASE                                                       "
                   + "\n" + "                                 WHEN     SUBSTR(acc.t_account,15,1) = '1'              "
                   + "\n" + "                                      AND acc.t_isCategoryBonus      =  1               "
                   + "\n" + "                                     THEN 0                                             "
                   + "\n" + "                                 WHEN acc.t_isRepCategBonus != 0                        "
                   + "\n" + "                                     THEN 0                                             "
                   + "\n" + "                                 ELSE 1                                                 "
                   + "\n" + "                             END                                                        "
                   + "\n" + "                    ELSE 1                                                              "
                   + "\n" + "                END = 1                                                                 ",
                     "\n" + "            AND 1=1                                                                     ")
                   + "\n" + "        OR  acc.t_part != 1                                                             "
                   + "\n" + "       )                                                                                "
                   ;

        return QueryForData;
    end;

    private macro getQuery()
        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        var query =  "SELECT account,                                                                   "
            + "\n" + "       accountId,                                                                 "
            + "\n" + "       SUBSTR(balance, 1, 5) bal,                                                 "
            + "\n" + "       name,                                                                      "
            + "\n" + "       regNumber,                                                                 "
            + "\n" + "       DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry)) countryCode,"
            + "\n" + "       begRest,                                                                   "
            + "\n" + "       debet,                                                                     "
            + "\n" + "       credit,                                                                    "
            + "\n" + "       endRest,                                                                   "
            + "\n" + "       objectId,                                                                  "
            + "\n" + "       operationEndDate,                                                          "
            + "\n" + "       partyID,                                                                   "
            + "\n" + "       part,                                                                      "
            + "\n" + "       typeAccount,                                                               "
            + "\n" + "       kindAccount,                                                               "
            + "\n" + "       chapter,                                                                   "
            + "\n" + "       isexistcorrect,                                                            "
            + "\n" + "       isCategoryMarginSum,                                                       "
            + "\n" + "       isResident,                                                                "
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN    (" + convertMaskToSQLFormat(m_BalanceList, "balance")  + ")"
            + "\n" + "                OR (" + convertMaskToSQLFormat("32401, 32402", "balance") + ")"
            + "\n" + "           THEN CASE                                                              "
            + "\n" + "                    WHEN endRest = 0                                              "
            + "\n" + "                         AND (   (begRest != 0)                                   "
            + "\n" + "                              OR (credit != 0)                                    "
            + "\n" + "                              OR (debet != 0)                                     "
            + "\n" + "                             )                                                    "
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)                                  "
            + "\n" + "                            FROM drepdocument_vw doc                              "
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND ((    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId)      "
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId)       "
            + "\n" + "                                 )                                                "
            + "\n" + "                         )                                                        "
            + "\n" + "                    WHEN endRest != 0                                             "
            + "\n" + "                    THEN NULL                                                     "
            + "\n" + "                END                                                               "
            + "\n" + "           ELSE CASE                                                              "
            + "\n" + "                    WHEN (   (" + ternary(TParameters().m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1                                 "
            + "\n" + "                                           FROM mmDeals                           "
            + "\n" + "                                          WHERE mmDeals.t_part = part             "
            + "\n" + "                                            AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )                                         "
            + "\n" + "                         )                                                        "
            + "\n" + "                    THEN COALESCE(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "), operationEndDate," + getSqlDate(Date(0,0,0)) + ")"
            + "\n" + "                    ELSE COALESCE((SELECT MAX(mmDeals.t_plannedFinishDate)        "
            + "\n" + "                                     FROM mmDeals                                 "
            + "\n" + "                                    WHERE mmDeals.t_part = part                   "
            + "\n" + "                                      AND account        = mmDeals.t_mainRestAccount"
            + "\n" + "                                  )," + getSqlDate(Date(0,0,0))
            + "\n" + "                                 )                                                "
            + "\n" + "                END                                                               "
            + "\n" + "       END                                                                  AS perfomanceDate,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ") OR (" + convertMaskToSQLFormat("32401, 32402", "balance") + ")"
            + "\n" + "           THEN 0                                                                 "
            + "\n" + "           ELSE CASE                                                              "
            + "\n" + "                    WHEN (   (" + ternary(m_parameters.m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1                                 "
            + "\n" + "                                           FROM mmDeals                           "
            + "\n" + "                                          WHERE mmDeals.t_part = part             "
            + "\n" + "                                            AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )                                         "
            + "\n" + "                         )                                                        "
            + "\n" + "                    THEN 0                                                        "
            + "\n" + "                    ELSE COALESCE((SELECT deal.t_id                               "
            + "\n" + "                                     FROM mmDeals deal                            "
            + "\n" + "                                    WHERE deal.t_part              = part         "
            + "\n" + "                                      AND deal.t_mainRestAccount   = account      "
            + "\n" + "                                      AND deal.t_plannedFinishDate = COALESCE((SELECT MAX(maxDate.t_plannedFinishDate)                  "
            + "\n" + "                                                                                 FROM mmDeals maxDate                                   "
            + "\n" + "                                                                                WHERE maxDate.t_part            = deal.t_part           "
            + "\n" + "                                                                                  AND maxDate.t_mainRestAccount = deal.t_mainRestAccount"
            + "\n" + "                                                                              )," + getSqlDate(Date(0,0,0))
            + "\n" + "                                                                             )    "
            + "\n" + "                                  ), 0)                                           "
            + "\n" + "                END                                                               "
            + "\n" + "       END                                                                  AS perfomanceDateDealId,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN CASE                                                              "
            + "\n" + "                    WHEN     endRest = 0                                          "
            + "\n" + "                         AND (   (begRest != 0)                                   "
            + "\n" + "                              OR (credit  != 0)                                   "
            + "\n" + "                              OR (debet   != 0)                                   "
            + "\n" + "                             )                                                    "
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)                                  "
            + "\n" + "                            FROM drepdocument_vw doc                              "
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND (   (    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId)"
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId)"
            + "\n" + "                                 )                                                "
            + "\n" + "                         )                                                        "
            + "\n" + "                    WHEN endRest != 0                                             "
            + "\n" + "                    THEN NULL --использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
            + "\n" + "                END                                                               "
            + "\n" + "           ELSE NULL --в экспорте использовать perfomanceDate                     "
            + "\n" + "       END                                                                  AS perfomanceDateKliko,"
            + "\n" + "       CASE                                                                       "
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN NULL                                                              "
            + "\n" + "           WHEN (   (" + ternary(m_parameters.m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1                                          "
            + "\n" + "                                  FROM mmDeals                                    "
            + "\n" + "                                 WHERE mmDeals.t_part = part                      "
            + "\n" + "                                   AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                               )                                                  "
            + "\n" + "                )                                                                 "
            + "\n" + "           THEN COALESCE(rep_note.readRate(data.objectId," + SQL_END_DATE + "), 0)"
            + "\n" + "           ELSE (SELECT CASE                                                      "
            + "\n" + "                            WHEN mmDeals.t_isOverNight = 1                        "
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount                  "
            + "\n" + "                                             *(SELECT rateHistory.t_rate          "
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory                                "
            + "\n" + "                                                WHERE rateHistory.t_dealId      = deals.t_id                             "
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7                                      "
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh        "
            + "\n" + "                                                                                 WHERE rh.t_dealId      = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7              "
            + "\n" + "                                                                                   AND rh.t_rateDate   <= " + SQL_END_DATE
            + "\n" + "                                                                               )                                         "
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,                                           "
            + "\n" + "                                                         rateHistory.t_rate                                              "
            + "\n" + "                                              )                                                                          "
            + "\n" + "                                            )                                                                            "
            + "\n" + "                                       / SUM(deals.t_dealAmount)                                                         "
            + "\n" + "                                    FROM repMmDeals_vw deals                                                             "
            + "\n" + "                                   WHERE deals.t_kind = mmDeals.t_kind                                                   "
            + "\n" + "                                     AND (   (mmDeals.t_mainRestAccount   = deals.t_mainRestAccount)                     "
            + "\n" + "                                          OR (mmDeals.t_delaydMainRestAcc = deals.t_delaydMainRestAcc))                  "
            + "\n" + "                                     AND deals.t_contragentId = mmDeals.t_contragentId                                   "
            + "\n" + "                                     AND (   deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                          OR (    deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )                                                                           "
            + "\n" + "                                         )                                                                               "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                            WHEN     mmDeals.t_isOverNight     != 1                                                      "
            + "\n" + "                                 AND mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount                                                         "
            + "\n" + "                                             *(SELECT rateHistory.t_rate                                                 "
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory                                "
            + "\n" + "                                                WHERE rateHistory.t_dealId      = deals.t_id                             "
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7                                      "
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh        "
            + "\n" + "                                                                                 WHERE rh.t_dealId      = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7              "
            + "\n" + "                                                                                   AND rh.t_rateDate   <= " + SQL_END_DATE
            + "\n" + "                                                                               )                                         "
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,                                           "
            + "\n" + "                                                         rateHistory.t_rate                                              "
            + "\n" + "                                              )                                                                          "
            + "\n" + "                                            )                                                                            "
            + "\n" + "                                       / SUM(deals.t_dealAmount)                                                         "
            + "\n" + "                                    FROM repMmDeals_vw deals                                                             "
            + "\n" + "                                   WHERE (   (   deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )                                                                           "
            + "\n" + "                                          OR deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                         )                                                                               "
            + "\n" + "                                     AND deals.t_mainRestAccount = mmDeals.t_mainRestAccount                             "
            + "\n" + "                                 CONNECT BY PRIOR deals.t_id = deals.t_prolongingDealId                                  "
            + "\n" + "                                   START WITH deals.t_id     = mmDeals.t_id                                              "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                            ELSE (SELECT rateHistory.t_rate                                                              "
            + "\n" + "                                    FROM repMmDealRateHistory_vw rateHistory                                             "
            + "\n" + "                                   WHERE rateHistory.t_dealId      = mmDeals.t_id                                        "
            + "\n" + "                                     AND rateHistory.t_percentKind = 7                                                   "
            + "\n" + "                                     AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                             "
            + "\n" + "                                                                     FROM repMmDealRateHistory_vw rh                     "
            + "\n" + "                                                                    WHERE rh.t_dealId      = rateHistory.t_dealId        "
            + "\n" + "                                                                      AND rh.t_percentKind = 7                           "
            + "\n" + "                                                                      AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                  )                                                      "
            + "\n" + "                                   GROUP BY rateHistory.t_dealId,                                                        "
            + "\n" + "                                            rateHistory.t_rate                                                           "
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                        END AS t_rate"
            + "\n" + "                   FROM mmDeals                                                                                          "
            + "\n" + "                  WHERE mmDeals.t_part = part                                                                            "
            + "\n" + "                    AND account        = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)                    "
            + "\n" + "                    AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                                           "
            + "\n" + "                                          FROM mmDeals maxId                                                             "
            + "\n" + "                                         WHERE maxId.t_part = mmDeals.t_part                                             "
            + "\n" + "                                           AND (   (mmDeals.t_mainRestAccount   = maxId.t_mainRestAccount)               "
            + "\n" + "                                                OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc))            "
            + "\n" + "                                           AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)      "
            + "\n" + "                                                                              FROM mmDeals maxDate                       "
            + "\n" + "                                                                             WHERE maxDate.t_part = maxId.t_part         "
            + "\n" + "                                                                               AND (   (maxId.t_mainRestAccount   = maxDate.t_mainRestAccount)   "
            + "\n" + "                                                                                    OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc))"
            + "\n" + "                                                                           )                                             "
            + "\n" + "                                       )                                                                                 "
            + "\n" + "                )                                                                                                        "
            + "\n" + "       END                                                                  AS rate,                                     "
            + "\n" + "       CASE                                                                                                              "
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN 0                                                                                                        "
            + "\n" + "           WHEN (   (" + ternary(m_parameters.m_isMmData, "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1                                                                                 "
            + "\n" + "                                  FROM mmDeals                                                                           "
            + "\n" + "                                 WHERE mmDeals.t_part = part                                                             "
            + "\n" + "                                   AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)             "
            + "\n" + "                               )                                                                                         "
            + "\n" + "                )                                                                                                        "
            + "\n" + "           THEN 0                                                                                                        "
            + "\n" + "           ELSE COALESCE((SELECT mmDeals.t_id                                                                            "
            + "\n" + "                            FROM mmDeals                                                                                 "
            + "\n" + "                           WHERE mmDeals.t_part = part                                                                   "
            + "\n" + "                             AND account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)                   "
            + "\n" + "                             AND (   mmDeals.t_isOverNight      = 1                                                      "
            + "\n" + "                                  OR mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                                 )                                                                                       "
            + "\n" + "                             AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                                  "
            + "\n" + "                                                   FROM mmDeals maxId                                                    "
            + "\n" + "                                                  WHERE maxId.t_part = mmDeals.t_part                                    "
            + "\n" + "                                                    AND (   (mmDeals.t_mainRestAccount   = maxId.t_mainRestAccount)      "
            + "\n" + "                                                         OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc))   "
            + "\n" + "                                                    AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)"
            + "\n" + "                                                                                       FROM mmDeals maxDate              "
            + "\n" + "                                                                                      WHERE maxDate.t_part = maxId.t_part"
            + "\n" + "                                                                                        AND (   (maxId.t_mainRestAccount   = maxDate.t_mainRestAccount)   "
            + "\n" + "                                                                                             OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc))"
            + "\n" + "                                                                                    )                                    "
            + "\n" + "                                                )                                                                        "
            + "\n" + "                         ), 0)                                                                                           "
            + "\n" + "       END                                                                  AS rateDealId                                "
                   ;

            query = query + addRelationsQuery();

            // Начало запроса. Формирование подзапросов на представления ГК и МБК. Отбор данных по условиям соответствия
            query =  ""
            + "\n" + "WITH tune                                                             "
            + "\n" + "  AS (" + m_tuneTable.getQuery() + "),"
            + "\n" + "  accountSrcTable                                                     "
            + "\n" + "  AS (SELECT acc.t_chapter,      acc.t_account,                       "
            + "\n" + "             acc.t_accountId,    acc.t_fiId,                          "
            + "\n" + "             acc.t_kind,         acc.t_balance,                       "
            + "\n" + "             acc.t_inCoverRest,  acc.t_outCoverRest,                  "
            + "\n" + "             acc.t_objectId,     acc.t_operationDate,                 "
            + "\n" + "             acc.t_daysToEnd,    acc.t_partyId,                       "
            + "\n" + "             acc.t_contragentId, t501.t_Part,                         "
            + "\n" + "             CASE t501.t_TypeAccount                                  "
            + "\n" + "                 WHEN " + SQL_TYPE_1_CODE
            + "\n" + "                 THEN 1                                               "
            + "\n" + "                 ELSE 2                                               "
            + "\n" + "             END t_typeAccount,                                       "
            + "\n" + "             rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", "
                                                                      + RCB_OBJGROUP_FOR_REPORTING
                                                                      + ", 'Дисконт по ППТ', acc.t_objectId,       "
                                                                      + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                      + ")                  t_isRepCategDiscount,       "
            + "\n" + "             rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", "
                                                                      + RCB_OBJGROUP_FOR_REPORTING
                                                                      + ", 'Премия по ППТ', acc.t_objectId,        "
                                                                      + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                      + ")                  t_isRepCategBonus,          "
            // 272109
            + "\n" + "             COALESCE(accWithCatMarginSum.t_isCategoryMarginSum, 0)   t_isCategoryMarginSum,  "
            + "\n" + "             COALESCE(accWithCatMarginSum.t_isCategoryDiscount,  0)   t_isCategoryDiscount,   "
            + "\n" + "             COALESCE(accWithCatMarginSum.t_isCategoryBonus,     0)   t_isCategoryBonus       "
            + "\n" + "        FROM drepaccount_vw                        acc,               "
            + "\n" + "             tune                                  t501,              "
            // 272109
            // аналог функции CheckCategoryForAccount, только интегрированной в основной запрос
            // поле t_isCategoryMarginSum будет проверяться и если значение в этом поле будет равно 1, то если процентная ставка
            // будет меньше нуля, она будет записана, как 0.
            + "\n" + "             (SELECT acc2.t_accountId,                                                    "
            + "\n" + "                     MAX(mcaccwithcat.t_isCategoryMarginSum) AS t_isCategoryMarginSum,    "
            + "\n" + "                     MAX(mcaccwithcat.t_isCategoryDiscount)  AS t_isCategoryDiscount,     "
            + "\n" + "                     MAX(mcaccwithcat.t_isCategoryBonus)     AS t_isCategoryBonus         "
            + "\n" + "                FROM daccount_dbt                       acc2,                             "
            + "\n" + "                     (SELECT mcacc.t_account,                                             "
            + "\n" + "                             mcacc.t_currency,                                            "
            + "\n" + "                             mcacc.t_chapter,                                             "
            + "\n" + "                             CASE                                                         "
            + "\n" + "                                 WHEN cat.t_code IN ('-МС','+МС')                         "
            + "\n" + "                                     THEN 1                                               "
            + "\n" + "                                 ELSE 0                                                   "
            + "\n" + "                             END            AS t_isCategoryMarginSum,                     "
            + "\n" + "                             CASE                                                         "
            + "\n" + "                                 WHEN cat.t_code = 'Дисконт_ПТ'                           "
            + "\n" + "                                     THEN 1                                               "
            + "\n" + "                                 ELSE 0                                                   "
            + "\n" + "                             END            AS t_isCategoryDiscount,                      "
            + "\n" + "                             CASE                                                         "
            + "\n" + "                                 WHEN cat.t_code = 'Премия_ПТ'                            "
            + "\n" + "                                     THEN 1                                               "
            + "\n" + "                                 ELSE 0                                                   "
            + "\n" + "                             END            AS t_isCategoryBonus                          "
            + "\n" + "                        FROM dmcaccdoc_dbt mcacc,                                         "
            + "\n" + "                             dmccateg_dbt  cat                                            "
            + "\n" + "                       WHERE mcacc.t_catId = cat.t_id                                     "
            + "\n" + "                         AND cat.t_code IN ('-МС','+МС','Дисконт_ПТ','Премия_ПТ')) mcaccwithcat"
            + "\n" + "               WHERE mcaccwithcat.t_account  = acc2.t_account                             "
            + "\n" + "                 AND mcaccwithcat.t_currency = acc2.t_code_currency                       "
            + "\n" + "                 AND mcaccwithcat.t_chapter  = acc2.t_chapter                             "
            + "\n" + "               GROUP BY acc2.t_accountId                                                  "
            + "\n" + "             )                                          accWithCatMarginSum               "
            + "\n" + "       WHERE acc.t_accountId = accWithCatMarginSum.t_accountId(+)                         "
            + "\n" + "         AND acc.t_isOpened       = 1                                                     "
            + "\n" + "         AND acc.t_chapter        = 1                                                     "
            + "\n" + "         AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, acc.t_account) = 1"
            + "\n" + "         AND rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT        + ", "
                                                                          + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО ч/з ЦК', acc.t_objectId, "
                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT        + ", "
                                                                          + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "         AND (   (    (SELECT party.t_isBank                          "
            + "\n" + "                         FROM dRepParty_vw party                      "
            + "\n" + "                        WHERE party.t_id = acc.t_contragentId         "
            + "\n" + "                      ) = 1                                           "
            + "\n" + "                   AND EXISTS(SELECT 1                                "
            + "\n" + "                                FROM dRepParty_vw party               "
            + "\n" + "                               WHERE party.t_id = acc.t_contragentId  "
            + "\n" + "                                 AND party.t_bankRegNumber IS NOT NULL" // код "Рег. номер кред. орг-ции" в представлении dRepParty_vw равен NULL, если дата закрытия <= ДООП
            + "\n" + "                             )                                        "
            + "\n" + "                 )                                                    "
            + "\n" + "              OR (SELECT party.t_isBank                               "
            + "\n" + "                    FROM dRepParty_vw party                           "
            + "\n" + "                   WHERE party.t_id         = acc.t_contragentId      "
            + "\n" + "                     AND party.t_isResident = 0                       "
            + "\n" + "                 ) = 1                                                "
            + "\n" + "              OR (SELECT party.t_isCentralBank                        "
            + "\n" + "                    FROM dRepParty_vw party                           "
            + "\n" + "                   WHERE party.t_id = acc.t_contragentId              "
            + "\n" + "                 ) = 1                                                "
            + "\n" + "             )                                                        "
            + "\n" + "     ),                                                               "
            + "\n" + "  mmDeals                                                             "
                   + ternary(m_parameters.m_isMmData,
              "\n" + "  AS (SELECT deals.t_id,                                             "
            + "\n" + "             deals.t_mainRestAccount,                                "
            + "\n" + "             deals.t_delaydMainRestAcc,                              "
            + "\n" + "             deals.t_plannedFinishDate,                              "
            + "\n" + "             deals.t_isOverNight,                                    "
            + "\n" + "             deals.t_kind,                                           "
            + "\n" + "             deals.t_contragentId,                                   "
            + "\n" + "             deals.t_isProlongingDeal,                               "
            + "\n" + "             CASE deals.t_kind                                       "
            + "\n" + "                 WHEN 'Размещение ' THEN 1                           "
            + "\n" + "                 WHEN 'Привлечение' THEN 2                           "
            + "\n" + "                 ELSE 0                                              "
            + "\n" + "             END t_part                                              "
            + "\n" + "        FROM repMmDeals_vw deals                                     "
            + "\n" + "       WHERE deals.t_kind IN ('Размещение ', 'Привлечение')          "
            + "\n" + "         AND deals.t_isOpened = 1                                    "
            + "\n" + "     ),                                                              ",
              "\n" + "  AS (SELECT 0                                AS t_id,               "
            + "\n" + "             CHR(1)                           AS t_mainRestAccount,  "
            + "\n" + "             CHR(1)                           AS t_delaydMainRestAcc,"
            + "\n" + "         " + getSQLDate(Date(0, 0, 0)) + "    AS t_plannedFinishDate,"
            + "\n" + "             0                                AS t_isOverNight,      "
            + "\n" + "             CHR(1)                           AS t_kind,             "
            + "\n" + "             0                                AS t_contragentId,     "
            + "\n" + "             CHR(1)                           AS t_isProlongingDeal, "
            + "\n" + "             0                                AS t_part              "
            + "\n" + "        FROM DUAL                                                    "
            + "\n" + "     ),                                                              ")
            + "\n" + "  accountTable                                                       "
            + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *                                     "
            + "\n" + "        FROM accountSrcTable                                         "
            + "\n" + "     )                                                               "
            + "\n" + "SELECT *                                                             "
            + "\n" + "  FROM (" + query + ")"
            + "\n" + " WHERE begRest <> 0                                                  "
            + "\n" + "    OR debet   <> 0                                                  "
            + "\n" + "    OR credit  <> 0                                                  "
            + "\n" + "    OR endRest <> 0                                                  ";

            // еще одно перечисление полей, для более удобного использования и наглядности
            // плюс идет одно условие, которое перешло из функции FillTempTable(), связанное с процентами
            // В ТЗ Securities оно звучит примерно так: Если в результате расчета значение средневзвешенной процентной ставки < 0, то в отчет  выводится значение 0
            // Такая проверка необходима, только если на счете присутствует категория учета "+МС" или "-МС", поэтому
            // было приятно решение реализовать это условие в рамках основного запроса
        query =      "SELECT account              AS t_account,             "
            + "\n" + "       accountId            AS t_accountId,           "
            + "\n" + "       bal                  AS t_balance,             "
            + "\n" + "       account              AS t_printedAccount,      "
            + "\n" + "       name                 AS t_clientName,          "
            + "\n" + "       regNumber            AS t_regNumber,           "
            + "\n" + "       countryCode          AS t_countryCode,         "
            + "\n" + "       begRest              AS t_beginRest,           "
            + "\n" + "       debet                AS t_debet,               "
            + "\n" + "       credit               AS t_credit,              "
            + "\n" + "       endRest              AS t_endRest,             "
            + "\n" + "       perfomanceDate       AS t_perfomanceDate,      "
            + "\n" + "       perfomanceDateDealId AS t_perfomanceDateDealId,"
            + "\n" + "       perfomanceDateKliko  AS t_perfomanceDateKliko, "
            + "\n" + "       CASE                                           "
            + "\n" + "           WHEN isCategoryMarginSum = 1               "
            + "\n" + "           THEN CASE                                  "
            + "\n" + "                    WHEN rate > 0                     "
            + "\n" + "                    THEN rate                         "
            + "\n" + "                    ELSE 0                            "
            + "\n" + "                END                                   "
            + "\n" + "           ELSE rate                                  "
            + "\n" + "       END                  AS t_rate,                "
            + "\n" + "       rateDealId           AS t_rateDealId,          "
            + "\n" + "       partyID              AS t_clientCode,          "
            + "\n" + "       part                 AS t_partReport,          "
            + "\n" + "       typeAccount          AS t_typeAccount,         "
            + "\n" + "       kindAccount          AS t_kindAccount,         "
            + "\n" + "       part                 AS t_part,                "
            + "\n" + "       isRepoAccount        AS t_isRepoAccount,       "
            + "\n" + "       isGD                 AS t_isGD,                "
            + "\n" + "       isResident           AS t_isClientResident,    "
            + "\n" + "       isExistCorrect       AS t_isExistCorrect,      "
            + "\n" + "       isThirdPerson        AS t_isThirdPerson,       "
            + "\n" + "       singDepending        AS t_singDepending,       "
            + "\n" + "       prolongationAmount   AS t_prolongationAmount,  "
            + "\n" + "       explanation          AS t_explanation,         "
            + "\n" + "       BIC                  AS t_BIC,                 "
            + "\n" + "       onerousClaim         AS t_onerousClaim,        "
            + "\n" + "       identifier           AS t_identifier,          "
            + "\n" + "       onerousClaimCategory AS t_onerousClaimCategory,"
            + "\n" + "       restLinkedAccount    AS t_restLinkedAccount,   "
            + "\n" + "       CASE                                           "
            + "\n" + "           WHEN redemptionDate IS NULL                "
            + "\n" + "           THEN " + getSqlDate(date(0,0,0))
            + "\n" + "           ELSE redemptionDate                        "
            + "\n" + "       END                  AS t_redemptionDate,      "
            + "\n" + "       linkedAccount        AS t_linkedAccount,       "
            + "\n" + "       onerousSign          AS t_onerousSign,         "
            + "\n" + "       swiftDepartment      AS t_swiftDepartment,     "
            + "\n" + "       conditionalCode      AS t_conditionalCode,     "
            + "\n" + "       otherDecoding        AS t_otherDecoding        "
            + "\n" + "  FROM (" + query + ")";
        return query;
    end;
end;

private class (TCalculator_4212) TCalculator_5456(report : RcbReport, tuneTable : RcbTuneTable, params : TParameters)
    private var m_parameters = params;

    private macro AnalyzeTurnTable()
        // Не используется
    end;

    macro removeVariables()
        private macro RemoveCompositValues(name:string)

            var iterator = m_report.AttributeValue(name).CreateValueIterator();
            var idList = TArray();
            var i;

            i = 0;
            iterator.moveFirst();
            while(not iterator.isDone())
                if( iterator.currentItem.valueId != 0 )
                    idList(i) = iterator.currentItem.valueId;
                    i = i + 1;
                end;
                iterator.moveNext();
            end;

            i = 0;
            while(i < idList.size())
                m_report.AttributeValue(name).removeValue(idList(i));
                i = i + 1;
            end;
        end;
        RemoveCompositValues("Ф501_1");
        RemoveCompositValues("Ф501_2");
        RemoveCompositValues("Ф501_3");
        RemoveCompositValues("Ф501_1Пояснения");
        RemoveCompositValues("Ф501_3Пояснения");
        RcbApplication().transactionManager.Commit();
    end;

    private macro cacheSecuritiesData()
        // Представление repSecuritiesAccounts_vw обернуто в запрос с группировкой, что бы избежать ситуации
        // когда в данном представлении есть более одной записи на один счет.
        // Сама по себе подобная ситуация не должна происходить (на один счет более одной записи в представлении)
        // однако на тестовых БД подобная ситуация возникает.
        var query =
                 "INSERT INTO df501Securities_tmp                                  "
        + "\n" + "(t_account,                                                      "
        + "\n" + " t_accountId,                                                    "
        + "\n" + " t_contragentId,                                                 "
        + "\n" + " t_openDate,                                                     "
        + "\n" + " t_debtDate,                                                     "
        + "\n" + " t_rate,                                                         "
        + "\n" + " t_isDebtRepo,                                                   "
        + "\n" + " t_isDebtCentralCounterParty,                                    "
        + "\n" + " t_isSecurities                                                  "
        + "\n" + ")                                                                "
        + "\n" + "SELECT accSecur.t_account,                                       "
        + "\n" + "       accSecur.t_accountId,                                     "
        + "\n" + "       accSecur.t_contragentId,                                  "
        + "\n" + "       MAX(accSecur.t_openDate)              AS t_openDate,      "
        + "\n" + "       MAX(accSecur.t_debtDate)              AS t_debtDate,      "
        + "\n" + "       MAX(accSecur.t_rate)                  AS t_rate,          "
        + "\n" + "       accSecur.t_isDebtRepo,                                    "
        + "\n" + "       accSecur.t_isDebtCentralCounterparty,                     "
        + "\n" + "       1                                     AS t_isSecurities   "
        + "\n" + "  FROM repSecuritiesAccounts_vw accSecur                         "
        + "\n" + " GROUP BY accSecur.t_account,                                    "
        + "\n" + "          accSecur.t_accountId,                                  "
        + "\n" + "          accSecur.t_contragentId,                               "
        + "\n" + "          accSecur.t_isDebtRepo,                                 "
        + "\n" + "          accSecur.t_isDebtCentralCounterparty                   ";

        sql_execute(query);
    end;

    private macro cacheAccData()
        var query =
                 "INSERT INTO df501Accounts_tmp                                                                  "
        + "\n" + "(t_chapter,                                                                                    "
        + "\n" + " t_isOpened,                                                                                   "
        + "\n" + " t_account,                                                                                    "
        + "\n" + " t_accountId,                                                                                  "
        + "\n" + " t_fiId,                                                                                       "
        + "\n" + " t_kind,                                                                                       "
        + "\n" + " t_balance,                                                                                    "
        + "\n" + " t_inCoverRest,                                                                                "
        + "\n" + " t_outCoverRest,                                                                               "
        + "\n" + " t_objectId,                                                                                   "
        + "\n" + " t_operationDate,                                                                              "
        + "\n" + " t_daysToEnd,                                                                                  "
        + "\n" + " t_contragentId,                                                                               "
        + "\n" + " t_part,                                                                                       "
        + "\n" + " t_isRepCategCC,                                                                               "
        + "\n" + " t_isRepCategExcludeAcc,                                                                       "
        + "\n" + " t_isRepCategDiscount,                                                                         "
        + "\n" + " t_isRepCategBonus,                                                                            "
        + "\n" + " t_isCategoryMarginSum,                                                                        "
        + "\n" + " t_isCategoryDiscount,                                                                         "
        + "\n" + " t_isCategoryBonus,                                                                            "
        + "\n" + " t_code,                                                                                       "
        + "\n" + " t_isBank,                                                                                     "
        + "\n" + " t_isCentralBank,                                                                              "
        + "\n" + " t_bankRegNumber,                                                                              "
        + "\n" + " t_isResident,                                                                                 "
        + "\n" + " t_countryCode,                                                                                "
        + "\n" + " t_isSWIFT,                                                                                    "
        + "\n" + " t_name,                                                                                       "
        + "\n" + " t_isNSPK                                                                                      "
        + "\n" + ")                                                                                              "
        + "\n" + "WITH tune                                                                                      "
        + "\n" + "  AS (" + m_tuneTable.getQuery() + ")                                                          "
        + "\n" + "SELECT accounts.t_chapter,                                                                     "
        + "\n" + "       accounts.t_isOpened,                                                                    "
        + "\n" + "       accounts.t_account,                                                                     "
        + "\n" + "       accounts.t_accountId,                                                                   "
        + "\n" + "       accounts.t_fiId,                                                                        "
        + "\n" + "       accounts.t_kind,                                                                        "
        + "\n" + "       accounts.t_balance,                                                                     "
        + "\n" + "       accounts.t_inCoverRest,                                                                 "
        + "\n" + "       accounts.t_outCoverRest,                                                                "
        + "\n" + "       accounts.t_objectId,                                                                    "
        + "\n" + "       accounts.t_operationDate,                                                               "
        + "\n" + "       accounts.t_daysToEnd,                                                                   "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 "       COALESCE(accSec.t_contragentId, accounts.t_contragentId)     AS t_contragentId,         ",
                 "       accounts.t_contragentId,                                                                ")
        + "\n" + "       t501.t_part,                                                                            "
        + "\n" + "       rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ","
                                                                + RCB_OBJGROUP_FOR_REPORTING
                                                                + ", 'РЕПО ч/з ЦК'"
                                                                + ", accounts.t_objectId,"
                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                + ")                  AS t_isRepCategCC,         "
        + "\n" + "       rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ","
                                                                + RCB_OBJGROUP_FOR_REPORTING
                                                                + ", 'Исключить из расчета'"
                                                                + ", accounts.t_objectId,"
                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                + ")                  AS t_isRepCategExcludeAcc, "
        + "\n" + "       rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ","
                                                                + RCB_OBJGROUP_FOR_REPORTING
                                                                + ", 'Дисконт по ППТ'"
                                                                + ", accounts.t_objectId,"
                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                + ")                  AS t_isRepCategDiscount,   "
        + "\n" + "       rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ","
                                                                + RCB_OBJGROUP_FOR_REPORTING
                                                                + ", 'Премия по ППТ'"
                                                                + ", accounts.t_objectId,"
                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate())
                                                                + ")                  AS t_isRepCategBonus,      "
        // 272109
        + "\n" + "       COALESCE(accWithCatMarginSum.t_isCategoryMarginSum, 0)       AS t_isCategoryMarginSum,  "
        + "\n" + "       COALESCE(accWithCatMarginSum.t_isCategoryDiscount,  0)       AS t_isCategoryDiscount,   "
        + "\n" + "       COALESCE(accWithCatMarginSum.t_isCategoryBonus,     0)       AS t_isCategoryBonus,      "
        + "\n" + "       CASE                                                                                    "
        + "\n" + "           WHEN party.t_isCentralBank = 1                                                      "
        + "\n" + "               THEN (SELECT partyCode.t_code                                                   "
        + "\n" + "                       FROM dreppartycodes_vw partyCode                                        "
        + "\n" + "                      WHERE partyCode.t_partyid  = party.t_id                                  "
        + "\n" + "                        AND partyCode.t_codekind = " + RCB_PTCK_BIC + ")                       "
        + "\n" + "           WHEN party.t_isBank = 1                                                             "
        + "\n" + "               THEN                                                                            "
        + "\n" + "                   CASE                                                                        "
        + "\n" + "                       WHEN party.t_isResident = 1                                             "
        + "\n" + "                           THEN (SELECT partyCode.t_code                                       "
        + "\n" + "                                   FROM dreppartycodes_vw partyCode                            "
        + "\n" + "                                  WHERE partyCode.t_partyid  = party.t_id                      "
        + "\n" + "                                    AND partyCode.t_codekind = " + RCB_PTCK_BANKREGNUM + ")    "
        + "\n" + "                       ELSE (SELECT partyCode.t_code                                           "
        + "\n" + "                               FROM dreppartycodes_vw partyCode                                "
        + "\n" + "                              WHERE partyCode.t_partyid  = party.t_id                          "
        + "\n" + "                                AND partyCode.t_codekind = " + RCB_PTCK_SWIFT + ")             "
        + "\n" + "                   END                                                                         "
        + "\n" + "           ELSE NULL                                                                           "
        + "\n" + "       END                                                          AS t_code,                 "
        + "\n" + "       party.t_isBank,                                                                         "
        + "\n" + "       party.t_isCentralBank,                                                                  "
        + "\n" + "       party.t_bankRegNumber,                                                                  "
        + "\n" + "       party.t_isResident,                                                                     "
        + "\n" + "       party.t_countryCode,                                                                    "
        + "\n" + "       party.t_isSWIFT,                                                                        "
        + "\n" + "       party.t_name,                                                                           "
        + "\n" + "       CASE                                                                                    "
        + "\n" + "            WHEN EXISTS (SELECT 1                                                              "
        + "\n" + "                           FROM dpartyown_dbt partyOwn                                         "
        + "\n" + "                          WHERE partyOwn.t_partyId = party.t_id                                "
        + "\n" + "                            AND partyOwn.t_partyKind = " + RCB_PTK_NSPK + ")                   "
        + "\n" + "            THEN 1                                                                             "
        + "\n" + "            ELSE 0                                                                             "
        + "\n" + "       END                                                          AS t_isNSPK                "
        + "\n" + "  FROM dRepAccount_vw       accounts,                                                          "
        + "\n" + "       dRepParty_vw         party,                                                             "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 "       df501Securities_tmp  accSec,                                                            ",
                 "")
        + "\n" + "       tune                 t501,                                                              "
        // 272109
        // аналог функции CheckCategoryForAccount, только интегрированной в основной запрос.
        // Поле t_isCategoryMarginSum будет проверяться и если значение в этом поле будет равно 1, то если процентная ставка
        // будет меньше нуля, она будет записана, как 0.
        + "\n" + "       (SELECT acc.t_accountId,                                                                "
        + "\n" + "               MAX(mcaccwithcat.t_isCategoryMarginSum) AS t_isCategoryMarginSum,               "
        + "\n" + "               MAX(mcaccwithcat.t_isCategoryDiscount)  AS t_isCategoryDiscount,                "
        + "\n" + "               MAX(mcaccwithcat.t_isCategoryBonus)     AS t_isCategoryBonus                    "
        + "\n" + "          FROM daccount_dbt acc,                                                               "
        + "\n" + "               (SELECT mcacc.t_account,                                                        "
        + "\n" + "                       mcacc.t_currency,                                                       "
        + "\n" + "                       mcacc.t_chapter,                                                        "
        + "\n" + "                       CASE                                                                    "
        + "\n" + "                           WHEN cat.t_code IN ('-МС','+МС')                                    "
        + "\n" + "                               THEN 1                                                          "
        + "\n" + "                           ELSE 0                                                              "
        + "\n" + "                       END                             AS t_isCategoryMarginSum,               "
        + "\n" + "                       CASE                                                                    "
        + "\n" + "                           WHEN cat.t_code = 'Дисконт_ПТ'                                      "
        + "\n" + "                               THEN 1                                                          "
        + "\n" + "                           ELSE 0                                                              "
        + "\n" + "                       END                             AS t_isCategoryDiscount,                "
        + "\n" + "                       CASE                                                                    "
        + "\n" + "                           WHEN cat.t_code = 'Премия_ПТ'                                       "
        + "\n" + "                               THEN 1                                                          "
        + "\n" + "                           ELSE 0                                                              "
        + "\n" + "                       END                             AS t_isCategoryBonus                    "
        + "\n" + "                  FROM dmcaccdoc_dbt mcacc,                                                    "
        + "\n" + "                       dmccateg_dbt  cat                                                       "
        + "\n" + "                 WHERE mcacc.t_catId = cat.t_id                                                "
        + "\n" + "                   AND cat.t_code IN ('-МС','+МС','Дисконт_ПТ','Премия_ПТ')) mcaccwithcat      "
        + "\n" + "         WHERE mcaccwithcat.t_account  = acc.t_account                                         "
        + "\n" + "           AND mcaccwithcat.t_currency = acc.t_code_currency                                   "
        + "\n" + "           AND mcaccwithcat.t_chapter  = acc.t_chapter                                         "
        + "\n" + "         GROUP BY acc.t_accountId                                                              "
        + "\n" + "       )                    accWithCatMarginSum                                                "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 " WHERE accounts.t_accountId = accSec.t_accountId(+)                                            "
        + "\n" + "   AND party.t_id           = COALESCE(accSec.t_contragentId, accounts.t_contragentId)         ",
                 " WHERE party.t_id           = accounts.t_contragentId                                          ")
        + "\n" + "   AND accounts.t_accountId = accWithCatMarginSum.t_accountId(+)                               "
        // Часть условий отбора л/с (общие условия по отбору л/с (счет открыт и т.д.) и общие условия по контрагенту по счету).
        // Остальное в commonData.
        + "\n" + "   AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, accounts.t_account) = 1             "
        + "\n" + "   AND accounts.t_isOpened  = 1                                                                "
        + "\n" + "   AND accounts.t_chapter   = 1                                                                "
        + "\n" + "   AND t501.t_typeAccount   = " + SQL_TYPE_1_CODE
        + "\n" + "   AND (   (     party.t_isResident = 1                                                        "
        + "\n" + "             AND party.t_isBank     = 1                                                        "
        // код 13 - "Рег. номер кред. орг-ции" в представлении dRepParty_vw равен NULL, если дата закрытия <= ДООП
        + "\n" + "             AND party.t_bankRegNumber IS NOT NULL                                             "
        + "\n" + "           )                                                                                   "
        + "\n" + "        OR (     party.t_isResident = 0                                                        "
        + "\n" + "             AND party.t_isBank     = 1                                                        "
        + "\n" + "           )                                                                                   "
        + "\n" + "        OR EXISTS (SELECT 1                                                                    "
        + "\n" + "                     FROM dpartyown_dbt partyOwn                                               "
        + "\n" + "                    WHERE partyOwn.t_partyId   = party.t_id                                    "
        + "\n" + "                      AND partyOwn.t_partyKind = " + RCB_PTK_NSPK + ") "
        + "\n" + "        OR party.t_isCentralBank = 1                                                           "
        + "\n" + "        OR SUBSTR(accounts.t_account, 1, 5) = '30425'                                          "//DEF-61262 Условие из дистрибутива
        + "\n" + "       )                                                                                       ";
        sql_execute(query);

        // Более продуктивнее получить информацию об оборотах отдельно.
        query =  "UPDATE df501Accounts_tmp acc                                                       "
        + "\n" + "   SET t_debet = COALESCE((SELECT SUM(doc.t_inCoverSum)                            "
        + "\n" + "                             FROM drepdocumentwithcorrection_vw doc                "
        + "\n" + "                            WHERE doc.t_chapter      = acc.t_chapter               "
        + "\n" + "                              AND doc.t_debetAccount = acc.t_account               "
        + "\n" + "                              AND doc.t_date        >= rep_data.getBeginDate()     "
        + "\n" + "                              AND doc.t_date        <= rep_data.getEndDate()), 0), "
        + "\n" + "       t_credit = COALESCE((SELECT SUM(doc.t_inCoverSum)                           "
        + "\n" + "                              FROM drepdocumentwithcorrection_vw doc               "
        + "\n" + "                             WHERE doc.t_chapter       = acc.t_chapter             "
        + "\n" + "                               AND doc.t_creditAccount = acc.t_Account             "
        + "\n" + "                               AND doc.t_date         >= rep_data.getBeginDate()   "
        + "\n" + "                               AND doc.t_date         <= rep_data.getEndDate()), 0)";
        sql_execute(query);
    end;

    private macro cacheMmdData()
        var query =
                 "INSERT INTO df501MmDeals_tmp                         "
        + "\n" + "(                                                    "
        + "\n" + " t_id,                                               "
        + "\n" + " t_mainRestAccount,                                  "
        + "\n" + " t_delaydMainRestAcc,                                "
        + "\n" + " t_plannedFinishDate,                                "
        + "\n" + " t_isOverNight,                                      "
        + "\n" + " t_kind,                                             "
        + "\n" + " t_contragentId,                                     "
        + "\n" + " t_isProlongingDeal,                                 "
        + "\n" + " t_rate,                                             "
        + "\n" + " t_part                                              "
        + "\n" + ")                                                    "
        + "\n" + "SELECT deals.t_id,                                   "
        + "\n" + "       deals.t_mainRestAccount,                      "
        + "\n" + "       deals.t_delaydMainRestAcc,                    "
        + "\n" + "       deals.t_plannedFinishDate,                    "
        + "\n" + "       deals.t_isOverNight,                          "
        + "\n" + "       deals.t_kind,                                 "
        + "\n" + "       deals.t_contragentId,                         "
        + "\n" + "       deals.t_isProlongingDeal,                     "
        + "\n" + "       (SELECT rateHistory.t_rate                    "
        + "\n" + "          FROM repMmDealRateHistory_vw rateHistory   "
        + "\n" + "         WHERE rateHistory.t_dealId      = deals.t_id"
        + "\n" + "           AND rateHistory.t_percentKind = 7         "
        + "\n" + "           AND rateHistory.t_rateDate    = (SELECT MAX(rh.t_rateDate)                     "
        + "\n" + "                                              FROM repMmDealRateHistory_vw rh             "
        + "\n" + "                                             WHERE rh.t_dealId      = rateHistory.t_dealId"
        + "\n" + "                                               AND rh.t_percentKind = 7                   "
        + "\n" + "                                               AND rh.t_rateDate   <= " + SQL_END_DATE
        + "\n" + "                                           )         "
        + "\n" + "         GROUP BY rateHistory.t_dealId,              "
        + "\n" + "                  rateHistory.t_rate) AS t_rate,     "
        + "\n" + "       CASE deals.t_kind                             "
        + "\n" + "           WHEN 'Размещение ' THEN 1                 "
        + "\n" + "           WHEN 'Привлечение' THEN 2                 "
        + "\n" + "           ELSE 0                                    "
        + "\n" + "           END                        AS t_part      "
        + "\n" + "  FROM repMmDeals_vw deals                           "
        + "\n" + " WHERE deals.t_kind IN ('Размещение ', 'Привлечение')"
        + "\n" + "   AND deals.t_isOpened = 1                          ";
        sql_execute(query);
    end;

    private macro addRelationsQuery()
        var query = ""
        // Графа 8
        + "\n" + "       CASE                                                                       "
        + "\n" + "            WHEN acc.t_part != 3 OR (acc.t_part = 3 AND acc.t_isExcludedAcc = 1)  "
        + "\n" + "            THEN acc.t_debet                                                      "
        + "\n" + "            ELSE NULL                                                             "
        + "\n" + "       END AS t_debet,                                                            "
        // Графа 9
        + "\n" + "       CASE                                                                       "
        + "\n" + "            WHEN acc.t_part != 3 OR (acc.t_part = 3 AND acc.t_isExcludedAcc = 1)  "
        + "\n" + "            THEN acc.t_credit                                                     "
        + "\n" + "            ELSE NULL                                                             "
        + "\n" + "       END AS t_credit,                                                           "
        + "\n" + "       CASE                                                                       "
        + "\n" + "            WHEN EXISTS (SELECT 1                                                 "
        + "\n" + "                           FROM drepCorrectionalDocument_vw iscorrect             "
        + "\n" + "                          WHERE iscorrect.t_creditaccount = acc.t_account)        "
        + "\n" + "            THEN 1                                                                "
        + "\n" + "            ELSE 0                                                                "
        + "\n" + "       END AS t_isExistCorrect,                                                   "
        // Графа 3
        + "\n" + "       CASE                                                                        "
        + "\n" + "            WHEN (SELECT t_isCentralBank                                           "
        + "\n" + "                  FROM   drepparty_vw repParty                                     "
        + "\n" + "                  WHERE  repParty.t_id = acc.t_partyId) = 1                        "
        + "\n" + "            THEN                                                                   "
        + "\n" + "                 (SELECT t_code                                                    "
        + "\n" + "                  FROM   dRepPartyCodes_vw codes                                   "
        + "\n" + "                  WHERE  codes.t_partyId  =  acc.t_partyId                         "
        + "\n" + "                  AND    codes.t_codekind = " + RCB_PTCK_BIC + ")"
        + "\n" + "            ELSE                                                                            "
        + "\n" + "                 CASE                                                                       "
        + "\n" + "                      WHEN acc.t_isNSPK = 1                                                 "
        + "\n" + "                      THEN 'М'                                                              "
        + "\n" + "                      WHEN acc.t_isResident = 1                                             "
        + "\n" + "                      THEN                                                                  "
        + "\n" + "                          CASE                                                              "
        + "\n" + "                              WHEN acc.t_code like '%/%'                                    "
        + "\n" + "                                  THEN SUBSTR(acc.t_code, 1, INSTR(acc.t_code, '/') - 1)    "
        + "\n" + "                              ELSE COALESCE(acc.t_code, CHR(1))                             "
        + "\n" + "                          END                                                               "
        + "\n" + "                      ELSE                                                                  "
        + "\n" + "                          CASE                                                              "
        + "\n" + "                              WHEN acc.t_isswift = 1                                        "
        + "\n" + "                                  THEN COALESCE(acc.t_code, 'НР')                           "
        + "\n" + "                              ELSE 'НР'                                                     "
        + "\n" + "                          END                                                               "
        + "\n" + "                 END                                                                        "
        + "\n" + "       END                                                                                  "
        + "\n" + "           AS t_regNumber,                                                                  "
        //графа 13
        + "\n" + "       CASE                                                                                 "
        + "\n" + "           WHEN acc.t_isActiveKindEncumbrance <> 0                                          "
        //Признак обременения первая цифра, остальное значение графы
        + "\n" + "               THEN '11'                                                                    "
        + "\n" + "           ELSE COALESCE((SELECT CASE                                                       "
        + "\n" + "                                     WHEN NOT (party.t_isPhisical = 1 AND party.t_isResident = 0)"
        + "\n" + "                                         THEN '9' || party.t_name                           "
        + "\n" + "                                     ELSE '0'                                               "
        + "\n" + "                                  END AS t_name                                             "
        + "\n" + "                             FROM dRepParty_vw party,                                       "
        + "\n" + "                                  dRepLinkedObjects_vw objLink                              "
        + "\n" + "                            WHERE party.t_objectId                = objLink.t_id            "
        + "\n" + "                              AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
        + "\n" + "                              AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
        + "\n" + "                              AND objLink.t_isInstalledForEndDate = 1                       "
        + "\n" + "                              AND objLink.t_connectObjectId       = acc.t_objectId          "
        + "\n" + "                              AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                          ),                                                                "
        + "\n" + "                          '0'                                                               "
        + "\n" + "                         )                                                                  "
        + "\n" + "       END AS t_onerousClaim,                                                               "
        //графа 14
        + "\n" + "       CASE                                                                                 "
        + "\n" + "           WHEN acc.t_isActiveKindEncumbrance <> 0                                          "
        // Условный код. Первая цифра (если X - значит не заполяется),
        // следующие 3 цифры - это код SWIFT
        // (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
        + "\n" + "               THEN 'XYYY'                                                                  "
        + "\n" + "           ELSE COALESCE((SELECT CASE                                                               "
        + "\n" + "                                     WHEN party.t_isBank = 1 AND party.t_isResident = 1             "
        + "\n" + "                                         THEN (SELECT CASE                                          "
        + "\n" + "                                                          WHEN INSTR(codes.t_code, '/', 1, 1) != 0  "
        + "\n" + "                                                              THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
        + "\n" + "                                                          WHEN codes.t_code = ''                    "
        + "\n" + "                                                              THEN 'X' || 'YYY' || codes.t_code     "
        + "\n" + "                                                          ELSE '2' || 'YYY' || codes.t_code         "
        + "\n" + "                                                      END                                           "
        + "\n" + "                                                 FROM dRepPartyCodes_vw codes                       "
        + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
        + "\n" + "                                                  AND codes.t_partyId  = party.t_id)                "

        + "\n" + "                                     WHEN party.t_isBank = 1 AND party.t_isResident = 0             "
        + "\n" + "                                         THEN (COALESCE((SELECT CASE                                "
        + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 8   "
        + "\n" + "                                                                        THEN '4' || 'XXX' || codes.t_code || 'XXX'"
        + "\n" + "                                                                    WHEN LENGTH(codes.t_code) = 11  "
        + "\n" + "                                                                        THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
        + "\n" + "                                                                    ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
        + "\n" + "                                                                END t_code                          "
        + "\n" + "                                                           FROM dRepPartyCodes_vw codes             "
        + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
        + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))"

        + "\n" + "                                     WHEN party.t_isPhisical = 0 AND party.t_isResident = 1         "
        + "\n" + "                                         THEN (COALESCE((SELECT '1' || 'YYY' || codes.t_code        "
        + "\n" + "                                                           FROM dRepPartyCodes_vw codes             "
        + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
        + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

        + "\n" + "                                     WHEN party.t_isEmployer = 1                                    "
        + "\n" + "                                         THEN (COALESCE((SELECT '6' || 'YYY' || codes.t_code        "
        + "\n" + "                                                           FROM dRepPartyCodes_vw codes             "
        + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
        + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

        + "\n" + "                                     WHEN party.t_isPhisical = 0 AND party.t_isResident = 0         "
        + "\n" + "                                         THEN '3'|| 'YYY' || 'HP'                                   "
        + "\n" + "                                     WHEN party.t_isPhisical = 1 AND party.t_isResident = 1 AND party.t_isEmployer = 0"
        + "\n" + "                                         THEN (COALESCE((SELECT '5' || 'YYY' || codes.t_code        "
        + "\n" + "                                                           FROM dRepPartyCodes_vw codes             "
        + "\n" + "                                                          WHERE codes.t_codeKind = " + RCB_PTCK_INN
        + "\n" + "                                                            AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
        + "\n" + "                                     ELSE 'X' || 'YYY' || ''                                        "
        + "\n" + "                                 END t_identifier                                                   "
        + "\n" + "                             FROM dRepLinkedObjects_vw link,                                        "
        + "\n" + "                                  dRepParty_vw         party                                        "
        + "\n" + "                            WHERE acc.t_objectId               = link.t_connectObjectId             "
        + "\n" + "                              AND party.t_objectId             = link.t_id                          "
        + "\n" + "                              AND link.t_isInstalledForEndDate = 1                                  "
        + "\n" + "                              AND link.t_connectObjectType     = 4                                  "
        + "\n" + "                              AND link.t_type                  = 3                                  "
        + "\n" + "                              AND link.t_role                  = 59                                 "
        + "\n" + "                         ),                                                                         "
        + "\n" + "                         'X' || 'YYY' || ''                                                         "
        + "\n" + "                        )                                                                           "
        + "\n" + "       END AS t_identifier,                                                                    "
        //графа 15
        + "\n" + "       (SELECT CASE category.t_value                                                           "
        + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда"            ) + " THEN " + getSqlString("1")
        + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит"          ) + " THEN " + getSqlString("2")
        + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
        + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз"         ) + " THEN " + getSqlString("4")
        + "\n" + "                    ELSE " + getSqlString("")
        + "\n" + "               END                                                                             "
        + "\n" + "          FROM dRepCategory_vw      category,                                                  "
        + "\n" + "               dRepLinkedObjects_vw objLink                                                    "
        + "\n" + "         WHERE category.t_id         = " + RCB_OBJGROUP_FOR_REPORTING
        + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND category.t_value      = ANY(" + getSqlString("Обрем_Ссуда"            ) + ","
        + "\n" + "                                           " + getSqlString("Обрем_Депозит"          ) + ","
        + "\n" + "                                           " + getSqlString("Обрем_ДолгОбязательство") + ","
        + "\n" + "                                           " + getSqlString("Обрем_ИноеОбяз"         ) + ""
        + "\n" + "                                          )"
        + "\n" + "           AND category.t_isInstalledForEndDate = 1                                            "
        + "\n" + "           AND category.t_objectId              = objLink.t_id                                 "
        + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1                                            "
        + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId                               "
        + "\n" + "       ) AS t_onerousClaimCategory,                                                            "
        //графа 16
        + "\n" + "       (SELECT acc2.t_outCoverRest                                                             "
        + "\n" + "          FROM dRepAccount_vw       acc2,                                                      "
        + "\n" + "               dRepLinkedObjects_vw objLink                                                    "
        + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))                          "
        + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')               "
        + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                                       "
        + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
        + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                                "
        + "\n" + "       ) AS t_restLinkedAccount,                                                               "

        + "\n" + "       (SELECT SUBSTR(objLink.t_id, 10)                                                        "
        + "\n" + "          FROM dRepLinkedObjects_vw objLink                                                    "
        + "\n" + "         WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                                             "
        + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                                "
        + "\n" + "       ) AS t_linkedAccount,                                                                   "
        //графа 17
        + "\n" + "       (SELECT rep_note.getDateAccountNote(acc2.t_objectId, 16,                                "
                                                             + SQL_END_DATE
                                                             + ")                                                "
        + "\n" + "          FROM dRepAccount_vw       acc2,                                                      "
        + "\n" + "               dRepLinkedObjects_vw objLink                                                    "
        + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))                          "
        + "\n" + "           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')               "
        + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)                                       "
        + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "           AND objLink.t_isInstalledForEndDate = 1                                             "
        + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId                                "
        + "\n" + "       ) AS t_redemptionDate,                                                                  "
        + "\n" + "       CASE                                                                                    "
        + "\n" + "           WHEN acc.t_isSecurities = 1                                                         "
        + "\n" + "               THEN CASE                                                                       "
        + "\n" + "                        WHEN acc.t_isDebtRepo = " + getSqlString("YES")
        + "\n" + "                           THEN 1                                                              "
        + "\n" + "                        ELSE 0                                                                 "
        + "\n" + "                    END                                                                        "
        + "\n" + "           ELSE                                                                                "
        + "\n" + "               CASE                                                                            "
        + "\n" + "                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", "
                                                                                 + RCB_OBJGROUP_FOR_REPORTING
                                                                                 + ", 'РЕПО', acc.t_objectId, "
                                                                                 + SQL_END_DATE + ") <> 0        "
        + "\n" + "                       THEN 1                                                                  "
        + "\n" + "                   ELSE 0                                                                      "
        + "\n" + "               END                                                                             "
        + "\n" + "       END AS t_isRepoAccount,                                                                 "
        + "\n" + "       CASE                                                                                    "
        + "\n" + "           WHEN t_isThirdPerson != 0                                                           "
        + "\n" + "               THEN '*'                                                                        "
        + "\n" + "           ELSE ''                                                                             "
        + "\n" + "       END AS t_singDepending,                                                                 "
        + "\n" + "       CASE                                                                                    "
        + "\n" + "           WHEN     t_isThirdPerson != 0                                                       "
        + "\n" + "                AND rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", acc.t_objectId, "
                                                               + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "
                                                               + SQL_END_DATE + ") IS NOT NULL                                                         "
        + "\n" + "           THEN ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", acc.t_objectId, "
                                                                                                 + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                 + SQL_END_DATE + ")), 2, 1)) * 256 "
        + "\n" + "              + ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", acc.t_objectId, "
                                                                                                 + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                 + SQL_END_DATE + ")), 1, 1))                          "
        + "\n" + "           ELSE -1                                                                                                                   "
        + "\n" + "       END AS t_prolongationAmount,                                                                                                  "
        // Атрибут: Пояснения
        + "\n" + "       COALESCE(rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ",  acc.t_objectId, "
                                                                                      + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", "
                                                                                      + SQL_END_DATE + ")), '') AS t_explanation,                                                                                                                                                              "
        // Атрибут: БИК
        + "\n" + "       CASE                                                                                    "
        + "\n" + "           WHEN acc.t_isResident != 0                                                          "
        + "\n" + "               THEN COALESCE(RSI_RSBPARTY.PT_GetPartyCode(acc.t_partyId, 3), '')               "
        + "\n" + "           ELSE ''                                                                             "
        + "\n" + "       END AS t_BIC                                                                            "
               ;
        return query;
    end;

    private macro getQueryWithMmdData()
        var queryWithMmdData = ""
        // Графа 11
        + "\n" + "       CASE                                                                                                    "
        + "\n" + "           WHEN acc.t_part != 3                                                                                "
        + "\n" + "           THEN CASE                                                                                           "
        + "\n" + "                    WHEN    (" + convertMaskToSQLFormat(m_BalanceList, "acc.t_balance")  + ")                  "
        + "\n" + "                         OR (" + convertMaskToSQLFormat("32401, 32402", "acc.t_balance") + ")                  "
        + "\n" + "                    THEN CASE                                                                                  "
        + "\n" + "                             WHEN acc.t_isSecurities = 0                                                       "
        + "\n" + "                             THEN CASE                                                                         "
        + "\n" + "                                      WHEN acc.t_outCoverRest = 0                                              "
        + "\n" + "                                       AND (   (acc.t_inCoverRest != 0)                                        "
        + "\n" + "                                            OR (acc.t_credit      != 0)                                        "
        + "\n" + "                                            OR (acc.t_debet       != 0)                                        "
        + "\n" + "                                           )                                                                   "
        + "\n" + "                                      THEN (SELECT MAX(doc.t_date)                                             "
        + "\n" + "                                              FROM drepdocument_vw doc                                         "
        + "\n" + "                                             WHERE doc.t_date <= " + SQL_END_DATE
        + "\n" + "                                               AND (   (    acc.t_kindAccount != " + getSqlString("П")
        + "\n" + "                                                        AND doc.t_creditAccountId = acc.t_accountId            "
        + "\n" + "                                                       )                                                       "
        + "\n" + "                                                    OR (    acc.t_kindAccount = " + getSqlString("П")
        + "\n" + "                                                        AND doc.t_debetAccountId = acc.t_accountId             "
        + "\n" + "                                                       )                                                       "
        + "\n" + "                                                   )                                                           "
        + "\n" + "                                           )                                                                   "
        + "\n" + "                                      WHEN acc.t_outCoverRest != 0                                             "
        + "\n" + "                                      THEN NULL                                                                "
        + "\n" + "                                  END                                                                          "
        + "\n" + "                             ELSE CASE                                                                         "
        + "\n" + "                                      WHEN acc.t_securDebtDate != " + getSqlDate(Date(0, 0, 0))
        + "\n" + "                                      THEN acc.t_securDebtDate                                                 "
        + "\n" + "                                      ELSE NULL                                                                "
        + "\n" + "                                  END                                                                          "
        + "\n" + "                         END                                                                                   "
        + "\n" + "                    ELSE CASE                                                                                  "
        + "\n" + "                             WHEN acc.t_isSecurities = 0                                                       "
          "\n" + "                              AND acc.t_isMMD        = 0                                                       "
        + "\n" + "                             THEN COALESCE(rep_note.readMaturityDate(acc.t_objectId," + SQL_END_DATE + "),     "
        + "\n" + "                                           acc.t_operationEndDate,                                             "
                                                           + getSqlDate(Date(0, 0, 0)) + ")                                      "
        + "\n" + "                             WHEN acc.t_isSecurities = 1                                                       "
          "\n" + "                              AND acc.t_isMMD        = 0                                                       "
        + "\n" + "                             THEN acc.t_securDebtDate                                                          "
               + ternary(m_parameters.m_isMmData,
          "\n" + "                             WHEN acc.t_isMMD = 1                                                              "
        + "\n" + "                             THEN COALESCE((SELECT MAX(mmDeals.t_plannedFinishDate)                            "
        + "\n" + "                                              FROM df501MmDeals_tmp mmDeals                                    "
        + "\n" + "                                             WHERE mmDeals.t_part = acc.t_part                                 "
        + "\n" + "                                               AND acc.t_account  = mmDeals.t_mainRestAccount                  "
        + "\n" + "                                           )," + getSqlDate(Date(0,0,0))
        + "\n" + "                                          )                                                                    ",
          "\n" + "")
        + "\n" + "                         END                                                                                   "
        + "\n" + "                END                                                                                            "
        + "\n" + "           ELSE NULL                                                                                           "
        + "\n" + "       END AS t_perfomanceDate,                                                                                "
               + ternary(m_parameters.m_isMmData,
          "\n" + "       CASE                                                                                                    "
        + "\n" + "           WHEN    (" + convertMaskToSQLFormat(m_BalanceList, "acc.t_balance")  + ")                           "
        + "\n" + "                OR (" + convertMaskToSQLFormat("32401, 32402", "acc.t_balance") + ")                           "
        + "\n" + "           THEN 0                                                                                              "
        + "\n" + "           ELSE CASE                                                                                           "
        + "\n" + "                    WHEN acc.t_isMMD = 0                                                                       "
        + "\n" + "                    THEN 0                                                                                     "
        + "\n" + "                    ELSE COALESCE((SELECT deal.t_id                                                            "
        + "\n" + "                                     FROM df501MmDeals_tmp deal                                                "
        + "\n" + "                                    WHERE deal.t_part              = acc.t_part                                "
        + "\n" + "                                      AND deal.t_mainRestAccount   = acc.t_account                             "
        + "\n" + "                                      AND deal.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)  "
        + "\n" + "                                                                        FROM df501MmDeals_tmp maxDate          "
        + "\n" + "                                                                       WHERE maxDate.t_part = deal.t_part      "
        + "\n" + "                                                                         AND maxDate.t_mainRestAccount = deal.t_mainRestAccount"
        + "\n" + "                                                                     )                                         "
        + "\n" + "                                  ), 0                                                                         "
        + "\n" + "                                 )                                                                             "
        + "\n" + "                END                                                                                            "
        + "\n" + "       END AS t_perfomanceDateDealId,                                                                          ",
          "\n" + "       0   AS t_perfomanceDateDealId,                                                                          ")
        // Атрибут: _Добяз_Kliko
        + "\n" + "       CASE                                                                                                    "
        + "\n" + "           WHEN acc.t_part != 3                                                                                "
        + "\n" + "           THEN CASE                                                                                           "
        + "\n" + "                    WHEN     (   (" + convertMaskToSQLFormat(m_BalanceList, "acc.t_balance")  + ")             "
        + "\n" + "                              OR (" + convertMaskToSQLFormat("32401, 32402", "acc.t_balance") + ")             "
        + "\n" + "                             )                                                                                 "
        + "\n" + "                         AND acc.t_isSecurities = 0                                                            "
        + "\n" + "                    THEN CASE                                                                                  "
        + "\n" + "                             WHEN acc.t_outCoverRest = 0                                                       "
        + "\n" + "                              AND (   (acc.t_inCoverRest != 0)                                                 "
        + "\n" + "                                   OR (acc.t_credit != 0)                                                      "
        + "\n" + "                                   OR (acc.t_debet != 0)                                                       "
        + "\n" + "                                  )                                                                            "
        + "\n" + "                             THEN (SELECT MAX(doc.t_date)                                                      "
        + "\n" + "                                     FROM drepdocument_vw doc                                                  "
        + "\n" + "                                    WHERE doc.t_date <= " + SQL_END_DATE
        + "\n" + "                                      AND (   (    acc.t_kindAccount != " + getSqlString("П")
        + "\n" + "                                               AND doc.t_creditAccountId = acc.t_accountId                     "
        + "\n" + "                                              )                                                                "
        + "\n" + "                                           OR (    acc.t_kindAccount = " + getSqlString("П")
        + "\n" + "                                               AND doc.t_debetAccountId = acc.t_accountId                      "
        + "\n" + "                                              )                                                                "
        + "\n" + "                                          )                                                                    "
        + "\n" + "                                  )                                                                            "
        + "\n" + "                             WHEN acc.t_outCoverRest != 0                                                      "
        + "\n" + "                             THEN NULL --использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
        + "\n" + "                         END                                                                                   "
        + "\n" + "                    ELSE NULL --в экспорте использовать perfomanceDate                                         "
        + "\n" + "                END                                                                                            "
        + "\n" + "           ELSE NULL                                                                                           "
        + "\n" + "       END AS t_perfomanceDateKliko,                                                                           "
        // Атрибут: _%
        + "\n" + "       CASE                                                                                                    "
        + "\n" + "           WHEN acc.t_part != 3 AND acc.t_isRepCatGD = 0                                                       "
        + "\n" + "           THEN CASE                                                                                           "
        + "\n" + "                    WHEN     acc.t_isSecurities = 0                                                            "
        + "\n" + "                         AND acc.t_isMMD        = 0                                                            "
        + "\n" + "                    THEN COALESCE(rep_note.readRate(acc.t_objectId," + SQL_END_DATE + "), 0)                   "
        + "\n" + "                    WHEN     acc.t_isSecurities = 1                                                            "
        + "\n" + "                         AND acc.t_isMMD        = 0                                                            "
        + "\n" + "                    THEN acc.t_securRate                                                                       "
               + ternary(m_parameters.m_isMmData,
          "\n" + "                    ELSE (SELECT CASE                                                                          "
        + "\n" + "                                     WHEN mmDeals.t_isOverNight = 1                                            "
        + "\n" + "                                     THEN (SELECT SUM( deals.t_dealAmount                                      "
        + "\n" + "                                                      *(SELECT rateHistory.t_rate                              "
        + "\n" + "                                                          FROM repMmDealRateHistory_vw rateHistory             "
        + "\n" + "                                                         WHERE rateHistory.t_dealId = deals.t_id               "
        + "\n" + "                                                           AND rateHistory.t_percentKind = 7                   "
        + "\n" + "                                                           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
        + "\n" + "                                                                                           FROM repMmDealRateHistory_vw rh        "
        + "\n" + "                                                                                          WHERE rh.t_dealId = rateHistory.t_dealId"
        + "\n" + "                                                                                            AND rh.t_percentKind = 7              "
        + "\n" + "                                                                                            AND rh.t_rateDate <= " + SQL_END_DATE
        + "\n" + "                                                                                        )                      "
        + "\n" + "                                                         GROUP BY rateHistory.t_dealId,                        "
        + "\n" + "                                                                  rateHistory.t_rate                           "
        + "\n" + "                                                       )                                                       "
        + "\n" + "                                                     )                                                         "
        + "\n" + "                                                / SUM(deals.t_dealAmount)                                      "
        + "\n" + "                                             FROM repMmDeals_vw deals                                          "
        + "\n" + "                                            WHERE deals.t_kind = mmDeals.t_kind                                "
        + "\n" + "                                              AND (   (mmDeals.t_mainRestAccount = deals.t_mainRestAccount)    "
        + "\n" + "                                                   OR (mmDeals.t_delaydMainRestAcc = deals.t_delaydMainRestAcc)"
        + "\n" + "                                                  )"
        + "\n" + "                                              AND deals.t_contragentId = mmDeals.t_contragentId                "
        + "\n" + "                                              AND (   deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
        + "\n" + "                                                   OR (    deals.t_openDate < " + SQL_BEGIN_DATE
        + "\n" + "                                                       AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate         "
        + "\n" + "                                                      )                                                        "
        + "\n" + "                                                  )                                                            "
        + "\n" + "                                          )                                                                    "
        + "\n" + "                                     WHEN mmDeals.t_isOverNight != 1                                           "
        + "\n" + "                                      AND mmDeals.t_isProlongingDeal = " + getSqlString("YES")
        + "\n" + "                                     THEN (SELECT SUM( deals.t_dealAmount                                      "
        + "\n" + "                                                      *(SELECT rateHistory.t_rate                              "
        + "\n" + "                                                          FROM repMmDealRateHistory_vw rateHistory             "
        + "\n" + "                                                         WHERE rateHistory.t_dealId = deals.t_id               "
        + "\n" + "                                                           AND rateHistory.t_percentKind = 7                   "
        + "\n" + "                                                           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
        + "\n" + "                                                                                           FROM repMmDealRateHistory_vw rh        "
        + "\n" + "                                                                                          WHERE rh.t_dealId = rateHistory.t_dealId"
        + "\n" + "                                                                                            AND rh.t_percentKind = 7              "
        + "\n" + "                                                                                            AND rh.t_rateDate <= " + SQL_END_DATE
        + "\n" + "                                                                                        )                      "
        + "\n" + "                                                         GROUP BY rateHistory.t_dealId,                        "
        + "\n" + "                                                                  rateHistory.t_rate                           "
        + "\n" + "                                                       )                                                       "
        + "\n" + "                                                     )                                                         "
        + "\n" + "                                                / SUM(deals.t_dealAmount)                                      "
        + "\n" + "                                             FROM repMmDeals_vw deals                                          "
        + "\n" + "                                            WHERE (   (   deals.t_openDate < " + SQL_BEGIN_DATE
        + "\n" + "                                                       AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate         "
        + "\n" + "                                                      )                                                        "
        + "\n" + "                                                   OR deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
        + "\n" + "                                                  )                                                            "
        + "\n" + "                                              AND deals.t_mainRestAccount = mmDeals.t_mainRestAccount          "
        + "\n" + "                                          CONNECT BY PRIOR deals.t_id = deals.t_prolongingDealId               "
        + "\n" + "                                            START WITH deals.t_id = mmDeals.t_id                               "
        + "\n" + "                                          )                                                                    "
        + "\n" + "                                     ELSE (SELECT rateHistory.t_rate                                           "
        + "\n" + "                                             FROM repMmDealRateHistory_vw rateHistory                          "
        + "\n" + "                                            WHERE rateHistory.t_dealId = mmDeals.t_id                          "
        + "\n" + "                                              AND rateHistory.t_percentKind = 7                                "
        + "\n" + "                                              AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)          "
        + "\n" + "                                                                              FROM repMmDealRateHistory_vw rh        "
        + "\n" + "                                                                             WHERE rh.t_dealId = rateHistory.t_dealId"
        + "\n" + "                                                                               AND rh.t_percentKind = 7              "
        + "\n" + "                                                                               AND rh.t_rateDate <= " + SQL_END_DATE
        + "\n" + "                                                                           )                                   "
        + "\n" + "                                            GROUP BY rateHistory.t_dealId,                                     "
        + "\n" + "                                                     rateHistory.t_rate                                        "
        + "\n" + "                                          )                                                                    "
        + "\n" + "                                 END t_rate                                                                    "
        + "\n" + "                            FROM df501MmDeals_tmp mmDeals                                                      "
        + "\n" + "                           WHERE mmDeals.t_part = acc.t_part                                                   "
        + "\n" + "                             AND acc.t_account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)   "
        + "\n" + "                             AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                        "
        + "\n" + "                                                   FROM df501MmDeals_tmp maxId                                 "
        + "\n" + "                                                  WHERE maxId.t_part = mmDeals.t_part                          "
        + "\n" + "                                                    AND (   (mmDeals.t_mainRestAccount = maxId.t_mainRestAccount)    "
        + "\n" + "                                                         OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc)"
        + "\n" + "                                                        )                                                      "
        + "\n" + "                                                    AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)                             "
        + "\n" + "                                                                                       FROM df501MmDeals_tmp maxDate                                     "
        + "\n" + "                                                                                      WHERE maxDate.t_part = maxId.t_part                                "
        + "\n" + "                                                                                        AND (   (maxId.t_mainRestAccount = maxDate.t_mainRestAccount)    "
        + "\n" + "                                                                                             OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc)"
        + "\n" + "                                                                                            )                  "
        + "\n" + "                                                                                    )                          "
        + "\n" + "                                                )                                                              "
        + "\n" + "                         )                                                                                     ",
          "\n" + "")
        + "\n" + "                END                                                                                            "
        + "\n" + "           ELSE NULL                                                                                           "
        + "\n" + "       END AS t_rate,                                                                                          "
               + ternary(m_parameters.m_isMmData,
          "\n" + "       CASE                                                                                                    "
        + "\n" + "           WHEN     acc.t_isRepCatGD = 0                                                                       "
        + "\n" + "                AND acc.t_isMMD      = 1                                                                       "
        + "\n" + "           THEN COALESCE((SELECT mmDeals.t_id                                                                  "
        + "\n" + "                            FROM df501MmDeals_tmp mmDeals                                                      "
        + "\n" + "                           WHERE mmDeals.t_part = acc.t_part                                                   "
        + "\n" + "                             AND acc.t_account  = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)  "
        + "\n" + "                             AND (   mmDeals.t_isOverNight = 1                                                 "
        + "\n" + "                                  OR mmDeals.t_isProlongingDeal = " + getSqlString("YES")
        + "\n" + "                                 )                                                                             "
        + "\n" + "                             AND mmDeals.t_id = (SELECT MAX(maxId.t_id)                                        "
        + "\n" + "                                                   FROM df501MmDeals_tmp maxId                                 "
        + "\n" + "                                                  WHERE maxId.t_part = mmDeals.t_part                          "
        + "\n" + "                                                    AND (   (mmDeals.t_mainRestAccount = maxId.t_mainRestAccount)"
        + "\n" + "                                                         OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc)"
        + "\n" + "                                                        )                                                      "
        + "\n" + "                                                    AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)                             "
        + "\n" + "                                                                                       FROM df501MmDeals_tmp maxDate                                     "
        + "\n" + "                                                                                      WHERE maxDate.t_part = maxId.t_part                                "
        + "\n" + "                                                                                        AND (   (maxId.t_mainRestAccount = maxDate.t_mainRestAccount)    "
        + "\n" + "                                                                                             OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc)"
        + "\n" + "                                                                                            )                  "
        + "\n" + "                                                                                    )                          "
        + "\n" + "                                                )                                                              "
        + "\n" + "                         ), 0                                                                                  "
        + "\n" + "                        )                                                                                      "
        + "\n" + "           ELSE 0                                                                                              "
        + "\n" + "       END AS t_rateDealId                                                                                     ",
          "\n" + "       0   AS t_rateDealId                                                                                     ")
               ;
        return queryWithMmdData;
    end;

    private macro getQueryForData()
        var  queryForData = ""
        // Графа 6
        + "\n" + "SELECT acc.t_account,                                 "
        + "\n" + "       acc.t_accountId,                               "
        + "\n" + "       acc.t_objectId,                                "
        + "\n" + "       acc.t_kindAccount,                             "
        + "\n" + "       acc.t_partyId               AS t_clientCode,   "
        // Графа 5
        + "\n" + "       acc.t_balance,                                 "
        // Графа 2
        + "\n" + "       acc.t_clientName,                              "
        // Графа 4
        + "\n" + "       DECODE(acc.t_nrCountry, CHR(1), '???', (SELECT t_CodeNum3                                   "
        + "\n" + "                                                 FROM dcountry_dbt                                 "
        + "\n" + "                                                WHERE t_CodeLat3 = acc.t_nrCountry)) t_countryCode,"
        // Графа 7
        + "\n" + "       acc.t_inCoverRest           AS t_beginRest,    "
        // Графа 10
        + "\n" + "       acc.t_outCoverRest          AS t_endRest,      "
        + "\n" + "       acc.t_part,                                    "
        + "\n" + "       acc.t_typeAccount,                             "
        + "\n" + "       acc.t_isExcludedAcc,                           "
        + "\n" + "       acc.t_isSecurities,                            "
        + "\n" + "       acc.t_isResident,                              "
        // 272109
        + "\n" + "       acc.t_isCategoryMarginSum,                     "
        + "\n" + "       acc.t_isRepCatGD            AS t_isGD,         "
        + "\n" + "       acc.t_isThirdPerson,                           "
        + "\n"       + addRelationsQuery()
        + "\n" + "," + getQueryWithMmdData()
        //  Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
        + "\n" + "  FROM accountTable acc                                                         "
               ;
        return QueryForData;
    end;

    private macro getQuery()
        var query = ""
        // Графа 6
        + "\n" + "SELECT t_account,                                 "
        + "\n" + "       t_accountId,                               "
        // Графа 5
        + "\n" + "       t_balance,                                 "
        + "\n" + "       t_account            AS t_printedAccount,  "
        // Графа 2
        + "\n" + "       t_clientName,                              "
        // Графа 3
        + "\n" + "       t_regNumber,                               "
        // Графа 4
        + "\n" + "       t_countryCode,                             "
        // Графа 7
        + "\n" + "       t_beginRest,                               "
        // Графа 8
        + "\n" + "       t_debet,                                   "
        // Графа 9
        + "\n" + "       t_credit,                                  "
        // Графа 10
        + "\n" + "       t_endRest,                                 "
        // Графа 11
        + "\n" + "       t_perfomanceDate,                          "
        + "\n" + "       t_perfomanceDateDealId,                    "
        // Атрибут: _Добяз_Kliko
        + "\n" + "       t_perfomanceDateKliko,                     "
        // Атрибут: _% (Графа 12)
        + "\n" + "       CASE                                       "
        + "\n" + "           WHEN t_isCategoryMarginSum = 1         "
        + "\n" + "           THEN CASE                              "
        + "\n" + "                    WHEN t_rate > 0               "
        + "\n" + "                    THEN t_rate                   "
        + "\n" + "                    ELSE 0                        "
        + "\n" + "                END                               "
        + "\n" + "           ELSE t_rate                            "
        + "\n" + "       END                  AS t_rate,            "
        + "\n" + "       t_rateDealId,                              "
        + "\n" + "       t_clientCode,                              "
        + "\n" + "       t_part               AS t_partReport,      "
        + "\n" + "       t_typeAccount,                             "
        + "\n" + "       t_kindAccount,                             "
        + "\n" + "       t_part,                                    "
        + "\n" + "       t_isRepoAccount,                           "
        + "\n" + "       t_isSecurities,                            "
        + "\n" + "       t_isResident         AS t_isClientResident,"
        + "\n" + "       t_isGD,                                    "
        + "\n" + "       t_isExistCorrect,                          "
        + "\n" + "       t_isThirdPerson,                           "
        + "\n" + "       t_isExcludedAcc,                           "
        + "\n" + "       t_singDepending,                           "
        + "\n" + "       t_prolongationAmount,                      "
        // Атрибут: Пояснения
        + "\n" + "       t_explanation,                             "
        // Атрибут: БИК
        + "\n" + "       t_BIC,                                     "
        // Атрибут: Обрем_Гр13 (графа 13)
        + "\n" + "       SUBSTR(t_onerousClaim, 2) AS t_onerousClaim,"
        // Атрибут: Обрем_Гр14 (Графа 14)
        + "\n" + "       SUBSTR(t_identifier, 5)   AS t_identifier,  "
        // Атрибут: Обрем_Гр15 (графа 15)
        + "\n" + "       t_onerousClaimCategory,                    "
        // Графа 16
        + "\n" + "       t_restLinkedAccount,                       "
        // Графа 17
        + "\n" + "       t_redemptionDate,                          "
        + "\n" + "       t_linkedAccount,                           "
        // Атрибут: Признак_Обрем
        + "\n" + "       CASE                                       "
        + "\n" + "           WHEN SUBSTR(t_onerousClaim, 1, 1) = 'X'"
        + "\n" + "               THEN ''                            "
        + "\n" + "           ELSE SUBSTR(t_onerousClaim, 1, 1)      "
        + "\n" + "       END                  AS t_onerousSign,     "
        // Атрибут: Филиал_SWIFT
        + "\n" + "       CASE                                       "
        + "\n" + "           WHEN SUBSTR(t_identifier, 2, 3) = 'YYY'"
        + "\n" + "               THEN ''                            "
        + "\n" + "           ELSE SUBSTR(t_identifier, 2, 3)        "
        + "\n" + "       END                  AS t_swiftDepartment, "
        // Атрибут: Условный_Код
        + "\n" + "       CASE                                       "
        + "\n" + "           WHEN SUBSTR(t_identifier, 1, 1) = 'X'  "
        + "\n" + "               THEN ''                            "
        + "\n" + "           ELSE SUBSTR(t_identifier, 1, 1)        "
        + "\n" + "       END                  AS t_conditionalCode, "

        + "\n" + "       CASE                                                                "
        + "\n" + "           WHEN t_onerousClaimCategory = '4'                               "
        + "\n" + "           THEN COALESCE((SELECT rep_note.getTextAccountNote(objLink.t_id, "
                                                                             + RCB_NOTEKIND_OTHER_ONEROUS_OBLIGATION_EXPLANATION
                                                                             + ", "
                                                                             + SQL_END_DATE
                                                                             + ")            "
        + "\n" + "                            FROM dRepLinkedObjects_vw objLink              "
        + "\n" + "                           WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                             AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "                             AND objLink.t_isInstalledForEndDate = 1       "
        + "\n" + "                             AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                             AND objLink.t_connectObjectId       = t_objectId"
        + "\n" + "                         ),                                                "
        + "\n" + "                         CHR(1)                                            "
        + "\n" + "                        )                                                  "
        + "\n" + "           ELSE ''                                                         "
        + "\n" + "       END                  AS t_otherDecoding                             "
        + "\n" + "  FROM ("+ getQueryForData() + ") data                                     "
               ;

        // Начало запроса. Отбор данных по условиям соответствия (продолжение. Часть отбора по условиям соответствия находится в cacheAccData()).
        query =  "WITH commonData                                                                               "
        + "\n" + "  AS (SELECT acc.t_chapter,              acc.t_account,                                       "
        + "\n" + "             acc.t_accountId,            acc.t_fiId,                                          "
        + "\n" + "             acc.t_kind                                                 AS t_kindAccount,     "
        + "\n" + "             SUBSTR(acc.t_balance, 1, 5)                                AS t_balance,         "
        + "\n" + "             acc.t_inCoverRest,          acc.t_outCoverRest,                                  "
        + "\n" + "             acc.t_objectId,                                                                  "
        + "\n" + "             acc.t_operationDate + acc.t_daysToEnd                      AS t_operationEndDate,"
        + "\n" + "             acc.t_contragentId                                         AS t_partyId,         "
        + "\n" + "             acc.t_debet,                acc.t_credit,                                        "
        + "\n" + "             acc.t_part,                                                                      "
        + "\n" + "             acc.t_securOpenDate,        acc.t_securDebtDate,                                 "
        + "\n" + "             acc.t_securRate,            acc.t_isDebtRepo,                                    "
        + "\n" + "             acc.t_isDebtCentralCounterParty,                                                 "
        + "\n" + "             acc.t_isSecurities,                                                              "
        + "\n" + "             acc.t_typeAccount,          acc.t_isRepCategCC,                                  "
        + "\n" + "             acc.t_isRepCategExcludeAcc,                                                      "
        + "\n" + "             acc.t_isRepCategDiscount,                                                        "
        + "\n" + "             acc.t_isRepCategBonus,                                                           "
        + "\n" + "             acc.t_isCategoryMarginSum,                                                       "
        + "\n" + "             acc.t_isCategoryDiscount,                                                        "
        + "\n" + "             acc.t_isCategoryBonus,                                                           "
        + "\n" + "             acc.t_isExcludedAcc,                                                             "
        + "\n" + "             acc.t_code,                                                                      "
        + "\n" + "             acc.t_isBank,                                                                    "
        + "\n" + "             acc.t_isCentralBank,                                                             "
        + "\n" + "             acc.t_bankRegNumber,                                                             "
        + "\n" + "             acc.t_isResident,                                                                "
        + "\n" + "             acc.t_countryCode,                                                               "
        + "\n" + "             acc.t_isSWIFT,                                                                   "
        + "\n" + "             acc.t_isNSPK,                                                                    "
        + "\n" + "             DECODE(acc.t_isResident,                                                         "
        + "\n" + "                    1,                                                                        "
        + "\n" + "                    acc.t_name,                                                               "
        + "\n" + "                    COALESCE((SELECT pn.t_name                                                "
        + "\n" + "                                FROM dPartyName_dbt pn                                        "
        + "\n" + "                               WHERE pn.t_partyId    = acc.t_contragentId                     "
        + "\n" + "                                 AND pn.t_nameTypeId = 3                                      "
        + "\n" + "                                 AND ROWNUM          < 2), acc.t_name))       AS t_clientName,"
        + "\n" + "             COALESCE((SELECT adr.t_country                                                   "
        + "\n" + "                         FROM dAdress_dbt adr                                                 "
        + "\n" + "                        WHERE adr.t_partyId  = acc.t_contragentId                             "
        + "\n" + "                          AND adr.t_type     = 2                                              "
        + "\n" + "                          AND adr.t_country != CHR(1)),                                       "
        + "\n" + "                      acc.t_countryCode)                                      AS t_nrCountry, "
               + ternary(m_parameters.m_isMmData,
          "\n" + "             CASE                                                                             "
        + "\n" + "                 WHEN EXISTS (SELECT 1                                                        "
        + "\n" + "                                FROM df501MmDeals_tmp mmDeals                                 "
        + "\n" + "                               WHERE mmDeals.t_part = acc.t_part                              "
        + "\n" + "                                 AND acc.t_account = ANY(mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc))"
        + "\n" + "                 THEN 1                                                                       "
        + "\n" + "                 ELSE 0                                                                       "
        + "\n" + "             END                                                        AS t_isMMD,           ",
          "\n" + "             0                                                          AS t_isMMD,           ")
        + "\n" + "             rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", "
                                                                      + RCB_OBJGROUP_FOR_REPORTING
                                                                      + ", 'ГД', acc.t_objectId, "
                                                                      + SQL_END_DATE + ") AS t_isRepCatGD,   "
        + "\n" + "             rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", "
                                                                      + RCB_OBJGROUP_ACTIVEKIND
                                                                      + ", 'Собств_Обременение', acc.t_objectId,"
                                                                      + SQL_END_DATE + ") AS t_isActiveKindEncumbrance,"
        + "\n" + "             rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT     + ", "
                                                                      + RCB_OBJGROUP_ACTIVEKIND
                                                                      + ", 'Третье лицо', acc.t_objectId,       "
                                                                      + SQL_END_DATE + ") AS t_isThirdPerson    "
        + "\n" + "        FROM (SELECT acc.t_chapter,              acc.t_account,                               "
        + "\n" + "                     acc.t_accountId,            acc.t_fiId,                                  "
        + "\n" + "                     acc.t_kind,                 acc.t_balance,                               "
        + "\n" + "                     acc.t_inCoverRest,          acc.t_outCoverRest,                          "
        + "\n" + "                     acc.t_objectId,             acc.t_operationDate,                         "
        + "\n" + "                     acc.t_daysToEnd,                                                         "
        + "\n" + "                     acc.t_debet,                acc.t_credit,                                "
        + "\n" + "                     acc.t_part,                                                              "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 "                     accSec.t_openDate        AS t_securOpenDate,                             "
        + "\n" + "                     accSec.t_debtDate        AS t_securDebtDate,                             "
        + "\n" + "                     accSec.t_rate            AS t_securRate,                                 "
        + "\n" + "                     accSec.t_isDebtRepo,                                                     "
        + "\n" + "                     accSec.t_isDebtCentralCounterParty,                                      "
        + "\n" + "                     COALESCE(accSec.t_isSecurities, 0)                  AS t_isSecurities,   "
        + "\n" + "                     COALESCE(accSec.t_contragentId, acc.t_contragentId) AS t_contragentId,   ",
                 "                     " + getSQLDate(Date(0, 0, 0)) + "                   AS t_securOpenDate,  "
        + "\n" + "                     " + getSQLDate(Date(0, 0, 0)) + "                   AS t_securDebtDate,  "
        + "\n" + "                     0                                                   AS t_securRate,      "
        + "\n" + "                     CHR(1)                                              AS t_isDebtRepo,     "
        + "\n" + "                     CHR(1)                                              AS t_isDebtCentralCounterParty,"
        + "\n" + "                     0                                                   AS t_isSecurities,   "
        + "\n" + "                     acc.t_contragentId                                  AS t_contragentId,   ")
        + "\n" + "                     acc.t_isRepCategCC,                                                      "
        + "\n" + "                     acc.t_isRepCategExcludeAcc,                                              "
        + "\n" + "                     acc.t_isRepCategDiscount,                                                "
        + "\n" + "                     acc.t_isRepCategBonus,                                                   "
        + "\n" + "                     acc.t_isCategoryMarginSum,                                               "
        + "\n" + "                     acc.t_isCategoryDiscount,                                                "
        + "\n" + "                     acc.t_isCategoryBonus,                                                   "
        // Тип лицевого счета из НТ. (раньше было два, тепеь один - "Депозит/кредит". Оставлено для совместимости)
        + "\n" + "                     1                                                   AS t_typeAccount, "
        // Если isExcludedAcc = 1 - значит л/с, был открыт по сделке РЕПО через ц/к и при расчете формы исключен из раздела 1 или 3
        // Если isExcludedAcc = 0 - если л/с по первому разделу, значит он удовлетворяет одному из условий соответствия и
        // если он будет удовлетворять и другим условиям (описанным в commonData) то будет включен в основной отчет; если л/с по третьему разделу,
        // значит он не является исключенным счетом и если будет удовлетворять другим условиям соответствия (описанным в commonData) попадет в отчет
        + "\n" + "                     CASE WHEN acc.t_part = 1                                                 "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 "                          THEN CASE WHEN accSec.t_isSecurities = 1                            "
        + "\n" + "                                    THEN CASE WHEN     accSec.t_isDebtRepo                = " + getSqlString("YES")
        + "\n" + "                                                   AND accSec.t_isDebtCentralCounterParty = " + getSqlString("YES")
        + "\n" + "                                              THEN 1                                          "
        + "\n" + "                                              ELSE 0                                          "
        + "\n" + "                                         END                                                  "
        + "\n" + "                                    ELSE CASE WHEN acc.t_isRepCategCC = 1                     "
        + "\n" + "                                              THEN 1                                          "
        + "\n" + "                                              ELSE 0                                          "
        + "\n" + "                                         END                                                  "
        + "\n" + "                                END                                                           ",
                 "                          THEN CASE WHEN acc.t_isRepCategCC = 1                               "
        + "\n" + "                                    THEN 1                                                    "
        + "\n" + "                                    ELSE 0                                                    "
        + "\n" + "                               END                                                            ")
        + "\n" + "                          WHEN     acc.t_part         = 3                                     "
        + "\n" + "                               AND acc.t_inCoverRest  = 0                                     "
        + "\n" + "                               AND acc.t_outCoverRest = 0                                     "
        + "\n" + "                               AND (acc.t_credit <> 0 OR acc.t_debet <> 0)                    "
        + "\n" + "                          THEN 1                                                              "
        + "\n" + "                          ELSE 0                                                              "
        + "\n" + "                     END                                                 AS t_isExcludedAcc,  "
        + "\n" + "                     acc.t_code,                                                              "
        + "\n" + "                     acc.t_isBank,                                                            "
        + "\n" + "                     acc.t_isCentralBank,                                                     "
        + "\n" + "                     acc.t_bankRegNumber,                                                     "
        + "\n" + "                     acc.t_isResident,                                                        "
        + "\n" + "                     acc.t_countryCode,                                                       "
        + "\n" + "                     acc.t_isSWIFT,                                                           "
        + "\n" + "                     acc.t_name,                                                              "
        + "\n" + "                     acc.t_isNSPK                                                             "
        + "\n" + "                FROM df501Accounts_tmp   acc                                                  "
        + "\n" + ternary(m_parameters.m_isSecuritiesData,
                 "                   , df501Securities_tmp accSec                                               "
        + "\n" + "               WHERE acc.t_accountId = accSec.t_accountId(+)                                  ",
                 "")
        + "\n" + "             ) acc                                                                            "
        + "\n" + "       WHERE (   acc.t_inCoverRest  <> 0                                                      "
        + "\n" + "              OR acc.t_outCoverRest <> 0                                                      "
        + "\n" + "              OR acc.t_credit       <> 0                                                      "
        + "\n" + "              OR acc.t_debet        <> 0)                                                     "
        + "\n" + "         AND (   acc.t_isRepCategExcludeAcc = 0                                               "
        + "\n" + "              OR acc.t_isExcludedAcc        = 1)                                              "
        // Общий отбор по контрагенту по счету (раздел ТЗ 4.2.4, начало) производится в cacheAccData()
        // Специфичные условия для разных разделов отчета
        + "\n" + "         AND (   (    acc.t_part              = 1                                             "
        + "\n" + "                  AND (   (    acc.t_balance  = 30215                                         "
        + "\n" + "                           AND acc.t_isNSPK   = 1                                             "
        + "\n" + "                          )                                                                   "
        + "\n" + "                       OR acc.t_balance      != 30215                                         "
        + "\n" + "                      )                                                                       "
        + ternary(m_parameters.m_isExcludeDiscountByPpt,
          "\n" + "                  AND CASE                                                                    "
        + "\n" + "                          WHEN acc.t_balance IN ('32030','32130','32230','32330')             "
        + "\n" + "                              THEN CASE                                                       "
        + "\n" + "                                       WHEN     SUBSTR(acc.t_account,15,1) = '2'              "
        + "\n" + "                                            AND acc.t_isCategoryDiscount   =  1               "
        + "\n" + "                                           THEN 0                                             "
        + "\n" + "                                       WHEN acc.t_isRepCategDiscount != 0                     "
        + "\n" + "                                           THEN 0                                             "
        + "\n" + "                                       ELSE 1                                                 "
        + "\n" + "                                   END                                                        "
        + "\n" + "                          ELSE 1                                                              "
        + "\n" + "                      END = 1                                                                 ",
          "\n" + "                  AND 1=1                                                                     ")
        + ternary(m_parameters.m_isExcludeBonusByPpt,
          "\n" + "                  AND CASE                                                                    "
        + "\n" + "                          WHEN acc.t_balance IN ('32030','32130','32230','32330')             "
        + "\n" + "                              THEN CASE                                                       "
        + "\n" + "                                       WHEN     SUBSTR(acc.t_account,15,1) = '1'              "
        + "\n" + "                                            AND acc.t_isCategoryBonus      =  1               "
        + "\n" + "                                           THEN 0                                             "
        + "\n" + "                                       WHEN acc.t_isRepCategBonus != 0                        "
        + "\n" + "                                           THEN 0                                             "
        + "\n" + "                                       ELSE 1                                                 "
        + "\n" + "                                   END                                                        "
        + "\n" + "                          ELSE 1                                                              "
        + "\n" + "                      END = 1                                                                 ",
          "\n" + "                  AND 1=1                                                                     ")
        + "\n" + "                 )                                                                            "
        + "\n" + "              OR (    acc.t_part = 2                                                          "
        + "\n" + "                  AND (   (    acc.t_isSecurities = 1                                         "
        + "\n" + "                           AND (   acc.t_isDebtRepo                     = " + getSqlString("NO")
        + "\n" + "                                OR (    acc.t_isDebtRepo                = " + getSqlString("YES")
        + "\n" + "                                    AND acc.t_isDebtCentralCounterParty = " + getSqlString("NO")
        + "\n" + "                                   )                                                          "
        + "\n" + "                               )                                                              "
        + "\n" + "                          )                                                                   "
        + "\n" + "                       OR (    acc.t_isSecurities = 0                                         "
        + "\n" + "                           AND acc.t_isRepCategCC = 0                                         "
        + "\n" + "                          )                                                                   "
        + "\n" + "                      )                                                                       "
        + "\n" + "                 )                                                                            "
        + "\n" + "              OR (    acc.t_part = 3                                                          "
        + "\n" + "                  AND (   (    acc.t_isSecurities = 1                                         "
        + "\n" + "                           AND acc.t_isDebtRepo                = " + getSqlString("YES")
        + "\n" + "                           AND acc.t_isDebtCentralCounterParty = " + getSqlString("YES")
        + "\n" + "                          )                                                                   "
        + "\n" + "                       OR (    acc.t_isSecurities = 0                                         "
        + "\n" + "                           AND acc.t_isRepCategCC = 1                                         "
        + "\n" + "                          )                                                                   "
        + "\n" + "                      )                                                                       "
        + "\n" + "                 )                                                                            "
        + "\n" + "             )                                                                                "
        + "\n" + "     ),                                                                                       "
        + "\n" + "  accountTable                  "
        + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *"
        + "\n" + "        FROM commonData         "
        + "\n" + "     )                          "
        + "\n" + "SELECT *                        "
        + "\n" + "  FROM (" + query + ")          "
               ;
        return query;
    end;

    macro FillTempTable()
        SQL_Truncate("df501_tmp");
        SQL_Truncate("df501Securities_tmp");
        SQL_Truncate("df501Accounts_tmp");
        SQL_Truncate("df501MmDeals_tmp");

        global.initializeRepDataPackage(SQL_BEGIN_DATE, SQL_END_DATE);

        if (m_parameters.m_isSecuritiesData)
            cacheSecuritiesData();
        end;
        cacheAccData();
        if (m_parameters.m_isMmData)
            cacheMmdData();
        end;

        // В функции getQuery() (и в фунцияях, которые используются внутри данной функции) формируется запрос
        // на получние (расчет) данных по атрибутам.
        // Изначально вставка данных во временную таблицу проводилась посредством одиночных запросов.
        // Такой способ можно посмотреть в классах для предыдущих Указов или в предыдущих ревизиях в репозитории.
        var query = "INSERT INTO DF501_TMP   "
           + "\n" + "(t_account,             "
           + "\n" + " t_accountId,           "
           + "\n" + " t_balance,             "
           + "\n" + " t_printedAccount,      "
           + "\n" + " t_clientName,          "
           + "\n" + " t_regNumber,           "
           + "\n" + " t_countryCode,         "
           + "\n" + " t_beginRest,           "
           + "\n" + " t_debet,               "
           + "\n" + " t_credit,              "
           + "\n" + " t_endRest,             "
           + "\n" + " t_perfomanceDate,      "
           + "\n" + " t_perfomanceDateDealId,"
           + "\n" + " t_perfomanceDateKliko, "
           + "\n" + " t_rate,                "
           + "\n" + " t_rateDealId,          "
           + "\n" + " t_clientCode,          "
           + "\n" + " t_partReport,          "
           + "\n" + " t_typeAccount,         "
           + "\n" + " t_kindAccount,         "
           + "\n" + " t_part,                "
           + "\n" + " t_isRepoAccount,       "
           + "\n" + " t_isSecurities,        "
           + "\n" + " t_isClientResident,    "
           + "\n" + " t_isGD,                "
           + "\n" + " t_isExistCorrect,      "
           + "\n" + " t_isThirdPerson,       "
           + "\n" + " t_isExcludedAcc,       "
           + "\n" + " t_singDepending,       "
           + "\n" + " t_prolongationAmount,  "
           + "\n" + " t_explanation,         "
           + "\n" + " t_BIC,                 "
           + "\n" + " t_onerousClaim,        "
           + "\n" + " t_identifier,          "
           + "\n" + " t_onerousClaimCategory,"
           + "\n" + " t_restLinkedAccount,   "
           + "\n" + " t_redemptionDate,      "
           + "\n" + " t_linkedAccount,       "
           + "\n" + " t_onerousSign,         "
           + "\n" + " t_swiftDepartment,     "
           + "\n" + " t_conditionalCode,     "
           + "\n" + " t_otherDecoding        "
           + "\n" + ")                       "
           + "\n" + getQuery();

        sql_execute(query);
    end;

    macro SaveVariables(parameters : TParameters)
        //var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfileForManualInput"));
        //profiler.clear();
        //profiler.on();

        private macro SavePart(NumPart, parameters:TParameters)
            var Query = "  SELECT *              "
               + "\n" + "    FROM df501_tmp      "
               + "\n" + "   WHERE t_PartReport = " + NumPart
               + "\n" + "     AND t_isExcludedAcc = 0";

            if( parameters.m_SortBalance)
                Query = Query + " ORDER BY t_Balance ";
                if( parameters.m_SortClient == 0)
                    Query = Query + ", t_ClientCode, t_PrintedAccount ";
                elif( parameters.m_SortClient == 5)
                    Query = Query + ", t_ClientName, t_PrintedAccount ";
                end;
            else
                Query = Query + " ORDER BY ";
                if( parameters.m_SortClient == 0)
                    Query = Query + " t_ClientCode, t_Account ";
                elif( parameters.m_SortClient == 5)
                    Query = Query + " t_ClientName, t_Account ";
                end;
            end;

            var dataSet = TRsbDataSet( Query );
            var VarName = "Ф501_" + NumPart;
            var CompositeValue;

            dataSet.setFieldType("perfomanceDate",      V_DATE);
            dataSet.setFieldType("perfomanceDateKliko", V_DATE);
            dataSet.setFieldType("redemptionDate",      V_DATE);
            while( dataSet.Next() )
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("ПризнакРЕПО").exact           = dataSet.isRepoAccount;
                CompositeValue.fieldValue("ПризнакСчетSecurities").exact = dataSet.isSecurities;
                CompositeValue.fieldValue("ПризнакГД").exact             = dataSet.isGD;
                CompositeValue.fieldValue("ПризнакТретьеЛицо").exact     = dataSet.isThirdPerson;
                CompositeValue.fieldValue("ПризнакИП").exact             = dataSet.isExistCorrect;
                CompositeValue.fieldValue("ПризнакРезидентности").exact  = dataSet.isClientResident;
                CompositeValue.fieldValue("НомЛС").exact                 = dataSet.account;
                CompositeValue.fieldValue("НомБС").exact                 = dataSet.balance;
                CompositeValue.fieldValue("ОтчНомЛС").exact              = dataSet.PrintedAccount;
                CompositeValue.fieldValue("НаимКО").exact                = dataSet.clientName;
                CompositeValue.fieldValue("РегНом").exact                = dataSet.RegNumber;
                CompositeValue.fieldValue("КодСтр").exact                = dataSet.CountryCode;
                CompositeValue.fieldValue("ОстВход").exact               = NVL(dataSet.BeginRest,                   0.0);
                CompositeValue.fieldValue("ОбДебет").exact               = NVL(dataSet.debet,                       0.0);
                CompositeValue.fieldValue("ОбКредит").exact              = NVL(dataSet.credit,                      0.0);
                CompositeValue.fieldValue("ОстИсход").exact              = NVL(dataSet.EndRest,                     0.0);
                CompositeValue.fieldValue("ПризнакЗависимости").exact    = string(NVL(dataSet.singDepending,        ""));
                CompositeValue.fieldValue("КолПролонгаций").exact        = NVL(dataSet.prolongationAmount,          -1);
                CompositeValue.fieldValue("Пояснения").exact             = string(NVL(dataSet.explanation,          ""));
                CompositeValue.fieldValue("БИК").exact                   = string(NVL(dataSet.BIC,                  ""));
                CompositeValue.fieldValue("ЛицоПоОбрем").exact           = string(NVL(dataSet.onerousClaim,         ""));
                CompositeValue.fieldValue("ИдентификаторОбрем").exact    = string(NVL(dataSet.identifier,           ""));
                CompositeValue.fieldValue("ВидОбрем").exact              = string(NVL(dataSet.onerousClaimCategory, ""));
                CompositeValue.fieldValue("ОстатокПоСчетуОбрем").exact   = NVL(dataSet.restLinkedAccount,           0.0);
                CompositeValue.fieldValue("ДатаПогашения").exact         = string(NVL(dataSet.redemptionDate,       ""));
                if (dataSet.PerfomanceDate == null)
                    CompositeValue.fieldValue("ДатаИспОб").exact = "д/в";
                else
                    CompositeValue.fieldValue("ДатаИспОб").exact = String(ternary(dataSet.PerfomanceDate != Date(0,0,0), dataSet.PerfomanceDate, ""));
                end;
                if (dataSet.PerfomanceDateKliko == null)
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = CompositeValue.fieldValue("ДатаИспОб").exact;
                else
                    CompositeValue.fieldValue("ДатаИспОбKliko").exact = String(ternary(dataSet.PerfomanceDateKliko != Date(0,0,0), dataSet.PerfomanceDateKliko, ""));
                end;
                CompositeValue.fieldValue("ПрСтавка").exact              = NVL(dataSet.Rate, 0.0);
                CompositeValue.fieldValue("КодКО").exact                 = NVL(dataSet.ClientCode,             "");
                CompositeValue.fieldValue("ТипЛС").exact                 = string(dataSet.typeAccount);
                CompositeValue.fieldValue("ВидЛС").exact                 = string(dataSet.KindAccount);
                CompositeValue.fieldValue("ПризнакОбременения").exact    = string(NVL(dataSet.onerousSign,     ""));
                CompositeValue.fieldValue("ФилиалСВИФТ").exact           = string(NVL(dataSet.swiftDepartment, ""));
                CompositeValue.fieldValue("УсловныйКод").exact           = string(NVL(dataSet.conditionalCode, ""));
                CompositeValue.fieldValue("ИноеРасшифровка").exact       = string(NVL(dataSet.otherDecoding,   ""));

                compositeValue.fieldValue("ОстатокПоСчетуОбрем").recalculateScaled();
                compositeValue.fieldValue("ОстВход").recalculateScaled();
                compositeValue.fieldValue("ОбДебет").recalculateScaled();
                compositeValue.fieldValue("ОбКредит").recalculateScaled();
                compositeValue.fieldValue("ОстИсход").recalculateScaled();
            end;
        end;

        private macro savePartForManualInput(numPart, parameters:TParameters)
            var varName = "Ф501_" + numPart + "ввод";
            var compositeValue = RcbApplication().currentReport.attributeValue(varName).createValueIterator();
            var query;
            var dataSet;
            var customerCode;

            compositeValue.moveFirst();
            while (not compositeValue.isDone())
                customerCode = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
                query =  "SELECT                                                                                                                                               "
                + "\n" + "    data.t_id,                                                                                                                                       "
                + "\n" + "    data.t_name,                                                                                                                                     "
                + "\n" + "    data.t_shortName,                                                                                                                                "
                + "\n" + "    data.t_code,                                                                                                                                     "
                + "\n" + "    data.t_countryCode,                                                                                                                              "
                + "\n" + "    data.t_isResident,                                                                                                                               "
                + "\n" + "    CASE                                                                                                                                             "
                + "\n" + "        WHEN data.t_isCentralBank = 1                                                                                                                "
                + "\n" + "        THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = data.t_id and codes.t_name = 'БИК (ЦБ РФ)')                         "
                + "\n" + "        WHEN data.t_isResident = 1                                                                                                                   "
                + "\n" + "        THEN                                                                                                                                         "
                + "\n" + "            CASE                                                                                                                                     "
                + "\n" + "                WHEN t_regNumber like '%/%'                                                                                                          "
                + "\n" + "                THEN SUBSTR(t_regNumber, 1, INSTR(t_regNumber, '/')-1)                                                                               "
                + "\n" + "                ELSE COALESCE(t_regNumber, CHR(1))                                                                                                   "
                + "\n" + "            END                                                                                                                                      "
                + "\n" + "        ELSE                                                                                                                                         "
                + "\n" + "            CASE                                                                                                                                     "
                + "\n" + "                WHEN data.t_isswift = 1                                                                                                              "
                + "\n" + "                THEN COALESCE(t_regNumber, 'НР')                                                                                                     "
                + "\n" + "                ELSE 'НР'                                                                                                                            "
                + "\n" + "            END                                                                                                                                      "
                + "\n" + "    END AS t_regNumber                                                                                                                               "
                + "\n" + "FROM                                                                                                                                                 "
                + "\n" + "   (SELECT                                                                                                                                           "
                + "\n" + "        party.t_id,                                                                                                                                  "
                + "\n" + "        DECODE(party.t_isResident, 1,party.t_name, COALESCE((SELECT pn.t_name FROM dPartyName_dbt pn WHERE pn.t_partyId = party.t_id AND pn.t_nameTypeId = 3 AND ROWNUM < 2), party.t_name)) AS t_name, "
                + "\n" + "        party.t_shortName,                                                                                                                           "
                + "\n" + "        party.t_isResident,                                                                                                                          "
                + "\n" + "        party.t_isCentralBank,                                                                                                                       "
                + "\n" + "        party.t_isswift,                                                                                                                             "
                + "\n" + "        codes.t_code as t_code,                                                                                                                      "
                + "\n" + "        codes.t_name as t_nameCode,                                                                                                                  "
                + "\n" + "        COALESCE((SELECT country.t_CodeNum3 FROM dcountry_dbt country WHERE country.t_CodeLat3 =(SELECT adr.t_country FROM dAdress_dbt adr WHERE adr.t_partyId = party.t_id AND adr.t_type = 2)),"
                + "\n" + "                 (CASE                                                                                                                               "
                + "\n" + "                     WHEN (party.t_isResident = 0)                                                                                                   "
                + "\n" + "                         THEN DECODE(party.t_countryCode, CHR(1), '???', (SELECT country.t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = party.t_countryCode))"
                + "\n" + "                         ELSE COALESCE((SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = 'RUS'), CHR(1))                                      "
                + "\n" + "                 END)) t_countryCode,                                                                                                                "
                + "\n" + "        CASE                                                                                                                                         "
                + "\n" + "            WHEN exists (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')"
                + "\n" + "                THEN (select t_code from dRepPartyCodes_vw codes where codes.t_partyId = party.t_id and codes.t_name = 'Рег. номер кред. орг-ции')   "
                + "\n" + "                ELSE CHR(1)                                                                                                                          "
                + "\n" + "        END as t_regNumber                                                                                                                           "
                + "\n" + "    FROM                                                                                                                                             "
                + "\n" + "        dRepParty_vw      party,                                                                                                                     "
                + "\n" + "        dRepPartyCodes_vw codes,                                                                                                                     "
                + "\n" + "        dCountry_dbt      country                                                                                                                    "
                + "\n" + "    WHERE                                                                                                                                            "
                + "\n" + "        party.t_id = (SELECT codes.t_partyId                                                                                                         "
                + "\n" + "                        FROM dRepPartyCodes_vw codes                                                                                                 "
                + "\n" + "                       WHERE codes.t_code = '" + customerCode + "'"
                + "\n" + "                         AND codes.t_name = 'Код')                                                                                                   "
                + "\n" + "        AND codes.t_name       = 'Код'                                                                                                               "
                + "\n" + "        AND codes.t_partyId    = party.t_id                                                                                                          "
                + "\n" + "        AND country.t_codeLat3 = party.t_countrycode                                                                                                 "
                + "\n" + ") data                                                                                                                                               ";
                dataSet = TRsbDataSet(query);
                if (dataSet.moveNext())
                    compositeValue.currentItem.fieldValue("НаимКО").current               = NVL(dataSet.name,        "");
                    compositeValue.currentItem.fieldValue("РегНом").current               = NVL(dataSet.regNumber,   "");
                    compositeValue.currentItem.fieldValue("КодСтр").current               = NVL(dataSet.countryCode, "");
                    compositeValue.currentItem.fieldValue("КодКО").current                = NVL(dataSet.id,          "");
                    compositeValue.currentItem.fieldValue("ПризнакРезидентности").current = NVL(dataSet.isResident,  1 );
                end;
                compositeValue.currentItem.fieldValue("ОстВход_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОбДебет_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОбКредит_ввод").recalculateScaled();
                compositeValue.currentItem.fieldValue("ОстИсход_ввод").recalculateScaled();
                compositeValue.moveNext();
            end;
        end;

        private macro SavePartExplanation(NumPart)
            var Query = "  SELECT f501.t_account,     "
               + "\n" + "         COALESCE((SELECT account.t_name                        "
               + "\n" + "                     FROM drepaccount_vw account                "
               + "\n" + "                    WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "                  ), CHR(1)                                     "
               + "\n" + "                 ) t_name,                                      "
               + "\n" + "         f501.t_beginRest,   "
               + "\n" + "         f501.t_debet,       "
               + "\n" + "         f501.t_credit,      "
               + "\n" + "         f501.t_endRest      "
               + "\n" + "    FROM df501_tmp f501      "
               + "\n" + "   WHERE f501.t_PartReport    = " + NumPart
               + "\n" + "     AND f501.t_isExcludedAcc = 1 "
               + "\n" + "ORDER BY f501.t_account";

            var dataSet = TRsbDataSet(Query);
            var VarName = "Ф501_" + NumPart + "Пояснения";
            var CompositeValue;

            while(dataSet.Next())
                CompositeValue = m_report.AttributeValue(VarName).AddValue();
                CompositeValue.fieldValue("НомЛС").exact    = dataSet.t_account;
                CompositeValue.fieldValue("НаимЛС").exact   = dataSet.t_name;
                CompositeValue.fieldValue("ОстВход").exact  = NVL(dataSet.t_beginRest, 0.0);
                CompositeValue.fieldValue("ОбДебет").exact  = NVL(dataSet.t_debet,     0.0);
                CompositeValue.fieldValue("ОбКредит").exact = NVL(dataSet.t_credit,    0.0);
                CompositeValue.fieldValue("ОстИсход").exact = NVL(dataSet.t_endRest,   0.0);

                compositeValue.fieldValue("ОстВход").recalculateScaled();
                compositeValue.fieldValue("ОбДебет").recalculateScaled();
                compositeValue.fieldValue("ОбКредит").recalculateScaled();
                compositeValue.fieldValue("ОстИсход").recalculateScaled();
            end;
        end;

        SavePart(1, parameters);
        SavePart(2, parameters);
        SavePart(3, parameters);
        savePartForManualInput(1, parameters);
        savePartForManualInput(2, parameters);
        SavePartExplanation(1);
        SavePartExplanation(3);
    end;

    macro updateSecuritiesAccount()
        // Не используется
    end;

    private macro constructorTCalculator_5456(report : RcbReport, tuneTable : RcbTuneTable)
        initTCalculator_4212(report);

        if ((tuneTable != null) or (valType(tuneTable) != V_UNDEF))
            m_tuneTable = tuneTable;
        end;
    end;

    constructorTCalculator_5456(report, tuneTable);
end;

/***************************************************************************************************
 *  Класс управления расчетом
 **************************************************************************************************/
private class TCalculatorController( )
    private var m_report = RcbApplication().currentReport;
    private var m_calculator;

    private macro initialize()
        m_calculator = TCalculator(m_report);
    end;

    private macro CheckReport()
        if (m_report == NULL)
            Throw(TNullCurrentReportError());
        end;

        if (    (m_report.form.id != "Форма 501")
            and (m_report.form.id != "Форма 501-УП")
            and (m_report.form.id != "Форма 501 по 5456-У")
           )
            Throw(TWrongFormError());
        end;

        /*if (m_report.form.dimension != m_report.dimension)
            Throw(TWrongDimensionError());
        end;*/
    end;

    private macro Calculate(parameters : TParameters)
        if(parameters.step == "FillData")
            var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProfile"));
            profiler.clear();
            profiler.on();

            message("Очистка переменных формы");
            m_calculator.removeVariables();
            message("Расчет");
            m_calculator.FillTempTable();
        elif(parameters.step == "SaveVariable")
            message("Сохранение рассчитанных данных");
            m_calculator.saveVariables();
        elif( parameters.step == "UpdateSecuritiesAccount")
            message("Актуализация данных Securities");
            m_calculator.updateSecuritiesAccount();
        end;
    end;

    macro execute(parameters : TParameters)
        CheckReport();
        Calculate(parameters);

        if( parameters.step == "SaveVariable")
            RcbApplication().transactionManager.Commit();
        end;
    end;

    initialize();
end;

private class (TCalculatorController) TCalculatorController_2332()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_2332(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_3129()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_3129(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_3269()
    initTCalculatorController;

    private macro initialize()
        m_calculator = TCalculator_3269(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_4212()
    initTCalculatorController();

    private macro initialize()
        m_calculator = TCalculator_4212(m_report);
    end;
end;

private class (TCalculatorController) TCalculatorController_5586()
    initTCalculatorController();

    private macro initialize()
        m_calculator = TCalculator_5586(m_report, TF501TuneTable("dt501_dbt", RCB_I5586_DATE), TParameters_5586());
    end;
end;

private class (TCalculatorController) TCalculatorController_5456()
    initTCalculatorController();

    private macro initialize()
        m_calculator = TCalculator_5456(m_report, TF501TuneTable("dt501_dbt", RCB_I5456_DATE), TParameters_5586());
    end;
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()
    if   (   (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE)
          or (is5456RSHBChangesProject() and (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE_F501)))
        TCalculatorController_5456().Execute(TParameters_5586());
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I5586_DATE)
        TCalculatorController_5586().Execute(TParameters_5586());
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I4212_DATE)
        TCalculatorController_4212().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3269_DATE)
        TCalculatorController_3269().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3129_DATE)
        TCalculatorController_3129().Execute(TParameters());
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I2332_DATE)
        TCalculatorController_2332().Execute(TParameters());
    else
        TCalculatorController().Execute(TParameters());
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/
main();

УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
