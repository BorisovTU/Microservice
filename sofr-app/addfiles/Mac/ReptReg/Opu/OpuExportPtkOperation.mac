/*
$Name:        OpuExportPtkOperation.mac
$Module:      Регламентируемая отчетность
$Description: классы экспорта в АС ПСД
*/
/*-------------------------------------------------------------------------------------------------┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Операции по экспорту в АС ПСД для 102 формы (ОПУ)

  Создан: 23.05.2008 - Deulya.

L-------------------------------------------------------------------------------------------------*/
import RcbPtkPsdView;

class  OpuExportPtkPsdOperation()

    private var m_attributeValue : RcbAttributeValue=RcbApplication().currentReport.attributeValue("Символы");
    private var m_valueArray : TArray;     /*массив для хранения полученных данных*/

    private macro getValueArray(klikoSymbol : String, symbol : String, isReferenceSymbol : Bool) : TArray
        var m_valueArray : TArray;
        var m_keyValue   = m_attributeValue.createKeyValue();

        m_keyValue.fieldValue("code") = symbol;
        var m_rcbValue = m_attributeValue.findValue(m_keyValue);

        if (m_rcbValue != null)
            m_valueArray = TArray();

            m_valueArray[m_valueArray.size] = klikoSymbol;

            if (not isReferenceSymbol)
                m_valueArray[m_valueArray.size] = ternary(m_rcbValue.fieldValue("roubleValue").isDefined(),   m_rcbValue.fieldValue("roubleValue").currentAsString,   "0");
                m_valueArray[m_valueArray.size] = ternary(m_rcbValue.fieldValue("currencyValue").isDefined(), m_rcbValue.fieldValue("currencyValue").currentAsString, "0");
            end;

            m_valueArray[m_valueArray.size] = ternary(m_rcbValue.fieldValue("totalValue").isDefined(),    m_rcbValue.fieldValue("totalValue").currentAsString,    "0");

        end;

        return m_valueArray;
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    private macro getDataSetSymbol()
           return "SELECT t_klikoSymbol,"
         + "\n" + "       t_symbol"
         + "\n" + "  FROM drcbopuklikosymbol_vw"
         + "\n" + " WHERE t_klikoSymbol NOT LIKE '_А%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_Б%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_В%'"
         + "\n" + "   AND t_symbol NOT LIKE '___'"
         + "\n" + "   AND t_klikoSymbol NOT IN ('31003','31004','31005','32003','32004','32005')"
         + "\n" + " ORDER BY t_symbol";
    end;

    private macro exportSymbol(opuPtkPsdView : Object)
        var m_dataSet = TRsbDataSet(getDataSetSymbol());

        var i;

        while(m_dataSet.moveNext())

            m_valueArray = getValueArray(m_dataSet.klikoSymbol, m_dataSet.symbol, false);

            opuPtkPsdView.printRow("F102",m_valueArray[0],"FCODE", m_valueArray[0]);
            opuPtkPsdView.printRow("F102",m_valueArray[0],"SUM_A", m_valueArray[1]);
            opuPtkPsdView.printRow("F102",m_valueArray[0],"SUM_B", m_valueArray[2]);
            opuPtkPsdView.printRow("F102",m_valueArray[0],"SUMM",  m_valueArray[3]);

        end;
    end;

    private macro exportReferenceSymbol(opuPtkPsdView : Object)
        var m_dataSet = TRsbDataSet("SELECT t_klikoSymbol,"
                           + "\n" + "       t_symbol"
                           + "\n" + "  FROM drcbopuklikosymbol_vw"
                           + "\n" + " WHERE t_klikoSymbol IN ('31003','31004','31005','32003','32004','32005')");

        while(m_dataSet.moveNext())

            m_valueArray = getValueArray(m_dataSet.klikoSymbol, m_dataSet.symbol, true);

            opuPtkPsdView.printRow("SPR", m_valueArray[0], "pok", 0);
            opuPtkPsdView.printRow("SPR", m_valueArray[0], "pok", 0);
            opuPtkPsdView.printRow("SPR", m_valueArray[0], "pok", m_valueArray[1]);

        end;
    end;

    macro execute()
        var opuPtkPsdView = TPtkPsdView("102", RcbApplication().currentReport.context.period.endDate+1);
        opuPtkPsdView.setOutputFile(false);

        exportSymbol(opuPtkPsdView);
        if(RcbApplication().currentReport.context.period.kind == RCB_PK_YEAR)
            exportReferenceSymbol(opuPtkPsdView);
        end;

        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В ПТК ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();
        protocolView.printLine("Альбом форм ПТК ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + opuPtkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + opuPtkPsdView.getRowsCount());
    end;

    global.initializePackages();

end;

class (OpuExportPtkPsdOperation) OpuExportPtkPsdOperation2090()

    private var m_AdvisorySymbolCur = TArray(20);
    private var m_AdvisorySymbolNew = TArray(20);

    /*  Номер символа в форме  */        /*  Номер символа, выгружаемый в файл  */
    m_AdvisorySymbolCur[0]  = "26000";    m_AdvisorySymbolNew[0]  = "40001";
    m_AdvisorySymbolCur[1]  = "26101";    m_AdvisorySymbolNew[1]  = "40011";
    m_AdvisorySymbolCur[2]  = "26102";    m_AdvisorySymbolNew[2]  = "40012";
    m_AdvisorySymbolCur[3]  = "26103";    m_AdvisorySymbolNew[3]  = "40013";
    m_AdvisorySymbolCur[4]  = "26104";    m_AdvisorySymbolNew[4]  = "40014";
    m_AdvisorySymbolCur[5]  = "26201";    m_AdvisorySymbolNew[5]  = "40015";
    m_AdvisorySymbolCur[6]  = "26202";    m_AdvisorySymbolNew[6]  = "40016";
    m_AdvisorySymbolCur[7]  = "26203";    m_AdvisorySymbolNew[7]  = "40017";
    m_AdvisorySymbolCur[8]  = "26301";    m_AdvisorySymbolNew[8]  = "40018";
    m_AdvisorySymbolCur[9]  = "26302";    m_AdvisorySymbolNew[9]  = "40019";
    m_AdvisorySymbolCur[10] = "26303";    m_AdvisorySymbolNew[10] = "40110";
    m_AdvisorySymbolCur[11] = "26305";    m_AdvisorySymbolNew[11] = "40111";
    m_AdvisorySymbolCur[12] = "26401";    m_AdvisorySymbolNew[12] = "40112";
    m_AdvisorySymbolCur[13] = "26402";    m_AdvisorySymbolNew[13] = "40113";
    m_AdvisorySymbolCur[14] = "26403";    m_AdvisorySymbolNew[14] = "40114";
    m_AdvisorySymbolCur[15] = "26404";    m_AdvisorySymbolNew[15] = "40115";
    m_AdvisorySymbolCur[16] = "26405";    m_AdvisorySymbolNew[16] = "40116";
    m_AdvisorySymbolCur[17] = "26406";    m_AdvisorySymbolNew[17] = "40117";
    m_AdvisorySymbolCur[18] = "26410";    m_AdvisorySymbolNew[18] = "40118";
    m_AdvisorySymbolCur[19] = "26412";    m_AdvisorySymbolNew[19] = "40119";

    private macro getDataSetSymbol()
           return "SELECT t_klikoSymbol,"
         + "\n" + "       t_symbol"
         + "\n" + "  FROM drcbopuklikosymbol2090_vw"
         + "\n" + " WHERE t_klikoSymbol NOT LIKE '_А%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_Б%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_В%'"
         + "\n" + "   AND t_symbol NOT LIKE '___'"
         + "\n" + "   AND t_symbol NOT LIKE '0%'"
         + "\n" + " ORDER BY t_symbol" ;
    end;

    private macro getValueArrayForAdvisorySimbol(compositeValue)
        var valueArray = TArray();
        var i = 0;
        var isBreak = false;

        while ((i < 20) and not isBreak)
            if (String(compositeValue.fieldValue("code").exact) == m_AdvisorySymbolCur[i])
                valueArray[valueArray.size] = m_AdvisorySymbolNew[i];
                valueArray[valueArray.size] = String((compositeValue.fieldValue("value").scaled):0:0);
                isBreak = true;
            end;
            i = i + 1;
        end;

        return valueArray;
    end;

    private macro exportReferenceSymbol(opuPtkPsdView : Object)
        var iterator;
        var isAllNull = true;

        iterator = RcbApplication().currentReport.attributeValue("AdvisorySymbol").createValueIterator();

        iterator.moveFirst();

        while (not iterator.isDone)
            m_valueArray = getValueArrayForAdvisorySimbol(iterator.currentItem);
            opuPtkPsdView.printRow("SPRAV", m_valueArray[0], "SUMM", m_valueArray[1]);
            if (m_valueArray[1] != "0")
                isAllNull = false;
            end;
            iterator.moveNext();
        end;

        if (isAllNull)
            opuPtkPsdView.printRow("PRS", "pr", "pr", "0");
        else
            opuPtkPsdView.printRow("PRS", "pr", "pr", "1");
        end;

    end;

    initOpuExportPtkPsdOperation();
end;

class (OpuExportPtkPsdOperation2090) OpuExportPtkPsdOperation2514()

    private macro getDataSetSymbol()
           return "SELECT t_klikoSymbol,"
         + "\n" + "       t_symbol"
         + "\n" + "  FROM drcbopuklikosymbol2514_vw"
         + "\n" + " WHERE t_klikoSymbol NOT LIKE '_А%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_Б%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_В%'"
         + "\n" + "   AND t_symbol NOT LIKE '___'"
         + "\n" + "   AND t_symbol NOT LIKE '0%'"
         + "\n" + " ORDER BY t_symbol" ;
    end;

    initOpuExportPtkPsdOperation2090();

end;

class (OpuExportPtkPsdOperation2514) OpuExportPtkPsdOperation2835()

    macro execute()
        var opuPtkPsdView = TPtkPsdView("102", RcbApplication().currentReport.context.period.endDate+1);
        opuPtkPsdView.setOutputFile(false);

        exportSymbol(opuPtkPsdView);

        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В ПТК ПСД", "Форма 102. ОТЧЕТ О ФИНАНСОВЫХ РЕЗУЛЬТАТАХ");

        protocolView.setProtocolOutput();
        protocolView.printHead();
        protocolView.printLine("Альбом форм ПТК ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + opuPtkPsdView.getFileName());
        protocolView.printLine("Выгружено строк: " + opuPtkPsdView.getRowsCount());
    end;

    initOpuExportPtkPsdOperation2514();
end;

class (OpuExportPtkPsdOperation2835) OpuExportPtkPsdOperation3053()

    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    private macro getDataSetSymbol()
           return "SELECT t_klikoSymbol,"
         + "\n" + "       t_symbol"
         + "\n" + "  FROM drcbopuklikosymbol3053_vw"
         + "\n" + " WHERE t_klikoSymbol NOT LIKE '_А%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_Б%'"
         + "\n" + "   AND t_klikoSymbol NOT LIKE '_В%'"
         + "\n" + "   AND t_symbol NOT LIKE '___'"
         + "\n" + "   AND t_symbol NOT LIKE '0%'"
         + "\n" + " ORDER BY t_symbol" ;
    end;

    macro execute()
        var opuPtkPsdView = TPtkPsdView("102", RcbApplication().currentReport.context.period.endDate+1);
        opuPtkPsdView.setOutputFile(false);

        exportSymbol(opuPtkPsdView);

        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД", "Форма 102. ОТЧЕТ О ФИНАНСОВЫХ РЕЗУЛЬТАТАХ");

        protocolView.setProtocolOutput();
        protocolView.printHead();
        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + opuPtkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных строк: " + opuPtkPsdView.getRowsCount());
    end;

    initOpuExportPtkPsdOperation2835();

end;
