/*
$Name:          OpuNormalizationOperation.mac
$Module:        Регламентируемая отчетность
$Description:   Нормализация формы 102.
*/

/** !!!
 *  Реализовано:
 *  Атрибут     Балансовый счет
 *  10000_Итого 70601-70705
 *  20000_Итого 70606-70611
 *  32101_Итого 70612
 *  ТЗ:
 *  Атрибут     Балансовый счет
 *  10000_Итого 70601-70705
 *  Р1_7_Итого  70606-70610
 *  28101_Итого 70611
 *  32101_Итого 70612
 *
 *  Т.к. на данный момент не понятна разница для ЦБ в том что будет округлена сумма  (Р1_7+ Р8) или отдельные значения (Р1_7 и Р8), а потом все равно мы просуммируем.
 *  ЦБ требует сходимости с балансом символа 33001 (прибыль) или 33002 (убыток) с разницей счетов 70601-70605 и 70606-70611.
 *  Для расчета 33001(33002) используется не сам символ 20000, а его составляющие - Р1_7 и Р8.
 */

import balanceAttribute;

class TNormalizationOperation()

    private class TValue()
        var exact  = 0;
        var scaled = 0;

        macro isDefined()
            return true;
        end;
    end;

    private macro getCalculate3()
        return TCalculate3();
    end;

    private macro getNormalizationProtocolView()
        return TNormalizationProtocolView();
    end;

    private macro getNormalizer(protocolView)
        return TNormalizer(protocolView) ;
    end;

    private var m_calculate3   = getCalculate3();
    private var m_protocolView = getNormalizationProtocolView();
    private var m_normalizer   = getNormalizer(m_protocolView);

    private macro getValue(value)
        value = nvl(value, TValue());
        return ternary(value.isDefined(), value, TValue())
    end;

    private macro createBalanceReport(isAccumulativeReport)
        var context = rcbApplication.currentReport.context;

        var dataset = TRsbDataset("SELECT t_bdPrevDate AS t_beginDate"
                         + "\n" + "  FROM dcy_rdate_dbt rdate,"
                         + "\n" + "       dcy_forms_dbt forms"
                         + "\n" + " WHERE forms.t_szFormName  = 'Балансовые счета'"
                         + "\n" + "   AND rdate.t_organizationStructure = " + context.organizationStructure
                         + "\n" + "   AND rdate.t_issueMode   = " + context.issueMode
                         + "\n" + "   AND rdate.t_isSummary   = " + rcbSqlBool(context.isSummaryMode)
                         + "\n" + "   AND rdate.t_iFormId     = forms.t_iFormId"
                         + "\n" + "   AND rdate.t_iNumDprt    = " + context.departmentCode
                         + "\n" + "   AND rdate.t_cVarKind    = CHR(0)"
                         + "\n" + "   AND rdate.t_bdRepDate   = " + getSqlDate(context.period.endDate)
                         + "\n" + ternary(isAccumulativeReport,"   AND rdate.t_bdPrevDate <> " + getSqlDate(Date(0, 0, 0)),
                                                               "   AND rdate.t_bdPrevDate  = " + getSqlDate(context.period.beginDate))
                         + "\n" + "   AND rdate.t_cCalculated = 'X'"
                         + "\n" + " ORDER BY t_bdPrevDate ASC");

        dataset.setFieldType("beginDate", V_DATE);

        if (dataset.next())
            return rcbApplication.objectFactory.createReport("Балансовые счета", RcbReportContext(RcbPeriod(dataset.beginDate,
                                                                                                            context.period.endDate),
                                                                                                  context.departmentCode,
                                                                                                  context.issueMode,
                                                                                                  context.organizationStructure,
                                                                                                  context.isSummaryMode));
        else
            m_protocolView.printBalanceAbsence();
        end;

        return null;
    end;

    private macro replaceBalance()
        var node10000 = m_normalizer.node10000();
        var node20000 = m_normalizer.node20000();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node20000.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        node10000.exclude();
        node20000.exclude();

        if (global.isHeadDepartment())
            node32101.exclude();
        end;

        var balanceReport = createBalanceReport(false);

        if (balanceReport == null)
            return;
        end;

        var valueDebet70601 = getValue(balanceReport.attributeValue("Бн70601__Д"));
        var valueDebet70602 = getValue(balanceReport.attributeValue("Бн70602__Д"));
        var valueDebet70603 = getValue(balanceReport.attributeValue("Бн70603__Д"));
        var valueDebet70604 = getValue(balanceReport.attributeValue("Бн70604__Д"));
        var valueDebet70605 = getValue(balanceReport.attributeValue("Бн70605__Д"));
        var valueDebet70606 = getValue(balanceReport.attributeValue("Бн70606__Д"));
        var valueDebet70607 = getValue(balanceReport.attributeValue("Бн70607__Д"));
        var valueDebet70608 = getValue(balanceReport.attributeValue("Бн70608__Д"));
        var valueDebet70609 = getValue(balanceReport.attributeValue("Бн70609__Д"));
        var valueDebet70610 = getValue(balanceReport.attributeValue("Бн70610__Д"));
        var valueDebet70611 = getValue(balanceReport.attributeValue("Бн70611__Д"));
        var valueDebet70612 = getValue(balanceReport.attributeValue("Бн70612__Д"));

        var valueCredit70601 = getValue(balanceReport.attributeValue("Бн70601__К"));
        var valueCredit70602 = getValue(balanceReport.attributeValue("Бн70602__К"));
        var valueCredit70603 = getValue(balanceReport.attributeValue("Бн70603__К"));
        var valueCredit70604 = getValue(balanceReport.attributeValue("Бн70604__К"));
        var valueCredit70605 = getValue(balanceReport.attributeValue("Бн70605__К"));
        var valueCredit70606 = getValue(balanceReport.attributeValue("Бн70606__К"));
        var valueCredit70607 = getValue(balanceReport.attributeValue("Бн70607__К"));
        var valueCredit70608 = getValue(balanceReport.attributeValue("Бн70608__К"));
        var valueCredit70609 = getValue(balanceReport.attributeValue("Бн70609__К"));
        var valueCredit70610 = getValue(balanceReport.attributeValue("Бн70610__К"));
        var valueCredit70611 = getValue(balanceReport.attributeValue("Бн70611__К"));
        var valueCredit70612 = getValue(balanceReport.attributeValue("Бн70612__К"));

        var valueDebetReceiptsExact   = valueDebet70601.exact   + valueDebet70602.exact   + valueDebet70603.exact   + valueDebet70604.exact   + valueDebet70605.exact;
        var valueDebetReceiptsScaled  = valueDebet70601.scaled  + valueDebet70602.scaled  + valueDebet70603.scaled  + valueDebet70604.scaled  + valueDebet70605.scaled;
        var valueCreditReceiptsExact  = valueCredit70601.exact  + valueCredit70602.exact  + valueCredit70603.exact  + valueCredit70604.exact  + valueCredit70605.exact;
        var valueCreditReceiptsScaled = valueCredit70601.scaled + valueCredit70602.scaled + valueCredit70603.scaled + valueCredit70604.scaled + valueCredit70605.scaled;

        var valueDebetExpenditureExact   = valueDebet70606.exact   + valueDebet70607.exact   + valueDebet70608.exact   + valueDebet70609.exact   + valueDebet70610.exact   + valueDebet70611.exact;
        var valueDebetExpenditureScaled  = valueDebet70606.scaled  + valueDebet70607.scaled  + valueDebet70608.scaled  + valueDebet70609.scaled  + valueDebet70610.scaled  + valueDebet70611.scaled;
        var valueCreditExpenditureExact  = valueCredit70606.exact  + valueCredit70607.exact  + valueCredit70608.exact  + valueCredit70609.exact  + valueCredit70610.exact  + valueCredit70611.exact;
        var valueCreditExpenditureScaled = valueCredit70606.scaled + valueCredit70607.scaled + valueCredit70608.scaled + valueCredit70609.scaled + valueCredit70610.scaled + valueCredit70611.scaled;

        var valueReceiptsExact     = valueCreditReceiptsExact    - valueDebetReceiptsExact;
        var valueReceiptsScaled    = valueCreditReceiptsScaled   - valueDebetReceiptsScaled;
        var valueExpenditureExact  = valueDebetExpenditureExact  - valueCreditExpenditureExact;
        var valueExpenditureScaled = valueDebetExpenditureScaled - valueCreditExpenditureScaled;
        var value70612Exact        = valueDebet70612.exact       - valueCredit70612.exact;
        var value70612Scaled       = valueDebet70612.scaled      - valueCredit70612.scaled;

        if ((node10000.exact == valueReceiptsExact) and (node20000.exact == valueExpenditureExact) and ((global.isHeadDepartment()) and (node32101.exact == value70612Exact)))
            node10000.scaled = valueReceiptsScaled;
            node20000.scaled = valueExpenditureScaled;
            node32101.scaled = value70612Scaled;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605", valueDebetReceiptsExact, valueCreditReceiptsExact);
            end;
            if (node20000.exact != valueExpenditureExact)
                m_protocolView.printDifference(node20000.code, node20000.exact, "70606-70611", valueDebetExpenditureExact, valueCreditExpenditureExact);
            end;
            if ((global.isHeadDepartment()) and (node32101.exact != value70612Exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", valueDebet70612.exact, valueCredit70612.exact);
            end;
        end;
    end;

    private macro replaceBalanceForAccumulativeReport()
        macro setConstantValue(node : Object, constantValue : Double)

            var relation = ReportLinearRelation(RCB_RS_EQUAL);

            node.recalculateScaled();

            var difference = round(Money(abs(node.scaled - constantValue)), 0, 1);

            node.setDef(difference + 1);

            relation.lhs.plus(node);
            relation.rhs.plus(constantValue);

            m_normalizer.addRelation(relation);
        end;

        var node10000 = m_normalizer.node10000();
        var node20000 = m_normalizer.node20000();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node20000.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        var balanceReport = createBalanceReport(true);

        if (balanceReport == null)
            return;
        end;

        var value70601 = getValue(balanceReport.attributeValue("Бн70601__П"));
        var value70602 = getValue(balanceReport.attributeValue("Бн70602__П"));
        var value70603 = getValue(balanceReport.attributeValue("Бн70603__П"));
        var value70604 = getValue(balanceReport.attributeValue("Бн70604__П"));
        var value70605 = getValue(balanceReport.attributeValue("Бн70605__П"));
        var value70606 = getValue(balanceReport.attributeValue("Бн70606__А"));
        var value70607 = getValue(balanceReport.attributeValue("Бн70607__А"));
        var value70608 = getValue(balanceReport.attributeValue("Бн70608__А"));
        var value70609 = getValue(balanceReport.attributeValue("Бн70609__А"));
        var value70610 = getValue(balanceReport.attributeValue("Бн70610__А"));
        var value70611 = getValue(balanceReport.attributeValue("Бн70611__А"));
        var value70612 = getValue(balanceReport.attributeValue("Бн70612__А"));

        var valueReceiptsExact  = value70601.exact  + value70602.exact  + value70603.exact  + value70604.exact  + value70605.exact;
        var valueReceiptsScaled = value70601.scaled + value70602.scaled + value70603.scaled + value70604.scaled + value70605.scaled;

        var valueExpenditureExact  = value70606.exact  + value70607.exact  + value70608.exact  + value70609.exact  + value70610.exact + value70611.exact;
        var valueExpenditureScaled = value70606.scaled + value70607.scaled + value70608.scaled + value70609.scaled + value70610.scaled + value70611.scaled;

        if ((node10000.exact == valueReceiptsExact) and (node20000.exact == valueExpenditureExact) and ((global.isHeadDepartment()) and (node32101.exact == value70612.exact)))

            if (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                setConstantValue(node10000, valueReceiptsScaled);
                setConstantValue(node20000, valueExpenditureScaled);
                setConstantValue(node32101, value70612.scaled);
            elif (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_SM)
                node10000.exclude();
                node20000.exclude();
                node32101.exclude();

                node10000.scaled = valueReceiptsScaled;
                node20000.scaled = valueExpenditureScaled;
                node32101.scaled = value70612.scaled;
            end;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605", valueReceiptsExact);
            end;
            if (node20000.exact != valueExpenditureExact)
                m_protocolView.printDifference(node20000.code, node20000.exact, "70606-70611", valueExpenditureExact);
            end;
            if ((global.isHeadDepartment()) and (node32101.exact != value70612.exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", value70612.exact);
            end;
        end;
    end;

    private macro loadBalance()
        var day, month;
        dateSplit(rcbApplication.currentReport.context.period.beginDate, day, month);

        if ((day == 1) and (month == 1))
            replaceBalanceForAccumulativeReport()
        else
            replaceBalance();
        end;
    end;

    macro showProtocol()
        var protocol = TSummaryProtocolView();

        var protocolDescription = "ПРОТОКОЛ ПРОЦЕДУРЫ НОРМАЛИЗАЦИИ";

        protocol.add(TProtocolView(protocolDescription));

        protocol.show();
    end;

    macro execute()
        m_protocolView.beginProtocol();

        m_normalizer.loadSymbols();

        loadBalance();

        m_normalizer.normalize();

        if (m_normalizer.isNormalized())
            m_protocolView.printLine("Нормализация выполнена.");
            if(rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                m_protocolView.printLine("лог-файл:" + m_normalizer.getLogFilePath());
            end;
            m_normalizer.saveSymbols();
        else
            if(rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                m_protocolView.printLine("Не удалось выполнить нормализацию (смотри лог-файл:" + m_normalizer.getLogFilePath() + ").");
            else
                m_protocolView.printLine("Не удалось провести нормализацию.");
            end;
        end;

        m_protocolView.endProtocol();

        m_calculate3.execute();

        rcbApplication.transactionManager.commit();

        showProtocol();
    end;
end;

class (TNormalizationOperation) TNormalizationOperation2090()
    private macro getCalculate3()
        return TCalculate32090();
    end;

    initTNormalizationOperation();
end;


class (TNormalizationOperation2090) TNormalizationOperation2477()
    private macro getNormalizer(protocolView)
        return TNormalizer2477(protocolView) ;
    end;

    initTNormalizationOperation2090();
end;

class (TNormalizationOperation2477) TNormalizationOperation2654()

    private macro replaceBalance()
        var node10000 = m_normalizer.node10000();
        var node20000 = m_normalizer.node20000();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node20000.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        node10000.exclude();
        node20000.exclude();

        if (global.isHeadDepartment())
            node32101.exclude();
        end;

        var balanceReport = createBalanceReport(false);

        if (balanceReport == null)
            return;
        end;

        var balanceAttribute = TBalanceAttribute("БАЛАНС", balanceReport);

        balanceAttribute.getBalanceAttribute(1, "70601", false);
        var valueDebet70601  = getValue(balanceAttribute.getDebet());
        var valueCredit70601 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70602", false);
        var valueDebet70602  = getValue(balanceAttribute.getDebet());
        var valueCredit70602 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70603", false);
        var valueDebet70603  = getValue(balanceAttribute.getDebet());
        var valueCredit70603 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70604", false);
        var valueDebet70604  = getValue(balanceAttribute.getDebet());
        var valueCredit70604 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70605", false);
        var valueDebet70605  = getValue(balanceAttribute.getDebet());
        var valueCredit70605 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70606", false);
        var valueDebet70606  = getValue(balanceAttribute.getDebet());
        var valueCredit70606 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70607", false);
        var valueDebet70607  = getValue(balanceAttribute.getDebet());
        var valueCredit70607 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70608", false);
        var valueDebet70608  = getValue(balanceAttribute.getDebet());
        var valueCredit70608 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70609", false);
        var valueDebet70609  = getValue(balanceAttribute.getDebet());
        var valueCredit70609 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70610", false);
        var valueDebet70610  = getValue(balanceAttribute.getDebet());
        var valueCredit70610 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70611", false);
        var valueDebet70611  = getValue(balanceAttribute.getDebet());
        var valueCredit70611 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70612", false);
        var valueDebet70612  = getValue(balanceAttribute.getDebet());
        var valueCredit70612 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70613", false);
        var valueDebet70613  = getValue(balanceAttribute.getDebet());
        var valueCredit70613 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70614", false);
        var valueDebet70614  = getValue(balanceAttribute.getDebet());
        var valueCredit70614 = getValue(balanceAttribute.getCredit());

        var valueDebetReceiptsExact   = valueDebet70601.exact   + valueDebet70602.exact   + valueDebet70603.exact   + valueDebet70604.exact   + valueDebet70605.exact   + valueDebet70613.exact;
        var valueDebetReceiptsScaled  = valueDebet70601.scaled  + valueDebet70602.scaled  + valueDebet70603.scaled  + valueDebet70604.scaled  + valueDebet70605.scaled  + valueDebet70613.scaled;
        var valueCreditReceiptsExact  = valueCredit70601.exact  + valueCredit70602.exact  + valueCredit70603.exact  + valueCredit70604.exact  + valueCredit70605.exact  + valueCredit70613.exact;
        var valueCreditReceiptsScaled = valueCredit70601.scaled + valueCredit70602.scaled + valueCredit70603.scaled + valueCredit70604.scaled + valueCredit70605.scaled + valueCredit70613.scaled;

        var valueDebetExpenditureExact   = valueDebet70606.exact   + valueDebet70607.exact   + valueDebet70608.exact   + valueDebet70609.exact   + valueDebet70610.exact   + valueDebet70611.exact   + valueDebet70614.exact;
        var valueDebetExpenditureScaled  = valueDebet70606.scaled  + valueDebet70607.scaled  + valueDebet70608.scaled  + valueDebet70609.scaled  + valueDebet70610.scaled  + valueDebet70611.scaled  + valueDebet70614.scaled;
        var valueCreditExpenditureExact  = valueCredit70606.exact  + valueCredit70607.exact  + valueCredit70608.exact  + valueCredit70609.exact  + valueCredit70610.exact  + valueCredit70611.exact  + valueCredit70614.exact;
        var valueCreditExpenditureScaled = valueCredit70606.scaled + valueCredit70607.scaled + valueCredit70608.scaled + valueCredit70609.scaled + valueCredit70610.scaled + valueCredit70611.scaled + valueCredit70614.scaled;

        var valueReceiptsExact     = valueCreditReceiptsExact    - valueDebetReceiptsExact;
        var valueReceiptsScaled    = valueCreditReceiptsScaled   - valueDebetReceiptsScaled;
        var valueExpenditureExact  = valueDebetExpenditureExact  - valueCreditExpenditureExact;
        var valueExpenditureScaled = valueDebetExpenditureScaled - valueCreditExpenditureScaled;
        var value70612Exact        = valueDebet70612.exact       - valueCredit70612.exact;
        var value70612Scaled       = valueDebet70612.scaled      - valueCredit70612.scaled;

        if ((node10000.exact == valueReceiptsExact) and (node20000.exact == valueExpenditureExact) and ((global.isHeadDepartment()) and (node32101.exact == value70612Exact)))
            node10000.scaled = valueReceiptsScaled;
            node20000.scaled = valueExpenditureScaled;
            node32101.scaled = value70612Scaled;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605,70613", valueDebetReceiptsExact, valueCreditReceiptsExact);
            end;
            if (node20000.exact != valueExpenditureExact)
                m_protocolView.printDifference(node20000.code, node20000.exact, "70606-70611,70614", valueDebetExpenditureExact, valueCreditExpenditureExact);
            end;
            if ((global.isHeadDepartment()) and (node32101.exact != value70612Exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", valueDebet70612.exact, valueCredit70612.exact);
            end;
        end;
    end;

    private macro replaceBalanceForAccumulativeReport()
        macro setConstantValue(node : Object, constantValue : Double)

            var relation = ReportLinearRelation(RCB_RS_EQUAL);

            node.recalculateScaled();

            var difference = round(Money(abs(node.scaled - constantValue)), 0, 1);

            node.setDef(difference + 1);

            relation.lhs.plus(node);
            relation.rhs.plus(constantValue);

            m_normalizer.addRelation(relation);
        end;

        var node10000 = m_normalizer.node10000();
        var node20000 = m_normalizer.node20000();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node20000.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        var balanceReport = createBalanceReport(true);

        if (balanceReport == null)
            return;
        end;

        var balanceAttribute = TBalanceAttribute("БАЛАНС", balanceReport);

        balanceAttribute.getBalanceAttribute(1, "70601", false);
        var value70601 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70602", false);
        var value70602 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70603", false);
        var value70603 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70604", false);
        var value70604 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70605", false);
        var value70605 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70613", false);
        var value70613 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70606", false);

        var value70606 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70607", false);
        var value70607 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70608", false);
        var value70608 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70609", false);
        var value70609 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70610", false);
        var value70610 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70611", false);
        var value70611 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70612", false);
        var value70612 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70614", false);
        var value70614 = getValue(balanceAttribute.getOutRestActive());

        var valueReceiptsExact  = value70601.exact  + value70602.exact  + value70603.exact  + value70604.exact  + value70605.exact  + value70613.exact;
        var valueReceiptsScaled = value70601.scaled + value70602.scaled + value70603.scaled + value70604.scaled + value70605.scaled + value70613.scaled;

        var valueExpenditureExact  = value70606.exact  + value70607.exact  + value70608.exact  + value70609.exact  + value70610.exact  + value70611.exact  + value70614.exact;
        var valueExpenditureScaled = value70606.scaled + value70607.scaled + value70608.scaled + value70609.scaled + value70610.scaled + value70611.scaled + value70614.scaled;

        if ((node10000.exact == valueReceiptsExact) and (node20000.exact == valueExpenditureExact) and ((global.isHeadDepartment()) and (node32101.exact == value70612.exact)))

            if (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                setConstantValue(node10000, valueReceiptsScaled);
                setConstantValue(node20000, valueExpenditureScaled);
                setConstantValue(node32101, value70612.scaled);
            elif (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_SM)
                node10000.exclude();
                node20000.exclude();
                node32101.exclude();

                node10000.scaled = valueReceiptsScaled;
                node20000.scaled = valueExpenditureScaled;
                node32101.scaled = value70612.scaled;
            end;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605,70613", valueReceiptsExact);
            end;
            if (node20000.exact != valueExpenditureExact)
                m_protocolView.printDifference(node20000.code, node20000.exact, "70606-70611,70614", valueExpenditureExact);
            end;
            if ((global.isHeadDepartment()) and (node32101.exact != value70612.exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", value70612.exact);
            end;
        end;
    end;

    initTNormalizationOperation2477();
end;

class (TNormalizationOperation2654) TNormalizationOperation2835()

    macro execute()
        m_protocolView.beginProtocol();

        m_normalizer.loadSymbols();

        loadBalance();

        m_normalizer.normalize();

        if (m_normalizer.isNormalized())
            m_protocolView.printLine("Нормализация выполнена.");
            if(rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                m_protocolView.printLine("лог-файл:" + m_normalizer.getLogFilePath());
            end;
            m_normalizer.saveSymbols();
        else
            if(rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                m_protocolView.printLine("Не удалось выполнить нормализацию (смотри лог-файл:" + m_normalizer.getLogFilePath() + ").");
            else
                m_protocolView.printLine("Не удалось провести нормализацию.");
            end;
        end;

        m_protocolView.endProtocol();

        rcbApplication.transactionManager.commit();

        showProtocol();
    end;

    initTNormalizationOperation2654();
end;

class (TNormalizationOperation2654) TNormalizationOperation3053()
    private macro getNormalizer(protocolView)
        return TNormalizer3053(protocolView) ;
    end;

    private macro replaceBalance()
        var node10000 = m_normalizer.node10000();
        var node2ABV  = m_normalizer.node2ABV();
        var node28101 = m_normalizer.node28101();
        var node28102 = m_normalizer.node28102();
        var node28103 = m_normalizer.node28103();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node2ABV.recalculateScaled();
        node28101.recalculateScaled();
        node28102.recalculateScaled();
        node28103.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        node10000.exclude();
        node2ABV.exclude();
        node28101.exclude();
        node28102.exclude();
        node28103.exclude();

        if (global.isHeadDepartment())
            node32101.exclude();
        end;

        var balanceReport = createBalanceReport(false);

        if (balanceReport == null)
            return;
        end;

        var balanceAttribute = TBalanceAttribute("БАЛАНС", balanceReport);

        balanceAttribute.getBalanceAttribute(1, "70601", false);
        var valueDebet70601  = getValue(balanceAttribute.getDebet());
        var valueCredit70601 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70602", false);
        var valueDebet70602  = getValue(balanceAttribute.getDebet());
        var valueCredit70602 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70603", false);
        var valueDebet70603  = getValue(balanceAttribute.getDebet());
        var valueCredit70603 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70604", false);
        var valueDebet70604  = getValue(balanceAttribute.getDebet());
        var valueCredit70604 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70605", false);
        var valueDebet70605  = getValue(balanceAttribute.getDebet());
        var valueCredit70605 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70606", false);
        var valueDebet70606  = getValue(balanceAttribute.getDebet());
        var valueCredit70606 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70607", false);
        var valueDebet70607  = getValue(balanceAttribute.getDebet());
        var valueCredit70607 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70608", false);
        var valueDebet70608  = getValue(balanceAttribute.getDebet());
        var valueCredit70608 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70609", false);
        var valueDebet70609  = getValue(balanceAttribute.getDebet());
        var valueCredit70609 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70610", false);
        var valueDebet70610  = getValue(balanceAttribute.getDebet());
        var valueCredit70610 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70611", false);
        var valueDebet70611  = getValue(balanceAttribute.getDebet());
        var valueCredit70611 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70612", false);
        var valueDebet70612  = getValue(balanceAttribute.getDebet());
        var valueCredit70612 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70613", false);
        var valueDebet70613  = getValue(balanceAttribute.getDebet());
        var valueCredit70613 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70614", false);
        var valueDebet70614  = getValue(balanceAttribute.getDebet());
        var valueCredit70614 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70615", false);
        var valueDebet70615  = getValue(balanceAttribute.getDebet());
        var valueCredit70615 = getValue(balanceAttribute.getCredit());
        balanceAttribute.getBalanceAttribute(1, "70616", false);
        var valueDebet70616  = getValue(balanceAttribute.getDebet());
        var valueCredit70616 = getValue(balanceAttribute.getCredit());

        var valueDebetReceiptsExact   = valueDebet70601.exact   + valueDebet70602.exact   + valueDebet70603.exact   + valueDebet70604.exact   + valueDebet70605.exact   + valueDebet70613.exact;
        var valueDebetReceiptsScaled  = valueDebet70601.scaled  + valueDebet70602.scaled  + valueDebet70603.scaled  + valueDebet70604.scaled  + valueDebet70605.scaled  + valueDebet70613.scaled;
        var valueCreditReceiptsExact  = valueCredit70601.exact  + valueCredit70602.exact  + valueCredit70603.exact  + valueCredit70604.exact  + valueCredit70605.exact  + valueCredit70613.exact;
        var valueCreditReceiptsScaled = valueCredit70601.scaled + valueCredit70602.scaled + valueCredit70603.scaled + valueCredit70604.scaled + valueCredit70605.scaled + valueCredit70613.scaled;

        var valueDebetExpenditureExact   = valueDebet70606.exact   + valueDebet70607.exact   + valueDebet70608.exact   + valueDebet70609.exact   + valueDebet70610.exact   + valueDebet70614.exact;
        var valueDebetExpenditureScaled  = valueDebet70606.scaled  + valueDebet70607.scaled  + valueDebet70608.scaled  + valueDebet70609.scaled  + valueDebet70610.scaled  + valueDebet70614.scaled;
        var valueCreditExpenditureExact  = valueCredit70606.exact  + valueCredit70607.exact  + valueCredit70608.exact  + valueCredit70609.exact  + valueCredit70610.exact  + valueCredit70614.exact;
        var valueCreditExpenditureScaled = valueCredit70606.scaled + valueCredit70607.scaled + valueCredit70608.scaled + valueCredit70609.scaled + valueCredit70610.scaled + valueCredit70614.scaled;

        var valueReceiptsExact     = valueCreditReceiptsExact    - valueDebetReceiptsExact;
        var valueReceiptsScaled    = valueCreditReceiptsScaled   - valueDebetReceiptsScaled;
        var valueExpenditureExact  = valueDebetExpenditureExact  - valueCreditExpenditureExact;
        var valueExpenditureScaled = valueDebetExpenditureScaled - valueCreditExpenditureScaled;

        var value70611Exact        = valueDebet70611.exact       - valueCredit70611.exact;
        var value70611Scaled       = valueDebet70611.scaled      - valueCredit70611.scaled;
        var value70612Exact        = valueDebet70612.exact       - valueCredit70612.exact;
        var value70612Scaled       = valueDebet70612.scaled      - valueCredit70612.scaled;
        var value70615Exact        = valueCredit70615.exact      - valueDebet70615.exact;
        var value70615Scaled       = valueCredit70615.scaled     - valueDebet70615.scaled;
        var value70616Exact        = valueDebet70616.exact       - valueCredit70616.exact;
        var value70616Scaled       = valueDebet70616.scaled      - valueCredit70616.scaled;

        if ((node10000.exact == valueReceiptsExact)    and
            (node2ABV.exact  == valueExpenditureExact) and
            (node28101.exact == value70611Exact)       and
            (node28102.exact == value70616Exact)       and
            (node28103.exact == value70615Exact)       and
            ((global.isHeadDepartment()) and (node32101.exact == value70612Exact)))

            node10000.scaled = valueReceiptsScaled;
            node2ABV.scaled  = valueExpenditureScaled;
            node28101.scaled  = value70611Scaled;
            node28102.scaled  = value70616Scaled;
            node28103.scaled  = value70615Scaled;
            node32101.scaled = value70612Scaled;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605,70613", valueDebetReceiptsExact, valueCreditReceiptsExact);
            end;

            if (node2ABV.exact != valueExpenditureExact)
                m_protocolView.printDifference(node2ABV.code, node2ABV.exact, "70606-70610,70614", valueDebetExpenditureExact, valueCreditExpenditureExact);
            end;

            if (node28101.exact != value70611Exact)
                m_protocolView.printDifference(node28101.code, node28101.exact, "70611", valueDebet70611.exact, valueCredit70611.exact);
            end;

            if (node28102.exact != value70616Exact)
                m_protocolView.printDifference(node28102.code, node28102.exact, "70616", valueDebet70616.exact, valueCredit70616.exact);
            end;

            if (node28103.exact != value70615Exact)
                m_protocolView.printDifference(node28103.code, node28103.exact, "70615", valueCredit70615.exact, valueDebet70615.exact);
            end;

            if ((global.isHeadDepartment()) and (node32101.exact != value70612Exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", valueDebet70612.exact, valueCredit70612.exact);
            end;
        end;
    end;

    private macro replaceBalanceForAccumulativeReport()
        macro setConstantValue(node : Object, constantValue : Double)

            var relation = ReportLinearRelation(RCB_RS_EQUAL);

            node.recalculateScaled();

            var difference = round(Money(abs(node.scaled - constantValue)), 0, 1);

            node.setDef(difference + 1);

            relation.lhs.plus(node);
            relation.rhs.plus(constantValue);

            m_normalizer.addRelation(relation);
        end;

        var node10000 = m_normalizer.node10000();
        var node2ABV  = m_normalizer.node2ABV();
        var node28101 = m_normalizer.node28101();
        var node28102 = m_normalizer.node28102();
        var node28103 = m_normalizer.node28103();
        var node32101 = m_normalizer.node32101();

        node10000.recalculateScaled();
        node2ABV.recalculateScaled();
        node28101.recalculateScaled();
        node28102.recalculateScaled();
        node28103.recalculateScaled();

        if (global.isHeadDepartment())
            node32101.recalculateScaled();
        end;

        var balanceReport = createBalanceReport(true);

        if (balanceReport == null)
            return;
        end;

        var balanceAttribute = TBalanceAttribute("БАЛАНС", balanceReport);

        balanceAttribute.getBalanceAttribute(1, "70601", false);
        var value70601 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70602", false);
        var value70602 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70603", false);
        var value70603 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70604", false);
        var value70604 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70605", false);
        var value70605 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70613", false);
        var value70613 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70606", false);
        var value70606 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70607", false);
        var value70607 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70608", false);
        var value70608 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70609", false);
        var value70609 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70610", false);
        var value70610 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70612", false);
        var value70612 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70614", false);
        var value70614 = getValue(balanceAttribute.getOutRestActive());

        balanceAttribute.getBalanceAttribute(1, "70611", false);
        var value70611 = getValue(balanceAttribute.getOutRestActive());
        balanceAttribute.getBalanceAttribute(1, "70615", false);
        var value70615 = getValue(balanceAttribute.getOutRestPassive());
        balanceAttribute.getBalanceAttribute(1, "70616", false);
        var value70616 = getValue(balanceAttribute.getOutRestActive());


        var valueReceiptsExact  = value70601.exact  + value70602.exact  + value70603.exact  + value70604.exact  + value70605.exact  + value70613.exact;
        var valueReceiptsScaled = value70601.scaled + value70602.scaled + value70603.scaled + value70604.scaled + value70605.scaled + value70613.scaled;

        var valueExpenditureExact  = value70606.exact  + value70607.exact  + value70608.exact  + value70609.exact  + value70610.exact  + value70614.exact;
        var valueExpenditureScaled = value70606.scaled + value70607.scaled + value70608.scaled + value70609.scaled + value70610.scaled + value70614.scaled;

        if ((node10000.exact == valueReceiptsExact)   and
            (node2ABV.exact == valueExpenditureExact) and
            (node28101.exact == value70611.exact)      and
            (node28102.exact == value70616.exact)      and
            (node28103.exact == value70615.exact)      and
            ((global.isHeadDepartment()) and (node32101.exact == value70612.exact)))

            if (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB)
                setConstantValue(node10000, valueReceiptsScaled);
                setConstantValue(node2ABV, valueExpenditureScaled);
                setConstantValue(node28101, value70611.scaled);
                setConstantValue(node28102, value70616.scaled);
                setConstantValue(node28103, value70615.scaled);
                setConstantValue(node32101, value70612.scaled);
            elif (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_SM)
                node10000.exclude();
                node2ABV.exclude();
                node28101.exclude();
                node28102.exclude();
                node28103.exclude();
                node32101.exclude();

                node10000.scaled = valueReceiptsScaled;
                node2ABV.scaled  = valueExpenditureScaled;
                node28101.scaled = value70611.scaled;
                node28102.scaled = value70616.scaled;
                node28103.scaled = value70615.scaled;
                node32101.scaled = value70612.scaled;
            end;
        else
            if (node10000.exact != valueReceiptsExact)
                m_protocolView.printDifference(node10000.code, node10000.exact, "70601-70605,70613", valueReceiptsExact);
            end;

            if (node2ABV.exact != valueExpenditureExact)
                m_protocolView.printDifference(node2ABV.code, node2ABV.exact, "70606-70610,70614", valueExpenditureExact);
            end;

            if (node28101.exact != value70611.exact)
                m_protocolView.printDifference(node28101.code, node28101.exact, "70611", value70611.exact);
            end;

            if (node28102.exact != value70616.exact)
                m_protocolView.printDifference(node28102.code, node28102.exact, "70616", value70616.exact);
            end;

            if (node28103.exact != value70615.exact)
                m_protocolView.printDifference(node28103.code, node28103.exact, "70615", value70615.exact);
            end;

            if ((global.isHeadDepartment()) and (node32101.exact != value70612.exact))
                m_protocolView.printDifference(node32101.code, node32101.exact, "70612", value70612.exact);
            end;
        end;
    end;


    initTNormalizationOperation2654();
end;
