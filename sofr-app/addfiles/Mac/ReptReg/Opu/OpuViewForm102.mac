/*
$Name:        OpuViewForm102.mac
$Module:      Регламентируемая отчетность
$Description: классы для печати отчетной формы 102 (ОФР)
*/
/*
*/

class (TException) TNotExistaMethodtException(methodName : String)
     initTException("Вызов не существующего метода: " + methodName, true);
end;

class (TView) TViewForm102(formName, formOkudCode, formPeriodicity, periodFormat)
    initTView(NVL(formName,          "ОТЧЕТ О ПРИБЫЛЯХ И УБЫТКАХ КРЕДИТНОЙ ОРГАНИЗАЦИИ"),
                NVL(formOkudCode,    "0409102"),
                NVL(formPeriodicity, RCB_PK_QUARTER),
                NVL(periodFormat,    DATE_OUT_PERIOD_FORMAT));

    private macro getPeriodName()
        var reportPeriod = RcbApplication().currentReport.context.period;
        return "по состоянию на " + string((reportPeriod.endDate + 1) : m);
    end;

    macro printDescription()
        printLendingAgencyCodeZone();
        printNamesZone();
    end;

    private macro getPrintableValue(value : RcbValue) : String
        return ternary(value.currentAsString == "Undefined", "", value.currentAsString);
    end;
end;

class (TViewForm102) TViewForm1022055(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm102(formName, formOkudCode, formPeriodicity, periodFormat);
    var advisoryTemplateName = "opu_advisorySymbol.tpl";

    private var m_advisorysymbols = null;
    private var m_advisorykeyValue = null;

    private macro getAdvisorysymbols()
        if (m_advisorysymbols == null)
            m_advisorysymbols = m_report.attributeValue("AdvisorySymbol");
        end;
        return m_advisorysymbols;
    end;

    private macro getAdvisorykeyValue()
        if (m_advisorykeyValue == null)
            m_advisorykeyValue = getAdvisorysymbols().attribute.structure.key.createKeyValue();
        end;
        return m_advisorykeyValue;
    end;

    private macro getAdvisorySymbolValue(symbolCode)
        getAdvisorykeyValue().fieldValue("code") = symbolCode;
        return getAdvisorysymbols().findValue(getAdvisorykeyValue());
    end;

    private macro printSymbol(repForm)
        var fieldId = 0;
        var currentField;
        var symbolValue;
        var symbolMask;

        while (hasTemplateField(repForm, fieldId))
            currentField = repForm.field(fieldId);
            symbolMask = currentField.name;
            symbolValue = getAdvisorySymbolValue(symbolMask);
            currentField.value = getPrintableValue(symbolValue.fieldValue("value"));
            fieldId = fieldId + 1;
        end;
        repForm.write;
    end;

    macro printAdvisoryInformation()
        var repForm;
        repForm = TRepForm(advisoryTemplateName, false, "Head");
        repForm.write;
        var resource = TRsbDataSet("SELECT NVL (t_symbol, '26result')                         t_symbol,"
                + "\n" + "                 DECODE (GROUPING (t_symbol), 1, '26000', t_symbol) t_mask"
                + "\n" + "            FROM drcbopuadvisorysymbol_vw"
                + "\n" + " GROUP BY ROLLUP (t_symbol)"
                + "\n" + "        ORDER BY t_mask");

        while (resource.moveNext())
            repForm = TRepForm(advisoryTemplateName, false, resource.symbol);
            printSymbol(repForm);
        end;

        repForm = TRepForm(advisoryTemplateName, false, "Bottom");
        repForm.write;

    end;

    macro printDescription()
        changePrintZone(MC_LEADING_AGENCY_NAME_WHITHOUT_BRANCH);
        printLendingAgencyCodeZone();
        printNamesZone();
    end;


    macro printDataZone()
        printDataZone();
        printAdvisoryInformation();
    end;
end;

class (TViewForm1022055) TViewForm1022090(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022055(formName, formOkudCode, formPeriodicity, periodFormat);
    templateName  = "OPU_resources2090.tpl";
    symbolTplView = "drcbopusymboltpl2090_vw";
end;

class (TViewForm1022090) TViewForm1022332(formName, formOkudCode, formPeriodicity, periodFormat)

    private macro printHead();
        var repForm = TRepForm(templateName, false, "Head102");
        repForm.write;
    end;

    initTViewForm1022090(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName         = "OPU_resources2332.tpl";
    advisoryTemplateName = "opu_advisorySymbol2332.tpl";
end;

class (TViewForm1022090) TViewForm1022477(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022090(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName  = "OPU_resources2477.tpl";
    symbolTplView = "drcbopusymboltpl2477_vw";
end;

class (TViewForm1022090) TViewForm1022514(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022090(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName  = "OPU_resources2514.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm1022090) TViewForm1022679(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022090(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName  = "OPU_resources2679.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm1022679) TViewForm1022654(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022679(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName  = "OPU_resources2654.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm1022654) TViewForm1022736(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022654(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER)),
                        periodFormat);
    templateName  = "OPU_resources2736.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm1022736) TViewForm1022742(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022736(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                        periodFormat);
end;

class (TViewForm1022742) TViewForm1022800(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022742(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                        periodFormat);
    templateName  = "OPU_resources2800.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm1022800) TViewForm1022835(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022800(formName,
                        formOkudCode,
                        NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                        periodFormat);
    private macro createAccountAdvisoryDataDataSource()
        throw(TNotExistaMethodtException("TCalculationProtocol2835::createAccountAdvisoryDataDataSource"));
    end;

    private macro getAdvisorySymbolValue(symbolCode)
        throw(TNotExistaMethodtException("TViewForm1022835::getAdvisorySymbolValue"));
    end;

    macro printAdvisoryInformation()
        throw(TNotExistaMethodtException("TViewForm1022835::printAdvisoryInformation"));
    end;

    macro printDataZone()
        const registryName = "REPTREG/REP_GROUPS/ФОРМА 102/ПЕЧАТЬ НУЛЕЙ";
        var printNulls = null;

        getRegistryValue(registryName, V_INTEGER, printNulls, null);

        printHead();

        if (printNulls == 0)
            printAllSymbols();
        elif (printNulls == 1)
            printOpenSymbols();
        elif (printNulls == 2)
            printNotNulls();
        end;

        printBottom()
    end;
end;

class (TViewForm1022835) TViewForm102385(formName, formOkudCode, formPeriodicity, periodFormat)
    initTViewForm1022835(formName,
                         formOkudCode,
                         NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                         periodFormat);
    templateName  = "OPU_resources385.tpl";
    symbolTplView = "drcbopusymboltpl2514_vw";
end;

class (TViewForm102385) TViewForm1023053(formName, formOkudCode, formPeriodicity, periodFormat)
    var title : String = "";
    if (valType(formName) == V_UNDEF)
        title = "Отчет о финансовых результатах";
    else
        title = formName;
    end;

    initTViewForm1022835(title,
                         formOkudCode,
                         NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                         periodFormat);
    templateName  = "OPU_resources3053.tpl";
    symbolTplView = "drcbopusymboltpl3053_vw";
end;

class (TViewForm1023053) TViewForm1023468(formName, formOkudCode, formPeriodicity, periodFormat)
    title  = "Отчет о финансовых результатах кредитной организации";
  
    initTViewForm1023053(title,
                         formOkudCode,
                         NVL(formPeriodicity, arrCreate(RCB_PK_MONTH, RCB_PK_QUARTER, RCB_PK_HALFYEAR)),
                         periodFormat);
    templateName  = "OPU_resources3468.tpl";
end;
