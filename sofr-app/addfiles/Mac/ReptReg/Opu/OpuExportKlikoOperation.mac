/*
$Name:        OpuExportKlikoOperation.mac
$Module:      Регламентируемая отчетность
$Description: классы экспорта в kliko.exe
*/
/*
иерархия классов, соответствующих разным инструкциям ЦБ
TExportKlikoOperation - базовый класс
*/

class TExportKlikoOperation()
    private var m_attributeValue   : RcbAttributeValue = RcbApplication().currentReport.attributeValue("Символы");
    private var m_isExportNullData : Bool      = true;

    private var m_specialSymbolForColumn2 = TArray();
    private var m_specialSymbolForColumn3 = TArray();
    private var m_symbolWithLetterCur = TArray();
    private var m_symbolWithLetterNew = TArray();
    private var m_AdvisorySymbolCur = TArray();
    private var m_AdvisorySymbolNew = TArray();

    private var symbolKlikoView = "drcbopuKlikoSymbol_vw";

    /*              Итоговые символа по группам доходов/расходов           */

    /*  Номер символа в форме  */        /*  Номер символа, выгружаемый в файл  */

    m_symbolWithLetterCur[0] = "1А000";   m_symbolWithLetterNew[0] = "10001";
    m_symbolWithLetterCur[1] = "1Б000";   m_symbolWithLetterNew[1] = "10002";
    m_symbolWithLetterCur[2] = "1В000";   m_symbolWithLetterNew[2] = "10003";
    m_symbolWithLetterCur[3] = "2А000";   m_symbolWithLetterNew[3] = "20001";
    m_symbolWithLetterCur[4] = "2Б000";   m_symbolWithLetterNew[4] = "20002";
    m_symbolWithLetterCur[5] = "2В000";   m_symbolWithLetterNew[5] = "20003";
    m_symbolWithLetterCur[6] = "2АБВ0";   m_symbolWithLetterNew[6] = "20100";

    /*  Номер символа в форме  */        /*  Номер символа, выгружаемый в файл  */
    m_AdvisorySymbolCur[0]  = "26000";    m_AdvisorySymbolNew[0]  = "40001";
    m_AdvisorySymbolCur[1]  = "26101";    m_AdvisorySymbolNew[1]  = "40011";
    m_AdvisorySymbolCur[2]  = "26102";    m_AdvisorySymbolNew[2]  = "40012";
    m_AdvisorySymbolCur[3]  = "26103";    m_AdvisorySymbolNew[3]  = "40013";
    m_AdvisorySymbolCur[4]  = "26104";    m_AdvisorySymbolNew[4]  = "40014";
    m_AdvisorySymbolCur[5]  = "26201";    m_AdvisorySymbolNew[5]  = "40015";
    m_AdvisorySymbolCur[6]  = "26202";    m_AdvisorySymbolNew[6]  = "40016";
    m_AdvisorySymbolCur[7]  = "26203";    m_AdvisorySymbolNew[7]  = "40017";
    m_AdvisorySymbolCur[8]  = "26301";    m_AdvisorySymbolNew[8]  = "40018";
    m_AdvisorySymbolCur[9]  = "26302";    m_AdvisorySymbolNew[9]  = "40019";
    m_AdvisorySymbolCur[10] = "26303";    m_AdvisorySymbolNew[10] = "40110";
    m_AdvisorySymbolCur[11] = "26305";    m_AdvisorySymbolNew[11] = "40111";
    m_AdvisorySymbolCur[12] = "26401";    m_AdvisorySymbolNew[12] = "40112";
    m_AdvisorySymbolCur[13] = "26402";    m_AdvisorySymbolNew[13] = "40113";
    m_AdvisorySymbolCur[14] = "26403";    m_AdvisorySymbolNew[14] = "40114";
    m_AdvisorySymbolCur[15] = "26404";    m_AdvisorySymbolNew[15] = "40115";
    m_AdvisorySymbolCur[16] = "26405";    m_AdvisorySymbolNew[16] = "40116";
    m_AdvisorySymbolCur[17] = "26406";    m_AdvisorySymbolNew[17] = "40117";
    m_AdvisorySymbolCur[18] = "26410";    m_AdvisorySymbolNew[18] = "40118";
    m_AdvisorySymbolCur[19] = "26412";    m_AdvisorySymbolNew[19] = "40119";

    /*  Символы, 2-е поле которых должно быть пустым  */

    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "01000";
    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "02000";
    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "31001";
    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "31002";
    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "33001";
    m_specialSymbolForColumn2[m_specialSymbolForColumn2.size] = "33002";


    /*  Символы, 3-е поле которых должно быть пустым  */

    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "12201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "12200";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "12401";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "12403";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13102";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13103";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13104";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13105";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13106";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13107";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13108";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "13100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15102";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15103";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15202";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15203";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15204";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15200";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "15000";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "16101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "16100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "16302";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "16303";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "16305";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "17307";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "22101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "22100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "22201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "22203";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23102";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23103";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23104";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23105";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23106";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23107";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "23108";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24102";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24103";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24202";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24203";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24204";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24200";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "24000";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "25101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "25100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "25302";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26202";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26203";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26200";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26305";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26306";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26307";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "27309";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28102";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28103";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28100";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28000";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "32001";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "32002";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "32101";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "01000";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "02000";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "31001";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "31002";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "33001";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "33002";

    private macro constructorTOpuExportKlikoOperation()
        var isNotExportNullData : Bool;
        m_isExportNullData = not (global.parameters.getRegistry().getIsZeroValueExport().getValue());
    end;

    private macro  getValueArray(klikoSymbol : String, symbol : String) : TArray
        var valueArray = TArray();
        var keyValue   = m_attributeValue.createKeyValue();

        keyValue.fieldValue("code") = symbol;
        var rcbValue = m_attributeValue.findValue(keyValue);

        var i = 0;
        var isFind = true;

        var isBreak = false;
        while ((i<7) and not isBreak)
            if (String(klikoSymbol) == m_symbolWithLetterCur[i])
                klikoSymbol = int(m_symbolWithLetterNew[i]);
                isBreak = true;
            end;
            i=i+1;
        end;

        if (rcbValue == null)
            valueArray[valueArray.size] = klikoSymbol;
            valueArray[valueArray.size] = "0";
            valueArray[valueArray.size] = "0";
            valueArray[valueArray.size] = "0";
        else
            valueArray[valueArray.size] = klikoSymbol;

            i=0;
            isBreak = false;
            var specialSymbolSize = m_specialSymbolForColumn2.size;
            while ((i < specialSymbolSize) and not isBreak)
                if (String(klikoSymbol) == m_specialSymbolForColumn2[i])
                    valueArray[valueArray.size] = "";
                    isFind  = false;
                    isBreak = true;
                end;
                i=i+1;
            end;

            if (isFind == true)
            valueArray[valueArray.size] = ternary(rcbValue.fieldValue("roubleValue").isDefined(),   rcbValue.fieldValue("roubleValue").currentAsString,   "");
            end;


            i=0;
            isBreak = false;
            isFind = true;
            specialSymbolSize = m_specialSymbolForColumn3.size;
            while ((i < specialSymbolSize) and not isBreak)
                if (String(klikoSymbol) == m_specialSymbolForColumn3[i])
                    valueArray[valueArray.size] = "";
                    isFind  = false;
                    isBreak = true;
                end;
                i=i+1;
            end;

            if (isFind == true)
                valueArray[valueArray.size] = ternary(rcbValue.fieldValue("currencyValue").isDefined(),  rcbValue.fieldValue("currencyValue").currentAsString, "");
            end;
            valueArray[valueArray.size] = ternary(rcbValue.fieldValue("totalValue").isDefined(),    rcbValue.fieldValue("totalValue").currentAsString,    "0");
        end;

        return valueArray;
    end;

    private macro isNullData(valueArray : TArray) : Bool
        var i : Integer = 1;/*Пропускаем первый эллемент, потому что это код символа*/

        while (i < valueArray.size)
            if((valueArray[i] != "0") and ((valueArray[i]) != ""))
                return false;
            end;
            i = i + 1;
        end;

        return true;
    end;

    private macro getValueArrayForAdvisorySimbol(compositeValue)
        var valueArray = TArray();
        var i = 0;
        var isBreak = false;

        while ((i < 20) and not isBreak)
            if (String(compositeValue.fieldValue("code").exact) == m_AdvisorySymbolCur[i])
                valueArray[valueArray.size] = m_AdvisorySymbolNew[i];
                valueArray[valueArray.size] = "";
                valueArray[valueArray.size] = "";
                valueArray[valueArray.size] = String((compositeValue.fieldValue("value").scaled):0:0);
                isBreak = true;
            end;
            i = i + 1;
        end;

        return valueArray;
    end;


    macro execute()
        var opuKlikoView = TRcbKlikoView("102", RcbApplication.currentReport.context.period.endDate);
        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        macro printRegistry(registry)
           protocolView.printLine("\n");
           protocolView.printLine(string(registry.getName():60) + string(registry.getValue()));
        end;

        protocolView.setProtocolOutput();
        protocolView.printHead();

        opuKlikoView.setOutputFile();

        if (in(RcbApplication().currentReport.context.period.kind, RCB_PK_DAY, RCB_PK_MONTH))
            opuKlikoView.printHead("F102D");
        else
            opuKlikoView.printHead("Ф_102");
        end;

        global.initializePackages();

        var dataSet = TRsbDataSet("SELECT t_klikoSymbol, t_symbol FROM " + symbolKlikoView);

        var valueArray : TArray = null;

        while (dataSet.moveNext())

            valueArray = getValueArray(dataSet.klikoSymbol, dataSet.symbol);

            if ((m_isExportNullData) or (not isNullData(valueArray)))
                opuKlikoView.printRow(valueArray);
            end;
        end;

        var iterator;

        if (RcbApplication.currentReport.context.period.endDate >= RCB_I2055_DATE)

            iterator = RcbApplication().currentReport.attributeValue("AdvisorySymbol").createValueIterator();

            iterator.moveFirst();

            while (not iterator.isDone)

                valueArray = getValueArrayForAdvisorySimbol(iterator.currentItem);

                opuKlikoView.printRow(valueArray);
                iterator.moveNext();
            end;
        end;

        opuKlikoView.resetOutputFile();

        protocolView.printLine("Количество выгруженных записей: " + opuKlikoView.getRowsCount());
        protocolView.printLine("Файл экспорта: " + opuKlikoView.getFileName());

        printRegistry(global.parameters.getRegistry().getIsZeroValueExport());
    end;

    constructorTOpuExportKlikoOperation();
end;

class (TExportKlikoOperation) TExportKlikoOperation2090()
    initTExportKlikoOperation();
    symbolKlikoView = "drcbopuKlikoSymbol2090_vw";
end;

class (TExportKlikoOperation) TExportKlikoOperation2514()
    initTExportKlikoOperation();
    symbolKlikoView = "drcbopuKlikoSymbol2514_vw";
end;

class (TExportKlikoOperation2514) TExportKlikoOperation2736()
    initTExportKlikoOperation2514();

    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "26204";
end;

class (TExportKlikoOperation2736) TExportKlikoOperation2835()
    initTExportKlikoOperation2736();

    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28201";
    m_specialSymbolForColumn3[m_specialSymbolForColumn3.size] = "28202";

    macro execute()
        var opuKlikoView = TRcbKlikoView("102", RcbApplication.currentReport.context.period.endDate);
        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");
        var descriptorInfo = "";

        macro printRegistry(registry)
           protocolView.printLine("\n");
           protocolView.printLine(string(registry.getName():60) + string(registry.getValue()));
        end;

        protocolView.setProtocolOutput();
        protocolView.printHead();

        opuKlikoView.setOutputFile();

        if (in(RcbApplication().currentReport.context.period.kind, RCB_PK_DAY, RCB_PK_MONTH))
            opuKlikoView.printHead("F102D");
            descriptorInfo = "f102d_03.pak от 02.01.2011";
        else
            opuKlikoView.printHead("Ф_102");
            descriptorInfo = "f102_12.pak от 29.06.2012";
        end;

        global.initializePackages();

        var dataSet = TRsbDataSet("SELECT t_klikoSymbol, t_symbol FROM " + symbolKlikoView);

        var valueArray : TArray = null;

        while (dataSet.moveNext())

            valueArray = getValueArray(dataSet.klikoSymbol, dataSet.symbol);

            if ((m_isExportNullData) or (not isNullData(valueArray)))
                opuKlikoView.printRow(valueArray);
            end;
        end;

        opuKlikoView.resetOutputFile();

        protocolView.printLine("Файл описателя: " + descriptorInfo);
        protocolView.printLine("Файл экспорта: " + opuKlikoView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + opuKlikoView.getRowsCount());

        printRegistry(global.parameters.getRegistry().getIsZeroValueExport());
    end;
end;

class (TExportKlikoOperation2835) TExportKlikoOperation3053()

    macro execute()
        var opuKlikoView = TRcbKlikoView("102", RcbApplication.currentReport.context.period.endDate);
        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe", "Форма 102. ОТЧЕТ О ФИНАНСОВЫХ РЕЗУЛЬТАТАХ");
        var descriptorInfo = "";

        macro printRegistry(registry)
           protocolView.printLine("\n");
           protocolView.printLine(string(registry.getName():60) + string(registry.getValue()));
        end;

        protocolView.setProtocolOutput();
        protocolView.printHead();

        opuKlikoView.setOutputFile();

        if (in(RcbApplication().currentReport.context.period.kind, RCB_PK_DAY, RCB_PK_MONTH))
            opuKlikoView.printHead("F102D");
            descriptorInfo = "f102d_03.pak от 02.01.2011";
        else
            opuKlikoView.printHead("Ф_102");
            descriptorInfo = "f102_15.pak от 02.07.2014";
        end;

        global.initializePackages();

        var dataSet = TRsbDataSet("SELECT t_klikoSymbol, t_symbol FROM " + symbolKlikoView);

        var valueArray : TArray = null;

        while (dataSet.moveNext())

            valueArray = getValueArray(dataSet.klikoSymbol, dataSet.symbol);

            if ((m_isExportNullData) or (not isNullData(valueArray)))
                opuKlikoView.printRow(valueArray);
            end;
        end;

        opuKlikoView.resetOutputFile();

        protocolView.printLine("Файл описателя: " + descriptorInfo);
        protocolView.printLine("Файл экспорта: " + opuKlikoView.getFileName());
        protocolView.printLine("Выгружено строк: " + opuKlikoView.getRowsCount() + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: 1");
        protocolView.printLine("    количество содержательных строк: " + String(opuKlikoView.getRowsCount() - 1));

        printRegistry(global.parameters.getRegistry().getIsZeroValueExport());
    end;

    initTExportKlikoOperation2835();
    symbolKlikoView = "drcbopuKlikoSymbol3053_vw";
end;
