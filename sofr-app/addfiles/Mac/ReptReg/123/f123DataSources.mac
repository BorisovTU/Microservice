/*
$Name:          f123DataSources.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 123. Источники данных
*/

/**
 * @since   18.09.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

// import testlib;
// var p = tsqlprofiler(gettxtfilename("!123!"));
// p.clear();
// p.on();


class (RcbDataSource) TF123AccountsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_comment = "";

    macro makeCommentForCategory(objectType : Integer, groupID : Integer, listCategory : String)
        var category = TRsbDataSet("SELECT t_name FROM dobjattr_dbt WHERE t_objectType = " + objectType + " AND t_groupId = " + groupID + " AND " + " t_numInList = " + listCategory);

        if (category.moveNext())
            if (m_comment == "")
                m_comment = m_comment
                          + " На счете установлена категория " + "\"" + category.name + "\"";
            else
                m_comment = m_comment
                          + "\n" + " На счете установлена категория " + "\"" + category.name + "\"";
            end;
        end;
    end;

    macro makeCommentForNote(noteKind : Integer, NoteValue : String)
        var note = TRsbDataSet("SELECT t_name FROM dnotekind_dbt note WHERE t_objectType = " + RCB_OBJTYPE_PARTY + " AND t_noteKind = " + noteKind);

        if (note.moveNext())
            if (m_comment == "")
                m_comment = m_comment
                          + " На клиенте счета установлено примечание " + "\"" + note.name + "\"" + " со значением " +  NoteValue;
            else
                m_comment = m_comment
                          + "\n" + " На клиенте счета установлено примечание " + "\"" + note.name + "\"" + " со значением " +  NoteValue;
            end;
        end;
    end;

    macro makeCommentForOwn(kind : Integer)
        var own = TRsbDataSet("SELECT t_name FROM dptkind_dbt own WHERE t_partyKind = " + kind);

        if (own.moveNext())
            if (m_comment == "")
                m_comment = m_comment
                          + " На клиенте счета установлена принадлежность " + "\"" + own.name + "\"";
            else
                m_comment = m_comment
                          + "\n" + " На клиенте счета установлена принадлежность " + "\"" + own.name + "\"";
            end;
        end;
    end;

    macro getDataForOwn(filter : RcbDataSourceFilter)
        var query =  "SELECT general.t_chapter,"
            + "\n" + "       general.t_account,"
            + "\n" + "       general.t_sum,"
            + "\n" + "       general.t_isTotal,"
            + "\n" + "       general.t_contragentId,"
            + "\n" + "       general.t_comment || chr(10)"
            + "\n" + "       || bank.t_comment || fin_org.t_comment t_comment"
            + "\n" + "  FROM (SELECT acc.t_chapter,"
            + "\n" + "               acc.t_account,"
            + "\n" + "               SUM(acc.t_outCoverRest) t_sum,"
            + "\n" + "               GROUPING (acc.t_account) t_isTotal,"
            + "\n" + "               " + getSqlString(m_comment) + " t_comment,"
            + "\n" + "               acc.t_contragentId t_contragentId"
            + "\n" + "          FROM drepaccount_vw acc"
            + "\n" + "         WHERE acc.t_isOpenedAtEndDate = 1"
            + "\n" + "           AND " + filter.isSuitable()
            + "\n" + "           AND acc.t_outCoverRest != 0"
            + "\n" + "         GROUP BY ROLLUP ((t_chapter, t_account, t_contragentId))"
            + "\n" + "         ORDER BY GROUPING (t_account) ASC) general,"
            + "\n" + "       (SELECT t_id, 'На клиенте счета установлена принадлежность \"Банком\"' t_comment"
            + "\n" + "          FROM drepparty_vw"
            + "\n" + "         WHERE drepparty_vw.t_isBank = 1) bank,"
            + "\n" + "       (SELECT t_partyid t_id, 'На клиенте счета установлена принадлежность \"Финансовой организацией\"' t_comment"
            + "\n" + "          FROM dpartyown_dbt partyown"
            + "\n" + "         WHERE partyown.t_partykind = " + RCB_PTK_FINORG + ") fin_org"
            + "\n" + " WHERE bank.t_id(+)   = general.t_contragentId"
            + "\n" + "   AND fin_org.t_id(+)= general.t_contragentId";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    macro getDataForCategory(filter : RcbDataSourceFilter, comment : String)
       var query =  "SELECT acc.t_chapter,"
           + "\n" + "       acc.t_account,"
           + "\n" + "       SUM(acc.t_outCoverRest) t_sum,"
           + "\n" + "       GROUPING (acc.t_account) t_isTotal,"
           + "\n" + "       t_numInList t_comment"
           + "\n" + "  FROM drepaccount_vw acc, "
           + "\n" + "       (SELECT t_numInList, t_Object"
           + "\n" + "          FROM " + comment  + ") db"
           + "\n" + " WHERE acc.t_isOpenedAtEndDate = 1"
           + "\n" + "   AND " + filter.isSuitable()
           + "\n" + "   AND acc.t_outCoverRest != 0"
           + "\n" + "   AND acc.t_objectId (+)= db.t_Object "
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account, t_numInList))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    macro getData(filter : RcbDataSourceFilter)
        var query = "SELECT acc.t_chapter,"
           + "\n" + "       acc.t_account,"
           + "\n" + "       SUM(acc.t_outCoverRest) t_sum,"
           + "\n" + "       GROUPING (acc.t_account) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + " t_comment"
           + "\n" + "  FROM drepaccount_vw acc"
           + "\n" + " WHERE acc.t_isOpenedAtEndDate = 1"
           + "\n" + "   AND " + filter.isSuitable()
           + "\n" + "   AND acc.t_outCoverRest != 0"
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    /* Остаточная стоимость субординированного кредита */
    macro getResidualCostSubLoan(filter : RcbDataSourceFilter)
        var query = "SELECT account.t_chapter,"
           + "\n" + "       account.t_account,"
           + "\n" + "       SUM(account.t_rest) AS t_sum,"
           + "\n" + "       GROUPING (account.t_account) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + "     t_comment"
           + "\n" + "  FROM (SELECT acc.*,"
           + "\n" + "               CASE"
           + "\n" + "                   WHEN acc.t_maturityDate - rep_data.getEndDate() > 5 * 365"
           + "\n" + "                       THEN  acc.t_outCoverRest"
           + "\n" + "                   WHEN acc.t_maturityDate - rep_data.getEndDate() <= 5 * 365"
           + "\n" + "                    AND acc.t_maturityDate - rep_data.getEndDate() > 0"
           + "\n" + "                       THEN acc.t_outCoverRest * FLOOR(MONTHS_BETWEEN(acc.t_maturityDate, rep_data.getEndDate())/3) / 20"
           + "\n" + "                   ELSE 0"
           + "\n" + "               END t_rest"
           + "\n" + "          FROM drepaccount_vw acc"
           + "\n" + "         WHERE acc.t_isOpenedAtEndDate = 1"
           + "\n" + "           AND " + filter.isSuitable()
           + "\n" + "       ) account"
           + "\n" + " WHERE account.t_rest != 0"
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    /* Получение сформированного резерва */
    macro getReservesData(filter : RcbDataSourceFilter)
        var query = "SELECT acc.t_chapter,"
           + "\n" + "       reserve.t_reserveaccount as t_account,"
           + "\n" + "       SUM(reserve.t_endDateReserveAmount) t_sum,"
           + "\n" + "       GROUPING (reserve.t_reserveAccount) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + " t_comment"
           + "\n" + "  FROM drepaccount_vw acc,"
           + "\n" + "       drepReserveAccount_vw reserve"
           + "\n" + " WHERE acc.t_accountId = reserve.t_connectAccountId"
           + "\n" + "   AND acc.t_isOpenedAtEndDate = 1"
           + "\n" + "   AND " +  filter.isSuitable()
           + "\n" + "   AND reserve.t_endDateReserveAmount != 0"
           + "\n" + " GROUP BY ROLLUP ((t_chapter, reserve.t_reserveaccount))"
           + "\n" + " ORDER BY GROUPING (reserve.t_reserveaccount) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    /* Получение остатка за дату*/
    macro getRestForDate(filter : RcbDataSourceFilter, restDate : Date)
        var query = "SELECT acc.t_chapter,"
           + "\n" + "       acc.t_account,"
           + "\n" + "       SUM(DECODE(acc.t_kind, 'А', -1, 1) * restDate.t_rest) AS t_sum,"
           + "\n" + "       GROUPING (acc.t_account) t_isTotal,"
           + "\n" +         getSqlString(m_comment) + " t_comment"
           + "\n" + "  FROM drepaccount_vw acc, dRestDate_dbt restDate"
           + "\n" + " WHERE acc.t_isOpenedAtEndDate = 1"
           + "\n" + "   AND " + filter.isSuitable()
           + "\n" + "   AND restDate.t_restCurrency = " + NATCUR
           + "\n" + "   AND restDate.t_accountId    = acc.t_accountId"
           + "\n" + "   AND restDate.t_restDate     = (SELECT MAX(maxDate.t_restDate) t_maxDate"
           + "\n" + "                                    FROM dRestDate_dbt maxDate"
           + "\n" + "                                   WHERE maxDate.t_restDate     <= " + getSqlDate(restDate)
           + "\n" + "                                     AND maxDate.t_restCurrency = " + NATCUR
           + "\n" + "                                     AND maxDate.t_accountId    = acc.t_accountId"
           + "\n" + "                                 )"
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    /* Получение остатка счета, который является счетом положительной (отрицательной) переоценки для некоторого счета (со своим фильтром) из суммы 1 */
    macro getRestForRevaluation(filter : RcbDataSourceFilter, overValuation : Integer, filterFromSum : RcbDataSourceFilter)
        var query = "SELECT acc.t_chapter,"
           + "\n" + "       acc.t_account,"
           + "\n" + "       SUM(t_outCoverRest) t_sum,"
           + "\n" + "       GROUPING (acc.t_account) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + " t_comment"
           + "\n" + "  FROM drepaccount_vw acc"
           + "\n" + " WHERE EXISTS (SELECT obj.t_attrId"
           + "\n" + "                 FROM dobjlink_dbt obj"
           + "\n" + "                WHERE acc.t_objectId = obj.t_attrId"
           + "\n" + "                  AND obj.t_objectType = " + RCB_OBJTYPE_ACCOUNT
           + "\n" + "                  AND obj.t_groupId = " + overValuation
           + "\n" + "                  AND EXISTS (SELECT 1"
           + "\n" + "                                FROM drepaccount_vw acc"
           + "\n" + "                               WHERE obj.t_objectId = acc.t_objectId"
           + "\n" + "                                 AND " + filterFromSum.isSuitable()
           + "\n" + "                             )"
           + "\n" + "              )"
           + "\n" + "   AND acc.t_isOpenedAtEndDate = 1"
           + "\n" + "   AND t_outCoverRest != 0"
           + "\n" + "   AND " +  filter.isSuitable()
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";

        return rest;
    end;

    private macro constructorTF123AccountsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("Accounts", protocolView, dataSources);
        m_comment = "";
    end;

    constructorTF123AccountsDataSource(protocolView, dataSources);
end;

class (RcbDataSource) TF123DocumentsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    macro getData(filter : RcbDataSourceFilter)
        var query = "SELECT doc.t_chapter,"
           + "\n" + "       doc.t_date,"
           + "\n" + "       doc.t_number,"
           + "\n" + "       doc.t_debetAccount,"
           + "\n" + "       doc.t_creditAccount,"
           + "\n" + "       doc.t_id,"
           + "\n" + "       SUM(t_inCoverSum) t_sum,"
           + "\n" + "       GROUPING(doc.t_id) AS t_isTotal"
           + "\n" + "  FROM drepdocument_vw doc"
           + "\n" + " WHERE doc.t_date <= rep_data.getEndDate()"
           + "\n" + "   AND t_inCoverSum != 0"
           + "\n" + "   AND " + filter.isSuitable()
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_date, t_number, t_debetAccount, t_creditAccount, t_id))"
           + "\n" + " ORDER BY GROUPING(t_id) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);
        dataSet.SetFieldType("t_date", V_DATE);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        return rest;
    end;

    private macro constructorTF123DocumentsDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource("Documents", protocolView, dataSources);
    end;

    constructorTF123DocumentsDataSource(protocolView, dataSources);
end;

class (RcbDataSource) TF123AccountNoteDataSource(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource("AccountNote", protocolView, dataSources);

    private var m_comment  = "";

    macro makeCommentForCategory(objectType : Integer, groupID : Integer, listCategory : String)
        var category = TRsbDataSet("SELECT t_name FROM dobjattr_dbt WHERE t_objectType = " + objectType + " AND t_groupId = " + groupID + " AND " + " t_numInList = " + listCategory);
        category.moveNext();

        m_comment = m_comment
            + " На счете установлена категория " + "\"" + category.name + "\n";
    end;


    macro getData(filter : RcbDataSourceFilter, noteId : Integer, noteDate : Date)

        var query = "SELECT data.t_chapter,"
           + "\n" + "       data.t_account,"
           + "\n" + "       SUM(data.t_noteValue) AS t_sum,"
           + "\n" + "       GROUPING (data.t_account) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + " || CASE"
           + "\n" + "                                          WHEN t_noteValue != 0"
           + "\n" + "                                              THEN ("
           + "\n" + "                                                    SELECT 'В расчет включено значение примечания на л/счете ' || t_name"
           + "\n" + "                                                      FROM dnotekind_dbt"
           + "\n" + "                                                     WHERE t_objectType = 4"
           + "\n" + "                                                       AND t_noteKind = " + noteId
           + "\n" + "                                                   )"
           + "\n" + "                                      END t_comment"
           + "\n" + "  FROM (SELECT acc.*,"
           + "\n" + "               rep_note.getMoneyAccountNote(acc.t_objectId,"
           + "\n" + "                                        " + noteId + ","
           + "\n" + "                                        " + ternary(noteDate != null, getSqlDate(noteDate), getSqlDate(global.getRcbReport().context.period.endDate))
           + "\n" + "                                           ) AS t_noteValue,"
           + "\n" + "               acc.t_outCoverRest  AS t_rest"
           + "\n" + "          FROM drepaccount_vw acc"
           + "\n" + "         WHERE acc.t_isOpenedAtEndDate = 1 AND " + filter.isSuitable()
           + "\n" + "       ) data"
           + "\n" + " WHERE data.t_noteValue IS NOT NULL"
           + "\n" + "   AND data.t_noteValue != 0 AND data.t_noteValue < data.t_rest"
           + "\n" + "   AND data.t_noteValue < data.t_rest"
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account, t_noteValue))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";
        return rest;
   end;

    macro getDataWithoutNote(filter : RcbDataSourceFilter, noteId : Integer, noteDate : Date)

        var query = "SELECT data.t_chapter,"
           + "\n" + "       data.t_account,"
           + "\n" + "       SUM(data.t_outCoverRest) AS t_sum,"
           + "\n" + "       GROUPING (data.t_account) t_isTotal,"
           + "\n" + "   " + getSqlString(m_comment) + " || CASE"
           + "\n" + "                                          WHEN t_noteValue != 0"
           + "\n" + "                                              THEN ("
           + "\n" + "                                                    SELECT 'В расчет включено значение примечания на л/счете ' || t_name"
           + "\n" + "                                                      FROM dnotekind_dbt"
           + "\n" + "                                                     WHERE t_objectType = 4"
           + "\n" + "                                                       AND t_noteKind = " + noteId
           + "\n" + "                                                   )"
           + "\n" + "                                      END t_comment"
           + "\n" + "  FROM (SELECT acc.*,"
           + "\n" + "               rep_note.getMoneyAccountNote(acc.t_objectId,"
           + "\n" + "                                        " + noteId + ","
           + "\n" + "                                        " + ternary(noteDate != null, getSqlDate(noteDate), getSqlDate(global.getRcbReport().context.period.endDate))
           + "\n" + "                                           ) AS t_noteValue,"
           + "\n" + "               acc.t_outCoverRest  AS t_rest"
           + "\n" + "          FROM drepaccount_vw acc"
           + "\n" + "         WHERE acc.t_isOpenedAtEndDate = 1 AND " + filter.isSuitable()
           + "\n" + "       ) data"
           + "\n" + " WHERE data.t_noteValue IS NULL"
           + "\n" + "   OR data.t_noteValue = 0 OR  data.t_noteValue > data.t_rest "
           + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account, t_noteValue))"
           + "\n" + " ORDER BY GROUPING (t_account) ASC";

        var dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSet.SetFieldType("t_sum", V_MONEY);

        var rest = $0.0;
        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                rest = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";
        return rest;
   end;

end;

class (RcbDataSources) TF123DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(TF123AccountsDataSource(m_protocolView.getDataProtocolView("Accounts"), this));
        m_dataSourcePool.push_back(TF123AccountNoteDataSource(m_protocolView.getDataProtocolView("AccountNote"), this));
        m_dataSourcePool.push_back(TF123DocumentsDataSource(m_protocolView.getDataProtocolView("Documents"), this));
    end;
end;

/**
 * Класс источника данных по лицевым счетам
 *
 * @param protocolView Файл печати протокола расчета
 * @param dataSources Источник данных
 */
class (TF123AccountsDataSource) TF123AccountsDataSource_3875(protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initTF123AccountsDataSource(protocolView, dataSources);

    /**
     * Остаточная стоимость субординированного кредита
     *
     * @param filter Фильтр истоичника данных
     * @param tuneTable Настроечная таблица
     *
     * @return Money Значение остаточной стоимости
     */
    macro getResidualCostSubLoan(filter: RcbDataSourceFilter, addFilter: RcbDataSourceFilter): Money
        /**
         * Выражение sql-запроса
         */
        var query: String = "";
        /**
         * Набор данных
         */
        var dataSet: Object = NULL;
        /**
         * Результат
         */
        var result: Money = $0.0;

        var filterByBalance;
        if (addFilter != null)
            filterByBalance = addFilter.isSuitable();
        else
            filterByBalance = "1=1";
        end;

        query =  "SELECT account.t_chapter,"
        + "\n" + "       account.t_account,"
        + "\n" + "       SUM(account.t_rest) AS t_sum,"
        + "\n" + "       GROUPING (account.t_account) t_isTotal,"
        + "\n" + "   " + getSqlString(m_comment) + "     t_comment"
        + "\n" + "  FROM (SELECT acc.*,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN NOT acc.t_noteValue IS NULL "
        + "\n" + "                       THEN"
        + "\n" + "                           CASE"
        + "\n" + "                               WHEN acc.t_noteValue != 0 "
        + "\n" + "                                   THEN"
        + "\n" + "                                       CASE"
        + "\n" + "                                           WHEN acc.t_maturityDate - rep_data.getEndDate() > 5 * 365"
        + "\n" + "                                               THEN  acc.t_noteValue"
        + "\n" + "                                           WHEN acc.t_maturityDate - rep_data.getEndDate() <= 5 * 365"
        + "\n" + "                                            AND acc.t_maturityDate - rep_data.getEndDate() > 0"
        + "\n" + "                                               THEN acc.t_noteValue * FLOOR(MONTHS_BETWEEN(acc.t_maturityDate, rep_data.getEndDate())/3) / 20"
        + "\n" + "                                           ELSE 0"
        + "\n" + "                                       END "
        + "\n" + "                                   ELSE acc.t_outCoverRest"
        + "\n" + "                           END"
        + "\n" + "                       ELSE"
        + "\n" + "                           CASE"
        + "\n" + "                               WHEN acc.t_maturityDate - rep_data.getEndDate() > 5 * 365"
        + "\n" + "                                   THEN  acc.t_outCoverRest"
        + "\n" + "                               WHEN acc.t_maturityDate - rep_data.getEndDate() <= 5 * 365"
        + "\n" + "                                AND acc.t_maturityDate - rep_data.getEndDate() > 0"
        + "\n" + "                                   THEN acc.t_outCoverRest * FLOOR(MONTHS_BETWEEN(acc.t_maturityDate, rep_data.getEndDate())/3) / 20"
        + "\n" + "                               ELSE 0"
        + "\n" + "                           END "
        + "\n" + "               END t_rest"
        + "\n" + "          FROM (SELECT acc.*,"
        + "\n" + "                      (SELECT rep_utl.castRawToMoney("
        + "\n" + "                                  rsi_rsb_kernel.getNote("
        + "\n" + "                                      4,"
        + "\n" + "                                      (SELECT t_objectId"
        + "\n" + "                                         FROM drepaccount_vw"
        + "\n" + "                                        WHERE t_account = acc.t_account"
        + "\n" + "                                          AND " + filterByBalance + "),"
        + "\n" + "                                      67,"
        + "\n" + "                                      rep_data.getEndDate())) AS t_noteValue FROM dual) AS t_noteValue"
        + "\n" + "                  FROM dRepAccount_vw acc"
        + "\n" + "                 WHERE acc.t_isOpenedAtEndDate = 1"
        + "\n" + "                   AND " + filter.isSuitable()
        + "\n" + "                    ) acc ) account"
        + "\n" + " WHERE account.t_rest != 0"
        + "\n" + " GROUP BY ROLLUP ((t_chapter, t_account))"
        + "\n" + " ORDER BY GROUPING (t_account) ASC";

        dataSet = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        dataSet.SetFieldType("t_sum", V_MONEY);

        m_protocolView.printHead();

        while (dataSet.moveNext())
            if (dataSet.isTotal)
                m_protocolView.printItog(dataSet);
                result = dataSet.sum;
            else
                m_protocolView.printString(dataSet);
            end;
        end;

        m_protocolView.printBottom();

        if (dataSet.getRecCount() == 0)
            m_protocolView.printNullData();
        end;

        m_comment = "";
        return result;
    end;
end;

/**
 * Класс источника данных
 */
class (TF123DataSources) TF123DataSources_3875(protocolView : RcbCalculateProtocolView)
    initTF123DataSources(protocolView);

    /**
     * Инициализация
     */
    private macro initialize()
        m_dataSourcePool.push_back(TF123AccountsDataSource_3875(m_protocolView.getDataProtocolView("Accounts"), this));
        m_dataSourcePool.push_back(TF123AccountNoteDataSource(m_protocolView.getDataProtocolView("AccountNote"), this));
        m_dataSourcePool.push_back(TF123DocumentsDataSource(m_protocolView.getDataProtocolView("Documents"), this));
    end;
end;
