/*
$Name:          f123Parameters.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 123. Параметры, используемые в выпуске отчета
*/

/**
 * @since   18.09.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

/**
 * Глобальная ссылка для хранения параметров.
 */

class TF123Parameters()

    private var m_isCalculateForDocuments = NULL;
    private var m_isOurBankCorporation = NULL;
    private var m_isOurBankOOO = NULL;
    private var m_currentDateProfit = NULL;
    private var m_lastDateProfit = NULL;
    private var m_confirmedProfitCurrentDate = NULL;
    private var m_confirmedProfitLastDate = NULL;
    private var m_DateMeetingShareHolders = NULL;
    private var m_DateRevaluation = NULL;
    private var m_subCredit134F = NULL;
    private var m_unconfirmedProfitBasel = NULL;
    private var m_include106InBaseCapital = NULL;
    private var m_k1 = NULL;
    private var m_k2 = NULL;
    private var m_k3 = NULL;
    private var m_k4 = NULL;
    private var m_PfiConfirmedImplementedFinResultPrevYears;
    private var m_PfiConfirmedNotImplementedFinResultPrevYears;
    private var m_PfiNotConfirmedImplementedFinResultPrevYears;
    private var m_PfiNotConfirmedNotImplementedFinResultPrevYears;

    private var m_fillCapitalData = NULL;

    macro isCalculateForDocuments()
        return m_isCalculateForDocuments;
    end;

    /* Наш банк является АО */
    macro isOurBankCorporation()
        return m_isOurBankCorporation;
    end;

    /* Наш банк является ООО */
    macro isOurBankOOO()
        return not m_isOurBankCorporation;
    end;

    /* Дата Ауд_ТекГ */
    macro getCurrentDateProfit()
        return ternary((Date(m_currentDateProfit) == Date("00.00.0000")) or (strlen(m_currentDateProfit) != 10), Date("31.12.2099"), Date(m_currentDateProfit));

        onError
            m_currentDateProfit = Date("31.12.2099");
            return m_currentDateProfit;
    end;

    /* Дата Дата Ауд_прошлГ */
    macro getLastDateProfit()
        return ternary((Date(m_lastDateProfit) == Date("00.00.0000")) or (strlen(m_lastDateProfit) != 10), Date("31.12.2099"), Date(m_lastDateProfit));

        onError
            m_lastDateProfit = Date("31.12.2099");
            return m_lastDateProfit;
    end;

    /* Дата ГодСобАкц */
    macro getDateMeetingShareHolders()
        return ternary((Date(m_DateMeetingShareHolders) == Date("00.00.0000")) or (strlen(m_DateMeetingShareHolders) != 10), Date("31.12.2099"), Date(m_DateMeetingShareHolders));

        onError
            m_DateMeetingShareHolders = Date("31.12.2099");
            return m_DateMeetingShareHolders;
    end;

    /* Дата переоценки */
    macro getDateRevaluation()
        return ternary((Date(m_DateRevaluation) == Date("00.00.0000")) or (strlen(m_DateRevaluation) != 10), Date("31.12.2099"), Date(m_DateRevaluation));

        onError
            m_DateRevaluation = Date("31.12.2099");
            return m_DateRevaluation;
    end;

    /* ДатаАудПодтв_ТекГ */
    macro getConfirmedProfitCurrentDate()
        return ternary((Date(m_confirmedProfitCurrentDate) == Date("00.00.0000")) or (strlen(m_confirmedProfitCurrentDate) != 10), Date("00.00.0000"), Date(m_confirmedProfitCurrentDate));

        onError
            m_confirmedProfitCurrentDate = Date("00.00.0000");
            return m_confirmedProfitCurrentDate;
    end;

    /* ДатаАудПодтв_ПрошлыйГ */
    macro getConfirmedProfitLastDate()
        return ternary((Date(m_confirmedProfitLastDate) == Date("00.00.0000")) or (strlen(m_confirmedProfitLastDate) != 10), Date("00.00.0000"), Date(m_confirmedProfitLastDate));

        onError
            m_confirmedProfitLastDate = Date("00.00.0000");
            return m_confirmedProfitLastDate;
    end;

    /* K1 */
    macro getK1()
        return m_k1;
    end;

    /* K2 */
    macro getK2()
        return m_k2;
    end;

    /* K3 */
    macro getK3()
        return m_k3;
    end;

    /* K4 */
    macro getK4()
        return m_k4;
    end;

    /* Субкредит_134 форма */
    macro getSubCredit134F()
        return m_subCredit134F;
    end;

    /* Прибыль текущего года подтверждена (НЕ подтверждена) */
    macro isConfirmedProfitCurrentDate()
        var year;
        datesplit(rcbApplication().currentReport.context.period.endDate, null, null, year);

        return ((Date(1, 1, year) <= getConfirmedProfitCurrentDate()) and (getConfirmedProfitCurrentDate() <= getCurrentDateProfit())
            and (getCurrentDateProfit() <= rcbApplication().currentReport.context.period.endDate + 1));
    end;

    /* Прибыль предшествующих лет подтверждена (НЕ подтверждена) */
    macro isConfirmedProfitLastDate()
        var year;
        datesplit(rcbApplication().currentReport.context.period.endDate, null, null, year);

        return ((Date(1, 1, year) <= getConfirmedProfitLastDate()) and (getConfirmedProfitLastDate() <= getLastDateProfit())
            and (getLastDateProfit() <= rcbApplication().currentReport.context.period.endDate + 1));
    end;

    /* Принято (Не принято) решение о распределении подтвержденной аудиторами прибыли предшествующего года */
    macro acceptedDistributedProfit()
        var year;
        datesplit(rcbApplication().currentReport.context.period.endDate, null, null, year);

        return ((Date(1, 1, year) <= getDateMeetingShareHolders()) and (getDateMeetingShareHolders() <= rcbApplication().currentReport.context.period.endDate));
    end;

    /* НЕПОД_ПРИБ_ПРЕДШ_ЛЕТ_БАЗЕЛЬ III */
    macro getUnconfirmedProfitBasel()
        return m_unconfirmedProfitBasel;
    end;

    /* ВКЛЮЧАТЬ 106 СЧЕТ В БАЗ. КАПИТ.*/
    macro getInclude106InBaseCapital()
        return m_include106InBaseCapital;
    end;

    /* Заполнить справочник капитала */
    macro getFillCapitalData()
        return m_fillCapitalData;
    end;

    /*ПФИ: реализованный фин. результат прошлых лет, подтвержденный аудиторами*/
    macro getPfiConfirmedImplementedFinResultPrevYears()
        return m_PfiConfirmedImplementedFinResultPrevYears;
    end;

    /*ПФИ: нереализованный фин. результат прошлых лет, подтвержденный аудиторами*/
    macro getPfiConfirmedNotImplementedFinResultPrevYears()
        return m_PfiConfirmedNotImplementedFinResultPrevYears;
    end;

    /*ПФИ: реализованный фин. результат прошлых лет, не подтвержденный аудиторами*/
    macro getPfiNotConfirmedImplementedFinResultPrevYears()
        return m_PfiNotConfirmedImplementedFinResultPrevYears;
    end;

    /*ПФИ: нереализованный фин. результат прошлых лет, не подтвержденный аудиторами*/
    macro getPfiNotConfirmedNotImplementedFinResultPrevYears()
        return m_PfiNotConfirmedNotImplementedFinResultPrevYears;
    end;

    private macro constructorTF123Parameters()
        private macro getFactorValue(factorName)
            var value = RcbFactor(factorName).getValue(RcbApplication().currentReport.context.period.endDate);
            var val = 0.0;
            if (value.isDefined())
                val = value.max;
            else
                val = 0.0;
            end;

            return val;
        end;

        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/РАСЧЕТ_УК_ПО_ПРОВОДКАМ", V_BOOL, m_isCalculateForDocuments, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/COMMON/ОПФ_КО_АО", V_BOOL, m_isOurBankCorporation, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/COMMON/ДАТААУД_ТЕКГ", V_STRING, m_currentDateProfit, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/COMMON/ДАТААУД_ПРОШЛЫЙГ", V_STRING, m_lastDateProfit, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/COMMON/ДАТААУДПОДТВ_ТЕКГ", V_STRING, m_confirmedProfitCurrentDate, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/COMMON/ДАТААУДПОДТВ_ПРОШЛЫЙГ", V_STRING, m_confirmedProfitLastDate, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/ДАТА ГОДОВОГО СОБРАНИЯ АКЦИОНЕР", V_STRING, m_DateMeetingShareHolders, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/ДАТА ПОДТВЕРЖДЕНИЯ ПЕРЕОЦЕНКИ", V_STRING, m_DateRevaluation, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/СУБКРЕДИТ В Ф.134 НА 01.01.2014", V_INTEGER, m_subCredit134F, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/НЕПОД_ПРИБ_ПРЕДШ_ЛЕТ_БАЗЕЛЬ III", V_STRING, m_unconfirmedProfitBasel, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/ЗАПОЛНИТЬ СПРАВОЧНИК КАПИТАЛА", V_BOOL, m_fillCapitalData, NULL);
        getRegistryValue("REPTREG/REP_GROUPS/РАСЧЕТ КАПИТАЛА/ВКЛЮЧАТЬ 106 СЧЕТ В БАЗ. КАПИТ.", V_BOOL, m_include106InBaseCapital, NULL);

        m_k1 = getFactorValue("п.8.1. Коэффициент поэтапного включения показателей") / 100.0;
        m_k2 = getFactorValue("п.8.1.1. Коэффициент поэтапного исключения показателей") / 100.0;
        m_k3 = getFactorValue("п.8.2. Коэффициент поэтапного исключения привилегированных акций и субординированных инструментов") / 100.0;
        m_k4 = getFactorValue("Процент прибыли/убытка от ПФИ");
        m_PfiConfirmedImplementedFinResultPrevYears       = getFactorValue("ПФИ: реализованный финансовый результат прошлых лет, подтвержденный аудиторами");
        m_PfiConfirmedNotImplementedFinResultPrevYears    = getFactorValue("ПФИ: нереализованный финансовый результат прошлых лет, подтвержденный аудиторами");
        m_PfiNotConfirmedImplementedFinResultPrevYears    = getFactorValue("ПФИ: реализованный финансовый результат прошлых лет, не подтвержденный аудиторами");
        m_PfiNotConfirmedNotImplementedFinResultPrevYears = getFactorValue("ПФИ: нереализованный финансовый результат прошлых лет, не подтвержденный аудиторами");
    end;

    constructorTF123Parameters();
end;
