/*
$Name:          f123ReportCalculateController.mac
$Module:        ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
$Description:   ”®à¬  123. Š®­âà®««¥à à áç¥â  ®âç¥â 
*/

/**
 * @since   18.09.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */

class (RcbReportCalculateController) TF123ReportCalculateController()
    initRcbReportCalculateController();

    m_protocolView = objectFactoryInstance.createCalculateProtocolView("’Š‹ €‘—…’€");

    private var m_serviceProtocolView = objectFactoryInstance.createCalculateProtocolView("’Š‹ …€–ˆˆ ‘…‚ˆ‘");

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController(this));
    end;

    macro initialize() : Bool
        global().initializeRepDataPackage(global().getRcbReport());

        pushControllers();

        return m_partCalculateControllers.size > 0;
    end;

    private macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        var calculationDataPool = calculationAttributeData.getCalculationDataPool();

        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationDataPool.getCurrentItem().calculate();
        end;

        calculationAttributeData.setCalculated();
    end;

    macro service()
        global.getRcbReport().attributeValue("®«ì§®¢ â¥«ìáª¨©‚¢®¤").removeAllValues();

        m_serviceProtocolView.setProtocolOutput(m_isUseAvailableReport);
        if (not m_isUseAvailableReport)
            m_serviceProtocolView.printHead();
        end;

        getReport().defineUserInput();
        getReport().ControlReserveInput();

        m_serviceProtocolView.resetProtocolOutput();
    end;

    macro serviceFromCalculate()
        global.getRcbReport().attributeValue("®«ì§®¢ â¥«ìáª¨©‚¢®¤").removeAllValues();

        m_serviceProtocolView.setProtocolOutput(m_isUseAvailableReport);
        if (not m_isUseAvailableReport)
            m_serviceProtocolView.printHead();
        end;

        getReport().defineUserInput();
        getReport().ControlReserveInput();

        m_serviceProtocolView.resetProtocolOutput();
    end;

    macro calculate() : Bool
        var needCallService = false;
        var hasError = false;
        var serviceData = global.getRcbReport().attributeValue("®«ì§®¢ â¥«ìáª¨©‚¢®¤").createValueIterator();
        serviceData.moveFirst();

        if (serviceData.count == 0)
            needCallService = true;
        else
            while(not serviceData.isDone)
                if (not serviceData.currentItem.isCompleteDefined)
                    needCallService = true;
                    break;
                end;

                serviceData.moveNext();
            end;
        end;

        if ( (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_254_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_283_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_1584“_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_2732“_¢¢®¤").isDefined))
            needCallService = true;
            hasError = true;
        end;

        if (needCallService)
            serviceFromCalculate();
            RcbApplication.transactionManager.commit();

            if (hasError)
                m_serviceProtocolView.show();
                ãáâ ­®¢¨âì”« £‚®§¢à â (OK_MACRO_FLAG);
                exit(1);
            end;
        end;

        global.getRcbReport().attributeValue("„ ­­ë¥âç¥â ").removeAllValues();

        initialize();

        getReport().defineUserInputByReserve();
        getReport().storeUserInput();

        m_protocolView.setProtocolOutput(m_isUseAvailableReport);

        if (not m_isUseAvailableReport)
            m_protocolView.printHead();
        end;

        m_protocolView.printLine(getProtocolText());


        initProgress(m_partCalculateControllers.getCount(), "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ", "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå", "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_calculationDataPool.getCount(), "‚ë¯®«­¥­¨¥ à áç¥â ", "‚ë¯®«­¥­¨¥ à áç¥â ");
        m_calculationDataPool.moveFirst();

        remProgress();

        if (not m_isUseAvailableReport)
            m_protocolView.resetProtocolOutput();
        end;

        initProgress(-1, "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå", "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå");
        RcbApplication.TransactionManager.commit();
        remProgress();

/* ‡ ¯®«­¥­¨¥ á¯à ¢®ç­¨ª  " §¬¥à á®¡áâ¢¥­­ëå áà¥¤áâ¢ (ª ¯¨â «) ¡ ­ª "*/
        objectFactoryInstance.createCapitalData(RcbApplication.currentReport).execute();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_3377()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_3377(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_3643()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_3643(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_3714()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_3714(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_3875()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_3875(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_XXXX()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_XXXX(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_4033()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_4033(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_4098()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_4098(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_41_1_1_4_330()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_41_1_1_4_330(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_4212()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_4212(this));
    end;
end;

class (TF123ReportCalculateController) TF123ReportCalculateController_4637()
    initTF123ReportCalculateController();

    private macro pushControllers()
        m_partCalculateControllers.push_back(TF123PartCalculateController_4637(this));
    end;

    macro calculate() : Bool
        var needCallService = false;
        var hasError = false;
        var serviceData = global.getRcbReport().attributeValue("®«ì§®¢ â¥«ìáª¨©‚¢®¤").createValueIterator();
        serviceData.moveFirst();

        if (serviceData.count == 0)
            needCallService = true;
        else
            while(not serviceData.isDone)
                if (not serviceData.currentItem.isCompleteDefined)
                    needCallService = true;
                    break;
                end;

                serviceData.moveNext();
            end;
        end;

        if ( (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_590_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_283_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_1584“_¢¢®¤").isDefined)
          or (not global.getRcbReport().attributeValue("¥¤®á®§¤_à¥§¥à¢_2732“_¢¢®¤").isDefined))
            needCallService = true;
            hasError = true;
        end;

        if (needCallService)
            serviceFromCalculate();
            RcbApplication.transactionManager.commit();

            if (hasError)
                m_serviceProtocolView.show();
                ãáâ ­®¢¨âì”« £‚®§¢à â (OK_MACRO_FLAG);
                exit(1);
            end;
        end;

        global.getRcbReport().attributeValue("„ ­­ë¥âç¥â ").removeAllValues();

        initialize();

        getReport().defineUserInputByReserve();
        getReport().storeUserInput();

        m_protocolView.setProtocolOutput(m_isUseAvailableReport);

        if (not m_isUseAvailableReport)
            m_protocolView.printHead();
        end;

        m_protocolView.printLine(getProtocolText());


        initProgress(m_partCalculateControllers.getCount(), "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ", "ˆ­¨æ¨ «¨§ æ¨ï ª®­âà®««¥à  à áç¥â ");
        m_partCalculateControllers.moveFirst();

        while (m_partCalculateControllers.moveNext())
            m_partCalculateControllers.getCurrentItem().execute();

            useProgress(m_partCalculateControllers.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_preprocessingDataPool.getCount(), "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå", "‚ë¯®«­¥­¨¥ ¯à¥¤®¡à ¡®âª¨ ¤ ­­ëå");
        m_preprocessingDataPool.moveFirst();

        while (m_preprocessingDataPool.moveNext())
            preprocessAttributeData(m_preprocessingDataPool.getCurrentItem());
            useProgress(m_preprocessingDataPool.getCurrentIndex());
        end;
        remProgress();

        initProgress(m_calculationDataPool.getCount(), "‚ë¯®«­¥­¨¥ à áç¥â ", "‚ë¯®«­¥­¨¥ à áç¥â ");
        m_calculationDataPool.moveFirst();

        remProgress();

        if (not m_isUseAvailableReport)
            m_protocolView.resetProtocolOutput();
        end;

        initProgress(-1, "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå", "C®åà ­¥­¨¥ à áç¨â ­­ëå ¤ ­­ëå");
        RcbApplication.TransactionManager.commit();
        remProgress();

        /* ‡ ¯®«­¥­¨¥ á¯à ¢®ç­¨ª  " §¬¥à á®¡áâ¢¥­­ëå áà¥¤áâ¢ (ª ¯¨â «) ¡ ­ª "*/
        objectFactoryInstance.createCapitalData(RcbApplication.currentReport).execute();

        return m_calculationDataPool.getCurrentIndex() > 0;
    end;
end;
