/*
$Name:          calc_f711avoir.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 711. Расчет первого раздела
*/

/**
 * @since   11.06.2014
 * @author  Kirin Pavel
 * @version 6.00.020.31
 */
import DepartmentFilter;
import com_f711;
import com_f711objectFactory;
import dl711avoir;
import RcbLibrary;
import RcbProtocolView;
import RcbCalculateProtocolView;

private class TDataSourceAvoiris(avoirPart)
    private var m_dataSource : Object;
    private var m_isFirstCall : Bool;
    private var m_number = 0;

    macro counter() : Double               // Номер п/п
        return m_number;
    end;

    macro КорреспНаим() : String
        return nvl(m_dataSource.КорреспНаим, ""); // Владелец счета ЛОРО
    end;

    macro КорреспИНН() : String
        return nvl(m_dataSource.КорреспИНН, ""); // ИНН владельца счета ЛОРО
    end;

    macro КорреспКПП() : String
        return nvl(m_dataSource.КорреспКПП, ""); // КПП владельца счета ЛОРО
    end;

    macro КорреспОГРН() : String
        return nvl(m_dataSource.КорреспОГРН, ""); // ОГРН владельца счета ЛОРО
    end;

    macro КорреспОКСМ() : String
        return nvl(m_dataSource.КорреспОКСМ, ""); // Страна владельца счета ЛОРО
    end;

    macro КорреспНомерЛицензии() : String
        return nvl(m_dataSource.КорреспНомерЛицензии, ""); // Лицензия владельца счета ЛОРО
    end;

    macro КорреспПризнак() : String
        return nvl(m_dataSource.КорреспПризнак, ""); // Признак депозитария владельца счета ЛОРО
    end;

    macro КорреспНомерСчета() : String
        return nvl(m_dataSource.КорреспНомерСчета, ""); // Номер счета ЛОРО
    end;

    macro КорреспИНН_Признак() : String
        return nvl(m_dataSource.КорреспИНН_Признак, ""); // для ИНН признак депозитария - корреспондента
    end;

    macro КорреспИНН_TIN() : String
        return nvl(m_dataSource.КорреспИНН_TIN, ""); // для ИНН TIN корреспондента
    end;

    macro КорреспИНН_ПризнакКода() : String
        return nvl(m_dataSource.ПризнакКодаНерез, ""); // Вид кода корреспондента-нерезидента
    end;

    macro КоличествоПоСчету() : Numeric
        return nvl(m_dataSource.КоличествоПоСчету, $0.0); // Количество ц/б на счете владельца
    end;

    macro ЭмитентНаименование() : String
        return nvl(m_dataSource.ЭмитентНаименование, ""); // Наименование эмитента
    end;

    macro ЭмитентИНН() : String
        return nvl(m_dataSource.ЭмитентИНН, ""); // ИНН эмитента
    end;

    macro ЭмитентКПП() : String
        return nvl(m_dataSource.ЭмитентКПП, ""); // КПП эмитента
    end;

    macro ЭмитентОГРН() : String
        return nvl(m_dataSource.ЭмитентОГРН, ""); // ОГРН эмитента
    end;

    macro ЭмитентОКСМ() : String
        return nvl(m_dataSource.ЭмитентОКСМ, ""); // ОКСМ эмитента
    end;

    macro ЭмитентИНН_Признак() : String
        return nvl(m_dataSource.ЭмитентИНН_Признак, ""); // для ИНН признак эмитента
    end;

    macro ЭмитентИНН_TIN() : String
        return nvl(m_dataSource.ЭмитентИНН_TIN, "");
    end;

    macro ЭмитентИНН_ПризнакКода() : String
        return nvl(m_dataSource.ПризнакКодаЭмНерез, ""); // Вид кода эмитента-нерезидента
    end;

    macro ЦБКодТипа() : String
        return nvl(m_dataSource.ЦБКодТипа, ""); // Код ц/б для Ф711
    end;

    macro ЦБНомерГосРег() : String
        return nvl(m_dataSource.ЦБНомерГосРег, ""); // Номер гос. рег. ц/б
    end;

    macro ЦБISIN() : String
        return nvl(m_dataSource.ЦБISIN, ""); // ISIN ц/б
    end;

    macro ЦБВалюта() : String
        return nvl(m_dataSource.ЦБВалюта, ""); // Код валюты номинала ц/б
    end;

    macro ЦБНоминал() : Numeric
        return nvl(m_dataSource.ЦБНоминал, $0.0); // Номинал ц/б
    end;

    macro ЦБНоминалТочность() : Integer
        return nvl(m_dataSource.ЦБНоминалТочность, 2); // Точность номинала ц/б
    end;

    macro СвоиЦБ_Займ() : Numeric
        return $0.0;
    end;

    macro СвоиЦБ_ОбязОтсутств() : Numeric
        return $0.0;
    end;

    macro СвоиЦБ_Безнадежн() : Numeric
        return $0.0;
    end;

    macro СвоиЦБ_ИныеПричины() : Numeric
        return $0.0;
    end;

    macro СвоиЦБ_ОснБаланс() : Numeric
        return nvl(m_dataSource.СвоиЦБ_ОснБаланс, $0.0); // Ц/б, принадлежащие банку
    end;

    macro СвоиЦБ_РЕПО_БПП() : Numeric
        return nvl(m_dataSource.СвоиЦБ_РЕПО_БПП, $0.0); // Ц/б РЕПО
    end;

    macro СвоиЦБ_ЗачислОшибочно() : Numeric
        return nvl(m_dataSource.СвоиЦБ_ЗачислОшибочно, $0.0); // Ц/б неустановленных владельцев
    end;

    macro СвоиЦБ_ДУ() : Numeric
        return nvl(m_dataSource.СвоиЦБ_ДУ, $0.0); // Ц/б в ДУ
    end;

    macro СвоиЦБ_КазнСчета() : Numeric
        return nvl(m_dataSource.СвоиЦБ_КазнСчета, $0.0); // Ц/б казначейского счета эмитента
    end;

    macro СвоиЦБ_Залог() : Numeric
        return nvl(m_dataSource.СвоиЦБ_Залог, $0.0); // Ц/б в залоге
    end;

    macro СвоиЦБ_Эмисс() : Numeric
        return nvl(m_dataSource.СвоиЦБ_Эмисс, $0.0); // Ц/б эмитента
    end;

    macro СвоиЦБ_Всего() : Numeric
        return СвоиЦБ_Займ() + СвоиЦБ_ОбязОтсутств() + СвоиЦБ_Безнадежн() + СвоиЦБ_ИныеПричины() + СвоиЦБ_ОснБаланс() +
               СвоиЦБ_РЕПО_БПП() + СвоиЦБ_ЗачислОшибочно();
    end;

    macro МХНаименование() : String
        return nvl(m_dataSource.МХНаименование, ""); // Наименование места хранения
    end;

    macro МХИНН() : String
        return nvl(m_dataSource.МХИНН, ""); // ИНН места хранения
    end;

    macro МХКПП() : String
        return nvl(m_dataSource.МХКПП, ""); // КПП места хранения
    end;

    macro МХОГРН() : String
        return nvl(m_dataSource.МХОГРН, ""); // ОГРН места хранения
    end;

    macro МХОКСМ() : String
        return nvl(m_dataSource.МХОКСМ, ""); // ОКСМ места хранения
    end;

    macro МХНомерЛицензии() : String
        return nvl(m_dataSource.МХНомерЛицензии, ""); // Лицензия места хранения
    end;

    macro МХПризнак() : String
        return nvl(m_dataSource.МХПризнак, ""); // Признак депозитария места хранения
    end;

    macro МХНомерСчёта() : String
        return nvl(m_dataSource.МХНомерСчёта, ""); // Номер счета места хранения
    end;

    macro МХИНН_Признак() : String
        return nvl(m_dataSource.МХИНН_Признак, ""); // для ИНН МХ признак организации
    end;

    macro МХИНН_TIN() : String
        return nvl(m_dataSource.МХИНН_TIN, ""); // для ИНН МХ TIN
    end;

    macro МХИНН_ПризнакКода() : String
        return nvl(m_dataSource.ПризнакКодаМХНерез, ""); // Вид кода организации-нерезидента
    end;

    macro ВидСчётаДепо() : String
        return nvl(m_dataSource.ВидСчётаДепо, ""); // Вид счета депо
    end;

    macro Владелец_СекторЭкономики() : String
        return nvl(m_dataSource.Владелец_СекторЭкономики, ""); // Код сектора экономики
    end;

    macro ОбъемВложений() : Numeric
        return nvl(m_dataSource.ОбъемВложений, $0.0); // Объем вложений сектора экономики
    end;

    macro ЦБКод() : String
        return nvl(m_dataSource.ЦБКод, ""); // FIID ЦБ
    end;

    macro Протокол() : TArray
        return nvl(m_dataSource.Протокол, TArray()); // Протокол
    end;

    macro Залог() : Numeric
        return nvl(m_dataSource.Залог, $0.0);                               // Ц/б на счетах с блокировкой классификатора "Блокировки заложенных ц/б"
    end;

    macro ТогрСчета() : Numeric
        return nvl(m_dataSource.ТогрСчета, $0.0);                           // Ц/б на торговых счетах
    end;

    macro ОгранКД() : Numeric
        return nvl(m_dataSource.ОгранКД, $0.0);                             // Ц/б на счетах с блокировкой классификатора "Блокировки цб, ограниченных по кор. действ."
    end;

    macro ЗапретОпер() : Numeric
        return nvl(m_dataSource.ЗапретОпер, $0.0);                          // Ц/б на счетах с блокировкой классификатора "Блокировка цб запрета на операции"
    end;
	
	macro ЦБЭскроуАгента() : Numeric
        return nvl(m_dataSource.ЦБЭскроуАгента, $0.0);                      // Ц/б на счетах эскроу-агента
    end;

    macro Арест() : Numeric
        return nvl(m_dataSource.Арест, $0.0);                               // Ц/б на счетах с блокировкой классификатора "Блокировки арестованных ц/б
    end;

    macro ВсегоОбрем() : Numeric
        return nvl(m_dataSource.ВсегоОбрем, $0.0);                          // Количество ценных бумаг, в отношении которых зафиксировано обременение" и (или) ограничение распоряжения
    end;

    macro СВ_ОКМС() : String
        return nvl(m_dataSource.СВ_ОКМС, "");                               // Код страны по классификатору ОКСМ для владельца счета депо
    end;

    macro БалансСчет() : String
        return nvl(m_dataSource.БалансСчет, "");                            // Номер балансового
    end;

    macro ЭмитентОКВЭД() : String
        return nvl(m_dataSource.ЭмитентОКВЭД, "");                            // Код ОКВЭД эмитента
    end;

    macro КоличествоЦБ() : Numeric
        return nvl(m_dataSource.КоличествоЦБ, $0.0);                            // Количество ц/б по непроданным лотам
    end;

    macro НКД() : Numeric
        return nvl(m_dataSource.НКД, $0.0);                            // накопленный купонный доход
    end;

    macro ОтрицПереоценка() : Numeric
        return nvl(m_dataSource.ОтрицПереоценка, $0.0);                            // отрицательная переоценка
    end;

    macro ПоложПереоценка() : Numeric
        return nvl(m_dataSource.ПоложПереоценка, $0.0);                            // положительная переоценка
    end;

    macro УровеньИДвиерархииСС() : String
        return nvl(m_dataSource.УровеньИДвиерархииСС, "");                            // уровень исходных данных в иерархии справедливой стоимости
    end;

    macro КатКачества() : String
        return nvl(m_dataSource.КатКачества, "");                            // Категория качества
    end;

    macro Резерв() : Numeric
        return nvl(m_dataSource.Резерв, $0.0);                            // резерв
    end;

    macro ОтрицПоложПереоценка() : Numeric
        return nvl(m_dataSource.ОтрицПоложПереоценка, $0.0);       // Переоценка ценных бумаг - отрицательная (положительная) разница
    end;

    macro Корр_СС_ПП() : Numeric
        return nvl(m_dataSource.Корр_СС_ПП, $0.0);           // Корректировка, увеличивающая (уменьшающая) стоимость долговых ценных бумаг или изменения справедливой стоимости при первоначальном признании долевых ценных бумаг
    end;

    macro Корр_резерва_ВП() : Numeric
        return nvl(m_dataSource.Корр_резерва_ВП, $0.0);          // Корректировка резерва на возможные потери до оценочного резерва под ожидаемые кредитные убытки
    end;

    macro НРезДатаВыдачиЛицензии() : String
        return nvl(m_dataSource.НРезДатаВыдачиЛицензии, "");  // код "№ лицензии участника ОРЦБ" субъекта
    end;

    macro НРезКемВыданаЛицензия() : String
        return nvl(m_dataSource.НРезКемВыданаЛицензия, "");   // примечание "Орган, выдавший лицензию" субъекта
    end;

    macro ПриемЦБ() : Numeric
        return  nvl(m_dataSource.ПриемЦБ, $0.0);             // объем проведенных операций по зачислению ценных бумаг
    end;

    macro СнятиеЦБ() : Numeric
        return  nvl(m_dataSource.СнятиеЦБ, $0.0);            // объем проведенных операций по списанию ценных бумаг
    end;

    macro ПереводЦБ() : Numeric
        return nvl(m_dataSource.ПереводЦБ, $0.0);           // объем проведенных операций по переводу ценных бумаг с лицевого счета депо одного депонента на лицевой счет депо другого депонента внутри депозитария
    end;

    macro ПриемЦБКоличество() : Numeric
        return  nvl(m_dataSource.ПриемЦБКоличество, 0);       // Количество проведенных операций по зачислению ценных бумаг
    end;

    macro СнятиеЦБКоличество() : Numeric
        return  nvl(m_dataSource.СнятиеЦБКоличество, 0);      // Количество проведенных операций по списанию ценных бумаг
    end;

    macro ПереводЦБКоличество() : Numeric
        return nvl(m_dataSource.ПереводЦБКоличество, 0);      // Количество проведенных операций по переводу ценных бумаг с лицевого счета депо одного депонента на лицевой счет депо другого депонента внутри депозитария
    end;

    macro РезервПроцент() : String
        return nvl(m_dataSource.РезервПроцент, "");           // примечание "Процент резервирования" объекта Ценная бумага
    end;

    macro КодCFI() : String
        return nvl(m_dataSource.КодCFI, "");           // Код CFI
    end;

    macro ОбособФЗ() : Numeric
        return nvl(m_dataSource.ОбособФЗ, $0.0);                 // учет которых обособлен на основании федеральных законов и нормативных правовых актов Российской Федерации
    end;

    macro ОбособТреб() : Numeric
        return nvl(m_dataSource.ОбособТреб, $0.0);               // учет которых обособлен на основании предписаний (требований) Банка России
    end;

    macro Примечание() : String
        return "";                                          // Примечание. Объяснение аналитика: Подразумевается, что Банк эту информацию будет заполнять сам (заполняется руками пользователем)
    end;
	
	macro ОшибкаНетОГРН() : String
       return nvl(m_dataSource.ОшибкаНетОГРН, "");                                           // Примечание. Объяснение аналитика: Подразумевается, что Банк эту информацию будет заполнять сам (заполняется руками пользователем)
    end;

    macro next()
        var result = false;

        if (m_isFirstCall)
            m_isFirstCall = false;
            result = m_dataSource.getFirst();
        else
            result = m_dataSource.getNext();
        end;

        m_number = m_number + 1;

        return result;
    end;

    private macro configureDataSource(avoirPart)
        var departmentList = TArray();
        var departmentListDataSource;

        RcbDepartmentList().saveToTable();

        departmentListDataSource = TRsbDataset("SELECT * FROM dbldept_tmp");

        while (departmentListDataSource.next())
            departmentList[departmentList.size] = departmentListDataSource.code;
        end;

        m_dataSource.setFilter(departmentList, RcbApplication().currentReport.context.period.beginDate, RcbApplication().currentReport.context.period.endDate, avoirPart);
    end;

    private macro constructorTDataSourceBill(avoirPart)
        m_dataSource = C_711avoir();
        m_isFirstCall = true;

        configureDataSource(avoirPart);
    end;

    constructorTDataSourceBill(avoirPart);
end;

/**
 *  ИД подраздела 1.1 (Ценные бумаги, учитываемые на междепозитарных счетах "ЛОРО") по 3129-У
 *  @since 6.00.020.31
 *  @author Kirin
 */
class (TDataSource) TDataSourcePart11Avoir_I3129()
    private macro constructorTDataSourcePart11Avoir_I3129(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart11Avoir_I3129(LORO_PART);
end;

/**
 *  ИД подраздела 1.2 (ЦенныеЦенные бумаги, учитываемые на счетах депо и иных счетах клиентов депозитария) по 3129-У
 *  @since 6.00.020.31
 *  @author Kirin
 */
class (TDataSource) TDataSourcePart12Avoir_I3129()
    private macro constructorTDataSourcePart12Avoir_I3129(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart12Avoir_I3129(CLIENT_PART);
end;

class (TDataSource) TDataSourcePart121Avoir_I5456()
    private macro constructorTDataSourcePart121Avoir_I5456(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart121Avoir_I5456(CLIENT_PART_2_1);
end;

/**
 *  ИД подраздела 1.3 (Ценные бумаги, учитываемые на счетах депо и иных счетах кредитной организации) по 3129-У
 *  @since 6.00.020.31
 *  @author Kirin
 */
class (TDataSource) TDataSourcePart13Avoir_I3129()
    macro isExistsProtocol() : Bool
        return true;
    end;

    macro getProtocolTableName() : String
        return "df711Protocol_1_3_tmp";
    end;

    macro getProtocolData(counter, protocolData : Object) : TArray
        var resultArray = TArray();

        resultArray[0] = int(counter);
        resultArray[1] = protocolData.Флаг;
        resultArray[2] = protocolData.ЦБКод;
        resultArray[3] = protocolData.Графа;
        resultArray[4] = protocolData.ЛицСчет;
        resultArray[5] = protocolData.КолЦБЛицСч;
        resultArray[6] = protocolData.ТипСчетаДЕПО;
        resultArray[7] = protocolData.Владелец;
        resultArray[8] = protocolData.Нерезидент;
        resultArray[9] = protocolData.Примечание;

        return resultArray;
    end;

    macro getProtocolFieldsList() : TArray;
        var fieldsArray = TArray();

        fieldsArray[fieldsArray.size] = "t_counter";
        fieldsArray[fieldsArray.size] = "t_flag";
        fieldsArray[fieldsArray.size] = "t_cbCode";
        fieldsArray[fieldsArray.size] = "t_column";
        fieldsArray[fieldsArray.size] = "t_account";
        fieldsArray[fieldsArray.size] = "t_count";
        fieldsArray[fieldsArray.size] = "t_depoAccType";
        fieldsArray[fieldsArray.size] = "t_owner";
        fieldsArray[fieldsArray.size] = "t_isNoResident";
        fieldsArray[fieldsArray.size] = "t_note";

        return fieldsArray;
    end;

    private macro constructorTDataSourcePart13Avoir_I3129(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart13Avoir_I3129(BANK_PART);
end;

/**
 *  ИД подраздела 1.3 (Информация по ранее загруженным закладным))
 *  @since 6.00.020.31
 *  @author Vrubel
 */
class (TDataSource) TDataSourcePart13Avoir_Loaded()
    macro isExistsProtocol() : Bool
        return true;
    end;

    macro getProtocolTableName() : String
        return "df711Protocol_1_3_tmp";
    end;

    macro getProtocolData(counter, protocolData : Object) : TArray
        var resultArray = TArray();

        resultArray[0] = int(counter);
        resultArray[1] = protocolData.Флаг;
        resultArray[2] = protocolData.ЦБКод;
        resultArray[3] = protocolData.Графа;
        resultArray[4] = protocolData.ЛицСчет;
        resultArray[5] = protocolData.КолЦБЛицСч;
        resultArray[6] = protocolData.ТипСчетаДЕПО;
        resultArray[7] = protocolData.Владелец;
        resultArray[8] = protocolData.Нерезидент;
        resultArray[9] = protocolData.Примечание;

        return resultArray;
    end;

    macro getProtocolFieldsList() : TArray;
        var fieldsArray = TArray();

        fieldsArray[fieldsArray.size] = "t_counter";
        fieldsArray[fieldsArray.size] = "t_flag";
        fieldsArray[fieldsArray.size] = "t_cbCode";
        fieldsArray[fieldsArray.size] = "t_column";
        fieldsArray[fieldsArray.size] = "t_account";
        fieldsArray[fieldsArray.size] = "t_count";
        fieldsArray[fieldsArray.size] = "t_depoAccType";
        fieldsArray[fieldsArray.size] = "t_owner";
        fieldsArray[fieldsArray.size] = "t_isNoResident";
        fieldsArray[fieldsArray.size] = "t_note";

        return fieldsArray;
    end;

    private macro constructorTDataSourcePart13Avoir_Loaded(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart13Avoir_Loaded(LD_BANK_PART);
end;

/**
 *  ИД подраздела 1.4 (Балансовая стоимость вложений в эмиссионные ценные бумаги и инвестиционные паи паевых инвестиционных фондов, принадлежащие кредитной организации на праве
 *  собственности (за исключением переданных кредитной организацией на возвратной основе без прекращения признания, в доверительное управление)) по 3129-У
 *  @since 6.00.020.31
 *  @author Kirin
 */
class (TDataSource) TDataSourcePart14Avoir_I3129()
    private macro constructorTDataSourcePart14Avoir_I3129(avoirPart)
        initTDataSource();

        add("TPart11Avoir", TDataSourceAvoiris(avoirPart));
    end;

    constructorTDataSourcePart14Avoir_I3129(BALANCE_PART);
end;

class TProtocolDataPart11()
    private var m_table = CTableReport(0);

    macro printBottom()
        m_table.printBottom();
    end;

    macro beginProtocol()
        setoutput( ИмяФайлаПротокола );
        println("Форма 711. Раздел 1 \"Депозитарные операции\"");
        println("ПРОТОКОЛ РАСЧЕТА");
        println("    Период отчета с " + string(RcbApplication().currentReport.context.period.beginDate) + " по " + string(RcbApplication().currentReport.context.period.endDate));
        println("    Исполнитель: " + Исполнитель);
        println("    Дата и время выпуска отчета " + string(date())+ "  " + string(time()));
        println();
    end;

    macro printSeparator()
        m_table.printSeparator();
    end;

    macro printHead()
        println("\n Подраздел 1.1");
        m_table.printHead();
    end;

    // Комментарий к счету по количеству ц/б (для протокола)
    private macro getNoteForAmount(amount)
        return ternary(strLen(string(amount:0:4)) > 16,
                       "Внимание! Количество ц/б по л/с превышает допустимое значение для выгрузки в kliko.exe: тип N - число с плав.точкой, 16.4.",
                       "");
    end;

    macro printString(dataSet : Object)
        var accounts = TRsbDataset("SELECT ormDepAcc.t_corAccount  as t_corAccount,"
                          + "\n" + "       ormDepAccount.t_account as t_account,"
                          + "\n" + "       ormDepAccount.t_restEnd as t_rest"
                          + "\n" + "    FROM ormDepAcc, ormDepAccount"
                          + "\n" + "   WHERE " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("ormDepAcc.t_department", "ormDepAcc.t_branch")
                          + "\n" + "     AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("ormDepAccount.t_department", "ormDepAccount.t_branch")
                          + "\n" + "     AND ormDepAcc.t_briefCode = " + getSqlString(dataSet.currentItem.fieldValue("КорреспНомерСчета").exact)
                          + "\n" + "     AND ormDepAcc.t_code = ormDepAccount.t_depoAccCode"
                                    );

        accounts.moveNext();
        m_table.printStringTransferByWord(dataSet.currentItem.fieldValue("counter").exactAsString,
                                          dataSet.currentItem.fieldValue("КорреспНаим").exactAsString,
                                          dataSet.currentItem.fieldValue("КорреспНомерСчета").exactAsString,
                                          accounts.corAccount,
                                          accounts.account,
                                          accounts.rest,
                                          getNoteForAmount(accounts.rest));

        while (accounts.moveNext())
            m_table.printStringTransferByWord("",
                                              "",
                                              "",
                                              "",
                                              accounts.account,
                                              accounts.rest,
                                              getNoteForAmount(accounts.rest));
        end;
    end;

    macro print()
        var it = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_Подраздел_1_1").createValueIterator();
        var prevItem;
        printHead();

        it.moveFirst();
        while (not it.isDone())
            if ((valType(prevItem) != V_UNDEF) and (prevItem.fieldValue("КорреспНомерСчета").exact == it.currentItem.fieldValue("КорреспНомерСчета").exact))
                it.moveNext();
                continue;
            end;
            printString(it);
            prevItem = it.currentItem;
            it.moveNext();
        end;

        printBottom();
    end;

    private macro initialize()
        m_table.addColumn( "№ п/п", 5, AL_CENTER);
        m_table.addColumn( "Корреспондент", 20, AL_LEFT );
        m_table.addColumn( "Номер счета депо", 25, AL_LEFT );
        m_table.addColumn( "Номер счета депо у корр.", 25, AL_LEFT );
        m_table.addColumn( "Список лицевых счетов депо", 25, AL_LEFT );
        m_table.addcolumn( "Количество ц/б на л/с", 24, AL_RIGHT );
        m_table.addcolumn( "Примечание",            24, AL_LEFT);
    end;

    initialize();
end;

class (TProtocolDataPart11) TProtocolDataPart1_23(partNumber)
    private const NOTE_WIDTH = 24.0;
    private const EMPTY_NOTE = mkstr(" ", NOTE_WIDTH);
    private var m_partNumber = partNumber;

    private macro initialize()
        m_table.addColumn( "", 5, AL_CENTER);
        m_table.addColumn( "№ п/п", 5, AL_CENTER);
        m_table.addColumn("Код ценной бумаги",                                               30., AL_LEFT);
        m_table.addColumn("Графа",                                                            7., AL_CENTER);
        m_table.addColumn("Номер лицевого счета депо",                                       25., AL_LEFT);
        m_table.addColumn("Количество ц/б на лицевом счете",                                 24., AL_RIGHT);
        m_table.addColumn("Тип счета депо по назначению",                                    24., AL_LEFT);
        m_table.addcolumn("Владелец",                                                        20., AL_LEFT);
        m_table.addColumn("Н",                                                                1., AL_CENTER);
        m_table.addcolumn("Примечание",                                               NOTE_WIDTH, AL_LEFT);
    end;

    macro beginProtocol()
        setoutput( ИмяФайлаПротокола );
    end;

    macro printHead()
        if (m_partNumber == 2)
            println("\n Подраздел 1.2");
        elif (m_partNumber == 3)
            println("\n Подраздел 1.3");
        end;

        m_table.printHead();
    end;

    // Комментарий к счету с отсутствующим свойством "Код ценной бумаги для банковской отчетности по форме 0409711"
    private macro getNoteForCode711(obj : Object)
        return ternary(obj.currentItem.fieldValue("ЦБКодТипа").exactAsString == "",
                       "Внимание! Для ценной бумаги не задано значение примечания \"Код типа ц.б. для формы 711\"",
                       "");
    end;

    macro printString(dataSet : Object)
        var purposeString = TArray();
        purposeString[ 0] = "00 вычисляемый";
        purposeString[ 1] = "01 счет владельца";
        purposeString[ 2] = "02 счет номинального держателя";
        purposeString[ 3] = "03 счет доверительного управляющего";
        purposeString[ 4] = "04 счет залогодержателя";
        purposeString[ 5] = "05 эмиссионный счет эмитента";
        purposeString[ 6] = "06 счет эмитента для выкупа/погашения";
        purposeString[ 7] = "07 ценные бумаги неустановленных лиц";
        purposeString[21] = "21 хранилище";
        purposeString[22] = "22 междепозитарный счет";
        purposeString[98] = "98 транзитный счет";

        var column : String;

        var data = TRsbDataset("SELECT acc.t_fi_code as t_fi_code,"
                       + "\n" + "      acc.t_account as t_account,"
                       + "\n" + "      acc.t_restEnd as t_rest,"
                       + "\n" + "      acc.t_restEnd as t_rest,"
                       + "\n" + "      ormDepAcc.t_purpose as t_purpose,"
                       + "\n" + "      (SELECT pt.t_shortName FROM drepparty_vw pt WHERE pt.t_id = ormDepAcc.t_ownerId) as t_ownerName,"
                       + "\n" + "      (SELECT pt.t_isResident FROM drepparty_vw pt WHERE pt.t_id = ormDepAcc.t_ownerId) as t_isResident"
                       + "\n" + "  FROM ormDepAccount acc, OrmFinAvoiriss avoir, ormDepAcc"
                       + "\n" + " WHERE " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("ormDepAcc.t_department", "ormDepAcc.t_branch")
                       + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().getAsSqlString("acc.t_department", "acc.t_branch")
                       + "\n" + "   AND avoir.t_fiid = " + getSqlString(dataSet.currentItem.fieldValue("ЦБКод").exact)
                       + "\n" + "   AND acc.t_depoAccCode = ormDepAcc.t_code"
                       + "\n" + "   AND avoir.t_fi_code = acc.t_fi_code"
                                    );
        if (data.moveNext())
            if (m_partNumber == 2)
                column = "";
            elif (m_partNumber == 3)
                column = ternary(dataSet.currentItem.fieldValue("СвоиЦБ_ОснБаланс").exact      != 0, " 62,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_РЕПО_БПП").exact       != 0, " 63,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_Займ").exact           != 0, " 64,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_ОбязОтсутств").exact   != 0, " 65,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_Безнадежн").exact      != 0, " 66,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_ЗачислОшибочно").exact != 0, " 67,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_ИныеПричины").exact    != 0, " 68,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_ДУ").exact             != 0, " 69,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_КазнСчета").exact      != 0, " 70,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_Залог").exact          != 0, " 71,", "") +
                         ternary(dataSet.currentItem.fieldValue("СвоиЦБ_Эмисс").exact          != 0, " 72,", "");
                column = substr(column, 1, strlen(column) - 1);
            end;
            var s1 = ternary(getNoteForAmount(data.rest) == "", EMPTY_NOTE, getNoteForAmount(data.rest));
            var s2 = getNoteForCode711(dataSet);
            var n = mod(strlen(s1), NOTE_WIDTH);
            if (n != 0)
                strset(s1, strlen(s1), substr(EMPTY_NOTE, 1, n));
            end;
            var note = s1 + s2;
            m_table.printStringTransferByWord(ternary(data.purpose == 0, "!", ""),
                                              dataSet.currentItem.fieldValue("counter").exactAsString,
                                              data.fi_code,
                                              ternary(m_partNumber == 2, "", ternary(data.purpose == 0, "", column)),
                                              data.account,
                                              data.rest,
                                              purposeString[data.purpose],
                                              ternary(m_partNumber == 2, data.ownerName, ""),
                                              ternary(m_partNumber == 2, ternary(not data.isResident, "X", ""), ""),
                                              note
                                             );
        end;

        if (m_partNumber == 3)
            data = TRsbDataset(" SELECT tmp.t_flag,                "
                       + "\n" + "       tmp.t_counter,             "
                       + "\n" + "       tmp.t_cbCode,              "
                       + "\n" + "       tmp.t_column,              "
                       + "\n" + "       tmp.t_account,             "
                       + "\n" + "       tmp.t_count,               "
                       + "\n" + "       tmp.t_depoAccType,         "
                       + "\n" + "       tmp.t_owner,               "
                       + "\n" + "       tmp.t_isNoResident,        "
                       + "\n" + "       tmp.t_note                 "
                       + "\n" + "  FROM df711Protocol_1_3_tmp tmp "
                       + "\n" + " WHERE tmp.t_counter = " + dataSet.currentItem.fieldValue("counter").exactAsString
                              );

            while (data.moveNext())
                m_table.printStringTransferByWord(data.flag,
                                                  data.counter,
                                                  data.cbCode,
                                                  data.column,
                                                  data.account,
                                                  data.count,
                                                  data.depoAccType,
                                                  data.owner,
                                                  data.isNoResident,
                                                  data.note
                                                 );
            end;
        end;
    end;

    macro print()
        var it;

        if (m_partNumber == 2)
            it = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_Подраздел_1_2").createValueIterator()
        elif (m_partNumber == 3)
            it = RcbApplication().currentReport.attributeValue("Ф711_Раздел1_Подраздел_1_3").createValueIterator()
        end;

        printHead();

        it.moveFirst();
        while (not it.isDone())
            printString(it);
            it.moveNext();
        end;

        printBottom();
    end;

    initTProtocolDataPart11();
end;

/**
 *  Класс расчета раздела 1 (депозитарные операции)
 *  @since 6.00.020.31
 *  @author Kirin
 */
class TCalculatorSection1()
    private macro calculatePart(variableName : String, dataSource : Object)
        if (dataSource == null)
            return;
        end;

        var fieldIterator;
        var variable;
        var protocolData;
        var isExistsProtocol = dataSource.isExistsProtocol();

        if (isExistsProtocol)
            protocolData = TProtocolDataInserter(dataSource.getProtocolTableName(), dataSource.getProtocolFieldsList());
        end;

        while (dataSource.next())

            variable = RcbApplication().currentReport.attributeValue(variableName).addValue(RCB_NEW_VALUE_ID);

            fieldIterator = RcbApplication().currentReport.form.attribute(variableName).structure.createFieldIterator();

            fieldIterator.first();
            while (not fieldIterator.isDone())
                variable.fieldValue(fieldIterator.currentItem.name).exact = dataSource.getValue(fieldIterator.currentItem.name);
                fieldIterator.next();
            end;

            if (isExistsProtocol)
                var protocolArray : TArray;
                var i = 0;

                protocolArray = dataSource.getValue("Протокол");

                if (protocolArray.size > 0)
                    while (i < protocolArray.size)
                        protocolData.addData(dataSource.getProtocolData(dataSource.getValue("counter"), protocolArray[i]));
                        i = i + 1;
                    end;
                end;
            end;
        end;

        if (isExistsProtocol)
            if (protocolData.isExistsData())
                protocolData.insertData();
            end;
        end;
    end;

    macro calculate()

        begAction(1000, "Расчет переменных раздела 1");

        calculatePart("Ф711_Раздел1_Подраздел_1_1", objectFactoryInstance.createDataSourcePart11Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_2", objectFactoryInstance.createDataSourcePart12Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_3", objectFactoryInstance.createDataSourcePart13Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_4", objectFactoryInstance.createDataSourcePart14Avoir());

        RcbApplication().transactionManager.commit();

        endAction();
    end;
end;

class (TCalculatorSection1) TCalculatorSection1_5456()
    macro calculate()

        begAction(1000, "Расчет переменных раздела 1");

        calculatePart("Ф711_Раздел1_Подраздел_1_1",   objectFactoryInstance.createDataSourcePart11Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_2",   objectFactoryInstance.createDataSourcePart12Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_2_1", objectFactoryInstance.createDataSourcePart121Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_3",   objectFactoryInstance.createDataSourcePart13Avoir());
        calculatePart("Ф711_Раздел1_Подраздел_1_4",   objectFactoryInstance.createDataSourcePart14Avoir());

        RcbApplication().transactionManager.commit();

        endAction();
    end;
end;

class (TCalculatorSection1) TCalculatorSection1_Loaded()
    macro calculate()

        begAction(1000, "Расчет переменных раздела 1");

        calculatePart("Ф711_Раздел1_Подраздел_1_3",   objectFactoryInstance.createDataSourcePart13Avoir_Loaded());
        calculatePart("Ф711_Раздел1_Подраздел_1_4",   objectFactoryInstance.createDataSourcePart14Avoir());

        RcbApplication().transactionManager.commit();

        endAction();
    end;
end;

