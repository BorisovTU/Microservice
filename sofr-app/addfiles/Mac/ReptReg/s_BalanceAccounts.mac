import cb_sql;
import ReptCbInter;
import log_lib;

private const KA_AP = "АП";

private MACRO GetQuery( BegDate, EndDate )

    Macro SelectString( ps )
        return "       CASE"                                                                                            + "\n" +
               "           WHEN    NVL(vd"+ps+".t_bdInclude," + GetSQLDate(Date(0,0,0)) + ") <= " + GetSQLDate(EndDate) + "\n" +
               "               AND NVL(vd"+ps+".t_bdExclude," + GetSQLDate(Date(0,0,0)) + ") >= " + GetSQLDate(BegDate) + "\n" +
               "               THEN 1 "                                                                                 + "\n" +
               "           ELSE 0 "                                                                                     + "\n" +
               "       END "+ps+"w, "                                                                                   + "\n" +
               "       vd"+ps+".t_cFormat               "+ps+"f,"                                                                     + "\n" +
               "       mr"+ps+".t_mean1                 "+ps+"1,"                                                                     + "\n" +
               "       mr"+ps+".t_mean2                 "+ps+"2 ";
    End;

    Macro WhereString( ps, suff, begdate, enddate )
        return "       AND vd"+ps+".t_iFormId(+)    = " + 1                                          + "\n" +
               "       AND vd"+ps+".t_szVarName(+)  = 'Бн' || bl.t_Balance || " + GetSQLString(suff) + "\n" +
               "       AND mr"+ps+".t_iNumDprt(+)   = " + НомерПодразделения                         + "\n" +
               "       AND mr"+ps+".t_isSummary(+)   = " + GetSqlChar( RcbIsSummaryMode )                                + "\n" +
               "       AND mr"+ps+".t_OrganizationStructure(+)   = " + RcbOrganizationStructure            + "\n" +
               "       AND mr"+ps+".t_IssueMode(+)   = " + RcbIssueMode                        + "\n" +
               "       AND mr"+ps+".t_bdRepDate(+)  = " + GetSQLDate(enddate)                        + "\n" +
               "       AND mr"+ps+".t_bdPrevDate(+) = " + GetSQLDate(begdate)                        + "\n" +
               "       AND mr"+ps+".t_iFormId(+)    = " + 1                                          + "\n" +
               "       AND mr"+ps+".t_iVarId(+)     = vd"+ps+".t_iVarId";
    End;

    Macro GetIsAP()
        return "       DECODE(INSTR(bl.t_Kind_Account,"+GetSQLString(KA_AP)+"),0,0,1)";
    End;

    return "SELECT bl.t_Balance      Balance,"                                  + "\n" +
           "       bl.t_Kind_Account BKind,  "                                  + "\n" +
           "       bl.t_Chapter      Chapter, "                                 + "\n" +
           "       bl.t_iNumPlan     planNumber, "                              + "\n" +
                   GetIsAP()          + " isAP,"                                + "\n" +
                   SelectString("cs") + ","                                     + "\n" +
                   SelectString("cr") + ","                                     + "\n" +
                   SelectString("cp") + ","                                     + "\n" +
                   SelectString("ds") + ","                                     + "\n" +
                   SelectString("dr") + ","                                     + "\n" +
                   SelectString("dp") + ","                                     + "\n" +
                   SelectString("oas") + ","                                     + "\n" +
                   SelectString("oar") + ","                                     + "\n" +
                   SelectString("oap") + ","                                     + "\n" +
                   SelectString("ops") + ","                                     + "\n" +
                   SelectString("opr") + ","                                     + "\n" +
                   SelectString("opp")                                           + "\n" +
           "FROM   dbalance_dbt  bl, "                                          + "\n" +
           "       dobchaptr_dbt ch, "                                          + "\n" +
           "       dcy_varsd_dbt vdcs, dcy_varsd_dbt vdcr, dcy_varsd_dbt vdcp," + "\n" +
           "       dcy_varsd_dbt vdds, dcy_varsd_dbt vddr, dcy_varsd_dbt vddp," + "\n" +
           "       dcy_varsd_dbt vdoas, dcy_varsd_dbt vdoar, dcy_varsd_dbt vdoap," + "\n" +
           "       dcy_varsd_dbt vdops, dcy_varsd_dbt vdopr, dcy_varsd_dbt vdopp," + "\n" +
           "       dcy_mreal_dbt mrcs, dcy_mreal_dbt mrcr, dcy_mreal_dbt mrcp," + "\n" +
           "       dcy_mreal_dbt mrds, dcy_mreal_dbt mrdr, dcy_mreal_dbt mrdp," + "\n" +
           "       dcy_mreal_dbt mroas, dcy_mreal_dbt mroar, dcy_mreal_dbt mroap," + "\n" +
           "       dcy_mreal_dbt mrops, dcy_mreal_dbt mropr, dcy_mreal_dbt mropp " + "\n" +
           "WHERE      bl.t_Chapter         =     ch.t_Chapter                " + "\n" +
           "       AND bl.t_iNumPlan        = " + ПолучитьРеальныйНомерПлана()  + "\n" +
           "       AND (    INSTR(bl.t_Kind_Account, 'А') > 0   "                       + "\n" +
           "             OR INSTR(bl.t_Kind_Account, 'П') > 0 ) "                       + "\n" +
           "       AND INSTR(bl.t_Type_Balance," + GetSQLChar("1")   + ") = 0"  + "\n" +
           "       AND ch.t_excludefromformalacnt = " + GetSqlChar( "" )        + "\n" +
                   WhereString("cs","__К",    BegDate,EndDate)                  + "\n" +
                   WhereString("cr","РуК",    BegDate,EndDate)                  + "\n" +
                   WhereString("cp","ПоК",    BegDate,EndDate)                  + "\n" +
                   WhereString("ds","__Д",    BegDate,EndDate)                  + "\n" +
                   WhereString("dr","РуД",    BegDate,EndDate)                  + "\n" +
                   WhereString("dp","ПоД",    BegDate,EndDate)                  + "\n" +
                   WhereString("oas","__А",   BegDate,EndDate)                  + "\n" +
                   WhereString("oar","РуА",   BegDate,EndDate)                  + "\n" +
                   WhereString("oap","ПоА",   BegDate,EndDate)                  + "\n" +
                   WhereString("ops","__П",   BegDate,EndDate)                  + "\n" +
                   WhereString("opr","РуП",   BegDate,EndDate)                  + "\n" +
                   WhereString("opp","ПоП",   BegDate,EndDate)                  + "\n" +
           "ORDER BY bl.t_Balance";

END;


private macro GetPreparedQuery( BegDate, EndDate )

    macro GetDevisor();
        if ( ЕдиницыИзмерения == ЕИ_Тысячи )
            return 1000;
        elif ( ЕдиницыИзмерения == ЕИ_НацВал )
            return 1;
        elif ( ЕдиницыИзмерения == ЕИ_НацВалТочн )
            return 1;
        elif ( ЕдиницыИзмерения == ЕИ_Миллионы )
            return 1000000;
        end;
    end;

    macro GetDevidedField( field, devisor )
        if ( devisor != 1 )
            return string( field, "/", devisor );
        else 
            return field;
        end;
        
    end;

    var devisor = GetDevisor();

    

    var preparedQuery =
        " SELECT " + GetSQLChar(RcbIsSummaryMode)  +     " T_ISSUMMARY,             " +
                 GetSqlDate( EndDate ) +     " T_BDREPDATE,             " +
                 GetSqlDate( BegDate ) +     " T_BDPREVDATE,            " +
        "        0                             T_IREGCODE,              " +
        "        q.chapter                     T_ICHAPTER,              " +
        "        q.planNumber                  T_INUMPLAN,              " +
        "        0                             T_ICURRENCY,             " +
        "        q.Balance                     T_BALANCE,               " +
        "    " + НомерПодразделения        + " T_INUMDPRT,              " +
        "    " + RcbOrganizationStructure  + " T_ORGANIZATIONSTRUCTURE, " +
        "    " + RcbIssueMode              + " T_ISSUEMODE,             " +
        "        decode( q.oas1, NULL, 0, q.oas1 + q.cs1 - q.ds1 ) T_DMINACTIVE,  " +
        "        decode( q.oar1, NULL, 0, q.oar1 + q.cr1 - q.dr1 ) T_DMINACTIVE_R, " + 
        "        decode( q.oap1, NULL, 0, q.oap1 + q.cp1 - q.dp1 ) T_DMINACTIVE_V, " + 
        "        decode( q.ops1, NULL, 0, q.ops1 - q.cs1 + q.ds1 ) T_DMINPASSIVE,  " +
        "        decode( q.opr1, NULL, 0, q.opr1 - q.cr1 + q.dr1 ) T_DMINPASSIVE_R, " + 
        "        decode( q.opp1, NULL, 0, q.opp1 - q.cp1 + q.dp1 ) T_DMINPASSIVE_V, " + 
        "        NVL(q.ds1, 0)                 T_DMDEBET, " +
        "        NVL(q.dr1, 0)                 T_DMDEBET_R, " +
        "        NVL(q.dp1, 0)                 T_DMDEBET_V, " +
        "        NVL(q.cs1, 0)                 T_DMCREDIT, " +
        "        NVL(q.cr1, 0)                 T_DMCREDIT_R, " +
        "        NVL(q.cp1, 0)                 T_DMCREDIT_V, " +
        "        NVL(q.oas1, 0)                T_DMOUTACTIVE,  " +
        "        NVL(q.oar1, 0)                T_DMOUTACTIVE_R, " +
        "        NVL(q.oap1, 0)                T_DMOUTACTIVE_V, " +
        "        NVL(q.ops1, 0)                T_DMOUTPASSIVE,  " +
        "        NVL(q.opr1, 0)                T_DMOUTPASSIVE_R, " +
        "        NVL(q.opp1, 0)                T_DMOUTPASSIVE_V, " +
        "        0                             T_DMFINALDEBET, " +
        "        0                             T_DMFINALDEBET_R,  " +
        "        0                             T_DMFINALDEBET_V, " +
        "        0                             T_DMFINALCREDIT, " +
        "        0                             T_DMFINALCREDIT_R, " +
        "        0                             T_DMFINALCREDIT_V,  " +
        "NVL(" + GetDevidedField( "decode( q.oas2, NULL, 0, q.oas2 + q.cs2 - q.ds2 )", devisor ) + ", 0) T_LMINACTIVETH,  " +
        "NVL(" + GetDevidedField( "decode( q.oar2, NULL, 0, q.oar2 + q.cr2 - q.dr2 )", devisor ) + ", 0) T_LMINACTIVETH_R, " + 
        "NVL(" + GetDevidedField( "decode( q.oap2, NULL, 0, q.oap2 + q.cp2 - q.dp2 )", devisor ) + ", 0) T_LMINACTIVETH_V, " + 
        "NVL(" + GetDevidedField( "decode( q.ops2, NULL, 0, q.ops2 - q.cs2 + q.ds2 )", devisor ) + ", 0) T_LMINPASSIVETH,  " +
        "NVL(" + GetDevidedField( "decode( q.opr2, NULL, 0, q.opr2 - q.cr2 + q.dr2 )", devisor ) + ", 0) T_LMINPASSIVETH_R, " + 
        "NVL(" + GetDevidedField( "decode( q.opp2, NULL, 0, q.opp2 - q.cp2 + q.dp2 )", devisor ) + ", 0) T_LMINPASSIVETH_V, " + 
        "NVL(" + GetDevidedField( "q.ds2",  devisor ) +  ", 0) T_LMDEBETTH, " +
        "NVL(" + GetDevidedField( "q.dr2",  devisor ) +  ", 0) T_LMDEBETTH_R, " +
        "NVL(" + GetDevidedField( "q.dp2",  devisor ) +  ", 0) T_LMDEBETTH_V, " +
        "NVL(" + GetDevidedField( "q.cs2",  devisor ) +  ", 0) T_LMCREDITTH, " +
        "NVL(" + GetDevidedField( "q.cr2",  devisor ) +  ", 0) T_LMCREDITTH_R, " +
        "NVL(" + GetDevidedField( "q.cp2",  devisor ) +  ", 0) T_LMCREDITTH_V, " +
        "NVL(" + GetDevidedField( "q.oas2", devisor ) +  ", 0) T_LMOUTACTIVETH, " +
        "NVL(" + GetDevidedField( "q.oar2", devisor ) +  ", 0) T_LMOUTACTIVETH_R, " +
        "NVL(" + GetDevidedField( "q.oap2", devisor ) +  ", 0) T_LMOUTACTIVETH_V, " +
        "NVL(" + GetDevidedField( "q.ops2", devisor ) +  ", 0) T_LMOUTPASSIVETH, " +
        "NVL(" + GetDevidedField( "q.opr2", devisor ) +  ", 0) T_LMOUTPASSIVETH_R, " +
        "NVL(" + GetDevidedField( "q.opp2", devisor ) +  ", 0) T_LMOUTPASSIVETH_V, " +
        "        0                             T_LMFINALDEBETTH, " +
        "        0                             T_LMFINALDEBETTH_R,  " +
        "        0                             T_LMFINALDEBETTH_V, " +
        "        0                             T_LMFINALCREDITTH, " +
        "        0                             T_LMFINALCREDITTH_R, " +
        "        0                             T_LMFINALCREDITTH_V  " +
        " FROM ( " + GetQuery( BegDate, EndDate ) + " ) q " +
        " WHERE NVL(q.oas1, 0) != 0 " +
        " OR    NVL(q.ops1, 0) != 0 " +
        " OR    NVL(q.cs1,  0) != 0 " +
        " OR    NVL(q.ds1,  0) != 0 ";
        

    return preparedQuery;
end;

private macro GetExistentBalanceDataQuery( BegDate, EndDate )
    var existentBalanceDataQuery =
        " SELECT * FROM dcx_mbl98_dbt bd " +
        " WHERE  bd.t_NumDprt    =   " + НомерПодРазделения +
        " AND    bd.t_bdPrevDate =   " + GetSqlDate( BegDate ) +
        " AND    bd.t_bdRepDate  =   " + GetSqlDate( EndDate ) +
        " AND    bd.t_iRegCode   = 0 " +
        " AND    bd.t_iNumPlan   =   " + ПолучитьРеальныйНомерПлана() +
        " AND    bd.t_iCurrency  = 0 ";

    return existentBalanceDataQuery;
end;



private macro ReplaceExistentData( BegDate, EndDate, shouldDeleteData, isShowMessage )

    macro DeleteExistentBalanceData( BegDate, EndDate )
        var deleteQuery = 
            " DELETE FROM dcx_mbl98_dbt bd        " +
            " WHERE  bd.t_NumDprt    =            " + НомерПодРазделения             +
            " AND    bd.t_IsSummary  =            " + GetSqlChar( RcbIsSummaryMode ) +
            " AND    bd.t_OrganizationStructure = " + RcbOrganizationStructure       +
            " AND    bd.t_IssueMode =             " + RcbIssueMode                   +
            " AND    bd.t_bdPrevDate =            " + GetSqlDate( BegDate )          +
            " AND    bd.t_bdRepDate  =            " + GetSqlDate( EndDate )          +
            " AND    bd.t_iRegCode   = 0          " +
            " AND    bd.t_iNumPlan   =            " + ПолучитьРеальныйНомерПлана() +
            " AND    bd.t_iCurrency  = 0          ";
 
        SQL_Execute( deleteQuery, "Удаление старых данных" );
    end;

    macro InsertCalculatedData( BegDate, EndDate )
        var InsertCalculatedDataQuery =
            " INSERT INTO dcx_mbl98_dbt " +
            " ( T_ISSUMMARY, T_BDREPDATE, T_BDPREVDATE, T_IREGCODE, T_ICHAPTER, T_INUMPLAN, T_ICURRENCY, T_BALANCE, T_NUMDPRT, T_ORGANIZATIONSTRUCTURE, T_ISSUEMODE, " +
            "   T_DMINACTIVE, T_DMINACTIVE_R, T_DMINACTIVE_V,  T_DMINPASSIVE, T_DMINPASSIVE_R, T_DMINPASSIVE_V,                             " +
            "   T_DMDEBET, T_DMDEBET_R, T_DMDEBET_V, T_DMCREDIT, T_DMCREDIT_R, T_DMCREDIT_V,                                                " +
            "   T_DMOUTACTIVE, T_DMOUTACTIVE_R, T_DMOUTACTIVE_V, T_DMOUTPASSIVE, T_DMOUTPASSIVE_R, T_DMOUTPASSIVE_V,                        " +
            "   T_DMFINALDEBET, T_DMFINALDEBET_R, T_DMFINALDEBET_V, T_DMFINALCREDIT, T_DMFINALCREDIT_R, T_DMFINALCREDIT_V,                  " +
            "   T_LMINACTIVETH, T_LMINACTIVETH_R, T_LMINACTIVETH_V, T_LMINPASSIVETH, T_LMINPASSIVETH_R, T_LMINPASSIVETH_V,                  " + 
            "   T_LMDEBETTH, T_LMDEBETTH_R, T_LMDEBETTH_V, T_LMCREDITTH, T_LMCREDITTH_R, T_LMCREDITTH_V,                                    " +
            "   T_LMOUTACTIVETH, T_LMOUTACTIVETH_R, T_LMOUTACTIVETH_V, T_LMOUTPASSIVETH, T_LMOUTPASSIVETH_R, T_LMOUTPASSIVETH_V,            " + 
            "   T_LMFINALDEBETTH, T_LMFINALDEBETTH_R, T_LMFINALDEBETTH_V, T_LMFINALCREDITTH, T_LMFINALCREDITTH_R, T_LMFINALCREDITTH_V )     " +
            GetPreparedQuery( BegDate, EndDate );

        SQL_Execute( InsertCalculatedDataQuery, "Вставка данных, рассчитанных по переменным" );
        
    end;

    if ( shouldDeleteData )
        DeleteExistentBalanceData( BegDate, EndDate );
    end;
    InsertCalculatedData( BegDate, EndDate );

    if (isShowMessage)
    msgbox( "Данные синхронизированы" );
    end;

end;

private macro FillCalculatedBalanceData()
    var existentBalanceData = TRsbDataSet( GetExistentBalanceDataQuery( ПредДатаОтчета, датаОтчета ) );
    var dumper;
    var differingDataQuery;
    var isDataIdentical;
    var shouldReplaceData;
    var protocolFileName = GetNameLog( "sba" );
    SetOutPut( protocolFileName );

    if ( not existentBalanceData.MoveNext() ) 
        ReplaceExistentData( ПредДатаОтчета, датаОтчета, false, true );
    else 
        dumper = SQL_Dumper(4);

        dumper.AddColumn(  "source",               "Источник данных",     15);
        dumper.AddColumn(  "T_BDREPDATE",          "T_BDREPDATE",         10);
        dumper.AddColumn(  "T_BDPREVDATE",         "T_BDPREVDATE",        10);
        dumper.AddColumn(  "T_IREGCODE",           "T_IREGCODE",          3);
        dumper.AddColumn(  "T_ICHAPTER",           "T_ICHAPTER",          4);
        dumper.AddColumn(  "T_INUMPLAN",           "T_INUMPLAN",          4);
        dumper.AddColumn(  "T_ICURRENCY",          "T_ICURRENCY",         3);
        dumper.AddColumn(  "T_BALANCE",            "T_BALANCE",           7);
        dumper.AddColumn(  "T_INUMDPRT",           "T_INUMDPRT",          6);
        dumper.AddColumn(  "T_DMINACTIVE",         "T_DMINACTIVE",        15);
        dumper.AddColumn(  "T_DMINACTIVE_R",       "T_DMINACTIVE_R",      15);
        dumper.AddColumn(  "T_DMINACTIVE_V",       "T_DMINACTIVE_V",      15);
        dumper.AddColumn(  "T_DMINPASSIVE",        "T_DMINPASSIVE",       15);
        dumper.AddColumn(  "T_DMINPASSIVE_R",      "T_DMINPASSIVE_R",     15);
        dumper.AddColumn(  "T_DMINPASSIVE_V",      "T_DMINPASSIVE_V",     15);
        dumper.AddColumn(  "T_DMDEBET",            "T_DMDEBET",           15);
        dumper.AddColumn(  "T_DMDEBET_R",          "T_DMDEBET_R",         15);
        dumper.AddColumn(  "T_DMDEBET_V",          "T_DMDEBET_V",         15);
        dumper.AddColumn(  "T_DMCREDIT",           "T_DMCREDIT",          15);
        dumper.AddColumn(  "T_DMCREDIT_R",         "T_DMCREDIT_R",        15);
        dumper.AddColumn(  "T_DMCREDIT_V",         "T_DMCREDIT_V",        15);
        dumper.AddColumn(  "T_DMOUTACTIVE",        "T_DMOUTACTIVE",       15);
        dumper.AddColumn(  "T_DMOUTACTIVE_R",      "T_DMOUTACTIVE_R",     15);
        dumper.AddColumn(  "T_DMOUTACTIVE_V",      "T_DMOUTACTIVE_V",     15);
        dumper.AddColumn(  "T_DMOUTPASSIVE",       "T_DMOUTPASSIVE",      15);
        dumper.AddColumn(  "T_DMOUTPASSIVE_R",     "T_DMOUTPASSIVE_R",    15);
        dumper.AddColumn(  "T_DMOUTPASSIVE_V",     "T_DMOUTPASSIVE_V",    15);
        dumper.AddColumn(  "T_DMFINALDEBET",       "T_DMFINALDEBET",      15);
        dumper.AddColumn(  "T_DMFINALDEBET_R",     "T_DMFINALDEBET_R",    15);
        dumper.AddColumn(  "T_DMFINALDEBET_V",     "T_DMFINALDEBET_V",    15);
        dumper.AddColumn(  "T_DMFINALCREDIT",      "T_DMFINALCREDIT",     15);
        dumper.AddColumn(  "T_DMFINALCREDIT_R",    "T_DMFINALCREDIT_R",   15);
        dumper.AddColumn(  "T_DMFINALCREDIT_V",    "T_DMFINALCREDIT_V",   15);
        dumper.AddColumn(  "T_LMINACTIVETH",       "T_LMINACTIVETH",      15);
        dumper.AddColumn(  "T_LMINACTIVETH_R",     "T_LMINACTIVETH_R",    15);
        dumper.AddColumn(  "T_LMINACTIVETH_V",     "T_LMINACTIVETH_V",    15);
        dumper.AddColumn(  "T_LMINPASSIVETH",      "T_LMINPASSIVETH",     15);
        dumper.AddColumn(  "T_LMINPASSIVETH_R",    "T_LMINPASSIVETH_R",   15);
        dumper.AddColumn(  "T_LMINPASSIVETH_V",    "T_LMINPASSIVETH_V",   15);
        dumper.AddColumn(  "T_LMDEBETTH",          "T_LMDEBETTH",         15);
        dumper.AddColumn(  "T_LMDEBETTH_R",        "T_LMDEBETTH_R",       15);
        dumper.AddColumn(  "T_LMDEBETTH_V",        "T_LMDEBETTH_V",       15);
        dumper.AddColumn(  "T_LMCREDITTH",         "T_LMCREDITTH",        15);
        dumper.AddColumn(  "T_LMCREDITTH_R",       "T_LMCREDITTH_R",      15);
        dumper.AddColumn(  "T_LMCREDITTH_V",       "T_LMCREDITTH_V",      15);
        dumper.AddColumn(  "T_LMOUTACTIVETH",      "T_LMOUTACTIVETH",     15);
        dumper.AddColumn(  "T_LMOUTACTIVETH_R",    "T_LMOUTACTIVETH_R",   15);
        dumper.AddColumn(  "T_LMOUTACTIVETH_V",    "T_LMOUTACTIVETH_V",   15);
        dumper.AddColumn(  "T_LMOUTPASSIVETH",     "T_LMOUTPASSIVETH",    15);
        dumper.AddColumn(  "T_LMOUTPASSIVETH_R",   "T_LMOUTPASSIVETH_R",  15);
        dumper.AddColumn(  "T_LMOUTPASSIVETH_V",   "T_LMOUTPASSIVETH_V",  15);
        dumper.AddColumn(  "T_LMFINALDEBETTH",     "T_LMFINALDEBETTH",    15);
        dumper.AddColumn(  "T_LMFINALDEBETTH_R",   "T_LMFINALDEBETTH_R",  15);
        dumper.AddColumn(  "T_LMFINALDEBETTH_V",   "T_LMFINALDEBETTH_V",  15);
        dumper.AddColumn(  "T_LMFINALCREDITTH",    "T_LMFINALCREDITTH",   15);
        dumper.AddColumn(  "T_LMFINALCREDITTH_R",  "T_LMFINALCREDITTH_R", 15);
        dumper.AddColumn(  "T_LMFINALCREDITTH_V",  "T_LMFINALCREDITTH_V", 15);

        differingDataQuery = 
                         " SELECT * FROM ( " +
                         "(" + 
                            " SELECT " + GetSqlString("Переменные") + " source, " +
                            "            v.* "
                            " FROM ( " +
                                GetPreparedQuery( ПредДатаОтчета, датаОтчета ) + 
                                " MINUS " + 
                                GetExistentBalanceDataQuery( ПредДатаОтчета, датаОтчета ) +
                            "      ) v " +
                         ")" +
                         " UNION "
                         "(" +
                            " SELECT " + GetSqlString("dcx_mbl98_dbt") + " source, " +
                            "            t.* "
                            " FROM ( " +
                            GetExistentBalanceDataQuery( ПредДатаОтчета, датаОтчета ) + 
                            " MINUS " + 
                            GetPreparedQuery( ПредДатаОтчета, датаОтчета ) +
                            "      ) t " +
                         ") ) t ORDER BY t.T_BALANCE, t.SOURCE ";

        isDataIdentical = not dumper.Dump( differingDataQuery, "Сравнение данных" );

        if ( isDataIdentical )
            [ Данные идентичны ];

            ViewFileLog( protocolFileName );
            SetOutPut( NULL, true );

        else 
            [    Список несоотвествий данных ];
            [ ];

            ViewFileLog( protocolFileName );
            SetOutPut( NULL, true );


            if ( GetTRUE( TRUE, "Синхронизировать данные?" ) )
                ReplaceExistentData( ПредДатаОтчета, датаОтчета, true, true);
            end;

        end;
    end; 

    УстановитьФлагВозврата( OK_MACRO_FLAG );
    exit(1);
   
end;

private macro FillCalculatedBalanceDataNoMessage();
    var existentBalanceData = TRsbDataSet( GetExistentBalanceDataQuery( ПредДатаОтчета, датаОтчета ) );

    if ( not existentBalanceData.MoveNext() )
        ReplaceExistentData(ПредДатаОтчета, датаОтчета, false, false);
    else
        ReplaceExistentData( ПредДатаОтчета, датаОтчета, true, false );
    end;

    УстановитьФлагВозврата( OK_MACRO_FLAG );
    exit(1);

end;
