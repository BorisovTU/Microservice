/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank 6.0                                      R-Style Software Lab Ltd
   Файл подсистемы "Регламентируемая отчетность"

   Экспорт значений переменных Формы 664 Раздела 2 в текстовый файл для программы 
   kliko.exe согласно 1747-У

   CREATED : 18.04.2007 Малахова

   MODIFICATIONS:    
   NOTES: 

└────────────────────────────────────────────────────────────────────────── */
import ex_kl664common_1747u;

private MACRO isCommonValueSuitable(v)
    return (COMMON_VARIABLE_NAME == v.fieldValue(OPERATION_KIND_CODE).exactAsString);
END;

private MACRO isInRestValueSuitable(v)
    return (IN_REST_VARIABLE_NAME == v.fieldValue(OPERATION_KIND_CODE).exactAsString);
END;

private MACRO isOutRestValueSuitable(v)
    return (OUT_REST_VARIABLE_NAME == v.fieldValue(OPERATION_KIND_CODE).exactAsString);
END;

/*Класс экспорта первого раздела*/
CLASS (TExportIssue)TExportSecondIssue(exportIssueName, rootAttributeName, subsectionNumber)
    private var m_subsectionNumber = subsectionNumber;

    private var m_secondLevelAttributeName = ""; /*Имя переменной второго уровня*/
    private var m_temporaryTableRecord:TTemporaryTableRecord;
    private var m_temporaryTableRecordLevel2:TTemporaryTableRecord;

    private var m_rsbDataSet; /*выборка данных для экспорта*/

    private var m_currentLevelNumber;
    private var m_currentOperationKind;
    private var m_currentDirection;
    private var m_currentRestKind;

    private var m_numberOfExportStrings;

    MACRO getNumberOfExportStrings()
        return m_numberOfExportStrings;
    END;

    MACRO prepareData()

        m_temporaryTable = TTemporaryTable();

        m_temporaryTable.truncate();

        putDataToTemporaryTable();

    END;

    /*Функция преобразует наименования переменных первого уровня в буквенные коды*/
    /*для того, чтобы потом в базе при сортировке запись об остатках на начало была */
    /*раньше, чем об остатках на конец отчетного периода*/
    private MACRO getFirstLevelOperationCode(operationKind)
        var operationCode;

        if (operationKind == COMMON_VARIABLE_NAME)
            operationCode = "А";
        elif (operationKind == IN_REST_VARIABLE_NAME)
            operationCode = "Б";
        elif (operationKind == OUT_REST_VARIABLE_NAME)
            operationCode = "В";
        else
            operationCode = operationKind;
        end;

        return operationCode; 
    END;

    /*Добавление данных по переменным ВСЕГО и их структурным составляющим во временную таблицу*/
    private MACRO putCommonDataToTemporaryTable()
        var i = 0;
        var firstLevelCommonValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        var secondLevelValueIterator;

        firstLevelCommonValueIterator.setFilter(@isCommonValueSuitable);

        if (not firstLevelCommonValueIterator.first())
            m_temporaryTableRecord = TTemporaryTableRecord();
            m_temporaryTableRecord.m_currencyNumber = 0;
            m_temporaryTableRecord.m_currencyCode   = 0;
            m_temporaryTableRecord.m_currencyName   = "";
            m_temporaryTableRecord.m_direction = 0;

            m_temporaryTableRecord.m_commonDebit = $0;
            m_temporaryTableRecord.m_commonCredit = $0;
            m_temporaryTableRecord.m_restIn        = $0;
            m_temporaryTableRecord.m_restOut       = $0;
            m_temporaryTableRecord.m_operationKind = getFirstLevelOperationCode(COMMON_VARIABLE_NAME);
            m_temporaryTableRecord.m_debit         = $0;
            m_temporaryTableRecord.m_credit        = $0;
            m_temporaryTableRecord.m_countryCode   = "";
            m_temporaryTableRecord.m_countryName   = "";
            m_temporaryTableRecord.m_issueNumber = 2;                   
            m_temporaryTableRecord.m_issueSubsectionNumber = m_subsectionNumber; 
            m_temporaryTableRecord.m_levelNumber = 1;                  
            m_temporaryTableRecord.m_restKind = -1;

            m_temporaryTable.insert(m_temporaryTableRecord);
        end;

        while (not firstLevelCommonValueIterator.isDone())
            i = i + 1;
            /*Формируем данные для записи во временную таблицу*/
            m_temporaryTableRecord = TTemporaryTableRecord();
            m_temporaryTableRecord.m_currencyNumber = 0;
            m_temporaryTableRecord.m_currencyCode   = 0;
            m_temporaryTableRecord.m_currencyName   = "";
            m_temporaryTableRecord.m_direction = firstLevelCommonValueIterator.currentItem.fieldValue(DIRECTION).exact;

            if (m_temporaryTableRecord.m_direction == 1)
                m_temporaryTableRecord.m_commonDebit = 
                    firstLevelCommonValueIterator.currentItem.fieldValue(SUMM).scaled;
                m_temporaryTableRecord.m_commonCredit = $0;
            elif (m_temporaryTableRecord.m_direction == 0)
                m_temporaryTableRecord.m_commonDebit = $0;
                m_temporaryTableRecord.m_commonCredit = 
                    firstLevelCommonValueIterator.currentItem.fieldValue(SUMM).scaled;
            end;

            m_temporaryTableRecord.m_restIn        = $0;
            m_temporaryTableRecord.m_restOut       = $0;
            m_temporaryTableRecord.m_operationKind = getFirstLevelOperationCode(COMMON_VARIABLE_NAME);
            m_temporaryTableRecord.m_debit         = $0;
            m_temporaryTableRecord.m_credit        = $0;
            m_temporaryTableRecord.m_countryCode   = "";
            m_temporaryTableRecord.m_countryName   = "";
            m_temporaryTableRecord.m_issueNumber = 2;                   
            m_temporaryTableRecord.m_issueSubsectionNumber = m_subsectionNumber; 
            m_temporaryTableRecord.m_levelNumber = 1;                  
            m_temporaryTableRecord.m_restKind = -1;

            m_temporaryTable.insert(m_temporaryTableRecord);

            secondLevelValueIterator = firstLevelCommonValueIterator.currentItem.createValueIterator();            
            secondLevelValueIterator.first();
            while (not secondLevelValueIterator.isDone())
                m_temporaryTableRecordLevel2 = TTemporaryTableRecord ();

                m_temporaryTableRecordLevel2.m_currencyNumber = 0;
                m_temporaryTableRecordLevel2.m_currencyCode   = 0;
                m_temporaryTableRecordLevel2.m_currencyName   = "";
                m_temporaryTableRecordLevel2.m_direction      = m_temporaryTableRecord.m_direction;
                m_temporaryTableRecordLevel2.m_commonDebit    = $0;
                m_temporaryTableRecordLevel2.m_commonCredit   = $0;
                m_temporaryTableRecordLevel2.m_restIn         = $0;
                m_temporaryTableRecordLevel2.m_restOut        = $0;
                m_temporaryTableRecordLevel2.m_operationKind  = secondLevelValueIterator.currentItem.fieldValue(OPERATION_KIND_CODE).exact;
        

                if (m_temporaryTableRecordLevel2.m_direction == 1)

                    m_temporaryTableRecordLevel2.m_debit = 
                        secondLevelValueIterator.currentItem.fieldValue(SUMM).scaled;

                    m_temporaryTableRecordLevel2.m_credit = $0;
                
                elif (m_temporaryTableRecordLevel2.m_direction == 0)

                    m_temporaryTableRecordLevel2.m_debit = $0;
                
                    m_temporaryTableRecordLevel2.m_credit = 
                        secondLevelValueIterator.currentItem.fieldValue(SUMM).scaled;

                end;             
                

                m_temporaryTableRecordLevel2.m_countryCode   = "";
                m_temporaryTableRecordLevel2.m_countryName   = "";
                m_temporaryTableRecordLevel2.m_issueNumber = 2;                   
                m_temporaryTableRecordLevel2.m_issueSubsectionNumber = m_subsectionNumber; 
                m_temporaryTableRecordLevel2.m_levelNumber = 2;                  
                m_temporaryTableRecordLevel2.m_restKind = -1;

                m_temporaryTable.insert(m_temporaryTableRecordLevel2);

                secondLevelValueIterator.next();    
            end;

            firstLevelCommonValueIterator.next();
        end;

    END;

    /*Добавление данных по переменным входящих остатков во временную таблицу*/
    private MACRO putInRestDataToTemporaryTable()
        private var firstLevelInRestValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        firstLevelInRestValueIterator.setFilter(@isInRestValueSuitable);
        firstLevelInRestValueIterator.first();
        while (not firstLevelInRestValueIterator.isDone())
            /*Формируем данные для записи во временную таблицу*/
            m_temporaryTableRecord = TTemporaryTableRecord ();
            m_temporaryTableRecord.m_currencyNumber = 0;
            m_temporaryTableRecord.m_currencyCode   = 0;
            m_temporaryTableRecord.m_currencyName   = "";
            m_temporaryTableRecord.m_direction      = 0;

            m_temporaryTableRecord.m_commonDebit  = $0;
            m_temporaryTableRecord.m_commonCredit = $0;

            m_temporaryTableRecord.m_restIn        = firstLevelInRestValueIterator.currentItem.fieldValue(SUMM).scaled;
            m_temporaryTableRecord.m_restOut       = $0;
            m_temporaryTableRecord.m_operationKind = getFirstLevelOperationCode(IN_REST_VARIABLE_NAME);
            m_temporaryTableRecord.m_debit         = $0;
            m_temporaryTableRecord.m_credit        = $0;
            m_temporaryTableRecord.m_countryCode   = "";
            m_temporaryTableRecord.m_countryName   = "";
            m_temporaryTableRecord.m_issueNumber = 2;                   
            m_temporaryTableRecord.m_issueSubsectionNumber = m_subsectionNumber; 
            m_temporaryTableRecord.m_levelNumber = 1;                  
            m_temporaryTableRecord.m_restKind = 0;

            m_temporaryTable.insert(m_temporaryTableRecord);

            firstLevelInRestValueIterator.next();
        end;       
    END;

    /*Добавление данных по переменным исходящих остатков во временную таблицу*/
    private MACRO putOutRestDataToTemporaryTable()
        private var firstLevelOutRestValueIterator = RcbApplication().currentReport.attributeValue(m_rootAttributeName).createValueIterator();
        firstLevelOutRestValueIterator.setFilter(@isOutRestValueSuitable);
        firstLevelOutRestValueIterator.first();
        while (not firstLevelOutRestValueIterator.isDone())
            /*Формируем данные для записи во временную таблицу*/
            m_temporaryTableRecord = TTemporaryTableRecord ();
            m_temporaryTableRecord.m_currencyNumber        = 0;
            m_temporaryTableRecord.m_currencyCode          = 0;
            m_temporaryTableRecord.m_currencyName          = "";
            m_temporaryTableRecord.m_direction             = 0;
            m_temporaryTableRecord.m_commonDebit           = $0;
            m_temporaryTableRecord.m_commonCredit          = $0;
            m_temporaryTableRecord.m_restIn                = $0;
            m_temporaryTableRecord.m_restOut               = firstLevelOutRestValueIterator.currentItem.fieldValue(SUMM).scaled;
            m_temporaryTableRecord.m_operationKind         = getFirstLevelOperationCode(OUT_REST_VARIABLE_NAME);
            m_temporaryTableRecord.m_debit                 = $0;
            m_temporaryTableRecord.m_credit                = $0;
            m_temporaryTableRecord.m_countryCode           = "";
            m_temporaryTableRecord.m_countryName           = "";
            m_temporaryTableRecord.m_issueNumber           = 2;                   
            m_temporaryTableRecord.m_issueSubsectionNumber = m_subsectionNumber; 
            m_temporaryTableRecord.m_levelNumber           = 1;                  
            m_temporaryTableRecord.m_restKind              = 1;

            m_temporaryTable.insert(m_temporaryTableRecord);

            firstLevelOutRestValueIterator.next();
        end;
        
    END;

    /*Добавление данных для экспорта первого раздела во временную таблицу*/
    private MACRO putDataToTemporaryTable()

        putCommonDataToTemporaryTable();

        putInRestDataToTemporaryTable();

        putOutRestDataToTemporaryTable();

    END;

    private MACRO makeRsbDataSet()
       var queryText = "";

       queryText = queryText + "       SELECT   t_commonDebit           commonDebit," 
                             + "\n" +  "        t_commonCredit          commonCredit,"
                             + "\n" +  "        t_restIn                restIn,"      
                             + "\n" +  "        t_restOut               restOut,"     
                             + "\n" +  "        t_operationKind         opKind,"      
                             + "\n" +  "        t_debit                 debit,"       
                             + "\n" +  "        t_credit                credit,"      
                             + "\n" +  "        t_levelNumber           levNumber,"   
                             + "\n" +  "        t_direction             direction,"   
                             + "\n" +  "        t_restKind              restKind, "
                             + "\n" +  "        t_issueSubsectionNumber subsNum, "
                             + "\n" +  "        t_issueNumber           issueNumber";

       queryText = queryText + "\n" + "  FROM df664exp_tmp ";

       queryText = queryText + "\n" + "ORDER BY levNumber, "
                             + "\n" + "         opKind, "   
                             + "\n" + "         direction, "
                             + "\n" + "         restKind ";

       m_rsbDataSet = TRsbDataSet(queryText);

    END;

    private MACRO setCurrentValues(levelNumber,  
                                   operationKind,
                                   direction,    
                                   restKind)     

        m_currentLevelNumber   = levelNumber;   
        m_currentOperationKind = operationKind;
        m_currentDirection     = direction;    
        m_currentRestKind      = restKind;     
    END;

    private MACRO exportCurrentLevel1(rsbRecordSet, exportString:TExportString)
        if (rsbRecordSet.subsNum == 1)
            exportString.setWord(0, "БН");
        else
            exportString.setWord(0, "ЮФ");
        end;

        if (rsbRecordSet.opKind == getFirstLevelOperationCode(COMMON_VARIABLE_NAME))
            exportString.setWord(1, COMMON_VARIABLE_NAME);
            if (rsbRecordSet.direction == 0)  /*Кредит*/
                exportString.setWord(3, rsbRecordSet.commonCredit);        
            elif (rsbRecordSet.direction == 1) /*Дебет*/
                exportString.setWord(2, rsbRecordSet.commonDebit);                               
            end;
            exportString.setWord(4, "2");
            exportString.setWord(5, "1");
        elif (rsbRecordSet.restKind == 0)
            exportString.setWord(1, "Остатки на начало отч. периода");
            exportString.setWord(2, "");
            exportString.setWord(3, rsbRecordSet.restIn);
            exportString.setWord(4, "2");
            exportString.setWord(5, "2");
        elif (m_rsbDataSet.restKind == 1)
            exportString.setWord(1, "Остатки на конец отч. периода");
            exportString.setWord(2, "");
            exportString.setWord(3, rsbRecordSet.restOut);
            exportString.setWord(4, "2");
            exportString.setWord(5, "3");
        end;           
        exportString.setWord(6, "");

    END;

    private MACRO exportCurrentLevel2(rsbRecordSet, exportString:TExportString)
        if (rsbRecordSet.subsNum == 1)
            exportString.setWord(0, "БН");
        else
            exportString.setWord(0, "ЮФ");
        end;

        exportString.setWord(1, rsbRecordSet.opKind);

        if (rsbRecordSet.direction   == 0)  /*Кредит*/
            exportString.setWord(3, rsbRecordSet.credit);        
        elif (rsbRecordSet.direction == 1) /*Дебет*/
            exportString.setWord(2, rsbRecordSet.debit);                               
        end;

        exportString.setWord(4, "2");
        exportString.setWord(5, "0");
        exportString.setWord(6, "3");
    END;

    MACRO exportIssue(exportFile)
      
        private var hasRecords = FALSE;
        private var i = 0;
        private var exportString:TExportString;
        private var count;

        makeRsbDataSet();

        exportString = TExportString(2, exportFile, TRUE);

        exportString.putStringToExportFile(m_exportIssueName);

        count = 0;
        while (m_rsbDataSet.moveNext())
            hasRecords = TRUE;
            /*Итерация первая*/
            if (i == 0)


                setCurrentValues(m_rsbDataSet.levNumber,  
                                 m_rsbDataSet.opKind,
                                 m_rsbDataSet.direction,    
                                 m_rsbDataSet.restKind);     

                exportString = TExportString(m_rsbDataSet.issueNumber, exportFile, FALSE);

                exportCurrentLevel1 (m_rsbDataSet, exportString);
            else

               if (m_rsbDataSet.levNumber == 1)

                    if (m_rsbDataSet.opKind == m_currentOperationKind)

                       exportCurrentLevel1 (m_rsbDataSet, exportString);

                    else

                         exportString.putStringFromBufferToFile();
                         count = count + 1;

                         exportString = TExportString(m_rsbDataSet.issueNumber, exportFile, FALSE);

                         exportCurrentLevel1(m_rsbDataSet, exportString);

                    end;

                elif (m_rsbDataSet.levNumber == 2)

                    if (m_rsbDataSet.opKind == m_currentOperationKind)

                        exportCurrentLevel2(m_rsbDataSet, exportString); 

                    else
                        exportString.putStringFromBufferToFile();
                        count = count + 1;

                        exportString = TExportString(m_rsbDataSet.issueNumber, exportFile, FALSE);

                        exportCurrentLevel2(m_rsbDataSet, exportString);
                    end;

                end;

                setCurrentValues(m_rsbDataSet.levNumber,  
                                 m_rsbDataSet.opKind,
                                 m_rsbDataSet.direction,    
                                 m_rsbDataSet.restKind);     

            end;
           
            i = i + 1;
        end;

        if (hasRecords)

            exportString.putStringFromBufferToFile();
            count = count + 1;

        else

            exportString = TExportString(2, exportFile, FALSE);

            exportString.exportEmptyIssue();
            
        end;

        m_numberOfExportStrings = count;

    END;

    initTExportIssue(exportIssueName, rootAttributeName);
  
END;

