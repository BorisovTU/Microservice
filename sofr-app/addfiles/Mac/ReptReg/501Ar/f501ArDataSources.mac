/*
$Name:          f501ArDataSources.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501Ar. Источники данных.
*/

private const DEAL_KIND_ATTRACTION = "Привлечение";
private const DEAL_KIND_PLACEMENT  = "Размещение ";

/**
 * Форма 501Ar. Данные сделок МБК
 */
private class (RcbDataSource) TF501ArData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private const SQL_BEGIN_DATE = getSqlDate(TF501ArGlobal().getRcbReport().context.period.beginDate);
    private const SQL_END_DATE   = getSqlDate(TF501ArGlobal().getRcbReport().context.period.endDate);
    private const SQL_ZERO_DATE  = getSqlDate(Date(0, 0, 0));

    private var m_BalanceList =  "32001, 32010, 32101, 32110, 32201, 32301, 31301, 31310, 31401, 31410, 31501, 31601";

    macro clear()
        sql_truncate("df501_ar_tmp");
        return this;
    end;

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account                                                       account,"
                   + "\n" + "       acc.t_accountId                                                     accountId,"
                   + "\n" + "       acc.t_fiid                                                          fiid,"
                   + "\n" + "       acc.t_kind                                                          kindAccount,"
                   + "\n" + "       acc.t_chapter                                                       chapter,"
                   + "\n" + "       acc.t_balance                                                       balance,"
                   + "\n" + "       acc.t_dealNumber                                                    dealNumber,"
                   + "\n" + "       acc.t_prolongDealSign                                               prolongDealSign,"
                   + "\n" + "       acc.t_prolongDealNumber                                             prolongDealNumber,"
                   + "\n" + "       acc.t_prolongDealDate                                               prolongDealDate,"
                   + "\n" + "       acc.t_rate                                                          rate,"
                   + "\n" + "       acc.t_performanceDate                                               performanceDate,"
                   + "\n" + "       prt.t_id                                                            partyId,"
                   + "\n" + "       DECODE(prt.t_isResident, 1,prt.t_name, NVL((SELECT pn.t_name FROM dPartyName_dbt pn WHERE pn.t_partyId = prt.t_id AND pn.t_nameTypeId = 3  AND ROWNUM < 2), prt.t_name)) AS name, "
                   + "\n" + "       prt.t_isResident                                                    isResident,"
                   + "\n" + "       NVL((SELECT adr.t_country FROM dAdress_dbt adr WHERE adr.t_partyId = prt.t_id AND adr.t_type = 2 AND adr.t_country != CHR(1)), prt.t_countryCode) nrCountry,"
                   + "\n" + "       acc.t_inCoverRest                                                   BegRest,"
                   + "\n" + "       acc.t_outCoverRest                                                  EndRest,"
                   + "\n" + "       NVL((SELECT sum(doc.t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_debetaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Debet,"
                   + "\n" + "       NVL((SELECT sum(t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_creditaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0)                     Credit,"
                   + "\n" + "       acc.t_objectId                                                      objectId, "
                   + "\n" + "       acc.t_part                                                          part, "
                   + "\n" + "       CASE"
                   + "\n" + "            WHEN prt.t_isresident = 1 "
                   + "\n" + "            THEN"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN reppartycodes.t_code like '%/%'"
                   + "\n" + "                        THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                   + "\n" + "                    ELSE NVL(reppartycodes.t_code, CHR(1))"
                   + "\n" + "                END"
                   + "\n" + "            ELSE"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN prt.t_isswift = 1"
                   + "\n" + "                        THEN NVL(reppartycodes.t_code, 'НР')"
                   + "\n" + "                    ELSE 'НР'"
                   + "\n" + "                END"
                   + "\n" + "       END AS                                                              regNumber,"
                   //графа 13
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId, "
                                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN '11'" //Признак обременения первая цифра, остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                               WHEN NOT (party.t_isPhisical = 1 AND  party.t_isResident = 0)"
                   + "\n" + "                                   THEN '9' || party.t_name"
                   + "\n" + "                               ELSE '0'"
                   + "\n" + "                            END as t_name"
                   + "\n" + "                       FROM dRepParty_vw party,"
                   + "\n" + "                            dRepLinkedObjects_vw objLink"
                   + "\n" + "                      WHERE party.t_objectId                = objLink.t_id"
                   + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
                   + "\n" + "                        AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
                   + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "                        AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "                    ),"
                   + "\n" + "                    '0'"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                             onerousClaim,"
                   //графа 14
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId," +
                                                                                  getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN 'XYYY'" //Условный код первая цифра (если X - значит не заполяется), следующие 3 цифры - это код SWIFT (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (SELECT CASE"
                   + "\n" + "                                                     WHEN INSTR(codes.t_code, '/', 1, 1) != 0"
                   + "\n" + "                                                         THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
                   + "\n" + "                                                     WHEN codes.t_code = ''"
                   + "\n" + "                                                         THEN 'X' || 'YYY' || codes.t_code"
                   + "\n" + "                                                     ELSE '2' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 END"
                   + "\n" + "                                            FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                           WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
                   + "\n" + "                                             AND codes.t_partyId  = party.t_id)"

                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN (NVL((SELECT CASE"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 8"
                   + "\n" + "                                                              THEN '4' || 'XXX' || codes.t_code || 'XXX'"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 11"
                   + "\n" + "                                                              THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
                   + "\n" + "                                                          ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
                   + "\n" + "                                                      END t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '1' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isEmployer = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '6' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN '3'|| 'YYY' || 'HP'"
                   + "\n" + "                                WHEN party.t_isPhisical = 1 AND party.t_isResident = 1 AND party.t_isEmployer = 0"
                   + "\n" + "                                    THEN (NVL((SELECT '5' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_INN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
                   + "\n" + "                                ELSE 'X' || 'YYY' || ''"
                   + "\n" + "                            END t_identifier"
                   + "\n" + "                        FROM dRepLinkedObjects_vw link,"
                   + "\n" + "                             dRepParty_vw party"
                   + "\n" + "                       WHERE acc.t_objectId               = link.t_connectObjectId"
                   + "\n" + "                         AND party.t_objectId             = link.t_id"
                   + "\n" + "                         AND link.t_isInstalledForEndDate = 1"
                   + "\n" + "                         AND link.t_connectObjectType     = 4"
                   + "\n" + "                         AND link.t_type                  = 3"
                   + "\n" + "                         AND link.t_role                  = 59"
                   + "\n" + "                    ),"
                   + "\n" + "                    'X' || 'YYY' || ''"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                                 identifier,"
                   //графа 15
                   + "\n" + "       (SELECT CASE category.t_value"
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда")             + " THEN " + getSqlString("1")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит")           + " THEN " + getSqlString("2")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз")          + " THEN " + getSqlString("4")
                   + "\n" + "                    ELSE " + getSqlString("")
                   + "\n" + "               END"
                   + "\n" + "          FROM dRepCategory_vw category,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE category.t_id = " + RCB_OBJGROUP_FOR_REPORTING
                   + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND category.t_value = ANY(" + getSqlString("Обрем_Ссуда") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_Депозит") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ДолгОбязательство") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ИноеОбяз") + ""
                   + "\n" + "                                     )"
                   + "\n" + "           AND category.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND category.t_objectId              = objLink.t_id"
                   + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1"
                   + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId"
                   + "\n" + "       ) onerousClaimCategory,"
                   //графа 16
                   + "\n" + "       (SELECT acc2.t_outCoverRest"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) restLinkedAccount,"
                   //графа 17
                   + "\n" + "       (SELECT TO_CHAR(rep_note.getDateAccountNote(acc2.t_objectId, 16, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")/*, 'DD.MM.YYYY'*/)"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) redemptionDate";

        queryForData = queryForData
                   + "\n" + "  FROM accountTable acc,"//Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
                   + "\n" + "       drepparty_vw prt,"
                   + "\n" + "       (SELECT *"
                   + "\n" + "          FROM dreppartycodes_vw partycode,"
                   + "\n" + "               drepparty_vw      repparty_"
                   + "\n" + "         WHERE repparty_.t_id = partycode.t_partyId"
                   + "\n" + "               -- для центробанка БИК (ЦБ РФ)"
                   + "\n" + "           AND (  (    repparty_.t_isCentralBank = 1"
                   + "\n" + "                   AND partycode.t_codekind   = " + RCB_PTCK_BIC + ")"
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                   + "\n" + "           OR (  (    repparty_.t_isResident = 0"
                   + "\n" + "                   AND partycode.t_codekind   = " + RCB_PTCK_SWIFT + ")"
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'"
                   + "\n" + "               OR (    repparty_.t_isResident = 1"
                   + "\n" + "                   AND repparty_.t_isCentralBank = 0"
                   + "\n" + "                   AND partycode.t_codekind   = " + RCB_PTCK_BANKREGNUM + ")))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = NVL(DECODE(acc.t_partyId, "
                   + "\n" + "                         " + {OurBank} + ", "
                   + "\n" + "                             acc.t_contragentId),"
                   + "\n" + "                             acc.t_partyId)"
                   + "\n" + "   AND prt.t_id = reppartycodes.t_partyid(+)"
                   ;

        return QueryForData;
    end;

    private macro addRelationsQuery()
        var query;

        query =  ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isRepoAccount,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isGD,                                                                                                                                                                     "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isThirdPerson,                                                                                                                                                            "
        + "\n" + "       rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ",  data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", "
                                                                             + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")) AS explanation,                                                                                                                                                              "
        + "\n" + "       SUBSTR(onerousClaim, 2) onerousClaim,                                                                                                                                         "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(onerousClaim, 1, 1) = 'X'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(onerousClaim, 1, 1)"
        + "\n" + "       END onerousSign,"

        + "\n" + "       SUBSTR(identifier, 5) identifier,                                                                                                                                             "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 2, 3) = 'YYY'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 2, 3)"
        + "\n" + "       END swiftDepartment,"

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 1, 1) = 'X'                                                                                                                                       "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 1, 1)"
        + "\n" + "       END conditionalCode,"

        + "\n" + "       NVL(onerousClaimCategory, " + getSqlString("") + ") onerousClaimCategory,                                                                                                                                                         "

        + "\n" + "       CASE"
        + "\n" + "           WHEN     onerousClaimCategory IS NOT NULL"
        + "\n" + "                AND onerousClaimCategory = '4'"
        + "\n" + "           THEN NVL((SELECT rep_note.getTextAccountNote(objLink.t_id, 69, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
        + "\n" + "                       FROM dRepLinkedObjects_vw objLink"
        + "\n" + "                      WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
        + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_connectObjectId       = data.objectId"
        + "\n" + "                    ),"
        + "\n" + "                    CHR(1)"
        + "\n" + "                   )"
        + "\n" + "           ELSE " + getSqlString("")
        + "\n" + "       END otherDecoding,"
        + "\n" + "       restLinkedAccount,                                                                                                                                                            "
        + "\n" + "       redemptionDate                                                                                                                                                                "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    macro cacheData(filter : String)
        var query =  "SELECT account,"
            + "\n" + "       accountId accId,"
            + "\n" + "       SUBSTR(balance, 1, 5) bal,"
            + "\n" + "       name,"
            + "\n" + "       regNumber,"
            + "\n" + "       DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry)) countryCode,"
            + "\n" + "       begRest,"
            + "\n" + "       debet,"
            + "\n" + "       credit,"
            + "\n" + "       endRest,"
            + "\n" + "       objectId,"
            + "\n" + "       partyID,"
            + "\n" + "       part,"
            + "\n" + "       kindAccount,"
            + "\n" + "       chapter,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN 'д/в'"
            + "\n" + "           ELSE "
            + "\n" + "                performanceDate "
            + "\n" + "       END AS performanceDate,"
            + "\n" + "       rate,"
            + "\n" + "       dealNumber,"
            + "\n" + "       prolongDealSign,"
            + "\n" + "       prolongDealNumber,"
            + "\n" + "       prolongDealDate";

            query = query + addRelationsQuery();

            query =  ""
            + "\n" + "WITH tune"
            + "\n" + "  AS (" + TF501ArGlobal().getTune().getQuery() + "),"
            + "\n" + "  mmDeals"
              "\n" + "  AS (SELECT /*+ MATERIALIZE*/ "
            + "\n" + "             SUM(deals.t_mainRestRoubleAmount),"
            + "\n" + "             deals.t_kind,"
            + "\n" + "             deals.t_contragentId"
            + "\n" + "        FROM repMmDeals_vw deals"
            + "\n" + "       WHERE deals.t_kind IN ('" + DEAL_KIND_PLACEMENT + "', '" + DEAL_KIND_ATTRACTION + "')"
            + "\n" + "         AND deals.t_startDateFact = " + SQL_END_DATE
            + "\n" + "    GROUP BY t_kind, t_contragentId"
            + "\n" + "    HAVING SUM(deals.t_mainRestRoubleAmount) >= " + TF501ArSettings().getThreshold(TF501ArGlobal().getRcbReport().context.period.endDate)
            + "\n" + "     ),"
            + "\n" + "  accountSrcTable"
            + "\n" + "  AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "             acc.t_objectId, acc.t_partyId, acc.t_contragentId,"
            + "\n" + "             deals.t_subPart t_part, deals.t_performanceDate, deals.t_rate, deals.t_prolongDealSign, deals.t_dealNumber,"
            + "\n" + "             deals.t_prolongDealDate, deals.t_prolongDealNumber"
            + "\n" + "        FROM drepaccount_vw acc,"
            + "\n" + "             tune t501Ar,"
            + "\n" + "             (SELECT mmDeal.t_id AS t_dealId,"
            + "\n" + "                     mmDeal.t_number AS t_dealNumber,"
            + "\n" + "                     mmDeal.t_mainRestAccount AS t_mainRestAccount,"
            + "\n" + "                     DECODE(mmDeal.t_isProlongingDeal, 'YES', 1, 0) AS t_prolongDealSign,"
            + "\n" + "                     NVL(TO_CHAR(mmDeal.t_plannedFinishDate, 'dd.mm.yyyy'), '') AS t_performanceDate,"
            + "\n" + "                      (SELECT rateHistory.t_rate"
            + "\n" + "                         FROM repMmDealRateHistory_vw rateHistory "
            + "\n" + "                        WHERE rateHistory.t_dealId = mmDeal.t_id"
            + "\n" + "                          AND rateHistory.t_percentKind = 7"
            + "\n" + "                          AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                          FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                         WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                           AND rh.t_percentKind = 7"
            + "\n" + "                                                           AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                       )"
            + "\n" + "                      )  AS t_rate,"
            + "\n" + "                     CASE "
            + "\n" + "                         WHEN mmDeal.t_isProlongingDeal = 'YES'"
            + "\n" + "                             THEN TO_CHAR((SELECT mm.t_openDate FROM repMmDeals_vw mm WHERE mm.t_id = mmDeal.t_prolongedDealId))"
            + "\n" + "                         ELSE ''"
            + "\n" + "                     END t_prolongDealDate,"
            + "\n" + "                     CASE "
            + "\n" + "                         WHEN mmDeal.t_isProlongingDeal = 'YES'"
            + "\n" + "                             THEN (SELECT mm.t_number FROM repMmDeals_vw mm WHERE mm.t_id = mmDeal.t_prolongedDealId)"
            + "\n" + "                         ELSE ''"
            + "\n" + "                     END t_prolongDealNumber,"
            + "\n" + "                     CASE mmDeal.t_kind"
            + "\n" + "                         WHEN '" + DEAL_KIND_PLACEMENT + "' THEN 1"
            + "\n" + "                         WHEN '" + DEAL_KIND_ATTRACTION + "' THEN 2"
            + "\n" + "                         ELSE 0"
            + "\n" + "                     END t_subPart"
            + "\n" + "                FROM repMmDeals_vw mmDeal"
            + "\n" + "               WHERE mmDeal.t_startDateFact = " + SQL_END_DATE
            + "\n" + "                 AND mmDeal.t_kind IN ('" + DEAL_KIND_PLACEMENT + "', '" + DEAL_KIND_ATTRACTION + "')"
            + "\n" + "                 AND EXISTS(SELECT 1 FROM mmDeals deals WHERE mmDeal.t_contragentId = deals.t_contragentId AND mmDeal.t_kind = deals.t_kind)"
            + "\n" + "             ) deals"
            + "\n" + "       WHERE acc.t_chapter = 1"
            + "\n" + "         AND RSB_MASK.COMPARESTRINGWITHMASK(t501Ar.t_accountMasks, acc.t_account) = 1"
            + "\n" + "         AND t501Ar.t_subPart = deals.t_subPart"
            + "\n" + "         AND acc.t_account = deals.t_mainRestAccount"
            + "\n" + "         AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                       + SQL_END_DATE + ") = 0"
            + "\n" + "     ),"
            + "\n" + "  accountTable"
            + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *"
            + "\n" + "        FROM accountSrcTable"
            + "\n" + "     )"
            + "\n" + "SELECT dealNumber,"
            + "\n" + "       account,"
            + "\n" + "       accId,"
            + "\n" + "       bal,"
            + "\n" + "       name,"
            + "\n" + "       regNumber,"
            + "\n" + "       countryCode,"
            + "\n" + "       begRest,"
            + "\n" + "       debet,"
            + "\n" + "       credit,"
            + "\n" + "       endRest,"
            + "\n" + "       partyId,"
            + "\n" + "       part,"
            + "\n" + "       kindAccount,"
            + "\n" + "       performanceDate,"
            + "\n" + "       isRepoAccount,"
            + "\n" + "       rate,"
            + "\n" + "       isGD,"
            + "\n" + "       isThirdPerson,"
            + "\n" + "       explanation,"
            + "\n" + "       onerousClaim,"
            + "\n" + "       identifier,"
            + "\n" + "       onerousClaimCategory,"
            + "\n" + "       restLinkedAccount,"
            + "\n" + "       redemptionDate,"
            + "\n" + "       onerousSign,"
            + "\n" + "       swiftDepartment,"
            + "\n" + "       conditionalCode,"
            + "\n" + "       otherDecoding,"
            + "\n" + "       prolongDealSign,"
            + "\n" + "       prolongDealNumber,"
            + "\n" + "       prolongDealDate"
            + "\n" + "  FROM (" + query + ")";

        sql_execute("INSERT INTO df501_ar_tmp"
                      + "\n" + "("
                      + "\n" + " t_dealNumber,"
                      + "\n" + " t_account,"
                      + "\n" + " t_accountId,"
                      + "\n" + " t_balance,"
                      + "\n" + " t_clientName,"
                      + "\n" + " t_regNumber,"
                      + "\n" + " t_countryCode,"
                      + "\n" + " t_beginRest,"
                      + "\n" + " t_debet,"
                      + "\n" + " t_credit,"
                      + "\n" + " t_endRest,"
                      + "\n" + " t_clientCode,"
                      + "\n" + " t_partReport,"
                      + "\n" + " t_kindAccount,"
                      + "\n" + " t_performanceDate,"
                      + "\n" + " t_isRepoAccount,"
                      + "\n" + " t_rate,"
                      + "\n" + " t_isGD,"
                      + "\n" + " t_isThirdPerson,"
                      + "\n" + " t_explanation,"
                      + "\n" + " t_encumbranceParty,"
                      + "\n" + " t_encumbrancePartyId,"
                      + "\n" + " t_encumbranceKind,"
                      + "\n" + " t_encumbranceRest,"
                      + "\n" + " t_redemptionDate,"
                      + "\n" + " t_encumbranceSign,"
                      + "\n" + " t_swiftDepartment,"
                      + "\n" + " t_conditionalCode,"
                      + "\n" + " t_otherDecoding,"
                      + "\n" + " t_prolongDealSign,"
                      + "\n" + " t_prolongDealNumber,"
                      + "\n" + " t_prolongDealDate"
                      + "\n" + ") "
                     + "\n" + query
                   );

        sql_execute("COMMIT");

        return this;
    end;

    macro getData(filter : String, attribute : RcbAttributeBase)
        return RcbDataset("SELECT t_account AS t_account,"
                 + "\n" + "       t_accountId AS t_accountId,"
                 + "\n" + "       t_dealNumber AS t_dealNumber,"
                 + "\n" + "       t_balance AS t_balance,"
                 + "\n" + "       t_clientName AS t_clientName,"
                 + "\n" + "       t_regNumber AS t_regNumber,"
                 + "\n" + "       t_countryCode AS t_countryCode,"
                 + "\n" + "       t_beginRest AS t_inRest,"
                 + "\n" + "       t_debet AS t_debetTurnover,"
                 + "\n" + "       t_credit AS t_creditTurnover,"
                 + "\n" + "       t_endRest AS outRest,"
                 + "\n" + "       t_clientCode AS t_accountClientCode,"
                 + "\n" + "       t_partReport AS t_partReport,"
                 + "\n" + "       t_kindAccount AS t_accountKind,"
                 + "\n" + "       t_performanceDate AS t_performanceDate,"
                 + "\n" + "       t_isRepoAccount AS t_repoAccountSign,"
                 + "\n" + "       t_rate AS t_percentValue,"
                 + "\n" + "       t_isGD AS t_gdSign,"
                 + "\n" + "       t_isThirdPerson AS t_thirdPartySign,"
                 + "\n" + "       t_explanation AS t_explanations,"
                 + "\n" + "       t_encumbranceParty AS t_encumbranceParty,"
                 + "\n" + "       t_encumbrancePartyId AS t_encumbrancePartyId,"
                 + "\n" + "       t_encumbranceKind AS t_encumbranceKind,"
                 + "\n" + "       t_encumbranceRest AS t_encumbranceRest,"
                 + "\n" + "       t_redemptionDate AS t_maturityDate,"
                 + "\n" + "       t_encumbranceSign AS t_encumbranceSign,"
                 + "\n" + "       t_swiftDepartment AS t_swiftFilial,"
                 + "\n" + "       t_conditionalCode AS t_conditionalCode,"
                 + "\n" + "       t_otherDecoding AS t_otherDecoding,"
                 + "\n" + "       t_prolongDealSign AS t_prolongDealSign,"
                 + "\n" + "       t_prolongDealNumber AS t_prolongDealNumber,"
                 + "\n" + "       t_prolongDealDate AS t_prolongDealDate"
                 + "\n" + "  FROM df501_ar_tmp sourceData"
                 + "\n" + " WHERE " + filter,
                          RSDVAL_SERVER, RSDVAL_FORWARD_ONLY
                         );
    end;

    private macro constructorTF501ArData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTF501ArData(id, protocolView, dataSources);
end;

/**
 * Форма 501Ar. Атрибуты формы. Базовый для разделов 1 и 2
 */
private class (RcbDataSource) TAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        throw(TPureVirtualMethodCallException("TAttributes::getPartFilter"));
    end;

    macro getData() : Object
        var dataset = m_datasources.getDatasource("501ArData").getData(getPartFilter());

        return dataset;
    end;

    private macro constructorTAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTAttributes(id, protocolView, dataSources);
end;

/**
 * Форма 501Ar. Атрибуты раздела 1
 */
private class (TAttributes) TAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        return " sourceData.t_partReport = 1";
    end;

    private macro constructorTAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart1(id, protocolView, dataSources);
end;

/**
 * Форма 501Ar. Атрибуты раздела 2
 */
private class (TAttributes) TAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        return " sourceData.t_partReport = 2";
    end;

    private macro constructorTAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart2(id, protocolView, dataSources);
end;

/**
 * Форма 501Ar. Контейнер ИД
 */
class (RcbDataSources) TF501ArDataSources(protocolView : RcbCalculateProtocolView)
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(TF501ArData("501ArData", null, this));
        m_dataSourcePool.push_back(TAttributesPart1("part1Data", null, this));
        m_dataSourcePool.push_back(TAttributesPart2("part2Data", null, this));
    end;

    private macro constructorTF501ArDataSources(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorTF501ArDataSources(protocolView);
end;
