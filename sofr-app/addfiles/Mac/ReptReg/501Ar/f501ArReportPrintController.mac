/*
$Name:          f501ArReportPrintController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501Ar. Контроллер печати отчета.
*/

class (RcbReportPrintController) TF501ArReportPrintController(format : Integer)
    private var m_format : Integer;

    private macro getRowNumber(number, value) : string
        var rowNumber = string(number);

        if (value.getRepoAccountSign() == 1)
            rowNumber = rowNumber + "*";
        elif (value.getGdSign() == 1)
            rowNumber = rowNumber + "**";
        elif (value.getThirdPartySign() == 1)
            rowNumber = rowNumber + "***";
        end;
        return rowNumber;
    end;

    private macro printDataZone()
        var view = getReportView();

        var isPartEmpty = RcbArray().init(null,
                                        getReport().getPart(TF501ArGlobal().getPart1Id()).isEmpty(),
                                        getReport().getPart(TF501ArGlobal().getPart2Id()).isEmpty(),
                                        true
                                        );

        view.printHead();

        var i = 0, rowNumber = 0;
        for (var partId, RcbArray().init(TF501ArGlobal().getPart1Id(), TF501ArGlobal().getPart2Id()))
            i = i + 1;
            message("Раздел " + i);

            var part = getReport().getPart(partId);
            var partView = view.getPartView(partId);

            partView.printHead();

            for (var attribute, part.getAttributes(true))
                var value = attribute.getValue();
                rowNumber = rowNumber + 1;

                partView.printString(getRowNumber(rowNumber, value), value);
            end;
        end;

        partView.printBottom();
        view.printSignatureZone();
    end;

    macro print()
        checkReport();

        var view = getReportView();

        if (m_format != WINREP_FORMAT_XLSX)
            view.setOutputFile();
            view.setReportWidth(m_reportWidth);
            view.printLendingAgencyCodeZone();
            view.printNamesZone("Полное или сокращенное фирменное наименование кредитной организации ");
            printDataZone();
        else
            view.print();
        end;
    end;

    private macro printAdditionalProtocolData()
//        TF501ArParameters().printPrintingReport(getProtocolView());
    end;

    private macro destructor()
        if (m_format == WINREP_FORMAT_XLSX)
            if (not m_protocolView.isEmpty())
                m_protocolView.show();
            end;
        else
            var view = getReportView();
            if (not m_protocolView.isEmpty())
                m_protocolView.show();
            end;
            view.resetOutputFile();
            destructor();
        end;
    end;

    private macro constructorTF501ArReportPrintController(format : Integer)
        initRcbReportPrintController();

        m_reportWidth = 201;
        m_format = nvl(format, WINREP_FORMAT_HTML);

        if (m_format == WINREP_FORMAT_XLSX)
            m_reportView = objectFactoryInstance.createReportExcelView(m_protocolView);
        else
            var view = getReportView();
            view.excludeAttribute(AC_FORM_PERIODICITY);
            view.excludeAttribute(AC_FORM_UNIT);
        end;
    end;

    constructorTF501ArReportPrintController(format);
end;
