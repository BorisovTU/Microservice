/*
$Name:          f501ArPartCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501Ar. Классы контроллеров расчета разделов.
*/

//Рассчитываемые атрибуты для контроллера расчета отчета - это конкретные графы для группы строк из раздела отчета.
private class (RcbPartCalculateController) TF501ArPartCalculateController(reportCalculateController : Object, partId : String)
    private var m_protocolView;
    private var m_dataProtocolView;

    macro getDataProtocolView()
        return m_dataProtocolView;
    end;

    macro createAttributes(data)
        var staticAttribute = objectFactoryInstance.createAttribute(null, m_part);

        while (data.moveNext())
            var account = data.account;
            var id = staticAttribute.makeId(account);

            var attributeValue;
            var attribute = m_part.getAttribute(id);
            if (attribute != null)
                attributeValue = attribute.getValue();
                attributeValue.set("dealNumber", nvl(data.dealNumber, ""));
                attributeValue.set("balance", nvl(data.balance, ""));
                attributeValue.set("clientName", nvl(data.clientName, ""));
                attributeValue.set("regNumber", nvl(data.regNumber, ""));
                attributeValue.set("countryCode", nvl(data.countryCode, ""));
                attributeValue.set("inRest", nvl(data.inRest, $0) + nvl(attributeValue.get("inRest").exact, $0));
                attributeValue.set("debetTurnover", nvl(data.debetTurnover, $0) + nvl(attributeValue.get("debetTurnover").exact, $0));
                attributeValue.set("creditTurnover", nvl(data.creditTurnover, $0) + nvl(attributeValue.get("creditTurnover").exact, $0));
                attributeValue.set("outRest", nvl(data.outRest, $0) + nvl(attributeValue.get("outRest").exact, $0));
                attributeValue.set("performanceDate", nvl(data.performanceDate, ""));
                attributeValue.set("percentValue", nvl(data.percentValue, $0));
                attributeValue.set("accountClientCode", nvl(data.accountClientCode, ""));
                attributeValue.set("accountKind", nvl(data.accountKind, ""));
                attributeValue.set("repoAccountSign", nvl(data.repoAccountSign, 0));
                attributeValue.set("thirdPartySign", nvl(data.thirdPartySign, 0));
                attributeValue.set("explanations", nvl(data.explanations, ""));
                attributeValue.set("encumbranceRest", nvl(data.encumbranceRest, $0) + nvl(attributeValue.get("encumbranceRest").exact, $0));
                attributeValue.set("gdSign", nvl(data.gdSign, 0));
                attributeValue.set("encumbranceParty", nvl(data.encumbranceParty, ""));
                attributeValue.set("encumbrancePartyId", nvl(data.encumbrancePartyId, ""));
                attributeValue.set("encumbranceKind", nvl(data.encumbranceKind, ""));
                attributeValue.set("maturityDate", nvl(data.maturityDate, ""));
                attributeValue.set("encumbranceSign", nvl(data.encumbranceSign, ""));
                attributeValue.set("swiftFilial", nvl(data.swiftFilial, ""));
                attributeValue.set("conditionalCode", nvl(data.conditionalCode, ""));
                attributeValue.set("otherDecoding", nvl(data.otherDecoding, ""));
                attributeValue.set("prolongDealSign", nvl(data.prolongDealSign, ""));
                attributeValue.set("prolongDealNumber", nvl(data.prolongDealNumber, ""));
                attributeValue.set("prolongDealDate", nvl(data.prolongDealDate, ""));
            else
                var storage = m_part.getPartCompositeValue().addValue();
                attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setAccount(account);

                attributeValue.set("dealNumber", nvl(data.dealNumber, ""));
                attributeValue.set("balance", nvl(data.balance, ""));
                attributeValue.set("clientName", nvl(data.clientName, ""));
                attributeValue.set("regNumber", nvl(data.regNumber, ""));
                attributeValue.set("countryCode", nvl(data.countryCode, ""));
                attributeValue.set("inRest", nvl(data.inRest, $0));
                attributeValue.set("debetTurnover", nvl(data.debetTurnover, $0));
                attributeValue.set("creditTurnover", nvl(data.creditTurnover, $0));
                attributeValue.set("outRest", nvl(data.outRest, $0));
                attributeValue.set("performanceDate", nvl(data.performanceDate, ""));
                attributeValue.set("percentValue", nvl(data.percentValue, $0));
                attributeValue.set("accountClientCode", nvl(data.accountClientCode, ""));
                attributeValue.set("accountKind", nvl(data.accountKind, ""));
                attributeValue.set("repoAccountSign", nvl(data.repoAccountSign, 0));
                attributeValue.set("thirdPartySign", nvl(data.thirdPartySign, 0));
                attributeValue.set("explanations", nvl(data.explanations, ""));
                attributeValue.set("encumbranceRest", nvl(data.encumbranceRest, $0));
                attributeValue.set("gdSign", nvl(data.gdSign, 0));
                attributeValue.set("encumbranceParty", nvl(data.encumbranceParty, ""));
                attributeValue.set("encumbrancePartyId", nvl(data.encumbrancePartyId, ""));
                attributeValue.set("encumbranceKind", nvl(data.encumbranceKind, ""));
                attributeValue.set("maturityDate", nvl(data.maturityDate, ""));
                attributeValue.set("encumbranceSign", nvl(data.encumbranceSign, ""));
                attributeValue.set("swiftFilial", nvl(data.swiftFilial, ""));
                attributeValue.set("conditionalCode", nvl(data.conditionalCode, ""));
                attributeValue.set("otherDecoding", nvl(data.otherDecoding, ""));
                attributeValue.set("prolongDealSign", nvl(data.prolongDealSign, ""));
                attributeValue.set("prolongDealNumber", nvl(data.prolongDealNumber, ""));
                attributeValue.set("prolongDealDate", nvl(data.prolongDealDate, ""));

                m_part.addAttribute(id, attributeValue);
            end;
        end;
    end;

    private macro getCalculateAttributeData(functionName : String, data : Object, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(RcbAttributeBase(dependencesAttributeIdPool.getCurrentItem(), m_part, null));
        end;

        return RcbCalculationAttributeData(null,
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(data/*список параметров*/)
                                                                                   )
                                                                ),
                                           RcbDependencesData(dependencesAttributePool)
                                          );
    end;



    private macro constructorTF501ArPartCalculateController(reportCalculateController : Object, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_protocolView = m_dataSources.getProtocolView();
    end;

    constructorTF501ArPartCalculateController(reportCalculateController, partId);
end;

class (TF501ArPartCalculateController) TF501ArPart1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    macro execute()
//        m_protocolView.printLine("");

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("createAttributes", m_datasources.getDatasource("part1Data").getData()));

//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF501ArPart1CalculateController(reportCalculateController : Object)
        initTF501ArPartCalculateController(reportCalculateController, TF501ArGlobal().getPart1Id());
        m_dataProtocolView = m_protocolView.getDataProtocolView("part1");
    end;

    constructorTF501ArPart1CalculateController(reportCalculateController);
end;

class (TF501ArPartCalculateController) TF501ArPart2CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    macro execute()
//        m_protocolView.printLine("");

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("createAttributes", m_datasources.getDatasource("part2Data").getData()));

//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF501ArPart2CalculateController(reportCalculateController : Object)
        initTF501ArPartCalculateController(reportCalculateController, TF501ArGlobal().getPart2Id());
        m_dataProtocolView = m_protocolView.getDataProtocolView("part2");
    end;

    constructorTF501ArPart2CalculateController(reportCalculateController);
end;
