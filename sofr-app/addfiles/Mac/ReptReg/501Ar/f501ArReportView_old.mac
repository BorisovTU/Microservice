/*
$Name:          f501ArReportView.mac
$Module:        âç¥âë –
$Description:   ”®à¬  501Ar. ¥ç â­®¥ ¯à¥¤áâ ¢«¥­¨¥ ®âç¥â .
*/

import param;
import rcbWebCommon;



class (RcbReportView) TF501ArReportView(protocolView : RcbPrintProtocolView)
    macro printData()
        m_view.printData(this);
    end;

    macro printHead()
    [    §¤¥« 1];
    [ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
    [³®¬¥à ³    ¨¬¥­®¢ ­¨¥ ªà¥¤¨â­®©   ³¥£¨áâà æ¨®­-³  Š®¤  ³  ®¬¥à   ³   ®¬¥à ®â¤¥«ì­®£®   ³   áâ â®ª    ³    ¡®à®âë §  ®âç¥â­ë©    ³   áâ â®ª   ³    „ â      ³à®æ¥­â-³ ®¬¥à  ³    „ â      ³  âç¥â­ ï   ³        «¨ç¨¥ ®¡à¥¬¥­¥­¨ï         ³        ¡ï§ â¥«ìáâ¢®, ¯® ª®â®à®¬ã         ³];
    [³áâà®ª¨³        ®à£ ­¨§ æ¨¨,        ³  ­ë© ­®¬¥à  ³áâà ­ë ³¡ « ­á®¢®-³    «¨æ¥¢®£® áç¥â     ³      ­       ³      ¬¥áïæ, âëá. àã¡.     ³     ­       ³ ¨á¯®«­¥­¨ï  ³  ­ ï   ³ á¤¥«ª¨ ³  ¯à¨­ïâ¨ï   ³¤ â  ¨ ­®¬¥à ³                                   ³         ®áãé¥áâ¢«¥­® ®¡à¥¬¥­¥­¨¥          ³];
    [³      ³ ¯à¨¢«¥ªè¥© (à §¬¥áâ¨¢è¥©)  ³ (ª®¤ ‘‚ˆ”’) ³ ¬¥áâ  ³£® áç¥â , ³                      ³­ ç «® ¬¥áïæ ,³                           ³ª®­¥æ ¬¥áïæ ,³®¡ï§ â¥«ìáâ¢ ³ áâ ¢ª  ³        ³ à¥è¥­¨ï ¨   ³ ¯à®«®­£¨à®- ³                                   ³                                           ³];
    [³      ³     ¤¥­¥¦­ë¥ áà¥¤áâ¢       ³             ³­ å®¦- ³­  ª®â®à®¬³                      ³  âëá. àã¡.   ³                           ³  âëá. àã¡.  ³             ³        ³        ³­®¬¥à á¤¥«ª¨ ³   ¢ ­­®©    ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ´];
    [³      ³                            ³             ³ ¤¥­¨ï ³ ®âà ¦¥­ë ³                      ³              ³                           ³             ³             ³        ³        ³  ¨§ ä®à¬ë   ³   á¤¥«ª¨    ³ ­ ¨¬¥­®¢ ­¨¥ «¨æ ,  ³¨¤¥­â¨ä¨ª â®à³      ¢¨¤       ³ áâ®¨¬®áâì,  ³    áà®ª    ³];
    [³      ³                            ³             ³ªà¥¤¨â-³¯à¨¢«¥ç¥­-³                      ³              ³                           ³             ³             ³        ³        ³    501€     ³             ³  ¢ ¯®«ì§ã ª®â®à®£®  ³    «¨æ      ³                ³  âëá. àã¡.  ³ ¯®£ è¥­¨ï  ³];
    [³      ³                            ³             ³  ­®©  ³­ë¥ (à §- ³                      ³              ³                           ³             ³             ³        ³        ³             ³             ³    ®áãé¥áâ¢«¥­®     ³             ³                ³             ³            ³];
    [³      ³                            ³             ³®à£ ­¨-³¬¥é¥­­ë¥) ³                      ³              ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ´             ³             ³        ³        ³             ³             ³     ®¡à¥¬¥­¥­¨¥     ³             ³                ³             ³            ³];
    [³      ³                            ³             ³ § æ¨¨ ³ áà¥¤áâ¢  ³                      ³              ³  „¥¡¥â®¢ë©  ³ Šà¥¤¨â®¢ë©  ³             ³             ³        ³        ³             ³             ³                     ³             ³                ³             ³            ³];
    [ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´];
    [³   1  ³             2              ³      3      ³   4   ³    5     ³          6           ³      7       ³      8      ³      9      ³     10      ³     11      ³   12   ³   -    ³      -      ³      -      ³          13         ³     14      ³       15       ³     16      ³     17     ³];
    [ÃÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´];
    end;

    private macro initialize()
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF501ArGlobal().getPart1Id(), this));
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF501ArGlobal().getPart2Id(), this));
    end;

    private macro constructorTF501ArReportView(protocolView : RcbPrintProtocolView)
        initRcbReportView("‘‚…„…ˆŸ  Œ…†€Š‚‘Šˆ• Š…„ˆ’€• ˆ „…‡ˆ’€•",
                        "0409501", arrCreate(RCB_PK_MONTH, RCB_PK_DAY), DATE_OUT_PERIOD_FORMAT, protocolView);
    end;

    constructorTF501ArReportView(protocolView);
end;

private class (TSignatureZone_4212) TSignatureZoneExcel()
    initTSignatureZone_4212();

    macro getFirstPersonName()
        return m_firstPersonName;
    end;

    macro getSecondPersonName()
        return m_secondPersonName;
    end;

    macro getExecutorName()
        return m_executorName;
    end;

    macro getExecutorPhoneNumber()
        return m_executorPhoneNumber;
    end;

    macro getReportIssueDate()
        return m_reportIssueDate;
    end;
end;

private class (TNamesZone_4212) TNamesZoneExcel(formName : String, formOkudCode : String, formPeriodicity, periodFormat : Integer)
    initTNamesZone_4212(formName, formOkudCode, formPeriodicity, periodFormat);
    macro getFormName()
        return m_formName;
    end;
end;

private class (CB_CReportTemplate)TF501ArExcelPrintableView(formName : String, formOkudCode : String, formPeriodicity, periodFormat : Integer, protocolView : RcbPrintProtocolView)
    private var   m_protocolView : RcbPrintProtocolView;
    private var   m_lendingAgencyCodeZone = null;
    private var   m_namesZone = null;
    private var   m_signatureZone = null;
    private var   m_report;
    private var m_start = true;

    private macro printLendingAgencyCodeZone()
        PrintFormatString(null,
                        "okatoCode",           m_lendingAgencyCodeZone.getOkato(),
                        "okpoCode",            m_lendingAgencyCodeZone.getOkpo(),
                        "regNumber",           m_lendingAgencyCodeZone.getRegistrationNumber()
                        );

    end;

    private macro printNamesZone()
        var periodicity = "";
        PrintFormatString(null,
                        "reportName",          m_namesZone.getFormName(),
                        "periodKind",          periodicity, //ternary(rcbApplication().currentReport.context.period.kind == RCB_PK_MONTH, "Œ¥áïç­ ï", ""),
                        "reportPeriod",        m_namesZone.getPeriodName(),
                        "organisationName",    m_namesZone.getLendingAgencyName(),
                        "organisationAddress", m_namesZone.getLendingAgencyPostalAdress(),//,
                        "okudCode",            m_namesZone.getOkudString(0)
                        );
    end;

    private macro printSignatureZone()
        PrintFormatString(null,
                        "boss",          m_signatureZone.getFirstPersonName(),
                        "book",          m_signatureZone.getSecondPersonName(),
                        "executor",      m_signatureZone.getExecutorName(),
                        "number",        m_signatureZone.getExecutorPhoneNumber(),
                        "executionDate", string(m_signatureZone.getReportIssueDate() : f : m)
                        );
    end;

    macro PrintMode():INTEGER
        return DL_OUTREPORT_EXCEL;
    end;

    private macro SaveTotalBook(name)
        var ShowAppl:BOOL = true;
        if(m_UseTemplate)
            m_ObjTemplateXLS.Close();
            if( m_IsWebService )
                ShowAppl = false;
            end;
            m_ObjTemplateXLS.SaveTotalBook( name, ShowAppl);
        end;
    end;

    private macro BeginReport( /* NumCopy:INTEGER */ )
        CreateTotalBook();
    end;

    private macro EndReport()
        var formIdPrefix = strupr(strsubst(RcbApplication().currentReport.form.id, " ", "_")) + "_";
        SetXLSXFormat();
        var date = {curDate};
        SaveTotalBook(formIdPrefix + strSubst(trim(String(date)) , ".", "") + ".xlsx");
        m_protocolView.printline(" ");
        m_protocolView.printline("‘ä®à¬¨à®¢ ­ ä ©« ®âç¥â  ..\\TxtFile\\" + formIdPrefix +
                                strSubst(trim(String(rcbApplication().currentReport().context.period.endDate + 1)) , ".", "") +
                                subStr(GetExlusiveFileName(), 15)+ ".xlsx");
    end;

    /**
    * ¥ç âì áâà®ª¨ â ¡«¨æë
    */
    private macro printPartTableLine(partPrefix, row, orgName, swift, countryCode,
                                    balance, account, inRest, debet, credit, outRest, date, rate,
                                    dealNumber, f501ADateNumber, prolongDeal,
                                    encumName, encumId, encumType, encumValue, encumTerm)
        PrintTableLine(partPrefix + "Row",         row,         null,
                        partPrefix + "OrgName",     orgName,     null,
                        partPrefix + "Swift",       swift,       null,
                        partPrefix + "CountryCode", countryCode, null,
                        partPrefix + "Balance",     balance,     null,
                        partPrefix + "Account",     account,     null,
                        partPrefix + "InRest",      inRest,      null,
                        partPrefix + "Debet",       debet,       null,
                        partPrefix + "Credit",      credit,      null,
                        partPrefix + "OutRest",     outRest,     null,
                        partPrefix + "Date",        date,        null,
                        partPrefix + "Rate",        rate,        null,
                        partPrefix + "DealNumber",  dealNumber,  null,
                        partPrefix + "501ADateNumber", f501ADateNumber, null,
                        partPrefix + "ProlongDeal", prolongDeal, null,
                        partPrefix + "EncumName",   encumName,   null,
                        partPrefix + "EncumId",     encumId,     null,
                        partPrefix + "EncumType",   encumType,   null,
                        partPrefix + "EncumValue",  encumValue,  null,
                        partPrefix + "EncumTerm",   encumTerm,   null);
    end;

    private macro printPart(partId, partNumber)

        SetActiveSheet("âç¥â");
        var partPrefix = "p" + partNumber;

        RegisterTable(partPrefix + "Table", null /*header*/,
                        partPrefix + "Row",
                        partPrefix + "OrgName",
                        partPrefix + "Swift",
                        partPrefix + "CountryCode",
                        partPrefix + "Balance",
                        partPrefix + "Account",
                        partPrefix + "InRest",
                        partPrefix + "Debet",
                        partPrefix + "Credit",
                        partPrefix + "OutRest",
                        partPrefix + "Date",
                        partPrefix + "Rate",
                        partPrefix + "DealNumber",
                        partPrefix + "F501ADateNumber",
                        partPrefix + "ProlongDeal",
                        partPrefix + "EncumName",
                        partPrefix + "EncumId",
                        partPrefix + "EncumType",
                        partPrefix + "EncumValue",
                        partPrefix + "EncumTerm");

        var value;
        var rowNumber;
        var stringRate;
        var i  = 0;
        var isEmpty = true;

        for (var attribute, m_report.getPart(partId).getAttributes(true))
            isEmpty = false;
            value = attribute.getValue();

            i = i + 1;

            if   (int(value.getRepoAccountSign()) == 1)
                rowNumber = string(i + "*");
            elif (int(value.getGdSign()) == 1)
                rowNumber = string(i + "**");
            elif (int(value.getThirdPartySign()) == 1)
                rowNumber = string(i + "***");
            else
                rowNumber = string(i);
            end;

            stringRate = ternary((int(value.getGdSign()) == 0),string((value.getPercentValue().current):0:2),"");

            printPartTableLine(partPrefix,
                                rowNumber,
                                value.getClientName(),
                                value.getRegNumber(),
                                value.getCountryCode(),
                                value.getBalance(),
                                value.getAccount(),
                                value.getInRest().currentAsString,
                                value.getDebetTurnover().currentAsString,
                                value.getCreditTurnover().currentAsString,
                                value.getOutRest().currentAsString,
                                value.getPerformanceDate(),
                                stringRate,
                                value.getDealNumber(),
                                "-",
                                value.getProlongDealDate() + " " + value.getProlongDealNumber,
                                ternary(partNumber == 1, value.getEncumbranceParty(), "X"),
                                ternary(partNumber == 1, value.getEncumbrancePartyId(), "X"),
                                ternary(partNumber == 1, value.getEncumbranceKind(), "X"),
                                ternary(partNumber == 1, ternary(value.getEncumbranceKind() != "", value.getEncumbranceRest().currentAsString, ""), "X     "),
                                ternary(partNumber == 1, value.getMaturityDate(), "X"));
        end;

        EndTable();

        if (isEmpty)
            m_protocolView.printLine(" §¤¥« " + partNumber + ". „ ­­ë¥ ®âáãâáâ¢ãîâ.");
        end;
    end;

    private macro create()
        printLendingAgencyCodeZone();
        printNamesZone();
        printPart(TF501ArGlobal().getPart1Id(), 1);
        printPart(TF501ArGlobal().getPart2Id(), 2);
        printSignatureZone();
        CopyAllSheetInTotalBook("âç¥â", false,"reportPage","A1","âç¥â", false);
    end;

    macro print()
        Run();
        /**
        * ‘¯¨á®ª ä ©«®¢ ¯¥ç â¨ (*.xls)
        */
        var reportFileNameList = GetFullReportFileNames();
        var i: Integer = 0;
        while (i < reportFileNameList.size)
            RepTxtFilesQueue().add(reportFileNameList[i]);
            i = i + 1;
        end;
    end;

    private macro initializeVariables(formName : String, formOkudCode : String, formPeriodicity, periodFormat : Integer)
        m_lendingAgencyCodeZone  = TLendingAgencyCodeZone();
        m_namesZone              = TNamesZoneExcel(formName, formOkudCode, formPeriodicity, periodFormat);
        m_signatureZone          = TSignatureZoneExcel();
        m_report                 = objectFactoryInstance.createReport();
    end;

    private macro constructorTF501ExcelPrintableView(formName : String, formOkudCode : String, formPeriodicity, periodFormat : Integer, protocolView : RcbPrintProtocolView)
        initCB_CReportTemplate( null, "f501ArTemplate.xlsx", null, rcbWebCommon_isWebSystem());
        initializeVariables(formName, formOkudCode, formPeriodicity, periodFormat);
        m_protocolView = protocolView;
        m_protocolView.setOnFlySwitching(true);
        m_protocolView.setProtocolOutput(false);
        m_protocolView.resetProtocolOutput();
        m_protocolView.printHead();

        // ¢®ááâ ­®¢¨¬ ®à¨£¨­ «ì­ãî äã­ªæ¨î
        ReplaceMacro("isStandalone");
    end;

    constructorTF501ExcelPrintableView(formName, formOkudCode, formPeriodicity, periodFormat, protocolView);
end;

class (RcbReportView) TF501ArExcelView(protocolView : RcbPrintProtocolView)
    private var m_excelPrintView;

    macro print()
        m_excelPrintView.print();
    end;

    private macro constructorTF501ArExcelView(protocolView : RcbPrintProtocolView)
        initRcbReportView("‘‚…„…ˆŸ  Œ…†€Š‚‘Šˆ• Š…„ˆ’€• ˆ „…‡ˆ’€•",
                        "0409501", RCB_PK_DAY, DATE_OUT_PERIOD_FORMAT, protocolView);
        m_excelPrintView = TF501ArExcelPrintableView("‘‚…„…ˆŸ  Œ…†€Š‚‘Šˆ• Š…„ˆ’€• ˆ „…‡ˆ’€•",
                                                    "0409501", RCB_PK_DAY, DATE_OUT_PERIOD_FORMAT, protocolView);
    end;

    constructorTF501ArExcelView(protocolView);
end;
