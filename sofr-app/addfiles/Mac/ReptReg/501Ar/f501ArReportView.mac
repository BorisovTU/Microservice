/*
$Name:          f501ArReportView.mac
$Module:        é‚Á•‚Î ñÅ
$Description:   îÆ‡¨† 501Ar. è•Á†‚≠Æ• Ø‡•§·‚†¢´•≠®• Æ‚Á•‚†.
*/

import param;
import rcbWebCommon;
import ExcelReportView;



class (RcbReportView) TF501ArReportView(protocolView : RcbPrintProtocolView)
    macro printData()
        m_view.printData(this);
    end;

    macro printHead()
    [   ê†ß§•´ 1];
    [⁄ƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
    [≥çÆ¨•‡ ≥   ç†®¨•≠Æ¢†≠®• ™‡•§®‚≠Æ©   ≥ê•£®·‚‡†Ê®Æ≠-≥  äÆ§  ≥  çÆ¨•‡   ≥   çÆ¨•‡ Æ‚§•´Ï≠Æ£Æ   ≥   é·‚†‚Æ™    ≥    é°Æ‡Æ‚Î ß† Æ‚Á•‚≠Î©    ≥   é·‚†‚Æ™   ≥    Ñ†‚†     ≥è‡ÆÊ•≠‚-≥ çÆ¨•‡  ≥    Ñ†‚†     ≥  é‚Á•‚≠†Ô   ≥       ç†´®Á®• Æ°‡•¨•≠•≠®Ô         ≥        é°Ôß†‚•´Ï·‚¢Æ, ØÆ ™Æ‚Æ‡Æ¨„         ≥];
    [≥·‚‡Æ™®≥        Æ‡£†≠®ß†Ê®®,        ≥  ≠Î© ≠Æ¨•‡  ≥·‚‡†≠Î ≥°†´†≠·Æ¢Æ-≥    ´®Ê•¢Æ£Æ ·Á•‚†    ≥      ≠†      ≥      ¨•·ÔÊ, ‚Î·. ‡„°.     ≥     ≠†      ≥ ®·ØÆ´≠•≠®Ô  ≥  ≠†Ô   ≥ ·§•´™® ≥  Ø‡®≠Ô‚®Ô   ≥§†‚† ® ≠Æ¨•‡ ≥                                   ≥         Æ·„È•·‚¢´•≠Æ Æ°‡•¨•≠•≠®•          ≥];
    [≥      ≥ Ø‡®¢´•™Ë•© (‡†ß¨•·‚®¢Ë•©)  ≥ (™Æ§ ëÇàîí) ≥ ¨•·‚† ≥£Æ ·Á•‚†, ≥                      ≥≠†Á†´Æ ¨•·ÔÊ†,≥                           ≥™Æ≠•Ê ¨•·ÔÊ†,≥Æ°Ôß†‚•´Ï·‚¢†≥ ·‚†¢™† ≥        ≥ ‡•Ë•≠®Ô ®   ≥ Ø‡Æ´Æ≠£®‡Æ- ≥                                   ≥                                           ≥];
    [≥      ≥     §•≠•¶≠Î• ·‡•§·‚¢†      ≥             ≥≠†ÂÆ¶- ≥≠† ™Æ‚Æ‡Æ¨≥                      ≥  ‚Î·. ‡„°.   ≥                           ≥  ‚Î·. ‡„°.  ≥             ≥        ≥        ≥≠Æ¨•‡ ·§•´™® ≥   ¢†≠≠Æ©    √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
    [≥      ≥                            ≥             ≥ §•≠®Ô ≥ Æ‚‡†¶•≠Î ≥                      ≥              ≥                           ≥             ≥             ≥        ≥        ≥  ®ß ‰Æ‡¨Î   ≥   ·§•´™®    ≥ ≠†®¨•≠Æ¢†≠®• ´®Ê†,  ≥®§•≠‚®‰®™†‚Æ‡≥      ¢®§       ≥ ·‚Æ®¨Æ·‚Ï,  ≥    ·‡Æ™    ≥];
    [≥      ≥                            ≥             ≥™‡•§®‚-≥Ø‡®¢´•Á•≠-≥                      ≥              ≥                           ≥             ≥             ≥        ≥        ≥    501Ä     ≥             ≥  ¢ ØÆ´Ïß„ ™Æ‚Æ‡Æ£Æ  ≥    ´®Ê†     ≥                ≥  ‚Î·. ‡„°.  ≥ ØÆ£†Ë•≠®Ô  ≥];
    [≥      ≥                            ≥             ≥  ≠Æ©  ≥≠Î• (‡†ß- ≥                      ≥              ≥                           ≥             ≥             ≥        ≥        ≥             ≥             ≥    Æ·„È•·‚¢´•≠Æ     ≥             ≥                ≥             ≥            ≥];
    [≥      ≥                            ≥             ≥Æ‡£†≠®-≥¨•È•≠≠Î•) ≥                      ≥              √ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥             ≥             ≥        ≥        ≥             ≥             ≥     Æ°‡•¨•≠•≠®•     ≥             ≥                ≥             ≥            ≥];
    [≥      ≥                            ≥             ≥ ß†Ê®® ≥ ·‡•§·‚¢† ≥                      ≥              ≥  Ñ•°•‚Æ¢Î©  ≥ ä‡•§®‚Æ¢Î©  ≥             ≥             ≥        ≥        ≥             ≥             ≥                     ≥             ≥                ≥             ≥            ≥];
    [√ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
    [≥   1  ≥             2              ≥      3      ≥   4   ≥    5     ≥          6           ≥      7       ≥      8      ≥      9      ≥     10      ≥     11      ≥   12   ≥   -    ≥      -      ≥      -      ≥          13         ≥     14      ≥       15       ≥     16      ≥     17     ≥];
    [√ƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
    end;

    private macro initialize()
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF501ArGlobal().getPart1Id(), this));
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF501ArGlobal().getPart2Id(), this));
    end;

    private macro constructorTF501ArReportView(protocolView : RcbPrintProtocolView)
        initRcbReportView("ëÇÖÑÖçàü é åÖÜÅÄçäéÇëäàï äêÖÑàíÄï à ÑÖèéáàíÄï",
                        "0409501", arrCreate(RCB_PK_MONTH, RCB_PK_DAY), DATE_OUT_PERIOD_FORMAT, protocolView);
    end;

    constructorTF501ArReportView(protocolView);
end;

private class (TSignatureZone_4212) TSignatureZoneExcel()
    initTSignatureZone_4212();

    macro getFirstPersonName()
        return m_firstPersonName;
    end;

    macro getSecondPersonName()
        return m_secondPersonName;
    end;

    macro getExecutorName()
        return m_executorName;
    end;

    macro getExecutorPhoneNumber()
        return m_executorPhoneNumber;
    end;

    macro getReportIssueDate()
        return m_reportIssueDate;
    end;
end;

private class (TNamesZone_4212) TNamesZoneExcel(formName : String, formOkudCode : String, formPeriodicity, periodFormat : Integer)
    initTNamesZone_4212(formName, formOkudCode, formPeriodicity, periodFormat);
    macro getFormName()
        return m_formName;
    end;
end;

class (TBaseNamesZoneExcelView) TF501NamesZoneExcelView(templateName, reportView, namesZone)
    private var m_namesZone;

    /**
     * å•‚Æ§ ß†ØÆ´≠•≠®Ô ØÆ´•© Ë†°´Æ≠†
     */
    macro fillTemplateFields()
        var periodicity = "";
        printTemplateField(m_formNameTarget,    m_namesZone.getFormName());
        printTemplateField(m_formPeriodTarget,  m_namesZone.getPeriodName());
        printTemplateField(m_bankNameTarget,    m_namesZone.getLendingAgencyName());
        printTemplateField(m_bankAddressTarget, m_namesZone.getLendingAgencyPostalAdress());
        printTemplateField(m_okudCodeTarget,    "äÆ§ ‰Æ‡¨Î ØÆ éäìÑ 0409501",      AC_FORM_OKUD_CODE);
        printTemplateField(m_periodicityTarget, periodicity,                      AC_FORM_PERIODICITY);
    end;

    private macro constructorTF501NamesZoneExcelView(templateName, reportView, namesZone)
        initTBaseNamesZoneExcelView(templateName, reportView);

        m_namesZone = namesZone;
    end;

    constructorTF501NamesZoneExcelView(templateName, reportView, namesZone);
end;

class (TBaseSignatureZoneExcelView) TF501SignatureZoneExcelView(templateName, reportView, signatureZone)
    private var m_signatureZone;

    /**
     * å•‚Æ§ ß†ØÆ´≠•≠®Ô ØÆ´•© Ë†°´Æ≠†
     */
    macro fillTemplateFields()
        printTemplateField(m_firstPersonNameTarget,         m_signatureZone.getFirstPersonName(),         AC_FIRST_PERSON);
        printTemplateField(m_secondPersonNameTarget,        m_signatureZone.getSecondPersonName(),        AC_SECOND_PERSON);
        printTemplateField(m_executorNameTarget,            m_signatureZone.getExecutorName(),            AC_EXECUTOR);
        printTemplateField(m_phoneNumberTarget,             m_signatureZone.getExecutorPhoneNumber(),     AC_EXECUTOR_PHONE_NUMBER);
        printTemplateField(m_reportDateTarget,              m_signatureZone.getReportIssueDate());
    end;

    private macro constructorTF501SignatureZoneExcelView(templateName, reportView, signatureZone)
        initTBaseSignatureZoneExcelView(templateName, reportView);

        m_signatureZone = signatureZone;
    end;

    constructorTF501SignatureZoneExcelView(templateName, reportView, signatureZone);
end;

class (RcbPartExcelView) TF501ArPartExcelView(partName, sheetName, sheetNumber, templateName, reportView, templatePartZoneHeader, headerHeight, templatePartZone)
    macro makeRowCSV(dataset)
        addCellToCurRow(cell(getStringExcelFormat(dataset[0] )));
        addCellToCurRow(cell(getStringExcelFormat(dataset[1] )));
        addCellToCurRow(cell(getStringExcelFormat(dataset[2] )));
        addCellToCurRow(cell(getStringExcelFormat(dataset[3] )));
        addCellToCurRow(cell(getStringExcelFormat(dataset[4] )));
        addCellToCurRow(cell(getStringExcelFormat(dataset[5] )));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[6] ,0)));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[7] ,0)));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[8] ,0)));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[9] ,0)));
        addCellToCurRow(cell(getStringExcelFormat(dataset[10])));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[11],0)));
        addCellToCurRow(cell(getStringExcelFormat(dataset[12])));
        addCellToCurRow(cell(getStringExcelFormat(dataset[13])));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[14],0)));
        addCellToCurRow(cell(getStringExcelFormat(dataset[15])));
        addCellToCurRow(cell(getStringExcelFormat(dataset[16])));
        addCellToCurRow(cell(getStringExcelFormat(dataset[17])));
        addCellToCurRow(cell(getDoubleExcelFormat(dataset[18],0)));
        addCellToCurRow(cell(getStringExcelFormat(dataset[19])));
    end;

    macro printHead()
        //Ñ´Ô ·Æ¢¨•·‚®¨Æ·‚®
    end;

    macro printBottom()
        //Ñ´Ô ·Æ¢¨•·‚®¨Æ·‚®
    end;

    macro printString(dataSet)
        printRow(dataSet);
    end;

    macro savePart()
        saveCsvTable();
        saveTemplate();
    end;

    private macro constructor501ArPartExcelView(partName, sheetName, sheetNumber, templateName, reportView, templatePartZoneHeader, headerHeight, templatePartZone)
        initRcbPartExcelView(partName, sheetName, sheetNumber, templateName, reportView, null, templatePartZoneHeader, headerHeight);
        m_templateTable = templatePartZone + "String";
        m_templateTableHeader = templatePartZoneHeader + "Header";
    end;

    constructor501ArPartExcelView(partName, sheetName, sheetNumber, templateName, reportView, templatePartZoneHeader, headerHeight, templatePartZone);
end;

class (RcbReportExcelView) TF501ArExcelReportView(protocolView : RcbPrintProtocolView)
    macro printDate_YYYYMMDD(_date : string) : string
        return SubStr(_date, 7) + SubStr(_date, 4, 2) + SubStr(_date, 1, 2);
    end;

    macro initializeLendingAgencyCodeZoneExcelView()
        m_lendingAgencyCodeZoneExcelView = TBaseLendingAgencyCodeZoneExcelView("f501ArTemplate.xlsx", this);
    end;

    macro initializeBaseNamesZoneExcelView()
        m_namesZoneExcelView             = TF501NamesZoneExcelView            ("f501ArTemplate.xlsx", this, TNamesZoneExcel("ëÇÖÑÖçàü é åÖÜÅÄçäéÇëäàï äêÖÑàíÄï à ÑÖèéáàíÄï", "0409501", RCB_PK_DAY, DATE_OUT_PERIOD_FORMAT));
    end;

    macro initializeBaseSignatureZoneExcelView()
        m_signatureZoneExcelView         = TF501SignatureZoneExcelView        ("f501ArTemplate.xlsx", this, TSignatureZoneExcel());
    end;

    macro initializePartViews()
        m_partViewPool = RcbArray();
        m_partViewPool[m_partViewPool.size] = TF501ArPartExcelView(TF501ArGlobal().getPart1Id(), "é‚Á•‚", "é‚Á•‚", "f501ArTemplate.xlsx", this, TF501ArGlobal().getPart1Id() + "TableHeader", 10, TF501ArGlobal().getPart1Id() + "Table");
        m_partViewPool[m_partViewPool.size] = TF501ArPartExcelView(TF501ArGlobal().getPart2Id(), "é‚Á•‚", "é‚Á•‚", "f501ArTemplate.xlsx", this, TF501ArGlobal().getPart2Id() + "TableHeader", 1, TF501ArGlobal().getPart2Id() + "Table");
    end;

//DEF-79259
    macro getFileName()
      var dotIndex=0;
      var _fileName = getTxtFileName(strSubst("f501ArTemplate.xlsx", ".xlsx", ""));
        _fileName =  GetUniqAdd(_fileName);
        dotIndex = strlen(_fileName);
        while ((dotIndex > 0) and (substr(_fileName, dotIndex, 1) != "."))
            dotIndex = dotIndex - 1;
        end;
        if (dotIndex > 0)
            _fileName = substr(_fileName, 1, dotIndex - 1) + "_" + substr(_fileName, dotIndex + 1);
        end;
        return _fileName;
    end;

    private MACRO CorrectNumberStr( CellValue:VARIANT ):VARIANT
      VAR CellType;

      if( (CellValue != null) )
        if( ValType( CellValue ) == V_STRING )
          var pp = index(CellValue, ".");
          if( pp > 0 )
            StrSet( CellValue, pp, "," );
          end;
        end;
      end;

      return CellValue;
    END;

    macro print()
        printLendingAgencyCodeZone("é‚Á•‚");
        printNamesZone("é‚Á•‚");
        var partNumber = 1;
        var curReport = objectFactoryInstance.createReport();
        for (var currentView, m_partViewPool)
            var value;
            var rowNumber;
            var stringRate;
            var i       = 0;
            var isEmpty = true;
            currentView.printHeadPart();

            for (var attribute, curReport.getPart(currentView.getPartId()).getAttributes(true))
                isEmpty = false;
                value = attribute.getValue();

                i = i + 1;

                if   (int(value.getRepoAccountSign()) == 1)
                    rowNumber = string(i + "*");
                elif (int(value.getGdSign()) == 1)
                    rowNumber = string(i + "**");
                elif (int(value.getThirdPartySign()) == 1)
                    rowNumber = string(i + "***");
                else
                    rowNumber = string(i);
                end;

                stringRate = ternary((int(value.getGdSign()) == 0),CorrectNumberStr(string((value.getPercentValue().current):0:2)),"");

                var dataArray = RcbArray();
                dataArray[dataArray.size] = rowNumber;
                dataArray[dataArray.size] = value.getClientName();
                dataArray[dataArray.size] = value.getRegNumber();
                dataArray[dataArray.size] = value.getCountryCode();
                dataArray[dataArray.size] = value.getBalance();
                dataArray[dataArray.size] = value.getAccount();
                dataArray[dataArray.size] = value.getInRest().currentAsString;
                dataArray[dataArray.size] = value.getDebetTurnover().currentAsString;
                dataArray[dataArray.size] = value.getCreditTurnover().currentAsString;
                dataArray[dataArray.size] = value.getOutRest().currentAsString;
                dataArray[dataArray.size] = printDate_YYYYMMDD( value.getPerformanceDate() );
                dataArray[dataArray.size] = stringRate;
                dataArray[dataArray.size] = value.getDealNumber();
                dataArray[dataArray.size] = "-";
                dataArray[dataArray.size] = value.getProlongDealDate() + " " + value.getProlongDealNumber;
                dataArray[dataArray.size] = ternary(partNumber == 1, value.getEncumbranceParty(), "X");
                dataArray[dataArray.size] = ternary(partNumber == 1, value.getEncumbrancePartyId(), "X");
                dataArray[dataArray.size] = ternary(partNumber == 1, value.getEncumbranceKind(), "X");
                dataArray[dataArray.size] = ternary(partNumber == 1, ternary(value.getEncumbranceKind() != "", value.getEncumbranceRest().currentAsString, ""), "X     ");
                dataArray[dataArray.size] = ternary(partNumber == 1, value.getMaturityDate(), "X");

                currentView.printString(dataArray);
            end;

            currentView.savePart();

            if (isEmpty)
                m_protocolView.printLine("ê†ß§•´ " + partNumber + ". Ñ†≠≠Î• Æ‚·„‚·‚¢„Ó‚.");
            end;

            partNumber = partNumber + 1;
        end;
        printSignatureZone("é‚Á•‚");
        show();
    end;

    private macro constructorTF501ArExcelReportView(protocolView : RcbPrintProtocolView)
        initRcbReportExcelView("ëÇÖÑÖçàü é åÖÜÅÄçäéÇëäàï äêÖÑàíÄï à ÑÖèéáàíÄï",
                               "0409501",
                               RCB_PK_DAY,
                               DATE_OUT_PERIOD_FORMAT,
                               protocolView,
                               true,
                               true,
                               true);
    end;

    constructorTF501ArExcelReportView(protocolView);
end;
