/*
$Name:          OfrParameters.mac
$Module:        é‚Á•‚Î ñÅ
$Description:   éîê. è†‡†¨•‚‡Î Æ‚Á•‚≠Æ© ‰Æ‡¨Î.
*/

private class TOfrParametersReportData(_key, _value)
    var key = _key;
    var value = _value;
end;

/**
 * éîê. ä´†·· Ø†‡†¨•‚‡Æ¢ Æ‚Á•‚≠Æ© ‰Æ‡¨Î.
 *
 * @since 17.11.2015
 * @author ABP
 * @version 6.20.031.032
 */
private var m_parameters = null;
class TOfrParametersImpl()
    private const REGISTRY_PATH = "REPTREG/REP_GROUPS/îÆ‡¨† 102";
    private const ATTRIBUTE_NAME = "ç†·‚‡Æ©™®";

    private var m_parametersReader : Object;

    private var m_parametersReportData : RcbArray;

    private var m_zeroValuePrintingMode : Integer;
    private var m_isRestsCalculating : Bool;
    private var m_isSpodPrintingInSpecialLine : Bool;
    private var m_isRollupSymbol : Bool;
    private var m_symbolsMask : String;

    private macro getVariableValue(path : String, type : INTEGER, value : Variant)
        var splittedPath = strCut(path, "/\\");
        var result = V_UNDEF;

        var compositeValue = TOfrGlobal().getRcbReport().attributeValue(ATTRIBUTE_NAME);

        var isFound = false;
        var splittedPathSize = splittedPath.size;
        var i = 0;
        while (i < splittedPathSize)
            var key = compositeValue.createKeyValue();
            key.fieldValue("name") = splittedPath.value(i);
            var temp = compositeValue.findValue(key);
            if (temp != null)
                compositeValue = temp;
                if (i == splittedPathSize-1)
                    isFound = true;
                end;
            end;

            i = i + 1;
        end;

        if (    isFound
            and (compositeValue != null)
            and (compositeValue.fieldValue("type").isDefined())
            and (compositeValue.fieldValue("value").isDefined())
           )
            value = m_parametersReader.fromString(compositeValue.fieldValue("value").exact, type);
            if (m_parametersReader.isTypesMatch(type, strupr(trim(compositeValue.fieldValue("type").exact))))
                result = type;
            end;

            setParm(3, value);
        end;

        return result;
    end;

    private macro getValue(path : String, type : INTEGER, value : Variant, defaultValue : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        else
            if (getVariableValue(path, type, value) == V_UNDEF)
                value = defaultValue;
                note = " (ØÆ „¨Æ´Á†≠®Ó)";
            end;
        end;
        setParm(3, value);

        if (((type == V_STRING) and (value == "")) or (value == null))
            value = "á≠†Á•≠®• ≠• ß†§†≠Æ";
        end;
        m_parametersReportData.push_back(TOfrParametersReportData(path, String(value) + note));
    end;

    // ó‚•≠®• ®ß ‡••·‚‡† ≠†·‚‡Æ©™®, ™Æ‚Æ‡†Ô ≠• ·ÆÂ‡†≠Ô•‚·Ô ¢ Ø•‡•¨•≠≠Æ©
    private macro _getRegistryValue(path : String, type : INTEGER, value : Variant, defaultValue : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        else
            if (getRegistryValue(path, type, value) == V_UNDEF)
                value = defaultValue;
                note = " (ØÆ „¨Æ´Á†≠®Ó)";
            end;
        end;
        setParm(3, value);

        if (((type == V_STRING) and (value == "")) or (value == null))
            value = "á≠†Á•≠®• ≠• ß†§†≠Æ";
        end;
        m_parametersReportData.push_back(TOfrParametersReportData(path, String(value) + note));
    end;

    private macro initializeParameterValue(caption : String, parameter : Variant, value : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        end;
        setParm(2, value);

        m_parametersReportData.push_back(TOfrParametersReportData(caption, String(value) + note));
    end;

    private macro getReportString(key, caption)
        m_parametersReportData.moveFirst();
        while (m_parametersReportData.moveNext())
            var reportData = m_parametersReportData.getCurrentItem();
            if (reportData.key == key)
                if (caption == null)
                    return reportData.key + " = " + reportData.value;
                else
                    return caption + " = " + reportData.value;
                end;
            end;
        end;
        return null;
    end;

    private macro printLine(protocol, value, caption)
        if (value != null)
            protocol.printServiceLine(ternary(caption == null, value, caption + " = " + value));
        end;
    end;

    private macro makeTabbedString(value, nTabs)
        nTabs = nvl(nTabs, 1);
        if (value != null)
            value = mkstr("\t", nTabs) + value;
        end;

        return value;
    end;

    macro getZeroValuePrintingMode() : Integer
        return m_zeroValuePrintingMode;
    end;

    macro isRestsCalculating() : Bool
        return m_isRestsCalculating;
    end;

    macro isSpodPrintingInSpecialLine() : Bool
        return m_isSpodPrintingInSpecialLine;
    end;

    macro isRollupSymbol() : Bool
        return m_isRollupSymbol;
    end;

    macro getSymbolsMask() : String
        return m_symbolsMask;
    end;

    macro printCalculationReport(protocol)
        printLine(protocol, "á≠†Á•≠®Ô ≠†·‚‡Æ•™ ‡••·‚‡†:");
        printLine(protocol, makeTabbedString(getReportString(REGISTRY_PATH + "/êÄëóÖí èé éëíÄíäÄå")));
        printLine(protocol, makeTabbedString(getReportString(REGISTRY_PATH + "/ëÇéêÄóàÇÄíú ëàåÇéã èé ãàñ.ëóÖíì")));
        printLine(protocol, "");
    end;

    macro printPrintingReport(protocol)
        printLine(protocol, "á≠†Á•≠®Ô ≠†·‚‡Æ•™ ‡••·‚‡†:");
        printLine(protocol, makeTabbedString(getReportString(REGISTRY_PATH + "/èÖóÄíú çìãÖâ")));
        printLine(protocol, makeTabbedString(getReportString(REGISTRY_PATH + "/èÖóÄíú ëèéÑ éíÑÖãúçéâ ëíêéäéâ")));
        printLine(protocol, "");
    end;

    macro printExportationReport(protocol)
    end;

    macro printNormalizationReport(protocol)
    end;

    macro read()
//        // ó‚•≠®• ¢•‚™® "REPTREG/REP_GROUPS/îÆ‡¨† 102/"
//        m_parametersReader.read(false);

        // ó‚•≠®• Æ‚§•´Ï≠ÎÂ ≠†·‚‡Æ•™
        m_parametersReader.readRegistryValue("REPTREG/REP_GROUPS/îÆ‡¨† 102/èÖóÄíú çìãÖâ", V_INTEGER, null, null, false);
        m_parametersReader.readRegistryValue("REPTREG/REP_GROUPS/îÆ‡¨† 102/êÄëóÖí èé éëíÄíäÄå", V_BOOL, null, null, false);
        m_parametersReader.readRegistryValue("REPTREG/REP_GROUPS/îÆ‡¨† 102/èÖóÄíú ëèéÑ éíÑÖãúçéâ ëíêéäéâ", V_BOOL, null, null, false);
        m_parametersReader.readRegistryValue("REPTREG/REP_GROUPS/îÆ‡¨† 102/ëÇéêÄóàÇÄíú ëàåÇéã èé ãàñ.ëóÖíì", V_BOOL, null, null, false);

        m_parametersReportData.clear();

        getValue(REGISTRY_PATH + "/èÖóÄíú çìãÖâ", V_INTEGER, m_zeroValuePrintingMode, 0);
        getValue(REGISTRY_PATH + "/êÄëóÖí èé éëíÄíäÄå", V_BOOL, m_isRestsCalculating, true);
        getValue(REGISTRY_PATH + "/èÖóÄíú ëèéÑ éíÑÖãúçéâ ëíêéäéâ", V_BOOL, m_isSpodPrintingInSpecialLine, false);
        getValue(REGISTRY_PATH + "/ëÇéêÄóàÇÄíú ëàåÇéã èé ãàñ.ëóÖíì", V_BOOL, m_isRollupSymbol, true);

        getValue("ëàåÇéãõ Ñãü êÄëóÖíÄ", V_STRING, m_symbolsMask, "");
    end;

    private macro constructorTOfrParametersImpl()
        m_parametersReportData = RcbArray();
        m_parametersReader = objectFactoryInstance.createParametersReader(REGISTRY_PATH, ATTRIBUTE_NAME);

        read();
    end;

    constructorTOfrParametersImpl();
end;

macro TOfrParameters() : TOfrParametersImpl
    if (m_parameters == null)
        m_parameters = TOfrParametersImpl();
    end;

    return m_parameters;
end;
