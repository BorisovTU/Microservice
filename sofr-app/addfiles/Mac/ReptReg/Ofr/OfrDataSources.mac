/*
$Name:          OfrDataSources.mac
$Module:        Отчеты ЦБ
$Description:   ОФР. Источники данных.
*/

const PAIRED_ACC_MASK_FOR_SPOD  = "715*";
const DECREASE_MASK_FOR_SPOD = "719*";
const INCREASE_MASK_FOR_SPOD = "729*";

/**
 * ОФР. Источник символов, устанавливаемых на лицевые счета
 * Первичными данными является информация из НТ для частей 1-5, НТ для части 7
 *
 * @since 26.11.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TPrimarySymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_isExistsSymbolsMask : Bool;
    private var m_symbolsMask : String;

    private macro parseDataset(query : String, data : RcbArray, currencyFieldName : String, isSpod : Bool)
        var dataset = TRsbDataset(query);

        while (dataset.moveNext())
            var i;
            var symbols = strCut(dataset.ofrSymbolMasks, ",");
            var ranges = RcbArray();
            var isCurrency = false;
            var accountMask = dataset.accountMasks;

            if (TOfrGlobal().isOfrWithSpodReport())
                var accountMaskForSpod;

                if (isSpod)
                    accountMaskForSpod = dataset.accountMasksForSpod;
                else
                    accountMaskForSpod = "";
                end;
            end;

            if (currencyFieldName != null)
                isCurrency = dataset.value(currencyFieldName) == "X";
            end;

            // сформировать пул диапазонов, встретившихся в маске
            // сохранить в результирующем множестве символы, заданные в маске явно
            for (i, symbols)
                if (index(i, "-") != 0)
                    ranges.push_back(i);
                else
                    if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, i) == 0))
                        if (TOfrGlobal().isOfrWithSpodReport())
                            data.push_back(RcbArray().initialize(i, isCurrency, accountMask, accountMaskForSpod));
                        else
                            data.push_back(RcbArray().initialize(i, isCurrency, accountMask));
                        end;
                    end;
                end;
            end;

            // для каждого диапазона получить все попадающие в него пятизначные символы
            // и сохранить их в результирующем множестве
            for (i, ranges)
                symbols = strCut(i, "-");
                var rangeBegin = int(symbols[0]);
                var rangeEnd = int(symbols[1]);
                var j = int(symbols[0]);
                while (j <= int(symbols[1]))
                    if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, string(j)) == 0))
                        if (TOfrGlobal().isOfrWithSpodReport())
                            data.push_back(RcbArray().initialize(string(j), isCurrency, accountMask, accountMaskForSpod));
                        else
                            data.push_back(RcbArray().initialize(string(j), isCurrency, accountMask));
                        end;
                    end;
                    j = j + 1;
                end;
            end;
        end;
    end;

    /**
     * Получить символы ОФР в виде RcbArray из объектов RcbArray
     * первый элемент - номер символа,
     * второй - признак валютного символа
     * третий - маска л/с
     */
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var data = RcbArray();

        var query;

        // 14.12.2015 ABP Можно было бы (и это правильнее с идейной точки зрения) выполнить сортировку созданного массива данных.
        //                Но на уровне sql сортировка выполнится намного эффективней.
        query =        m_dataSources.getTuneTable1_5().getQuery()
              + "\n" + "ORDER BY tune.t_part, tune.t_section, tune.t_group, tune.t_isCurrencySymbol";
        parseDataset(query, data, "t_isCurrencySymbol", TOfrGlobal().isOfrWithSpodReport());

        query =        m_dataSources.getTuneTable7().getQuery()
              + "\n" + "ORDER BY tune.t_section, tune.t_group";
        parseDataset(query, data, null, false);

        return data;
    end;

    private macro constructorTPrimarySymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_symbolsMask = TOfrParameters().getSymbolsMask();
        m_isExistsSymbolsMask = m_symbolsMask != "";
    end;

    constructorTPrimarySymbolsList(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник специальных символов, рассчитываемых по значениям других символов (в том числе итоги по группам, разделам, частям, статьям)
 * Первичными данными является информация из НТ для частей 1-5
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSpecialSymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_isExistsSymbolsMask : Bool;
    private var m_symbolsMask : String;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var data = RcbArray();

        var dataset : Object;

        // Группы символов
        dataset = TRsbDataset("WITH groups AS"
                      +"\n"+ "("
                      +"\n"+ " SELECT tuneTable.t_part || tuneTable.t_section || tuneTable.t_group t_symbol,"
                      +"\n"+ "        tuneTable.t_isCurrencySymbol                                 t_isCurrencySymbol"
                      +"\n"+ "   FROM (" + m_dataSources.getTuneTable1_5().getQuery() + ") tuneTable"
                      +"\n"+ "  GROUP BY tuneTable.t_part, tuneTable.t_section, tuneTable.t_group, tuneTable.t_isCurrencySymbol"
                      +"\n"+ "  UNION ALL"
                      +"\n"+ " SELECT '7' || tuneTable.t_section || tuneTable.t_group t_symbol,"
                      +"\n"+ "    " + getSqlChar("") + "                              t_isCurrencySymbol"
                      +"\n"+ "   FROM (" + m_dataSources.getTuneTable7().getQuery() + ") tuneTable"
                      +"\n"+ "  GROUP BY tuneTable.t_section, tuneTable.t_group"
                      +"\n"+ "  UNION ALL"
                      +"\n"+ " SELECT SUBSTR(tuneTable.t_pairOfrSymbolMasks, 1, 3) t_symbol,"
                      +"\n"+ "    " + getSqlChar("") + "                           t_isCurrencySymbol"
                      +"\n"+ "   FROM (" + m_dataSources.getTuneTable7().getQuery() + ") tuneTable"
                      +"\n"+ "  WHERE tuneTable.t_pairOfrSymbolMasks != " + getSqlString("")
                      +"\n"+ "  GROUP BY SUBSTR(tuneTable.t_pairOfrSymbolMasks, 1, 3)"
                      +"\n"+ ")"
                      +"\n"+ "SELECT data.*"
                      +"\n"+ "  FROM groups data"
                      +"\n"+ " WHERE (   (SELECT COUNT(t_symbol) g1"
                      +"\n"+ "              FROM groups g1"
                      +"\n"+ "             WHERE g1.t_symbol = data.t_symbol"
                      +"\n"+ "           ) = 1"
                      +"\n"+ "        OR (    (SELECT COUNT(t_symbol) g1"
                      +"\n"+ "                   FROM groups g1"
                      +"\n"+ "                  WHERE g1.t_symbol = data.t_symbol"
                      +"\n"+ "                ) = 2"
                      +"\n"+ "            AND data.t_isCurrencySymbol = " + getSqlChar("X")
                      +"\n"+ "           )"
                      +"\n"+ "       )"
                      +"\n"+ "   AND NOT data.t_symbol = ANY('511', '512')"
                            );

        while (dataset.moveNext())
            if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, dataset.symbol) == 0))
                data.push_back(RcbArray().initialize(dataset.symbol, dataset.isCurrencySymbol == "X"));
            end;
        end;

        // Разделы
        dataset = TRsbDataset("WITH groups AS"
                      +"\n"+ "("
                      +"\n"+ " SELECT tuneTable.t_part || tuneTable.t_section t_symbol,"
                      +"\n"+ "        tuneTable.t_isCurrencySymbol            t_isCurrencySymbol"
                      +"\n"+ "   FROM (" + m_dataSources.getTuneTable1_5().getQuery() + ") tuneTable"
                      +"\n"+ "  GROUP BY tuneTable.t_part, tuneTable.t_section, tuneTable.t_isCurrencySymbol"
                      +"\n"+ ")"
                      +"\n"+ "SELECT data.*"
                      +"\n"+ "  FROM groups data"
                      +"\n"+ " WHERE (   (SELECT COUNT(t_symbol) g1"
                      +"\n"+ "              FROM groups g1"
                      +"\n"+ "             WHERE g1.t_symbol = data.t_symbol"
                      +"\n"+ "           ) = 1"
                      +"\n"+ "        OR (    (SELECT COUNT(t_symbol) g1"
                      +"\n"+ "                   FROM groups g1"
                      +"\n"+ "                  WHERE g1.t_symbol = data.t_symbol"
                      +"\n"+ "                ) = 2"
                      +"\n"+ "            AND data.t_isCurrencySymbol = " + getSqlChar("X")
                      +"\n"+ "           )"
                      +"\n"+ "       )"
                      +"\n"+ "   AND data.t_symbol != '51'"
                            );

        while (dataset.moveNext())
            if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, dataset.symbol) == 0))
                data.push_back(RcbArray().initialize(dataset.symbol, dataset.isCurrencySymbol == "X"));
            end;
        end;

        // Части
        dataset = TRsbDataset("SELECT TO_CHAR(tuneTable.t_part) t_symbol"
                      +"\n"+ "  FROM (" + m_dataSources.getTuneTable1_5().getQuery() + ") tuneTable"
                      +"\n"+ " WHERE tuneTable.t_part != 5"
                      +"\n"+ " GROUP BY tuneTable.t_part"
                            );

        while (dataset.moveNext())
            if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, dataset.symbol) == 0))
                data.push_back(RcbArray().initialize(dataset.symbol, true));
            end;
        end;

        // Спец. значения для доходов и расходов, специальные символы
        var symbols = RcbArray().initialize(RcbArray().initialize("1_2", true),
                                            RcbArray().initialize("3_4", true),
                                            RcbArray().initialize("01000", false),
                                            RcbArray().initialize("02000", false),
                                            RcbArray().initialize("03000", false),
                                            RcbArray().initialize("04000", false),
                                            RcbArray().initialize("61101", false),
                                            RcbArray().initialize("61102", false),
                                            RcbArray().initialize("40000", false),
                                            RcbArray().initialize("50000", false),
                                            RcbArray().initialize("81101", false),
                                            RcbArray().initialize("81102", false),
                                            RcbArray().initialize("81201", false),
                                            RcbArray().initialize("81202", false)
                                           );
        for (var symbol, symbols)
            if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, symbol[0]) == 0))
                data.push_back(symbol);
            end;
        end;

        return data;
    end;

    private macro constructorTSpecialSymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_symbolsMask = TOfrParameters().getSymbolsMask();
        m_isExistsSymbolsMask = m_symbolsMask != "";
    end;

    constructorTSpecialSymbolsList(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник символов, которые рассчитываются при своде специфичным образом
 *
 * @since 11.04.2016
 * @author ABP
 * @version 6.20.031.034
 */
private class (RcbDataSource) TRecalculatedSymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_isExistsSymbolsMask : Bool;
    private var m_symbolsMask : String;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var data = RcbArray();

        var symbols = RcbArray().initialize(RcbArray().initialize("01000", false),
                                            RcbArray().initialize("02000", false),
                                            RcbArray().initialize("03000", false),
                                            RcbArray().initialize("04000", false),
                                            RcbArray().initialize("61101", false),
                                            RcbArray().initialize("61102", false),
                                            RcbArray().initialize("81101", false),
                                            RcbArray().initialize("81102", false),
                                            RcbArray().initialize("81201", false),
                                            RcbArray().initialize("81202", false)
                                           );
        for (var symbol, symbols)
            if (not m_isExistsSymbolsMask or (compareStrWithMasks(m_symbolsMask, symbol[0]) == 0))
                data.push_back(symbol);
            end;
        end;

        return data;
    end;

    private macro constructorTRecalculatedSymbolsList(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_symbolsMask = TOfrParameters().getSymbolsMask();
        m_isExistsSymbolsMask = m_symbolsMask != "";
    end;

    constructorTRecalculatedSymbolsList(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник остатков на л/с для символов частей 1-5.
 *
 * @since 01.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TRests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_isExistsOpenAccount : Bool;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var query = "SELECT account.t_accountId    AS t_accountId,"
             +"\n"+ "       account.t_account      AS t_account,"
             +"\n"+ "       account.t_name         AS t_name,"
             +"\n"+ "       account.t_outCoverRest AS t_outRest,"
             +"\n"+ "       account.t_inCoverRest  AS t_inRest"
             +"\n"+ "  FROM drepaccount_vw account,"
             +"\n"+ "       dopusymb_dbt symb"
             +"\n"+ " WHERE account.t_isOpened = 1"
             +"\n"+ "   AND account.t_balance LIKE " + getSqlString("706%")
             +"\n"+ "   AND rsb_mask.compareStringWithMask(" + getSqlString(attribute.getProperties().getAccountMask()) + ", account.t_account) = 1" // маска из RSL, как параметр
             +"\n"+ "   AND account.t_ofrSymbolId = symb.t_recId"
             +"\n"+ "   AND symb.t_openDate <= rep_data.getEndDate()"
             +"\n"+ "   AND (   symb.t_closeDate = " + getSqlDate(date(0,0,0))
             +"\n"+ "        OR (    rep_data.getBeginDate() <= symb.t_closeDate"
             +"\n"+ "            AND symb.t_closeDate < rep_data.getEndDate()"
             +"\n"+ "            AND symb.t_principle = " + getSqlString("X")
             +"\n"+ "           )"
             +"\n"+ "        OR symb.t_closeDate >= rep_data.getEndDate()"
             +"\n"+ "       )"
             +"\n"+ "   AND symb.t_code = " + getSqlString(attribute.getValue().getSymbol()) // символ из RSL, как параметр
             +"\n"+ "   AND " + filter.isSuitable() // признак счета для учета валютных доходов
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_accountId", V_INTEGER);
        dataSet.setFieldType("t_account",   V_STRING);
        dataSet.setFieldType("t_name",      V_STRING);
        dataSet.setFieldType("t_outRest",   V_MONEY);
        dataSet.setFieldType("t_inRest",    V_MONEY);

        var accountsIds = TArray();
        var accounts = TArray();

        var amount = $0.0;

        m_protocolView.printAccountsTableHeader(description, getSqlString(attribute.getValue().getSymbol()));

        while (dataSet.moveNext())
            m_protocolView.printAccountString(dataSet);
            amount = amount + dataSet.outRest - dataSet.inRest;
            accountsIds[accountsIds.size] = dataSet.accountId;
            accounts[accounts.size] = dataSet.account;
        end;

        m_protocolView.printAccountsTableFooter(dataSet, amount);

        sql_execute("TRUNCATE TABLE dofraccounts_tmp");

        query = "INSERT INTO dofraccounts_tmp"
         +"\n"+ "("
         +"\n"+ "    t_accountId,"
         +"\n"+ "    t_account,"
         +"\n"+ "    t_pairAccount"
         +"\n"+ ")"
         +"\n"+ "VALUES"
         +"\n"+ "("
         +"\n"+ "    ?,"
         +"\n"+ "    ?,"
         +"\n"+ "    CHR(1)"
         +"\n"+ ")"
        ;

        var inserter = RsbSqlInsert(query, 2, accountsIds.size);
        inserter.addParam(V_INTEGER, accountsIds);
        inserter.addParam(V_STRING, accounts, 25);
        inserter.insert();

        sql_execute("COMMIT");

        m_isExistsOpenAccount = (accountsIds.size > 0);

        return amount;
    end;

    macro isExistsOpenAccount()
        return m_isExistsOpenAccount;
    end;

    private macro constructorTRests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_isExistsOpenAccount = false;
    end;

    constructorTRests(id, protocolView, dataSources);
end;

/**
 * ОФР со СПОД. Источник остатков на л/с для символов частей 1-5 для СПОД.
 *
 * @since 04.10.2016
 * @author
 * @version 6.20.031.038
 */
private class (RcbDataSource) TRestsForSpod(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var query = "SELECT account.t_accountId    AS t_accountId,"
             +"\n"+ "       account.t_account      AS t_account,"
             +"\n"+ "       account.t_name         AS t_name,"
             +"\n"+ "       account.t_outCoverRest AS t_outRest,"
             +"\n"+ "       account.t_inCoverRest  AS t_inRest"
             +"\n"+ "  FROM drepaccount_vw account,"
             +"\n"+ "       dopusymb_dbt symb"
             +"\n"+ " WHERE account.t_balance LIKE " + getSqlString("707%")
             +"\n"+ "   AND rsb_mask.compareStringWithMask(" + getSqlString(attribute.getProperties().getAccountMaskForSpod()) + ", account.t_account) = 1" // маска из RSL, как параметр
             +"\n"+ "   AND account.t_ofrSymbolId = symb.t_recId"
             +"\n"+ "   AND symb.t_openDate <= rep_data.getEndDate()"
             +"\n"+ "   AND (   symb.t_closeDate = " + getSqlDate(date(0,0,0))
             +"\n"+ "        OR (    rep_data.getBeginDate() <= symb.t_closeDate"
             +"\n"+ "            AND symb.t_closeDate < rep_data.getEndDate()"
             +"\n"+ "            AND symb.t_principle = " + getSqlString("X")
             +"\n"+ "           )"
             +"\n"+ "        OR symb.t_closeDate >= rep_data.getEndDate()"
             +"\n"+ "       )"
             +"\n"+ "   AND symb.t_code = " + getSqlString(attribute.getValue().getSymbol()) // символ из RSL, как параметр
             +"\n"+ "   AND " + filter.isSuitable() // признак счета для учета валютных доходов
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_accountId", V_INTEGER);
        dataSet.setFieldType("t_account",   V_STRING);
        dataSet.setFieldType("t_name",      V_STRING);
        dataSet.setFieldType("t_outRest",   V_MONEY);
        dataSet.setFieldType("t_inRest",    V_MONEY);

        var accountsIds = TArray();
        var accounts = TArray();

        var amount = $0.0;

        m_protocolView.printAccountsTableHeader(description);

        while (dataSet.moveNext())
            m_protocolView.printAccountString(dataSet);
            amount = amount + dataSet.outRest - dataSet.inRest;
            accountsIds[accountsIds.size] = dataSet.accountId;
            accounts[accounts.size] = dataSet.account;
        end;

        m_protocolView.printAccountsTableFooter(dataSet, amount);

        sql_execute("TRUNCATE TABLE dofraccounts_tmp");

        query = "INSERT INTO dofraccounts_tmp"
         +"\n"+ "("
         +"\n"+ "    t_accountId,"
         +"\n"+ "    t_account,"
         +"\n"+ "    t_pairAccount"
         +"\n"+ ")"
         +"\n"+ "VALUES"
         +"\n"+ "("
         +"\n"+ "    ?,"
         +"\n"+ "    ?,"
         +"\n"+ "    CHR(1)"
         +"\n"+ ")"
        ;

        var inserter = RsbSqlInsert(query, 2, accountsIds.size);
        inserter.addParam(V_INTEGER, accountsIds);
        inserter.addParam(V_STRING, accounts, 25);
        inserter.insert();

        sql_execute("COMMIT");

        return amount;
    end;

    private macro constructorTRests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTRests(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник оборотов по л/с.
 *
 * @since 01.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_debitTurnsSign : String; // Знак дебетового оборота
    private var m_creditTurnsSign : String; // Знак кредитового оборота

    macro setDebitTurnsSign(sign : String) : Object
        m_debitTurnsSign = sign;
        return this;
    end;

    macro setCreditTurnsSign(sign : String) : Object
        m_creditTurnsSign = sign;
        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var query = "SELECT doc.t_id                AS t_id,"
             +"\n"+ "       doc.t_number            AS t_number,"
             +"\n"+ "       doc.t_date              AS t_date,"
             +"\n"+ "       doc.t_debetAccount      AS t_debetAccount,"
             +"\n"+ "       doc.t_creditAccount     AS t_creditAccount,"
             +"\n"+ "       CASE account.t_account"
             +"\n"+ "           WHEN doc.t_debetAccount THEN " + m_debitTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "           WHEN doc.t_creditAccount THEN " + m_creditTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "           ELSE 0.0"
             +"\n"+ "       END                     AS t_amount,"
             +"\n"+ "       account.t_account       AS t_account"
             +"\n"+ "  FROM drepdocument_vw doc,"
             +"\n"+ "       dofraccounts_tmp account"
             +"\n"+ " WHERE doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
             +"\n"+ "   AND account.t_account = ANY(doc.t_creditAccount, doc.t_debetAccount)"
             +"\n"+ "   AND " + filter.isSuitable()
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_number",        V_STRING);
        dataSet.setFieldType("t_date",          V_DATE);
        dataSet.setFieldType("t_debetAccount",  V_STRING);
        dataSet.setFieldType("t_creditAccount", V_STRING);
        dataSet.setFieldType("t_amount",        V_MONEY);
        dataSet.setFieldType("t_account",       V_STRING);

        m_protocolView.printDocumentsTableHeader();

        var amount = $0.0;

        while (dataSet.moveNext())
            m_protocolView.printDocumentString(dataSet);
            amount = amount + dataSet.t_amount;
        end;

        m_protocolView.printDocumentsTableFooter(dataset, amount);

        return amount;
    end;

    private macro constructorTTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTTurns(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник оборотов СПОД по л/с.
 *
 * @since 25.09.2016
 * @author GWW
 * @version 6.20.031.38
 */
private class (TTurns) TTurnsNextYear(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro setDebitTurnsSign(sign : String) : Object
        m_debitTurnsSign = sign;
        return this;
    end;

    macro setCreditTurnsSign(sign : String) : Object
        m_creditTurnsSign = sign;
        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var beginDate = rcbApplication.currentReport.context.period.endDate + 1;
        var endDate   = DateAfterCalenMonths(rcbApplication.currentReport.context.period.endDate, 12);

        var query = "SELECT doc.t_id                AS t_id,"
             +"\n"+ "       doc.t_number            AS t_number,"
             +"\n"+ "       doc.t_date              AS t_date,"
             +"\n"+ "       doc.t_debetAccount      AS t_debetAccount,"
             +"\n"+ "       doc.t_creditAccount     AS t_creditAccount,"
             +"\n"+ "       CASE account.t_account"
             +"\n"+ "           WHEN doc.t_debetAccount THEN " + m_debitTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "           WHEN doc.t_creditAccount THEN " + m_creditTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "           ELSE 0.0"
             +"\n"+ "       END                     AS t_amount,"
             +"\n"+ "       account.t_account       AS t_account,"
             +"\n"+ "       NULL                    AS t_pairAccount"
             +"\n"+ "  FROM drepdocument_vw doc,"
             +"\n"+ "       dofraccounts_tmp account"
             +"\n"+ " WHERE doc.t_date BETWEEN " + getSqlDate(beginDate) + " AND " + getSqlDate(endDate)
             +"\n"+ "   AND account.t_account = ANY(doc.t_creditAccount, doc.t_debetAccount)"
             +"\n"+ "   AND " + filter.isSuitable()
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_number",        V_STRING);
        dataSet.setFieldType("t_date",          V_DATE);
        dataSet.setFieldType("t_debetAccount",  V_STRING);
        dataSet.setFieldType("t_creditAccount", V_STRING);
        dataSet.setFieldType("t_amount",        V_MONEY);
        dataSet.setFieldType("t_account",       V_STRING);
        dataSet.setFieldType("t_pairAccount",   V_STRING);

        m_protocolView.printDocumentsTableHeader();

        var amount = $0.0;

        while (dataSet.moveNext())
            m_protocolView.printDocumentString(dataSet);
            amount = amount + dataSet.t_amount;
        end;

        m_protocolView.printDocumentsTableFooter(dataset, amount);

        return amount;
    end;

    private macro constructorTTurnsSpod(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
    end;

    constructorTTurnsSpod(id, protocolView, dataSources);
end;


/**
 * ОФР со СПОД. Источник данных для расчета СПОД для частей 1-4
 *
 * @since 10.10.2016
 * @author
 * @version 6.20.031.038
 */
private class (RcbDataSource) TTurnsSpodAlg(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_restsForSpod : RcbDataSource;
    private var m_turnsSpod    : RcbDataSource;

    private var m_restsForSpodFilter        : RcbDataSourceFilter;
    private var m_turnsSpodFilterRouble     : RcbDataSourceFilter;
    private var m_turnsSpodFilterEquivalent : RcbDataSourceFilter;
    private var m_excludedAccountsMask;

    macro getTurnsSpodDataSource()
        return m_turnsSpod;
    end;

    macro setExcludedAccountsMask(accountsMask)
        m_excludedAccountsMask = accountsMask;

        return this;
    end;

    macro getExcludedAccountsMask()
        return m_excludedAccountsMask;
    end;

    macro getData(attribute : RcbAttributeBase, description : String) : Object
        var roubleSpodAmount;
        var equivalentSpodAmount;
        var totalSpodAmount;

        private var isCurrency = attribute.getProperties().isCurrency();

        m_restsForSpod.getData(m_restsForSpodFilter, attribute, description);

        m_turnsSpodFilterRouble.clear().isSpod().op("AND").op("NOT").isCorrespondingAccountSatisfiesToMask(getExcludedAccountsMask(), "account");

        if (isCurrency)
            m_turnsSpodFilterRouble.op("AND").isRoubleCorrespondingAccount("account");
        end;

        roubleSpodAmount = m_turnsSpod.getData(m_turnsSpodFilterRouble, attribute, "");

        if (isCurrency)
            m_turnsSpodFilterEquivalent.clear().isSpod().op("AND").isCurrencyCorrespondingAccount("account");
            m_turnsSpodFilterEquivalent.op("AND").op("NOT").isCorrespondingAccountSatisfiesToMask(getExcludedAccountsMask(), "account");

            equivalentSpodAmount = m_turnsSpod.getData(m_turnsSpodFilterEquivalent, attribute, "");
        end;

        totalSpodAmount = nvl(roubleSpodAmount, $0.0) + nvl(equivalentSpodAmount, $0.0);

        m_protocolView.printSymbolFooter(roubleSpodAmount, equivalentSpodAmount);

        return RcbArray().initialize(nvl(roubleSpodAmount, $0.0), nvl(equivalentSpodAmount, $0.0), totalSpodAmount);

    end;

    macro constructorTTurnsSpodAlg(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_restsForSpod = TRestsForSpod("restsForSpod", m_protocolView, m_dataSources);
        m_turnsSpod    = TTurnsNextYear("spod", m_protocolView, m_dataSources);

        m_turnsSpodFilterRouble = m_dataSources.getDataSourceFilters().getFilter("documents");

        m_turnsSpodFilterEquivalent = m_dataSources.getDataSourceFilters().getFilter("documents");

        m_restsForSpodFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsForSpodFilter.op("1=1");
    end;

    constructorTTurnsSpodAlg(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов частей 1 и 2 (доходы) при расчете "по остаткам".
 *
 * @since 01.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TIncomeSymbolsValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_rests : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsSpod : RcbDataSource;

    private var m_restsFilterRouble : RcbDataSourceFilter;
    private var m_restsFilterEquivalent : RcbDataSourceFilter;
    private var m_turnsFilter : RcbDataSourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var roubleAmount = m_rests.getData(m_restsFilterRouble, attribute, "Счета учета рублевых доходов")
                         + m_turns.getData(m_turnsFilter, attribute, "");

        var equivalentAmount;
        var isExistsRoubleAccounts = m_rests.isExistsOpenAccount();
        var isExistsEquivalentAccounts = false;

        if (attribute.getProperties().isCurrency())
            equivalentAmount = m_rests.getData(m_restsFilterEquivalent, attribute, "Счета учета валютных доходов")
                             + m_turns.getData(m_turnsFilter, attribute, "");

            isExistsEquivalentAccounts = m_rests.isExistsOpenAccount();
        end;

        var totalAmount = roubleAmount + nvl(equivalentAmount, $0.0);

        m_protocolView.printSymbolFooter(roubleAmount, equivalentAmount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodValue = m_turnsSpod.getData(attribute, description);

            roubleAmount     = roubleAmount + spodValue[0];
            equivalentAmount = nvl(equivalentAmount, $0.0) + spodValue[1];
            totalAmount      = totalAmount + spodValue[2];

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     spodValue[0], spodValue[1], spodValue[2],
                                                                                                                                     (isExistsRoubleAccounts or isExistsEquivalentAccounts)));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     (isExistsRoubleAccounts or isExistsEquivalentAccounts)));
        end;
    end;

    private macro constructorTIncomeSymbolsValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_rests = TRests("rests", m_protocolView, m_dataSources);
        m_turns = TTurns("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        m_turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        m_turnsFilter.isSpod().op("AND").isCorrespondingAccountSatisfiesToMask("70701-70705,70713*,30305*,30306*", "account");

        m_restsFilterRouble = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilterRouble.op("NOT").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING, "V");

        m_restsFilterEquivalent = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilterEquivalent.hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING, "V");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsSpodAlg(id, protocolView, dataSources);
            m_turnsSpod.getTurnsSpodDataSource().setDebitTurnsSign("-").setCreditTurnsSign("+");
            m_turnsSpod.setExcludedAccountsMask("30305*,30306*,70601-70605,70613*,708*");
        end;
    end;

    constructorTIncomeSymbolsValuesRestsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов частей 3 и 4 (расходы) при расчете "по остаткам".
 *
 * @since 02.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TExpensesSymbolsValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_rests : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsSpod : RcbDataSource;

    private var m_restsFilterRouble : RcbDataSourceFilter;
    private var m_restsFilterEquivalent : RcbDataSourceFilter;
    private var m_turnsFilter : RcbDataSourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var roubleAmount = m_rests.getData(m_restsFilterRouble, attribute, "Счета учета рублевых расходов")
                         + m_turns.getData(m_turnsFilter, attribute, "");

        var equivalentAmount;
        var isExistsRoubleAccounts = m_rests.isExistsOpenAccount();
        var isExistsEquivalentAccounts = false;

        if (attribute.getProperties().isCurrency())
            equivalentAmount = m_rests.getData(m_restsFilterEquivalent, attribute, "Счета учета валютных расходов")
                             + m_turns.getData(m_turnsFilter, attribute, "");

            isExistsEquivalentAccounts = m_rests.isExistsOpenAccount();
        end;

        var totalAmount = roubleAmount + nvl(equivalentAmount, $0.0);

        m_protocolView.printSymbolFooter(roubleAmount, equivalentAmount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodValue = m_turnsSpod.getData(attribute, description);

            roubleAmount     = roubleAmount + spodValue[0];
            equivalentAmount = nvl(equivalentAmount, $0.0) + spodValue[1];
            totalAmount      = totalAmount + spodValue[2];

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     spodValue[0], spodValue[1], spodValue[2]
                                                                                                                                     (isExistsRoubleAccounts or isExistsEquivalentAccounts)));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     (isExistsRoubleAccounts or isExistsEquivalentAccounts)));
        end;
    end;

    private macro constructorTExpensesSymbolsValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_rests = TRests("rests", m_protocolView, m_dataSources);
        m_turns = TTurns("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        m_turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        m_turnsFilter.isSpod().op("AND").isCorrespondingAccountSatisfiesToMask("70706-70711,70714*,70716*,30305*,30306*", "account");

        m_restsFilterRouble = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilterRouble.op("NOT").hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING, "V");

        m_restsFilterEquivalent = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilterEquivalent.hasAccountAssignedCategory(RCB_OBJGROUP_FOR_REPORTING, "V");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsSpodAlg(id, protocolView, dataSources);
            m_turnsSpod.getTurnsSpodDataSource().setDebitTurnsSign("+").setCreditTurnsSign("-");
            m_turnsSpod.setExcludedAccountsMask("30305*,30306*,70606-70610,70614*,708*");
        end;
    end;

    constructorTExpensesSymbolsValuesRestsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов частей 1 и 2 (доходы) при расчете "по оборотам".
 *
 * @since 02.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TIncomeSymbolsValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_rests : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsSpod : RcbDataSource;

    private var m_restsFilter : RcbDataSourceFilter;
    private var m_turnsFilterRouble : RcbDataSourceFilter;
    private var m_turnsFilterEquivalent : RcbDataSourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        private var isCurrency = attribute.getProperties().isCurrency();

        m_rests.getData(m_restsFilter, attribute, "Доходы от рублевых операций");

        var isExistsOpenAccount = m_rests.isExistsOpenAccount();

        m_turnsFilterRouble.clear().op("NOT").isSpod();

        if (isCurrency)
            m_turnsFilterRouble.op("AND").isRoubleCorrespondingAccount("account");
        end;

        var roubleAmount = m_turns.getData(m_turnsFilterRouble, attribute, "");

        var equivalentAmount;
        if (isCurrency)
            equivalentAmount = m_turns.getData(m_turnsFilterEquivalent, attribute, "");
        end;

        var totalAmount = roubleAmount + nvl(equivalentAmount, $0.0);

        m_protocolView.printSymbolFooter(roubleAmount, equivalentAmount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodValue = m_turnsSpod.getData(attribute, description);

            roubleAmount     = roubleAmount + spodValue[0];
            equivalentAmount = nvl(equivalentAmount, $0.0) + spodValue[1];
            totalAmount      = totalAmount + spodValue[2];

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     spodValue[0], spodValue[1], spodValue[2],
                                                                                                                                     isExistsOpenAccount));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     isExistsOpenAccount));
        end;
    end;

    private macro constructorTIncomeSymbolsValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_rests = TRests("rests", m_protocolView, m_dataSources);
        m_turns = TTurns("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        m_turnsFilterRouble = m_dataSources.getDataSourceFilters().getFilter("documents");

        m_turnsFilterEquivalent = m_dataSources.getDataSourceFilters().getFilter("documents");
        m_turnsFilterEquivalent.op("NOT").isSpod().op("AND").isCurrencyCorrespondingAccount("account");

        m_restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilter.op("1=1");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsSpodAlg(id, protocolView, dataSources);
            m_turnsSpod.getTurnsSpodDataSource().setDebitTurnsSign("-").setCreditTurnsSign("+");
            m_turnsSpod.setExcludedAccountsMask("30305*,30306*,70601-70605,70613*,708*");
        end;
    end;

    constructorTIncomeSymbolsValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов частей 3 и 4 (расходы) при расчете "по оборотам".
 *
 * @since 02.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TExpensesSymbolsValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_rests : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsSpod : RcbDataSource;

    private var m_restsFilter : RcbDataSourceFilter;
    private var m_turnsFilterRouble : RcbDataSourceFilter;
    private var m_turnsFilterEquivalent : RcbDataSourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        private var isCurrency = attribute.getProperties().isCurrency();

        m_rests.getData(m_restsFilter, attribute, "Расходы от рублевых операций");

        var isExistsOpenAccount = m_rests.isExistsOpenAccount();

        m_turnsFilterRouble.clear().op("NOT").isSpod();

        if (isCurrency)
            m_turnsFilterRouble.op("AND").isRoubleCorrespondingAccount("account");
        end;

        var roubleAmount = m_turns.getData(m_turnsFilterRouble, attribute, "");

        var equivalentAmount;

        if (isCurrency)
            equivalentAmount = m_turns.getData(m_turnsFilterEquivalent, attribute, "");
        end;

        var totalAmount = roubleAmount + nvl(equivalentAmount, $0.0);

        m_protocolView.printSymbolFooter(roubleAmount, equivalentAmount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodValue = m_turnsSpod.getData(attribute, description);

            roubleAmount     = roubleAmount + spodValue[0];
            equivalentAmount = nvl(equivalentAmount, $0.0) + spodValue[1];
            totalAmount      = totalAmount + spodValue[2];

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     spodValue[0], spodValue[1], spodValue[2],
                                                                                                                                     isExistsOpenAccount));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, totalAmount,
                                                                                                                                     isExistsOpenAccount));
        end;
    end;

    private macro constructorTExpensesSymbolsValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_rests = TRests("rests", m_protocolView, m_dataSources);
        m_turns = TTurns("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        m_turnsFilterRouble = m_dataSources.getDataSourceFilters().getFilter("documents");

        m_turnsFilterEquivalent = m_dataSources.getDataSourceFilters().getFilter("documents");
        m_turnsFilterEquivalent.op("NOT").isSpod().op("AND").isCurrencyCorrespondingAccount("account");

        m_restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        m_restsFilter.op("1=1");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsSpodAlg(id, protocolView, dataSources);
            m_turnsSpod.getTurnsSpodDataSource().setDebitTurnsSign("+").setCreditTurnsSign("-");
            m_turnsSpod.setExcludedAccountsMask("30305*,30306*,70606-70610,70614*,708*");
        end;
    end;

    constructorTExpensesSymbolsValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для итоговых символов групп, разделов, частей (1-4) и статей (доходы и расходы).
 * Категория для подсчета итогов (группа, раздел, часть, статья) определяется фильтром ИД
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TTotalSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    class TFilter(filter)
        private var m_filter = filter;

        macro isSuitable(value : Object)
            return execExp(m_filter.getFilter());
        end;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);
        m_protocolView.printSymbolsHeader();

        var roubleAmount : Money = $0.0;
        var equivalentAmount = null;
        var roubleSpodAmount : Money = $0.0;
        var equivalentSpodAmount = null;

        var isOfrWithSpod = TOfrGlobal().isOfrWithSpodReport();
        var isExistsOpenAccount = false;

        var it = TOfrGlobal().getRcbReport().attributeValue("Символы").createValueIterator();
        it.setFilter(TFilter(filter));

        it.moveFirst();
        while (not it.isDone())
            var rouble = it.currentItem.fieldValue("rouble").exact;
            roubleAmount = roubleAmount + rouble;

            if (isOfrWithSpod)
                roubleSpodAmount = roubleSpodAmount + nvl(it.currentItem.fieldValue("roubleSpod").exact, $0.0);
            end;

            var equivalent = "X";
            if (    it.currentItem.fieldValue("equivalent").isDefined()
                and (it.currentItem.fieldValue("equivalent").exact != null)
               )
                equivalent = it.currentItem.fieldValue("equivalent").exact;
                equivalentAmount = nvl(equivalentAmount, $0.0) + equivalent;

                if (isOfrWithSpod)
                    equivalentSpodAmount = nvl(equivalentSpodAmount, $0.0) + nvl(it.currentItem.fieldValue("equivalentSpod").exact, $0.0);
                end;
            end;

            if (it.currentItem.fieldValue("isExistsOpenAccount").exact == "X")
                isExistsOpenAccount = true;
            end;

            m_protocolView.printSymbolValue(it.currentItem.fieldValue("symbol").exact, rouble, equivalent, rouble + nvl(equivalent, $0.0));

            it.moveNext();
        end;

        if (isOfrWithSpod)
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, roubleAmount+nvl(equivalentAmount, $0.0),
                                                                                                                                     roubleSpodAmount, equivalentSpodAmount, roubleSpodAmount+nvl(equivalentSpodAmount, $0.0),
                                                                                                                                     isExistsOpenAccount));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), roubleAmount, equivalentAmount, roubleAmount+nvl(equivalentAmount, $0.0),
                                                                                                                                     isExistsOpenAccount));
        end;
    end;

    private macro constructorTTotalSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTTotalSymbolsValues(id, protocolView, dataSources);
end;

private class (RcbDataSource) TSpecialSymbolDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_partValue : Object;

    private macro getValue(keyField : String, keyData : String, dataField : String, isScaled : bool)
        var attributeValue : Object;
        var fieldValue : Object;
        var amount = $0.0;

        defaultParm(isScaled, false);

        var keyValue = m_partValue.createKeyValue();
        keyValue.fieldValue(keyField) = keyData;
        attributeValue = m_partValue.findValue(keyValue);
        if (    (attributeValue != null)
            and attributeValue.isDefined()
           )
            fieldValue = attributeValue.fieldValue(dataField);
            if (    fieldValue.isDefined()
                and fieldValue.exact != null
               )
                amount = ternary(isScaled, fieldValue.scaled, fieldValue.exact);
            else
                m_protocolView.printFreeString("\t\tНе определено значение");
            end;
        else
            m_protocolView.printFreeString("\t\tНе найдено значение");
        end;

        return amount;
    end;

    private macro constructorTSpecialSymbolDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_partValue = TOfrGlobal().getRcbReport().attributeValue("Символы");
    end;

    constructorTSpecialSymbolDataSource(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 01000.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_01000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var income = getValue("symbol", "1_2", "total");
        m_protocolView.printComponentValue("Всего доходов", income);

        var expenses = getValue("symbol", "3_4", "total");
        m_protocolView.printComponentValue("Всего расходов", expenses);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), income, expenses);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_01000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_01000_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 02000.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_02000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var income = getValue("symbol", "1_2", "total");
        m_protocolView.printComponentValue("Всего доходов", income);

        var expenses = getValue("symbol", "3_4", "total");
        m_protocolView.printComponentValue("Всего расходов", expenses);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), income, expenses);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_02000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_02000_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 01000 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_01000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var incomeExact = getValue("symbol", "1_2", "total");
        var incomeScaled = getValue("symbol", "1_2", "total", true);
        m_protocolView.printComponentValue("Всего доходов", incomeExact);

        var expensesExact = getValue("symbol", "3_4", "total");
        var expensesScaled = getValue("symbol", "3_4", "total", true);
        m_protocolView.printComponentValue("Всего расходов", expensesExact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), incomeExact, expensesExact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), incomeScaled, expensesScaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_01000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_01000_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 02000 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_02000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var incomeExact = getValue("symbol", "1_2", "total");
        var incomeScaled = getValue("symbol", "1_2", "total", true);
        m_protocolView.printComponentValue("Всего доходов", incomeExact);

        var expensesExact= getValue("symbol", "3_4", "total");
        var expensesScaled= getValue("symbol", "3_4", "total", true);
        m_protocolView.printComponentValue("Всего расходов", expensesExact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), incomeExact, expensesExact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), incomeScaled, expensesScaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_02000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_02000_Values_Recalculate(id, protocolView, dataSources);
end;


/**
 * ОФР. Источник данных для символа 51101 при расчете "по остаткам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51101_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.isSpod().op("AND").isCorrespondingAccountSatisfiesToMask("70711*,30305*,30306*", "account");

        var amount = $0.0;

        amount = rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов") + turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51101_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51101_ValuesRestsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 51101 при расчете "по оборотам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51101_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isSpod();

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51101_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51101_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР со СПОД. Источник данных для символа 51101.
 *
 * @since 10.10.2016
 * @author
 * @version 6.20.031.038
 */
private class (RcbDataSource) TSymbol_51101_ValuesSpodAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRestsForSpod("restsForSpod", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurnsNextYear("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isCorrespondingAccountSatisfiesToMask("708*", "account");

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, null, null, null));
    end;

    private macro constructorTSymbol_51101_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51101_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 51201 при расчете "по остаткам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51201_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.isSpod().op("AND").isCorrespondingAccountSatisfiesToMask("70716*,30305*,30306*", "account");

        var amount = $0.0;

        amount = rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов") + turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51201_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51201_ValuesRestsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 51201 при расчете "по оборотам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51201_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isSpod();

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51201_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51201_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР со СПОД. Источник данных для символа 51201.
 *
 * @since 10.10.2016
 * @author
 * @version 6.20.031.038
 */
private class (RcbDataSource) TSymbol_51201_ValuesSpodAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRestsForSpod("restsForSpod", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurnsNextYear("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isCorrespondingAccountSatisfiesToMask("708*", "account");

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, null, null, null));
    end;

    private macro constructorTSymbol_51201_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51201_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 51202 при расчете "по остаткам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51202_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("+").setCreditTurnsSign("-");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.isSpod().op("AND").isCorrespondingAccountSatisfiesToMask("70715*,30305*,30306*", "account");

        var amount = $0.0;

        amount = rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов") + turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51202_ValuesRestsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51202_ValuesRestsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 51202 при расчете "по оборотам".
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TSymbol_51202_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRests("rests", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurns("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isSpod();

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_51202_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51202_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР со СПОД. Источник данных для символа 51202.
 *
 * @since 10.10.2016
 * @author
 * @version 6.20.031.038
 */
private class (RcbDataSource) TSymbol_51202_ValuesSpodAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var rests = TRestsForSpod("restsForSpod", m_protocolView, m_dataSources);

        var restsFilter = m_dataSources.getDataSourceFilters().getFilter("accounts");
        restsFilter.op("1=1");

        var turns = TTurnsNextYear("turns", m_protocolView, m_dataSources);
        turns.setDebitTurnsSign("-").setCreditTurnsSign("+");

        var turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        turnsFilter.op("NOT").isCorrespondingAccountSatisfiesToMask("708*", "account");

        var amount = $0.0;

        rests.getData(restsFilter, attribute, "Учет рублевых доходов/расходов");
        amount = turns.getData(turnsFilter, attribute, description);

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, null, null, null));
    end;

    private macro constructorTSymbol_51202_ValuesTurnsAgl(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_51202_ValuesTurnsAgl(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 03000.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_03000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s51101 = getValue("symbol", "51101", "rouble");
        m_protocolView.printComponentValue("Символ 51101", s51101);

        var s51201 = getValue("symbol", "51201", "rouble");
        m_protocolView.printComponentValue("Символ 51201", s51201);

        var s51202 = getValue("symbol", "51202", "rouble");
        m_protocolView.printComponentValue("Символ 51202", s51202);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s51101, s51201, s51202);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_03000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_03000_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 04000.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_04000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s51101 = getValue("symbol", "51101", "rouble");
        m_protocolView.printComponentValue("Символ 51101", s51101);

        var s51201 = getValue("symbol", "51201", "rouble");
        m_protocolView.printComponentValue("Символ 51201", s51201);

        var s51202 = getValue("symbol", "51202", "rouble");
        m_protocolView.printComponentValue("Символ 51202", s51202);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s51101, s51201, s51202);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount));
    end;

    private macro constructorTSymbol_04000_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_04000_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 61101.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_61101_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s01000 = getValue("symbol", "01000", "total");
        m_protocolView.printComponentValue("Символ 01000", s01000);

        var s02000 = getValue("symbol", "02000", "total");
        m_protocolView.printComponentValue("Символ 02000", s02000);

        var s03000 = getValue("symbol", "03000", "total");
        m_protocolView.printComponentValue("Символ 03000", s03000);

        var s04000 = getValue("symbol", "04000", "total");
        m_protocolView.printComponentValue("Символ 04000", s04000);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s01000, s02000, s03000, s04000);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_61101_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_61101_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 61102.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_61102_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s01000 = getValue("symbol", "01000", "total");
        m_protocolView.printComponentValue("Символ 01000", s01000);

        var s02000 = getValue("symbol", "02000", "total");
        m_protocolView.printComponentValue("Символ 02000", s02000);

        var s03000 = getValue("symbol", "03000", "total");
        m_protocolView.printComponentValue("Символ 03000", s03000);

        var s04000 = getValue("symbol", "04000", "total");
        m_protocolView.printComponentValue("Символ 04000", s04000);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s01000, s02000, s03000, s04000);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_61102_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_61102_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 03000 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_03000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s51101Exact = getValue("symbol", "51101", "rouble");
        var s51101Scaled = getValue("symbol", "51101", "rouble", true);
        m_protocolView.printComponentValue("Символ 51101", s51101Exact);

        var s51201Exact = getValue("symbol", "51201", "rouble");
        var s51201Scaled = getValue("symbol", "51201", "rouble", true);
        m_protocolView.printComponentValue("Символ 51201", s51201Exact);

        var s51202Exact = getValue("symbol", "51202", "rouble");
        var s51202Scaled = getValue("symbol", "51202", "rouble", true);
        m_protocolView.printComponentValue("Символ 51202", s51202Exact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), s51101Exact, s51201Exact, s51202Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s51101Scaled, s51201Scaled, s51202Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), TValue(amountExact, amountScaled), null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_03000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_03000_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 04000 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_04000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s51101Exact = getValue("symbol", "51101", "rouble");
        var s51101Scaled = getValue("symbol", "51101", "rouble", true);
        m_protocolView.printComponentValue("Символ 51101", s51101Exact);

        var s51201Exact = getValue("symbol", "51201", "rouble");
        var s51201Scaled = getValue("symbol", "51201", "rouble", true);
        m_protocolView.printComponentValue("Символ 51201", s51201Exact);

        var s51202Exact = getValue("symbol", "51202", "rouble");
        var s51202Scaled = getValue("symbol", "51202", "rouble", true);
        m_protocolView.printComponentValue("Символ 51202", s51202Exact);

        var amountExact : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s51101Exact, s51201Exact, s51202Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s51101Scaled, s51201Scaled, s51202Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), TValue(amountExact, amountScaled), null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_04000_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_04000_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 61101 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_61101_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s01000Exact = getValue("symbol", "01000", "total");
        var s01000Scaled = getValue("symbol", "01000", "total", true);
        m_protocolView.printComponentValue("Символ 01000", s01000Exact);

        var s02000Exact = getValue("symbol", "02000", "total");
        var s02000Scaled = getValue("symbol", "02000", "total", true);
        m_protocolView.printComponentValue("Символ 02000", s02000Exact);

        var s03000Exact = getValue("symbol", "03000", "total");
        var s03000Scaled = getValue("symbol", "03000", "total", true);
        m_protocolView.printComponentValue("Символ 03000", s03000Exact);

        var s04000Exact = getValue("symbol", "04000", "total");
        var s04000Scaled = getValue("symbol", "04000", "total", true);
        m_protocolView.printComponentValue("Символ 04000", s04000Exact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), s01000Exact, s02000Exact, s03000Exact, s04000Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s01000Scaled, s02000Scaled, s03000Scaled, s04000Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_61101_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_61101_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 61102 для пересчета итогов.
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_61102_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s01000Exact = getValue("symbol", "01000", "total");
        var s01000Scaled = getValue("symbol", "01000", "total", true);
        m_protocolView.printComponentValue("Символ 01000", s01000Exact);

        var s02000Exact = getValue("symbol", "02000", "total");
        var s02000Scaled = getValue("symbol", "02000", "total", true);
        m_protocolView.printComponentValue("Символ 02000", s02000Exact);

        var s03000Exact = getValue("symbol", "03000", "total");
        var s03000Scaled = getValue("symbol", "03000", "total", true);
        m_protocolView.printComponentValue("Символ 03000", s03000Exact);

        var s04000Exact = getValue("symbol", "04000", "total");
        var s04000Scaled = getValue("symbol", "04000", "total", true);
        m_protocolView.printComponentValue("Символ 04000", s04000Exact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), s01000Exact, s02000Exact, s03000Exact, s04000Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s01000Scaled, s02000Scaled, s03000Scaled, s04000Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_61102_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_61102_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник лицевых счетов части 7.
 *
 * @since 07.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TAccountsPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_savePairAccounts : Bool;
    private var m_isExistsOpenAccount : Bool;

    macro setSavePairAccounts(flag)
        m_savePairAccounts = flag;
        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var query = "SELECT account.t_accountId     AS t_accountId,"
             +"\n"+ "       account.t_account       AS t_account,"
             +"\n"+ "       account.t_pairAccount   AS t_pairAccount"
             +"\n"+ "  FROM drepaccount_vw account"
             +"\n"+ " WHERE account.t_balance LIKE " + getSqlString("106%")
             +"\n"+ "   AND rsb_mask.compareStringWithMask(" + getSqlString(attribute.getProperties().getAccountMask()) + ", account.t_account) = 1" // маска из RSL, как параметр
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_account",       V_STRING);
        dataSet.setFieldType("t_pairAccount",   V_STRING);

        var accountsIds = TArray();
        var accounts = TArray();
        var pairAccounts = TArray();

        m_protocolView.printAccountsTableHeader(description);

        while (dataSet.moveNext())
            var isDuplicates = false;
            // Исключение пар-дубликатов
            if ((dataSet.pairAccount != "") and m_savePairAccounts)
                for (var i, accounts)
                    if (dataSet.pairAccount == i)
                        isDuplicates = true;
                        break;
                    end;
                end;
            end;

            if (not isDuplicates)
                m_protocolView.printAccountString(dataSet);

                accountsIds[accountsIds.size] = dataSet.accountId;
                accounts[accounts.size] = dataSet.account;
                pairAccounts[pairAccounts.size] = dataSet.pairAccount;
            end;
        end;

        m_protocolView.printAccountsTableFooter();

        sql_execute("TRUNCATE TABLE dofraccounts_tmp");

        query = "INSERT INTO dofraccounts_tmp"
         +"\n"+ "("
         +"\n"+ "    t_accountId,"
         +"\n"+ "    t_account,"
         +"\n"+ "    t_pairAccount"
         +"\n"+ ")"
         +"\n"+ "VALUES"
         +"\n"+ "("
         +"\n"+ "    ?,"
         +"\n"+ "    ?,"
         +"\n"+ "  " + ternary(m_savePairAccounts, "?", getSqlString(""))
         +"\n"+ ")"
        ;

        var inserter = RsbSqlInsert(query, 3, accountsIds.size);
        inserter.addParam(V_INTEGER, accountsIds);
        inserter.addParam(V_STRING, accounts, 25);
        inserter.addParam(V_STRING, pairAccounts, 25);
        inserter.insert();

        sql_execute("COMMIT");

        m_isExistsOpenAccount = (accountsIds.size > 0);

        return $0.0;
    end;

    macro isExistsOpenAccount()
        return m_isExistsOpenAccount;
    end;

    private macro constructorTAccountsPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_savePairAccounts = false;
        m_isExistsOpenAccount = false;
    end;

    constructorTAccountsPart7(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник оборотов по л/с для символов части 7.
 *
 * @since 08.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TTurnsPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_debitTurnsSign : String; // Знак дебетового оборота
    private var m_creditTurnsSign : String; // Знак кредитового оборота

    macro setDebitTurnsSign(sign : String) : Object
        m_debitTurnsSign = sign;
        return this;
    end;

    macro setCreditTurnsSign(sign : String) : Object
        m_creditTurnsSign = sign;
        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Money
        var query = "SELECT doc.t_id                AS t_id,"
             +"\n"+ "       doc.t_number            AS t_number,"
             +"\n"+ "       doc.t_date              AS t_date,"
             +"\n"+ "       doc.t_debetAccount      AS t_debetAccount,"
             +"\n"+ "       doc.t_creditAccount     AS t_creditAccount,"
             +"\n"+ "       CASE account.t_account"
             +"\n"+ "           WHEN doc.t_debetAccount THEN " + m_debitTurnsSign + " doc.t_inCoverSum"
             +"\n"+ "           WHEN doc.t_creditAccount THEN " + m_creditTurnsSign + " doc.t_inCoverSum"
             +"\n"+ "           ELSE 0.0"
             +"\n"+ "       END                     AS t_amount,"
             +"\n"+ "       account.t_account       AS t_account,"
             +"\n"+ "       account.t_pairAccount   AS t_pairAccount"
             +"\n"+ "  FROM drepdocument_vw doc,"
             +"\n"+ "       dofraccounts_tmp account"
             +"\n"+ " WHERE doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
             +"\n"+ "   AND account.t_account = ANY(doc.t_creditAccount, doc.t_debetAccount)"
             +"\n"+ "   AND " + filter.isSuitable()
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_number",        V_STRING);
        dataSet.setFieldType("t_date",          V_DATE);
        dataSet.setFieldType("t_debetAccount",  V_STRING);
        dataSet.setFieldType("t_creditAccount", V_STRING);
        dataSet.setFieldType("t_amount",        V_MONEY);
        dataSet.setFieldType("t_account",       V_STRING);
        dataSet.setFieldType("t_pairAccount",   V_STRING);

        m_protocolView.printDocumentsTableHeader(description);

        var amount = $0.0;

        while (dataSet.moveNext())
            amount = amount + dataSet.amount;
            m_protocolView.printDocumentString(dataSet);
        end;

        m_protocolView.printDocumentsTableFooter(dataset, amount);

        return amount;
    end;

    private macro constructorTTurnsPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTTurnsPart7(id, protocolView, dataSources);
end;


/**
 * ОФР. Источник оборотов по л/с для парных символов части 7.
 *
 * @since 08.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TTurnsPairedPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_debitTurnsSign : String; // Знак дебетового оборота
    private var m_creditTurnsSign : String; // Знак кредитового оборота

    macro setDebitTurnsSign(sign : String) : Object
        m_debitTurnsSign = sign;
        return this;
    end;

    macro setCreditTurnsSign(sign : String) : Object
        m_creditTurnsSign = sign;
        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var query = "SELECT doc.t_account           AS t_account,"
             +"\n"+ "       doc.t_pairAccount       AS t_pairAccount,"
             +"\n"+ "       doc.t_pairId            AS t_pairId,"
             +"\n"+ "       doc.t_amount            AS t_amount,"
             +"\n"+ "       doc.t_id                AS t_id,"
             +"\n"+ "       doc.t_number            AS t_number,"
             +"\n"+ "       doc.t_date              AS t_date,"
             +"\n"+ "       doc.t_debetAccount      AS t_debetAccount,"
             +"\n"+ "       doc.t_creditAccount     AS t_creditAccount,"
             +"\n"+ "       doc.t_isAccountTotals   AS t_isAccountTotals"
             +"\n"+ "  FROM (SELECT CASE"
             +"\n"+ "                   WHEN account.t_account = doc.t_debetAccount"
             +"\n"+ "                     OR account.t_account = doc.t_creditAccount"
             +"\n"+ "                   THEN account.t_account"
             +"\n"+ "                   WHEN account.t_pairAccount = doc.t_debetAccount"
             +"\n"+ "                     OR account.t_pairAccount = doc.t_creditAccount"
             +"\n"+ "                   THEN account.t_pairAccount"
             +"\n"+ "               END                                                     AS t_account,"
             +"\n"+ "               CASE"
             +"\n"+ "                   WHEN account.t_account = doc.t_debetAccount"
             +"\n"+ "                     OR account.t_account = doc.t_creditAccount"
             +"\n"+ "                   THEN account.t_pairAccount"
             +"\n"+ "                   WHEN account.t_pairAccount = doc.t_debetAccount"
             +"\n"+ "                     OR account.t_pairAccount = doc.t_creditAccount"
             +"\n"+ "                   THEN account.t_account"
             +"\n"+ "               END                                                     AS t_pairAccount,"
             +"\n"+ "               account.t_account||account.t_pairAccount                AS t_pairId,"
             +"\n"+ "               SUM(CASE"
             +"\n"+ "                       WHEN account.t_account = doc.t_debetAccount"
             +"\n"+ "                         OR account.t_pairAccount = doc.t_debetAccount"
             +"\n"+ "                       THEN " + m_debitTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "                       WHEN account.t_account = doc.t_creditAccount"
             +"\n"+ "                         OR account.t_pairAccount = doc.t_creditAccount"
             +"\n"+ "                       THEN " + m_creditTurnsSign + "doc.t_inCoverSum"
             +"\n"+ "                       ELSE 0.0"
             +"\n"+ "                   END"
             +"\n"+ "                  )                                                    AS t_amount,"
             +"\n"+ "               doc.t_id                                                AS t_id,"
             +"\n"+ "               doc.t_number                                            AS t_number,"
             +"\n"+ "               doc.t_date                                              AS t_date,"
             +"\n"+ "               doc.t_debetAccount                                      AS t_debetAccount,"
             +"\n"+ "               doc.t_creditAccount                                     AS t_creditAccount,"
             +"\n"+ "               GROUPING(doc.t_number)                                  AS t_isAccountTotals,"
             +"\n"+ "               GROUPING(account.t_account)                             AS t_totals1,"
             +"\n"+ "               GROUPING(account.t_pairAccount)                         AS t_totals2"
             +"\n"+ "          FROM drepdocument_vw doc,"
             +"\n"+ "               dofraccounts_tmp account"
             +"\n"+ "         WHERE doc.t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
             +"\n"+ "           AND " + filter.isSuitable()
             +"\n"+ "         GROUP BY ROLLUP(account.t_account, account.t_pairAccount, (doc.t_id, doc.t_number, doc.t_date, doc.t_debetAccount, doc.t_creditAccount))"
             +"\n"+ "       ) doc"
             +"\n"+ " WHERE doc.t_totals1 = 0"
             +"\n"+ "   AND doc.t_totals2 = 0"
             +"\n"+ " ORDER BY t_pairId, t_isAccountTotals"
            ;

        var dataSet = TRsbDataset(query);
        dataSet.setFieldType("t_account",           V_STRING);
        dataSet.setFieldType("t_pairAccount",       V_STRING);
        dataSet.setFieldType("t_pairId",            V_STRING);
        dataSet.setFieldType("t_amount",            V_MONEY);
        dataSet.setFieldType("t_number",            V_STRING);
        dataSet.setFieldType("t_date",              V_DATE);
        dataSet.setFieldType("t_debetAccount",      V_STRING);
        dataSet.setFieldType("t_creditAccount",     V_STRING);
        dataSet.setFieldType("t_isAccountTotals",   V_INTEGER);

        m_protocolView.printDocumentsTableHeader(description);

        var amounts = RcbArray();
        var amount = $0.0;

        while (dataSet.moveNext())
            if (dataset.isAccountTotals == 1)
                amounts.push_back(RcbArray().initialize(dataSet.pairId, dataSet.amount));
            else
                m_protocolView.printDocumentString(dataSet);
                amount = amount + dataSet.amount;
            end;
        end;

        m_protocolView.printDocumentsTableFooter(dataset, amount);

        return amounts;
    end;

    private macro constructorTTurnsPairedPart7(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTTurnsPairedPart7(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для парных символов части 7.
 *
 * @since 08.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TPairedSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_accounts : RcbDatasource;

    private var m_turnsPart1 : RcbDatasource;
    private var m_turnsPart1Filter : RcbDatasourceFilter;

    private var m_turnsPart2 : RcbDatasource;
    private var m_turnsPart2Filter : RcbDatasourceFilter;

    private var m_turnsSpodPart1 : RcbDatasource;
    private var m_turnsSpodPart1Filter : RcbDatasourceFilter;

    private var m_turnsSpodPart2 : RcbDatasource;
    private var m_turnsSpodPart2Filter : RcbDatasourceFilter;

    // Формирует массив с данными по всем счетам, для которых есть хотя бы одна из сумм
    // Фактически, формирует декартово произведение массивов с суммой1 и суммой2
    private macro createAccountsData(amounts1 : Object, amounts2 : Object)
        var amounts = RcbArray();
        var i;
        var j;

        for (i, amounts1)
            var hasAmount2 = false;
            for (j, amounts2)
                if (i[0] == j[0])
                    amounts.push_back(RcbArray().initialize(i[0], i[1], j[1]));
                    hasAmount2 = true;
                end;
            end;

            if (not hasAmount2)
                amounts.push_back(RcbArray().initialize(i[0], i[1], $0.0));
            end;
        end;

        for (i, amounts2)
            var hasAmount = false;
            for (j, amounts)
                if (i[0] == j[0])
                    hasAmount = true;
                    break;
                end;
            end;

            if (not hasAmount)
                amounts.push_back(RcbArray().initialize(i[0], $0.0, i[1]));
            end;
        end;

        return amounts;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var pairedSymbol = m_dataSources.getTuneTable7().setKey(attribute.getValue().getSymbol()).getPairOfrSymbolMasks();

        m_accounts.setSavePairAccounts(filter.isSuitable()).getData(null, attribute, "Счета:");
        var isExistsOpenAccount = m_accounts.isExistsOpenAccount();

        m_turnsPart1Filter.clear().op("NOT").isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());
        m_turnsPart2Filter.clear().op("NOT").isSpod().op("AND").hasOfrSymbol(pairedSymbol);
        if (filter.isSuitable())
            m_turnsPart1Filter.op("AND").includePairedAccountsDocuments("account");
            m_turnsPart2Filter.op("AND").includePairedAccountsDocuments("account");
        else
            m_turnsPart1Filter.op("AND").excludePairedAccountsDocuments("account");
            m_turnsPart2Filter.op("AND").excludePairedAccountsDocuments("account");
        end;

        var amounts1 = m_turnsPart1.getData(m_turnsPart1Filter, attribute, "Проводки символа " + attribute.getValue().getSymbol() + " (сумма1)");
        var amounts2 = m_turnsPart2.getData(m_turnsPart2Filter, attribute, "Проводки символа " + pairedSymbol + " (сумма2)");

        var amount = $0.0;
        var pairedAmount = $0.0;

        for (var i, createAccountsData(amounts1, amounts2))
            var amount1 = i[1];
            var amount2 = i[2];

            if (TOfrParameters().isRollupSymbol())
                if (amount1 > amount2)
                    amount = amount + (amount1 - amount2);
                    pairedAmount = pairedAmount + $0.0;
                elif (amount1 < amount2)
                    amount = amount + $0.0;
                    pairedAmount = pairedAmount + (amount2 - amount1);
                else
                    amount = amount + $0.0;
                    pairedAmount = pairedAmount + $0.0;
                end;
            else
                amount = amount + amount1;
                pairedAmount = pairedAmount + amount2;
            end;
        end;

        var value;
        var pairedValue;

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodAmountPart1 = $0.0;
            var spodAmountPart2 = $0.0;
            var spodAmount = $0.0;
            var spodPairedAmount = $0.0;

            if (compareStrWithMasks(PAIRED_ACC_MASK_FOR_SPOD, attribute.getValue().getSymbol()) == 0)
                m_turnsSpodPart1Filter.clear().isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());
                spodAmountPart1 = m_turnsSpodPart1.getData(m_turnsSpodPart1Filter, attribute, null);

                m_turnsSpodPart2Filter.clear().isSpod().op("AND").hasOfrSymbol(pairedSymbol);
                spodAmountPart2 = m_turnsSpodPart2.getData(m_turnsSpodPart2Filter, attribute, null);

                if (TOfrParameters().isRollupSymbol())
                    if (spodAmountPart1 > spodAmountPart2)
                        spodAmount = spodAmountPart1 - spodAmountPart2;
                        spodPairedAmount = $0.0;
                    elif (spodAmountPart1 < spodAmountPart2)
                        spodAmount = $0.0;
                        spodPairedAmount = spodAmountPart2 - spodAmountPart1;
                    else
                        spodAmount = $0.0;
                        spodPairedAmount = $0.0;
                    end;
                else
                    spodAmount = spodAmountPart1;
                    spodPairedAmount = spodAmountPart2;
                end;
            end;

            value       = objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount + spodAmount, null, amount + spodAmount,
                                                                                                                      spodAmount, null, spodAmount, isExistsOpenAccount);
            pairedValue = objectFactoryInstance.createStandaloneAttributeValuePart1(pairedSymbol, pairedAmount + spodPairedAmount, null, pairedAmount + spodPairedAmount,
                                                                                                  spodPairedAmount, null, spodPairedAmount, isExistsOpenAccount);
        else
            value = objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, isExistsOpenAccount);
            pairedValue = objectFactoryInstance.createStandaloneAttributeValuePart1(pairedSymbol, pairedAmount, null, pairedAmount, isExistsOpenAccount);
        end;

        m_protocolView.printSymbolFooter(amount);

        return RcbArray().initialize(value, pairedValue);
    end;

    private macro constructorTPairedSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_accounts = TAccountsPart7("accounts", m_protocolView, m_dataSources);

        m_turnsPart1 = TTurnsPairedPart7("turnsPart1", m_protocolView, m_dataSources);
        m_turnsPart1.setDebitTurnsSign("-").setCreditTurnsSign("+");
        m_turnsPart1Filter = m_dataSources.getDataSourceFilters().getFilter("documents");

        m_turnsPart2 = TTurnsPairedPart7("turnsPart2", m_protocolView, m_dataSources);
        m_turnsPart2.setDebitTurnsSign("+").setCreditTurnsSign("-");
        m_turnsPart2Filter = m_dataSources.getDataSourceFilters().getFilter("documents");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpodPart1 = TTurnsNextYear("turnsSpodPart1", m_protocolView, m_dataSources);
            m_turnsSpodPart1.setDebitTurnsSign("-").setCreditTurnsSign("+");
            m_turnsSpodPart1Filter = m_dataSources.getDataSourceFilters().getFilter("documents");

            m_turnsSpodPart2 = TTurnsNextYear("turnsSpodPart1", m_protocolView, m_dataSources);
            m_turnsSpodPart2.setDebitTurnsSign("+").setCreditTurnsSign("-");
            m_turnsSpodPart2Filter = m_dataSources.getDataSourceFilters().getFilter("documents");
        end;
    end;

    constructorTPairedSymbolsValues(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов учета переноса накопленного уменьшения стоимости.
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TDecreaseSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_accounts : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsFilter : RcbDatasourceFilter;

    private var m_turnsSpod : RcbDatasource;
    private var m_turnsSpodFilter : RcbDatasourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        m_accounts.getData(null, attribute, null);
        m_turnsFilter.clear().op("NOT").isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());
        var amount = m_turns.getData(m_turnsFilter, attribute, null);
        var isExistsOpenAccount = m_accounts.isExistsOpenAccount();

        m_protocolView.printSymbolFooter(amount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodAmount = $0.0;

            if (compareStrWithMasks(DECREASE_MASK_FOR_SPOD, attribute.getValue().getSymbol()) == 0)
                m_turnsSpodFilter.clear().isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());

                spodAmount = m_turnsSpod.getData(m_turnsSpodFilter, attribute, null);
            end;

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount + spodAmount, null, amount + spodAmount,
                                                                                                                                     spodAmount, null, spodAmount, isExistsOpenAccount));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, isExistsOpenAccount));
        end;

    end;

    private macro constructorTDecreaseSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_accounts = TAccountsPart7("accounts", m_protocolView, m_dataSources);
        m_turns = TTurnsPart7("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("-").setCreditTurnsSign("+");
        m_turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsNextYear("turnsSpod", m_protocolView, m_dataSources);
            m_turnsSpod.setDebitTurnsSign("-").setCreditTurnsSign("+");
            m_turnsSpodFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        end;
    end;

    constructorTDecreaseSymbolsValues(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов учета переноса накопленного увеличения стоимости.
 *
 * @since 04.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TIncreaseSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_accounts : RcbDatasource;
    private var m_turns : RcbDatasource;
    private var m_turnsFilter : RcbDatasourceFilter;

    private var m_turnsSpod : RcbDatasource;
    private var m_turnsSpodFilter : RcbDatasourceFilter;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        m_accounts.getData(null, attribute, null);
        m_turnsFilter.clear().op("NOT").isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());
        var amount = m_turns.getData(m_turnsFilter, attribute, null);
        var isExistsOpenAccount = m_accounts.isExistsOpenAccount();

        m_protocolView.printSymbolFooter(amount);

        if (TOfrGlobal().isOfrWithSpodReport())
            var spodAmount = $0.0;

            if (compareStrWithMasks(INCREASE_MASK_FOR_SPOD, attribute.getValue().getSymbol()) == 0)
                m_turnsSpodFilter.clear().isSpod().op("AND").hasOfrSymbol(attribute.getValue().getSymbol());

                spodAmount = m_turnsSpod.getData(m_turnsSpodFilter, attribute, null);
            end;

            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount + spodAmount, null, amount + spodAmount,
                                                                                                                                     spodAmount, null, spodAmount, isExistsOpenAccount));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), amount, null, amount, isExistsOpenAccount));
        end;
    end;

    private macro constructorTIncreaseSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);

        m_accounts = TAccountsPart7("accounts", m_protocolView, m_dataSources);
        m_turns = TTurnsPart7("turns", m_protocolView, m_dataSources);
        m_turns.setDebitTurnsSign("+").setCreditTurnsSign("-");
        m_turnsFilter = m_dataSources.getDataSourceFilters().getFilter("documents");

        if (TOfrGlobal().isOfrWithSpodReport())
            m_turnsSpod = TTurnsNextYear("turnsSpod", m_protocolView, m_dataSources);
            m_turnsSpod.setDebitTurnsSign("+").setCreditTurnsSign("-");
            m_turnsSpodFilter = m_dataSources.getDataSourceFilters().getFilter("documents");
        end;
    end;

    constructorTIncreaseSymbolsValues(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81101.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81101_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s40000 = getValue("symbol", "40000", "rouble");
        m_protocolView.printComponentValue("Символ 40000", s40000);

        var s50000 = getValue("symbol", "50000", "rouble");
        m_protocolView.printComponentValue("Символ 50000", s50000);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s40000, s50000);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_81101_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81101_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81102.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81102_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s40000 = getValue("symbol", "40000", "rouble");
        m_protocolView.printComponentValue("Символ 40000", s40000);

        var s50000 = getValue("symbol", "50000", "rouble");
        m_protocolView.printComponentValue("Символ 50000", s50000);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s40000, s50000);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_81102_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81102_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81201.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81201_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s61101 = getValue("symbol", "61101", "total");
        m_protocolView.printComponentValue("Символ 61101", s61101);

        var s61102 = getValue("symbol", "61102", "total");
        m_protocolView.printComponentValue("Символ 61102", s61102);

        var s81101 = getValue("symbol", "81101", "total");
        m_protocolView.printComponentValue("Символ 81101", s81101);

        var s81102 = getValue("symbol", "81102", "total");
        m_protocolView.printComponentValue("Символ 81102", s81102);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101, s61102, s81101, s81102);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_81201_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81201_Values(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81202.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81202_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s61101 = getValue("symbol", "61101", "total");
        m_protocolView.printComponentValue("Символ 61101", s61101);

        var s61102 = getValue("symbol", "61102", "total");
        m_protocolView.printComponentValue("Символ 61102", s61102);

        var s81101 = getValue("symbol", "81101", "total");
        m_protocolView.printComponentValue("Символ 81101", s81101);

        var s81102 = getValue("symbol", "81102", "total");
        m_protocolView.printComponentValue("Символ 81102", s81102);

        var amount : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101, s61102, s81101, s81102);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, amount));
    end;

    private macro constructorTSymbol_81202_Values(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81202_Values(id, protocolView, dataSources);
end;


/**
 * ОФР. Источник данных для символа 81101 для пересчета итогов.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81101_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s40000Exact = getValue("symbol", "40000", "rouble");
        var s40000Scaled = getValue("symbol", "40000", "rouble", true);
        m_protocolView.printComponentValue("Символ 40000", s40000Exact);

        var s50000Exact = getValue("symbol", "50000", "rouble");
        var s50000Scaled = getValue("symbol", "50000", "rouble", true);
        m_protocolView.printComponentValue("Символ 50000", s50000Exact);

        var amountExact : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s40000Exact, s50000Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s40000Scaled, s50000Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_81101_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81101_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81102 для пересчета итогов.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81102_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s40000Exact = getValue("symbol", "40000", "rouble");
        var s40000Scaled = getValue("symbol", "40000", "rouble", true);
        m_protocolView.printComponentValue("Символ 40000", s40000Exact);

        var s50000Exact = getValue("symbol", "50000", "rouble");
        var s50000Scaled = getValue("symbol", "50000", "rouble", true);
        m_protocolView.printComponentValue("Символ 50000", s50000Exact);

        var amountExact : Money  = calculateSymbolValue(attribute.getValue().getSymbol(), s40000Exact, s50000Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s40000Scaled, s50000Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_81102_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81102_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81201 для пересчета итогов.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81201_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s61101Exact = getValue("symbol", "61101", "total");
        var s61101Scaled = getValue("symbol", "61101", "total", true);
        m_protocolView.printComponentValue("Символ 61101", s61101Exact);

        var s61102Exact = getValue("symbol", "61102", "total");
        var s61102Scaled = getValue("symbol", "61102", "total", true);
        m_protocolView.printComponentValue("Символ 61102", s61102Exact);

        var s81101Exact = getValue("symbol", "81101", "total");
        var s81101Scaled = getValue("symbol", "81101", "total", true);
        m_protocolView.printComponentValue("Символ 81101", s81101Exact);

        var s81102Exact = getValue("symbol", "81102", "total");
        var s81102Scaled = getValue("symbol", "81102", "total", true);
        m_protocolView.printComponentValue("Символ 81102", s81102Exact);

        var amountExact : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101Exact, s61102Exact, s81101Exact, s81102Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101Scaled, s61102Scaled, s81101Scaled, s81102Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_81201_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81201_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символа 81202 для пересчета итогов.
 *
 * @since 09.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (TSpecialSymbolDataSource) TSymbol_81202_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var s61101Exact = getValue("symbol", "61101", "total");
        var s61101Scaled = getValue("symbol", "61101", "total", true);
        m_protocolView.printComponentValue("Символ 61101", s61101Exact);

        var s61102Exact = getValue("symbol", "61102", "total");
        var s61102Scaled = getValue("symbol", "61102", "total", true);
        m_protocolView.printComponentValue("Символ 61102", s61102Exact);

        var s81101Exact = getValue("symbol", "81101", "total");
        var s81101Scaled = getValue("symbol", "81101", "total", true);
        m_protocolView.printComponentValue("Символ 81101", s81101Exact);

        var s81102Exact = getValue("symbol", "81102", "total");
        var s81102Scaled = getValue("symbol", "81102", "total", true);
        m_protocolView.printComponentValue("Символ 81102", s81102Exact);

        var amountExact : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101Exact, s61102Exact, s81101Exact, s81102Exact);
        var amountScaled : Money = calculateSymbolValue(attribute.getValue().getSymbol(), s61101Scaled, s61102Scaled, s81101Scaled, s81102Scaled);

        return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
    end;

    private macro constructorTSymbol_81202_Values_Recalculate(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTSymbol_81202_Values_Recalculate(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для символов при пересчете итогов по строкам
 *
 * @since 13.04.2017
 * @author GWW
 * @version 6.20.031.042
 */
private class (TSpecialSymbolDataSource) TRecalculatedRowTotal(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        m_protocolView.printFreeString("\tСимвол " + attribute.getValue().getSymbol());

        var amountExact  = nvl(attribute.getValue().getRoubleAmount().exact, 0)  + nvl(attribute.getValue().getEquivalentAmount().exact, 0);
        var amountScaled = nvl(attribute.getValue().getRoubleAmount().scaled, 0) + nvl(attribute.getValue().getEquivalentAmount().scaled, 0);

        var isOfrWithSpod = TOfrGlobal().isOfrWithSpodReport();

        if (isOfrWithSpod)
            var amountSpodExact  = nvl(attribute.getValue().getRoubleSpodAmount().exact, 0)  + nvl(attribute.getValue().getEquivalentSpodAmount().exact, 0);
            var amountSpodScaled = nvl(attribute.getValue().getRoubleSpodAmount().scaled, 0) + nvl(attribute.getValue().getEquivalentSpodAmount().scaled, 0);
        end;

        m_protocolView.printFreeString("\t\tТочное значение: " + amountExact);
        m_protocolView.printFreeString("\t\tОкругленное значение: " + amountScaled);

        if (isOfrWithSpod)
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled),
                                                                                                                                     null, null, TValue(amountSpodExact, amountSpodScaled)));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), null, null, TValue(amountExact, amountScaled)));
        end;
    end;

    private macro constructorTRecalculatedRowTotal(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTSpecialSymbolDataSource(id, protocolView, dataSources);
    end;

    constructorTRecalculatedRowTotal(id, protocolView, dataSources);
end;

/**
 * ОФР. Источник данных для итоговых символов групп, разделов, частей (1-4) и статей (доходы и расходы) при перерасчете итогов.
 * Категория для подсчета итогов (группа, раздел, часть, статья) определяется фильтром ИД
 *
 * @since 03.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
private class (RcbDataSource) TRecalculatedTotalSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    class TFilter(filter)
        private var m_filter = filter;

        macro isSuitable(value : Object)
            return execExp(m_filter.getFilter());
        end;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_protocolView.printSymbolHeader(attribute);

        var roubleAmountExact : Money = $0.0;
        var equivalentAmountExact = null;
        var roubleSpodAmountExact : Money = $0.0;
        var equivalentSpodAmountExact = null;

        var roubleAmountScaled : Money = $0.0;
        var equivalentAmountScaled = null;
        var roubleSpodAmountScaled : Money = $0.0;
        var equivalentSpodAmountScaled = null;

        var isOfrWithSpod = TOfrGlobal().isOfrWithSpodReport();

        var it = TOfrGlobal().getRcbReport().attributeValue("Символы").createValueIterator();
        it.setFilter(TFilter(filter));

        it.moveFirst();
        while (not it.isDone())
            var rouble = it.currentItem.fieldValue("rouble").exact;
            roubleAmountExact  = roubleAmountExact  + rouble;
            roubleAmountScaled = roubleAmountScaled + it.currentItem.fieldValue("rouble").scaled;

            if (isOfrWithSpod)
                roubleSpodAmountExact = roubleSpodAmountExact + nvl(it.currentItem.fieldValue("roubleSpod").exact, $0.0);
                roubleSpodAmountScaled = roubleSpodAmountScaled + nvl(it.currentItem.fieldValue("roubleSpod").scaled, $0.0);
            end;

            var equivalent = "X";
            if (    it.currentItem.fieldValue("equivalent").isDefined()
                and (it.currentItem.fieldValue("equivalent").exact != null)
               )
                equivalent = it.currentItem.fieldValue("equivalent").exact;
                equivalentAmountExact = nvl(equivalentAmountExact, $0.0) + equivalent;
                equivalentAmountScaled = nvl(equivalentAmountScaled, $0.0) + it.currentItem.fieldValue("equivalent").scaled;

                if (isOfrWithSpod)
                    equivalentSpodAmountExact = nvl(equivalentSpodAmountExact, $0.0) + nvl(it.currentItem.fieldValue("equivalentSpod").exact, $0.0);
                    equivalentSpodAmountScaled = nvl(equivalentSpodAmountScaled, $0.0) + nvl(it.currentItem.fieldValue("equivalentSpod").scaled, $0.0);
                end;
            end;

            m_protocolView.printFreeString("\tСимвол " + it.currentItem.fieldValue("symbol").exactAsString + ":\t" + rouble + ",\t" + equivalent);

            it.moveNext();
        end;

        if (isOfrWithSpod)
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), TValue(roubleAmountExact, roubleAmountScaled),
                                                                                                                                     TValue(equivalentAmountExact, equivalentAmountScaled),
                                                                                                                                     TValue(roubleAmountExact+ nvl(equivalentAmountExact, $0.0),roubleAmountScaled + nvl(equivalentAmountScaled, $0.0)),
                                                                                                                                     TValue(roubleSpodAmountExact, roubleSpodAmountScaled),
                                                                                                                                     TValue(equivalentSpodAmountExact, equivalentSpodAmountScaled),
                                                                                                                                     TValue(roubleSpodAmountExact+ nvl(equivalentSpodAmountExact, $0.0),roubleSpodAmountScaled + nvl(equivalentSpodAmountScaled, $0.0))));
        else
            return RcbArray().initialize(objectFactoryInstance.createStandaloneAttributeValuePart1(attribute.getValue().getSymbol(), TValue(roubleAmountExact, roubleAmountScaled),
                                                                                                                                     TValue(equivalentAmountExact, equivalentAmountScaled),
                                                                                                                                     TValue(roubleAmountExact+ nvl(equivalentAmountExact, $0.0),roubleAmountScaled + nvl(equivalentAmountScaled, $0.0))));
        end;

    end;

    private macro constructorTTRecalculatedTotalSymbolsValues(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTTRecalculatedTotalSymbolsValues(id, protocolView, dataSources);
end;

/**
 * ОФР. Контейнер ИД
 *
 * @since 08.12.2015
 * @author ABP
 * @version 6.20.031.032
 */
class (RcbDataSources) TOfrDataSources(protocolView : RcbCalculateProtocolView)
    private var m_tuneTable1_5 : RcbTuneTable;
    private var m_tuneTable7 : RcbTuneTable;

    macro getTuneTable1_5()
        return m_tuneTable1_5;
    end;

    macro getTuneTable7()
        return m_tuneTable7;
    end;

    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        const PROTOCOL_NAME = "symbols";
        const PROTOCOL7_NAME = "symbols7";

        // 15.12.2015 ABP ИД добавляются в соответствии с частотой использования. Хоть маленькая, но прибавка к производительности
        if (TOfrParameters().isRestsCalculating())
            m_dataSourcePool.push_back(TIncomeSymbolsValuesRestsAgl("income", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TExpensesSymbolsValuesRestsAgl("expenses", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        else
            m_dataSourcePool.push_back(TIncomeSymbolsValuesTurnsAgl("income", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TExpensesSymbolsValuesTurnsAgl("expenses", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        end;

        m_dataSourcePool.push_back(TRecalculatedRowTotal("recalculatedRowTotal", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TTotalSymbolsValues("totals", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TPairedSymbolsValues("paired", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));
        m_dataSourcePool.push_back(TDecreaseSymbolsValues("decrease", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));
        m_dataSourcePool.push_back(TIncreaseSymbolsValues("increase", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));

        if (TOfrParameters().isRestsCalculating())
            m_dataSourcePool.push_back(TSymbol_51101_ValuesRestsAgl("51101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TSymbol_51201_ValuesRestsAgl("51201", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TSymbol_51202_ValuesRestsAgl("51202", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        else
            m_dataSourcePool.push_back(TSymbol_51101_ValuesTurnsAgl("51101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TSymbol_51201_ValuesTurnsAgl("51201", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TSymbol_51202_ValuesTurnsAgl("51202", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        end;

        m_dataSourcePool.push_back(TSymbol_01000_Values("01000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_02000_Values("02000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_03000_Values("03000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_04000_Values("04000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61101_Values("61101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61102_Values("61102", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81101_Values("81101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81102_Values("81102", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81201_Values("81201", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81202_Values("81202", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TPrimarySymbolsList("primary", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSpecialSymbolsList("special", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TRecalculatedSymbolsList("recalculated", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TRecalculatedTotalSymbolsValues("recalculatedTotals", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TSymbol_01000_Values_Recalculate("01000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_02000_Values_Recalculate("02000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_03000_Values_Recalculate("03000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_04000_Values_Recalculate("04000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61101_Values_Recalculate("61101_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61102_Values_Recalculate("61102_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81101_Values_Recalculate("81101_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81102_Values_Recalculate("81102_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81201_Values_Recalculate("81201_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81202_Values_Recalculate("81202_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
    end;

    private macro constructorTOfrDataSources(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);

        m_tuneTable1_5 = objectFactoryInstance.createTuneTablePart1_5();
        m_tuneTable7 = objectFactoryInstance.createTuneTablePart7();
    end;

    constructorTOfrDataSources(protocolView);
end;

/**
 * ОФР со СПОД. Контейнер ИД
 *
 * @since 04.10.2016
 * @author
 * @version 6.20.031.037
 */
class (TOfrDataSources) TOfrWithSpodDataSources(protocolView : RcbCalculateProtocolView)
    private macro initialize()
        const PROTOCOL_NAME = "symbols";
        const PROTOCOL7_NAME = "symbols7";

        // 15.12.2015 ABP ИД добавляются в соответствии с частотой использования. Хоть маленькая, но прибавка к производительности
        if (TOfrParameters().isRestsCalculating())
            m_dataSourcePool.push_back(TIncomeSymbolsValuesRestsAgl("income", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TExpensesSymbolsValuesRestsAgl("expenses", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        else
            m_dataSourcePool.push_back(TIncomeSymbolsValuesTurnsAgl("income", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
            m_dataSourcePool.push_back(TExpensesSymbolsValuesTurnsAgl("expenses", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        end;

        m_dataSourcePool.push_back(TRecalculatedRowTotal("recalculatedRowTotal", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TTotalSymbolsValues("totals", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TPairedSymbolsValues("paired", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));
        m_dataSourcePool.push_back(TDecreaseSymbolsValues("decrease", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));
        m_dataSourcePool.push_back(TIncreaseSymbolsValues("increase", m_protocolView.getDataProtocolView(PROTOCOL7_NAME), this));

        m_dataSourcePool.push_back(TSymbol_51101_ValuesSpodAgl("51101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_51201_ValuesSpodAgl("51201", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_51202_ValuesSpodAgl("51202", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TSymbol_01000_Values("01000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_02000_Values("02000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_03000_Values("03000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_04000_Values("04000", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61101_Values("61101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61102_Values("61102", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81101_Values("81101", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81102_Values("81102", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81201_Values("81201", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81202_Values("81202", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TPrimarySymbolsList("primary", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSpecialSymbolsList("special", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TRecalculatedSymbolsList("recalculated", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TRecalculatedTotalSymbolsValues("recalculatedTotals", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));

        m_dataSourcePool.push_back(TSymbol_01000_Values_Recalculate("01000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_02000_Values_Recalculate("02000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_03000_Values_Recalculate("03000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_04000_Values_Recalculate("04000_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61101_Values_Recalculate("61101_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_61102_Values_Recalculate("61102_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81101_Values_Recalculate("81101_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81102_Values_Recalculate("81102_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81201_Values_Recalculate("81201_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
        m_dataSourcePool.push_back(TSymbol_81202_Values_Recalculate("81202_Recalculate", m_protocolView.getDataProtocolView(PROTOCOL_NAME), this));
    end;

    private macro constructorTOfrWithSpodDataSources(protocolView : RcbCalculateProtocolView)
        initTOfrDataSources(protocolView);
    end;

    constructorTOfrWithSpodDataSources(protocolView);
end;
