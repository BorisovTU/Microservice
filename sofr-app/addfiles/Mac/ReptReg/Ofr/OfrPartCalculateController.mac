/*
$Name:          OfrPartCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   ОФР. Классы контроллеров расчета разделов.
*/

private class (RcbPartCalculateController) TOfrPartCalculateController(reportCalculateController : Object, partId : String)
    private var m_protocolView;

    private macro getCalculateAttributeData(attributeId : String, functionName : String, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(m_part.getAttribute(dependencesAttributeIdPool.getCurrentItem()));
        end;

        return RcbCalculationAttributeData(m_part.getAttribute(attributeId),
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(attributeId)
                                                                                   )
                                                                ),
                                           RcbDependencesData(dependencesAttributePool)
                                          );
    end;

    private macro constructorTOfrPartCalculateController(reportCalculateController : Object, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_protocolView = m_dataSources.getProtocolView();
    end;

    constructorTOfrPartCalculateController(reportCalculateController, partId);
end;

class (TOfrPartCalculateController) TOfrPart1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    private var INCOME_MASK = "11101-11120,11201-11220,11301-11303,11401-11403,11501-11508,11601-11608,11701-11708,11801-11808,"
                            + "12101-12120,12201-12220,12301-12303,13101-13120,13201-13220,13301-13303,13401-13403,13501-13508,"
                            + "13601-13608,13701-13708,13801-13808,14101-14105,14201-14213,14301-14318,14401-14418,14501-14502,"
                            + "14601-14602,14701-14702,14801-14805,15101-15120,15201-15220,15301-15303,15401-15403,15501-15508,"
                            + "15601-15608,15701-15708,16101-16105,21101-21120,21201-21220,21301-21303,22101-22108,22201-22208,"
                            + "22301-22308,22401-22408,22501-22508,23101-23104,23201-23204,23301-23304,23401-23404,23501-23504,"
                            + "23601-23604,23701-23704,23801-23804,23901-23904,24101-24105,24201-24218,24301-24318,24401-24402,"
                            + "24501-24502,24601-24605,25101-25105,25201-25205,25301-25305,25401-25405,25501-25505,25601,26101-26106,"
                            + "26201-26206,26301-26306,26401-26405,26501-26505,27101-27104,27201-27204,27301-27304,27401-27409,"
                            + "27501-27504,27601-27604,27701-27704,27801-27804,27901-27904,28101-28104,28201-28204,28301-28303,"
                            + "28401-28402,28501-28504,28601-28602,28701-28704,28801-28803,29101-29107,29201-29208,29301-29304,"
                            + "29401-29407"
                  ;

    private var EXPENSES_MASK = "31101-31105,31201-31213,31301-31318,31401-31418,31501-31502,31601-31602,31701-31702,31801-31805,"
                              + "31901-31903,32101-32105,32201-32218,32301-32318,32401-32402,32501-32502,32601-32605,33101-33120,"
                              + "33201-33220,33301-33303,33401-33403,33501-33508,33601-33608,33701-33708,33801-33808,34101-34120,"
                              + "34201-34220,34301-34308,34401-34408,34501-34508,34601-34608,35101-35120,35201-35220,35301-35303,"
                              + "35401-35403,35501-35508,35601-35608,35701-35708,35801-35808,36101-36105,36201-36213,"
                              + "36301-36318,36401-36418,36501-36502,36601-36602,36701-36702,36801-36805,37101-37120,37201-37220,"
                              + "37301-37303,37401-37403,37501-37508,37601-37608,37701-37708,41101-41120,41201-41220,41301-41303,"
                              + "42101-42108,42201-42208,42301-42308,42401-42408,42501-42508,43101-43104,43201-43204,43301-43304,"
                              + "43401-43404,43501-43504,44101-44105,44201-44218,44301-44318,44401-44402,44501-44502,44601-44605,"
                              + "45101-45105,45201-45205,45301-45305,45401-45405,45501-45505,45601,46101-46106,46201-46206,46301-46306,"
                              + "46401-46405,46501-46505,47101-47109,47201-47204,47301-47304,47401-47402,47501-47506,47601-47602,"
                              + "47701-47704,47801-47803,48101-48113,48201-48209,48301-48303,48401-48414,48501-48505,48601-48611"
                  ;

    private var PAIRED_WITH_ACC_MASK = "711*,713*,716*";

    private var PAIRED_WO_ACC_MASK = "715*,717*";

    private var DECREASE_MASK = "712*,714*,718*,719*";

    private var INCREASE_MASK = "722*,724*,728*,729*";

    initTOfrPartCalculateController(reportCalculateController, TOfrGlobal().getPart1Id());

    private var m_dataProtocolView = m_protocolView.getDataProtocolView("symbols");

    private macro setAttributeValues(attribute : object, value : object)
        attribute.setRoubleAmount(value.getRoubleAmount().exact).setEquivalentAmount(value.getEquivalentAmount().exact).setTotalAmount(value.getTotalAmount().exact);
        attribute.setExistsOpenAccountFlag(value.isExistsOpenAccount);
    end;

    macro getDataProtocolView()
        return m_dataProtocolView;
    end;

    macro calculateAttribute(attributeId)
        m_dataProtocolView.printSymbolBeginProcess(attributeId);

        var attribute = m_part.getAttribute(attributeId);

        var symbol = attribute.getValue().getSymbol();
        var symbolLength = strlen(symbol);

        var datasourceName : String;
        var filter : Object;

        if ((symbolLength == 5) and (compareStrWithMasks(INCOME_MASK, symbol) == 0)) // символы доходов
            datasourceName = "income";
            filter = null;
        elif ((symbolLength == 5) and (compareStrWithMasks(EXPENSES_MASK, symbol) == 0)) // символы расходов
            datasourceName = "expenses";
            filter = null;
        elif (symbol == "51101")
            datasourceName = "51101";
            filter = null;
        elif (symbol == "51201")
            datasourceName = "51201";
            filter = null;
        elif (symbol == "51202")
            datasourceName = "51202";
            filter = null;
        elif ((symbolLength == 5) and (compareStrWithMasks(PAIRED_WITH_ACC_MASK, symbol) == 0)) // часть 7, парные символы с парными счетами
            datasourceName = "paired";
            filter = m_dataSouceFilters.getFilter("symbols").usePairedAccounts();
        elif ((symbolLength == 5) and (compareStrWithMasks(PAIRED_WO_ACC_MASK, symbol) == 0)) // часть 7, парные символы без парных счетов
            datasourceName = "paired";
            filter = m_dataSouceFilters.getFilter("symbols").op("NOT").usePairedAccounts();
        elif ((symbolLength == 5) and (compareStrWithMasks(DECREASE_MASK, symbol) == 0)) // часть 7, накопленное уменьшение стоимости
            datasourceName = "decrease";
            filter = null;
        elif ((symbolLength == 5) and (compareStrWithMasks(INCREASE_MASK, symbol) == 0)) // часть 7, накопленное увеличение стоимости
            datasourceName = "increase";
            filter = null;
        elif ((symbolLength == 3) and (index(symbol, "_") == 0)) // итоги по группам
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToGroup(symbol);
        elif ((symbolLength == 2)) // итоги по разделам частей 1-5
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToSection(symbol);
        elif ((symbolLength == 1)) // итоги по частям 1-5
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToPart(symbol);
        elif (symbol == "1_2") // всего доходы
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToIncome();
        elif (symbol == "3_4") // всего расходы
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToExpenses();
        elif (symbol == "01000")
            datasourceName = "01000";
            filter = null;
        elif (symbol == "02000")
            datasourceName = "02000";
            filter = null;
        elif (symbol == "03000")
            datasourceName = "03000";
            filter = null;
        elif (symbol == "04000")
            datasourceName = "04000";
            filter = null;
        elif (symbol == "61101")
            datasourceName = "61101";
            filter = null;
        elif (symbol == "61102")
            datasourceName = "61102";
            filter = null;
        elif (symbol == "40000") // итоги по разделу 1 части 7
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToSection("71");
        elif (symbol == "50000") // итоги по разделу 2 части 7
            datasourceName = "totals";
            filter = m_dataSouceFilters.getFilter("symbols").isSatisfiesToSection("72");
        elif (symbol == "81101")
            datasourceName = "81101";
            filter = null;
        elif (symbol == "81102")
            datasourceName = "81102";
            filter = null;
        elif (symbol == "81201")
            datasourceName = "81201";
            filter = null;
        elif (symbol == "81202")
            datasourceName = "81202";
            filter = null;
        else
            m_protocolView.printLine("Неизвестный символ " + symbol);
            return;
        end;

        var value;

        var data = m_datasources.getDatasource(datasourceName).getData(filter, attribute, "");
        data.moveFirst();
        if (data.moveNext())
            value = data.getCurrentItem();
            setAttributeValues(attribute.getValue(), value);
        end;

        m_dataProtocolView.printSymbolEndProcess();

        m_dataProtocolView.printSymbolBeginProcess(attributeId, " (paired symbols)");
        while (data.moveNext())
            value = data.getCurrentItem();

            symbol = value.getSymbol();

            var additionalAttribute = m_part.getAttribute(symbol);
            if (additionalAttribute == null)
                var storage = m_part.getPartCompositeValue().addValue();
                var attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setSymbol(symbol);
                setAttributeValues(attributeValue, value);
                var attributeProperties = objectFactoryInstance.createAttributeProperties(m_part, storage).setCurrencyFlag(attribute.getProperties().isCurrency());

                m_part.addAttribute(symbol, attributeValue, attributeProperties);
            else
                setAttributeValues(additionalAttribute.getValue(), value);
            end;
        end;
        m_dataProtocolView.printSymbolEndProcess();
    end;

    private macro processSymbolsList(listName : String)
        for (var i, m_datasources.getDatasource(listName).getData())
            var symbol = i[0];

            message("Инициализация символа " + symbol);

            var storage = m_part.getPartCompositeValue().addValue();
            var attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setSymbol(symbol);
            var attributeProperties = objectFactoryInstance.createAttributeProperties(m_part, storage).setCurrencyFlag(i[1]).setAccountMask(i[2]);

            m_part.addAttribute(symbol, attributeValue, attributeProperties);

            m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(symbol, "calculateAttribute"));
        end;
    end;

    macro execute()
        m_protocolView.printLine("");

        m_dataProtocolView.printSymbolBeginProcess(null, "init primary symbols");
        processSymbolsList("primary");
        m_dataProtocolView.printSymbolEndProcess();

        m_dataProtocolView.printSymbolBeginProcess(null, "init special symbols");
        processSymbolsList("special");
        m_dataProtocolView.printSymbolEndProcess();

        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;
end;

class (TOfrPart1CalculateController) TOfrPart1CalculateController_4556(reportCalculateController : Object /*TReportCalculateController*/)
    initTOfrPart1CalculateController(reportCalculateController);

    INCOME_MASK = "11101-11120,11201-11220,11301-11303,11401-11403,11501-11508,11601-11608,11701-11708,11801-11808,"
                + "12101-12120,12201-12220,12301-12303,13101-13120,13201-13220,13301-13303,13401-13403,13501-13508,"
                + "13601-13608,13701-13708,13801-13808,14101-14105,14201-14213,14301-14318,14401-14418,14501-14502,"
                + "14601-14602,14701-14702,14801-14805,15101-15120,15201-15220,15301-15303,15401-15403,15501-15508,"
                + "15601-15608,15701-15708,16101-16105,17101-17120,17201-17220,17301-17303,17401-17403,17501-17508,"
                + "17601-17608,17701-17708,21101-21120,21201-21220,21301-21303,22101-22108,22201-22208,21401-21420,"
                + "21501-21520,21601-21603,22301-22308,22401-22408,22501-22508,23101-23104,23201-23204,23301-23304,"
                + "23501-23504,22601-22608,23601-23604,23701-23704,23801-23804,23901-23904,24101-24105,24201-24218,"
                + "24301-24318,24401-24402,24501-24502,24601-24605,25101-25105,25201-25205,25301-25305,25401-25405,"
                + "25501-25505,25601-25627,26101,24701-24741,24801-24804,24901-24905,26201,26301,26401,26501,"
                + "27101-27104,27201-27204,27301-27304,27401-27409,27501-27504,27601-27604,27701-27704,27801-27804,"
                + "27901-27904,28101-28104,28201-28205,28301-28303,28401-28402,28501-28504,28601-28602,28701-28704,"
                         + "28801-28803,29101-29107,29201-29208,29301-29304,29401-29407";

    EXPENSES_MASK = "31101-31105,31201-31213,31301-31318,31401-31418,31501-31502,31601-31602,31701-31702,31801-31805,"
                  + "31901-31903,32101-32105,32201-32218,32301-32318,32401-32402,32501-32502,32601-32605,33101-33120,"
                  + "33201-33220,33301-33303,33401-33403,33501-33508,33601-33608,33701-33708,33801-33808,34101-34120,"
                  + "34201-34220,34301-34308,34401-34408,34501-34508,34601-34608,35101-35120,35201-35220,35301-35303,"
                  + "35401-35403,35501-35508,35601-35608,35701-35708,35801-35808,36101-36105,36201-36213,36301-36318,"
                  + "36401-36418,36501-36502,36601-36602,36701-36702,36801-36805,37101-37120,37201-37220,37301-37303,"
                  + "37401-37403,37501-37508,37601-37608,37701-37708,41101-41120,41201-41220,41301-41303,38101-38120,"
                  + "38201-38220,38301-38303,38401-38403,38501-38508,38601-38608,38701-38708,41401-41420,41501-41520,"
                  + "41601-41603,42601-42608,42101-42108,42201-42208,42301-42308,42401-42408,42501-42508,43101-43104,"
                  + "43201-43204,43301-43304,43501-43504,44101-44105,44201-44218,44301-44318,44401-44402,44501-44502,"
                  + "44601-44605,44701-44741,44801-44804,44901-44905,45101-45105,45201-45205,45301-45305,45401-45405,"
                  + "45501-45505,45601-45627,46101,46201,46301,46401,46501,47101-47109,47201-47204,47301-47305,"
                  + "47401-47402,47501-47506,47601-47602,47701-47704,47801-47803,48101-48113,48201-48209,48301-48303,"
                         + "48401-48414,48501-48505,48601-48611";

    PAIRED_WITH_ACC_MASK = "711*,713*,716*,71803,71806";
end;

class (TOfrPart1CalculateController) TOfrSpodPart1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    private macro processSymbolsList(listName : String)
        for (var i, m_datasources.getDatasource(listName).getData())
            var symbol = i[0];

            message("Инициализация символа " + symbol);
            var storage = m_part.getPartCompositeValue().addValue();
            var attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setSymbol(symbol);
            var attributeProperties = objectFactoryInstance.createAttributeProperties(m_part, storage).setCurrencyFlag(i[1]).setAccountMask(i[2]).setAccountMaskForSpod(i[3]);

            m_part.addAttribute(symbol, attributeValue, attributeProperties);

            m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(symbol, "calculateAttribute"));
        end;
    end;

    private macro setAttributeValues(attribute : object, value : object)

        attribute.setRoubleAmount(value.getRoubleAmount().exact).setEquivalentAmount(value.getEquivalentAmount().exact).setTotalAmount(value.getTotalAmount().exact).
                  setRoubleSpodAmount(value.getRoubleSpodAmount().exact).setEquivalentSpodAmount(value.getEquivalentSpodAmount().exact).setTotalSpodAmount(value.getTotalSpodAmount().exact);
        attribute.setExistsOpenAccountFlag(value.isExistsOpenAccount);
    end;

    macro contstructorTOfrSpodPart1CalculateController(reportCalculateController : Object)
        initTOfrPart1CalculateController(reportCalculateController);
    end;

    contstructorTOfrSpodPart1CalculateController(reportCalculateController);
end;
