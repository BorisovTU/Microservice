/*
$Name:          OfrCalculateProtocolView.mac
$Module:        Отчеты ЦБ
$Description:   ОФР. Классы протоколов расчета.
*/

import ofstream;

//private class TTimeCounter(testCaption, event)
//    private const MAX_STORAGE_SIZE = 100000;
//
//    private var m_fromTime;
//    private var m_tillTime;
//
//    private var m_testCaption;
//    private var m_event;
//
//    private var m_storageTestCaptionArray;
//    private var m_storageEventArray;
//    private var m_storageFromTimeArray;
//    private var m_storageTillTimeArray;
//    private var m_storageIndex;
//
//
//    macro start(event)
//        m_fromTime = time();
//        m_storageEventArray[m_storageIndex] = event;
//    end;
//
//    macro stop()
//        m_tillTime = time();
//
//        m_storageFromTimeArray[m_storageIndex] = m_fromTime;
//        m_storageTillTimeArray[m_storageIndex] = m_tillTime;
//
//        m_storageIndex = m_storageIndex + 1;
//    end;
//
//    macro clearDbStorage()
//        sql_execute("TRUNCATE TABLE timelog");
//    end;
//
//    macro constructor(testCaption, event)
//
//        m_testCaption = testCaption;
//        m_event = event;
//
//        m_storageTestCaptionArray = TArray(MAX_STORAGE_SIZE);
//        m_storageEventArray       = TArray(MAX_STORAGE_SIZE);
//        m_storageFromTimeArray    = TArray(MAX_STORAGE_SIZE);
//        m_storageTillTimeArray    = TArray(MAX_STORAGE_SIZE);
//
//        var i = 0;
//        while (i < MAX_STORAGE_SIZE)
//            m_storageTestCaptionArray[i] = m_testCaption;
//            m_storageEventArray[i]       = m_event;
//
//            i = i + 1;
//        end;
//
//        m_storageIndex = 0;
//
//    end;
//
//    macro destructor()
//        if (m_storageIndex > 0)
//
//            var i = 0;
//            while (i < m_storageIndex)
//                m_storageFromTimeArray[i] = int(m_storageFromTimeArray[i]);
//                m_storageTillTimeArray[i] = int(m_storageTillTimeArray[i]);
//
//                i = i + 1;
//            end;
//
//            m_storageTestCaptionArray.size = m_storageIndex;
//            m_storageEventArray.size       = m_storageIndex;
//            m_storageFromTimeArray.size    = m_storageIndex;
//            m_storageTillTimeArray.size    = m_storageIndex;
//
//            var query = "INSERT INTO timelog"
//               + "\n" + "("
//               + "\n" + "    test_caption,"
//               + "\n" + "    event,"
//               + "\n" + "    fromTime,"
//               + "\n" + "    tillTime"
//               + "\n" + ")"
//               + "\n" + "VALUES"
//               + "\n" + "("
//               + "\n" + "    ?,"
//               + "\n" + "    ?,"
//               + "\n" + "    ?,"
//               + "\n" + "    ?"
//               + "\n" + ")"
//            ;
//
//            var inserter = RsbSQLInsert(query, 4, m_storageIndex);
//
//            inserter.addParam(V_STRING,  m_storageTestCaptionArray, 1024);
//            inserter.addParam(V_STRING,  m_storageEventArray, 1024);
//            inserter.addParam(V_INTEGER, m_storageFromTimeArray);
//            inserter.addParam(V_INTEGER, m_storageTillTimeArray);
//
//            inserter.insert();
//
//            sql_execute("COMMIT");
//
//        end;
//    end;
//
//    constructor(testCaption, event);
//end;

private class TTimeCounter(testCaption, event)
    macro start(event)
    end;

    macro stop()
    end;

    macro clearDbStorage()
    end;

    macro constructor(testCaption, event)
    end;

    macro destructor()
    end;

    constructor(testCaption, event);
end;


private class (RcbDataProtocolView) TOfrProtocolData(id : String)
    private const DELIMITER = "\t";

    private var m_stream : Object;
    private var m_isHeaderPrinted : Bool;

    private macro initialize()
    end;

    macro printBottom(dataset, amount)
        printString("");
    end;

    macro getFileName()
        var name = m_stream.getFileName();
        var dotIndex = strlen(name);
        while ((dotIndex > 0) and (substr(name, dotIndex, 1) != "."))
            dotIndex = dotIndex - 1;
end;
        if (dotIndex == 0)
            dotIndex = strlen(name) + 1;
    end;
        strset(name, dotIndex, "_");
        name = name + ".csv";

        return name;
    end;

    macro save()
        m_stream.save(getFileName());
    end;

    macro printString()
        var i = 1;
        var p = null;
        var str = "";

        while (getParm(i, p))
            str = str + DELIMITER + "\"" + p + "\"";
            i = i + 1;
    end;
        str = substr(str, 2);

        m_stream.setOutputFile();
        println(str);
        m_stream.resetOutputFile();
    end;

    private macro constructorTOfrProtocolData(id : String)
        initRcbDataProtocolView(id);
        m_stream = TOfstream("ofr_calculate_" + nvl(id, ""));
        m_isHeaderPrinted = false;
end;

    constructorTOfrProtocolData(id);
    end;

private class (TOfrProtocolData) TOfrAccountsProtocolData(id : String)
    macro printLine(str)
        println(str);
    end;

    macro printHead(description, symbol)
        printString("id Счета", "Счет", "Наименование счета", "Входящий остаток", "Исходящий остаток");
    end;

    macro printAccountString(dataSet : Object)
        printString(dataSet.accountId, dataSet.account, dataSet.name, dataSet.inRest, dataSet.outRest);
    end;

    private macro constructorTOfrAccountsProtocolData(id : String)
        initTOfrProtocolData(id);
    end;

    constructorTOfrAccountsProtocolData(id);
    end;

private class (TOfrProtocolData) TOfrAccounts7ProtocolData(id : String)
    macro printHead(description)
        printString("Id Счета", "Счет", "Парный счет");
    end;

    macro printAccountString(dataSet)
        printString(dataSet.accountId, dataSet.account, dataSet.pairAccount);
    end;

    private macro constructorTOfrAccounts7ProtocolData(id : String)
        initTOfrProtocolData(id, true);
    end;

    constructorTOfrAccounts7ProtocolData(id);
    end;

private class (TOfrProtocolData) TOfrDocumentsProtocolData(id : String)
    macro printHead(description : String)
        printString(nvl(description, ""));
        printString("Id Проводки", "Номер", "Дата", "Счет по дебету", "Счет по кредиту", "Сумма", "Счет");
    end;

    macro printDocumentString(dataSet : Object)
        printString(dataSet.id,
                    dataSet.number,
                    dataSet.date,
                    dataSet.debetAccount,
                    dataSet.creditAccount,
                    dataSet.amount,
                    dataSet.account
                   );
    end;

    private macro constructorTOfrDocumentsProtocolData(id : String)
        initTOfrProtocolData(id, true);
    end;

    constructorTOfrDocumentsProtocolData(id);
    end;

private class (TOfrProtocolData) TOfrDocuments7ProtocolData(id : String)
    macro printHead(description)
        printString(ternary(description == null, "Проводки:", description));
        printString("Счет", "Парный счет", "Id проводки", "Номер", "Счет по дебету", "Счет по кредиту", "Дата", "Сумма");
    end;

    macro printDocumentString(dataset)
        printString(dataset.account, dataset.pairAccount, dataSet.id, dataset.number, dataset.debetAccount, dataset.creditAccount, dataset.date, dataset.amount);
    end;

    private macro constructorTOfrDocuments7ProtocolData(id : String)
        initTOfrProtocolData(id, true);
    end;

    constructorTOfrDocuments7ProtocolData(id);
end;

private class (TOfrProtocolData) TSymbolsProtocolData(id : String)
    private var m_timelogSymbCalc : TTimeCounter;
    private var m_timelogSymbProcess : TTimeCounter;

    macro printFreeString(str)
        println(str);
    end;

    macro printSymbolBeginProcess(symbol, details)
        symbol = nvl(symbol, "");
        m_timelogSymbProcess.start(symbol + nvl(details, ""));
    end;

    macro printSymbolEndProcess()
        m_timelogSymbProcess.stop();
    end;

    macro printSymbolHeader(attribute : Object)
        printString("Символ: " + attribute.getValue().getSymbol());
        m_timelogSymbCalc.start(attribute.getValue().getSymbol());
    end;

    macro printSymbolsHeader(attribute : Object)
        printString("Символ", "Рубли", "Эквивалент", "Итого");
    end;

    macro printSymbolFooter()
        m_timelogSymbCalc.stop();
    end;

    macro printSymbolValue(symbol : String, rouble : String, equivalent : String, total : String)
        printString(symbol, rouble, equivalent, total);
        end;

    macro printComponentValue(description : String, value : String)
        printString(description, value);
    end;

    macro printSymbolAlgNotPresent(symbol)
        printFreeString("Алгоритм вычисления значения символа " + symbol + " не описан в ТЗ");
    end;

    private macro constructorTSymbolsProtocolData(id : String)
        initTOfrProtocolData(id);

        m_timelogSymbCalc = TTimeCounter("SymbCalc", "");
        m_timelogSymbProcess = TTimeCounter("SymbProcess", "");

        TTimeCounter().clearDbStorage();
    end;

    constructorTSymbolsProtocolData(id);
end;

private class (RcbDataProtocolView) TOfrSymbolsProtocolData(id : String, symbols : TOfrProtocolData, accounts : TOfrProtocolData, documents : TOfrProtocolData)
    private var m_accounts : TOfrProtocolData;
    private var m_documents : TOfrProtocolData;
    private var m_symbols : TOfrProtocolData;

    private macro initialize()
    end;

    macro printBottom(dataset, amount)
    end;

    macro printFreeString(str)
        m_symbols.printString(str);
    end;

    macro printAccountsTableHeader(description, symbol)
        m_accounts.printHead(description, symbol);
    end;

    macro printAccountString(dataset)
        m_accounts.printAccountString(dataset);
    end;

    macro printAccountsTableFooter(dataset, amount)
        m_accounts.printBottom(dataset, amount);
    end;

    macro printDocumentsTableHeader(description)
        m_documents.printHead(description);
    end;

    macro printDocumentString(dataset)
        m_documents.printDocumentString(dataSet);
    end;

    macro printDocumentsTableFooter(dataset, amount)
        m_documents.printBottom(dataset, amount);
    end;

    macro printSymbolBeginProcess(symbol, details)
        m_symbols.printSymbolBeginProcess(symbol, details);
    end;

    macro printSymbolEndProcess()
        m_symbols.printSymbolEndProcess();
    end;

    macro printSymbolHeader(attribute : Object)
        m_symbols.printSymbolHeader(attribute);
    end;

    macro printSymbolFooter()
        m_symbols.printSymbolFooter();
    end;

    macro printSymbolsHeader()
        m_symbols.printSymbolsHeader();
    end;

    macro printSymbolValue(symbol : String, rouble : String, equivalent : String, total : String)
        m_symbols.printSymbolValue(symbol, rouble, equivalent, total);
    end;

    macro printComponentValue(description : String, value : String)
        m_symbols.printComponentValue(description, value);
    end;

    macro printSymbolAlgNotPresent(symbol)
        m_symbols.printSymbolAlgNotPresent(symbol);
    end;

    macro getProtocolFileName()
        return m_symbols.getFileName();
    end;

    macro save()
        m_symbols.save();
    end;

    private macro constructorTOfrSymbolsProtocolData(id : String, symbols : RcbDataProtocolView, accounts : RcbDataProtocolView, documents : RcbDataProtocolView)
        initRcbDataProtocolView(id);

        m_accounts = accounts;
        m_documents = documents;
        m_symbols = symbols;
    end;


    constructorTOfrSymbolsProtocolData(id, symbols, accounts, documents);
end;

class (RcbCalculateProtocolView) TOfrCalculateProtocolView(protocolName : String)
    private macro initialize()
        m_dataProtocolViewPull.push_back(TOfrSymbolsProtocolData("symbols", TSymbolsProtocolData(), TOfrAccountsProtocolData(), TOfrDocumentsProtocolData()));
        m_dataProtocolViewPull.push_back(TOfrSymbolsProtocolData("symbols7", TSymbolsProtocolData(), TOfrAccounts7ProtocolData(), TOfrDocuments7ProtocolData()));
    end;

    private macro constructorTOfrCalculateProtocolView(protocolName : String)
        initRcbCalculateProtocolView(null, protocolName);
    end;

    constructorTOfrCalculateProtocolView(protocolName);
end;
