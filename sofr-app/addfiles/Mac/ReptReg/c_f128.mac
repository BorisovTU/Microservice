/*
$Name:          c_f128.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 128. Расчет
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Расчет формы 128

   CREATED : 14.03.05 Sarkisova

   MODIFICATIONS: 8.11.05 Лузгин - интеграция с МБК
   NOTES:

└─────────────────────────────────────────────────────────────────────────- */
import ReptCBCommon, FIInter, RsbDataSet, Chk_Regd, acc_lib, lib_date, cb_sql;
import DepartmentFilter;
import rcb_bo;
import SbCrdInter;
import rcb_lib;

import sum_128_129;
import rcbconst;
import p_f128;

import testLib;

import rcbLibrary;

private const AVERAGE_TERM_ARITHMETIC_ROUND_KIND    = 0;
private const AVERAGE_TERM_FLOOR_ROUND_KIND         = 1;

class TReportController()

    const RUR_CODE    = "810", RUR_PART = 1,
          RUR_CODE_OR = "643",
          USD_CODE    = "840", USD_PART = 2,
          EUR_CODE    = "978", EUR_PART = 3,

          ЮЛ = "ЮЛ", ФЛ = "ФЛ";

    var RUR_FIID,
        RUR_FIID_OR,
        USD_FIID,
        EUR_FIID;

    var Маска_ФЛ,
        Маска_ЮЛ;

    var SrokName, SrokShifr;

    var ИмяФайлаПротокола;

    private macro getCreditTypeQuery() : String
        return "WITH reportData"
         +"\n"+"AS"
         +"\n"+"       (SELECT tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               contract.t_contragentId                            AS t_contractorId,"
         +"\n"+"               (CASE"
         +"\n"+"                  WHEN party.t_isPhisical = 1"
         +"\n"+"                      THEN 'ФЛ'"
         +"\n"+"                  WHEN party.t_isPhisical = 0 AND party.t_isBank = 0"
         +"\n"+"                       THEN 'ЮЛ'"
         +"\n"+"                  ELSE CHR(1)"
         +"\n"+"                END)                                              AS t_contragentCode,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               operation.t_currencyId                             AS t_currencyId,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               contract.t_departmentId                            AS t_FNCash,"
         +"\n"+"               operation.t_interestRate                           AS t_interestRate,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               DECODE(party.t_isEmployer, 1, 'X', CHR(0))         AS t_isContractorEmployer,"
         +"\n"+"               DECODE(party.t_isPhisical, 1, 'X', CHR(0))         AS t_isContractorPhysical,"
         +"\n"+"               (CASE operation.t_currencyId"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '810') THEN 1"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '840') THEN 2"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '978') THEN 3"
         +"\n"+"                    ELSE 0"
         +"\n"+"                END)                                              AS t_part,"
         +"\n"+"               (CASE"
         +"\n"+"                    WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                    WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                    WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                    WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                    WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                    WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                    ELSE '___'"
         +"\n"+"               END)                                               AS t_srok,"
         +"\n"+"               operation.t_roubleSum                              AS t_roubleSum,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               contract.t_branchId                                AS t_territorialStruct,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               operation.t_id                                     AS t_operationId"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number)";

    end;

    macro FindFIID(code)

        var fininstr = TRsbDataSet("SELECT t_fiId FROM dfininstr_dbt WHERE t_fi_code = " + GetSQLString(code));

        if (fininstr.moveNext())
            return fininstr.fiId;
        else
            return -1;
      end;

    end;

    macro Init()
        var dataSetTuneTable;
        var stringTuneTable = "";
        var filter = "";
      SQL_Truncate( "dtemp_128_tmp"  );

      RUR_FIID    = FindFIID( RUR_CODE );
      USD_FIID    = FindFIID( USD_CODE );
      EUR_FIID    = FindFIID( EUR_CODE );

        if (rcbApplication.currentReport.context.period.endDate >= RCB_I2835_DATE4)
            filter = " t_instructionDate = " + getSqlDate(RCB_I2835_DATE4);
        else
            filter = " 1 = 1 ";
      end;
      filter = filter + " AND t_isClosed = 0 ";

      stringTuneTable =  "SELECT *"
      + "\n" +           " FROM  "
      + "\n" +           "     dSymb128_dbt "
      + "\n" +           " WHERE " + filter
      + "\n" +           " ORDER BY "
      + "\n" +           "     t_szContragent, t_instructionDate DESC";

      dataSetTuneTable = TRsbDataSet(stringTuneTable);

      while (dataSetTuneTable.MoveNext())
          if (dataSetTuneTable.szContragent == ФЛ)
              Маска_ФЛ = dataSetTuneTable.szBalance;
          else
              Маска_ЮЛ = dataSetTuneTable.szBalance;
          end;
      end;

      sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(RcbApplication.currentReport.context.period.beginDate)+", 'DD.MM.YYYY')))");
      sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(RcbApplication.currentReport.context.period.endDate)+", 'DD.MM.YYYY')))");

    end;

    private macro getDataWithTypeProlingationOrPayment(creditTypeFilter : string)
        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype)"
            +"\n"+  getCreditTypeQuery()
            +"\n"+  "SELECT t_part,"                  //t_iPart
            +"\n"+  "       t_contragentCode,"        //t_szContragent,"
            +"\n"+  "       t_srok,"                  //t_szSrok,"
            +"\n"+  "       t_creditNumberForReport," //t_szContractNumber
            +"\n"+  "       t_cbAccountNumber,"       //t_cbAccountNumber
            +"\n"+  "       t_type,"                  //t_operationTypedId
            +"\n"+  "       t_creditOpenDate,"        //t_bdContractDate
            +"\n"+  "       t_trancheKind,"           //t_objectId
            +"\n"+  "       t_trancheNumber,"         //t_objectNumber
            +"\n"+  "       t_date,"                  //t_bdPayDate
            +"\n"+  "       t_interestRate,"          //t_iProcRate
            +"\n"+  "       t_term,"                  //t_iTrancheSrok
            +"\n"+  "       t_roubleSum,"             //t_rest
            +"\n"+  "       t_creditId,"              //T_creditId
            +"\n"+  "       null"                     //t_iProcRateType
            +"\n"+  "  FROM reportData"
            +"\n"+  " WHERE (   t_type = 2"
            +"\n"+                        "        OR t_type = 5)"
            +"\n"+                        "   AND t_date >= " + getSqlDate(ПредДатаОтчета)
            +"\n"+                        "   AND t_date <= " + getSqlDate(ДатаОтчета)
            +"\n"+                        "   AND " + creditTypeFilter
            +"\n"+                        "   AND t_interestRate != 0"
            +"\n"+                        "   AND (    t_contragentCode = '" + ФЛ + "' AND (" + convertMaskToSqlFormat(Маска_ФЛ, "t_cbAccountNumber") + ")"
            +"\n"+                        "         OR t_contragentCode = '" + ЮЛ + "' AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "t_cbAccountNumber") + "))"
            +"\n"+                        "   AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_FNCash", "t_territorialStruct")
            +"\n"+                        "   AND (    t_currencyId = " + RUR_FIID
            +"\n"+                        "         OR t_currencyId = " + USD_FIID
            +"\n"+                        "         OR t_currencyId = " + EUR_FIID + ")");

            var commandTranches = RsdCommand(rslDefCon);

            var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                       + "\n" + "        t_objectid     AS a_objectTypeId "
                       + "\n" + "   FROM dtemp_128_tmp)          ";

            commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
            commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
            commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
            commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

            commandTranches.execute();
    end;

    macro Расчет()

      Init();

      message( "Получение данных Loans..." );

      getDataWithTypeProlingationOrPayment("t_credittype != 21");

    end;


    macro PrintHeader()
      var ProtocolHeader = String( "  Форма 128. Данные о средневзвешенных процентных ставках по кредитам, предоставленным кредитной организацией \n" +
                                   "  ПРОТОКОЛ РАСЧЕТА. \n"                                             +
                                   "\n"                                                                 +
                                   "  Период отчета с " + ПредДатаОтчета + " по " + ДатаОтчета + "\n"   +
                                   "  Исполнитель: "    + Исполнитель + "\n"                            +
                                   "  Дата и время выпуска отчета " + date + " " + time + "\n"
                                 );

      PrintLn( ProtocolHeader );

      PrintLn();
    end;


    macro PrintPartHeader( Part, Contragent )
      var TableHeader, PartHeader = String( "     Раздел " + Part + ".");

      if  ( Contragent == ФЛ ) PartHeader = PartHeader + " Физические лица";
      elif( Contragent == ЮЛ ) PartHeader = PartHeader + " Нефинансовые организации";
      end;

      PrintLn( PartHeader );


      TableHeader = String(   "    ┌──────────────────────┬────────────────┬──────────┬───────────┬─────────────────────────┬───────────┬──────────┬────────┬─────────────────────┐\n" +
                              "    │     Строка отчета    │       №        │   Дата   │Дата выдачи│        Номер л/с        │   Тип     │ % ставка │  Срок  │ Сумма выдачи транша │\n" +
                              "    │                      │    договора    │ договора │  транша   │                         │ операции  │          │ транша │                     │\n" +
                              "    ├──────────────────────┼────────────────┼──────────┼───────────┼─────────────────────────┼───────────┼──────────┼────────┼─────────────────────┤  "
                              );

      Println( TableHeader );

    end;


    macro printBottom(contragent)

            [    └──────────────────────┴────────────────┴──────────┴───────────┴─────────────────────────┴───────────┴──────────┴────────┴─────────────────────┘];
            [                                                                                                                                                    ];


    end;


    macro FindSrokName( Shifr )
      var i = 1;

      while( i <= SrokShifr.size )
        if( SrokShifr( i ) == Shifr) return SrokName( i ); end;
        i = i + 1;
      end;

      return "";
    end;


    macro ПечатьПротокола()

      macro printTerm(dataSet, isPrintTermName)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var termName = "";
        var percentRate = formatting(dataSet.iProcRate);
        if (isPrintTermName)
            termName = FindSrokName(dataSet.szSrok);
        end;

        [    │######################│################│##########│###########│#########################│###########│##########│########│#####################│ ]
        (termName, dataSet.szContractNumber, SQL_ConvTypeDate( dataSet.bdContractDate ), SQL_ConvTypeDate( dataSet.bdPayDate ), dataSet.cbAccountNumber, getOperationTypeName(dataSet.t_operationTypedId), percentRate, dataSet.iTrancheSrok, dataSet.Rest );

      end;


      macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + Srok + "_" + NameColumn + "_К_";

        return VarName;
      end;

      macro saveTotalSrokVariable(dataSet : Object)
            if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__" ) ) )
              msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__" ) );
            end;
      end;

      macro saveTotalSubSrokVariable(dataSet : Object)
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"%_",dataSet.szSrok));
          end;

          if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_",dataSet.szSrok));
          end;
      end;

      setoutput( ИмяФайлаПротокола );
      PrintHeader();

      var query =               "SELECT *"
          + "\n" +              "  FROM (SELECT SUM(t_rest) t_resultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(t_rest) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(t_rest * t_iProcRate)/SUM(t_rest)"
          + "\n" +              "               end t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(t_rest) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(t_rest * t_iTrancheSrok)/SUM(t_rest)"
          + "\n" +              "               end t_resultTerm,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_srokSum,"
          + "\n" +              "               data.*"
          + "\n" +              "          FROM (SELECT temp.t_ipart, temp.t_szcontragent, temp.t_szsrok, temp.t_szcontractnumber, temp.t_cbaccountnumber,"
          + "\n" +              "                       temp.t_operationtypedid, temp.t_bdcontractdate, temp.t_objectid, temp.t_objectnumber, temp.t_bdpaydate,"
          + "\n" +              "                       temp.t_iprocrate, temp.t_itranchesrok, temp.t_rest, temp.t_creditid,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContraGent = 'ФЛ'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = 'ЮЛ'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0)"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC";

      var dataSet = TRsbDataSet(query);

      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;

      while (dataSet.moveNext())
          if (dataSet.partSum == "TOTAL")
              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              printPartHeader(dataSet.iPart, dataSet.szContragent);
              isempty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              saveTotalSubSrokVariable(dataSet);
          else
              printTerm(dataSet, isPrintTermName);
              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (not TRsbDataSet("SELECT 1 FROM DUAL WHERE CASE WHEN EXISTS(SELECT 1 FROM dtemp_128_tmp) THEN 1 ELSE 0 end = 1").next())
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);

    end;

    private macro constructorTReportController()

        if (SrokName == null)
            SrokName = TArray();                      SrokShifr = TArray();
            SrokName( 1) = "До востребования";        SrokShifr( 1) = "1_1";
            SrokName( 2) = "На 1 день";               SrokShifr( 2) = "1_2";
            SrokName( 3) = "От 2 до 7 дней";          SrokShifr( 3) = "1_3";
            SrokName( 4) = "От 8 до 30 дней";         SrokShifr( 4) = "1_4";
            SrokName( 5) = "От 31 до 90 дней";        SrokShifr( 5) = "2__";
            SrokName( 6) = "От 91 дней до 180 дней";  SrokShifr( 6) = "3__";
            SrokName( 7) = "От 181 дня до 1 года";    SrokShifr( 7) = "4__";
            SrokName( 8) = "От 1 года до 3 лет";      SrokShifr( 8) = "5__";
            SrokName( 9) = "Свыше 3 лет";             SrokShifr( 9) = "6__";
        end;

        ИмяФайлаПротокола = getNameProtocolF128();
    end;

    constructorTReportController();
end;

class (TReportController) TReportController_2332()

    macro Расчет()

      Init();

      message( "Получение данных Loans..." );

      getDataWithTypeProlingationOrPayment("t_credittype = 1");

    end;

    macro PrintHeader()
      var ProtocolHeader = String( "  Форма 128. Данные о средневзвешенных процентных ставках по кредитам, предоставленным кредитной организацией \n" +
                                   "  ПРОТОКОЛ РАСЧЕТА. \n"                                             +
                                   "\n"                                                                 +
                                   "  Период отчета с " + ПредДатаОтчета + " по " + ДатаОтчета + "\n"   +
                                   "  Исполнитель: "    + Исполнитель + "\n"                            +
                                   "  Дата и время выпуска отчета " + date + " " + time + "\n"
                                 );

      PrintLn( ProtocolHeader );
      PrintLn();
    end;

    macro PrintPartHeader( Part, Contragent )
      var TableHeader, PartHeader = String( "     Раздел " + Part + ".");

      if  ( Contragent == ФЛ ) PartHeader = PartHeader + " Физические лица";
      elif( Contragent == ЮЛ ) PartHeader = PartHeader + " Нефинансовые организации";
      end;

      PrintLn( PartHeader );


      TableHeader = String(   "    ┌──────────────────────┬────────────────┬──────────┬───────────┬─────────────────────────┬───────────┬──────────┬─────────────────────┐\n" +
                              "    │     Строка отчета    │       №        │   Дата   │Дата выдачи│        Номер л/с        │   Тип     │ % ставка │ Сумма выдачи транша │\n" +
                              "    │                      │    договора    │ договора │  транша   │                         │ операции  │          │                     │\n" +
                              "    ├──────────────────────┼────────────────┼──────────┼───────────┼─────────────────────────┼───────────┼──────────┼─────────────────────┤  "
                              );

      Println( TableHeader );

    end;


    macro printBottom(contragent)

            [    └──────────────────────┴────────────────┴──────────┴───────────┴─────────────────────────┴───────────┴──────────┴─────────────────────┘];
            [                                                                                                                                                    ];


    end;

    macro ПечатьПротокола()

      macro printTerm(dataSet, isPrintTermName)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var termName = "";
        var percentRate = formatting(dataSet.iProcRate);
        if (isPrintTermName)
            termName = FindSrokName(dataSet.szSrok);
        end;

        [    │######################│################│##########│###########│#########################│###########│##########│#####################│ ]
        (termName, dataSet.szContractNumber, SQL_ConvTypeDate( dataSet.bdContractDate ), SQL_ConvTypeDate( dataSet.bdPayDate ), dataSet.cbAccountNumber, getOperationTypeName(dataSet.t_operationTypedId), percentRate, dataSet.Rest );


      end;


      macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + Srok + "_" + NameColumn + "_К_";

        return VarName;
      end;

      macro saveTotalSrokVariable(dataSet : Object)
            if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__" ) ) )
              msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__" ) );
            end;
      end;

      macro saveTotalSubSrokVariable(dataSet : Object)
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"%_",dataSet.szSrok));
          end;

          if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_",dataSet.szSrok));
          end;
      end;

      setoutput( ИмяФайлаПротокола );
      PrintHeader();

      var dataSet = TRsbDataSet("SELECT *"
          + "\n" +              "  FROM (SELECT SUM(t_rest) t_resultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(t_rest) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(t_rest * t_iProcRate)/SUM(t_rest)"
          + "\n" +              "               end t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_srokSum,"
          + "\n" +              "               data.*"
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContraGent = 'ФЛ'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = 'ЮЛ'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0)"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC");

      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;

      while (dataSet.moveNext())
          if (dataSet.partSum == "TOTAL")
              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              printPartHeader(dataSet.iPart, dataSet.szContragent);
              isempty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              saveTotalSubSrokVariable(dataSet);
          else
              printTerm(dataSet, isPrintTermName);
              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (not TRsbDataSet("SELECT 1 FROM DUAL WHERE CASE WHEN EXISTS(SELECT 1 FROM dtemp_128_tmp) THEN 1 ELSE 0 end = 1").next())
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);

    end;

    private macro constructorTReportController_2332()
        initTReportController();
    end;

    constructorTReportController_2332();
end;

class (TReportController_2332) TReportController_2539()

    var m_protocol = CTableReport();

    private macro getCreditTypeQuery() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN '810' THEN 1"
         +"\n"+"                   WHEN '840' THEN 2"
         +"\n"+"                   WHEN '978' THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN 'ФЛ'"
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN 'ЮЛ'"
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN operation.t_tarifType = 2 THEN '72_'"
         +"\n"+"                   WHEN operation.t_type  =   5 THEN '71_'"
         +"\n"+"                   WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                   WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                   WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                   WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                   WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                   WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                   ELSE '___'"
         +"\n"+"               END                                                AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType                                   "
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate                     "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND contract.t_type = " + LO_CREDIT
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )"
         ;
    end;


    private macro getDataWithTypeProlingationOrPayment(creditTypeFilter : string)
        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  getCreditTypeQuery()
                   );

            var commandTranches = RsdCommand(rslDefCon);

            var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                       + "\n" + "        t_objectid     AS a_objectTypeId "
                       + "\n" + "   FROM dtemp_128_tmp)          ";

            commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
            commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
            commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
            commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

            commandTranches.execute();
    end;

    macro PrintPartHeader( Part, Contragent, useAddition )
      var TableHeader, PartHeader = String( "     Раздел " + Part + ".");
        defaultParm (useAddition, 0);

      if  ( Contragent == ФЛ ) PartHeader = PartHeader + " Физические лица";
            if (useAddition != 0)
                PartHeader = PartHeader + ", в том числе автокредиты";
            end;
      elif( Contragent == ЮЛ ) PartHeader = PartHeader + " Нефинансовые организации";
            if (useAddition != 0)
                PartHeader = PartHeader + ", в том числе кредиты субъектам малого и среднего предпринимательства";
        end;
      end;

      PrintLn( PartHeader );

      m_protocol.printHead();

    end;


    macro printBottom(contragent)

        m_protocol.printBottom();

    end;

    macro ПечатьПротокола()

      macro printTerm(dataSet, isPrintTermName)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro getSignCorrectionType(operationHistoryCode)
            var tabStr = "        ";
            if (operationHistoryCode == "К")
                return tabStr + "X";
            else
                return "";
            end;
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var termName = "";
        var correction_Date = "";
        var signCorrectionType = getSignCorrectionType(dataSet.t_operationHistory);
        var percentRate = formatting(dataSet.iProcRate);

        termName = FindSrokName(dataSet.szSrok);

        if (signCorrectionType != "")
            correction_Date = SQL_ConvTypeDate( dataSet.correctionDate );
        end;

        m_protocol.printStringTransferByWord(termName, dataSet.szContractNumber, SQL_ConvTypeDate( dataSet.bdContractDate ), SQL_ConvTypeDate( dataSet.bdPayDate ), dataSet.cbAccountNumber, getOperationTypeName(dataSet.t_operationTypedId), percentRate, dataSet.Rest, signCorrectionType, correction_Date)
      end;

      macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + Srok + "_" + NameColumn + "_К_";

        return VarName;
      end;

      macro saveReferenceVariables(dataSet : Object)
          if (dataset.szSrok == "71_")
            if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "71_" ) ) )
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "71_"));
            end;
          end;

          if (dataset.szSrok == "72_")
            if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "72_" ) ) )
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "72_"));
            end;
          end;
      end;

      macro saveTotalSrokVariable(dataSet : Object)
            if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__" ) ) )
              msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__" ) );
            end;
      end;

      macro saveTotalSubSrokVariable(dataSet : Object)
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"%_",dataSet.szSrok));
          end;

          if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_",dataSet.szSrok));
          end;
      end;

      setoutput( ИмяФайлаПротокола );
      PrintHeader();

      var dataSet = TRsbDataSet("SELECT *"
          + "\n" +              "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
          + "\n" +              "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
          + "\n" +              "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(t_rest * t_iProcRate)/SUM(DECODE(t_iProcRateType, 1, t_rest, 0))"
          + "\n" +              "               end t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_srokSum,"
          + "\n" +              "               data.t_iPart,"
          + "\n" +              "               data.t_szContragent,"
          + "\n" +              "               data.t_szSrok,"
          + "\n" +              "               data.t_szContractNumber,"
          + "\n" +              "               data.t_cbAccountNumber,"
          + "\n" +              "               data.t_operationTypedId,"
          + "\n" +              "               data.t_bdContractDate,"
          + "\n" +              "               data.t_objectId,"
          + "\n" +              "               data.t_objectNumber,"
          + "\n" +              "               data.t_bdpayDate,"
          + "\n" +              "               data.t_iProcRate,"
          + "\n" +              "               data.t_iTrancheSrok,"
          + "\n" +              "               data.t_rest,"
          + "\n" +              "               data.t_creditId,"
          + "\n" +              "               data.t_iProcRateType,"
          + "\n" +              "               data.t_operationHistory,"
          + "\n" +              "               data.T_correctiondate,"
          + "\n" +              "               data.T_totalsrok,"
          + "\n" +              "               data.t_sortByContragent "
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContraGent = 'ФЛ'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = 'ЮЛ'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0)"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC");

      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;

      while (dataSet.moveNext())
          if (dataSet.partSum == "TOTAL")
              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              printPartHeader(dataSet.iPart, dataSet.szContragent);
              isempty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              if (substr(dataset.szSrok, 1, 1) == "7") // сохраняем переменные для раздела 7.Справочно
                saveReferenceVariables(dataset);
              else
                saveTotalSubSrokVariable(dataSet);
              end;
          else
              printTerm(dataSet, isPrintTermName);
              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (not TRsbDataSet("SELECT 1 FROM DUAL WHERE CASE WHEN EXISTS(SELECT 1 FROM dtemp_128_tmp) THEN 1 ELSE 0 end = 1").next())
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);

    end;

    private macro constructorTReportController_2539()

        if (SrokName == null)
            SrokName = TArray();                                          SrokShifr = TArray();
            SrokName( 1) = "1.1. До востребования";                       SrokShifr( 1) = "1_1";
            SrokName( 2) = "1.2. На 1 день";                              SrokShifr( 2) = "1_2";
            SrokName( 3) = "1.3. От 2 до 7 дней";                         SrokShifr( 3) = "1_3";
            SrokName( 4) = "1.4. От 8 до 30 дней";                        SrokShifr( 4) = "1_4";
            SrokName( 5) = "2. От 31 до 90 дней";                         SrokShifr( 5) = "2__";
            SrokName( 6) = "3. От 91 дней до 180 дней";                   SrokShifr( 6) = "3__";
            SrokName( 7) = "4. От 181 дня до 1 года";                     SrokShifr( 7) = "4__";
            SrokName( 8) = "5. От 1 года до 3 лет";                       SrokShifr( 8) = "5__";
            SrokName( 9) = "6. Свыше 3 лет";                              SrokShifr( 9) = "6__";
            SrokName(10) = "7.1 Пролонгированные кредиты";                SrokShifr(10) = "71_";
            SrokName(11) = "7.2 Кредиты по переменной процентной ставке"; SrokShifr(11) = "72_";
        end;

        m_protocol.addColumn("Строка отчета",                             25.0, AL_LEFT);
        m_protocol.addColumn("№ договора",                                16.0, AL_LEFT);
        m_protocol.addColumn("Дата договора",                             10.0, AL_CENTER);
        m_protocol.addColumn("Дата выдачи транша",                        10.0, AL_CENTER);
        m_protocol.addColumn("Номер л/с",                                 23.0, AL_LEFT);
        m_protocol.addColumn("Тип операции",                              11.0, AL_LEFT);
        m_protocol.addColumn("% ставка",                                  8.0, AL_LEFT);
        m_protocol.addColumn("Сумма выдачи транша",                       19.0, AL_RIGHT);
        m_protocol.addColumn("Корректирующая операция",                   14.0, AL_LEFT);
        m_protocol.addColumn("Дата, за которую проведена корр. операция", 26.0, AL_CENTER);

        initTReportController_2332();
    end;

    constructorTReportController_2539();
end;

class (TReportController_2539) TReportController_2835()

    macro Расчет()
      Init();
      message( "Получение данных Loans..." );
      getDataWithTypeProlingationOrPayment();
    end;

    private macro getCreditTypeQuery() : String
        return "WITH reportData"
         +"\n"+"AS"
         +"\n"+"       (SELECT tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               contract.t_contragentId                            AS t_contractorId,"
         +"\n"+"               (CASE"
         +"\n"+"                  WHEN party.t_isPhisical = 1"
         +"\n"+"                      THEN '" + ФЛ + "'"
         +"\n"+"                  WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN '" + ЮЛ + "'"
         +"\n"+"                  ELSE CHR(1)"
         +"\n"+"                END)                                              AS t_contragentCode,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               operation.t_currencyId                             AS t_currencyId,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               contract.t_departmentId                            AS t_FNCash,"
         +"\n"+"               operation.t_interestRate                           AS t_interestRate,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               DECODE(party.t_isEmployer, 1, 'X', CHR(0))         AS t_isContractorEmployer,"
         +"\n"+"               DECODE(party.t_isPhisical, 1, 'X', CHR(0))         AS t_isContractorPhysical,"
         +"\n"+"               (CASE operation.t_currencyId"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '810') THEN 1"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '840') THEN 2"
         +"\n"+"                    WHEN (SELECT t_fiid FROM dfininstr_dbt WHERE t_fi_code = '978') THEN 3"
         +"\n"+"                    ELSE 0"
         +"\n"+"                END)                                              AS t_part,"
         +"\n"+"               (CASE"
         +"\n"+"                    WHEN contract.t_type in (8, 22) THEN '73_'"
         +"\n"+"                    WHEN operation.t_tarifType = 2  THEN '72_'"
         +"\n"+"                    WHEN operation.t_type  =   5 THEN '71_'"
         +"\n"+"                    WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                    WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                    WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                    WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                    WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                    WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                    WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                    ELSE '___'"
         +"\n"+"               END)                                               AS t_srok,"
         +"\n"+"               operation.t_roubleSum                              AS t_roubleSum,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               contract.t_branchId                                AS t_territorialStruct,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               operation.t_id                                     AS t_operationId,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND operation.t_sum > 500"
         +"\n"+"           AND contract.t_type IN (" + LO_CREDIT + ", " + LO_KARTA + ", " + LO_OVERDRAFT + ")"
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0"
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+  "         AND (   (    party.t_isPhisical = 1"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "              OR (    party.t_isPhisical = 0"
         +"\n"+  "                  AND party.t_isBank = 0"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "             )"
         +"\n"+"       )"
         ;

    end;


    private macro getDataWithTypeProlingationOrPayment(creditTypeFilter : string)

// Kirin: SCR 185037 : удвоение суммы происходит из-за повтороного отбора записей и их последующей вставки в таблицу,
// для исключения которых пришлось сделать обертку с группировкой по всем полям
        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  getCreditTypeQuery()
            +"\n"+  "SELECT t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "  FROM (SELECT t_part,"                  //t_iPart
            +"\n"+  "               t_contragentCode,"        //t_szContragent,"
            +"\n"+  "               t_srok,"                  //t_szSrok,"
            +"\n"+  "               t_creditNumberForReport," //t_szContractNumber
            +"\n"+  "               t_cbAccountNumber,"       //t_cbAccountNumber
            +"\n"+  "               t_type,"                  //t_operationTypedId
            +"\n"+  "               t_creditOpenDate,"        //t_bdContractDate
            +"\n"+  "               t_trancheKind,"           //t_objectId
            +"\n"+  "               t_trancheNumber,"         //t_objectNumber
            +"\n"+  "               t_date,"                  //t_bdPayDate
            +"\n"+  "               DECODE(t_srok,'72_',t_interestRate,DECODE(t_interestRateType, 1, t_interestRate, 0)) AS t_interestRate," //t_iProcRate
            +"\n"+  "               t_term,"                  //t_iTrancheSrok
            +"\n"+  "               t_sum,"                   //t_rest
            +"\n"+  "               t_creditId,"              //T_creditId
            +"\n"+  "               t_interestRateType,"      //t_iProcRateType
            +"\n"+  "               t_operationHistory,"
            +"\n"+  "               t_correctionDate,"
            +"\n"+  "               t_credittype"             //t_contactType
            +"\n"+  "          FROM reportData"
            +"\n"+  "       )"
            +"\n"+  "GROUP BY("
            +"\n"+  "       t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "        )"
           );

           var commandTranches = RsdCommand(rslDefCon);

           var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                      + "\n" + "        t_objectid     AS a_objectTypeId "
                      + "\n" + "   FROM dtemp_128_tmp)          ";

           commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
           commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
           commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
           commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

           commandTranches.execute();

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       '71_',"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationTypedId,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype"
            +"\n"+  "  FROM dtemp_128_tmp"
            +"\n"+  " WHERE t_operationTypedId = 5 and t_szsrok <> '73_'");
    end;


    macro ПечатьПротокола()

      macro printTerm(dataSet, isPrintTermName)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro getSignCorrectionType(operationHistoryCode)
            var tabStr = "        ";
            if (operationHistoryCode == "К")
                return tabStr + "X";
            else
                return "";
            end;
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var rest = String(dataSet.rest);
        if (dataSet.szSrok == "73_")
            rest = subStr(rest, 1, strLen(rest) - 2);
        end;

        var termName = "";
        var correction_Date = "";
        var signCorrectionType = getSignCorrectionType(dataSet.t_operationHistory);
        var percentRate = formatting(dataSet.iProcRate);

        termName = FindSrokName(dataSet.szSrok);

        if (signCorrectionType != "")
            correction_Date = SQL_ConvTypeDate( dataSet.correctionDate );
        end;
        m_protocol.printStringTransferByWord(termName, dataSet.szContractNumber, SQL_ConvTypeDate( dataSet.bdContractDate ), SQL_ConvTypeDate( dataSet.bdPayDate ), dataSet.cbAccountNumber, getOperationTypeName(dataSet.t_operationTypedId), percentRate, rest, signCorrectionType, correction_Date);
      end;

      macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + Srok + "_" + NameColumn + "_К_";

        return VarName;
      end;

      macro saveReferenceVariables(dataSet : Object)
          if (dataset.szSrok == "71_")
              if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "71_" ) ) )
                  msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "71_"));
              end;
          end;

          if (dataset.szSrok == "72_")
              if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "72_" ) ) )
                  msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "72_"));
              end;
          end;
      end;

      macro saveVirables73(dataSet: Object)
          if (dataSet.contractType == 8)
              if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__С__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__С__К_");
              end;
              if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__%__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__%__К_");
              end;
          elif (dataSet.contractType == 22)
              if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__С__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__С__К_");
              end;
              if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__%__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__%__К_");
              end;
          end;
      end;

      macro saveTotalSrokVariable(dataSet : Object)
            if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__" ) ) )
              msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__" ) );
            end;
      end;

      macro saveTotalSubSrokVariable(dataSet : Object)
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"%_",dataSet.szSrok));
          end;

          if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_",dataSet.szSrok));
          end;
      end;

      macro calculateString73(dataSet, contragent, isPrintTermName, isPrintHeader, isPrintedBottom)
          var m_contragent;
          var isPrinted = false;
          if (dataSet.contractType == contragent)
              if (dataSet.contractTypeTotal == "TOTAL")
                  saveVirables73(dataSet);
              else
                  if (isPrintedBottom == true)
                      printBottom(ФЛ);
                  end;
                  if (isPrintHeader == true)
                      printPartHeader(1, contragent);
                      isPrintHeader = false;
                  end;
                  printTerm(dataSet, isPrintTermName);
                  isPrinted = true;
              end;
          end;
          if (contragent == ФЛ)
              m_contragent = 8;
          else
              m_contragent = 22;
          end;
          while ((dataSet.moveNext()) and (dataSet.contractType == m_contragent))
              if (dataSet.contractTypeTotal == "TOTAL")
                  saveVirables73(dataSet);
              else
                  if (isPrintedBottom == true)
                      printBottom(ФЛ);
                  end;
                  if (isPrintHeader == true)
                      printPartHeader(1, contragent);
                      isPrintHeader = false;
                  end;
                  printTerm(dataSet, isPrintTermName);
                  isPrinted = true;
              end;
          end;
          return isPrinted;
      end;

      setoutput( ИмяФайлаПротокола );
      PrintHeader();
      var dataSet = TRsbDataSet("SELECT *"
          + "\n" +              "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
          + "\n" +              "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
          + "\n" +              "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(DECODE(t_iProcRateType, 1, t_rest, 0) * t_iProcRate)/SUM(DECODE(t_iProcRateType, 1, t_rest, 0))"
          + "\n" +              "               end t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_srokSum,"
          + "\n" +              "               data.t_iPart,"
          + "\n" +              "               data.t_szContragent,"
          + "\n" +              "               data.t_szSrok,"
          + "\n" +              "               data.t_szContractNumber,"
          + "\n" +              "               data.t_cbAccountNumber,"
          + "\n" +              "               data.t_operationTypedId,"
          + "\n" +              "               data.t_bdContractDate,"
          + "\n" +              "               data.t_objectId,"
          + "\n" +              "               data.t_objectNumber,"
          + "\n" +              "               data.t_bdpayDate,"
          + "\n" +              "               data.t_iProcRate,"
          + "\n" +              "               data.t_iTrancheSrok,"
          + "\n" +              "               data.t_rest,"
          + "\n" +              "               data.t_creditId,"
          + "\n" +              "               data.t_iProcRateType,"
          + "\n" +              "               data.t_operationHistory,"
          + "\n" +              "               data.T_correctiondate,"
          + "\n" +              "               data.T_totalsrok,"
          + "\n" +              "               data.t_sortByContragent "
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContraGent = '" + ФЛ + "'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = '" + ЮЛ + "'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp"
          + "\n" +              "                  WHERE temp.t_contractType = 1) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0)"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC");

    /* note: расчет строки 7.3, для договора с типом = 8(кредит по карте) выбираем максимальную процентную ставку из истории */
      var dataSet73 = TRsbDataSet("SELECT "
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    sum(data.t_rest) as t_rest,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_contracttype,"
          + "\n" +                "    (SUM(t_rest * data.t_procRate)/SUM(t_rest)) AS t_iProcRate,"
          + "\n" +                "    CASE "
          + "\n" +                "        WHEN GROUPING(data.t_rest) = 1"
          + "\n" +                "            THEN 'TOTAL'"
          + "\n" +                "        ELSE '0'"
          + "\n" +                "    END AS t_contractTypeTotal,"
          + "\n" +                "    data.t_operationHistory"
          + "\n" +                "FROM"
          + "\n" +                "    (SELECT "
          + "\n" +                "        (CASE temp.t_contracttype"
          + "\n" +                "            WHEN 8"
          + "\n" +                "                THEN"
          + "\n" +                "                    (SELECT MAX(history.t_rateval)"
          + "\n" +                "                       FROM  repLnsRateHistory_vw history"
          + "\n" +                "                      WHERE history.t_objectId =  temp.t_objectid"
          + "\n" +                "                        AND history.t_objectNumber = temp.t_objectnumber)"
          + "\n" +                "            ELSE temp.t_iProcRate"
          + "\n" +                "        END) AS t_procRate,"
          + "\n" +                "        temp.*"
          + "\n" +                "    FROM "
          + "\n" +                "        dtemp_128_tmp temp"
          + "\n" +                "    WHERE"
          + "\n" +                "        temp.t_iPart = 1 "
          + "\n" +                "        AND t_iProcRateType = 1"
          + "\n" +                "        AND   ((temp.t_contractType = 8 AND temp.t_szContragent = '" + ФЛ + "') "
          + "\n" +                "            OR (temp.t_contractType = 22 AND temp.t_szContragent = '" + ЮЛ + "'))"
          + "\n" +                "    ) data"
          + "\n" +                "GROUP BY ROLLUP"
          + "\n" +                "    (data.t_contracttype,"
          + "\n" +                "    (data.t_Rest ,"
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    data.t_iProcRate,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_operationHistory))"
          + "\n" +                "HAVING GROUPING(data.t_contracttype) = 0"
          + "\n" +                "ORDER BY t_rest DESC");



      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;
      var isPrintString73    = false;
      while (dataSet.moveNext())

          if (dataSet.partSum == "TOTAL")

              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if ((dataSet.szContragent == ЮЛ) and (previousContragent == ФЛ) and (dataSet.iPart == 1))
                  calculateString73(dataSet73, ФЛ, isPrintTermName);
                  isPrintString73 = true;
                      end;
              if ((dataSet.szContragent == ФЛ) and (previousContragent == ЮЛ) and (dataSet.iPart == 2))
                  calculateString73(dataSet73, ЮЛ, isPrintTermName);
                      isPrintString73 = true;
                  end;
              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              printPartHeader(dataSet.iPart, dataSet.szContragent);
              isEmpty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              if (substr(dataset.szSrok, 1, 1) == "7") // сохраняем переменные для раздела 7.Справочно
                  saveReferenceVariables(dataset);
              else
                  saveTotalSubSrokVariable(dataSet);
              end;
          else
              if ((dataSet.iPart == 1) and (isPrintString73 == false) and (dataSet.szContragent == ЮЛ))
                  calculateString73(dataSet73, ФЛ, isPrintTermName);
                  printBottom(previousContragent);
                  printPartHeader(dataSet.iPart, dataSet.szContragent);
              end;
              if ((dataSet.iPart == 2) and (isPrintString73 == false))
                  if (calculateString73(dataSet73, ФЛ, isPrintTermName))
                      printBottom(ЮЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent);
                  end;
                  if (calculateString73(dataSet73, ЮЛ, isPrintTermName))
                      printBottom(ФЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent);
                  end;
              end;
              if (dataSet.iProcRate != 0)
                  printTerm(dataSet, isPrintTermName);
              end;
              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (isEmpty == true)
          if (calculateString73(dataSet73, ФЛ, isPrintTermName, true))
              isEmpty = false;
                  end;
          if (calculateString73(dataSet73, ЮЛ, isPrintTermName, true, not isEmpty))
              isEmpty = false;
              end;
          end;

      if (isEmpty == true)
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);

    end;

    private macro constructorTReportController_2835()

        if (SrokName == null)
            SrokName = TArray();                                           SrokShifr = TArray();
            SrokName( 1) = "1.1. До востребования";                        SrokShifr( 1) = "1_1";
            SrokName( 2) = "1.2. На 1 день";                               SrokShifr( 2) = "1_2";
            SrokName( 3) = "1.3. От 2 до 7 дней";                          SrokShifr( 3) = "1_3";
            SrokName( 4) = "1.4. От 8 до 30 дней";                         SrokShifr( 4) = "1_4";
            SrokName( 5) = "2. От 31 до 90 дней";                          SrokShifr( 5) = "2__";
            SrokName( 6) = "3. От 91 дней до 180 дней";                    SrokShifr( 6) = "3__";
            SrokName( 7) = "4. От 181 дня до 1 года";                      SrokShifr( 7) = "4__";
            SrokName( 8) = "5. От 1 года до 3 лет";                        SrokShifr( 8) = "5__";
            SrokName( 9) = "6. Свыше 3 лет";                               SrokShifr( 9) = "6__";
            SrokName(10) = "7.1 Пролонгированные кредиты";                 SrokShifr(10) = "71_";
            SrokName(11) = "7.2 Кредиты по переменной процентной ставке";  SrokShifr(11) = "72_";
            SrokName(12) = "7.3 Операции с использованием банковских карт"; SrokShifr(12) = "73_";
        end;
        initTReportController_2539();
    end;

    constructorTReportController_2835();
end;

class (TReportController_2835) TReportController_2926()

    var Маска_ФЛ_73;
    var Маска_ЮЛ_73;

    macro Init()
        var dataSetTuneTable;
        var stringTuneTable = "";
        var filter = "";
      SQL_Truncate( "dtemp_128_tmp"  );

      RUR_FIID    = FindFIID( RUR_CODE );
      RUR_FIID_OR = FindFIID( RUR_CODE_OR );
      USD_FIID    = FindFIID( USD_CODE );
      EUR_FIID    = FindFIID( EUR_CODE );

        if (rcbApplication.currentReport.context.period.endDate >= RCB_I2926_DATE)
            filter = " t_instructionDate = " + getSqlDate(RCB_I2926_DATE);
        else
            filter = " 1 = 1 ";
        end;
        filter = filter + " AND t_isClosed = 0 ";

        stringTuneTable =  "SELECT *"
        + "\n" +           " FROM  "
        + "\n" +           "     dt128_dbt "
        + "\n" +           " WHERE " + filter
        + "\n" +           " ORDER BY "
        + "\n" +           "     t_szContragent, t_instructionDate DESC";

        dataSetTuneTable = TRsbDataSet(stringTuneTable);

        while (dataSetTuneTable.MoveNext())
            if (dataSetTuneTable.line != "7.3")
                if (dataSetTuneTable.szContragent == ФЛ)
                    Маска_ФЛ = dataSetTuneTable.szBalance;
                else
                    Маска_ЮЛ = dataSetTuneTable.szBalance;
                end;
            else
                if (dataSetTuneTable.szContragent == ФЛ)
                    Маска_ФЛ_73 = dataSetTuneTable.szBalance;
                else
                    Маска_ЮЛ_73 = dataSetTuneTable.szBalance;
                end;

            end;
      end;

      sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(RcbApplication.currentReport.context.period.beginDate)+", 'DD.MM.YYYY')))");
      sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(RcbApplication.currentReport.context.period.endDate)+", 'DD.MM.YYYY')))");

    end;


    macro Расчет()
      Init();
      message( "Получение данных Loans..." );
      getDataWithTypeProlingationOrPayment();
    end;

    private macro getCreditTypeQuery() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN operation.t_tarifType = 2 THEN '72_'"
         +"\n"+"                   WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                   WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                   WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                   WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                   WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                   WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                   ELSE '___'"
         +"\n"+"               END                                                AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType                                   "
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate                     "
         +"\n"+"                   WHEN 2 THEN operation.t_interestRate                     "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND contract.t_type = " + LO_CREDIT
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0"
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+  "         AND (   (    party.t_isPhisical = 1"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "              OR (    party.t_isPhisical = 0"
         +"\n"+  "                  AND party.t_isBank = 0"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "             )"
         +"\n"+"UNION ALL"
         +"\n"+"        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               '73_'                                              AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               account.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType                                   "
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate                     "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsAccount_vw account"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND operation.t_contractId = account.t_contractId"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND contract.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND contract.t_type = " + LO_KARTA
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND contract.t_type = " + LO_OVERDRAFT
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )"
         ;
    end;

    private macro getDataWithTypeProlingationOrPayment()

        sql_execute("INSERT INTO dtemp_128_tmp( --11111111"
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "  FROM ("
            +"\n"+           getCreditTypeQuery()
            +"\n"+  "       )"
            +"\n"+  "GROUP BY("
            +"\n"+  "       t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "        )"
            );

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                   + "\n" + "        t_objectid     AS a_objectTypeId "
                   + "\n" + "   FROM dtemp_128_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       '71_',"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationTypedId,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype"
            +"\n"+  "  FROM dtemp_128_tmp"
            +"\n"+  " WHERE t_operationTypedId = 5 and t_szsrok <> '73_'");

        sql_execute("COMMIT");

    end;


    macro ПечатьПротокола()

      macro printTerm(dataSet, isPrintTermName, isPrint)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro getSignCorrectionType(operationHistoryCode)
            var tabStr = "        ";
            if (operationHistoryCode == "К")
                return tabStr + "X";
            else
                return "";
            end;
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var rest = String(dataSet.rest);
        var srok : String;
        var percentRate = formatting(dataSet.iProcRate);

        if (dataSet.szSrok == "73_")
            rest = subStr(rest, 1, strLen(rest) - 2);
            srok = "-";

            if (dataSet.iProcRate == dataSet.maxiProcRate)
                percentRate = "Max " + formatting(dataSet.iProcRate);
            end
        end;

        if ((dataSet.szSrok == "71_") or (dataSet.szSrok == "72_"))
            srok = "-";
            percentRate = "-";
        else
            srok = dataSet.iTrancheSrok;
        end;

        var termName = "";
        var correction_Date = "";
        var signCorrectionType = getSignCorrectionType(dataSet.t_operationHistory);

        if (isPrintTermName)
            termName = FindSrokName(dataSet.szSrok);
        end;

        if (signCorrectionType != "")
            correction_Date = SQL_ConvTypeDate( dataSet.correctionDate );
        end;

        if (isPrint)
            m_protocol.printStringTransferByWord(termName, dataSet.szContractNumber, SQL_ConvTypeDate(dataSet.bdContractDate),
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        else
            m_protocol.printStringTransferByWord(termName, "" /* dataSet.szContractNumber */, "" /* SQL_ConvTypeDate(dataSet.bdContractDate) */,
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        end;

      end;

      macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + Srok + "_" + NameColumn + "_К_";

        return VarName;
      end;

      macro saveReferenceVariables(dataSet : Object)
          if (dataset.szSrok == "71_")
              if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "71_" ) ) )
                  msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "71_"));
              end;
          end;

          if (dataset.szSrok == "72_")
              if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "72_" ) ) )
                  msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_", "72_"));
              end;
          end;
      end;

      macro saveVirables73(dataSet: Object)
          if (dataSet.contractType == 8)
              if (dataSet.rest <= 500)
                  dataSet.rest = 0;
              end;
              if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__С__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__С__К_");
              end;
              if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__%__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__%__К_");
              end;
          elif (dataSet.contractType == 22)
              if (dataSet.rest <= 500)
                  dataSet.rest = 0;
              end;
              if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__С__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__С__К_");
              end;
              if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__%__К_"))
                  msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__%__К_");
              end;
          end;
      end;

      macro saveTotalSrokVariable(dataSet : Object)
          if (dataSet.resultRest <= 500)
              dataSet.resultRate = 0;
          end;
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__" ) ) )
              msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__" ) );
          end;
      end;

      macro saveTotalSubSrokVariable(dataSet : Object)
          if (dataSet.resultRest <= 500)
              dataSet.resultRate = 0;
          end;
          if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"%_",dataSet.szSrok));
          end;

          if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok ) ) )
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet,"С_",dataSet.szSrok));
          end;
      end;

      macro calculateString73(dataSet, contragent, isPrintHeader, isPrintedBottom)
          var m_contragent;
          var isPrinted = false;
          var isPrint73 = true;
          var line73 = "";
          var contract73 = "";
          var date73 = "";
          var isPrintTermName = true;

          if (dataSet.contractTypeTotal == "TOTAL")
              saveVirables73(dataSet);
          elif  (dataSet.contractType == contragent)
              if (isPrintedBottom == true)
                  printBottom(ФЛ);
              end;
              if (isPrintHeader == true)
                  printPartHeader(1, contragent);
                  isPrintHeader = false;
              end;
              printTerm(dataSet, isPrintTermName, isPrint73);
              isPrinted = true;
          end;

          if (contragent == ФЛ)
              m_contragent = 8;
          else
              m_contragent = 22;
          end;
          while ((dataSet.moveNext()) and (dataSet.contractType == m_contragent))
              if ((line73 == dataSet.szSrok) and (contract73 == dataSet.szContractNumber) and (date73 == dataSet.bdContractDate))
                  isPrint73 = false;
              else
                  line73 = dataSet.szSrok;
                  contract73 = dataSet.szContractNumber;
                  date73 = dataSet.bdContractDate;
                  isPrint73 = true;
              end;

              if (dataSet.contractTypeTotal == "TOTAL")
                  saveVirables73(dataSet);
                  isPrintTermName = true;
              else
                  if (isPrintedBottom == true)
                      printBottom(ФЛ);
                  end;
                  if (isPrintHeader == true)
                      printPartHeader(1, contragent);
                      isPrintHeader = false;
                  end;
                  printTerm(dataSet, isPrintTermName, isPrint73);
                  isPrinted = true;
                  isPrintTermName = false;
              end;
          end;
          return isPrinted;
      end;

      setoutput( ИмяФайлаПротокола );
      PrintHeader();
      var dataSet = TRsbDataSet("SELECT *"
          + "\n" +              "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
          + "\n" +              "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
          + "\n" +              "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(DECODE(t_iProcRateType, 1, t_rest, 0) * t_iProcRate)/SUM(DECODE(t_iProcRateType, 1, t_rest, 0))"
          + "\n" +              "               end t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               end t_srokSum,"
          + "\n" +              "               data.t_iPart,"
          + "\n" +              "               data.t_szContragent,"
          + "\n" +              "               data.t_szSrok,"
          + "\n" +              "               data.t_szContractNumber,"
          + "\n" +              "               data.t_cbAccountNumber,"
          + "\n" +              "               data.t_operationTypedId,"
          + "\n" +              "               data.t_bdContractDate,"
          + "\n" +              "               data.t_objectId,"
          + "\n" +              "               data.t_objectNumber,"
          + "\n" +              "               data.t_bdpayDate,"
          + "\n" +              "               data.t_iProcRate,"
          + "\n" +              "               data.t_iTrancheSrok,"
          + "\n" +              "               data.t_rest,"
          + "\n" +              "               data.t_creditId,"
          + "\n" +              "               data.t_iProcRateType,"
          + "\n" +              "               data.t_operationHistory,"
          + "\n" +              "               data.T_correctiondate,"
          + "\n" +              "               data.T_totalsrok,"
          + "\n" +              "               data.t_sortByContragent "
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContraGent = '" + ФЛ + "'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = '" + ЮЛ + "'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp"
          + "\n" +              "                  WHERE temp.t_contractType = 1) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0)"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC");

      var dataSet73 = TRsbDataSet("SELECT "
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    sum(data.t_rest) as t_rest,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_contracttype,"
          + "\n" +                "    NVL(data.t_iprocRate, MAX(data.t_maxProcRate)) AS t_iProcRate,"
          + "\n" +                "    MAX(data.t_maxProcRate) AS t_maxiProcRate,"
          + "\n" +                "    CASE "
          + "\n" +                "        WHEN GROUPING(data.t_rest) = 1"
          + "\n" +                "            THEN 'TOTAL'"
          + "\n" +                "        ELSE '0'"
          + "\n" +                "    END AS t_contractTypeTotal,"
          + "\n" +                "    data.t_operationHistory"
          + "\n" +                "FROM"
          + "\n" +                "    (SELECT "
          + "\n" +                "        (SELECT MAX(history.a_rateval)"
          + "\n" +                "           FROM repLnsRateHistory_vw history"
          + "\n" +                "         WHERE history.a_objectId =  temp.t_objectid"
          + "\n" +                "           AND history.a_objectNumber = temp.t_objectnumber"
          + "\n" +                "           AND history.a_rateDate <= (SELECT MAX(tmp.t_bdPayDate)"
          + "\n" +                "                                        FROM dtemp_128_tmp tmp"
          + "\n" +                "                                       WHERE tmp.t_szContractNumber = temp.t_szContractNumber) ) AS t_maxProcRate,"
          + "\n" +                "        temp.*"
          + "\n" +                "    FROM "
          + "\n" +                "        dtemp_128_tmp temp"
          + "\n" +                "    WHERE"
          + "\n" +                "        temp.t_iPart = 1 "
          + "\n" +                "        AND t_iProcRateType = 1"
          + "\n" +                "        AND   ((temp.t_contractType = " + LO_KARTA + " AND temp.t_szContragent = '" + ФЛ + "') "
          + "\n" +                "            OR (temp.t_contractType = " + LO_OVERDRAFT + " AND temp.t_szContragent = '" + ЮЛ + "'))"
          + "\n" +                "    ) data"
          + "\n" +                "GROUP BY ROLLUP"
          + "\n" +                "    (data.t_contracttype,"
          + "\n" +                "    (data.t_Rest ,"
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    data.t_iProcRate,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_operationHistory))"
          + "\n" +                "HAVING GROUPING(data.t_contracttype) = 0"
          + "\n" +                "ORDER BY t_rest DESC");

      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;
      var isPrintString73    = false;
      var isPrint = true;
      var line = "";
      var contract = "";
      var date = "";
      while (dataSet.moveNext())
          if ((line == dataSet.szSrok) and (contract == dataSet.szContractNumber) and (date == dataSet.bdContractDate))
              isPrint = false;
          else
              line = dataSet.szSrok;
              contract = dataSet.szContractNumber;
              date = dataSet.bdContractDate;
              isPrint = true;
          end;

          if (dataSet.partSum == "TOTAL")

              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if ((dataSet.szContragent == ЮЛ) and (previousContragent == ФЛ) and (dataSet.iPart == 1))
                  calculateString73(dataSet73, ФЛ);
                  isPrintString73 = true;
              end;

              if ((dataSet.szContragent == ФЛ) and (previousContragent == ЮЛ) and (dataSet.iPart == 2))
                  calculateString73(dataSet73, ЮЛ);
                  isPrintString73 = true;
              end;

              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              printPartHeader(dataSet.iPart, dataSet.szContragent);
              isEmpty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              if (substr(dataset.szSrok, 1, 1) == "7") // сохраняем переменные для раздела 7.Справочно
                  saveReferenceVariables(dataset);
              else
                  saveTotalSubSrokVariable(dataSet);
              end;
          else
              if ((dataSet.iPart == 1) and (isPrintString73 == false) and (dataSet.szContragent == ЮЛ))
                  calculateString73(dataSet73, ФЛ);
                  printBottom(previousContragent);
                  printPartHeader(dataSet.iPart, dataSet.szContragent);
              end;
              if ((dataSet.iPart == 2) and (isPrintString73 == false))
                  if (calculateString73(dataSet73, ФЛ))
                      printBottom(ЮЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent);
                  end;
                  if (calculateString73(dataSet73, ЮЛ))
                      printBottom(ФЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent);
                  end;
              end;
              if (dataSet.iProcRate != 0)
                  printTerm(dataSet, isPrintTermName, isPrint);
              end;
              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (isEmpty == true)
          if (calculateString73(dataSet73, ФЛ, true))
              isEmpty = false;
                  end;
          if (calculateString73(dataSet73, ЮЛ, true, not isEmpty))
              isEmpty = false;
              end;
          end;

      if (isEmpty == true)
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);

    end;

    private macro constructorTReportController_2926()

        initTReportController_2835();

        m_protocol = CTableReport();
        m_protocol.addColumn("Строка отчета",                             25.0, AL_LEFT);
        m_protocol.addColumn("№ договора",                                16.0, AL_LEFT);
        m_protocol.addColumn("Дата договора",                             10.0, AL_CENTER);
        m_protocol.addColumn("Дата выдачи",                               10.0, AL_CENTER);
        m_protocol.addColumn("Номер л/с",                                 23.0, AL_LEFT);
        m_protocol.addColumn("Тип операции",                              11.0, AL_LEFT);
        m_protocol.addColumn("Срок операции",                             11.0, AL_LEFT);
        m_protocol.addColumn("% ставка",                                  11.0, AL_LEFT);
        m_protocol.addColumn("Сумма операции",                            19.0, AL_RIGHT);
        m_protocol.addColumn("Корректирующая операция",                   14.0, AL_LEFT);
        m_protocol.addColumn("Дата, за которую проведена корр. операция", 26.0, AL_CENTER);

    end;

    constructorTReportController_2926();
end;



class (TReportController_2926) TReportController_3006()

    var SrokNumber: TArray;

    private var totalRest = 0.0;
    private var termIndex;

    private macro getCreditTypeQuery() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN operation.t_tarifType = 2 THEN '72_'"
         +"\n"+"                   WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                   WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                   WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                   WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                   WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                   WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                   ELSE '___'"
         +"\n"+"               END                                                AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType"
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate "
         +"\n"+"                   WHEN 2 THEN operation.t_interestRate "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               CASE "
         +"\n"+"                   WHEN regexp_like(upper(contract.t_aim), 'А') AND (party.t_isPhisical = 1)"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                   t_isAuto,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', party.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                    t_isMsp"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND contract.t_type = " + LO_CREDIT
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+  "         AND (   (    party.t_isPhisical = 1"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "              OR (    party.t_isPhisical = 0"
         +"\n"+  "                  AND party.t_isBank = 0"
         +"\n"+  "                  AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+  "                      )"
         +"\n"+  "                 )"
         +"\n"+  "             )"
         +"\n"+"UNION ALL"
         +"\n"+"        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               '73_'                                              AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               account.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               contract.t_maxTarifValue                           AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               0                                                  AS t_isAuto,"
         +"\n"+"               0                                                  AS t_isMsp"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsAccount_vw account"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND operation.t_contractId = account.t_contractId"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND contract.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND contract.t_maxTarifValue != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND contract.t_type = " + LO_KARTA
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND contract.t_type = " + LO_OVERDRAFT
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )"
         ;
    end;

    private macro getDataWithTypeProlingationOrPayment()

        sql_execute("INSERT INTO dtemp_128_tmp( --11111111"
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_ismsp,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isauto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "  FROM ("
            +"\n"+           getCreditTypeQuery()
            +"\n"+  "       )"
            +"\n"+  "GROUP BY("
            +"\n"+  "       t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "        )"
            );

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                   + "\n" + "        t_objectid     AS a_objectTypeId "
                   + "\n" + "   FROM dtemp_128_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_ismsp,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isauto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       '71_',"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationTypedId,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype"
            +"\n"+  "  FROM dtemp_128_tmp"
            +"\n"+  " WHERE t_operationTypedId = 5"
            +"\n"+  "   AND t_szsrok <> '73_'"
            +"\n"+  "   AND t_iprocratetype = 1");      //для строки 7.1 отбираем ДГ только с простой ставкой

        sql_execute("COMMIT");
    end;

    macro PrintPartHeader( Part, Contragent, useAddition )
      var TableHeader, PartHeader = String( "     Раздел " + Part + ".");
        defaultParm (useAddition, 0);

      if  ( Contragent == ФЛ ) PartHeader = PartHeader + " Физические лица";
            if (useAddition != 0)
                PartHeader = PartHeader + ", в том числе автокредиты";
            else
                PartHeader = PartHeader + ", всего";
            end;
      elif( Contragent == ЮЛ ) PartHeader = PartHeader + " Нефинансовые организации";
            if (useAddition != 0)
                PartHeader = PartHeader + ", в том числе кредиты субъектам малого и среднего предпринимательства";
            else
                PartHeader = PartHeader + ", всего";
        end;
      end;

      PrintLn( PartHeader );

      m_protocol.printHead();

    end;

    private macro printTotalRest()
        if (totalRest != 0.0)
            m_protocol.printString("Итого по строке " + srokNumber(termIndex), "", "", "", "", "", "", "", String(totalRest:0:2), "", "");
            totalRest = 0.0;
        end;
    end;

    macro printBottom(contragent)
        printTotalRest();
        m_protocol.printBottom();
    end;

    private macro printSeparaionLine()
        m_protocol.PrintSeparator();
    end;

    macro printTerm(dataSet, isPrintTermName, isPrint)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro getSignCorrectionType(operationHistoryCode)
            var tabStr = "        ";
            if (operationHistoryCode == "К")
                return tabStr + "X";
            else
                return "";
            end;
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var rest = String(dataSet.rest);
        var srok : String;
        var percentRate = formatting(dataSet.iProcRate);

        if (dataSet.szSrok == "73_")
            rest = subStr(rest, 1, strLen(rest) - 2);
            srok = "-";

            if (dataSet.iProcRate == dataSet.maxiProcRate)
                percentRate = "Max " + formatting(dataSet.iProcRate);
            end
        end;

        if ((dataSet.szSrok == "71_") or (dataSet.szSrok == "72_"))
            srok = "-";
            percentRate = "-";
        else
            srok = dataSet.iTrancheSrok;
        end;

        var termName = "";
        var correction_Date = "";
        var signCorrectionType = getSignCorrectionType(dataSet.t_operationHistory);

        if (isPrintTermName)
            termName = FindSrokName(dataSet.szSrok);
        end;

        if (signCorrectionType != "")
            correction_Date = SQL_ConvTypeDate( dataSet.correctionDate );
        end;

        if (isPrint)
            m_protocol.printStringTransferByWord(termName, dataSet.szContractNumber, SQL_ConvTypeDate(dataSet.bdContractDate),
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        else
            m_protocol.printStringTransferByWord(termName, "" /* dataSet.szContractNumber */, "" /* SQL_ConvTypeDate(dataSet.bdContractDate) */,
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        end;

        if (totalRest == 0.0)
            var i;
            for (i, 1, srokShifr.size)
                if (SrokShifr(i) == dataSet.szSrok)
                    break;
                end;
            end;
            termIndex = i;
        end;
        totalRest = totalRest + dataSet.rest;
    end;

    macro GetVarName( dataSet, NameColumn, Srok )
      var VarName =  "Ф128_";

      if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
      elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
      elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
      end;

      if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
      elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
      end;

      VarName = VarName + Srok + "_" + NameColumn + "_К_";

      return VarName;
    end;

    macro saveReferenceVariables(dataSet : Object)
        if (dataset.szSrok == "71_")
            if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "71_")))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", "71_"));
            end;

            if (dataSet.prolongedResultRestAuto > 0)
                if( not СохранитьПеременную2(dataSet.prolongedResultRestAuto, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", "71_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", "71_"));
                end;
            end;

            if (dataSet.prolongedResultRestMsp > 0)
                if (dataSet.szContragent == ЮЛ)
                    if( not СохранитьПеременную2(dataSet.prolongedResultRestMsp, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", "71_")))
                        msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", "71_"));
                    end;
                end;
            end;
        end;

        if (dataset.szSrok == "72_")
            if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "72_")))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", "72_"));
            end;

            if (dataSet.floatingRateResultRestAuto > 0)
                if( not СохранитьПеременную2(dataSet.floatingRateResultRestAuto, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", "72_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", "72_"));
                end;
            end;

            if (dataSet.floatingRateResultRestMsp > 0)
                if( not СохранитьПеременную2(dataSet.floatingRateResultRestMsp, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", "72_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", "72_"));
                end;
            end;
        end;
    end;

    macro saveVirables73(dataSet: Object)
        if (dataSet.contractType == 8)
            if (dataSet.rest <= 500)
                dataSet.rest = 0;
            end;
            if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__С__К_"))
                msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__С__К_");
            end;
            if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ФЛ_73__%__К_"))
                msgbox("Ошибка сохранения переменной ", "Ф128_810_ФЛ_73__%__К_");
            end;
        elif (dataSet.contractType == 22)
            if (dataSet.rest <= 500)
                dataSet.rest = 0;
            end;
            if (not СохранитьПеременную2(dataSet.rest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__С__К_"))
                msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__С__К_");
            end;
            if (not СохранитьПеременную2(dataSet.iProcRate/100, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, "Ф128_810_ЮЛ_73__%__К_"))
                msgbox("Ошибка сохранения переменной ", "Ф128_810_ЮЛ_73__%__К_");
            end;
        end;
    end;

    macro saveTotalSrokVariable(dataSet : Object)
        if (dataSet.resultRest <= 500)
            dataSet.resultRate = 0;
        end;
        if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", "1__")))
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", "1__"));
        end;

        if (dataSet.resultRestAuto > 0)
            if( not СохранитьПеременную ( dataSet.resultRateAuto/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%А", "1__")))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%А", "1__"));
            end;
        end;

        if (dataSet.resultRestMsp > 0)
            if (dataSet.szContragent == ЮЛ)
                if( not СохранитьПеременную ( dataSet.resultRateMsp/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%П", "1__")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%П", "1__"));
                end;
            end;
        end;
    end;

    macro saveTotalSubSrokVariable(dataSet : Object)
        if (dataSet.resultRest <= 500)
            dataSet.resultRate = 0;
        end;
        if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok)))
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", dataSet.szSrok));
        end;

        if (dataSet.resultRestAuto > 0)
            if( not СохранитьПеременную ( dataSet.resultRateAuto/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%А", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%А", dataSet.szSrok));
            end;
        end;

        if (dataSet.resultRestMsp > 0)
            if (dataSet.szContragent == ЮЛ)
                if( not СохранитьПеременную ( dataSet.resultRateMsp/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%П", dataSet.szSrok)))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%П", dataSet.szSrok));
                end;
            end;
        end;

        if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok)))
            msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", dataSet.szSrok));
        end;

        if (dataSet.resultRestAuto > 0)
            if( not СохранитьПеременную2(dataSet.resultRestAuto, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", dataSet.szSrok));
            end;
        end;

        if (dataSet.resultRestMsp)
            if (dataSet.szContragent == ЮЛ)
                if( not СохранитьПеременную2(dataSet.resultRestMsp, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", dataSet.szSrok)))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", dataSet.szSrok));
                end;
            end;
        end;
    end;

    macro calculateString73(dataSet, contragent, isPrintHeader, isPrintedBottom)
        var m_contragent;
        var isPrinted = false;
        var isPrint73 = true;
        var line73 = "";
        var contract73 = "";
        var date73 = "";
        var isPrintTermName = true;
        var isSeparatorPrinted = false;

        dataSet.moveFirst();

        if (dataSet.contractTypeTotal == "TOTAL")
            saveVirables73(dataSet);
        elif  (dataSet.contractType == contragent)
            if (isPrintedBottom == true)
                printBottom(ФЛ);
            end;
            if (isPrintHeader == true)
                printPartHeader(1, contragent);
                isPrintHeader = false;
            end;
            printTerm(dataSet, isPrintTermName, isPrint73);
            isPrinted = true;
        end;

        if (contragent == ФЛ)
            m_contragent = 8;
        else
            m_contragent = 22;
        end;

        while (dataSet.moveNext())
            if (dataSet.contractType != m_contragent)
                continue;
            end;

            if ((line73 == dataSet.szSrok) and (contract73 == dataSet.szContractNumber) and (date73 == dataSet.bdContractDate))
                isPrint73 = false;
            else
                line73 = dataSet.szSrok;
                contract73 = dataSet.szContractNumber;
                date73 = dataSet.bdContractDate;
                isPrint73 = true;
            end;

            if (dataSet.contractTypeTotal == "TOTAL")
                saveVirables73(dataSet);
                isPrintTermName = true;
            else
                if (isPrintedBottom == true)
                    printBottom(ФЛ);
                end;
                if (isPrintHeader == true)
                    printPartHeader(1, contragent);
                    isPrintHeader = false;
                    isSeparatorPrinted = true;
                end;
                if (not isSeparatorPrinted)
                    printSeparaionLine();
                    isSeparatorPrinted = true;
                end;
                printTerm(dataSet, isPrintTermName, isPrint73);
                isPrinted = true;
                isPrintTermName = false;
            end;
        end;
        return isPrinted;
    end;

    macro ПечатьПротокола()
      setoutput( ИмяФайлаПротокола );
      PrintHeader();
      var dataSet = TRsbDataSet("SELECT *"
          + "\n" +              "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
          + "\n" +              "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
          + "\n" +              "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(DECODE(t_iProcRateType, 1, t_rest, 0) * t_iProcRate)/SUM(DECODE(t_iProcRateType, 1, t_rest, 0))"
          + "\n" +              "               END t_resultRate,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0) * t_iProcRate)/SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0))"
          + "\n" +              "               END t_resultRateMsp,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0) * t_iProcRate)/SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0))"
          + "\n" +              "               END t_resultRateAuto,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_iPart) = 0 AND GROUPING(t_szContragent) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               END t_partSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szContragent) = 0 AND GROUPING(t_totalsrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               END t_contragentSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_totalsrok) = 0 AND GROUPING(t_szSrok) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               END t_totalSrokSum,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
          + "\n" +              "                       THEN 'TOTAL'"
          + "\n" +              "                   ELSE '0'"
          + "\n" +              "               END t_srokSum,"
          + "\n" +              "               data.t_iPart,"
          + "\n" +              "               data.t_szContragent,"
          + "\n" +              "               0 t_isMsp,"
          + "\n" +              "               0 t_isAuto,"
          + "\n" +              "               SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_resultRestMsp,"
          + "\n" +              "               SUM(DECODE(t_isAuto, 1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_resultRestAuto,"
          + "\n" +              "               SUM(DECODE(t_isMsp,  1, DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0), 0)) t_prolongedResultRestMsp,"
          + "\n" +              "               SUM(DECODE(t_isAuto, 1, DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0), 0)) t_prolongedResultRestAuto,"
          + "\n" +              "               SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, 0, t_rest), 0)) t_floatingRateResultRestMsp,"
          + "\n" +              "               SUM(DECODE(t_isAuto, 1, DECODE(t_iProcRateType, 1, 0, t_rest), 0)) t_floatingRateResultRestAuto,"
          + "\n" +              "               data.t_szSrok,"
          + "\n" +              "               data.t_szContractNumber,"
          + "\n" +              "               data.t_cbAccountNumber,"
          + "\n" +              "               data.t_operationTypedId,"
          + "\n" +              "               data.t_bdContractDate,"
          + "\n" +              "               data.t_objectId,"
          + "\n" +              "               data.t_objectNumber,"
          + "\n" +              "               data.t_bdpayDate,"
          + "\n" +              "               data.t_iProcRate,"
          + "\n" +              "               data.t_iTrancheSrok,"
          + "\n" +              "               data.t_rest,"
          + "\n" +              "               data.t_creditId,"
          + "\n" +              "               data.t_iProcRateType,"
          + "\n" +              "               data.t_operationHistory,"
          + "\n" +              "               data.T_correctiondate,"
          + "\n" +              "               data.T_totalsrok,"
          + "\n" +              "               data.t_sortByContragent, "
          + "\n" +              "               0 t_sort "
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContragent = '" + ФЛ + "'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = '" + ЮЛ + "'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp"
          + "\n" +              "                  WHERE temp.t_contractType = 1) data"
          + "\n" +              "        GROUP BY ROLLUP (t_iPart,"
          + "\n" +              "                         (t_sortByContragent, t_szContragent),"
          + "\n" +              "                         t_totalSrok, t_szSrok,"
          + "\n" +              "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, t_objectId,"
          + "\n" +              "                          t_objectNumber, t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate))"
          + "\n" +              "        HAVING GROUPING(t_iPart) = 0"
          + "\n" +              "  UNION ALL SELECT DECODE(t_iProcRateType, 1, t_rest, 0) t_resultRest,"
          + "\n" +              "                   DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0) t_prolongedResultRest,"
          + "\n" +              "                   DECODE(t_iProcRateType, 1, 0, t_rest) t_floatingRateResultRest,"
          + "\n" +              "               CASE"
          + "\n" +              "                   WHEN DECODE(t_iProcRateType, 1, t_rest, 0) = 0"
          + "\n" +              "                       THEN 0"
          + "\n" +              "                   ELSE DECODE(t_iProcRateType, 1, t_rest, 0) * t_iProcRate/DECODE(t_iProcRateType, 1, t_rest, 0)"
          + "\n" +              "               END t_resultRate,"
          + "\n" +              "               0 t_resultRateMsp,"
          + "\n" +              "               0 t_resultRateAuto,"
          + "\n" +              "               '0' t_partSum,"
          + "\n" +              "               '0' t_contragentSum,"
          + "\n" +              "               '0' t_totalSrokSum,"
          + "\n" +              "               '0' t_srokSum,"
          + "\n" +              "               data.t_iPart,"
          + "\n" +              "               data.t_szContragent,"
          + "\n" +              "               data.t_isMsp,"
          + "\n" +              "               data.t_isAuto,"
          + "\n" +              "               0 t_resultRestMsp,"
          + "\n" +              "               0 t_resultRestAuto,"
          + "\n" +              "               0 t_floatingRateResultRestMsp,"
          + "\n" +              "               0 t_floatingRateResultRestAuto,"
          + "\n" +              "               0 t_prolongedResultRestMsp,"
          + "\n" +              "               0 t_prolongedResultRestAuto,"
          + "\n" +              "               data.t_szSrok,"
          + "\n" +              "               data.t_szContractNumber,"
          + "\n" +              "               data.t_cbAccountNumber,"
          + "\n" +              "               data.t_operationTypedId,"
          + "\n" +              "               data.t_bdContractDate,"
          + "\n" +              "               data.t_objectId,"
          + "\n" +              "               data.t_objectNumber,"
          + "\n" +              "               data.t_bdpayDate,"
          + "\n" +              "               data.t_iProcRate,"
          + "\n" +              "               data.t_iTrancheSrok,"
          + "\n" +              "               data.t_rest,"
          + "\n" +              "               data.t_creditId,"
          + "\n" +              "               data.t_iProcRateType,"
          + "\n" +              "               data.t_operationHistory,"
          + "\n" +              "               data.T_correctiondate,"
          + "\n" +              "               data.T_totalsrok,"
          + "\n" +              "               data.t_sortByContragent, "
          + "\n" +              "               1 t_sort "
          + "\n" +              "          FROM (SELECT temp.*,"
          + "\n" +              "                       CASE"
          + "\n" +              "                           WHEN t_szContragent = '" + ФЛ + "'"
          + "\n" +              "                               THEN 0"
          + "\n" +              "                           WHEN t_szContragent = '" + ЮЛ + "'"
          + "\n" +              "                               THEN 1"
          + "\n" +              "                           ELSE NULL"
          + "\n" +              "                       end t_sortByContragent,"
          + "\n" +              "                       SUBSTR(t_szSrok, 1, 1) t_totalSrok"
          + "\n" +              "                  FROM DTEMP_128_TMP temp"
          + "\n" +              "                  WHERE temp.t_contractType = 1"
          + "\n" +              "                    AND (t_isMsp = 1 OR t_isAuto = 1) "
          + "\n" +              "               ORDER BY t_iPart, t_sortByContragent, t_szContragent, t_szSrok, "
          + "\n" +              "                        t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, "
          + "\n" +              "                        t_objectNumber, t_bdPayDate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate "
          + "\n" +              "                  ) data"
          + "\n" +              "                  )"
          + "\n" +              "ORDER BY t_iPart, t_partSum DESC, t_sortByContragent, t_contragentSum DESC, t_sort, t_totalSrok, t_totalSrokSum DESC, t_szSrok, t_srokSum DESC");

      var dataSet73 = TRsbDataSet("SELECT "
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    sum(data.t_rest) as t_rest,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_contracttype,"
          + "\n" +                "    NVL(data.t_iprocRate, MAX(data.t_iProcRate)) AS t_iProcRate,"
          + "\n" +                "    MAX(data.t_iProcRate) AS t_maxiProcRate,"
          + "\n" +                "    CASE "
          + "\n" +                "        WHEN GROUPING(data.t_rest) = 1"
          + "\n" +                "            THEN 'TOTAL'"
          + "\n" +                "        ELSE '0'"
          + "\n" +                "    END AS t_contractTypeTotal,"
          + "\n" +                "    data.t_operationHistory"
          + "\n" +                "FROM"
          + "\n" +                "    (SELECT "
          + "\n" +                "        temp.*"
          + "\n" +                "    FROM "
          + "\n" +                "        dtemp_128_tmp temp"
          + "\n" +                "    WHERE"
          + "\n" +                "        temp.t_iPart = 1 "
          + "\n" +                "        AND   ((temp.t_contractType = " + LO_KARTA + " AND temp.t_szContragent = '" + ФЛ + "') "
          + "\n" +                "            OR (temp.t_contractType = " + LO_OVERDRAFT + " AND temp.t_szContragent = '" + ЮЛ + "'))"
          + "\n" +                "    ) data"
          + "\n" +                "GROUP BY ROLLUP"
          + "\n" +                "    (data.t_contracttype,"
          + "\n" +                "    (data.t_Rest ,"
          + "\n" +                "    data.t_szContractNumber,"
          + "\n" +                "    data.t_bdContractDate,"
          + "\n" +                "    data.t_bdPayDate,"
          + "\n" +                "    data.t_cbAccountNumber,"
          + "\n" +                "    data.t_operationTypedId,"
          + "\n" +                "    data.t_iTrancheSrok,"
          + "\n" +                "    data.t_iProcRate,"
          + "\n" +                "    data.t_szSrok,"
          + "\n" +                "    data.t_operationHistory))"
          + "\n" +                "HAVING GROUPING(data.t_contracttype) = 0"
          + "\n" +                "ORDER BY t_rest DESC", RSDVAL_CLIENT, RSDVAL_STATIC );

      var previousContragent = "";
      var isPrintTermName    = true;
      var isEmpty            = true;
      var isPrintString73    = false;
      var isPrint = true;
      var line = "";
      var contract = "";
      var date = "";
      var sort = 0;

      while (dataSet.moveNext())
          if ((line == dataSet.szSrok) and (contract == dataSet.szContractNumber) and (date == dataSet.bdContractDate))
              isPrint = false;
          else
              if (line != dataSet.szSrok)
                  printTotalRest();

                  //печать горизонтального разделителя строк
                  if (
                       //борьба с паразитными разделителями строк в протоколе:
                           (isPrint == true)                                               //если была выведена хоть одна строка данных
                       and not ((dataSet.contragentSum == "TOTAL") and (not isEmpty))      //конец таблицы "Физические лица, в том числе автокредиты"
                       and not (dataSet.sort != sort)
                       and not ((dataSet.iPart == 2) and (isPrintString73 == false))
                     )
                      printSeparaionLine();
                  end;
                  isPrintTermName = true;
              end;

              line = dataSet.szSrok;
              contract = dataSet.szContractNumber;
              date = dataSet.bdContractDate;
              isPrint = true;
          end;

          if (dataSet.partSum == "TOTAL")

              /*итог по разделу*/
          elif (dataSet.contragentSum == "TOTAL")
              if ((dataSet.szContragent == ФЛ) and (previousContragent == ЮЛ) and (dataSet.iPart == 2))
                  calculateString73(dataSet73, ЮЛ);
                  isPrintString73 = true;
              end;

              if (not isEmpty)
                  printBottom(previousContragent);
              end;

              sort = dataSet.sort;
              printPartHeader(dataSet.iPart, dataSet.szContragent, sort);
              isEmpty = false;
          elif (dataSet.totalSrokSum == "TOTAL")
              if (dataSet.totalSrok == "1")
                  saveTotalSrokVariable(dataSet);
              end;
          elif (dataSet.srokSum == "TOTAL")
              isPrintTermName = true;
              if (substr(dataset.szSrok, 1, 1) == "7") // сохраняем переменные для раздела 7.Справочно
                  saveReferenceVariables(dataset);
              else
                  saveTotalSubSrokVariable(dataSet);
              end;
          else
              if (dataSet.sort != sort)
                  if ((dataSet.iPart == 1) and (dataSet.szContragent == ФЛ))
                      calculateString73(dataSet73, ФЛ);
                      isPrintString73 = true;
                  end;

                  sort = dataSet.sort;
                  isPrintTermName = true;
                  isPrint = true;
                  printBottom(previousContragent);
                  printPartHeader(dataSet.iPart, dataSet.szContragent, sort);
              end;

              if ((dataSet.iPart == 1) and (isPrintString73 == false) and (dataSet.szContragent == ЮЛ))
                  calculateString73(dataSet73, ФЛ);
              end;

              if ((dataSet.iPart == 2) and (isPrintString73 == false))
                  if (calculateString73(dataSet73, ФЛ))
                      printBottom(ЮЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent, sort);
                  end;
                  if (calculateString73(dataSet73, ЮЛ))
                      printBottom(ФЛ);
                      printPartHeader(dataSet.iPart, dataSet.szContragent, sort);
                  end;
              end;

              if (dataSet.iProcRate != 0)
                  printTerm(dataSet, isPrintTermName, isPrint);
              end;

              isPrintTermName = false;
              previousContragent = dataSet.szContragent;
          end;
      end;

      if (isEmpty == true)
          if (calculateString73(dataSet73, ФЛ, true))
              isEmpty = false;
          end;

          if (calculateString73(dataSet73, ЮЛ, true, not isEmpty))
              isEmpty = false;
          end;
      end;

      if (isEmpty == true)
          println("  Нет данных для отчета.");
      else
          printBottom(previousContragent);
      end;

      viewFileLog(ИмяФайлаПротокола);
    end;

    private macro constructorTReportController_3006()

        initTReportController_2926();

        m_protocol = CTableReport();
        m_protocol.addColumn("Строка отчета",                             25.0, AL_LEFT);
        m_protocol.addColumn("№ договора",                                16.0, AL_LEFT);
        m_protocol.addColumn("Дата договора",                             10.0, AL_CENTER);
        m_protocol.addColumn("Дата выдачи",                               10.0, AL_CENTER);
        m_protocol.addColumn("Номер л/с",                                 23.0, AL_LEFT);
        m_protocol.addColumn("Тип операции",                              11.0, AL_LEFT);
        m_protocol.addColumn("Срок операции",                             11.0, AL_LEFT);
        m_protocol.addColumn("% ставка",                                  11.0, AL_LEFT);
        m_protocol.addColumn("Сумма операции",                            19.0, AL_RIGHT);
        m_protocol.addColumn("Корректирующая операция",                   14.0, AL_LEFT);
        m_protocol.addColumn("Дата, за которую проведена корр. операция", 26.0, AL_CENTER);

        SrokNumber = TArray();      SrokName = TArray();                                                            SrokShifr = TArray();
        SrokNumber( 1) = "1.1";     SrokName( 1) = SrokNumber( 1) + ". До востребования";                           SrokShifr( 1) = "1_1";
        SrokNumber( 2) = "1.2";     SrokName( 2) = SrokNumber( 2) + ". На 1 день";                                  SrokShifr( 2) = "1_2";
        SrokNumber( 3) = "1.3";     SrokName( 3) = SrokNumber( 3) + ". От 2 до 7 дней";                             SrokShifr( 3) = "1_3";
        SrokNumber( 4) = "1.4";     SrokName( 4) = SrokNumber( 4) + ". От 8 до 30 дней";                            SrokShifr( 4) = "1_4";
        SrokNumber( 5) = "2";       SrokName( 5) = SrokNumber( 5) + ". От 31 до 90 дней";                           SrokShifr( 5) = "2__";
        SrokNumber( 6) = "3";       SrokName( 6) = SrokNumber( 6) + ". От 91 дней до 180 дней";                     SrokShifr( 6) = "3__";
        SrokNumber( 7) = "4";       SrokName( 7) = SrokNumber( 7) + ". От 181 дня до 1 года";                       SrokShifr( 7) = "4__";
        SrokNumber( 8) = "5";       SrokName( 8) = SrokNumber( 8) + ". От 1 года до 3 лет";                         SrokShifr( 8) = "5__";
        SrokNumber( 9) = "6";       SrokName( 9) = SrokNumber( 9) + ". Свыше 3 лет";                                SrokShifr( 9) = "6__";
        SrokNumber(10) = "7.1";     SrokName(10) = SrokNumber(10) + ". Пролонгированные кредиты";                   SrokShifr(10) = "71_";
        SrokNumber(11) = "7.2";     SrokName(11) = SrokNumber(11) + ". Кредиты по переменной процентной ставке";    SrokShifr(11) = "72_";
        SrokNumber(12) = "7.3";     SrokName(12) = SrokNumber(12) + ". Операции с использованием банковских карт";  SrokShifr(12) = "73_";
    end;

    constructorTReportController_3006();
end;

class (TReportController_3006) TReportController_3468()

    private macro getCreditTypeQuery() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN operation.t_tarifType = 2 THEN '72_'"
         +"\n"+"                   WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                   WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                   WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                   WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                   WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                   WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                   ELSE '___'"
         +"\n"+"               END                                                AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType"
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate "
         +"\n"+"                   WHEN 2 THEN operation.t_interestRate "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               CASE "
         +"\n"+"                   WHEN regexp_like(upper(contract.t_aim), 'А') AND (party.t_isPhisical = 1)"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                   t_isAuto,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', party.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                    t_isMsp"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND contract.t_type = " + LO_CREDIT
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND NOT EXISTS(SELECT 1"
         +"\n"+"                            FROM dobjatcor_dbt atc"
         +"\n"+"                           WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
         +"\n"+"                             AND atc.t_GroupID    = " + RCB_OBJGROUP_AFFILIATES_CREDIT_ORG
         +"\n"+"                             AND atc.t_Object     = party.t_objectId"
         +"\n"+"                             AND atc.t_AttrID IN (SELECT att.t_AttrID"
         +"\n"+"                                                    FROM dobjattr_dbt att"
         +"\n"+"                                                   WHERE att.t_ObjectType = atc.t_ObjectType"
         +"\n"+"                                                     AND att.t_GroupID    = atc.t_GroupID"
         +"\n"+"                                                     AND att.t_numInList = " + getSqlString("АФЛ") + ")"
         +"\n"+"                                                     AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)"
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )";
    end;

    private macro getCreditTypeQuery_73() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE) + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE) + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               '73_'                                              AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               account.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               contract.t_maxTarifValue                           AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               0                                                  AS t_isAuto,"
         +"\n"+"               0                                                  AS t_isMsp"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsAccount_vw account"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND operation.t_contractId = account.t_contractId"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND contract.t_type IN (" + LO_KARTA + ", " + LO_OVERDRAFT + ")"
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND contract.t_maxTarifValue != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND contract.t_type = " + LO_KARTA
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND contract.t_type = " + LO_OVERDRAFT
         +"\n"+"                    AND account.t_type = 'С'"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ_73, "account.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )"
         ;
    end;

    private macro getDataWithTypeProlingationOrPayment()

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_ismsp,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isauto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "  FROM ("
            +"\n"+           getCreditTypeQuery()
            +"\n"+  "       )"
            +"\n"+  "GROUP BY("
            +"\n"+  "       t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "        )"
            );

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_ismsp,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isauto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "  FROM ("
            +"\n"+           getCreditTypeQuery_73()
            +"\n"+  "       )"
            +"\n"+  "GROUP BY("
            +"\n"+  "       t_part,"
            +"\n"+  "       t_contragentCode,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       t_srok,"
            +"\n"+  "       t_creditNumberForReport,"
            +"\n"+  "       t_cbAccountNumber,"
            +"\n"+  "       t_type,"
            +"\n"+  "       t_creditOpenDate,"
            +"\n"+  "       t_trancheKind,"
            +"\n"+  "       t_trancheNumber,"
            +"\n"+  "       t_date,"
            +"\n"+  "       t_interestRate,"
            +"\n"+  "       t_term,"
            +"\n"+  "       t_sum,"
            +"\n"+  "       t_creditId,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_interestRateType,"
            +"\n"+  "       t_operationHistory,"
            +"\n"+  "       t_correctionDate,"
            +"\n"+  "       t_credittype"
            +"\n"+  "        )"
            );

        var commandTranches = RsdCommand(rslDefCon);

        var queryTranches = "(SELECT t_objectnumber AS a_objectNumber,"
                   + "\n" + "        t_objectid     AS a_objectTypeId "
                   + "\n" + "   FROM dtemp_128_tmp)          ";

        commandTranches.cmdText = "CALL LoansVox.fillHistPerc(?, ?, ?)";
        commandTranches.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        commandTranches.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        commandTranches.addParam("DataSource", RSDBP_IN, queryTranches);

        commandTranches.execute();

        sql_execute("INSERT INTO dtemp_128_tmp("
            +"\n"+  "       t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_ismsp,"
            +"\n"+  "       t_szsrok,"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationtypedid,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isauto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype)"
            +"\n"+  "SELECT t_ipart,"
            +"\n"+  "       t_szcontragent,"
            +"\n"+  "       t_isMsp,"
            +"\n"+  "       '71_',"
            +"\n"+  "       t_szcontractnumber,"
            +"\n"+  "       t_cbaccountnumber,"
            +"\n"+  "       t_operationTypedId,"
            +"\n"+  "       t_bdcontractdate,"
            +"\n"+  "       t_objectid,"
            +"\n"+  "       t_objectnumber,"
            +"\n"+  "       t_bdpaydate,"
            +"\n"+  "       t_iprocrate,"
            +"\n"+  "       t_itranchesrok,"
            +"\n"+  "       t_rest,"
            +"\n"+  "       t_creditid,"
            +"\n"+  "       t_isAuto,"
            +"\n"+  "       t_iprocratetype,"
            +"\n"+  "       t_operationhistory,"
            +"\n"+  "       t_correctiondate,"
            +"\n"+  "       t_contracttype"
            +"\n"+  "  FROM dtemp_128_tmp"
            +"\n"+  " WHERE t_operationTypedId = 5"
            +"\n"+  "   AND t_szsrok <> '73_'"
            +"\n"+  "   AND t_iprocratetype = 1");      //для строки 7.1 отбираем ДГ только с простой ставкой

        sql_execute("COMMIT");
    end;

    macro printTerm(dataSet, isPrintTermName, isPrint)
        macro getOperationTypeName(operationTypedId)
            if (operationTypedId == "2")
                return "выдача";
            elif (operationTypedId == "5")
                return "пролонгация";
            elif (operationTypedId == "S")
                return "размещение";
            end;
            return "";
        end;

        macro getSignCorrectionType(operationHistoryCode)
            var tabStr = "        ";
            if (operationHistoryCode == "К")
                return tabStr + "X";
            else
                return "";
            end;
        end;

        macro formatting(v)
            v = String(v);
            while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
                v = substr(v,1, strLen(v)-1);
            end;
            if (subStr(v,strLen(v)) == ".")
                v = substr(v,1, strLen(v)-1);
            end;
            return v;
        end;

        var rest = String(dataSet.rest);
        var srok : String;
        var percentRate = formatting(dataSet.iProcRate);

        if ((dataSet.szSrok == "71_") or (dataSet.szSrok == "72_"))
            srok = "-";
            percentRate = "-";
        else
            srok = dataSet.iTrancheSrok;
        end;

        var termName = "";
        var correction_Date = "";
        var signCorrectionType = getSignCorrectionType(dataSet.t_operationHistory);

        if (isPrintTermName)
            termName = FindSrokName(dataSet.szSrok);
        end;

        if (signCorrectionType != "")
            correction_Date = SQL_ConvTypeDate( dataSet.correctionDate );
        end;

        if (isPrint)
            m_protocol.printStringTransferByWord(termName, dataSet.szContractNumber, SQL_ConvTypeDate(dataSet.bdContractDate),
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        else
            m_protocol.printStringTransferByWord(termName, "" /* dataSet.szContractNumber */, "" /* SQL_ConvTypeDate(dataSet.bdContractDate) */,
                                                 SQL_ConvTypeDate(dataSet.bdPayDate), dataSet.cbAccountNumber,
                                                 getOperationTypeName(dataSet.t_operationTypedId), srok, percentRate, rest,
                                                 signCorrectionType, correction_Date);
        end;

        if (totalRest == 0.0)
            var i;
            for (i, 1, srokShifr.size)
                if (SrokShifr(i) == dataSet.szSrok)
                    break;
                end;
            end;
            termIndex = i;
        end;
        totalRest = totalRest + dataSet.rest;
    end;

    macro GetVarName( dataSet, NameColumn, Srok )
        var VarName =  "Ф128_";

        if  ( dataSet.iPart == RUR_PART ) VarName = VarName + RUR_CODE + "_";
        elif( dataSet.iPart == USD_PART ) VarName = VarName + USD_CODE + "_";
        elif( dataSet.iPart == EUR_PART ) VarName = VarName + EUR_CODE + "_";
        end;

        if  ( dataSet.szContragent == ФЛ ) VarName = VarName + ФЛ + "_";
        elif( dataSet.szContragent == ЮЛ ) VarName = VarName + ЮЛ + "_";
        end;

        VarName = VarName + ternary(Srok == "1", "1__", Srok) + "_" + NameColumn + "_К_";

        return VarName;
    end;

    macro saveReferenceVariables(dataSet : Object)
        if (dataset.szSrok == "71_")
            if (dataSet.Auto_Msp == 0)
                if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "71_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", "71_"));
                end;
            end;

            if ((dataSet.Auto_Msp == 1) and (dataSet.prolongedResultRest > 0))
                if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", "71_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", "71_"));
                end;
            end;

            if ((dataSet.Auto_Msp == 2) and (dataSet.prolongedResultRest > 0))
                if (dataSet.szContragent == ЮЛ)
                    if( not СохранитьПеременную2(dataSet.prolongedResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", "71_")))
                        msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", "71_"));
                    end;
                end;
            end;
        end;

        if (dataset.szSrok == "72_")
            if (dataSet.Auto_Msp == 0)
                if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", "72_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", "72_"));
                end;
            end;

            if ((dataSet.Auto_Msp == 1) and (dataSet.floatingRateResultRest > 0))
                if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", "72_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", "72_"));
                end;
            end;

            if ((dataSet.Auto_Msp == 2) and (dataSet.floatingRateResultRest > 0))
                if( not СохранитьПеременную2(dataSet.floatingRateResultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", "72_")))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", "72_"));
                end;
            end;
        end;
    end;

    macro saveTotalSubSrokVariable(dataSet : Object)
        if (dataSet.resultRest <= 500)
            dataSet.resultRate = 0;
        end;
        var name;

        if (dataSet.Auto_Msp == 0)
            if( not СохранитьПеременную ( dataSet.resultRate/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%_", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%_", dataSet.szSrok));
            end;
        end;

        if ((dataSet.Auto_Msp == 1) and (dataSet.resultRestAuto > 0))
            if( not СохранитьПеременную ( dataSet.resultRateAuto/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%А", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%А", dataSet.szSrok));
            end;
        end;

        if ((dataSet.Auto_Msp == 2) and (dataSet.resultRestMsp > 0))
            if (dataSet.szContragent == ЮЛ)
                if( not СохранитьПеременную ( dataSet.resultRateMsp/100, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "%П", dataSet.szSrok)))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "%П", dataSet.szSrok));
                end;
            end;
        end;

        if (dataSet.Auto_Msp == 0)
            if( not СохранитьПеременную2(dataSet.resultRest, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "С_", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "С_", dataSet.szSrok));
            end;
        end;

        if ((dataSet.Auto_Msp == 1) and (dataSet.resultRestAuto > 0))
            if( not СохранитьПеременную2(dataSet.resultRestAuto, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СА", dataSet.szSrok)))
                msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СА", dataSet.szSrok));
            end;
        end;

        if ((dataSet.Auto_Msp == 2) and (dataSet.resultRestMsp > 0))
            if (dataSet.szContragent == ЮЛ)
                if( not СохранитьПеременную2(dataSet.resultRestMsp, null, ДатаОтчета, ПредДатаОтчета, {Название отчета}, GetVarName(dataSet, "СП", dataSet.szSrok)))
                    msgbox("Ошибка сохранения переменной ", GetVarName(dataSet, "СП", dataSet.szSrok));
                end;
            end;
        end;
    end;

    macro calculateString73(dataSet)
        while (dataSet.moveNext())
            if (dataSet.contractTypeTotal == "TOTAL")
                saveVirables73(dataSet);
            end;
        end;
    end;

    macro getQuery(part, contragent)
        return   "SELECT *"
        + "\n" + "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
        + "\n" + "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
        + "\n" + "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) = 0"
        + "\n" + "                       THEN 0"
        + "\n" + "                   ELSE SUM(DECODE(t_iProcRateType, 1, t_rest, 0) * t_iProcRate)/SUM(DECODE(t_iProcRateType, 1, t_rest, 0))"
        + "\n" + "               END t_resultRate,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
        + "\n" + "                       THEN 'TOTAL'"
        + "\n" + "                   ELSE '0'"
        + "\n" + "               END t_srokSum,"
        + "\n" + "               data.t_iPart,"
        + "\n" + "               0 Auto_Msp,"                     //всего - 0, автокредиты - 1, МСП -2
        + "\n" + "               data.t_szContragent,"
        + "\n" + "               data.t_szSrok,"
        + "\n" + "               data.t_szContractNumber,"
        + "\n" + "               data.t_cbAccountNumber,"
        + "\n" + "               data.t_operationTypedId,"
        + "\n" + "               data.t_bdContractDate,"
        + "\n" + "               data.t_bdpayDate,"
        + "\n" + "               data.t_iProcRate,"
        + "\n" + "               data.t_iTrancheSrok,"
        + "\n" + "               data.t_rest,"
        + "\n" + "               data.t_operationHistory,"
        + "\n" + "               data.t_correctionDate"
        + "\n" + "          FROM (SELECT t_iPart, t_isAuto, t_isMsp, t_szContragent, t_szSrok,"
        + "\n" + "                       t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate,"
        + "\n" + "                       t_bdPayDate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate, t_iProcRate"
        + "\n" + "                  FROM DTEMP_128_TMP temp"
        + "\n" + "                 WHERE temp.t_iPart = " + part
        + "\n" + "                   AND t_szContragent = '" + contragent + "'"
        + "\n" + "                 UNION ALL"
                                  //данные по строке 1 в целом
        + "\n" + "                SELECT t_iPart, t_isAuto, t_isMsp, t_szContragent, SUBSTR(t_szSrok, 1, 1) t_szSrok,"
        + "\n" + "                       t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate,"
        + "\n" + "                       t_bdPayDate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate, t_iProcRate"
        + "\n" + "                  FROM DTEMP_128_TMP temp"
        + "\n" + "                 WHERE SUBSTR(t_szSrok, 1, 1) = '1'"
        + "\n" + "                   AND temp.t_iPart = " + part
        + "\n" + "                   AND t_szContragent = '" + contragent + "'"
        + "\n" + "               ) data"
        + "\n" + "        GROUP BY ROLLUP ( t_iPart, t_szContragent, t_szSrok,"
        + "\n" + "                         (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, "
        + "\n" + "                          t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_operationHistory, t_correctionDate))"
        + "\n" + "        HAVING GROUPING(t_szSrok) = 0"
        + "\n" + "       )"
        + "\n" + "ORDER BY t_szSrok, t_srokSum, t_iTrancheSrok";
    end;

    macro getQuery_Auto_Msp(part, contragent, filter, Auto_Msp)
        return   "SELECT DISTINCT *"
        + "\n" + "  FROM (SELECT SUM(DECODE(t_iProcRateType, 1, t_rest, 0)) t_resultRest,"
        + "\n" + "               SUM(DECODE(t_operationTypedId, 5, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_prolongedResultRest,"
        + "\n" + "               SUM(DECODE(t_iProcRateType, 1, 0, t_rest)) t_floatingRateResultRest,"
        + "\n" + "               0 t_resultRate,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) = 0"
        + "\n" + "                       THEN 0"
        + "\n" + "                   ELSE SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0) * t_iProcRate)/SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0))"
        + "\n" + "               END t_resultRateMsp,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) = 0"
        + "\n" + "                       THEN 0"
        + "\n" + "                   ELSE SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0) * t_iProcRate)/SUM(DECODE(t_isAuto,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0))"
        + "\n" + "               END t_resultRateAuto,"
        + "\n" + "               CASE"
        + "\n" + "                   WHEN GROUPING(t_szSrok) = 0 AND GROUPING(t_cbAccountNumber) = 1"
        + "\n" + "                       THEN 'TOTAL'"
        + "\n" + "                   ELSE '0'"
        + "\n" + "               END t_srokSum,"
        + "\n" + "               data.t_iPart,"
        + "\n" + "               " + Auto_Msp + " Auto_Msp,"    //всего - 0, автокредиты - 1, МСП -2
        + "\n" + "               data.t_szContragent,"
        + "\n" + "               SUM(DECODE(t_isMsp,  1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_resultRestMsp,"
        + "\n" + "               SUM(DECODE(t_isAuto, 1, DECODE(t_iProcRateType, 1, t_rest, 0), 0)) t_resultRestAuto,"
        + "\n" + "               data.t_szSrok,"
        + "\n" + "               data.t_szContractNumber,"
        + "\n" + "               data.t_cbAccountNumber,"
        + "\n" + "               data.t_operationTypedId,"
        + "\n" + "               data.t_bdContractDate,"
        + "\n" + "               data.t_bdpayDate,"
        + "\n" + "               data.t_iProcRate,"
        + "\n" + "               data.t_iTrancheSrok,"
        + "\n" + "               data.t_rest,"
        + "\n" + "               data.t_operationHistory,"
        + "\n" + "               data.t_correctionDate"
        + "\n" + "          FROM (SELECT t_iPart, t_isAuto, t_isMsp, t_szContragent, t_szSrok,"
        + "\n" + "                       t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate,"
        + "\n" + "                       t_bdPayDate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate, t_iProcRate"
        + "\n" + "                  FROM DTEMP_128_TMP temp"
        + "\n" + "                 WHERE temp.t_contractType = 1"
        + "\n" + "                   AND temp.t_iPart = " + part
        + "\n" + "                   AND t_szContragent = '" + contragent + "'"
        + "\n" + "                   " + filter
        + "\n" + "                 UNION ALL"
                                  //данные по строке 1 в целом
        + "\n" + "                SELECT t_iPart, t_isAuto, t_isMsp, t_szContragent, SUBSTR(t_szSrok, 1, 1) t_szSrok,"
        + "\n" + "                       t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate,"
        + "\n" + "                       t_bdPayDate, t_iTrancheSrok, t_rest, t_creditid, t_iProcRateType, t_operationHistory, t_correctionDate, t_iProcRate"
        + "\n" + "                  FROM DTEMP_128_TMP temp"
        + "\n" + "                 WHERE temp.t_contractType = 1"
        + "\n" + "                   AND SUBSTR(t_szSrok, 1, 1) = '1'"
        + "\n" + "                   AND temp.t_iPart = " + part
        + "\n" + "                   AND t_szContragent = '" + contragent + "'"
        + "\n" + "                   " + filter
        + "\n" + "               ) data"
        + "\n" + "         GROUP BY ROLLUP ( t_iPart, t_szContragent, t_szSrok,"
        + "\n" + "                          (t_szContractNumber, t_cbAccountNumber, t_operationTypedId, t_bdContractDate, "
        + "\n" + "                           t_bdPayDate, t_iProcRate, t_iTrancheSrok, t_rest, t_operationHistory, t_correctionDate))"
        + "\n" + "        HAVING GROUPING(t_szSrok) = 0"
        + "\n" + "       )"
        + "\n" + " WHERE NOT t_resultRest IS NULL"
        + "\n" + " ORDER BY t_szSrok, t_srokSum, t_iTrancheSrok";
    end;

    macro ПечатьПротокола()
        var dataSet;
        var query73;
        var dataSet73;

        query73 = "SELECT "
        + "\n" +  "    data.t_szContractNumber,"
        + "\n" +  "    data.t_bdContractDate,"
        + "\n" +  "    data.t_bdPayDate,"
        + "\n" +  "    data.t_cbAccountNumber,"
        + "\n" +  "    data.t_operationTypedId,"
        + "\n" +  "    data.t_iTrancheSrok,"
        + "\n" +  "    sum(data.t_rest) as t_rest,"
        + "\n" +  "    data.t_szSrok,"
        + "\n" +  "    data.t_contracttype,"
        + "\n" +  "    NVL(data.t_iprocRate, MAX(data.t_iProcRate)) AS t_iProcRate,"
        + "\n" +  "    MAX(data.t_iProcRate) AS t_maxiProcRate,"
        + "\n" +  "    CASE "
        + "\n" +  "        WHEN GROUPING(data.t_rest) = 1"
        + "\n" +  "            THEN 'TOTAL'"
        + "\n" +  "        ELSE '0'"
        + "\n" +  "    END AS t_contractTypeTotal,"
        + "\n" +  "    data.t_operationHistory"
        + "\n" +  "FROM"
        + "\n" +  "    (SELECT "
        + "\n" +  "        temp.*"
        + "\n" +  "    FROM "
        + "\n" +  "        dtemp_128_tmp temp"
        + "\n" +  "    WHERE"
        + "\n" +  "        temp.t_iPart = 1 "
        + "\n" +  "        AND   ((temp.t_contractType = " + LO_KARTA + " AND temp.t_szContragent = '" + ФЛ + "') "
        + "\n" +  "            OR (temp.t_contractType = " + LO_OVERDRAFT + " AND temp.t_szContragent = '" + ЮЛ + "'))"
        + "\n" +  "    ) data"
        + "\n" +  "GROUP BY ROLLUP"
        + "\n" +  "    (data.t_contracttype,"
        + "\n" +  "    (data.t_Rest ,"
        + "\n" +  "    data.t_szContractNumber,"
        + "\n" +  "    data.t_bdContractDate,"
        + "\n" +  "    data.t_bdPayDate,"
        + "\n" +  "    data.t_cbAccountNumber,"
        + "\n" +  "    data.t_operationTypedId,"
        + "\n" +  "    data.t_iTrancheSrok,"
        + "\n" +  "    data.t_iProcRate,"
        + "\n" +  "    data.t_szSrok,"
        + "\n" +  "    data.t_operationHistory))"
        + "\n" +  "HAVING GROUPING(data.t_contracttype) = 0"
        + "\n" +  "ORDER BY t_rest DESC";

        setoutput( ИмяФайлаПротокола );
        PrintHeader();

        class TPartInfo(part, contragent, sort, query)
            var m_part       = part;
            var m_contragent = contragent;
            var m_sort       = sort;
            var m_query      = query;
        end;

        //массив, содержащий данные для формирования ВСЕГО протокола и данные отчета (кроме строки 7.3 и пользовательского ввода)
        var partInfo = rcbArray().initialize(TPartInfo(1, ФЛ, 0, getQuery(1, ФЛ)),                                  //Раздел 1. Физические лица, всего
                                             TPartInfo(1, ФЛ, 1, getQuery_Auto_Msp(1, ФЛ, "AND t_isAuto = 1", 1)),  //Раздел 1. Физические лица, автокредиты
                                             TPartInfo(1, ЮЛ, 0, getQuery(1, ЮЛ)),                                  //Раздел 1. Нефинансовые организации, всего
                                             TPartInfo(1, ЮЛ, 1, getQuery_Auto_Msp(1, ЮЛ, "AND t_isMsp = 1", 2)),   //Раздел 1. Нефинансовые организации, кредиты МСП
                                             TPartInfo(2, ФЛ, 0, getQuery(2, ФЛ)),                                  //Раздел 2. Физические лица, всего
                                             TPartInfo(2, ФЛ, 1, getQuery_Auto_Msp(2, ФЛ, "AND t_isAuto = 1", 1)),  //Раздел 2. Физические лица, автокредиты
                                             TPartInfo(2, ЮЛ, 0, getQuery(2, ЮЛ)),                                  //Раздел 2. Нефинансовые организации, всего
                                             TPartInfo(2, ЮЛ, 1, getQuery_Auto_Msp(2, ЮЛ, "AND t_isMsp = 1", 2)),   //Раздел 2. Нефинансовые организации, кредиты МСП
                                             TPartInfo(3, ФЛ, 0, getQuery(3, ФЛ)),                                  //Раздел 3. Физические лица, всего
                                             TPartInfo(3, ФЛ, 1, getQuery_Auto_Msp(3, ФЛ, "AND t_isAuto = 1", 1)),  //Раздел 3. Физические лица, автокредиты
                                             TPartInfo(3, ЮЛ, 0, getQuery(3, ЮЛ)),                                  //Раздел 3. Нефинансовые организации, всего
                                             TPartInfo(3, ЮЛ, 1, getQuery_Auto_Msp(3, ЮЛ, "AND t_isMsp = 1", 2))    //Раздел 3. Нефинансовые организации, кредиты МСП
                                            );

        var isPrintTermName     = true;
        var isEmpty             = true;   //пуст ли протокол
        var isPrint             = true;
        var contract            = "";     //текущий контракт
        var sort                = 0;
        var isPartHeaderPrinted = false;  //шапка таблицы напечатана?
        var isBottomNeed        = false;  //нужна закрывашка
        var isSeparaionLineNeed = false;  //нужен горизонтальный разделитель

        //печатаем протокол
        partInfo.moveFirst();
        while (partInfo.moveNext())

            dataSet = TRsbDataSet(partInfo.getCurrentItem().m_query);
            isPartHeaderPrinted = false;
            isSeparaionLineNeed = false;

            while (dataSet.moveNext())

                isEmpty = false;  //какие-то данные точно есть

                //сохранение данных
                if (dataSet.srokSum == "TOTAL")
                    if (substr(dataset.szSrok, 1, 1) == "7")   //для строк 7.1 и 7.2
                        saveReferenceVariables(dataset);
                    else
                        saveTotalSubSrokVariable(dataSet);     //для строк 1-6
                    end;
                end;

                //печать заголовка таблицы
                if (isPartHeaderPrinted == false)
                    printPartHeader(partInfo.getCurrentItem().m_part, partInfo.getCurrentItem().m_contragent, partInfo.getCurrentItem().m_sort);
                    isPartHeaderPrinted = true;
                    isBottomNeed = true;
                end;

                //печать разделительной линии между строками
                if (isSeparaionLineNeed == true)
                    printSeparaionLine();
                    isSeparaionLineNeed = false;
                end;

                //выводим все тот же контракт?
                if (contract == dataSet.szContractNumber)
                    isPrint = false;
                else
                    isPrint = true;
                end;
                contract = dataSet.szContractNumber;

                //печать данных в протокол
                if (dataSet.srokSum == "TOTAL")
                    //печать итогов по строке
                    printTotalRest();
                    isSeparaionLineNeed = true;
                    isPrintTermName = true;
                else
                    //печать строки данных
                    printTerm(dataSet, isPrintTermName, isPrint);
                    isPrintTermName = false;
                end;
            end;

            //печатаем закрывашку таблицы (если был напечатан ее заголовок)
            if (isBottomNeed == true)
                printBottom();
                isBottomNeed = false;
            end;
        end;

        //сохранение данных по строке 7.3 (в протокол данные уже выведены)
        dataSet73 = TRsbDataSet(query73, RSDVAL_CLIENT, RSDVAL_STATIC);
        calculateString73(dataSet73);

        if (isEmpty == true)
            println("  Нет данных для отчета.");
        end;

        viewFileLog(ИмяФайлаПротокола);
    end;

    private macro constructorTReportController_3468()
        initTReportController_3006();
        SrokNumber(13) = "1";       SrokName(13) = SrokNumber(13) + ". До 30 дней, в том числе:";                   SrokShifr(13) = "1";
    end;

    constructorTReportController_3468();
end;

class (TReportController_3468) TReportController_4212()
    initTReportController_3468();

    private macro getCreditTypeQuery() : String
        return "        SELECT CASE (SELECT fi.t_fi_code"
         +"\n"+"                       FROM dfininstr_dbt fi"
         +"\n"+"                      WHERE fi.t_fiId = operation.t_currencyId"
         +"\n"+"                    )"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE)    + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(RUR_CODE_OR) + " THEN 1"
         +"\n"+"                   WHEN " + getSqlString(USD_CODE)    + " THEN 2"
         +"\n"+"                   WHEN " + getSqlString(EUR_CODE)    + " THEN 3"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_part,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN party.t_isPhisical = 1"
         +"\n"+"                       THEN " + getSqlString(ФЛ)
         +"\n"+"                   WHEN party.t_isPhisical = 0"
         +"\n"+"                       THEN " + getSqlString(ЮЛ)
         +"\n"+"                   ELSE CHR(1)"
         +"\n"+"               END                                                AS t_contragentCode,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN operation.t_tarifType = 2 THEN '72_'"
         +"\n"+"                   WHEN operation.t_term <=   0 THEN '1_1'"
         +"\n"+"                   WHEN operation.t_term  =   1 THEN '1_2'"
         +"\n"+"                   WHEN operation.t_term <=   7 THEN '1_3'"
         +"\n"+"                   WHEN operation.t_term <=  30 THEN '1_4'"
         +"\n"+"                   WHEN operation.t_term <=  90 THEN '2__'"
         +"\n"+"                   WHEN operation.t_term <= 180 THEN '3__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 1*12)) THEN '4__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) <= (ADD_MONTHS(operation.t_date, 3*12)) THEN '5__'"
         +"\n"+"                   WHEN (operation.t_date + operation.t_term) >  (ADD_MONTHS(operation.t_date, 3*12)) THEN '6__'"
         +"\n"+"                   ELSE '___'"
         +"\n"+"               END                                                AS t_srok,"
         +"\n"+"               contract.t_number                                  AS t_creditNumberForReport,"
         +"\n"+"               tranche.t_cbAccount                                AS t_cbAccountNumber,"
         +"\n"+"               operation.t_type                                   AS t_type,"
         +"\n"+"               contract.t_openDate                                AS t_creditOpenDate,"
         +"\n"+"               operation.t_trancheKind                            AS t_trancheKind,"
         +"\n"+"               operation.t_trancheNumber                          AS t_trancheNumber,"
         +"\n"+"               operation.t_date                                   AS t_date,"
         +"\n"+"               CASE operation.t_tarifType"
         +"\n"+"                   WHEN 1 THEN operation.t_interestRate "
         +"\n"+"                   WHEN 2 THEN operation.t_interestRate "
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                AS t_interestRate,"
         +"\n"+"               operation.t_term                                   AS t_term,"
         +"\n"+"               operation.t_sum                                    AS t_sum,"
         +"\n"+"               operation.t_contractId                             AS t_creditId,"
         +"\n"+"               operation.t_tarifType                              AS t_interestRateType,"
         +"\n"+"               operation.t_history                                AS t_operationHistory,"
         +"\n"+"               operation.t_correctionDate                         AS t_correctionDate,"
         +"\n"+"               contract.t_type                                    AS t_creditType,"
         +"\n"+"               CASE "
         +"\n"+"                   WHEN regexp_like(upper(contract.t_aim), 'А') AND (party.t_isPhisical = 1)"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                   t_isAuto,"
         +"\n"+"               CASE"
         +"\n"+"                   WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', party.t_objectId," + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") >0"
         +"\n"+"                       THEN 1"
         +"\n"+"                   ELSE 0"
         +"\n"+"               END                                                   t_isMsp"
         +"\n"+"          FROM repLnsOperation_vw operation,"
         +"\n"+"               repLnsContract_vw contract,"
         +"\n"+"               drepParty_vw party,"
         +"\n"+"               repLnsTranches_vw tranche"
         +"\n"+"         WHERE operation.t_contractId = contract.t_id"
         +"\n"+"           AND party.t_id = contract.t_contragentId"
         +"\n"+"           AND operation.t_trancheKind  = tranche.t_kind "
         +"\n"+"           AND operation.t_trancheNumber = tranche.t_number"
         +"\n"+"           AND contract.t_type = " + LO_CREDIT
         +"\n"+"           AND operation.t_type IN (2, 5)"
         +"\n"+"           AND (contract.t_subordinatedCredit = 0 OR contract.t_subordinatedCredit is null)"
         +"\n"+"           AND operation.t_date BETWEEN " + getSqlDate(ПредДатаОтчета)
         +"\n"+"                                    AND " + getSqlDate(ДатаОтчета)
         +"\n"+"           AND operation.t_interestRate != 0 "
         +"\n"+"           AND operation.t_currencyId IN (" + RUR_FIID_OR + ", " + RUR_FIID + ", " + USD_FIID + ", " + EUR_FIID + ")"
         +"\n"+"           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("contract.t_departmentId", "contract.t_branchId")
         +"\n"+"           AND NOT EXISTS(SELECT 1"
         +"\n"+"                            FROM dobjatcor_dbt atc"
         +"\n"+"                           WHERE atc.t_ObjectType = " + RCB_OBJTYPE_PARTY
         +"\n"+"                             AND atc.t_GroupID    = " + RCB_OBJGROUP_AFFILIATES_CREDIT_ORG
         +"\n"+"                             AND atc.t_Object     = party.t_objectId"
         +"\n"+"                             AND atc.t_AttrID IN (SELECT att.t_AttrID"
         +"\n"+"                                                    FROM dobjattr_dbt att"
         +"\n"+"                                                   WHERE att.t_ObjectType = atc.t_ObjectType"
         +"\n"+"                                                     AND att.t_GroupID    = atc.t_GroupID"
         +"\n"+"                                                     AND att.t_numInList = " + getSqlString("АФЛ") + ")"
         +"\n"+"                                                     AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)"
         +"\n"+"           AND (   (    party.t_isPhisical = 1"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ФЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"                OR (    party.t_isPhisical = 0"
         +"\n"+"                    AND party.t_isBank = 0"
         +"\n"+"                    AND (" + convertMaskToSqlFormat(Маска_ЮЛ, "tranche.t_cbAccount")
         +"\n"+"                        )"
         +"\n"+"                   )"
         +"\n"+"               )";
    end;
end;

/***************************************************************************************************
 *  Пересчет после свода
 **************************************************************************************************/
private class (TRecalculateExecutor) TRecalculateExecutor128()
    private macro initialize()
        m_backOfficeSuffixList[m_backOfficeSuffixList.size()] = TBackOffice(BOLoans).getSuffix();
        m_backOfficeSuffixList[m_backOfficeSuffixList.size()] = TBackOffice(BOIBC).getSuffix();
    end;

    initTRecalculateExecutor();
end;

private class (TRecalculateExecutor) TRecalculateExecutor128_2926()
    private macro initialize()
        m_backOfficeSuffixList[m_backOfficeSuffixList.size()] = TBackOffice(BOLoans).getSuffix();
        m_backOfficeSuffixList[m_backOfficeSuffixList.size()] = TBackOffice(BOIBC).getSuffix();
    end;

    private macro processOneGroupAttribute(attributeIdPreffix : String)
        macro processBackOffice(backOfficeSuffix : String)
            var dataProcessor = TDataProcessor_2926(attributeIdPreffix, backOfficeSuffix);
            var i = 0;

            while (i < m_summarizedReportsList.size())

                dataProcessor.addreportData(m_summarizedReportsList[i]);

                i = i + 1;
            end;

            dataProcessor.saveResult(m_currentReport);
        end;

        var i = 0;

        while (i < m_backOfficeSuffixList.size())
            processBackOffice(m_backOfficeSuffixList[i]);
            i = i + 1;
        end;
    end;

    initTRecalculateExecutor();
end;

/***************************************************************************************************
 *  Вызов функций осуществляется системной операцией
 **************************************************************************************************/
macro calculate()
    var repController;

    var profiler = TSQLProfiler(getTxtFileName("!c_f128_profile"));
    profiler.clear();
    profiler.on();

    if   (rcbApplication.currentReport.context.period.endDate >= RCB_I4212_DATE)
        repController = TReportController_4212();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I3468_DATE)
        repController = TReportController_3468();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I3006_DATE2)
        repController = TReportController_3006();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2926_DATE)
        repController = TReportController_2926();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2835_DATE4)
        repController = TReportController_2835();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2539_DATE)
        repController = TReportController_2539();
    elif (rcbApplication.currentReport.context.period.endDate >= RCB_I2332_DATE)
        repController = TReportController_2332();
    else
        repController = TReportController();
    end;

    repController.Расчет();
    repController.ПечатьПротокола();

    RcbApplication.TransactionManager.commit();
end;

macro recalculate()
    if (rcbApplication.currentReport.context.period.endDate >= RCB_I2926_DATE)
        TRecalculateExecutor128_2926().run();
    else
        TRecalculateExecutor128().run();
    end;

    RcbApplication.TransactionManager.commit();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
