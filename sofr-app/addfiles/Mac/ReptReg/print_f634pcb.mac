/*
$Name:        print_f634pcb.mac
$Module:      Регламентируемая отчетность
$Description: Печать протокола расчета 634. ГКБО
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Печать протокола расчета 634. ГКБО

  Создан: 07.08.2007 - ABP

          13.12.2007 ABP - SCR 118046. Вывод резервов ГКБО отдельным разделом.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import print_f634p;
import res_fun;
import testLib;

/**
 *  Неверное количество параметров
 */
private class (TException) TWrongParmCountException()
    initTException("Неверное количество параметров", true);
end;


/**
 *  Фильтр счетов по вхождению в расчет показателя формы
 */
private class TPositionCodeFilter()

    private const ADDING_TYPE_INCLUDE = 1;
    private const ADDING_TYPE_EXCLUDE = 2;

    private var m_includedPositionCodeList : Object;

    private var m_excludedPositionCodeList : Object;

    private macro add(positionCode, addingType)
        if (addingType == ADDING_TYPE_INCLUDE)
            m_includedPositionCodeList[m_includedPositionCodeList.size] = positionCode;
        else
            m_excludedPositionCodeList[m_excludedPositionCodeList.size] = positionCode;
        end;
    end;

    macro addIncluded(positionCode)
        add(positionCode, ADDING_TYPE_INCLUDE);
    end;

    macro addExcluded(positionCode)
        add(positionCode, ADDING_TYPE_EXCLUDE);
    end;

    macro reset()
        m_includedPositionCodeList.size = 0;
        m_excludedPositionCodeList.size = 0;
    end;

    macro getAsSqlString(accountTableAlias)

        defaultParm(accountTableAlias, "");

        var sqlClauseIncluded;

        var sqlClauseExcluded;

        var sqlClause;

        var fullFieldName = ternary((accountTableAlias != ""), accountTableAlias + ".t_usedByPosition", "t_usedByPosition");

        var positionCode;

        var i;

        i = 0;
        sqlClauseIncluded = "";

        while (i < m_includedPositionCodeList.size)
            if (i > 0)
                sqlClauseIncluded = sqlClauseIncluded + " OR ";
            end;

            positionCode = getSqlChar(m_includedPositionCodeList[i]);
            sqlClauseIncluded = sqlClauseIncluded + "(INSTR(" + fullFieldName + ", " + positionCode + ") > 0)";
            i = i + 1;
        end;

        if (sqlClauseIncluded != "")
            sqlClauseIncluded = "(" + sqlClauseIncluded +")";
        end;

        i = 0;
        sqlClauseExcluded = "";
        while (i < m_excludedPositionCodeList.size)
            if (i > 0)
                sqlClauseExcluded = sqlClauseExcluded + " AND ";
            end;

            positionCode = getSqlChar(m_excludedPositionCodeList[i]);

            sqlClauseExcluded = sqlClauseExcluded + "(INSTR(" + fullFieldName + ", " + positionCode + ") = 0)";

            i = i + 1;
        end;

        if (sqlClauseExcluded != "")
            sqlClauseExcluded = "(" + sqlClauseExcluded +")";
        end;

        if ((sqlClauseIncluded != "") and (sqlClauseExcluded != ""))
            sqlClause = "(" + sqlClauseIncluded + " AND " + sqlClauseExcluded + ")";
        else
            sqlClause = sqlClauseIncluded + sqlClauseExcluded;
        end;

        if (sqlClause == "")
            sqlClause = "(1 = 1)";
        end;

        return sqlClause;
    end;

    private macro constructorTPositionCodeFilter()
        m_includedPositionCodeList = TArray(5);
        m_excludedPositionCodeList = TArray(5);
    end;

    constructorTPositionCodeFilter();
end;

//!------------------------------------------Источники данных--------------------------------------------
/**
 *  Источник данных по остаткам счетов граф 3(VVV_3, VVV_3_810), 4(VVV_4, VVV_4_810), 5(VVV_5, VVV_5_810)
 */
private class (TPrinterDataSource) TDataSourceCbRests3_4_5(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)

    private var m_positionCodeFilter : TPositionCodeFilter;

    private macro makeDataQuery()

        var query;

        // Остаток в валюте расчета для счетов в нац. валюте без НВПИ
        var convertedRestClause = "DECODE(account.t_fiId, 0,"
                         + "\n" + "       rsb_fiinstr.convSumType(account.t_rest,"
                         + "\n" + "                               0,"
                         + "\n" + "                               account.t_fiIdLinked,"
                         + "\n" + "                               7,"
                         + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                         + "\n" + "                              ),"
                         + "\n" + "       account.t_rest"
                         + "\n" + ")";

        // Остаток в рублях для остатка-эквивалента счетов с НВПИ
        var roubleEquivalentRestClause = "rsb_fiinstr.convSumType(account.t_equivalentRest,"
                                + "\n" + "                        account.t_fiId,"
                                + "\n" + "                        0,"
                                + "\n" + "                        7,"
                                + "\n" + "                    " + getSqlDate(getParameters().getEndDate())
                                + "\n" + "                       )";

        var accountRestClause = "CASE"
                       + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true)
                       + "\n" + "        THEN DECODE(account.t_accountKind,"
                       + "\n" + "                " + getSqlChar("А") + ","
                       + "\n" + "                    -account.t_equivalentRest,"
                       + "\n" + "                    account.t_equivalentRest)"
                       + "\n" + "    ELSE DECODE(account.t_accountKind,"
                       + "\n" + "            " + getSqlChar("А") + ","
                       + "\n" + "            " + "-" + convertedRestClause + ","
                       + "\n" + "            " + convertedRestClause + ")"
                       + "\n" + " END";


        var accountRoubleRestClause = "CASE"
                             + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true) + " AND account.t_fiId != 0"
                             + "\n" + "        THEN DECODE(account.t_accountKind,"
                             + "\n" + "                " + getSqlChar("А") + ","
                             + "\n" + "                " + "-" + roubleEquivalentRestClause + ","
                             + "\n" + "                " + roubleEquivalentRestClause + ")"
                             + "\n" + "    ELSE DECODE(account.t_accountKind,"
                             + "\n" + "            " + getSqlChar("А") + ","
                             + "\n" + "                -account.t_roubleRest,"
                             + "\n" + "                account.t_roubleRest)"
                             + "\n" + " END";

        var usedByPositionFilterClause = m_positionCodeFilter.getAsSqlString("account");

        query =          "WITH account AS"
                + "\n" + "("
                + "\n" + " SELECT fi.t_code                   t_fiCode,"
                + "\n" + "        account.t_accountNumber     t_accountNumber,"
                + "\n" + "        account.t_accountKind       t_accountKind,"
                + "\n" + "        account.t_hasNvpi           t_hasNvpi,"
                + "\n" + "    " + accountRestClause + "       t_rest,"
                + "\n" + "    " + accountRoubleRestClause + " t_roubleRest"
                + "\n" + "   FROM df634cb_tmp account,"
                + "\n" + "        v_rcb_f634_fininstr fi"
                + "\n" + "  WHERE (account.t_fiId = fi.t_id OR account.t_fiIdLinked = fi.t_id)"
                + "\n" + "    AND (" + usedByPositionFilterClause + ")"
                + "\n" + "),"
                + "\n" + "protocolData AS"
                + "\n" + "("
                + "\n" + " SELECT DECODE(GROUPING(account.t_accountNumber), 1, 'Итого по валюте:', account.t_fiCode) t_fiCode,"
                + "\n" + "        NVL(account.t_accountNumber, " + getSqlString("") + ")                             t_accountNumber,"
                + "\n" + "        NVL(account.t_accountKind, " + getSqlString("") + ")                               t_accountKind,"
                + "\n" + "        SUM(account.t_rest)                                                                t_rest,"
                + "\n" + "        SUM(account.t_roubleRest)                                                          t_roubleRest,"
                + "\n" + "        NVL(account.t_hasNvpi, " + getSqlChar("") + ")                                     t_hasNvpi,"
                + "\n" + "        account.t_fiCode                                                                   t_sortingFiCode,"
                + "\n" + "        account.t_accountNumber                                                            t_sortingAccountNumber,"
                + "\n" + "        GROUPING_ID(account.t_fiCode,"
                + "\n" + "                    account.t_hasNvpi,"
                + "\n" + "                    account.t_accountNumber,"
                + "\n" + "                    account.t_accountKind"
                + "\n" + "                   )                                                                       t_grouping"
                + "\n" + "   FROM account account"
                + "\n" + "  GROUP BY ROLLUP(account.t_fiCode, account.t_hasNvpi, account.t_accountNumber, account.t_accountKind)"
                + "\n" + ")"
                + "\n" + "SELECT *"
                + "\n" + "  FROM protocolData"
                + "\n" + " WHERE t_grouping IN (0, 7)"
                + "\n" + " ORDER BY t_sortingFiCode, t_sortingAccountNumber";

        return query;

    end;

    macro getDataSource()
        return m_container;
    end;

    private macro constructorTDataSourceCbRests(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)
        initTPrinterDataSource(parameters);

        m_positionCodeFilter = positionCodeFilter;

        m_container = TRsbDataset(makeDataQuery());

        m_container.setFieldType("t_hasNvpi",    V_STRING);
        m_container.setFieldType("t_rest",       V_MONEY);
        m_container.setFieldType("t_roubleRest", V_MONEY);
    end;

    constructorTDataSourceCbRests(parameters, positionCodeFilter);
end;

/**
 *  Источник данных по остаткам счетов граф 7(VVV_Гар_ГК, VVV_Гар_810),  7(VVV_Аккредитив, VVV_Аккредитив_810)
 */
private class (TPrinterDataSource) TDataSourceCbRests7(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)

    private var m_positionCodeFilter : TPositionCodeFilter;

    private macro makeDataQuery()

        var query;

        // Остаток в валюте расчета для счетов в нац. валюте без НВПИ
        var convertedRestClause = "DECODE(account.t_fiId, 0,"
                         + "\n" + "       rsb_fiinstr.convSumType(account.t_rest,"
                         + "\n" + "                               0,"
                         + "\n" + "                               account.t_fiIdLinked,"
                         + "\n" + "                               7,"
                         + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                         + "\n" + "                              ),"
                         + "\n" + "       account.t_rest"
                         + "\n" + ")";

        // Остаток в рублях для остатка-эквивалента счетов с НВПИ
        var roubleEquivalentRestClause = "rsb_fiinstr.convSumType(account.t_equivalentRest,"
                                + "\n" + "                        account.t_fiId,"
                                + "\n" + "                        0,"
                                + "\n" + "                        7,"
                                + "\n" + "                    " + getSqlDate(getParameters().getEndDate())
                                + "\n" + "                       )";

        var accountRestClause = "CASE"
                       + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true)
                       + "\n" + "        THEN DECODE(account.t_accountKind,"
                       + "\n" + "                " + getSqlChar("А") + ","
                       + "\n" + "                    -account.t_equivalentRest,"
                       + "\n" + "                    account.t_equivalentRest)"
                       + "\n" + "    ELSE DECODE(account.t_accountKind,"
                       + "\n" + "            " + getSqlChar("А") + ","
                       + "\n" + "            " + "-" + convertedRestClause + ","
                       + "\n" + "            " + convertedRestClause + ")"
                       + "\n" + " END";


        var accountRoubleRestClause = "CASE"
                             + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true) + " AND account.t_fiId != 0"
                             + "\n" + "        THEN DECODE(account.t_accountKind,"
                             + "\n" + "                " + getSqlChar("А") + ","
                             + "\n" + "                " + "-" + roubleEquivalentRestClause + ","
                             + "\n" + "                " + roubleEquivalentRestClause + ")"
                             + "\n" + "    ELSE DECODE(account.t_accountKind,"
                             + "\n" + "            " + getSqlChar("А") + ","
                             + "\n" + "                -account.t_roubleRest,"
                             + "\n" + "                account.t_roubleRest)"
                             + "\n" + " END";

        var usedByPositionFilterClause = m_positionCodeFilter.getAsSqlString("account");

        var accountReserveClause = "account.t_reserveAmount";

        var accountEquivalentReserveClause = "rsb_fiinstr.convSumType(account.t_reserveAmount, 0, fi.t_id, 7, account.t_reserveDate)";

        query =          "WITH account AS"
                + "\n" + "("
                + "\n" + " SELECT fi.t_code                   t_fiCode,"
                + "\n" + "        fi.t_id                     t_rowFiId,"
                + "\n" + "        account.t_fiIdMain          t_accFiId,"
                + "\n" + "        account.t_chapterNumber     t_chapterNumber,"
                + "\n" + "        account.t_accountNumber     t_accountNumber,"
                + "\n" + "        account.t_accountKind       t_accountKind,"
                + "\n" + "        account.t_hasNvpi           t_hasNvpi,"
                + "\n" + "    " + accountRestClause + "       t_rest,"
                + "\n" + "    " + accountRoubleRestClause + " t_roubleRest,"
                + "\n" + "    " + accountReserveClause + "          t_reserveAmount,"
                + "\n" + "    " + accountEquivalentReserveClause + "t_equivalentReserveAmount,"
                + "\n" + "        account.t_reserveDate             t_reserveDate"
                + "\n" + "   FROM df634cb_tmp account,"
                + "\n" + "        v_rcb_f634_fininstr fi"
                + "\n" + "  WHERE (account.t_fiId = fi.t_id OR account.t_fiIdLinked = fi.t_id)"
                + "\n" + "    AND (" + usedByPositionFilterClause + ")"
                + "\n" + "),"
                + "\n" + "usedAccount AS"
                + "\n" + "("
                + "\n" + " SELECT account.*,"
                + "\n" + "        -(ABS(t_rest) - ABS(t_equivalentReserveAmount)) t_usedValue"
                + "\n" + "   FROM account"
                + "\n" + "),"
                + "\n" + "protocolData AS"
                + "\n" + "("
                + "\n" + " SELECT DECODE(GROUPING(account.t_accountNumber), 1, 'Итого по валюте:', account.t_fiCode) t_fiCode,"
                + "\n" + "        account.t_rowFiId                                                                  t_rowFiId,"
                + "\n" + "        account.t_accFiId                                                                  t_accFiId,"
                + "\n" + "        NVL(account.t_chapterNumber, 0)                                                    t_chapterNumber,"
                + "\n" + "        NVL(account.t_accountNumber, " + getSqlString("") + ")                             t_accountNumber,"
                + "\n" + "        NVL(account.t_accountKind, " + getSqlString("") + ")                               t_accountKind,"
                + "\n" + "        SUM(account.t_rest)                                                                t_rest,"
                + "\n" + "        SUM(account.t_roubleRest)                                                          t_roubleRest,"
                + "\n" + "        NVL(account.t_hasNvpi, " + getSqlChar("") + ")                                     t_hasNvpi,"
                + "\n" + "        account.t_fiCode                                                                   t_sortingFiCode,"
                + "\n" + "        DECODE(SUBSTR(account.t_accountNumber, 6, 3), '810',"
                + "\n" + "               NVL2(account.t_accountNumber,"
                + "\n" + "                    '8' || account.t_accountNumber,"
                + "\n" + "                    LPAD('9', 30, '9')),"
                + "\n" + "               NVL(account.t_accountNumber, LPAD('9', 30, '9')))                           t_sortingAccountNumber,"
                + "\n" + "        GROUPING_ID(account.t_fiCode,"
                + "\n" + "                    account.t_accFiId,"
                + "\n" + "                    account.t_hasNvpi,"
                + "\n" + "                    account.t_accountNumber,"
                + "\n" + "                    account.t_accountKind"
                + "\n" + "                   )                                                                       t_grouping,"
                + "\n" + "        SUM(account.t_reserveAmount)                                                       t_reserve,"
                + "\n" + "        SUM(account.t_equivalentReserveAmount)                                             t_equivalentReserve,"
                + "\n" + "        SUM(account.t_usedValue)                                                           t_usedValue,"
                + "\n" + "        account.t_reserveDate                                                              t_reserveDate"
                + "\n" + "   FROM usedAccount account"
                + "\n" + "  GROUP BY ROLLUP((account.t_fiCode, account.t_rowFiId), account.t_accFiId, account.t_hasNvpi, (account.t_accountNumber, account.t_chapterNumber, account.t_reserveDate), account.t_accountKind)"
                + "\n" + ")"
                + "\n" + "SELECT protocolData.*,"
                + "\n" + "       CASE WHEN t_reserveDate IS NULL"
                + "\n" + "                THEN 0"
                + "\n" + "            ELSE rsb_fiinstr.convSumType(1, t_rowFiId, 0, 7, t_reserveDate)"
                + "\n" + "       END                                                                                 t_rate"
                + "\n" + "  FROM protocolData"
                + "\n" + " WHERE t_grouping IN (0, 15)"
                + "\n" + " ORDER BY t_sortingFiCode, t_sortingAccountNumber";

        return query;

    end;

    macro getDataSource()
        return m_container;
    end;

    private macro constructorTDataSourceCbRests(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)
        initTPrinterDataSource(parameters);

        m_positionCodeFilter = positionCodeFilter;

        var query = makeDataQuery();

        m_container = TRsbDataset(query);

        m_container.setFieldType("t_hasNvpi",           V_STRING);
        m_container.setFieldType("t_rest",              V_MONEY);
        m_container.setFieldType("t_roubleRest",        V_MONEY);
        m_container.setFieldType("t_reserveDate",       V_DATE);
        m_container.setFieldType("t_reserve",           V_MONEY);
        m_container.setFieldType("t_equivalentReserve", V_MONEY);
        m_container.setFieldType("t_usedValue",         V_MONEY);
    end;

    constructorTDataSourceCbRests(parameters, positionCodeFilter);
end;

/**
 *  Источник данных по остаткам счетов граф 7(VVV_ГарантииПолуч_ГК, VVV_ГарПолуч_810_ГК), 7(VVV_Залог_ГК, VVV_Залог_810), 10(VVV_10_ГК)
 */
private class (TPrinterDataSource) TDataSourceCbRests7_10(parameters : TParameters, positionCodeFilter : TPositionCodeFilter, accRole)

    private var TYPE_PERCENT;
    private var TYPE_SECURITY;
    private var TYPE_GUARANTEE;

    private var m_positionCodeFilter : TPositionCodeFilter;
    private var m_accRole;
    private var m_accountTypeClause;

    private macro makeDataQuery()

        var query;

        // Остаток в валюте расчета для счетов в нац. валюте без НВПИ
        var convertedRestClause = "DECODE(account.t_fiId, 0,"
                         + "\n" + "       rsb_fiinstr.convSumType(account.t_rest,"
                         + "\n" + "                               0,"
                         + "\n" + "                               account.t_fiIdLinked,"
                         + "\n" + "                               7,"
                         + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                         + "\n" + "                              ),"
                         + "\n" + "       account.t_rest"
                         + "\n" + ")";

        var accountRestClause = "CASE"
                       + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true)
                       + "\n" + "        THEN DECODE(account.t_accountKind,"
                       + "\n" + "                " + getSqlChar("А") + ","
                       + "\n" + "                    -account.t_equivalentRest,"
                       + "\n" + "                    account.t_equivalentRest)"
                       + "\n" + "    ELSE DECODE(account.t_accountKind,"
                       + "\n" + "            " + getSqlChar("А") + ","
                       + "\n" + "            " + "-" + convertedRestClause + ","
                       + "\n" + "            " + convertedRestClause + ")"
                       + "\n" + " END";


        // Остаток в валюте расчета для основных счетов в нац. валюте без НВПИ
        var convertedRestMainClause =          "DECODE(account.t_fiIdMain, 0,"
                                      + "\n" + "       rsb_fiinstr.convSumType(account.t_restMain,"
                                      + "\n" + "                               0,"
                                      + "\n" + "                               account.t_fiIdLinked,"
                                      + "\n" + "                               7,"
                                      + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                                      + "\n" + "                              ),"
                                      + "\n" + "       account.t_restMain"
                                      + "\n" + ")";

        var accountRestMainClause =          "DECODE(account.t_accountKindMain,"
                                    + "\n" + "   " + getSqlChar("А") + ","
                                    + "\n" + "   " + "-" + convertedRestMainClause + ","
                                    + "\n" + "   " + convertedRestMainClause + ")";

        var accountRoubleRestMainClause =          "DECODE(account.t_accountKindMain,"
                                          + "\n" + "   " + getSqlChar("А") + ","
                                          + "\n" + "       -account.t_roubleRestMain,"
                                          + "\n" + "       account.t_roubleRestMain)";

        var usedByPositionFilterClause = m_positionCodeFilter.getAsSqlString("account");

        var accountReserveClause = "account.t_reserveAmount";

        var accountEquivalentReserveClause = "rsb_fiinstr.convSumType(account.t_reserveAmount, 0, fi.t_id, 7, account.t_reserveDate)";

        query =          "WITH account AS"
                + "\n" + "("
                + "\n" + " SELECT DISTINCT"
                + "\n" + "        fi.t_code                         t_fiCode,"
                + "\n" + "        fi.t_id                           t_rowFiId,"
                + "\n" + "        account.t_fiIdMain                t_accFiId,"
                + "\n" + "        account.t_chapterNumberMain       t_chapterNumber,"
                + "\n" + "        account.t_accountNumberMain       t_accountNumber,"
                + "\n" + "        account.t_accountKindMain         t_accountKind,"
                + "\n" + "    " + rcbSqlBool(false) + "             t_hasNvpi,"
                + "\n" + "    " + accountRestMainClause + "         t_rest,"
                + "\n" + "    " + accountRoubleRestMainClause + "   t_roubleRest,"
                + "\n" + "        account.t_accountNumber           t_accountNumberLinked,"
                + "\n" + "    " + accountRestClause + "             t_restLinked,"
                + "\n" + "    " + accountReserveClause + "          t_reserveAmount,"
                + "\n" + "    " + accountEquivalentReserveClause + "t_equivalentReserveAmount,"
                + "\n" + "        account.t_reserveDate             t_reserveDate"
                + "\n" + "   FROM df634cb_tmp account,"
                + "\n" + "        v_rcb_f634_fininstr fi"
                + "\n" + "  WHERE (account.t_fiId = fi.t_id OR account.t_fiIdLinked = fi.t_id)"
                + "\n" + "    AND (" + usedByPositionFilterClause + ")"
                + "\n" + "    AND t_accountType IN (" + m_accountTypeClause + ")"
                + "\n" + "),"
                + "\n" + "usedAccount AS"
                + "\n" + "("
                + "\n" + " SELECT account.*, "
                       + ternary(((m_accRole == TYPE_SECURITY) OR (m_accRole == TYPE_GUARANTEE)),
                  "\n" + "        CASE "
                + "\n" + "            WHEN account.t_chapterNumber = 1                                                    --Простое обеспечение "
                + "\n" + "                THEN CASE WHEN (    (ABS(t_restLinked) < ABS(t_rest))"
                + "\n" + "                   AND (ABS(t_restLinked) < ABS(t_equivalentReserveAmount)))"
                + "\n" + "                 THEN ABS(t_restLinked)"
                + "\n" + "             ELSE     ABS(t_equivalentReserveAmount)"
                + "\n" + "                     END"
                + "\n" + "            ELSE CASE                                                                           --Контргарантия"
                + "\n" + "                     WHEN ABS(t_restLinked) >= (ABS(t_rest) - ABS(t_equivalentReserveAmount))"
                + "\n" + "                         THEN ABS(t_rest) - ABS(t_equivalentReserveAmount)"
                + "\n" + "                     ELSE     ABS(t_restLinked)"
                + "\n" + "                 END"
                + "\n" + "        END",
                         ternary(m_accRole == TYPE_PERCENT,
                  "\n" + "        DECODE(t_rest, 0, 0, ABS(t_restLinked) * (ABS(t_rest) - ABS(t_equivalentReserveAmount)) / ABS(t_rest))",
                                  "0")) + " t_usedValue"
                + "\n" + "   FROM account"
                + "\n" + "),"
                + "\n" + "protocolData AS"
                + "\n" + "("
                + "\n" + " SELECT DECODE(GROUPING(account.t_accountNumber), 1, 'Итого по валюте:', account.t_fiCode) t_fiCode,"
                + "\n" + "        account.t_rowFiId                                                                  t_rowFiId,"
                + "\n" + "        account.t_accFiId                                                                  t_accFiId,"
                + "\n" + "        NVL(account.t_chapterNumber, 0)                                                    t_chapterNumber,"
                + "\n" + "        NVL(account.t_accountNumber, " + getSqlString("") + ")                             t_accountNumber,"
                + "\n" + "        NVL(account.t_accountKind, " + getSqlString("") + ")                               t_accountKind,"
                + "\n" + "        SUM(account.t_rest)                                                                t_rest,"
                + "\n" + "        SUM(account.t_roubleRest)                                                          t_roubleRest,"
                + "\n" + "        NVL(account.t_hasNvpi, " + getSqlChar("") + ")                                     t_hasNvpi,"
                + "\n" + "        account.t_fiCode                                                                   t_sortingFiCode,"
                + "\n" + "        DECODE(SUBSTR(account.t_accountNumber, 6, 3), '810',"
                + "\n" + "               NVL2(account.t_accountNumber,"
                + "\n" + "                    '8' || account.t_accountNumber,"
                + "\n" + "                    LPAD('9', 30, '9')),"
                + "\n" + "               NVL(account.t_accountNumber, LPAD('9', 30, '9')))                           t_sortingAccountNumber,"
                + "\n" + "        GROUPING_ID(account.t_fiCode,"
                + "\n" + "                    account.t_accFiId,"
                + "\n" + "                    account.t_hasNvpi,"
                + "\n" + "                    account.t_accountNumber,"
                + "\n" + "                    account.t_accountNumberLinked"
                + "\n" + "                   )                                                                       t_grouping,"
                + "\n" + "        NVL(account.t_accountNumberLinked, " + getSqlString("") + ")                       t_accountNumberLinked,"
                + "\n" + "        SUM(account.t_restLinked)                                                          t_restLinked,"
                + "\n" + "        SUM(account.t_reserveAmount)                                                       t_reserve,"
                + "\n" + "        SUM(account.t_equivalentReserveAmount)                                             t_equivalentReserve,"
                + "\n" + "        SUM(account.t_usedValue)                                                           t_usedValue,"
                + "\n" + "        account.t_reserveDate                                                              t_reserveDate"
                + "\n" + "   FROM usedAccount account"
                + "\n" + "  GROUP BY ROLLUP((account.t_fiCode, account.t_rowFiId), account.t_accFiId, account.t_hasNvpi, (t_accountNumberLinked, t_restLinked), (account.t_accountNumber, account.t_chapterNumber, account.t_accountKind, account.t_reserveDate))"
                + "\n" + ")"
                + "\n" + "SELECT protocolData.*,"
                + "\n" + "       CASE WHEN t_reserveDate IS NULL"
                + "\n" + "                THEN 0"
                + "\n" + "            ELSE rsb_fiinstr.convSumType(1, t_rowFiId, 0, 7, t_reserveDate)"
                + "\n" + "       END                                                                                 t_rate"
                + "\n" + "  FROM protocolData"
                + "\n" + " WHERE t_grouping IN (0, 15)"
                + "\n" + " ORDER BY t_sortingFiCode, t_sortingAccountNumber";

        return query;

    end;

    macro getDataSource()
        return m_container;
    end;

    private macro constructorTDataSourceCbRests(parameters : TParameters, positionCodeFilter : TPositionCodeFilter, accRole)
        initTPrinterDataSource(parameters);

        TYPE_PERCENT   = parameters.getAccountTypePercent();
        TYPE_SECURITY  = parameters.getAccountTypeSecurity();
        TYPE_GUARANTEE = parameters.getAccountTypeGuarantee();

        m_positionCodeFilter = positionCodeFilter;
        m_accRole = accRole;
        m_accountTypeClause = ternary(m_accRole == TYPE_SECURITY,  getSqlChar(getParameters().getAccountTypeSecurity()),
                              ternary(m_accRole == TYPE_GUARANTEE, getSqlChar(getParameters().getAccountTypeGuarantee()),
                              ternary(m_accRole == TYPE_PERCENT,   getSqlChar(getParameters().getAccountTypePercent()),
                                                                   getSqlChar(getParameters().getAccountTypeSecurity()) + ", "
                                                                  +getSqlChar(getParameters().getAccountTypeGuarantee()) + ", "
                                                                  +getSqlChar(getParameters().getAccountTypePercent())       )));

        var query = makeDataQuery();

        m_container = TRsbDataset(query);

        m_container.setFieldType("t_hasNvpi",           V_STRING);
        m_container.setFieldType("t_rest",              V_MONEY);
        m_container.setFieldType("t_roubleRest",        V_MONEY);
        m_container.setFieldType("t_restLinked",        V_MONEY);
        m_container.setFieldType("t_reserveDate",       V_DATE);
        m_container.setFieldType("t_reserve",           V_MONEY);
        m_container.setFieldType("t_equivalentReserve", V_MONEY);
        m_container.setFieldType("t_usedValue",         V_MONEY);
    end;

    constructorTDataSourceCbRests(parameters, positionCodeFilter, accRole);
end;

/**
 *  Источник данных по остаткам счетов граф 10(VVV_10_ГК)
 */
private class (TPrinterDataSource) TDataSourceCbRests10(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)

    private var m_positionCodeFilter : TPositionCodeFilter;

    private macro makeDataQuery()

        var query;

        // Остаток в валюте расчета для счетов в нац. валюте без НВПИ
        var convertedRestClause = "DECODE(account.t_fiId, 0,"
                         + "\n" + "       rsb_fiinstr.convSumType(account.t_rest,"
                         + "\n" + "                               0,"
                         + "\n" + "                               account.t_fiIdLinked,"
                         + "\n" + "                               7,"
                         + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                         + "\n" + "                              ),"
                         + "\n" + "       account.t_rest"
                         + "\n" + ")";

        var accountRestClause = "CASE"
                       + "\n" + "    WHEN account.t_hasNvpi = " + rcbSqlBool(true)
                       + "\n" + "        THEN DECODE(account.t_accountKind,"
                       + "\n" + "                " + getSqlChar("А") + ","
                       + "\n" + "                    -account.t_equivalentRest,"
                       + "\n" + "                    account.t_equivalentRest)"
                       + "\n" + "    ELSE DECODE(account.t_accountKind,"
                       + "\n" + "            " + getSqlChar("А") + ","
                       + "\n" + "            " + "-" + convertedRestClause + ","
                       + "\n" + "            " + convertedRestClause + ")"
                       + "\n" + " END";


        // Остаток в валюте расчета для основных счетов в нац. валюте без НВПИ
        var convertedRestMainClause =          "DECODE(account.t_fiIdMain, 0,"
                                      + "\n" + "       rsb_fiinstr.convSumType(account.t_restMain,"
                                      + "\n" + "                               0,"
                                      + "\n" + "                               account.t_fiIdLinked,"
                                      + "\n" + "                               7,"
                                      + "\n" + "                           " + getSqlDate(getParameters().getEndDate())
                                      + "\n" + "                              ),"
                                      + "\n" + "       account.t_restMain"
                                      + "\n" + ")";

        var accountRestMainClause =          "DECODE(account.t_accountKindMain,"
                                    + "\n" + "   " + getSqlChar("А") + ","
                                    + "\n" + "   " + "-" + convertedRestMainClause + ","
                                    + "\n" + "   " + convertedRestMainClause + ")";

        var accountRoubleRestMainClause =          "DECODE(account.t_accountKindMain,"
                                          + "\n" + "   " + getSqlChar("А") + ","
                                          + "\n" + "       -account.t_roubleRestMain,"
                                          + "\n" + "       account.t_roubleRestMain)";

        var usedByPositionFilterClause = m_positionCodeFilter.getAsSqlString("account");

        var accountReserveClause = "account.t_reserveAmount";
        var accountEquivalentReserveClause = "rsb_fiinstr.convSumType(account.t_reserveAmount, 0, fi.t_id, 7, account.t_reserveDate)";
        var accountTypeClause = getSqlChar(getParameters().getAccountTypePercent());

        query =          "WITH account AS"
                + "\n" + "("
                + "\n" + " SELECT fi.t_code                                                               t_fiCode,"
                + "\n" + "        fi.t_id                                                                 t_rowFiId,"
                + "\n" + "        account.t_fiIdMain                                                      t_accFiId,"
                + "\n" + "        account.t_chapterNumberMain                                             t_chapterNumber,"
                + "\n" + "        account.t_accountNumberMain                                             t_accountNumber,"
                + "\n" + "        account.t_accountKindMain                                               t_accountKind,"
                + "\n" + "    " + rcbSqlBool(false) + "                                                   t_hasNvpi,"
                + "\n" + "    " + accountRestMainClause + "                                               t_rest,"
                + "\n" + "    " + accountRoubleRestMainClause + "                                         t_roubleRest,"
                + "\n" + "        account.t_accountNumber                                                 t_accountNumberLinked,"
                + "\n" + "    " + accountRestClause + "                                                   t_restLinked,"
                + "\n" + "    " + accountReserveClause + "                                                t_reserveAmount,"
                + "\n" + "    " + accountEquivalentReserveClause + "                                      t_equivalentReserveAmount,"
                + "\n" + "        account.t_reserveDate                                                   t_reserveDate,"
                + "\n" + "        prcContract.t_contractBackoffice || ' ' || prcContract.t_contractNumber t_contractNumber"
                + "\n" + "   FROM df634cb_tmp account,"
                + "\n" + "        v_rcb_f634_fininstr fi,"
                + "\n" + "        drepaccountpercentaccounts_vw prcContract"
                + "\n" + "  WHERE (account.t_fiId = fi.t_id OR account.t_fiIdLinked = fi.t_id)"
                + "\n" + "    AND (" + usedByPositionFilterClause + ")"
                + "\n" + "    AND t_accountType IN (" + accountTypeClause + ")"
                + "\n" + "    AND prcContract.t_connectFiId    = account.t_fiIdMain"
                + "\n" + "    AND prcContract.t_connectChapter = account.t_chapterNumberMain"
                + "\n" + "    AND prcContract.t_connectAccount = account.t_accountNumberMain"
                + "\n" + "    AND prcContract.t_fiId    = account.t_fiId"
                + "\n" + "    AND prcContract.t_chapter = account.t_chapterNumber"
                + "\n" + "    AND prcContract.t_account = account.t_accountNumber"
                + "\n" + "),"
                + "\n" + "usedAccount AS"
                + "\n" + "("
                + "\n" + " SELECT account.*,"
                + "\n" + "        DECODE(t_rest, 0, 0,"
                + "\n" + "               ABS(t_restLinked) * (ABS(t_rest) - ABS(t_equivalentReserveAmount))"
                + "\n" + "               / ABS(t_rest)"
                + "\n" + "              )                                                                            t_usedValue"
                + "\n" + "   FROM account"
                + "\n" + "),"
                + "\n" + "protocolData AS"
                + "\n" + "("
                + "\n" + " SELECT DECODE(GROUPING(account.t_accountNumber), 1, 'Итого по валюте:', account.t_fiCode) t_fiCode,"
                + "\n" + "        account.t_rowFiId                                                                  t_rowFiId,"
                + "\n" + "        account.t_accFiId                                                                  t_accFiId,"
                + "\n" + "        NVL(account.t_chapterNumber, 0)                                                    t_chapterNumber,"
                + "\n" + "        NVL(account.t_accountNumber, " + getSqlString("") + ")                             t_accountNumber,"
                + "\n" + "        NVL(account.t_accountKind, " + getSqlString("") + ")                               t_accountKind,"
                + "\n" + "        SUM(account.t_rest)                                                                t_rest,"
                + "\n" + "        SUM(account.t_roubleRest)                                                          t_roubleRest,"
                + "\n" + "        NVL(account.t_hasNvpi, " + getSqlChar("") + ")                                     t_hasNvpi,"
                + "\n" + "        account.t_fiCode                                                                   t_sortingFiCode,"
                + "\n" + "        DECODE(SUBSTR(account.t_accountNumber, 6, 3), '810',"
                + "\n" + "               NVL2(account.t_accountNumber,"
                + "\n" + "                    '8' || account.t_accountNumber,"
                + "\n" + "                    LPAD('9', 30, '9')),"
                + "\n" + "               NVL(account.t_accountNumber, LPAD('9', 30, '9')))                           t_sortingAccountNumber,"
                + "\n" + "        GROUPING_ID(account.t_fiCode,"
                + "\n" + "                    account.t_accFiId,"
                + "\n" + "                    account.t_hasNvpi,"
                + "\n" + "                    account.t_accountNumber,"
                + "\n" + "                    account.t_accountNumberLinked"
                + "\n" + "                   )                                                                       t_grouping,"
                + "\n" + "        NVL(account.t_accountNumberLinked, " + getSqlString("") + ")                       t_accountNumberLinked,"
                + "\n" + "        SUM(account.t_restLinked)                                                          t_restLinked,"
                + "\n" + "        SUM(account.t_reserveAmount)                                                       t_reserve,"
                + "\n" + "        SUM(account.t_equivalentReserveAmount)                                             t_equivalentReserve,"
                + "\n" + "        SUM(account.t_usedValue)                                                           t_usedValue,"
                + "\n" + "        account.t_reserveDate                                                              t_reserveDate,"
                + "\n" + "        account.t_contractNumber                                                           t_contractNumber"
                + "\n" + "   FROM usedAccount account"
                + "\n" + "  GROUP BY ROLLUP((account.t_fiCode, account.t_rowFiId), account.t_accFiId, account.t_hasNvpi, (t_accountNumberLinked, t_restLinked), (account.t_accountNumber, account.t_chapterNumber, account.t_accountKind, account.t_reserveDate, account.t_contractNumber))" //, account.t_contractNumber
                + "\n" + ")"
                + "\n" + "SELECT protocolData.*,"
                + "\n" + "       CASE WHEN t_reserveDate IS NULL"
                + "\n" + "                THEN 0"
                + "\n" + "            ELSE rsb_fiinstr.convSumType(1, t_rowFiId, 0, 7, t_reserveDate)"
                + "\n" + "       END                                                                                 t_rate"
                + "\n" + "  FROM protocolData"
                + "\n" + " WHERE t_grouping IN (0, 15)"
                + "\n" + " ORDER BY t_sortingFiCode, t_sortingAccountNumber";

        return query;

    end;

    macro getDataSource()
        return m_container;
    end;

    private macro constructorTDataSourceCbRests(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)
        initTPrinterDataSource(parameters);

        m_positionCodeFilter = positionCodeFilter;

        var query = makeDataQuery();

        m_container = TRsbDataset(query);

        m_container.setFieldType("t_hasNvpi",           V_STRING);
        m_container.setFieldType("t_rest",              V_MONEY);
        m_container.setFieldType("t_roubleRest",        V_MONEY);
        m_container.setFieldType("t_restLinked",        V_MONEY);
        m_container.setFieldType("t_reserveDate",       V_DATE);
        m_container.setFieldType("t_reserve",           V_MONEY);
        m_container.setFieldType("t_equivalentReserve", V_MONEY);
        m_container.setFieldType("t_usedValue",         V_MONEY);
    end;

    constructorTDataSourceCbRests(parameters, positionCodeFilter);
end;

/**
 *  Источник данных по резервам
 */
private class (TPrinterDataSource) TDataSourceCbReserves(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)

    private var m_positionCodeFilter : TPositionCodeFilter;

    private macro makeDataQuery()

        var query;

        var accountReserveClause = "SUM(account.t_reserveAmount)";

        var accountEquivalentReserveClause = "SUM(rsb_fiinstr.convSumType(account.t_reserveAmount, 0, fi.t_id, 7, account.t_reserveDate))";

        var usedByPositionFilterClause = m_positionCodeFilter.getAsSqlString("account");

        query =          "WITH protocolData AS"
                + "\n" + "("
                + "\n" + " SELECT DECODE(GROUPING(account.t_accountNumber), 1, 'Итого по валюте:', fi.t_code) t_fiCode,"
                + "\n" + "        NVL(account.t_accountNumber, " + getSqlString("") + ")                      t_accountNumber,"
                + "\n" + "    " + accountReserveClause + "                                                    t_reserve,"
                + "\n" + "    " + accountEquivalentReserveClause + "                                          t_equivalentReserve,"
                + "\n" + "        account.t_chapterNumber                                                     t_chapterNumber,"
                + "\n" + "        fi.t_id                                                                     t_fiId,"
                + "\n" + "        fi.t_code                                                                   t_sortingFiCode,"
                + "\n" + "        NVL(account.t_accountNumber, LPAD('9', 30, '9'))                            t_sortingAccountNumber,"
                + "\n" + "        GROUPING_ID("
                + "\n" + "                    fi.t_code,"
                + "\n" + "                    fi.t_id,"
                + "\n" + "                    account.t_accountNumber,"
                + "\n" + "                    account.t_chapterNumber"
                + "\n" + "                   )                                                                t_grouping,"
                + "\n" + "        account.t_fiIdMain                                                          t_accountFiId,"
                + "\n" + "        account.t_reserveDate                                                       t_reserveDate"
                + "\n" + "   FROM df634cb_tmp account,"
                + "\n" + "        v_rcb_f634_fininstr fi"
                + "\n" + "  WHERE (account.t_fiId = fi.t_id OR account.t_fiIdLinked = fi.t_id)"
                + "\n" + "    AND (" + usedByPositionFilterClause + ")"
                + "\n" + " GROUP BY ROLLUP("
                + "\n" + "                 fi.t_code,"
                + "\n" + "                 fi.t_id,"
                + "\n" + "                 (account.t_accountNumber, account.t_reserveDate),"
                + "\n" + "                 (account.t_chapterNumber, account.t_fiIdMain)"
                + "\n" + "                )"
                + "\n" + ")"
                + "\n" + "SELECT protocolData.*,"
                + "\n" + "       CASE WHEN t_reserveDate IS NULL"
                + "\n" + "                THEN 0"
                + "\n" + "            ELSE rsb_fiinstr.convSumType(1, t_fiId, 0, 7, t_reserveDate)"
                + "\n" + "       END                                                                          t_rate"
                + "\n" + "  FROM protocolData"
                + "\n" + " WHERE t_grouping IN (0, 3)"
                + "\n" + "ORDER BY t_sortingFiCode, t_sortingAccountNumber";

        return query;

    end;

    macro getDataSource()
        return m_container;
    end;

    private macro constructorTDataSourceCbReserves(parameters : TParameters, positionCodeFilter : TPositionCodeFilter)
        initTPrinterDataSource(parameters);

        m_positionCodeFilter = positionCodeFilter;

        m_container = TRsbDataset(makeDataQuery());

        m_container.setFieldType("t_reserve",           V_MONEY);
        m_container.setFieldType("t_equivalentReserve", V_MONEY);
    end;

    constructorTDataSourceCbReserves(parameters, positionCodeFilter);
end;

//!-----------------------------------------Протоколы по графам------------------------------------------
/**
 *  Протокол расчета с данными по остаткам счетов граф 3(VVV_3, VVV_3_810), 4(VVV_4, VVV_4_810), 5(VVV_5, VVV_5_810)
 */
private class (TProtocol) TProtocolRests3_4_5(parameters : TParameters)

    private var m_isEmpty;
    private var m_positionCodeFilter;
    private var m_currentPosition;

    private macro isEmpty()
        return m_isEmpty;
    end;

    private macro addTableHeader()
//        switchOutput();
        println("┌────────────┬───────────────────────────┬────────────────┬────────────────┬────────────────┬──────────────────────────────────────────────┐");
        println("│ Код валюты │        Номер счета        │    Остаток в   │    Остаток в   │     Сумма,     │                  Комментарий                 │");
        println("│     или    │                           │  валюте счета  │   эквиваленте  │    вошедшая    │                                              │");
        println("│драг.металла│                           │                │                │    в расчет    │                                              │");
        println("└────────────┴───────────────────────────┴────────────────┴────────────────┴────────────────┴──────────────────────────────────────────────┘");

//        switchOutput();
    end;

    private macro addTableFooter()
        if (not isEmpty())
            switchOutput();
//            println();
            switchOutput();
        end;
    end;

    private macro printPositionType(positionHeader)
        var errorMessage;
        var dataSource;
        var isFirst;
        var isEmptyPosition = true;

        dataSource = TDataSourceCbRests3_4_5(getParameters(), m_positionCodeFilter).getDataSource();

        switchOutput();

        println();
        [#](positionHeader);

        isFirst = true;

        while (dataSource.next())
            m_isEmpty = false;
            isEmptyPosition = false;

            if (isFirst)
                addTableHeader(positionHeader);
                isFirst = false;
            end;

            errorMessage = "";

            if (dataSource.hasNvpi == rcbCharBool(true))
                errorMessage = errorMessage + "Счет с НВПИ";
            end;

            if ((dataSource.accountKind == "А") and (dataSource.rest > 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На активном счете кредитовый остаток";
            elif ((dataSource.accountKind == "П") and (dataSource.rest < 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На пассивном счете дебетовый остаток";
            end;

            if (datasource.accountNumber != "")
                [     ###       ########################   ################ ################ ################  ############################################  ]
                (dataSource.fiCode, dataSource.accountNumber, dataSource.rest, dataSource.roubleRest, dataSource.rest, errorMessage:w);
            else
                [ ######################################                    ################                                                                 ]
                (dataSource.fiCode, dataSource.roubleRest);
            end;
        end;

        switchOutput();
    end;

    macro print()
        var parameters = getParameters();

//        addTableHeader();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810_reval());
        printPositionType("Графа 3. Чистая балансовая позиция");

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4_810_eq());
        printPositionType("Графа 4. Чистая спот позиция");

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810_eq());

        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810_eq());
        printPositionType("Графа 5. Чистая срочная позиция");

//        printPositionType("Чистая опционная позиция");

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());

//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv_810());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_gk());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_810());
        printPositionType("Чистые позиции по гарантиям");

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());

        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810_eq());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv_810());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_gk());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_810());
        printPositionType("Совокупная внебалансовая позиция");

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());
        printPositionType("Проценты по совокупной внебалансовой позиции");

        printEmptyMessage();

        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printPureBalancePos()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_3_810_reval());
        printPositionType("Графа 3. Чистая балансовая позиция (атрибуты VVV_3, VVV_3_810)");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printPureSpotPoz()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_4_810_eq());
        printPositionType("Графа 4. Чистая спот позиция (атрибуты VVV_4, VVV_4_810)");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printPureTermPos()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810_eq());
/*
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810_eq());
*/
        printPositionType("Графа 5. Чистая срочная позиция (атрибуты VVV_5, VVV_5_810)", m_positionCodeFilter);

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printPureGuaranteePos()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());

//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv_810());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_gk());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_810());
        printPositionType("Чистые позиции по гарантиям");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printAggregateOutBalancePos()

        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());

        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810_eq());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv_810());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_gk());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_810());
        printPositionType("Совокупная внебалансовая позиция");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printAggregateOutBalancePosRercents()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());
        printPositionType("Проценты по совокупной внебалансовой позиции");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    private macro constructorTProtocolRests(parameters : TParameters)
        initTProtocol(parameters);

        m_isEmpty            = true;
        m_positionCodeFilter = TPositionCodeFilter();
    end;

    constructorTProtocolRests(parameters);
end;

/**
 *  Протокол расчета с данными по остаткам счетов граф 7 (VVV_Гар_ГК, VVV_Гар_810), 7 (VVV_Аккредитив, VVV_Аккредитив_810)
 */
private class (TProtocol) TProtocolRests7(parameters : TParameters)

    private var m_isEmpty;
    private var m_positionCodeFilter;
    private var m_currentPosition;

    private macro isEmpty()
        return m_isEmpty;
    end;

    private macro addTableHeader(positionHeader)
//        switchOutput();
        println("┌────────────┬───────────────────────────┬────────────────┬────────────────┬──────────────────────────┬─────────────────────┬───────────────┬───────────────┬───────────────┬──────────────────────────────────────────────┐");
        println("│ Код валюты │        Номер счета        │    Остаток в   │    Остаток в   │       Номер счета        │  Дата формирования  │  Остаток на   │  Остаток на   │ Сумма, вошед- │                  Комментарий                 │");
        println("│     или    │                           │  валюте счета  │   эквиваленте  │         резерва          │       резерва       │ счете резерва │ счете резерва │ шая в расчет  │                                              │");
        println("│драг.металла│                           │                │                │                          │      /Курс ЦБР      │               │   в валюте    │               │                                              │");
        println("└────────────┴───────────────────────────┴────────────────┴────────────────┴──────────────────────────┴─────────────────────┴───────────────┴───────────────┴───────────────┴──────────────────────────────────────────────┘");

//        switchOutput();
    end;

    private macro addTableFooter()
        if (not isEmpty())
            switchOutput();

//            println();

            switchOutput();
        end;
    end;

    private macro printPositionType(positionHeader)
        var errorMessage;
        var dataSource;
        var reserveAccountNumber;
        var isFirst;
        var isEmptyPosition = true;

        dataSource = TDataSourceCbRests7(getParameters(), m_positionCodeFilter).getDataSource();

        switchOutput();

        println();
        [#](positionHeader);

        isFirst = true;
        while (dataSource.next())
            m_isEmpty = false;

            isEmptyPosition = false;

            if (isFirst)
                addTableHeader(positionHeader);
                isFirst = false;
            end;

            errorMessage = "";

            if (dataSource.hasNvpi == rcbCharBool(true))
                errorMessage = errorMessage + "Счет с НВПИ";
            end;

            if ((dataSource.accountKind == "А") and (dataSource.rest > 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На активном счете кредитовый остаток";
            elif ((dataSource.accountKind == "П") and (dataSource.rest < 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На пассивном счете дебетовый остаток";
            end;

            if (datasource.accountNumber != "")
                reserveAccountNumber = getAccCaseReserveAccount(dataSource.chapterNumber,
                                                                dataSource.t_accFiId,
                                                                dataSource.accountNumber);
                reserveAccountNumber = NVL(reserveAccountNumber, "???");

                [     ###       ########################   ################ ################  ########################  ########## / ######## ############### ############### ###############  ############################################  ]
                (dataSource.fiCode,
                                dataSource.accountNumber,  dataSource.rest, dataSource.roubleRest, reserveAccountNumber, string(dataSource.reserveDate:t),
                                                                                                                                     string(dataSource.rate:8:2:l),
                                                                                                                                              dataSource.reserve,
                                                                                                                                                              dataSource.equivalentReserve,
                                                                                                                                                                              dataSource.usedValue, errorMessage:w);
            else
                [ ######################################                                                                                                      ############### ###############                                                ]
                (dataSource.fiCode, dataSource.equivalentReserve, dataSource.usedValue);
            end;
        end;

        switchOutput();
    end;

    macro printReleasedGuaranteeAndSecurity()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());
        printPositionType("Графа 7. Выданные гарантии и поручительства (атрибуты VVV_Гар_ГК, VVV_Гар_810)");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printExposedAccredit()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        printPositionType("Графа 7. Выставленные аккредитивы (атрибуты VVV_Аккредитив, VVV_Аккредитив_810)");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printAggregateOutBalancePos()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_5_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_akkreditiv_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_gar_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());

        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810());
        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_4_810_eq());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_akkreditiv_810());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_gk());
//        m_positionCodeFilter.addExcluded(parameters.getCode_vvv_gar_810());
        printPositionType("Совокупная внебалансовая позиция");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printAggregateOutBalancePosRercents()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());
        printPositionType("Проценты по совокупной внебалансовой позиции");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    private macro constructorTProtocolRests(parameters : TParameters)
        initTProtocol(parameters);

        m_isEmpty            = true;
        m_positionCodeFilter = TPositionCodeFilter();
    end;

    constructorTProtocolRests(parameters);
end;

/**
 *  Протокол расчета с данными по остаткам счетов граф 7 (VVV_ГарантииПолуч_ГК, VVV_ГарПолуч_810_ГК), 7 (VVV_Залог_ГК, VVV_Залог_810), 10 (VVV_10_ГК)
 */
private class (TProtocol) TProtocolRests7_10(parameters : TParameters)

    private var TYPE_SECURITY;
    private var TYPE_GUARANTEE;

    private var m_isEmpty;
    private var m_positionCodeFilter;
    private var m_currentPosition;

    private macro isEmpty()
        return m_isEmpty;
    end;

    private macro addTableHeader(positionHeader, accRole)
//        switchOutput();
        var accTypeStr = "";

        if (accRole   == TYPE_SECURITY) //TYPE_SECURITY
            accTypeStr = "обеспечения";
        elif (accRole == TYPE_GUARANTEE) //TYPE_GUARANTEE
            accTypeStr = "залога";
        end;
                [┌────────────┬───────────────────────────┬────────────────┬──────────────────────────┬────────────────┬──────────────────────────┬─────────────────────┬───────────────┬───────────────┬───────────────┬──────────────────────────────────────────────┐];
                [│ Код валюты │        Номер счета        │    Остаток в   │       Номер счета        │    Остаток     │       Номер счета        │  Дата формирования  │  Остаток на   │  Остаток на   │ Сумма, вошед- │                  Комментарий                 │];
                [│     или    │                           │  валюте счета  │      #############       │     счета      │         резерва          │       резерва       │ счете резерва │ счете резерва │ шая в расчет  │                                              │](accTypeStr:c);
                [│драг.металла│                           │                │                          │ ############## │                          │      /Курс ЦБР      │               │   в валюте    │               │                                              │](accTypeStr:c);
                [└────────────┴───────────────────────────┴────────────────┴──────────────────────────┴────────────────┴──────────────────────────┴─────────────────────┴───────────────┴───────────────┴───────────────┴──────────────────────────────────────────────┘];
//        switchOutput();
    end;

    private macro addTableFooter()
        if (not isEmpty())
            switchOutput();
//            println();
            switchOutput();
        end;
    end;

    private macro printPositionType(positionHeader, accRole)
        var errorMessage;
        var dataSource;
        var reserveAccountNumber;
        var isFirst;
        var isEmptyPosition = true;

        dataSource = TDataSourceCbRests7_10(getParameters(), m_positionCodeFilter, accRole).getDataSource();

        switchOutput();

        println();
        [#](positionHeader);

        isFirst = true;
        while (dataSource.next())
            m_isEmpty = false;
            isEmptyPosition = false;

            if (isFirst)
                addTableHeader(positionHeader, accRole);
                isFirst = false;
            end;

            errorMessage = "";

            if (dataSource.hasNvpi == rcbCharBool(true))
                errorMessage = errorMessage + "Счет с НВПИ";
            end;

            if ((dataSource.accountKind == "А") and (dataSource.rest > 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На активном счете кредитовый остаток";
            elif ((dataSource.accountKind == "П") and (dataSource.rest < 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На пассивном счете дебетовый остаток";
            end;

            if (datasource.accountNumber != "")
                reserveAccountNumber = getAccCaseReserveAccount(dataSource.chapterNumber,
                                                                dataSource.t_accFiId,
                                                                dataSource.accountNumber);
                reserveAccountNumber = NVL(reserveAccountNumber, "???");

                [     ###       ########################   ################  ########################  ################  ########################  ########## / ######## ############### ############### ###############  ############################################  ]
                (dataSource.fiCode,
                                dataSource.accountNumber,  dataSource.rest, dataSource.accountNumberLinked, dataSource.restLinked, reserveAccountNumber,
                                                                                                                             string(dataSource.reserveDate:t), string(dataSource.rate:8:2:l),
                                                                                                                                                                         dataSource.reserve, dataSource.equivalentReserve,
                                                                                                                                                                                                         dataSource.usedValue, errorMessage:w);
            else
                [ ######################################                                                                                                                                 ############### ###############                                                ]
                (dataSource.fiCode, dataSource.equivalentReserve, dataSource.usedValue);
            end;
        end;

        switchOutput();
    end;

    macro printRceivedGuaranteeAndSecurity()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garantiipolu4());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_garpolu4_810_eq());
        printPositionType("Графа 7. Полученные гарантии и поручительства (атрибуты  VVV_ГарантииПолуч_ГК, VVV_ГарПолуч_810)", TYPE_SECURITY);

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    macro printCurrencyMortgages()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_gk());
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_zalog_810());
        printPositionType("Графа 7. Залоги в иностранной валюте (атрибуты  VVV_Залог_ГК, VVV_Залог_810)", TYPE_GUARANTEE);

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    private macro constructorTProtocolRests(parameters : TParameters)
        initTProtocol(parameters);

        TYPE_SECURITY  = parameters.getAccountTypeSecurity();
        TYPE_GUARANTEE = parameters.getAccountTypeGuarantee();

        m_isEmpty            = true;
        m_positionCodeFilter = TPositionCodeFilter();
    end;

    constructorTProtocolRests(parameters);
end;

/**
 *  Протокол расчета с данными по остаткам счетов граф 10 (VVV_10_ГК)
 */
private class (TProtocol) TProtocolRests10(parameters : TParameters)

    private var m_isEmpty;
    private var m_positionCodeFilter;
    private var m_currentPosition;

    private macro isEmpty()
        return m_isEmpty;
    end;

    private macro addTableHeader(positionHeader)
//        switchOutput();
        [┌────────────┬─────────────────────────┬────────────────┬──────────────────────┬────────────────────────┬────────────────┬────────────────────────┬─────────────────────┬───────────────┬───────────────┬───────────────┬──────────────────────────────────────────────┐];
        [│ Код валюты │       Номер счета       │    Остаток в   │         Номер        │      Номер счета       │    Остаток     │      Номер счета       │  Дата формирования  │    Остаток    │    Остаток    │ Сумма, вошед- │                  Комментарий                 │];
        [│     или    │                         │  валюте счета  │      процентного     │       процентов        │     счета      │        резерва         │       резерва       │ счета резерва │ счета резерва │ шая в расчет  │                                              │];
        [│драг.металла│                         │                │       договора       │                        │   процентов    │                        │      /Курс ЦБР      │               │   в валюте    │               │                                              │];
        [└────────────┴─────────────────────────┴────────────────┴──────────────────────┴────────────────────────┴────────────────┴────────────────────────┴─────────────────────┴───────────────┴───────────────┴───────────────┴──────────────────────────────────────────────┘];
//        switchOutput();
    end;

    private macro addTableFooter()
        if (not isEmpty())
//            switchOutput();
//            println();
//            switchOutput();
        end;
    end;

    private macro printPositionType(positionHeader)
        var errorMessage;
        var dataSource;
        var reserveAccountNumber;
        var isFirst;
        var isEmptyPosition = true;

        dataSource = TDataSourceCbRests10(getParameters(), m_positionCodeFilter).getDataSource();

        switchOutput();

        println();
        [#](positionHeader);

        isFirst = true;

        while (dataSource.next())
            m_isEmpty = false;
            isEmptyPosition = false;

            if (isFirst)
                addTableHeader(positionHeader);
                isFirst = false;
            end;

            errorMessage = "";

            if (dataSource.hasNvpi == rcbCharBool(true))
                errorMessage = errorMessage + "Счет с НВПИ";
            end;

            if ((dataSource.accountKind == "А") and (dataSource.rest > 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На активном счете кредитовый остаток";
            elif ((dataSource.accountKind == "П") and (dataSource.rest < 0))
                errorMessage = errorMessage + "\n" + "Ошибка! На пассивном счете дебетовый остаток";
            end;

            if (datasource.accountNumber != "")
                reserveAccountNumber = getAccCaseReserveAccount(dataSource.chapterNumber,
                                                                dataSource.t_accFiId,
                                                                dataSource.accountNumber);
                reserveAccountNumber = NVL(reserveAccountNumber, "???");

                [     ###      ######################## ################  ###################### ######################## ################ ######################## ########## / ######## ############### ############### ############### ############################################  ]
                (dataSource.fiCode,
                               dataSource.accountNumber,dataSource.rest,  dataSource.contractNumber,
                                                                                                 dataSource.accountNumberLinked,
                                                                                                                          dataSource.restLinked,
                                                                                                                                           reserveAccountNumber,
                                                                                                                                                                    string(dataSource.reserveDate:t), string(dataSource.rate:8:2:l),
                                                                                                                                                                                          dataSource.reserve,
                                                                                                                                                                                                          dataSource.equivalentReserve,
                                                                                                                                                                                                                          dataSource.usedValue,
                                                                                                                                                                                                                                          errorMessage:w);
            else
                [ ######################################                                                                                                                                                  ############### ###############                                                ]
                (dataSource.fiCode, dataSource.equivalentReserve, dataSource.usedValue);
            end;
        end;

        switchOutput();
    end;

    macro printAggregateOutBalancePosRercents()
        var parameters = getParameters();

        m_positionCodeFilter.reset();
        m_positionCodeFilter.addIncluded(parameters.getCode_vvv_10());
        printPositionType("Графа 10. Проценты по совокупной внебалансовой позиции (атрибут VVV_10_ГК)");

        printEmptyMessage();
        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    private macro constructorTProtocolRests(parameters : TParameters)
        initTProtocol(parameters);

        m_isEmpty            = true;
        m_positionCodeFilter = TPositionCodeFilter();
    end;

    constructorTProtocolRests(parameters);
end;

/**
 *  Протокол расчета с данными по резервам
 */
private class (TProtocol) TProtocolReserves(parameters : TParameters)

    private var m_isEmpty;

    private macro isEmpty()
        return m_isEmpty;
    end;

    private macro addTableHeader()
        switchOutput();

        println();
        println("Резервы на возможные потери по балансовым активам (атрибут VVV_рез_бал)");
        println("┌────────────┬───────────────────────────┬──────────────────────────┬───────────────────────┬────────────────┬────────────────┬──────────────────────────────────────────────┐");
        println("│ Код валюты │        Номер счета        │       Номер счета        │   Дата формирования   │   Остаток на   │   Остаток на   │                  Комментарий                 │");
        println("│     или    │          актива           │         резерва          │        резерва        │ счете резерва  │ счете резерва  │                                              │");
        println("│драг.металла│                           │                          │       /Курс ЦБР       │                │   в валютном   │                                              │");
        println("│            │                           │                          │                       │                │  эквиваленте   │                                              │");
        println("│            │                           │                          │                       │                │ (сумма, вошед- │                                              │");
        println("│            │                           │                          │                       │                │  шая в расчет) │                                              │");
        println("└────────────┴───────────────────────────┴──────────────────────────┴───────────────────────┴────────────────┴────────────────┴──────────────────────────────────────────────┘");

        switchOutput();
    end;

    private macro addTableFooter()
        switchOutput();
//        println();
        switchOutput();
    end;

    private macro printPositionType(positionCodeFilter)
        var errorMessage;
        var dataSource;
        var reserveAccountNumber;
        var isEmptyPosition = true;

        dataSource = TDataSourceCbReserves(getParameters(), positionCodeFilter).getDataSource();

        switchOutput();

        while (dataSource.next())
            m_isEmpty = false;
            isEmptyPosition = false;

            errorMessage = "";

            if (dataSource.reserve < 0)
                errorMessage = "Ошибка! На пассивном счете дебетовый остаток";
            end;

            if (datasource.accountNumber != "")
                reserveAccountNumber = getAccCaseReserveAccount(dataSource.chapterNumber,
                                                                dataSource.t_accountFiId,
                                                                dataSource.accountNumber);
                reserveAccountNumber = NVL(reserveAccountNumber, "???");

                if (reserveAccountNumber != null)
                    [     ###       ########################    ########################   ########## / ########  ################ ################  ############################################  ]
                    (dataSource.fiCode, dataSource.accountNumber, reserveAccountNumber, string(dataSource.reserveDate:t),
                                                                                                        string(dataSource.rate:8:2:l),
                                                                                                                  dataSource.reserve, -dataSource.equivalentReserve, errorMessage);
                end;
            else
                [ ##################################################################                          ################ ################                                                ]
                (dataSource.fiCode, dataSource.reserve, -dataSource.equivalentReserve);
            end;
        end;

        switchOutput();
    end;

    macro print()
        var parameters = getParameters();
        var positionCodeFilter = TPositionCodeFilter();

        addTableHeader();

        positionCodeFilter.reset();
        positionCodeFilter.addIncluded(parameters.getCode_vvv_rez_bal_gk());
        positionCodeFilter.addIncluded(parameters.getCode_vvv_rez_bal_gk_810());
        printPositionType(positionCodeFilter);

        printEmptyMessage();

        addTableFooter();

        onError(error)
            exceptionMessage(error);
            exit(1);
    end;

    private macro constructorTProtocolReserves(parameters : TParameters)
        initTProtocol(parameters);

        m_isEmpty = true;
    end;

    constructorTProtocolReserves(parameters);
end;

//!---------------------------------------------Протокол------------------------------------------------
/**
 *  Протокол расчета по данным ГКБО
 */
class (TProtocol) TProtocolCb(parameters : TParameters)
/*
    var profiler = TSQLProfiler(getTxtFileName("!prot_f634cb_profile"));
    profiler.clear();
    profiler.on();
*/
    private var m_protocolRests3_4_5 : Object;

    private var m_protocolRests7 : Object;

    private var m_protocolRests7_10 : Object;

    private var m_protocolRests10 : Object;

    private var m_protocolReserves : Object;

    private macro printBoHead()
        switchOutput();
        println();
        if ((rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_MMB) OR (rcbApplication.currentReport.normalizationAlgorithm == RCB_NA_SM))
            if (rcbApplication().currentReport.normalizationAlgorithm == RCB_NA_MMB)
                println("Алгоритм нормализации <В тысячах СМ> для формы 634 не реализован");
            elif (rcbApplication().currentReport.normalizationAlgorithm == RCB_NA_SM)
                println("Алгоритм нормализации <В тысячах ММБ> для формы 634 не реализован");
            end;
        end;

        println();
        println("Главная книга");
        switchOutput();
    end;

    private macro isEmpty()
        return false;
    end;

    macro print()
        printBoHead();
        m_protocolRests3_4_5.printPureBalancePos();
        m_protocolReserves.print();
        m_protocolRests3_4_5.printPureSpotPoz();
        m_protocolRests3_4_5.printPureTermPos();
        m_protocolRests7.printReleasedGuaranteeAndSecurity();
        m_protocolRests7.printExposedAccredit();
        m_protocolRests7_10.printRceivedGuaranteeAndSecurity();
        m_protocolRests7_10.printCurrencyMortgages();
        m_protocolRests10.printAggregateOutBalancePosRercents();
    end;

    private macro constructorTProtocolCb(parameters : TParameters)
        initTProtocol(parameters);

        m_protocolRests3_4_5 = TProtocolRests3_4_5(parameters);
        m_protocolRests7     = TProtocolRests7(parameters);
        m_protocolRests7_10  = TProtocolRests7_10(parameters);
        m_protocolRests10    = TProtocolRests10(parameters);
        m_protocolReserves   = TProtocolReserves(parameters);
    end;

    constructorTProtocolCb(parameters);
end;
