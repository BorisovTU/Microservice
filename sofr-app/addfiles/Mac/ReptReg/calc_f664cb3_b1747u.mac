/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 664 по данным ГКБО. Раздел 3.

  Создан: 29.01.2007 - ABP
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import calc_f664_b1747u;

/**
 *  Параметры отчета
 */
private class (TParameters) TParametersCbIssue3()

    initTParameters("", "", 3);

end;


/**
 *  Источник данных для оборотов ГКБО, раздел 3
 */
private class (TDataSourceCb) TDataSourceCbTurnsIssue3(parameters : TParameters, restsTempTable : Object)

    initTDataSourceCb(parameters, TTurnsTempTable());

    private var m_restsTempTable = restsTempTable;

    private macro makeDataQuery()

        var dateIn  = getParameters().getBeginDate(),
            dateOut = getParameters().getEndDate();

        var reportIssue = getParameters().getReportIssue();

        var accountKind = getSqlString(getParameters().getAccountKind());

        var countryCodeClause, countryNameClause;

        var query = "";

        if (dateOut < RCB_I1803_DATE)

            countryCodeClause = "rcb_f664.getCountryCode_1747(documentData.t_accountNumber, documentData.t_chapterNumber)";

            countryNameClause = "NVL(turnData.t_countryName, " + getSqlString("") + ")";

        else

            countryCodeClause = "rcb_f664.getCountryCode_1803(documentData.t_accountNumber, documentData.t_chapterNumber)";

            countryNameClause =          "CASE"
                                + "\n" + "    WHEN turnData.t_countryCode IN ('997', '998', '999')"
                                + "\n" + "        THEN '-'"
                                + "\n" + "    ELSE NVL(turnData.t_countryName, " + getSqlString("") + ")"
                                + "\n" + "END";

        end;

        query =          "WITH turnData AS"
                + "\n" + "(SELECT documentData.*,"
                + "\n" + "        CASE"
                + "\n" + "            WHEN documentData.t_countryId IS NOT NULL"
                + "\n" + "                THEN rcb_f664.getCountryCodeByCategory(documentData.t_countryId,"
                + "\n" + "                                                       documentData.t_operationCode,"
                + "\n" + "                                                       documentData.t_directionCode,"
                + "\n" + "                                                       documentData.t_paymentId)"
                + "\n" + "            ELSE " + countryCodeClause
                + "\n" + "        END                                                                              t_countryCode,"
                + "\n" + "        CASE"
                + "\n" + "            WHEN documentData.t_countryId IS NOT NULL"
                + "\n" + "                THEN rcb_f664.getCountryNameByCategory(documentData.t_countryId,"
                + "\n" + "                                                       documentData.t_operationCode,"
                + "\n" + "                                                       documentData.t_directionCode,"
                + "\n" + "                                                       documentData.t_paymentId)"
                + "\n" + "            ELSE (SELECT country.t_fullName"
                + "\n" + "                    FROM daccount_dbt ac,"
                + "\n" + "                         dparty_dbt pt,"
                + "\n" + "                         dcountry_dbt country"
                + "\n" + "                   WHERE ac.t_account = documentData.t_accountNumber"
                + "\n" + "                     AND ac.t_chapter = documentData.t_chapterNumber"
                + "\n" + "                     AND pt.t_partyId = ac.t_client"
                + "\n" + "                     AND country.t_codeLat3(+) = DECODE(pt.t_nrCountry,"
                + "\n" + "                                                        CHR(1), NULL,"
                + "\n" + "                                                        CHR(0), NULL,"
                + "\n" + "                                                        pt.t_nrCountry))"
                + "\n" + "        END                                                                              t_countryName"
                + "\n" + "   FROM (SELECT DISTINCT"
                + "\n" + "                tmp.t_accountNumber                          t_accountNumber,"
                + "\n" + "                tmp.t_chapterNumber                          t_chapterNumber,"
                + "\n" + "                CASE"
                + "\n" + "                    WHEN pmco.t_amount IS NULL"
                + "\n" + "                        THEN doc.t_sum"
                + "\n" + "                        ELSE pmco.t_amount"
                + "\n" + "                END                                          t_sum,"
                + "\n" + "                doc.t_date_carry                             t_dateCarry,"
                + "\n" + "                doc.t_account_payer                          t_accountPayer,"
                + "\n" + "                doc.t_account_receiver                       t_accountReceiver,"
                + "\n" + "                doc.t_numb_document                          t_numberDocument,"
                + "\n" + "                pmdoc.t_paymentId                            t_paymentId,"
                + "\n" + "                CASE"
                + "\n" + "                    WHEN tmp.t_accountNumber = doc.t_account_payer"
                + "\n" + "                        THEN " + getSqlString(DEBIT)
                + "\n" + "                    ELSE " + getSqlString(CREDIT)
                + "\n" + "                END                                          t_directionCode,"
                + "\n" + "                rcb_f664.getOperationCode(objatcor.t_attrId,"
                + "\n" + "                                          doc.t_ground,"
                + "\n" + "                                          llvalues.t_code)   t_operationCode,"
                + "\n" + "                country.t_attrId                             t_countryId,"
                + "\n" + "                doc.t_autokey                                t_autokey"
                + "\n" + "           FROM darhdoc_dbt doc,"
                + "\n" + "                " + m_restsTempTable.getTableName() + " tmp,"
                + "\n" + "                dpmdocs_dbt pmdoc,"
                + "\n" + "                dobjatcor_dbt objatcor,"
                + "\n" + "                dobjatcor_dbt country,"
                + "\n" + "                dpmco_dbt pmco,"
                + "\n" + "                dllvalues_dbt llvalues"
                + "\n" + "          WHERE (tmp.t_accountNumber = doc.t_account_payer OR tmp.t_accountNumber = doc.t_account_receiver)"
                + "\n" + "            AND tmp.t_chapterNumber = doc.t_chapter"
                + "\n" + "            AND tmp.t_reportIssue = 2"
                + "\n" + "            AND doc.t_date_carry BETWEEN " + getSqlDate(dateIn) + " AND " + getSqlDate(dateOut)
                + "\n" + "            AND pmdoc.t_applicationKind(+) = doc.t_iApplicationKind"
                + "\n" + "            AND pmdoc.t_applicationKey(+)  = doc.t_applicationKey"
                + "\n" + "            AND pmdoc.t_linkKindId(+) = 1"
                + "\n" + "            AND objatcor.t_object(+) = pmdoc.t_paymentId"
                + "\n" + "            AND objatcor.t_objectType(+) = " + OBJTYPE_PAYMENT
                + "\n" + "            AND objatcor.t_groupId(+) = 7"
                + "\n" + "            AND pmco.t_paymentId(+) = pmdoc.t_paymentId"
                + "\n" + "            AND llvalues.t_list(+) = " + RCB_OBJTYPE_PURPOSE117
                + "\n" + "            AND llvalues.t_element(+) = pmco.t_vo_code"
                + "\n" + "            AND country.t_object(+) = pmdoc.t_paymentId"
                + "\n" + "            AND country.t_objectType(+) = " + OBJTYPE_PAYMENT
                + "\n" + "            AND country.t_groupId(+) = 5"
                + "\n" + "        ) documentData"
                + "\n" + ")"
                + "\n" + "SELECT NULL                       t_currencyCode,"
                + "\n" + "       turnData.t_sum             t_sum,"
                + "\n" + "       turnData.t_dateCarry       t_dateCarry,"
                + "\n" + "       turnData.t_accountPayer    t_accountPayer,"
                + "\n" + "       turnData.t_accountReceiver t_accountReceiver,"
                + "\n" + "       turnData.t_numberDocument  t_numberDocument,"
                + "\n" + "       turnData.t_directionCode   t_directionCode,"
                + "\n" + "       turnData.t_operationCode   t_operationCode,"
                + "\n" + "       turnData.t_countryCode     t_countryCode,"
                + "\n" +         countryNameClause + "      t_countryName,"
                + "\n" + "       NULL                       t_clientCodeAndName,"
                + "\n" +         reportIssue + "            t_reportIssue,"
                + "\n" +         accountKind + "            t_accountKind,"
                + "\n" +         getBackOffice() + "        t_backOffice,"
                + "\n" + "       turnData.t_accountNumber   t_accountNumber,"
                + "\n" + "       turnData.t_chapterNumber   t_chapterNumber,"
                + "\n" + "       NULL                       t_isWrongPayment"
                + "\n" + "  FROM turnData"
                + "\n" + " WHERE turnData.t_operationCode != " + getSqlString("");

        return query;

    end;
end;

/**
 *  Контроллер расчета
 */
private class TCalculator(parameters : TParameters)

    private var m_parameters = parameters;

    private var m_restsTempTable = TRestsTempTable();

    macro calculate()

        var turns = TDataSourceCbTurnsIssue3(m_parameters, m_restsTempTable);

        turns.fillTempTable();

    end;

end;

/**
 *  Основная функция
 */
private macro main()

    var bo_cb = TBackOffice(BOCB);

    var tunetable = TTuneTable("dt664_dbt", "t_backOffice");

    var parameters = TParametersCbIssue3();

    if (tuneTable.hasDataFor(bo_cb))

        BegAction(2000, "Расчет переменных раздела 3 по данным ГКБО");

        TCalculator(parameters).calculate();

        EndAction(1);

    end;

end;

/**
 *  Точка входа
 */
main();
// 13.02.2007 ABP Пока нижеследущие строки закомментированы. А вообще от практики использования exit(1) нужно отказываться
//УстановитьФлагВозврата(OK_MACRO_FLAG);
//exit(1);

OnError(error)
    exceptionMessage(error);
    exit(1);
