/*
$Name:          f603DataSources.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 603. Источники данных
*/

class (RcbDataSource) F603DataSource(dataSources : RcbDataSources)

    initRcbDataSource("603DataSource", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)

        var sourceQuery =                  "WITH repcredit AS (  SELECT --+materialize"
                              +"\n"+       "                            t_chapter, t_creditaccount as t_account,"
                              +"\n"+       "                            sum(t_incoversum) as t_creditsum"
                              +"\n"+       "                       FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_creditaccount")
                              +"\n"+       "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_creditaccount") + ")"
                              +"\n"+       "                   GROUP BY t_chapter,t_creditaccount ),"
                              +"\n"+       "     repdebet AS (  SELECT  --+materialize"
                              +"\n"+       "                           t_chapter, t_debetaccount as t_account,"
                              +"\n"+       "                           sum(t_incoversum) as t_debetsum"
                              +"\n"+       "                      FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                     WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                       AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_debetaccount")
                              +"\n"+       "                             OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_debetaccount") + ")"
                              +"\n"+       "                  GROUP BY t_chapter,t_debetaccount )"
                              +"\n"+       "SELECT  repaccount.t_account,"
                              +"\n"+       "        repaccount.t_kind,"
                              +"\n"+       "        repaccount.t_partyid,"
                              +"\n"+       "        repaccount.t_branchid,"
                              +"\n"+       "        repparty.t_name,"
                              +"\n"+       "        repparty.t_shortname,"
                              +"\n"+       "        repaccount.t_isloro,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 1 "
                              +"\n"+       "            THEN"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN reppartycodes.t_code like '%/%'"
                              +"\n"+       "                    THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/')-1)"
                              +"\n"+       "                    ELSE reppartycodes.t_code"
                              +"\n"+       "                END"
                              +"\n"+       "            ELSE"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN repparty.t_isswift = 1"
                              +"\n"+       "                    THEN reppartycodes.t_code"
                              +"\n"+       "                    ELSE 'НР'"
                              +"\n"+       "            END"
                              +"\n"+       "        END AS t_regnumber,"
                              +"\n"+       "        country.t_codenum3 as t_codecountry,"
                              +"\n"+       "        repaccount.t_balance,"
                              +"\n"+       "        repaccount.t_fiid,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 0"
                              +"\n"+       "            THEN 2"
                              +"\n"+       "            ELSE 1"
                              +"\n"+       "        END AS t_isresident,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN t_isloro = 0"
                              +"\n"+       "            THEN corschem.t_coraccount"
                              +"\n"+       "            ELSE repaccount.t_account"
                              +"\n"+       "        END AS t_repaccount,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN EXISTS (SELECT 1"
                              +"\n"+       "                           FROM drepdocument_vw doc"
                              +"\n"+       "                          WHERE (    (doc.t_debetaccount  = repaccount.t_Account)"
                              +"\n"+       "                                  OR (doc.t_creditaccount = repaccount.t_Account))"
                              +"\n"+       "                            AND doc.t_iscorrect = 1"
                              +"\n"+       "                            AND doc.t_date >= rep_data.getbegindate()"
                              +"\n"+       "                            AND doc.t_date <= rep_data.getenddate())"
                              +"\n"+       "                THEN 1"
                              +"\n"+       "            ELSE 0"
                              +"\n"+       "        END isCorrect,"
                              +"\n"+       "        repaccount.t_incoverrest AS t_inrest,"
                              +"\n"+       "        NVL(repcredit.t_creditsum, 0) as t_creditsum,"
                              +"\n"+       "        NVL(repdebet.t_debetsum,   0) as t_debetsum,"
                              +"\n"+       "        repaccount.t_outcoverrest AS t_outrest"
                              +"\n"+       "FROM    (SELECT repaccount_.*,"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
                              +"\n"+       "                    THEN 0"
                              +"\n"+       "                    ELSE 1"
                              +"\n"+       "                END AS t_isloro"
                              +"\n"+       "         FROM drepaccount_vw repaccount_"
                              +"\n"+       "        WHERE "     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "                OR "+ convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "               )repaccount,"
                              +"\n"+       "        drepparty_vw repparty,"
                              +"\n"+       "        (SELECT *"
                              +"\n"+       "           FROM dreppartycodes_vw partyсode,"
                              +"\n"+       "                drepparty_vw      repparty_"
                              +"\n"+       "          WHERE repparty_.t_id = partyсode.t_partyId"
                              +"\n"+       "                -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                              +"\n"+       "            AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
                              +"\n"+       "                -- для резидентов отбираем 'Регистрационный номер'"
                              +"\n"+       "                OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))) reppartycodes,"
                              +"\n"+       "        dcountry_dbt country,"
                              +"\n"+       "        dcorschem_dbt corschem,"
                              +"\n"+       "        repcredit,"
                              +"\n"+       "        repdebet"
                              +"\n"+       "WHERE   repaccount.t_partyid = repparty.t_id"
                              +"\n"+       "  AND   repaccount.t_partyid  = reppartycodes.t_partyid (+)"
                              +"\n"+       "  AND   repparty.t_countrycode = country.t_codelat3"
                              +"\n"+       "  AND   repaccount.t_account = corschem.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_fiid = corschem.t_fiid (+)"
                              +"\n"+       "  AND   repaccount.t_departmentid = corschem.t_department (+)"
                              +"\n"+       "  AND   repaccount.t_account = repcredit.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repcredit.t_chapter (+)"
                              +"\n"+       "  AND   repaccount.t_account = repdebet.t_account  (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repdebet.t_chapter  (+)"
                              +"\n"+       "  AND   ( t_inrest <> 0 or t_creditsum <> 0 or t_debetsum <> 0 or t_outrest <> 0 )"
                              +"\n"+       "  AND " + filter.isSuitable();


        return sourceQuery;

    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        return dataSet;
    end;

end;

class (RcbDataSource) F603DataSource_2539(dataSources : RcbDataSources)

    initRcbDataSource("603DataSource", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)

        var sourceQuery =                  "WITH repcredit AS (  SELECT --+materialize"
                              +"\n"+       "                            t_chapter, t_creditaccount as t_account,"
                              +"\n"+       "                            sum(t_incoversum) as t_creditsum"
                              +"\n"+       "                       FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_creditaccount")
                              +"\n"+       "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_creditaccount") + ")"
                              +"\n"+       "                   GROUP BY t_chapter,t_creditaccount ),"
                              +"\n"+       "     repdebet AS (  SELECT  --+materialize"
                              +"\n"+       "                           t_chapter, t_debetaccount as t_account,"
                              +"\n"+       "                           sum(t_incoversum) as t_debetsum"
                              +"\n"+       "                      FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                     WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                       AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_debetaccount")
                              +"\n"+       "                             OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_debetaccount") + ")"
                              +"\n"+       "                  GROUP BY t_chapter,t_debetaccount )"
                              +"\n"+       "SELECT  repaccount.t_account,"
                              +"\n"+       "        repaccount.t_kind,"
                              +"\n"+       "        repaccount.t_partyid,"
                              +"\n"+       "        repaccount.t_branchid,"
                              +"\n"+       "        repparty.t_name,"
                              +"\n"+       "        repparty.t_shortname,"
                              +"\n"+       "        repaccount.t_isloro,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 1 "
                              +"\n"+       "            THEN"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN reppartycodes.t_code like '%/%'"
                              +"\n"+       "                    THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/')-1)"
                              +"\n"+       "                    ELSE reppartycodes.t_code"
                              +"\n"+       "                END"
                              +"\n"+       "            ELSE"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN repparty.t_isswift = 1"
                              +"\n"+       "                    THEN reppartycodes.t_code"
                              +"\n"+       "                    ELSE 'НР'"
                              +"\n"+       "            END"
                              +"\n"+       "        END AS t_regnumber,"
                              +"\n"+       "        country.t_codenum3 as t_codecountry,"
                              +"\n"+       "        repaccount.t_balance,"
                              +"\n"+       "        repaccount.t_fiid,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 0"
                              +"\n"+       "            THEN 2"
                              +"\n"+       "            ELSE 1"
                              +"\n"+       "        END AS t_isresident,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN t_isloro = 0"
                              +"\n"+       "            THEN corschem.t_coraccount"
                              +"\n"+       "            ELSE ''"
                              +"\n"+       "        END AS t_repaccount,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN EXISTS (SELECT 1"
                              +"\n"+       "                           FROM drepdocument_vw doc"
                              +"\n"+       "                          WHERE (    (doc.t_debetaccount  = repaccount.t_Account)"
                              +"\n"+       "                                  OR (doc.t_creditaccount = repaccount.t_Account))"
                              +"\n"+       "                            AND doc.t_iscorrect = 1"
                              +"\n"+       "                            AND doc.t_date >= rep_data.getbegindate()"
                              +"\n"+       "                            AND doc.t_date <= rep_data.getenddate())"
                              +"\n"+       "                THEN 1"
                              +"\n"+       "            ELSE 0"
                              +"\n"+       "        END isCorrect,"
                              +"\n"+       "        repaccount.t_incoverrest AS t_inrest,"
                              +"\n"+       "        NVL(repcredit.t_creditsum, 0) as t_creditsum,"
                              +"\n"+       "        NVL(repdebet.t_debetsum,   0) as t_debetsum,"
                              +"\n"+       "        repaccount.t_outcoverrest AS t_outrest"
                              +"\n"+       "FROM    (SELECT repaccount_.*,"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
                              +"\n"+       "                    THEN 0"
                              +"\n"+       "                    ELSE 1"
                              +"\n"+       "                END AS t_isloro"
                              +"\n"+       "         FROM drepaccount_vw repaccount_"
                              +"\n"+       "        WHERE "     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "                OR "+ convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "               )repaccount,"
                              +"\n"+       "        drepparty_vw repparty,"
                              +"\n"+       "        (SELECT *"
                              +"\n"+       "           FROM dreppartycodes_vw partyсode,"
                              +"\n"+       "                drepparty_vw      repparty_"
                              +"\n"+       "          WHERE repparty_.t_id = partyсode.t_partyId"
                              +"\n"+       "                -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                              +"\n"+       "            AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
                              +"\n"+       "                -- для резидентов отбираем 'Регистрационный номер'"
                              +"\n"+       "                OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))) reppartycodes,"
                              +"\n"+       "        dcountry_dbt country,"
                              +"\n"+       "        dcorschem_dbt corschem,"
                              +"\n"+       "        repcredit,"
                              +"\n"+       "        repdebet"
                              +"\n"+       "WHERE   repaccount.t_partyid = repparty.t_id"
                              +"\n"+       "  AND   repaccount.t_partyid  = reppartycodes.t_partyid (+)"
                              +"\n"+       "  AND   repparty.t_countrycode = country.t_codelat3"
                              +"\n"+       "  AND   repaccount.t_account = corschem.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_fiid = corschem.t_fiid (+)"
                              +"\n"+       "  AND   repaccount.t_departmentid = corschem.t_department (+)"
                              +"\n"+       "  AND   repaccount.t_account = repcredit.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repcredit.t_chapter (+)"
                              +"\n"+       "  AND   repaccount.t_account = repdebet.t_account  (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repdebet.t_chapter  (+)"
                              +"\n"+       "  AND   ( t_inrest <> 0 or t_creditsum <> 0 or t_debetsum <> 0 or t_outrest <> 0 )"
                              +"\n"+       "  AND " + filter.isSuitable();

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        return dataSet;
    end;
end;

class (RcbDataSource) F603DataSource_3129(dataSources : RcbDataSources)

    initRcbDataSource("603DataSource", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getObjectCode(tableName : String, chapter : String, fiid : String, account : String) : String
        return   "(  TO_CHAR (" + tableName + "." + chapter + ", 'FM0x')"
        + "\n" + "|| TO_CHAR (" + tableName + "." + fiid    + ", 'FM0xxxxxx')"
        + "\n" + "||          " + tableName + "." + account + ")";
    end;

    private macro getSourceQuery(filter)

        var sourceQuery =                  "WITH repcredit AS ("
                              +"\n"+       "                     SELECT --+materialize"
                              +"\n"+       "                            t_chapter, t_creditaccount as t_account,"
                              +"\n"+       "                            sum(t_incoversum) as t_creditsum"
                              +"\n"+       "                       FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_creditaccount")
                              +"\n"+       "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_creditaccount") + ")"
                              +"\n"+       "                   GROUP BY t_chapter,t_creditaccount"
                              +"\n"+       "                  ),"
                              +"\n"+       "     repdebet AS  ("
                              +"\n"+       "                     SELECT  --+materialize"
                              +"\n"+       "                            t_chapter, t_debetaccount as t_account,"
                              +"\n"+       "                            sum(t_incoversum) as t_debetsum"
                              +"\n"+       "                       FROM drepdocumentwithcorrection_vw"
                              +"\n"+       "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
                              +"\n"+       "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_debetaccount")
                              +"\n"+       "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_debetaccount") + ")"
                              +"\n"+       "                   GROUP BY t_chapter,t_debetaccount"
                              +"\n"+       "                  )"
                              +"\n"+       "SELECT  repaccount.t_account,"
                              +"\n"+       "        repaccount.t_kind,"
                              +"\n"+       "        repaccount.t_partyid,"
                              +"\n"+       "        repaccount.t_branchid,"
                              +"\n"+       "        repparty.t_name,"
                              +"\n"+       "        repparty.t_shortname,"
                              +"\n"+       "        repaccount.t_isloro,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 1 "
                              +"\n"+       "            THEN"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN rsb_rep_pt.get_partyCode(" + PTCK_BIC + ", repparty.t_id, rep_data.getEndDate()) = '044583123'"
                              +"\n"+       "                        THEN '044583123' "
                              +"\n"+       "                    ELSE "
                              +"\n"+       "                        CASE"
                              +"\n"+       "                            WHEN reppartycodes.t_code like '%/%'"
                              +"\n"+       "                                THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                              +"\n"+       "                            ELSE reppartycodes.t_code"
                              +"\n"+       "                        END"
                              +"\n"+       "                END"
                              +"\n"+       "            ELSE"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN repparty.t_isswift = 1"
                              +"\n"+       "                    THEN reppartycodes.t_code"
                              +"\n"+       "                    ELSE 'НР'"
                              +"\n"+       "            END"
                              +"\n"+       "        END AS t_regnumber,"
                              +"\n"+       "        CASE "
                              +"\n"+       "            WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasContractorAssignedCategory(RCB_OBJGROUP_PT_IS_INTERNAT_INTERGOV_ORG, 1, null, "repparty.t_objectid").isSuitable()
                              +"\n"+       "                THEN '998' "
                              +"\n"+       "            ELSE country.t_codenum3"
                              +"\n"+       "        END t_codecountry,"
                              +"\n"+       "        repaccount.t_balance,"
                              +"\n"+       "        repaccount.t_fiid,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN repparty.t_isresident = 0"
                              +"\n"+       "            THEN 2"
                              +"\n"+       "            ELSE 1"
                              +"\n"+       "        END AS t_isresident,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN t_isloro = 0"
                              +"\n"+       "            THEN corschem.t_coraccount"
                              +"\n"+       "            ELSE ''"
                              +"\n"+       "        END AS t_repaccount,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN EXISTS (SELECT 1"
                              +"\n"+       "                           FROM drepdocument_vw doc"
                              +"\n"+       "                          WHERE (    (doc.t_debetaccount  = repaccount.t_Account)"
                              +"\n"+       "                                  OR (doc.t_creditaccount = repaccount.t_Account))"
                              +"\n"+       "                            AND doc.t_iscorrect = 1"
                              +"\n"+       "                            AND doc.t_date >= rep_data.getbegindate()"
                              +"\n"+       "                            AND doc.t_date <= rep_data.getenddate())"
                              +"\n"+       "                THEN 1"
                              +"\n"+       "            ELSE 0"
                              +"\n"+       "        END isCorrect,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо'," + getObjectCode("repaccount","t_chapter","t_fiId","t_account") +", " +
                                                                                                  getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                              +"\n"+       "                THEN 1"
                              +"\n"+       "            ELSE 0"
                              +"\n"+       "        END isThirdPerson,"
                              +"\n"+       "        repaccount.t_incoverrest AS t_inrest,"
                              +"\n"+       "        NVL(repcredit.t_creditsum, 0) as t_creditsum,"
                              +"\n"+       "        NVL(repdebet.t_debetsum,   0) as t_debetsum,"
                              +"\n"+       "        repaccount.t_outcoverrest AS t_outrest,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
                              +"\n"+       "                THEN rep_note.getMoneyAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_AMOUNTALLOCATEDFUNDS + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
                              +"\n"+       "            ELSE NULL"
                              +"\n"+       "        END t_amountFunds,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
                              +"\n"+       "                THEN rep_note.getIntegerAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_DURATION + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
                              +"\n"+       "            ELSE NULL"
                              +"\n"+       "        END t_duration,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
                              +"\n"+       "                THEN rep_note.getMoneyAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_INTERESTRATE + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
                              +"\n"+       "            ELSE NULL"
                              +"\n"+       "        END t_interestRate,"
                              +"\n"+       "        CASE"
                              +"\n"+       "            WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
                              +"\n"+       "                THEN rep_note.getTextAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
                              +"\n"+       "            ELSE NULL"
                              +"\n"+       "        END t_explanations"
                              +"\n"+       "FROM    ("
                              +"\n"+       "         SELECT repaccount_.*,"
                              +"\n"+       "                CASE"
                              +"\n"+       "                    WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
                              +"\n"+       "                    THEN 0"
                              +"\n"+       "                    ELSE 1"
                              +"\n"+       "                END AS t_isloro"
                              +"\n"+       "           FROM drepaccount_vw repaccount_"
                              +"\n"+       "          WHERE "     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "             OR "     + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "        ) repaccount,"
                              +"\n"+       "        drepparty_vw repparty,"
                              +"\n"+       "        ("
                              +"\n"+       "         SELECT *"
                              +"\n"+       "           FROM dreppartycodes_vw partyсode,"
                              +"\n"+       "                drepparty_vw      repparty_"
                              +"\n"+       "          WHERE repparty_.t_id = partyсode.t_partyId"
                              +"\n"+       "                -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                              +"\n"+       "            AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
                              +"\n"+       "                -- для резидентов отбираем 'Регистрационный номер'"
                              +"\n"+       "                 OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))"
                              +"\n"+       "        ) reppartycodes,"
                              +"\n"+       "        dcountry_dbt country,"
                              +"\n"+       "        dcorschem_dbt corschem,"
                              +"\n"+       "        repcredit,"
                              +"\n"+       "        repdebet"
                              +"\n"+       "WHERE   repaccount.t_partyid = repparty.t_id"
                              +"\n"+       "  AND   repaccount.t_partyid  = reppartycodes.t_partyid (+)"
                              +"\n"+       "  AND   repparty.t_countrycode = country.t_codelat3"
                              +"\n"+       "  AND   repaccount.t_account = corschem.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_fiid = corschem.t_fiid (+)"
                              +"\n"+       "  AND   repaccount.t_departmentid = corschem.t_department (+)"
                              +"\n"+       "  AND   repaccount.t_account = repcredit.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repcredit.t_chapter (+)"
                              +"\n"+       "  AND   repaccount.t_account = repdebet.t_account  (+)"
                              +"\n"+       "  AND   repaccount.t_chapter = repdebet.t_chapter  (+)"
                              +"\n"+       "  AND   ( t_inrest <> 0 or t_creditsum <> 0 or t_debetsum <> 0 or t_outrest <> 0 )"
                              +"\n"+       "  AND " + filter.isSuitable();

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        dataSet.SetFieldType("isThirdPerson", V_INTEGER);

        return dataSet;
    end;
end;

class (RcbDataSource) F603DataSource_4212(dataSources : RcbDataSources)
    initRcbDataSource("603DataSource", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)
        var sourceQuery =
                   "WITH repcredit AS ("
            +"\n"+ "                     SELECT --+materialize"
            +"\n"+ "                            t_chapter, t_creditaccount as t_account,"
            +"\n"+ "                            sum(t_incoversum) as t_creditsum"
            +"\n"+ "                       FROM drepdocumentwithcorrection_vw"
            +"\n"+ "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
            +"\n"+ "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_creditaccount")
            +"\n"+ "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_creditaccount") + ")"
            +"\n"+ "                   GROUP BY t_chapter,t_creditaccount"
            +"\n"+ "                  ),"
            +"\n"+ "     repdebet AS  ("
            +"\n"+ "                     SELECT  --+materialize"
            +"\n"+ "                            t_chapter, t_debetaccount as t_account,"
            +"\n"+ "                            sum(t_incoversum) as t_debetsum"
            +"\n"+ "                       FROM drepdocumentwithcorrection_vw"
            +"\n"+ "                      WHERE t_date BETWEEN rep_data.getBeginDate() AND rep_data.getEndDate()"
            +"\n"+ "                        AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(), "t_debetaccount")
            +"\n"+ "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks()  , "t_debetaccount") + ")"
            +"\n"+ "                   GROUP BY t_chapter,t_debetaccount"
            +"\n"+ "                  ),"
            +"\n"+ "     reference AS ("
            +"\n"+ "                  --справочник для л/с по связанным объектам Субъект экономики с ролью Контрагент по обременению  "
            +"\n"+ "                  SELECT acc.t_account,                                                                           "
            +"\n"+ "                         acc.t_accountId,                                                                         "
            +"\n"+ "                         party.t_id,                                                                              "
            +"\n"+ "                         codes.t_codeKind,                                                                        "
            +"\n"+ "                         codes.t_code,                                                                            "
            +"\n"+ "                         codes.t_name,                                                                            "
            +"\n"+ "                         --является Банком и Резидентом                                                           "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isBank = 1 AND party.t_isResident = 1                                   "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isBankResident,                                                                    "
            +"\n"+ "                         --является Банком и Нерезидентом                                                         "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isBank = 1 AND party.t_isResident = 0                                   "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isBankNotResident,                                                                 "
            +"\n"+ "                         --является Юридическим лицом и Резидентом             "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isPhisical = 0 AND party.t_isResident = 1                               "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isJuridicalResident,                                                               "
            +"\n"+ "                         --является Индивидуальным предпринимателем                                               "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isEmployer = 1                                                          "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isEmployer,                                                                        "
            +"\n"+ "                         --является Юридическим лицом и Нерезидентом                                              "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isPhisical = 0 AND party.t_isResident = 0                               "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isJuridicalNotResident,                                                            "
            +"\n"+ "                         --является Физическим лицом и Резидентом и НЕ является Индивидуальным предпринимателем   "
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isPhisical = 1 AND party.t_isResident = 1 AND party.t_isEmployer = 0    "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isPhysResidentNotEmpl,                                                             "
            +"\n"+ "                         --является Физическим лицом и Нерезидентом и НЕ является Индивидуальным предпринимателем,"
            +"\n"+ "                         CASE                                                                                     "
            +"\n"+ "                             WHEN party.t_isPhisical = 1 AND party.t_isResident = 0 AND party.t_isEmployer = 0    "
            +"\n"+ "                                 THEN 1                                                                           "
            +"\n"+ "                             ELSE 0                                                                               "
            +"\n"+ "                         END t_isPhysNotResidentNotEmpl                                                           "
            +"\n"+ "                    FROM dRepLinkedObjects_vw link,                                                               "
            +"\n"+ "                         dRepAccount_vw       acc,                                                                "
            +"\n"+ "                         dRepParty_vw         party,                                                              "
            +"\n"+ "                         dRepPartyCodes_vw    codes                                                               "
            +"\n"+ "                   WHERE acc.t_objectId   = link.t_connectObjectId                                                "
            +"\n"+ "                     AND party.t_objectId = link.t_id                                                             "
            +"\n"+ "                     AND codes.t_partyId  = party.t_id                                                            "
            +"\n"+ "                     AND link.t_role      = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
            +"\n"+ "                  )                                                                                               "
            +"\n"+ "SELECT repaccount.t_account,"
            +"\n"+ "       repaccount.t_kind,"
            +"\n"+ "       repaccount.t_partyid,"
            +"\n"+ "       repaccount.t_branchid,"
            +"\n"+ "       repparty.t_name,"
            +"\n"+ "       repparty.t_shortname,"
            +"\n"+ "       repaccount.t_isloro,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN repparty.t_isresident = 1 "
            +"\n"+ "           THEN"
            +"\n"+ "               CASE"
            +"\n"+ "                   WHEN rsb_rep_pt.get_partyCode(" + PTCK_BIC + ", repparty.t_id, rep_data.getEndDate()) = '044583123'"
            +"\n"+ "                       THEN '044583123' "
            +"\n"+ "                   ELSE "
            +"\n"+ "                       CASE"
            +"\n"+ "                           WHEN reppartycodes.t_code like '%/%'"
            +"\n"+ "                               THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
            +"\n"+ "                           ELSE reppartycodes.t_code"
            +"\n"+ "                       END"
            +"\n"+ "               END"
            +"\n"+ "           ELSE"
            +"\n"+ "               CASE"
            +"\n"+ "                   WHEN repparty.t_isswift = 1"
            +"\n"+ "                       THEN reppartycodes.t_code"
            +"\n"+ "                   ELSE 'НР'"
            +"\n"+ "           END"
            +"\n"+ "       END AS t_regnumber,"
            +"\n"+ "       CASE "
            +"\n"+ "           WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasContractorAssignedCategory(RCB_OBJGROUP_PT_IS_INTERNAT_INTERGOV_ORG, 1, null, "repparty.t_objectid").isSuitable()
            +"\n"+ "               THEN '998' "
            +"\n"+ "           ELSE country.t_codenum3"
            +"\n"+ "       END t_codecountry,"
            +"\n"+ "       repaccount.t_balance,"
            +"\n"+ "       repaccount.t_fiid,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN repparty.t_isresident = 0"
            +"\n"+ "           THEN 2"
            +"\n"+ "           ELSE 1"
            +"\n"+ "       END AS t_isresident,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN t_isloro = 0"
            +"\n"+ "           THEN corschem.t_coraccount"
            +"\n"+ "           ELSE ''"
            +"\n"+ "       END AS t_repaccount,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN EXISTS (SELECT 1"
            +"\n"+ "                          FROM drepdocument_vw doc"
            +"\n"+ "                         WHERE (    (doc.t_debetaccount  = repaccount.t_Account)"
            +"\n"+ "                                 OR (doc.t_creditaccount = repaccount.t_Account))"
            +"\n"+ "                           AND doc.t_iscorrect = 1"
            +"\n"+ "                           AND doc.t_date >= rep_data.getbegindate()"
            +"\n"+ "                           AND doc.t_date <= rep_data.getenddate())"
            +"\n"+ "               THEN 1"
            +"\n"+ "           ELSE 0"
            +"\n"+ "       END isCorrect,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Третье лицо', rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)," +
                                                                         getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
            +"\n"+ "               THEN 1"
            +"\n"+ "           ELSE 0"
            +"\n"+ "       END isThirdPerson,"
            //Обрем_Гр11
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Собств_Обременение', rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)," +
                                                                         getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
            +"\n"+ "               THEN '1'"
            +"\n"+ "           WHEN EXISTS(SELECT 1"
            +"\n"+ "                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                          AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + ")"
            +"\n"+ "               THEN NVL((SELECT party.t_name"
            +"\n"+ "                           FROM dRepParty_vw party"
            +"\n"+ "                          WHERE party.t_objectId IN (SELECT t_id"
            +"\n"+ "                                                       FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                                                      WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                                                        AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
            +"\n"+ "                                                        AND rownum = 1)), '')"
            +"\n"+ "           ELSE '0'"
            +"\n"+ "       END t_onerousClaim,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN EXISTS(SELECT 1"
            +"\n"+ "                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                          AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + ")"
            +"\n"+ "           THEN NVL((SELECT  country.t_codenum3 "
            +"\n"+ "                       FROM dRepParty_vw party, dcountry_dbt country"
            +"\n"+ "                      WHERE party.t_objectId IN (SELECT t_id"
            +"\n"+ "                                                   FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                                                  WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                                                    AND objLink.t_role = "+ RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
            +"\n"+ "                                                    AND rownum = 1)"
            +"\n"+ "                        AND  country.t_codelat3 = party.t_countryCode), '')"
            +"\n"+ "       END t_codeCountryClaim,"
            //Обрем_Гр12
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Собств_Обременение', rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)," +
                                                                         getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
            +"\n"+ "               THEN ''"
            +"\n"+ "           WHEN EXISTS(SELECT 1"
            +"\n"+ "                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                          AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + ")"
            +"\n"+ "               THEN (SELECT CASE"
            +"\n"+ "                                WHEN t_isBankResident = 1"
            +"\n"+ "                                    THEN (SELECT CASE"
            +"\n"+ "                                                     WHEN INSTR(ref.t_code, '/', 1, 1) != 0"
            +"\n"+ "                                                         THEN SUBSTR(ref.t_code, 1, 4)"
            +"\n"+ "                                                     ELSE ref.t_code"
            +"\n"+ "                                                 END"
            +"\n"+ "                                            FROM reference ref"
            +"\n"+ "                                           WHERE ref.t_codeKind = " + RCB_PTCK_BANKREGNUM
            +"\n"+ "                                             AND repaccount.t_account = ref.t_account)"
            +"\n"+ "                                WHEN t_isBankNotResident = 1"
            +"\n"+ "                                    THEN CASE "
            +"\n"+ "                                             WHEN (LENGTH(NVL((SELECT ref.t_code    "
            +"\n"+ "                                                                 FROM reference ref"
            +"\n"+ "                                                                WHERE ref.t_codeKind = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                  AND repaccount.t_account = ref.t_account), '')) = 8)"
            +"\n"+ "                                                 THEN CONCAT((SELECT ref.t_code    "
            +"\n"+ "                                                                FROM reference ref"
            +"\n"+ "                                                               WHERE ref.t_codeKind = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                 AND repaccount.t_account = ref.t_account), 'XXX')"
            +"\n"+ "                                             WHEN (LENGTH(NVL((SELECT ref.t_code    "
            +"\n"+ "                                                                 FROM reference ref"
            +"\n"+ "                                                                WHERE ref.t_codeKind = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                  AND repaccount.t_account = ref.t_account), '')) = 11)"
            +"\n"+ "                                                 THEN (SELECT ref.t_code    "
            +"\n"+ "                                                         FROM reference ref"
            +"\n"+ "                                                        WHERE ref.t_codeKind = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                          AND repaccount.t_account = ref.t_account)"
            +"\n"+ "                                             ELSE 'НР'    "
            +"\n"+ "                                         END        "
            +"\n"+ "                                                 "
            +"\n"+ "                                                 "
            +"\n"+ "                                                 "
            +"\n"+ "                                                 "
            +"\n"+ "                                WHEN t_isJuridicalResident = 1"
            +"\n"+ "                                    THEN (NVL((SELECT ref.t_code"
            +"\n"+ "                                                 FROM reference ref"
            +"\n"+ "                                                WHERE ref.t_codeKind = " + RCB_PTCK_OGRN
            +"\n"+ "                                                  AND repaccount.t_account = ref.t_account), ''))"
            +"\n"+ "                                WHEN t_isEmployer = 1"
            +"\n"+ "                                    THEN (NVL((SELECT ref.t_code"
            +"\n"+ "                                                 FROM reference ref"
            +"\n"+ "                                                WHERE ref.t_codeKind = " + RCB_PTCK_OGRN
            +"\n"+ "                                                  AND repaccount.t_account = ref.t_account), ''))"
            +"\n"+ "                                WHEN t_isJuridicalNotResident = 1"
            +"\n"+ "                                    THEN 'HP'"
            +"\n"+ "                                WHEN t_isPhysResidentNotEmpl = 1"
            +"\n"+ "                                    THEN (NVL((SELECT ref.t_code"
            +"\n"+ "                                                 FROM reference ref"
            +"\n"+ "                                                WHERE ref.t_codeKind = " + RCB_PTCK_INN
            +"\n"+ "                                                  AND repaccount.t_account = ref.t_account), ''))"
            +"\n"+ "                                ELSE ''"
            +"\n"+ "                            END t_identifier"
            +"\n"+ "                       FROM reference ref"
            +"\n"+ "                      WHERE ref.t_account = repaccount.t_account"
            +"\n"+ "                        AND rownum        = 1)"
            +"\n"+ "           ELSE ''"
            +"\n"+ "       END AS t_identifier,"
            //Филиал_SWIFT_Kliko
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Собств_Обременение', rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)," +
                                                                         getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
            +"\n"+ "               THEN ''"
            +"\n"+ "           WHEN EXISTS(SELECT 1"
            +"\n"+ "                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                          AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + ")"
            +"\n"+ "               THEN (SELECT CASE"
            +"\n"+ "                                WHEN t_isBankResident = 1"
            +"\n"+ "                                    THEN ''"
            +"\n"+ "                                WHEN t_isBankNotResident = 1"
            +"\n"+ "                                    THEN CASE "
            +"\n"+ "                                             WHEN (LENGTH(NVL((SELECT ref.t_code    "
            +"\n"+ "                                                                 FROM reference ref"
            +"\n"+ "                                                                WHERE ref.t_codeKind  = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                  AND ref.t_accountId = repaccount.t_accountId), '')) = 8)"
            +"\n"+ "                                                 THEN 'XXX'"
            +"\n"+ "                                             WHEN (LENGTH(NVL((SELECT ref.t_code    "
            +"\n"+ "                                                                 FROM reference ref"
            +"\n"+ "                                                                WHERE ref.t_codeKind  = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                  AND ref.t_accountId = repaccount.t_accountId), '')) = 11)"
            +"\n"+ "                                                 THEN SUBSTR((SELECT ref.t_code    "
            +"\n"+ "                                                                FROM reference ref"
            +"\n"+ "                                                               WHERE ref.t_codeKind  = " + RCB_PTCK_SWIFT
            +"\n"+ "                                                                 AND ref.t_accountId = repaccount.t_accountId), 9, 3)"
            +"\n"+ "                                             ELSE ''    "
            +"\n"+ "                                         END        "
            +"\n"+ "                                WHEN t_isJuridicalResident = 1"
            +"\n"+ "                                    THEN ''"
            +"\n"+ "                                WHEN t_isEmployer = 1"
            +"\n"+ "                                    THEN ''"
            +"\n"+ "                                WHEN t_isJuridicalNotResident = 1"
            +"\n"+ "                                    THEN ''"
            +"\n"+ "                                WHEN t_isPhysResidentNotEmpl = 1"
            +"\n"+ "                                    THEN ''"
            +"\n"+ "                                ELSE ''"
            +"\n"+ "                            END t_identifier"
            +"\n"+ "                       FROM reference ref"
            +"\n"+ "                      WHERE ref.t_accountId = repaccount.t_accountId"
            +"\n"+ "                        AND rownum          = 1)"
            +"\n"+ "           ELSE ''"
            +"\n"+ "       END AS t_branchSwiftKliko,"
            //Условн_код_kliko
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(4, 18, 'Собств_Обременение', rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)," +
                                                                         getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
            +"\n"+ "               THEN ''"
            +"\n"+ "           WHEN EXISTS(SELECT 1"
            +"\n"+ "                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                          AND objLink.t_role = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + ")"
            +"\n"+ "               THEN (SELECT CASE"
            +"\n"+ "                                WHEN t_isBankResident = 1"
            +"\n"+ "                                    THEN (SELECT CASE"
            +"\n"+ "                                                     WHEN NOT ref.t_code IS NULL"
            +"\n"+ "                                                         THEN '2'"
            +"\n"+ "                                                     ELSE ''"
            +"\n"+ "                                                 END"
            +"\n"+ "                                            FROM reference ref"
            +"\n"+ "                                           WHERE ref.t_codeKind  = " + RCB_PTCK_BANKREGNUM
            +"\n"+ "                                             AND ref.t_accountId = repaccount.t_accountId)"
            +"\n"+ "                                WHEN t_isBankNotResident = 1"
            +"\n"+ "                                    THEN '4'        "
            +"\n"+ "                                WHEN t_isJuridicalResident = 1"
            +"\n"+ "                                    THEN '1'"
            +"\n"+ "                                WHEN t_isEmployer = 1"
            +"\n"+ "                                    THEN '6'"
            +"\n"+ "                                WHEN t_isJuridicalNotResident = 1"
            +"\n"+ "                                    THEN '3'"
            +"\n"+ "                                WHEN t_isPhysResidentNotEmpl = 1"
            +"\n"+ "                                    THEN '5'"
            +"\n"+ "                                ELSE ''"
            +"\n"+ "                            END t_identifier"
            +"\n"+ "                       FROM reference ref"
            +"\n"+ "                      WHERE ref.t_accountId = repaccount.t_accountId"
            +"\n"+ "                        AND rownum          = 1)"
            +"\n"+ "           ELSE ''"
            +"\n"+ "       END AS t_conditionalCodeKliko,"
            //Обрем_Гр13
            +"\n"+ "       (SELECT CASE"
            +"\n"+ "                   WHEN category.t_value = 'Обрем_Ссуда'"
            +"\n"+ "                       THEN '1'"
            +"\n"+ "                   WHEN category.t_value = 'Обрем_Депозит'"
            +"\n"+ "                       THEN '2'"
            +"\n"+ "                   WHEN category.t_value = 'Обрем_ДолгОбязательство'"
            +"\n"+ "                       THEN '3'"
            +"\n"+ "                   WHEN category.t_value = 'Обрем_ИноеОбяз'"
            +"\n"+ "                       THEN '4'"
            +"\n"+ "               END"
            +"\n"+ "          FROM dRepCategory_vw category"
            +"\n"+ "         WHERE category.t_objectId IN (SELECT t_id"
            +"\n"+ "                                         FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                                        WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                                          AND objLink.t_role            = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
            +"\n"+ "                                          AND rownum                    = 1)"
            +"\n"+ "           AND t_id                    = " + RCB_OBJGROUP_FOR_REPORTING
            +"\n"+ "           AND t_isinstalledForEndDate = 1"
            +"\n"+ "           AND rownum                  = 1) AS t_onerousClaimCategory,"
            //Обрем_Гр14
            +"\n"+ "       (SELECT acc.t_outCoverRest"
            +"\n"+ "          FROM dRepAccount_vw acc"
            +"\n"+ "         WHERE acc.t_objectId = (SELECT t_id"
            +"\n"+ "                                   FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                                  WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                                    AND objLink.t_role            = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
            +"\n"+ "                                    AND rownum                    = 1)) AS t_restLinkedAccount,"
            //Обрем_Гр15
            +"\n"+ "       (SELECT TO_CHAR(rep_note.getDateAccountNote(acc.t_objectId, 16, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + "), 'DD.MM.YYYY')"
            +"\n"+ "          FROM dRepAccount_vw acc"
            +"\n"+ "         WHERE acc.t_objectId = (SELECT t_id"
            +"\n"+ "                                   FROM dRepLinkedObjects_vw objLink"
            +"\n"+ "                                  WHERE objLink.t_connectObjectId = rsb_rep_ac.makeAccountId(repaccount.t_account, repaccount.t_fiId, repaccount.t_chapter, NULL)"
            +"\n"+ "                                    AND objLink.t_role            = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
            +"\n"+ "                                    AND rownum                    = 1)) AS t_redemptionDate,"

            +"\n"+ "       repaccount.t_incoverrest      AS t_inrest,"
            +"\n"+ "       NVL(repcredit.t_creditsum, 0) AS t_creditsum,"
            +"\n"+ "       NVL(repdebet.t_debetsum,   0) AS t_debetsum,"
            +"\n"+ "       repaccount.t_outcoverrest     AS t_outrest,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
            +"\n"+ "               THEN rep_note.getMoneyAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_AMOUNTALLOCATEDFUNDS + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
            +"\n"+ "           ELSE NULL"
            +"\n"+ "       END t_amountFunds,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
            +"\n"+ "               THEN rep_note.getIntegerAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_DURATION + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
            +"\n"+ "           ELSE NULL"
            +"\n"+ "       END t_duration,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
            +"\n"+ "               THEN rep_note.getMoneyAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_INTERESTRATE + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
            +"\n"+ "           ELSE NULL"
            +"\n"+ "       END t_interestRate,"
            +"\n"+ "       CASE"
            +"\n"+ "           WHEN " + objectFactoryInstance.createDataSourceFilters().getFilter("Account").hasAccountAssignedCategory(RCB_OBJGROUP_ACTIVEKIND, "Третье лицо", null, "repaccount.t_objectid").isSuitable()
            +"\n"+ "               THEN rep_note.getTextAccountNote(repaccount.t_objectid, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", " + getSqlDate(global.getRcbReport().context.period.endDate) + ")"
            +"\n"+ "           ELSE NULL"
            +"\n"+ "       END t_explanations"
            +"\n"+ "  FROM ("
            +"\n"+ "        SELECT repaccount_.*,"
            +"\n"+ "               CASE"
            +"\n"+ "                   WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
            +"\n"+ "                   THEN 0"
            +"\n"+ "                   ELSE 1"
            +"\n"+ "               END AS t_isloro"
            +"\n"+ "          FROM drepaccount_vw repaccount_"
            +"\n"+ "         WHERE "     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
            +"\n"+ "            OR "     + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account")
            +"\n"+ "       ) repaccount,"
            +"\n"+ "       drepparty_vw repparty,"
            +"\n"+ "       ("
            +"\n"+ "        SELECT *"
            +"\n"+ "          FROM dreppartycodes_vw partyсode,"
            +"\n"+ "               drepparty_vw      repparty_"
            +"\n"+ "         WHERE repparty_.t_id = partyсode.t_partyId"
            +"\n"+ "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
            +"\n"+ "           AND (   (repparty_.t_isResident = 0 AND repparty_.t_isswift = 1 AND partyсode.t_codekind = 6)"
            +"\n"+ "               -- для резидентов отбираем 'Регистрационный номер'"
            +"\n"+ "                OR (repparty_.t_isResident = 1 AND partyсode.t_codekind = 13))"
            +"\n"+ "       ) reppartycodes,"
            +"\n"+ "       dcountry_dbt country,"
            +"\n"+ "       dcorschem_dbt corschem,"
            +"\n"+ "       repcredit,"
            +"\n"+ "       repdebet"
            +"\n"+ " WHERE repaccount.t_partyid      = repparty.t_id"
            +"\n"+ "   AND repaccount.t_partyid      = reppartycodes.t_partyid (+)"
            +"\n"+ "   AND repparty.t_countrycode    = country.t_codelat3"
            +"\n"+ "   AND repaccount.t_account      = corschem.t_account (+)"
            +"\n"+ "   AND repaccount.t_fiid         = corschem.t_fiid (+)"
            +"\n"+ "   AND repaccount.t_departmentid = corschem.t_department (+)"
            +"\n"+ "   AND repaccount.t_account      = repcredit.t_account (+)"
            +"\n"+ "   AND repaccount.t_chapter      = repcredit.t_chapter (+)"
            +"\n"+ "   AND repaccount.t_account      = repdebet.t_account  (+)"
            +"\n"+ "   AND repaccount.t_chapter      = repdebet.t_chapter  (+)"
            +"\n"+ "   AND ( t_inrest <> 0 or t_creditsum <> 0 or t_debetsum <> 0 or t_outrest <> 0 )"
            +"\n"+ "   AND " + filter.isSuitable()
            ;

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        dataSet.SetFieldType("isThirdPerson", V_INTEGER);

        return dataSet;
    end;
end;

class (RcbDataSource) F603DataSourceForControlBeginData(dataSources : RcbDataSources)

    initRcbDataSource("603DataSourceForBeginData", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)

        var sourceQuery =                  "SELECT  repaccount.t_account,"
                              +"\n"+       "        corschem.t_coraccount"
                              +"\n"+       "FROM    (SELECT *"
                              +"\n"+       "           FROM drepaccount_vw repaccount_"
                              +"\n"+       "          WHERE "     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "                OR "+ convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account")
                              +"\n"+       "               )repaccount,"
                              +"\n"+       "        drepcorschema_vw corschem"
                              +"\n"+       "WHERE   repaccount.t_account = corschem.t_account (+)"
                              +"\n"+       "  AND   repaccount.t_fiid = corschem.t_fiid (+)"
                              +"\n"+       "  AND   repaccount.t_departmentid = corschem.t_department (+)"
                              +"\n"+       "  AND " + filter.isSuitable();

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        return dataSet;
    end;
end;

class (RcbDataSource) F603DataSourceForProtocol(dataSources : RcbDataSources)

    initRcbDataSource("603DataSourceForProtocol", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)

        var sourceQuery =
                    "WITH repaccount AS (SELECT --+materialize"
             +"\n"+ "                           repaccount_.t_account,"
             +"\n"+ "                           CASE"
             +"\n"+ "                              WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
             +"\n"+ "                                 THEN 0"
             +"\n"+ "                              ELSE 1"
             +"\n"+ "                           END AS t_isloro,"
             +"\n"+ "                           repaccount_.t_chapter,"
             +"\n"+ "                           repaccount_.t_departmentid,"
             +"\n"+ "                           repaccount_.t_fiid,"
             +"\n"+ "                           repaccount_.t_name,"
             +"\n"+ "                           repaccount_.t_incoverrest,"
             +"\n"+ "                           repaccount_.t_outcoverrest"
             +"\n"+ "                      FROM drepaccount_vw repaccount_,"
             +"\n"+ "                           drepparty_vw repparty"
             +"\n"+ "                     WHERE repaccount_.t_chapter = 1"
             +"\n"+ "                       AND repaccount_.t_partyId = repparty.t_id"
             +"\n"+ "                       AND  ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
             +"\n"+ "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account") + ")"
             +"\n"+ "                       AND " + filter.isSuitable() + "),"
             +"\n"+ "    doc AS (SELECT --+materialize"
             +"\n"+ "                   *"
             +"\n"+ "              FROM (SELECT --+materialize"
             +"\n"+ "                           document.t_chapter,"
             +"\n"+ "                           document.t_number,"
             +"\n"+ "                           document.t_date,"
             +"\n"+ "                           document.t_debetaccount,"
             +"\n"+ "                           document.t_creditaccount,"
             +"\n"+ "                           document.t_incoversum,"
             +"\n"+ "                           document.t_note"
             +"\n"+ "                      FROM drepdocumentwithcorrection_vw document"
             +"\n"+ "                     WHERE document.t_chapter = 1"
             +"\n"+ "                       AND  ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"document.t_debetaccount")
             +"\n"+ "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"document.t_debetaccount") + ")"
             +"\n"+ "                       AND document.t_date BETWEEN rep_data.getbegindate ()"
             +"\n"+ "                       AND rep_data.getenddate ()"
             +"\n"+ "                     UNION"
             +"\n"+ "                    SELECT document.t_chapter,"
             +"\n"+ "                           document.t_number,"
             +"\n"+ "                           document.t_date,"
             +"\n"+ "                           document.t_debetaccount,"
             +"\n"+ "                           document.t_creditaccount,"
             +"\n"+ "                           document.t_incoversum,"
             +"\n"+ "                           document.t_note"
             +"\n"+ "                      FROM drepdocumentwithcorrection_vw document"
             +"\n"+ "                     WHERE document.t_chapter = 1"
             +"\n"+ "                       AND  ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"document.t_creditaccount")
             +"\n"+ "                              OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"document.t_creditaccount") + ")"
             +"\n"+ "                       AND document.t_date BETWEEN rep_data.getbegindate ()"
             +"\n"+ "                       AND rep_data.getenddate ()))"
             +"\n"+ "  SELECT *"
             +"\n"+ "    FROM (SELECT documents.t_isloro,"
             +"\n"+ "                 GROUPING (documents.t_account) t_islorobegin,"
             +"\n"+ "                 GROUPING (documents.t_name) t_iscreditordebetend,"
             +"\n"+ "                 documents.t_account,"
             +"\n"+ "                 documents.t_iscreditdocument,"
             +"\n"+ "                 documents.t_name,"
             +"\n"+ "                 documents.t_incoverrest,"
             +"\n"+ "                 documents.t_outcoverrest,"
             +"\n"+ "                 documents.t_number,"
             +"\n"+ "                 documents.t_date,"
             +"\n"+ "                 documents.t_debetaccount,"
             +"\n"+ "                 documents.t_creditaccount,"
             +"\n"+ "                 SUM (documents.t_incoversum) t_incoversum,"
             +"\n"+ "                 documents.t_note"
             +"\n"+ "            FROM (SELECT CASE"
             +"\n"+ "                            WHEN documents_.t_isloro = 0"
             +"\n"+ "                               THEN NVL(corschem.t_coraccount, documents_.t_account)"
             +"\n"+ "                            ELSE documents_.t_account"
             +"\n"+ "                         END AS t_account,"
             +"\n"+ "                         documents_.t_name,"
             +"\n"+ "                         documents_.t_isloro,"
             +"\n"+ "                         documents_.t_incoverrest,"
             +"\n"+ "                         documents_.t_outcoverrest,"
             +"\n"+ "                         documents_.t_number,"
             +"\n"+ "                         documents_.t_date,"
             +"\n"+ "                         documents_.t_debetaccount,"
             +"\n"+ "                         documents_.t_creditaccount,"
             +"\n"+ "                         documents_.t_incoversum,"
             +"\n"+ "                         documents_.t_iscreditdocument,"
             +"\n"+ "                         documents_.t_note"
             +"\n"+ "                    FROM dcorschem_dbt corschem,"
             +"\n"+ "                         ((SELECT repaccount.t_account,"
             +"\n"+ "                                  repaccount.t_chapter,"
             +"\n"+ "                                  repaccount.t_fiid,"
             +"\n"+ "                                  repaccount.t_departmentid,"
             +"\n"+ "                                  repaccount.t_name,"
             +"\n"+ "                                  repaccount.t_incoverrest,"
             +"\n"+ "                                  repaccount.t_outcoverrest,"
             +"\n"+ "                                  repaccount.t_isloro,"
             +"\n"+ "                                  doc.t_number,"
             +"\n"+ "                                  doc.t_date,"
             +"\n"+ "                                  doc.t_debetaccount,"
             +"\n"+ "                                  doc.t_creditaccount,"
             +"\n"+ "                                  doc.t_incoversum,"
             +"\n"+ "                                  1 t_iscreditdocument,"
             +"\n"+ "                                  doc.t_note"
             +"\n"+ "                             FROM doc,"
             +"\n"+ "                                  repaccount"
             +"\n"+ "                            WHERE repaccount.t_account = doc.t_creditaccount(+)"
             +"\n"+ "                              AND repaccount.t_chapter = doc.t_chapter(+))"
             +"\n"+ "                            UNION"
             +"\n"+ "                          (SELECT repaccount.t_account,"
             +"\n"+ "                                  repaccount.t_chapter,"
             +"\n"+ "                                  repaccount.t_fiid,"
             +"\n"+ "                                  repaccount.t_departmentid,"
             +"\n"+ "                                  repaccount.t_name,"
             +"\n"+ "                                  repaccount.t_incoverrest,"
             +"\n"+ "                                  repaccount.t_outcoverrest,"
             +"\n"+ "                                  repaccount.t_isloro,"
             +"\n"+ "                                  doc.t_number,"
             +"\n"+ "                                  doc.t_date,"
             +"\n"+ "                                  doc.t_debetaccount,"
             +"\n"+ "                                  doc.t_creditaccount,"
             +"\n"+ "                                  doc.t_incoversum,"
             +"\n"+ "                                  0 t_iscreditdocument,"
             +"\n"+ "                                  doc.t_note"
             +"\n"+ "                             FROM doc,"
             +"\n"+ "                                  repaccount"
             +"\n"+ "                            WHERE repaccount.t_account = doc.t_debetaccount(+)"
             +"\n"+ "                              AND repaccount.t_chapter = doc.t_chapter(+))) documents_"
             +"\n"+ "   WHERE documents_.t_account = corschem.t_account(+)"
             +"\n"+ "     AND documents_.t_fiid = corschem.t_fiid(+)"
             +"\n"+ "     AND documents_.t_departmentid = corschem.t_department(+)"
             +"\n"+ "     AND (documents_.t_incoverrest <> 0 OR documents_.t_outcoverrest <> 0 OR documents_.t_incoversum <> 0)) documents"
             +"\n"+ "   GROUP BY ROLLUP (documents.t_isloro,"
             +"\n"+ "                    documents.t_account,"
             +"\n"+ "                    documents.t_iscreditdocument,"
             +"\n"+ "                    (documents.t_name,"
             +"\n"+ "                     documents.t_incoverrest,"
             +"\n"+ "                     documents.t_outcoverrest,"
             +"\n"+ "                     documents.t_number,"
             +"\n"+ "                     documents.t_date,"
             +"\n"+ "                     documents.t_debetaccount,"
             +"\n"+ "                     documents.t_creditaccount,"
             +"\n"+ "                     documents.t_incoversum,"
             +"\n"+ "                     documents.t_note"
             +"\n"+ "                    ))"
             +"\n"+ "  HAVING (GROUPING (documents.t_isloro) = 0"
             +"\n"+ "     AND NOT (    GROUPING (documents.t_iscreditdocument) = 1"
             +"\n"+ "              AND GROUPING (documents.t_account) = 0"
             +"\n"+ "              AND GROUPING (documents.t_name) = 1)))"
             +"\n"+ "   ORDER BY t_isloro DESC,"
             +"\n"+ "            t_islorobegin DESC,"
             +"\n"+ "            t_account,"
             +"\n"+ "            t_iscreditdocument,"
             +"\n"+ "            t_iscreditordebetend,"
             +"\n"+ "            t_date,"
             +"\n"+ "            t_number";

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        return dataSet;
    end;
end;

class (RcbDataSource) F603DataSourceForProtocol_4212(dataSources : RcbDataSources)
    initRcbDataSource("603DataSourceForProtocol", null, dataSources);

    private var m_tuneTable = objectFactoryInstance.createTuneTable();

    private macro getSourceQuery(filter)
        var sourceQuery =
                    "WITH linkParty AS (                                                                                        "
             +"\n"+ "                   SELECT acc.t_account                                                      AS t_account, "
             +"\n"+ "                          RPAD(RPAD(codes.t_code, 15, ' ') || ' ' || party.t_name, 100, ' ') AS t_linkParty"
             +"\n"+ "                     FROM dRepLinkedObjects_vw link,                                                       "
             +"\n"+ "                          dRepAccount_vw       acc,                                                        "
             +"\n"+ "                          dRepParty_vw         party,                                                      "
             +"\n"+ "                          dRepPartyCodes_vw    codes                                                       "
             +"\n"+ "                    WHERE acc.t_objectId      = link.t_connectObjectId                                     "
             +"\n"+ "                      AND party.t_objectId(+) = link.t_id                                                  "
             +"\n"+ "                      AND codes.t_partyId     = link.t_id                                                  "
             +"\n"+ "                      AND codes.t_codeKind    = 1                                                          "
             +"\n"+ "                      AND link.t_role         = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS + "),            "
             +"\n"+ "      linkAccount AS (                                                                                     "
             +"\n"+ "                      SELECT acc.t_account,                                                                "
             +"\n"+ "                             acc2.t_account AS t_linkAccount                                               "
             +"\n"+ "                        FROM dRepLinkedObjects_vw link,                                                    "
             +"\n"+ "                             dRepAccount_vw       acc,                                                     "
             +"\n"+ "                             dRepAccount_vw       acc2                                                     "
             +"\n"+ "                       WHERE acc.t_objectId      = link.t_connectObjectId                                  "
             +"\n"+ "                             and acc2.t_objectId = link.t_id                                               "
             +"\n"+ "                             and link.t_role     = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM + "),                 "
             +"\n"+ "     linkObjects AS (                                                                                      "
             +"\n"+ "                     SELECT CASE                                                                           "
             +"\n"+ "                                WHEN NOT linkParty.t_account IS NULL                                       "
             +"\n"+ "                                    THEN linkParty.t_account                                               "
             +"\n"+ "                                ELSE linkAccount.t_account                                                 "
             +"\n"+ "                            END t_account,                                                                 "
             +"\n"+ "                            linkParty.t_linkParty,                                                         "
             +"\n"+ "                            linkAccount.t_linkAccount                                                      "
             +"\n"+ "                       FROM linkParty                                                                      "
             +"\n"+ "                       full join linkAccount                                                               "
             +"\n"+ "                         on linkAccount.t_account = linkParty.t_account),                                  "
             +"\n"+ "     repaccount AS (SELECT --+materialize                                                                  "
             +"\n"+ "                           repaccount_.t_account,                                                          "
             +"\n"+ "                           CASE                                                                            "
             +"\n"+ "                              WHEN (" + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")+")"
             +"\n"+ "                                 THEN 0"
             +"\n"+ "                              ELSE 1"
             +"\n"+ "                           END AS t_isloro,"
             +"\n"+ "                           repaccount_.t_chapter,"
             +"\n"+ "                           repaccount_.t_departmentid,"
             +"\n"+ "                           repaccount_.t_fiid,"
             +"\n"+ "                           repaccount_.t_name,"
             +"\n"+ "                           repaccount_.t_incoverrest,"
             +"\n"+ "                           repaccount_.t_outcoverrest,"
             +"\n"+ "                           linkObjects.t_linkParty,"
             +"\n"+ "                           linkObjects.t_linkAccount"
             +"\n"+ "                      FROM drepaccount_vw repaccount_,"
             +"\n"+ "                           drepparty_vw repparty,"
             +"\n"+ "                           linkObjects"
             +"\n"+ "                     WHERE repaccount_.t_chapter    = 1"
             +"\n"+ "                       AND linkObjects.t_account(+) = repaccount_.t_account"
             +"\n"+ "                       AND repaccount_.t_partyId    = repparty.t_id"
             +"\n"+ "                       AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"repaccount_.t_account")
             +"\n"+ "                             OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"repaccount_.t_account") + ")"
             +"\n"+ "                       AND " + filter.isSuitable() + "),"
             +"\n"+ "    doc AS (SELECT --+materialize"
             +"\n"+ "                   *"
             +"\n"+ "              FROM (SELECT --+materialize"
             +"\n"+ "                           document.t_chapter,"
             +"\n"+ "                           document.t_number,"
             +"\n"+ "                           document.t_date,"
             +"\n"+ "                           document.t_debetaccount,"
             +"\n"+ "                           document.t_creditaccount,"
             +"\n"+ "                           document.t_incoversum,"
             +"\n"+ "                           document.t_note"
             +"\n"+ "                      FROM drepdocumentwithcorrection_vw document"
             +"\n"+ "                     WHERE document.t_chapter = 1"
             +"\n"+ "                       AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"document.t_debetaccount")
             +"\n"+ "                             OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"document.t_debetaccount") + ")"
             +"\n"+ "                       AND document.t_date BETWEEN rep_data.getbegindate ()"
             +"\n"+ "                       AND rep_data.getenddate ()"
             +"\n"+ "                     UNION"
             +"\n"+ "                    SELECT document.t_chapter,"
             +"\n"+ "                           document.t_number,"
             +"\n"+ "                           document.t_date,"
             +"\n"+ "                           document.t_debetaccount,"
             +"\n"+ "                           document.t_creditaccount,"
             +"\n"+ "                           document.t_incoversum,"
             +"\n"+ "                           document.t_note"
             +"\n"+ "                      FROM drepdocumentwithcorrection_vw document"
             +"\n"+ "                     WHERE document.t_chapter = 1"
             +"\n"+ "                       AND ("     + convertMaskToSqlFormat(m_tuneTable.setKey("НОСТРО").getMasks(),"document.t_creditaccount")
             +"\n"+ "                             OR " + convertMaskToSqlFormat(m_tuneTable.setKey("ЛОРО").getMasks(),"document.t_creditaccount") + ")"
             +"\n"+ "                       AND document.t_date BETWEEN rep_data.getbegindate ()"
             +"\n"+ "                       AND rep_data.getenddate ()))"
             +"\n"+ "  SELECT *"
             +"\n"+ "    FROM (SELECT documents.t_isloro,"
             +"\n"+ "                 GROUPING (documents.t_account) t_islorobegin,"
             +"\n"+ "                 GROUPING (documents.t_name) t_iscreditordebetend,"
             +"\n"+ "                 documents.t_account,"
             +"\n"+ "                 documents.t_iscreditdocument,"
             +"\n"+ "                 documents.t_name,"
             +"\n"+ "                 documents.t_incoverrest,"
             +"\n"+ "                 documents.t_outcoverrest,"
             +"\n"+ "                 documents.t_number,"
             +"\n"+ "                 documents.t_date,"
             +"\n"+ "                 documents.t_debetaccount,"
             +"\n"+ "                 documents.t_creditaccount,"
             +"\n"+ "                 SUM (documents.t_incoversum) t_incoversum,"
             +"\n"+ "                 documents.t_linkAccount,"
             +"\n"+ "                 documents.t_linkParty,"
             +"\n"+ "                 documents.t_note"
             +"\n"+ "            FROM (SELECT CASE"
             +"\n"+ "                            WHEN documents_.t_isloro = 0"
             +"\n"+ "                               THEN NVL(corschem.t_coraccount, documents_.t_account)"
             +"\n"+ "                            ELSE documents_.t_account"
             +"\n"+ "                         END AS t_account,"
             +"\n"+ "                         documents_.t_name,"
             +"\n"+ "                         documents_.t_isloro,"
             +"\n"+ "                         documents_.t_linkAccount,"
             +"\n"+ "                         documents_.t_linkParty,"
             +"\n"+ "                         documents_.t_incoverrest,"
             +"\n"+ "                         documents_.t_outcoverrest,"
             +"\n"+ "                         documents_.t_number,"
             +"\n"+ "                         documents_.t_date,"
             +"\n"+ "                         documents_.t_debetaccount,"
             +"\n"+ "                         documents_.t_creditaccount,"
             +"\n"+ "                         documents_.t_incoversum,"
             +"\n"+ "                         documents_.t_iscreditdocument,"
             +"\n"+ "                         documents_.t_note"
             +"\n"+ "                    FROM dcorschem_dbt corschem,"
             +"\n"+ "                         ((SELECT repaccount.t_account,"
             +"\n"+ "                                  repaccount.t_chapter,"
             +"\n"+ "                                  repaccount.t_fiid,"
             +"\n"+ "                                  repaccount.t_departmentid,"
             +"\n"+ "                                  repaccount.t_name,"
             +"\n"+ "                                  repaccount.t_incoverrest,"
             +"\n"+ "                                  repaccount.t_outcoverrest,"
             +"\n"+ "                                  repaccount.t_isloro,"
             +"\n"+ "                                  repaccount.t_linkAccount,"
             +"\n"+ "                                  repaccount.t_linkParty,"
             +"\n"+ "                                  doc.t_number,"
             +"\n"+ "                                  doc.t_date,"
             +"\n"+ "                                  doc.t_debetaccount,"
             +"\n"+ "                                  doc.t_creditaccount,"
             +"\n"+ "                                  doc.t_incoversum,"
             +"\n"+ "                                  1 t_iscreditdocument,"
             +"\n"+ "                                  doc.t_note"
             +"\n"+ "                             FROM doc,"
             +"\n"+ "                                  repaccount"
             +"\n"+ "                            WHERE repaccount.t_account = doc.t_creditaccount(+)"
             +"\n"+ "                              AND repaccount.t_chapter = doc.t_chapter(+))"
             +"\n"+ "                            UNION"
             +"\n"+ "                          (SELECT repaccount.t_account,"
             +"\n"+ "                                  repaccount.t_chapter,"
             +"\n"+ "                                  repaccount.t_fiid,"
             +"\n"+ "                                  repaccount.t_departmentid,"
             +"\n"+ "                                  repaccount.t_name,"
             +"\n"+ "                                  repaccount.t_incoverrest,"
             +"\n"+ "                                  repaccount.t_outcoverrest,"
             +"\n"+ "                                  repaccount.t_isloro,"
             +"\n"+ "                                  repaccount.t_linkAccount,"
             +"\n"+ "                                  repaccount.t_linkParty,"
             +"\n"+ "                                  doc.t_number,"
             +"\n"+ "                                  doc.t_date,"
             +"\n"+ "                                  doc.t_debetaccount,"
             +"\n"+ "                                  doc.t_creditaccount,"
             +"\n"+ "                                  doc.t_incoversum,"
             +"\n"+ "                                  0 t_iscreditdocument,"
             +"\n"+ "                                  doc.t_note"
             +"\n"+ "                             FROM doc,"
             +"\n"+ "                                  repaccount"
             +"\n"+ "                            WHERE repaccount.t_account = doc.t_debetaccount(+)"
             +"\n"+ "                              AND repaccount.t_chapter = doc.t_chapter(+))) documents_"
             +"\n"+ "   WHERE documents_.t_account      = corschem.t_account(+)"
             +"\n"+ "     AND documents_.t_fiid         = corschem.t_fiid(+)"
             +"\n"+ "     AND documents_.t_departmentid = corschem.t_department(+)"
             +"\n"+ "     AND (documents_.t_incoverrest <> 0 OR documents_.t_outcoverrest <> 0 OR documents_.t_incoversum <> 0)) documents"
             +"\n"+ "   GROUP BY ROLLUP (documents.t_isloro,"
             +"\n"+ "                    documents.t_account,"
             +"\n"+ "                    documents.t_iscreditdocument,"
             +"\n"+ "                    (documents.t_name,"
             +"\n"+ "                     documents.t_incoverrest,"
             +"\n"+ "                     documents.t_outcoverrest,"
             +"\n"+ "                     documents.t_number,"
             +"\n"+ "                     documents.t_date,"
             +"\n"+ "                     documents.t_debetaccount,"
             +"\n"+ "                     documents.t_creditaccount,"
             +"\n"+ "                     documents.t_incoversum,"
             +"\n"+ "                     documents.t_note,"
             +"\n"+ "                     documents.t_linkAccount,"
             +"\n"+ "                     documents.t_linkParty"
             +"\n"+ "                    ))"
             +"\n"+ "  HAVING (GROUPING (documents.t_isloro) = 0"
             +"\n"+ "     AND NOT (    GROUPING (documents.t_iscreditdocument) = 1"
             +"\n"+ "              AND GROUPING (documents.t_account)          = 0"
             +"\n"+ "              AND GROUPING (documents.t_name)             = 1)))"
             +"\n"+ "   ORDER BY t_isloro DESC,"
             +"\n"+ "            t_islorobegin DESC,"
             +"\n"+ "            t_account,"
             +"\n"+ "            t_iscreditdocument,"
             +"\n"+ "            t_iscreditordebetend,"
             +"\n"+ "            t_date,"
             +"\n"+ "            t_number";

        return sourceQuery;
    end;

    macro getData(filter)
        var dataSet = TRsbDataSet(getSourceQuery(filter));
        return dataSet;
    end;
end;

class (RcbDataSources) F603DataSources()
    initRcbDataSources(null);

    private macro initialize()
        m_dataSourcePool.push_back(F603DataSource(this));
        m_dataSourcePool.push_back(F603DataSourceForControlBeginData(this));
        m_dataSourcePool.push_back(F603DataSourceForProtocol(this));
    end;
end;

class (RcbDataSources) F603DataSources_2539()
    initRcbDataSources(null);

    private macro initialize()
        m_dataSourcePool.push_back(F603DataSource_2539(this));
        m_dataSourcePool.push_back(F603DataSourceForControlBeginData(this));
        m_dataSourcePool.push_back(F603DataSourceForProtocol(this));
    end;
end;

class (RcbDataSources) F603DataSources_3129()
    initRcbDataSources(null);

    private macro initialize()
        m_dataSourcePool.push_back(F603DataSource_3129(this));
        m_dataSourcePool.push_back(F603DataSourceForControlBeginData(this));
        m_dataSourcePool.push_back(F603DataSourceForProtocol(this));
    end;
end;

class (RcbDataSources) F603DataSources_4212()
    initRcbDataSources(null);

    private macro initialize()
        m_dataSourcePool.push_back(F603DataSource_4212(this));
        m_dataSourcePool.push_back(F603DataSourceForControlBeginData(this));
        m_dataSourcePool.push_back(F603DataSourceForProtocol_4212(this));
    end;
end;
