/*
$Name:          f603PtkPsdExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 603. Контроллер экспорта
*/

/**
 * Операция экспорта в АС ПСД для раздела.
 */
class TPtkPsdExportPartController(view, part, head)
     /**
      * Представление печати.
      */
     private var m_view            = view;
     /**
      * Ссылка на раздел.
      */
     private var m_part            = part;
     /**
      * Заголовок раздела.
      */
     private var m_applicationCode = head;
     /*
      * Банк нерезидент обременитель
      */
    const
        ISBANKNOTRESIDENT : integer = 1;
     /*
      * в атрибутах не сохраняется наименование страны
      */
    macro getCountryName(countryCode)
         var sqlStr = "SELECT t_name"
             + "\n" + "  FROM dcountry_dbt"
             + "\n" + " WHERE t_codenum3 = '" + countryCode + "'";
         var ds = TrsbDataSet(sqlStr);

         if (ds.moveNext())
            return ds.name;
         end;
         return "";
     end;

     macro isCheckIsBankNotResident(nameBank, accountOnerousClaim)
         var sqlStr = " SELECT CASE"
         + "\n" + "                WHEN party.t_isBank = 1 AND party.t_isResident = 0"
         + "\n" + "                    THEN " + ISBANKNOTRESIDENT
         + "\n" + "                    ELSE 0"
         + "\n" + "                END t_isBankNotResident"
         + "\n" + "       FROM dRepLinkedObjects_vw link,"
         + "\n" + "            dRepParty_vw         party,"
         + "\n" + "            dRepAccount_vw       acc"
         + "\n" + "      WHERE acc.t_objectId   = link.t_connectObjectId"
         + "\n" + "        AND acc.t_account LIKE '" + accountOnerousClaim + "'"
         + "\n" + "        AND party.t_name LIKE  '" + nameBank + "'"
         + "\n" + "        AND party.t_objectId = link.t_id"
         + "\n" + "        AND link.t_role      = 59";
         var ds = TrsbDataSet(sqlStr);

         if (ds.moveNext())
            return ds.isBankNotResident;
         end;
         return 0;
     end;
     /**
      * в атрибутах не сохраняется наименование страны
      */
     macro findNewNotRes(notResAttribute, notResArray)
         var l = 0;
         while (l < notResArray.size)
             if (notResAttribute.getValueAsString(14) == notResArray[l].getValueAsString(14))
                 return l;
             end;
             l = l+1;
         end;
         return -1;
     end;
     /**
      * Печать раздела в файл экспорта.
      */
     macro execute()
         var attributes : RcbArray = m_part.getAttributes();
         var row        : Integer  = 1;     /*номер строки раздела*/
         var notResArr = TArray();          /*массив нерезидентов*/

         attributes.moveFirst();
         while (attributes.moveNext())
             var i = 1;
             var attribute = attributes.getCurrentItem();

             if (attribute.getValueAsString(11) == 2)
                 var posNotRes = findNewNotRes(attribute, notResArr);
                 if (posNotRes == -1)
                     posNotRes = notResArr.size;
                     notResArr[notResArr.size] = attribute;
                 end;
                 m_view.printRow(m_applicationCode,  //Код приложения
                                 string(row:4:o),    //строка
                                 "res",              //признак резидента
                                 posNotRes+1);       //Код нерезидента из справочного приложения F603_N
             else
                 m_view.printRow(m_applicationCode,
                                 string(row:4:o),
                                 "res",
                                 0);                 //признак резидента = 0
             end;

             while (i < 10)
                 m_view.printRow(m_applicationCode,
                                 string(row:4:o),
                                 i,                  //колонка
                                 attribute.getValueAsString(i+1)/*значение*/);
                 i=i+1;
             end;
             row = row + 1;
         end;

         /*  справочное приложение F603_N  */
         var n = 0;
         while (n < notResArr.size)
             m_view.printRow(m_applicationCode + "_N", //Код приложения
                             string(n+1:3:o),          //код строки соответстветствует коду банка-нерезидента
                             "CODE",                   //код банка нерезидента (номер по порядку в отчете от 1 до 999)
                             n+1);
             m_view.printRow(m_applicationCode + "_N",
                             string(n+1:3:o),
                             "SWIFT",                  //Код SWIFT банка нерезидента
                             notResArr[n].getValueAsString(3));
             m_view.printRow(m_applicationCode + "_N",
                             string(n+1:3:o),
                             "NAME",                   //Наименование банка нерезидента
                             notResArr[n].getValueAsString(2));
             m_view.printRow(m_applicationCode + "_N",
                             string(n+1:3:o),
                             "ISO",                    //Числовой код страны
                             notResArr[n].getValueAsString(4));

             //наименования страны нет в атрибутах, берем значение из таблицы dcountry_dbt
             m_view.printRow(m_applicationCode + "_N",
                             string(n+1:3:o),
                             "CNAME",                  //наименование страны
                             getCountryName(notResArr[n].getValueAsString(4)));
             n=n+1;
         end;
     end;
end;

class (TPtkPsdExportPartController) TPtkPsdExportPartController_3129(view, part, head)
    initTPtkPsdExportPartController(view, part, head);

    macro execute()
        var attributes : RcbArray = m_part.getAttributes();
        var row        : Integer  = 1;     /*номер строки раздела*/
        var notResArr = TArray();          /*массив нерезидентов*/

        attributes.moveFirst();
        while (attributes.moveNext())
            var i = 1;
            var attribute = attributes.getCurrentItem();
            var isThirdPerson = attribute.getValue(15);
            var isResident = attribute.getValueAsString(11);

            m_view.printRow(m_applicationCode,  //Код приложения
                            string(row:4:o),    //строка
                            "npp",              //признак резидента
                            row);               //Код нерезидента из справочного приложения F603_N

            if (isResident == 2)
                var posNotRes = findNewNotRes(attribute, notResArr);
                if (posNotRes == -1)
                    posNotRes = notResArr.size;
                    notResArr[notResArr.size] = attribute;
                end;
                m_view.printRow(m_applicationCode,  //Код приложения
                                string(row:4:o),    //строка
                                "res",              //признак резидента
                                posNotRes + 1);     //Код нерезидента из справочного приложения F603_N
            else
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "res",
                                0);
            end;

            while (i < 10)
                if (i == 3)
                    if (isResident == 1)
                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        {MFO_BANK}/*значение БИК*/);
                    else
                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        attribute.getValueAsString(i + 1)/*значение КодСтр*/);
                    end;
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    i,                  //колонка
                                    attribute.getValueAsString(i + 1)/*значение*/);
                end;
                i = i + 1;
            end;

            if (isThirdPerson == 1) /* (Если в значении атрибута  НомПП символ "*") == (Если на лицевом счете для атрибута НомЛС установлена категория "Вид актива" со значением "Третье лицо") */
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "pz",
                                1);
                if (attribute.getRcbValue(16, null, true).isDefined())
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    ternary(attribute.getScaledValueAsString(16) == 0, "", attribute.getScaledValueAsString(16)));
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    "");
                end;
                //если атрибуты pz2-pzt не определены, то в файл экспорта их не выводим
                if (attribute.getScaledValueAsString(17) != "Undefined")
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz2",
                                    attribute.getScaledValueAsString(17));
                end;
                if (attribute.getValue(18) != null)
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz3",
                                    attribute.getValue(18));
                end;
                if (attribute.getValue(19) != null)
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pzt",
                                    attribute.getValue(19));
                end;
            else
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "pz",
                                0);
                if (attribute.getRcbValue(16, null, true).isDefined())
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    ternary(attribute.getScaledValueAsString(16) == 0, "", attribute.getScaledValueAsString(16)));
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    "");
                end;
                //если на счете не установлена категория "Вид актива" со значением "Третье лицо", то атрибуты pz2-pzt в файл экспорта не выводим
            end;

            row = row + 1;
        end;

        /*  справочное приложение F603_N  */
        var n = 0;
        while (n < notResArr.size)
            m_view.printRow(m_applicationCode + "_N", //Код приложения
                            string(n + 1 :3:o),          //код строки соответстветствует коду банка-нерезидента
                            "CODE",                   //код банка нерезидента (номер по порядку в отчете от 1 до 999)
                            n + 1);
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "SWIFT",                  //Код SWIFT банка нерезидента
                            notResArr[n].getValueAsString(3));
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "NAME",                   //Наименование банка нерезидента
                            notResArr[n].getValueAsString(2));
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "ISO",                    //Числовой код страны
                            notResArr[n].getValueAsString(4));

            //наименования страны нет в атрибутах, берем значение из таблицы dcountry_dbt
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "CNAME",                  //наименование страны
                            getCountryName(notResArr[n].getValueAsString(4)));
            n =n + 1;
        end;
    end;
end;

class (TPtkPsdExportPartController) TPtkPsdExportPartController_4212(view, part, head)
    initTPtkPsdExportPartController(view, part, head);

    macro execute()
        var attributes : RcbArray = m_part.getAttributes();
        var row        : Integer  = 1;     /*номер строки раздела*/
        var notResArr = TArray();          /*массив нерезидентов*/

        attributes.moveFirst();
        while (attributes.moveNext())
            var i = 1;
            var attribute = attributes.getCurrentItem();
            var isThirdPerson = attribute.getValue(15);
            var isResident = attribute.getValueAsString(11);

            m_view.printRow(m_applicationCode,  //Код приложения
                            string(row:4:o),    //строка
                            "npp",              //признак резидента
                            row);               //Код нерезидента из справочного приложения F603_N

            if (isResident == 2)
                var posNotRes = findNewNotRes(attribute, notResArr);
                if (posNotRes == -1)
                    posNotRes = notResArr.size;
                    notResArr[notResArr.size] = attribute;
                end;
                m_view.printRow(m_applicationCode,  //Код приложения
                                string(row:4:o),    //строка
                                "res",              //признак резидента
                                posNotRes + 1);     //Код нерезидента из справочного приложения F603_N
            else
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "res",
                                0);
            end;

            while (i < 15)
                if (i == 3)
                    if (isResident == 1)
                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        {MFO_BANK}/*значение БИК*/);
                    else
                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        attribute.getValueAsString(i + 1)/*значение КодСтр*/);
                    end;
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    i,                  //колонка
                                    ternary(attribute.getValueAsString(i + 1) != "Undefined", attribute.getValueAsString(i + 1), "") /*значение*/);
                end;
                i = i + 1;
            end;

            if (isThirdPerson == 1) /* (Если в значении атрибута  НомПП символ "*") == (Если на лицевом счете для атрибута НомЛС установлена категория "Вид актива" со значением "Третье лицо") */
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "pz",
                                1);
                if (attribute.getRcbValue(16, null, true).isDefined())
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    ternary(attribute.getScaledValueAsString(16) == 0, "", attribute.getScaledValueAsString(16)));
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    "");
                end;
                //если атрибуты pz2-pzt не определены, то в файл экспорта их не выводим
                if (attribute.getScaledValueAsString(17) != "Undefined")
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz2",
                                    attribute.getScaledValueAsString(17));
                end;
                if (attribute.getValue(18) != null)
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz3",
                                    attribute.getValue(18));
                end;
                if (attribute.getValue(19) != null)
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pzt",
                                    attribute.getValue(19));
                end;
            else
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "pz",
                                0);
                if (attribute.getRcbValue(16, null, true).isDefined())
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    ternary(attribute.getScaledValueAsString(16) == 0, "", attribute.getScaledValueAsString(16)));
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    "pz1",
                                    "");
                end;
                //если на счете не установлена категория "Вид актива" со значением "Третье лицо", то атрибуты pz2-pzt в файл экспорта не выводим
            end;

            row = row + 1;
        end;

        /*  справочное приложение F603_N  */
        var n = 0;
        while (n < notResArr.size)
            m_view.printRow(m_applicationCode + "_N", //Код приложения
                            string(n + 1 :3:o),          //код строки соответстветствует коду банка-нерезидента
                            "CODE",                   //код банка нерезидента (номер по порядку в отчете от 1 до 999)
                            n + 1);
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "SWIFT",                  //Код SWIFT банка нерезидента
                            notResArr[n].getValueAsString(3));
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "NAME",                   //Наименование банка нерезидента
                            notResArr[n].getValueAsString(2));
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "ISO",                    //Числовой код страны
                            notResArr[n].getValueAsString(4));

            //наименования страны нет в атрибутах, берем значение из таблицы dcountry_dbt
            m_view.printRow(m_applicationCode + "_N",
                            string(n + 1 :3:o),
                            "CNAME",                  //наименование страны
                            getCountryName(notResArr[n].getValueAsString(4)));
            n =n + 1;
        end;
    end;
end;

class (TPtkPsdExportPartController) TPtkPsdExportPartController_5_84_4212(view, part, head)
    initTPtkPsdExportPartController(view, part, head);

    //проверка, отобран ли уже банк-нерезидент, являющийся контрагентами по обременению, в банки-нерезиденты клиента счета НомЛС
    private macro checkNotResident(baseArray, swift, name, iso)
        if (isEqClass("RcbArray", baseArray))
            for (var i, 0, baseArray.size - 1, 1)
                if (    (   (baseArray[i][0] == swift)
                         or (baseArray[i][0] == StrSubst(swift, "XXX", ""))
                        )
                    and (baseArray[i][1] == name)
                    and (baseArray[i][2] == iso)
                   )
                    return false;
                end;
            end;
        else
            for (i, 0, baseArray.size - 1, 1)
                if (    (   (baseArray[i].getValueAsString(3) == swift)
                         or (baseArray[i].getValueAsString(3) == StrSubst(swift, "XXX", ""))
                        )
                    and (baseArray[i].getValueAsString(2) == name)
                    and (baseArray[i].getValueAsString(4) == iso)
                   )
                    return false;
                end;
            end;
        end;
        return true;
    end;

    macro execute()
        var attributes : RcbArray = m_part.getAttributes();
        var row        : Integer  = 1;                                /*номер строки раздела*/
        var notResArr             = TArray();                         /*массив нерезидентов*/
        var notResArrBranch       = RcbArray();                       /*массив нерезидентов* контрагентов по обременению*/
        var AccounteNote          = F603KlikoExportController_4212();
        var numOBR                = "_01";                            /* До реализации запроса 248905 номер обременения XX всегда равен 01*/
        var note;
        var partyBic : string;
        var partyId  : Integer;

        attributes.moveFirst();
        while (attributes.moveNext())
            var i             = 1;
            var attribute     = attributes.getCurrentItem();
            var isThirdPerson = attribute.getValue(15);
            var isResident    = attribute.getValueAsString(16);

            m_view.printRow(m_applicationCode,  //Код приложения
                            string(row:4:o),    //строка
                            "npp",              //признак резидента
                            row);               //Код нерезидента из справочного приложения F603_N

            if (isResident == 2)
                var posNotRes = findNewNotRes(attribute, notResArr);
                if (posNotRes == -1)
                    posNotRes = notResArr.size;
                    notResArr[notResArr.size] = attribute;
                end;
                m_view.printRow(m_applicationCode,  //Код приложения
                                string(row:4:o),    //строка
                                "res",              //признак резидента
                                posNotRes + 1);     //Код нерезидента из справочного приложения F603_N
            else
                m_view.printRow(m_applicationCode,
                                string(row:4:o),
                                "res",
                                0);
            end;

            while (i < 10)
                if (i == 3)
                    if (isResident == 1)
                        partyId  = Int(attribute.getValue(19));
                        partyBic = ПолучитьКодСубъекта(partyId, PTCK_BIC);

                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        partyBic/*значение БИК*/);
                    else
                        m_view.printRow(m_applicationCode,
                                        string(row:4:o),
                                        i,                  //колонка
                                        attribute.getValueAsString(i + 1)/*значение КодСтр*/);
                    end;
                else
                    m_view.printRow(m_applicationCode,
                                    string(row:4:o),
                                    i,                  //колонка
                                    ternary(attribute.getValueAsString(i + 1) != "Undefined", attribute.getValueAsString(i + 1), "") /*значение*/);
                end;
                i = i + 1;
            end;

            /* F603_OBR*/
            m_view.printRow(m_applicationCode + "_OBR",  //Код приложения
                                string(row:4:o) + numOBR,    //строка
                                "npp",
                                row);

            m_view.printRow(m_applicationCode + "_OBR",
                                string(row:4:o) + numOBR,
                                "nom",
                                "1");

            if (attribute.getValue(11) == 0)
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "kod_obr",
                                    0);
            elif (attribute.getValue(11) == 1)
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "kod_obr",
                                    1);
            else
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "kod_obr",
                                    9);
            end;

            if ((attribute.getValueAsString(11) != 0) and (attribute.getValueAsString(11) != ""))

                m_view.printRow(m_applicationCode + "_OBR",
                                string(row:4:o) + numOBR,
                                "npers_obr",
                                attribute.getValue(11));
                if (    (isCheckIsBankNotResident(attribute.getValue(11), attribute.getValue(6)) == ISBANKNOTRESIDENT)
                    and checkNotResident(notResArr, attribute.getValue(12), attribute.getValue(11), attribute.getValue(27))
                    and checkNotResident(notResArrBranch, attribute.getValue(12), attribute.getValue(11), attribute.getValue(27))
                   )
                     notResArrBranch.push_back(RcbArray().initialize(attribute.getValue(12),
                                                                     attribute.getValue(11),
                                                                     attribute.getValue(27))
                                               );
                end;
            end;
            if (attribute.getValue(26) != null)
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "kpers_obr",
                                    attribute.getValue(26));
            end;
            if (attribute.getValue(26) == "4")
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "res_obr",
                                     posNotRes + 1);
            else
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "res_obr",
                                    0);
            end;
            if ((attribute.getValue(12) != null) and (attribute.getValue(12) != ""))
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "2_obr",
                                    attribute.getValue(12));
            end;
            if ((attribute.getValue(13) != null) and (attribute.getValue(13) != ""))
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "vid_obz",
                                    attribute.getValue(13));
            end;
            if (attribute.getValue(14) != null)
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "sum_obz",
                                    attribute.getValue(14));
            end;
            if ((attribute.getValue(15) != null) and (attribute.getValue(15) != ""))
                var day, month, year;
                DateSplit(Date(attribute.getValue(15)), day, month, year);
                m_view.printRow(m_applicationCode + "_OBR",
                                    string(row:4:o) + numOBR,
                                    "date_obz",
                                    String(year) + String(month:2:o) + String(day:2:o));
            end;
            if (attribute.getValue(13) == "4")
                note = AccounteNote.getAccounteNoteForAsPsd(attribute.getValueAsString(6),69);
                if ((note != "") and (ValType(note) != V_UNDEF))
                    m_view.printRow(m_applicationCode + "_OBR",
                                        string(row:4:o) + numOBR,
                                        "prim_obz",
                                        ternary(ValType(note) != V_UNDEF, note, ""));
                end;
            end;

            row = row + 1;
        end;

        /*  справочное приложение F603_N  */
        macro writeStringForF603_N(code, swift, name, iso)
            m_view.printRow(m_applicationCode + "_N", //Код приложения
                            string(code + 1 :3:o),    //код строки соответстветствует коду банка-нерезидента
                            "CODE",                   //код банка нерезидента (номер по порядку в отчете от 1 до 999)
                            code + 1);
            m_view.printRow(m_applicationCode + "_N",
                            string(code + 1 :3:o),
                            "SWIFT",                  //Код SWIFT банка нерезидента
                            swift);
            m_view.printRow(m_applicationCode + "_N",
                            string(code + 1 :3:o),
                            "NAME",                   //Наименование банка нерезидента
                            name);
            m_view.printRow(m_applicationCode + "_N",
                            string(code + 1 :3:o),
                            "ISO",                    //Числовой код страны
                            iso);

            //наименования страны нет в атрибутах, берем значение из таблицы dcountry_dbt
            m_view.printRow(m_applicationCode + "_N",
                            string(code + 1 :3:o),
                            "CNAME",                  //наименование страны
                            getCountryName(iso));
        end;

        var n = 0;
        var y = 0;

        while (n < notResArr.size)
            writeStringForF603_N(n, notResArr[n].getValueAsString(3), notResArr[n].getValueAsString(2), notResArr[n].getValueAsString(4));
            n = n + 1;
        end;

        while (y < notResArrBranch.size)
            writeStringForF603_N(n, notResArrBranch[y][0], notResArrBranch[y][1], notResArrBranch[y][2]);
            y = y + 1;
            n = n + 1;
        end;
    end;
end;

/**
 * Операция экспорта в АС ПСД отчета.
 */
class  F603PtkPsdExportController()
    private var m_ptkPsdExportPartControllers : TArray;
    private var m_ptkPsdView;
    private var m_report;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();
        m_report                      = objectFactoryInstance.createReport();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView, m_report.getPart(1), "F603");
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;
        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class  (F603PtkPsdExportController) F603PtkPsdExportController_3129()
    initF603PtkPsdExportController();

    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();
        m_report                      = objectFactoryInstance.createReport();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_3129(m_ptkPsdView, m_report.getPart(1), "F603");
    end;
end;

class  (F603PtkPsdExportController) F603PtkPsdExportController_4212()
    initF603PtkPsdExportController();

    private macro getDescriptorInfo()
        return "Формат экспорта в АС ПСД доработан \"по интуиции\" в соответствии с требованиями Указания № 4212-У";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();
        m_report                      = objectFactoryInstance.createReport();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_4212(m_ptkPsdView, m_report.getPart(1), "F603");
    end;
end;

class  (F603PtkPsdExportController) F603PtkPsdExportController_5_84_4212()
    initF603PtkPsdExportController();

    private macro getDescriptorInfo()
        return "Формат экспорта в АС ПСД доработан в соответствии с мета-данным 0mw1g";
    end;

    private macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = objectFactoryInstance.createPtkPsdView();
        m_report                      = objectFactoryInstance.createReport();

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController_5_84_4212(m_ptkPsdView, m_report.getPart(1), "F603");
    end;
end;