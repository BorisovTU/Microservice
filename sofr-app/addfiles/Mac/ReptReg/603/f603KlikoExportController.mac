/*
$Name:          f603KlikoExportController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 603. Контроллер экспорта в kliko
*/

class F603KlikoExportController()
    private var m_report : F603Report;
    private var m_view   : TRcbKlikoView;

    private macro initialize()
        m_view   = objectFactoryInstance.createKlikoView();
        m_report = objectFactoryInstance.createReport(global().getRcbReport(), false);
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    private macro getValue(column : Integer, attribute : F603Attribute) : String
        if (attribute.getRcbValue(column, null, true).isDefined());
            return attribute.getValueAsString(column);
        else
            return "";
        end;
    end;

    private macro getValuePool(attribute : F603Attribute)
        var part = m_report.getPart(1);
        var valuePool = TArray();

        valuePool[0] = getValue(2, attribute);

        if ((getValue(11, attribute) == "2") and (StrLen(getValue(3, attribute)) == 11))
            valuePool[1] = SubStr(getValue(3, attribute),1,8);
        else
            valuePool[1] = getValue(3, attribute);
        end;

        if ((getValue(11, attribute) == "2") and (StrLen(getValue(3, attribute)) == 11))
            valuePool[2] = SubStr(getValue(3, attribute),9,3);
        else
            valuePool[2] = "";
        end;

        valuePool[3]  = getValue(4,  attribute);
        valuePool[4]  = getValue(5,  attribute);
        valuePool[5]  = getValue(6,  attribute);
        valuePool[6]  = getValue(7,  attribute);
        valuePool[7]  = getValue(8,  attribute);
        valuePool[8]  = getValue(9,  attribute);
        valuePool[9]  = getValue(10, attribute);
        valuePool[10] = "";
        valuePool[11] = getValue(11, attribute);
        valuePool[12] = "1";
        valuePool[13] = "1";
        valuePool[14] = "";

        return valuePool;
    end;

    private macro printPart()
        m_view.printHead("F603M");

        var attributesPool = m_report.getPart(1).getAttributes();

        attributesPool.moveFirst();

        while (attributesPool.moveNext())
            m_view.printRow(getValuePool(attributesPool.getCurrentItem()));
        end;
    end;

    /**
     * Выполнить печать.
     */
    macro execute()
        m_view.setOutputFile();

        printPart();

        m_view.resetOutputFile();

        var protocolView = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В kliko.exe");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("Файл описателя: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Выгружено строк: " + String(m_view.getHeadsCount() + m_view.getRowsCount()) + ", в т.ч.:");
        protocolView.printLine("    количество служебных строк: " + m_view.getHeadsCount());
        protocolView.printLine("    количество содержательных строк:" + m_view.getRowsCount());

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;

    initialize();
end;

class (F603KlikoExportController) F603KlikoExportController_3129()
    initF603KlikoExportController();

    private macro getDescriptorInfo()
        return "f603_02.pak от 05.02.2014";
    end;

    private macro getExactValue(column : Integer, attribute : F603Attribute) : String

        if (attribute.getRcbValue(column, null, true).isDefined());
            return attribute.getExactValueAsString(column);
        else
            return "";
        end;
    end;

    private macro getScaledValue(column : Integer, attribute : F603Attribute) : String
        if (attribute.getRcbValue(column, null, true).isDefined());
            return attribute.getScaledValueAsString(column);
        else
            return "";
        end;
    end;

    private macro getValuePool(attribute : F603Attribute)
        var part = m_report.getPart(1);
        var valuePool = TArray();

        valuePool[0] = getValue(2, attribute);

        if ((getValue(11, attribute) == "2") and (StrLen(getValue(3, attribute)) == 11))
            valuePool[1] = SubStr(getValue(3, attribute),1,8);
        else
            valuePool[1] = getValue(3, attribute);
        end;

        if ((getValue(11, attribute) == "1") and (getValue(3, attribute) == "2639"))
            valuePool[2] = "МГ";
        elif ((getValue(11, attribute) == "2") and (StrLen(getValue(3, attribute)) == 11))
            valuePool[2] = SubStr(getValue(3, attribute),9,3);
        else
            valuePool[2] = "";
        end;

        valuePool[3]  = getValue(4,  attribute);

        if (getValue(15, attribute) == 1)
            valuePool[4] = "*";
        else
            valuePool[4] = ""
        end;

        valuePool[5]  = getScaledValue(16, attribute);
        valuePool[6]  = getExactValue(17, attribute);
        valuePool[7]  = getExactValue(18, attribute);
        valuePool[8]  = getExactValue(19, attribute);

        valuePool[9]  = getValue(5,  attribute);
        valuePool[10] = getValue(6, attribute);
        valuePool[11] = getValue(7,  attribute);
        valuePool[12] = getValue(8,  attribute);
        valuePool[13] = getValue(9,  attribute);
        valuePool[14] = getValue(10, attribute);
        valuePool[15] = "";
        valuePool[16] = getValue(11, attribute);

        return valuePool;
    end;
end;

class (F603KlikoExportController_3129) F603KlikoExportController_4212()
    initF603KlikoExportController_3129();

    private macro getDescriptorInfo()
        return "F603_05.pak от 09.02.2017";
    end;

    //получение примечания к л/с
    private macro getAccounteNote(account : String, noteType : integer) : String
        var query  = "select rep_note.getTextAccountNote((SELECT t_id"
            + "\n" + "                                      FROM dRepLinkedObjects_vw objLink"
            + "\n" + "                                     WHERE objLink.t_connectObjectId = (select t_objectId from dRepAccount_vw where t_account = " + getSqlString(account) + " and rownum < 2)"
            + "\n" + "                                       AND objLink.t_role            = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
            + "\n" + "                                       AND rownum                    = 1),"
            + "\n" + String(noteType) + ", "
            + "\n" + getSqlDate(RcbApplication().currentReport.context.period.endDate) + ")"
            + "\n" + " AS t_note from dual;";

        var dataSet = TRsbDataSet(query);

        dataSet.SetFieldType("t_note", V_STRING);

        if (dataSet.moveNext())
            return dataSet.note;
        else
            return "";
        end;
    end;

    macro getAccounteNoteForAsPsd(account : String, noteType : integer) : String
        return getAccounteNote(account,noteType);
    end;

    private macro getValuePool(attribute : F603Attribute)
        var part      = m_report.getPart(1);
        var valuePool = TArray();
        var note;

        valuePool[0] = getValue(2, attribute);                      //Н

        if (    (getValue(16, attribute) == "2")                    //№
            and (StrLen(getValue(3, attribute)) == 11))
            valuePool[1] = SubStr(getValue(3, attribute), 1, 8);
        else
            valuePool[1] = getValue(3, attribute);
        end;


        if   (    (getValue(16, attribute) == "1")                  //Ф-л
              and (getValue( 3, attribute) == "2639"))
            valuePool[2] = "МГ";
        elif (    (getValue(16, attribute) == "2")
              and (StrLen(getValue(3, attribute)) == 11))
            valuePool[2] = SubStr(getValue(3, attribute), 9, 3);
        else
            valuePool[2] = "";
        end;

        valuePool[3]  = getValue(4,  attribute);                    //Страна
        valuePool[4]  = getExactValue(24, attribute);               //Пояснения о характере сделки
        valuePool[5]  = getValue(5,  attribute);                    //Счет Ностро
        valuePool[6]  = getValue(6,  attribute);                    //Л/с
        valuePool[7]  = getValue(7,  attribute);                    //Вх
        valuePool[8]  = getValue(8,  attribute);                    //Д
        valuePool[9]  = getValue(9,  attribute);                    //К
        valuePool[10] = getValue(10, attribute);                    //Исх

        if   (getValue(11, attribute) == 0)                         //Призн_обрем_kliko
            valuePool[11] = 0;
        elif (getValue(11, attribute) == 1)
            valuePool[11] = 1;
        else
            valuePool[11] = 9;
        end;

        valuePool[12] = getValue(26, attribute);                    //Условн_код_kliko
        valuePool[13] = getValue(11, attribute);                    //Обрем_Гр11
        valuePool[14] = getValue(12, attribute);                    //Обрем_Гр12
        valuePool[15] = getValue(25, attribute);                    //Филиал_SWIFT_Kliko
        valuePool[16] = getValue(13, attribute);                    //Обрем_Гр13

        if (valuePool[16] == "Обремененное обязательство является иным обязательством")//4)                                     //Иное_расш_kliko
            note = getAccounteNote(valuePool[6], 69);
            valuePool[17] = ternary(ValType(note) != V_UNDEF, note, "");
        else
            valuePool[17] = "";
        end;

        valuePool[18] = getValue(14, attribute);                    //Обрем_Гр14
        valuePool[19] = getValue(15, attribute);                    //Обрем_Гр15
        valuePool[20] = "";                                         //""
        valuePool[21] = getValue(16, attribute);                    //1(2)

        return valuePool;
    end;
end;

class (F603KlikoExportController_4212) F603KlikoExportController_Т1_30_1_01_72551()
    initF603KlikoExportController_4212();

    private macro getDescriptorInfo()
        return "F603_07.pak от 30.06.2017";
    end;

    private macro getValuePool(attribute : F603Attribute)
        var part      = m_report.getPart(1);
        var valuePool = TArray();
        var note;

        valuePool[0] = getValue(2, attribute);                                                       //Н

        if (    (getValue(16, attribute) == "2")                                                     //№
            and (StrLen(getValue(3, attribute)) == 11))
            valuePool[1] = SubStr(getValue(3, attribute), 1, 8);
        else
            valuePool[1] = getValue(3, attribute);
        end;


        if   (    (getValue(16, attribute) == "1")                                                   //Ф-л
              and (getValue( 3, attribute) == "2639"))
            valuePool[2] = "МГ";
        elif (    (getValue(16, attribute) == "2")
              and (StrLen(getValue(3, attribute)) == 11))
            valuePool[2] = SubStr(getValue(3, attribute), 9, 3);
        else
            valuePool[2] = "";
        end;

        valuePool[3]  = getValue(4,  attribute);                                                     //Страна
        valuePool[4]  = getExactValue(24, attribute);                                                //Пояснения о характере сделки
        valuePool[5]  = getValue(5,  attribute);                                                     //Счет Ностро
        valuePool[6]  = getValue(6,  attribute);                                                     //Л/с
        valuePool[7]  = getValue(7,  attribute);                                                     //Вх
        valuePool[8]  = getValue(8,  attribute);                                                     //Д
        valuePool[9]  = getValue(9,  attribute);                                                     //К
        valuePool[10] = getValue(10, attribute);                                                     //Исх

        if   (getValue(11, attribute) == 0)                                                          //Призн_обрем_kliko
            valuePool[11] = 0;
        elif (getValue(11, attribute) == 1)
            valuePool[11] = 1;
        else
            valuePool[11] = 9;
        end;

        valuePool[12] = getValue(26, attribute);                                                     //Условн_код_kliko
        valuePool[13] = getValue(11, attribute);                                                     //Обрем_Гр11
        valuePool[14] = getValue(12, attribute);                                                     //Обрем_Гр12
        valuePool[15] = getValue(25, attribute);                                                     //Филиал_SWIFT_Kliko
        valuePool[16] = getValue(13, attribute);                                                     //Обрем_Гр13

        if (valuePool[16] == 4)                                                                      //Иное_расш_kliko
            note = getAccounteNote(valuePool[6], RCB_NOTEKIND_OTHER_ONEROUS_OBLIGATION_EXPLANATION);
            valuePool[17] = ternary(ValType(note) != V_UNDEF, note, "");
        else
            valuePool[17] = "";
        end;

        valuePool[18] = getValue(14, attribute);                                                     //Обрем_Гр14
        valuePool[19] = getValue(15, attribute);                                                     //Обрем_Гр15
        valuePool[20] = "";                                                                          //""
        valuePool[21] = getValue(16, attribute);                                                     //1(2)
        valuePool[22] = "S";
        valuePool[23] = "1";
        valuePool[24] = "1";
        valuePool[25] = "";

        return valuePool;
    end;
end;

class (F603KlikoExportController_Т1_30_1_01_72551) F603KlikoExportController_Т1_30_1_01_81913()
    initF603KlikoExportController_Т1_30_1_01_72551();

    private macro getDescriptorInfo()
        return "F603_08.pak от 25.07.2017";
    end;

    private macro getValuePool(attribute : F603Attribute)
        var part      = m_report.getPart(1);
        var valuePool = TArray();
        var note;

        valuePool[0] = getValue(2, attribute);                                                       //Н

        if (    (getValue(16, attribute) == "2")                                                     //№
            and (StrLen(getValue(3, attribute)) == 11))
            valuePool[1] = SubStr(getValue(3, attribute), 1, 8);
        else
            valuePool[1] = getValue(3, attribute);
        end;


        if   (    (getValue(16, attribute) == "1")                                                   //Ф-л
              and (getValue( 3, attribute) == "2639"))
            valuePool[2] = "МГ";
        elif (    (getValue(16, attribute) == "2")
              and (StrLen(getValue(3, attribute)) == 11))
            valuePool[2] = SubStr(getValue(3, attribute), 9, 3);
        else
            valuePool[2] = "";
        end;

        valuePool[3]  = getValue(4,  attribute);                                                     //Страна
        valuePool[4]  = getExactValue(24, attribute);                                                //Пояснения о характере сделки
        valuePool[5]  = getValue(5,  attribute);                                                     //Счет Ностро
        valuePool[6]  = getValue(6,  attribute);                                                     //Л/с
        valuePool[7]  = getValue(7,  attribute);                                                     //Вх
        valuePool[8]  = getValue(8,  attribute);                                                     //Д
        valuePool[9]  = getValue(9,  attribute);                                                     //К
        valuePool[10] = getValue(10, attribute);                                                     //Исх

        if   (getValue(11, attribute) == 0)                                                          //Призн_обрем_kliko
            valuePool[11] = 0;
        elif (getValue(11, attribute) == 1)
            valuePool[11] = 1;
        else
            valuePool[11] = 9;
        end;

        valuePool[12] = getValue(26, attribute);                                                     //Условн_код_kliko
        valuePool[13] = getValue(11, attribute);                                                     //Обрем_Гр11
        valuePool[14] = getValue(12, attribute);                                                     //Обрем_Гр12
        valuePool[14] = ternary(getValue(25, attribute) != "", 
                                substr(getValue(12, attribute), 1, 8), 
                                getValue(12, attribute));                                            //Обрем_Гр12
        valuePool[15] = getValue(25, attribute);                                                     //Филиал_SWIFT_Kliko
        valuePool[16] = getValue(13, attribute);                                                     //Обрем_Гр13

        if (valuePool[16] == 4)                                                                      //Иное_расш_kliko
            note = getAccounteNote(valuePool[6], RCB_NOTEKIND_OTHER_ONEROUS_OBLIGATION_EXPLANATION);
            valuePool[17] = ternary(ValType(note) != V_UNDEF, note, "");
        else
            valuePool[17] = "";
        end;

        valuePool[18] = getValue(14, attribute);                                                     //Обрем_Гр14
        valuePool[19] = getValue(15, attribute);                                                     //Обрем_Гр15
        valuePool[20] = "";                                                                          //""
        valuePool[21] = getValue(16, attribute);                                                     //1(2)
        valuePool[22] = "S";
        valuePool[23] = "1";
        valuePool[24] = "1";
        valuePool[25] = "";

        return valuePool;
    end;
end;
