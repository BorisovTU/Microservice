/*
$Name:          BalanceGlobal.mac
$Module:        Регламентируемая отчетность
$Description:   Фома Балансовый отчет. Глобализмы.
*/
/**
 * Форма Балансовый отчет. Глобальная точка доступа.
 *
 * @since   07.03.2013
 * @author  Gromov
 * @version 6.00.020.31
 */

import rcbimport;
import balanceCalculateProtocolView;

const APPLICATION_5       = "appl5";
const APPLICATION_5_SPOD  = "appl5spod";
const APPLICATION_6       = "appl6";
const APPLICATION_7       = "appl7";
const APPLICATION_7_SPOD  = "appl7spod";
const APPLICATION_11      = "appl11";
const APPLICATION_13      = "appl13";
const APPLICATION_8       = "appl8";

const FLAG_OFF = 0;
const FLAG_ON  = 1;

/**
 * Формирование сообщений об ошибках.
 */
class TErrorMessage(errorRef, beginDate, endDate, dimension, printKind, applicationNumber)
    private var messages = TArray();
    private var m_dnopBalance;
    private var m_doopBalance;
    private var m_dnopSpod;
    private var m_doopSpod;
    private var m_errorRef;
    private var m_dimension;
    private var m_printKind;

    macro TErrorMessageConstructor(errorRef, dimension, dnopBalance, doopBalance, printKind, applicationNumber)
        m_dnopBalance = dnopBalance;
        m_doopBalance = doopBalance;
        m_dnopSpod    = RcbApplication().currentReport.context.period.beginDate;
        m_doopSpod    = RcbApplication().currentReport.context.period.endDate;
        m_errorRef    = errorRef;
        m_dimension   = dimension;
        m_printKind   = printKind;

        //Приложение 13
        messages[1]   = "Расчет Приложения " + applicationNumber + " не выполнен: отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.";
        messages[2]   = "Расчет Приложения " + applicationNumber + " не выполнен: отсутствуют рассчитанные данные СПОД за период с <_ДНОП> по <_ДООП> в единицах измерения <единицы измерения>.";
        messages[3]   = "Расчет Приложения " + applicationNumber + " не выполнен:\n" +
                        "отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n"
                        "отсутствуют рассчитанные данные СПОД за период с <_ДНОП> по <_ДООП> в единицах измерения <единицы измерения>.";
        messages[8]   = "При расчете Приложения " + applicationNumber + " использовались следующие данные: форма \"Баланс\" за период с <ДНОП> по <ДООП> и данные СПОД за период с <_ДНОП> по <_ДООП>.";

        //Приложение 7
        messages[4]   = "Для формирования Приложения " + applicationNumber + " отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>. Печать отчета невозможна.";
        messages[14]  = " Печать отчета невозможна:\n" +
                        "Для формирования Приложения " + applicationNumber + " отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n" +
                        "Значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\", установите одно из требуемых дистрибутивных значений:\n" +
                        "0 - в печатную форму выводятся все счета;\n" +
                        "1 - в печатную форму выводятся счета, входящие в РПС;\n" +
                        "2 - в печатную форму выводятся только счета, работающие в отчетный период (т. е. счета по которым есть ненулевые остатки / обороты).\n"
                        "3 - в печатную форму выводятся только счета, работающие в отчетный период, по которым после нормализации отчета есть ненулевые остатки / обороты.";
        messages[9]   = "Для формирования Приложения " + applicationNumber + " использовалась форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>\n" +
                        "Значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\".";
        messages[19]  = "Для формирования Приложения " + applicationNumber + " использовалась форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n" +
                        "Некорректное значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\". Будут напечатаны все счета.";

        //Приложение 7 со СПОД
        messages[5]   = "Печать отчета невозможна: для печати \"Приложения " + applicationNumber + " со СПОД\" отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.";
        messages[6]   = "Для печати \"Приложения " + applicationNumber + " со СПОД\" отсутствуют рассчитанные данные СПОД за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>. Печать отчета невозможна.";
        messages[7]   = "Формирование \"Приложения " + applicationNumber + " со СПОД\" не выполнено:\n"
                        "отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n"
                        "отсутствуют рассчитанные данные СПОД за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.";
        messages[17]  = "Формирование \"Приложения " + applicationNumber + " со СПОД\" не выполнено:\n" +
                        "отсутствует рассчитанная форма \"Баланс\" за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n" +
                        "отсутствуют рассчитанные данные СПОД за период с <ДНОП> по <ДООП> в единицах измерения <единицы измерения>.\n" +
                        "Значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\", установите одно из требуемых дистрибутивных значений:\n" +
                        "0 - в печатную форму выводятся все счета;\n" +
                        "1 - в печатную форму выводятся счета, входящие в РПС;\n" +
                        "2 - в печатную форму выводятся только счета, работающие в отчетный период (т. е. счета по которым есть ненулевые остатки / обороты).\n"
                        "3 - в печатную форму выводятся только счета, работающие в отчетный период, по которым после нормализации отчета есть ненулевые остатки / обороты.";
        messages[11]  = "Для формирования \"Приложения " + applicationNumber + " со СПОД\" использовались следующие данные: форма \"Баланс\" за период с <ДНОП> по <ДООП> и данные СПОД за период с <ДНОП> по <ДООП>.\n" +
                        "Значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\".";
        messages[21]  = "Для формирования \"Приложения " + applicationNumber + " со СПОД\" использовались следующие данные: форма \"Баланс\" за период с <ДНОП> по <ДООП> и данные СПОД за период с <ДНОП> по <ДООП>.\n" +
                        "Некорректное значение настройки реестра \"REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / ПЕЧАТЬ ФОРМЫ 101\" = \"<X>\". Будут напечатаны все счета.";
    end;

    macro getMessage()
        var s = messages[m_errorRef];

        s = StrSubst(s, "<ДНОП>",  String(m_dnopBalance));
        s = StrSubst(s, "<ДООП>",  String(m_doopBalance));
        s = StrSubst(s, "<_ДНОП>", String(m_dnopSpod));
        s = StrSubst(s, "<_ДООП>", String(m_doopSpod));
        s = StrSubst(s, "<единицы измерения>", GetUnitsName(m_dimension));
        if (m_printKind != null)
            s = StrSubst(s, "<X>", String(m_printKind));
        end;
        return s;
    end;

    TErrorMessageConstructor(errorRef, beginDate, endDate, dimension, printKind, applicationNumber);
end;

class (TGlobalBase) TBalanceGlobal()
    initTGlobalBase();

    /**
     * Текущий отчет.
     */
    private var m_rcbReport;

    private var m_previousReport;

    /**
     * Вывод периода отчета в строку статуса.
     */
    macro putPeriodToStatusString()
        if (RcbApplication.currentReport.context.period.endDate == RcbApplication.currentReport.context.period.beginDate)
            message("Расчет за " + strSubst(string(RcbApplication.currentReport.context.period.endDate : f), " ", "0"));
        else
            message("Расчет за " + strSubst(string(RcbApplication.currentReport.context.period.beginDate : f), " ", "0") + "-" + strSubst(string(RcbApplication.currentReport.context.period.endDate : f), " ", "0"));
        end;
    end;

    /**
     * Получить текущий отчет.
     */
    macro getRcbReport() : RcbReport
        return m_rcbReport;
    end;

    macro getPreviousReport() : RcbReport
        return m_previousReport;
    end;

    private macro constructor()
        initializeRepDataPackage(m_rcbReport);

        m_rcbReport      = RcbApplication().currentReport;
        m_previousReport = m_rcbReport.createPreviousReport();
    end;

    constructor();
end;

macro balanceGlobal()
    if (v_global == null)
        v_global = TBalanceGlobal();
    end;
    return v_global;
end;
