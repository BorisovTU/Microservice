/*
$Name:        balanceInterface.mac
$Module:      Регламентируемая отчетность
$Description: Форма Балансовые счета. Доступ к операциям формы
*/

/**
 * Форма Балансовый отчет. Доступ к операциям формы.
 *
 * @since   07.03.2013
 * @author  Gromov
 * @version 6.00.020.31
 */
import ReptCBInter;
import RcbCoreInter;

import rcbimport;
import testLib;

import balanceObjectFactory;
import balanceCalculateProtocolView;
import balanceCalculateController;
import balanceKlikoExportController;
import balanceKlikoImportController;
import balancePtkPsdImportController;
import balanceXmlExportController;
import applCalculation;
import balancePtkPsdExportController;
import balanceDataSource;
import appl7ReportView;
import appl8PrintController;
import appl8ReportView;
import appl13ReportView;
import balancePrintProtocolView;
import f101ReportView;
import balancePrintController;
import balanceReCalculation;
import balanceNormalizerParametersReader;
import balanceExcludeAcc;

macro checkInstruction579Date(isAfter : Bool, applName : String, protocolName : String, actionName : String) : Bool
    var isGoodPeriod;

    if (isAfter)
        isGoodPeriod = ternary(rcbApplication.currentReport.context.period.endDate >= RCB_I579_DATE, true, false);
    else
        isGoodPeriod = ternary(rcbApplication.currentReport.context.period.endDate < RCB_I579_DATE, true, false);
    end;

    if (isGoodPeriod)
        return true;
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView(applName, protocolName);
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine(applName + " можно " + actionName + " только за отчетный период, у которого дата окончания " + ternary(isAfter, "больше или равна ", "меньше ") + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);

        return false;
    end;
end;

/**
 *  Запуск операции расчета отчета
 */
macro executeCalculationOperation()
    const CHAPTER_LABEL = "-desc:";
    const MODE_LABEL    = "-mode:";

    var chapterLabelIndex = index(cmdArgs, CHAPTER_LABEL);
    var modeLabelIndex    = index(cmdArgs, MODE_LABEL);
    var isOnlyBalance     = ternary(substr(cmdArgs, modeLabelIndex + strlen(MODE_LABEL), strlen("isOnlyBalance")) == "isOnlyBalance", true, false);
    var m_protocolView    = objectFactoryInstance.createCalculateProtocolView();

    if (chapterLabelIndex == 0)
        return;
    end;

    var chapter = substr(cmdArgs, chapterLabelIndex + strlen(CHAPTER_LABEL), 1);

//    var profiler = TSQLProfiler(getTxtFileName("balanceSqlProfile"));
//    profiler.clear();
//    profiler.on();
    objectFactoryInstance.createReportCalculateController(chapter).calculate();

    m_protocolView.resetProtocolOutput();

    //если главы Баланса рассчитывается изолированно, показываем протокол
    if (isOnlyBalance)
        m_protocolView.show();
    end;
end;

/**
 *  Запуск операции печати отчета
 */
macro executePrintOperation()
    const CHAPTER_LABEL = "-ch:";
    const REPORT_LABEL  = "-report:";

    var reportLabelIndex  = index(cmdArgs, REPORT_LABEL);
    var chapterLabelIndex = index(cmdArgs, CHAPTER_LABEL);

    if ((chapterLabelIndex == 0) or (reportLabelIndex == 0))
        return;
    end;

    var report  = SubStr(CmdArgs, reportLabelIndex  + StrLen(REPORT_LABEL));
    var chapter = SubStr(cmdArgs, chapterLabelIndex + strlen(CHAPTER_LABEL), 1);

    var isCanPrint : Bool;

    if   (report == APPLICATION_5)
        isCanPrint = checkInstruction579Date(true, "Приложение 5", "Протокол печати Приложения 5", "напечатать");
    elif (report == APPLICATION_5_SPOD)
        isCanPrint = checkInstruction579Date(true, "Приложение 5 со СПОД", "Протокол печати Приложения 5 со СПОД", "напечатать");
    elif (report == APPLICATION_6)
        isCanPrint = checkInstruction579Date(true, "Приложение 6", "Протокол печати Приложения 6", "напечатать");
    elif (report == APPLICATION_11)
        isCanPrint = checkInstruction579Date(true, "Приложение 11", "Протокол печати Приложения 11", "напечатать");
    elif (report == APPLICATION_7)
        isCanPrint = checkInstruction579Date(false, "Приложение 7", "Протокол печати Приложения 7", "напечатать");
    elif (report == APPLICATION_7_SPOD)
        isCanPrint = checkInstruction579Date(false, "Приложение 7 со СПОД", "Протокол печати Приложения 7 со СПОД", "напечатать");
    elif (report == APPLICATION_8)
        isCanPrint = checkInstruction579Date(false, "Приложение 8", "Протокол печати Приложения 8", "напечатать");
    elif (report == APPLICATION_13)
        isCanPrint = checkInstruction579Date(false, "Приложение 13", "Протокол печати Приложения 13", "напечатать");
    else
        isCanPrint = true;
    end;

    if (isCanPrint)
        objectFactoryInstance.createReportPrintController(chapter, report).execute();
    end;
end;

/**
 *  Запуск операции печати приложения 8
 */
macro executePrintOperationAppl8()
    const CHAPTER_LABEL = "-ch:";

    var chapterLabelIndex = index(cmdArgs, CHAPTER_LABEL);

    if (chapterLabelIndex == 0)
        return;
    end;

    var chapter = SubStr(cmdArgs, chapterLabelIndex + strlen(CHAPTER_LABEL), 1);

    if (checkInstruction579Date(false, "Приложение 8", "Протокол печати Приложения 8", "напечатать"))
        objectFactoryInstance.createApplication8PrintController(chapter).execute();
    end;
end;

/**
 *  Запуск операции печати приложения 6
 */
macro executePrintOperationAppl6()
    const CHAPTER_LABEL = "-ch:";

    var chapterLabelIndex = index(cmdArgs, CHAPTER_LABEL);

    if (chapterLabelIndex == 0)
        return;
    end;

    var chapter = SubStr(cmdArgs, chapterLabelIndex + strlen(CHAPTER_LABEL), 1);

    if (checkInstruction579Date(true, "Приложение 6", "Протокол печати Приложения 6", "напечатать"))
        objectFactoryInstance.createApplication6PrintController(chapter).execute();
    end;
end;

/**
 *  Запуск операции экспорта в kliko.exe за день
 */
macro executeKlikoExportDayOperation()
    const DESCRIPTION_LABEL = "-desc:";

    /**
     * Позиция подстроки "-decs:" в строке
     */
    var descriptionLabelIndex: Integer = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    /**
     * Номер главы. 0 - все главы.
     */
    var chapter: String = subStr(cmdArgs, descriptionLabelIndex + strLen(DESCRIPTION_LABEL));

    objectFactoryInstance.createKlikoExportController(true, chapter).execute();
end;

/**
 *  Запуск операции экспорта в kliko.exe за месяц
 */
macro executeKlikoExportMonthOperation()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = SubStr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL));

    objectFactoryInstance.createKlikoExportController(false, chapter).execute();
end;

/**
 *  Запуск операции импорта из kliko.exe за день
 */
macro executeKlikoImportDayOperation()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = SubStr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL));

    objectFactoryInstance.createKlikoImportController(true, chapter).execute();
end;

/**
 *  Запуск операции импорта из kliko.exe за месяц
 */
macro executeKlikoImportMonthOperation()
    const DESCRIPTION_LABEL = "-desc:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);

    if (descriptionLabelIndex == 0)
        return;
    end;

    var chapter = SubStr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL));

    objectFactoryInstance.createKlikoImportController(false, chapter).execute();
end;

/**
 *  Запуск операции экспорта в ПТК ПСД
 */
macro executePtkPsdExportOperation()
    objectFactoryInstance.createPtkPsdExportController().execute();
end;

/**
 *  Запуск операции импорта из ПТК ПСД
 */
macro executePtkPsdImportOperation()
    objectFactoryInstance.createPtkPsdImportController().execute();
end;

/**
 * Операция экспорта в xml. "Экспорт в XML-формате"
 */
macro executeXmlExportMonthlyOperation()
    const DESCRIPTION_LABEL = "-desc:";
    var descriptionLabelIndex: Integer = index(cmdArgs, DESCRIPTION_LABEL);
    if (descriptionLabelIndex == 0)
        return;
    end;
    var chapter : Integer = subStr(cmdArgs, descriptionLabelIndex + strLen(DESCRIPTION_LABEL));

    objectFactoryInstance.createXmlExportController(chapter, RCB_XML_PK_MONTHLY).execute();
end;

/**
 * Операция экспорта в xml. "Экспорт в XML-формате еженедельно"
 */
macro executeXmlExportWeeklyOperation()
    const DESCRIPTION_LABEL = "-desc:";
    var descriptionLabelIndex: Integer = index(cmdArgs, DESCRIPTION_LABEL);
    if (descriptionLabelIndex == 0)
        return;
    end;
    var chapter : Integer = subStr(cmdArgs, descriptionLabelIndex + strLen(DESCRIPTION_LABEL));

    objectFactoryInstance.createXmlExportController(chapter, RCB_XML_PK_WEEKLY).execute();
end;

/**
 * Операция экспорта в xml. "Экспорт в XML-формате по треб."
 */
macro executeXmlExportNotRegularyOperation()
    const DESCRIPTION_LABEL = "-desc:";
    var descriptionLabelIndex: Integer = index(cmdArgs, DESCRIPTION_LABEL);
    if (descriptionLabelIndex == 0)
        return;
    end;
    var chapter : Integer = subStr(cmdArgs, descriptionLabelIndex + strLen(DESCRIPTION_LABEL));

    objectFactoryInstance.createXmlExportController(chapter, RCB_XML_PK_NOT_REGULARLY).execute();
end;

/**
 *  Расчет приложения 8
 */
macro executeAppl8CalculationOperation()
    const DESCRIPTION_LABEL = "-mode:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);
    var m_isOnlyAppl8         = ternary(substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL), strlen("isOnlyAppl8")) == "isOnlyAppl8", true, false);

    if (checkInstruction579Date(false, "Приложение 8", "Протокол расчета Приложения 8", "рассчитать"))
        objectFactoryInstance.createAppl8CalculationController(m_isOnlyAppl8).execute();
    end;
end;

/**
 *  Расчет приложения 6
 */
macro executeAppl6CalculationOperation()
    const DESCRIPTION_LABEL = "-mode:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);
    var m_isOnlyAppl6         = ternary(substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL), strlen("isOnlyAppl6")) == "isOnlyAppl6", true, false);

    if (checkInstruction579Date(true, "Приложение 6", "Протокол расчета Приложения 6", "рассчитать"))
        objectFactoryInstance.createAppl6CalculationController(m_isOnlyAppl6).execute();
    end;

end;

/**
 *  Расчет приложения 13
 */
macro executeAppl13CalculationOperation()
    const DESCRIPTION_LABEL = "-mode:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);
    var m_isOnlyAppl13        = ternary(substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL), strlen("isOnlyAppl11")) == "isOnlyAppl11", true, false);

    if (checkInstruction579Date(false, "Приложение 13", "Протокол расчета Приложения 13", "рассчитать"))
        objectFactoryInstance.createAppl13CalculationController(m_isOnlyAppl13).execute();
    end;
end;

/**
 *  Расчет приложения 11
 */
macro executeAppl11CalculationOperation()
    const DESCRIPTION_LABEL = "-mode:";

    var descriptionLabelIndex = index(cmdArgs, DESCRIPTION_LABEL);
    var m_isOnlyAppl11        = ternary(substr(cmdArgs, descriptionLabelIndex + strlen(DESCRIPTION_LABEL), strlen("isOnlyAppl11")) == "isOnlyAppl11", true, false);

    if (checkInstruction579Date(true, "Приложение 11", "Протокол расчета Приложения 11", "рассчитать"))
        objectFactoryInstance.createAppl11CalculationController(m_isOnlyAppl11).execute();
    end;
end;

/**
 *  Пересчет после свода
 */
macro executeReCalculationOperation()
    objectFactoryInstance.createReCalculationController().execute();
end;

/**
 *  Копирование настроек нормализатора из реестра в переменную формы
 */
macro executeNormalizerParametersCopyOperation()
    var object = objectFactoryInstance.createNormalizerParametersReader();
    object.clear();
    object.read();
    RcbApplication().transactionManager.commit();
end;

/**
 * Получить имя файла печатной формы прил.7
 */
macro getPrintableReportViewAppl7FileName()
    if (rcbApplication.currentReport.context.period.endDate < RCB_I579_DATE)
        return objectFactoryInstance.createApplication7ReportView(false, 0, false).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 7 только за отчетный период, у которого дата окончания меньше " + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Получить имя файла печатной формы прил.7 со СПОД
 */
macro getPrintableReportViewAppl7SpodFN()
    if (rcbApplication.currentReport.context.period.endDate < RCB_I579_DATE)
        return objectFactoryInstance.createApplication7ReportView(true, 0, false).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 7 со СПОД только за отчетный период, у которого дата окончания меньше " + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Получить имя файла печатной формы прил.8
 */
macro getPrintableReportViewAppl8FileName()
    if (rcbApplication.currentReport.context.period.endDate < RCB_I579_DATE)
        return objectFactoryInstance.createApplication8ReportView(0).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 8 только за отчетный период, у которого дата окончания меньше" + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Получить имя файла печатной формы прил.5
 */
macro getPrintableReportViewAppl5FileName()
    if (rcbApplication.currentReport.context.period.endDate >= RCB_I579_DATE)
        return objectFactoryInstance.createApplication5ReportView(false, 0, false).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 5 можно  только за отчетный период, у которого дата окончания больше или ровна " + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Получить имя файла печатной формы прил.5 со СПОД
 */
macro getPrintableReportViewAppl5SpodFN()
    if (rcbApplication.currentReport.context.period.endDate >= RCB_I579_DATE)
        return objectFactoryInstance.createApplication5ReportView(true, 0, false).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 5 со СПОД можно  только за отчетный период, у которого дата окончания больше или ровна " + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Получить имя файла печатной формы прил.6
 */
macro getPrintableReportViewAppl6FileName()
    if (rcbApplication.currentReport.context.period.endDate >= RCB_I579_DATE)
        return objectFactoryInstance.createApplication6ReportView(0).getFileName();
    else
        var m_protocolView = objectFactoryInstance.createCalculateProtocolView();
        m_protocolView.setProtocolOutput();
        m_protocolView.printHead();
        m_protocolView.printLine("Выгружать Приложение 6 только за отчетный период, у которого дата окончания больше или ровна" + RCB_I579_DATE);
        m_protocolView.resetProtocolOutput();
        m_protocolView.show();

        установитьФлагВозврата(STOP_PROC_FLG);
    end;
end;

/**
 * Создать протокол расчета
 */
macro createCalculateProtocol()
    var protocol = objectFactoryInstance.createCalculateProtocolView("Балансовые счета");

    protocol.setProtocolOutput(false);
    protocol.printHead();
    protocol.resetProtocolOutput();
end;

macro excludeAccounts()
    var balanceExcludeAcc = TBalanceExcludeAcc();

    begAction(2000, "Исключение счетов из отчетности");
    balanceExcludeAcc.reset();
    balanceExcludeAcc.exclude();
    endAction();
end;

macro resetExcludedAccounts()
    begAction(2000, "Отмена исключения счетов из отчетности");
    TBalanceExcludeAcc().reset();
    endAction();
end;

macro reportExcludedAccounts()
    var report = TProtocolView("ОТЧЕТ ОБ ИСКЛЮЧЕННЫХ СЧЕТАХ");

    report.setProtocolOutput();
    report.printHead();

    begAction(2000, "Построение отчета об исключенных счетах");
    TBalanceExcludeAcc().report();
    endAction();

    report.resetProtocolOutput();
    report.show();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
