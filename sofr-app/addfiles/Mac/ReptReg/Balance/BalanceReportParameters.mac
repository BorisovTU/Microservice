/*
$Name:          BalanceReportParameters.mac
$Module:        Регламентируемая отчетность
$Description:   Форма Балансовые счета. Параметры отчета
*/

/**
 * Module:  TBalanceParameters.mac
 * Author:  Ivkina
 * Modified: 11 февраля 2008 г. 10:18:46
 * Purpose: Declaration of the class TBalanceParameters
 *          Реализует порождающий паттерн "Одиночка" (см. Related Diagrams).
 * Comment: Параметры отчета.
 */
import ReportInter;
import repException;

import Reporting, ReportInter, FIInter, PTInter, CTInter,
       PaymInter, OprInter, CurrInter, BankInter;
import cb_sql, lib_str, lib_lang, lib_arr;
import acv;
import RsbObjFactory;

import param;
import balanceGlobal;

const CALC_WITH_MESSAGE    = 0;
const CALC_WITHOUT_MESSAGE = 1;
const CALC_BREAK           = 2;

const NODETYPE_FILIAL = 1, //Тип узла ТС - Филиал
      NODETYPE_BRANCH = 2; //Тип узла ТС - Подразделение

const ORGSTRUCTURE_TERRITORIAL = 1; //Территориальная структура

const MODE_BRANCH = 1; // Режим выпуска отчета - Подразделение

/**
 * Глобальная ссылка для хранения одиночки.
 */
private var m_parameters = null;
/**
 * Параметры отчета.
 */
class TBalanceParameters()
    /**
     * Код подразделения.
     */
    private var m_departmentCode : Integer;

    /**
     * Оргструктура.
     */
    private var m_orgStructure : Integer;

    /**
     * Режим выпуска.
     */
    private var m_issueMode : Integer;

    /**
     * Глава счетов.
     */
    private var m_chapter : Integer;

    /**
     * Номер плана счетов.
     */
    private var m_plan : Integer;

    /**
     * Валюта.
     */
    private var m_fiId : Integer;

    /**
     * Дата начала отчетного периода.
     */
    private var m_dateIn : Date;

    /**
     * Дата конца отчетного периода.
     */
    private var m_dateOut : Date;

    /**
     * Форма балансового отчета.
     */
    private var m_balanceForm : Integer;

    /**
     * Размерность денежных сумм.
     */
    private var m_moneyDimension : Integer;

    /**
     * Итоги по разделам?
     */
    private var m_isPrintIssueItog : Bool;

    /**
     * Учет покрытия?
     */
    private var m_isPrintCover : Bool;

    /**
     * Учет Спод?
     */
    private var m_isPrintSpod : Bool;

    /**
     * С апострофами?
     */
    private var m_isPrintApostrophe : Bool;

    /**
     * Печатать нулевые данные?
     */
    private var m_isPrintZeroData : Bool;

    /**
     * Исключить счета ОВП?
     */
    private var m_isExcludeOcp : Bool;

    /**
     * Печать отчета за каждый день периода?
     */
    private var m_isPrintEveryDay : Bool;

    private var m_departmentList : RepDepartmentList;

    private var m_periodKind : Integer;

    private var m_planNumber : Integer;

    private var m_ocpAccountServer : RepOcpAccountServer;

    private var m_isCur;

    /**
    * Состояние расчета
    *   0 - Выводить сообщение об ошибке
    *   1 - Не выводить сообщение об ошибке
    *   2 - Прервать расчет
    */
    private var m_calculationState;
    /**
     * печатать нули в отчете для главы Д формы 101?
     */
    private var m_isPrintZeroInChapter5 : Bool;

    /**
     * Размерность денежных сумм в форме 101
     */
    private var m_precisionChapter5 : Integer;

    private var m_printFormBalance;

    private var m_chaptersCount : integer;

    private macro constructor()

        m_departmentCode    = RcbApplication().currentReport.context.departmentCode;
        m_orgStructure      = RcbApplication().currentReport.context.organizationStructure;
        m_issueMode         = RcbApplication().currentReport.context.issueMode;
        m_plan              = RcbApplication().parameters.balancePlanNumber;
        m_fiId              = 0;
        m_periodKind        = 0;
        m_dateIn            = balanceGlobal().getRcbReport().context.period.beginDate;
        m_dateOut           = balanceGlobal().getRcbReport().context.period.endDate;
        m_planNumber        = RcbApplication().parameters.balancePlanNumber;
        m_moneyDimension    = 0;
        m_isPrintIssueItog  = 0;
        m_isPrintCover      = 0;
        m_isPrintSpod       = 0;
        m_isPrintApostrophe = 0;
        m_isPrintZeroData   = 0;
        m_isExcludeOcp      = 0;
        m_isPrintEveryDay   = 0;
        m_isCur             = 0;
        m_calculationState  = CALC_WITH_MESSAGE;

        if (m_dateOut >= RCB_I4212_DATE)
            m_chaptersCount = 4;
        else
            m_chaptersCount = 5;
        end;

        m_departmentList   = RepDepartmentList(RcbApplication().currentReport.context.organizationStructure, RcbApplication().currentReport.context.issueMode, RcbApplication().currentReport.context.departmentCode);
        GetRegistryValue("REPTREG\\REP_GROUPS\\BALANCE_ACCOUNTS\\ПЕЧАТЬ НУЛЕЙ ПО ГЛАВЕ Д", V_BOOL, m_isPrintZeroInChapter5, NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\BALANCE_ACCOUNTS\\ТОЧНОСТЬ ДЛЯ ГЛАВЫ Д", V_INTEGER, m_precisionChapter5, NULL);
        GetRegistryValue("REPTREG\\REP_GROUPS\\BALANCE_ACCOUNTS\\ПЕЧАТЬ ФОРМЫ БАЛАНСОВЫЕ СЧЕТА", V_INTEGER, m_printFormBalance, NULL);
    end;

    macro getDepartmentCode() : Integer
        return m_departmentCode;
    end;

    macro getOrgStructure() : Integer
        return m_orgStructure;
    end;

    macro getIssueMode() : Integer
        return m_issueMode;
    end;

    macro getChapter() : Integer
        return m_chapter;
    end;

    macro getPlanNumber() : Integer
        return m_plan;
    end;

    macro getFiId() : Integer
        return m_fiId;
    end;

    macro getDateIn() : Date
        return m_dateIn;
    end;

    macro getDateOut() : Date
        return m_dateOut;
    end;

    macro getMoneyDimension() : Integer
        return m_moneyDimension;
    end;

    macro getIsPrintIssueItog() : Bool
        return m_isPrintIssueItog;
    end;


    macro getIsPrintApostrophe() : Bool
        return m_isPrintApostrophe;
    end;

    macro getIsPrintZeroData() : Bool
        return m_isPrintZeroData;
    end;

    macro getIsExcludeOcp() : Bool
        return m_isExcludeOcp;
    end;

    macro getIsPrintEveryDay() : Bool
        return m_isPrintEveryDay;
    end;

    macro getDepartmentList() : RepDepartmentList
        return m_departmentList;
    end;

    macro getPeriodKind() : Integer
        return m_periodKind;
    end;

    macro getOcpAccountServer() : RepOcpAccountServer
        return m_ocpAccountServer;
    end;

    macro getIsCur()
        return m_isCur;
    end;

    /**
     * @param     newM_dateIn
     */
    macro setDateIn(newM_dateIn : Date)
        m_dateIn = newM_dateIn;
    end;

    /**
     * @param     newM_dateOut
     */
    macro setDateOut(newM_dateOut : Date)
        m_dateOut = newM_dateOut;
    end;

    macro getCalculationState()
        return m_calculationState;
    end;

    macro setCalculationState(value)
        m_calculationState = nvl(value);
    end;

    macro getIsPrintZeroInChapter5() : Bool
        return m_isPrintZeroInChapter5;
    end;

    macro getPrecisionChapter5() : Integer
        return m_precisionChapter5;
    end;

    macro getPrintFormBalance()
        return m_printFormBalance;
    end;

    macro getNodeType()
        var queryString = "SELECT t_nodeType "
                 + "\n" + "  FROM " + ternary(m_orgStructure == ORGSTRUCTURE_TERRITORIAL, "dRepDpDep_vw", "dRepDpReg_vw")
                 + "\n" + " WHERE t_nodeId = " + m_departmentCode;

        var ds = TRsbDataSet(queryString);

        if (ds.moveNext())
            return ds.nodeType;
        end;

        return NULL;
    end;

    macro getChaptersCountForF101()
        return m_chaptersCount;
    end;

    macro getChaptersCountForCalculate()
        if (m_dateOut >= RCB_I579_DATE)
            return 4;
        else
        return 5;
    end;
    end;

    constructor();
end;

/**
 * Точка доступа.
 */
macro balanceParameters() : TBalanceParameters
    if (m_parameters == null)
        m_parameters = TBalanceParameters();
    end;
    return m_parameters;
end;
