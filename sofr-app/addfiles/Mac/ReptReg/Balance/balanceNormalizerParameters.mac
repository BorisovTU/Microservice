/*
$Name:          balanceNormalizerParameters.mac
$Module:        ê•£´†¨•≠‚®‡„•¨†Ô Æ‚Á•‚≠Æ·‚Ï
$Description:   îÆ‡¨† Å†´†≠·Æ¢Î• ·Á•‚†. è†‡†¨•‚‡Î ≠Æ‡¨†´®ß†‚Æ‡†
*/

import RcbClassLibInter;
import RcbCoreInter;
import balanceNormalizerParametersReader;
import balanceObjectFactory;
import lib_lang;

private class TNormalizerParametersReportData(_key, _value)
    var key = _key;
    var value = _value;
end;

class TNormalizerParametersBase(parametersAttributeName)
    private var m_parametersReader : Object;
    private var m_parametersAttributeName;
    private var m_parametersReportData : RcbArray;
    private var m_chapter5Precision;
    private var m_isEnableControlRoundingError;
    private var m_shouldShowProtocol;

    private macro getVariableValue(path : String, type : INTEGER, value : Variant)
        var splittedPath = strCut(path, "/\\");
        var result = V_UNDEF;
        var parametersCompositeValue = RcbApplication().currentReport.attributeValue(m_parametersAttributeName);

        if (parametersCompositeValue == null)
            return V_UNDEF;
        end;

        var isFound = false;
        var splittedPathSize = splittedPath.size;
        var i = 0;
        while (i < splittedPathSize)
            var key = parametersCompositeValue.createKeyValue();
            key.fieldValue("name") = splittedPath.value(i);
            var temp = parametersCompositeValue.findValue(key);
            if (temp != null)
                parametersCompositeValue = temp;
                if (i == splittedPathSize-1)
                    isFound = true;
                end;
            end;

            i = i + 1;
        end;

        if (    isFound
            and (parametersCompositeValue != null)
            and (parametersCompositeValue.fieldValue("type").isDefined())
            and (parametersCompositeValue.fieldValue("value").isDefined())
           )
            value = m_parametersReader.fromString(parametersCompositeValue.fieldValue("value").exact, type);
            if (m_parametersReader.isTypesMatch(type, strupr(trim(parametersCompositeValue.fieldValue("type").exact))))
                result = type;
            end;

            setParm(3, value);
        end;

        return result;
    end;

    private macro getValue(path : String, type : INTEGER, value : Variant, defaultValue : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        else
            if (getVariableValue(path, type, value) == V_UNDEF)
                value = defaultValue;
                note = " (ØÆ „¨Æ´Á†≠®Ó)";
            end;
        end;
        setParm(3, value);

        if (((type == V_STRING) and (value == "")) or (value == null))
            value = "á≠†Á•≠®• ≠• ß†§†≠Æ";
        end;
        m_parametersReportData.push_back(TNormalizerParametersReportData(path, String(value) + note));
    end;

    private macro _getRegistryValue(path : String, type : INTEGER, value : Variant, defaultValue : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        else
            if (getRegistryValue(path, type, value) == V_UNDEF)
                value = defaultValue;
                note = " (ØÆ „¨Æ´Á†≠®Ó)";
            end;
        end;
        setParm(3, value);

        if (((type == V_STRING) and (value == "")) or (value == null))
            value = "á≠†Á•≠®• ≠• ß†§†≠Æ";
        end;
        m_parametersReportData.push_back(TNormalizerParametersReportData(path, String(value) + note));
    end;

    private macro initializeParameterValue(caption : String, parameter : Variant, value : Variant, forceValue : Variant)
        var note : String = "";

        if (forceValue != null)
            value = forceValue;
            note = " (‰Æ‡·®‡Æ¢†≠Æ ®ß Ø‡Æ£‡†¨≠Æ£Æ ™Æ§†)";
        end;
        setParm(2, value);

        m_parametersReportData.push_back(TNormalizerParametersReportData(caption, String(value) + note));
    end;

    private macro getReportString(key, caption)
        m_parametersReportData.moveFirst();
        while (m_parametersReportData.moveNext())
            var reportData = m_parametersReportData.getCurrentItem();
            if (reportData.key == key)
                if (caption == null)
                    return reportData.key + " = " + reportData.value;
                else
                    return caption + " = " + reportData.value;
                end;
            end;
        end;
        return null;
    end;

    private macro makeTabbedString(value, nTabs)
        nTabs = nvl(nTabs, 1);
        if (value != null)
            value = mkstr("\t", nTabs) + value;
        end;

        return value;
    end;

    private macro printLine(protocol, value, caption)
        if (value != null)
            protocol.printLine(ternary(caption == null, value, caption + " = " + value));
        end;
    end;

    macro getChapter5Precision()
        return m_chapter5Precision;
    end;

    macro isEnableControlRoundingError()
        return m_isEnableControlRoundingError
    end;

    macro shouldShowProtocol()
        return m_shouldShowProtocol;
    end;

    private macro constructorTNormalizerParametersBase(parametersAttributeName)
        m_parametersReader = objectFactoryInstance.createNormalizerParametersReader();
        m_parametersReportData = RcbArray();

        m_parametersAttributeName = parametersAttributeName;
        if (m_parametersAttributeName == null)
            if (balanceGlobal().getRcbReport().normalizationAlgorithm == RCB_NA_SM)
                m_parametersAttributeName = "çÄëíêéâäà_çéêåÄãàáÄíéêÄ_ëå";
            elif (balanceGlobal().getRcbReport().normalizationAlgorithm == RCB_NA_MMB)
                m_parametersAttributeName = "çÄëíêéâäà_çéêåÄãàáÄíéêÄ_ååÅ";
            end;
        end;
        m_parametersReader.read();

        getValue("REPORT/FLOOR/çÄëíêéâäÄ ååÅ/Çäãûóàíú äéçíêéãú èéÉêÖòçéëíà", V_BOOL, m_isEnableControlRoundingError, true);
//        getValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/íéóçéëíú Ñãü ÉãÄÇõ Ñ", V_INTEGER, m_chapter5Precision, 0);
        _getRegistryValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/èÖóÄíú èêéíéäéãÄ çéêåÄãàáÄñàà", V_BOOL, m_shouldShowProtocol, true);
        _getRegistryValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/íéóçéëíú Ñãü ÉãÄÇõ Ñ", V_INTEGER, m_chapter5Precision, 0);
    end;

    constructorTNormalizerParametersBase(parametersAttributeName);
end;
