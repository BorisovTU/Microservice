/*
$Name:          balanceNormalizerSm.mac
$Module:        ê•£´†¨•≠‚®‡„•¨†Ô Æ‚Á•‚≠Æ·‚Ï
$Description:   îÆ‡¨† Å†´†≠·Æ¢Î• ·Á•‚†. çÆ‡¨†´®ß†‚Æ‡ "Ç ‚Î·ÔÁ†Â ëå"
*/

import DatesUtility;
import BalanceGlobal;
import BalanceAttribute;
import rcw;

private class (TProtocolView) TProtocol(description : String)
    macro constructor(description)
        initTProtocolView(description);
        setProtocolOutput(false);
        resetProtocolOutput();
        setOnFlySwitching(true);
    end;

    constructor(description);
end;

private var m_parameters = null;
class (TNormalizerParametersBase) TParametersImpl()
    private var m_isExcludeAccountsSm;
    private var m_isExcludeAccountsForChapterSm;
    private var m_excludedAccountsRoubleSm;
    private var m_excludedAccountsForeignSm;
    private var m_excludedAccountsTotalSm;

    private var m_hasImportantAccountsSm;
    private var m_hasImportantAccountsForChapterSm;
    private var m_importantAccountsRoubleSm;
    private var m_importantAccountsForeignSm;
    private var m_importantAccountsTotalSm;

    private var m_hasTrashAccountsSm;
    private var m_hasTrashAccountsForChapterSm;
    private var m_trashAccountsRoubleSm;
    private var m_trashAccountsForeignSm;
    private var m_trashAccountsTotalSm;

    private var m_isEnabledExpertParametersSm;
    private var m_isEnabledExpertParametersForChapterSm;
    private var m_maximumErrorSm;
    private var m_normalDefSm;
    private var m_restPrioritySm;
    private var m_turnsPrioritySm;
    private var m_currencyPrioritySm;
    private var m_roublePrioritySm;
    private var m_totalPrioritySm;
    private var m_importantPrioritySm;
    private var m_trashPrioritySm;
    private var m_zeroPrioritySm;
    private var m_accuratePrioritySm;
    private var m_isCorAccControlDisabledSm;

    private var m_useDailyBalanceRests;
    private var m_isCalendarWeekends;

    macro isExcludeAccountsSm()
        return m_isExcludeAccountsSm;
    end;

    macro isExcludeAccountsForChapterSm(chapter)
        return m_isExcludeAccountsForChapterSm[chapter];
    end;

    macro getExcludedAccountsRoubleSm(chapter)
        return m_excludedAccountsRoubleSm[chapter];
    end;

    macro getExcludedAccountsForeignSm(chapter)
        return m_excludedAccountsForeignSm[chapter];
    end;

    macro getExcludedAccountsTotalSm(chapter)
        return m_excludedAccountsTotalSm[chapter];
    end;

    macro hasImportantAccountsSm();
        return m_hasImportantAccountsSm;
    end;

    macro hasImportantAccountsForChapterSm(chapter);
        return m_hasImportantAccountsForChapterSm[chapter];
    end;

    macro getImportantAccountsRoubleSm(chapter);
        return m_importantAccountsRoubleSm[chapter];
    end;

    macro getImportantAccountsForeignSm(chapter);
        return m_importantAccountsForeignSm[chapter];
    end;

    macro getImportantAccountsTotalSm(chapter);
        return m_importantAccountsTotalSm[chapter];
    end;

    macro hasTrashAccountsSm();
        return m_hasTrashAccountsSm;
    end;

    macro hasTrashAccountsForChapterSm(chapter);
        return m_hasTrashAccountsForChapterSm[chapter];
    end;

    macro getTrashAccountsRoubleSm(chapter);
        return m_trashAccountsRoubleSm[chapter];
    end;

    macro getTrashAccountsForeignSm(chapter);
        return m_trashAccountsForeignSm[chapter];
    end;

    macro getTrashAccountsTotalSm(chapter);
        return m_trashAccountsTotalSm[chapter];
    end;

    macro isEnabledExpertParametersSm();
        return m_isEnabledExpertParametersSm;
    end;

    macro isEnabledExpertParametersForChapterSm(chapter);
        return m_isEnabledExpertParametersForChapterSm[chapter];
    end;

    macro getMaximumErrorSm(chapter);
        return m_maximumErrorSm[chapter];
    end;

    macro getNormalDefSm(chapter);
        return m_normalDefSm[chapter];
    end;

    macro getRestPrioritySm(chapter);
        return m_restPrioritySm[chapter];
    end;

    macro getTurnsPrioritySm(chapter);
        return m_turnsPrioritySm[chapter];
    end;

    macro getCurrencyPrioritySm(chapter);
        return m_currencyPrioritySm[chapter];
    end;

    macro getRoublePrioritySm(chapter);
        return m_roublePrioritySm[chapter];
    end;

    macro getTotalPrioritySm(chapter);
        return m_totalPrioritySm[chapter];
    end;

    macro getImportantPrioritySm(chapter);
        return m_importantPrioritySm[chapter];
    end;

    macro getTrashPrioritySm(chapter);
        return m_trashPrioritySm[chapter];
    end;

    macro getZeroPrioritySm(chapter);
        return m_zeroPrioritySm[chapter];
    end;

    macro getAccuratePrioritySm(chapter);
        return m_accuratePrioritySm[chapter];
    end;

    macro isCorAccControlDisabledSm(chapter)
        if  (chapter == 1)
            return m_isCorAccControlDisabledSm[chapter];
        end;

        return null;
    end;

    macro useDailyBalanceRests()
        return m_useDailyBalanceRests;
    end;

    macro isCalendarWeekends() : Bool
        return m_isCalendarWeekends;
    end;

    macro printReport(protocol)
        printLine(protocol, "ç†·‚‡Æ©™® ‡••·‚‡†:");
        printLine(protocol, makeTabbedString(getReportString("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/ìóàíõÇÄíú àëïéÑüôàÖ")));
        printLine(protocol, makeTabbedString(getReportString("REPTREG/REP_GROUPS/îéê/ÇõïéÑç. à êÄÅ. Ñçà èé äÄãÖçÑÄêû")));
    end;

    private macro constructorTParametersImpl()
        initTNormalizerParametersBase("çÄëíêéâäà_çéêåÄãàáÄíéêÄ_ëå");

        var path : String = "";
        var rootPath : String = "";

        m_isExcludeAccountsForChapterSm = RcbArray();
        m_excludedAccountsRoubleSm = RcbArray();
        m_excludedAccountsForeignSm = RcbArray();
        m_excludedAccountsTotalSm = RcbArray();
        m_hasImportantAccountsForChapterSm = RcbArray();
        m_importantAccountsRoubleSm = RcbArray();
        m_importantAccountsForeignSm = RcbArray();
        m_importantAccountsTotalSm = RcbArray();
        m_hasTrashAccountsForChapterSm = RcbArray();
        m_trashAccountsRoubleSm = RcbArray();
        m_trashAccountsForeignSm = RcbArray();
        m_trashAccountsTotalSm = RcbArray();
        m_isEnabledExpertParametersForChapterSm = RcbArray();
        m_maximumErrorSm = RcbArray();
        m_normalDefSm = RcbArray();
        m_restPrioritySm = RcbArray();
        m_turnsPrioritySm = RcbArray();
        m_currencyPrioritySm = RcbArray();
        m_roublePrioritySm = RcbArray();
        m_totalPrioritySm = RcbArray();
        m_importantPrioritySm = RcbArray();
        m_trashPrioritySm = RcbArray();
        m_zeroPrioritySm = RcbArray();
        m_accuratePrioritySm = RcbArray();
        m_isCorAccControlDisabledSm = RcbArray();

        var i;

        rootPath = path = "REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/àëäãûóÄÖåõÖ ëóÖíÄ";
        getValue(path, V_BOOL, m_isExcludeAccountsSm, true);
        if (m_isExcludeAccountsSm)
            i = 1;
            while (i <= 4)
                path = rootPath + "/ÉãÄÇÄ " + i;
                getValue(path, V_BOOL, m_isExcludeAccountsForChapterSm[i], (i==1));
                if (m_isExcludeAccountsForChapterSm[i])
                    getValue(path + "/êìÅãà", V_STRING, m_excludedAccountsRoubleSm[i], ternary(i==1, "20202,30102,30109,30110,30111,30114", ""));
                    getValue(path + "/ÇÄãûíÄ", V_STRING, m_excludedAccountsForeignSm[i], "");
                    getValue(path + "/àíéÉ", V_STRING, m_excludedAccountsTotalSm[i], "");
                    if ((m_excludedAccountsRoubleSm[i] == "") and (m_excludedAccountsForeignSm[i] == "") and (m_excludedAccountsTotalSm[i] == ""))
                        m_isExcludeAccountsForChapterSm[i] = false;
                    end;
                end;
                i = i +1;
            end;
        end;

        rootPath = path = "REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/ÇÄÜçõÖ ëóÖíÄ";
        getValue(path, V_BOOL, m_hasImportantAccountsSm, false);
        if (m_hasImportantAccountsSm)
            i = 1;
            while (i <= 4)
                path = rootPath + "/ÉãÄÇÄ " + i;
                getValue(path, V_BOOL, m_hasImportantAccountsForChapterSm[i], false);
                if (m_hasImportantAccountsForChapterSm[i])
                    getValue(path + "/êìÅãà", V_STRING, m_importantAccountsRoubleSm[i], "");
                    getValue(path + "/ÇÄãûíÄ", V_STRING, m_importantAccountsForeignSm[i], "");
                    getValue(path + "/àíéÉ", V_STRING, m_importantAccountsTotalSm[i], "");
                    if ((m_importantAccountsRoubleSm[i] == "") and (m_importantAccountsForeignSm[i] == "") and (m_importantAccountsTotalSm[i] == ""))
                        m_hasImportantAccountsForChapterSm[i] = false;
                    end;
                end;
                i = i +1;
            end;
        end;

        rootPath = path = "REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/çÖÇÄÜçõÖ ëóÖíÄ";
        getValue(path, V_BOOL, m_hasTrashAccountsSm, false);
        if (m_hasTrashAccountsSm)
            i = 1;
            while (i <= 4)
                path = rootPath + "/ÉãÄÇÄ " + i;
                getValue(path, V_BOOL, m_hasTrashAccountsForChapterSm[i], false);
                if (m_hasTrashAccountsForChapterSm[i])
                    getValue(path + "/êìÅãà", V_STRING, m_trashAccountsRoubleSm[i], "");
                    getValue(path + "/ÇÄãûíÄ", V_STRING, m_trashAccountsForeignSm[i], "");
                    getValue(path + "/àíéÉ", V_STRING, m_trashAccountsTotalSm[i], "");
                    if ((m_trashAccountsRoubleSm[i] == "") and (m_trashAccountsForeignSm[i] == "") and (m_trashAccountsTotalSm[i] == ""))
                        m_hasTrashAccountsForChapterSm[i] = false;
                    end;
                end;
                i = i +1;
            end;
        end;

        rootPath = path = "REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/ùäëèÖêíçõÖ çÄëíêéâäà";
        getValue(path, V_BOOL, m_isEnabledExpertParametersSm, true);
        if (m_isEnabledExpertParametersSm)
            i = 1;
            while (i <= 4)
                path = rootPath + "/ÉãÄÇÄ " + i;
                getValue(path, V_BOOL, m_isEnabledExpertParametersForChapterSm[i], true);
                if (m_isEnabledExpertParametersForChapterSm[i])
                    getValue(path + "/åÄäëàåÄãúçÄü èéÉêÖòçéëíú", V_DOUBLE, m_maximumErrorSm[i]);
                    getValue(path + "/èéÉêÖòçéëíú éäêìÉãÖçàü", V_DOUBLE, m_normalDefSm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü éëíÄíäéÇ", V_INTEGER, m_restPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü éÅéêéíéÇ", V_INTEGER, m_turnsPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü ÇÄãûíõ", V_INTEGER, m_currencyPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü êìÅãÖâ", V_INTEGER, m_roublePrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü àíéÉéÇ", V_INTEGER, m_totalPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü ÇÄÜçõï ëóÖíéÇ", V_INTEGER, m_importantPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü çÖÇÄÜçõï ëóÖíéÇ", V_INTEGER, m_trashPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü çìãÖÇõï éÅéêéíéÇ", V_INTEGER, m_zeroPrioritySm[i]);
                    getValue(path + "/èêàéêàíÖí Ñãü íéóçé éäêìÉãççõï éÅéêéíéÇ", V_INTEGER, m_accuratePrioritySm[i]);
                    getValue(path + "/éíäãûóàíú äéçíêéãú 303 ëóÖíéÇ", V_BOOL, m_isCorAccControlDisabledSm[i]);
                end;
                i = i +1;
            end;
        end;

        getValue("REPTREG/REP_GROUPS/BALANCE_ACCOUNTS/çéêåÄãàáÄíéê ëå/ìóàíõÇÄíú àëïéÑüôàÖ", V_BOOL, m_useDailyBalanceRests, false);
        _getRegistryValue("REPTREG/REP_GROUPS/îéê/ÇõïéÑç. à êÄÅ. Ñçà èé äÄãÖçÑÄêû", V_BOOL, m_isCalendarWeekends, true);
    end;

    constructorTParametersImpl();
end;

private macro TParameters(forceNewInstance : bool)
    if (forceNewInstance)
        m_parameters = null;
    end;

    if (m_parameters == null)
        m_parameters = TParametersImpl();
    end;

    return m_parameters;
end;

class TBalanceData(_balance, _type, _inRestNatCur, _inRestCur, _inRest, _debetNatCur, _debetCur, _debet, _creditNatCur, _creditCur, _credit, _outRestNatCur, _outRestCur, _outRest)
    var balance =       _balance;
    var type =          _type;
    var inRestNatCur =  _inRestNatCur;
    var inRestCur =     _inRestCur;
    var inRest =        _inRest;
    var debetNatCur =   _debetNatCur;
    var debetCur =      _debetCur;
    var debet =         _debet;
    var creditNatCur =  _creditNatCur;
    var creditCur =     _creditCur;
    var credit =        _credit;
    var outRestNatCur = _outRestNatCur;
    var outRestCur =    _outRestCur;
    var outRest =       _outRest;
end;

private class TChapterNormalizer(chapter)
    private var m_chapter;

    private var m_balanceAttribute;
    private var m_isPreviousDataExists;
    private var m_previousBalanceAttribute;
    private var m_isDailyDataExists;
    private var m_dailyBalanceAttribute;
    private var m_operationProtocol;
    private var m_dailyReport;

    macro isWorkDate(day : Date) : Bool
        var res = false;

        if (TParameters().isCalendarWeekends())
            res = isWorkDayBranch(day, balanceGlobal().getRcbReport().context.departmentCode) == 1;
        else
            var serviceKind;
            var isBalance = false;
            getDateAttr(day, serviceKind, isBalance, balanceGlobal().getRcbReport().context.departmentCode);
            res = isBalance;
        end;

        return res;
    end;

    private macro createDailyBalanceAttribute()
        macro checkAndSet(dimension, reportDate, currentReportContext)
            var context = RcbReportContext(RcbPeriod(reportDate, reportDate),
                                           currentReportContext.departmentCode,
                                           currentReportContext.issueMode,
                                           currentReportContext.organizationStructure,
                                           currentReportContext.isSummaryMode
                                          );
            m_dailyReport = RcbApplication().objectFactory.createReport("Å†´†≠·Æ¢Î• ·Á•‚†", context);
            m_dailyBalanceAttribute = TBalanceAttribute("ÅÄãÄçë", m_dailyReport, TBalanceAttributeMode().READ_ONLY);
            if (m_dailyBalanceAttribute.isBalanceCalculated(m_chapter, dimension))
                m_isDailyDataExists = true;
            else
                m_isDailyDataExists = false;
            end;
        end;

        var currentReport = balanceGlobal().getRcbReport();
        var currentReportContext = balanceGlobal().getRcbReport().context;
        if (not TParameters().useDailyBalanceRests() or (currentReportContext.period.beginDate == currentReportContext.period.endDate))
            m_isDailyDataExists = false;
            return;
        end;
        checkAndSet(currentReport.dimension, currentReportContext.period.endDate, currentReportContext);
        if (not m_isDailyDataExists)
            var reportDate = TDatesUtility().getNearPreviosWorkDay(currentReportContext.period.endDate, true, r2m(this, "isWorkDate"));
            checkAndSet(currentReport.dimension, reportDate, currentReportContext);
        end;
    end;

    private macro getBalanceType(type)
        const TYPE_PASSIVE = 2;
        const TYPE_ACTIVE = 0;
        if (type == "è")
            type = TYPE_PASSIVE;
        else
            type = TYPE_ACTIVE;
        end;
        return type;
    end;

    private macro push_back(collection, kind, name, value)
        if (value != null)
            collection[collection.size] = arrCreate(kind, name, value);
        end;

        return collection;
    end;

    private macro readSettings()
        var settings = TArray();

        if (TParameters().isExcludeAccountsSm() and TParameters().isExcludeAccountsForChapterSm(m_chapter))
            push_back(settings, "exclude", "Rouble", TParameters().getExcludedAccountsRoubleSm(m_chapter));
            push_back(settings, "exclude", "Currency", TParameters().getExcludedAccountsForeignSm(m_chapter));
            push_back(settings, "exclude", "Total", TParameters().getExcludedAccountsTotalSm(m_chapter));
        end;

        if (TParameters().hasImportantAccountsSm() and TParameters().hasImportantAccountsForChapterSm(m_chapter))
            push_back(settings, "important", "Rouble", TParameters().getImportantAccountsRoubleSm(m_chapter));
            push_back(settings, "important", "Currency", TParameters().getImportantAccountsForeignSm(m_chapter));
            push_back(settings, "important", "Total", TParameters().getImportantAccountsTotalSm(m_chapter));
        end;

        if (TParameters().hasTrashAccountsSm() and TParameters().hasTrashAccountsForChapterSm(m_chapter))
            push_back(settings, "trash", "Rouble", TParameters().getTrashAccountsRoubleSm(m_chapter));
            push_back(settings, "trash", "Currency", TParameters().getTrashAccountsForeignSm(m_chapter));
            push_back(settings, "trash", "Total", TParameters().getTrashAccountsTotalSm(m_chapter));
        end;

        if (TParameters().isEnabledExpertParametersSm() and TParameters().isEnabledExpertParametersForChapterSm(m_chapter))
            push_back(settings, "expert", "MaxDef", TParameters().getMaximumErrorSm(m_chapter));
            push_back(settings, "expert", "NormalDef", TParameters().getNormalDefSm(m_chapter));
            push_back(settings, "expert", "RestPriority", TParameters().getRestPrioritySm(m_chapter));
            push_back(settings, "expert", "TurnsPriority", TParameters().getTurnsPrioritySm(m_chapter));
            push_back(settings, "expert", "CurrencyPriority", TParameters().getCurrencyPrioritySm(m_chapter));
            push_back(settings, "expert", "RoublePriority", TParameters().getRoublePrioritySm(m_chapter));
            push_back(settings, "expert", "TotalPriority", TParameters().getTotalPrioritySm(m_chapter));
            push_back(settings, "expert", "ImportantPriority", TParameters().getImportantPrioritySm(m_chapter));
            push_back(settings, "expert", "TrashPriority", TParameters().getTrashPrioritySm(m_chapter));
            push_back(settings, "expert", "ZeroPriority", TParameters().getZeroPrioritySm(m_chapter));
            push_back(settings, "expert", "AccuratePriority", TParameters().getAccuratePrioritySm(m_chapter));
            push_back(settings, "expert", "CorAccControlDisabled", TParameters().isCorAccControlDisabledSm(m_chapter));
        end;

        return settings;
    end;

    private macro readPrevBalanceData()
        var data = TArray();

        if (m_isPreviousDataExists)
            m_previousBalanceAttribute.createBalanceIterator(m_chapter, KIND_ALL, false, true, false);
            while (m_previousBalanceAttribute.next())
                if (index(m_previousBalanceAttribute.getBalance(), "Chapter") == 0)
                    if (not (    m_previousBalanceAttribute.getOutRestNatCur().isDefined()
                             and m_previousBalanceAttribute.getOutRestCur().isDefined()
                             and m_previousBalanceAttribute.getOutRest().isDefined()
                            )
                       )
                        continue;
                    end;
                    data[data.size] = arrCreate(m_previousBalanceAttribute.getBalance(),
                                                getBalanceType(m_previousBalanceAttribute.getKindBalance()),
                                                m_previousBalanceAttribute.getOutRestNatCur().scaled,
                                                m_previousBalanceAttribute.getOutRestCur().scaled,
                                                m_previousBalanceAttribute.getOutRest().scaled
                                               );
                end;
            end;
        end;

        return data;
    end;

    private macro readBalanceData()
        var data = TArray();

        m_balanceAttribute.createBalanceIterator(m_chapter, KIND_ALL, false, true, false);
        while (m_balanceAttribute.next())
            if (index(m_balanceAttribute.getBalance(), "Chapter") == 0)
                data[data.size] = arrCreate(m_balanceAttribute.getBalance(),
                                            getBalanceType(m_balanceAttribute.getKindBalance()),
                                            m_balanceAttribute.getInRestNatCur().exact,
                                            m_balanceAttribute.getInRestCur().exact,
                                            m_balanceAttribute.getInRest().exact,
                                            m_balanceAttribute.getDebetNatCur().exact,
                                            m_balanceAttribute.getDebetCur().exact,
                                            m_balanceAttribute.getDebet().exact,
                                            m_balanceAttribute.getCreditNatCur().exact,
                                            m_balanceAttribute.getCreditCur().exact,
                                            m_balanceAttribute.getCredit().exact,
                                            m_balanceAttribute.getOutRestNatCur().exact,
                                            m_balanceAttribute.getOutRestCur().exact,
                                            m_balanceAttribute.getOutRest().exact
                                           );
            end;
        end;

        return data;
    end;

    private macro readDailyBalanceData()
        var data = TArray();

        if (m_isDailyDataExists)
            m_dailyBalanceAttribute.createBalanceIterator(m_chapter, KIND_ALL, false, true, false);
            while (m_dailyBalanceAttribute.next())
                if (index(m_dailyBalanceAttribute.getBalance(), "Chapter") == 0)
                    if (not (    m_dailyBalanceAttribute.getOutRestNatCur().isDefined()
                             and m_dailyBalanceAttribute.getOutRestCur().isDefined()
                             and m_dailyBalanceAttribute.getOutRest().isDefined()
                            )
                       )
                        continue;
                    end;
                    data[data.size] = arrCreate(m_dailyBalanceAttribute.getBalance(),
                                                getBalanceType(m_dailyBalanceAttribute.getKindBalance()),
                                                m_dailyBalanceAttribute.getOutRestNatCur().scaled,
                                                m_dailyBalanceAttribute.getOutRestCur().scaled,
                                                m_dailyBalanceAttribute.getOutRest().scaled
                                               );
                end;
            end;
        end;

        return data;
    end;

    private macro readLoroAccounts()
        var data = TArray();

        var active = "";
        var passive = "";

        if (m_chapter == 3)
            active = "99998";
            passive = "99999";
        elif (m_chapter == 4)
            active = "99996";
            passive = "99997";
        else
            active = "";
            passive = "";
        end;

        data[data.size] = arrCreate("active", active);
        data[data.size] = arrCreate("passive", passive);

        return data;
    end;

    private macro save(balanceData : Object)
        var data = createObject("rsjvm", "TJavaHost", "GlobalJavaHost").createJavaObject("java.util.HashMap", "<init>");
        for (var it, balanceData)
            var element = TBalanceData();
            var i = 0;
            while (i < it.size)
                element(i) = it.value(i);
                i = i + 1;
            end;
            data.put(String(element.type)+element.balance, element);
        end;

        m_balanceAttribute.createBalanceIterator(m_chapter, KIND_ALL, false, true, false);
        while (m_balanceAttribute.next())
            if (index(m_balanceAttribute.getBalance(), "Chapter") == 0)
                var balance = data.get(String(getBalanceType(m_balanceAttribute.getKindBalance()))+m_balanceAttribute.getBalance());

                m_balanceAttribute.getInRestNatCur().scaled = balance.inRestNatCur;
                m_balanceAttribute.getInRestCur().scaled = balance.inRestCur;
                m_balanceAttribute.getInRest().scaled = balance.inRest;

                m_balanceAttribute.getDebetNatCur().scaled = balance.debetNatCur;
                m_balanceAttribute.getDebetCur().scaled = balance.debetCur;
                m_balanceAttribute.getDebet().scaled = balance.debet;

                m_balanceAttribute.getCreditNatCur().scaled = balance.creditNatCur;
                m_balanceAttribute.getCreditCur().scaled = balance.creditCur;
                m_balanceAttribute.getCredit().scaled = balance.credit;

                m_balanceAttribute.getOutRestNatCur().scaled = balance.outRestNatCur;
                m_balanceAttribute.getOutRestCur().scaled = balance.outRestCur;
                m_balanceAttribute.getOutRest().scaled = balance.outRest;
            end;
        end;
    end;

    macro execute()
        var protocolText = "";
        var logText = "";
        var settings = readSettings();
        var prevBalance = readPrevBalanceData();
        var balance = readBalanceData();
        var dailyBalance = readDailyBalanceData();
        var loro = readLoroAccounts();
        var data = TArray();

        data = rcbNormalizeBalance(m_chapter, balanceGlobal().getRcbReport().multiplier, settings, prevBalance, balance, dailyBalance, loro, protocolText, logText);
        if ((data != null) and (data.size != 0))
            save(data);
            RcbApplication().transactionManager.commit();
        end;

        m_operationProtocol.printLine("çéêåÄãàáÄñàü ÉãÄÇõ " + m_chapter);
        m_operationProtocol.printLine("");
        if (m_isDailyDataExists)
            m_operationProtocol.printLine("Ç ÂÆ§• ≠Æ‡¨†´®ß†Ê®® •¶•¨•·ÔÁ≠Æ© ‰Æ‡¨Î °Î´® ®·ØÆ´ÏßÆ¢†≠Î ®·ÂÆ§ÔÈ®• "
                                        + "Æ·‚†‚™® •¶•§≠•¢≠Æ£Æ °†´†≠·†, ‡†··Á®‚†≠≠Æ£Æ ß† Ø•‡®Æ§ · "
                                        + m_dailyReport.context.period.beginDate
                                        + " ØÆ "
                                        + m_dailyReport.context.period.endDate
                                         );
            m_operationProtocol.printLine("");
        end;

        if (protocolText != "")
            m_operationProtocol.printLine("çÄëíêéâäà êÖÖëíêÄ ¢ REPTREG / REP_GROUPS / BALANCE_ACCOUNTS / çéêåÄãàáÄíéê ëå:");
            m_operationProtocol.printLine(protocolText);
        else
            m_operationProtocol.printLine("è‡® ¢ÎØÆ´≠•≠®® ≠Æ‡¨†´®ß†Ê®® Ø‡Æ®ßÆË´† ™‡®‚®Á•·™†Ô ÆË®°™†");
        end;

        var fileName = ReturnDirString("TEXTDIR", "TXTFILE") + "normalizer" + StrSubst(String(time), ":", "") + String(Random(1000))+ ".log";

        var out = setoutput(fileName);
        println(logText);
        setoutput(out, true);
        m_operationProtocol.printLine("´Æ£-‰†©´: " + fileName);
    end;

    private macro constructor(chapter)
        m_chapter = chapter;
        m_balanceAttribute = TBalanceAttribute("ÅÄãÄçë", null, TBalanceAttributeMode().MODIFY_FIELD_VALUE);
        m_isPreviousDataExists = ((balanceGlobal().getRcbReport().previousPeriod.endDate != Date(0,0,0)) and (balanceGlobal().getPreviousReport().isCalculated()));
        m_previousBalanceAttribute = TBalanceAttribute("ÅÄãÄçë", balanceGlobal().getPreviousReport(), TBalanceAttributeMode().READ_ONLY);
        m_operationProtocol = TProtocol("èêéíéäéã èêéñÖÑìêõ çéêåÄãàáÄñàà " + String(m_chapter) + " ÉãÄÇõ");
        createDailyBalanceAttribute();
    end;

    constructor(chapter);
end;

macro execute(chapter, summaryProtocolView)
    TParameters().printReport(summaryProtocolView);
    if (chapter == 0)
        TChapterNormalizer(1).execute();
        TChapterNormalizer(2).execute();
        TChapterNormalizer(3).execute();
        TChapterNormalizer(4).execute();
    else
        TChapterNormalizer(chapter).execute();
    end;
end;
