/*
$Name:          f155CalculationPart4Controller.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 155. Контроллер расчета. Раздел 4.
*/


/**
 * Форма 155. Контроллер расчета. Раздел 4.
 *
 * @since   23.09.2008
 * @author  Ivkina Olga
 * @version 6.00.020.29
 */
import f155CalculationPartController;

/**
 * Расчет атрибута.
 */
class (TCalculationAttribute) TPart4CalculationAttribute(name : String/*, calculationData /*: TCalculationData*/*/)

    /**
     * Добавить значение к атрибуту.
     *
     * @param     dataLine  строка данных
     */
/*    private*/ macro addAttributeValue(attribute : TAttribute, data /*: TDataSet*/, backOffice)
        attribute.addExactValue(data.column_1,  backOffice);

    end;

/*    private macro constructor(name : String, calculationData /*: TCalculationData*/)*/
        initTCalculationAttribute();
        m_name = name;

        private var temp;
        private var i = 2;

        while (GetParm(i, temp))
             m_calculationData[m_calculationData.size] = temp;
             i = i + 1;
        end;

/*    end;*/

/*    constructor(name, calculationData);*/
end;

/**
 *  Расчет переменных по 2055-У.
 *
 */
class (TCalculationPartController) TCalculationPart4Controller2055(protocol, report, part)

    private var m_userDataSource;

    /**
     * Конструктор.
     */
    private macro constructor(protocol, report, part)
        initTCalculationPartController(protocol, report, part);
        m_userDataSource = objectFactoryInstance.createDataSource(BOUser);
    end;

    private macro calculationAttribute1()
        return TPart4CalculationAttribute("1",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart4Data"),
                                                    m_userDataSource.getFilter().isStringName("1")
                                                   )
                                         );
    end;

    private macro calculationAttribute2()
        return TPart4CalculationAttribute("2",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart4Data"),
                                                    m_userDataSource.getFilter().isStringName("2")
                                                   )
                                         );
    end;



    private macro initialize()

       m_calc = ArrCreate
       (
        calculationAttribute1(),
        calculationAttribute2()
       );
    end;

    constructor(protocol, report, part);
end;/**
 *  Расчет переменных по 2835-У.
 *
 */
class (TCalculationPartController) TCalculationPart4Controller2835(protocol, report, part)

    private var m_userDataSource;

    /**
     * Конструктор.
     */
    private macro constructor(protocol, report, part)
        initTCalculationPartController(protocol, report, part);
        m_userDataSource = objectFactoryInstance.createDataSource(BOUser);
    end;

    private macro calculationAttribute1()
        return TPart4CalculationAttribute("1",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart4Data"),
                                                    m_userDataSource.getFilter().isStringName("1")
                                                   )
                                         );
    end;

    private macro initialize()
       m_calc = ArrCreate (calculationAttribute1());
    end;

    constructor(protocol, report, part);
end;

class (TCalculationPart4Controller2835) TCalculationPart4Controller3006(protocol, report, part)
    private var m_cbAccountsDataSource;

    /**
     * Конструктор.
     */
    private macro constructorTCalculationPart4Controller3006(protocol, report, part)
        initTCalculationPart4Controller2835(protocol, report, part);
        m_userDataSource = objectFactoryInstance.createDataSource(BOUser);
        m_cbAccountsDataSource = objectFactoryInstance.createDataSource(BOCB, 4);
    end;

    private macro calculationAttribute1()
        return TPart4CalculationAttribute("1",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart4Data"),
                                                    m_userDataSource.getFilter().isStringName("1")
                                                   )
                                         );
    end;

    private macro calculationAttribute3()
        return TPart4CalculationAttribute("3",
                                   TCalculationData(m_cbAccountsDataSource.getBackOffice(),
                                                    r2m(m_cbAccountsDataSource,"getPart4Item3"),
                                                    m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'ОТЗ'")
                                                   )
                                         );
    end;

    private macro calculationAttribute4()
        return TPart4CalculationAttribute("4",
                                   TCalculationData(m_cbAccountsDataSource.getBackOffice(),
                                                    r2m(m_cbAccountsDataSource,"getPart4Item4"),
                                                    m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'ОТЗ'")
                                                   )
                                         );
    end;

    private macro calculationAttribute5()
        return TPart4CalculationAttribute("5",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart4Data"),
                                                    m_userDataSource.getFilter().isStringName("5")
                                                   )
                                         );
    end;

    private macro initialize()
       m_calc = ArrCreate (calculationAttribute1(), calculationAttribute3(), calculationAttribute4(), calculationAttribute5());
    end;

    constructorTCalculationPart4Controller3006(protocol, report, part);
end;

class (TCalculationPart4Controller3006) TCalculationPart3Controller3129(protocol, report, part)

    /**
     * Конструктор.
     */
    private macro constructorTCalculationPart3Controller3129(protocol, report, part)
        initTCalculationPart4Controller3006(protocol, report, part);
    end;

    private macro calculationAttribute2()
        return TPart4CalculationAttribute("2",
                                   TCalculationData(m_cbAccountsDataSource.getBackOffice(),
                                                    r2m(m_cbAccountsDataSource,"getPart3Item2"),
                                                    m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'ОТЗ'")
                                                   )
                                         );
    end;

    private macro calculationAttribute3()
        return TPart4CalculationAttribute("3",
                                   TCalculationData(m_cbAccountsDataSource.getBackOffice(),
                                                    r2m(m_cbAccountsDataSource,"getPart3Item3"),
                                                    m_cbAccountsDataSource.getFilter().hasAssignedAccountCategory("'ОТЗ'")
                                                   )
                                         );
    end;

    private macro calculationAttribute4()
        return TPart4CalculationAttribute("4",
                                   TCalculationData(m_userDataSource.getBackOffice(),
                                                    r2m(m_userDataSource,"getPart3Data"),
                                                    m_userDataSource.getFilter().isStringName("4")
                                                   )
                                         );
    end;

    private macro initialize()
       m_calc = ArrCreate (calculationAttribute2(), calculationAttribute3(), calculationAttribute4());
    end;

    constructorTCalculationPart3Controller3129(protocol, report, part);
end;

/**
 * Расчет переменных по 2835-У раздела 4 пункта 2
 */
class TCalculationPart4Item2Controller2835(protocol, report, part)
    private var m_dataSource;
    private var m_protocol;
    private var m_part;

    private macro calculationAttribute()
        var m_tuneTable = objectFactoryInstance.createTuneTable();
        var mask1 = m_tuneTable.getAccountMasks(4, "6", BOCb);
        var mask2 = m_tuneTable.getAccountMasks(4, "7", BOCb);
        mask1 = convertMaskToSqlFormat(mask1, "account.t_account");
        mask2 = convertMaskToSqlFormat(mask2, "account.t_account");
        var data = m_dataSource.getData(mask1, mask2);
        var number = 1;
        while (data.moveNext())
            if (data.total == 1)
                m_part.addAttribute(number, NVL(data.name, ""), data.inn, NVL(data.iLicense, ""), NVL(data.nSecurities, 0), NVL(data.valueOfSecurities, 0.0), NVL(data.presentValue, 0.0), NVL(data.madeReserve, 0.0), data.isNotResident);
                number = number + 1;
            end;
        end;
    end;

    /**
     * Конструктор.
     */
    private macro constructor(protocol, report, part)
        m_part       = part;
        m_protocol   = protocol;
        m_dataSource = objectFactoryInstance.createDataSource(BOCb, 3);
        calculationAttribute();
    end;

    constructor(protocol, report, part);
end;

class (TCalculationPart4Item2Controller2835) TCalculationPart4Item1Controller3129(protocol, report, part)
    initTCalculationPart4Item2Controller2835(protocol, report, part);

    private macro calculationAttribute()
        var m_tuneTable = objectFactoryInstance.createTuneTable();
        var mask1 = m_tuneTable.getAccountMasks(3, "6", BOCb);
        var mask2 = m_tuneTable.getAccountMasks(3, "7", BOCb);
        mask1 = convertMaskToSqlFormat(mask1, "account.t_account");
        mask2 = convertMaskToSqlFormat(mask2, "account.t_account");
        var data = m_dataSource.getData(mask1, mask2);
        var number = 1;
        while (data.moveNext())
            if (data.total == 1)
                m_part.addAttribute(number, NVL(data.name, ""), data.inn, NVL(data.iLicense, ""), NVL(data.nSecurities, 0), NVL(data.valueOfSecurities, 0.0), NVL(data.presentValue, 0.0), NVL(data.madeReserve, 0.0), data.isNotResident);
                number = number + 1;
            end;
        end;
    end;
end;

class (TCalculationPart4Item1Controller3129) TCalculationPart4Item1Controller3468(protocol, report, part)
    initTCalculationPart4Item1Controller3129(protocol, report, part);

    private macro calculationAttribute()
        var m_tuneTable = objectFactoryInstance.createTuneTable();
        var mask1 = m_tuneTable.getAccountMasks(3, "6", BOCb);
        var mask2 = m_tuneTable.getAccountMasks(3, "7", BOCb);
        var number = 1;

        mask1 = convertMaskToSqlFormat(mask1, "account.t_account");
        mask2 = convertMaskToSqlFormat(mask2, "account.t_account");

        m_protocol.printReportPartNumber("\"Справочно\"");

        var data = m_dataSource.getData(mask1, mask2);

        while (data.moveNext())
            if (data.total == 1)
                m_part.addAttribute(number, NVL(data.name, ""), data.inn, NVL(data.iLicense, ""), NVL(data.nSecurities, 0), NVL(data.valueOfSecurities, 0.0), NVL(data.presentValue, 0.0), NVL(data.madeReserve, 0.0), data.isNotResident);
                number = number + 1;
            end;
        end;
    end;
end;