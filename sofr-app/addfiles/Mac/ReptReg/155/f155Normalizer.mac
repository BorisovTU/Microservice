/*
$Name:          f155Normalizer.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 155. Нормализатор
*/

import f155NormalizationProtocolView;
import balanceAttribute;
import ReportNormalizer;

/**
* Пара(коэффициент - узел)
*/
private class pair(coefficient, pObject)
    var m_coefficient;
    var m_pObject;

    if (   (valType(coefficient) == V_DOUBLE)
        or (valType(coefficient) == V_MONEY)
       )
        m_coefficient = coefficient;
        m_pObject     = null;
    elif (IsEqClass("RcbNode", coefficient))
        m_coefficient = 1.0;
        m_pObject     = coefficient;
    end;

    if (IsEqClass("RcbNode", pObject))
        m_pObject     = pObject;
    end;
end;

/**
* Линейная комбинация.
*/
private class LinearCombination(linearRelation)
    var m_linearRelation = linearRelation;
    var m_listRelation   = TArray();

    macro plus(coefficient, pObject)
        m_listRelation[m_listRelation.size] = pair(coefficient, pObject);
    end;

    macro formatting(v)
        v = String(v);
        while ((subStr(v,strLen(v)) == "0") and (strLen(v) > 3))
            v = substr(v,1, strLen(v)-1);
        end;
        return v;
    end;

    macro toNameString()
        var i = 0;
        var lineCombString = "";
        while ( i < m_listRelation.size)
            lineCombString = lineCombString + " + " + formatting(m_listRelation[i].m_coefficient);
            if (valType(m_listRelation[i].m_pObject) != V_UNDEF)
                lineCombString = lineCombString +  " * " + m_listRelation[i].m_pObject.code;
            end;
            i = i + 1;
        end;
        return lineCombString;
    end;

    macro toExactString()
        var i = 0;
        var lineCombString = "";
        while ( i < m_listRelation.size)
            lineCombString = lineCombString + " + " + (m_listRelation[i].m_coefficient + "* " + m_listRelation[i].m_pObject.exact);
            i = i + 1;
        end;
        return lineCombString;
    end;

    macro exactResult()
        var i = 0;
        var result = 0;
        while ( i < m_listRelation.size)
            if (valType(m_listRelation[i].m_pObject) != V_UNDEF)
                result = result + (m_listRelation[i].m_coefficient * m_listRelation[i].m_pObject.exact);
            else
                result = result + m_listRelation[i].m_coefficient;
            end;
            i = i + 1;
        end;
        return result;
    end;
end;

/**
* Линейная комбинация левой части.
*/
private class (LinearCombination) LinearCombinationL(linearRelation)
    initLinearCombination(linearRelation);

    macro plus(coefficient, pObject)
        plus(coefficient, pObject);
        if(valtype(pObject) != V_UNDEF)
            m_linearRelation.lhs.plus(coefficient, pObject);
        else
            m_linearRelation.lhs.plus(coefficient);
        end;
        return this;
    end;
end;

/**
* Линейная комбинация правой части.
*/
private class (LinearCombination) LinearCombinationR(linearRelation)
    initLinearCombination(linearRelation);

    macro plus(coefficient, pObject)
        plus(coefficient, pObject);
        if(valtype(pObject) != V_UNDEF)
            m_linearRelation.rhs.plus(coefficient, pObject);
        else
            m_linearRelation.rhs.plus(coefficient);
        end;
        return this;
    end;
end;

/**
* Линейная связь.
*/
class linearRelation(relationSign)
    var m_linearRelation = RcbLinearRelation(relationSign);
    var m_relationSign   = relationSign;

    var lhs = LinearCombinationL(m_linearRelation);
    var rhs = LinearCombinationR(m_linearRelation);

    private macro getSign()
        if (m_relationSign == RCB_RS_EQUAL)
            return " == ";
        elif(m_relationSign == RCB_RS_GREATER_OR_EQUAL)
            return " >= ";
        elif(m_relationSign == RCB_RS_LESS_OR_EQUAL)
            return " <= ";
        else
            return "";
        end;
    end;

    macro linearRelationExactCheck(protocolView)
        var expression = string(lhs.exactResult) + getSign() + string(rhs.exactResult);
        if (not execExp(expression))
            protocolView.printRelationError(lhs.toNameString, getSign(), rhs.toNameString);
//            protocolView.printRelationError(lhs.exactResult,  getSign(), rhs.exactResult);
        end;
    end;

    macro getLinearRelation()
        return m_linearRelation;
    end;
end;

/**
* Формирование имени узла.
*/
private macro getName(line, column)
    return "Стр" + line + ternary((column != null) and (column != 0), "Гр" + column, "");
end;

/**
* нормализатор.
*/
class (RcbNormalizer) TNormalizer(protocolView)
    initRcbNormalizer(rcbApplication.currentReport.multiplier);

    /**
    * Ссылка на протокол нормализации.
    */
    private var m_protocolView = protocolView;

    /**
    * Ссылка на значения атрибута.
    */
    private var m_attributeValue;

    /**
    * Ссылка на значения "Балансовые счета".
    */
    private var m_balanceRcbReport = rcbApplication.currentReport.createOtherReport("Балансовые счета");
    private var m_balanceAttribute = TBalanceAttribute("БАЛАНС",  m_balanceRcbReport);

    /**
    * Начальный номер графы для строки.
    */
    private var m_beginColumn = 0;
    /**
    * Конечный номер графы для строки.
    */
    private var m_endColumn   = 0;

    /**
    * Получить
    * @param     line    код строки
    */
    private macro getValue(line) : TAttribute
        return m_attributeValue.getAttribute(line);
    end;

    /**
    * Добавить узел.
    * @param     parentLine    код родительской строки
    * @param     line           код строки
    * @param     column     код графы
    */
    macro addNode(parentLine, line, column)
        var node  = null;
        var value = getValue(line);
        var relation;

        if (parentLine == line)
            node = _extObj.addNode(getName(line, column));
            node.exclude();
        else
            node = _extObj.node(getName(parentLine, column)).addNode(getName(line, column));
        end;
        if (column == null)
            node.exact = value.getExactValue;
        elif (value.getSubAttribute(column).getExactValue == null)
            return null;
        else
            node.exact = value.getSubAttribute(column).getExactValue;
        end;

        node.recalculateScaled();

        return node;
    end;

    /**
    * Загрузить строку значений.
    * @param     parentLine    код родительской строки
    * @param     line          код строки
    */
    private macro loadLine(parentLine, line)
        throw(TPureVirtualMethodCallException("TNormalizer::loadLine"));
    end;

    /**
    * Загрузить данные для нормализации.
    */
    macro load()
        throw(TPureVirtualMethodCallException("TNormalizer::load"));
    end;

    /**
    * Загрузить связь строк.
    */
    private macro loadLinesRelation()
        var i = 1;/*т.к. первый параметр обязателен*/
        var temp;
        var rLines = TArray();
        var lLines = TArray();
        var sign   = null;

        var relation;

        while (GetParm(i, temp))
            if (valType(temp) == V_STRING)
                if (sign == null)
                    lLines[lLines.size] = temp;
                else
                    rLines[rLines.size] = temp;
                end;
            else
                sign = temp;
            end;
            i = i + 1;
        end;

        var column = m_beginColumn;
        while (column <= m_endColumn)
            relation = LinearRelation(sign);

            i = 0;
            while (i < lLines.size)
                relation.lhs.plus(node(getName(lLines[i],  column)));
                i = i + 1;
            end;

            i = 0;
            while (i < rLines.size)
                relation.rhs.plus(node(getName(rLines[i],  column)));
                i = i + 1;
            end;
            relation.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation.getLinearRelation);
            column = column + 1;
        end;
    end;

    /**
    * Загрузить связь с данными баланса.
    */
    private macro loadRelation()
        var i = 1;/*т.к. первый параметр обязателен*/
        var temp;
        var rLines = TArray();
        var lLines = TArray();
        var sign   = null;

        var relation;

        while (GetParm(i, temp))
            if (valType(temp) == V_INTEGER)
                sign = temp;
            else
                if (sign == null)
                    lLines[lLines.size] = temp;
                else
                    rLines[rLines.size] = temp;
                end;
            end;
            i = i + 1;
        end;

        macro get(name)
            if ((strlen(name) == 3) or ((strlen(name) == 5)))
                var balanceValue = m_balanceAttribute.getBalanceAttribute(4, name, false);

                if (balanceValue != null)
                    if (balanceValue.fieldValue("kind").currentAsString == "П")
                        return double(nvl(balanceValue.fieldValue("restPassive").scaled, 0.00));
                    else
                        return double(nvl(balanceValue.fieldValue("restActive").scaled, 0.00));
                    end;
                else
                    return 0.0;
                end;
            else
                return node(name);
            end;
        end;

        relation = LinearRelation(sign);

        i = 0;
        while (i < lLines.size)
            relation.lhs.plus(get(lLines[i]));
            i = i + 1;
        end;

        i = 0;
        while (i < rLines.size)
            relation.rhs.plus(get(rLines[i]));
            i = i + 1;
        end;
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);
    end;

    /**
    * Сохранить строку значений.
    * @param     line    код строки
    *
    */
    private macro saveLine(line)
        var value = getValue(line);

        macro valueSave(line, column)
            var node = this.node(getName(line, column));
            if (node)
                value.getSubAttribute(column).setExactValue(node.exact);
                value.getSubAttribute(column).setScaledValue(node.scaled);
            end;
        end;

        var i = m_beginColumn;
        var columnValue;
        var column;

        while (i <= m_endColumn)
                column = ternary((i==0), "", string(i));
            valueSave(line, column);

            columnValue = value.getSubAttribute(column);
            if (    (columnValue.getExactValue != null)
                and (columnValue.getScaledValue != floor(Double(columnValue.getExactValue) / rcbApplication.currentReport.multiplier + 0.5)))
                m_protocolView.printSymbol(line, column, columnValue.getExactValue, columnValue.getScaledValue);
            end;
            i = i + 1;
        end;
    end;

    /**
    * Сохранить атрибуты.
    */
    macro save()
        var attributes = m_attributeValue.getAttributes;
        var i = 0;
        while (i < attributes.size)
            saveLine(attributes[i].getName());
            i = i + 1;
        end;
    end;

    macro execute()
        load();
        m_protocolView.endRelErrHeadPrinted();
        normalize();

        if (isNormalized())
            save();
        else
            m_protocolView.printLine("Не удалось провести нормализацию.");
        end;
        m_protocolView.endPart();
    end;
end;

/**
* нормализатор ММБ
*/
class (ReportNormalizer) TNormalizer_MMB(protocolView)
    initReportNormalizer(rcbApplication.currentReport.multiplier);

    /**
    * Ссылка на протокол нормализации.
    */
    private var m_protocolView = protocolView;

    /**
    * Ссылка на значения атрибута.
    */
    private var m_attributeValue;

    /**
    * Ссылка на значения "Балансовые счета".
    */
    private var m_balanceRcbReport = rcbApplication.currentReport.createOtherReport("Балансовые счета");
    private var m_balanceAttribute = TBalanceAttribute("БАЛАНС",  m_balanceRcbReport);

    /**
    * Начальный номер графы для строки.
    */
    private var m_beginColumn = 0;
    /**
    * Конечный номер графы для строки.
    */
    private var m_endColumn   = 0;

    /**
    * Получить
    * @param     line    код строки
    */
    private macro getValue(line) : TAttribute
        return m_attributeValue.getAttribute(line);
    end;

    /**
    * Добавить узел.
    * @param     parentLine    код родительской строки
    * @param     line           код строки
    * @param     column     код графы
    */
    macro addNode(parentLine, line, column)
        var node  = null;
        var value = getValue(line);
        var relation;

        if (parentLine == line)
            node = normalizer.addNode(getName(line, column));
            node.exclude();
        else
            node = normalizer.node(getName(parentLine, column)).addNode(getName(line, column));
        end;
        if (column == null)
            node.exact = value.getExactValue;
        elif (value.getSubAttribute(column).getExactValue == null)
            return null;
        else
            node.exact = value.getSubAttribute(column).getExactValue;
        end;

        node.recalculateScaled();

        return node;
    end;

    /**
    * Загрузить строку значений.
    * @param     parentLine    код родительской строки
    * @param     line          код строки
    */
    private macro loadLine(parentLine, line)
        throw(TPureVirtualMethodCallException("TNormalizer::loadLine"));
    end;

    /**
    * Загрузить данные для нормализации.
    */
    macro load()
        throw(TPureVirtualMethodCallException("TNormalizer::load"));
    end;

    /**
    * Загрузить связь строк.
    */
    private macro loadLinesRelation()
        var i = 1;/*т.к. первый параметр обязателен*/
        var temp;
        var rLines = TArray();
        var lLines = TArray();
        var sign   = null;

        var relation;

        while (GetParm(i, temp))
            if (valType(temp) == V_STRING)
                if (sign == null)
                    lLines[lLines.size] = temp;
                else
                    rLines[rLines.size] = temp;
                end;
            else
                sign = temp;
            end;
            i = i + 1;
        end;

        var column = m_beginColumn;
        while (column <= m_endColumn)
            relation = ReportLinearRelation(sign);

            i = 0;
            while (i < lLines.size)
                relation.lhs.plus(node(getName(lLines[i],  column)));
                i = i + 1;
            end;

            i = 0;
            while (i < rLines.size)
                relation.rhs.plus(node(getName(rLines[i],  column)));
                i = i + 1;
            end;
            relation.checkExactValue(m_protocolView);
            addRelation(relation);
            column = column + 1;
        end;
    end;

    /**
    * Загрузить связь с данными баланса.
    */
    private macro loadRelation()
        var i = 1;/*т.к. первый параметр обязателен*/
        var temp;
        var rLines = TArray();
        var lLines = TArray();
        var sign   = null;

        var relation;

        while (GetParm(i, temp))
            if (valType(temp) == V_INTEGER)
                sign = temp;
            else
                if (sign == null)
                    lLines[lLines.size] = temp;
                else
                    rLines[rLines.size] = temp;
                end;
            end;
            i = i + 1;
        end;

        macro get(name)
            if ((strlen(name) == 3) or ((strlen(name) == 5)))
                var balanceValue = m_balanceAttribute.getBalanceAttribute(4, name, false);

                if (balanceValue != null)
                    if (balanceValue.fieldValue("kind").currentAsString == "П")
                        return double(nvl(balanceValue.fieldValue("restPassive").scaled, 0.00));
                    else
                        return double(nvl(balanceValue.fieldValue("restActive").scaled, 0.00));
                    end;
                else
                    return 0.0;
                end;
            else
                return node(name);
            end;
        end;

        relation = ReportLinearRelation(sign);

        i = 0;
        while (i < lLines.size)
            relation.lhs.plus(get(lLines[i]));
            i = i + 1;
        end;

        i = 0;
        while (i < rLines.size)
            relation.rhs.plus(get(rLines[i]));
            i = i + 1;
        end;
        relation.checkExactValue(m_protocolView);
        addRelation(relation);
    end;

    /**
    * Сохранить строку значений.
    * @param     line    код строки
    *
    */
    private macro saveLine(line)
        var value = getValue(line);

        macro valueSave(line, column)
            var node = this.node(getName(line, column));

            if (node)
                value.getSubAttribute(column).setExactValue(node.exact);
                value.getSubAttribute(column).setScaledValue(node.scaled);
            end;
        end;

        var i = m_beginColumn;
        var columnValue;
        var column;

        while (i <= m_endColumn)
                column = ternary((i==0), "", string(i));
            valueSave(line, column);

            columnValue = value.getSubAttribute(column);
            if (    (columnValue.getExactValue != null)
                and (columnValue.getScaledValue != floor(Double(columnValue.getExactValue) / rcbApplication.currentReport.multiplier + 0.5)))
                m_protocolView.printSymbol(line, column, columnValue.getExactValue, columnValue.getScaledValue);
            end;
            i = i + 1;
        end;
    end;

    /**
    * Сохранить атрибуты.
    */
    macro save()
        var attributes = m_attributeValue.getAttributes;
        var i = 0;
        while (i < attributes.size)
            saveLine(attributes[i].getName());
            i = i + 1;
        end;
    end;

    macro execute()
        load();
        m_protocolView.endRelErrHeadPrinted();
        normalize();

        if (isNormalized())
            save();
        else
            m_protocolView.printLine("Не удалось провести нормализацию.");
        end;
        m_protocolView.endPart();
    end;
end;

/**
* Нормализация раздела 1.
*/
class (TNormalizer_MMB) TPart1Normalizer(protocolView)
    initTNormalizer_MMB(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("1");
    m_beginColumn    =  3;
    m_endColumn      = 15;

    /**
    * Загрузить строку значений.
    * @param     parentLine    код родительской строки
    * @param     line          код строки
    */
    private macro loadLine(parentLine, line)
        var node3  = addNode(parentLine, line, "3");
        var node4  = addNode(parentLine, line, "4");
        var node5  = addNode(parentLine, line, "5");
        var node6  = addNode(parentLine, line, "6");
        var node7  = addNode(parentLine, line, "7");
        var node8  = addNode(parentLine, line, "8");
        var node9  = addNode(parentLine, line, "9");
        var node10 = addNode(parentLine, line, "10");
        var node11 = addNode(parentLine, line, "11");
        var node12 = addNode(parentLine, line, "12");
        var node13 = addNode(parentLine, line, "13");
        var node14 = addNode(parentLine, line, "14");
        var node15 = addNode(parentLine, line, "15");

        var relation;
        if (subStr(line, 1, 1) != "7")
            relation = ReportLinearRelation(RCB_RS_EQUAL);
            relation.lhs.plus(node4).plus(node5).plus(node6).plus(node7).plus(node8);
            relation.rhs.plus(node3);
            relation.checkExactValue(m_protocolView);
            addRelation(relation);
        end;


        var relation2;
        relation2 = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
        relation2.lhs.plus(node9);
        relation2.rhs.plus(node10);
        relation2.checkExactValue(m_protocolView);
        addRelation(relation2);


        var relation3;
        relation3 = ReportLinearRelation(RCB_RS_EQUAL);
        relation3.lhs.plus(node10);
        relation3.rhs.plus(node11);
        relation3.checkExactValue(m_protocolView);
        addRelation(relation3);


        var relation4;
        relation4 = ReportLinearRelation(RCB_RS_EQUAL);
        relation4.lhs.plus(node12).plus(node13).plus(node14).plus(node15);
        relation4.rhs.plus(node11);
        relation4.checkExactValue(m_protocolView);
        addRelation(relation4);

        var relation5;
        var relation6;
        var relation7;
        var relation8;

        if (subStr(line, 1, 1) != "7")
/*          relation5 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation5.lhs.plus(node12);
            relation5.rhs.plus(0.2, node5);
            relation5.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation5.getLinearRelation);

            relation6 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation6.lhs.plus(node13);
            relation6.rhs.plus(0.5, node6);
            relation6.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation6.getLinearRelation);
*/
            relation7 = ReportLinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation7.lhs.plus(node14);
            relation7.rhs.plus(node7);
            relation7.checkExactValue(m_protocolView);
            addRelation(relation7);

            relation8 = ReportLinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation8.lhs.plus(node15);
            relation8.rhs.plus(node8);
            relation8.checkExactValue(m_protocolView);
            addRelation(relation8);
/*      else
            relation5 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation5.lhs.plus(node12);
            relation5.rhs.plus(0.03, node5);
            relation5.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation5.getLinearRelation);

            relation6 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation6.lhs.plus(node13);
            relation6.rhs.plus(0.2, node6);
            relation6.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation6.getLinearRelation);


            relation7 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation7.lhs.plus(node14);
            relation7.rhs.plus(0.5, node7);
            this.addRelation(relation7.getLinearRelation);

            relation8 = LinearRelation(RCB_RS_LESS_OR_EQUAL);
            relation8.lhs.plus(node15);
            relation8.rhs.plus(0.5, node8);
            relation8.linearRelationExactCheck(m_protocolView);
            this.addRelation(relation8.getLinearRelation);
*/        end;
    end;

    macro load()

        loadLine("6", "6");

        loadLine("6", "1");
        loadLine("6", "2");
        loadLine("6", "3");
        loadLine("6", "4");
        loadLine("6", "5");


        loadLine("6.1", "6.1");

        loadLine("6.1", "1.1");
        loadLine("6.1", "2.1");
        loadLine("6.1", "3.1");
        loadLine("6.1", "4.1");
        loadLine("6.1", "5.1");


        loadLine("7", "7");
        loadLine("7", "7.1");
        loadLine("7", "7.2");
        loadLine("7", "7.3");
        var i = 4;
        while (i != 0)
            if (m_attributeValue.getAttribute("7." + i) != null)
                loadLine("7", "7." + i);
            else
                i = -1;
            end;
            i = i + 1;
        end;

        loadLinesRelation("1", RCB_RS_GREATER_OR_EQUAL, "1.1");
        loadLinesRelation("2", RCB_RS_GREATER_OR_EQUAL, "2.1");
        loadLinesRelation("3", RCB_RS_GREATER_OR_EQUAL, "3.1");
        loadLinesRelation("4", RCB_RS_GREATER_OR_EQUAL, "4.1");
        loadLinesRelation("5", RCB_RS_GREATER_OR_EQUAL, "5.1");
    end;
end;

/**
* Нормализация раздела 2.
*/
class (TNormalizer) TPart2Normalizer(protocolView)
    initTNormalizer(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("2");
    m_beginColumn    = 3;
    m_endColumn      = 7;

    private macro loadLine(parentLine, line)
        var node3  = addNode(parentLine, line, "3");
        var node4  = addNode(parentLine, line, "4");
        var node5  = addNode(parentLine, line, "5");
        var node6  = addNode(parentLine, line, "6");
        var node7  = addNode(parentLine, line, "7");

        var relation = LinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(node7);
        relation.rhs.plus(node6);
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);
    end;

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1.1", "3"), getName("2.1", "3"), getName("3.1", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933");

            loadRelation(getName("1.2", "3"), getName("1.3", "3"), getName("2.2", "3"),
                        getName("2.3", "3"), getName("3.2", "3"), getName("3.3", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933", "934", "935");

            loadRelation(getName("1.1", "4"), getName("2.1", "4"), getName("3.1", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963");

            loadRelation(getName("1.2", "4"), getName("1.3", "4"), getName("2.2", "4"),
                        getName("2.3", "4"), getName("3.2", "4"), getName("3.3", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963", "964", "965");

            loadRelation(getName("1.1", "5"), getName("2.1", "5"), getName("3.1", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "968");

            loadRelation(getName("1.2", "5"), getName("2.2", "5"), getName("3.2", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "969");

            loadRelation(getName("1.3", "5"), getName("2.3", "5"), getName("3.3", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "970");

            loadRelation(getName("1.1", "6"), getName("2.1", "6"), getName("3.1", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "938");

            loadRelation(getName("1.2", "6"), getName("2.2", "6"), getName("3.2", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "939");

            loadRelation(getName("1.3", "6"), getName("2.3", "6"), getName("3.3", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "940");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

/**
* Нормализация раздела 3.
*/
class (TNormalizer) TPart3Normalizer(protocolView)
    initTNormalizer(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("3");
    m_beginColumn    = 3;
    m_endColumn      = 7;

    private macro loadLine(parentLine, line)
        var node3  = addNode(parentLine, line, "3");
        var node4  = addNode(parentLine, line, "4");
        var node5  = addNode(parentLine, line, "5");
        var node6  = addNode(parentLine, line, "6");
        var node7  = addNode(parentLine, line, "7");

        var relation = LinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(node7);
        relation.rhs.plus(node6);
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);
    end;

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1", "5"), getName("2", "5"), getName("3", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "971");

            loadRelation(getName("1", "6"), getName("2", "6"), getName("3", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "950");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

class (TPart2Normalizer) TPart2Normalizer2742(protocolView)
    initTPart2Normalizer(protocolView);

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");

        loadLine("4", "4");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1.1", "3"), getName("2.1", "3"), getName("3.1", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933");

            loadRelation(getName("1.2", "3"), getName("1.3", "3"), getName("2.2", "3"),
                        getName("2.3", "3"), getName("3.2", "3"), getName("3.3", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933", "934", "935");

            loadRelation(getName("1.1", "4"), getName("2.1", "4"), getName("3.1", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963");

            loadRelation(getName("1.2", "4"), getName("1.3", "4"), getName("2.2", "4"),
                        getName("2.3", "4"), getName("3.2", "4"), getName("3.3", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963", "964", "965");

            loadRelation(getName("1.1", "5"), getName("2.1", "5"), getName("3.1", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "968");

            loadRelation(getName("1.2", "5"), getName("2.2", "5"), getName("3.2", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "969");

            loadRelation(getName("1.3", "5"), getName("2.3", "5"), getName("3.3", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "970");

            loadRelation(getName("1.1", "6"), getName("2.1", "6"), getName("3.1", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "938");

            loadRelation(getName("1.2", "6"), getName("2.2", "6"), getName("3.2", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "939");

            loadRelation(getName("1.3", "6"), getName("2.3", "6"), getName("3.3", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "940");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

class (TPart2Normalizer) TPart2Normalizer2835(protocolView)
    initTPart2Normalizer(protocolView);

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");
        loadLine("1", "1.5");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");
        loadLine("2", "2.5");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");
        loadLine("3", "3.5");

        loadLine("4", "4");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1.1", "3"), getName("1.2", "3"), getName("2.1", "3"), getName("2.2", "3"),
                        getName("3.1", "3"), getName("3.2", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933");

            loadRelation(getName("1.3", "3"), getName("1.4", "3"), getName("1.5", "3"),
                        getName("2.3", "3"), getName("2.4", "3"), getName("2.5", "3"), getName("3.3", "3"),
                        getName("3.4", "3"), getName("3.5", "3"), getName("4", "3"),
                        RCB_RS_LESS_OR_EQUAL,
                        "933", "934", "935");

            loadRelation(getName("1.1", "4"), getName("1.2", "4"), getName("2.1", "4"), getName("2.2", "4"),
                        getName("3.1", "4"), getName("3.2", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963");

            loadRelation(getName("1.3", "4"), getName("1.4", "4"), getName("1.5", "4"),
                        getName("2.3", "4"), getName("2.4", "4"), getName("2.5", "4"), getName("3.3", "4"),
                        getName("3.4", "4"), getName("3.5", "4"), getName("4", "4"),
                        RCB_RS_LESS_OR_EQUAL,
                        "963", "964", "965");

            loadRelation(getName("1.1", "5"), getName("1.2", "5"), getName("2.1", "5"), getName("2.2", "5"),
                        getName("3.1", "5"), getName("3.2", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "96801", "96805");

            loadRelation(getName("1.3", "5"), getName("2.3", "5"), getName("3.3", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "96802");

            loadRelation(getName("1.4", "5"), getName("2.4", "5"), getName("3.4", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "96803");

            loadRelation(getName("1.5", "5"), getName("2.5", "5"), getName("3.5", "5"), getName("4", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "96804", "96806", "96807");

            loadRelation(getName("1.1", "6"), getName("1.2", "6"), getName("2.1", "6"), getName("2.2", "6"),
                        getName("3.1", "6"), getName("3.2", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "93801", "93805");

            loadRelation(getName("1.3", "6"), getName("2.3", "6"), getName("3.3", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "93802");

            loadRelation(getName("1.4", "6"), getName("2.4", "6"), getName("3.4", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "93803");

            loadRelation(getName("1.5", "6"), getName("2.5", "6"), getName("3.5", "6"), getName("4", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "93804", "93806", "93807");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

/**
* Нормализация раздела 3.
*/
class (TPart3Normalizer) TPart3Normalizer2742(protocolView)
    initTPart3Normalizer(protocolView);
    m_beginColumn    = 3;
    m_endColumn      = 8;

    private macro loadLine(parentLine, line)
        var node3  = addNode(parentLine, line, "3");
        var node4  = addNode(parentLine, line, "4");
        var node5  = addNode(parentLine, line, "5");
        var node6  = addNode(parentLine, line, "6");
        var node7  = addNode(parentLine, line, "7");
        var node8  = addNode(parentLine, line, "8");

        var relation = LinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(node7);
        relation.rhs.plus(node6);
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);
    end;

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");
        loadLine("3", "3.5");

        loadLine("4", "4");
        loadLine("4", "4.1");
        loadLine("4", "4.2");
        loadLine("4", "4.3");
        loadLine("4", "4.4");
        loadLine("4", "4.5");
        loadLine("4", "4.6");

        loadLine("5", "5");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1", "5"), getName("2", "5"), getName("3", "5"),
                        RCB_RS_LESS_OR_EQUAL,
                        "971");

            loadRelation(getName("1", "6"), getName("2", "6"), getName("3", "6"),
                        RCB_RS_LESS_OR_EQUAL,
                        "950");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

class (TNormalizer_MMB) TPart2Normalizer3129(protocolView)
    initTNormalizer_MMB(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("2");
    m_beginColumn    = 3;
    m_endColumn      = 6;

    private macro loadLine(parentLine, line)
        var node3  = addNode(parentLine, line, "3");
        var node4  = addNode(parentLine, line, "4");
        var node5  = addNode(parentLine, line, "5");
        var node6  = addNode(parentLine, line, "6");

        var relation = ReportLinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.rhs.plus(node6);
        relation.checkExactValue(m_protocolView);
        addRelation(relation);
    end;

    macro load()
        loadLine("1", "1");
        loadLine("1", "1.1");
        loadLine("1", "1.2");
        loadLine("1", "1.3");
        loadLine("1", "1.4");

        loadLine("2", "2");
        loadLine("2", "2.1");
        loadLine("2", "2.2");
        loadLine("2", "2.3");
        loadLine("2", "2.4");

        loadLine("3", "3");
        loadLine("3", "3.1");
        loadLine("3", "3.2");
        loadLine("3", "3.3");
        loadLine("3", "3.4");
        loadLine("3", "3.5");

        loadLine("4", "4");
        loadLine("4", "4.1");
        loadLine("4", "4.2");
        loadLine("4", "4.3");
        loadLine("4", "4.4");
        loadLine("4", "4.5");
        loadLine("4", "4.6");

        loadLine("5", "5");

        if (m_balanceRcbReport.isCalculated())
            loadRelation(getName("1", "5"), getName("2", "5"), getName("3", "5"),
                         RCB_RS_LESS_OR_EQUAL,
                         "971");

            loadRelation(getName("1", "6"), getName("2", "6"), getName("3", "6"),
                         RCB_RS_LESS_OR_EQUAL,
                         "950");
        else
            m_protocolView.printLine("Не рассчитан баланс за период выпуска отчета. Контроль с данными баланса невозможен.");
        end;
    end;
end;

/**
* Нормализация раздела Справочно.
*/
class (TNormalizer) TPart4Normalizer(protocolView)
    initTNormalizer(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("4");

    private macro loadLine(parentLine, line)
        var node  = addNode(parentLine, line);
    end;

    macro load()
        loadLine("1", "1");

        var part = objectFactoryInstance.createReport().getPart("2");
        var relation = LinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(node(getName("1")));
        relation.rhs.plus(double(part.getAttribute("1").getSubAttribute("6").getScaledValue)).
                    plus(double(part.getAttribute("2").getSubAttribute("6").getScaledValue)).
                    plus(double(part.getAttribute("3").getSubAttribute("6").getScaledValue));
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);

    end;
end;

class (TPart4Normalizer) TPart4Normalizer2835(protocolView)
    initTPart4Normalizer(protocolView);
    m_attributeValue = objectFactoryInstance.createReport().getPart("4");

    private macro loadLine(parentLine, line)
        var node  = addNode(parentLine, line);
    end;

    macro load()
        loadLine("1", "1");

        var part = objectFactoryInstance.createReport().getPart("2");
        var relation = LinearRelation(RCB_RS_LESS_OR_EQUAL);
        relation.lhs.plus(node(getName("1")));
        relation.rhs.plus(double(part.getAttribute("1").getSubAttribute("6").getScaledValue)).
                    plus(double(part.getAttribute("2").getSubAttribute("6").getScaledValue)).
                    plus(double(part.getAttribute("3").getSubAttribute("6").getScaledValue)).
                    plus(double(part.getAttribute("4").getSubAttribute("6").getScaledValue));
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);

    end;
end;

/**
* Нормализация раздела Справочно, пункт 2.
*/
class (TNormalizer) TPart4NormalizerItem2(protocolView)
    initTNormalizer(protocolView);
    private var iteratorPart4    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт2").createValueIterator();
    private var m_attributeItem4 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт2");
    private var isNormazed = false;

    /**
     * Сохранить строку значений.
     * @param     line    код строки
     *
     */
    private macro saveValue(line, column, value, field)
        var keyValue                  = m_attributeItem4.createKeyValue();
        keyValue.fieldValue("number") = iteratorPart4.currentItem.fieldValue("number").current;
        var lineCompositeValue        = m_attributeItem4.findValue(keyValue);
        var valueExact  = 0;
        var valueScaled = 0;
        var node        = this.node("Стр" + line + "Гр" + column);
        if (node and lineCompositeValue.fieldValue(field).exact != 0)
            valueExact  = lineCompositeValue.fieldValue(field).exact  = node.exact;
            valueScaled = lineCompositeValue.fieldValue(field).scaled = node.scaled;
        end;
        var isNormalizedValue = ((valueExact  != null) and
                                 (valueScaled != floor(Double(valueExact) / rcbApplication.currentReport.multiplier + 0.5)));
        if (isNormalizedValue)
            m_protocolView.printSymbol(line, column, valueExact, valueScaled);
            isNormalized = true;
        end;
    end;

    /**
     * Сохранить атрибуты.
     */
    macro save()
        iteratorPart4.moveFirst();
        while (not iteratorPart4.isDone())
            saveValue(iteratorPart4.currentItem.fieldValue("number").current, "6", iteratorPart4.currentItem.fieldValue("valueOfSecurities").current, "valueOfSecurities");
            saveValue(iteratorPart4.currentItem.fieldValue("number").current, "7", iteratorPart4.currentItem.fieldValue("presentValue").current, "presentValue");
            saveValue(iteratorPart4.currentItem.fieldValue("number").current, "8", iteratorPart4.currentItem.fieldValue("madeReserve").current, "madeReserve");
            iteratorPart4.moveNext();
        end;
        m_protocolView.endPart();
    end;

    /**
     * Формирование имени узла.
     */
    private macro getName(line, column)
        return "Стр" + line + "Гр" + column;
    end;

    private macro addNode2(line, column, value)
        var node   = null;
        node       = _extObj.addNode(getName(line, column));
        node.exact = NVL(value, 0);
        node.recalculateScaled();
        return node;
    end;

    macro load()
        iteratorPart4.moveFirst();
        while (not iteratorPart4.isDone())
            var node6 = addNode2(iteratorPart4.currentItem.fieldValue("number").current, "6", iteratorPart4.currentItem.fieldValue("valueOfSecurities").exact);
            var node7 = addNode2(iteratorPart4.currentItem.fieldValue("number").current, "7", iteratorPart4.currentItem.fieldValue("presentValue").exact);
            var node8 = addNode2(iteratorPart4.currentItem.fieldValue("number").current, "8", iteratorPart4.currentItem.fieldValue("madeReserve").exact);

            var relation;

            if ((iteratorPart4.currentItem.fieldValue("valueOfSecurities").exact > 0) and
                (iteratorPart4.currentItem.fieldValue("presentValue").exact      == 0))
                relation = LinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node6);
                relation.linearRelationExactCheck(m_protocolView);
                this.addRelation(relation.getLinearRelation);
            end;
            if ((iteratorPart4.currentItem.fieldValue("presentValue").exact      > 0) and
                (iteratorPart4.currentItem.fieldValue("valueOfSecurities").exact == 0))
                relation = LinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node7);
                relation.linearRelationExactCheck(m_protocolView);
                this.addRelation(relation.getLinearRelation);
            end;

            if ((iteratorPart4.currentItem.fieldValue("presentValue").exact      > 0) and
                (iteratorPart4.currentItem.fieldValue("valueOfSecurities").exact > 0))
                relation = LinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node6).plus(0.5, node7);
        relation.linearRelationExactCheck(m_protocolView);
        this.addRelation(relation.getLinearRelation);
    end;

            iteratorPart4.moveNext();
        end;
    end;

    macro execute()
        m_protocolView.setNotIsRelErr();
        load();
        m_protocolView.endRelErrHeadPrinted();
        normalize();

        if (not m_protocolView.getIsRelErr())
            save();
        else
            m_protocolView.printLine("Не удалось провести нормализацию.");
        end;
    end;
end;

class (TNormalizer_MMB) TPart3NormalizerItem1_3129(protocolView)
    initTNormalizer_MMB(protocolView);
    private var iteratorPart3    = RcbApplication().currentReport.attributeValue("РазделСправочноПункт1").createValueIterator();
    private var m_attributeItem3 = RcbApplication().currentReport.attributeValue("РазделСправочноПункт1");
    private var isNormazed       = false;

    /**
     * Сохранить строку значений.
     * @param     line    код строки
     *
     */
    private macro saveValue(line, column, value, field)
        var keyValue                  = m_attributeItem3.createKeyValue();
        keyValue.fieldValue("number") = iteratorPart3.currentItem.fieldValue("number").current;
        var lineCompositeValue        = m_attributeItem3.findValue(keyValue);
        var valueExact  = 0;
        var valueScaled = 0;
        var node        = this.node("Стр" + line + "Гр" + column);
        if (node and lineCompositeValue.fieldValue(field).exact != 0)
            valueExact  = lineCompositeValue.fieldValue(field).exact  = node.exact;
            valueScaled = lineCompositeValue.fieldValue(field).scaled = node.scaled;
        end;
        var isNormalizedValue = (    (valueExact  != null)
                                 and (valueScaled != floor(Double(valueExact) / rcbApplication.currentReport.multiplier + 0.5)));
        if (isNormalizedValue)
            m_protocolView.printSymbol(line, column, valueExact, valueScaled);
            isNormalized = true;
        end;
    end;

    /**
     * Сохранить атрибуты.
     */
    macro save()
        iteratorPart3.moveFirst();
        while (not iteratorPart3.isDone())
            saveValue(iteratorPart3.currentItem.fieldValue("number").current, "6", iteratorPart3.currentItem.fieldValue("valueOfSecurities").current, "valueOfSecurities");
            saveValue(iteratorPart3.currentItem.fieldValue("number").current, "7", iteratorPart3.currentItem.fieldValue("presentValue").current, "presentValue");
            saveValue(iteratorPart3.currentItem.fieldValue("number").current, "8", iteratorPart3.currentItem.fieldValue("madeReserve").current, "madeReserve");
            iteratorPart3.moveNext();
        end;
        m_protocolView.endPart();
    end;

    /**
     * Формирование имени узла.
     */
    private macro getName(line, column)
        return "Стр" + line + "Гр" + column;
    end;

    private macro addNode2(line, column, value)
        var node   = null;
        node       = normalizer.addNode(getName(line, column));
        node.exact = NVL(value, 0);
        node.recalculateScaled();
        return node;
    end;

    macro load()
        iteratorPart3.moveFirst();
        while (not iteratorPart3.isDone())
            var node6 = addNode2(iteratorPart3.currentItem.fieldValue("number").current, "6", iteratorPart3.currentItem.fieldValue("valueOfSecurities").exact);
            var node7 = addNode2(iteratorPart3.currentItem.fieldValue("number").current, "7", iteratorPart3.currentItem.fieldValue("presentValue").exact);
            var node8 = addNode2(iteratorPart3.currentItem.fieldValue("number").current, "8", iteratorPart3.currentItem.fieldValue("madeReserve").exact);

            var relation;

            if (    (iteratorPart3.currentItem.fieldValue("valueOfSecurities").exact >  0)
                and (iteratorPart3.currentItem.fieldValue("presentValue").exact      == 0))
                relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node6);
                relation.checkExactValue(m_protocolView);
                addRelation(relation);
            end;

            if (    (iteratorPart3.currentItem.fieldValue("presentValue").exact      >  0)
                and (iteratorPart3.currentItem.fieldValue("valueOfSecurities").exact == 0))
                relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node7);
                relation.checkExactValue(m_protocolView);
                addRelation(relation);
            end;

            if (    (iteratorPart3.currentItem.fieldValue("presentValue").exact      > 0)
                and (iteratorPart3.currentItem.fieldValue("valueOfSecurities").exact > 0))
                relation = ReportLinearRelation(RCB_RS_GREATER_OR_EQUAL);
                relation.lhs.plus(node8);
                relation.rhs.plus(0.5, node6).plus(0.5, node7);
                relation.checkExactValue(m_protocolView);
                addRelation(relation);
            end;

            iteratorPart3.moveNext();
        end;
    end;

    macro execute()
        m_protocolView.setNotIsRelErr();
        load();
        m_protocolView.endRelErrHeadPrinted();
        normalize();

        if (not m_protocolView.getIsRelErr())
            save();
        else
            m_protocolView.printLine("Не удалось провести нормализацию.");
        end;
    end;
end;