/*
$Name:          f155Attribute.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 155. Атрибуты формы.
*/

/**
 * Форма 155. Атрибут отчета.
 * 
 * @since   23.09.2008
 * @author  Ivkina Olga
 * @version 6.00.020.29
 */
import lib_lang;
import rcb_bo;

/**
 * Простейший атрибут.
 */
class TBaseAttribute(attributeValue /*: RcbCompositeValue*/, name : String)
    /**
     * Имя атрибута.
     */
    private var m_name : String;
    
    /**
     * Ссылка на составное значение атрибута.
     */
    private var m_compositeValue /*: RcbCompositeValue*/;

    /**
     * Название поля структуры.
     */
    private var m_fieldName : String;


    /**
     * Операция дополнения по структурным значениям.
     */
    macro executeAdditionOperation() : bool
        return null; /*!!!*/
    end;
    
    /**
     * Установить значение в единицах измерения.
     * 
     * @param     exactValue    значение в единицах измерения
     * @param     backOffice
     */
    macro addExactValue(exactValue : Money, backOffice : Integer) : bool
        // Спецификация:
        //     Необходимо обработать следующие ситуации:
        //     -установка значений сразу нескольких граф для одной строки.
        //     -установка значения строки, если графа не указана.
        //     
        //     Также необходимо создать графу у атрибута, если она еще не создана.

        var boValue;
        var keyColumn;
        var keyValue;

        var value = NVL(exactValue, 0);

        if ((backOffice != null) AND (backOffice > 0))
            keyValue = m_compositeValue.createKeyValue();       
            keyValue.fieldValue(m_fieldName)  = m_name;
            keyValue.fieldValue("backOffice") = BONames[backOffice];

            boValue = m_compositeValue.findValue(keyValue);

            if (boValue == null)
                boValue = m_compositeValue.addValue();
                boValue.reset();

                boValue.fieldValue(m_fieldName).exact  = m_name;
                boValue.fieldValue("backOffice").exact = BONames[backOffice];
            end;          

            boValue.fieldValue("value").exact = boValue.fieldValue("value").exact + value;
            boValue.fieldValue("value").recalculateScaled();
        else
            m_compositeValue.fieldValue("value").exact = m_compositeValue.fieldValue("value").exact + value;
            m_compositeValue.fieldValue("value").recalculateScaled();
        end;

        return this;
    end;  

    /**
     * Установить значение в единицах измерения.
     * 
     * @param     exactValue    значение в единицах измерения
     */
    macro setScaledValue(scaledValue : Money) : bool
        m_compositeValue.fieldValue("value").scaled = NVL(scaledValue, 0);
        return this;
    end;  

    /**
     * Установить значение в единицах измерения.
     * 
     * @param     exactValue    значение в единицах измерения
     */
    macro setExactValue(exactValue : Money) : bool
        m_compositeValue.fieldValue("value").exact = NVL(exactValue, 0);
        return this;
    end;  
   
    /**
     * Получить значение в единицах измерения.
     */
    macro getExactValue() : Money
        return m_compositeValue.fieldValue("value").exact;
    end;

    /**
     * Получить значение в единицах измерения.
     */
    macro getScaledValue() : Money
        return m_compositeValue.fieldValue("value").scaled;
    end;

    
    /**
     * Получить значение для печати.
     */
    macro getStringValue() : String
        return m_compositeValue.fieldValue("value").currentAsString;
    end;

    /**
     * Получить имя атрибута.
     */
    macro getName() : String
        return m_name;
    end;
    
    /**
     * Конструктор.
     * @param     attributeValue    
     * @param     name  название
     */
    private macro constructor(attributeValue /*: RcbCompositeValue*/, name : String)

        var keyValue; 
        var compositeValue; 

        /*Без разнницы какой раздел, структура одна. Но идейно это не верно*/
        var temp = RcbApplication.currentReport.attributeValue("Раздел1");
        temp.reset();
        keyValue = temp.createKeyValue();

/*!!!! долгая обработка               
        keyValue = attributeValue.createKeyValue();       
        var i = 0;
        while (i < keyValue.key.fieldsCount)
            keyValue.fieldValue(keyValue.key.fieldId(i)) = "";
            i = i + 1;
        end;
*/

        
        m_name = name;

        keyValue.fieldValue(m_fieldName) = m_name;

        compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue == null)
            compositeValue = attributeValue.addValue();

            compositeValue.reset();
            compositeValue.fieldValue(m_fieldName).exact = m_name;
        end;

        m_compositeValue = compositeValue;
    end;    

    constructor(attributeValue /*: RcbCompositeValue*/, name);
end;

/**
 * Податрибут отчета.
 */
class (TBaseAttribute) TSubAttribute(attributeValue /*: RcbCompositeValue*/, name : String)
    
    private macro constructor(attributeValue /*: RcbCompositeValue*/, name)
        m_fieldName = "column";
        initTBaseAttribute(attributeValue /*: RcbCompositeValue*/, name);
    end;

    constructor(attributeValue /*: RcbCompositeValue*/, name);
end;

/**
 * Атрибут отчета.
 */
class (TBaseAttribute) TAttribute(attributeValue /*: RcbCompositeValue*/, name : String, structureAttribute)
    
    /**
     * Податрибуты.
     */
    var m_subAttributes : TArray;

    /**
     * Создать графу у атрибута(если еще не создана).
     * 
     * @param     colunmName    название графы
     */
    macro addSubAttribute(columnName : String) /*: RcbCompositeValue*/
        return (m_subAttributes[m_subAttributes.size] = TSubAttribute(m_compositeValue, columnName));
    end;

    /**
     * Получить графу атрибута.                      
     * 
     * @param     subAttributeName    название графы отчета
     */
    macro getSubAttribute(subAttributeName : String) /*: Money*/
        var i : Integer = 0;

        while (i < m_subAttributes.size)
            if (m_subAttributes[i].getName() == subAttributeName)
                return m_subAttributes[i];
            end;            
            i = i + 1;
        end;

        return null;
    end;

    /**
     * Получить графы атрибута.                      
     * 
     */
    macro getSubAttributes() /*: Money*/
        return m_subAttributes;
    end;

   
    /**
     * Установить значение в единицах измерения.
     * 
     * @param     column    название графы отчета
     * @param     exactValue    значение в единицах измерения
     */
    macro addSubAttributeExactValue(column : String, exactValue : Money, backOffice /*: Integer*/) : bool
        // Спецификация:
        //     Необходимо обработать следующие ситуации:
        //     -установка значений сразу нескольких граф для одной строки.
        //     -установка значения строки, если графа не указана.
        //     
        //     Также необходимо создать графу у атрибута, если она еще не создана.

        var  attribute = getSubAttribute(column);

        if (not attribute)
            attribute = addSubAttribute(column);
        end;

        attribute.addExactValue(exactValue, backOffice);

        return this;
    end;

    /**
     * Добавить к значению атрибута.
     * @param     attribute    атрибут
     */
    macro plus(attribute : TAttribute) : TAttribute

        var i = 0;
        var subAttributes = attribute.getSubAttributes();

        while (i < subAttributes.size)
            addSubAttributeExactValue(subAttributes[i].getName(), subAttributes[i].getExactValue());
            i = i + 1;
        end;
                
        return this;
    end; 

    /**
     * Получить примечание.
     */
    macro getNote() : String
        return m_compositeValue.fieldValue("note").currentAsString;
    end;

    /**
     * Получить примечание.
     */
    macro setNote(note : String) : String
        return m_compositeValue.fieldValue("note").exact = note;
    end;
        
    /**
     *
     */
    private macro constructor(attributeValue /*: RcbCompositeValue*/, name : String, structureAttribute)
        m_fieldName     = "line";
        m_subAttributes = TArray();
        initTBaseAttribute(attributeValue /*: RcbCompositeValue*/, name);

        var i = 0;
        if (structureAttribute != null)
            while(i < (structureAttribute.size)) 
                m_subAttributes[i] = addSubAttribute(structureAttribute[i]);
                i = i + 1;    
            end;
        end;
    end;

    constructor(attributeValue /*: RcbCompositeValue*/, name, structureAttribute);
end;

/**
 * Пользовательские атрибуты(именно тут оказываются данные, введенные пользователем).
 */
class (TAttribute) TUserAttribute(attributeValue /*: RcbCompositeValue*/, name, structureAttribute);
    /**
     * Установить значение в единицах измерения.
     * 
     * @param     exactValue    значение в единицах измерения
     * @param     backOffice
     */
    private macro addExactValue(exactValue : Money, backOffice : Integer) : bool
        /* данная операция недоступна*/
        return null;
    end;

    initTAttribute(attributeValue /*: RcbCompositeValue*/, name, structureAttribute);
end;/**
 * Атрибут для раздела справочно.
 */    
class TAttribute2835ForPart4(attributeValue/*: RcbCompositeValue*/, attributeNumber: Integer, attributeName: String, attributeInn: String, attributeILicense: String, 
                             attributeNSecurities: Integer, attributeValueOfSecurities: Money, attributePresentValue: Money, attributeMadeReserve: Money, attributeIsNotResident: Integer)
                                 
    private var m_number            : Integer;  /* номер строки */
    private var m_name              : String;   /* наименование */
    private var m_inn               : String;   /* ИНН */
    private var m_iLicense          : String;   /* номер лицензии */
    private var m_nSecurities       : Integer;  /* количество ценных бумаг */
    private var m_valueOfSecurities : Money;    /* стоимость ценных бумаг */
    private var m_presentValue      : Money;    /* текущая стоимость */
    private var m_madeReserve       : Money;    /* сформированный резерв */
    private var m_isNotResident     : Money;    /* признак резидента */
    
    /**
     * Ссылка на составное значение атрибута.
     */
    private var m_compositeValue /*: RcbCompositeValue*/;

    /**
     * Получить значение 
     */
    macro getNumber() : Integer
        return m_compositeValue.fieldValue("number").currentAsString;
    end;

    /**
     * Получить значение 
     */
    macro getName() : String
        return m_compositeValue.fieldValue("name").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getInn() : String
        return m_compositeValue.fieldValue("inn").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getILicense() : String
        return m_compositeValue.fieldValue("iLicense").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getNSecurities() : Integer
        return m_compositeValue.fieldValue("nSecurities").current;
    end;

    /**
     * Получить значение
     */
    macro getValueOfSecurities() 
        return m_compositeValue.fieldValue("valueOfSecurities").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getPresentValue() 
        return m_compositeValue.fieldValue("presentValue").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getMadeReserve() 
        return m_compositeValue.fieldValue("madeReserve").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getIsNotResident() : Integer
        return m_compositeValue.fieldValue("isNotResident").scaled;
    end;

    /**
     * Конструктор.
     * @param     attributeValue    
     * @param     m_name               наименование            
     * @param     m_inn                ИНН                     
     * @param     m_iLicense           номер лицензии          
     * @param     m_nSecurities        количество ценных бумаг 
     * @param     m_valueOfSecurities  стоимость ценных бумаг  
     * @param     m_presentValue       текущая стоимость       
     * @param     m_madeReserve        сформированный резерв   
     * @param     m_isNotResident      признак резидента   
     */
    private macro constructor(attributeValue /*: RcbCompositeValue*/, number: Integer, name: String, inn: String, iLicense: String, nSecurities: Integer, 
                              valueOfSecurities: Money, presentValue: Money, madeReserve: Money, isNotResident: Integer)

        var keyValue; 
        var compositeValue; 

        var temp = RcbApplication.currentReport.attributeValue("РазделСправочноПункт2");
        temp.reset();
        keyValue = temp.createKeyValue();

        m_number            = number;
        m_name              = name;
        m_inn               = inn;
        m_iLicense          = iLicense;
        m_nSecurities       = nSecurities;
        m_valueOfSecurities = valueOfSecurities;
        m_presentValue      = presentValue;
        m_madeReserve       = madeReserve;
        m_isNotResident     = isNotResident;

        keyValue.fieldValue("number")              = m_number;

        compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue == null)
            compositeValue = attributeValue.addValue();

            compositeValue.reset();
            compositeValue.fieldValue("number").current          = m_number;
            compositeValue.fieldValue("name").current            = m_name;
            compositeValue.fieldValue("inn").current             = m_inn;
            compositeValue.fieldValue("iLicense").current        = m_iLicense;
            compositeValue.fieldValue("nSecurities").current     = m_nSecurities;
            compositeValue.fieldValue("valueOfSecurities").exact = m_valueOfSecurities;
            compositeValue.fieldValue("presentValue").exact      = m_presentValue;
            compositeValue.fieldValue("madeReserve").exact       = m_madeReserve;
            compositeValue.fieldValue("isNotResident").current   = m_isNotResident;

            compositeValue.fieldValue("valueOfSecurities").recalculateScaled();
            compositeValue.fieldValue("presentValue").recalculateScaled();   
            compositeValue.fieldValue("madeReserve").recalculateScaled();    
        end;

        m_compositeValue = compositeValue;
    end;    

    constructor(attributeValue /*: RcbCompositeValue*/, attributeNumber, attributeName, attributeInn, 
            attributeILicense, attributeNSecurities, attributeValueOfSecurities, attributePresentValue, attributeMadeReserve, attributeIsNotResident);
end;

class TAttribute3129ForPart4(attributeValue/*: RcbCompositeValue*/, attributeNumber: Integer, attributeName: String, attributeInn: String, attributeILicense: String, 
                             attributeNSecurities: Integer, attributeValueOfSecurities: Money, attributePresentValue: Money, attributeMadeReserve: Money, attributeIsNotResident: Integer)
                                 
    private var m_number            : Integer;  /* номер строки */
    private var m_name              : String;   /* наименование */
    private var m_inn               : String;   /* ИНН */
    private var m_iLicense          : String;   /* номер лицензии */
    private var m_nSecurities       : Integer;  /* количество ценных бумаг */
    private var m_valueOfSecurities : Money;    /* стоимость ценных бумаг */
    private var m_presentValue      : Money;    /* текущая стоимость */
    private var m_madeReserve       : Money;    /* сформированный резерв */
    private var m_isNotResident     : Money;    /* признак резидента */
    
    /**
     * Ссылка на составное значение атрибута.
     */
    private var m_compositeValue /*: RcbCompositeValue*/;

    /**
     * Получить значение 
     */
    macro getNumber() : Integer
        return m_compositeValue.fieldValue("number").currentAsString;
    end;

    /**
     * Получить значение 
     */
    macro getName() : String
        return m_compositeValue.fieldValue("name").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getInn() : String
        return m_compositeValue.fieldValue("inn").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getILicense() : String
        return m_compositeValue.fieldValue("iLicense").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getNSecurities() : Integer
        return m_compositeValue.fieldValue("nSecurities").current;
    end;

    /**
     * Получить значение
     */
    macro getValueOfSecurities() 
        return m_compositeValue.fieldValue("valueOfSecurities").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getPresentValue() 
        return m_compositeValue.fieldValue("presentValue").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getMadeReserve() 
        return m_compositeValue.fieldValue("madeReserve").currentAsString;
    end;

    /**
     * Получить значение
     */
    macro getIsNotResident() : Integer
        return m_compositeValue.fieldValue("isNotResident").scaled;
    end;

    /**
     * Конструктор.
     * @param     attributeValue    
     * @param     m_name               наименование            
     * @param     m_inn                ИНН                     
     * @param     m_iLicense           номер лицензии          
     * @param     m_nSecurities        количество ценных бумаг 
     * @param     m_valueOfSecurities  стоимость ценных бумаг  
     * @param     m_presentValue       текущая стоимость       
     * @param     m_madeReserve        сформированный резерв   
     * @param     m_isNotResident      признак резидента   
     */
    private macro constructor(attributeValue /*: RcbCompositeValue*/, number: Integer, name: String, inn: String, iLicense: String, nSecurities: Integer, 
                              valueOfSecurities: Money, presentValue: Money, madeReserve: Money, isNotResident: Integer)

        var keyValue; 
        var compositeValue; 

        var temp = RcbApplication.currentReport.attributeValue("РазделСправочноПункт1");
        temp.reset();
        keyValue = temp.createKeyValue();

        m_number            = number;
        m_name              = name;
        m_inn               = inn;
        m_iLicense          = iLicense;
        m_nSecurities       = nSecurities;
        m_valueOfSecurities = valueOfSecurities;
        m_presentValue      = presentValue;
        m_madeReserve       = madeReserve;
        m_isNotResident     = isNotResident;

        keyValue.fieldValue("number")              = m_number;

        compositeValue = attributeValue.findValue(keyValue);

        if (compositeValue == null)
            compositeValue = attributeValue.addValue();

            compositeValue.reset();
            compositeValue.fieldValue("number").current          = m_number;
            compositeValue.fieldValue("name").current            = m_name;
            compositeValue.fieldValue("inn").current             = m_inn;
            compositeValue.fieldValue("iLicense").current        = m_iLicense;
            compositeValue.fieldValue("nSecurities").current     = m_nSecurities;
            compositeValue.fieldValue("valueOfSecurities").exact = m_valueOfSecurities;
            compositeValue.fieldValue("presentValue").exact      = m_presentValue;
            compositeValue.fieldValue("madeReserve").exact       = m_madeReserve;
            compositeValue.fieldValue("isNotResident").current   = m_isNotResident;

            compositeValue.fieldValue("valueOfSecurities").recalculateScaled();
            compositeValue.fieldValue("presentValue").recalculateScaled();   
            compositeValue.fieldValue("madeReserve").recalculateScaled();    
        end;

        m_compositeValue = compositeValue;
    end;    

    constructor(attributeValue /*: RcbCompositeValue*/, attributeNumber, attributeName, attributeInn, 
            attributeILicense, attributeNSecurities, attributeValueOfSecurities, attributePresentValue, attributeMadeReserve, attributeIsNotResident);
end;

end;
