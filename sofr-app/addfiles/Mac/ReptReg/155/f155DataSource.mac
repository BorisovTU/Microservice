/*
$Name:          f155DataSource.mac
$Module:        Регламентируемая отчетность
$Description:   Формма 155. Источник данных
*/

/**
* Форма 155. Источник данных.
*
* @since   23.09.2008
* @author  Ivkina Olga
* @version 6.00.020.29
*/
import rcb_bo;
import rcb_lib;

import f155DataSourceFilters;
import f155DataSourceProtocols;

/**
* Источник данных.
*/
class TDataSource()
    private macro RcbDataSet(text, cursorLocation, cursorType, groupText)
        if (not protocolIsOn())
/*         text = strSubSt(text, "\n", " ");
            while (index(text, "  ") > 0)
                text = strSubSt(text, "  ", " ");
            end;
*/
            var cmd = RsdCommand("{ ? = CALL rep_utl.excludeFromQueryDetailedRows(?, ?) }");
            cmd.AddParam( "newText",  RSDBP_RETVAL, V_STRING, 32000);
            cmd.addParam( "",         RSDBP_IN,     text );
            cmd.addParam( "",         RSDBP_IN,     groupText );

            cmd.execute;
            text  = cmd.value( "newText" );
            cmd.close();
        end;

        return TRsbDataSet(text, cursorLocation, cursorType);

        OnError(er);
            msgbox( cmd, "Ошибка.", er.message );
            return text;
    end;

    /**
    * Бэк-офис.
    */
    private var m_backOffice : Integer;

    /**
    * Фильтр данных.
    */
    private var m_filter : TDataSourceFilter;

    /**
    * Протокол ИД.
    */
    private var m_protocol;

    /**
    * Создать фильтер.
    */
    private macro createDataSourceFilter() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceFilter"));
    end;

    /**
    * Создать протокол.
    */
    private macro createDataSourceProtocol() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceProtocol"));
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        throw (TPureVirtualMethodCallException("TDataSource::clear"));
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        throw (TPureVirtualMethodCallException("TDataSource::cacheData"));
    end;

    /**
    * Получить бэк-офис.
    */
    macro getBackOffice() : Integer
        return m_backOffice;
    end;

    /**
    * Получить фильтр.
    */
    macro getFilter() : TDataSourceFilter
        return m_filter;
    end;

    private macro constructor()
        clear();
        cacheData();

        createDataSourceFilter();
        createDataSourceProtocol();
        m_backOffice = BONothing;
    end;

    constructor();
end;

/**
* Источник данных по ГК.
*/
class (TDataSource) TCbDataSource()
    private macro constructor()
        initTDataSource();
        m_backOffice = BOCB;
    end;
    constructor();
end;

/**
* Источник данных л/с ГК.
*/
class (TCbDataSource) TCbAccountsDataSource()
    /**
    * Создать фильтер.
    */
    private macro createDataSourceFilter() : bool
        m_filter = TCbAccountDataSourceFilter();
        return true;
    end;

    /**
    * Создать протокол.
    */
    private macro createDataSourceProtocol() : bool
        m_protocol = TCbAccountDataSourceProtocol();
        return true;
    end;

    /**
    * Получение данных для строки отчета раздела 1.
    * @param     selectText             текст выборки
    * @param     accountTableText       таблица счетов
    * @param     filter                 общий фильтр на выборку
    */
    private macro getData(selectText : String, accountTableText : String, filter : String)

        var commandText = " SELECT  " +selectText
                + "\n" + "    FROM ("+accountTableText+") acc,                                                          "
                + "\n" + "         drepreserveaccount_vw  reserveacc                                                    "
                + "\n" + "   WHERE acc.t_accountid = reserveacc.t_connectAccountid(+)                                   "
                + "\n" + "     AND acc.t_chapter = 3                                                                    "
                + "\n" + "     AND acc.t_isopenedatenddate = 1                   --открыт за дату окончания о.п         "
                + "\n" + "     AND acc.t_outrest != 0                            -- имеет ненулевой остаток за дату окончания о.п                "
/*!!!          + "\n" + "     AND acc.t_chapter = 3                                                                    "
!!! бэк-офис                 + "\n" + "     AND not exists (select 1 from df115register_tmp where  t_cbaccountnumber =  acc.t_account)      "
            */  + "\n" +       ternary(filter == null, " ", filter)
                + "\n" + "GROUP BY ROLLUP ((acc.t_qualitycategory,                                                      "
                + "\n" + "                  acc.t_account,                                                              "
                + "\n" + "                  reserveacc.t_reserveaccount,                                                "
                + "\n" + "                  acc.t_accountreservepercent,                                                "
                + "\n" + "                  acc.t_maturityDate                                                          "
                + "\n" + "                 ))                                                                           "
                + "\n" + "ORDER BY GROUPING (acc.t_qualitycategory) DESC,                                               "
                + "\n" + "         acc.t_qualitycategory,                                                               "
                + "\n" + "         acc.t_account,                                                                       "
                + "\n" + "         acc.t_accountreservepercent,                                                         "
                + "\n" + "         acc.t_maturityDate                                                                   ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("accountreservepercent", V_INTEGER);

        var hasData = data.moveNext();

        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    macro getContingentLiabilitiesData(filter : String) /*: TDataSet*/
        var selectText;

        selectText =      "         acc.t_qualityCategory                                              qualityCategory,        "
                 + "\n" + "         acc.t_account                                                      account,                "
                 + "\n" + "         acc.t_accountreservepercent                                        accountreservepercent,  "
                 + "\n" + "         NVL (reserveAcc.t_reserveaCcount, ' ')                             reserveAccount,         "
                 + "\n" + "         acc.t_maturityDate                                                 maturityDate,           "
                 + "\n" + "         SUM (NVL(acc.t_outCoverRest, 0))                                        column_3,          "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 1, NVL(acc.t_outCoverRest, 0), 0))  column_4,          "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(acc.t_outCoverRest, 0), 0))  column_5,          "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(acc.t_outCoverRest, 0), 0))  column_6,          "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(acc.t_outCoverRest, 0), 0))  column_7,          "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(acc.t_outCoverRest, 0), 0))  column_8,          "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveAmount,    0))                          column_9,               "
                 + "\n" + "         SUM (NVL (acc.t_calcReserveSecAmount, 0))                          column_10,              "
                 + "\n" + "         SUM (NVL (t_endDateReserveAmount,     0))                          column_11,              "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 2, NVL(t_endDateReserveAmount, 0), 0)) column_12,      "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 3, NVL(t_endDateReserveAmount, 0), 0)) column_13,      "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 4, NVL(t_endDateReserveAmount, 0), 0)) column_14,      "
                 + "\n" + "         SUM (DECODE (acc.t_qualityCategory, 5, NVL(t_endDateReserveAmount, 0), 0)) column_15       ";

        return getData(selectText, "drepaccount_vw", filter);
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        return true;          /*!!!*/
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        return true;           /*!!!*/
    end;


    private macro constructor()
        initTCbDataSource();
    end;
    constructor();
end;

/**
* Источник данных по портфелям ГК.
*/
class (TCbDataSource) TCbCaseDataSource()
    /**
    * Создать фильтер.
    */
    private macro createDataSourceFilter() : bool
        m_filter = TCbCaseDataSourceFilter();
        return true;
    end;

    /**
    * Создать протокол.
    */
    private macro createDataSourceProtocol() : bool
        m_protocol = TCbCaseDataSourceProtocol();
        return true;
    end;

    /**
    * Получение данных для строки отчета раздела 1.
    * @param     queryText              текст выборки
    * @param     filter                 общий фильтр на выборку
    */
    private macro getData(queryText : String, filter : String)
        var commandText = queryText
                + "\n" + "GROUP BY ROLLUP ((case.t_caseId),                      "
                + "\n" + "                 (case.t_endDateQualityCategory,       "
                + "\n" + "                  case.t_name,                         "
                + "\n" + "                  subCase.t_reserveAccount,            "
                + "\n" + "                  case.t_endDateReservePercent,        "
                + "\n" + "                  subCase.t_number                     "
                + "\n" + "                   ))                                  "
                + "\n" + "ORDER BY GROUPING (case.t_caseId) DESC,                "
                + "\n" + "                   case.t_caseId,                      "
                + "\n" + "                   GROUPING (subCase.t_number),        "
                + "\n" + "                   subCase.t_number                    ";

        var data = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    /**
    * Текст запроса.
    *
    */
    private macro queryText(filter : String) : String
        return           "SELECT   NVL (case.t_endDateQualityCategory, ' ')                                    qualityCategory,  "
                + "\n" + "         case.t_caseId                                                               id,               "
                + "\n" + "         NVL (case.t_name, ' ')                                                      name,             "
                + "\n" + "         subCase.t_number                                                            subNumber,        "
                + "\n" + "         NVL (subCase.t_reserveAccount, ' ')                                         reserveAccount,   "
                + "\n" + "         case.t_endDateReservePercent                                                reservePercent,   "
                + "\n" + "         SUM (NVL(subCase.t_outCoverRest, 0))                                        column_3,         "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 1, NVL(subCase.t_outCoverRest, 0), 0))  column_4, "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 2, NVL(subCase.t_outCoverRest, 0), 0))  column_5, "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 3, NVL(subCase.t_outCoverRest, 0), 0))  column_6, "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 4, NVL(subCase.t_outCoverRest, 0), 0))  column_7, "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 5, NVL(subCase.t_outCoverRest, 0), 0))  column_8, "
                + "\n" + "         SUM (NVL (subCase.t_calcReserveAmount,    0))                               column_9,         "
                + "\n" + "         SUM (NVL (subCase.t_calcReserveSecAmount, 0))                               column_10,        "
                + "\n" + "         SUM (NVL (subCase.t_reserveAmount,        0))                               column_11,        "
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 2, NVL(subCase.t_reserveAmount, 0), 0)) column_12,"
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 3, NVL(subCase.t_reserveAmount, 0), 0)) column_13,"
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 4, NVL(subCase.t_reserveAmount, 0), 0)) column_14,"
                + "\n" + "         SUM (DECODE (case.t_endDateQualityCategory, 5, NVL(subCase.t_reserveAmount, 0), 0)) column_15 "
                + "\n" + "    FROM drepcase_vw case,                                                                             "
                + "\n" + "         drepSubCase_vw subCase                                                                        "
                + "\n" + "   WHERE case.t_caseId = subCase.t_caseId                                                              "
/*!!!!*///                 + "\n" + "     AND case.t_chapter = 3                                                                           "
                + "\n" + "     AND case.t_outCoverRest  != 0 -- имеет ненулевой остаток за дату окончания о.п                    "
                + "\n" +       NVL(filter, "");
    end;

    /**
    *
    *
    */
    macro getContingentLiabilitiesData(filter : String) /*: TDataSet*/
        return getData(queryText(filter));
    end;

    /**
    *
    *
    */
    private var m_otherCaseData = null;

    macro getOtherCaseContingentLiabilitiesData(filter : String) /*: TDataSet*/
        var commandText;
        var hasData;

        if (m_otherCaseData == null)
            commandText = queryText(filter)
                + "\n" + "GROUP BY ROLLUP (                                      "
                + "\n" + "                 (case.t_caseId,                       "
                + "\n" + "                  case.t_endDateQualityCategory,       "
                + "\n" + "                  case.t_name,                         "
                + "\n" + "                  case.t_endDateReservePercent),       "
                + "\n" + "                 (subCase.t_number,                    "
                + "\n" + "                  subCase.t_reserveAccount)            "
                + "\n" + "                 )                                     "
                + "\n" + "HAVING case.t_caseId is not null                       "
                + "\n" + "ORDER BY case.t_caseId,                                "
                + "\n" + "         GROUPING (subCase.t_number),                  "
                + "\n" + "         subCase.t_number                              ";

            m_otherCaseData = RcbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC,
                                        "subCase.t_number, subCase.t_reserveAccount");

        end;

        hasData = m_otherCaseData.moveNext();

        m_protocol.printOtherCaseProtocol(m_otherCaseData, not m_otherCaseData.EOF); /*протокол оcуществляет проход по одному портфелю*/

        return m_otherCaseData;
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        return true;
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        return true;
    end;

    private macro constructor()
        initTCbDataSource();
    end;

    constructor();
end;

/*******************************************************************************************************/
/**
* Источник данных по Loans.
*/
class (TDataSource) TLoansDataSource()
    private macro constructor()
        initTDataSource();
        m_backOffice = BOLoans;
    end;
    constructor();
end;

/**
* Источник данных по договорам Loans
*/
class (TLoansDataSource) TLoansCreditDataSource()
    /**
    * Создать фильтер.
    */
    private macro createDataSourceFilter() : bool
        m_filter = TLoansCreditDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = TLoansCreditDataSourceProtocol();
        return true;
    end;

    private macro getData(selectText : String)
        selectText = selectText
                + "\n" + "                 GROUP BY ROLLUP ((credit.t_number,                                 "
                + "\n" + "                                   credit.t_type,                                   "
                + "\n" + "                                   credit.t_riskgroup,                              "
                + "\n" + "                                   credit.t_rvpreservepercent,                      "
                + "\n" + "                                   credit.t_finishdate),                            "
                + "\n" + "                  (REGISTER.t_type, regName.t_name)                                 "
                + "\n" + "                 )                                                                  "
                + "\n" + "  ORDER BY GROUPING (credit.t_number) DESC,                                         "
                + "\n" + "                     credit.t_riskgroup,                                            "
                + "\n" + "                     credit.t_number,                                               "
                + "\n" + "                     credit.t_rvpreservepercent,                                    "
                + "\n" + "                     GROUPING (register.t_type),                                    "
                + "\n" + "                     creditnumber                                                   ";

        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("finishdate", V_DATE);
        data.SetFieldType("t_rvpreservepercent", V_INTEGER);

        var hasData = data.moveNext();

        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    private macro reserveSelectText(riskGroup : Integer)
        return           " CASE                                                                        "
                + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 1  "
                + "\n" + "        THEN MAX (DECODE (credit.t_riskgroup,                                "
                + "\n" + "                          "+riskGroup+", t_rvpSum,                           "
                + "\n" + "                          0))                                                "
                + "\n" + "     WHEN GROUPING (REGISTER.t_type) = 1 AND GROUPING (credit.t_number) = 0  "
                + "\n" + "        THEN MAX (DECODE (credit.t_riskgroup,                                "
                + "\n" + "                          "+riskGroup+", t_reserveAmount,                    "
                + "\n" + "                          0                                                  "
                + "\n" + "                         )                                                   "
                + "\n" + "                        )                                                    "
                + "\n" + "     ELSE 0                                                                  "
                + "\n" + " END                                                                         ";
    end;

    macro getContingentLiabilitiesData(filter : String) /*: TDataSet*/
        var filter1 = StrSubst ( filter, "credit", "c");

        var creditTable = "(SELECT c1.*,                                                    "
                 + "\n" + "      SUM (c1.t_reserveAmount)                                   "
                 + "\n" + "      OVER (PARTITION BY c1.t_riskgroup) t_rvpSum                "
                 + "\n" + "      FROM (SELECT DISTINCT c.*,                                 "
                 + "\n" + "        c.t_rvpamount   t_reserveAmount                          "
                 + "\n" + "            FROM df155credit_tmp c,                              "
                 + "\n" + "                 df155register_tmp register,                     "
                 + "\n" + "                 dspr_reg_dbt      regName                       "
                 + "\n" + "            WHERE c.t_trancheKind (+)= register.t_trancheKind     "
                 + "\n" + "                  AND c.t_trancheNumber (+)= register.t_trancheNumber "
                 + "\n" + "                  AND regName.t_regid (+)= register.t_type       "
                 + "\n" + "                 " + NVL(filter1, " ")
                 + "\n" + "                  AND register.t_rest != 0) c1)                  ";

        var commandText = "SELECT register.t_type                                                  registerType,       "
                 + "\n" + "       regName.t_name                                                   registerKind,       "
                 + "\n" + "       credit.t_finishDate                                              finishDate,         "
                 + "\n" + "       credit.t_riskgroup                                               riskgroup,          "
                 + "\n" + "       credit.t_rvpreservepercent                                       t_rvpreservepercent,"
                 + "\n" + "       SUM (register.t_rest)                                            column_3,           "
                 + "\n" + "       SUM (case                                                                            "
                 + "\n" + "               when credit.t_riskgroup = 1                                                  "
                 + "\n" + "                  then register.t_rest                                                      "
                 + "\n" + "               else 0                                                                       "
                 + "\n" + "            end)                                                        column_4,           "
                 + "\n" + "       SUM (case                                                                            "
                 + "\n" + "               when credit.t_riskgroup = 2                                                  "
                 + "\n" + "                  then register.t_rest                                                      "
                 + "\n" + "               else 0                                                                       "
                 + "\n" + "            end)                                                        column_5,           "
                 + "\n" + "       SUM (case                                                                            "
                 + "\n" + "               when credit.t_riskgroup = 3                                                  "
                 + "\n" + "                  then register.t_rest                                                      "
                 + "\n" + "               else 0                                                                       "
                 + "\n" + "            end)                                                        column_6,           "
                 + "\n" + "       SUM (case                                                                            "
                 + "\n" + "               when credit.t_riskgroup = 4                                                  "
                 + "\n" + "                  then register.t_rest                                                      "
                 + "\n" + "               else 0                                                                       "
                 + "\n" + "            end)                                                        column_7,           "
                 + "\n" + "       SUM (case                                                                            "
                 + "\n" + "               when credit.t_riskgroup = 5                                                  "
                 + "\n" + "                  then register.t_rest                                                      "
                 + "\n" + "               else 0                                                                       "
                 + "\n" + "            end)                                                        column_8,           "
                 + "\n" + "       SUM (NVL(credit.t_rvpreservepercent * register.t_rest *0.01, 0)) column_9,           "
                 + "\n" + "       SUM (NVL(t_calculatedRvpAmount, 0))                              column_10,          "
                 + "\n" + "       SUM (NVL(t_reserveAmount, 0))                                    column_11,          "
                 + "\n" + "       "+reserveSelectText(2)+"                                         column_12,          "
                 + "\n" + "       "+reserveSelectText(3)+"                                         column_13,          "
                 + "\n" + "       "+reserveSelectText(4)+"                                         column_14,          "
                 + "\n" + "       "+reserveSelectText(5)+"                                         column_15,          "
                 + "\n" + "       credit.t_number                                                  creditNumber,       "
                 + "\n" + "       case credit.t_type                                                                   "
                 + "\n" + "           when "+LO_CREDIT+   " then 'Кредит'                                              "
                 + "\n" + "           when "+LO_OVERDRAFT+" then 'Овер'                                                "
                 + "\n" + "           when "+LO_KARTA+    " then 'Овер'                                                "
                 + "\n" + "           when "+LO_GUARANTEE+" then 'Гарантия'                                            "
                 + "\n" + "       end                                                              creditType          "
                 + "\n" + "  FROM "+creditTable+"   credit,                                                            "
                 + "\n" + "       df155register_tmp register,                                                          "
                 + "\n" + "       dspr_reg_dbt      regName                                                            "
                 + "\n" + " WHERE credit.t_trancheKind   = register.t_trancheKind                                      "
                 + "\n" + "   AND credit.t_trancheNumber = register.t_trancheNumber                                    "
                 + "\n" + "   AND regName.t_regid        = register.t_type                                             "
                 + "\n" + "   AND register.t_rest       != 0                                                           "
                 + "\n" + "   AND credit.t_riskgroup IN (1, 2, 3, 4, 5)                                                "
                 + "\n" + "       " + NVL(filter, " ");

        return getData(commandText);
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df155credit_tmp");
        sql_execute("TRUNCATE TABLE df155register_tmp");
        return true;
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        clear();

        var querySource =   "SELECT t_id   AS a_creditNumber,"
                   + "\n" + "       t_type AS a_type         "
                   + "\n" + "  FROM repLnsContract_vw"
                   + "\n" + " WHERE t_portfolioDebtId   = 0                            "
                   + "\n" + "   AND t_isopenedAtEndDate = 1                            "
                   + "\n" + "   AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId");

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);

        command.execute();

        sql_execute(" INSERT INTO df155credit_tmp  (t_calculatedRvpAmount,                                                    "
           + "\n" + "                               t_finishDate,                                                             "
           + "\n" + "                               t_id,                                                                     "
           + "\n" + "                               t_trancheKind,                                                            "
           + "\n" + "                               t_trancheNumber,                                                          "
           + "\n" + "                               t_number,                                                                 "
           + "\n" + "                               t_riskGroup,                                                              "
           + "\n" + "                               t_rvpReservePercent,                                                      "
           + "\n" + "                               t_rvpAmount,                                                              "
           + "\n" + "                               t_type,                                                                   "
           + "\n" + "                               t_issueType)                                                              "
           + "\n" + "                        SELECT reserve.t_calcRvpSum,                                                     "
           + "\n" + "                               t_finishdate,                                                             "
           + "\n" + "                               contract.t_id,                                                            "
           + "\n" + "                               contract.t_type,                                                          "
           + "\n" + "                               contract.t_id,                                                            "
           + "\n" + "                               contract.t_number,                                                        "
           + "\n" + "                               contract.t_rvpQualityCategory,                                            "
           + "\n" + "                               contract.t_rvpReservePercent,                                             "
           + "\n" + "                               reserve.t_rvpSum,                                                         "
           + "\n" + "                               contract.t_type,                                                          "
           + "\n" + "                               contract.t_issueType                                                      "
           + "\n" + "                          FROM repLnsContract_vw contract,                                               "
           + "\n" + "                               repLnsReserve_vw  reserve                                                 "
           + "\n" + "                         WHERE contract.t_id   = reserve.t_objectNumber                                  "
           + "\n" + "                           AND contract.t_type = reserve.t_objectTypeid                                  "
           + "\n" + "                           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId")
           + "\n" + "                     UNION ALL                                                                           "
           + "\n" + "                        SELECT DISTINCT tranche.t_calcRvpIssGuar,                                        "
           + "\n" + "                               tranche.t_plannedLastRepaymentDate,                                       "
           + "\n" + "                               contract.t_id,                                                            "
           + "\n" + "                               tranche.t_kind,                                                           "
           + "\n" + "                               tranche.t_number,                                                         "
           + "\n" + "                               contract.t_number,                                                        "
           + "\n" + "                               contract.t_rvpQualityCategory,                                            "
           + "\n" + "                               contract.t_rvpReservePercent,                                             "
           + "\n" + "                               tranche.t_rvpIssGuar,                                                     "
           + "\n" + "                               contract.t_type,                                                          "
           + "\n" + "                               contract.t_issueType                                                      "
           + "\n" + "                          FROM repLnsContract_vw contract,                                               "
           + "\n" + "                               repLnsTranches_vw tranche                                                 "
           + "\n" + "                         WHERE contract.t_issueType         = " + CF_GUARANTEELINE /*Гарантийная линия*/
           + "\n" + "                           AND contract.t_type              = " + LO_GUARANTEE
           + "\n" + "                           AND tranche.t_isFictive          = 0                                          "
           + "\n" + "                           AND tranche.t_contractId         = contract.t_id                              "
           + "\n" + "                           AND contract.t_portfolioDebtId   = 0                                          "
           + "\n" + "                           AND contract.t_isopenedAtEndDate = 1                                          "
           + "\n" + "                           AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId")
           );

        sql_execute(" INSERT INTO df155register_tmp (t_creditId,            "
           + "\n" + "                                t_trancheKind,         "
           + "\n" + "                                t_trancheNumber,       "
           + "\n" + "                                t_type,                "
           + "\n" + "                                t_rest)                "
           + "\n" + "                        SELECT  reg.t_tranchenumber,   "
           + "\n" + "                                reg.t_trancheKind,     "
           + "\n" + "                                reg.t_trancheNumber,   "
           + "\n" + "                                reg.t_type,            "
           + "\n" + "                                reg.t_roubleRest       "
           + "\n" + "                          FROM repLnsRegister_vw reg   "
           + "\n" + "                         WHERE reg.t_type IN ("+TCLTR_LIMPAY+","+TDR_PAYEDGUARANTEE+","+TCLTR_LIMDUTY+","+TDR_NOLIMGUAR+")"
           + "\n" + "                           AND EXISTS(SELECT 1 FROM df155credit_tmp c WHERE reg.t_trancheNumber = c.t_trancheNumber AND reg.t_trancheKind = c.t_trancheKind)");

         return true;
    end;

    private macro constructor()
        initTLoansDataSource();
    end;
    constructor();
end;

/**
* Источник данных по портфелям Loans
*/
class (TLoansDataSource) TLoansCaseDataSource()
    /**
    * Создать фильтер.
    */
    private macro createDataSourceFilter() : bool
        m_filter = TLoansCaseDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = TLoansCaseDataSourceProtocol();
        return null;
    end;

    private macro getData(selectText : String)
        selectText = selectText
                + "\n" + "                 GROUP BY ROLLUP ((case.t_number, case.t_riskgroup))             "
                + "\n" + "  ORDER BY GROUPING (case.t_number) DESC,                                      "
                + "\n" + "                     case.t_number                                               ";


        var data = RcbDataSet(selectText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        m_protocol.printProtocol(data, hasData);

        data.moveFirst();

        return data;
    end;

    macro getContingentLiabilitiesData(filter : String) /*: TDataSet*/
        var commandText = "SELECT case.t_number                                            caseNumber,"
                 + "\n" + "       case.t_riskgroup                                         riskgroup, "
                 + "\n" + "       SUM (case.t_demandsRest)                                 column_3,  "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 1                                   "
                 + "\n" + "                  then case.t_demandsRest                                  "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_4,  "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 2                                   "
                 + "\n" + "                  then case.t_demandsRest                                  "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_5,  "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 3                                   "
                 + "\n" + "                  then case.t_demandsRest                                  "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_6,  "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 4                                   "
                 + "\n" + "                  then case.t_demandsRest                                  "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_7,  "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 5                                   "
                 + "\n" + "                  then case.t_demandsRest                                  "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_8,  "
                 + "\n" + "       SUM (case.t_reservePercent / 100 * case.t_demandsRest)   column_9,  "
                 + "\n" + "       SUM (t_calcReserveAmount)                                column_10, "
                 + "\n" + "       SUM (t_reserveAmount )                                   column_11, "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 2                                   "
                 + "\n" + "                  then case.t_reserveAmount                                "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_12, "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 3                                   "
                 + "\n" + "                  then case.t_reserveAmount                                "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_13, "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 4                                   "
                 + "\n" + "                  then case.t_reserveAmount                                "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_14, "
                 + "\n" + "       SUM (case                                                           "
                 + "\n" + "               when case.t_riskgroup = 5                                   "
                 + "\n" + "                  then case.t_reserveAmount                                "
                 + "\n" + "               else 0                                                      "
                 + "\n" + "            end)                                                column_15  "
                 + "\n" + "  FROM df155case_tmp case                                                  "
                 + "\n" + " WHERE 1 = 1                                                               "
                 + "\n" + "       " + NVL(filter, " ");

        return getData(commandText);
    end;

    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df155case_tmp");
        return true;
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        sql_execute("INSERT INTO df155case_tmp (t_number,               "
        + "\n" +    "                           t_id,                   "
        + "\n" +    "                           t_riskGroup,            "
        + "\n" +    "                           t_demandsRest,          "
        + "\n" +    "                           t_reservePercent,       "
        + "\n" +    "                           t_calcReserveAmount,    "
        + "\n" +    "                           t_reserveAmount,        "
        + "\n" +    "                           t_creditType)           "
        + "\n" +    "SELECT t_number,                                   "
        + "\n" +    "       t_id,                                       "
        + "\n" +    "       t_qualityCategory,                          "
        + "\n" +    "       t_demandsRest,                              "
        + "\n" +    "       t_reservePercent,                           "
        + "\n" +    "       t_calcReserveSum,                           "
        + "\n" +    "       t_reserveSum,                               "
        + "\n" +    "       nvl ((select c.t_type                       "
        + "\n" +    "               from repLnsContract_vw c            "
        + "\n" +    "              where c.t_portfolioDebtId = case.t_id"
        + "\n" +    "                and rownum < 2),0 )                "
        + "\n" +    " FROM repLnsCase_vw case                           "
        + "\n" +    "WHERE t_type = 0                                   "
        + "\n" +    "  AND (t_demandsRest + t_delayedDebtRest) <> 0     "
        + "\n" +    "  AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId"));

        return true;
    end;

    private macro constructor()
        initTLoansDataSource();
    end;

    constructor();
end;

class (TLoansCaseDataSource) TLoansCaseDataSource_41_1_3_8_728()
    initTLoansCaseDataSource();

    macro cacheData() : bool
        sql_execute("INSERT INTO df155case_tmp (t_number,               "
        + "\n" +    "                           t_id,                   "
        + "\n" +    "                           t_riskGroup,            "
        + "\n" +    "                           t_demandsRest,          "
        + "\n" +    "                           t_reservePercent,       "
        + "\n" +    "                           t_calcReserveAmount,    "
        + "\n" +    "                           t_reserveAmount,        "
        + "\n" +    "                           t_calcRezSum_nlg,    "
        + "\n" +    "                           t_rezSum_nlg,        "
        + "\n" +    "                           t_creditType)           "
        + "\n" +    "SELECT t_number,                                   "
        + "\n" +    "       t_id,                                       "
        + "\n" +    "       t_qualityCategory,                          "
        + "\n" +    "       t_demandsRest,                              "
        + "\n" +    "       t_reservePercent,                           "
        + "\n" +    "       t_calcReserveSum,                           "
        + "\n" +    "       t_reserveSum,                               "
        + "\n" +    "       t_calcRezSum_nlg,                           "
        + "\n" +    "       t_rezSum_nlg,                               "
        + "\n" +    "       nvl ((select c.t_type                       "
        + "\n" +    "               from repLnsContract_vw c            "
        + "\n" +    "              where c.t_portfolioDebtId = case.t_id"
        + "\n" +    "                and rownum < 2),0 )                "
        + "\n" +    " FROM repLnsCase_vw case                           "
        + "\n" +    "WHERE t_type = 0                                   "
        + "\n" +    "  AND (t_demandsRest + t_delayedDebtRest) <> 0     "
        + "\n" +    "  AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("t_departmentId", "t_branchId"));

        return true;
    end;

    //выборка остатков по регистрам определенного вида
    macro getSumByRegisters(registers)
        var m_registers : String;
        var temp;
        var i = 1;

        if (GetParm(i, temp))
            m_registers = String(temp);
            i = i + 1;
            while (GetParm(i, temp))
                m_registers = m_registers + ", " + String(temp);
                i = i + 1;
            end;
        else
            m_registers = "-1";
        end;

        //на всякий случай проверяем
        if (in(StrUpr(m_registers), "UNDEFINED", ""))
           m_registers = "-1";
        end;

        return "(SELECT NVL(SUM(r.t_rest), 0)             "
        +"\n"+ "   FROM repLnsContract_vw c,              "
        +"\n"+ "        repLnsRegister_vw r               "
        +"\n"+ "  WHERE c.t_portfolioDebtId = case.t_id   "
        +"\n"+ "    AND r.t_trancheNumber   = c.t_id      "
        +"\n"+ "    AND r.t_type IN (" + m_registers + "))";
    end;

    //в колонки 4-8 выбираем только регистры с видом TDR_NOLIMGUAR (167 - Неиспользованный лимит гарантии)
    macro getContingentLiabilitiesData(filter : String) /*: TDataSet*/
        var commandText = "SELECT case.t_number                                         caseNumber,"
                 + "\n" + "       'Портфель неиспользуемых гарантийных линий'           name,      "
                 + "\n" + "       case.t_riskgroup                                      riskgroup, "
                 + "\n" + "       SUM (case.t_demandsRest)                              column_3,  "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 1                                "
                 + "\n" + "                  then " + getSumByRegisters(TDR_NOLIMGUAR)
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end     )                                        column_4,  "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 2                                "
                 + "\n" + "                  then " + getSumByRegisters(TDR_NOLIMGUAR)
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_5,  "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 3                                "
                 + "\n" + "                  then " + getSumByRegisters(TDR_NOLIMGUAR)
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_6,  "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 4                                "
                 + "\n" + "                  then " + getSumByRegisters(TDR_NOLIMGUAR)
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_7,  "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 5                                "
                 + "\n" + "                  then " + getSumByRegisters(TDR_NOLIMGUAR)
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_8,  "
                 + "\n" + "       SUM (case.t_reservePercent / 100 * " + getSumByRegisters(TDR_NOLIMGUAR) + ")      column_9,  "
                 + "\n" + "       SUM (t_calcRezSum_nlg)                                column_10, "
                 + "\n" + "       SUM (t_reserveAmount )                                column_11, "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 2                                "
                 + "\n" + "                  then case.t_rezSum_nlg                                "
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_12, "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 3                                "
                 + "\n" + "                  then case.t_rezSum_nlg                                "
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_13, "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 4                                "
                 + "\n" + "                  then case.t_rezSum_nlg                                "
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_14, "
                 + "\n" + "       SUM (case                                                        "
                 + "\n" + "               when case.t_riskgroup = 5                                "
                 + "\n" + "                  then case.t_rezSum_nlg                                "
                 + "\n" + "               else 0                                                   "
                 + "\n" + "            end)                                             column_15  "
                 + "\n" + "  FROM df155case_tmp case                                               "
                 + "\n" + " WHERE 1 = 1                                                            "
                 + "\n" + "   " + NVL(filter, " ");

        return getData(commandText);
    end;
end;

/**
* Даннае пользовательского ввода.
*/
class (TDataSource) TUserDataSourceBase()
    /**
    * Очистить закешированные данные.
    */
    macro clear() : bool
        return true;
    end;

    /**
    * Кешировать данные.
    */
    macro cacheData() : bool
        return true;
    end;

    private macro createDataSourceFilter() : bool
        m_filter = TUserDataSourceFilter();
        return true;
    end;

    private macro createDataSourceProtocol() : bool
        m_protocol = TUserDataSourceProtocol();
        return true;
    end;

    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     partName  Раздел.
    * @param     attributeName Атрибут(строка).
    */
    macro getUserAttributeValue(partName : String, attributeName : String) : Money
        return null;
    end;
    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     attributeName Атрибут(строка).
    */
    private macro getData(compositeValue, attributeName : String, columnName : String)
        var lineKeyValue;
        var lineCompositeValue;

        lineKeyValue = compositeValue.createKeyValue();
        lineKeyValue.fieldValue("line")     = attributeName;
        lineKeyValue.fieldValue("column")   = NVL(columnName, "");

        lineCompositeValue = compositeValue.findValue(lineKeyValue);

        if ((lineCompositeValue == null) or (lineCompositeValue.fieldValue("value").isUndefined()))
            return 0;
        end;

        return lineCompositeValue.fieldValue("value").exact;
    end;
end;

class (TUserDataSourceBase) TUserDataSource()
    private var m_rcbCompositeValue2;
    private var m_rcbCompositeValue3;
    private var m_rcbCompositeValue4;

    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     attributeName Атрибут(строка).
    */
    macro getPart2Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                                + getData(m_rcbCompositeValue2, attributeName, "3") + " column_3 ,"
                                + getData(m_rcbCompositeValue2, attributeName, "4") + " column_4 ,"
                                + getData(m_rcbCompositeValue2, attributeName, "5") + " column_5 ,"
                                + getData(m_rcbCompositeValue2, attributeName, "6") + " column_6 ,"
                                + getData(m_rcbCompositeValue2, attributeName, "7") + " column_7  "
                                + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);;
        data.moveNext();
        return data;
    end;

    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     attributeName Атрибут(строка).
    */
    macro getPart3Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                            + getData(m_rcbCompositeValue3, attributeName, "3") + " column_3 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "4") + " column_4 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "5") + " column_5 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "6") + " column_6 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "7") + " column_7  "
                            + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);
        data.moveNext();
        return data;
    end;

    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     attributeName Атрибут(строка).
    */
    macro getPart4Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                            + getData(m_rcbCompositeValue4, attributeName, "1") + " column_1 "
                            + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);
        data.moveNext();
        return data;
    end;

    private macro constructor()
        initTDataSource();
        m_backOffice = BOUser;

        m_rcbCompositeValue2  = RcbApplication().currentReport.attributeValue("ПользовательскийВводРаздел2");
        m_rcbCompositeValue3  = RcbApplication().currentReport.attributeValue("ПользовательскийВводРаздел3");
        m_rcbCompositeValue4  = RcbApplication().currentReport.attributeValue("ПользовательскийВводРазделСпр");
    end;

    constructor();
end;

/**
* Даннае пользовательского ввода.
*/
class (TUserDataSource) TUserDataSource2742()
    initTUserDataSource();

    macro getPart3Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                            + getData(m_rcbCompositeValue3, attributeName, "3") + " column_3 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "4") + " column_4 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "5") + " column_5 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "6") + " column_6 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "7") + " column_7 ,"
                            + getData(m_rcbCompositeValue3, attributeName, "8") + " column_8  "
                            + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);
        data.moveNext();
        return data;
    end;
end;

/**
* Даннае пользовательского ввода.
*/
class (TUserDataSourceBase) TUserDataSource3129()
    private var m_rcbCompositeValue2;
    private var m_rcbCompositeValue3;

    private macro constructor()
        initTDataSource();
        m_backOffice = BOUser;

        m_rcbCompositeValue2  = RcbApplication().currentReport.attributeValue("ПользовательскийВводРаздел2");
        m_rcbCompositeValue3  = RcbApplication().currentReport.attributeValue("ПользовательскийВводРазделСпр");
    end;

    macro getPart2Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                            + getData(m_rcbCompositeValue2, attributeName, "3") + " column_3 ,"
                            + getData(m_rcbCompositeValue2, attributeName, "4") + " column_4 ,"
                            + getData(m_rcbCompositeValue2, attributeName, "5") + " column_5 ,"
                            + getData(m_rcbCompositeValue2, attributeName, "6") + " column_6  "
                            + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);
        data.moveNext();
        return data;
    end;

    /**
    * Получить значение пользовательского атрибута(в единицах нац. валюты).
    *
    * @param     attributeName Атрибут(строка).
    */
    macro getPart3Data(attributeName : String)
        m_protocol.printProtocol();
        var data = RcbDataSet(" SELECT "
                            + getData(m_rcbCompositeValue3, attributeName, "1") + " column_1 "
                            + " FROM dual ", RSDVAL_CLIENT, RSDVAL_STATIC);
        data.moveNext();
        return data;
    end;

    initTUserDataSourceBase();
    constructor();
end;

/**
* Данные Раздела "Справочно".
*/
class (TCbAccountsDataSource) TCbAccountsDataSourcePart4_3006()
    initTCbAccountsDataSource();

    macro getPart4Item3(filter : String)
        var commandText = " SELECT SUM(NVL(t_outCoverRest, 0)) column_1"
                + "\n" + "    FROM drepaccount_vw acc"
                + "\n" + "   WHERE acc.t_isopenedatenddate = 1"
                + "\n" + "     AND acc.t_outCoverRest > 0"
                + "\n" +       ternary(filter == null, " ", filter);

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        data.moveFirst();

        return data;
    end;

    macro getPart4Item4(filter : String)
        var commandText = " SELECT SUM(NVL(t_endDateReserveAmount, 0)) column_1"
                + "\n" + "    FROM drepaccount_vw acc,"
                + "\n" + "         drepreserveaccount_vw  reserveacc"
                + "\n" + "   WHERE acc.t_accountid = reserveacc.t_connectAccountid(+)"
                + "\n" + "     AND acc.t_isopenedatenddate = 1"
                + "\n" + "     AND acc.t_outCoverRest > 0"
                + "\n" +       ternary(filter == null, " ", filter);

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        data.moveFirst();

        return data;
    end;
end;

class (TCbAccountsDataSource) TCbAccountsDataSourcePart3_3129()
    initTCbAccountsDataSource();

    macro getPart3Item2(filter : String)
        var commandText = " SELECT SUM(NVL(t_outCoverRest, 0)) column_1"
                + "\n" + "    FROM drepaccount_vw acc"
                + "\n" + "   WHERE acc.t_isopenedatenddate = 1"
                + "\n" + "     AND acc.t_outCoverRest > 0"
                + "\n" +       ternary(filter == null, " ", filter);

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        data.moveFirst();

        return data;
    end;

    macro getPart3Item3(filter : String)
        var commandText = " SELECT SUM(NVL(t_endDateReserveAmount, 0)) column_1"
                + "\n" + "    FROM drepaccount_vw acc,"
                + "\n" + "         drepreserveaccount_vw  reserveacc"
                + "\n" + "   WHERE acc.t_accountid = reserveacc.t_connectAccountid(+)"
                + "\n" + "     AND acc.t_isopenedatenddate = 1"
                + "\n" + "     AND acc.t_outCoverRest > 0"
                + "\n" +       ternary(filter == null, " ", filter);

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var hasData = data.moveNext();

        data.moveFirst();

        return data;
    end;
end;

/**
* Источник данных л/с ГК по 2835.
*/
class TCbAccountsDataSource2835()
    CONST RCB_ILICENSE    = 9,
          RCB_NSECURITIES = 52,
          RCB_DEPOSITORY  = 56;

    macro getProtocolDataSource()
        return TPart4Item2DataSourceProtocol();
    end;

    /**
    * Получение данных для раздела справочно строка 2
    * @param     filter1                 фильтр на выборку
    * @param     filter2                 фильтр на выборку
    */
    macro getData(filter1 : String, filter2 : String)
        var report;

        global.initializeRepDataPackage();

        var commandText =     "SELECT "
              + "\n" +    "    data.t_account               AS t_account,"
              + "\n" +    "    SUM(DISTINCT data.t_outrest) AS t_outrest,"
              + "\n" +    "    data.t_reserveaccount        AS t_reserveaccount,"
              + "\n" +    "    SUM(data.t_reserveoutrest)   AS t_madeReserve,"
              + "\n" +    "    data.t_name                  AS t_name,"
              + "\n" +    "    data.t_inn                   AS t_inn,"
              + "\n" +    "    data.t_iLicense              AS t_iLicense,"
              + "\n" +    "    SUM(data.t_nSecurities)      AS t_nSecurities,"
              + "\n" +    "    CASE"
              + "\n" +    "        WHEN GROUPING(data.t_name) = 0 AND GROUPING(data.t_account) = 1"
              + "\n" +    "            THEN 1"
              + "\n" +    "            ELSE 0"
              + "\n" +    "    END                                 AS t_total,"
              + "\n" +    "    data.t_isNotResident                AS t_isNotResident,"
              + "\n" +    "    sum(data.t_valueOfSecurities)       AS t_valueOfSecurities,"
              + "\n" +    "    sum(data.t_presentValue)            AS t_presentValue"
              + "\n" +    "FROM"
              + "\n" +    "    (SELECT"
              + "\n" +    "        account.t_account        AS t_account,"
              + "\n" +    "        account.t_outrest        AS t_outrest,"
              + "\n" +    "        account.t_objectId       AS t_objectid,"
              + "\n" +    "        account.t_reserveaccount AS t_reserveaccount,"
              + "\n" +    "        reserve.t_outrest        AS t_reserveoutrest,"
              + "\n" +    "        objLink.t_attrId         AS t_attrId,"
              + "\n" +    "        party.t_shortname        AS t_name,"
              + "\n" +    "        CASE "
              + "\n" +    "            WHEN party.t_isResident = 0 OR party.t_isResident = null "
              + "\n" +    "            THEN  NVL((party.t_countryCode), 0)"
              + "\n" +    "        ELSE NVL((codes.t_code), 0)"
              + "\n" +    "        END AS t_inn,"
              + "\n" +    "        CASE"
              + "\n" +    "            WHEN party.t_isResident != 0"
              + "\n" +    "               THEN CASE WHEN license.t_text IS NULL"
              + "\n" +    "                  THEN '0'"
              + "\n" +    "               ELSE rsb_struct.getString(license.t_text) END"
              + "\n" +    "           ELSE ''"
              + "\n" +    "        END                      AS t_iLicense,"
              + "\n" +    "        CASE"
              + "\n" +    "            WHEN securities.t_text IS NULL"
              + "\n" +    "                THEN 0"
              + "\n" +    "                ELSE rsb_struct.getInt(securities.t_text)"
              + "\n" +    "        END                      AS t_nSecurities,"
              + "\n" +    "        CASE"
              + "\n" +    "            WHEN party.t_isResident = 1"
              + "\n" +    "                THEN 0"
              + "\n" +    "            WHEN party.t_isResident = 0"
              + "\n" +    "                THEN 1"
              + "\n" +    "        END                      AS t_isNotResident,"
              + "\n" +    "        CASE"
              + "\n" +    "            WHEN (account.t_account LIKE '91311%')"
              + "\n" +    "                THEN CASE"
              + "\n" +    "                     WHEN ( rsi_rsb_reserve.IsAccountSumReserveCalcUser(account.t_account, account.t_chapter, account.t_fiId, "
                                                                                                   + getSqlDate(RcbApplication.currentReport.context.period.endDate) + ") != 0)"
              + "\n" +    "                             THEN account.t_outRest"
              + "\n" +    "                     ELSE rsi_rsb_reserve.GetAccountElemCalcBasicReserve(account.t_account, account.t_chapter, account.t_fiId, "
                                                                                                    + getSqlDate(RcbApplication.currentReport.context.period.endDate) + ")"
              + "\n" +    "                         END"
              + "\n" +    "                ELSE 0"
              + "\n" +    "        END                      AS t_valueOfSecurities,"
              + "\n" +    "        CASE"
              + "\n" +    "            WHEN (account.t_account LIKE '91314%')"
              + "\n" +    "                THEN account.t_outRest"
              + "\n" +    "                ELSE 0"
              + "\n" +    "        END AS t_presentValue"
              + "\n" +    "    FROM"
              + "\n" +    "        (SELECT"
              + "\n" +    "            account.t_account        AS t_account,"
              + "\n" +    "            account.t_outrest        AS t_outrest,"
              + "\n" +    "            account.t_fiId           AS t_fiId,"
              + "\n" +    "            account.t_chapter        AS t_chapter,"
              + "\n" +    "            account.t_objectid       AS t_objectid,"
              + "\n" +    "            account.t_isOpened       AS t_isOpened,"
              + "\n" +    "            reserve.t_reserveaccount        AS t_reserveaccount,"
              + "\n" +    "            account.t_accountReservePercent AS t_accountReservePercent"
              + "\n" +    "        FROM"
              + "\n" +    "            dRepAccount_vw account,"
              + "\n" +    "            dRepReserveAccount_vw reserve"
              + "\n" +    "        WHERE"
              + "\n" +    "            reserve.t_connectaccountid = account.t_accountid"
              + "\n" +    "            AND account.t_outrest > 0) account,"
              + "\n" +    "        dRepAccount_vw reserve,"
              + "\n" +    "        dRepAccount_vw providingAccount,"
              + "\n" +    "        dObjLink_dbt objLink,"
              + "\n" +    "        dObjLink_dbt objLinkProvidingAccount, -- счет обеспечения"
              + "\n" +    "        dRepParty_vw party,                   -- наименование"
              + "\n" +    "        dRepPartyCodes_vw codes,              -- ИНН"
              + "\n" +    "        dnotetext_dbt license,                -- номер лицензии"
              + "\n" +    "        dnotetext_dbt securities             -- количество цб"
              + "\n" +    "    WHERE"
              + "\n" +    "        account.t_reserveaccount = reserve.t_account"
              + "\n" +    "        AND account.t_isOpened = 1"
              + "\n" +    "        AND (" + filter1
              + "\n" +    "        OR  " + filter2 +")"
              + "\n" +    "        AND NOT EXISTS"
              + "\n" +    "            (SELECT"
              + "\n" +    "                repcategory.t_id,"
              + "\n" +    "                repcategory.t_value,"
              + "\n" +    "                repcategory.t_objectId"
              + "\n" +    "            FROM"
              + "\n" +    "                dRepCategory_vw repcategory"
              + "\n" +    "            WHERE"
              + "\n" +    "                 repcategory.t_id                        = 23"
              + "\n" +    "                 AND repcategory.t_objectid              = reserve.t_objectid"
              + "\n" +    "                 AND repcategory.t_value                != 2"
              + "\n" +    "                 AND repcategory.t_isInstalledForEndDate = 1"
              + "\n" +    "                 AND repcategory.t_isForAccount          = 1)"
              + "\n" +    "        AND objLink.t_validFromDate     <= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND objLink.t_validToDate       >= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND objLink.t_objectType        = " + RCB_OBJTYPE_ACCOUNT
              + "\n" +    "        AND objLink.t_attrType          = " + RCB_OBJTYPE_PARTY
              + "\n" +    "        AND objLink.t_GroupID           = " + RCB_DEPOSITORY
              + "\n" +    "        AND objLink.t_objectId          = account.t_objectId"
              + "\n" +    "        AND PARTY.T_ID(+)               = objLink.t_attrid"
              + "\n" +    "        AND CODES.t_partyid(+)          = party.t_id "
              + "\n" +    "        AND codes.t_codekind(+)         = 16"
              + "\n" +    "        AND license.t_date(+)           <= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND license.t_validToDate(+)    >= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND license.t_objectType(+)     = " + RCB_OBJTYPE_PARTY
              + "\n" +    "        AND license.t_noteKind(+)       = " + RCB_ILICENSE
              + "\n" +    "        AND license.t_documentId(+)     = party.t_id"
              + "\n" +    "        AND securities.t_date(+)        <= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND securities.t_validToDate(+) >= " + getSqlDate(RcbApplication.currentReport.context.period.endDate)
              + "\n" +    "        AND securities.t_objectType(+)  = " + RCB_OBJTYPE_ACCOUNT
              + "\n" +    "        AND securities.t_noteKind(+)    = " + RCB_NSECURITIES
              + "\n" +    "        AND securities.t_documentId(+)  = account.t_objectId"
              + "\n" +    "        AND objLinkProvidingAccount.t_objectId(+)    = reserve.t_objectId"
              + "\n" +    "        AND objLinkProvidingAccount.t_attrType(+)    = " + RCB_OBJTYPE_ACCOUNT
              + "\n" +    "        AND objLinkProvidingAccount.t_groupId(+) BETWEEN 34 AND 43"
              + "\n" +    "        AND objLinkProvidingAccount.t_attrId         = providingAccount.t_objectId(+)"
              + "\n" +    "    ORDER BY"
              + "\n" +    "        objLink.t_attrId) data"
              + "\n" +    "GROUP BY ROLLUP"
              + "\n" +    "    ((data.t_name,    data.t_iLicense, data.t_inn, data.t_isNotResident),"
              + "\n" +    "     (data.t_account, data.t_outrest,  data.t_reserveaccount,"
              + "\n" +    "      data.t_reserveoutrest, data.t_iLicense, data.t_nSecurities, data.t_presentValue))"
              + "\n" +    "HAVING"
              + "\n" +    "    GROUPING(data.t_iLicense) = 0"
              + "\n" +    "ORDER BY"
              + "\n" +    "    data.t_name, data.t_account";

        var commandText2 =
                          "SELECT dep.t_name                t_name,"
              + "\n" +    "           dep.t_id                  t_id,"
              + "\n" +    "           dep.t_inn                 t_inn,"
              + "\n" +    "           dep.t_license             t_iLicense,"
              + "\n" +    "           dep.t_numberOfSecurities  t_nSecurities,"
              + "\n" +    "           dep.t_sumMadeReserve      t_madeReserve,"
              + "\n" +    "           dep.t_valueOfSecurities   t_valueOfSecurities,"
              + "\n" +    "           NULL                      t_presentValue,"
              + "\n" +    "           CASE"
              + "\n" +    "               WHEN party.t_isResident = 1"
              + "\n" +    "                   THEN 0"
              + "\n" +    "               WHEN party.t_isResident = 0"
              + "\n" +    "                   THEN 1"
              + "\n" +    "           END                       t_isNotResident,"
              + "\n" +    "           1                         t_total"
              + "\n" +    "       FROM repLnsUnReliableDepository_vw dep, drepparty_vw party"
              + "\n" +    "      WHERE dep.t_id = party.t_id"
              + "\n" +    "        AND EXISTS("
              + "\n" +    "                     SELECT 1"
              + "\n" +    "                        FROM repLnsContract_vw contract, repLnsGuaranty_vw guaranty"
              + "\n" +    "                       WHERE contract.t_isOpenedAtEndDate = 1 AND contract.t_id = guaranty.t_contractId"
              + "\n" +    "                         AND EXISTS(SELECT 1"
              + "\n" +    "                                       FROM dens_crd_dbt rfcrd, -- Связь договора обеспечения с объектом обеспечения"
              + "\n" +    "                                            decn_eob_dbt rf,    -- Связь договора обеспечения с кредитным документом"
              + "\n" +    "                                            densobj_dbt oo      -- Объект обеспечения"
              + "\n" +    "                                      WHERE rfcrd.t_creditnumber_ref = guaranty.t_contractId AND rfcrd.t_enscontractId_ref = rf.t_enscontractId_ref"
              + "\n" +    "                                        AND oo.t_ensObjectId = rf.t_ensobjectId_ref AND dep.t_id = oo.t_depository)"
              + "\n" +    "                         AND EXISTS(SELECT 1 FROM drepdepartment_tmp department WHERE contract.t_branchId = department.t_code)"
              + "\n" +    "                  )";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        var m_protocol = getProtocolDataSource();
        m_protocol.printProtocol(data);

        if (data.moveNext())
            data.movePrev();
            return data;
        end;

        data = TRsbDataSet(commandText2, RSDVAL_CLIENT, RSDVAL_STATIC);

        return data;
    end;
end;

/**
* Источник данных л/с ГК по 3468
*/
class (TCbAccountsDataSource2835) TCbAccountsDataSource3468()
    initTCbAccountsDataSource2835();

    macro getProtocolDataSource()
        return TPart4Item2DataSourceProtocol_3468();
    end;
end;