/*───────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                  R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расшифровки формы 110 по Loans.
└───────────────────────────────────────────────────────────────────────────*/
import calc_f110, lib_loan;
 
// Класс вывода в протокол для расшифровок по Loans.
private CLASS( CLogger110 ) CCreditLogger
    InitCLogger110();

    AddColumn( "Номер договора", "Credit", 25 );            // Второй параметр фиктивный - не используется
    AddColumn( "Сумма, вошедшая в расчёт", "Rest", 16 );
END;

private var creditLogger = CCreditLogger;

private class( CCharacteristic110 ) CCharCreditSpecial1( name_ )

    macro process()
        startProcessing();
        var calcValue : Money = $0;
        var tranche   = factory.getObject("RcbTranche1122_110");
        var beginDate = date(1,1)-1;
        var endDate   = ДатаОтчета-1;

        tranche.setParmValue("BeginDate", string(beginDate:f));
        tranche.setParmValue("EndDate",   string(endDate:f));

        tranche.setFilter( "issueDate <= " + endDate + " and (repaymentDate >= " + beginDate + " or repaymentDate < issueDate)"+
                          " AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("FNCash", "TerritorialStruct"));
        tranche.ApplyFilter();

        while (tranche.next())
            calcValue = min(tranche.restSum, tranche.expenseSum);
            result    = result + calcValue;
            logger.printStringTransferByWord( tranche.creditNumberForReport, calcValue );
            IsEmpty = false;
        end;
        finishProcessing();       
    end;

    initcCharacteristic110( name_, BOLoans, creditLogger, "Rest" );    
end;

private class( CCharacteristic110 ) CCharCreditSpecial2( name_, dataSet : Object)
    private var m_dataSet = dataSet;

    macro process()
        startProcessing();
        var calcValue : Money = $0;
        var tranche   = factory.getObject("RcbTranche1124_110");
        var beginDate = date(1,1)-1;
        var endDate   = ДатаОтчета-1;

        tranche.setParmValue("BeginDate", string(beginDate:f));
        tranche.setParmValue("EndDate",   string(endDate:f));

        tranche.setFilter( "issueDate <= " + endDate + " and (repaymentDate >= " + beginDate + " or repaymentDate < issueDate)"+
                          " AND " + RcbBranchAndDepartmentFieldFilter().GetAsSqlString("FNCash", "TerritorialStruct"));
        tranche.ApplyFilter();

        while (tranche.next())
            calcValue = min(tranche.restSum, tranche.expenseSum);
            result    = result + calcValue;
            logger.printStringTransferByWord( tranche.creditNumberForReport, calcValue );
            IsEmpty = false;
        end;
        finishProcessing();
    end;

    initCCharacteristic110( name_, BOLoans, creditLogger, "Rest" );
end;

// Регистрация расшифровок.
macro RegisterLoansCharacteristics()

    if( U_1660 )
      if( isQuartal )
       charProcessor.register(CCharCreditSpecial1("1122_К_"), 50);
       charProcessor.register(CCharCreditSpecial2("1124"), 52);
      end;
    else
      if( isQuartal )
       charProcessor.register(CCharCreditSpecial1("1122_К_"), 47);
       charProcessor.register(CCharCreditSpecial2("1124"), 49);
      end;
    end;

end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
macro processLoans()
    var boSwitch  = TBackOfficeSwitch("Форма 110", TBackOffice(BOLOANS));
    if (boSwitch.isOn())
        registerLoansCharacteristics();
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/
processLoans();

