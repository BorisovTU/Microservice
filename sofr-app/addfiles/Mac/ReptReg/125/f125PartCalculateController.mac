/*
$Name:        f125PartCalculateController.mac
$Module:      Регламентируемая отчетность
$Description: Контроллер расчета раздела
*/
/**
 * Форма 125. Контроллер расчета части.
 *
 * @since   13.04.2008
 * @author  Ivkina Olga
 * @version 6.00.020.29
 */
import SbCrdInter;
import testLib;

const POSITIVE_REVALUATION = 51;   // Положительная переоценка
const NEGATIVE_REVALUATION = 52;   // Отрицательная переоценка

/**
 * Класс для хранения зависимостей атрибутов, по сути просто контейнер, содержащий ссылки на атрибуты, от которых зависит рассчитываемый атрибут
 *
 *  @param     dependetAttributePool   список объектов от которых зависит расчет текущего значения
 *  @param     dimensionDependences    размерность зависимостей: exact или scaled. используется при расчете
 */
class (RcbDependencesData) T125DependencesData(dependetAttributePool : RcbArray, dimensionDependences)
    private var m_dependetAttributesOperationPool : RcbArray = nvl(dependetAttributePool, RcbArray());
    private var m_dimensionDependences            : Integer  = nvl(dimensionDependences, 0);


    dependetAttributePool.moveFirst();
    while (dependetAttributePool.moveNext())
        m_dependetAttributePool.push_back(dependetAttributePool.getCurrentItem()(0));
    end;

    macro getDependentAttributeOperationPool() : RcbArray
        return m_dependetAttributesOperationPool;
    end;

    macro getDimensionDependences() : Integer
        return m_dimensionDependences;
    end;

    /**
     * @param     attribute
     */
    macro addAttribute(attribute : RcbAttributeBase, operation) : RcbDependencesData
        m_dependetAttributePool.push_back(attribute);
        m_dependetAttributesOperationPool.push_back(TArray(attribute, operation));
        return this;
    end;
end;

/**
 * Набор данных для расчета одного атрибута
 */
class (RcbCalculationAttributeData) T125CalculationAttributeData(attribute /*: RcbAttributeBase*/, calculationDataPool /*: RcbArray*/, dependencesData /*: RcbDependencesData*/)
    initRcbCalculationAttributeData(attribute, NVL(calculationDataPool, RcbArray()), dependencesData);
    m_dependencesData = nvl(dependencesData, T125DependencesData());

    macro addAttributeValue(data /*: TDataSet*/)
        if (data != null)
            m_attribute.addSubAttributeValue(  "2", NVL(data.column2,  0));
            m_attribute.addSubAttributeValue(  "3", NVL(data.column3,  0));
            m_attribute.addSubAttributeValue(  "4", NVL(data.column4,  0));
            m_attribute.addSubAttributeValue(  "5", NVL(data.column5,  0));
            m_attribute.addSubAttributeValue(  "6", NVL(data.column6,  0));
            m_attribute.addSubAttributeValue(  "7", NVL(data.column7,  0));
            m_attribute.addSubAttributeValue(  "8", NVL(data.column8,  0));
            m_attribute.addSubAttributeValue(  "9", NVL(data.column9,  0));
            m_attribute.addSubAttributeValue( "10", NVL(data.column10, 0));
            m_attribute.addSubAttributeValue( "11", NVL(data.column11, 0));
        end;
    end;

    macro addFromUserInput(str : String)
        var iterator = m_attribute.getPart().m_userAttributeValue.createValueIterator();
        iterator.moveFirst();

        while (not iterator.isDone())
            if (iterator.currentItem.fieldValue("line").currentAsString == str)
                    m_attribute.addSubAttributeValue("2",  NVL(iterator.currentItem.fieldValue("column2" ).exact,  0));
                    m_attribute.addSubAttributeValue("3",  NVL(iterator.currentItem.fieldValue("column3" ).exact,  0));
                    m_attribute.addSubAttributeValue("4",  NVL(iterator.currentItem.fieldValue("column4" ).exact,  0));
                    m_attribute.addSubAttributeValue("5",  NVL(iterator.currentItem.fieldValue("column5" ).exact,  0));
                    m_attribute.addSubAttributeValue("6",  NVL(iterator.currentItem.fieldValue("column6" ).exact,  0));
                    m_attribute.addSubAttributeValue("7",  NVL(iterator.currentItem.fieldValue("column7" ).exact,  0));
                    m_attribute.addSubAttributeValue("8",  NVL(iterator.currentItem.fieldValue("column8" ).exact,  0));
                    m_attribute.addSubAttributeValue("9",  NVL(iterator.currentItem.fieldValue("column9" ).exact,  0));
                    m_attribute.addSubAttributeValue("10", NVL(iterator.currentItem.fieldValue("column10").exact,  0));
                    m_attribute.addSubAttributeValue("11", NVL(iterator.currentItem.fieldValue("column11").exact,  0));

                return;
            end;
            iterator.moveNext();
        end;
    end;
end;

/**
 * Контроллер расчета.
 */
class (RcbPartCalculateController) T125PartCalculateController(reportCalculateController /*: RcbReportCalculateController*/)
    initRcbPartCalculateController(reportCalculateController, 0);
    /**
     * Настроечная таблица.
     */
    private var m_tuneTable = objectFactoryInstance.createTuneTable();
    private var row13byEndOfTermContract;
    private var accruedInterest;

    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 125/СТР.13 ПО СРОКУ ОКОНЧ. ДОГОВОРА", V_BOOL, row13byEndOfTermContract, null);
    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ", V_BOOL, accruedInterest, null);

    /*1 */
    private macro getCalculateCashAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1. Денежные средства", dataSource.getBackOffice().getId()))))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1(1). Денежные средства в КО", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1), 1, true)));

    end;
    /*2 */
    private macro getCalculateInvestmentsOfSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2. Вложения в торговые ценные бумаги", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1))));
    end;
    /*3 */
    private macro getCalculateLoanDebtsAssets(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        var userDataSource = m_dataSources.getDataSource("user");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                     addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("3"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3. Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1) +
                                                                               dataSource.getFilter().isExcludedAccount()))).
/*!!!!проверка отключенного бэк-офиса*/
                                      addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData"),
                                                         RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(1)+
                                                                               loansDataSource.getFilter().hasRegisterType(TDR_EXPREST,
                                                                                                                           TDR_OV,
                                                                                                                           TDR_EXPPAYMGUARANTEE,
                                                                                                                           TDR_EXPPERC,
                                                                                                                           TDR_EXPPERC_OV,
                                                                                                                           TDR_CLAIM,
                                                                                                                           TDR_PAYMGUARANTEEEXPPERC)
                                                                              , accruedInterest)));
    end;
    /*4 */
    private macro getCalculateSoldSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4. Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1) +
                                                                               dataSource.getFilter().securitiesAcquisitionPurpose("ПП"))));
    end;
    /*5 */
    private macro getCalculateKeptSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5. Вложения в инвестиционные ценные бумаги", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1) +
                                                                               dataSource.getFilter().securitiesAcquisitionPurpose("ИП"))));

    end;
    /*6 */
    private macro getCalculateOtherAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var userDataSource = m_dataSources.getDataSource("user");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("6"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("6. Прочие активы", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1) +
                                                                               dataSource.getFilter().isExcludedAccount())));
    end;
    /*7 */
    private macro getCalculateAssetsTotalSum(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("1"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("2"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("3"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("4"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("5"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("6"), PLUS)),
                                                                SCALED));
    end;

    /*8 */
    private macro getCalculateLendingAgencysMeansLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var userDataSource = m_dataSources.getDataSource("user");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("8"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("8. Средства кредитных организаций", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isBankContragent())));
    end;
    /*9 */
    private macro getCalculateClientsMeans(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("9.1"), PLUS)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9. Средства клиентов", dataSource.getBackOffice().getId())) +
/*!!!!*/                                                                       dataSource.getFilter().isNotBankContragent())));
                                      /*dataSource.getFilter().isNotLendingAgencyClient()));*/
    end;
    /*9.1*/
    private macro getCalculatePhysicalClientsMeans(attributeId : String)
        var cbDataSource     = m_dataSources.getDataSource("CbAccount");
        var retailDataSource = m_dataSources.getDataSource("retailDeposit");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1. Вклады физических лиц", cbdataSource.getBackOffice().getId()))/* +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail)*/))).
/*!!!!проверка отключенного бэк-офиса*/                                      addCalculationData(RcbCalculationData(r2m(retailDataSource, "getData")));
    end;

    /*10 */
    private macro getCalculateIssuedDebtInstrumentsLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("10. Выпущенные долговые обязательства", dataSource.getBackOffice().getId())))));
    end;
    /*11 */
    private macro getCalculateOtherLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var depositDataSource = m_dataSources.getDataSource("loansDeposit");

        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("11. Прочие обязательства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("11(1). Прочие обязательства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount() +
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'РЕПО'"))));

        if (not accruedInterest)
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                 RcbArray().initialize(depositDataSource.getFilter().hasRegisterType(TDR_DEPOPERC), false, NULL, "12, 14")));
        end;

        return calcAttributeData;
    end;
    /*12 */
    private macro getCalculateLiabilitiesTotalSum(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute( "8"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute( "9"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("10"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("11"), PLUS)),
                                                                SCALED));
    end;

    /*13 */
    private macro getCalculateIssuedGuaranteesAndLiabilityOffBalance(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("13. Внебалансовые обязательства и гарантии выданные", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount(), 1, row13byEndOfTermContract))).
/*!!!!проверка отключенного бэк-офиса*/
                                      addCalculationData(RcbCalculationData(r2m(loansDataSource, "getIssuedGuaranteesAndLiabilityData"),
                                                         RcbArray().initialize(NULL, row13byEndOfTermContract)));

    end;

    /*14 */
    private macro getCalculateLiquiditysOverplus(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute( "7"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("12"), MINUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("13"), MINUS)),
                                                                SCALED));
    end;
    /*15 */
    private macro getCalculateLiquiditysOverplusIndex(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("14"), PLUS),
                                                                                      RcbArray().initialize(100, MULTIPLY),
                                                                                      RcbArray().initialize(m_part.getAttribute("12"), PARTITION)),
                                                                SCALED));
    end;

    /**
     * Выполнение расчета.
     */
    macro execute()
        println("Значение настроек, используемых при расчете:");
        println("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ                      " + string(accruedInterest));
        println("REPTREG/REP_GROUPS/ФОРМА 125/СТР.13 ПО СРОКУ ОКОНЧ. ДОГОВОРА          " + string(row13byEndOfTermContract));

        m_reportCalculateController.addCalculationAttributeData( getCalculateCashAssets                   ("1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateInvestmentsOfSecuritiesAssets("2"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLoanDebtsAssets              ("3"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateSoldSecuritiesAssets         ("4"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateKeptSecuritiesAssets         ("5"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherAssets                  ("6"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateAssetsTotalSum               ("7"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateLendingAgencysMeansLiabilities  ("8"));
        m_reportCalculateController.addCalculationAttributeData( getCalculatePhysicalClientsMeans            ("9.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateClientsMeans                    ("9"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateIssuedDebtInstrumentsLiabilities("10"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherLiabilities                ("11"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLiabilitiesTotalSum             ("12"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateIssuedGuaranteesAndLiabilityOffBalance("13"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateLiquiditysOverplus     ("14"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLiquiditysOverplusIndex("15"));
    end;

    /**
     * Инициализация.
     */
    macro initialize() : Bool
        return true;
    end;
end;
/**
 * Контроллер расчета.
 */
class (T125PartCalculateController) T125PartCalculateController2332(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController(reportCalculateController, 0);

    /*2 */
    private macro getCalculateInvestmentsOfSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2. Вложения в ценные бумаги, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1)))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(1). Вложения в ценные бумаги, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1)+
                                                                              dataSource.getFilter().hasAssignedAccountCategory("'СС'"))));
    end;
    /*3 */
    private macro getCalculateLoanDebtsAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return getCalculateLoanDebtsAssets(attributeId).
               addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                  RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3(1) Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                        dataSource.getFilter().hasRiskGroup(1))));
    end;
    /*4 */
    private macro getCalculateSoldSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4. Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4(1). Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(1)+
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'ПР'"))));
    end;
    /*5 */
    private macro getCalculateKeptSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5. Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5(1). Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(1)+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'СС'")+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'ПР'"))));
    end;

    /*9 */
    private macro getCalculateClientsMeans(attributeId : String)
        var dataSource        = m_dataSources.getDataSource("CbAccount");
        var depositDataSource = m_dataSources.getDataSource("loansDeposit");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("9.1"), PLUS)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9. Средства клиентов", dataSource.getBackOffice().getId()))/* +
/*!!!!*/                                                                       dataSource.getFilter().isNotBankContragent()*/))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9(1). Средства клиентов", dataSource.getBackOffice().getId())) +
/*!!!!*/                                                                       dataSource.getFilter().isNotBankContragent()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9(2). Средства клиентов", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'S'"))));
        if (accruedInterest)
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                         RcbArray().initialize(depositDataSource.getFilter().hasRegisterTypeForDepositType(TDR_DEPOHIST, "", TDR_DEPOPERC, "13, 15"), true, TDR_DEPOHIST)));
        else
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                         RcbArray().initialize(depositDataSource.getFilter().hasRegisterType(TDR_DEPOHIST), false)));
        end;

        return calcAttributeData;
    end;
    /*9.1 */
    private macro getCalculatePhysicalClientsMeans(attributeId : String)
        var cbDataSource     = m_dataSources.getDataSource("CbAccount");
        var retailDataSource = m_dataSources.getDataSource("retailDeposit");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1. Вклады физических лиц", cbdataSource.getBackOffice().getId()))/* +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail)*/))).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1(1). Вклады физических лиц", cbdataSource.getBackOffice().getId())) +
                                                                               cbDataSource.getFilter().isPhysicalContragent() /*+
                                                                               dataSource.getFilter().isExcludedAccount(BORetail)*/))).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1(2). Вклады физических лиц", cbdataSource.getBackOffice().getId())) +
                                                                               cbDataSource.getFilter().hasAssignedAccountCategory("'S'")))).
/*!!!!проверка отключенного бэк-офиса*/addCalculationData(RcbCalculationData(r2m(retailDataSource, "getData")));

    end;

    /*10 */
    private macro getCalculateIssuedDebtInstrumentsLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("10. Выпущенные долговые обязательства", dataSource.getBackOffice().getId()))))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("10(1). Выпущенные долговые обязательства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'S'"))));
    end;
end;
/**
 * Контроллер расчета.
 */
class (T125PartCalculateController2332) T125PartCalculateController2835(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController2332(reportCalculateController, 0);

    /*2 */
    private macro getCalculateInvestmentsOfSecuritiesAssets(attributeId : String)
        var isSubtraction = -1;
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2. Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1)))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(1). Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1)+
                                                                              dataSource.getFilter().hasAssignedAccountCategory("'СС'")))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(2). Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1), isSubtraction)));

    end;
end;

class (T125PartCalculateController2835) T125PartCalculateController2926(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController2835(reportCalculateController, 0);

    /*2 */
    private macro getCalculateInvestmentsOfSecuritiesAssets(attributeId : String)
        var isSubtraction = -1;
        var dataSource    = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow2"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2. Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1) +
                                                                              dataSource.getFilter().checkNotBalance("'50121','50621'") +
                                                                              dataSource.getFilter().op("AND") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2. Финансовые активы, оцениваемые по справедливой стоимости")), 1, false))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow2"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(1). Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1) +
                                                                              dataSource.getFilter().checkNotBalance("'50121','50621'") +
                                                                              dataSource.getFilter().hasAssignedAccountCategory("'СС'") +
                                                                              dataSource.getFilter().op("AND (") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2. Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op("AND") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2(1). Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op(")"),
                                                                              1, false))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow2"),
                                                        RcbArray().initialize(dataSource.getFilter().checkBalance("'50121','50621'")+
                                                                              dataSource.getFilter().hasRiskGroup(1) +
                                                                              dataSource.getFilter().isNotRevaluation(POSITIVE_REVALUATION, "'50118','50618'") +
                                                                              dataSource.getFilter().op("AND") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2. Финансовые активы, оцениваемые по справедливой стоимости")), 1, false))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow2"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(2). Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1) +
                                                                              dataSource.getFilter().isNotRevaluation(NEGATIVE_REVALUATION, "'50118','50618'") +
                                                                              dataSource.getFilter().op("AND (") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2. Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op("AND") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2(2). Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op(")"),
                                                                              isSubtraction, false))).
                                     addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow2_Revaluation"),
                                                        RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("2(3). Финансовые активы, оцениваемые по справедливой стоимости", dataSource.getBackOffice().getId()))+
                                                                              dataSource.getFilter().hasRiskGroup(1) +
                                                                              dataSource.getFilter().op("AND (") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2. Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op("AND") +
                                                                              getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "2(3). Финансовые активы, оцениваемые по справедливой стоимости")) +
                                                                              dataSource.getFilter().op(")"),
                                                                              1, true)));
    end;
end;



class (T125PartCalculateController2926) T125PartCalculateController2922(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController2926(reportCalculateController, 0);

    /* 1 */
    private macro getCalculateCashAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_2922"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1. Денежные средства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasNotBalance202()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_2922"),
                                                         RcbArray().initialize(dataSource.getFilter().hasBalance202(), 1, false, true))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_2922"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1(1). Денежные средства в КО", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1), 1, true)));
    end;

end;

class (T125PartCalculateController2922) T125PartCalculateController2926_2(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController2922(reportCalculateController, 0);

    /* 1.1 */
    private macro getCalculateCashAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow11"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1(1). Денежные средства в КО", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2) +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1(1). Денежные средства в КО")), 1)));
    end;

    /* 1_1 */
    private macro getCalculateCashAssets1_1(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1. Денежные средства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasNotBalance202() +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1. Денежные средства"))))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().hasBalance202() +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1(1). Денежные средства в КО")), 1, false, true))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1(1). Денежные средства в КО", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1) +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1(1). Денежные средства в КО")), 1, true)
                                                                           )
                                                        );
    end;

    /* 1 = 1_1 + 1.1 */
    private macro getCalculateCashAssetsTotal(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("1.1"), PLUS),
                                                                                      RcbArray().initialize(ternary(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1. Денежные средства"), m_part.getAttribute("1_1"), null), PLUS))));
    end;

    /* 3.1 */
    private macro getCalculateLoanDebtsAssets(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        var userDataSource = m_dataSources.getDataSource("user");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("3.1"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3. Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2) +
                                                                               dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3(1) Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2))));

        if (m_tuneTable.hasDataFor(loansDataSource.getBackOffice(), "3. Ссудная и приравненная к ней задолженность"))
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData31"),
                                                         RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(2),
                                                                               loansDataSource.getFilter().hasRegisterType(TDR_EXPREST,
                                                                                                                           TDR_OV,
                                                                                                                           TDR_EXPPERC,
                                                                                                                           TDR_EXPPERC_OV,
                                                                                                                           TDR_CLAIM),
                                                                               accruedInterest,
                                                                               loansDataSource.getFilter().hasCreditType(LO_CREDIT,
                                                                                                                         LO_OVERDRAFT,
                                                                                                                         LO_KARTA)))).
                              addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData31"),
                                                         RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(2),
                                                                               loansDataSource.getFilter().hasRegisterType(TDR_EXPPAYMGUARANTEE,
                                                                                                                               TDR_PAYMGUARANTEEEXPPERC,
                                                                                                                               TDR_PAYMGUARANTEEPERCDEM),
                                                                               accruedInterest,
                                                                               loansDataSource.getFilter().hasCreditType(LO_GUARANTEE))));
        end;

        return calcAttributeData;
    end;

    /* 3_1 */
    private macro getCalculateLoanDebtsAssets3_1(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                          addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                             RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3. Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                                   dataSource.getFilter().hasRiskGroup(1) +
                                                                                   dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                                   dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                                   dataSource.getFilter().isExcludedAccount(BORetail)))).
                                           addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                              RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3(1) Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                                    dataSource.getFilter().hasRiskGroup(1))));

        if (m_tuneTable.hasDataFor(loansDataSource.getBackOffice(), "3. Ссудная и приравненная к ней задолженность"))
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData"),
                                                             RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(1),
                                                                                   loansDataSource.getFilter().hasRegisterType(TDR_EXPREST,
                                                                                                                               TDR_OV,
                                                                                                                               TDR_EXPPERC,
                                                                                                                               TDR_EXPPERC_OV,
                                                                                                                               TDR_CLAIM),
                                                                                   accruedInterest,
                                                                                   loansDataSource.getFilter().hasCreditType(LO_CREDIT,
                                                                                                                             LO_OVERDRAFT,
                                                                                                                             LO_KARTA)))).
                              addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData"),
                                                             RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(1),
                                                                                   loansDataSource.getFilter().hasRegisterType(TDR_EXPPAYMGUARANTEE,
                                                                                                                               TDR_PAYMGUARANTEEEXPPERC,
                                                                                                                               TDR_PAYMGUARANTEEPERCDEM),
                                                                                   accruedInterest,
                                                                                   loansDataSource.getFilter().hasCreditType(LO_GUARANTEE))));
        end;

        return calcAttributeData;
    end;

    /* 3 */
    private macro getCalculateLoanDebtsAssetsTotal(attributeId : String)
        var userDataSource = m_dataSources.getDataSource("user");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("3.1"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("3_1"), PLUS)))).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("3"),
                                                                               userDataSource.getBackOffice().getId())));
    end;

    /* 4.1 */
    private macro getCalculateSoldSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4. Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4(1). Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(2)+
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'ПР'"))));
    end;

    /* 4_1 */
    private macro getCalculateSoldSecuritiesAssets4_1(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4. Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("4(1). Ценные бумаги, имеющиеся в наличии для продажи", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(1)+
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'ПР'"))));
    end;

    /* 4 */
    private macro getCalculateSoldSecuritiesAssetsTotal(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("4.1"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("4_1"), PLUS))));
    end;

    /* 5.1 */
    private macro getCalculateKeptSecuritiesAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5. Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5(1). Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(2)+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'СС'")+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'ПР'"))));
    end;

    /* 5_1 */
    private macro getCalculateKeptSecuritiesAssets5_1(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5. Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("5(1). Вложения в ценные бумаги, удерживаемые до погашения", dataSource.getBackOffice().getId()))+
                                                                               dataSource.getFilter().hasRiskGroup(1)+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'СС'")+
                                                                               dataSource.getFilter().hasNotAssignedAccountCategory("'ПР'"))));
    end;

    /* 5 */
    private macro getCalculateKeptSecuritiesAssetsTotal(attributeId : String)
        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("5.1"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("5_1"), PLUS))));
    end;

    /* 6.1 */
    private macro getCalculateOtherAssets(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var userDataSource = m_dataSources.getDataSource("user");
        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("6.1"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("6. Прочие активы", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2))));

        return calcAttributeData;

    end;

    /* 6_1 */
    private macro getCalculateOtherAssets6_1(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("6. Прочие активы", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(1))));

        return calcAttributeData;

    end;

    /* 6 */
    private macro getCalculateOtherAssetsTotal(attributeId : String)
        var userDataSource = m_dataSources.getDataSource("user");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("6.1"), PLUS),
                                                                                      RcbArray().initialize(m_part.getAttribute("6_1"), PLUS)))).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("6"),
                                                                               userDataSource.getBackOffice().getId())));
    end;

    /*8 */
    private macro getCalculateLendingAgencysMeansLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var userDataSource = m_dataSources.getDataSource("user");
        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("8"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("8. Средства кредитных организаций", dataSource.getBackOffice().getId())) +
/*!!!!*/                                                                       dataSource.getFilter().isBankContragent())));

        return calcAttributeData;

    end;

    /*9 */
    private macro getCalculateClientsMeans(attributeId : String)
        var dataSource        = m_dataSources.getDataSource("CbAccount");
        var depositDataSource = m_dataSources.getDataSource("loansDeposit");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId), null,
                                            T125DependencesData(RcbArray().initialize(RcbArray().initialize(m_part.getAttribute("9.1"), PLUS)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9. Средства клиентов", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail) +
                                                                               dataSource.getFilter().isEmployerOrJuridicalPersons() ))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9(1). Средства клиентов", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail) +
/*!!!!*/                                                                       dataSource.getFilter().isNotBankContragent())));
        if (accruedInterest)
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                         RcbArray().initialize(depositDataSource.getFilter().hasRegisterTypeForDepositType(TDR_DEPOHIST, "", TDR_DEPOPERC, "13, 15"), true, TDR_DEPOHIST)));
        else
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                         RcbArray().initialize(depositDataSource.getFilter().hasRegisterType(TDR_DEPOHIST), false)));
        end;

        return calcAttributeData;
    end;

    /*9.1 */
    private macro getCalculatePhysicalClientsMeans(attributeId : String)
        var cbDataSource      = m_dataSources.getDataSource("CbAccount");
        var depositDataSource = m_dataSources.getDataSource("loansDeposit");
        var retailDataSource  = m_dataSources.getDataSource("retailDeposit");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1. Вклады физических лиц", cbdataSource.getBackOffice().getId())) +
                                                                               cbDataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               cbDataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               cbDataSource.getFilter().isExcludedAccount(BORetail)))).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1(1). Вклады физических лиц", cbdataSource.getBackOffice().getId())) +
                                                                               cbDataSource.getFilter().isEmployerOrPhysicalPersons() +
                                                                               cbDataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               cbDataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               cbDataSource.getFilter().isExcludedAccount(BORetail)))).
                                      addCalculationData(RcbCalculationData(r2m(cbDataSource, "getData"),
                                                         RcbArray().initialize(cbDataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("9.1(2). Вклады физических лиц", cbdataSource.getBackOffice().getId())) +
                                                                               cbDataSource.getFilter().hasAssignedAccountCategory("'S'") +
                                                                               cbDataSource.getFilter().isPhysicalContragent()))).

/*!!!!проверка отключенного бэк-офиса*/addCalculationData(RcbCalculationData(r2m(retailDataSource, "getData")));

        if (accruedInterest)
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                 RcbArray().initialize(depositDataSource.getFilter().hasRegisterTypeForDepositType(TDR_DEPOHIST, "", TDR_DEPOPERC, "13, 15"),
                                                                       true,
                                                                       TDR_DEPOHIST,
                                                                       null,
                                                                       depositDataSource.getFilter().isEmployer())));
        else
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                 RcbArray().initialize(depositDataSource.getFilter().hasRegisterType(TDR_DEPOHIST),
                                                                       false,
                                                                       null,
                                                                       null,
                                                                       depositDataSource.getFilter().isEmployer())));
        end;

        return calcAttributeData;
    end;

    /*11 */
    private macro getCalculateOtherLiabilities(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");
        var depositDataSource = m_dataSources.getDataSource("loansDeposit");

        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("11. Прочие обязательства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getData"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("11(1). Прочие обязательства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount() +
                                                                               dataSource.getFilter().hasAssignedAccountCategory("'РЕПО'"))));

        if (not accruedInterest)
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(depositDataSource, "getData"),
                                                 RcbArray().initialize(depositDataSource.getFilter().hasRegisterType(TDR_DEPOPERC), false, NULL, "12, 14")));
        end;

        return calcAttributeData;
    end;

    /* 13 */
    private macro getCalculateIssuedGuaranteesAndLiabilityOffBalance(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");

        var calcAttributeData;
        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("13. Внебалансовые обязательства и гарантии выданные", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail), 1, row13byEndOfTermContract)));

        if (m_tuneTable.hasDataFor(loansDataSource.getBackOffice(), "13. Внебалансовые обязательства и гарантии выданные"))
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(loansDataSource, "getIssuedGuaranteesAndLiabilityData"),
                                                         RcbArray().initialize(NULL, row13byEndOfTermContract)));
        end;

        return calcAttributeData;
    end;

    /**
     * Выполнение расчета.
     */
    macro execute()
        println("Значение настроек, используемых при расчете:");
        println("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ                      " + ternary(accruedInterest,          "Yes", "No"));
        println("REPTREG/REP_GROUPS/ФОРМА 125/СТР.13 ПО СРОКУ ОКОНЧ. ДОГОВОРА          " + ternary(row13byEndOfTermContract, "Yes", "No"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateCashAssets                      ("1.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateCashAssets1_1                   ("1_1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateCashAssetsTotal                 ("1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateInvestmentsOfSecuritiesAssets   ("2"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLoanDebtsAssets                 ("3.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLoanDebtsAssets3_1              ("3_1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLoanDebtsAssetsTotal            ("3"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateSoldSecuritiesAssets            ("4.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateSoldSecuritiesAssets4_1         ("4_1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateSoldSecuritiesAssetsTotal       ("4"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateKeptSecuritiesAssets            ("5.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateKeptSecuritiesAssets5_1         ("5_1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateKeptSecuritiesAssetsTotal       ("5"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherAssets                     ("6.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherAssets6_1                  ("6_1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherAssetsTotal                ("6"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateAssetsTotalSum                  ("7"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateLendingAgencysMeansLiabilities  ("8"));
        m_reportCalculateController.addCalculationAttributeData( getCalculatePhysicalClientsMeans            ("9.1"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateClientsMeans                    ("9"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateIssuedDebtInstrumentsLiabilities("10"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateOtherLiabilities                ("11"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLiabilitiesTotalSum             ("12"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateIssuedGuaranteesAndLiabilityOffBalance("13"));

        m_reportCalculateController.addCalculationAttributeData( getCalculateLiquiditysOverplus              ("14"));
        m_reportCalculateController.addCalculationAttributeData( getCalculateLiquiditysOverplusIndex         ("15"));
    end;
end;

class (T125PartCalculateController2926_2) T125PartCalculateController3875(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController2926_2(reportCalculateController, 0);

    /* 1_1 */
    private macro getCalculateCashAssets1_1(attributeId : String)
        var dataSource = m_dataSources.getDataSource("CbAccount");

        return T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1. Денежные средства", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasNotBalance202() +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1. Денежные средства"))))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().hasBalance202() +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1(1). Денежные средства в КО")), 1, false, true))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRow1_1"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("1(1). Денежные средства в КО", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroupOrHasNo(1) +
                                                                               dataSource.getFilter().op("AND") +
                                                                               getSqlBoolIdentity(m_tuneTable.hasDataFor(TBackOffice(BOCB), "1(1). Денежные средства в КО")), 1, true)
                                                                           )
                                                        );
    end;
end;

class (T125PartCalculateController3875) T125PartCalculateController4099(reportCalculateController /*: RcbReportCalculateController*/)
    initT125PartCalculateController3875(reportCalculateController, 0);

    /* 3.1 */
    private macro getCalculateLoanDebtsAssets(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        var userDataSource = m_dataSources.getDataSource("user");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                      addCalculationData(RcbCalculationData(r2m(userDataSource, "getData"),
                                                         RcbArray().initialize(userDataSource.getFilterForLine("3.1"),
                                                                               userDataSource.getBackOffice().getId()))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3. Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2) +
                                                                               dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                               dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                               dataSource.getFilter().isExcludedAccount(BORetail)))).
                                      addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowY"),
                                                         RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3(1) Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                               dataSource.getFilter().hasRiskGroup(2))));

        if (m_tuneTable.hasDataFor(loansDataSource.getBackOffice(), "3. Ссудная и приравненная к ней задолженность"))
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData31"),
                                                         RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(2),
                                                                               loansDataSource.getFilter().hasRegisterType(TDR_EXPREST,
                                                                                                                           TDR_EXPPERC,
                                                                                                                           TDR_EXPPERC_OV,
                                                                                                                           TDR_CLAIM),
                                                                               accruedInterest,
                                                                               loansDataSource.getFilter().hasCreditType(LO_CREDIT,
                                                                                                                         LO_OVERDRAFT,
                                                                                                                         LO_KARTA)))).
                              addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData31"),
                                                         RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(2),
                                                                               loansDataSource.getFilter().hasRegisterType(TDR_EXPPAYMGUARANTEE,
                                                                                                                               TDR_PAYMGUARANTEEEXPPERC,
                                                                                                                               TDR_PAYMGUARANTEEPERCDEM),
                                                                               accruedInterest,
                                                                               loansDataSource.getFilter().hasCreditType(LO_GUARANTEE))));
        end;

        return calcAttributeData;
    end;

    /* 3_1 */
    private macro getCalculateLoanDebtsAssets3_1(attributeId : String)
        var dataSource      = m_dataSources.getDataSource("CbAccount");
        var loansDataSource = m_dataSources.getDataSource("loansCredit");
        var calcAttributeData;

        calcAttributeData = T125CalculationAttributeData(m_part.getAttribute(attributeId)).
                                          addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                             RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3. Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                                   dataSource.getFilter().hasRiskGroup(1) +
                                                                                   dataSource.getFilter().isExcludedAccount(BOLoans) +
                                                                                   dataSource.getFilter().isExcludedAccount(BODeposits) +
                                                                                   dataSource.getFilter().isExcludedAccount(BORetail)))).
                                           addCalculationData(RcbCalculationData(r2m(dataSource, "getDataRowX"),
                                                              RcbArray().initialize(dataSource.getFilter().isSatisfiesToAccountMasks(m_tuneTable.getAccountMasks("3(1) Ссудная и приравненная к ней задолженность", dataSource.getBackOffice().getId())) +
                                                                                    dataSource.getFilter().hasRiskGroup(1))));

        if (m_tuneTable.hasDataFor(loansDataSource.getBackOffice(), "3. Ссудная и приравненная к ней задолженность"))
            calcAttributeData.addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData"),
                                                             RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(1),
                                                                                   loansDataSource.getFilter().hasRegisterType(TDR_EXPREST,
                                                                                                                               TDR_EXPPERC,
                                                                                                                               TDR_EXPPERC_OV,
                                                                                                                               TDR_CLAIM),
                                                                                   accruedInterest,
                                                                                   loansDataSource.getFilter().hasCreditType(LO_CREDIT,
                                                                                                                             LO_OVERDRAFT,
                                                                                                                             LO_KARTA)))).
                              addCalculationData(RcbCalculationData(r2m(loansDataSource, "getLoanDebtsData"),
                                                             RcbArray().initialize(loansDataSource.getFilter().hasRiskGroup(1),
                                                                                   loansDataSource.getFilter().hasRegisterType(TDR_EXPPAYMGUARANTEE,
                                                                                                                               TDR_PAYMGUARANTEEEXPPERC,
                                                                                                                               TDR_PAYMGUARANTEEPERCDEM),
                                                                                   accruedInterest,
                                                                                   loansDataSource.getFilter().hasCreditType(LO_GUARANTEE))));
        end;

        return calcAttributeData;
    end;
end;
