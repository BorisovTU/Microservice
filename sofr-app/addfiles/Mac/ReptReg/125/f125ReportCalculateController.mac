/*
$Name:          f125ReportCalculateController.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 125. Контроллер расчета
*/
/**
 * Форма 125. Контроллер расчета.
 * 
 * @since   15.04.2009
 * @author  Ivkina Olga
 * @version 6.00.020.29
 */
/**
 * Контроллер расчета.
 */ 
class (RcbReportCalculateController) T125ReportCalculateController()
        /**
         * Расчитать атрибут.
         *
         * @param   calculationAttributeData     набор данных для расчета одного атрибута
         */
    /* private */ macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;
        /*печать протокола :(*/
        m_protocolView.printReportLineNumber(calculationAttributeData.getAttribute().getId());

        var dependentAttributePool = calculationAttributeData.getDependencesData().getDependentAttributeOperationPool();
        var dimensionDependences   = calculationAttributeData.getDependencesData().getDimensionDependences();
        

        dependentAttributePool.moveFirst();
        while (dependentAttributePool.moveNext())                
            if ( valType(dependentAttributePool.getCurrentItem()(0)) == valType(RcbAttributeBase))
	            this.calculateAttribute(getCalculationAttributeData(dependentAttributePool.getCurrentItem()(0)));
            end;
            calculationAttributeData.getAttribute().addAttributeValue(dependentAttributePool.getCurrentItem()(0), 
                                                                      dependentAttributePool.getCurrentItem()(1),
                                                                      dimensionDependences);
        end;
                                                                                 
        var calculationDataPool = calculationAttributeData.getCalculationDataPool();        
        
        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationAttributeData.addAttributeValue(calculationDataPool.getCurrentItem().calculate());
        end;
        
        calculationAttributeData.setCalculated();
    end;


    initRcbReportCalculateController();

    macro initialize() : Bool                
        m_partCalculateControllers.push_back(T125PartCalculateController(this));

        return m_partCalculateControllers.size > 0;
    end;
end;

/**
 * Контроллер расчета.
 */ 
class (T125ReportCalculateController) T125ReportCalculateController2332()

    initT125ReportCalculateController();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController2332(this));

        return m_partCalculateControllers.size > 0;
    end;
end;
/**
 * Контроллер расчета.
 */ 
class (T125ReportCalculateController2332) T125ReportCalculateController2835()

    initT125ReportCalculateController2332();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController2835(this));
    
        return m_partCalculateControllers.size > 0;
    end;
end;

/**
 * Контроллер расчета 2926-У
 */
class (T125ReportCalculateController2835) T125ReportCalculateController2926()

    initT125ReportCalculateController2835();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController2926(this));

        return m_partCalculateControllers.size > 0;
    end;
end;

/**
 * Контроллер расчета по 2922-У
 */
class (T125ReportCalculateController2926) T125ReportCalculateController2922()

    initT125ReportCalculateController2926();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController2922(this));

        return m_partCalculateControllers.size > 0;
    end;
end;

/**
 * Контроллер расчета по 2926-У(2-ая очередь)
 */
class (T125ReportCalculateController2922) T125ReportCalculateController2926_2()

    initT125ReportCalculateController2922();

    macro calculateAttribute(calculationAttributeData : RcbCalculationAttributeData)
        if (calculationAttributeData.isCalculate())
            return;
        end;

        /* Исключаем вывод в протокол этих строк, так как в них содержится просто итоговая сумма*/
        if ((calculationAttributeData.getAttribute().getId() != "1") and
            (calculationAttributeData.getAttribute().getId() != "3") and
            (calculationAttributeData.getAttribute().getId() != "4") and
            (calculationAttributeData.getAttribute().getId() != "5") and
            (calculationAttributeData.getAttribute().getId() != "6")
           )
            m_protocolView.printReportLineNumber(calculationAttributeData.getAttribute().getId());
        end;

        var dependentAttributePool = calculationAttributeData.getDependencesData().getDependentAttributeOperationPool();
        var dimensionDependences   = calculationAttributeData.getDependencesData().getDimensionDependences();
        

        dependentAttributePool.moveFirst();
        while (dependentAttributePool.moveNext())                
            if ( valType(dependentAttributePool.getCurrentItem()(0)) == valType(RcbAttributeBase))
	            this.calculateAttribute(getCalculationAttributeData(dependentAttributePool.getCurrentItem()(0)));
            end;
            calculationAttributeData.getAttribute().addAttributeValue(dependentAttributePool.getCurrentItem()(0), 
                                                                      dependentAttributePool.getCurrentItem()(1),
                                                                      dimensionDependences);
        end;
                                                                                 
        var calculationDataPool = calculationAttributeData.getCalculationDataPool();        
        
        calculationDataPool.moveFirst();
        while (calculationDataPool.moveNext())
            calculationAttributeData.addAttributeValue(calculationDataPool.getCurrentItem().calculate());
        end;
        
        calculationAttributeData.setCalculated();
    end;

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController2926_2(this));

        return m_partCalculateControllers.size > 0;
    end;
end;

class (T125ReportCalculateController2926_2) T125ReportCalculateController3875()

    initT125ReportCalculateController2926_2();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController3875(this));

        return m_partCalculateControllers.size > 0;
    end;
end;

class (T125ReportCalculateController3875) T125ReportCalculateController4099()

    initT125ReportCalculateController3875();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(T125PartCalculateController4099(this));

        return m_partCalculateControllers.size > 0;
    end;
end;
