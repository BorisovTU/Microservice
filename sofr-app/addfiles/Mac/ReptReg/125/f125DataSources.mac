/*
$Name:        f125DataSources.mac
$Module:      Регламентируемая отчетность
$Description: Источники данных для формы 125
*/
/*
Источники данных  по подсистемам ГК, Кредитование, Депозиты и Ритейл
*/

import SbCrdInter;
import lib_str;

const NOTEKIND_REST_NOT_DOWN = 14; // Примечание Неснижаемый остаток
const RATETYPE_CB = 7; //Курс ЦБ

/**
 * Источник данных.
 */
class (RcbDataSource) TDataSource(backOffice : Integer, id : String)
    initRcbDataSource(id);
    /**
     * Бэк-офис.
     */
    private var m_backOffice = TBackOffice(backOffice);

    /**
     * Фильтр данных.
     */
    private var m_filter /*: TDataSourceFilter*/;

    /**
     * Протокол ИД.
     */
    private var m_protocol;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceFilter"));
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        throw (TPureVirtualMethodCallException("TDataSource::createDataSourceProtocol"));
    end;

    /**
     * Очистить закешированные данные.
     */
    macro clear() : bool
        throw (TPureVirtualMethodCallException("TDataSource::clear"));
    end;

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        throw (TPureVirtualMethodCallException("TDataSource::cacheData"));
    end;

    /**
     * Получить бэк-офис.
     */
    macro getBackOffice() : TBackOffice
        return m_backOffice;
    end;

    /**
     * Получить фильтр.
     */
    macro getFilter() /*: TDataSourceFilter*/
        return m_filter;
    end;

    private macro constructor()
        if (objectFactoryInstance.createTuneTable().hasDataFor(m_backOffice))
            cacheData();
        end;

        createDataSourceFilter();
        createDataSourceProtocol();
    end;

    constructor();
end;

/**
 * Источник данных по ГК.
 */
class (TDataSource) TCbDataSource(id)
    initTDataSource(BOCB, id);
end;
/**
 * Источник данных по Лоанс Кредитование.
 */
class (TDataSource) TLoansDataSource(id)
    initTDataSource(BOLoans, id);
end;
/**
 * Источник данных по Лоанс Депозиты.
 */
class (TDataSource) TDepositsDataSource(id)
    initTDataSource(BODeposits, id);
end;
/**
 * Источник данных по Ритейл.
 */
class (TDataSource) TRetailDataSource(id)
    initTDataSource(BORetail, id);
end;

/**
 * Источник пользовательских данных.
 */
class (TDataSource) TUserDataSource(id)
    initTDataSource(BOUser, id);
end;

/**
 * Источник данных ГК.
 */
class (TCbDataSource) T125CbAccountDataSource()
    initTCbDataSource("CbAccount");
    /**
     * Очистить закешированные данные.
     */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df125account_tmp");
    end;

    sql_execute(         " INSERT INTO df125account_tmp(t_accountId,        "
                + "\n" + "                              t_account,          "
                + "\n" + "                              t_kind,             "
                + "\n" + "                              t_chapter,          "
                + "\n" + "                              t_fiId,             "
                + "\n" + "                              t_qualityCategory,  "
                + "\n" + "                              t_acc_maturityDate, "
                + "\n" + "                              t_contragentId,     "
                + "\n" + "                              t_acc_outCoverRest, "
                + "\n" + "                              t_calcReserveAmount,"
                + "\n" + "                              t_reservePercent)"
                + "\n" + "SELECT acc.t_accountId,                           "
                + "\n" + "       acc.t_account,                             "
                + "\n" + "       acc.t_kind,                                "
                + "\n" + "       acc.t_chapter,                             "
                + "\n" + "       acc.t_fiId,                                "
                + "\n" + "       acc.t_qualityCategory,                     "
                + "\n" + "       acc.t_maturityDate t_acc_maturityDate,     "
                + "\n" + "       acc.t_contragentId,                        "
                + "\n" + "       acc.t_outCoverRest t_acc_outCoverRest,     "
                + "\n" + "       NVL(acc.t_calcReserveAmount, 0),           "
                + "\n" + "       NVL(acc.t_accountReservePercent, 0)        "
                + "\n" + "  FROM drepAccount_vw acc                         "
                + "\n" + " WHERE acc.t_isOpened = 1                         "
                + "\n" + "   AND acc.t_outRest != 0");

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        var filter;
        var masks = objectFactoryInstance.createTuneTable().getAccountMasks("%", m_backOffice.getId());

        if ((masks == "") or (masks == null))
            filter = "";
        else
            // 18.03.2011 ABP Символьная константа получается настолько впечатляющих размеров (8 кБ), что RSL на ней ломается
//            filter = "AND (" + strSubst(convertMaskToSqlFormat(masks, "acc.t_account"), "'", "''") + ")";
            filter = "AND rsb_mask.compareStringWithMask(" + strSubst(getSqlString(masks), "'", "''") + ", acc.t_account) > 0";
        end;

        sql_execute("BEGIN"
             +"\n"+ "    rep_data.initPercentRepaymentSchedule("
             +"\n"+ "        " + getSqlDate(global.getRcbReport().context.period.endDate) + ","
             +"\n"+ "        'SELECT acc.t_chapter,"
             +"\n"+ "                acc.t_fiId,"
             +"\n"+ "                acc.t_account"
             +"\n"+ "           FROM drepAccount_vw acc"
             +"\n"+ "          WHERE acc.t_isOpenedAtEndDate = 1"
             +"\n"+ "            " + filter + "');"
             +"\n"+ "END;");
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T125CbAccountDataSourceFilter();
        return true;
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = TCbAccountDataSourceProtocol();
        return true;
    end;

    /**
     * Получить данные.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getData(filter/*filter : RcbDataSourceFilter, attribute : RcbAttributeBase*/, subtractionSign, useMaturity)

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        if ((useMaturity == NULL) or (valType(useMaturity) == V_UNDEF))
            useMaturity = true;
        end;

        var commandText = "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_calcReserveAmount,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.t_account,"
                 + "\n" + "                 acc.t_chapter,"
                 + "\n" + "                 acc.t_fiId,"
                 + "\n" + "                 acc.t_qualityCategory,"
                 + "\n" + "                 acc.t_acc_maturityDate,"
                 + "\n" + "                 acc.t_acc_outCoverRest,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 acc.t_calcReserveAmount,"
                 + "\n" + "                 acc.t_reservePercent,";

        if (useMaturity)
            commandText = commandText + "   CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   1 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   5 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  10 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  20 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  30 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  90 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 180 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 270 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                 + "\n" + "                                                                               or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column10,";
        else
            commandText = commandText + "   t_acc_outCoverRest t_column2,"
                 + "\n" + "                 t_acc_outCoverRest t_column3,"
                 + "\n" + "                 t_acc_outCoverRest t_column4,"
                 + "\n" + "                 t_acc_outCoverRest t_column5,"
                 + "\n" + "                 t_acc_outCoverRest t_column6,"
                 + "\n" + "                 t_acc_outCoverRest t_column7,"
                 + "\n" + "                 t_acc_outCoverRest t_column8,"
                 + "\n" + "                 t_acc_outCoverRest t_column9,"
                 + "\n" + "                 t_acc_outCoverRest t_column10,";
        end;

            commandText = commandText + "   t_acc_outCoverRest t_column11"
                 + "\n" + "            FROM df125account_tmp acc"
                 + "\n" + "           WHERE 1 = 1" + NVL(filter, " ")
                 + "\n" + "          UNION ALL"
                 + "\n" + "          SELECT acc.t_account,"
                 + "\n" + "                 acc.t_chapter,"
                 + "\n" + "                 acc.t_fiId,"
                 + "\n" + "                 acc.t_qualityCategory,"
                 + "\n" + "                 NULL t_acc_maturityDate,"
                 + "\n" + "                 NULL t_acc_outCoverRest,"
                 + "\n" + "                 pc.t_backOffice,"
                 + "\n" + "                 pc.t_number,"
                 + "\n" + "                 prs.t_maturitydate,"
                 + "\n" + "                 prs.t_roubleSum,"
                 + "\n" + "                 acc.t_calcReserveAmount,"
                 + "\n" + "                 acc.t_reservePercent,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=   1 or prs.t_maturitydate is null THEN t_roubleSum END t_column2,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=   5 or prs.t_maturitydate is null THEN t_roubleSum END t_column3,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=  10 or prs.t_maturitydate is null THEN t_roubleSum END t_column4,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=  20 or prs.t_maturitydate is null THEN t_roubleSum END t_column5,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=  30 or prs.t_maturitydate is null THEN t_roubleSum END t_column6,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <=  90 or prs.t_maturitydate is null THEN t_roubleSum END t_column7,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <= 180 or prs.t_maturitydate is null THEN t_roubleSum END t_column8,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <= 270 or prs.t_maturitydate is null THEN t_roubleSum END t_column9,"
                 + "\n" + "                 CASE WHEN (prs.t_maturitydate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                 + "\n" + "                                                                               or prs.t_maturitydate is null THEN t_roubleSum END t_column10,"
                 + "\n" + "                 t_roubleSum                                                                                                      t_column11"
                 + "\n" + "            FROM df125account_tmp acc,"
                 + "\n" + "                 repPercentRepaymentSchedule_vw prs,"
                 + "\n" + "                 repPercentContract_vw pc"
                 + "\n" + "           WHERE pc.t_chapter = acc.t_chapter"
                 + "\n" + "             AND pc.t_fiId    = acc.t_fiId"
                 + "\n" + "             AND pc.t_account = acc.t_account"
                 + "\n" + "             AND prs.t_contractId = pc.t_id"
                 + "\n" + "               " + NVL(filter, " ")
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_calcReserveAmount,"
                 + "\n" + "                  t_reservePercent"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_calcReserveAmount,"
                 + "\n" + "         t_reservePercent";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    macro getDataRow1(filter, subtractionSign, useRestNotDown)
        var restNotDown;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        if (useRestNotDown)
            restNotDown = "NVL((SELECT rep_utl.castRawToMoney(t_text)                                    "
                 + "\n" + "       FROM dnoteText_dbt                                                     "
                 + "\n" + "      WHERE t_objectType = " + RCB_OBJTYPE_ACCOUNT
                 + "\n" + "        AND t_documentId = TO_CHAR (acc.t_chapter, 'FM0x')                    "
                 + "\n" + "                        || TO_CHAR (acc.t_fiId, 'FM0xxxxxx') || acc.t_account "
                 + "\n" + "        AND t_noteKind = " + NOTEKIND_REST_NOT_DOWN
                 + "\n" + "        AND rep_data.getEndDate() BETWEEN t_date  AND t_validToDate), 0)      ";
        else
            restNotDown = "NULL";
        end;

        var commandText = "WITH account AS"
                 + "\n" + "("
                 + "\n" + "SELECT accounts.t_account,"
                 + "\n" + "       accounts.t_chapter,"
                 + "\n" + "       accounts.t_fiId,"
                 + "\n" + "       accounts.t_qualityCategory,"
                 + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "       CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown) > 0 "
                 + "\n" + "            THEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown)"
                 + "\n" + "            ELSE 0"
                 + "\n" + "       END t_acc_outCoverRest,";
            else
                 commandText = commandText + "accounts.t_acc_outCoverRest t_acc_outCoverRest,";
            end;

            commandText = commandText
                 + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
                 + "\n" + "       accounts.t_restNotDown t_restNotDown"
                 + "\n" + "  FROM (SELECT acc.t_account,"
                 + "\n" + "               acc.t_chapter,"
                 + "\n" + "               acc.t_fiId,"
                 + "\n" + "               acc.t_qualityCategory,"
                 + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "               CASE WHEN (acc.t_fiId <> 0)"
                 + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(" + restNotDown + ", acc.t_fiId, 0," + RATETYPE_CB + ", rep_data.getEndDate()), 0)"
                 + "\n" + "                    ELSE " + restNotDown
                 + "\n" + "               END ";
            else
                commandText = commandText + restNotDown;
            end;

            commandText = commandText + " t_restNotDown "
                 + "\n" + "          FROM df125account_tmp acc"
                 + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ")
                 + "\n" + "       ) accounts"
                 + "\n" + ")"
                 + "\n" + "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.*,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   1 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   5 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  10 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  20 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  30 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  90 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 180 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 270 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                 + "\n" + "                                                                               or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column10,"
                 + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11"
                 + "\n" + "            FROM account acc"
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_rest,"
                 + "\n" + "                  t_restNotDown"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocolRow1(data);

        data.moveFirst();

        return data;
    end;

    macro getDataRow1_2922(filter, subtractionSign, useRestNotDown, useReserve)
        var restNotDown;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        if ((useReserve == NULL) or (valType(useReserve) == V_UNDEF))
            useReserve = false;
        end;


        if (useRestNotDown)
            restNotDown = "NVL((SELECT rep_utl.castRawToMoney(t_text)                                    "
                 + "\n" + "       FROM dnoteText_dbt                                                     "
                 + "\n" + "      WHERE t_objectType = " + RCB_OBJTYPE_ACCOUNT
                 + "\n" + "        AND t_documentId = TO_CHAR (acc.t_chapter, 'FM0x')                    "
                 + "\n" + "                        || TO_CHAR (acc.t_fiId, 'FM0xxxxxx') || acc.t_account "
                 + "\n" + "        AND t_noteKind = " + NOTEKIND_REST_NOT_DOWN
                 + "\n" + "        AND rep_data.getEndDate() BETWEEN t_date  AND t_validToDate), 0)      ";
        else
            restNotDown = "NULL";
        end;

         var commandText = "WITH account AS"
                 + "\n" + "("
                 + "\n" + "SELECT accounts.t_account,"
                 + "\n" + "       accounts.t_chapter,"
                 + "\n" + "       accounts.t_fiId,"
                 + "\n" + "       accounts.t_qualityCategory,"
                 + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "       CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown) > 0 "
                 + "\n" + "            THEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown)"
                 + "\n" + "            ELSE 0"
                 + "\n" + "       END t_acc_outCoverRest,";
            else
                if (useReserve)
                    commandText = commandText
                     + "\n" + "       CASE WHEN  NVL(accounts.t_reservesum, 0) <> 0 "
                     + "\n" + "            THEN"
                     + "\n" + "               CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_reserveSum) > 0 "
                     + "\n" + "                    THEN (accounts.t_acc_outCoverRest - accounts.t_reserveSum)"
                     + "\n" + "                    ELSE 0"
                     + "\n" + "               END"
                     + "\n" + "            ELSE accounts.t_acc_outCoverRest"
                     + "\n" + "       END t_acc_outCoverRest,";
                else
                    commandText = commandText + "accounts.t_acc_outCoverRest t_acc_outCoverRest,";
                end;
            end;

            commandText = commandText
                 + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
                 + "\n" + "       accounts.t_restNotDown t_restNotDown,"
                 + "\n" + "       accounts.t_reserveSum t_reserveSum,"
                 + "\n" + "       accounts.t_reserveAccount t_reserveAccount,"
                 + "\n" + "       accounts.t_reservePercent t_reservePercent"
                 + "\n" + "  FROM (SELECT acc.t_account,"
                 + "\n" + "               acc.t_chapter,"
                 + "\n" + "               acc.t_fiId,"
                 + "\n" + "               acc.t_qualityCategory,"
                 + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,"
                 + "\n" + "               acc.t_reservePercent   t_reservePercent,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "               CASE WHEN (acc.t_fiId <> 0)"
                 + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(" + restNotDown + ", acc.t_fiId, 0," + RATETYPE_CB + ", rep_data.getEndDate()), 0)"
                 + "\n" + "                    ELSE " + restNotDown
                 + "\n" + "               END ";
            else
                commandText = commandText + restNotDown;
            end;

            commandText = commandText + " t_restNotDown, ";

            if (useReserve)
                commandText = commandText + " NVL(reserve.t_reserveAccount, NULL)    t_reserveAccount,"
                                   + "\n" + " NVL(reserve.t_endDateReserveAmount, 0) t_reserveSum";
            else
                commandText = commandText + " NULL t_reserveAccount,"
                                   + "\n" + " 0    t_reserveSum";
            end;

            commandText = commandText + " FROM df125account_tmp acc";

            if (useReserve)
                commandText = commandText + ", dRepReserveAccount_vw reserve";
            end;

            commandText = commandText
                 + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ");

            if (useReserve)
                commandText = commandText + "AND acc.t_accountId = reserve.t_connectAccountId (+)";
            end;

            commandText = commandText
                 + "\n" + "       ) accounts"
                 + "\n" + ")"
                 + "\n" + "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         t_reserveSum,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.*,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   1 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   5 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  10 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  20 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  30 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  90 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 180 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 270 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                 + "\n" + "                                                                               or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column10,"
                 + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11"
                 + "\n" + "            FROM account acc"
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_rest,"
                 + "\n" + "                  t_restNotDown,"
                 + "\n" + "                  t_reserveAccount,"
                 + "\n" + "                  t_reserveSum"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         t_reserveSum";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocolRow1_2922(data);

        data.moveFirst();

        return data;
    end;

    macro getDataRow2(filter, subtractionSign, useMaturity)
        var revaluationSum;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        var commandText = "WITH account AS"
                 + "\n" + "("
                 + "\n" + "SELECT accounts.t_account,"
                 + "\n" + "       accounts.t_chapter,"
                 + "\n" + "       accounts.t_fiId,"
                 + "\n" + "       accounts.t_qualityCategory,"
                 + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
                 + "\n" + "       NVL(accounts.t_acc_outCoverRest, 0) t_acc_outCoverRest,"
                 + "\n" + "       accounts.t_calcReserveAmount,"
                 + "\n" + "       accounts.t_reservePercent"
                 + "\n" + "  FROM (SELECT acc.t_account,"
                 + "\n" + "               acc.t_chapter,"
                 + "\n" + "               acc.t_fiId,"
                 + "\n" + "               acc.t_qualityCategory,"
                 + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,"
                 + "\n" + "               acc.t_calcReserveAmount t_calcReserveAmount,"
                 + "\n" + "               acc.t_reservePercent    t_reservePercent";

            commandText = commandText
                 + "\n" + "          FROM df125account_tmp acc"
                 + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ")
                 + "\n" + "       ) accounts"
                 + "\n" + ")"
                 + "\n" + "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_calcReserveAmount,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.*,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,";
            if (useMaturity)
                commandText = commandText + " CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   1 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column2,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   5 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column3,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  10 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column4,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  20 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column5,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  30 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column6,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  90 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column7,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 180 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column8,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 270 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column9,"
                   + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                   + "\n" + "                                                                               or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column10,"
                   + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11";
            else
                commandText = commandText + " t_acc_outCoverRest t_column2,"
                   + "\n" + "                 t_acc_outCoverRest t_column3,"
                   + "\n" + "                 t_acc_outCoverRest t_column4,"
                   + "\n" + "                 t_acc_outCoverRest t_column5,"
                   + "\n" + "                 t_acc_outCoverRest t_column6,"
                   + "\n" + "                 t_acc_outCoverRest t_column7,"
                   + "\n" + "                 t_acc_outCoverRest t_column8,"
                   + "\n" + "                 t_acc_outCoverRest t_column9,"
                   + "\n" + "                 t_acc_outCoverRest t_column10,"
                   + "\n" + "                 t_acc_outCoverRest t_column11";
            end;
                commandText = commandText + " FROM account acc"
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_rest,"
                 + "\n" + "                  t_calcReserveAmount,"
                 + "\n" + "                  t_reservePercent"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_calcReserveAmount,"
                 + "\n" + "         t_reservePercent";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    macro getDataRow2_Revaluation(filter, subtractionSign, useMaturity)
        var commandText;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        commandText = "WITH account AS"
             + "\n" + "("
             + "\n" + "SELECT accounts.t_account,"
             + "\n" + "       accounts.t_accountId,"
             + "\n" + "       accounts.t_chapter,"
             + "\n" + "       accounts.t_fiId,"
             + "\n" + "       accounts.t_qualityCategory,"
             + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,"
             + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
             + "\n" + "       NVL(accounts.t_acc_outCoverRest + accounts.t_revaluationSum, 0) t_acc_outCoverRest,"
             + "\n" + "       accounts.t_calcReserveAmount,"
             + "\n" + "       accounts.t_reservePercent"
             + "\n" + "  FROM (SELECT acc.t_account,"
             + "\n" + "               acc.t_accountId,"
             + "\n" + "               acc.t_chapter,"
             + "\n" + "               acc.t_fiId,"
             + "\n" + "               acc.t_qualityCategory,"
             + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
             + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,"
             + "\n" + "               acc.t_calcReserveAmount t_calcReserveAmount,"
             + "\n" + "               acc.t_reservePercent    t_reservePercent,"
             + "\n" + "               NVL((SELECT SUM(a.t_outCoverRest * DECODE(linkedObjects.t_role, " + POSITIVE_REVALUATION + ", 1, " + NEGATIVE_REVALUATION + ", -1) ) "
             + "\n" + "                      FROM dRepLinkedObjects_vw linkedObjects, "
             + "\n" + "                           dRepAccount_vw a              "
             + "\n" + "                     WHERE a.t_account = SUBSTR(linkedObjects.t_id, 10)    "
             + "\n" + "                       AND a.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x') "
             + "\n" + "                       AND a.t_fiId = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx') "
             + "\n" + "                       AND TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectid, 1, 2), 'FM0x') = acc.t_chapter  "
             + "\n" + "                       AND TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectid, 3, 7), 'FM0xxxxxx') = acc.t_fiId"
             + "\n" + "                       AND SUBSTR(linkedObjects.t_connectObjectid, 10) = acc.t_account       "
             + "\n" + "                       AND linkedObjects.t_role IN (" + POSITIVE_REVALUATION + ", "+ NEGATIVE_REVALUATION + ") "
             + "\n" + "                       AND linkedObjects.t_type = 4), 0)   t_revaluationSum"
             + "\n" + "          FROM df125account_tmp acc"
             + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ")
             + "\n" + "       ) accounts";

        commandText = commandText
             + "\n" + ")"
             + "\n" + "SELECT   t_account,"
             + "\n" + "         t_accountId,"
             + "\n" + "         t_qualityCategory,"
             + "\n" + "         t_acc_maturityDate,"
             + "\n" + "         t_acc_outCoverRest,"
             + "\n" + "         t_backOffice,"
             + "\n" + "         t_number,"
             + "\n" + "         t_maturitydate,"
             + "\n" + "         t_roubleSum,"
             + "\n" + "         t_rest,"
             + "\n" + "         t_calcReserveAmount,"
             + "\n" + "         t_reservePercent,"
             + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
             + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
             + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
             + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
             + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
             + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
             + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
             + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
             + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
             + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
             + "\n" + "    FROM ("
             + "\n" + "          SELECT acc.*,"
             + "\n" + "                 NULL t_backOffice,"
             + "\n" + "                 NULL t_number,"
             + "\n" + "                 NULL t_maturitydate,"
             + "\n" + "                 NULL t_roubleSum,";

        if (useMaturity)
            commandText = commandText + " CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   1 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column2,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=   5 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column3,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  10 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column4,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  20 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column5,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  30 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column6,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <=  90 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column7,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 180 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column8,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= 270 or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column9,"
               + "\n" + "                 CASE WHEN (t_acc_maturityDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
               + "\n" + "                                                                               or t_acc_maturityDate is null THEN t_acc_outCoverRest END t_column10,"
               + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11";
        else
            commandText = commandText + " t_acc_outCoverRest t_column2,"
               + "\n" + "                 t_acc_outCoverRest t_column3,"
               + "\n" + "                 t_acc_outCoverRest t_column4,"
               + "\n" + "                 t_acc_outCoverRest t_column5,"
               + "\n" + "                 t_acc_outCoverRest t_column6,"
               + "\n" + "                 t_acc_outCoverRest t_column7,"
               + "\n" + "                 t_acc_outCoverRest t_column8,"
               + "\n" + "                 t_acc_outCoverRest t_column9,"
               + "\n" + "                 t_acc_outCoverRest t_column10,"
               + "\n" + "                 t_acc_outCoverRest t_column11";
        end;

        commandText = commandText + " FROM account acc"
         + "\n" + "         ) listacc"
         + "\n" + "GROUP BY ROLLUP((t_account,"
         + "\n" + "                 t_accountId,"
         + "\n" + "                 t_chapter,"
         + "\n" + "                 t_fiid,"
         + "\n" + "                 t_qualityCategory,"
         + "\n" + "                 t_acc_maturityDate,"
         + "\n" + "                 t_acc_outCoverRest,"
         + "\n" + "                 t_backOffice,"
         + "\n" + "                 t_number,"
         + "\n" + "                 t_maturitydate,"
         + "\n" + "                 t_roubleSum,"
         + "\n" + "                 t_rest,"
         + "\n" + "                 t_calcReserveAmount,"
         + "\n" + "                 t_reservePercent))"
         + "\n" + "ORDER BY GROUPING(t_account) DESC,"
         + "\n" + "         t_account, t_accountId, t_chapter, t_fiid,"
         + "\n" + "         t_qualityCategory,"
         + "\n" + "         t_acc_maturityDate,"
         + "\n" + "         t_acc_outCoverRest,"
         + "\n" + "         t_backOffice,"
         + "\n" + "         t_number,"
         + "\n" + "         t_maturitydate,"
         + "\n" + "         t_roubleSum,"
         + "\n" + "         t_rest,"
         + "\n" + "         t_calcReserveAmount,"
         + "\n" + "         t_reservePercent";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

         commandText =
           "\n" + "SELECT a.t_account,"
         + "\n" + "       acc.t_accountId AS t_accountIdRef,"
         + "\n" + "       a.t_outCoverRest * DECODE(linkedObjects.t_role, " + POSITIVE_REVALUATION + ", 1, " + NEGATIVE_REVALUATION + ", -1) t_acc_outCoverRest"
         + "\n" + "  FROM df125account_tmp acc, dRepLinkedObjects_vw linkedObjects, dRepAccount_vw a"
         + "\n" + " WHERE a.t_account = SUBSTR(linkedObjects.t_id, 10)    "
         + "\n" + "                       AND a.t_chapter = TO_NUMBER(SUBSTR(linkedObjects.t_id, 1, 2), 'FM0x') "
         + "\n" + "                       AND a.t_fiId = TO_NUMBER(SUBSTR(linkedObjects.t_id, 3, 7), 'FM0xxxxxx') "
         + "\n" + "                       AND TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectid, 1, 2), 'FM0x') = acc.t_chapter  "
         + "\n" + "                       AND TO_NUMBER(SUBSTR(linkedObjects.t_connectObjectid, 3, 7), 'FM0xxxxxx') = acc.t_fiId"
         + "\n" + "                       AND SUBSTR(linkedObjects.t_connectObjectid, 10) = acc.t_account       "
         + "\n" + "                       AND linkedObjects.t_role IN (" + POSITIVE_REVALUATION + ", "+ NEGATIVE_REVALUATION + ") "
         + "\n" + "                       AND linkedObjects.t_type = 4" + NVL(filter, " ")
         + "\n" + "ORDER BY a.t_accountId";

        var dataRevaluation = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data, dataRevaluation);

        data.moveFirst();

        return data;
    end;
end;

class (T125CbAccountDataSource) T125CbAccountDataSource2926_2()
    initT125CbAccountDataSource("CbAccount");

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = TCbAccountDataSourceProtocol2926_2();
        return true;
    end;

    /* Данные для строк 3_1,4_1,5_1,6_1, 8, 9, 9.1, 10, 11, 13*/
    macro getDataRowX(filter, subtractionSign, useMaturity)
        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        if ((useMaturity == NULL) or (valType(useMaturity) == V_UNDEF))
            useMaturity = true;
        end;

        var commandText = "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_calcReserveAmount,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.t_account,"
                 + "\n" + "                 acc.t_chapter,"
                 + "\n" + "                 acc.t_fiId,"
                 + "\n" + "                 acc.t_qualityCategory,"
                 + "\n" + "                 acc.t_acc_maturityDate,"
                 + "\n" + "                 acc.t_acc_outCoverRest,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 acc.t_calcReserveAmount,";

        if (useMaturity)
            commandText = commandText + "   CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 1)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 5)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 10)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 20)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 30)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 90)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 180) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 270) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                               or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column10,";
        else
            commandText = commandText + "   t_acc_outCoverRest t_column2,"
                 + "\n" + "                 t_acc_outCoverRest t_column3,"
                 + "\n" + "                 t_acc_outCoverRest t_column4,"
                 + "\n" + "                 t_acc_outCoverRest t_column5,"
                 + "\n" + "                 t_acc_outCoverRest t_column6,"
                 + "\n" + "                 t_acc_outCoverRest t_column7,"
                 + "\n" + "                 t_acc_outCoverRest t_column8,"
                 + "\n" + "                 t_acc_outCoverRest t_column9,"
                 + "\n" + "                 t_acc_outCoverRest t_column10,";
        end;

            commandText = commandText + "   t_acc_outCoverRest t_column11"
                 + "\n" + "            FROM df125account_tmp acc"
                 + "\n" + "           WHERE 1 = 1" + NVL(filter, " ")
                 + "\n" + "           UNION ALL"
                 + "\n" + "          SELECT acc.t_account,"
                 + "\n" + "                 acc.t_chapter,"
                 + "\n" + "                 acc.t_fiId,"
                 + "\n" + "                 acc.t_qualityCategory,"
                 + "\n" + "                 NULL t_acc_maturityDate,"
                 + "\n" + "                 NULL t_acc_outCoverRest,"
                 + "\n" + "                 pc.t_backOffice,"
                 + "\n" + "                 pc.t_number,"
                 + "\n" + "                 prs.t_maturitydate,"
                 + "\n" + "                 prs.t_roubleSum,"
                 + "\n" + "                 acc.t_calcReserveAmount,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 1)   or prs.t_maturitydate is null) THEN t_roubleSum END t_column2,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 5)   or prs.t_maturitydate is null) THEN t_roubleSum END t_column3,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 10)  or prs.t_maturitydate is null) THEN t_roubleSum END t_column4,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 20)  or prs.t_maturitydate is null) THEN t_roubleSum END t_column5,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 30)  or prs.t_maturitydate is null) THEN t_roubleSum END t_column6,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 90)  or prs.t_maturitydate is null) THEN t_roubleSum END t_column7,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 180) or prs.t_maturitydate is null) THEN t_roubleSum END t_column8,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 270) or prs.t_maturitydate is null) THEN t_roubleSum END t_column9,"
                 + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                               or prs.t_maturitydate is null) THEN t_roubleSum END t_column10,"
                 + "\n" + "                 t_roubleSum                                                                                                       t_column11"
                 + "\n" + "            FROM df125account_tmp acc,"
                 + "\n" + "                 repPercentRepaymentSchedule_vw prs,"
                 + "\n" + "                 repPercentContract_vw pc"
                 + "\n" + "           WHERE pc.t_chapter = acc.t_chapter"
                 + "\n" + "             AND pc.t_fiId    = acc.t_fiId"
                 + "\n" + "             AND pc.t_account = acc.t_account"
                 + "\n" + "             AND prs.t_contractId = pc.t_id"
                 + "\n" + "               " + NVL(filter, " ")
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_calcReserveAmount"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_calcReserveAmount";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /* Данные для строки 3.1, 4.1, 5.1, 6.1*/
    macro getDataRowY(filter, subtractionSign)
        var commandText = "";

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        commandText = "SELECT   t_account,"
             + "\n" + "         t_qualityCategory,"
             + "\n" + "         t_acc_maturityDate,"
             + "\n" + "         t_acc_outCoverRest,"
             + "\n" + "         t_backOffice,"
             + "\n" + "         t_number,"
             + "\n" + "         t_maturitydate,"
             + "\n" + "         t_roubleSum,"
             + "\n" + "         t_calcReserveAmount,"
             + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
             + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
             + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
             + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
             + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
             + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
             + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
             + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
             + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
             + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
             + "\n" + "    FROM ("
             + "\n" + "          SELECT acc.t_account,"
             + "\n" + "                 acc.t_chapter,"
             + "\n" + "                 acc.t_fiId,"
             + "\n" + "                 acc.t_qualityCategory,"
             + "\n" + "                 acc.t_acc_maturityDate,"
             + "\n" + "                 acc.t_acc_outCoverRest,"
             + "\n" + "                 NULL t_backOffice,"
             + "\n" + "                 NULL t_number,"
             + "\n" + "                 NULL t_maturitydate,"
             + "\n" + "                 NULL t_roubleSum,"
             + "\n" + "                 t_calcReserveAmount,"
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 1)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column2, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 5)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column3, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 10)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column4, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 20)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column5, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 30)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column6, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 90)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column7, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 180) or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column8, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 270) or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column9, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()) "
             + "\n" + "                                                                               or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column10,"
             + "\n" + "                 t_acc_outCoverRest - t_calcReserveAmount t_column11"
             + "\n" + "            FROM df125account_tmp acc"
             + "\n" + "           WHERE 1 = 1" + NVL(filter, " ")
             + "\n" + "          UNION ALL"
             + "\n" + "          SELECT acc.t_account,"
             + "\n" + "                 acc.t_chapter,"
             + "\n" + "                 acc.t_fiId,"
             + "\n" + "                 acc.t_qualityCategory,"
             + "\n" + "                 NULL t_acc_maturityDate,"
             + "\n" + "                 NULL t_acc_outCoverRest,"
             + "\n" + "                 pc.t_backOffice,"
             + "\n" + "                 pc.t_number,"
             + "\n" + "                 prs.t_maturitydate,"
             + "\n" + "                 prs.t_roubleSum,"
             + "\n" + "                 NVL(t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest, 0) t_calcReserveAmount,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 1)   or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column2,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 5)   or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column3,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 10)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column4,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 20)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column5,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 30)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column6,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 90)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column7,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 180) or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column8,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 270) or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column9,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
             + "\n" + "                                                                               or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest END t_column10,"
             + "\n" + "                 t_roubleSum - t_roubleSum * NVL(reserve.t_endDateReserveAmount, 0) / t_acc_outCoverRest                                                                                                      t_column11"
             + "\n" + "            FROM df125account_tmp acc,"
             + "\n" + "                 dRepReserveAccount_vw reserve,"
             + "\n" + "                 repPercentRepaymentSchedule_vw prs,"
             + "\n" + "                 repPercentContract_vw pc"
             + "\n" + "           WHERE pc.t_chapter = acc.t_chapter"
             + "\n" + "             AND pc.t_fiId    = acc.t_fiId"
             + "\n" + "             AND pc.t_account = acc.t_account"
             + "\n" + "             AND prs.t_contractId = pc.t_id"
             + "\n" + "             AND acc.t_accountId = reserve.t_connectAccountId (+)"
             + "\n" + "               " + NVL(filter, " ")
             + "\n" + "         ) listacc"
             + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
             + "\n" + "                  t_qualityCategory,"
             + "\n" + "                  t_acc_maturityDate,"
             + "\n" + "                  t_acc_outCoverRest,"
             + "\n" + "                  t_backOffice,"
             + "\n" + "                  t_number,"
             + "\n" + "                  t_maturitydate,"
             + "\n" + "                  t_roubleSum,"
             + "\n" + "                  t_calcReserveAmount"
             + "\n" + "                ))"
             + "\n" + "ORDER BY GROUPING(t_account) DESC,"
             + "\n" + "         t_account, t_chapter, t_fiid,"
             + "\n" + "         t_qualityCategory,"
             + "\n" + "         t_acc_maturityDate,"
             + "\n" + "         t_acc_outCoverRest,"
             + "\n" + "         t_backOffice,"
             + "\n" + "         t_number,"
             + "\n" + "         t_maturitydate,"
             + "\n" + "         t_roubleSum,"
             + "\n" + "         t_calcReserveAmount";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /* Данные для строки 1_1*/
    macro getDataRow1_1(filter, subtractionSign, useRestNotDown, useReserve)
        var restNotDown;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        if ((useReserve == NULL) or (valType(useReserve) == V_UNDEF))
            useReserve = false;
        end;


        if (useRestNotDown)
            restNotDown = "NVL((SELECT rep_utl.castRawToMoney(t_text)                                    "
                 + "\n" + "       FROM dnoteText_dbt                                                     "
                 + "\n" + "      WHERE t_objectType = " + RCB_OBJTYPE_ACCOUNT
                 + "\n" + "        AND t_documentId = TO_CHAR (acc.t_chapter, 'FM0x')                    "
                 + "\n" + "                        || TO_CHAR (acc.t_fiId, 'FM0xxxxxx') || acc.t_account "
                 + "\n" + "        AND t_noteKind = " + NOTEKIND_REST_NOT_DOWN
                 + "\n" + "        AND rep_data.getEndDate() BETWEEN t_date  AND t_validToDate), 0)      ";
        else
            restNotDown = "NULL";
        end;

         var commandText = "WITH account AS"
                 + "\n" + "("
                 + "\n" + "SELECT accounts.t_account,"
                 + "\n" + "       accounts.t_chapter,"
                 + "\n" + "       accounts.t_fiId,"
                 + "\n" + "       accounts.t_qualityCategory,"
                 + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "       CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown) > 0 "
                 + "\n" + "            THEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown)"
                 + "\n" + "            ELSE 0"
                 + "\n" + "       END t_acc_outCoverRest,";
            else
                if (useReserve)
                    commandText = commandText
                     + "\n" + "       CASE WHEN  NVL(accounts.t_reservesum, 0) <> 0 "
                     + "\n" + "            THEN"
                     + "\n" + "               CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_reserveSum) > 0 "
                     + "\n" + "                    THEN (accounts.t_acc_outCoverRest - accounts.t_reserveSum)"
                     + "\n" + "                    ELSE 0"
                     + "\n" + "               END"
                     + "\n" + "            ELSE accounts.t_acc_outCoverRest"
                     + "\n" + "       END t_acc_outCoverRest,";
                else
                    commandText = commandText + "accounts.t_acc_outCoverRest t_acc_outCoverRest,";
                end;
            end;

            commandText = commandText
                 + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
                 + "\n" + "       accounts.t_restNotDown t_restNotDown,"
                 + "\n" + "       accounts.t_reserveSum t_reserveSum,"
                 + "\n" + "       accounts.t_calcReserveAmount t_calcReserveAmount,"
                 + "\n" + "       accounts.t_reserveAccount t_reserveAccount,"
                 + "\n" + "       accounts.t_reservePercent t_reservePercent"
                 + "\n" + "  FROM (SELECT acc.t_account,"
                 + "\n" + "               acc.t_chapter,"
                 + "\n" + "               acc.t_fiId,"
                 + "\n" + "               acc.t_qualityCategory,"
                 + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,"
                 + "\n" + "               acc.t_reservePercent   t_reservePercent,";

            if (useRestNotDown)
                commandText = commandText
                 + "\n" + "               CASE WHEN (acc.t_fiId <> 0)"
                 + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(" + restNotDown + ", acc.t_fiId, 0," + RATETYPE_CB + ", rep_data.getEndDate()), 0)"
                 + "\n" + "                    ELSE " + restNotDown
                 + "\n" + "               END ";
            else
                commandText = commandText + restNotDown;
            end;

            commandText = commandText + " t_restNotDown, ";

            if (useReserve)
                commandText = commandText + " NVL(reserve.t_reserveAccount, NULL)    t_reserveAccount,"
                                   + "\n" + " NVL(reserve.t_endDateReserveAmount, 0) t_reserveSum,"
                                   + "\n" + " t_calcReserveAmount t_calcReserveAmount";
            else
                commandText = commandText + " NULL t_reserveAccount,"
                                   + "\n" + " 0    t_reserveSum,"
                                   + "\n" + " 0    t_calcReserveAmount";
            end;

            commandText = commandText + " FROM df125account_tmp acc";

            if (useReserve)
                commandText = commandText + ", dRepReserveAccount_vw reserve";
            end;

            commandText = commandText
                 + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ");

            if (useReserve)
                commandText = commandText + "AND acc.t_accountId = reserve.t_connectAccountId (+)";
            end;

            commandText = commandText
                 + "\n" + "       ) accounts"
                 + "\n" + ")"
                 + "\n" + "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         CASE"
                 + "\n" + "             WHEN t_account LIKE '202%' AND t_reserveAccount IS NOT NULL"
                 + "\n" + "                 THEN t_reserveSum"
                 + "\n" + "             WHEN t_qualityCategory = 2"
                 + "\n" + "                 THEN t_calcReserveAmount"
                 + "\n" + "             ELSE NULL"
                 + "\n" + "         END t_reserveSum,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.*,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 1)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 5)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 10)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 20)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 30)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 90)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 180) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 270) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                               or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column10,"
                 + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11"
                 + "\n" + "            FROM account acc"
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_rest,"
                 + "\n" + "                  t_restNotDown,"
                 + "\n" + "                  t_reserveAccount,"
                 + "\n" + "                  t_reserveSum,"
                 + "\n" + "                  t_reservePercent,"
                 + "\n" + "                  t_calcReserveAmount"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         t_reserveSum,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         t_calcReserveAmount";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocolRow1(data);

        data.moveFirst();

        return data;
    end;

    /* Данные для строки 1.1*/
    macro getDataRow11(filter, subtractionSign)
        var restNotDown;

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        restNotDown = "NVL((SELECT rep_utl.castRawToMoney(t_text)                                    "
             + "\n" + "       FROM dnoteText_dbt                                                     "
             + "\n" + "      WHERE t_objectType = " + RCB_OBJTYPE_ACCOUNT
             + "\n" + "        AND t_documentId = TO_CHAR (acc.t_chapter, 'FM0x')                    "
             + "\n" + "                        || TO_CHAR (acc.t_fiId, 'FM0xxxxxx') || acc.t_account "
             + "\n" + "        AND t_noteKind = " + NOTEKIND_REST_NOT_DOWN
             + "\n" + "        AND rep_data.getEndDate() BETWEEN t_date  AND t_validToDate), 0)      ";

         var commandText = "WITH account AS"
                 + "\n" + "("
                 + "\n" + "SELECT accounts.t_account,"
                 + "\n" + "       accounts.t_chapter,"
                 + "\n" + "       accounts.t_fiId,"
                 + "\n" + "       accounts.t_qualityCategory,"
                 + "\n" + "       accounts.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "       CASE WHEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown - (accounts.t_acc_outCoverRest - accounts.t_restNotDown) * accounts.t_reservePercent / 100 )> 0 "
                 + "\n" + "            THEN (accounts.t_acc_outCoverRest - accounts.t_restNotDown - (accounts.t_acc_outCoverRest - accounts.t_restNotDown) * accounts.t_reservePercent / 100)"
                 + "\n" + "            ELSE 0"
                 + "\n" + "       END t_acc_outCoverRest,"
                 + "\n" + "       accounts.t_acc_outCoverRest t_rest,"
                 + "\n" + "       accounts.t_restNotDown t_restNotDown,"
                 + "\n" + "       accounts.t_reserveSum t_reserveSum,"
                 + "\n" + "       accounts.t_reserveAccount t_reserveAccount,"
                 + "\n" + "       accounts.t_reservePercent t_reservePercent,"
                 + "\n" + "       accounts.t_calcReserveAmount t_calcReserveAmount"
                 + "\n" + "  FROM (SELECT acc.t_account,"
                 + "\n" + "               acc.t_chapter,"
                 + "\n" + "               acc.t_fiId,"
                 + "\n" + "               acc.t_qualityCategory,"
                 + "\n" + "               acc.t_acc_maturityDate t_acc_maturityDate,"
                 + "\n" + "               acc.t_acc_outCoverRest t_acc_outCoverRest,"
                 + "\n" + "               acc.t_reservePercent   t_reservePercent,"
                 + "\n" + "               acc.t_calcReserveAmount   t_calcReserveAmount,"
                 + "\n" + "               CASE WHEN (acc.t_fiId <> 0)"
                 + "\n" + "                    THEN NVL(rsb_fiinstr.convSumType(" + restNotDown + ", acc.t_fiId, 0," + RATETYPE_CB + ", rep_data.getEndDate()), 0)"
                 + "\n" + "                    ELSE " + restNotDown
                 + "\n" + "               END "
                 + "\n" + " t_restNotDown, "
                 + "\n" + "               NULL t_reserveAccount,"
                 + "\n" + "               0    t_reserveSum"
                 + "\n" + "      FROM df125account_tmp acc"
                 + "\n" + "         WHERE 1 = 1 " + NVL(filter, " ")
                 + "\n" + "       ) accounts"
                 + "\n" + ")"
                 + "\n" + "SELECT   t_account,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         CASE"
                 + "\n" + "             WHEN t_account LIKE '202%' AND t_reserveAccount IS NOT NULL"
                 + "\n" + "                 THEN t_reserveSum"
                 + "\n" + "             WHEN t_qualityCategory = 2"
                 + "\n" + "                 THEN t_calcReserveAmount"
                 + "\n" + "             ELSE NULL"
                 + "\n" + "         END t_reserveSum,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
                 + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
                 + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
                 + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
                 + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
                 + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
                 + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
                 + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
                 + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
                 + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
                 + "\n" + "    FROM ("
                 + "\n" + "          SELECT acc.*,"
                 + "\n" + "                 NULL t_backOffice,"
                 + "\n" + "                 NULL t_number,"
                 + "\n" + "                 NULL t_maturitydate,"
                 + "\n" + "                 NULL t_roubleSum,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 1)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column2,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 5)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column3,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 10)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column4,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 20)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column5,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 30)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column6,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 90)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column7,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 180) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column8,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 270) or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column9,"
                 + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                               or t_acc_maturityDate is null) THEN t_acc_outCoverRest END t_column10,"
                 + "\n" + "                 t_acc_outCoverRest                                                                                                      t_column11"
                 + "\n" + "            FROM account acc"
                 + "\n" + "         ) listacc"
                 + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
                 + "\n" + "                  t_qualityCategory,"
                 + "\n" + "                  t_acc_maturityDate,"
                 + "\n" + "                  t_acc_outCoverRest,"
                 + "\n" + "                  t_backOffice,"
                 + "\n" + "                  t_number,"
                 + "\n" + "                  t_maturitydate,"
                 + "\n" + "                  t_roubleSum,"
                 + "\n" + "                  t_rest,"
                 + "\n" + "                  t_restNotDown,"
                 + "\n" + "                  t_reserveAccount,"
                 + "\n" + "                  t_reserveSum,"
                 + "\n" + "                  t_reservePercent,"
                 + "\n" + "                  t_calcReserveAmount"
                 + "\n" + "                ))"
                 + "\n" + "ORDER BY GROUPING(t_account) DESC,"
                 + "\n" + "         t_account, t_chapter, t_fiid,"
                 + "\n" + "         t_qualityCategory,"
                 + "\n" + "         t_acc_maturityDate,"
                 + "\n" + "         t_acc_outCoverRest,"
                 + "\n" + "         t_backOffice,"
                 + "\n" + "         t_number,"
                 + "\n" + "         t_maturitydate,"
                 + "\n" + "         t_roubleSum,"
                 + "\n" + "         t_rest,"
                 + "\n" + "         t_restNotDown,"
                 + "\n" + "         t_reserveAccount,"
                 + "\n" + "         t_reserveSum,"
                 + "\n" + "         t_reservePercent,"
                 + "\n" + "         t_calcReserveAmount";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocolRow1(data);

        data.moveFirst();

        return data;
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T125CbAccountDataSourceFilter_2926_2();
        return true;
    end;
end;

class (T125CbAccountDataSource2926_2) T125CbAccountDataSource4099()
    initT125CbAccountDataSource2926_2("CbAccount");

    /* Данные для строки 3.1, 4.1, 5.1, 6.1*/
    macro getDataRowY(filter, subtractionSign)
        var commandText = "";

        if (subtractionSign != -1)
            subtractionSign = 1;
        end;

        commandText = "SELECT   t_account,"
             + "\n" + "         t_qualityCategory,"
             + "\n" + "         t_acc_maturityDate,"
             + "\n" + "         t_acc_outCoverRest,"
             + "\n" + "         t_backOffice,"
             + "\n" + "         t_number,"
             + "\n" + "         t_maturitydate,"
             + "\n" + "         t_roubleSum,"
             + "\n" + "         t_calcReserveAmount,"
             + "\n" + "         NVL(SUM(t_column2)*" + subtractionSign + ",  0) t_column2,"
             + "\n" + "         NVL(SUM(t_column3)*" + subtractionSign + ",  0) t_column3,"
             + "\n" + "         NVL(SUM(t_column4)*" + subtractionSign + ",  0) t_column4,"
             + "\n" + "         NVL(SUM(t_column5)*" + subtractionSign + ",  0) t_column5,"
             + "\n" + "         NVL(SUM(t_column6)*" + subtractionSign + ",  0) t_column6,"
             + "\n" + "         NVL(SUM(t_column7)*" + subtractionSign + ",  0) t_column7,"
             + "\n" + "         NVL(SUM(t_column8)*" + subtractionSign + ",  0) t_column8,"
             + "\n" + "         NVL(SUM(t_column9)*" + subtractionSign + ",  0) t_column9,"
             + "\n" + "         NVL(SUM(t_column10)*" + subtractionSign + ", 0) t_column10,"
             + "\n" + "         NVL(SUM(t_column11)*" + subtractionSign + ", 0) t_column11"
             + "\n" + "    FROM ("
             + "\n" + "          SELECT acc.t_account,"
             + "\n" + "                 acc.t_chapter,"
             + "\n" + "                 acc.t_fiId,"
             + "\n" + "                 acc.t_qualityCategory,"
             + "\n" + "                 acc.t_acc_maturityDate,"
             + "\n" + "                 acc.t_acc_outCoverRest,"
             + "\n" + "                 NULL t_backOffice,"
             + "\n" + "                 NULL t_number,"
             + "\n" + "                 NULL t_maturitydate,"
             + "\n" + "                 NULL t_roubleSum,"
             + "\n" + "                 t_calcReserveAmount,"
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 1)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column2, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 5)   or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column3, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 10)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column4, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 20)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column5, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 30)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column6, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 90)  or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column7, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 180) or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column8, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= 270) or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column9, "
             + "\n" + "                 CASE WHEN ((t_acc_maturityDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()) "
             + "\n" + "                                                                               or t_acc_maturityDate is null) THEN t_acc_outCoverRest - t_calcReserveAmount END t_column10,"
             + "\n" + "                 t_acc_outCoverRest - t_calcReserveAmount t_column11"
             + "\n" + "            FROM df125account_tmp acc"
             + "\n" + "           WHERE 1 = 1" + NVL(filter, " ")
             + "\n" + "          UNION ALL"
             + "\n" + "          SELECT acc.t_account,"
             + "\n" + "                 acc.t_chapter,"
             + "\n" + "                 acc.t_fiId,"
             + "\n" + "                 acc.t_qualityCategory,"
             + "\n" + "                 NULL t_acc_maturityDate,"
             + "\n" + "                 NULL t_acc_outCoverRest,"
             + "\n" + "                 pc.t_backOffice,"
             + "\n" + "                 pc.t_number,"
             + "\n" + "                 prs.t_maturitydate,"
             + "\n" + "                 prs.t_roubleSum,"
             + "\n" + "                 NVL(t_roubleSum * NVL(acc.t_reservePercent, 0) / 100, 0) t_calcReserveAmount,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 1)   or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column2,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 5)   or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column3,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 10)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column4,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 20)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column5,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 30)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column6,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 90)  or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column7,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 180) or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column8,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= 270) or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column9,"
             + "\n" + "                 CASE WHEN ((prs.t_maturitydate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
             + "\n" + "                                                                               or prs.t_maturitydate is null) THEN t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100 END t_column10,"
             + "\n" + "                 t_roubleSum - t_roubleSum * NVL(acc.t_reservePercent, 0) / 100                                                                                                      t_column11"
             + "\n" + "            FROM df125account_tmp acc,"
             + "\n" + "                 dRepReserveAccount_vw reserve,"
             + "\n" + "                 repPercentRepaymentSchedule_vw prs,"
             + "\n" + "                 repPercentContract_vw pc"
             + "\n" + "           WHERE pc.t_chapter = acc.t_chapter"
             + "\n" + "             AND pc.t_fiId    = acc.t_fiId"
             + "\n" + "             AND pc.t_account = acc.t_account"
             + "\n" + "             AND prs.t_contractId = pc.t_id"
             + "\n" + "             AND acc.t_accountId = reserve.t_connectAccountId (+)"
             + "\n" + "               " + NVL(filter, " ")
             + "\n" + "         ) listacc"
             + "\n" + "GROUP BY ROLLUP ((t_account, t_chapter, t_fiid,"
             + "\n" + "                  t_qualityCategory,"
             + "\n" + "                  t_acc_maturityDate,"
             + "\n" + "                  t_acc_outCoverRest,"
             + "\n" + "                  t_backOffice,"
             + "\n" + "                  t_number,"
             + "\n" + "                  t_maturitydate,"
             + "\n" + "                  t_roubleSum,"
             + "\n" + "                  t_calcReserveAmount"
             + "\n" + "                ))"
             + "\n" + "ORDER BY GROUPING(t_account) DESC,"
             + "\n" + "         t_account, t_chapter, t_fiid,"
             + "\n" + "         t_qualityCategory,"
             + "\n" + "         t_acc_maturityDate,"
             + "\n" + "         t_acc_outCoverRest,"
             + "\n" + "         t_backOffice,"
             + "\n" + "         t_number,"
             + "\n" + "         t_maturitydate,"
             + "\n" + "         t_roubleSum,"
             + "\n" + "         t_calcReserveAmount";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("t_acc_maturityDate", V_DATE);
        data.SetFieldType("maturityDate", V_DATE);
        data.SetFieldType("qualityCategory", V_INTEGER);
        data.SetFieldType("number", V_INTEGER);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;
end;

/**
 * Источник данных Лоанс.
 */
class (TLoansDataSource) T125LoansCreditDataSource()
    private macro constructor()
        initTLoansDataSource("loansCredit");
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T125LoansCreditDataSourceFilter();
        return true;
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = T125LoansCreditDataSourceProtocol();
        return true;
    end;

    /**
     * Очистить закешированные данные.
     */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df125TermDemand_tmp");
        sql_execute("TRUNCATE TABLE df125Interest_tmp");
        sql_execute("TRUNCATE TABLE df125Register_tmp");
        sql_execute("TRUNCATE TABLE df125Credit_tmp");
    end;

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        clear();

        var endDateStr = getSqlDate(rcbApplication().currentReport.context.period.endDate);
        var accruedInterest;
        var interestCondition;
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ", V_BOOL, accruedInterest, null);

        var creditFilter = rcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") +
                     " AND credit.t_isOpenedAtEndDate = 1"
                     " AND (   credit.t_type = " + LO_CREDIT    +
                     "      OR credit.t_type = " + LO_KARTA     +
                     "      OR credit.t_type = " + LO_GUARANTEE +
                     "      OR credit.t_type = " + LO_OVERDRAFT +
                     "      OR credit.t_type = " + LO_DEPOSIT + ")";

        var querySource =   "SELECT credit.t_id   AS a_creditNumber,"
                   + "\n" + "       credit.t_type AS a_type         "
                   + "\n" + "  FROM repLnsContract_vw credit, repLnsTranches_vw tranch        "
                   + "\n" + " WHERE (" + creditFilter + ")             "
                   + "\n" + "    AND credit.t_id = tranch.t_contractId  "
                   + "\n" + "    AND (tranch.t_isOpenedAtEndDate = 1)"
                   + "\n" + "GROUP BY credit.t_id, credit.t_type";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);

        command.execute();

        sql_execute(      " INSERT INTO df125Credit_tmp(t_creditId,                             "
                + "\n" + "                              t_creditNumber,                         "
                + "\n" + "                              t_creditType,                           "
                + "\n" + "                              t_trancheKind,                          "
                + "\n" + "                              t_trancheNumber,                        "
                + "\n" + "                              t_issueType,                            "
                + "\n" + "                              t_isCapitalized,                        "
                + "\n" + "                              t_finishDate,                           "
                + "\n" + "                              t_rvpsQualityCategory,                  "
                + "\n" + "                              t_reservePercent,                   "
                + "\n" + "                              t_rvpsSum,                          "
                + "\n" + "                              t_calcPercentRvpSum,                "
                + "\n" + "                              t_calcDelayedPercentRvpSum)         "
                + "\n" + "                      SELECT DISTINCT *                               "
                + "\n" + "                        FROM (                                        "
                + "\n" + "                            SELECT credit.t_id,                       "
                + "\n" + "                                   credit.t_number,                   "
                + "\n" + "                                   credit.t_type,                     "
                + "\n" + "                                   tranch.t_kind,                     "
                + "\n" + "                                   tranch.t_number AS t_trancheNumber,"
                + "\n" + "                                   credit.t_issueType,                "
                + "\n" + "                                   credit.t_isCapitalized,            "
                + "\n" + "                                   credit.t_finishDate,               "
                + "\n" + "                                   credit.t_rvpsQualityCategory,      "
                + "\n" + "                                   credit.t_rvpsReservePercent,       "
                + "\n" + "                                   reserve.t_rvpsSum,                  "
                + "\n" + "                                   tranch.t_CalcRVPPerc,        "
                + "\n" + "                                   tranch.t_CAlcRVPExpPerc  "
                + "\n" + "                              FROM repLnsReserve_vw  reserve,          "
                + "\n" + "                                   repLnsContract_vw  credit,          "
                + "\n" + "                                   repLnsTranches_vw tranch          "
                + "\n" + "                             WHERE credit.t_id = reserve.t_objectNumber AND credit.t_type = reserve.t_objectTypeid AND credit.t_id = tranch.t_contractId)");

        /*Наращенные проценты*/
        if (accruedInterest)
            sql_execute(      " INSERT INTO df125Interest_tmp(t_creditId,                                                                                        "
                    + "\n" + "                               t_creditType,                                                                                       "
                    + "\n" + "                               t_trancheKind,                                                                                      "
                    + "\n" + "                               t_trancheNumber,                                                                                    "
                    + "\n" + "                               t_creditNumber,                                                                                     "
                    + "\n" + "                               t_creditRiskGroup,                                                                                  "
                    + "\n" + "                               t_rvpsSum,                                                                                          "
                    + "\n" + "                               t_roubleSum,                                                                                        "
                    + "\n" + "                               t_reservePercent,                                                                                        "
                    + "\n" + "                               t_demandDate)                                                                                       "
                    + "\n" + "   SELECT t_creditId, t_creditType, t_trancheKind, t_trancheNumber, t_creditNumber, t_rvpsQualityCategory, t_rvpsSum,              "
                    + "\n" + "          (NVL(RSB_FIINSTR.convSum(A_PERCENTSUM , A_CURCODE , 0," + endDateStr +"), 0)) AS t_roubleSum , t_reservePercent, a_paydate "
                    + "\n" + "     FROM (                                                                                                                        "
                    + "\n" + "           SELECT contract.t_creditId,                                                                                             "
                    + "\n" + "                  contract.t_creditType,                                                                                           "
                    + "\n" + "                  contract.t_trancheKind,                                                                                          "
                    + "\n" + "                  contract.t_trancheNumber,                                                                                        "
                    + "\n" + "                  contract.t_creditNumber,                                                                                         "
                    + "\n" + "                  contract.t_rvpsQualityCategory,                                                                                  "
                    + "\n" + "                  contract.t_rvpsSum,                                                                                              "
                    + "\n" + "                  t_plannedpercentsum a_percentsum,                                                                                "
                    + "\n" + "                  contract.t_reservePercent,                                                                                              "
                    + "\n" + "                  t_plannedpaydate a_paydate,                                                                                      "
                    + "\n" + "                  DECODE (planpay.t_objecttypeid_ref, 6, NVL ((SELECT t_fiId                                                       "
                    + "\n" + "                                                                 FROM repLnsContract_vw cntrct                                     "
                    + "\n" + "                                                                WHERE cntrct.t_id = (SELECT t_creditnumber_ref                     "
                    + "\n" + "                                                                                       FROM dduty_crd_dbt                          "
                    + "\n" + "                                                                                      WHERE t_dutyid = planpay.t_objectid_ref)),   "
                    + "\n" + "                                                             0),                                                                   "
                    + "\n" + "                          NVL ((SELECT t_fiId                                                                                      "
                    + "\n" + "                                  FROM repLnsContract_vw cntrct                                                                    "
                    + "\n" + "                                 WHERE cntrct.t_id = t_creditId),                                                                  "
                    + "\n" + "                               0)) a_curcode                                                                                       "
                    + "\n" + "             FROM dplanpay_dbt planpay, df125Credit_tmp contract                                                                   "
                    + "\n" + "            WHERE planpay.t_plannedpercentsum > 0                                                                                  "
                    + "\n" + "              AND planpay.t_type IN (0, 4)                                                                                         "
                    + "\n" + "              AND planpay.t_credoperid_ref = (SELECT MAX (lgpayop.t_credoperid_ref)                                                "
                    + "\n" + "                                                FROM dlgpayop_dbt lgpayop                                                          "
                    + "\n" + "                                                     JOIN dcrd_op_dbt crd_op                                                       "
                    + "\n" + "                                                       ON crd_op.t_credoperid = lgpayop.t_credoperid_ref                           "
                    + "\n" + "                                               WHERE crd_op.t_objectid_ref = planpay.t_objectid_ref                                "
                    + "\n" + "                                                 AND lgpayop.t_type IN (0, 4)                                                      "
                    + "\n" + "                                                 AND crd_op.t_objecttypeid_ref = planpay.t_objecttypeid_ref                        "
                    + "\n" + "                                                 AND crd_op.t_credoperdate <= " + endDateStr
                    + "\n" + "                                              )                                                                                    "
                    + "\n" + "              AND contract.t_trancheKind = planPay.t_objecttypeid_ref                                                              "
                    + "\n" + "              AND contract.t_trancheNumber = planPay.t_objectid_ref                                                                "
                    + "\n" + "              AND contract.t_rvpsQualityCategory IN (1, 2)                                                                         "
                    + "\n" + "              AND t_plannedpercentsum <> 0                                                                                         "
                    + "\n" + "              AND contract.t_creditType != " + LO_DEPOSIT
                    + "\n" + "              AND t_plannedpaydate > " + endDateStr + ")" );
        end;

        /*Срочное требование*/
        sql_execute(      " INSERT INTO df125TermDemand_tmp(t_creditId,                                        "
                 + "\n" + "                                 t_creditType,                                      "
                 + "\n" + "                                 t_trancheKind,                                     "
                 + "\n" + "                                 t_trancheNumber,                                   "
                 + "\n" + "                                 t_creditNumber,                                    "
                 + "\n" + "                                 t_creditRiskGroup,                                 "
                 + "\n" + "                                 t_roubleSum,                                       "
                 + "\n" + "                                 t_demandDate,                                      "
                 + "\n" + "                                 t_reservePercent)                                      "
                 + "\n" + "   SELECT t_creditId, t_creditType, t_trancheKind, t_trancheNumber, t_creditNumber, t_rvpsQualityCategory,                             "
                 + "\n" + "          NVL(RSB_FIINSTR.ConvSum(a_restSum, a_curcode,  0, " + endDateStr + "), 0) AS t_roubleRest,                                   "
                 + "\n" + "          a_enddate AS t_repaymentDate, t_reservePercent                                                                                                 "
                 + "\n" + "     FROM (SELECT *                                                                                                                    "
                 + "\n" + "             FROM (SELECT credit.t_creditId, credit.t_creditType, credit.t_trancheKind, credit.t_trancheNumber, credit.t_creditNumber, "
                 + "\n" + "                          credit.t_rvpsQualityCategory, lns.a_objecttypeid AS a_objecttypeid,                                          "
                 + "\n" + "                          lns.a_objectnumber AS a_objectnumber,                                                                        "
                 + "\n" + "                          grp.a_enddate AS a_enddate,                                                                                  "
                 + "\n" + "                          lns.a_curcode,                                                                                               "
                 + "\n" + "                          grp.a_restsum AS a_restsum,                                                                                  "
                 + "\n" + "                          grp.t_reservePercent                                                                                   "
                 + "\n" + "                     FROM (SELECT a_objecttypeid,                                                                                      "
                 + "\n" + "                                  a_objectnumber,                                                                                      "
                 + "\n" + "                                  a_enddate,                                                                                           "
                 + "\n" + "                                  NVL (LEAST (a_sum, GREATEST (0, a_sumprev - a_sumparm + a_restsum)),  0) AS a_restsum,               "
                 + "\n" + "                                  t_reservePercent                                                                              "
                 + "\n" + "                             FROM (SELECT planpay.t_objecttypeid_ref AS a_objecttypeid,                                                "
                 + "\n" + "                                          planpay.t_objectid_ref AS a_objectnumber,                                                    "
                 + "\n" + "                                          planpay.t_plannedpaydate AS a_enddate,                                                       "
                 + "\n" + "                                          MIN(planpay.t_plannedpaysum) + SUM(planpay.t_plannedpaysumex) AS a_sum,                      "
                 + "\n" + "                                          SUM (SUM (planpay.t_plannedpaysum + planpay.t_plannedpaysumex)) OVER (PARTITION BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref) AS a_sumparm,                                   "
                 + "\n" + "                                          SUM (SUM (planpay.t_plannedpaysum + planpay.t_plannedpaysumex)) OVER ( PARTITION BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref ORDER BY planpay.t_plannedpaydate) AS a_sumprev,"
                 + "\n" + "                                          (SELECT NVL(SUM (dutyrest.t_restsum), 0) AS a_restsum                         "
                 + "\n" + "                                             FROM dlcusreg_dbt lcusreg, ddutyrest_dbt dutyrest                          "
                 + "\n" + "                                            WHERE lcusreg.t_regid IN (1, 16, 62)                                        "
                 + "\n" + "                                              AND dutyrest.t_id_ref = lcusreg.t_id                                      "
                 + "\n" + "                                              AND dutyrest.t_restdate = (SELECT MAX (dr.t_restdate)                     "
                 + "\n" + "                                                                           FROM ddutyrest_dbt dr                        "
                 + "\n" + "                                                                          WHERE dr.t_restdate <= " + endDateStr
                 + "\n" + "                                                                            AND dr.t_id_ref = dutyrest.t_id_ref)        "
                 + "\n" + "                                          )  AS a_restSum,                                                              "
                 + "\n" + "                                          credit.t_reservePercent                                                               "
                 + "\n" + "                                     FROM dplanpay_dbt planpay, df125Credit_tmp credit                                  "
                 + "\n" + "                                    WHERE planpay.t_plannedpaysum + planpay.t_plannedpaysumex > 0                       "
                 + "\n" + "                                      AND credit.t_trancheKind = planpay.t_objectTypeId_ref                             "
                 + "\n" + "                                      AND credit.t_trancheNumber = planpay.t_objectId_ref                               "
                 + "\n" + "                                      AND credit.t_rvpsQualityCategory IN (1, 2)                                        "
                 + "\n" + "                                      AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                                      AND EXISTS (SELECT 1                                                              "
                 + "\n" + "                                                    FROM dcrd_op_dbt crd_op                                             "
                 + "\n" + "                                                   WHERE planpay.t_credoperid_ref = t_credoperid                        "
                 + "\n" + "                                                     AND planpay.t_objectid_ref = crd_op.t_objectid_ref                 "
                 + "\n" + "                                                     AND planpay.t_objecttypeid_ref = crd_op.t_objecttypeid_ref         "
                 + "\n" + "                                                     AND crd_op.t_systemoperationid IN (2, 28)                          "
                 + "\n" + "                                                     AND crd_op.t_credoperdate <= " + endDateStr
                 + "\n" + "                                                     AND crd_op.t_isdeleted = 0                                         "
                 + "\n" + "                                                     AND crd_op.t_credoperid = loansuserfunction.getlastcredoperid_forplanpay (planpay.t_objecttypeid_ref, "
                 + "\n" + "                                                                                                                               planpay.t_objectid_ref,     "
                 + "\n" + "                                                                                                                               planpay.t_type,             "
                 + "\n" + "                                                                                                          " + endDateStr + "   ) )     "
                 + "\n" + "                                 GROUP BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref, planpay.t_plannedpaydate, credit.t_reservePercent) "
                 + "\n" + "                        UNION ALL                                                                                       "
                 + "\n" + "                           SELECT lcusreg.t_objecttypeid AS a_objecttypeid,                                             "
                 + "\n" + "                                  lcusreg.t_objectnumber AS a_objectnumber,                                             "
                 + "\n" + "                                 (SELECT sel.a_endDate                                                                  "
                 + "\n" + "                                    FROM (SELECT (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_crd_kind                                       "
                 + "\n" + "                                                  ELSE 6                                                                "
                 + "\n" + "                                                   END) AS a_objecttypeid,                                              "
                 + "\n" + "                                                 (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_creditnumber                                   "
                 + "\n" + "                                                  ELSE duty_crd.t_dutyid                                                "
                 + "\n" + "                                                   END) AS a_objectnumber,                                              "
                 + "\n" + "                                                 (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_returndate                                     "
                 + "\n" + "                                                  ELSE duty_crd.t_dutylastdate                                          "
                 + "\n" + "                                                  END) AS a_enddate                                                     "
                 + "\n" + "                                            FROM dcredit_c_dbt credit_c                                                 "
                 + "\n" + "                                                 LEFT JOIN dduty_crd_dbt duty_crd                                       "
                 + "\n" + "                                                        ON credit_c.t_creditnumber = duty_crd.t_creditnumber_ref) sel   "
                 + "\n" + "                                   WHERE lcusreg.t_objecttypeid = sel.a_objecttypeid                                    "
                 + "\n" + "                                     AND lcusreg.t_objectnumber = sel.a_objectnumber) AS a_endDate,                     "
                 + "\n" + "                                  SUM (dutyrest.t_restsum) AS a_restsum,                                                "
                 + "\n" + "                                  credit.t_reservePercent                                                                      "
                 + "\n" + "                             FROM dlcusreg_dbt lcusreg                                                                  "
                 + "\n" + "                                  JOIN ddutyrest_dbt dutyrest                                                           "
                 + "\n" + "                                    ON dutyrest.t_id_ref = lcusreg.t_id,                                                "
                 + "\n" + "                                  df125Credit_tmp credit                                                                "
                 + "\n" + "                            WHERE credit.t_trancheKind = lcusreg.t_objecttypeid                                         "
                 + "\n" + "                              AND credit.t_trancheNumber = lcusreg.t_objectnumber                                       "
                 + "\n" + "                              AND credit.t_rvpsQualityCategory IN (1, 2)                                                "
                 + "\n" + "                              AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                              AND lcusreg.t_regid IN (1, 16, 62)                                                        "
                 + "\n" + "                              AND NOT EXISTS(SELECT 1                                                                   "
                 + "\n" + "                                               FROM dplanpay_dbt pp                                                     "
                 + "\n" + "                                              WHERE pp.t_objecttypeid_ref =  lcusreg.t_objecttypeid                     "
                 + "\n" + "                                                AND pp.t_objectid_ref = lcusreg.t_objectnumber                          "
                 + "\n" + "                                                AND ROWNUM = 1)                                                         "
                 + "\n" + "                              AND dutyrest.t_restdate = (SELECT MAX (dr.t_restdate)                                     "
                 + "\n" + "                                                           FROM ddutyrest_dbt dr                                        "
                 + "\n" + "                                                          WHERE dr.t_restdate <= " + endDateStr
                 + "\n" + "                                                            AND dr.t_id_ref = dutyrest.t_id_ref)                        "
                 + "\n" + "                         GROUP BY lcusreg.t_objecttypeid, lcusreg.t_objectnumber, credit.t_reservePercent) grp,         "
                 + "\n" + "                    (SELECT sel.a_objecttypeid,                                                                         "
                 + "\n" + "                            sel.a_objectnumber,                                                                         "
                 + "\n" + "                            sel.a_curcode,                                                                              "
                 + "\n" + "                           (CASE sel.a_objecttypeid                                                                     "
                 + "\n" + "                            WHEN 6                                                                                      "
                 + "\n" + "                              THEN NVL (                                                                                "
                 + "\n" + "                                       (SELECT MIN (crd_op.t_credoperdate)                                              "
                 + "\n" + "                                          FROM dcrd_op_dbt crd_op                                                       "
                 + "\n" + "                                         WHERE crd_op.t_isdeleted = 0                                                   "
                 + "\n" + "                                           AND crd_op.t_stageid_ref = 99                                                "
                 + "\n" + "                                           AND crd_op.t_objecttypeid_ref = sel.a_objecttypeid                           "
                 + "\n" + "                                           AND crd_op.t_objectid_ref = sel.a_objectnumber                               "
                 + "\n" + "                                           AND crd_op.t_creditnumber_ref = sel.a_creditnumber                           "
                 + "\n" + "                                           AND crd_op.t_isdeleted = 0                                                   "
                 + "\n" + "                                           AND crd_op.t_systemoperationid = 2),                                         "
                 + "\n" + "                                      TO_DATE ('01.01.0001', 'dd.mm.yyyy'))                                             "
                 + "\n" + "                              ELSE                                                                                      "
                 + "\n" + "                                  CASE sel.a_paytype                                                                    "
                 + "\n" + "                                   WHEN 6                                                                               "
                 + "\n" + "                                    THEN TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                           "
                 + "\n" + "                                    ELSE                                                                                "
                 + "\n" + "                                         NVL (                                                                          "
                 + "\n" + "                                             (SELECT MIN (crd_op.t_credoperdate)                                        "
                 + "\n" + "                                                FROM dcrd_op_dbt crd_op                                                 "
                 + "\n" + "                                               WHERE crd_op.t_isdeleted = 0                                             "
                 + "\n" + "                                                 AND crd_op.t_stageid_ref = 99                                          "
                 + "\n" + "                                                 AND crd_op.t_objecttypeid_ref = sel.a_objecttypeid                     "
                 + "\n" + "                                                 AND crd_op.t_objectid_ref = sel.a_objectnumber                         "
                 + "\n" + "                                                 AND crd_op.t_creditnumber_ref = sel.a_creditnumber                     "
                 + "\n" + "                                                 AND crd_op.t_isdeleted = 0                                             "
                 + "\n" + "                                                 AND crd_op.t_systemoperationid = 2),                                   "
                 + "\n" + "                                       TO_DATE ('01.01.0001', 'dd.mm.yyyy'))                                            "
                 + "\n" + "                                    END                                                                                 "
                 + "\n" + "                              END)  AS a_paydate                                                                        "
                 + "\n" + "                    FROM (SELECT credit_c.t_creditnumber AS a_creditnumber,                                             "
                 + "\n" + "                                (CASE NVL (duty_crd.t_dutyid, 0)                                                        "
                 + "\n" + "                                 WHEN 0 THEN credit_c.t_crd_kind                                                        "
                 + "\n" + "                                 ELSE 6                                                                                 "
                 + "\n" + "                                 END) AS a_objecttypeid,                                                                "
                 + "\n" + "                                (CASE NVL (duty_crd.t_dutyid, 0)                                                        "
                 + "\n" + "                                 WHEN 0 THEN credit_c.t_creditnumber                                                    "
                 + "\n" + "                                 ELSE duty_crd.t_dutyid                                                                 "
                 + "\n" + "                                 END) AS a_objectnumber,                                                                "
                 + "\n" + "                                credit_c.t_curcode AS a_curcode,                                                        "
                 + "\n" + "                                credit_c.t_paytype AS a_paytype                                                         "
                 + "\n" + "                           FROM dcredit_c_dbt credit_c                                                                  "
                 + "\n" + "                             LEFT JOIN dduty_crd_dbt duty_crd                                                           "
                 + "\n" + "                                    ON credit_c.t_creditnumber = duty_crd.t_creditnumber_ref) sel) lns,                 "
                 + "\n" + "                                df125Credit_tmp credit                                                                  "
                 + "\n" + "                          WHERE grp.a_objecttypeid = lns.a_objecttypeid                                                 "
                 + "\n" + "                            AND grp.a_objectnumber = lns.a_objectnumber                                                 "
                 + "\n" + "                            AND lns.a_objectTypeId = credit.t_trancheKind                                               "
                 + "\n" + "                            AND lns.a_objectnumber = credit.t_trancheNumber                                             "
                 + "\n" + "                            AND credit.t_rvpsQualityCategory IN (1, 2)                                                  "
                 + "\n" + "                            AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                            AND grp.a_restSum <> 0                                                                      "
                 + "\n" + "                            AND lns.a_paydate <= " + endDateStr
                 + "\n" + "                            AND (grp.a_enddate  > " + endDateStr
                 + "\n" + "                                 OR lns.a_paydate > grp.a_enddate))                                                     "
                 + "\n" + "                  WHERE EXISTS(SELECT t_credoperdate                                                                    "
                 + "\n" + "                                 FROM dcrd_op_dbt                                                                       "
                 + "\n" + "                                WHERE t_isdeleted = 0                                                                   "
                 + "\n" + "                                  AND t_objecttypeid_ref IN (a_objecttypeid, 6)                                         "
                 + "\n" + "                                  AND T_OBJECTID_REF = a_objectnumber                                                   "
                 + "\n" + "                                  AND t_systemoperationid IN (2, 5, 46)                                                 "
                 + "\n" + "                                  AND t_stageid_ref = 99)                                                               "
                 + "\n" + "   )");


        /* Регистры */
        sql_execute(      " INSERT INTO df125Register_tmp (t_creditId,                                                                                                        "
                 + "\n" + "                                t_creditNumber,                                                                                                    "
                 + "\n" + "                                t_creditType,                                                                                                      "
                 + "\n" + "                                t_creditRiskGroup,                                                                                                 "
                 + "\n" + "                                t_trancheKind,                                                                                                     "
                 + "\n" + "                                t_trancheNumber,                                                                                                   "
                 + "\n" + "                                t_creditIssueType,                                                                                                 "
                 + "\n" + "                                t_type,                                                                                                            "
                 + "\n" + "                                t_roubleRest,                                                                                                      "
                 + "\n" + "                                t_demandDate,                                                                                                      "
                 + "\n" + "                                t_reservePercent,                                                                                                  "
                 + "\n" + "                                t_calcPercentRvpSum,                                                                                               "
                 + "\n" + "                                t_calcDelayedPercentRvpSum)                                                                                        "
                 + "\n" + "             SELECT t_creditId, t_creditNumber,t_creditType, t_rvpsQualityCategory, t_trancheKind, t_trancheNumber, t_issueType, a_typereg t_type, "
                 + "\n" + "                    NVL(RSB_FIINSTR.ConvSum(a_regRest, a_curCode, 0, " + endDateStr + " ), 0) AS t_roubleRest, t_finishDate, t_reservePercent,     "
                 + "\n" + "                    t_calcPercentRvpSum, t_calcDelayedPercentRvpSum                                                                                "
                 + "\n" + "               FROM (SELECT  r.*,  contract.t_creditId, contract.t_creditNumber, contract.t_creditType, contract.t_trancheKind,                    "
                 + "\n" + "                             contract.t_trancheNumber, contract.t_issueType,t_rvpsQualityCategory, contract.t_finishDate,                          "
                 + "\n" + "                             contract.t_calcPercentRvpSum, contract.t_calcDelayedPercentRvpSum, contract.t_reservePercent,                         "
                 + "\n" + "                             MAX (a_daterest) OVER (PARTITION BY a_objectid, a_objectnumber, a_typereg) a_maxdate                                  "
                 + "\n" + "                       FROM ( SELECT lcusreg.t_regid AS a_typereg,                                                                                 "
                 + "\n" + "                                     dutyrest.t_restdate AS a_daterest,                                                                            "
                 + "\n" + "                                    (CASE lcusreg.t_objecttypeid                                                                                   "
                 + "\n" + "                                     WHEN 6                                                                                                        "
                 + "\n" + "                                     THEN                                                                                                          "
                 + "\n" + "                                        (SELECT credit_c.t_fiId                                                                                    "
                 + "\n" + "                                           FROM dduty_crd_dbt duty_crd, repLnsContract_vw credit_c                                                 "
                 + "\n" + "                                          WHERE duty_crd.t_dutyid           = lcusreg.t_objectnumber                                               "
                 + "\n" + "                                            AND duty_crd.t_creditnumber_ref = credit_c.t_id)                                                       "
                 + "\n" + "                                     ELSE                                                                                                          "
                 + "\n" + "                                        (SELECT credit_c.t_fiId                                                                                    "
                 + "\n" + "                                           FROM repLnsContract_vw credit_c                                                                         "
                 + "\n" + "                                          WHERE credit_c.t_id = lcusreg.t_creditNumber)                                                            "
                 + "\n" + "                                     END) AS a_curcode,                                                                                            "
                 + "\n" + "                                     lcusreg.t_objecttypeid AS a_objectid,                                                                         "
                 + "\n" + "                                     lcusreg.t_objectnumber AS a_objectnumber,                                                                     "
                 + "\n" + "                                     dutyrest.t_restsum AS a_regrest                                                                               "
                 + "\n" + "                                FROM ddutyrest_dbt dutyrest                                                                                        "
                 + "\n" + "                                JOIN dlcusreg_dbt lcusreg                                                                                          "
                 + "\n" + "                                  ON dutyrest.t_id_ref = lcusreg.t_id                                                                              "
                 + "\n" + "                              ) r, df125Credit_tmp contract                                                                                        "
                 + "\n" + "                      WHERE a_daterest <= " + endDateStr
                 + "\n" + "                        AND (a_daterest >= (SELECT NVL(max(dutyrest.t_restdate), to_date('01.01.0001', 'dd.mm.yyyy'))                              "
                 + "\n" + "                                              FROM ddutyrest_dbt dutyrest,  dlcusreg_dbt lcusreg                                                   "
                 + "\n" + "                                             WHERE dutyrest.t_id_ref      = lcusreg.t_id                                                           "
                 + "\n" + "                                               AND dutyrest.t_restdate   <= " + endDateStr
                 + "\n" + "                                               AND lcusreg.t_objecttypeid = r.a_OBJECTID                                                           "
                 + "\n" + "                                               AND lcusreg.t_objectnumber = r.a_OBJECTNUMBER                                                       "
                 + "\n" + "                                               AND lcusreg.t_regid        = r.a_TYPEREG                                                            "
                 + "\n" + "                                               AND dutyrest.t_restsum     = 0)                                                                     "
                 + "\n" + "                                            )                                                                                                      "
                 + "\n" + "                        AND contract.t_trancheKind   = r.a_objectId                                                                                "
                 + "\n" + "                        AND contract.t_trancheNumber = r.a_objectNumber                                                                            "
                 + "\n" + "                        AND contract.t_creditType   != " + LO_DEPOSIT
                 + "\n" + "                        AND (r.a_regrest <> 0 AND r.a_typereg IN (" + TDR_MAINREST            +" ,"
                                                                                               + TDR_EXPREST             +" ,"
                                                                                               + TDR_OV                  +" ,"
                                                                                               + TDR_EXPPAYMGUARANTEE    +" ,"
                                                                                               + TDR_EXPPERC             +" ,"
                                                                                               + TDR_EXPPERC_OV          +" ,"
                                                                                               + TDR_PAYMGUARANTEEEXPPERC+" ,"
                                                                                               + TDR_PAYMGUARANTEEPERCDEM+" ,"
                                                                                               + TDR_NOLIMGUAR+" ,"
                                                                                               + TDR_PAYMGUARANTEE       +" ,"
                                                                                               + TDR_PAYEDGUARANTEE      +" ,"
                                                                                               + TCLTR_LIMDUTY           +" ,"
                                                                                               + TDR_CLAIM               +" ,"
                                                                                               + TCLTR_LIMPAY + "))          "
                 + "\n" + "                      ) reg                                                                     "
                 + "\n" + "                WHERE a_daterest = a_maxdate "  );

        //удаляем регистры "Требования по срочным %" для договоров, у которых регистр "История ОД" не равен нулю
        if (accruedInterest)
            sql_execute(      " DELETE FROM df125Register_tmp r                    "
                     + "\n" + "       WHERE t_type = " + TDR_CLAIM
                     + "\n" + "         AND EXISTS(SELECT *                        "
                     + "\n" + "                     FROM df125Register_tmp         "
                     + "\n" + "                    WHERE t_type = " + TDR_MAINREST
                     + "\n" + "                      AND t_creditId = r.t_creditId)");
        end;

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(      " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                     "
                 + "\n" + "                                       t_backOfficeId,                "
                 + "\n" + "                                       t_creditId,                    "
                 + "\n" + "                                       t_fiId,                        "
                 + "\n" + "                                       t_cbAccountNumber)             "
                 + "\n" + "                                SELECT t_chapter,                     "
                 + "\n" + "                                       "+m_backOffice.getId+",        "
                 + "\n" + "                                       acc.t_contractId,              "
                 + "\n" + "                                       acc.t_fiId,                    "
                 + "\n" + "                                       acc.t_cbAccount                "
                 + "\n" + "                                  FROM repLnsAccount_vw acc           "
                 + "\n" + "                                WHERE  acc.t_cbAccount <> chr(1)      "
                 + "\n" + "                                  AND (   EXISTS (SELECT 1 FROM df125TermDemand_tmp  d WHERE acc.t_contractId = d.t_creditId)   "
                 + "\n" + "                                       OR EXISTS (SELECT 1 FROM df125Interest_tmp    i WHERE acc.t_contractId = i.t_creditId)   "
                 + "\n" + "                                       OR EXISTS (SELECT 1 FROM df125Register_tmp    r WHERE acc.t_contractId = r.t_creditId)) ");

        return true;
    end;

    /**
     * Сумма вклада физических лиц для срока.
     *
     *  @param     term   срок
     */
    private macro creditAmount(term)
        return        " CASE WHEN GROUPING(t_type)+GROUPING(t_creditid) <> 1                        "
             + "\n" + "      THEN SUM(CASE WHEN t_maturityterm <= "+term+" OR t_maturityterm IS NULL"
             + "\n" + "                    THEN t_sum                                               "
             + "\n" + "                    ELSE 0                                                   "
             + "\n" + "               END)                                                          "
             + "\n" + "      ELSE null                                                              "
             + "\n" + " END                                                                         ";
    end;

    /**
     * Получить данные по ссудной задолженности.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getLoanDebtsData(registerFilter/*filter : RcbDataSourceFilter, attribute : RcbAttributeBase*/, accruedInterest)
        var commandText = "SELECT  DECODE(GROUPING(t_tranchekind), 1,                                                               "
                 + "\n" + "        DECODE(t_creditType, 1, 'Кредит',                                                                "
                 + "\n" + "                            21, 'Гарантии',                                                              "
                 + "\n" + "                             8, 'Карта',                                                                 "
                 + "\n" + "                            22, 'Овердрафт',                                                             "
                 + "\n" + "                            to_char(t_creditType)                                                        "
                 + "\n" + "        ), chr(0))t_creditType,                                                                          "
                 + "\n" + "        DECODE(GROUPING(t_tranchekind), 1, t_creditNumber, chr(0))                                       "
                 + "\n" + "        t_number,                                                                                        "
                 + "\n" + "        chr(0) t_creditIssueType,                                                                        "
                 + "\n" + "        decode(t_type,  2, 'Просроченный ОД',                                                            "
                 + "\n" + "                        3, 'Просроченные проценты',                                                      "
                 + "\n" + "                        4, 'Требования по срочным %',                                                    "
                 + "\n" + "                        8, 'Неиспользованный лимит задолженности',                                       "
                 + "\n" + "                        7, 'Неиспользованный лимит выдачи',                                              "
                 + "\n" + "                       17, 'Просроченный неразрешенный ОД',                                              "
                 + "\n" + "                       18, 'Просроченные проценты по неразрешенному ОД',                                 "
                 + "\n" + "                       55, 'Выданная гарантия',                                                          "
                 + "\n" + "                       64, 'Просроченная оплаченная гарантия',                                           "
                 + "\n" + "                       65, 'Просроченные проценты по оплаченной гарантии',                               "
                 + "\n" + "                       10001, 'Срочное требование',                                                      "
                 + "\n" + "                       10002, 'Нарощенные проценты',                                                     "
                 + "\n" + "                       chr(0)                                                                            "
                 + "\n" + "                       )                                                                                 "
                 + "\n" + "                  t_type,                                                                                "
                 + "\n" + "        t_demanddate,                                                                                    "
                 + "\n" + "        sum(t_sum) t_sum,                                                                                "
                 + "\n" + "        " + creditAmount(  1) + "                                                           t_column2,   "
                 + "\n" + "        " + creditAmount(  5) + "                                                           t_column3,   "
                 + "\n" + "        " + creditAmount( 10) + "                                                           t_column4,   "
                 + "\n" + "        " + creditAmount( 20) + "                                                           t_column5,   "
                 + "\n" + "        " + creditAmount( 30) + "                                                           t_column6,   "
                 + "\n" + "        " + creditAmount( 90) + "                                                           t_column7,   "
                 + "\n" + "        " + creditAmount(180) + "                                                           t_column8,   "
                 + "\n" + "        " + creditAmount(270) + "                                                           t_column9,   "
                 + "\n" + "        " + creditAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()") + " t_column10,   "
                 + "\n" + "        " + creditAmount("t_maturityterm") + "                                             t_column11    "
                 + "\n" + "    FROM (SELECT reg.t_creditid,                                                                         "
                 + "\n" + "                 reg.t_creditnumber,                                                                     "
                 + "\n" + "                 reg.t_creditType,                                                                       "
                 + "\n" + "                 reg.t_tranchekind,                                                                      "
                 + "\n" + "                 reg.t_tranchenumber,                                                                    "
                 + "\n" + "                 reg.t_type t_type,                                                                      ";

            if (accruedInterest)
                commandText = commandText + " TO_DATE ('01.01.0001', 'dd.mm.yyyy') t_demanddate,                                   "
                 + "\n" + "                 0 t_maturityterm,                                                                      "
            else
                commandText = commandText + "CASE WHEN reg.t_type = " + TDR_CLAIM
                 + "\n" + "                       THEN t_accruedInterestDate                                                       "
                 + "\n" + "                       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                        "
                 + "\n" + "                  END t_demanddate,                                                                     "
                 + "\n" + "                  CASE WHEN reg.t_type = " + TDR_CLAIM
                 + "\n" + "                       THEN DECODE (t_accruedInterestDate,                                              "
                 + "\n" + "                                    TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                            "
                 + "\n" + "                                    t_accruedInterestDate - rep_data.getenddate ())                     "
                 + "\n" + "                       ELSE 0                                                                           "
                 + "\n" + "                   END t_maturityterm,                                                                  ";
            end;

            commandText = commandText + "    reg.t_roublerest t_sum                                                                ";

            if (accruedInterest)
                commandText = commandText + "FROM df125register_tmp reg";
            else
                commandText = commandText +" FROM (SELECT r.t_creditid, r.t_creditNumber, r.t_credittype, r.t_trancheKind, r.t_type,   "
                     + "\n" + "                         r.t_trancheNumber, r.t_demandDate, r.t_roubleRest, r.t_creditRiskGroup,        "
                     + "\n" + "                        (SELECT MIN(t_plannedPayDate)                                                   "
                     + "\n" + "                           FROM dplanpay_dbt planpay                                                    "
                     + "\n" + "                          WHERE planpay.t_type IN (0, 4)                                                                  "
                     + "\n" + "                            AND planpay.t_credoperid_ref = (SELECT MAX (lgpayop.t_credoperid_ref)                         "
                     + "\n" + "                                                              FROM dlgpayop_dbt lgpayop                                   "
                     + "\n" + "                                                                   JOIN dcrd_op_dbt crd_op                                "
                     + "\n" + "                                                                     ON crd_op.t_credoperid = lgpayop.t_credoperid_ref    "
                     + "\n" + "                                                             WHERE crd_op.t_objectid_ref = planpay.t_objectid_ref         "
                     + "\n" + "                                                               AND lgpayop.t_type IN (0, 4)                               "
                     + "\n" + "                                                               AND crd_op.t_objecttypeid_ref = planpay.t_objecttypeid_ref "
                     + "\n" + "                                                               AND crd_op.t_credoperdate <= rep_data.getenddate ()        "
                     + "\n" + "                                                        )                                                                 "
                     + "\n" + "                        AND r.t_trancheKind = planPay.t_objecttypeid_ref                                                  "
                     + "\n" + "                        AND r.t_trancheNumber = planPay.t_objectid_ref                                                    "
                     + "\n" + "                        AND planpay.t_plannedpercentsum <> 0                                                              "
                     + "\n" + "                        AND planpay.t_plannedpaydate > rep_data.getenddate ()) t_accruedInterestDate,                      "
                     + "\n" + "                        r.t_reservepercent                      "
                     + "\n" + "                    FROM df125register_tmp r) reg                                                                         ";

            end;

            commandText = commandText + " WHERE 1=1 "+registerFilter+"                                                              ";

            commandText = commandText + " UNION ALL                                                                                 "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10001 t_type,                                                                           "
                 + "\n" + "                 dem.t_demanddate,                                                                       "
                 + "\n" + "                 DECODE (dem.t_demanddate,                                                               "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         dem.t_demanddate - rep_data.getenddate ()                                       "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 dem.t_roublesum t_sum                                                                   "
                 + "\n" + "            FROM df125termdemand_tmp dem                                                                 "
                 + "\n" + "          UNION ALL                                                                                      "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10002 t_type,                                                                           "
                 + "\n" + "                 interest.t_demanddate,                                                                  "
                 + "\n" + "                 DECODE (interest.t_demanddate,                                                          "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         interest.t_demanddate - rep_data.getenddate ()                                  "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 interest.t_roublesum t_sum                                                              "
                 + "\n" + "            FROM df125Interest_tmp interest)                                                             "
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                                            "
                 + "\n" + "                  t_creditType,                                                                          "
                 + "\n" + "                  t_creditNumber),                                                                       "
                 + "\n" + "                 (t_tranchekind,                                                                         "
                 + "\n" + "                  t_tranchenumber,                                                                       "
                 + "\n" + "                 t_demanddate,                                                                           "
                 + "\n" + "                  t_type))                                                                               "
                 + "\n" + "ORDER BY grouping(t_creditid) desc ,                                                                     "
                 + "\n" + "         t_creditid,                                                                                     "
                 + "\n" + "         grouping(t_tranchekind) desc,                                                                   "
                 + "\n" + "         t_tranchekind,                                                                                  "
                 + "\n" + "         t_tranchenumber                                                                                 ";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",       V_MONEY);
        data.SetFieldType("column2",   V_MONEY);
        data.SetFieldType("column3",   V_MONEY);
        data.SetFieldType("column4",   V_MONEY);
        data.SetFieldType("column5",   V_MONEY);
        data.SetFieldType("column6",   V_MONEY);
        data.SetFieldType("column7",   V_MONEY);
        data.SetFieldType("column8",   V_MONEY);
        data.SetFieldType("column9",   V_MONEY);
        data.SetFieldType("column10",  V_MONEY);
        data.SetFieldType("column11",  V_MONEY);


        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /**
     * Получить данные по обязательствам и гарантиям.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getIssuedGuaranteesAndLiabilityData(filter/*filter : RcbDataSourceFilter, attribute : RcbAttributeBase*/, useMaturity)
        var commandText = "SELECT  DECODE(t_creditType,  1, 'Кредит',                                                                     "
                 + "\n" + "                             21, 'Гарантии',                                                                   "
                 + "\n" + "                              8, 'Карта',                                                                      "
                 + "\n" + "                             22, 'Овердрафт',                                                                  "
                 + "\n" + "                             to_char(t_creditType))                                         t_creditType,      "
                 + "\n" + "        t_creditNumber                                                                      t_number,          "
                 + "\n" + "        DECODE(t_creditIssueType, 3, 'Лимит выдачи+задолженности',                                             "
                 + "\n" + "                                  4, 'Невозобновляемая КЛ',                                                    "
                 + "\n" + "                                  5, 'Под лимит задолженности',                                                "
                 + "\n" + "                                  chr(0))                                                   t_creditIssueType, "
                 + "\n" + "        null                                                                                t_demanddate,      "
                 + "\n" + "        DECODE(t_type,  2, 'Просроч. ОД',                                                                      "
                 + "\n" + "                        3, 'Просроч. %',                                                                       "
                 + "\n" + "                        8, 'Неисп. лимит задолженности',                                                       "
                 + "\n" + "                        7, 'Неисп. лимит выдачи',                                                              "
                 + "\n" + "                       17, 'Проср. неразрешенный ОД',                                                          "
                 + "\n" + "                       18, 'Проср. % по неразреш. ОД',                                                         "
                 + "\n" + "                       55, 'Выданная гарантия',                                                                "
                 + "\n" + "                       64, 'Проср. оплаченная гарантия',                                                       "
                 + "\n" + "                       65, 'Проср. % по оплач.гарантии',                                                       "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "                       )                                                                    t_type,            "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_sum,             ";
            if (useMaturity)
                commandText = commandText
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=   1 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column2,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=   5 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column3,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=  10 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column4,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=  20 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column5,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=  30 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column6,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <=  90 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column7,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <= 180 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column8,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <= 270 or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column9,"
                 + "\n" + "        sum(CASE WHEN (reg.t_demandDate - rep_data.getEndDate()) <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate()"
                 + "\n" + "                                                                      or t_demandDate is null THEN reg.t_roublerest ELSE 0 END) t_column10,"
                 + "\n" + "        sum(reg.t_roublerest)                                                                                           t_column11";
            else
                commandText = commandText
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column2,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column3,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column4,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column5,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column6,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column7,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column8,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column9,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column10,        "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column11         ";
            end;

            commandText = commandText + " FROM df125register_tmp reg                                                                                 "
                 + "\n" + "    WHERE (t_creditType = 21 and t_type = 55)                                                                  "
                 + "\n" + "       OR (t_creditType in (8, 22) and t_type = 8)                                                             "
                 + "\n" + "       OR (t_creditType = 1 and ((t_creditIssueType = 4 and t_type = 7)                                        "
                 + "\n" + "                                  or                                                                           "
                 + "\n" + "                                 (t_creditIssueType = 5 and t_type = 8)                                        "
                 + "\n" + "                                 or                                                                            "
                 + "\n" + "                                 (t_creditIssueType = 3 and                                                    "
                 + "\n" + "                                  t_roublerest||t_type =                                                       "
                 + "\n" + "                                            (select MIN(r.t_roublerest||r.t_type)                              "/*нужно найти меньший остаток из регистров 7, 8*/
                 + "\n" + "                                              from df125register_tmp r                                         "/*t_roublerest||t_type, чтобы взять один из регистров если остатки равны*/
                 + "\n" + "                                             where r.t_type in (7, 8)                                          "
                 + "\n" + "                                               and r.t_creditId = reg.t_creditId                               "
                 + "\n" + "                                             group by r.t_creditId                                             "
                 + "\n" + "                                            )                                                                  "
                 + "\n" + "                                ))                                                                             "
                 + "\n" + "          )                                                                                                    "
                 + "\n" + "GROUP BY ROLLUP ((t_creditid, t_creditNumber, t_creditType, t_creditIssueType,                                 "
                 + "\n" + "        t_tranchekind,                                                                                         "
                 + "\n" + "        t_tranchenumber,                                                                                       "
                 + "\n" + "        t_type))                                                                                               "
                 + "\n" + "ORDER BY t_creditid,                                                                                           "
                 + "\n" + "         t_tranchekind                                                                                         "
                 + "\n" + "                                                                                                               ";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);
        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",        V_MONEY);
        data.SetFieldType("column2",    V_MONEY);
        data.SetFieldType("column3",    V_MONEY);
        data.SetFieldType("column4",    V_MONEY);
        data.SetFieldType("column5",    V_MONEY);
        data.SetFieldType("column6",    V_MONEY);
        data.SetFieldType("column7",    V_MONEY);
        data.SetFieldType("column8",    V_MONEY);
        data.SetFieldType("column9",    V_MONEY);
        data.SetFieldType("column10",   V_MONEY);
        data.SetFieldType("column11",   V_MONEY);


        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;


    constructor();
end;

class (T125LoansCreditDataSource) T125LoansCreditDataSource2926_2()
    private macro constructorT125LoansCreditDataSource2926_2()
        initT125LoansCreditDataSource("loansCredit");
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = T125LoansCreditDataSourceProtocol2926_2();
        return true;
    end;

    private macro creditAmount(to)
        return        " CASE WHEN GROUPING(t_type)+GROUPING(t_creditid) <> 1                            "
             + "\n" + "      THEN SUM(CASE WHEN (t_maturityterm <= " + to + ") OR t_maturityterm IS NULL"
             + "\n" + "                    THEN t_sum                                                   "
             + "\n" + "                    ELSE 0                                                       "
             + "\n" + "               END)                                                              "
             + "\n" + "      ELSE null                                                                  "
             + "\n" + " END                                                                             ";
    end;

    /**
     * Получить данные по ссудной задолженности (Строка 3_1).
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getLoanDebtsData(riskGroupFilter, registerFilter, accruedInterest, creditFilter)
        var commandText = "SELECT  DECODE(GROUPING(t_tranchekind), 1,                                                                     "
                 + "\n" + "               DECODE(t_creditType, 1, 'Кредит',                                                               "
                 + "\n" + "                                   21, 'Гарантии',                                                             "
                 + "\n" + "                                    8, 'Карта',                                                                "
                 + "\n" + "                                   22, 'Овердрафт',                                                            "
                 + "\n" + "                                   to_char(t_creditType)                                                       "
                 + "\n" + "                     ), chr(0))                                                              t_creditType,     "
                 + "\n" + "        DECODE(GROUPING(t_tranchekind), 1, t_creditNumber, chr(0))                           t_number,         "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                  t_creditIssueType,"
                 + "\n" + "        decode(t_type,     2, 'Просроченный ОД',                                                               "
                 + "\n" + "                           3, 'Просроченные проценты',                                                         "
                 + "\n" + "                           4, 'Требования по срочным %',                                                       "
                 + "\n" + "                           8, 'Неиспользованный лимит задолженности',                                          "
                 + "\n" + "                           7, 'Неиспользованный лимит выдачи',                                                 "
                 + "\n" + "                          17, 'Просроченный неразрешенный ОД',                                                 "
                 + "\n" + "                          18, 'Просроченные проценты по неразрешенному ОД',                                    "
                 + "\n" + "                          55, 'Выданная гарантия',                                                             "
                 + "\n" + "                          63, 'Требования по % оплаченной гарантии',                                           "
                 + "\n" + "                          64, 'Просроченная оплаченная гарантия',                                              "
                 + "\n" + "                          65, 'Просроченные проценты по оплаченной гарантии',                                  "
                 + "\n" + "                       10001, 'Срочное требование',                                                            "
                 + "\n" + "                       10002, 'Наращенные проценты',                                                           "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "              )                                                                               t_type,          "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 17         --Просроченный неразрешенный ОД                                           "
                 + "\n" + "                THEN 8                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 4                                                                                         "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 10                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                  t_typeForSort,    "
                 + "\n" + "        t_demanddate                                                                         t_demanddate,     "
                 + "\n" + "        sum(t_sum)                                                                           t_sum,            "
                 + "\n" + "        sum(t_objectSum)                                                                     t_objectSum,      "
                 + "\n" + "        " + creditAmount(1)   + "                                                            t_column2,        "
                 + "\n" + "        " + creditAmount(5)   + "                                                            t_column3,        "
                 + "\n" + "        " + creditAmount(10)  + "                                                            t_column4,        "
                 + "\n" + "        " + creditAmount(20)  + "                                                            t_column5,        "
                 + "\n" + "        " + creditAmount(30)  + "                                                            t_column6,        "
                 + "\n" + "        " + creditAmount(90)  + "                                                            t_column7,        "
                 + "\n" + "        " + creditAmount(180) + "                                                            t_column8,        "
                 + "\n" + "        " + creditAmount(270) + "                                                            t_column9,        "
                 + "\n" + "        " + creditAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()") + "   t_column10,       "
                 + "\n" + "        " + creditAmount("t_maturityterm") + " t_column11"
                 + "\n" + "    FROM (SELECT reg.t_creditid,                                                                               "
                 + "\n" + "                 reg.t_creditnumber,                                                                           "
                 + "\n" + "                 reg.t_creditType,                                                                             "
                 + "\n" + "                 reg.t_creditIssueType,                                                                        "
                 + "\n" + "                 reg.t_tranchekind,                                                                            "
                 + "\n" + "                 reg.t_tranchenumber,                                                                          "
                 + "\n" + "                 reg.t_type t_type,                                                                            ";

            if (accruedInterest)
                commandText = commandText + " TO_DATE ('01.01.0001', 'dd.mm.yyyy') t_demanddate,                                    "
                 + "\n" + "                 0 t_maturityterm,                                                                       "
            else
                commandText = commandText + "CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")           "
                 + "\n" + "                       THEN t_accruedInterestDate                                                        "
                 + "\n" + "                       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                         "
                 + "\n" + "                  END t_demanddate,                                                                      "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")           "
                 + "\n" + "                       THEN DECODE (t_accruedInterestDate,                                               "
                 + "\n" + "                                    TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                             "
                 + "\n" + "                                    t_accruedInterestDate - rep_data.getenddate ())                      "
                 + "\n" + "                       ELSE 0                                                                            "
                 + "\n" + "                  END t_maturityterm,                                                                    ";
            end;

            commandText = commandText + "    reg.t_roublerest t_sum,                                                                "
                 + "\n" + "                  reg.t_roublerest t_objectSum                                                           ";

            if (accruedInterest)
                commandText = commandText + "FROM df125register_tmp reg";
            else
                commandText = commandText +" FROM (SELECT r.t_creditid, r.t_creditNumber, r.t_credittype, r.t_creditIssueType, r.t_trancheKind, r.t_type,"
                     + "\n" + "                           r.t_trancheNumber, r.t_demandDate, r.t_roubleRest, r.t_creditRiskGroup,                        "
                     + "\n" + "                           (SELECT MIN(t_repaymentDate)                                                                   "
                     + "\n" + "                              FROM repLnsInterest_vw planpay                                                              "
                     + "\n" + "                             WHERE r.t_trancheKind = planPay.t_trancheKind                                                "
                     + "\n" + "                               AND r.t_trancheNumber = planPay.t_trancheNumber                                            "
                     + "\n" + "                               AND planpay.t_repaymentDate > rep_data.getenddate ()) t_accruedInterestDate,               "
                     + "\n" + "                           r.t_reservepercent                                                                             "
                     + "\n" + "                      FROM df125register_tmp r) reg                                                                       ";

            end;

            commandText = commandText + "\n" + " WHERE 1=1 " + riskGroupFilter + registerFilter + creditFilter +"                                        ";

            commandText = commandText
                 + "\n" + "           UNION ALL                                                           "
                 + "\n" + "          SELECT t_creditid,                                                   "
                 + "\n" + "                 t_creditnumber,                                               "
                 + "\n" + "                 t_creditType,                                                 "
                 + "\n" + "                 NULL t_creditIssueType,                                       "
                 + "\n" + "                 t_tranchekind,                                                "
                 + "\n" + "                 t_tranchenumber,                                              "
                 + "\n" + "                 10001 t_type,                                                 "
                 + "\n" + "                 dem.t_demanddate,                                             "
                 + "\n" + "                 DECODE (dem.t_demanddate,                                     "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,              "
                 + "\n" + "                         dem.t_demanddate - rep_data.getenddate ()             "
                 + "\n" + "                        ) t_maturityterm,                                      "
                 + "\n" + "                 dem.t_roublesum t_sum,                                        "
                 + "\n" + "                 dem.t_roublesum t_objectSum                                   "
                 + "\n" + "            FROM df125termdemand_tmp dem                                       "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                              "
                 + "\n" + "                           FROM df125register_tmp reg                          "
                 + "\n" + "                          WHERE reg.t_trancheKind   = dem.t_trancheKind        "
                 + "\n" + "                            AND reg.t_trancheNumber = dem.t_trancheNumber      "
                 + "\n" + "                            AND reg.t_roubleRest > 0                           "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")"
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "           UNION ALL                                                           "
                 + "\n" + "          SELECT t_creditid,                                                   "
                 + "\n" + "                 t_creditnumber,                                               "
                 + "\n" + "                 t_creditType,                                                 "
                 + "\n" + "                 NULL t_creditIssueType,                                       "
                 + "\n" + "                 t_tranchekind,                                                "
                 + "\n" + "                 t_tranchenumber,                                              "
                 + "\n" + "                 10002 t_type,                                                 "
                 + "\n" + "                 interest.t_demanddate,                                        "
                 + "\n" + "                 DECODE (interest.t_demanddate,                                "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,              "
                 + "\n" + "                         interest.t_demanddate - rep_data.getenddate ()        "
                 + "\n" + "                        ) t_maturityterm,                                      "
                 + "\n" + "                 interest.t_roublesum t_sum,                                   "
                 + "\n" + "                 interest.t_roublesum t_objectSum                              "
                 + "\n" + "            FROM df125Interest_tmp interest                                    "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                              "
                 + "\n" + "                           FROM df125register_tmp reg                          "
                 + "\n" + "                          WHERE reg.t_trancheKind   = interest.t_trancheKind   "
                 + "\n" + "                            AND reg.t_trancheNumber = interest.t_trancheNumber "
                 + "\n" + "                            AND reg.t_roubleRest > 0                           "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")"
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "         )                                                                     "
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                  "
                 + "\n" + "                  t_creditType,                                                "
                 + "\n" + "                  t_creditIssueType,                                           "
                 + "\n" + "                  t_creditNumber),                                             "
                 + "\n" + "                 (t_tranchekind,                                               "
                 + "\n" + "                  t_tranchenumber,                                             "
                 + "\n" + "                  t_demanddate,                                                "
                 + "\n" + "                  t_type))                                                     "
                 + "\n" + "ORDER BY grouping(t_creditid) desc ,                                           "
                 + "\n" + "         t_creditid,                                                           "
                 + "\n" + "         grouping(t_tranchekind) desc,                                         "
                 + "\n" + "         t_tranchekind,                                                        "
                 + "\n" + "         t_typeForSort,                                                        "
                 + "\n" + "         t_demanddate,                                                         "
                 + "\n" + "         t_tranchenumber                                                       "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",       V_MONEY);
        data.SetFieldType("objectSum", V_MONEY);
        data.SetFieldType("column2",   V_MONEY);
        data.SetFieldType("column3",   V_MONEY);
        data.SetFieldType("column4",   V_MONEY);
        data.SetFieldType("column5",   V_MONEY);
        data.SetFieldType("column6",   V_MONEY);
        data.SetFieldType("column7",   V_MONEY);
        data.SetFieldType("column8",   V_MONEY);
        data.SetFieldType("column9",   V_MONEY);
        data.SetFieldType("column10",  V_MONEY);
        data.SetFieldType("column11",  V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /* Данные для строки 3.1 */
    macro getLoanDebtsData31(riskGroupFilter, registerFilter, accruedInterest, creditFilter)
        var commandText = "SELECT  DECODE(GROUPING(t_tranchekind), 1,                                                                     "
                 + "\n" + "               DECODE(t_creditType, 1, 'Кредит',                                                               "
                 + "\n" + "                                   21, 'Гарантии',                                                             "
                 + "\n" + "                                    8, 'Карта',                                                                "
                 + "\n" + "                                   22, 'Овердрафт',                                                            "
                 + "\n" + "                                   to_char(t_creditType)                                                       "
                 + "\n" + "                     ), chr(0))                                                              t_creditType,     "
                 + "\n" + "        DECODE(GROUPING(t_tranchekind), 1, t_creditNumber, chr(0))                           t_number,         "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                  t_creditIssueType,"
                 + "\n" + "        decode(t_type,     2, 'Просроченный ОД',                                                               "
                 + "\n" + "                           3, 'Просроченные проценты',                                                         "
                 + "\n" + "                           4, 'Требования по срочным %',                                                       "
                 + "\n" + "                          17, 'Просроченный неразрешенный ОД',                                                 "
                 + "\n" + "                          18, 'Просроченные проценты по неразрешенному ОД',                                    "
                 + "\n" + "                          63, 'Требования по % оплаченной гарантии',                                           "
                 + "\n" + "                          64, 'Просроченная оплаченная гарантия',                                              "
                 + "\n" + "                          65, 'Просроченные проценты по оплаченной гарантии',                                  "
                 + "\n" + "                       10001, 'Срочное требование',                                                            "
                 + "\n" + "                       10002, 'Наращенные проценты',                                                           "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "              )                                                                     t_type,                    "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 17         --Просроченный неразрешенный ОД                                           "
                 + "\n" + "                THEN 8                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 10                                                                                         "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 13                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                  t_typeForSort,    "
                 + "\n" + "        t_demanddate                                                                         t_demanddate,     "
                 + "\n" + "        sum(t_sum)                                                                           t_sum,            "
                 + "\n" + "        sum(t_objectSum)                                                                     t_objectSum,      "
                 + "\n" + "        " + creditAmount(1)   + "                                                            t_column2,        "
                 + "\n" + "        " + creditAmount(5)   + "                                                            t_column3,        "
                 + "\n" + "        " + creditAmount(10)  + "                                                            t_column4,        "
                 + "\n" + "        " + creditAmount(20)  + "                                                            t_column5,        "
                 + "\n" + "        " + creditAmount(30)  + "                                                            t_column6,        "
                 + "\n" + "        " + creditAmount(90)  + "                                                            t_column7,        "
                 + "\n" + "        " + creditAmount(180) + "                                                            t_column8,        "
                 + "\n" + "        " + creditAmount(270) + "                                                            t_column9,        "
                 + "\n" + "        " + creditAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()") + "   t_column10,       "
                 + "\n" + "        " + creditAmount("t_maturityterm") + "                                               t_column11        "
                 + "\n" + "    FROM (SELECT reg.t_creditid,                                                                               "
                 + "\n" + "                 reg.t_creditnumber,                                                                           "
                 + "\n" + "                 reg.t_creditType,                                                                             "
                 + "\n" + "                 reg.t_creditIssueType,                                                                        "
                 + "\n" + "                 reg.t_tranchekind,                                                                            "
                 + "\n" + "                 reg.t_tranchenumber,                                                                          "
                 + "\n" + "                 reg.t_type t_type,                                                                            ";

            if (accruedInterest)
                commandText = commandText + " TO_DATE ('01.01.0001', 'dd.mm.yyyy') t_demanddate,                                          "
                 + "\n" + "                 0 t_maturityterm,                                                                             "
                 + "\n" + "                 CASE                                                                                          ";
            else
                commandText = commandText + "CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                       THEN t_accruedInterestDate                                                              "
                 + "\n" + "                       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                               "
                 + "\n" + "                  END t_demanddate,                                                                            "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                       THEN DECODE (t_accruedInterestDate,                                                     "
                 + "\n" + "                                    TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                   "
                 + "\n" + "                                    t_accruedInterestDate - rep_data.getenddate ())                            "
                 + "\n" + "                       ELSE 0                                                                                  "
                 + "\n" + "                  END t_maturityterm,                                                                          "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                           THEN reg.t_roublerest - reg.t_calcPercentRvpSum                                     ";
            end;

            commandText = commandText + "         WHEN reg.t_type IN (" + TDR_EXPREST + "," + TDR_OV + "," + TDR_EXPPAYMGUARANTEE + ")"
                 + "\n" + "                           THEN reg.t_roublerest - (reg.t_roublerest * reg.t_reservepercent) / 100             "
                 + "\n" + "                       WHEN reg.t_type IN (" + TDR_EXPPERC + "," + TDR_EXPPERC_OV + "," + TDR_PAYMGUARANTEEEXPPERC + ")"
                 + "\n" + "                           THEN reg.t_roublerest - reg.t_calcDelayedPercentRvpSum * reg.t_roublerest /         "
                 + "\n" + "                                (SELECT SUM(t_roubleRest)                                                      "
                 + "\n" + "                                   FROM df125register_tmp r                                                    "
                 + "\n" + "                                  WHERE reg.t_creditid = r.t_creditId                                          "
                 + "\n" + "                                    AND reg.t_creditType = r.t_creditType                                      "
                 + "\n" + "                                    AND reg.t_tranchekind = r.t_trancheKind                                    "
                 + "\n" + "                                    AND reg.t_tranchenumber = r.t_trancheNumber                                "
                 + "\n" + "                                    AND r.t_type IN (" + TDR_EXPPERC + "," + TDR_EXPPERC_OV + "," + TDR_PAYMGUARANTEEEXPPERC + ")"
                 + "\n" + "                                )                                                                              "
                 + "\n" + "                       ELSE 0                                                                                  "
                 + "\n" + "                  END t_sum,                                                                                   "
                 + "\n" + "                  reg.t_roublerest  t_objectSum                                                                ";


            if (accruedInterest)
                commandText = commandText + "FROM df125register_tmp reg";
            else
                commandText = commandText +" FROM (SELECT r.t_creditid, r.t_creditNumber, r.t_credittype, r.t_creditIssueType, r.t_trancheKind, r.t_type,   "
                     + "\n" + "                           r.t_trancheNumber, r.t_demandDate, r.t_roubleRest, r.t_creditRiskGroup,                           "
                     + "\n" + "                           (SELECT MIN(t_repaymentDate)                                                                      "
                     + "\n" + "                              FROM repLnsInterest_vw planpay                                                                 "
                     + "\n" + "                             WHERE r.t_trancheKind = planPay.t_trancheKind                                                   "
                     + "\n" + "                               AND r.t_trancheNumber = planPay.t_trancheNumber                                               "
                     + "\n" + "                               AND planpay.t_repaymentDate > rep_data.getenddate ()) t_accruedInterestDate,                  "
                     + "\n" + "                           r.t_reservepercent, r.t_calcPercentRvpSum, r.t_calcDelayedPercentRvpSum                           "
                     + "\n" + "                      FROM df125register_tmp r) reg                                                                          ";

            end;

            commandText = commandText
                 + "\n" + " WHERE 1=1 " + riskGroupFilter + registerFilter + creditFilter + "                                       "
                 + "\n" + "           UNION ALL                                                                                     "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 NULL t_creditIssueType,                                                                 "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10001 t_type,                                                                           "
                 + "\n" + "                 dem.t_demanddate,                                                                       "
                 + "\n" + "                 DECODE (dem.t_demanddate,                                                               "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         dem.t_demanddate - rep_data.getenddate ()                                       "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 dem.t_roublesum - (dem.t_roublesum * dem.t_reservePercent) / 100 t_sum,                 "
                 + "\n" + "                 dem.t_roublesum t_objectSum                                                             "
                 + "\n" + "            FROM df125termdemand_tmp dem                                                                 "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                                        "
                 + "\n" + "                           FROM df125register_tmp reg                                                    "
                 + "\n" + "                          WHERE reg.t_trancheKind   = dem.t_trancheKind                                  "
                 + "\n" + "                            AND reg.t_trancheNumber = dem.t_trancheNumber                                "
                 + "\n" + "                            AND reg.t_roubleRest > 0                                                     "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")                              "
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "           UNION ALL                                                                                     "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 NULL t_creditIssueType,                                                                 "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10002 t_type,                                                                           "
                 + "\n" + "                 interest.t_demanddate,                                                                  "
                 + "\n" + "                 DECODE (interest.t_demanddate,                                                          "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         interest.t_demanddate - rep_data.getenddate ()                                  "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 interest.t_roublesum - (interest.t_roubleSum * interest.t_rvpsSum / (                   "
                 + "\n" + "                                                                                     SELECT SUM(t_roubleRest)                            "
                 + "\n" + "                                                                                       FROM df125register_tmp r                          "
                 + "\n" + "                                                                                      WHERE interest.t_creditid = r.t_creditId           "
                 + "\n" + "                                                                                        AND interest.t_creditType = r.t_creditType       "
                 + "\n" + "                                                                                        AND r.t_type IN (" + TDR_MAINREST + "," + TDR_PAYMGUARANTEEPERCDEM + ")"
                 + "\n" + "                                                                                      )) t_sum,  "
                 + "\n" + "                 interest.t_roublesum t_objectSum                                                        "
                 + "\n" + "            FROM df125Interest_tmp interest                                                              "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                                        "
                 + "\n" + "                           FROM df125register_tmp reg                                                    "
                 + "\n" + "                          WHERE reg.t_trancheKind   = interest.t_trancheKind                             "
                 + "\n" + "                            AND reg.t_trancheNumber = interest.t_trancheNumber                           "
                 + "\n" + "                            AND reg.t_roubleRest > 0                                                     "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")                              "
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "         )"
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                                            "
                 + "\n" + "                  t_creditType,                                                                          "
                 + "\n" + "                  t_creditIssueType,                                                                     "
                 + "\n" + "                  t_creditNumber),                                                                       "
                 + "\n" + "                 (t_tranchekind,                                                                         "
                 + "\n" + "                  t_tranchenumber,                                                                       "
                 + "\n" + "                  t_demanddate,                                                                          "
                 + "\n" + "                  t_type))                                                                               "
                 + "\n" + "ORDER BY grouping(t_creditid) desc ,                                                                     "
                 + "\n" + "         t_creditid,                                                                                     "
                 + "\n" + "         grouping(t_tranchekind) desc,                                                                   "
                 + "\n" + "         t_tranchekind,                                                                                  "
                 + "\n" + "         t_typeForSort,                                                                                  "
                 + "\n" + "         t_demanddate,                                                                                   "
                 + "\n" + "         t_tranchenumber                                                                                 "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",       V_MONEY);
        data.SetFieldType("objectSum", V_MONEY);
        data.SetFieldType("column2",   V_MONEY);
        data.SetFieldType("column3",   V_MONEY);
        data.SetFieldType("column4",   V_MONEY);
        data.SetFieldType("column5",   V_MONEY);
        data.SetFieldType("column6",   V_MONEY);
        data.SetFieldType("column7",   V_MONEY);
        data.SetFieldType("column8",   V_MONEY);
        data.SetFieldType("column9",   V_MONEY);
        data.SetFieldType("column10",  V_MONEY);
        data.SetFieldType("column11",  V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /**
     * Получить данные по обязательствам и гарантиям (строка 13)
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getIssuedGuaranteesAndLiabilityData(filter, useMaturity)
        var commandText = "SELECT  DECODE(t_creditType,  1, 'Кредит',                                                                     "
                 + "\n" + "                             21, 'Гарантии',                                                                   "
                 + "\n" + "                              8, 'Карта',                                                                      "
                 + "\n" + "                             22, 'Овердрафт',                                                                  "
                 + "\n" + "                             to_char(t_creditType))                                         t_creditType,      "
                 + "\n" + "        t_creditNumber                                                                      t_number,          "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                 t_creditIssueType, "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 17         --Просроченный неразрешенный ОД                                           "
                 + "\n" + "                THEN 8                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 4                                                                                         "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 10                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                 t_typeForSort,     "
                 + "\n" + "        null                                                                                t_demanddate,      "
                 + "\n" + "        DECODE(t_type,  2, 'Просроч. ОД',                                                                      "
                 + "\n" + "                        3, 'Просроч. %',                                                                       "
                 + "\n" + "                        8, 'Неисп. лимит задолженности',                                                       "
                 + "\n" + "                        7, 'Неисп. лимит выдачи',                                                              "
                 + "\n" + "                       17, 'Проср. неразрешенный ОД',                                                          "
                 + "\n" + "                       18, 'Проср. % по неразреш. ОД',                                                         "
                 + "\n" + "                       55, 'Выданная гарантия',                                                                "
                 + "\n" + "                       64, 'Проср. оплаченная гарантия',                                                       "
                 + "\n" + "                       65, 'Проср. % по оплач.гарантии',                                                       "
                 + "\n" + "                       167,'Неиспользованный лимит гарантии',                                                       "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "                       )                                                                    t_type,            "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_sum,             "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_objectSum,       ";
            if (useMaturity)
                commandText = commandText
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 1)   or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column2, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 5)   or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column3, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 10)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column4, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 20)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column5, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 30)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column6, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 90)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column7, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 180) or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column8, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 270) or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column9, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                         or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column10,"
                 + "\n" + "        sum(reg.t_roublerest)                                                                                                       t_column11 ";
            else
                commandText = commandText
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column2,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column3,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column4,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column5,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column6,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column7,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column8,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column9,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column10,        "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column11         ";
            end;

            commandText = commandText + " FROM df125register_tmp reg                                                                      "
                 + "\n" + "    WHERE (t_creditType = 21 and (t_type = 55 OR t_type = 167))                                                "
                 + "\n" + "       OR (t_creditType in (8, 22) and t_type = 8)                                                             "
                 + "\n" + "       OR (t_creditType = 1 and ((t_creditIssueType = 4 and t_type = 7)                                        "
                 + "\n" + "                                  or                                                                           "
                 + "\n" + "                                 (t_creditIssueType = 5 and t_type = 8)                                        "
                 + "\n" + "                                 or                                                                            "
                 + "\n" + "                                 (t_creditIssueType = 3 and                                                    "
                 + "\n" + "                                  t_roublerest||t_type =                                                       "
                 + "\n" + "                                            (select MIN(r.t_roublerest||r.t_type)                              "/*нужно найти меньший остаток из регистров 7, 8*/
                 + "\n" + "                                              from df125register_tmp r                                         "/*t_roublerest||t_type, чтобы взять один из регистров если остатки равны*/
                 + "\n" + "                                             where r.t_type in (7, 8)                                          "
                 + "\n" + "                                               and r.t_creditId = reg.t_creditId                               "
                 + "\n" + "                                             group by r.t_creditId                                             "
                 + "\n" + "                                            )                                                                  "
                 + "\n" + "                                ))                                                                             "
                 + "\n" + "          )                                                                                                    "
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                                                  "
                 + "\n" + "                  t_creditNumber,                                                                              "
                 + "\n" + "                  t_creditType,                                                                                "
                 + "\n" + "                  t_creditIssueType,                                                                           "
                 + "\n" + "                  t_tranchekind,                                                                               "
                 + "\n" + "                  t_tranchenumber,                                                                             "
                 + "\n" + "                  t_type))                                                                                     "
                 + "\n" + "ORDER BY t_creditid,                                                                                           "
                 + "\n" + "         t_tranchekind,                                                                                        "
                 + "\n" + "         t_typeForSort                                                                                         "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",        V_MONEY);
        data.SetFieldType("objectSum",  V_MONEY);
        data.SetFieldType("column2",    V_MONEY);
        data.SetFieldType("column3",    V_MONEY);
        data.SetFieldType("column4",    V_MONEY);
        data.SetFieldType("column5",    V_MONEY);
        data.SetFieldType("column6",    V_MONEY);
        data.SetFieldType("column7",    V_MONEY);
        data.SetFieldType("column8",    V_MONEY);
        data.SetFieldType("column9",    V_MONEY);
        data.SetFieldType("column10",   V_MONEY);
        data.SetFieldType("column11",   V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    constructorT125LoansCreditDataSource2926_2();
end;

class (T125LoansCreditDataSource2926_2) T125LoansCreditDataSource4099()
    private macro constructorT125LoansCreditDataSource4099()
        initT125LoansCreditDataSource2926_2("loansCredit");
    end;

    macro cacheData() : bool
        clear();

        var endDateStr = getSqlDate(rcbApplication().currentReport.context.period.endDate);
        var accruedInterest;
        var interestCondition;
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ", V_BOOL, accruedInterest, null);

        var creditFilter = rcbBranchAndDepartmentFieldFilter().GetAsSqlString("credit.t_departmentId", "credit.t_branchId") +
                     " AND credit.t_isOpenedAtEndDate = 1"
                     " AND (   credit.t_type = " + LO_CREDIT    +
                     "      OR credit.t_type = " + LO_KARTA     +
                     "      OR credit.t_type = " + LO_GUARANTEE +
                     "      OR credit.t_type = " + LO_OVERDRAFT +
                     "      OR credit.t_type = " + LO_DEPOSIT   + ")";

        var querySource =   "SELECT credit.t_id   AS a_creditNumber, "
                   + "\n" + "       credit.t_type AS a_type          "
                   + "\n" + "  FROM repLnsContract_vw credit,        "
                   + "\n" + "       repLnsTranches_vw tranch"
                   + "\n" + " WHERE (" + creditFilter + ")           "
                   + "\n" + "   AND credit.t_id = tranch.t_contractId"
                   + "\n" + "   AND (tranch.t_isOpenedAtEndDate = 1) "
                   + "\n" + " GROUP BY credit.t_id,                  "
                   + "\n" + "          credit.t_type                 ";

        var command = RsdCommand(rslDefCon);

        command.cmdText = "CALL LoansVox.fillLoansRezData(?, ?, ?)";
        command.addParam("BegDate", RSDBP_IN, rcbApplication().currentReport.context.period.beginDate);
        command.addParam("EndDate", RSDBP_IN, rcbApplication().currentReport.context.period.endDate);
        command.addParam("DataSource", RSDBP_IN, querySource);

        command.execute();

        sql_execute(      " INSERT INTO df125Credit_tmp(t_creditId,                             "
                + "\n" + "                              t_creditNumber,                         "
                + "\n" + "                              t_creditType,                           "
                + "\n" + "                              t_trancheKind,                          "
                + "\n" + "                              t_trancheNumber,                        "
                + "\n" + "                              t_issueType,                            "
                + "\n" + "                              t_isCapitalized,                        "
                + "\n" + "                              t_finishDate,                           "
                + "\n" + "                              t_rvpsQualityCategory,                  "
                + "\n" + "                              t_reservePercent,                       "
                + "\n" + "                              t_rvpsSum,                              "
                + "\n" + "                              t_calcPercentRvpSum,                    "
                + "\n" + "                              t_calcDelayedPercentRvpSum)             "
                + "\n" + "                      SELECT DISTINCT *                               "
                + "\n" + "                        FROM (                                        "
                + "\n" + "                            SELECT credit.t_id,                       "
                + "\n" + "                                   credit.t_number,                   "
                + "\n" + "                                   credit.t_type,                     "
                + "\n" + "                                   tranch.t_kind,                     "
                + "\n" + "                                   tranch.t_number AS t_trancheNumber,"
                + "\n" + "                                   credit.t_issueType,                "
                + "\n" + "                                   credit.t_isCapitalized,            "
                + "\n" + "                                   credit.t_finishDate,               "
                + "\n" + "                                   credit.t_rvpsQualityCategory,      "
                + "\n" + "                                   credit.t_rvpsReservePercent,       "
                + "\n" + "                                   reserve.t_rvpsSum,                 "
                + "\n" + "                                   tranch.t_CalcRVPPerc,              "
                + "\n" + "                                   tranch.t_CAlcRVPExpPerc            "
                + "\n" + "                              FROM repLnsReserve_vw  reserve,         "
                + "\n" + "                                   repLnsContract_vw  credit,         "
                + "\n" + "                                   repLnsTranches_vw tranch           "
                + "\n" + "                             WHERE credit.t_id = reserve.t_objectNumber AND credit.t_type = reserve.t_objectTypeid AND credit.t_id = tranch.t_contractId)");

        /*Наращенные проценты*/
        if (accruedInterest)
            sql_execute(      " INSERT INTO df125Interest_tmp(t_creditId,                                                                                        "
                    + "\n" + "                               t_creditType,                                                                                       "
                    + "\n" + "                               t_trancheKind,                                                                                      "
                    + "\n" + "                               t_trancheNumber,                                                                                    "
                    + "\n" + "                               t_creditNumber,                                                                                     "
                    + "\n" + "                               t_creditRiskGroup,                                                                                  "
                    + "\n" + "                               t_rvpsSum,                                                                                          "
                    + "\n" + "                               t_roubleSum,                                                                                        "
                    + "\n" + "                               t_reservePercent,                                                                                   "
                    + "\n" + "                               t_demandDate)                                                                                       "
                    + "\n" + "   SELECT t_creditId, t_creditType, t_trancheKind, t_trancheNumber, t_creditNumber, t_rvpsQualityCategory, t_rvpsSum,              "
                    + "\n" + "          (NVL(RSB_FIINSTR.convSum(A_PERCENTSUM , A_CURCODE , 0," + endDateStr +"), 0)) AS t_roubleSum , t_reservePercent, a_paydate "
                    + "\n" + "     FROM (                                                                                                                        "
                    + "\n" + "           SELECT contract.t_creditId,                                                                                             "
                    + "\n" + "                  contract.t_creditType,                                                                                           "
                    + "\n" + "                  contract.t_trancheKind,                                                                                          "
                    + "\n" + "                  contract.t_trancheNumber,                                                                                        "
                    + "\n" + "                  contract.t_creditNumber,                                                                                         "
                    + "\n" + "                  contract.t_rvpsQualityCategory,                                                                                  "
                    + "\n" + "                  contract.t_rvpsSum,                                                                                              "
                    + "\n" + "                  t_plannedpercentsum a_percentsum,                                                                                "
                    + "\n" + "                  contract.t_reservePercent,                                                                                       "
                    + "\n" + "                  t_plannedpaydate a_paydate,                                                                                      "
                    + "\n" + "                  DECODE (planpay.t_objecttypeid_ref, 6, NVL ((SELECT t_fiId                                                       "
                    + "\n" + "                                                                 FROM repLnsContract_vw cntrct                                     "
                    + "\n" + "                                                                WHERE cntrct.t_id = (SELECT t_creditnumber_ref                     "
                    + "\n" + "                                                                                       FROM dduty_crd_dbt                          "
                    + "\n" + "                                                                                      WHERE t_dutyid = planpay.t_objectid_ref)),   "
                    + "\n" + "                                                             0),                                                                   "
                    + "\n" + "                          NVL ((SELECT t_fiId                                                                                      "
                    + "\n" + "                                  FROM repLnsContract_vw cntrct                                                                    "
                    + "\n" + "                                 WHERE cntrct.t_id = t_creditId),                                                                  "
                    + "\n" + "                               0)) a_curcode                                                                                       "
                    + "\n" + "             FROM dplanpay_dbt planpay, df125Credit_tmp contract                                                                   "
                    + "\n" + "            WHERE planpay.t_plannedpercentsum > 0                                                                                  "
                    + "\n" + "              AND planpay.t_type IN (0, 4)                                                                                         "
                    + "\n" + "              AND planpay.t_credoperid_ref = (SELECT MAX (lgpayop.t_credoperid_ref)                                                "
                    + "\n" + "                                                FROM dlgpayop_dbt lgpayop                                                          "
                    + "\n" + "                                                     JOIN dcrd_op_dbt crd_op                                                       "
                    + "\n" + "                                                       ON crd_op.t_credoperid = lgpayop.t_credoperid_ref                           "
                    + "\n" + "                                               WHERE crd_op.t_objectid_ref = planpay.t_objectid_ref                                "
                    + "\n" + "                                                 AND lgpayop.t_type IN (0, 4)                                                      "
                    + "\n" + "                                                 AND crd_op.t_objecttypeid_ref = planpay.t_objecttypeid_ref                        "
                    + "\n" + "                                                 AND crd_op.t_credoperdate <= " + endDateStr
                    + "\n" + "                                              )                                                                                    "
                    + "\n" + "              AND contract.t_trancheKind   = planPay.t_objecttypeid_ref                                                            "
                    + "\n" + "              AND contract.t_trancheNumber = planPay.t_objectid_ref                                                                "
                    + "\n" + "              AND contract.t_rvpsQualityCategory IN (1, 2)                                                                         "
                    + "\n" + "              AND t_plannedpercentsum <> 0                                                                                         "
                    + "\n" + "              AND contract.t_creditType != " + LO_DEPOSIT
                    + "\n" + "              AND t_plannedpaydate > " + endDateStr + ")" );
        end;

        /*Срочное требование*/
        sql_execute(      " INSERT INTO df125TermDemand_tmp(t_creditId,                                                                                           "
                 + "\n" + "                                 t_creditType,                                                                                         "
                 + "\n" + "                                 t_trancheKind,                                                                                        "
                 + "\n" + "                                 t_trancheNumber,                                                                                      "
                 + "\n" + "                                 t_creditNumber,                                                                                       "
                 + "\n" + "                                 t_creditRiskGroup,                                                                                    "
                 + "\n" + "                                 t_roubleSum,                                                                                          "
                 + "\n" + "                                 t_demandDate,                                                                                         "
                 + "\n" + "                                 t_reservePercent)                                                                                     "
                 + "\n" + "   SELECT t_creditId, t_creditType, t_trancheKind, t_trancheNumber, t_creditNumber, t_rvpsQualityCategory,                             "
                 + "\n" + "          NVL(RSB_FIINSTR.ConvSum(a_restSum, a_curcode,  0, " + endDateStr + "), 0) AS t_roubleRest,                                   "
                 + "\n" + "          a_enddate AS t_repaymentDate, t_reservePercent                                                                               "
                 + "\n" + "     FROM (SELECT *                                                                                                                    "
                 + "\n" + "             FROM (SELECT credit.t_creditId, credit.t_creditType, credit.t_trancheKind, credit.t_trancheNumber, credit.t_creditNumber, "
                 + "\n" + "                          credit.t_rvpsQualityCategory, lns.a_objecttypeid AS a_objecttypeid,                                          "
                 + "\n" + "                          lns.a_objectnumber AS a_objectnumber,                                                                        "
                 + "\n" + "                          grp.a_enddate AS a_enddate,                                                                                  "
                 + "\n" + "                          lns.a_curcode,                                                                                               "
                 + "\n" + "                          grp.a_restsum AS a_restsum,                                                                                  "
                 + "\n" + "                          grp.t_reservePercent                                                                                         "
                 + "\n" + "                     FROM (SELECT a_objecttypeid,                                                                                      "
                 + "\n" + "                                  a_objectnumber,                                                                                      "
                 + "\n" + "                                  a_enddate,                                                                                           "
                 + "\n" + "                                  NVL (LEAST (a_sum, GREATEST (0, a_sumprev - a_sumparm + a_restsum)),  0) AS a_restsum,               "
                 + "\n" + "                                  t_reservePercent                                                                                     "
                 + "\n" + "                             FROM (SELECT planpay.t_objecttypeid_ref AS a_objecttypeid,                                                "
                 + "\n" + "                                          planpay.t_objectid_ref AS a_objectnumber,                                                    "
                 + "\n" + "                                          planpay.t_plannedpaydate AS a_enddate,                                                       "
                 + "\n" + "                                          MIN(planpay.t_plannedpaysum) + SUM(planpay.t_plannedpaysumex) AS a_sum,                      "
                 + "\n" + "                                          SUM (SUM (planpay.t_plannedpaysum + planpay.t_plannedpaysumex)) OVER (PARTITION BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref) AS a_sumparm,                                   "
                 + "\n" + "                                          SUM (SUM (planpay.t_plannedpaysum + planpay.t_plannedpaysumex)) OVER ( PARTITION BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref ORDER BY planpay.t_plannedpaydate) AS a_sumprev,"
                 + "\n" + "                                          (SELECT NVL(SUM (dutyrest.t_restsum), 0) AS a_restsum                         "
                 + "\n" + "                                             FROM dlcusreg_dbt lcusreg, ddutyrest_dbt dutyrest                          "
                 + "\n" + "                                            WHERE lcusreg.t_regid IN (1, 16, 62)                                        "
                 + "\n" + "                                              AND dutyrest.t_id_ref   = lcusreg.t_id                                    "
                 + "\n" + "                                              AND dutyrest.t_restdate = (SELECT MAX (dr.t_restdate)                     "
                 + "\n" + "                                                                           FROM ddutyrest_dbt dr                        "
                 + "\n" + "                                                                          WHERE dr.t_restdate <= " + endDateStr
                 + "\n" + "                                                                            AND dr.t_id_ref = dutyrest.t_id_ref)        "
                 + "\n" + "                                          )  AS a_restSum,                                                              "
                 + "\n" + "                                          credit.t_reservePercent                                                       "
                 + "\n" + "                                     FROM dplanpay_dbt planpay, df125Credit_tmp credit                                  "
                 + "\n" + "                                    WHERE planpay.t_plannedpaysum + planpay.t_plannedpaysumex > 0                       "
                 + "\n" + "                                      AND credit.t_trancheKind   = planpay.t_objectTypeId_ref                           "
                 + "\n" + "                                      AND credit.t_trancheNumber = planpay.t_objectId_ref                               "
                 + "\n" + "                                      AND credit.t_rvpsQualityCategory IN (1, 2)                                        "
                 + "\n" + "                                      AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                                      AND EXISTS (SELECT 1                                                              "
                 + "\n" + "                                                    FROM dcrd_op_dbt crd_op                                             "
                 + "\n" + "                                                   WHERE planpay.t_credoperid_ref = t_credoperid                        "
                 + "\n" + "                                                     AND planpay.t_objectid_ref = crd_op.t_objectid_ref                 "
                 + "\n" + "                                                     AND planpay.t_objecttypeid_ref = crd_op.t_objecttypeid_ref         "
                 + "\n" + "                                                     AND crd_op.t_systemoperationid IN (2, 28)                          "
                 + "\n" + "                                                     AND crd_op.t_credoperdate <= " + endDateStr
                 + "\n" + "                                                     AND crd_op.t_isdeleted = 0                                         "
                 + "\n" + "                                                     AND crd_op.t_credoperid = loansuserfunction.getlastcredoperid_forplanpay (planpay.t_objecttypeid_ref, "
                 + "\n" + "                                                                                                                               planpay.t_objectid_ref,     "
                 + "\n" + "                                                                                                                               planpay.t_type,             "
                 + "\n" + "                                                                                                          " + endDateStr + "   ) )     "
                 + "\n" + "                                 GROUP BY planpay.t_objecttypeid_ref, planpay.t_objectid_ref, planpay.t_plannedpaydate, credit.t_reservePercent) "
                 + "\n" + "                        UNION ALL                                                                                       "
                 + "\n" + "                           SELECT lcusreg.t_objecttypeid AS a_objecttypeid,                                             "
                 + "\n" + "                                  lcusreg.t_objectnumber AS a_objectnumber,                                             "
                 + "\n" + "                                 (SELECT sel.a_endDate                                                                  "
                 + "\n" + "                                    FROM (SELECT (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_crd_kind                                       "
                 + "\n" + "                                                  ELSE 6                                                                "
                 + "\n" + "                                                   END) AS a_objecttypeid,                                              "
                 + "\n" + "                                                 (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_creditnumber                                   "
                 + "\n" + "                                                  ELSE duty_crd.t_dutyid                                                "
                 + "\n" + "                                                   END) AS a_objectnumber,                                              "
                 + "\n" + "                                                 (CASE NVL (duty_crd.t_dutyid, 0)                                       "
                 + "\n" + "                                                  WHEN 0 THEN credit_c.t_returndate                                     "
                 + "\n" + "                                                  ELSE duty_crd.t_dutylastdate                                          "
                 + "\n" + "                                                  END) AS a_enddate                                                     "
                 + "\n" + "                                            FROM dcredit_c_dbt credit_c                                                 "
                 + "\n" + "                                                 LEFT JOIN dduty_crd_dbt duty_crd                                       "
                 + "\n" + "                                                        ON credit_c.t_creditnumber = duty_crd.t_creditnumber_ref) sel   "
                 + "\n" + "                                   WHERE lcusreg.t_objecttypeid = sel.a_objecttypeid                                    "
                 + "\n" + "                                     AND lcusreg.t_objectnumber = sel.a_objectnumber) AS a_endDate,                     "
                 + "\n" + "                                  SUM (dutyrest.t_restsum) AS a_restsum,                                                "
                 + "\n" + "                                  credit.t_reservePercent                                                               "
                 + "\n" + "                             FROM dlcusreg_dbt lcusreg                                                                  "
                 + "\n" + "                                  JOIN ddutyrest_dbt dutyrest                                                           "
                 + "\n" + "                                    ON dutyrest.t_id_ref = lcusreg.t_id,                                                "
                 + "\n" + "                                  df125Credit_tmp credit                                                                "
                 + "\n" + "                            WHERE credit.t_trancheKind = lcusreg.t_objecttypeid                                         "
                 + "\n" + "                              AND credit.t_trancheNumber = lcusreg.t_objectnumber                                       "
                 + "\n" + "                              AND credit.t_rvpsQualityCategory IN (1, 2)                                                "
                 + "\n" + "                              AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                              AND lcusreg.t_regid IN (1, 16, 62)                                                        "
                 + "\n" + "                              AND NOT EXISTS(SELECT 1                                                                   "
                 + "\n" + "                                               FROM dplanpay_dbt pp                                                     "
                 + "\n" + "                                              WHERE pp.t_objecttypeid_ref =  lcusreg.t_objecttypeid                     "
                 + "\n" + "                                                AND pp.t_objectid_ref = lcusreg.t_objectnumber                          "
                 + "\n" + "                                                AND ROWNUM = 1)                                                         "
                 + "\n" + "                              AND dutyrest.t_restdate = (SELECT MAX (dr.t_restdate)                                     "
                 + "\n" + "                                                           FROM ddutyrest_dbt dr                                        "
                 + "\n" + "                                                          WHERE dr.t_restdate <= " + endDateStr
                 + "\n" + "                                                            AND dr.t_id_ref = dutyrest.t_id_ref)                        "
                 + "\n" + "                         GROUP BY lcusreg.t_objecttypeid, lcusreg.t_objectnumber, credit.t_reservePercent) grp,         "
                 + "\n" + "                    (SELECT sel.a_objecttypeid,                                                                         "
                 + "\n" + "                            sel.a_objectnumber,                                                                         "
                 + "\n" + "                            sel.a_curcode,                                                                              "
                 + "\n" + "                           (CASE sel.a_objecttypeid                                                                     "
                 + "\n" + "                            WHEN 6                                                                                      "
                 + "\n" + "                              THEN NVL (                                                                                "
                 + "\n" + "                                       (SELECT MIN (crd_op.t_credoperdate)                                              "
                 + "\n" + "                                          FROM dcrd_op_dbt crd_op                                                       "
                 + "\n" + "                                         WHERE crd_op.t_isdeleted = 0                                                   "
                 + "\n" + "                                           AND crd_op.t_stageid_ref = 99                                                "
                 + "\n" + "                                           AND crd_op.t_objecttypeid_ref = sel.a_objecttypeid                           "
                 + "\n" + "                                           AND crd_op.t_objectid_ref = sel.a_objectnumber                               "
                 + "\n" + "                                           AND crd_op.t_creditnumber_ref = sel.a_creditnumber                           "
                 + "\n" + "                                           AND crd_op.t_isdeleted = 0                                                   "
                 + "\n" + "                                           AND crd_op.t_systemoperationid = 2),                                         "
                 + "\n" + "                                      TO_DATE ('01.01.0001', 'dd.mm.yyyy'))                                             "
                 + "\n" + "                              ELSE                                                                                      "
                 + "\n" + "                                  CASE sel.a_paytype                                                                    "
                 + "\n" + "                                   WHEN 6                                                                               "
                 + "\n" + "                                    THEN TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                           "
                 + "\n" + "                                    ELSE                                                                                "
                 + "\n" + "                                         NVL (                                                                          "
                 + "\n" + "                                             (SELECT MIN (crd_op.t_credoperdate)                                        "
                 + "\n" + "                                                FROM dcrd_op_dbt crd_op                                                 "
                 + "\n" + "                                               WHERE crd_op.t_isdeleted = 0                                             "
                 + "\n" + "                                                 AND crd_op.t_stageid_ref = 99                                          "
                 + "\n" + "                                                 AND crd_op.t_objecttypeid_ref = sel.a_objecttypeid                     "
                 + "\n" + "                                                 AND crd_op.t_objectid_ref = sel.a_objectnumber                         "
                 + "\n" + "                                                 AND crd_op.t_creditnumber_ref = sel.a_creditnumber                     "
                 + "\n" + "                                                 AND crd_op.t_isdeleted = 0                                             "
                 + "\n" + "                                                 AND crd_op.t_systemoperationid = 2),                                   "
                 + "\n" + "                                       TO_DATE ('01.01.0001', 'dd.mm.yyyy'))                                            "
                 + "\n" + "                                    END                                                                                 "
                 + "\n" + "                              END)  AS a_paydate                                                                        "
                 + "\n" + "                    FROM (SELECT credit_c.t_creditnumber AS a_creditnumber,                                             "
                 + "\n" + "                                (CASE NVL (duty_crd.t_dutyid, 0)                                                        "
                 + "\n" + "                                 WHEN 0 THEN credit_c.t_crd_kind                                                        "
                 + "\n" + "                                 ELSE 6                                                                                 "
                 + "\n" + "                                 END) AS a_objecttypeid,                                                                "
                 + "\n" + "                                (CASE NVL (duty_crd.t_dutyid, 0)                                                        "
                 + "\n" + "                                 WHEN 0 THEN credit_c.t_creditnumber                                                    "
                 + "\n" + "                                 ELSE duty_crd.t_dutyid                                                                 "
                 + "\n" + "                                 END) AS a_objectnumber,                                                                "
                 + "\n" + "                                credit_c.t_curcode AS a_curcode,                                                        "
                 + "\n" + "                                credit_c.t_paytype AS a_paytype                                                         "
                 + "\n" + "                           FROM dcredit_c_dbt credit_c                                                                  "
                 + "\n" + "                             LEFT JOIN dduty_crd_dbt duty_crd                                                           "
                 + "\n" + "                                    ON credit_c.t_creditnumber = duty_crd.t_creditnumber_ref) sel) lns,                 "
                 + "\n" + "                                df125Credit_tmp credit                                                                  "
                 + "\n" + "                          WHERE grp.a_objecttypeid = lns.a_objecttypeid                                                 "
                 + "\n" + "                            AND grp.a_objectnumber = lns.a_objectnumber                                                 "
                 + "\n" + "                            AND lns.a_objectTypeId = credit.t_trancheKind                                               "
                 + "\n" + "                            AND lns.a_objectnumber = credit.t_trancheNumber                                             "
                 + "\n" + "                            AND credit.t_rvpsQualityCategory IN (1, 2)                                                  "
                 + "\n" + "                            AND credit.t_creditType != " + LO_DEPOSIT
                 + "\n" + "                            AND grp.a_restSum <> 0                                                                      "
                 + "\n" + "                            AND lns.a_paydate <= " + endDateStr
                 + "\n" + "                            AND (grp.a_enddate  > " + endDateStr
                 + "\n" + "                                 OR lns.a_paydate > grp.a_enddate))                                                     "
                 + "\n" + "                  WHERE EXISTS(SELECT t_credoperdate                                                                    "
                 + "\n" + "                                 FROM dcrd_op_dbt                                                                       "
                 + "\n" + "                                WHERE t_isdeleted = 0                                                                   "
                 + "\n" + "                                  AND t_objecttypeid_ref IN (a_objecttypeid, 6)                                         "
                 + "\n" + "                                  AND T_OBJECTID_REF = a_objectnumber                                                   "
                 + "\n" + "                                  AND t_systemoperationid IN (2, 5, 46)                                                 "
                 + "\n" + "                                  AND t_stageid_ref = 99)                                                               "
                 + "\n" + "   )");

        /* Регистры */
        sql_execute(      " INSERT INTO df125Register_tmp (t_creditId,                                                                                                        "
                 + "\n" + "                                t_creditNumber,                                                                                                    "
                 + "\n" + "                                t_creditType,                                                                                                      "
                 + "\n" + "                                t_creditRiskGroup,                                                                                                 "
                 + "\n" + "                                t_trancheKind,                                                                                                     "
                 + "\n" + "                                t_trancheNumber,                                                                                                   "
                 + "\n" + "                                t_creditIssueType,                                                                                                 "
                 + "\n" + "                                t_type,                                                                                                            "
                 + "\n" + "                                t_roubleRest,                                                                                                      "
                 + "\n" + "                                t_demandDate,                                                                                                      "
                 + "\n" + "                                t_reservePercent,                                                                                                  "
                 + "\n" + "                                t_calcPercentRvpSum,                                                                                               "
                 + "\n" + "                                t_calcDelayedPercentRvpSum)                                                                                        "
                 + "\n" + "             SELECT t_creditId, t_creditNumber,t_creditType, t_rvpsQualityCategory, t_trancheKind, t_trancheNumber, t_issueType, a_typereg t_type, "
                 + "\n" + "                    NVL(RSB_FIINSTR.ConvSum(a_regRest, a_curCode, 0, " + endDateStr + " ), 0) AS t_roubleRest, t_finishDate, t_reservePercent,     "
                 + "\n" + "                    t_calcPercentRvpSum, t_calcDelayedPercentRvpSum                                                                                "
                 + "\n" + "               FROM (SELECT  r.*,  contract.t_creditId, contract.t_creditNumber, contract.t_creditType, contract.t_trancheKind,                    "
                 + "\n" + "                             contract.t_trancheNumber, contract.t_issueType,t_rvpsQualityCategory, contract.t_finishDate,                          "
                 + "\n" + "                             contract.t_calcPercentRvpSum, contract.t_calcDelayedPercentRvpSum, contract.t_reservePercent,                         "
                 + "\n" + "                             MAX (a_daterest) OVER (PARTITION BY a_objectid, a_objectnumber, a_typereg) a_maxdate                                  "
                 + "\n" + "                       FROM ( SELECT lcusreg.t_regid AS a_typereg,                                                                                 "
                 + "\n" + "                                     dutyrest.t_restdate AS a_daterest,                                                                            "
                 + "\n" + "                                    (CASE lcusreg.t_objecttypeid                                                                                   "
                 + "\n" + "                                     WHEN 6                                                                                                        "
                 + "\n" + "                                     THEN                                                                                                          "
                 + "\n" + "                                        (SELECT credit_c.t_fiId                                                                                    "
                 + "\n" + "                                           FROM dduty_crd_dbt duty_crd, repLnsContract_vw credit_c                                                 "
                 + "\n" + "                                          WHERE duty_crd.t_dutyid           = lcusreg.t_objectnumber                                               "
                 + "\n" + "                                            AND duty_crd.t_creditnumber_ref = credit_c.t_id)                                                       "
                 + "\n" + "                                     ELSE                                                                                                          "
                 + "\n" + "                                        (SELECT credit_c.t_fiId                                                                                    "
                 + "\n" + "                                           FROM repLnsContract_vw credit_c                                                                         "
                 + "\n" + "                                          WHERE credit_c.t_id = lcusreg.t_creditNumber)                                                            "
                 + "\n" + "                                     END) AS a_curcode,                                                                                            "
                 + "\n" + "                                     lcusreg.t_objecttypeid AS a_objectid,                                                                         "
                 + "\n" + "                                     lcusreg.t_objectnumber AS a_objectnumber,                                                                     "
                 + "\n" + "                                     dutyrest.t_restsum AS a_regrest                                                                               "
                 + "\n" + "                                FROM ddutyrest_dbt dutyrest                                                                                        "
                 + "\n" + "                                JOIN dlcusreg_dbt lcusreg                                                                                          "
                 + "\n" + "                                  ON dutyrest.t_id_ref = lcusreg.t_id                                                                              "
                 + "\n" + "                              ) r, df125Credit_tmp contract                                                                                        "
                 + "\n" + "                      WHERE a_daterest <= " + endDateStr
                 + "\n" + "                        AND (a_daterest >= (SELECT NVL(max(dutyrest.t_restdate), to_date('01.01.0001', 'dd.mm.yyyy'))                              "
                 + "\n" + "                                              FROM ddutyrest_dbt dutyrest,  dlcusreg_dbt lcusreg                                                   "
                 + "\n" + "                                             WHERE dutyrest.t_id_ref      = lcusreg.t_id                                                           "
                 + "\n" + "                                               AND dutyrest.t_restdate   <= " + endDateStr
                 + "\n" + "                                               AND lcusreg.t_objecttypeid = r.a_OBJECTID                                                           "
                 + "\n" + "                                               AND lcusreg.t_objectnumber = r.a_OBJECTNUMBER                                                       "
                 + "\n" + "                                               AND lcusreg.t_regid        = r.a_TYPEREG                                                            "
                 + "\n" + "                                               AND dutyrest.t_restsum     = 0)                                                                     "
                 + "\n" + "                                            )                                                                                                      "
                 + "\n" + "                        AND contract.t_trancheKind   = r.a_objectId                                                                                "
                 + "\n" + "                        AND contract.t_trancheNumber = r.a_objectNumber                                                                            "
                 + "\n" + "                        AND contract.t_creditType   != " + LO_DEPOSIT
                 + "\n" + "                        AND (r.a_regrest <> 0 AND r.a_typereg IN (" + TDR_MAINREST            +" ,"
                                                                                               + TDR_EXPREST             +" ,"
                                                                                               + TDR_EXPPAYMGUARANTEE    +" ,"
                                                                                               + TDR_EXPPERC             +" ,"
                                                                                               + TDR_EXPPERC_OV          +" ,"
                                                                                               + TDR_PAYMGUARANTEEEXPPERC+" ,"
                                                                                               + TDR_PAYMGUARANTEEPERCDEM+" ,"
                                                                                               + TDR_NOLIMGUAR           +" ,"
                                                                                               + TDR_PAYMGUARANTEE       +" ,"
                                                                                               + TDR_PAYEDGUARANTEE      +" ,"
                                                                                               + TCLTR_LIMDUTY           +" ,"
                                                                                               + TDR_CLAIM               +" ,"
                                                                                               + TCLTR_LIMPAY + "))          "
                 + "\n" + "                      ) reg                                                                       "
                 + "\n" + "                WHERE a_daterest = a_maxdate "  );

        //удаляем регистры "Требования по срочным %" для договоров, у которых регистр "История ОД" не равен нулю
        if (accruedInterest)
            sql_execute(      " DELETE FROM df125Register_tmp r                    "
                     + "\n" + "       WHERE t_type = " + TDR_CLAIM
                     + "\n" + "         AND EXISTS(SELECT *                        "
                     + "\n" + "                     FROM df125Register_tmp         "
                     + "\n" + "                    WHERE t_type     = " + TDR_MAINREST
                     + "\n" + "                      AND t_creditId = r.t_creditId)");
        end;

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(      " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                     "
                 + "\n" + "                                       t_backOfficeId,                "
                 + "\n" + "                                       t_creditId,                    "
                 + "\n" + "                                       t_fiId,                        "
                 + "\n" + "                                       t_cbAccountNumber)             "
                 + "\n" + "                                SELECT t_chapter,                     "
                 + "\n" + "                                       "+m_backOffice.getId+",        "
                 + "\n" + "                                       acc.t_contractId,              "
                 + "\n" + "                                       acc.t_fiId,                    "
                 + "\n" + "                                       acc.t_cbAccount                "
                 + "\n" + "                                  FROM repLnsAccount_vw acc           "
                 + "\n" + "                                WHERE  acc.t_cbAccount <> chr(1)      "
                 + "\n" + "                                  AND (   EXISTS (SELECT 1 FROM df125TermDemand_tmp d WHERE acc.t_contractId = d.t_creditId)   "
                 + "\n" + "                                       OR EXISTS (SELECT 1 FROM df125Interest_tmp   i WHERE acc.t_contractId = i.t_creditId)   "
                 + "\n" + "                                       OR EXISTS (SELECT 1 FROM df125Register_tmp   r WHERE acc.t_contractId = r.t_creditId)) ");

        return true;
    end;

    /* Данные для строки 3.1 */
    macro getLoanDebtsData31(riskGroupFilter, registerFilter, accruedInterest, creditFilter)
        var commandText = "SELECT  DECODE(GROUPING(t_tranchekind), 1,                                                                     "
                 + "\n" + "               DECODE(t_creditType, 1, 'Кредит',                                                               "
                 + "\n" + "                                   21, 'Гарантии',                                                             "
                 + "\n" + "                                    8, 'Карта',                                                                "
                 + "\n" + "                                   22, 'Овердрафт',                                                            "
                 + "\n" + "                                   to_char(t_creditType)                                                       "
                 + "\n" + "                     ), chr(0))                                                              t_creditType,     "
                 + "\n" + "        DECODE(GROUPING(t_tranchekind), 1, t_creditNumber, chr(0))                           t_number,         "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                  t_creditIssueType,"
                 + "\n" + "        decode(t_type,     2, 'Просроченный ОД',                                                               "
                 + "\n" + "                           3, 'Просроченные проценты',                                                         "
                 + "\n" + "                           4, 'Требования по срочным %',                                                       "
                 + "\n" + "                          18, 'Просроченные проценты по неразрешенному ОД',                                    "
                 + "\n" + "                          63, 'Требования по % оплаченной гарантии',                                           "
                 + "\n" + "                          64, 'Просроченная оплаченная гарантия',                                              "
                 + "\n" + "                          65, 'Просроченные проценты по оплаченной гарантии',                                  "
                 + "\n" + "                       10001, 'Срочное требование',                                                            "
                 + "\n" + "                       10002, 'Наращенные проценты',                                                           "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "              )                                                                              t_type,           "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 10                                                                                        "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 13                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                  t_typeForSort,    "
                 + "\n" + "        t_demanddate                                                                         t_demanddate,     "
                 + "\n" + "        sum(t_sum)                                                                           t_sum,            "
                 + "\n" + "        sum(t_objectSum)                                                                     t_objectSum,      "
                 + "\n" + "        " + creditAmount(1)   + "                                                            t_column2,        "
                 + "\n" + "        " + creditAmount(5)   + "                                                            t_column3,        "
                 + "\n" + "        " + creditAmount(10)  + "                                                            t_column4,        "
                 + "\n" + "        " + creditAmount(20)  + "                                                            t_column5,        "
                 + "\n" + "        " + creditAmount(30)  + "                                                            t_column6,        "
                 + "\n" + "        " + creditAmount(90)  + "                                                            t_column7,        "
                 + "\n" + "        " + creditAmount(180) + "                                                            t_column8,        "
                 + "\n" + "        " + creditAmount(270) + "                                                            t_column9,        "
                 + "\n" + "        " + creditAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()") + "   t_column10,       "
                 + "\n" + "        " + creditAmount("t_maturityterm") + "                                               t_column11        "
                 + "\n" + "    FROM (SELECT reg.t_creditid,                                                                               "
                 + "\n" + "                 reg.t_creditnumber,                                                                           "
                 + "\n" + "                 reg.t_creditType,                                                                             "
                 + "\n" + "                 reg.t_creditIssueType,                                                                        "
                 + "\n" + "                 reg.t_tranchekind,                                                                            "
                 + "\n" + "                 reg.t_tranchenumber,                                                                          "
                 + "\n" + "                 reg.t_type t_type,                                                                            ";

            if (accruedInterest)
                commandText = commandText + " TO_DATE ('01.01.0001', 'dd.mm.yyyy') t_demanddate,                                          "
                 + "\n" + "                 0 t_maturityterm,                                                                             "
                 + "\n" + "                 CASE                                                                                          ";
            else
                commandText = commandText + "CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                       THEN t_accruedInterestDate                                                              "
                 + "\n" + "                       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                               "
                 + "\n" + "                  END t_demanddate,                                                                            "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                       THEN DECODE (t_accruedInterestDate,                                                     "
                 + "\n" + "                                    TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                   "
                 + "\n" + "                                    t_accruedInterestDate - rep_data.getenddate ())                            "
                 + "\n" + "                       ELSE 0                                                                                  "
                 + "\n" + "                  END t_maturityterm,                                                                          "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")                 "
                 + "\n" + "                           THEN reg.t_roublerest - reg.t_calcPercentRvpSum                                     ";
            end;

            commandText = commandText + "         WHEN reg.t_type IN (" + TDR_EXPREST + "," + TDR_EXPPAYMGUARANTEE + ")"
                 + "\n" + "                           THEN reg.t_roublerest - (reg.t_roublerest * reg.t_reservepercent) / 100             "
                 + "\n" + "                       WHEN reg.t_type IN (" + TDR_EXPPERC + "," + TDR_EXPPERC_OV + "," + TDR_PAYMGUARANTEEEXPPERC + ")"
                 + "\n" + "                           THEN reg.t_roublerest - reg.t_calcDelayedPercentRvpSum * reg.t_roublerest /         "
                 + "\n" + "                                (SELECT SUM(t_roubleRest)                                                      "
                 + "\n" + "                                   FROM df125register_tmp r                                                    "
                 + "\n" + "                                  WHERE reg.t_creditid      = r.t_creditId                                     "
                 + "\n" + "                                    AND reg.t_creditType    = r.t_creditType                                   "
                 + "\n" + "                                    AND reg.t_tranchekind   = r.t_trancheKind                                  "
                 + "\n" + "                                    AND reg.t_tranchenumber = r.t_trancheNumber                                "
                 + "\n" + "                                    AND r.t_type IN (" + TDR_EXPPERC + "," + TDR_EXPPERC_OV + "," + TDR_PAYMGUARANTEEEXPPERC + ")"
                 + "\n" + "                                )                                                                              "
                 + "\n" + "                       ELSE 0                                                                                  "
                 + "\n" + "                  END t_sum,                                                                                   "
                 + "\n" + "                  reg.t_roublerest  t_objectSum                                                                ";


            if (accruedInterest)
                commandText = commandText + "FROM df125register_tmp reg";
            else
                commandText = commandText +" FROM (SELECT r.t_creditid, r.t_creditNumber, r.t_credittype, r.t_creditIssueType, r.t_trancheKind, r.t_type,   "
                     + "\n" + "                           r.t_trancheNumber, r.t_demandDate, r.t_roubleRest, r.t_creditRiskGroup,                           "
                     + "\n" + "                           (SELECT MIN(t_repaymentDate)                                                                      "
                     + "\n" + "                              FROM repLnsInterest_vw planpay                                                                 "
                     + "\n" + "                             WHERE r.t_trancheKind         = planPay.t_trancheKind                                           "
                     + "\n" + "                               AND r.t_trancheNumber       = planPay.t_trancheNumber                                         "
                     + "\n" + "                               AND planpay.t_repaymentDate > rep_data.getenddate ()) t_accruedInterestDate,                  "
                     + "\n" + "                           r.t_reservepercent, r.t_calcPercentRvpSum, r.t_calcDelayedPercentRvpSum                           "
                     + "\n" + "                      FROM df125register_tmp r) reg                                                                          ";
            end;

            commandText = commandText
                 + "\n" + " WHERE 1=1 " + riskGroupFilter + registerFilter + creditFilter + "                                       "
                 + "\n" + "           UNION ALL                                                                                     "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 (SELECT credit.t_issueType                                                              "
                 + "\n" + "                    FROM df125credit_tmp credit                                                          "
                 + "\n" + "                   WHERE credit.t_creditid      = dem.t_creditid                                         "
                 + "\n" + "                     AND credit.t_trancheNumber = dem.t_trancheNumber) t_creditIssueType,                "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10001 t_type,                                                                           "
                 + "\n" + "                 dem.t_demanddate,                                                                       "
                 + "\n" + "                 DECODE (dem.t_demanddate,                                                               "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         dem.t_demanddate - rep_data.getenddate ()                                       "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 dem.t_roublesum - (dem.t_roublesum * dem.t_reservePercent) / 100 t_sum,                 "
                 + "\n" + "                 dem.t_roublesum t_objectSum                                                             "
                 + "\n" + "            FROM df125termdemand_tmp dem                                                                 "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                                        "
                 + "\n" + "                           FROM df125register_tmp reg                                                    "
                 + "\n" + "                          WHERE reg.t_trancheKind   = dem.t_trancheKind                                  "
                 + "\n" + "                            AND reg.t_trancheNumber = dem.t_trancheNumber                                "
                 + "\n" + "                            AND reg.t_roubleRest    > 0                                                  "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")                              "
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "           UNION ALL                                                                                     "
                 + "\n" + "          SELECT t_creditid,                                                                             "
                 + "\n" + "                 t_creditnumber,                                                                         "
                 + "\n" + "                 t_creditType,                                                                           "
                 + "\n" + "                 (SELECT credit.t_issueType                                                              "
                 + "\n" + "                    FROM df125credit_tmp credit                                                          "
                 + "\n" + "                   WHERE credit.t_creditid      = interest.t_creditid                                    "
                 + "\n" + "                     AND credit.t_trancheNumber = interest.t_trancheNumber) t_creditIssueType,           "
                 + "\n" + "                 t_tranchekind,                                                                          "
                 + "\n" + "                 t_tranchenumber,                                                                        "
                 + "\n" + "                 10002 t_type,                                                                           "
                 + "\n" + "                 interest.t_demanddate,                                                                  "
                 + "\n" + "                 DECODE (interest.t_demanddate,                                                          "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                        "
                 + "\n" + "                         interest.t_demanddate - rep_data.getenddate ()                                  "
                 + "\n" + "                        ) t_maturityterm,                                                                "
                 + "\n" + "                 interest.t_roublesum - interest.t_roubleSum * interest.t_reservepercent / 100 t_sum,    "
                 + "\n" + "                 interest.t_roublesum t_objectSum                                                        "
                 + "\n" + "            FROM df125Interest_tmp interest                                                              "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                                        "
                 + "\n" + "                           FROM df125register_tmp reg                                                    "
                 + "\n" + "                          WHERE reg.t_trancheKind   = interest.t_trancheKind                             "
                 + "\n" + "                            AND reg.t_trancheNumber = interest.t_trancheNumber                           "
                 + "\n" + "                            AND reg.t_roubleRest    > 0                                                  "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")                              "
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "         )"
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                                            "
                 + "\n" + "                  t_creditType,                                                                          "
                 + "\n" + "                  t_creditIssueType,                                                                     "
                 + "\n" + "                  t_creditNumber),                                                                       "
                 + "\n" + "                 (t_tranchekind,                                                                         "
                 + "\n" + "                  t_tranchenumber,                                                                       "
                 + "\n" + "                  t_demanddate,                                                                          "
                 + "\n" + "                  t_type))                                                                               "
                 + "\n" + "ORDER BY grouping(t_creditid) desc ,                                                                     "
                 + "\n" + "         t_creditid,                                                                                     "
                 + "\n" + "         grouping(t_tranchekind) desc,                                                                   "
                 + "\n" + "         t_tranchekind,                                                                                  "
                 + "\n" + "         t_typeForSort,                                                                                  "
                 + "\n" + "         t_demanddate,                                                                                   "
                 + "\n" + "         t_tranchenumber                                                                                 "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",       V_MONEY);
        data.SetFieldType("objectSum", V_MONEY);
        data.SetFieldType("column2",   V_MONEY);
        data.SetFieldType("column3",   V_MONEY);
        data.SetFieldType("column4",   V_MONEY);
        data.SetFieldType("column5",   V_MONEY);
        data.SetFieldType("column6",   V_MONEY);
        data.SetFieldType("column7",   V_MONEY);
        data.SetFieldType("column8",   V_MONEY);
        data.SetFieldType("column9",   V_MONEY);
        data.SetFieldType("column10",  V_MONEY);
        data.SetFieldType("column11",  V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    /* Данные для строки 13 */
    macro getIssuedGuaranteesAndLiabilityData(filter, useMaturity)
        var commandText = "SELECT  DECODE(t_creditType,  1, 'Кредит',                                                                     "
                 + "\n" + "                             21, 'Гарантии',                                                                   "
                 + "\n" + "                              8, 'Карта',                                                                      "
                 + "\n" + "                             22, 'Овердрафт',                                                                  "
                 + "\n" + "                             to_char(t_creditType))                                         t_creditType,      "
                 + "\n" + "        t_creditNumber                                                                      t_number,          "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                 t_creditIssueType, "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 4                                                                                         "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 10                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                 t_typeForSort,     "
                 + "\n" + "        null                                                                                t_demanddate,      "
                 + "\n" + "        DECODE(t_type,  2, 'Просроч. ОД',                                                                      "
                 + "\n" + "                        3, 'Просроч. %',                                                                       "
                 + "\n" + "                        8, 'Неисп. лимит задолженности',                                                       "
                 + "\n" + "                        7, 'Неисп. лимит выдачи',                                                              "
                 + "\n" + "                       18, 'Проср. % по неразреш. ОД',                                                         "
                 + "\n" + "                       55, 'История выданной гарантии',                                                        "
                 + "\n" + "                       64, 'Проср. оплаченная гарантия',                                                       "
                 + "\n" + "                       65, 'Проср. % по оплач.гарантии',                                                       "
                 + "\n" + "                       167,'Неиспользованный лимит гарантии',                                                  "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "                       )                                                                    t_type,            "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_sum,             "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_objectSum,       ";
            if (useMaturity)
                commandText = commandText
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 1)   or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column2, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 5)   or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column3, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 10)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column4, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 20)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column5, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 30)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column6, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 90)  or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column7, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 180) or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column8, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= 270) or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column9, "
                 + "\n" + "        sum(CASE WHEN ((reg.t_demandDate - rep_data.getEndDate() <= ADD_MONTHS (rep_data.getEndDate(), 12) - rep_data.getEndDate())"
                 + "\n" + "                                                                         or t_demandDate is null) THEN reg.t_roublerest ELSE 0 END) t_column10,"
                 + "\n" + "        sum(reg.t_roublerest)                                                                                                       t_column11 ";
            else
                commandText = commandText
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column2,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column3,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column4,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column5,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column6,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column7,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column8,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column9,         "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column10,        "
                 + "\n" + "        sum(reg.t_roublerest)                                                               t_column11         ";
            end;

            commandText = commandText
                 + "\n" + "     FROM df125register_tmp reg                                                                                "
                 + "\n" + "    WHERE (t_creditType = 21 and (t_type = 55 OR t_type = 167))                                                "
                 + "\n" + "       OR (t_creditType in (8, 22) and t_type = 8)                                                             "
                 + "\n" + "       OR (t_creditType = 1 and ((t_creditIssueType = 4 and t_type = 7)                                        "
                 + "\n" + "                                  or                                                                           "
                 + "\n" + "                                 (t_creditIssueType = 5 and t_type = 8)                                        "
                 + "\n" + "                                 or                                                                            "
                 + "\n" + "                                 (t_creditIssueType = 3 and                                                    "
                 + "\n" + "                                  t_roublerest||t_type =                                                       "
                 + "\n" + "                                            (select MIN(r.t_roublerest||r.t_type)                              "/*нужно найти меньший остаток из регистров 7, 8*/
                 + "\n" + "                                              from df125register_tmp r                                         "/*t_roublerest||t_type, чтобы взять один из регистров если остатки равны*/
                 + "\n" + "                                             where r.t_type in (7, 8)                                          "
                 + "\n" + "                                               and r.t_creditId = reg.t_creditId                               "
                 + "\n" + "                                             group by r.t_creditId                                             "
                 + "\n" + "                                            )                                                                  "
                 + "\n" + "                                ))                                                                             "
                 + "\n" + "          )                                                                                                    "
                 + "\n" + " GROUP BY t_creditid,                                                                                          "
                 + "\n" + "          t_creditNumber,                                                                                      "
                 + "\n" + "          t_creditType,                                                                                        "
                 + "\n" + "          t_creditIssueType,                                                                                   "
                 + "\n" + "          t_tranchekind,                                                                                       "
                 + "\n" + "          t_tranchenumber,                                                                                     "
                 + "\n" + "          t_type                                                                                               "
                 + "\n" + " ORDER BY t_creditid,                                                                                          "
                 + "\n" + "          t_tranchekind,                                                                                       "
                 + "\n" + "          t_typeForSort                                                                                        "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",        V_MONEY);
        data.SetFieldType("objectSum",  V_MONEY);
        data.SetFieldType("column2",    V_MONEY);
        data.SetFieldType("column3",    V_MONEY);
        data.SetFieldType("column4",    V_MONEY);
        data.SetFieldType("column5",    V_MONEY);
        data.SetFieldType("column6",    V_MONEY);
        data.SetFieldType("column7",    V_MONEY);
        data.SetFieldType("column8",    V_MONEY);
        data.SetFieldType("column9",    V_MONEY);
        data.SetFieldType("column10",   V_MONEY);
        data.SetFieldType("column11",   V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    macro getLoanDebtsData(riskGroupFilter, registerFilter, accruedInterest, creditFilter)
        var commandText = "SELECT  DECODE(GROUPING(t_tranchekind), 1,                                                                     "
                 + "\n" + "               DECODE(t_creditType, 1, 'Кредит',                                                               "
                 + "\n" + "                                   21, 'Гарантии',                                                             "
                 + "\n" + "                                    8, 'Карта',                                                                "
                 + "\n" + "                                   22, 'Овердрафт',                                                            "
                 + "\n" + "                                   to_char(t_creditType)                                                       "
                 + "\n" + "                     ), chr(0))                                                              t_creditType,     "
                 + "\n" + "        DECODE(GROUPING(t_tranchekind), 1, t_creditNumber, chr(0))                           t_number,         "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_creditType = 1                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 1 THEN 'Разовый'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 2 THEN 'Частями'                                              "
                 + "\n" + "                        WHEN t_creditIssueType = 3 THEN 'Лимит выдачи+задолженности'                           "
                 + "\n" + "                        WHEN t_creditIssueType = 4 THEN 'Невозобновляемая КЛ'                                  "
                 + "\n" + "                        WHEN t_creditIssueType = 5 THEN 'Под лимит задолженности'                              "
                 + "\n" + "                        WHEN t_creditIssueType = 6 THEN 'До востребования'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 7 THEN 'До наступления условия'                               "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 8                                                                              "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 10 THEN 'Расчетная карта'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 11 THEN 'Кредитная карта'                                     "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            WHEN t_creditType = 21                                                                             "
                 + "\n" + "                THEN                                                                                           "
                 + "\n" + "                    CASE                                                                                       "
                 + "\n" + "                        WHEN t_creditIssueType = 8 THEN 'Разовая гарантия'                                     "
                 + "\n" + "                        WHEN t_creditIssueType = 9 THEN 'Гарантийная Линия'                                    "
                 + "\n" + "                        ELSE CHR(0)                                                                            "
                 + "\n" + "                    END                                                                                        "
                 + "\n" + "            ELSE CHR(0)                                                                                        "
                 + "\n" + "        END                                                                                  t_creditIssueType,"
                 + "\n" + "        decode(t_type,     2, 'Просроченный ОД',                                                               "
                 + "\n" + "                           3, 'Просроченные проценты',                                                         "
                 + "\n" + "                           4, 'Требования по срочным %',                                                       "
                 + "\n" + "                           8, 'Неиспользованный лимит задолженности',                                          "
                 + "\n" + "                           7, 'Неиспользованный лимит выдачи',                                                 "
                 + "\n" + "                          18, 'Просроченные проценты по неразрешенному ОД',                                    "
                 + "\n" + "                          55, 'История выданной гарантии',                                                     "
                 + "\n" + "                          63, 'Требования по % оплаченной гарантии',                                           "
                 + "\n" + "                          64, 'Просроченная оплаченная гарантия',                                              "
                 + "\n" + "                          65, 'Просроченные проценты по оплаченной гарантии',                                  "
                 + "\n" + "                       10001, 'Срочное требование',                                                            "
                 + "\n" + "                       10002, 'Наращенные проценты',                                                           "
                 + "\n" + "                       chr(0)                                                                                  "
                 + "\n" + "              )                                                                               t_type,          "
                 + "\n" + "        CASE                                                                                                   "
                 + "\n" + "            WHEN t_type = 10001      --Срочное требование                                                      "
                 + "\n" + "                THEN 1                                                                                         "
                 + "\n" + "            WHEN t_type = 2          --Просроченный ОД                                                         "
                 + "\n" + "                THEN 7                                                                                         "
                 + "\n" + "            WHEN t_type = 64         --Просроченная оплаченная гарантия                                        "
                 + "\n" + "                THEN 9                                                                                         "
                 + "\n" + "            WHEN t_type = 4          --Требования по срочным %                                                 "
                 + "\n" + "                THEN 4                                                                                         "
                 + "\n" + "            WHEN t_type = 3          --Просроченные проценты                                                   "
                 + "\n" + "                THEN 10                                                                                        "
                 + "\n" + "            WHEN t_type = 18         --Просроченные проценты по неразрешенному ОД                              "
                 + "\n" + "                THEN 11                                                                                        "
                 + "\n" + "            WHEN t_type = 64         --Просроченные проценты по оплаченной гарантии                            "
                 + "\n" + "                THEN 12                                                                                        "
                 + "\n" + "            WHEN t_type = 10002      --Наращенные проценты                                                     "
                 + "\n" + "                THEN 10002                                                                                     "
                 + "\n" + "            ELSE 999999              --неизвестный тип - в конец                                               "
                 + "\n" + "        END                                                                                  t_typeForSort,    "
                 + "\n" + "        t_demanddate                                                                         t_demanddate,     "
                 + "\n" + "        sum(t_sum)                                                                           t_sum,            "
                 + "\n" + "        sum(t_objectSum)                                                                     t_objectSum,      "
                 + "\n" + "        " + creditAmount(1)   + "                                                            t_column2,        "
                 + "\n" + "        " + creditAmount(5)   + "                                                            t_column3,        "
                 + "\n" + "        " + creditAmount(10)  + "                                                            t_column4,        "
                 + "\n" + "        " + creditAmount(20)  + "                                                            t_column5,        "
                 + "\n" + "        " + creditAmount(30)  + "                                                            t_column6,        "
                 + "\n" + "        " + creditAmount(90)  + "                                                            t_column7,        "
                 + "\n" + "        " + creditAmount(180) + "                                                            t_column8,        "
                 + "\n" + "        " + creditAmount(270) + "                                                            t_column9,        "
                 + "\n" + "        " + creditAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()") + "   t_column10,       "
                 + "\n" + "        " + creditAmount("t_maturityterm") + " t_column11"
                 + "\n" + "    FROM (SELECT reg.t_creditid,                                                                               "
                 + "\n" + "                 reg.t_creditnumber,                                                                           "
                 + "\n" + "                 reg.t_creditType,                                                                             "
                 + "\n" + "                 reg.t_creditIssueType,                                                                        "
                 + "\n" + "                 reg.t_tranchekind,                                                                            "
                 + "\n" + "                 reg.t_tranchenumber,                                                                          "
                 + "\n" + "                 reg.t_type t_type,                                                                            ";

            if (accruedInterest)
                commandText = commandText + " TO_DATE ('01.01.0001', 'dd.mm.yyyy') t_demanddate,                                    "
                 + "\n" + "                 0 t_maturityterm,                                                                       "
            else
                commandText = commandText + "CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")           "
                 + "\n" + "                       THEN t_accruedInterestDate                                                        "
                 + "\n" + "                       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                                         "
                 + "\n" + "                  END t_demanddate,                                                                      "
                 + "\n" + "                  CASE WHEN reg.t_type IN (" + TDR_CLAIM + "," + TDR_PAYMGUARANTEEPERCDEM + ")           "
                 + "\n" + "                       THEN DECODE (t_accruedInterestDate,                                               "
                 + "\n" + "                                    TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                             "
                 + "\n" + "                                    t_accruedInterestDate - rep_data.getenddate ())                      "
                 + "\n" + "                       ELSE 0                                                                            "
                 + "\n" + "                  END t_maturityterm,                                                                    ";
            end;

            commandText = commandText + "    reg.t_roublerest t_sum,                                                                "
                 + "\n" + "                  reg.t_roublerest t_objectSum                                                           ";

            if (accruedInterest)
                commandText = commandText + "FROM df125register_tmp reg";
            else
                commandText = commandText +" FROM (SELECT r.t_creditid, r.t_creditNumber, r.t_credittype, r.t_creditIssueType, r.t_trancheKind, r.t_type,"
                     + "\n" + "                           r.t_trancheNumber, r.t_demandDate, r.t_roubleRest, r.t_creditRiskGroup,                        "
                     + "\n" + "                           (SELECT MIN(t_repaymentDate)                                                                   "
                     + "\n" + "                              FROM repLnsInterest_vw planpay                                                              "
                     + "\n" + "                             WHERE r.t_trancheKind         = planPay.t_trancheKind                                        "
                     + "\n" + "                               AND r.t_trancheNumber       = planPay.t_trancheNumber                                      "
                     + "\n" + "                               AND planpay.t_repaymentDate > rep_data.getenddate ()) t_accruedInterestDate,               "
                     + "\n" + "                           r.t_reservepercent                                                                             "
                     + "\n" + "                      FROM df125register_tmp r) reg                                                                       ";

            end;

            commandText = commandText + "\n" + " WHERE 1=1 " + riskGroupFilter + registerFilter + creditFilter +"                                        ";

            commandText = commandText
                 + "\n" + "           UNION ALL                                                                 "
                 + "\n" + "          SELECT t_creditid,                                                         "
                 + "\n" + "                 t_creditnumber,                                                     "
                 + "\n" + "                 t_creditType,                                                       "
                 + "\n" + "                 (SELECT credit.t_issueType                                          "
                 + "\n" + "                    FROM df125credit_tmp credit                                      "
                 + "\n" + "                   WHERE credit.t_creditid      = dem.t_creditid                     "
                 + "\n" + "                     AND credit.t_trancheNumber = dem.t_trancheNumber) t_creditIssueType,"
                 + "\n" + "                 t_tranchekind,                                                      "
                 + "\n" + "                 t_tranchenumber,                                                    "
                 + "\n" + "                 10001 t_type,                                                       "
                 + "\n" + "                 dem.t_demanddate,                                                   "
                 + "\n" + "                 DECODE (dem.t_demanddate,                                           "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                    "
                 + "\n" + "                         dem.t_demanddate - rep_data.getenddate ()                   "
                 + "\n" + "                        ) t_maturityterm,                                            "
                 + "\n" + "                 dem.t_roublesum t_sum,                                              "
                 + "\n" + "                 dem.t_roublesum t_objectSum                                         "
                 + "\n" + "            FROM df125termdemand_tmp dem                                             "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                    "
                 + "\n" + "                           FROM df125register_tmp reg                                "
                 + "\n" + "                          WHERE reg.t_trancheKind   = dem.t_trancheKind              "
                 + "\n" + "                            AND reg.t_trancheNumber = dem.t_trancheNumber            "
                 + "\n" + "                            AND reg.t_roubleRest    > 0                              "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")"
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "           UNION ALL                                                                 "
                 + "\n" + "          SELECT t_creditid,                                                         "
                 + "\n" + "                 t_creditnumber,                                                     "
                 + "\n" + "                 t_creditType,                                                       "
                 + "\n" + "                 (SELECT credit.t_issueType                                          "
                 + "\n" + "                    FROM df125credit_tmp credit                                      "
                 + "\n" + "                   WHERE credit.t_creditid      = interest.t_creditid                "
                 + "\n" + "                     AND credit.t_trancheNumber = interest.t_trancheNumber) t_creditIssueType,"
                 + "\n" + "                 t_tranchekind,                                                      "
                 + "\n" + "                 t_tranchenumber,                                                    "
                 + "\n" + "                 10002 t_type,                                                       "
                 + "\n" + "                 interest.t_demanddate,                                              "
                 + "\n" + "                 DECODE (interest.t_demanddate,                                      "
                 + "\n" + "                         TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                    "
                 + "\n" + "                         interest.t_demanddate - rep_data.getenddate ()              "
                 + "\n" + "                        ) t_maturityterm,                                            "
                 + "\n" + "                 interest.t_roublesum t_sum,                                         "
                 + "\n" + "                 interest.t_roublesum t_objectSum                                    "
                 + "\n" + "            FROM df125Interest_tmp interest                                          "
                 + "\n" + "           WHERE EXISTS (SELECT 1                                                    "
                 + "\n" + "                           FROM df125register_tmp reg                                "
                 + "\n" + "                          WHERE reg.t_trancheKind   = interest.t_trancheKind         "
                 + "\n" + "                            AND reg.t_trancheNumber = interest.t_trancheNumber       "
                 + "\n" + "                            AND reg.t_roubleRest    > 0                              "
                 + "\n" + "                            AND (   reg.t_type = " + TDR_MAINREST
                 + "\n" + "                                 OR reg.t_type = " + TDR_PAYMGUARANTEE + ")"
                 + "\n" + "                        )" + creditFilter + riskGroupFilter
                 + "\n" + "         )                                                                           "
                 + "\n" + "GROUP BY ROLLUP ((t_creditid,                                                        "
                 + "\n" + "                  t_creditType,                                                      "
                 + "\n" + "                  t_creditIssueType,                                                 "
                 + "\n" + "                  t_creditNumber),                                                   "
                 + "\n" + "                 (t_tranchekind,                                                     "
                 + "\n" + "                  t_tranchenumber,                                                   "
                 + "\n" + "                  t_demanddate,                                                      "
                 + "\n" + "                  t_type))                                                           "
                 + "\n" + "ORDER BY grouping(t_creditid) desc ,                                                 "
                 + "\n" + "         t_creditid,                                                                 "
                 + "\n" + "         grouping(t_tranchekind) desc,                                               "
                 + "\n" + "         t_tranchekind,                                                              "
                 + "\n" + "         t_typeForSort,                                                              "
                 + "\n" + "         t_demanddate,                                                               "
                 + "\n" + "         t_tranchenumber                                                             "
                 ;

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",       V_MONEY);
        data.SetFieldType("objectSum", V_MONEY);
        data.SetFieldType("column2",   V_MONEY);
        data.SetFieldType("column3",   V_MONEY);
        data.SetFieldType("column4",   V_MONEY);
        data.SetFieldType("column5",   V_MONEY);
        data.SetFieldType("column6",   V_MONEY);
        data.SetFieldType("column7",   V_MONEY);
        data.SetFieldType("column8",   V_MONEY);
        data.SetFieldType("column9",   V_MONEY);
        data.SetFieldType("column10",  V_MONEY);
        data.SetFieldType("column11",  V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    constructorT125LoansCreditDataSource4099();
end;

/**
 * Источник данных Лоанс по депозитам
 */
class (TDepositsDataSource) T125DepositsDataSource()
    private macro constructor()
        initTDepositsDataSource("loansDeposit");
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        m_filter = T125DepositsDataSourceFilter();
        return true;
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = T125DepositsDataSourceProtocol();
        return true;
    end;

    /**
     * Очистить закешированные данные.
     */
    macro clear() : bool
        sql_execute("TRUNCATE TABLE df125DepositInterest_tmp");
        sql_execute("TRUNCATE TABLE df125DepositRegister_tmp");
    end;

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        clear();

        var depositFilter = rcbBranchAndDepartmentFieldFilter().GetAsSqlString("dep.t_departmentId", "dep.t_branchId") +
                     " AND dep.t_isOpenedAtEndDate = 1 "
                     " AND dep.t_type = " + LO_DEPOSIT ;

        var endDateStr = getSqlDate(rcbApplication().currentReport.context.period.endDate);
        var accruedInterest;
        var interestCondition;
        getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 125/НАРАЩЕННЫЕ ПРОЦЕНТЫ", V_BOOL, accruedInterest, null);

        /* Регистры */
       sql_execute(      " INSERT INTO df125DepositRegister_tmp(t_depositId,                              "
                + "\n" + "                                      t_depositNumber,                          "
                + "\n" + "                                      t_depositType,                            "
                + "\n" + "                                      t_trancheNumber,                          "
                + "\n" + "                                      t_trancheKind,                            "
                + "\n" + "                                      t_depositIssueType,                       "
                + "\n" + "                                      t_depositDemandDate,                      "
                + "\n" + "                                      t_depositIsCapitalized,                   "
                + "\n" + "                                      t_type,                                   "
                + "\n" + "                                      t_roubleRest)                             "
                + "\n" + "                               SELECT dep.t_creditid,                           "
                + "\n" + "                                      dep.t_creditnumber,                       "
                + "\n" + "                                      dep.t_credittype,                         "
                + "\n" + "                                      dep.t_trancheNumber,                      "
                + "\n" + "                                      dep.t_trancheKind,                        "
                + "\n" + "                                      dep.t_issueType,                          "
                + "\n" + "                                      dep.t_finishDate,                         "
                + "\n" + "                                      dep.t_isCapitalized,                      "
                + "\n" + "                                      reg.t_type,                               "
                + "\n" + "                                      reg.t_roubleRest                          "
                + "\n" + "                                 FROM repLnsRegister_vw reg,                    "
                + "\n" + "                                      df125credit_tmp dep                       "
                + "\n" + "                                WHERE dep.t_creditType = " + LO_DEPOSIT
                + "\n" + "                                  AND dep.t_tranchekind   = reg.t_trancheKind   "
                + "\n" + "                                  AND dep.t_trancheNumber = reg.t_trancheNumber "
                + "\n" + "                                  AND (reg.t_rest <> 0 and reg.t_type IN (" + TDR_DEPOHIST +" ,"
                                                                                                      + TDR_DEPOPERC + "))");

        if (accruedInterest)
            sql_execute(      " INSERT INTO df125DepositInterest_tmp(t_depositId,                             "
                    + "\n" + "                                      t_roubleSum,                              "
                    + "\n" + "                                      t_demandDate)                             "
                    + "\n" + "   SELECT t_creditId,                                                                                                             "
                    + "\n" + "          (NVL(RSB_FIINSTR.convSum(A_PERCENTSUM , A_CURCODE , 0," + endDateStr +"), 0)) AS t_roubleSum , a_paydate                 "
                    + "\n" + "     FROM (                                                                                                                        "
                    + "\n" + "           SELECT contract.t_creditId,                                                                                             "
                    + "\n" + "                  t_plannedpercentsum a_percentsum,                                                                                "
                    + "\n" + "                  t_plannedpaydate a_paydate,                                                                                      "
                    + "\n" + "                  DECODE (planpay.t_objecttypeid_ref, 6, NVL ((SELECT t_curcode                                                    "
                    + "\n" + "                                                                 FROM dcredit_c_dbt                                                "
                    + "\n" + "                                                                WHERE t_creditnumber = (SELECT t_creditnumber_ref                  "
                    + "\n" + "                                                                                          FROM dduty_crd_dbt                       "
                    + "\n" + "                                                                                         WHERE t_dutyid = planpay.t_objectid_ref)),"
                    + "\n" + "                                                             0),                                                                   "
                    + "\n" + "                          NVL ( (SELECT t_curcode                                                                                  "
                    + "\n" + "                                   FROM dcredit_c_dbt                                                                              "
                    + "\n" + "                                  WHERE t_creditnumber = planpay.t_objectid_ref),                                                  "
                    + "\n" + "                        0)) a_curcode                                                                                              "
                    + "\n" + "             FROM dplanpay_dbt planpay, df125Credit_tmp contract                                                                   "
                    + "\n" + "            WHERE planpay.t_plannedpercentsum > 0                                                                                  "
                    + "\n" + "              AND planpay.t_type IN (0, 4)                                                                                         "
                    + "\n" + "              AND planpay.t_credoperid_ref = (SELECT MAX (lgpayop.t_credoperid_ref)                                                "
                    + "\n" + "                                                FROM dlgpayop_dbt lgpayop                                                          "
                    + "\n" + "                                                     JOIN dcrd_op_dbt crd_op                                                       "
                    + "\n" + "                                                       ON crd_op.t_credoperid = lgpayop.t_credoperid_ref                           "
                    + "\n" + "                                               WHERE crd_op.t_objectid_ref = planpay.t_objectid_ref                                "
                    + "\n" + "                                                 AND lgpayop.t_type IN (0, 4)                                                      "
                    + "\n" + "                                                 AND crd_op.t_objecttypeid_ref = planpay.t_objecttypeid_ref                        "
                    + "\n" + "                                                 AND crd_op.t_credoperdate <= " + endDateStr
                    + "\n" + "                                              )                                                                                    "
                    + "\n" + "              AND contract.t_trancheKind = planPay.t_objecttypeid_ref                                                              "
                    + "\n" + "              AND contract.t_trancheNumber = planPay.t_objectid_ref                                                                "
                    + "\n" + "              AND t_plannedpercentsum <> 0                                                                                         "
                    + "\n" + "              AND contract.t_creditType = " + LO_DEPOSIT
                    + "\n" + "              AND t_plannedpaydate > " + endDateStr + ")" );
        end;

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(      " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                     "
                 + "\n" + "                                       t_backOfficeId,                "
                 + "\n" + "                                       t_creditId,                    "
                 + "\n" + "                                       t_fiId,                        "
                 + "\n" + "                                       t_cbAccountNumber)             "
                 + "\n" + "                                SELECT t_chapter,                     "
                 + "\n" + "                                       "+m_backOffice.getId+",        "
                 + "\n" + "                                       acc.t_contractId,              "
                 + "\n" + "                                       acc.t_fiId,                    "
                 + "\n" + "                                       acc.t_cbAccount                "
                 + "\n" + "                                  FROM repLnsAccount_vw acc           "
                 + "\n" + "                                WHERE acc.t_cbAccount <> chr(1)       "
                 + "\n" + "                                  AND EXISTS (SELECT 1 FROM df125DepositRegister_tmp reg WHERE reg.t_depositId = acc.t_contractId) ");

        return true;
    end;

    /**
     * Сумма вклада физических лиц для срока.
     *
     *  @param     term   срок
     */
    private macro depositAmount(term)
        return        " CASE WHEN GROUPING(t_type)+GROUPING(t_depositid) <> 1                       "
             + "\n" + "      THEN SUM(CASE WHEN t_depositIssueType IN (12, 14)                                     "
             + "\n" + "                    THEN CASE WHEN t_maturityterm <= " + term + " OR t_maturityterm IS NULL "
             + "\n" + "                              THEN t_sum                                               "
             + "\n" + "                              ELSE 0                                                   "
             + "\n" + "           END                                                                    "
             + "\n" + "                    WHEN t_depositIssueType IN (13, 15)                                     "
             + "\n" + "                    THEN t_sum                                                              "
             + "\n" + "                    ELSE 0                                                                  "
             + "\n" + "                END)                                                                        "
             + "\n" + "      ELSE null                                                              "
             + "\n" + " END                                                                              ";
    end;

    /**
     *
     */
    private macro registerRepaymentDate(dateOfAccruedInterest)
        if (NVL(dateOfAccruedInterest, "") != "")
            return        "   CASE                                                                "
                 + "\n" + "       WHEN t_depositIssueType IN(" + dateOfAccruedInterest + ")"
                 + "\n" + "       THEN (SELECT MIN(t_plannedPayDate)                                                   "
                 + "\n" + "               FROM dplanpay_dbt planpay                                                    "
                 + "\n" + "              WHERE planpay.t_type IN (0, 4)                                                                  "
                 + "\n" + "                AND planpay.t_credoperid_ref = (SELECT MAX (lgpayop.t_credoperid_ref)                         "
                 + "\n" + "                                                  FROM dlgpayop_dbt lgpayop                                   "
                 + "\n" + "                                                       JOIN dcrd_op_dbt crd_op                                "
                 + "\n" + "                                                         ON crd_op.t_credoperid = lgpayop.t_credoperid_ref    "
                 + "\n" + "                                                 WHERE crd_op.t_objectid_ref = planpay.t_objectid_ref         "
                 + "\n" + "                                                   AND lgpayop.t_type IN (0, 4)                               "
                 + "\n" + "                                                   AND crd_op.t_objecttypeid_ref = planpay.t_objecttypeid_ref "
                 + "\n" + "                                                   AND crd_op.t_credoperdate <= rep_data.getenddate ()        "
                 + "\n" + "                                            )                                                                 "
                 + "\n" + "            AND reg.t_trancheKind = planPay.t_objecttypeid_ref                                                "
                 + "\n" + "            AND reg.t_trancheNumber = planPay.t_objectid_ref                                                  "
                 + "\n" + "            AND planpay.t_plannedpercentsum <> 0                                                              "
                 + "\n" + "            AND planpay.t_plannedpaydate > rep_data.getenddate ())                                            "
                 + "\n" + "       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                             "
                 + "\n" + "   END                                                                       ";
        else
            return        "   CASE t_type                                                               "
                 + "\n" + "       WHEN 69 THEN t_depositDemandDate                                      "
                 + "\n" + "       ELSE TO_DATE ('01.01.0001', 'dd.mm.yyyy')                             "
                 + "\n" + "   END                                                                       ";
        end;
    end;

    /**
     *
     */
    private macro interestRepaymentDate()
        return        "   CASE t_depositIsCapitalized                                               "
             + "\n" + "       WHEN 1 THEN t_depositDemandDate                                       "
             + "\n" + "       ELSE t_demandDate                                                     "
             + "\n" + "   END                                                                       ";
    end;

    /**
     * Получить данные.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getData(registerFilter, useAccruedInterest, accruedInterestFilter, dateOfAccruedInterest, employerFilter)
        var commandText = "SELECT DECODE(t_depositType, 28, 'Депозитный договор',                                                     "
                 + "\n" + "                             to_char(t_depositType))                                    t_depositType,     "
                 + "\n" + "       DECODE(GROUPING(t_type), 1, t_depositNumber, chr(1))                             t_number,          "
                 + "\n" + "       DECODE(GROUPING(t_type), 1,                                                                         "
                 + "\n" + "              decode(t_depositIssueType, 12, 'Срочный депозит',                                            "
                 + "\n" + "                                         13, 'Депозит до востребования',                                   "
                 + "\n" + "                                         14, 'Срочный депозит с пополнением',                              "
                 + "\n" + "                                         15, 'Депозит до востребования с пополнением'),                    "
                 + "\n" + "              chr(1))                                                                   t_depositIssueType,"
                 + "\n" + "       decode(t_type, " + TDR_DEPOHIST + ", 'История депозита ',                                           "
                 + "\n" + "                      " + TDR_DEPOPERC + ", 'Обязательства по срочным процентам',                          "
                 + "\n" + "                      10002, 'Наращенные проценты',                                                        "
                 + "\n" + "                      chr(1)                                                                               "
                 + "\n" + "                      )                                                                 t_type,            "
                 + "\n" + "       t_demanddate,                                                                                       "
                 + "\n" + "       SUM(t_sum)                                                                       t_sum,             "
                 + "\n" + "       "+depositAmount(  1)+"                                                           t_column2,         "
                 + "\n" + "       "+depositAmount(  5)+"                                                           t_column3,         "
                 + "\n" + "       "+depositAmount( 10)+"                                                           t_column4,         "
                 + "\n" + "       "+depositAmount( 20)+"                                                           t_column5,         "
                 + "\n" + "       "+depositAmount( 30)+"                                                           t_column6,         "
                 + "\n" + "       "+depositAmount( 90)+"                                                           t_column7,         "
                 + "\n" + "       "+depositAmount(180)+"                                                           t_column8,         "
                 + "\n" + "       "+depositAmount(270)+"                                                           t_column9,         "
                 + "\n" + "       "+depositAmount("ADD_MONTHS(rep_data.getenddate(),12)-rep_data.getenddate()")+"  t_column10,        "
                 + "\n" + "       "+depositAmount("t_maturityterm")+"                                              t_column11         "
                 + "\n" + "  FROM (SELECT reg.t_depositid,                                                                            "
                 + "\n" + "               reg.t_depositNumber,                                                                        "
                 + "\n" + "               reg.t_depositIssueType,                                                                     "
                 + "\n" + "               reg.t_depositType,                                                                          "
                 + "\n" + "               reg.t_type t_type,                                                                          "
                 + "\n" + "               " + registerRepaymentDate(dateOfAccruedInterest) + " t_demanddate,                          "
                 + "\n" + "               DECODE (" + registerRepaymentDate(dateOfAccruedInterest) + ",                               "
                 + "\n" + "                       TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                            "
                 + "\n" + "                       " + registerRepaymentDate(dateOfAccruedInterest) + " - rep_data.getenddate ()       "
                 + "\n" + "                      ) t_maturityterm,                                                                    "
                 + "\n" + "               reg.t_roublerest t_sum                                                                      "
                 + "\n" + "          FROM df125depositRegister_tmp reg                                                                "
                 + "\n" + "         WHERE 1=1 " + registerFilter + "                                                                  ";
        if (NVL(employerFilter, "") != "")
            commandText = commandText + employerFilter;
        end;

        if (useAccruedInterest)
            commandText = commandText
                 + "\n" + "         UNION ALL                                                                                         "
                 + "\n" + "        SELECT interest.t_depositid,                                                                       "
                 + "\n" + "               reg.t_depositNumber,                                                                        "
                 + "\n" + "               reg.t_depositIssueType,                                                                     "
                 + "\n" + "               reg.t_depositType,                                                                          "
                 + "\n" + "               10002 t_type,                                                                               "
                 + "\n" + "               "+interestRepaymentDate+" t_demanddate,                                                     "
                 + "\n" + "               DECODE ("+interestRepaymentDate+",                                                          "
                 + "\n" + "                       TO_DATE ('01.01.0001', 'dd.mm.yyyy'), 0,                                            "
                 + "\n" + "                       " + interestRepaymentDate + " - rep_data.getenddate ()                              "
                 + "\n" + "                      ) t_maturityterm,                                                                    "
                 + "\n" + "               interest.t_roublesum t_sum                                                                  "
                 + "\n" + "          FROM df125depositInterest_tmp interest,                                                          "
                 + "\n" + "               df125depositRegister_tmp reg                                                                "
                 + "\n" + "         WHERE reg.t_depositid = interest.t_depositid                                                      ";
            if (NVL(accruedInterestFilter, "") != "")
                commandText = commandText + " AND reg.t_type      = "+accruedInterestFilter;
            end;
            if (NVL(employerFilter, "") != "")
                commandText = commandText + employerFilter;
            end;
        end;

        commandText = commandText +                                          ")                                                       "
                 + "\n" + "WHERE NOT ((t_type = 10002) AND (t_depositIssueType IN (13, 15)))                                          "
                 + "\n" + "GROUP BY ROLLUP ((t_depositid,                                                                             "
                 + "\n" + "                  t_depositType,                                                                           "
                 + "\n" + "                  t_depositIssueType,                                                                      "
                 + "\n" + "                  t_depositNumber),                                                                        "
                 + "\n" + "                 (t_demanddate,                                                                            "
                 + "\n" + "                  t_depositissuetype,                                                                      "
                 + "\n" + "                  t_type))                                                                                 "
                 + "\n" + "ORDER BY grouping(t_depositid) desc,                                                                       "
                 + "\n" + "         t_depositid,                                                                                      "
                 + "\n" + "         t_type,                                                                                           "
                 + "\n" + "         t_demanddate                                                                                      ";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("demanddate", V_DATE);
        data.SetFieldType("sum",        V_MONEY);
        data.SetFieldType("column2",    V_MONEY);
        data.SetFieldType("column3",    V_MONEY);
        data.SetFieldType("column4",    V_MONEY);
        data.SetFieldType("column5",    V_MONEY);
        data.SetFieldType("column6",    V_MONEY);
        data.SetFieldType("column7",    V_MONEY);
        data.SetFieldType("column8",    V_MONEY);
        data.SetFieldType("column9",    V_MONEY);
        data.SetFieldType("column10",   V_MONEY);
        data.SetFieldType("column11",   V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    constructor();
end;


/**
 * Источник данных Ритейла.
 */
class (TRetailDataSource) T125RetailDepositDataSource()
    private macro constructor()
        initTRetailDataSource("retailDeposit");
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        /*на текущий момент фильтр не нужен*/
        return true;
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = T125RetailDepositDataSourceProtocol();
        return true;
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        sql_execute("TRUNCATE TABLE df125deposit_tmp");
    end;

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        clear();

       /* Депозиты */
       sql_execute(      " INSERT INTO df125deposit_tmp (t_id,                                                     "
                + "\n" + "                               t_number,                                                 "
                + "\n" + "                               t_maturityDate,                                           "
                + "\n" + "                               t_interestMaturityDate,                                   "
                + "\n" + "                               t_outRest,                                                "
                + "\n" + "                               t_interestAccountValue,                                   "
                + "\n" + "                               t_accruedInteresAccountValue,"
                + "\n" + "                               t_cbAccount,                                              "
                + "\n" + "                               t_cbInterestAccount,         "
                + "\n" + "                               t_isDemand)                  "
                + "\n" + "                        SELECT dep.t_contractId,                                         "
                + "\n" + "                               dep.t_number,                                             "
                + "\n" + "                               dep.t_plannedCloseDate,                                   "
                + "\n" + "                               dep.t_accruedInterestRepaymentDate,                       "
                + "\n" + "                               dep.t_roubleOutRest,                                      "
                + "\n" + "                               dep.t_roubleInterestSum,                                  "
                + "\n" + "                               dep.t_roubleAccruedInterestSum,                           "
                + "\n" + "                               dep.t_cbAccount,                                          "
                + "\n" + "        (SELECT perc.t_cbaccount                            "
                + "\n" + "           FROM repRtlAccumpcAccount_vw perc                "
                + "\n" + "          WHERE dep.t_referenc = perc.t_referenc),          "
                + "\n" + "        dep.t_isDemand                                      "
                + "\n" + "                          FROM repRtlDeposit_vw dep                                      "
                + "\n" + "                         WHERE " + RcbBranchFieldFilter().GetAsSqlString("dep.t_branchId")
                + "\n" + "    AND dep.t_isOpeneDatEndDate = 1                         "
                + "\n" + "    AND dep.t_account IS NOT NULL /*т.к. в ритейле встречаются договора без счетов (это баг ритейла) которые нужно игнорировать*/");

        /*Заполнения списока л/с учтенных по бэк-офису*/
        sql_execute(      " INSERT INTO drcbBackOfficeAccount_tmp(t_chapter,                     "
                 + "\n" + "                                       t_backOfficeId,                "
                 + "\n" + "                                       t_creditId,                    "
                 + "\n" + "                                       t_fiId,                        "
                 + "\n" + "                                       t_cbAccountNumber)"
                 + "\n" + "                                SELECT t_chapter,                     "
                 + "\n" + "        " + m_backOffice.getId + ",                      "
                 + "\n" + "                                       acc.t_contractId,              "
                 + "\n" + "                                       acc.t_fiId,                    "
                 + "\n" + "                                       acc.t_cbAccount                "
                 + "\n" + "                                  FROM repLnsAccount_vw acc           "
                 + "\n" + "                                WHERE acc.t_cbAccount <> chr(1)      "
                 + "\n" + "    AND EXISTS (SELECT 1                                 "
                 + "\n" + "                  FROM df125deposit_tmp dep              "
                 + "\n" + "                 WHERE dep.t_id = acc.t_contractId)      ");

        return true;
    end;

    /**
     * Получить данные.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getData(filter/*filter : RcbDataSourceFilter, attribute : RcbAttributeBase*/)
        /**
         * Сумма вклада физических лиц для срока.
         */
        private macro depositAmount(term)
            return        "   SUM(CASE                                                                  "
                 + "\n" + "               WHEN (   t_maturityTerm <= " + term
                 + "\n" + "                     OR t_maturityTerm IS NULL)                                        "
                 + "\n" + "                   THEN t_outRest                                                      "
                 + "\n" + "               ELSE 0                                                                  "
                 + "\n" + "           END)                                                                        "
                 + "\n" + "     + SUM(CASE                                                                        "
                 + "\n" + "               WHEN     (t_isDemand = 1)                                               "
                 + "\n" + "                    AND (   t_maturityTerm <= " + term
                 + "\n" + "                         OR t_maturityTerm IS NULL)                                    "
                 + "\n" + "                   THEN t_accruedInteresAccountValue                                   "
                 + "\n" + "          ELSE 0                                                             "
                 + "\n" + "       END)                                                                  "
                 + "\n" + " + SUM(CASE                                                                  "
                 + "\n" + "               WHEN     (t_isDemand = 0)                                               "
                 + "\n" + "                    AND (   t_interestMaturityTerm <= " + term
                 + "\n" + "                         OR t_interestMaturityTerm IS NULL)                            "
                 + "\n" + "                   THEN t_interestAccountValue                                         "
                 + "\n" + "          ELSE 0                                                             "
                 + "\n" + "            END)                                                                       "
                 ;
        end;

        var commandText = "WITH deposit AS                                                              "
                 + "\n" + "     (SELECT dep.*,                                                          "
                 + "\n" + "             CASE                                                                      "
                 + "\n" + "                 WHEN dep.t_maturityDate != TO_DATE('01.01.0001', 'dd.mm.yyyy')        "
                 + "\n" + "                     THEN dep.t_maturityDate - rep_data.getEndDate()                   "
                 + "\n" + "                 ELSE 0                                                                "
                 + "\n" + "             END t_maturityTerm,                                                       "
                 + "\n" + "             CASE                                                                      "
                 + "\n" + "                 WHEN dep.t_interestMaturityDate != TO_DATE('01.01.0001', 'dd.mm.yyyy')"
                 + "\n" + "                     THEN dep.t_interestMaturityDate - rep_data.getEndDate()           "
                 + "\n" + "                 ELSE 0                                                                "
                 + "\n" + "             END t_interestMaturityTerm                                                "
                 + "\n" + "        FROM df125deposit_tmp dep)                                           "
                 + "\n" + "                                                                             "
                 + "\n" + "SELECT   deposit.t_number                                    t_number,       "
                 + "\n" + "       deposit.t_clientName,                                                           "
                 + "\n" + "       deposit.t_maturityDate,                                                         "
                 + "\n" + "       deposit.t_outRest,                                                              "
                 + "\n" + "       deposit.t_accruedInteresAccountValue,                                           "
                 + "\n" + "       deposit.t_interestMaturityDate,                                                 "
                 + "\n" + "       deposit.t_interestAccountValue,                                                 "
                 + "\n" +           depositAmount(  1) + "                               t_column2,     "
                 + "\n" +           depositAmount(  5) + "                               t_column3,     "
                 + "\n" +           depositAmount( 10) + "                               t_column4,     "
                 + "\n" +           depositAmount( 20) + "                               t_column5,     "
                 + "\n" +           depositAmount( 30) + "                               t_column6,     "
                 + "\n" +           depositAmount( 90) + "                               t_column7,     "
                 + "\n" +           depositAmount(180) + "                               t_column8,     "
                 + "\n" +           depositAmount(270) + "                               t_column9,     "
                 + "\n" +         depositAmount("ADD_MONTHS(rep_data.getEndDate(),12)                             "
                                                "-rep_data.getEndDate ()") + "         t_column10,                "
                 + "\n" + "       NVL(SUM(  t_outRest                                                             "
                 + "\n" + "               + CASE                                                                  "
                 + "\n" + "                     WHEN t_isDemand = 1                                               "
                 + "\n" + "                         THEN t_accruedInteresAccountValue                             "
                 + "\n" + "                     ELSE 0                                                            "
                 + "\n" + "                 END                                                                   "
                 + "\n" + "               + CASE                                                                  "
                 + "\n" + "                     WHEN t_isDemand = 0                                               "
                 + "\n" + "                         THEN t_interestAccountValue                                   "
                 + "\n" + "                     ELSE 0                                                            "
                 + "\n" + "                 END                                                                   "
                 + "\n" + "                  ),                                                         "
                 + "\n" + "              0)                                              t_column11     "
                 + "\n" + "    FROM deposit                                                             "
                 + "\n" + " GROUP BY ROLLUP ((deposit.t_number,                                                   "
                 + "\n" + "                   deposit.t_clientName,                                               "
                 + "\n" + "                   deposit.t_maturityDate,                                             "
                 + "\n" + "                   deposit.t_interestMaturityDate,                                     "
                 + "\n" + "                   deposit.t_outRest,                                                  "
                 + "\n" + "                   t_accruedInteresAccountValue,                                       "
                 + "\n" + "                   t_interestAccountValue                                              "
                 + "\n" + "                 ))                                                          "
                 + "\n" + " ORDER BY GROUPING (deposit.t_number) desc,                                            "
                 + "\n" + "         deposit.t_number                                                    ";

        var data = TRsbDataSet(commandText, RSDVAL_CLIENT, RSDVAL_STATIC);

        data.SetFieldType("maturityDate",         V_DATE);
        data.SetFieldType("interestMaturityDate", V_DATE);
        data.SetFieldType("column2",              V_MONEY);
        data.SetFieldType("column3",              V_MONEY);
        data.SetFieldType("column4",              V_MONEY);
        data.SetFieldType("column5",              V_MONEY);
        data.SetFieldType("column6",              V_MONEY);
        data.SetFieldType("column7",              V_MONEY);
        data.SetFieldType("column8",              V_MONEY);
        data.SetFieldType("column9",              V_MONEY);
        data.SetFieldType("column10",             V_MONEY);
        data.SetFieldType("column11",             V_MONEY);

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(data);

        data.moveFirst();

        return data;
    end;

    constructor();
end;

class (TUserDataSource) T125UserDataSource()

    private macro constructor()
        initTUserDataSource("user");
    end;

    /**
     * Создать фильтр.
     */
    private macro createDataSourceFilter() : bool
        /*на текущий момент фильтр не нужен*/
        return true;
    end;

    /**
     * Создать протокол.
     */
    private macro createDataSourceProtocol() : bool
        m_protocol = TUserDataSourceProtocol();
        return true;
    end;

    /**
     * Очистить кэш данных.
     */
    macro clear()
        return true;
    end;

    /**
     * Кешировать данные.
     */
    macro cacheData() : bool
        return true;
    end;

    macro getFilterForLine(line : String)
        return line;
    end;

    /**
     * Получить данные.
     *
     *  @param     filter   фильтр для отбора данных в условие where
     */
    macro getData(filter/*filter : RcbDataSourceFilter, attribute : RcbAttributeBase*/) : RcbCompositeValue
        var m_dataIter;
        var m_data = TArray();
        m_dataIter = RcbApplication.currentReport.attributeValue("ПользовательскийВвод").createValueIterator();
        m_dataIter.moveFirst();
        var query = "";
        var i = 1;

        while (not m_dataIter.isDone)
            if (m_dataIter.currentItem.fieldValue("line").currentAsString == filter)
                m_data[m_data.size] = m_dataIter.currentItem;

                if (i > 1)
                    query = query
                + "\n" + "UNION ALL";
                end;
                query = query
                + "\n" + "SELECT "
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column2").exact, 0) + " as column2,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column3").exact, 0) + " as column3,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column4").exact, 0) + " as column4,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column5").exact, 0) + " as column5,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column6").exact, 0) + " as column6,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column7").exact, 0) + " as column7,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column8").exact, 0) + " as column8,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column9").exact, 0) + " as column9,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column10").exact, 0) + " as column10,"
                + "\n" + NVL(m_dataIter.currentItem.fieldValue("column11").exact, 0) + " as column11"
                + "\n" + "   FROM dual";

                i = i + 1;
            end;
            m_dataIter.moveNext();
        end;

        var data;
        if (m_data.size > 0)
            query =  "SELECT sum(column2) as column2,"
            + "\n" + "       sum(column3) as column3,"
            + "\n" + "       sum(column4) as column4,"
            + "\n" + "       sum(column5) as column5,"
            + "\n" + "       sum(column6) as column6,"
            + "\n" + "       sum(column7) as column7,"
            + "\n" + "       sum(column8) as column8,"
            + "\n" + "       sum(column9) as column9,"
            + "\n" + "       sum(column10) as column10,"
            + "\n" + "       sum(column11) as column11"
            + "\n" + "    FROM "
            + "\n" + "         ( " + query + " )";

            data = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
            data.SetFieldType("column2",              V_MONEY);
            data.SetFieldType("column3",              V_MONEY);
            data.SetFieldType("column4",              V_MONEY);
            data.SetFieldType("column5",              V_MONEY);
            data.SetFieldType("column6",              V_MONEY);
            data.SetFieldType("column7",              V_MONEY);
            data.SetFieldType("column8",              V_MONEY);
            data.SetFieldType("column9",              V_MONEY);
            data.SetFieldType("column10",             V_MONEY);
            data.SetFieldType("column11",             V_MONEY);

            data.moveFirst();
        end;

        m_protocol.printLine(getBackOffice().getFullName());
        m_protocol.printProtocol(m_data, data);

        return data;
    end;

    constructor();
end;

/**
 * Источники данных для 125 формы.
 */
class (RcbDataSources) T125DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        sql_execute("TRUNCATE TABLE drcbBackOfficeAccount_tmp");

        m_dataSourcePool.push_back(T125CbAccountDataSource());
        m_dataSourcePool.push_back(T125LoansCreditDataSource());
        m_dataSourcePool.push_back(T125DepositsDataSource());
        m_dataSourcePool.push_back(T125RetailDepositDataSource());
        m_dataSourcePool.push_back(T125UserDataSource());
    end;
end;

class (RcbDataSources) T125DataSources2926_2(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        sql_execute("TRUNCATE TABLE drcbBackOfficeAccount_tmp");

        m_dataSourcePool.push_back(T125CbAccountDataSource2926_2());
        m_dataSourcePool.push_back(T125LoansCreditDataSource2926_2());
        m_dataSourcePool.push_back(T125DepositsDataSource());
        m_dataSourcePool.push_back(T125RetailDepositDataSource());
        m_dataSourcePool.push_back(T125UserDataSource());
    end;
end;

class (RcbDataSources) T125DataSources4099(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        sql_execute("TRUNCATE TABLE drcbBackOfficeAccount_tmp");

        m_dataSourcePool.push_back(T125CbAccountDataSource4099());
        m_dataSourcePool.push_back(T125LoansCreditDataSource4099());
        m_dataSourcePool.push_back(T125DepositsDataSource());
        m_dataSourcePool.push_back(T125RetailDepositDataSource());
        m_dataSourcePool.push_back(T125UserDataSource());
    end;
end;
