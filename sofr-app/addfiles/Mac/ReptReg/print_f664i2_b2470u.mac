/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank V6                                                                        R-Style Softlab
  ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì"

  ¥ç âì ¯à®â®ª®«  à áç¥â  ¨ ä®à¬ë 664.  §¤¥« 2

  ‘®§¤ ­: 09.08.2010 - Shestakov Dmitry
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import print_f664_b2470u; // print_f664_b2470u.mac

/**
 *  Š®­áâ ­âë
 */
private const DEBIT  = "0";
private const CREDIT = "1";

/**
 * Š« áá ¯à®â®ª®« .
 */
class (TProtocol) TProtocolIssue2()

    private var m_currencyOverall;
    private var m_operationOverall;

    private var m_currentDirection;
    private var m_currentCountry;
    private var m_currentCurrency;
    private var m_currentOperation;

    private var m_parameters;

    private var m_mainTableWidth;

    private macro constructorTProtocolIssue2()
        
        m_operationOverall = $0;
        m_currencyOverall  = $0;

        m_currentDirection = "";
        m_currentCountry   = "";
        m_currentCurrency  = "";
        m_currentOperation = "";

        m_parameters = TParameters("", "", 12);

        m_mainTableWidth     = 110;

        initTProtocol();

    end;

    private macro addIssueHeader()

        println();
        println();
        println("€‡„…‹ 2");
        println();

        println("ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
        println("³  Š®¤   ³  Š®¤   ³   Š®¤    ³     ‘ã¬¬  ¢ ¢ «îâ¥   ³   „ â    ³     ü     ³        ‘ç¥â ¯® ¤¥¡¥âã     ³      ‘ç¥â ¯® ªà¥¤¨âã      ³");
        println("³ áâà ­ë ³ ¢ «îâë ³ ®¯¥à æ¨¨ ³          áç¥â        ³   ¤®ª    ³ ¤®ªã¬¥­â  ³                           ³                           ³");
        println("ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");
         
    end;

    private macro addDirectionHeader(direction)

        if (direction == DEBIT)
            println(" ‘¯¨á ­¨¥");
        else
            println(" ‡ ç¨á«¥­¨¥");
        end;

        m_currentDirection = direction;

    end;

    private macro addDirectionFooter()

        println();

    end;

    private macro addCountryHeader(currencyCode)

        m_currentCountry = currencyCode;

    end;

    private macro addCountryFooter()
    end;

    private macro addCurrencyHeader(currencyCode)

        m_currentCurrency = currencyCode;

        m_currencyOverall = $0;

    end;

    private macro addCurrencyFooter()
    end;

    private macro addOperationHeader(operationCode)

        m_currentOperation = operationCode;

        m_operationOverall = $0;

    end;

    private macro addOperationFooter()

        [  ######   ######  ########## #####################  ](m_currentCountry:c, m_currentCurrency:c, "ˆ’ƒ":l, m_operationOverall:r);

    end;

    macro print()

        var isContinue;
        var isExistsTurns = false;
        var dataSource;

        var countryCode;
        var currencyCode;
        var operationCode;

        var query = "";

        query =          "SELECT turns.t_directionCode                  t_directionCode,"
                + "\n" + "       turns.t_countryCode                    t_countryCode,"
                + "\n" + "       t_iso_number                           t_currency,"
//                + "\n" + "       t_iso_number || ' ' || t_name          t_currency,"
                + "\n" + "       turns.t_operationCode                  t_operationCode,"
                + "\n" + "       turns.t_sum                            t_sum,"
                + "\n" + "       turns.t_dateCarry                      t_dateCarry,"
                + "\n" + "       turns.t_numberDocument                 t_numberDocument,"
                + "\n" + "       turns.t_accountPayer                   t_accountPayer,"
                + "\n" + "       turns.t_accountReceiver                t_accountReceiver"
                + "\n" + "  FROM " + TTurnsTempTable().getTableName() + " turns,"
                + "\n" + "       dfininstr_dbt fi"
                + "\n" + " WHERE fi.t_iso_number = turns.t_currencyCode"
                + "\n" + "   AND turns.t_reportIssue = " + m_parameters.getReportIssue()
                + "\n" + "ORDER BY t_directionCode,"
                + "\n" + "         t_countryCode,"
                + "\n" + "         t_currency,"
                + "\n" + "         t_operationCode,"
                + "\n" + "         t_dateCarry,"
                + "\n" + "         t_sum,"
                + "\n" + "         t_accountPayer,"
                + "\n" + "         t_accountReceiver";
        
        dataSource = TRsbDataSet(query);
        
        dataSource.setFieldType("t_sum",       V_MONEY);
        dataSource.setFieldType("t_dateCarry", V_DATE);

        switchOutput();

        addIssueHeader();

        isContinue = dataSource.next();

        if (not isContinue)

            println(strAlign("¥â ¤ ­­ëå", m_mainTableWidth, STR_ALIGN_CENTER));
            println();

        end;

        while (isContinue)

            isExistsTurns = true;

            if (dataSource.directionCode != m_currentDirection)

                if (m_currentDirection != "")
                    addOperationFooter();
                    addCurrencyFooter();
                    addCountryFooter();
                    addDirectionFooter();
                end;

                addDirectionHeader(dataSource.directionCode);
                addCountryHeader(dataSource.countryCode);
                addCurrencyHeader(dataSource.currency);
                addOperationHeader(dataSource.operationCode);

            end;

            if (dataSource.countryCode != m_currentCountry)

                if (m_currentCountry != "")
                    addOperationFooter();
                    addCurrencyFooter();
                    addCountryFooter();
                end;

                addCountryHeader(dataSource.countryCode);
                addCurrencyHeader(dataSource.currency);
                addOperationHeader(dataSource.operationCode);

            end;

            if (dataSource.currency != m_currentCurrency)

                if (m_currentCurrency != "")
                    addOperationFooter();
                    addCurrencyFooter();
                end;

                addCurrencyHeader(dataSource.currency);
                addOperationHeader(dataSource.operationCode);

            end;

            if (dataSource.operationCode != m_currentOperation)

                if (m_currentOperation != "")
                    addOperationFooter();
                end;

                addOperationHeader(dataSource.operationCode);

            end;

//           ³  Š®¤   ³  Š®¤   ³   Š®¤    ³     ‘ã¬¬  ¢ ¢ «îâ¥   ³   „ â    ³ ü ¤®ª     ³        ‘ç¥â ¯® ¤¥¡¥âã     ³      ‘ç¥â ¯® ªà¥¤¨âã      ³
            [  ######   ######  ########## #####################  ##########  #########   #########################   ######################### ]
            (dataSource.countryCode:c,
                        dataSource.currency:c,
                                dataSource.operationCode:r, 
                                           dataSource.sum,        dataSource.dateCarry:f,   
                                                                              dataSource.numberDocument:l, 
                                                                                      dataSource.accountPayer,    dataSource.accountReceiver);

            m_operationOverall = m_operationOverall + dataSource.sum;
            m_currencyOverall  = m_currencyOverall  + dataSource.sum;        

            isContinue = dataSource.next();

        end;

        if (isExistsTurns)

            addOperationFooter();
            addCurrencyFooter();
            addCountryFooter();
            addDirectionFooter();

        end;

        switchOutput();
    
    end;

    constructorTProtocolIssue2();
end;

class (TOperByCountryPrintableForm664) TIssue2PrintableForm664_I2470(rootAttributeName : String)

    private macro addHeader()
        switchOutput();

        println();
        println();
        println(strAlign(" §¤¥« 2. ‘âàãªâãà  ®¯¥à æ¨©, ®áãé¥áâ¢«ï¥¬ëå ¯® à áç¥â­ë¬ áç¥â ¬", getTableWidth(), STR_ALIGN_CENTER));
        println(strAlign("à¥§¨¤¥­â®¢, ¯® áâà ­ ¬ ¡ ­ª  ¯®«ãç â¥«ï(¯« â¥«ìé¨ª )", getTableWidth(), STR_ALIGN_CENTER));
        println();

        switchOutput();
    end;

    macro constructorTIssue2PrintableForm664_I2470(rootAttributeName)
        initTOperByCountryPrintableForm664(rootAttributeName, true);
    end;

    constructorTIssue2PrintableForm664_I2470(rootAttributeName);
end;
