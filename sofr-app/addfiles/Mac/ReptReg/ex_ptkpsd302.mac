/*
$Name:          ex_ptkpsd302.mac
$Module:        Регламентируемая отчетность
$Description:   Форма 302. Контроллер экспорта
*/

/**
 * Форма 302. Экспорт данных отчета в АС ПСД
 *
 * @since   11.09.2012
 * @author  Gromov
 * @version 6.00.020.31
 */

import rcbImport;
import cb_sql;
import rcbCoreInter;
import RcbProtocolView;
import RcbPtkPsdView;

class (TPtkPsdView) T302PtkPsdView()
    initTPtkPsdView("302", RcbApplication.currentReport.context.period.endDate + 1, "rsansi"); //ДООП+1
    EOL = "";
end;

/**
 * Операция экспорта в АС ПСД для раздела.
 */
class TPtkPsdExportPartController(view, part, head)
    private var m_view            = view;     //представление печати
    private var m_part            = part;     //раздел
    private var m_applicationCode = head;     //заголовок раздела
    private var m_rowsArray       = TArray(); //массив номеров строк
    private var m_rowsPtkPsdArray = TArray(); //массив номеров строк АС ПСД
    private var m_columnsArray    = TArray(); //массив столбцов

    macro initColumnsAndRowsArray()
        m_rowsArray[m_rowsArray.size] = "1";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1";
        m_rowsArray[m_rowsArray.size] = "1.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.1";
        m_rowsArray[m_rowsArray.size] = "1.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.2";
        m_rowsArray[m_rowsArray.size] = "1.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.3";
        m_rowsArray[m_rowsArray.size] = "1.4";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.4";
        m_rowsArray[m_rowsArray.size] = "1.5";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.5";
        m_rowsArray[m_rowsArray.size] = "1.6";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.6";
        m_rowsArray[m_rowsArray.size] = "1.7";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.7";
        m_rowsArray[m_rowsArray.size] = "1.8";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.8";
        m_rowsArray[m_rowsArray.size] = "1.9";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.9";
        m_rowsArray[m_rowsArray.size] = "2";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4";
        m_rowsArray[m_rowsArray.size] = "2.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.0";
        m_rowsArray[m_rowsArray.size] = "2.1.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.1";
        m_rowsArray[m_rowsArray.size] = "2.1.1.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.11";
        m_rowsArray[m_rowsArray.size] = "2.1.2";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.2";
        m_rowsArray[m_rowsArray.size] = "2.1.2.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.21";
        m_rowsArray[m_rowsArray.size] = "2.1.2.2";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.22";
        m_rowsArray[m_rowsArray.size] = "2.1.2.3";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.23";
        m_rowsArray[m_rowsArray.size] = "2.1.2.4";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.24";
        m_rowsArray[m_rowsArray.size] = "2.1.2.5";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.25";
        m_rowsArray[m_rowsArray.size] = "2.1.2.6";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.26";
        m_rowsArray[m_rowsArray.size] = "2.1.2.7";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.27";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.28";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.281";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.29";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.291";
        m_rowsArray[m_rowsArray.size] = "2.1.3";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.3";
        m_rowsArray[m_rowsArray.size] = "2.1.4";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.4";
        m_rowsArray[m_rowsArray.size] = "2.1.4.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.41";
        m_rowsArray[m_rowsArray.size] = "2.1.5";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.5";
        m_rowsArray[m_rowsArray.size] = "2.1.5.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.51";
        m_rowsArray[m_rowsArray.size] = "2.1.6";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.6";
        m_rowsArray[m_rowsArray.size] = "2.1.6.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.61";
        m_rowsArray[m_rowsArray.size] = "2.1.7";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.7";
        m_rowsArray[m_rowsArray.size] = "2.1.8";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.8";
        m_rowsArray[m_rowsArray.size] = "2.1.9";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.9";
        m_rowsArray[m_rowsArray.size] = "2.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.10";
        m_rowsArray[m_rowsArray.size] = "2.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5.0";
        m_rowsArray[m_rowsArray.size] = "2.3.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5";
        m_rowsArray[m_rowsArray.size] = "3";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "6";

        m_columnsArray[1] = "row";
        m_columnsArray[2] = "okatoCode";
        m_columnsArray[3] = "roubleSum";
        m_columnsArray[4] = "currencySum";
        m_columnsArray[5] = "roubleDebt";
        m_columnsArray[6] = "currencyDebt";
        m_columnsArray[7] = "roubleDelayedDebt";
        m_columnsArray[8] = "currencyDelayedDebt";
    end;

    private macro getPtkPsdRowNumber(rowNumber : String)
        var i = 0;
        while (i < m_rowsArray.size)
            if (m_rowsArray[i] == rowNumber)
                return m_rowsPtkPsdArray[i];
            end;

            i = i + 1;
        end;

        return "";
    end;

    private macro printExportRow(itemValue, firstColumn, lastColumn)
        var i = firstColumn;
        while (i <= lastColumn)
            if (itemValue.fieldValue(m_columnsArray[i]).scaled != 0)
                m_view.printRow(m_applicationCode,                                                                                                         //код приложения
                                getPtkPsdRowNumber(itemValue.fieldValue(m_columnsArray[1]).currentAsString),                                               //код строки
                                i,                                                                                                                         //код колонки
                                itemValue.fieldValue(m_columnsArray[i]).currentAsString,                                                                   //значение
                                ternary(itemValue.fieldValue(m_columnsArray[2]).scaled == "", "$empty$", itemValue.fieldValue(m_columnsArray[2]).scaled)); //код региона
            end;

            i = i + 1;
        end;
    end;

    private macro printPartExportString(formVariable, firstColumn, lastColumn, useNested : Bool)
        var nestedValueIterator;
        var i;

        if (formVariable != NULL)
            var valueIterator = formVariable.createValueIterator();
            valueIterator.moveFirst();
            while (not valueIterator.isDone())
                if (useNested)
                    nestedValueIterator = valueIterator.currentItem().createValueIterator();
                    nestedValueIterator.moveFirst();
                    while (not nestedValueIterator.isDone())
                        printExportRow(nestedValueIterator.currentItem(), firstColumn, lastColumn);
                        nestedValueIterator.moveNext();
                    end;
                else
                    printExportRow(valueIterator.currentItem(), firstColumn, lastColumn);
                end;

                valueIterator.moveNext();
            end;
        end;
    end;

    macro execute()
        initColumnsAndRowsArray();

        if   (m_part == "1.1")
            printPartExportString(RcbApplication.CurrentReport.attributeValue("Раздел1"), 3, 8, false);
        elif (m_part == "1")
            var item = RcbApplication.CurrentReport.attributeValue("Раздел1");
            var iterator = item.createValueIterator();
            iterator.moveFirst();
            printPartExportString(iterator.currentItem(), 3, 8, true);
        elif (m_part == "2")
            m_columnsArray[4] = "rubObtainedFundsRest";
            m_columnsArray[5] = "curObtainedFundsRest";

            printPartExportString(RcbApplication.CurrentReport.attributeValue("Раздел2"), 4, 5, true);
        end;
    end;
end;

class (TPtkPsdExportPartController) TPtkPsdExportPartController2926(view, part, head)
    macro initColumnsAndRowsArray()
        m_rowsArray[m_rowsArray.size] = "1";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1";
        m_rowsArray[m_rowsArray.size] = "1.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.1";
        m_rowsArray[m_rowsArray.size] = "1.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.2";
        m_rowsArray[m_rowsArray.size] = "1.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.3";
        m_rowsArray[m_rowsArray.size] = "1.4";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.4";
        m_rowsArray[m_rowsArray.size] = "1.5";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.5";
        m_rowsArray[m_rowsArray.size] = "1.6";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.6";
        m_rowsArray[m_rowsArray.size] = "1.7";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.7";
        m_rowsArray[m_rowsArray.size] = "1.8";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.8";
        m_rowsArray[m_rowsArray.size] = "1.9";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.9";
        m_rowsArray[m_rowsArray.size] = "2";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4";
        m_rowsArray[m_rowsArray.size] = "2.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.0";
        m_rowsArray[m_rowsArray.size] = "2.1.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.1";
        m_rowsArray[m_rowsArray.size] = "2.1.1.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.11";
        m_rowsArray[m_rowsArray.size] = "2.1.2";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.2";
        m_rowsArray[m_rowsArray.size] = "2.1.2.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.21";
        m_rowsArray[m_rowsArray.size] = "2.1.2.2";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.22";
        m_rowsArray[m_rowsArray.size] = "2.1.2.3";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.23";
        m_rowsArray[m_rowsArray.size] = "2.1.2.4";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.24";
        m_rowsArray[m_rowsArray.size] = "2.1.2.5";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.25";
        m_rowsArray[m_rowsArray.size] = "2.1.2.6";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.26";
        m_rowsArray[m_rowsArray.size] = "2.1.2.7";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.27";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.28";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.281";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.29";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.291";
        m_rowsArray[m_rowsArray.size] = "2.1.3";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.3";
        m_rowsArray[m_rowsArray.size] = "2.1.4";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.4";
        m_rowsArray[m_rowsArray.size] = "2.1.4.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.41";
        m_rowsArray[m_rowsArray.size] = "2.1.5";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.5";
        m_rowsArray[m_rowsArray.size] = "2.1.5.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.51";
        m_rowsArray[m_rowsArray.size] = "2.1.6";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.6";
        m_rowsArray[m_rowsArray.size] = "2.1.6.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.61";
        m_rowsArray[m_rowsArray.size] = "2.1.7";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.7";
        m_rowsArray[m_rowsArray.size] = "2.1.8";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.8";
        m_rowsArray[m_rowsArray.size] = "2.1.9";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.9";
        m_rowsArray[m_rowsArray.size] = "2.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.10";
        m_rowsArray[m_rowsArray.size] = "2.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5.0";
        m_rowsArray[m_rowsArray.size] = "2.3.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5";
        m_rowsArray[m_rowsArray.size] = "3";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "6";

        m_columnsArray[1] = "row";
        m_columnsArray[2] = "okatoCode";
        m_columnsArray[3] = "roubleSum";
        m_columnsArray[4] = "currencySum";
        m_columnsArray[5] = "roubleDebt";
        m_columnsArray[6] = "currencyDebt";
        m_columnsArray[7] = "roubleDelayedDebt";
        m_columnsArray[8] = "currencyDelayedDebt";
    end;

    initTPtkPsdExportPartController(view, part, head);
end;

class (TPtkPsdExportPartController2926) TPtkPsdExportPartController4637(view, part, head)
    macro initColumnsAndRowsArray()
        m_rowsArray[m_rowsArray.size] = "1";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1";
        m_rowsArray[m_rowsArray.size] = "1.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.1";
        m_rowsArray[m_rowsArray.size] = "1.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.2";
        m_rowsArray[m_rowsArray.size] = "1.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.3";
        m_rowsArray[m_rowsArray.size] = "1.4";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.4";
        m_rowsArray[m_rowsArray.size] = "1.5";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.5";
        m_rowsArray[m_rowsArray.size] = "1.6";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.6";
        m_rowsArray[m_rowsArray.size] = "1.7";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.7";
        m_rowsArray[m_rowsArray.size] = "1.8";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.8";
        m_rowsArray[m_rowsArray.size] = "1.9";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "1.9";
        m_rowsArray[m_rowsArray.size] = "2";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4";
        m_rowsArray[m_rowsArray.size] = "2.1";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.0";
        m_rowsArray[m_rowsArray.size] = "2.1.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.1";
        m_rowsArray[m_rowsArray.size] = "2.1.1.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.11";
        m_rowsArray[m_rowsArray.size] = "2.1.2";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.2";
        m_rowsArray[m_rowsArray.size] = "2.1.2.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.21";
        m_rowsArray[m_rowsArray.size] = "2.1.2.2";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.22";
        m_rowsArray[m_rowsArray.size] = "2.1.2.3";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.23";
        m_rowsArray[m_rowsArray.size] = "2.1.2.4";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.24";
        m_rowsArray[m_rowsArray.size] = "2.1.2.5";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.25";
        m_rowsArray[m_rowsArray.size] = "2.1.2.6";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.26";
        m_rowsArray[m_rowsArray.size] = "2.1.2.7";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.27";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.28";
        m_rowsArray[m_rowsArray.size] = "2.1.2.8.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.281";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.29";
        m_rowsArray[m_rowsArray.size] = "2.1.2.9.1"; m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.291";
        m_rowsArray[m_rowsArray.size] = "2.1.3";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.3";
        m_rowsArray[m_rowsArray.size] = "2.1.4";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.4";
        m_rowsArray[m_rowsArray.size] = "2.1.4.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.41";
        m_rowsArray[m_rowsArray.size] = "2.1.5";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.5";
        m_rowsArray[m_rowsArray.size] = "2.1.5.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.51";
        m_rowsArray[m_rowsArray.size] = "2.1.6";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.6";
        m_rowsArray[m_rowsArray.size] = "2.1.6.1";   m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.61";
        m_rowsArray[m_rowsArray.size] = "2.1.7";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.7";
        m_rowsArray[m_rowsArray.size] = "2.1.8";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.8";
        m_rowsArray[m_rowsArray.size] = "2.1.9";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.9";
        m_rowsArray[m_rowsArray.size] = "2.2";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "4.10";
        m_rowsArray[m_rowsArray.size] = "2.3";       m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5.0";
        m_rowsArray[m_rowsArray.size] = "2.3.1";     m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "5";
        m_rowsArray[m_rowsArray.size] = "3";         m_rowsPtkPsdArray[m_rowsPtkPsdArray.size] = "6";

        m_columnsArray[1]  = "row";
        m_columnsArray[2]  = "okatoCode";
        m_columnsArray[3]  = "roubleSum";
        m_columnsArray[4]  = "totalSum";
        m_columnsArray[5]  = "sum_643";
        m_columnsArray[6]  = "sum_840";
        m_columnsArray[7]  = "sum_978";
        m_columnsArray[8]  = "sum_156";
        m_columnsArray[9]  = "currencyDebt";
        m_columnsArray[10] = "roubleDelayedDebt";
        m_columnsArray[11] = "currencyDelayedDebt";
    end;

    macro execute()
        initColumnsAndRowsArray();

        if   (m_part == "1.1")
            printPartExportString(RcbApplication.CurrentReport.attributeValue("Раздел1"), 3, 8, false);
        elif (m_part == "1")
            var item     = RcbApplication.CurrentReport.attributeValue("Раздел1");
            var iterator = item.createValueIterator();
            iterator.moveFirst();
            printPartExportString(iterator.currentItem(), 3, 8, true);
        elif (m_part == "2")
            m_columnsArray[4] = "obtainedFundsRestTotal";
            m_columnsArray[5] = "obtainedFundsRest_643";
            m_columnsArray[6] = "obtainedFundsRest_840";
            m_columnsArray[7] = "obtainedFundsRest_978";
            m_columnsArray[8] = "obtainedFundsRest_156";

            printPartExportString(RcbApplication.CurrentReport.attributeValue("Раздел2"), 4, 8, true);
        end;
    end;

    initTPtkPsdExportPartController2926(view, part, head);
end;

/**
 * Операция экспорта в АС ПСД отчета.
 */
class  T302PtkPsdExportController()
    private var m_ptkPsdExportPartControllers : TArray;
    private var m_ptkPsdView;
    private var m_report;

    macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = genObject("T302PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "1.1", "F302_I");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "1",   "F302");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController(m_ptkPsdView,  "2",   "F302_2");
    end;

    private macro getDescriptorInfo()
        return "";
    end;

    macro execute()
        var m_protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        if (not rcbApplication().currentReport.isCalculated)
            m_protocolView.checkCalculateReport("АС ПСД");
            установитьФлагВозврата(STOP_PROC_FLG);
            exit(1);
        end;

        var i = 0;
        var protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

        protocolView.setProtocolOutput();
        protocolView.printHead();

        m_ptkPsdView.setOutputFile();
        while ( i < m_ptkPsdExportPartControllers.size)
            m_ptkPsdExportPartControllers[i].execute();
            i = i + 1;
        end;
        m_ptkPsdView.resetOutputFile();

        protocolView.printLine("Альбом форм АС ПСД: " + getDescriptorInfo());
        protocolView.printLine("Файл экспорта: " + m_ptkPsdView.getFileName());
        protocolView.printLine("Количество выгруженных записей: " + m_ptkPsdView.getRowsCount()());

        protocolView.resetProtocolOutput();
        protocolView.show();
    end;

    constructor();
end;

class (T302PtkPsdExportController) T302PtkPsdExportController2926()
    private macro getDescriptorInfo()
        return "alb2_2_4.doc от 01.10.2014";
    end;

    macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = genObject("T302PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2926(m_ptkPsdView,  "1.1", "F302_I");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2926(m_ptkPsdView,  "1",   "F302");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2926(m_ptkPsdView,  "2",   "F302_2");
    end;

    initT302PtkPsdExportController();
end;

class (T302PtkPsdExportController2926) T302PtkPsdExportController4637()
    private macro getDescriptorInfo()
        return "Изменения внесены по \"интуиции\" в рамках доработки по Указанию № 4637-У";
    end;

    macro constructor()
        m_ptkPsdExportPartControllers = TArray();
        m_ptkPsdView                  = genObject("T302PtkPsdView");

        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2926(m_ptkPsdView,  "1.1", "F302_I");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController2926(m_ptkPsdView,  "1",   "F302");
        m_ptkPsdExportPartControllers[m_ptkPsdExportPartControllers.size] = TPtkPsdExportPartController4637(m_ptkPsdView, "2",   "F302_2");

    end;

    initT302PtkPsdExportController();
end;

private macro executePtkPsdExportOperation()
    if   (RcbApplication.currentReport.context.period.endDate < RCB_I2926_DATE)
        T302PtkPsdExportController().execute();
    elif (RcbApplication.currentReport.context.period.endDate < RCB_I4637_DATE_F302)
        T302PtkPsdExportController2926().execute();
    else
        T302PtkPsdExportController4637().execute();
    end;
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
