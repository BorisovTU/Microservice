/*
$Name:          f401ReportCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 401. Класс контроллера расчета отчета.
*/

class (RcbReportCalculateController) TF401ReportCalculateController()
    private macro clearValues()
        getReport().getPart(TF401Global().getPart1Id()).getPartCompositeValue().removeAllValues();
        getReport().getPart(TF401Global().getPart2Id()).getPartCompositeValue().removeAllValues();
        getReport().getPart(TF401Global().getPart31Id()).getPartCompositeValue().removeAllValues();
        getReport().getPart(TF401Global().getPart32Id()).getPartCompositeValue().removeAllValues();
        RcbApplication().transactionManager.commit();
        getReport().getPart(TF401Global().getPart1Id()).clear();
        getReport().getPart(TF401Global().getPart2Id()).clear();
        getReport().getPart(TF401Global().getPart31Id()).clear();
        getReport().getPart(TF401Global().getPart32Id()).clear();
    end;

    private macro pushControllers()
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF401Global().getPart1Id()), this));
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF401Global().getPart2Id()), this));
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF401Global().getPart31Id()), this));
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF401Global().getPart32Id()), this));
    end;

    private macro printAdditionalProtocolData()
        TF401Settings().printCalculationReport(getProtocolView());
    end;

    macro initialize() : Bool
        clearValues();
        pushControllers();
        getDatasources().getDatasource("deals").cacheData();

        return m_partCalculateControllers.size > 0;
    end;

    private macro postprocess()
        for (var partController, m_partCalculateControllers)
            partController.deleteZeroDealAttributes();
        end;

        objectFactoryInstance.createExportBiskvitExactController(m_partCalculateControllers).execute(false);
    end;

    macro calculate()
        var result = calculate();
        for (var i, m_partCalculateControllers)
            i.getDataProtocolView().save();
        end;
        return result;
    end;

    private macro constructorTF401ReportCalculateController()
        initRcbReportCalculateController();
    end;

    constructorTF401ReportCalculateController();
end;
