/*
$Name:          f401DataSources.mac
$Module:        Отчеты ЦБ
$Description:   Форма 401. Источники данных.
*/

private const RATETYPE_CB = 7;
private const DEAL_KIND_ATTRACTION = "ПРИВЛЕЧЕНИЕ";
private const DEAL_KIND_PLACEMENT  = "РАЗМЕЩЕНИЕ ";

private class TBiskvitElement(_sym1, _sym2, _sym3, _sym4, _val1, _val2, _val3, _val4, _val5, _val6, _val7, _val8, _val9, _val10, _val11, _val12, _txt1, _txt2, _txt3, _txt4, _txt5)
    private macro rnd(v)
        v = v * 1000;
        if (v < 0)
            v = -round(-v + 0.5, 0, 2);
        else
            v = round(v + 0.5, 0, 2);
        end;
        v = v / 1000;

        return Money(v);
    end;

    var sym1  = _sym1;
    var sym2  = _sym2;
    var sym3  = _sym3;
    var sym4  = _sym4;
    var val1  = rnd(nvl(_val1, $0.0));
    var val2  = rnd(nvl(_val2, $0.0));
    var val3  = rnd(nvl(_val3, $0.0));
    var val4  = rnd(nvl(_val4, $0.0));
    var val5  = rnd(nvl(_val5, $0.0));
    var val6  = rnd(nvl(_val6, $0.0));
    var val7  = rnd(nvl(_val7, $0.0));
    var val8  = rnd(nvl(_val8, $0.0));
    var val9  = rnd(nvl(_val9, $0.0));
    var val10 = rnd(nvl(_val10, $0.0));
    var val11 = rnd(nvl(_val11, $0.0));
    var val12 = rnd(nvl(_val12, $0.0));
    var txt1  = _txt1;
    var txt2  = _txt2;
    var txt3  = _txt3;
    var txt4  = _txt4;
    var txt5  = _txt5;
end;

/**
 * Специальный ИД для хранения данных выгрузки БИСквит в единицах валюты
 */
private class (RcbDataSource) TBiskvitExactData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private const JVM = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");

    private var m_container : Object;

    macro add(sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12, txt1, txt2, txt3, txt4, txt5)
        if ((substr(txt1, 3, 1) == "Ф") and (txt2 == null))
            var nrCode = strcut(sym3, ";", true);
            if (nrCode[2] != "NN;")
                sym3 = nrCode[0]+nrCode[1]+nrCode[2]+nrCode[3]+"NRP";
            end;
        end;
        var element = TBiskvitElement(sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12, txt1, txt2, txt3, txt4, txt5);
        var id = element.sym1+element.sym2+element.sym3+element.sym4;
        var saved = m_container.get(id);
        if (saved != null)
            saved.val1  = saved.val1 + element.val1;
            saved.val2  = saved.val2 + element.val2;
            saved.val3  = saved.val3 + element.val3;
            saved.val4  = saved.val4 + element.val4;
            saved.val5  = saved.val5 + element.val5;
            saved.val6  = saved.val6 + element.val6;
            saved.val7  = saved.val7 + element.val7;
            saved.val8  = saved.val8 + element.val8;
            saved.val9  = saved.val9 + element.val9;
            saved.val10 = saved.val10 + element.val10;
            saved.val11 = saved.val11 + element.val11;
            saved.val12 = saved.val12 + element.val12;
        else
            m_container.put(id, element);
        end;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        return m_container.values();
    end;

    private macro ctorTBiskvitExactData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_container = JVM.createJavaObject("java.util.HashMap", "<init>");
    end;

    ctorTBiskvitExactData(id, protocolView, dataSources);
end;

/**
 * Специальный ИД для хранения данных выгрузки БИСквит в тысячах единиц валюты
 */
private class TNonTotalsFilter()
    macro isSuitable(val)
        return (    (val.fieldValue("rowCode").exact != "А30")
                and (val.fieldValue("rowCode").exact != "А50")
                and (val.fieldValue("rowCode").exact != "П30")
                and (val.fieldValue("rowCode").exact != "П50")
               );
    end;
end;

private class (RcbDataSource) TBiskvitScaledDataParts12Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private const JVM = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");

    private var m_container : Object;
    private var m_attributeName : String;
    private var m_countryGroupMembership : Object;

    // Нужно для сортировки по номеру строки. Пока не используется.
    private macro normalizeRowCode(rowCode)
        var c1 = substr(rowCode, 1, 1);
        var c2 = substr(rowCode, 2);
        var c2Length = strlen(c2);
        if (c2Length == 1)
            c2 = "0" + c2;
            c2Length = 2;
        end;
        if (c2Length == 2)
            c2 = c2 + ".0";
        end;

        return (c1 + c2);
    end;

    macro add(nrCode, sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12, txt1)
//        var id = normalizeRowCode(sym1) + nrCode;
        var id = sym1 + nrCode;
        var element = TBiskvitElement(sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12, txt1);
        var saved = m_container.get(id);
        if (saved != null)
            saved.val1  = saved.val1 + element.val1;
            saved.val2  = saved.val2 + element.val2;
            saved.val3  = saved.val3 + element.val3;
            saved.val4  = saved.val4 + element.val4;
            saved.val5  = saved.val5 + element.val5;
            saved.val6  = saved.val6 + element.val6;
            saved.val7  = saved.val7 + element.val7;
            saved.val8  = saved.val8 + element.val8;
            saved.val9  = saved.val9 + element.val9;
            saved.val10 = saved.val10 + element.val10;
            saved.val11 = saved.val11 + element.val11;
            saved.val12 = saved.val12 + element.val12;
        else
            nrCode = strcut(nrCode, "/");
            element.sym3 = nrCode[2] + ";" + ";" + nrCode[0] + ";" + nrCode[1] + ";" + nrCode[3];
            //сформировать txt1 - группа стран, характер отношений - по данным nrCode
            var countryGroup = m_countryGroupMembership.get(nrCode[2]);
            if (countryGroup == null)
                if (nrCode[2] == "643")
                    countryGroup = "Р";
                elif (nrCode[2] != strFor(1))
                    var ds = TRsbDataset("SELECT atc.t_value AS t_countryGroup"
                                + "\n" + "  FROM drepcategory_vw atc"
                                + "\n" + " WHERE atc.t_id = " + RCB_OBJGROUP_COUNTRY_GROUP_MEMBERSHIP
                                + "\n" + "   AND atc.t_objectType = " + RCB_OBJTYPE_COUNTRY
                                + "\n" + "   AND atc.t_objectId = (SELECT country.t_codeLat3"
                                + "\n" + "                           FROM dcountry_dbt country"
                                + "\n" + "                          WHERE country.t_codeNum3 = " + getSqlString(nrCode[2])
                                + "\n" + "                        )"
                                + "\n" + "   AND atc.t_isInstalledForEndDate = 1"
                                        );
                    if (ds.moveNext())
                        countryGroup = nvl(ds.countryGroup, "Д");
                    else
                        countryGroup = "Д";
                    end;
                else
                    countryGroup = "Д";
                end;
                m_countryGroupMembership.put(nrCode[2], countryGroup);
            end;

            var relationship;
            if ((nrCode[0] == "N1") or (nrCode[0] == "N2"))
                relationship = "О";
            elif (nrCode[4] == "SPV")
                relationship = "П";
            else
                relationship = strFor(1);
            end;
            element.txt1 = countryGroup + ";" + "Н" + ";" + "Н" + ";" + strFor(1) + ";" + relationship;

            m_container.put(id, element);
        end;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        var it = TF401Global().getRcbReport().attributeValue(m_attributeName).createValueIterator();
        it.setFilter(TNonTotalsFilter());
        it.moveFirst();
        while (not it.isDone())
            var value = it.currentItem;
            add(value.fieldValue("nrCode").exact,
                value.fieldValue("rowCode").exact,
                "",
                "",
                "",
                value.fieldValue("incomeRest").scaled,
                value.fieldValue("turns").scaled,
                $0,//value.fieldValue("revaluationTurns").scaled, //расчёт выполняется при выгрузке
                value.fieldValue("otherTurns").scaled,
                value.fieldValue("outgoingRest").scaled,
                value.fieldValue("interests").scaled,
                $0,
                $0,
                $0,
                $0,
                $0,
                $0,
                ""
               );
            it.moveNext();
        end;

        return m_container.values();
    end;

    private macro ctorTBiskvitScaledDataParts12Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        // Для сортировки по номеру строки заменить на java.util.TreeMap и включить нормализацию номера строки
        m_container = JVM.createJavaObject("java.util.HashMap", "<init>");

        m_countryGroupMembership = JVM.createJavaObject("java.util.HashMap", "<init>");
    end;

    ctorTBiskvitScaledDataParts12Base(id, protocolView, dataSources);
end;

private class (TBiskvitScaledDataParts12Base) TBiskvitScaledDataPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro ctorTBiskvitScaledDataPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTBiskvitScaledDataParts12Base(id, protocolView, dataSources);
        m_attributeName = "Раздел_1_по_4212У";
    end;

    ctorTBiskvitScaledDataPart1(id, protocolView, dataSources);
end;

private class (TBiskvitScaledDataParts12Base) TBiskvitScaledDataPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro ctorTBiskvitScaledDataPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTBiskvitScaledDataParts12Base(id, protocolView, dataSources);
        m_attributeName = "Раздел_2_по_4212У";
    end;

    ctorTBiskvitScaledDataPart2(id, protocolView, dataSources);
end;

private class (RcbDataSource) TBiskvitScaledDataPart3Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private const JVM = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");

    private var m_container : Object;
    private var m_attributeName : String;

// 28.06.2019 ABP Переделать под формат номеров строк в разделе 3
//    // Нужно для сортировки по номеру строки. Пока не используется.
//    private macro normalizeRowCode(rowCode)
//        var c1 = substr(rowCode, 1, 1);
//        var c2 = substr(rowCode, 2);
//        var c2Length = strlen(c2);
//        if (c2Length == 1)
//            c2 = "0" + c2;
//            c2Length = 2;
//        end;
//        if (c2Length == 2)
//            c2 = c2 + ".0";
//        end;
//
//        return (c1 + c2);
//    end;

    private macro add(sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12)
//        var id = normalizeRowCode(sym1) + nrCode;
        var id = sym1+sym2+sym3+sym4;
        var element = TBiskvitElement(sym1, sym2, sym3, sym4, val1, val2, val3, val4, val5, val6, val7, val8, val9, val10, val11, val12);
        var saved = m_container.get(id);
        if (saved != null)
            saved.val1  = saved.val1 + element.val1;
            saved.val2  = saved.val2 + element.val2;
            saved.val3  = saved.val3 + element.val3;
            saved.val4  = saved.val4 + element.val4;
            saved.val5  = saved.val5 + element.val5;
            saved.val6  = saved.val6 + element.val6;
            saved.val7  = saved.val7 + element.val7;
            saved.val8  = saved.val8 + element.val8;
            saved.val9  = saved.val9 + element.val9;
            saved.val10 = saved.val10 + element.val10;
            saved.val11 = saved.val11 + element.val11;
            saved.val12 = saved.val12 + element.val12;
        else
            m_container.put(id, element);
        end;
    end;

    private macro ctorTBiskvitScaledDataPart3Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        // Для сортировки по номеру строки заменить на java.util.TreeMap и включить нормализацию номера строки
        m_container = JVM.createJavaObject("java.util.HashMap", "<init>");
    end;

    ctorTBiskvitScaledDataPart3Base(id, protocolView, dataSources);
end;

private class (TBiskvitScaledDataPart3Base) TBiskvitScaledDataPart31(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        var it = TF401Global().getRcbReport().attributeValue(m_attributeName).createValueIterator();
        it.setFilter(TNonTotalsFilter());
        it.moveFirst();
        while (not it.isDone())
            var value = it.currentItem;

            // Требования, они же - купленные опционы
            add("3А.1",
                value.fieldValue("currencyCode").exact,
                ternary(value.fieldValue("nrCode").exact == "Кредитные организации", "КО", "Прочие"),
                "1",
                value.fieldValue("rtGroup2IncomeRest").scaled,
                value.fieldValue("rtGroup2Turns").scaled,
                value.fieldValue("rtGroup2RevaluationTurns").scaled,
                value.fieldValue("rtGroup2OtherTurns").scaled,
                value.fieldValue("rtGroup2OutgoingRest").scaled,
                value.fieldValue("stockOptionReceived").scaled,
                value.fieldValue("stockOptionPaid").scaled,
                $0,
                $0,
                $0,
                $0,
                $0
               );

            // Обязательства, они же - выписанные опционы
            add("3П.1",
                value.fieldValue("currencyCode").exact,
                ternary(value.fieldValue("nrCode").exact == "Кредитные организации", "КО", "Прочие"),
                "1",
                value.fieldValue("incomeRest").scaled,
                value.fieldValue("turns").scaled,
                value.fieldValue("revaluationTurns").scaled,
                value.fieldValue("otherTurns").scaled,
                value.fieldValue("outgoingRest").scaled,
                value.fieldValue("stockOptionReceived").scaled,
                value.fieldValue("stockOptionPaid").scaled,
                $0,
                $0,
                $0,
                $0,
                $0
               );

            it.moveNext();
        end;

        return m_container.values();
    end;

    private macro ctorTBiskvitScaledDataPart31(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTBiskvitScaledDataPart3Base(id, protocolView, dataSources);
        m_attributeName = "Подраздел_3.1_по_4927У";
    end;

    ctorTBiskvitScaledDataPart31(id, protocolView, dataSources);
end;

private class (TBiskvitScaledDataPart3Base) TBiskvitScaledDataPart32(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        var it = TF401Global().getRcbReport().attributeValue(m_attributeName).createValueIterator();
        it.setFilter(TNonTotalsFilter());
        it.moveFirst();
        while (not it.isDone())
            var value = it.currentItem;
            var rowCodePrefix = ternary(value.fieldValue("claimName").exact == "Требования", "3А2.", "3П2.");

            // Внебиржевые ПФИ
            add(rowCodePrefix + "1",
                value.fieldValue("currencyCode").exact,
                ternary(value.fieldValue("nrCode").exact == "Кредитные организации", "КО", "Прочие"),
                "2",
                value.fieldValue("incomeRest").scaled,
                value.fieldValue("turns").scaled,
                value.fieldValue("revaluationTurns").scaled,
                value.fieldValue("otherTurns").scaled,
                value.fieldValue("outgoingRest").scaled,
                $0,
                $0,
                $0,
                $0,
                $0,
                $0,
                $0
               );

            // Прочие срочные сделки
            add(rowCodePrefix + "2",
                value.fieldValue("currencyCode").exact,
                ternary(value.fieldValue("nrCode").exact == "Кредитные организации", "КО", "Прочие"),
                "2",
                value.fieldValue("rtGroup2IncomeRest").scaled,
                value.fieldValue("rtGroup2Turns").scaled,
                value.fieldValue("rtGroup2RevaluationTurns").scaled,
                value.fieldValue("rtGroup2OtherTurns").scaled,
                value.fieldValue("rtGroup2OutgoingRest").scaled,
                $0,
                $0,
                $0,
                $0,
                $0,
                $0,
                $0
               );

            it.moveNext();
        end;

        return m_container.values();
    end;

    private macro ctorTBiskvitScaledDataPart32(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTBiskvitScaledDataPart3Base(id, protocolView, dataSources);
        m_attributeName = "Подраздел_3.2_по_4927У";
    end;

    ctorTBiskvitScaledDataPart32(id, protocolView, dataSources);
end;

/**
 * Форма 401. Данные сделок МБК
 *
 * @since 17.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TMmDeals(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro clear()
        sql_truncate("df401mmdeals_tmp");
        return this;
    end;

    macro cacheData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        var query = "";
        var partyFilter = RcbBoCbDataSourceFilter("contragent", "deal");

        query = "SELECT deal.*,"
       + "\n" + "       deal.t_nrCodeType"
            " || '/' || deal.t_nrCodeSector"
            " || '/' || deal.t_nrCodeCountry"
            " || '/' || deal.t_nrCodeOkved"
            " || '/' || deal.t_nrCodeSpecApp    AS t_nrCode,"
       + "\n" + "       DECODE(deal.t_nrCodeCountry, " + getSqlString("643") + ", " + getSqlString("Р") + ","
       + "\n" + "              NVL((SELECT atc.t_value"
       + "\n" + "                    FROM drepcategory_vw atc"
       + "\n" + "                   WHERE atc.t_id = " + RCB_OBJGROUP_COUNTRY_GROUP_MEMBERSHIP
       + "\n" + "                     AND atc.t_objectType = " + RCB_OBJTYPE_COUNTRY
       + "\n" + "                     AND atc.t_objectId = (SELECT country.t_codeLat3"
       + "\n" + "                                             FROM dcountry_dbt country"
       + "\n" + "                                            WHERE country.t_codeNum3 = deal.t_nrCodeCountry"
       + "\n" + "                                              AND deal.t_nrCodeCountry != CHR(1)"
       + "\n" + "                                          )"
       + "\n" + "                     AND atc.t_isInstalledForEndDate = 1"
       + "\n" + "                  ), " + getSqlString("Д")
       + "\n" + "                 )"
       + "\n" + "             )                 AS t_countryGroupBis,"
       + "\n" + "       CASE"
       + "\n" + "           WHEN deal.t_nrCodeType = ANY(" + getSqlString("N1") + ", " + getSqlString("N2") + ")"
       + "\n" + "           THEN " + getSqlString("О")
       + "\n" + "           WHEN deal.t_nrCodeSpecApp = " + getSqlString("SPV")
       + "\n" + "           THEN " + getSqlString("П")
       + "\n" + "           ELSE " + getSqlString("")
       + "\n" + "       END AS t_relationshipBis"
       + "\n" + "  FROM ("
       + "\n" + "        SELECT NVL((SELECT category.t_value"
       + "\n" + "                      FROM drepCategory_vw category"
       + "\n" + "                     WHERE category.t_id = " + RCB_OBJGROUP_NONRESIDENT_TYPE
       + "\n" + "                       AND category.t_objectId = party.t_objectId"
       + "\n" + "                       AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                       AND category.t_isForParty = 1"
       + "\n" + "                   ), " + getSqlString("NN")
       + "\n" + "                  ) AS t_nrCodeType,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN party.t_isInternationalCorporation = 1"
       + "\n" + "                     OR party.t_isWorldDevelopmentBank = 1"
       + "\n" + "                     OR party.t_isEvrasianDevelopmentBank = 1"
       + "\n" + "                     OR party.t_isBlackseaDevelopmentBank = 1"
       + "\n" + "                     OR party.t_isInternationSettlementsBank = 1"
       + "\n" + "                     OR party.t_isInternalFinanceCorporation = 1"
       + "\n" + "                     OR " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_CREDITOR_SECTOR_CODE, "$mask$4*,5*", null, "party.t_objectId").isSuitable()
       + "\n" + "                   THEN " + getSqlString("500")
       + "\n" + "                   WHEN party.t_isCentralBank = 1"
       + "\n" + "                     OR party.t_isEuropeanCentralBank = 1"
       + "\n" + "                     OR " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_CREDITOR_SECTOR_CODE, "200", null, "party.t_objectId").isSuitable()
       + "\n" + "                   THEN " + getSqlString("200")
       + "\n" + "                   WHEN party.t_isBank = 1"
       + "\n" + "                     OR " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_CREDITOR_SECTOR_CODE, "100", null, "party.t_objectId").isSuitable()
       + "\n" + "                   THEN " + getSqlString("100")
       + "\n" + "                   ELSE " + getSqlString("500")
       + "\n" + "               END AS t_nrCodeSector,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN party.t_isForeignBranch = 1"
       + "\n" + "                    AND NOT EXISTS (SELECT 1"
       + "\n" + "                                      FROM drepparty_vw superior"
       + "\n" + "                                     WHERE superior.t_id = party.t_superior"
       + "\n" + "                                       AND superior.t_countryHistoryCode = " + getSqlString("RUS")
       + "\n" + "                                   )"
       + "\n" + "                   THEN (SELECT superior.t_countryHistoryNumberCode"
       + "\n" + "                           FROM drepparty_vw superior"
       + "\n" + "                          WHERE superior.t_id = party.t_superior"
       + "\n" + "                        )"
       + "\n" + "                   WHEN party.t_isForeignBranch = 1"
       + "\n" + "                    AND EXISTS (SELECT 1"
       + "\n" + "                                  FROM drepparty_vw superior"
       + "\n" + "                                 WHERE superior.t_id = party.t_superior"
       + "\n" + "                                   AND superior.t_countryHistoryCode = " + getSqlString("RUS")
       + "\n" + "                                   AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_REPORTING_COUNTRY, null, null, "superior.t_objectId").isSuitable()
       + "\n" + "                               )"
       + "\n" + "                   THEN (SELECT country.t_codeNum3"
       + "\n" + "                           FROM dcountry_dbt country,"
       + "\n" + "                                drepCategory_vw category,"
       + "\n" + "                                drepparty_vw superior"
       + "\n" + "                          WHERE category.t_id = " + RCB_OBJGROUP_REPORTING_COUNTRY
       + "\n" + "                            AND category.t_objectId = superior.t_objectId"
       + "\n" + "                            AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                            AND category.t_isForParty = 1"
       + "\n" + "                            AND superior.t_id = party.t_superior"
       + "\n" + "                            AND country.t_codelat3 = category.t_value"
       + "\n" + "                        )"
       + "\n" + "                   WHEN party.t_isForeignBranch = 1"
       + "\n" + "                    AND EXISTS (SELECT 1"
       + "\n" + "                                  FROM drepparty_vw superior"
       + "\n" + "                                 WHERE superior.t_id = party.t_superior"
       + "\n" + "                                   AND (   superior.t_countryHistoryCode IS NULL"
       + "\n" + "                                        OR (    superior.t_countryHistoryCode = " + getSqlString("RUS")
       + "\n" + "                                            AND " + partyFilter.clear().op("NOT").op("(").hasContractorAssignedCategory(RCB_OBJGROUP_REPORTING_COUNTRY, null, null, "superior.t_objectId").op(")").isSuitable()
       + "\n" + "                                           )"
       + "\n" + "                                       )"
       + "\n" + "                               )"
       + "\n" + "                   THEN " + getSqlString("997")
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND party.t_countryHistoryCode != " + getSqlString("RUS")
       + "\n" + "                    AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, "NN", null, "party.t_objectId").isSuitable()
       + "\n" + "                    AND party.t_isEuropeanCentralBank = 1"
       + "\n" + "                   THEN " + getSqlString("276")
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND party.t_countryHistoryCode != " + getSqlString("RUS")
       + "\n" + "                    AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, "NN", null, "party.t_objectId").isSuitable()
       + "\n" + "                    AND party.t_isInternationSettlementsBank = 1"
       + "\n" + "                   THEN " + getSqlString("756")
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND party.t_countryHistoryCode != " + getSqlString("RUS")
       + "\n" + "                    AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, "NN", null, "party.t_objectId").isSuitable()
       + "\n" + "                    AND (   party.t_isInternationalCorporation = 1"
       + "\n" + "                         OR party.t_isWorldDevelopmentBank = 1"
       + "\n" + "                         OR party.t_isEvrasianDevelopmentBank = 1"
       + "\n" + "                         OR party.t_isBlackseaDevelopmentBank = 1"
       + "\n" + "                        )"
       + "\n" + "                   THEN " + getSqlString("998")
       + "\n" + "                   WHEN party.t_isForeignBranch = 0" // Не важно, какое значение задано для категории RCB_OBJGROUP_NONRESIDENT_TYPE
       + "\n" + "                    AND party.t_isResidenceUnknown = 1"
       + "\n" + "                   THEN " + getSqlString("999")
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, "NN", null, "party.t_objectId").isSuitable()
       + "\n" + "                    AND NOT (   party.t_isInternationalCorporation = 1"
       + "\n" + "                             OR party.t_isWorldDevelopmentBank = 1"
       + "\n" + "                             OR party.t_isEvrasianDevelopmentBank = 1"
       + "\n" + "                             OR party.t_isBlackseaDevelopmentBank = 1"
       + "\n" + "                             OR party.t_isEuropeanCentralBank = 1"
       + "\n" + "                             OR party.t_isInternationSettlementsBank = 1"
       + "\n" + "                            )"
       + "\n" + "                   THEN party.t_countryHistoryNumberCode"
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND party.t_countryHistoryCode != " + getSqlString("RUS")
       + "\n" + "                    AND " + partyFilter.clear().op("NOT").op("(").hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, "NN", null, "party.t_objectId").op(")").isSuitable()
       + "\n" + "                   THEN party.t_countryHistoryNumberCode"
       + "\n" + "                   WHEN party.t_isForeignBranch = 0"
       + "\n" + "                    AND party.t_isResidenceUnknown = 0"
       + "\n" + "                    AND party.t_countryHistoryCode = " + getSqlString("RUS")
       + "\n" + "                    AND " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_NONRESIDENT_TYPE, null, null, "party.t_objectId").isSuitable()
       + "\n" + "                   THEN (SELECT country.t_codeNum3"
       + "\n" + "                           FROM dcountry_dbt country,"
       + "\n" + "                                drepCategory_vw category"
       + "\n" + "                          WHERE category.t_id = " + RCB_OBJGROUP_REPORTING_COUNTRY
       + "\n" + "                            AND category.t_objectId = party.t_objectId"
       + "\n" + "                            AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                            AND category.t_isForParty = 1"
       + "\n" + "                            AND country.t_codelat3 = category.t_value"
       + "\n" + "                        )"
       + "\n" + "               END AS t_nrCodeCountry,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN NVL((SELECT category.t_value"
       + "\n" + "                               FROM drepCategory_vw category"
       + "\n" + "                              WHERE category.t_id = " + RCB_OBJGROUP_NONRESIDENT_TYPE
       + "\n" + "                                AND category.t_objectId = party.t_objectId"
       + "\n" + "                                AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                                AND category.t_isForParty = 1"
       + "\n" + "                            ), " + getSqlString("NN")
       + "\n" + "                           ) = " + getSqlString("NN")
       + "\n" + "                   THEN " + getSqlString("XXX")
       + "\n" + "                   ELSE NVL((SELECT category.t_value"
       + "\n" + "                               FROM drepCategory_vw category"
       + "\n" + "                              WHERE category.t_id = " + RCB_OBJGROUP_NONRESIDENT_OKVED
       + "\n" + "                                AND category.t_objectId = party.t_objectId"
       + "\n" + "                                AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                                AND category.t_isForParty = 1"
       + "\n" + "                            ), " + getSqlString("")
       + "\n" + "                           )"
       + "\n" + "               END AS t_nrCodeOkved,"
       + "\n" + "               DECODE(party.t_isSpecialAppEnterprise, 1, " + getSqlString("SPV") + ", " + getSqlString("000") + ") AS t_nrCodeSpecApp,"
       + "\n" + "               deal.t_mainRestAccount AS t_mainRestAccount,"
       + "\n" + "               deal.t_delaydMainRestAcc AS t_delaydMainRestAcc,"
       + "\n" + "               deal.t_accruedInterestAccount AS t_accruedInterestAccount,"
       + "\n" + "               deal.t_delaydPercentAcc AS t_delaydPercentAcc,"
       + "\n" + "               deal.t_fiId AS t_fiId,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN NVL((SELECT category.t_value"
       + "\n" + "                               FROM drepCategory_vw category"
       + "\n" + "                              WHERE category.t_id = " + RCB_OBJGROUP_NONRESIDENT_TYPE
       + "\n" + "                                AND category.t_objectId = party.t_objectId"
       + "\n" + "                                AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                                AND category.t_isForParty = 1"
       + "\n" + "                            ), " + getSqlString("NN")
       + "\n" + "                           ) = " + getSqlString("NN")
       + "\n" + "                   THEN " + getSqlString("000")
       + "\n" + "                   ELSE (SELECT CASE"
       + "\n" + "                                    WHEN fi.t_id = 0"
       + "\n" + "                                    THEN " + getSqlString("643")
       + "\n" + "                                    WHEN fi.t_code = ANY ('840','978','826','756','392','933','398','156')"
       + "\n" + "                                    THEN fi.t_code"
       + "\n" + "                                    ELSE " + getSqlString("999")
       + "\n" + "                                END"
       + "\n" + "                           FROM drepfininstrument_vw fi"
       + "\n" + "                          WHERE fi.t_id = deal.t_fiId"
       + "\n" + "                        )"
       + "\n" + "               END AS t_fiNumericCode,"
       + "\n" + "               deal.t_id AS t_id,"
       + "\n" + "               deal.t_number AS t_number,"
       + "\n" + "               deal.t_kind AS t_kind,"
       + "\n" + "               DECODE(party.t_isResident, 1," + getSqlString("Р") + ", " + getSqlString("Н") + ") AS t_residenceSignBis,"
       + "\n" + "               CASE"
       + "\n" + "                   WHEN party.t_isBank = 1"
       + "\n" + "                   THEN " + getSqlString("Б")
       + "\n" + "                   WHEN party.t_isPhisical = 1"
       + "\n" + "                   THEN " + getSqlString("Ф")
       + "\n" + "                   WHEN (SELECT category.t_value"
       + "\n" + "                           FROM drepCategory_vw category"
       + "\n" + "                          WHERE category.t_id = " + RCB_OBJGROUP_CREDITOR_SECTOR_CODE_RESIDENT
       + "\n" + "                            AND category.t_objectId = party.t_objectId"
       + "\n" + "                            AND category.t_isInstalledForEndDate = 1"
       + "\n" + "                            AND category.t_isForParty = 1"
       + "\n" + "                        ) = " + getSqlString("810")
       + "\n" + "                   THEN " + getSqlString("Н")
       + "\n" + "                   ELSE " + getSqlString("Ю")
       + "\n" + "               END AS t_clientTypeBis"
       + "\n" + "          FROM repMmDeals_vw deal,"
       + "\n" + "               drepParty_vw party"
       + "\n" + "         WHERE deal.t_contragentId = party.t_id"
       + "\n" + "           AND deal.t_isOpened = 1"
       + "\n" + "           AND (   party.t_countryHistoryCode != 'RUS'"
       + "\n" + "                OR " + partyFilter.clear().hasContractorAssignedCategory(RCB_OBJGROUP_REPORTING_COUNTRY, null, null, "party.t_objectId").isSuitable()
       + "\n" + "               )"
       + "\n" + "           AND " + RcbDepartmentFieldFilter().getAsSqlString("deal.t_department")
       + "\n" + "       ) deal"
              ;

        sql_execute("INSERT INTO df401mmdeals_tmp"
           + "\n" + "("
           + "\n" + "     t_nrCodeType,"
           + "\n" + "     t_nrCodeSector,"
           + "\n" + "     t_nrCodeCountry,"
           + "\n" + "     t_nrCodeOkved,"
           + "\n" + "     t_nrCodeSpecApp,"
           + "\n" + "     t_mainRestAccount,"
           + "\n" + "     t_delaydMainRestAcc,"
           + "\n" + "     t_accruedInterestAccount,"
           + "\n" + "     t_delaydPercentAcc,"
           + "\n" + "     t_fiId,"
           + "\n" + "     t_fiNumericCode,"
           + "\n" + "     t_id,"
           + "\n" + "     t_number,"
           + "\n" + "     t_kind,"
           + "\n" + "     t_residenceSignBis,"
           + "\n" + "     t_clientTypeBis,"
           + "\n" + "     t_nrCode,"
           + "\n" + "     t_countryGroupBis,"
           + "\n" + "     t_relationshipBis"
           + "\n" + ")"
           + "\n" + query
                   );

        sql_execute("COMMIT");

        return this;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
        return RcbDataset("SELECT *"
                 + "\n" + "  FROM df401mmdeals_tmp"
                 + "\n" + " WHERE " + filter.isSuitable(),
                          RSDVAL_SERVER, RSDVAL_FORWARD_ONLY
                         );
    end;

    private macro constructorTMmDeals(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTMmDeals(id, protocolView, dataSources);
end;

///**
// * Форма 401. Уникальные счета по сделкам МБК
// *
// * @since 17.09.2018
// * @author ABP
// * @version 6.20.031.054
// */
//private class (RcbDataSource) TAccounts(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
//    macro clear()
//        sql_truncate("df401accounts_tmp");
//    end;
//
//    macro cacheData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
//        var query = "";
//
//// Отобрать уникальные счета с привязкой к КодеНР,VVV,строка(???)
//// "Раскрасить": признак того, каким счетом в сделке является (ОД, проср.ОД, начисл.%%, просроч.%%). На счете может быть несколько признаков
//        query = "WITH dealacc AS"
//       + "\n" + "(SELECT /*+ MATERIALIZE */deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp    AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode    AS t_currencyCode,"
//       + "\n" + "        tune.t_row              AS t_rowCode,"
//       + "\n" + "        deal.t_mainRestAccount  AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А3,А5,А6,А18,П1,П3,П4 (1,2,4,5)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp           AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
//       + "\n" + "        tune.t_row                     AS t_rowCode,"
//       + "\n" + "        deal.t_accruedInterestAccount  AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А3,А5,А6,А18,П1,П3,П4 (1,2,4,5)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
//       + "\n" + "    AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp       AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
//       + "\n" + "        tune.t_row                 AS t_rowCode,"
//       + "\n" + "        deal.t_delaydMainRestAcc   AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А3,А5,А6,А18,П1,П3,П4 (4)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp           AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
//       + "\n" + "        tune.t_row                     AS t_rowCode,"
//       + "\n" + "        deal.t_accruedInterestAccount  AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А3,А5,А6,А18,П1,П3,П4 (4,6)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp       AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
//       + "\n" + "        tune.t_row                 AS t_rowCode,"
//       + "\n" + "        deal.t_delaydPercentAcc   AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А3,А5,А6,А18,П1,П3,П4 (4)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp       AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
//       + "\n" + "        tune.t_row                 AS t_rowCode,"
//       + "\n" + "        deal.t_delaydMainRestAcc   AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А15.1,П14.1 (1,2,4,5)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp       AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
//       + "\n" + "        tune.t_row                 AS t_rowCode,"
//       + "\n" + "        deal.t_mainRestAccount     AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А15.1,П14.1 (4)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp       AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
//       + "\n" + "        tune.t_row                 AS t_rowCode,"
//       + "\n" + "        deal.t_delaydPercentAcc   AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А16,П15 (1,2,4,5,6)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//       + "\n" + " UNION"
//       + "\n" + "(SELECT deal.t_nrCodeType"
//             " || '/' || deal.t_nrCodeSector"
//             " || '/' || deal.t_nrCodeCountry"
//             " || '/' || deal.t_nrCodeOkved"
//             " || '/' || deal.t_nrCodeSpecApp           AS t_nrCode,"
//       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
//       + "\n" + "        tune.t_row                     AS t_rowCode,"
//       + "\n" + "        deal.t_accruedInterestAccount  AS t_account"
//       + "\n" + "   FROM df401mmdeals_tmp deal,"
//       + "\n" + "        (" + getTune().getQuery()    //А16,П15 (4)
//       + "\n" + "        ) tune"
//       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
//       + "\n" + "    AND (" + getDealFilter()
//       + "\n" + "        )"
//
//
//       + "\n" + ")"
//              ;
//
//        sql_execute("INSERT INTO df401accounts_tmp"
//           + "\n" + "("
//           + "\n" + "     t_nrCodeType,"
//           + "\n" + "     t_nrCodeSector,"
//           + "\n" + "     t_nrCodeCountry,"
//           + "\n" + "     t_nrCodeOkved,"
//           + "\n" + "     t_nrCodeSpecApp,"
//           + "\n" + "     t_mainRestAccount,"
//           + "\n" + "     t_delaydMainRestAcc,"
//           + "\n" + "     t_accruedInterestAccount,"
//           + "\n" + "     t_delaydPercentAcc,"
//           + "\n" + "     t_fiId,"
//           + "\n" + "     t_fiNumericCode,"
//           + "\n" + "     t_id,"
//           + "\n" + "     t_number,"
//           + "\n" + "     t_kind"
//           + "\n" + ")"
//           + "\n" + query
//                   );
//    end;
//
//    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase)
//        return RcbDataset("SELECT *"
//                 + "\n" + "  FROM df401accounts_tmp"
//                 + "\n" + " WHERE " + filter.isSuitable()
//                         );
//    end;
//
//    private macro constructorTAccounts(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
//        initRcbDataSource(id, protocolView, dataSources);
//    end;
//
//    constructorTAccounts(id, protocolView, dataSources);
//end;

/**
 * Форма 401. Атрибуты формы, рассчитываемые по ГК/МБК. Базовый для разделов 1 и 2
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getRow()
        throw(TPureVirtualMethodCallException("TAttributes::getRows"));
    end;

    private macro getDealFilter()
        throw(TPureVirtualMethodCallException("TAttributes::getDealFilter"));
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var query = "";

        query = "SELECT deal.t_nrCode,"
       + "\n" + "       deal.t_currencyCode,"
       + "\n" + "       formRow.t_rowCode,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_incomeRest,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_turns,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_revaluationTurns,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_otherTurns,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_outgoingRest,"
       + "\n" + "       CASE formRow.t_isAutomated"
       + "\n" + "           WHEN 1 THEN 0.0"
       + "\n" + "           ELSE NULL"
       + "\n" + "       END AS t_interests,"
       + "\n" + "       formRow.t_rowIndex,"
       + "\n" + "       formRow.t_isAutomated"
       + "\n" + "  FROM (SELECT DISTINCT deal.t_nrCode  AS t_nrCode,"
       + "\n" + "               deal.t_fiNumericCode    AS t_currencyCode"
       + "\n" + "          FROM df401mmdeals_tmp deal"
       + "\n" + "         WHERE (" + getDealFilter()
       + "\n" + "               )"
       + "\n" + "       ) deal,"
       + "\n" + "       (" + getRow()
       + "\n" + "       ) formRow"
       + "\n" + "GROUP BY deal.t_nrCode,"
       + "\n" + "         deal.t_currencyCode,"
       + "\n" + "         formRow.t_rowCode,"
       + "\n" + "         formRow.t_rowIndex,"
       + "\n" + "         formRow.t_isAutomated"
       + "\n" + "ORDER BY deal.t_nrCode,"
       + "\n" + "         deal.t_currencyCode,"
       + "\n" + "         formRow.t_rowIndex"
              ;

        var dataset = RcbDataset(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("t_nrCode",            V_STRING);
        dataSet.setFieldType("t_currencyCode",      V_STRING);
        dataSet.setFieldType("t_rowCode",           V_STRING);
        dataSet.setFieldType("t_incomeRest",        V_MONEY);
        dataSet.setFieldType("t_turns",             V_MONEY);
        dataSet.setFieldType("t_revaluationTurns",  V_MONEY);
        dataSet.setFieldType("t_otherTurns",        V_MONEY);
        dataSet.setFieldType("t_outgoingRest",      V_MONEY);
        dataSet.setFieldType("t_interests",         V_MONEY);
        dataSet.setFieldType("t_rowIndex",          V_INTEGER);
        dataSet.setFieldType("t_isAutomated",       V_INTEGER);

        return dataset;
    end;

    private macro constructorTAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTAttributes(id, protocolView, dataSources);
end;

/**
 * Форма 401. Атрибуты раздела 1
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TAttributes) TAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getRow()
        const QUERY_PREFIX = "\nUNION ALL ";
        var query = "";
        for (var row, TF401Part1RowsData())
            query = query + QUERY_PREFIX + "SELECT " + getSqlString(row.code) + " t_rowCode, "
                                                     + row.indx + " t_rowIndex, "
                                                     + ternary(row.isAutomated, 1, 0) + " t_isAutomated FROM DUAL";
        end;
        query = substr(query, strlen(QUERY_PREFIX)+1);
        return query;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro constructorTAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart1(id, protocolView, dataSources);
end;

/**
 * Форма 401. Атрибуты раздела 2
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TAttributes) TAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getRow()
        const QUERY_PREFIX = "\nUNION ALL ";
        var query = "";
        for (var row, TF401Part2RowsData())
            query = query + QUERY_PREFIX + "SELECT " + getSqlString(row.code) + " t_rowCode, "
                                                     + row.indx + " t_rowIndex, "
                                                     + ternary(row.isAutomated, 1, 0) + " t_isAutomated FROM DUAL";
        end;
        query = substr(query, strlen(QUERY_PREFIX)+1);
        return query;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro constructorTAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart2(id, protocolView, dataSources);
end;

private class TBiskvitResources(accountTableAlias, dealsAccountsTableAlias)
    private var m_accountTableAlias;
    private var m_dealsAccountsTableAlias;
    private var m_biskvitExact;

    macro setBiskvitExactDatasource(biskvitExact)
        m_biskvitExact = biskvitExact;
    end;

    macro getAccountTableAlias()
        return m_accountTableAlias;
    end;

    macro getDealsAccountsTableAlias()
        return m_dealsAccountsTableAlias;
    end;

    macro getInsertClause()
       return   "t_sym2,"
       + "\n" + "t_sym3,"
       + "\n" + "t_sym4,"
       + "\n" + "t_val7,"
       + "\n" + "t_val8,"
       + "\n" + "t_val9,"
       + "\n" + "t_val10,"
       + "\n" + "t_val11,"
       + "\n" + "t_val12,"
       + "\n" + "t_txt1"
       ;
    end;

    macro getNrCodePartsClause()
       return   "deal.t_nrCodeType          AS t_nrCodeType,"
       + "\n" + "deal.t_nrCodeSector        AS t_nrCodeSector,"
       + "\n" + "deal.t_nrCodeCountry       AS t_nrCodeCountry,"
       + "\n" + "deal.t_nrCodeOkved         AS t_nrCodeOkved,"
       + "\n" + "deal.t_nrCodeSpecApp       AS t_nrCodeSpecApp,"
       + "\n" + "deal.t_countryGroupBis     AS t_countryGroupBis,"
       + "\n" + "deal.t_residenceSignBis    AS t_residenceSignBis,"
       + "\n" + "deal.t_clientTypeBis       AS t_clientTypeBis,"
       + "\n" + "deal.t_relationshipBis     AS t_relationshipBis"
       ;
    end;

    macro getSelectClause()
       return   "t_sym2       AS t_sym2,"
       + "\n" + "t_sym3       AS t_sym3,"
       + "\n" + "t_sym4       AS t_sym4,"
       + "\n" + "SUM(t_val7)  AS t_val7,"
       + "\n" + "SUM(t_val8)  AS t_val8,"
       + "\n" + "SUM(t_val9)  AS t_val9,"
       + "\n" + "SUM(t_val10) AS t_val10,"
       + "\n" + "SUM(t_val11) AS t_val11,"
       + "\n" + "SUM(t_val12) AS t_val12,"
       + "\n" + "t_txt1       AS t_txt1"
       ;
    end;

    macro getDataClause()
       return    getAccountTableAlias() + ".t_account        AS t_sym2,"
       + "\n" +  getDealsAccountsTableAlias() + ".t_nrCodeCountry"
              + "|| ';'"
              + "|| ';' || " + getDealsAccountsTableAlias() + ".t_nrCodeType"
              + "|| ';' || " + getDealsAccountsTableAlias() + ".t_nrCodeSector"
              + "|| ';' || DECODE(" + getDealsAccountsTableAlias() + ".t_nrCodeType, 'NN', '', " + getDealsAccountsTableAlias() + ".t_nrCodeOkved) --" + getDealsAccountsTableAlias() + ".t_nrCodeOkved -> DECODE(, 'Ф', 'NRP', " + getDealsAccountsTableAlias() + ".t_nrCodeOkved)"
       + "\n" + "                                            AS t_sym3,"
       + "\n" +  getAccountTableAlias() + ".t_iso_number     AS t_sym4,"
       + "\n" + "0                        AS t_val7,"
       + "\n" + "0                        AS t_val8,"
       + "\n" + "0                        AS t_val9,"
       + "\n" + "0                        AS t_val10,"
       + "\n" + "0                        AS t_val11,"
       + "\n" + "0                        AS t_val12,"
       + "\n" +  getDealsAccountsTableAlias() + ".t_countryGroupBis"
              + "|| ';' || " + getDealsAccountsTableAlias() + ".t_residenceSignBis"
              + "|| ';' || " + getDealsAccountsTableAlias() + ".t_clientTypeBis"
              + "|| ';' || " + getDealsAccountsTableAlias() + ".t_relationshipBis"
       + "\n" + "                                            AS t_txt1"
       ;
    end;

    macro getGroupingClause()
       return   " GROUP BY ROLLUP ((t_nrCode,"
       + "\n" + "                   t_currencyCode,"
       + "\n" + "                   t_rowCode"
       + "\n" + "                  ),"
       + "\n" + "                  (t_sym2,"
       + "\n" + "                   t_sym3,"
       + "\n" + "                   t_sym4,"
       + "\n" + "                   t_txt1"
       + "\n" + "                  )"
       + "\n" + "                 )"
       + "\n" + "HAVING GROUPING_ID(t_nrCode, t_currencyCode, t_rowCode) = 0"
       + "\n" + "    OR GROUPING(t_nrCode) = 1"
       + "\n" + " ORDER BY GROUPING_ID(t_sym2, t_sym3, t_sym4, t_txt1),"
       + "\n" + "          GROUPING(t_nrCode) DESC,"
       + "\n" + "          t_nrCode,"
       + "\n" + "          t_currencyCode,"
       + "\n" + "          t_rowCode"
       ;
    end;

    macro setDatasetFieldTypes(dataset)
        dataSet.setFieldType("t_sym2",  V_STRING);
        dataSet.setFieldType("t_sym3",  V_STRING);
        dataSet.setFieldType("t_sym4",  V_STRING);
        dataSet.setFieldType("t_val7",  V_MONEY);
        dataSet.setFieldType("t_val8",  V_MONEY);
        dataSet.setFieldType("t_val9",  V_MONEY);
        dataSet.setFieldType("t_val10", V_MONEY);
        dataSet.setFieldType("t_val11", V_MONEY);
        dataSet.setFieldType("t_val12", V_MONEY);
        dataSet.setFieldType("t_txt1",  V_STRING);
    end;

    macro saveDetailsParts12(dataset, datasources)
        while (dataset.next() and (dataset.value("t_nrCode") != null))
            m_biskvitExact.add(dataset.value("t_rowCode"),
                               dataSet.value("t_sym2"),
                               dataSet.value("t_sym3"),
                               dataSet.value("t_sym4"),
                               dataSet.value("t_incomeRest"),
                               dataSet.value("t_turns"),
                               dataSet.value("t_revaluationTurns"),
                               dataSet.value("t_otherTurns"),
                               dataSet.value("t_outgoingRest"),
                               dataSet.value("t_interests"),
                               dataSet.value("t_val7"),
                               dataSet.value("t_val8"),
                               dataSet.value("t_val9"),
                               dataSet.value("t_val10"),
                               dataSet.value("t_val11"),
                               dataSet.value("t_val12"),
                               dataSet.value("t_txt1")
                              );
        end;
    end;

    macro saveDetailsSecParts12(dataset)
        for (var it, dataset)
            m_biskvitExact.add(it.sym1,
                               it.sym2,
                               it.sym3,
                               it.sym4,
                               it.val1,
                               it.val2,
                               it.val3,
                               it.val4,
                               it.val5,
                               it.val6,
                               it.val7,
                               it.val8,
                               it.val9,
                               it.val10,
                               it.val11,
                               it.val12,
                               it.txt1
                              );
        end;
    end;

    macro saveDetailsSecPart3(dataset)
        for (var it, dataset)
            var txt5;
            var dummy;
            dttmSplit(it.txt5, txt5, dummy);

            m_biskvitExact.add(it.sym1,
                               it.sym2,
                               it.sym3,
                               it.sym4,
                               it.val1,
                               it.val2,
                               it.val3,
                               it.val4,
                               it.val5,
                               it.val6,
                               it.val7,
                               it.val8,
                               it.val9,
                               it.val1,
                               it.val1,
                               it.val1,
                               it.txt1,
                               String(it.txt2),
                               it.txt3,
                               it.txt4,
                               String(txt5 : f)
                              );
        end;
    end;

    private macro ctorTBiskvitResources(accountTableAlias, dealsAccountsTableAlias)
        m_accountTableAlias = accountTableAlias;
        m_dealsAccountsTableAlias = dealsAccountsTableAlias;
    end;

    ctorTBiskvitResources(accountTableAlias, dealsAccountsTableAlias);
end;

/**
 * Форма 401. Атрибуты, вычисляемые по данным RS-Securities. Базовый для разделов 1 и 2
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TAttributesSecParts12Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_partNumber;
    private var m_datasource;
    private var m_isDatasourceValid;
    private var m_isFirstCall;
    private var m_rowsData;
    private var m_container;

    private var m_nrCode;
    private var m_currencyCode;

    private var m_biskvitResources;

    // Создать полный набор строк для пары КодНерезидента-КодВалюты
    // Графы строк, отсутствующих в m_datasource, заполняются нулями или null'ами, в зависимости от m_rowsData.getCurrentItem().isAutomated
    // 06.08.2019 ABP SCR274418. Алгоритм усложнился по сравнению с предыдущей реализацией: убрана зависимость от упорядочивания по "номеру"
    //                           строки в ИД Securities C_401_Secur (номера строк - не числа, поэтому порядок строк неверный). Эти же
    //                           изменения реализуют контроль корректности кодов (номеров) строк в разрезе разделов. Алгоритм, по всей
    //                           видимости, потерял в производительности. Но на тестовых данных это не заметно. В случае выявления
    //                           проблем в пром. эксплуатации нужно либо вернуть старый алгоритм с реализацией корректного упорядочивания
    //                           в ИД Securities, либо пытаться ускорить эту реализацию алгоритма.
    private macro makeRowsPool()
        var rowData;

        m_container.clear();

        var isCodesChanged = false;
        while (not isCodesChanged and m_isDatasourceValid)
            rowData = null;
            var indx = null;
            // 06.08.2019 ABP Сюда можно Java.HashMap для TRowData.code-TRowData.indx, заранее построенный в TF401RowsData.
            //                Но не факт, что будет более производительно.
            for (var it, m_rowsData)
                if (it.code == m_datasource.НомерСтроки)
                    rowData = it;
                    indx = rowData.indx;
                    break;
                end;
            end;

            if (rowData != null)
                var details = RcbArray();
                for (it, m_datasource.RepData)
                    details.push_back(TBiskvitElement(it.НомерСтроки,                 // Номер строки
                                                      it.Счет,                        // Счет
                                                      it.КодНерезидента_Sym3,         // Код нерезидента Sym3
                                                      it.КодВалюты,                   // Код валюты
                                                      it.ОстатокНачало,               // Остаток на начало отчетного периода
                                                      it.ИзменениеАктивовОперация,    // Изменение активов в результате операций
                                                      it.ИзменениеАктивовПереоценкка, // Изменение активов в результате переоценки
                                                      it.ПрочиеИзменения,             // Прочие изменения активов
                                                      it.ОстатокКонец,                // Остаток на конец  отчетного периода
                                                      it.НачисленныеПроценты,         // Начисленные проценты
                                                      0,                              // t_val7
                                                      0,                              // t_val8
                                                      0,                              // t_val9
                                                      0,                              // t_val10
                                                      0,                              // t_val11
                                                      0,                              // t_val12
                                                      it.ДопИнфо                      // Дополнительная информация
                                                     )
                                      );
                end;

                // заполнить по данным m_datasource
                m_container[indx] = RcbArray().init(m_datasource.КодНерезидента,
                                                    m_datasource.КодВалюты,
                                                    m_datasource.НомерСтроки,
                                                    m_datasource.ОстатокНачало,
                                                    m_datasource.ИзменениеАктивовОперация,
                                                    m_datasource.ИзменениеАктивовПереоценкка,
                                                    m_datasource.ПрочиеИзменения,
                                                    m_datasource.ОстатокКонец,
                                                    m_datasource.НачисленныеПроценты,
                                                    rowData.indx,
                                                    rowData.isAutomated,
                                                    details
                                                   );
            end;

            m_isDatasourceValid = m_datasource.getNext();
            isCodesChanged =     m_isDatasourceValid
                             and (   (m_nrCode != m_datasource.КодНерезидента)
                                  or (m_currencyCode != m_datasource.КодВалюты)
                                 );
        end;

        // Строки, отсутствующие в датасете, заполнить нулями или null'ми, в зависимости от m_rowsData.getCurrentItem().isAutomated
        for (rowData, m_rowsData)
            if (m_container[rowData.indx] == null)
                m_container[rowData.indx] = RcbArray().init(m_nrCode,
                                                            m_currencyCode,
                                                            rowData.code,
                                                            ternary(rowData.isAutomated, $0, null),
                                                            ternary(rowData.isAutomated, $0, null),
                                                            ternary(rowData.isAutomated, $0, null),
                                                            ternary(rowData.isAutomated, $0, null),
                                                            ternary(rowData.isAutomated, $0, null),
                                                            ternary(rowData.isAutomated, $0, null),
                                                            rowData.indx,
                                                            rowData.isAutomated,
                                                            RcbArray()
                                                           );
            end;
        end;
        if (m_isDatasourceValid and isCodesChanged)
            m_nrCode = m_datasource.КодНерезидента;
            m_currencyCode = m_datasource.КодВалюты;
        end;
    end;

    macro nrCode()
        return m_container.getCurrentItem()[0];
    end;

    macro currencyCode()
        return m_container.getCurrentItem()[1];
    end;

    macro rowCode()
        return m_container.getCurrentItem()[2];
    end;

    macro incomeRest()
        return m_container.getCurrentItem()[3];
    end;

    macro turns()
        return m_container.getCurrentItem()[4];
    end;

    macro revaluationTurns()
        return m_container.getCurrentItem()[5];
    end;

    macro otherTurns()
        return m_container.getCurrentItem()[6];
    end;

    macro outgoingRest()
        return m_container.getCurrentItem()[7];
    end;

    macro interests()
        return m_container.getCurrentItem()[8];
    end;

    macro rowIndex()
        return m_container.getCurrentItem()[9];
    end;

    macro isAutomated()
        return m_container.getCurrentItem()[10];
    end;

    macro detailsData()
        return m_container.getCurrentItem()[11];
    end;

    macro value(name) : Variant
        // Альтернатива - предположительно, более производительная - явно проверять соответствие имени и вызывать соответствующий метод
        if (index(name, "t_") == 1)
            name = substr(name, 3);
        end;
        return genRun(this, name);
    end;

    macro moveNext() : Bool
        if (m_isFirstCall)
            m_isDatasourceValid = m_datasource.getFirst();
            m_isFirstCall = false;

            if (m_isDatasourceValid)
                m_nrCode = m_datasource.КодНерезидента;
                m_currencyCode = m_datasource.КодВалюты;
                makeRowsPool();
                m_container.moveFirst();
            end;
        end;

        var result = m_container.moveNext();
        if (not result and m_isDatasourceValid)
            makeRowsPool();
            m_container.moveFirst();
            result = m_container.moveNext();
        end;

        if (result)
            m_biskvitResources.saveDetailsSecParts12(detailsData());
        end;

        return result;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var departmentList = RcbArray();
        RcbDepartmentList().saveToTable();
        var departmentListDataSource = TRsbDataset("SELECT * FROM dbldept_tmp");
        while (departmentListDataSource.next())
            departmentList.push_back(departmentListDataSource.code);
        end;

        var period = TF401Global().getRcbReport().context.period;
        m_datasource = C_401_Secur();
        m_datasource.setFilter(departmentList, period.beginDate, period.endDate, m_partNumber);

        m_isFirstCall = true;
        m_container.moveFirst();

        return this;
    end;

    private macro constructorTAttributesSecParts12Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_container = RcbArray();
        m_biskvitResources = TBiskvitResources();
    end;

    constructorTAttributesSecParts12Base(id, protocolView, dataSources);
end;

private class (TAttributesSecParts12Base) TAttributesSecPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro constructorTAttributesSecPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributesSecParts12Base(id, protocolView, dataSources);
        m_partNumber = PART_ONE;
        m_rowsData = TF401Part1RowsData();
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTAttributesSecPart1(id, protocolView, dataSources);
end;

private class (TAttributesSecParts12Base) TAttributesSecPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro constructorTAttributesSecPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributesSecParts12Base(id, protocolView, dataSources);
        m_partNumber = PART_TWO;
        m_rowsData = TF401Part2RowsData();
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTAttributesSecPart2(id, protocolView, dataSources);
end;

/**
 * Форма 401. Атрибуты, вычисляемые по данным RS-Securities. Базовый для подразделов 3.1, 3.2
 *
 * @since 28.05.2019
 * @author ABP
 * @version 6.20.031.057
 */
private class (RcbDataSource) TAttributesSecPart3Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_partNumber;
    private var m_datasource;
    private var m_rowIndex;
    private var m_rowsData;
    private var m_delimiter;

    private var m_index1;
    private var m_index2;
    private var m_rowDataString;

    private var m_shift;

    private var m_biskvitResources;

    macro nrCode()
        if (m_index2 != 0)
            return substr(m_rowDataString, m_index1+1, m_index2-m_index1-1);
        else
            return substr(m_rowDataString, m_index1+1);
        end;
    end;

    macro currencyCode()
        return substr(m_rowDataString, 1, m_index1-1);
    end;

    macro rowCode()
        return m_rowsData[m_rowIndex].code;
    end;

    macro claimName()
        return substr(m_rowDataString, m_index2+1);
    end;

    macro incomeRest()
        return genGetProp(m_datasource, "C_"+String(4+m_shift));
    end;

    macro turns()
        return genGetProp(m_datasource, "C_"+String(5+m_shift));
    end;

    macro revaluationTurns()
        return genGetProp(m_datasource, "C_"+String(6+m_shift));
    end;

    macro otherTurns()
        return genGetProp(m_datasource, "C_"+String(7+m_shift));
    end;

    macro outgoingRest()
        return genGetProp(m_datasource, "C_"+String(8+m_shift));
    end;

    macro rtGroup2IncomeRest()
        return genGetProp(m_datasource, "C_"+String(9+m_shift));
    end;

    macro rtGroup2Turns()
        return genGetProp(m_datasource, "C_"+String(10+m_shift));
    end;

    macro rtGroup2RevaluationTurns()
        return genGetProp(m_datasource, "C_"+String(11+m_shift));
    end;

    macro rtGroup2OtherTurns()
        return genGetProp(m_datasource, "C_"+String(12+m_shift));
    end;

    macro rtGroup2OutgoingRest()
        return genGetProp(m_datasource, "C_"+String(13+m_shift));
    end;

    macro stockOptionReceived()
        return genGetProp(m_datasource, "C_"+String(14+m_shift));
    end;

    macro stockOptionPaid()
        return genGetProp(m_datasource, "C_"+String(15+m_shift));
    end;

    macro rowIndex()
        return m_rowsData[m_rowIndex].indx;
    end;

    macro isAutomated()
        return m_rowsData[m_rowIndex].isAutomated;
    end;

    macro detailsData()
        return m_datasource.RepData;
    end;

    macro value(name) : Variant
        // Альтернатива - предположительно, более производительная - явно проверять соответствие имени и вызывать соответствующий метод
        if (index(name, "t_") == 1)
            name = substr(name, 3);
        end;
        return genRun(this, name);
    end;

    macro moveNext() : Bool
        var result;

        if (m_rowIndex == -1)
            result = m_datasource.getFirst();
        else
            result = m_datasource.getNext();
        end;

        if (result)
            m_rowIndex = m_rowIndex + 1;

            m_rowDataString = m_rowsData[m_rowIndex].name;
            m_index1 = index(m_rowDataString, m_delimiter);
            m_index2 = index(m_rowDataString, m_delimiter, m_index1+1);

            m_biskvitResources.saveDetailsSecPart3(detailsData());
        end;

        return result;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var departmentList = RcbArray();
        RcbDepartmentList().saveToTable();
        var departmentListDataSource = TRsbDataset("SELECT * FROM dbldept_tmp");
        while (departmentListDataSource.next())
            departmentList.push_back(departmentListDataSource.code);
        end;

        var period = TF401Global().getRcbReport().context.period;
        m_datasource = C_401deriv();
        m_datasource.setFilter(departmentList, period.beginDate, period.endDate, m_partNumber);

//        m_isFirstCall = true;
//        m_container.moveFirst();
        m_rowIndex = -1;
        m_delimiter = m_rowsData.getDelimiter();
        m_rowsData = m_rowsData.get();

        return this;
    end;

    private macro constructorTAttributesSecPart3Base(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
//        m_container = RcbArray();
        m_biskvitResources = TBiskvitResources();
    end;

    constructorTAttributesSecPart3Base(id, protocolView, dataSources);
end;

private class (TAttributesSecPart3Base) TAttributesSecPart31(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro constructorTAttributesSecPart31(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributesSecPart3Base(id, protocolView, dataSources);
        m_partNumber = PART_3_1;
        m_rowsData = objectFactoryInstance.createPartRowsData(TF401Global().getPart31Id());
        m_shift = 0;
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 3.1"));
    end;

    constructorTAttributesSecPart31(id, protocolView, dataSources);
end;

private class (TAttributesSecPart3Base) TAttributesSecPart32(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro constructorTAttributesSecPart32(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributesSecPart3Base(id, protocolView, dataSources);
        m_partNumber = PART_3_2;
        m_rowsData = objectFactoryInstance.createPartRowsData(TF401Global().getPart32Id());
        m_shift = 1;
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 3.2"));
    end;

    constructorTAttributesSecPart32(id, protocolView, dataSources);
end;

/**
 * Форма 401. Входящие и исходящие остатки по счетам. Базовый для разделов 1 и 2
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TRests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_biskvitResources;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TRests::getTune"));
    end;

    private macro getDealFilter()
        throw(TPureVirtualMethodCallException("TRests::getDealFilter"));
    end;

    private macro getDealAccounts()
        throw(TPureVirtualMethodCallException("TRests::getDealAccounts"));
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var query = "";

        query = getDealAccounts()
       + "\n" + "SELECT t_nrCode,"
       + "\n" + "       t_currencyCode,"
       + "\n" + "       t_rowCode,"
       + "\n" + "       SUM(t_incomeRest)   AS t_incomeRest,"
       + "\n" + "       SUM(t_outgoingRest) AS t_outgoingRest,"
       + "\n" + "       NULL                AS t_turns,"
       + "\n" + "       NULL                AS t_revaluationTurns,"
       + "\n" + "       NULL                AS t_otherTurns,"
       + "\n" + "       NULL                AS t_interests,"
       + "\n" + "       " + m_biskvitResources.getSelectClause()
       + "\n" + "  FROM (SELECT dealacc.t_nrCode        AS t_nrCode,"
       + "\n" + "               dealacc.t_currencyCode  AS t_currencyCode,"
       + "\n" + "               dealacc.t_rowCode       AS t_rowCode,"
       + "\n" + "               rsb_fiinstr.convSumType(account.t_inRest,"
       + "\n" + "                                       account.t_fiId,"
       + "\n" + "                                   " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                   " + RATETYPE_CB + ","
       + "\n" + "                                   " + getSqlDate(TF401Global().getRcbReport().context.period.beginDate-1)
       + "\n" + "                                      ) AS t_incomeRest,"
       + "\n" + "               rsb_fiinstr.convSumType(account.t_outRest,"
       + "\n" + "                                       account.t_fiId,"
       + "\n" + "                                   " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                   " + RATETYPE_CB + ","
       + "\n" + "                                   " + getSqlDate(TF401Global().getRcbReport().context.period.endDate)
       + "\n" + "                                      ) AS t_outgoingRest,"
       + "\n" + "           " + m_biskvitResources.getDataClause()
       + "\n" + "          FROM dealacc,"
       + "\n" + "               drepaccount_vw account"
       + "\n" + "         WHERE dealacc.t_accountId = account.t_accountId"
       + "\n" + "       ) data"
       + "\n" + m_biskvitResources.getGroupingClause()
              ;

        var dataset = RcbDataset(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("t_nrCode",            V_STRING);
        dataSet.setFieldType("t_currencyCode",      V_STRING);
        dataSet.setFieldType("t_rowCode",           V_STRING);
        dataSet.setFieldType("t_incomeRest",        V_MONEY);
        dataSet.setFieldType("t_outgoingRest",      V_MONEY);
        dataSet.setFieldType("t_turns",             V_MONEY);
        dataSet.setFieldType("t_revaluationTurns",  V_MONEY);
        dataSet.setFieldType("t_otherTurns",        V_MONEY);
        dataSet.setFieldType("t_interests",         V_MONEY);
        m_biskvitResources.setDatasetFieldTypes(dataset);

        m_biskvitResources.saveDetailsParts12(dataset, m_datasources);

        return dataset;
    end;

    private macro constructorTRests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_biskvitResources = TBiskvitResources("account", "dealacc");
    end;

    constructorTRests(id, protocolView, dataSources);
end;

/**
 * Форма 401. Остатки по счетам для раздела 1, строки А3,А5,А6,А18.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А3','А5','А6','А18') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (   account.t_account = deal.t_mainRestAccount"
       + "\n" + "         OR (    account.t_account = deal.t_accruedInterestAccount"
       + "\n" + "             AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "            )"
       + "\n" + "        )"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTRestsPart1Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 1, строки А17.
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TRests) TRestsPart1Rows17(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А17') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        drepaccount_vw           account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE (   rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_costsAcc) = 1"
       + "\n" + "         OR rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_calcOtherIncomePlaceAccount ) = 1"
       + "\n" + "        )"
       + "\n" + "    AND (   account.t_account = msfo.t_costsAcc"
       + "\n" + "         OR account.t_account = msfo.t_calcOtherIncomePlaceAccount"
       + "\n" + "        )"
       + "\n" + "    AND msfo.t_dealId     = deal.t_id"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId    = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart1Rows17(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTRestsPart1Rows17(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 1, строк А15.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А15.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND account.t_account = deal.t_delaydMainRestAcc"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTRestsPart1Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 1, строка А16.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND account.t_account = deal.t_delaydPercentAcc"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTRestsPart1Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 2, строки П1,П3,П4.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П1','П3','П4') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (   account.t_account = deal.t_mainRestAccount"
       + "\n" + "         OR (    account.t_account = deal.t_accruedInterestAccount"
       + "\n" + "             AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "            )"
       + "\n" + "        )"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTRestsPart2Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 2, строк П14.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П14.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND account.t_account = deal.t_delaydMainRestAcc"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTRestsPart2Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 2, строка П15.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRests) TRestsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П15') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        drepaccount_vw account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND account.t_account = deal.t_delaydPercentAcc"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTRestsPart2Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Остатки по счетам для раздела 2, строка П16.
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TRests) TRestsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */DISTINCT"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        account.t_accountId    AS t_accountId,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        drepaccount_vw           account,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE (   rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_paymentsAcc) = 1"
       + "\n" + "         OR rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_otherIncomePlaceAccount ) = 1"
       + "\n" + "        )"
       + "\n" + "    AND (   account.t_account = msfo.t_paymentsAcc"
       + "\n" + "         OR account.t_account = msfo.t_otherIncomePlaceAccount"
       + "\n" + "        )"
       + "\n" + "    AND msfo.t_dealId     = deal.t_id"
       + "\n" + "    AND account.t_chapter = 1"
       + "\n" + "    AND account.t_fiId    = deal.t_fiId"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTRestsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTRestsPart2Rows16(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков в результате операций. Базовый для разделов 1 и 2
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_biskvitResources;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TTurns::getTune"));
    end;

    private macro getDealFilter()
        throw(TPureVirtualMethodCallException("TTurns::getDealFilter"));
    end;

    private macro getDebetSign()
        throw(TPureVirtualMethodCallException("TTurns::getDebetSign"));
    end;

    private macro getCreditSign()
        throw(TPureVirtualMethodCallException("TTurns::getCreditSign"));
    end;

    private macro getDealAccounts()
        throw(TPureVirtualMethodCallException("TTurns::getDealAccounts"));
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var query = "";

        query = getDealAccounts()
       + "\n" + "SELECT t_nrCode,"
       + "\n" + "       t_currencyCode,"
       + "\n" + "       t_rowCode,"
       + "\n" + "       SUM(t_sum)      AS t_turns,"
       + "\n" + "       NULL            AS t_incomeRest,"
       + "\n" + "       NULL            AS t_outgoingRest,"
       + "\n" + "       NULL            AS t_revaluationTurns,"
       + "\n" + "       NULL            AS t_otherTurns,"
       + "\n" + "       NULL            AS t_interests,"
       + "\n" + "   " + m_biskvitResources.getSelectClause()
       + "\n" + "  FROM (SELECT dealacc.t_nrCode,"
       + "\n" + "               dealacc.t_currencyCode,"
       + "\n" + "               dealacc.t_rowCode,"
       + "\n" + "               CASE dealacc.t_account"
       + "\n" + "                   WHEN document.t_debetAccount"
       + "\n" + "                   THEN " + getDebetSign() + "rsb_fiinstr.convSumType(document.t_debetSum,"
       + "\n" + "                                                                      document.t_debetFiId,"
       + "\n" + "                                                                      " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                                      " + RATETYPE_CB + ","
       + "\n" + "                                                                          document.t_date"
       + "\n" + "                                                                     )"
       + "\n" + "                   WHEN document.t_creditAccount"
       + "\n" + "                   THEN " + getCreditSign() + "rsb_fiinstr.convSumType(document.t_creditSum,"
       + "\n" + "                                                                       document.t_creditFiId,"
       + "\n" + "                                                                       " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                                       " + RATETYPE_CB + ","
       + "\n" + "                                                                           document.t_date"
       + "\n" + "                                                                      )"
       + "\n" + "               END AS t_sum,"
       + "\n" + "           " + m_biskvitResources.getDataClause()
       + "\n" + "         FROM dealacc,"
       + "\n" + "              drepdocument_vw document,"
       + "\n" + "              drepaccount_vw account"
       + "\n" + "        WHERE dealacc.t_account = account.t_account"
       + "\n" + "          AND account.t_chapter = 1"
       + "\n" + "          AND (   dealacc.t_account = document.t_debetAccount"
       + "\n" + "               OR dealacc.t_account = document.t_creditAccount"
       + "\n" + "              )"
       + "\n" + "          AND document.t_date BETWEEN " + getSqlDate(TF401Global().getRcbReport().context.period.beginDate)
       + "\n" + "                                  AND " + getSqlDate(TF401Global().getRcbReport().context.period.endDate)
       + "\n" + "          AND document.t_isRevaluation = 0"
       + "\n" + "          AND document.t_isDeltarate = 0"
       + "\n" + "          AND document.t_id NOT IN (SELECT col4doc.t_id"
       + "\n" + "                                      FROM df401documents_tmp col4doc"
       + "\n" + "                                     WHERE col4doc.t_nrCode = dealacc.t_nrCode"
       + "\n" + "                                       AND col4doc.t_currencyCode = dealacc.t_currencyCode"
       + "\n" + "                                       AND col4doc.t_rowCode = dealacc.t_rowCode"
       + "\n" + "                                   )"
       + "\n" + "       ) data"
       + "\n" + m_biskvitResources.getGroupingClause()
              ;

        var dataset = RcbDataset(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("t_nrCode",            V_STRING);
        dataSet.setFieldType("t_currencyCode",      V_STRING);
        dataSet.setFieldType("t_rowCode",           V_STRING);
        dataSet.setFieldType("t_incomeRest",        V_MONEY);
        dataSet.setFieldType("t_outgoingRest",      V_MONEY);
        dataSet.setFieldType("t_turns",             V_MONEY);
        dataSet.setFieldType("t_revaluationTurns",  V_MONEY);
        dataSet.setFieldType("t_otherTurns",        V_MONEY);
        dataSet.setFieldType("t_interests",         V_MONEY);
        m_biskvitResources.setDatasetFieldTypes(dataset);

        m_biskvitResources.saveDetailsParts12(dataset, m_datasources);

        return dataset;
    end;

    private macro constructorTTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_biskvitResources = TBiskvitResources("account", "dealacc");
    end;

    constructorTTurns(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 1, строки А3,А5,А6,А18.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А3','А5','А6','А18') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + " UNION"
       + "\n" + " SELECT deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTTurnsPart1Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 1, строки А15.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А15.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydMainRestAcc   AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTTurnsPart1Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 1, строки А16.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTTurnsPart1Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 1, строки А17.
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TTurns) TTurnsPart1Rows17(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А17') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        msfo.t_costsAcc            AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_costsAcc) = 1"
       + "\n" + "    AND msfo.t_dealId = deal.t_id"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + "  UNION "
       + "\n" + " SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode                      AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode               AS t_currencyCode,"
       + "\n" + "        tune.t_row                         AS t_rowCode,"
       + "\n" + "        msfo.t_calcOtherIncomePlaceAccount AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_calcOtherIncomePlaceAccount ) = 1"
       + "\n" + "    AND msfo.t_dealId = deal.t_id"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTTurnsPart1Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 2, строки П1,П3,П4.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П1','П3','П4') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + " UNION"
       + "\n" + " SELECT deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTTurnsPart2Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 2, строки П14.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П14.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydMainRestAcc   AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTTurnsPart2Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 2, строки П15.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTurns) TTurnsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П15') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTTurnsPart2Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 2, строки П16
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TTurns) TTurnsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE (   rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_paymentsAcc) = 1"
       + "\n" + "         OR rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_otherIncomePlaceAccount ) = 1"
       + "\n" + "        )"
       + "\n" + "    AND msfo.t_dealId = deal.t_id"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTTurnsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTTurnsPart2Rows16(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам. Базовый для разделов 1 и 2
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TOtherTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_biskvitResources;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TOtherTurns::getTune"));
    end;

    private macro getDealFilter()
        throw(TPureVirtualMethodCallException("TOtherTurns::getDealFilter"));
    end;

    private macro getDebetSign()
        throw(TPureVirtualMethodCallException("TOtherTurns::getDebetSign"));
    end;

    private macro getCreditSign()
        throw(TPureVirtualMethodCallException("TOtherTurns::getCreditSign"));
    end;

    private macro getDealAccounts()
        throw(TPureVirtualMethodCallException("TOtherTurns::getDealAccounts"));
    end;

    private macro getDeals()
        throw(TPureVirtualMethodCallException("TOtherTurns::getDeals"));
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        sql_truncate("df401documents_tmp");

        var query = "";

        query = "INSERT INTO df401documents_tmp"
       + "\n" + "("
       + "\n" + "   t_nrCode,"
       + "\n" + "   t_currencyCode,"
       + "\n" + "   t_rowCode,"
       + "\n" + "   t_id,"
       + "\n" + "   t_sum,"
       + "\n" + " " + m_biskvitResources.getInsertClause()
       + "\n" + ")"
       + "\n" + getDealAccounts()
//+ "\n" + ", dacctrn_dbt AS"
//+ "\n" + "(SELECT 21 t_accTrnId, 'R' t_typedocument, 28 t_accountId_payer, 11 t_accountId_receiver FROM DUAL"
//+ "\n" + " UNION ALL SELECT 22, CHR(1), 27, 12 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 23, 'R',    28, 13 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 24, CHR(1), 27, 14 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 25, 'R',    28, 15 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 26, CHR(1), 27, 16 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 27, CHR(1), 29, 17 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 31, 'R',    11, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 32, CHR(1), 12, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 33, 'R',    13, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 34, CHR(1), 14, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 35, 'R',    15, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 36, CHR(1), 16, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 37, CHR(1), 17, 29 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 81, 'R',    28, 11 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 82, CHR(1), 27, 12 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 83, 'R',    28, 13 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 84, CHR(1), 27, 14 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 85, 'R',    28, 15 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 86, CHR(1), 27, 16 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 87, CHR(1), 29, 17 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 91, 'R',    11, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 92, CHR(1), 12, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 93, 'R',    13, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 94, CHR(1), 14, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 95, 'R',    15, 28 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 96, CHR(1), 16, 27 FROM DUAL"
//+ "\n" + " UNION ALL SELECT 97, CHR(1), 17, 29 FROM DUAL"
//+ "\n" + ")"
       + "\n" + "SELECT dealacc.t_nrCode        AS t_nrCode,"
       + "\n" + "       dealacc.t_currencyCode  AS t_currencyCode,"
       + "\n" + "       dealacc.t_rowCode       AS t_rowCode,"
       + "\n" + "       document.t_id           AS t_id,"
       + "\n" + "       CASE dealacc.t_account"
       + "\n" + "           WHEN document.t_debetAccount"
       + "\n" + "           THEN " + getDebetSign() + "rsb_fiinstr.convSumType(document.t_debetSum,"
       + "\n" + "                                                              document.t_debetFiId,"
       + "\n" + "                                                              " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                              " + RATETYPE_CB + ","
       + "\n" + "                                                                  document.t_date"
       + "\n" + "                                                             )"
       + "\n" + "           WHEN document.t_creditAccount"
       + "\n" + "           THEN " + getCreditSign() + "rsb_fiinstr.convSumType(document.t_creditSum,"
       + "\n" + "                                                               document.t_creditFiId,"
       + "\n" + "                                                               " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                               " + RATETYPE_CB + ","
       + "\n" + "                                                                   document.t_date"
       + "\n" + "                                                              )"
       + "\n" + "       END                     AS t_sum,"
       + "\n" + "   " + m_biskvitResources.getDataClause()
       + "\n" + "  FROM dealacc,"
       + "\n" + "       drepdocument_vw document,"
       + "\n" + "       drepaccount_vw account"
       + "\n" + " WHERE dealacc.t_account = account.t_account"
       + "\n" + "   AND account.t_chapter = 1"
       + "\n" + "   AND (   dealacc.t_account = document.t_debetAccount"
       + "\n" + "        OR dealacc.t_account = document.t_creditAccount"
       + "\n" + "       )"
       + "\n" + "   AND document.t_date BETWEEN " + getSqlDate(TF401Global().getRcbReport().context.period.beginDate)
       + "\n" + "                           AND " + getSqlDate(TF401Global().getRcbReport().context.period.endDate)
       + "\n" + "   AND EXISTS (SELECT 1"
       + "\n" + "                 FROM dacctrn_dbt trn"
       + "\n" + "                WHERE trn.t_accTrnId = document.t_id"
       + "\n" + "                  AND (   INSTR(trn.t_typedocument, 'R') != 0"
       + "\n" + "                       OR (   (    dealacc.t_account = document.t_debetAccount"
       + "\n" + "                               AND EXISTS (SELECT 1"
       + "\n" + "                                             FROM drepparty_vw party,"
       + "\n" + "                                                  drepaccount_vw account"
       + "\n" + "                                            WHERE trn.t_accountId_payer = account.t_accountId"
       + "\n" + "                                              AND party.t_id = account.t_contragentId"
       + "\n" + "                                              AND party.t_isResident = 1"
       + "\n" + "                                          )"
       + "\n" + "                              )"
       + "\n" + "                           OR (    dealacc.t_account = document.t_creditAccount"
       + "\n" + "                               AND EXISTS (SELECT 1"
       + "\n" + "                                             FROM drepparty_vw party,"
       + "\n" + "                                                  drepaccount_vw account"
       + "\n" + "                                            WHERE trn.t_accountId_receiver = account.t_accountId"
       + "\n" + "                                              AND party.t_id = account.t_contragentId"
       + "\n" + "                                              AND party.t_isResident = 1"
       + "\n" + "                                          )"
       + "\n" + "                              )"
       + "\n" + "                          )"
       + "\n" + "                      )"
       + "\n" + "              )"
              ;

        sql_execute(query);
        sql_execute("COMMIT");

        query = "INSERT INTO df401documents_tmp"
       + "\n" + "("
       + "\n" + "   t_nrCode,"
       + "\n" + "   t_currencyCode,"
       + "\n" + "   t_rowCode,"
       + "\n" + "   t_id,"
       + "\n" + "   t_sum,"
       + "\n" + " " + m_biskvitResources.getInsertClause()
       + "\n" + ")"
       + "\n" + getDeals()
       + "\n" + "SELECT dealacc.t_nrCode       AS t_nrCode,"
       + "\n" + "       dealacc.t_currencyCode AS t_currencyCode,"
       + "\n" + "       dealacc.t_rowCode      AS t_rowCode,"
       + "\n" + "       document.t_id          AS t_id,"
       + "\n" + "       CASE "
       + "\n" + "           WHEN (    document.t_debetAccount = dealacc.t_mainRestAccount"
       + "\n" + "                 AND document.t_creditAccount = dealacc.t_delaydMainRestAcc"
       + "\n" + "                )"
       + "\n" + "             OR (    document.t_debetAccount = dealacc.t_accruedInterestAccount"
       + "\n" + "                 AND document.t_creditAccount = dealacc.t_delaydPercentAcc"
       + "\n" + "                )"
       + "\n" + "           THEN " + getDebetSign() + "rsb_fiinstr.convSumType(document.t_debetSum,"
       + "\n" + "                                                              document.t_debetCurrencyFiId,"
       + "\n" + "                                                              " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                              " + RATETYPE_CB + ","
       + "\n" + "                                                              document.t_date"
       + "\n" + "                                                             )"
       + "\n" + "           WHEN (    document.t_debetAccount = dealacc.t_delaydMainRestAcc"
       + "\n" + "                 AND document.t_creditAccount = dealacc.t_mainRestAccount"
       + "\n" + "                )"
       + "\n" + "             OR (    document.t_debetAccount = dealacc.t_delaydPercentAcc"
       + "\n" + "                 AND document.t_creditAccount = dealacc.t_accruedInterestAccount"
       + "\n" + "                )"
       + "\n" + "           THEN " + getCreditSign() + "rsb_fiinstr.convSumType(document.t_creditSum,"
       + "\n" + "                                                               document.t_creditCurrencyFiId,"
       + "\n" + "                                                               " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                               " + RATETYPE_CB + ","
       + "\n" + "                                                               document.t_date"
       + "\n" + "                                                              )"
       + "\n" + "       END                 AS t_sum,"
       + "\n" + "   " + m_biskvitResources.getDataClause()
       + "\n" + "  FROM dealacc,"
       + "\n" + "       repMmDealTurnoverHistory_vw document,"
       + "\n" + "       drepaccount_vw account"
       + "\n" + " WHERE document.t_debetAccount = account.t_account"
       + "\n" + "   AND account.t_chapter = 1"
       + "\n" + "   AND document.t_dealId = dealacc.t_id"
       + "\n" + "   AND document.t_date BETWEEN " + getSqlDate(TF401Global().getRcbReport().context.period.beginDate)
       + "\n" + "                           AND " + getSqlDate(TF401Global().getRcbReport().context.period.endDate)
       + "\n" + "   AND (   (    document.t_debetAccount = dealacc.t_mainRestAccount"
       + "\n" + "            AND document.t_creditAccount = dealacc.t_delaydMainRestAcc"
       + "\n" + "           )"
       + "\n" + "        OR (    document.t_debetAccount = dealacc.t_delaydMainRestAcc"
       + "\n" + "            AND document.t_creditAccount = dealacc.t_mainRestAccount"
       + "\n" + "           )"
       + "\n" + "        OR (    document.t_debetAccount = dealacc.t_accruedInterestAccount"
       + "\n" + "            AND document.t_creditAccount = dealacc.t_delaydPercentAcc"
       + "\n" + "           )"
       + "\n" + "        OR (    document.t_debetAccount = dealacc.t_delaydPercentAcc"
       + "\n" + "            AND document.t_creditAccount = dealacc.t_accruedInterestAccount"
       + "\n" + "           )"
       + "\n" + "       )"
              ;

        sql_execute(query);
        sql_execute("COMMIT");

        query = "SELECT t_nrCode,"
       + "\n" + "       t_currencyCode,"
       + "\n" + "       t_rowCode,"
       + "\n" + "       SUM(t_sum)      AS t_otherTurns,"
       + "\n" + "       NULL            AS t_incomeRest,"
       + "\n" + "       NULL            AS t_outgoingRest,"
       + "\n" + "       NULL            AS t_turns,"
       + "\n" + "       NULL            AS t_revaluationTurns,"
       + "\n" + "       NULL            AS t_interests,"
       + "\n" + "   " + m_biskvitResources.getSelectClause()
       + "\n" + "  FROM df401documents_tmp"
       + "\n" + m_biskvitResources.getGroupingClause()
              ;

        var dataset = RcbDataset(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("t_nrCode",            V_STRING);
        dataSet.setFieldType("t_currencyCode",      V_STRING);
        dataSet.setFieldType("t_rowCode",           V_STRING);
        dataSet.setFieldType("t_incomeRest",        V_MONEY);
        dataSet.setFieldType("t_outgoingRest",      V_MONEY);
        dataSet.setFieldType("t_turns",             V_MONEY);
        dataSet.setFieldType("t_revaluationTurns",  V_MONEY);
        dataSet.setFieldType("t_otherTurns",        V_MONEY);
        dataSet.setFieldType("t_interests",         V_MONEY);
        m_biskvitResources.setDatasetFieldTypes(dataset);

        m_biskvitResources.saveDetailsParts12(dataset, m_datasources);

        return dataset;
    end;

    private macro constructorTOtherTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_biskvitResources = TBiskvitResources("account", "dealacc");
    end;

    constructorTOtherTurns(id, protocolView, dataSources);
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 1, строки А3,А5,А6,А18.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А3','А5','А6','А18') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + " UNION"
       + "\n" + " SELECT deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTOtherTurnsPart1Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 1, строки А15.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А15.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTOtherTurnsPart1Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 1, строки А16.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTOtherTurnsPart1Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 1, строки А17.
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TOtherTurns) TOtherTurnsPart1Rows17(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А17') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE (   rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_costsAcc) = 1"
       + "\n" + "         OR rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_calcOtherIncomePlaceAccount ) = 1"
       + "\n" + "        )"
       + "\n" + "    AND msfo.t_dealId = deal.t_id"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE 1=0"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart1Rows17(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTOtherTurnsPart1Rows17(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 2, строки П1,П3,П4.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П1','П3','П4') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount     AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + " UNION"
       + "\n" + " SELECT deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_accruedInterestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTOtherTurnsPart2Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 2, строки П14.1.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П14.1') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_mainRestAccount     AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_delaydMainRestAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTOtherTurnsPart1Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 2, строки П15.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TOtherTurns) TOtherTurnsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П15') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTOtherTurnsPart2Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 2, строки П16
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
private class (TOtherTurns) TOtherTurnsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDealAccounts()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp         deal,"
       + "\n" + "        repMmDealMsfoConcepts_vw msfo,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE (   rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_paymentsAcc) = 1"
       + "\n" + "         OR rsb_mask.compareStringWithMask(tune.t_accountMask, msfo.t_otherIncomePlaceAccount ) = 1"
       + "\n" + "        )"
       + "\n" + "    AND msfo.t_dealId = deal.t_id"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode          AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode   AS t_currencyCode,"
       + "\n" + "        tune.t_row             AS t_rowCode,"
       + "\n" + "        deal.t_id              AS t_id,"
       + "\n" + "        deal.t_mainRestAccount,"
       + "\n" + "        deal.t_delaydMainRestAcc,"
       + "\n" + "        deal.t_accruedInterestAccount,"
       + "\n" + "        deal.t_delaydPercentAcc,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE 1=0"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTOtherTurnsPart2Rows16(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTOtherTurns(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTOtherTurnsPart2Rows16(id, protocolView, dataSources)
end;

/**
 * Форма 401. Начисленные проценты и объявленные дивиденды в отчетном периоде. Базовый для разделов 1 и 2
 *
 * @since 01.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TInterests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_biskvitResources;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TInterests::getTune"));
    end;

    private macro getDealFilter()
        throw(TPureVirtualMethodCallException("TInterests::getDealFilter"));
    end;

    private macro getDebetSign()
        throw(TPureVirtualMethodCallException("TInterests::getDebetSign"));
    end;

    private macro getCreditSign()
        throw(TPureVirtualMethodCallException("TInterests::getCreditSign"));
    end;

    private macro getDeals()
        throw(TPureVirtualMethodCallException("TInterests::getDeals"));
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var query = "";

        query = getDeals()
       + "\n" + "SELECT t_nrCode,"
       + "\n" + "       t_currencyCode,"
       + "\n" + "       t_rowCode,"
       + "\n" + "       SUM(t_sum)      AS t_interests,"
       + "\n" + "       NULL            AS t_incomeRest,"
       + "\n" + "       NULL            AS t_outgoingRest,"
       + "\n" + "       NULL            AS t_turns,"
       + "\n" + "       NULL            AS t_revaluationTurns,"
       + "\n" + "       NULL            AS t_otherTurns,"
       + "\n" + "   " + m_biskvitResources.getSelectClause()
       + "\n" + "  FROM (SELECT dealacc.t_nrCode,"
       + "\n" + "               dealacc.t_currencyCode,"
       + "\n" + "               dealacc.t_rowCode,"
       + "\n" + "               CASE dealacc.t_account"
       + "\n" + "                   WHEN document.t_debetAccount"
       + "\n" + "                   THEN " + getDebetSign() + "rsb_fiinstr.convSumType(document.t_debetSum,"
       + "\n" + "                                                                      document.t_debetCurrencyFiId,"
       + "\n" + "                                                                      " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                                      " + RATETYPE_CB + ","
       + "\n" + "                                                                      document.t_date"
       + "\n" + "                                                                     )"
       + "\n" + "                   WHEN document.t_creditAccount"
       + "\n" + "                   THEN " + getCreditSign() + "rsb_fiinstr.convSumType(document.t_creditSum,"
       + "\n" + "                                                                       document.t_creditCurrencyFiId,"
       + "\n" + "                                                                       " + TF401Global().getUsdFiId() + ","
       + "\n" + "                                                                       " + RATETYPE_CB + ","
       + "\n" + "                                                                       document.t_date"
       + "\n" + "                                                                      )"
       + "\n" + "               END AS t_sum,"
       + "\n" + "           " + m_biskvitResources.getDataClause()
       + "\n" + "         FROM dealacc,"
       + "\n" + "              repMmDealTurnoverHistory_vw document,"
       + "\n" + "              drepaccount_vw account"
       + "\n" + "        WHERE dealacc.t_account = account.t_account"
       + "\n" + "          AND account.t_chapter = 1"
       + "\n" + "          AND dealacc.t_id = document.t_dealId"
       + "\n" + "          AND (   (    dealacc.t_account = document.t_debetAccount"
       + "\n" + "                   AND SUBSTR(document.t_creditAccount, 1, 5) = " + getSqlString("70601")
       + "\n" + "                  )"
       + "\n" + "               OR (    dealacc.t_account = document.t_creditAccount"
       + "\n" + "                   AND SUBSTR(document.t_debetAccount, 1, 5) = " + getSqlString("70601")
       + "\n" + "                  )"
       + "\n" + "              )"
       + "\n" + "          AND document.t_date BETWEEN " + getSqlDate(TF401Global().getRcbReport().context.period.beginDate)
       + "\n" + "                                  AND " + getSqlDate(TF401Global().getRcbReport().context.period.endDate)
       + "\n" + "          AND document.t_id NOT IN (SELECT col4doc.t_id"
       + "\n" + "                                      FROM df401documents_tmp col4doc"
       + "\n" + "                                     WHERE col4doc.t_nrCode = dealacc.t_nrCode"
       + "\n" + "                                       AND col4doc.t_currencyCode = dealacc.t_currencyCode"
       + "\n" + "                                       AND col4doc.t_rowCode = dealacc.t_rowCode"
       + "\n" + "                                   )"
       + "\n" + "       ) data"
       + "\n" + m_biskvitResources.getGroupingClause()
              ;

        var dataset = RcbDataset(query, RSDVAL_SERVER, RSDVAL_FORWARD_ONLY);

        dataSet.setFieldType("t_nrCode",            V_STRING);
        dataSet.setFieldType("t_currencyCode",      V_STRING);
        dataSet.setFieldType("t_rowCode",           V_STRING);
        dataSet.setFieldType("t_incomeRest",        V_MONEY);
        dataSet.setFieldType("t_outgoingRest",      V_MONEY);
        dataSet.setFieldType("t_turns",             V_MONEY);
        dataSet.setFieldType("t_revaluationTurns",  V_MONEY);
        dataSet.setFieldType("t_otherTurns",        V_MONEY);
        dataSet.setFieldType("t_interests",         V_MONEY);
        m_biskvitResources.setDatasetFieldTypes(dataset);

        m_biskvitResources.saveDetailsParts12(dataset, m_datasources);

        return dataset;
    end;

    private macro constructorTInterests(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_biskvitResources = TBiskvitResources("account", "dealacc");
    end;

    constructorTInterests(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 1, строки А3,А5,А6,А18.
 *
 * @since 01.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TInterests) TTInterestsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А3','А5','А6','А18') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_id                      AS t_id,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTInterestsPart1Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTInterests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTInterestsPart1Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 1, строки А16.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TInterests) TTInterestsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 1 AND tune.t_row = ANY ('А16') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_PLACEMENT);
    end;

    private macro getDebetSign()
        return "+";
    end;

    private macro getCreditSign()
        return "-";
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_id                  AS t_id,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTInterestsPart1Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTInterests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 1"));
    end;

    constructorTInterestsPart1Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Изменение остатков по счетам в результате операций для раздела 2, строки П1,П3,П4.
 *
 * @since 01.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TInterests) TTInterestsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П1','П3','П4') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode                  AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode           AS t_currencyCode,"
       + "\n" + "        tune.t_row                     AS t_rowCode,"
       + "\n" + "        deal.t_id                      AS t_id,"
       + "\n" + "        deal.t_accruedInterestAccount  AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_accountMask, deal.t_mainRestAccount) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTInterestsPart2Rows1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTInterests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTInterestsPart2Rows1(id, protocolView, dataSources)
end;

/**
 * Форма 401. Прочие изменения остатков по счетам для раздела 2, строки П15.
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TInterests) TTInterestsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getTune()
        var tune = TF401Global().getTune();
        tune.setUserFilter("tune.t_part = 2 AND tune.t_row = ANY ('П15') AND tune.t_backoffice = " + BOIBC);
        return tune;
    end;

    private macro getDealFilter()
        return "UPPER(deal.t_kind) = " + getSqlString(DEAL_KIND_ATTRACTION);
    end;

    private macro getDebetSign()
        return "-";
    end;

    private macro getCreditSign()
        return "+";
    end;

    private macro getDeals()
        var query = "";

        query = "WITH dealacc AS"
       + "\n" + "(SELECT /*+ MATERIALIZE */"
       + "\n" + "        deal.t_nrCode              AS t_nrCode,"
       + "\n" + "        deal.t_fiNumericCode       AS t_currencyCode,"
       + "\n" + "        tune.t_row                 AS t_rowCode,"
       + "\n" + "        deal.t_id                  AS t_id,"
       + "\n" + "        deal.t_delaydPercentAcc    AS t_account,"
       + "\n" + "    " + m_biskvitResources.getNrCodePartsClause()
       + "\n" + "   FROM df401mmdeals_tmp deal,"
       + "\n" + "        (" + getTune().getQuery()
       + "\n" + "        ) tune"
       + "\n" + "  WHERE rsb_mask.compareStringWithMask(tune.t_interestAccountMask, deal.t_delaydPercentAcc) = 1"
       + "\n" + "    AND (" + getDealFilter()
       + "\n" + "        )"
       + "\n" + ")";

        return query;
    end;

    private macro constructorTInterestsPart2Rows3(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTInterests(id, protocolView, dataSources);
        m_biskvitResources.setBiskvitExactDatasource(datasources.getDatasource("biskvitExact part 2"));
    end;

    constructorTInterestsPart2Rows3(id, protocolView, dataSources)
end;

/**
 * Форма 401. Строки (атрибуты) из коллекции атрибутов раздела с фильтрацией по коду строки. Базовый для разделов 1 и 2
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TRows(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_container;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TRows::getTune"));
    end;

    private macro in(value, set)
        for (var i, set)
            if (i == value)
                return true;
            end;
        end;
        return false;
    end;

    macro moveFirst() : Bool
        m_container.moveFirst();
    end;

    macro moveNext() : Bool
        var tune = getTune();
        var result = m_container.moveNext();
        while (result and not in(m_container.getCurrentItem().getValue().getRowCode(), tune))
            result = m_container.moveNext();
        end;
        return result;
    end;

    macro value(fieldName) : Variant
        fieldName = substr(fieldName, 3);
        var fieldValue = m_container.getCurrentItem().getValue().get(fieldName);
        var exact = null;

        if (fieldValue == null)
            exact = null;
        elif (valType(fieldValue) == V_GENOBJ)
            exact = fieldValue.exact;
        else
            exact = fieldValue;
        end;

        return exact;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        m_container = RcbArray();
        for (var attr, attribute.getPart().getAttributes())
            m_container.push_back(attr);
        end;
        m_container.moveFirst();
        return this;
    end;

    private macro constructorTRows(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTRows(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков в результате переоценки. Базовый для разделов 1 и 2
 *
 * @since 11.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRows) TRevaluationTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro value(fieldName) : Variant
        fieldName = strupr(substr(fieldName, 3));

        if (fieldName == "NRCODE")
            return value("t_nrCode");
        end;

        if (fieldName == "CURRENCYCODE")
            return value("t_currencyCode");
        end;

        if (fieldName == "ROWCODE")
            return value("t_rowCode");
        end;

        if (fieldName == "REVALUATIONTURNS")
            var outgoingRest = value("t_outgoingRest") ;
            var incomeRest = value("t_incomeRest");
            var turns = value("t_turns");
            var otherTurns = value("t_otherTurns");
            if ((outgoingRest != null) and (incomeRest != null) and (turns != null) and (otherTurns != null))
                return outgoingRest - incomeRest - turns - otherTurns;
            end;
        end;

        return null;
    end;

    private macro constructorTRevaluationTurns(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRows(id, protocolView, dataSources);
    end;

    constructorTRevaluationTurns(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков в результате переоценки. Раздел 1, все автоматизированные строки, кроме А15, А30, А50
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRevaluationTurns) TRevaluationTurnsPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTRevaluationTurnsPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRevaluationTurns(id, protocolView, dataSources);
        m_tune = RcbArray();
        var filterData = RcbArray().init("А15", "А30", "А50");
        for (var rowData, TF401Part1RowsData())
            if (in(rowData.code, filterData) or not rowData.isAutomated)
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTRevaluationTurnsPart1(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков в результате переоценки. Раздел 1, строка А50
 *
 * @since 15.02.2019
 * @author MFB
 * @version 6.20.031.055
 */
private class (TRevaluationTurns) TTotalRevaluationTurnsPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTTotalRevaluationTurnsPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRevaluationTurns(id, protocolView, dataSources);
        m_tune = RcbArray().init("А50");
    end;

    constructorTTotalRevaluationTurnsPart1(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков в результате переоценки. Раздел 2, все автоматизированные строки, кроме П14, П30, П50
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRevaluationTurns) TRevaluationTurnsPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTRevaluationTurnsPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRevaluationTurns(id, protocolView, dataSources);
        m_tune = RcbArray();
        var filterData = RcbArray().init("П14", "П30", "П50");
        for (var rowData, TF401Part2RowsData())
            if (in(rowData.code, filterData) or not rowData.isAutomated)
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTRevaluationTurnsPart2(id, protocolView, dataSources);
end;

/**
 * Форма 401. Изменение остатков в результате переоценки. Раздел 2, строка П50
 *
 * @since 15.02.2019
 * @author MFB
 * @version 6.20.031.055
 */
private class (TRevaluationTurns) TTotalRevaluationTurnsPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTTotalRevaluationTurnsPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRevaluationTurns(id, protocolView, dataSources);
        m_tune = RcbArray().init("П50");
    end;

    constructorTTotalRevaluationTurnsPart2(id, protocolView, dataSources);
end;

/**
 * Форма 401. Начисленные проценты для раздела 1, строка А15.1.
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRows) TTInterestsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    macro value(fieldName) : Variant
        fieldName = strupr(substr(fieldName, 3));

        if (fieldName == "NRCODE")
            return value("t_nrCode");
        end;

        if (fieldName == "CURRENCYCODE")
            return value("t_currencyCode");
        end;

        if (fieldName == "ROWCODE")
            return value("t_rowCode");
        end;

        if (fieldName == "INTERESTS")
            return $0;
        end;

        return null;
    end;

    private macro constructorTInterestsPart1Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRows(id, protocolView, dataSources);
        m_tune = RcbArray().init("А15.1");
    end;

    constructorTInterestsPart1Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Начисленные проценты для раздела 2, строка П14.1.
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TRows) TTInterestsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    macro value(fieldName) : Variant
        fieldName = strupr(substr(fieldName, 3));

        if (fieldName == "NRCODE")
            return value("t_nrCode");
        end;

        if (fieldName == "CURRENCYCODE")
            return value("t_currencyCode");
        end;

        if (fieldName == "ROWCODE")
            return value("t_rowCode");
        end;

        if (fieldName == "INTERESTS")
            return $0;
        end;

        return null;
    end;

    private macro constructorTInterestsPart2Rows2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTRows(id, protocolView, dataSources);
        m_tune = RcbArray().init("П14.1");
    end;

    constructorTInterestsPart2Rows2(id, protocolView, dataSources)
end;

/**
 * Форма 401. Итоговая строка. Базовый для разделов 1 и 2
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TTotalRow(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_container;
    private var m_rowCode;

    private macro getTune()
        throw(TPureVirtualMethodCallException("TRows::getTune"));
    end;

    private macro in(value, set)
        for (var i, set)
            if (i == value)
                return true;
            end;
        end;
        return false;
    end;

    macro moveFirst() : Bool
        m_container.moveFirst();
    end;

    macro moveNext() : Bool
        return m_container.moveNext();
    end;

    macro value(fieldName) : Variant
        fieldName = substr(fieldName, 3);

        var fieldValue = m_container.getCurrentItem().get(fieldName);
        var exact = null;

        if (fieldValue == null)
            exact = null;
        elif (valType(fieldValue) == V_GENOBJ)
            exact = fieldValue.exact;
        else
            exact = fieldValue;
        end;

        return exact;
    end;

    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Object
        var tune = getTune();

        m_container = RcbArray();
        var nrCode = null;
        var currencyCode = null;
        var rowCode = null;
        var incomeRest = null;
        var turns = null;
        var revaluationTurns = null;
        var otherTurns = null;
        var outgoingRest = null;
        var interests = null;

        for (var row, attribute.getPart().getAttributes(true))
            var value = row.getValue();
            if (not in(value.getRowCode(), tune))
                continue;
            end;
            if (   (nrCode != value.getNrCode())
                or (currencyCode != value.getCurrencyCode())
               )
                if (nrCode != null)
                    m_container.push_back(objectFactoryInstance.createStandaloneAttributeValue(attribute.getPart(), nrCode, currencyCode, m_rowCode, incomeRest, turns, revaluationTurns, otherTurns, outgoingRest, interests));
                end;
                nrCode = value.getNrCode();
                currencyCode = value.getCurrencyCode();
                rowCode = value.getRowCode();
                incomeRest = null;
                turns = null;
                revaluationTurns = null;
                otherTurns = null;
                outgoingRest = null;
                interests = null;
            end;
            if ((value.getIncomeRest() != null) and (value.getIncomeRest().exact != null))
                incomeRest = nvl(incomeRest, $0) + value.getIncomeRest().exact;
            end;
            if ((value.getTurns() != null) and (value.getTurns().exact != null))
                turns = nvl(turns, $0) + value.getTurns().exact;
            end;
            if ((value.getRevaluationTurns() != null) and (value.getRevaluationTurns().exact != null))
                revaluationTurns = nvl(revaluationTurns, $0) + value.getRevaluationTurns().exact;
            end;
            if ((value.getOtherTurns() != null) and (value.getOtherTurns().exact != null))
                otherTurns = nvl(otherTurns, $0) + value.getOtherTurns().exact;
            end;
            if ((value.getOutgoingRest() != null) and (value.getOutgoingRest().exact != null))
                outgoingRest = nvl(outgoingRest, $0) + value.getOutgoingRest().exact;
            end;
            if ((value.getInterests() != null) and (value.getInterests().exact != null))
                interests = nvl(interests, $0) + value.getInterests().exact;
            end;
        end;
        if (nrCode != null)
            m_container.push_back(objectFactoryInstance.createStandaloneAttributeValue(attribute.getPart(), nrCode, currencyCode, m_rowCode, incomeRest, turns, revaluationTurns, otherTurns, outgoingRest, interests));
        end;
        m_container.moveFirst();
        return this;
    end;

    private macro constructorTTotalRow(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
        m_rowCode = null;
    end;

    constructorTTotalRow(id, protocolView, dataSources);
end;

/**
 * Форма 401. Строка А15
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTotalRow) TRow_A15(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTRow_A15(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTotalRow(id, protocolView, dataSources);
        m_rowCode = "А15";
        //все автоматизированные А15.*
        m_tune = RcbArray();
        for (var rowData, TF401Part1RowsData())
            if (not rowData.isAutomated or (index(rowData.code, "15.") == 0))
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTRow_A15(id, protocolView, dataSources);
end;


/**
 * Форма 401. Строка П14
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTotalRow) TRow_P14(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTRow_P14(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTotalRow(id, protocolView, dataSources);
        //все автоматизированные П14.*
        m_rowCode = "П14";
        m_tune = RcbArray();
        for (var rowData, TF401Part2RowsData())
            if (not rowData.isAutomated or (index(rowData.code, "14.") == 0))
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTRow_P14(id, protocolView, dataSources);
end;

/**
 * Форма 401. Итоговая строка. Раздел 1
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTotalRow) TTotalRowPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTTotalRowPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTotalRow(id, protocolView, dataSources);
        m_rowCode = "А50";
        //все автоматизированные, кроме А15.*, А30, А50
        var filterData = RcbArray().init("А30", "А50");
        m_tune = RcbArray();
        for (var rowData, TF401Part1RowsData())
            if (not rowData.isAutomated or (index(rowData.code, "15.") != 0) or in(rowData.code, filterData))
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTTotalRowPart1(id, protocolView, dataSources);
end;

/**
 * Форма 401. Итоговая строка. Раздел 2
 *
 * @since 12.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (TTotalRow) TTotalRowPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private var m_tune;

    private macro getTune()
        return m_tune;
    end;

    private macro constructorTTotalRowPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTTotalRow(id, protocolView, dataSources);
        m_rowCode = "П50";
        //все автоматизированные, кроме П14.*, П30, П50
        var filterData = RcbArray().init("П30", "П50");
        m_tune = RcbArray();
        for (var rowData, TF401Part2RowsData())
            if (not rowData.isAutomated or (index(rowData.code, "14.") != 0) or in(rowData.code, filterData))
                continue;
            end;
            m_tune.push_back(rowData.code);
        end;
    end;

    constructorTTotalRowPart2(id, protocolView, dataSources);
end;

/**
 * Форма 401. E-mail исполнителя
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class (RcbDataSource) TExecutorEmail(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : String
        var attributeValue = TF401Global().getRcbReport().attributeValue("Email_Исполнителя");
        var value;

        if (attributeValue.isDefined())
            value = attributeValue.currentAsString;
        else
            value = "";
        end;

        return value;
    end;

    private macro constructorTExecutorEmail(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTExecutorEmail(id, protocolView, dataSources);
end;

/**
 * Форма 401. Количество листов
 *
 * @since 20.09.2018
 * @author ABP
 * @version 6.20.031.054
 */
private class TSheetsAmountSorter()
    macro isLess(val1, val2)
        return (val1.fieldValue("nrCode").exact+val1.fieldValue("currencyCode").exact) < (val2.fieldValue("nrCode").exact+val2.fieldValue("currencyCode").exact);
    end;
end;

private class TSheetsAmountFilter(rowCode)
    private var m_rowCode = rowCode;

    private macro isNotZero(value, name)
        return (value.fieldValue(name).isDefined() and value.fieldValue(name).current != $0)
    end;

    macro isSuitable(val)
        return (val.fieldValue("rowCode").exact == m_rowCode)
           and (   isNotZero(val, "incomeRest")
                or isNotZero(val, "turns")
                or isNotZero(val, "revaluationTurns")
                or isNotZero(val, "otherTurns")
                or isNotZero(val, "outgoingRest")
                or isNotZero(val, "interests")
              )
             ;
    end;
end;

private class (RcbDataSource) TSheetsAmount(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    macro getData(filter : RcbDataSourceFilter, attribute : RcbAttributeBase, description : String) : Integer
        macro isNotZero(value, name)
            return (value.fieldValue(name).isDefined() and value.fieldValue(name).current != $0)
        end;

        var sheetsCount = 1; // как минимум есть титульный лист

        var it;
        for (var part, RcbArray().init(RcbArray().init("Раздел_1_по_4212У","А50"), RcbArray().init("Раздел_2_по_4212У","П50")))
            it = TF401Global().getRcbReport().attributeValue(part[0]).createValueIterator();
            it.setFilter(TSheetsAmountFilter(part[1]));
            it.setSortOrder(TSheetsAmountSorter());
            var prevHash = null;
            it.moveFirst();
            while (not it.isDone())
                if (prevHash != (it.currentItem.fieldValue("nrCode").exact+it.currentItem.fieldValue("currencyCode").exact))
                    sheetsCount = sheetsCount + 1;
                    prevHash = it.currentItem.fieldValue("nrCode").exact+it.currentItem.fieldValue("currencyCode").exact;
                end;
                it.moveNext();
            end;
        end;

        var isPart3Empty = true;
        var value;
        it = TF401Global().getRcbReport().attributeValue("Подраздел_3.1_по_4927У").createValueIterator();
        it.moveFirst();
        while (not it.isDone() and isPart3Empty)
            value = it.currentItem;
            isPart3Empty = not(   isNotZero(value, "incomeRest")
                               or isNotZero(value, "turns")
                               or isNotZero(value, "revaluationTurns")
                               or isNotZero(value, "otherTurns")
                               or isNotZero(value, "outgoingRest")
                               or isNotZero(value, "rtGroup2IncomeRest")
                               or isNotZero(value, "rtGroup2Turns")
                               or isNotZero(value, "rtGroup2RevaluationTurns")
                               or isNotZero(value, "rtGroup2OtherTurns")
                               or isNotZero(value, "rtGroup2OutgoingRest")
                               or isNotZero(value, "stockOptionReceived")
                               or isNotZero(value, "stockOptionPaid")
                              );
            it.moveNext();
        end;

        if (isPart3Empty)
            it = TF401Global().getRcbReport().attributeValue("Подраздел_3.2_по_4927У").createValueIterator();
            it.moveFirst();
            while (not it.isDone() and isPart3Empty)
                value = it.currentItem;
                isPart3Empty = not(   isNotZero(value, "incomeRest")
                                   or isNotZero(value, "turns")
                                   or isNotZero(value, "revaluationTurns")
                                   or isNotZero(value, "otherTurns")
                                   or isNotZero(value, "outgoingRest")
                                   or isNotZero(value, "rtGroup2IncomeRest")
                                   or isNotZero(value, "rtGroup2Turns")
                                   or isNotZero(value, "rtGroup2RevaluationTurns")
                                   or isNotZero(value, "rtGroup2OtherTurns")
                                   or isNotZero(value, "rtGroup2OutgoingRest")
                                  );
                it.moveNext();
            end;
        end;

        if (not isPart3Empty)
            sheetsCount = sheetsCount + 1;
        end;

        return sheetsCount;
    end;

    private macro constructorTSheetsAmount(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTSheetsAmount(id, protocolView, dataSources);
end;

/**
 * Форма 401. Наименования строк таблиц разделов
 *
 * @since 01.02.2019
 * @author MFB
 * @version 6.20.031.054
 */
 private class (RcbDataSource) TRowCaptionsDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)

    private macro getResource(partId)
        if   (partId == TF401Global().getPart1Id())
            return TF401Part1RowsData();
        elif (partId == TF401Global().getPart2Id())
            return TF401Part2RowsData();
        else
            return null;
        end;
    end;

    macro getData(partId, rowNumber) : String
        var result = "Undefined";
        var resource = getResource(partId);
        var rowDataArray : RcbArray;
        if(resource != null)
            rowDataArray = resource;
            rowDataArray.moveFirst();
            while(rowDataArray.moveNext())
                if(rowDataArray.getCurrentItem.code == rowNumber)
                    result = rowDataArray.getCurrentItem.name;
                end;
            end;
            return result;
        end;
    end;

    private macro constructorTRowCaptionsDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTRowCaptionsDataSource(id, protocolView, dataSources);
end;

/**
 * Форма 401. Контейнер ИД
 *
 * @since 02.10.2018
 * @author ABP
 * @version 6.20.031.054
 */
class (RcbDataSources) TF401DataSources_4212(protocolView : RcbCalculateProtocolView)
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(TExecutorEmail("executorEmail", null, this));
        m_dataSourcePool.push_back(TMmDeals("deals", null, this));
        m_dataSourcePool.push_back(TSheetsAmount("sheets amount", null, this));
        m_dataSourcePool.push_back(TRowCaptionsDataSource("RowCaptions", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 1", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart1("biskvitScaled part 1", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart1("sec attributes part 1", null, this));
        m_dataSourcePool.push_back(TAttributesPart1("attributes part 1", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows1("p1c1,5r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows2("p1c1,5r15.1", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows3("p1c1,5r16", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows1("p1c2r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows2("p1c2r15.1", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows3("p1c2r16", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows1("p1c4r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows2("p1c4r15.1", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows3("p1c4r16", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows1("p1c6r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows2("p1c6r15.1", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows3("p1c6r16", null, this));
        m_dataSourcePool.push_back(TRevaluationTurnsPart1("p1c3r_automated", null, this));
        m_dataSourcePool.push_back(TTotalRevaluationTurnsPart1("p1c3r50", null, this));
        m_dataSourcePool.push_back(TRow_A15("p1c1-6r15", null, this));
        m_dataSourcePool.push_back(TTotalRowPart1("p1c1,2,4,5,6r50", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 2", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart2("biskvitScaled part 2", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart2("sec attributes part 2", null, this));
        m_dataSourcePool.push_back(TAttributesPart2("attributes part 2", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows1("p2c1,5r1,3,4", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows2("p2c1,5r14.1", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows3("p2c1,5r15", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows1("p2c2r1,3,4", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows2("p2c2r14.1", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows3("p2c2r15", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows1("p2c4r1,3,4", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows2("p2c4r14.1", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows3("p2c4r15", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows1("p2c6r1,3,4", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows2("p2c6r14.1", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows3("p2c6r15", null, this));
        m_dataSourcePool.push_back(TRevaluationTurnsPart2("p2c3r_automated", null, this));
        m_dataSourcePool.push_back(TTotalRevaluationTurnsPart2("p2c3r50", null, this));
        m_dataSourcePool.push_back(TRow_P14("p2c1-6r14", null, this));
        m_dataSourcePool.push_back(TTotalRowPart2("p2c1,2,4,5,6r50", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 3.1", null, this));
        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 3.2", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart31("biskvitScaled part 3.1", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart32("biskvitScaled part 3.2", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart31("sec attributes part 3.1", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart32("sec attributes part 3.2", null, this));
    end;

    private macro constructorTF401DataSources_4212(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorTF401DataSources_4212(protocolView);
end;

/**
 * Форма 401. Контейнер ИД
 *
 * @since   16.08.2019
 * @author  const1995
 * @version 6.20.031.053
 */
class (RcbDataSources) TF401DataSources_16_MP(protocolView : RcbCalculateProtocolView)
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(TExecutorEmail("executorEmail", null, this));
        m_dataSourcePool.push_back(TMmDeals("deals", null, this));
        m_dataSourcePool.push_back(TSheetsAmount("sheets amount", null, this));
        m_dataSourcePool.push_back(TRowCaptionsDataSource("RowCaptions", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 1", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart1("biskvitScaled part 1", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart1("sec attributes part 1", null, this));
        m_dataSourcePool.push_back(TAttributesPart1("attributes part 1", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows1("p1c1,5r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows17("p1c1,5r17", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows2("p1c1,5r15.1", null, this));
        m_dataSourcePool.push_back(TRestsPart1Rows3("p1c1,5r16", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows1("p1c2r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows2("p1c2r15.1", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows3("p1c2r16", null, this));
        m_dataSourcePool.push_back(TTurnsPart1Rows17("p1c2r17", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows1("p1c4r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows2("p1c4r15.1", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows3("p1c4r16", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart1Rows17("p1c4r17", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows1("p1c6r3,5,6,18", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows2("p1c6r15.1", null, this));
        m_dataSourcePool.push_back(TTInterestsPart1Rows3("p1c6r16", null, this));
        m_dataSourcePool.push_back(TRevaluationTurnsPart1("p1c3r_automated", null, this));
        m_dataSourcePool.push_back(TTotalRevaluationTurnsPart1("p1c3r50", null, this));
        m_dataSourcePool.push_back(TRow_A15("p1c1-6r15", null, this));
        m_dataSourcePool.push_back(TTotalRowPart1("p1c1,2,4,5,6r50", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 2", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart2("biskvitScaled part 2", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart2("sec attributes part 2", null, this));
        m_dataSourcePool.push_back(TAttributesPart2("attributes part 2", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows1("p2c1,5r1,3,4", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows2("p2c1,5r14.1", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows3("p2c1,5r15", null, this));
        m_dataSourcePool.push_back(TRestsPart2Rows16("p2c1,5r16", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows1("p2c2r1,3,4", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows2("p2c2r14.1", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows3("p2c2r15", null, this));
        m_dataSourcePool.push_back(TTurnsPart2Rows16("p2c2r16", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows1("p2c4r1,3,4", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows2("p2c4r14.1", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows3("p2c4r15", null, this));
        m_dataSourcePool.push_back(TOtherTurnsPart2Rows16("p2c4r16", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows1("p2c6r1,3,4", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows2("p2c6r14.1", null, this));
        m_dataSourcePool.push_back(TTInterestsPart2Rows3("p2c6r15", null, this));
        m_dataSourcePool.push_back(TRevaluationTurnsPart2("p2c3r_automated", null, this));
        m_dataSourcePool.push_back(TTotalRevaluationTurnsPart2("p2c3r50", null, this));
        m_dataSourcePool.push_back(TRow_P14("p2c1-6r14", null, this));
        m_dataSourcePool.push_back(TTotalRowPart2("p2c1,2,4,5,6r50", null, this));

        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 3.1", null, this));
        m_dataSourcePool.push_back(TBiskvitExactData("biskvitExact part 3.2", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart31("biskvitScaled part 3.1", null, this));
        m_dataSourcePool.push_back(TBiskvitScaledDataPart32("biskvitScaled part 3.2", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart31("sec attributes part 3.1", null, this));
        m_dataSourcePool.push_back(TAttributesSecPart32("sec attributes part 3.2", null, this));
    end;

    private macro constructorTF401DataSources_16_MP(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorTF401DataSources_16_MP(protocolView);
end;
