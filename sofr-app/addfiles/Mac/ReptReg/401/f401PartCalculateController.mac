/*
$Name:          f401PartCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 401. Классы контроллеров расчета разделов.
*/

//Рассчитываемые атрибуты для контроллера расчета отчета - это конкретные графы для группы строк из раздела отчета.
private class (RcbPartCalculateController) TF401PartCalculateController(reportCalculateController : Object, partId : String)
    private var m_protocolView;
    private var m_dataProtocolView;
    private var m_fieldNamesList;

    private macro setAttributeValues(attributeValue : Object, value : Object)
        for (var name, m_fieldNamesList)
            if (value.value("t_"+name) != null)
                attributeValue.set(name, value.value("t_"+name));
            end;
        end;
    end;

    macro getDataProtocolView()
        return m_dataProtocolView;
    end;

    private macro makeAttributeId(data, staticAttribute)
        return null;
    end;

    macro calculateAttribute(attributeId, calcAttribute)
        var staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        var data = m_datasources.getDatasource(attributeId).getData(null, calcAttribute, "");
        while (data.moveNext())
            var id = makeAttributeId(data, staticAttribute);
            var attribute = m_part.getAttribute(id);
            if (attribute != null)
                setAttributeValues(attribute.getValue(), data);
            end;
        end;
    end;

    private macro createAttributes(data)
        var staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        while (data.moveNext())
            var nrCode = data.nrCode;
            var currencyCode = data.currencyCode;
            var rowCode = data.rowCode;
            var rowIndex = data.rowIndex;
            var id = makeAttributeId(data, staticAttribute);

            message("Создание атрибутов");

            var attributeValue;
            var attribute = m_part.getAttribute(id);
            var name;
            if (attribute != null)
                if (data.isAutomated)
                    attributeValue = attribute.getValue();
                    for (name, m_fieldNamesList)
                        attributeValue.set(name, nvl(data.value("t_"+name), $0) + nvl(attributeValue.get(name).exact, $0));
                    end;
                end;
            else
                var storage = m_part.getPartCompositeValue().addValue();
                attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setNrCode(nrCode).setCurrencyCode(currencyCode).setRowCode(rowCode);
                var attributeProperties = objectFactoryInstance.createAttributeProperties(m_part, storage).setRowIndex(rowIndex);
                for (name, m_fieldNamesList)
                    attributeValue.set(name, data.value("t_"+name));
                end;
                m_part.addAttribute(id, attributeValue, attributeProperties);
            end;
        end;
    end;

    private macro getCalculateAttributeData(attributeId : String, functionName : String, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(RcbAttributeBase(dependencesAttributeIdPool.getCurrentItem(), m_part, null));
        end;

        var attribute = RcbAttributeBase(attributeId, m_part, null);
        return RcbCalculationAttributeData(attribute,
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(attributeId, attribute)
                                                                                   )
                                                                ),
                                           RcbDependencesData(dependencesAttributePool)
                                          );
    end;

    private macro isPartTotalRow(rowCode)
        throw(TPureVirtualMethodCallException("TF401PartCalculateController::isPartTotalRow"));
    end;

    macro deleteZeroDealAttributes()
        var zeroDealArray = RcbArray();
        for (var attribute, m_part.getAttributes())
            var value = attribute.getValue();
            if (isPartTotalRow(value.getRowCode()))
                if (value.isZero())
                    zeroDealArray.push_back(RcbArray().initialize(value.getNrCode(), value.getCurrencyCode()));
                end;
            end;
        end;

        var cleanAttributes = RcbArray();
        for (attribute, m_part.getAttributes())
            var isZero = false;
            zeroDealArray.moveFirst();
            while (zeroDealArray.moveNext())
                if((attribute.getValue().getNrCode()       == zeroDealArray.getCurrentItem()[0] ) and
                   (attribute.getValue().getCurrencyCode() == zeroDealArray.getCurrentItem()[1] ))
                   isZero = true;
                   break;
                end;
            end;

            if (isZero)
                attribute.removeStorage();
            else
                cleanAttributes.push_back(attribute);
            end;
        end;

        m_part.clear();
        cleanAttributes.moveFirst();
        while (cleanAttributes.moveNext())
            var newAttribute = cleanAttributes.getCurrentItem();
            m_part.addAttribute(newAttribute.getId(), newAttribute.getValue(), newAttribute.getProperties());
        end;
    end;

    macro getBisExactData()
        throw(TPureVirtualMethodCallException("TF401PartCalculateController::getBisExactData"));
    end;

    private macro constructorTF401PartCalculateController(reportCalculateController : Object, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_protocolView = m_dataSources.getProtocolView();
    end;

    constructorTF401PartCalculateController(reportCalculateController, partId);
end;

class (TF401PartCalculateController) TF401Part1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    private macro makeAttributeId(data, staticAttribute)
        if (staticAttribute == null)
            staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        end;
        return staticAttribute.makeId(data.value("t_nrCode"), data.value("t_currencyCode"), data.value("t_rowCode"));
    end;

    private macro prepareCalculationData()
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r3,5,6,18", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r15.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r16", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r3,5,6,18", "calculateAttribute", RcbArray().init("p1c4r3,5,6,18")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r15.1", "calculateAttribute", RcbArray().init("p1c4r15.1")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r16", "calculateAttribute", RcbArray().init("p1c4r16")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r3,5,6,18", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r15.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r16", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r3,5,6,18", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r15.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r16", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1-6r15", "calculateAttribute", RcbArray().init("p1c1,5r15.1", "p1c2r15.1", "p1c4r15.1", "p1c6r15.1", "p1c3r_automated")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c3r_automated",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p1c1,5r3,5,6,18",
                                                                                                          "p1c1,5r15.1",
                                                                                                          "p1c1,5r16",
                                                                                                          "p1c2r3,5,6,18",
                                                                                                          "p1c2r15.1",
                                                                                                          "p1c2r16",
                                                                                                          "p1c4r3,5,6,18",
                                                                                                          "p1c4r15.1",
                                                                                                          "p1c4r16"
                                                                                                         )
                                                                                         )
                                                               );
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c3r50", "calculateAttribute", RcbArray().init("p1c1,2,4,5,6r50")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,2,4,5,6r50",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p1c1,5r3,5,6,18",
                                                                                                          "p1c1,5r16",
                                                                                                          "p1c2r3,5,6,18",
                                                                                                          "p1c2r16",
                                                                                                          "p1c4r3,5,6,18",
                                                                                                          "p1c4r16",
                                                                                                          "p1c6r3,5,6,18",
                                                                                                          "p1c6r16",
                                                                                                          "p1c1-6r15"
                                                                                                         )
                                                                                         )
                                                               );
    end;

    private macro isPartTotalRow(rowCode)
        return (rowCode == "А50");
    end;

    macro getBisExactData()
        return m_datasources.getDatasource("biskvitExact part 1").getData();
    end;

    macro execute()
//        m_protocolView.printLine("");
        if (TF401Settings().isUseSecuritiesData())
            createAttributes(m_datasources.getDatasource("sec attributes part 1").getData());
        end;
        createAttributes(m_datasources.getDatasource("attributes part 1").getData());
        prepareCalculationData();
//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF401Part1CalculateController(reportCalculateController : Object)
        initTF401PartCalculateController(reportCalculateController, TF401Global().getPart1Id());

        m_fieldNamesList = RcbArray().init("incomeRest",
                                           "turns",
                                           "revaluationTurns",
                                           "otherTurns",
                                           "outgoingRest",
                                           "interests"
                                          );

        m_dataProtocolView = m_protocolView.getDataProtocolView("part1");
    end;

    constructorTF401Part1CalculateController(reportCalculateController);
end;

class (TF401Part1CalculateController) TF401Part1CalculateController_16_MP(reportCalculateController : Object /*TReportCalculateController*/)
    private macro prepareCalculationData()
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r3,5,6,18", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r17",       "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r15.1",     "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,5r16",       "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r3,5,6,18",   "calculateAttribute", RcbArray().init("p1c4r3,5,6,18")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r15.1",       "calculateAttribute", RcbArray().init("p1c4r15.1")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r16",         "calculateAttribute", RcbArray().init("p1c4r16")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c2r17",         "calculateAttribute", RcbArray().init("p1c4r17")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r3,5,6,18",   "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r15.1",       "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r16",         "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c4r17",         "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r3,5,6,18",   "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r15.1",       "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c6r16",         "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1-6r15",       "calculateAttribute", RcbArray().init("p1c1,5r15.1", "p1c2r15.1", "p1c4r15.1", "p1c6r15.1", "p1c3r_automated")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c3r_automated",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p1c1,5r3,5,6,18",
                                                                                                          "p1c1,5r17",
                                                                                                          "p1c1,5r15.1",
                                                                                                          "p1c1,5r16",
                                                                                                          "p1c2r3,5,6,18",
                                                                                                          "p1c2r15.1",
                                                                                                          "p1c2r16",
                                                                                                          "p1c2r17",
                                                                                                          "p1c4r3,5,6,18",
                                                                                                          "p1c4r15.1",
                                                                                                          "p1c4r16",
                                                                                                          "p1c4r17"
                                                                                                         )
                                                                                         )
                                                               );
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c3r50", "calculateAttribute", RcbArray().init("p1c1,2,4,5,6r50")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p1c1,2,4,5,6r50",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p1c1,5r3,5,6,18",
                                                                                                          "p1c1,5r17",
                                                                                                          "p1c1,5r16",
                                                                                                          "p1c2r3,5,6,18",
                                                                                                          "p1c2r16",
                                                                                                          "p1c2r17",
                                                                                                          "p1c4r3,5,6,18",
                                                                                                          "p1c4r16",
                                                                                                          "p1c4r17",
                                                                                                          "p1c6r3,5,6,18",
                                                                                                          "p1c6r16",
                                                                                                          "p1c1-6r15"
                                                                                                         )
                                                                                         )
                                                               );
    end;

    private macro constructorTF401Part1CalculateController_16_MP(reportCalculateController : Object)
        initTF401Part1CalculateController(reportCalculateController);
    end;

    constructorTF401Part1CalculateController_16_MP(reportCalculateController);
end;

class (TF401PartCalculateController) TF401Part2CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    private macro makeAttributeId(data, staticAttribute)
        if (staticAttribute == null)
            staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        end;
        return staticAttribute.makeId(data.value("t_nrCode"), data.value("t_currencyCode"), data.value("t_rowCode"));
    end;

    private macro prepareCalculationData()
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r1,3,4", "calculateAttribute", RcbArray().init("p2c4r1,3,4")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r14.1", "calculateAttribute", RcbArray().init("p2c4r14.1")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r15", "calculateAttribute", RcbArray().init("p2c4r15")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1-6r14", "calculateAttribute", RcbArray().init("p2c1,5r14.1", "p2c2r14.1", "p2c4r14.1", "p2c6r14.1", "p2c3r_automated")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c3r_automated",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p2c1,5r1,3,4",
                                                                                                          "p2c1,5r14.1",
                                                                                                          "p2c1,5r15",
                                                                                                          "p2c2r1,3,4",
                                                                                                          "p2c2r14.1",
                                                                                                          "p2c2r15",
                                                                                                          "p2c4r1,3,4",
                                                                                                          "p2c4r14.1",
                                                                                                          "p2c4r15"
                                                                                                         )
                                                                                         )
                                                               );
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c3r50", "calculateAttribute", RcbArray().init("p2c1,2,4,5,6r50")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,2,4,5,6r50",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p2c1,5r1,3,4",
                                                                                                          "p2c1,5r15",
                                                                                                          "p2c2r1,3,4",
                                                                                                          "p2c2r15",
                                                                                                          "p2c4r1,3,4",
                                                                                                          "p2c4r15",
                                                                                                          "p2c6r1,3,4",
                                                                                                          "p2c6r15",
                                                                                                          "p2c1-6r14"
                                                                                                         )
                                                                                         )
                                                               );
    end;

    private macro isPartTotalRow(rowCode)
        return (rowCode == "П50");
    end;

    macro getBisExactData()
        return m_datasources.getDatasource("biskvitExact part 2").getData();
    end;

    macro execute()
//        m_protocolView.printLine("");
        if (TF401Settings().isUseSecuritiesData())
            createAttributes(m_datasources.getDatasource("sec attributes part 2").getData());
        end;
        createAttributes(m_datasources.getDatasource("attributes part 2").getData());
        prepareCalculationData();
//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF401Part2CalculateController(reportCalculateController : Object)
        initTF401PartCalculateController(reportCalculateController, TF401Global().getPart2Id());

        m_fieldNamesList = RcbArray().init("incomeRest",
                                           "turns",
                                           "revaluationTurns",
                                           "otherTurns",
                                           "outgoingRest",
                                           "interests"
                                          );

        m_dataProtocolView = m_protocolView.getDataProtocolView("part2");
    end;

    constructorTF401Part2CalculateController(reportCalculateController);
end;

class (TF401Part2CalculateController) TF401Part2CalculateController_16_MP(reportCalculateController : Object /*TReportCalculateController*/)
    private macro prepareCalculationData()
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,5r16", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r1,3,4", "calculateAttribute", RcbArray().init("p2c4r1,3,4")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r14.1", "calculateAttribute", RcbArray().init("p2c4r14.1")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r15", "calculateAttribute", RcbArray().init("p2c4r15")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c2r16", "calculateAttribute", RcbArray().init("p2c4r16")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c4r16", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r1,3,4", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r14.1", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c6r15", "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1-6r14", "calculateAttribute", RcbArray().init("p2c1,5r14.1", "p2c2r14.1", "p2c4r14.1", "p2c6r14.1", "p2c3r_automated")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c3r_automated",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p2c1,5r1,3,4",
                                                                                                          "p2c1,5r14.1",
                                                                                                          "p2c1,5r15",
                                                                                                          "p2c1,5r16",
                                                                                                          "p2c2r1,3,4",
                                                                                                          "p2c2r14.1",
                                                                                                          "p2c2r15",
                                                                                                          "p2c2r16",
                                                                                                          "p2c4r1,3,4",
                                                                                                          "p2c4r14.1",
                                                                                                          "p2c4r15",
                                                                                                          "p2c4r16"
                                                                                                         )
                                                                                         )
                                                               );
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c3r50", "calculateAttribute", RcbArray().init("p2c1,2,4,5,6r50")));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("p2c1,2,4,5,6r50",
                                                                                          "calculateAttribute",
                                                                                          RcbArray().init("p2c1,5r1,3,4",
                                                                                                          "p2c1,5r15",
                                                                                                          "p2c1,5r16",
                                                                                                          "p2c2r1,3,4",
                                                                                                          "p2c2r15",
                                                                                                          "p2c2r16",
                                                                                                          "p2c4r1,3,4",
                                                                                                          "p2c4r15",
                                                                                                          "p2c4r16",
                                                                                                          "p2c6r1,3,4",
                                                                                                          "p2c6r15",
                                                                                                          "p2c1-6r14"
                                                                                                         )
                                                                                         )
                                                               );
    end;

    private macro constructorTF401Part2CalculateController_16_MP(reportCalculateController : Object)
        initTF401Part2CalculateController(reportCalculateController);
    end;

    constructorTF401Part2CalculateController_16_MP(reportCalculateController);
end;

class (TF401PartCalculateController) TF401Part31CalculateController(reportCalculateController : Object, partId : String)
    private macro makeAttributeId(data, staticAttribute)
        if (staticAttribute == null)
            staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        end;
        return staticAttribute.makeId(data.value("t_rowCode"));
    end;

    private macro isPartTotalRow(rowCode)
        return false;
    end;

    macro deleteZeroDealAttributes()
        return;
    end;

    macro getBisExactData()
        return m_datasources.getDatasource("biskvitExact part 3.1").getData();
    end;

    macro execute()
//        m_protocolView.printLine("");
        if (TF401Settings().isUseSecuritiesData())
            createAttributes(m_datasources.getDatasource("sec attributes part 3.1").getData());
        end;
//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro cnstTF401Part31CalculateController(reportCalculateController : Object, partId : String)
        initTF401PartCalculateController(reportCalculateController, partId);

        m_fieldNamesList = RcbArray().init("incomeRest",
                                           "turns",
                                           "revaluationTurns",
                                           "otherTurns",
                                           "outgoingRest",
                                           "rtGroup2IncomeRest",
                                           "rtGroup2Turns",
                                           "rtGroup2RevaluationTurns",
                                           "rtGroup2OtherTurns",
                                           "rtGroup2OutgoingRest",
                                           "stockOptionReceived",
                                           "stockOptionPaid"
                                          );

        m_dataProtocolView = m_protocolView.getDataProtocolView("part31");
    end;

    cnstTF401Part31CalculateController(reportCalculateController, partId);
end;

class (TF401PartCalculateController) TF401Part32CalculateController(reportCalculateController : Object, partId : String)
    private macro makeAttributeId(data, staticAttribute)
        if (staticAttribute == null)
            staticAttribute = objectFactoryInstance.createAttribute(null, m_part);
        end;
        return staticAttribute.makeId(data.value("t_rowCode"));
    end;

    private macro isPartTotalRow(rowCode)
        return false;
    end;

    macro getBisExactData()
        return m_datasources.getDatasource("biskvitExact part 3.2").getData();
    end;

    macro execute()
//        m_protocolView.printLine("");
        if (TF401Settings().isUseSecuritiesData())
            createAttributes(m_datasources.getDatasource("sec attributes part 3.2").getData());
        end;
//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro cnstTF401Part32CalculateController(reportCalculateController : Object, partId : String)
        initTF401PartCalculateController(reportCalculateController, partId);

        m_fieldNamesList = RcbArray().init("claimName",
                                           "incomeRest",
                                           "turns",
                                           "revaluationTurns",
                                           "otherTurns",
                                           "outgoingRest",
                                           "rtGroup2IncomeRest",
                                           "rtGroup2Turns",
                                           "rtGroup2RevaluationTurns",
                                           "rtGroup2OtherTurns",
                                           "rtGroup2OutgoingRest"
                                          );

        m_dataProtocolView = m_protocolView.getDataProtocolView("part32");
    end;

    cnstTF401Part32CalculateController(reportCalculateController, partId);
end;
