/*
$Name:          f401Attribute.mac
$Module:        Отчеты ЦБ
$Description:   Форма 401. Класс атрибута.
*/

/**
 * Форма 401. Атрибут для раздела 1.
 * Хранит идентификатор, дополнительные свойства и значение в виде объекта класса, реализующего IF401AttibuteValue
 *
 * @since 12.09.2018
 * @author ABP
 * @version 6.20.031.052
 */
class (RcbAttributeBase) TF401AttributePart1(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart1)
    private var m_attributeValue : IF401AttributeValue;
    private var m_attributeProperties : TF401AttributePropertiesPart1;

    macro makeId(p1, p2, p3)
        macro normalizeRowCode(rowCode)
            var c1 = substr(rowCode, 1, 1);
            var c2 = substr(rowCode, 2);
            var c2Length = strlen(c2);
            if (c2Length == 1)
                c2 = "0" + c2;
                c2Length = 2;
            end;
            if (c2Length == 2)
                c2 = c2 + ".0";
            end;

            return (c1 + c2);
        end;

        var id;

        if (isEqClass("RcbCompositeValue", p1))
            id = p1.fieldValue("nrCode").currentAsString
               + p1.fieldValue("currencyCode").currentAsString
               + normalizeRowCode(p1.fieldValue("rowCode").currentAsString);
        else
            id = p1 + p2 + normalizeRowCode(p3);
        end;

        return id;
    end;

    /**
     * Получить значение атрибута
     */
    macro getValue() : IF401AttributeValue
        return m_attributeValue;
    end;

    macro getProperties() : TF401AttributePropertiesPart1
        return m_attributeProperties;
    end;

    /**
     * Проверка существования значения атрибута
     */
    macro isDefined() : Bool
        var isDefinedValue = false;

        if (m_attributeValue != null)
            isDefinedValue = m_attributeValue.isDefined();
        end;

        return isDefinedValue;
    end;

    macro isZero() : Bool
        return m_attributeValue.isZero();
    end;

    macro removeStorage()
        m_attributeValue.removeStorage();
    end;

    private macro constructorTF401AttributePart1(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart1)
        if (id == null) // ничего не создаём, экземпляр нужен только для вызова "статического" метода makeId
            return;
        end;

        if (value == null)
            value = part.getPartCompositeValue().addValue();
        end;

        if (isEqClass("RcbCompositeValue", value))
            initRcbAttributeBase(id, part, value);
            m_attributeValue = objectFactoryInstance.createAttributeValue(part, value);
            m_attributeProperties = objectFactoryInstance.createAttributeProperties(part, value);
        else
            initRcbAttributeBase(id, part, value.getStorage());
            m_attributeValue = value;
            m_attributeProperties = properties;
        end;
    end;

    constructorTF401AttributePart1(id, part, value, properties);
end;

/**
 * Форма 401. Атрибут для раздела 2.
 * Хранит идентификатор, дополнительные свойства и значение в виде объекта класса, реализующего IF401AttibuteValue
 *
 * @since 12.09.2018
 * @author ABP
 * @version 6.20.031.052
 */
class (RcbAttributeBase) TF401AttributePart2(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart2)
    private var m_attributeValue : IF401AttributeValue;
    private var m_attributeProperties : TF401AttributePropertiesPart2;

    macro makeId(p1, p2, p3)
        macro normalizeRowCode(rowCode)
            var c1 = substr(rowCode, 1, 1);
            var c2 = substr(rowCode, 2);
            var c2Length = strlen(c2);
            if (c2Length == 1)
                c2 = "0" + c2;
                c2Length = 2;
            end;
            if (c2Length == 2)
                c2 = c2 + ".0";
            end;

            return (c1 + c2);
        end;

        var id;

        if (isEqClass("RcbCompositeValue", p1))
            id = p1.fieldValue("nrCode").currentAsString
               + p1.fieldValue("currencyCode").currentAsString
               + normalizeRowCode(p1.fieldValue("rowCode").currentAsString);
        else
            id = p1 + p2 + normalizeRowCode(p3);
        end;

        return id;
    end;

    /**
     * Получить значение атрибута
     */
    macro getValue() : IF401AttributeValue
        return m_attributeValue;
    end;

    macro getProperties() : TF401AttributePropertiesPart2
        return m_attributeProperties;
    end;

    /**
     * Проверка существования значения атрибута
     */
    macro isDefined() : Bool
        var isDefinedValue = false;

        if (m_attributeValue != null)
            isDefinedValue = m_attributeValue.isDefined();
        end;

        return isDefinedValue;
    end;

    macro isZero() : Bool
        return m_attributeValue.isZero();
    end;

    macro removeStorage()
        m_attributeValue.removeStorage();
    end;

    private macro constructorTF401AttributePart2(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart2)
        if (id == null) // ничего не создаём, экземпляр нужен только для вызова "статического" метода makeId
            return;
        end;

        if (value == null)
            value = part.getPartCompositeValue().addValue();
        end;

        if (isEqClass("RcbCompositeValue", value))
            initRcbAttributeBase(id, part, value);
            m_attributeValue = objectFactoryInstance.createAttributeValue(part, value);
            m_attributeProperties = objectFactoryInstance.createAttributeProperties(part, value);
        else
            initRcbAttributeBase(id, part, value.getStorage());
            m_attributeValue = value;
            m_attributeProperties = properties;
        end;

    end;

    constructorTF401AttributePart2(id, part, value, properties);
end;

/**
 * Форма 401. Атрибут для раздела 3.
 * Хранит идентификатор, дополнительные свойства и значение в виде объекта класса, реализующего IF401AttibuteValue
 *
 * @since 27.05.2019
 * @author ABP
 * @version 6.20.031.057
 */
class (RcbAttributeBase) TF401AttributePart3(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart3)
    private var m_attributeValue : IF401AttributeValue;
    private var m_attributeProperties : TF401AttributePropertiesPart3;

    macro makeId(p1) : String
        macro normalizeRowCode(rowCode)
            if (strlen(rowCode) == 5)
                rowCode = substr(rowCode, 1, 4) + "0" + substr(rowCode, 5);
            end;
            return rowCode;
        end;

        var id;

        if (isEqClass("RcbCompositeValue", p1))
            id = normalizeRowCode(p1.fieldValue("rowCode").currentAsString);
        else
            id = normalizeRowCode(p1);
        end;

        return id;
    end;

    /**
     * Получить значение атрибута
     */
    macro getValue() : IF401AttributeValue
        return m_attributeValue;
    end;

    macro getProperties() : TF401AttributePropertiesPart3
        return m_attributeProperties;
    end;

    /**
     * Проверка существования значения атрибута
     */
    macro isDefined() : Bool
        var isDefinedValue = false;

        if (m_attributeValue != null)
            isDefinedValue = m_attributeValue.isDefined();
        end;

        return isDefinedValue;
    end;

    macro isZero() : Bool
        return m_attributeValue.isZero();
    end;

    macro removeStorage()
        m_attributeValue.removeStorage();
    end;

    private macro constructorTF401AttributePart3(id : String, part : Object, value : Object, properties : TF401AttributePropertiesPart3)
        if (id == null) // ничего не создаём, экземпляр нужен только для вызова "статического" метода makeId
            return;
        end;

        if (value == null)
            value = part.getPartCompositeValue().addValue();
        end;

        if (isEqClass("RcbCompositeValue", value))
            initRcbAttributeBase(id, part, value);
            m_attributeValue = objectFactoryInstance.createAttributeValue(part, value);
            m_attributeProperties = objectFactoryInstance.createAttributeProperties(part, value);
        else
            initRcbAttributeBase(id, part, value.getStorage());
            m_attributeValue = value;
            m_attributeProperties = properties;
        end;
    end;

    constructorTF401AttributePart3(id, part, value, properties);
end;
