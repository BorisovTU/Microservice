/*ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
  RS-Bank V6                                                                        R-Style Softlab
  î†©´ ØÆ§·®·‚•¨Î "ê•£´†¨•≠‚®‡„•¨†Ô Æ‚Á•‚≠Æ·‚Ï"

  ê†·Á•‚ ‰Æ‡¨Î 664 ØÆ §†≠≠Î¨ Retail. ê†ß§•´Î 3-ûî ® 4-ûî.

  ëÆß§†≠: 09.08.2010 - Shestakov Dmitry
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ*/
import calc_f664_b2470u;

/**
 *  è†‡†¨•‚‡Î Æ‚Á•‚†
 */
private class (TParameters) TParametersRtIssue34()

    initTParameters(ACCOUNT_KIND_UF, "", 34);

end;

/**
 *  à·‚ÆÁ≠®™® §†≠≠ÎÂ
 */
private class (TDataSource) TDataSourceRtDepositIssue34(parameters : TParameters, tuneTable : RcbTuneTable)
    var report = rcbApplication.currentReport;
    var tableName = TRestsTempTable().getTableName();

    initTDataSource(BORetail, parameters, TRestsTempTable());

    sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.beginDate)+", 'DD.MM.YYYY')))");
    sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.endDate)+", 'DD.MM.YYYY')))");

    sql_execute("        INSERT INTO " + tableName + "(t_accountnumber,                                                "
              + "\n" + "                               t_chapternumber,                                                "
              + "\n" + "                               t_currencyid,                                                   "
              + "\n" + "                               t_reportissue,                                                  "
              + "\n" + "                               t_accountkind,                                                  "
              + "\n" + "                               t_backoffice,                                                   "
              + "\n" + "                               t_restin,                                                       "
              + "\n" + "                               t_restout,                                                      "
              + "\n" + "                               t_clientcodeandname,                                            "
              + "\n" + "                               t_contragentid)                                                 "
              + "\n" + "                        SELECT dep.t_number,                                                   "
              + "\n" + "                               NULL,                                                           "
              + "\n" + "                               dep.t_currencyid,                                               "
              + "\n" +                                 string(getParameters().getReportIssue()) + ",                   "
              + "\n" +                                 getSqlString(getParameters().getAccountKind()) + ",             "
              + "\n" +                                 BORetail + ",                                                   "
              + "\n" + "                               dep.t_inrest,                                                   "
              + "\n" + "                               dep.t_outrest,                                                  "
              + "\n" + "                               codes.t_code  || ' ' || party.t_shortname,                      "
              + "\n" + "                               NULL                                                           "
              + "\n" + "                          FROM repRtlDeposit_vw dep, dparty_dbt party, dreppartycodes_vw codes "
              + "\n" + "                         WHERE dep.t_contragentId = party.t_partyID                            "
              + "\n" + "                           AND dep.t_contragentId = codes.t_partyID                            "
              + "\n" + "                           AND codes.t_codeKind = 1                                            "
              + "\n" + "                           AND " + RcbBranchFieldFilter().GetAsSqlString("dep.t_branchId")
              + "\n" + "                           AND " +  ConvertMaskToSQLFormat(getMaskForAccountKind(parameters.getAccountKind()), "dep.t_balance")
              + "\n" + "                           AND dep.t_isOpened = 1 AND dep.t_currencyId = 0                     "
              + "\n" + "                           AND dep.t_account IS NOT NULL");
end;

private class (TDataSourceRt) TDataSourceRtDepositOperationsStatisticIssue34(parameters : TParameters)
    var report = rcbApplication.currentReport;
    var tableName = TTurnsTempTable().getTableName();

    initTDataSource(BORetail, parameters, TTurnsTempTable());

    sql_execute("CALL rsvoxprm.setPrmVal('BeginDate', UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.beginDate)+", 'DD.MM.YYYY')))");
    sql_execute("CALL rsvoxprm.setPrmVal('EndDate',   UTL_RAW.CAST_TO_RAW(TO_CHAR("+getSqlDate(report.context.period.endDate)+", 'DD.MM.YYYY')))");

    sql_execute("        INSERT INTO " + tableName + "(t_currencycode,                                                                         "
              + "\n" + "                               t_sum,                                                                                  "
              + "\n" + "                               t_datecarry,                                                                            "
              + "\n" + "                               t_accountpayer,                                                                         "
              + "\n" + "                               t_accountreceiver,                                                                      "
              + "\n" + "                               t_numberdocument,                                                                       "
              + "\n" + "                               t_directioncode,                                                                        "
              + "\n" + "                               t_operationcode,                                                                        "
              + "\n" + "                               t_countrycode,                                                                          "
              + "\n" + "                               t_countryname,                                                                          "
              + "\n" + "                               t_clientcodeandname,                                                                    "
              + "\n" + "                               t_reportissue,                                                                          "
              + "\n" + "                               t_accountkind,                                                                          "
              + "\n" + "                               t_backoffice,                                                                           "
              + "\n" + "                               t_accountnumber,                                                                        "
              + "\n" + "                               t_chapternumber,                                                                        "
              + "\n" + "                               t_iswrongpayment)                                                                       "
              + "\n" + "                        SELECT  currencyCode,                                                                          "
              + "\n" + "                                t_operationssum,                                                                       "
              + "\n" + "                                t_date,                                                                                "
              + "\n" + "                                NULL,                                                                                  "
              + "\n" + "                                NULL,                                                                                  "
              + "\n" + "                                t_operationsCount,                                                                     "
              + "\n" + "                                t_isreceipts,                                                                          "
              + "\n" + "                                operationCode,                                                                         "
              + "\n" + "                                countryCode,                                                                           "
              + "\n" + "                                countryName,                                                                           "
              + "\n" + "                                NULL,                                                                                  "
              + "\n" + "                                reportIssue,                                                                           "
              + "\n" + "                                accountKind,                                                                           "
              + "\n" + "                                backOffice,                                                                            "
              + "\n" + "                                NULL,                                                                                  "
              + "\n" + "                                NULL,                                                                                  "
              + "\n" + "                                CASE                                                                                   "
              + "\n" + "                                    WHEN countryCode = '999' THEN 1                                                    "
              + "\n" + "                                    ELSE 0                                                                             "
              + "\n" + "                                END                                                                                    "
              + "\n" + "                          FROM (SELECT (SELECT fi.t_iso_number                                                         "
              + "\n" + "                                          FROM dfininstr_dbt fi                                                        "
              + "\n" + "                                         WHERE fi.t_fiid = stat.t_currencyCode) as currencyCode,                       "
              + "\n" + "                                       t_operationssum,                                                                "
              + "\n" + "                                       t_date,                                                                         "
              + "\n" + "                                       t_operationsCount,                                                              "
              + "\n" + "                                       t_isreceipts,                                                                   "
              + "\n" + "                                       CASE                                                                            "
              + "\n" + "                                           WHEN t_instruction117OperationCode IS NULL                                  "
              + "\n" + "                                               THEN CHR(1)                                                             "
              + "\n" + "                                           WHEN t_instruction117OperationCode IN (CHR(0), CHR(1))                      "
              + "\n" + "                                               THEN CHR(1)                                                             "
              + "\n" + "                                           WHEN rcb_f664.isValidOperationCode(t_instruction117OperationCode) = 0   "
              + "\n" + "                                               THEN '00000'                                                            "
              + "\n" + "                                           ELSE t_instruction117OperationCode                                          "
              + "\n" + "                                       END as operationCode,                                                           "
              + "\n" + "                                       DECODE(t_clientcountrycode, CHR(1), '999', t_clientcountrycode) as countryCode, "
              + "\n" + "                                       CASE                                                                            "
              + "\n" + "                                           WHEN t_clientcountrycode IN ('997', '998', '999')                           "
              + "\n" + "                                               THEN '·‚‡†≠† ≠• ÆØ‡•§•´•≠†'                                             "
              + "\n" + "                                           ELSE (SELECT country.t_fullName                                             "
              + "\n" + "                                                   FROM dcountry_dbt country                                           "
              + "\n" + "                                                  WHERE country.t_codeNum3 = t_clientcountrycode)                      "
              + "\n" + "                                       END as countryName,                                                             "
              + "\n" +                                         string(getParameters().getReportIssue()) + " as reportIssue,                    "
              + "\n" +                                         getSqlString(getParameters().getAccountKind()) + " as accountKind,              "
              + "\n" +                                         BORetail + " as backOffice                                                     "
              + "\n" + "                                  FROM reprtldepoperatestatistics_vw stat, dparty_dbt party, dreppartycodes_vw codes   "
              + "\n" + "                                 WHERE t_isClientNotResident = 'X'                                                     "
              + "\n" + "                                   AND " + RcbBranchFieldFilter().GetAsSqlString("t_branchId") + ")"
              + "\n" + "                         WHERE operationCode != '' AND currencyCode = '643'");
end;

/**
 *  äÆ≠‚‡Æ´´•‡ ‡†·Á•‚†
 */
private class TCalculator()
    macro calculate(parameters : TParameters, tuneTable : RcbTuneTable)
        TDataSourceRtDepositIssue34(parameters, tuneTable);

        TDataSourceRtDepositOperationsStatisticIssue34(parameters);
    end;
end;

/**
 *  é·≠Æ¢≠†Ô ‰„≠™Ê®Ô
 */
private macro main()

    var bo_retail = TBackOffice(BORetail);

    var tunetable = RcbTuneTable("dt664h_dbt");
    tunetable.setInstructionFilter(RCB_I2470_DATE3);

    var parameters = TParametersRtIssue34();

    if (tuneTable.hasDataFor(bo_retail, "t_backOffice"))

        BegAction(2000, "ê†·Á•‚ Ø•‡•¨•≠≠ÎÂ ‡†ß§•´Æ¢ 3 ® 4 (ûî) ØÆ §†≠≠Î¨ RS-Retail");

            TCalculator().calculate(parameters, tuneTable);

        EndAction(1000);

    end;

end;

/**
 *  íÆÁ™† ¢ÂÆ§†
 */
main();

OnError(error)
    exceptionMessage(error);
    exit(1);

