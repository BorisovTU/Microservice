/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank V6                                                                        R-Style Softlab
  ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì"

  ¥ç âì ¯à®â®ª®«  à áç¥â  ¨ ä®à¬ë 664.  §¤¥« 3

  ‘®§¤ ­: 29.01.2007 - ABP
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/
import PTInter;
import print_f664_b1747u;

import param;

/**
 *  Š®­áâ ­âë
 */
private const DEBIT  = "0";
private const CREDIT = "1";

/**
 * Š« áá ¯à®â®ª®« .
 */
class (TProtocol) TProtocolIssue3()

    private var m_countryOverall;
    private var m_directionOverall;

    private var m_currentDirection;
    private var m_currentCountry;

    private var m_parameters;

    private var m_cbTableWidth;
    private var m_rtTableWidth;
    private var m_accountsTableWidth;
    private var m_depositsTableWidth;

    private macro constructorTProtocolIssue3()
        
        m_countryOverall   = $0;
        m_directionOverall = $0;

        m_currentDirection = "";
        m_currentCountry   = "";

        m_parameters = TParameters("", "", 3);

        m_cbTableWidth       = 121;
        m_rtTableWidth       = 85;
        m_accountsTableWidth = 77;
        m_depositsTableWidth = 102;

        initTProtocol();

    end;

    private macro addAccountsWithoutTurns()

        var isExistsAccounts = false;

        var beginDate = getSqlDate(RcbApplication().currentReport.context.period.beginDate),
            endDate   = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var query =          "SELECT rests.t_accountNumber t_accountNumber,"
                    + "\n" + "       rests.t_restIn        t_restIn,"
                    + "\n" + "       rests.t_restOut       t_restOut"
                    + "\n" + "  FROM " + TRestsTempTable().getTableName() + " rests"
                    + "\n" + " WHERE (rests.t_restIn != 0 OR rests.t_restOut != 0)"
                    + "\n" + "   AND rests.t_reportIssue = 2"
                    + "\n" + "   AND rests.t_backOffice = " + BOCB
                    + "\n" + "   AND NOT EXISTS (SELECT 1 FROM darhdoc_dbt doc"
                    + "\n" + "                    WHERE (rests.t_accountNumber = doc.t_account_payer OR rests.t_accountNumber = doc.t_account_receiver)"
                    + "\n" + "                      AND rests.t_chapterNumber = doc.t_chapter"
                    + "\n" + "                      AND rests.t_currencyId = doc.t_code_currency"
                    + "\n" + "                      AND doc.t_date_carry BETWEEN " + beginDate + " AND " + endDate + ")"
                    + "\n" + " ORDER BY t_accountNumber";

        var dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_restIn",  V_MONEY);
        dataSource.setFieldType("t_restOut", V_MONEY);

        println();

        println("‹¨æ¥¢ë¥ áç¥â , ¯® ª®â®àë¬ ¢ ®âç¥â­ë© ¯¥à¨®¤ ­¥ ¡ë«® ®¡®à®â®¢, ­® ¡ë«¨ ®áâ âª¨:");
        println("ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
        println("³       ®¬¥à «/á           ³   áâ â®ª ­  ­ ç «®   ³   áâ â®ª ­  ª®­¥æ    ³");
        println("³                           ³        ¯¥à¨®¤         ³        ¯¥à¨®¤         ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

        while (dataSource.next())
         
            isExistsAccounts = true;

            [  #########################   #####################   #####################  ]
            (  dataSource.accountNumber,   dataSource.restIn,      dataSource.restOut);

        end;

        if (not isExistsAccounts)

            println(strAlign("¥â ¤ ­­ëå", m_accountsTableWidth, STR_ALIGN_CENTER));
            println();

        end;

    end;

    private macro addUnknownCountryCb()

        var isContinue;

        var errorMessage;

        var query =          "WITH errCountryDoc AS"
                    + "\n" + "("
                    + "\n" + "SELECT DISTINCT"
                    + "\n" + "       DECODE(turns.t_countryCode, CHR(1), '!',"
                    + "\n" + "                                   CHR(2), '!',"
                    + "\n" + "                                   CHR(1))        t_errorFlag,"
                    + "\n" + "       turns.t_dateCarry                          t_dateCarry,"
                    + "\n" + "       turns.t_accountNumber                      t_accountNumber,"
                    + "\n" + "       turns.t_accountPayer                       t_accountPayer,"
                    + "\n" + "       turns.t_accountReceiver                    t_accountReceiver,"
                    + "\n" + "       turns.t_numberDocument                     t_numberDocument,"
                    + "\n" + "       turns.t_sum                                t_sum,"
                    + "\n" + "       turns.t_countryCode                        t_countryCode,"
                    + "\n" + "       partycode.t_code                           t_partyCode,"
                    + "\n" + "       party.t_shortName                          t_partyName"
                    + "\n" + "  FROM " + TTurnsTempTable().getTableName() + " turns,"
                    + "\n" + "       daccount_dbt                             account,"
                    + "\n" + "       dparty_dbt                               party,"
                    + "\n" + "       dobjcode_dbt                             partycode"
                    + "\n" + " WHERE turns.t_countryCode IN (CHR(1), CHR(2), '999')"
                    + "\n" + "   AND turns.t_backOffice = " + BOCB
                    + "\n" + "   AND account.t_account = turns.t_accountNumber"
                    + "\n" + "   AND account.t_chapter = turns.t_chapterNumber"
                    + "\n" + "   AND party.t_partyId = account.t_client"
                    + "\n" + "   AND partycode.t_objectType = " + OBJTYPE_PARTY
                    + "\n" + "   AND partycode.t_codeKind = " + PTCK_CONTR
                    + "\n" + "   AND partycode.t_objectId = party.t_partyId"
                    /* 02.10.2007 Malakhova 110424*/
                    /*ˆáâ®à¨ç­®áâì ª®¤®¢*/
                    + "\n" + "   AND " + setFilterForCodeDate("partycode", "turns.t_dateCarry")
                    + "\n" + ")"
                    + "\n" + "SELECT t_errorFlag,"
                    + "\n" + "       t_dateCarry,"
                    + "\n" + "       t_accountPayer,"
                    + "\n" + "       t_accountReceiver,"
                    + "\n" + "       t_numberDocument,"
                    + "\n" + "       t_sum,"
                    + "\n" + "       t_countryCode,"
                    + "\n" + "       t_partyCode,"
                    + "\n" + "       t_partyName"
                    + "\n" + "  FROM errCountryDoc ecd"
                    + "\n" + " WHERE    (t_accountPayer = t_accountNumber)"                                   // ¥á«¨ ¤«ï ¤®ªã¬¥­â  ¯à¨áãâáâ¢ãîâ
                    + "\n" + "       OR (   (t_accountReceiver = t_accountNumber)"                            // ¤¢¥ § ¯¨á¨ (á® áç¥â®¬ ¯« â¥«ìé¨ª  ¨
                    + "\n" + "           AND NOT EXISTS(SELECT 1"                                             // á® áç¥â®¬ ¯®«ãç â¥«ï), â® ¢ë¢®¤¨âáï
                    + "\n" + "                            FROM errCountryDoc ecdDup"                          // â®«ìª® ®¤­  § ¯¨áì ¤«ï ¤®ªã¬¥­â 
                    + "\n" + "                           WHERE ecd.t_accountPayer = ecdDup.t_accountNumber"   // (á® áç¥â®¬ ¯« â¥«ìé¨ª )
                    + "\n" + "                         )"
                    + "\n" + "          )"
                    + "\n" + " ORDER BY t_errorFlag, t_dateCarry, t_accountPayer, t_accountReceiver, t_numberDocument";
                    
        var dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_dateCarry", V_DATE);
        dataSource.setFieldType("t_sum",       V_MONEY);

        errorMessage = "„«ï ¤®ªã¬¥­â  § ¤ ­® §­ ç¥­¨¥ ª â¥£®à¨¨ \"Š®¤ áâà ­ë ­¥à¥§¨¤¥­â \". "
                       "¥¢®§¬®¦­® ª®àà¥ªâ­® ®¯à¥¤¥«¨âì ª®¤ áâà ­ë ¯« â¥«ìé¨ª  ¨ ¯®«ãç â¥«ï";

        isContinue = dataSource.next();

        if (isContinue)
            println();
            
            println("¯¥à æ¨¨, ¤«ï ª®â®àëå ­¥¢®§¬®¦­® ®¯à¥¤¥«¨âì ª®¤ áâà ­ë ­¥à¥§¨¤¥­â  - ¢« ¤¥«ìæ  áç¥â :");
            println("ÚÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
            println("³ ³ Š®¤  ³   „ â    ³        ‘ç¥â ¯® ¤¥¡¥âã     ³      ‘ç¥â ¯® ªà¥¤¨âã      ³ ü ¤®ª ³  ‘ã¬¬  ¢ àã¡«ïå ”   ³ ¥à¥§¨¤¥­â - ¢« ¤¥«¥æ ³");
            println("³ ³áâà ­ë³   ¤®ª    ³                           ³                           ³       ³                      ³          áç¥â         ³");
            println("³ ³­¥à¥§.³          ³                           ³                           ³       ³                      ³                       ³");
            println("ÀÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");
        end;
            
        while (isContinue)
        
            if (dataSource.countryCode != strFor(2))
            
                [ #  ###   ##########  #########################   #########################   #####   #####################  ###################### ]
                ( dataSource.errorFlag,
                     dataSource.countryCode,
                           dataSource.dateCarry:f, 
                                       dataSource.accountPayer,    dataSource.accountReceiver, dataSource.numberDocument, 
                                                                                                       dataSource.sum:r,      dataSource.partyCode:w);

                [                                                                                                             ###################### ]
                (                                                                                                             dataSource.partyName:w);
        
            else

                [ #        ##########  #########################   #########################   #####   #####################  ###################### ]
                ( dataSource.errorFlag,
                           dataSource.dateCarry:f, 
                                       dataSource.accountPayer,    dataSource.accountReceiver, dataSource.numberDocument, 
                                                                                                       dataSource.sum:r,      errorMessage:w);

            end;

            isContinue = dataSource.next();

        end;

    end;

    private macro addDeposits()

        var isExistsDeposits = false;

        var beginDate = getSqlDate(RcbApplication().currentReport.context.period.beginDate),
            endDate   = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var query =          "SELECT rests.t_accountNumber     t_accountNumber,"
                    + "\n" + "       rests.t_restIn            t_restIn,"
                    + "\n" + "       rests.t_restOut           t_restOut,"
                    + "\n" + "       rests.t_clientCodeAndName t_clientCodeAndName"
                    + "\n" + "  FROM " + TRestsTempTable().getTableName() + " rests"
                    + "\n" + " WHERE rests.t_reportIssue = 2"
                    + "\n" + "   AND rests.t_backOffice = " + BORetail
                    + "\n" + " ORDER BY t_accountNumber";

        var dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_restIn",  V_MONEY);
        dataSource.setFieldType("t_restOut", V_MONEY);

        println();

        println("„®£®¢®à  Retail, ®â®¡à ­­ë¥ ¤«ï ®âç¥â :");
        println("ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
        println("³      ®¬¥à ¤®£®¢®à        ³   áâ â®ª ­  ­ ç «®   ³   áâ â®ª ­  ª®­¥æ    ³         Š«¨¥­â         ³");
        println("³                           ³        ¯¥à¨®¤         ³        ¯¥à¨®¤         ³                        ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

        while (dataSource.next())
            
            isExistsDeposits = true;

            [  #########################   #####################   #####################   ######################  ]
            (  dataSource.accountNumber,   dataSource.restIn,      dataSource.restOut,     dataSource.clientCodeAndName:w);

        end;

        if (not isExistsDeposits)

            println(strAlign("¥â ¤ ­­ëå", m_depositsTableWidth, STR_ALIGN_CENTER));
            println();

        end;
        
    end;

    private macro addUnknownCountryRt()

        var isContinue;

        var query =          "SELECT turns.t_dateCarry      t_dateCarry,"
                    + "\n" + "       turns.t_operationCode  t_operationCode,"
                    + "\n" + "       turns.t_sum            t_sum,"
                    + "\n" + "       turns.t_numberDocument t_numberDocument"
                    + "\n" + "  FROM " + TTurnsTempTable().getTableName() + " turns"
                    + "\n" + " WHERE turns.t_countryCode = '999'"
                    + "\n" + "   AND turns.t_backOffice = " + BORetail
                    + "\n" + " ORDER BY t_dateCarry, t_operationCode, t_sum, t_numberDocument";
                    
        var dataSource = TRsbDataSet(query);

        dataSource.setFieldType("t_dateCarry", V_DATE);
        dataSource.setFieldType("t_sum",       V_MONEY);

        isContinue = dataSource.next();

        if (isContinue)
            println();
            
            println("¯¥à æ¨¨ ¢ Retail, ¤«ï ª®â®àëå ­¥¢®§¬®¦­® ®¯à¥¤¥«¨âì ª®¤ áâà ­ë ­¥à¥§¨¤¥­â :");
            println("ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
            println("³   „ â    ³   Š®¤    ³   ‘ã¬¬  ¢ àã¡«ïå ”   ³    Š®«¨ç¥áâ¢® ®¯¥à æ¨©    ³");
            println("³          ³ ®¯¥à æ¨¨ ³                       ³                           ³");
            println("ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");

        end;
            
        while (isContinue)
        
            [ ##########   #####     #####################   #########################  ]
            ( dataSource.dateCarry:f,
                           dataSource.operationCode,    
                                     dataSource.sum:r,       dataSource.numberDocument);
        
            isContinue = dataSource.next();

        end;

    end;

    private macro addIssueHeader()

        println();
        println("€‡„…‹ 3");
        println();

    end;

    macro addTableHeaderCb()

        println("ƒ‹€‚€Ÿ Šˆƒ€");
        println("ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄ¿");
        println("³Š®¤ áâà ­ë³   Š®¤    ³  ‘ã¬¬  ¢ àã¡«ïå ”   ³   „ â    ³        ‘ç¥â ¯® ¤¥¡¥âã     ³      ‘ç¥â ¯® ªà¥¤¨âã      ³ ü ¤®ª ³");
        println("³ ­¥à¥§¨¤. ³ ®¯¥à æ¨¨ ³                      ³   ¤®ª    ³                           ³                           ³       ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÙ");
 
        m_currentDirection = "";

    end;

    macro addTableHeaderRt()

        println("RETAIL");
        println("ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
        println("³Š®¤ áâà ­ë³   Š®¤    ³  ‘ã¬¬  ¢ àã¡«ïå ”   ³   „ â    ³    Š®«¨ç¥áâ¢® ®¯¥à æ¨©    ³");
        println("³ ­¥à¥§¨¤. ³ ®¯¥à æ¨¨ ³                      ³          ³                           ³");
        println("ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");
 
        m_currentDirection = "";

    end;

    private macro addTableFooter()

//        println();

    end;

    private macro addDirectionHeader(directionCode)
        
        var directionStr;

        if (directionCode == DEBIT)
            directionStr = "‘¯¨á ­¨¥";
        else
            directionStr = "‡ ç¨á«¥­¨¥";
        end;

        [ ########## ](directionStr:l);

        m_directionOverall = $0;

        m_currentDirection = directionCode;

        m_currentCountry = "";

    end;

    private macro addDirectionFooter()

        var directionStr;

        if (m_currentDirection == DEBIT)
            directionStr = "‚‘…ƒ ‘ˆ‘";
        else
            directionStr = "‚‘…ƒ ‡€—";
        end;

        [ ##########            #####################  ](directionStr:l, m_directionOverall);

        println();

    end;

    private macro addCountryHeader(countryCode)

        m_currentCountry = countryCode;

        m_countryOverall = $0;

        [   ###      ](countryCode);

    end;

    private macro addCountryFooter()

        [  ######## ###         #####################  ]("ˆ’ƒ ", m_currentCountry, m_countryOverall);

    end;

    macro addTableLineCb(countryCode, dataSource)

        [   ###       #####     #####################  ##########  #########################   #########################   #####  ]
        (   countryCode:r, 
                      dataSource.operationCode, 
                                dataSource.sum,        dataSource.dateCarry:f, 
                                                                   dataSource.accountPayer,    dataSource.accountReceiver, dataSource.numberDocument:l);

    end;

    macro addTableLineRt(countryCode, dataSource)

        [   ###       #####     #####################  ##########  #########################  ]
        (   countryCode:r, 
                      dataSource.operationCode, 
                                dataSource.sum,        dataSource.dateCarry:f, 
                                                                   dataSource.numberDocument:l);

    end;

    private macro printBackOffice(backOffice, width, tableHeaderPrinter, tableLinePrinter)

        var isExistsTurns = false;

        var isContinue;

        var dataSource;

        var countryCode;

        var query;

        query =          "SELECT turns.t_countryCode     t_countryCode,"
                + "\n" + "       turns.t_operationCode   t_operationCode,"
                + "\n" + "       turns.t_sum             t_sum,"
                + "\n" + "       turns.t_dateCarry       t_dateCarry,"
                + "\n" + "       turns.t_accountPayer    t_accountPayer,"
                + "\n" + "       turns.t_accountReceiver t_accountReceiver,"
                + "\n" + "       turns.t_numberDocument  t_numberDocument,"
                + "\n" + "       turns.t_directionCode   t_directionCode"
                + "\n" + "  FROM " + TTurnsTempTable().getTableName() + " turns"
                + "\n" + " WHERE turns.t_reportIssue = " + m_parameters.getReportIssue()
                + "\n" + "   AND turns.t_countryCode NOT IN (CHR(1), CHR(2))"
                + "\n" + "   AND turns.t_countryCode IS NOT NULL"
                + "\n" + "   AND turns.t_backOffice = " + backOffice
                + "\n" + "ORDER BY t_directionCode, t_countryCode, t_operationCode, t_accountPayer, t_accountReceiver, t_dateCarry, t_sum";

        dataSource = TRsbDataSet(query);
        
        dataSource.setFieldType("t_sum",       V_MONEY);
        dataSource.setFieldType("t_dateCarry", V_DATE);

        isContinue = dataSource.next();

        execMacro(tableHeaderPrinter);

        if (not isContinue)
            println(strAlign("¥â ¤ ­­ëå", width, STR_ALIGN_CENTER));
            println();
        end;

        countryCode = dataSource.countryCode;

        while (isContinue)

            isExistsTurns = true;

            if (dataSource.directionCode != m_currentDirection)

                if (m_currentDirection != "")
                    addCountryFooter();
                    addDirectionFooter();
                end;

                addDirectionHeader(dataSource.directionCode);
                addCountryHeader(dataSource.countryCode);

            end;

            if (dataSource.countryCode != m_currentCountry)

                if (m_currentCountry != "")
                    addCountryFooter();
                end;

                addCountryHeader(dataSource.countryCode);

            else

                countryCode = "";

            end;

            execMacro(tableLinePrinter, countryCode, dataSource);

            m_countryOverall   = m_countryOverall + dataSource.sum;
            m_directionOverall = m_directionOverall + dataSource.sum;        

            isContinue = dataSource.next();

        end;

        if (isExistsTurns)
            
            addCountryFooter();
            addDirectionFooter();

        end;

    end;

    macro print()

        var query = "";

        switchOutput();

        addIssueHeader();

        printBackOffice(BOCB, m_cbTableWidth, r2m(this, "addTableHeaderCb"), r2m(this, "addTableLineCb"));

        printBackOffice(BORetail, m_rtTableWidth, r2m(this, "addTableHeaderRt"), r2m(this, "addTableLineRt"));

        addAccountsWithoutTurns();

        addUnknownCountryCb();

        addDeposits();

        addUnknownCountryRt();

        switchOutput();
    
    end;

    constructorTProtocolIssue3();

end;

/**
 * Š« áá ¯¥ç â­®© ä®à¬ë à §¤¥« 
 */
private class TOperationCodeFilter(filterValue)
    private var m_filterValue = nvl(filterValue, "");

    macro isSuitable(v)
        return m_filterValue == v.fieldValue("Š®¤ ¢¨¤  ®¯¥à æ¨¨").exact;
    end;
end;

private class TDirectionCodeFilter(filterValue)
    private var m_filterValue = nvl(filterValue, "");

    macro isSuitable(v)
        return m_filterValue == v.fieldValue(" ¯à ¢«¥­¨¥").exact;
    end;
end;

private class TCountryCodeFilter(filterValue)
    private var m_filterValue = nvl(filterValue, "");

    macro isSuitable(v)
        return m_filterValue == v.fieldValue("Š®¤ áâà ­ë").exact;
    end;
end;

class (TPrintableForm664) TIssue3PrintableForm664(rootAttributeName : String)

    private var m_reportTable : CTableReport;

    private var m_operations : TArray;
    private var m_countries : TArray;
                                      
    class TFilter(country, direction, operation)
        private var m_countryFilter   = TCountryCodeFilter(country);
        private var m_directionFilter = TDirectionCodeFilter(direction);
        private var m_operationFilter = TOperationCodeFilter(operation);

        macro isSuitable(v)
            return m_countryFilter.isSuitable(v) and m_directionFilter.isSuitable(v) and m_operationFilter.isSuitable(v);
        end;
    end;

    class TCountrySorter()
        macro isLess(v1, v2)
            return (v1.fieldValue("Š®¤ áâà ­ë").exact <= v2.fieldValue("Š®¤ áâà ­ë").exact);
        end;
    end;

    private macro fillCountries()
        var valueIterator = RcbApplication().currentReport.attributeValue(getRootAttributeName()).createValueIterator();
        var currentValue;

//        valueIterator.setFilter(TOperationCodeFilter("‚á¥£®"));
        valueIterator.setSortOrder(TCountrySorter());

        m_countries = TArray(50);

        valueIterator.first();
        while (not valueIterator.isDone())
            currentValue = valueIterator.currentItem.fieldValue("Š®¤ áâà ­ë").exact;

            if (m_countries.size == 0)
                m_countries[0] = ArrCreate(currentValue, valueIterator.currentItem.fieldValue(" ¨¬¥­®¢ ­¨¥ áâà ­ë").exact);
            else
                if (currentValue != m_countries[m_countries.size-1][0])
                    m_countries[m_countries.size] = ArrCreate(currentValue, valueIterator.currentItem.fieldValue(" ¨¬¥­®¢ ­¨¥ áâà ­ë").exact);
                end;
            end;

            valueIterator.next();
        end;
    end;

    private macro fillOperations()
        
        macro qSortComparer(v1, v2)
            var result = 0;
            
            if (v1 < v2)
                result = -1;
            elif (v1 == v2)
                result = 0;
            else
                result = 1;
            end;

            return result;
        end;
        
        var valueIteratorL1 = RcbApplication().currentReport.attributeValue(getRootAttributeName()).createValueIterator();
        var valueIteratorL2;
        var currentValue;

        valueIteratorL1.setFilter(TOperationCodeFilter("‚á¥£®"));

        m_operations = TArray(50);

        valueIteratorL1.first();
        while (not valueIteratorL1.isDone())
            
            valueIteratorL2 = valueIteratorL1.currentItem.createValueIterator();
            valueIteratorL2.first();
       
            while (not valueIteratorL2.isDone())                
                currentValue = valueIteratorL2.currentItem.fieldValue("Š®¤ ¢¨¤  ®¯¥à æ¨¨").exact;

                if (arrFind(m_operations, currentValue) == -1)
                    m_operations[m_operations.size] = currentValue;
                end;
                
                valueIteratorL2.next();
            end;

            valueIteratorL1.next();
        end;

        qSort(m_operations, "qSortComparer");

    end;

    macro getWidth()
        if (isEmpty())
            return getMINIMAL_REPORT_WIDTH();
        else
            return m_reportTable.getSumLen();
        end;
    end;

    private macro constructorTIssue3PrintableForm664(rootAttributeName)

        initTPrintableForm664(rootAttributeName);

        fillCountries();

        fillOperations();

        m_reportTable = CTableReport(0, false, false);

        m_reportTable.addColumn("1", 05, AL_LEFT);        // ¯à¥¤¥«¥­¨¥ ª®«®­®ª â ¡«¨æë
        m_reportTable.addColumn("2", 13, AL_CENTER);
        m_reportTable.addColumn("3", 41, AL_CENTER);
        m_reportTable.addColumn("4", 06, AL_CENTER);
        m_reportTable.addColumn("5", 14, AL_RIGHT);
        m_reportTable.addColumn("6", 14, AL_RIGHT);

    end;

    private macro isEmpty()
        var valueIteratorL1;
        var result = true;

        valueIteratorL1 = RcbApplication().currentReport.attributeValue(getRootAttributeName()).createValueIterator();
        valueIteratorL1.first();
        if (not valueIteratorL1.isDone())
            result = false;
        end;

        return result;
    end;

    private macro addHeader()
        var isEmptyReport = strAlign(ternary(IsEmpty(), "0", " "), 5, STR_ALIGN_CENTER);

        switchOutput();

        println();
        println(strAlign(" §¤¥« III. ‘âàãªâãà  ®¯¥à æ¨©, ®áãé¥áâ¢«ï¥¬ëå ¯® â¥ªãé¨¬, à áç¥â­ë¬,", getWidth(), STR_ALIGN_CENTER));
        println(strAlign("ª®àà¥á¯®­¤¥­âáª¨¬ áç¥â ¬, áç¥â ¬ ¯® ¢ª« ¤ ¬ (¤¥¯®§¨â ¬)", getWidth(), STR_ALIGN_CENTER));
        println(strAlign("­¥à¥§¨¤¥­â®¢ ¢ ¢ «îâ¥ ®áá¨©áª®© ”¥¤¥à æ¨¨, ¯® áâà ­ ¬", getWidth(), STR_ALIGN_CENTER));
        println();
        println(strAlign("¢ âëáïç å àã¡«¥©", getWidth(), STR_ALIGN_RIGHT));
        println(strAlign("ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³ ®¬¥à ³  Š®¤ áâà ­ë   ³              ¨¬¥­®¢ ­¨¥ áâà ­ë           ³Š®¤ ¢¨¤ ³           ‘ã¬¬ë ®¯¥à æ¨¨        ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³  ¯/¯  ³ ­¥à¥§¨¤¥­â  - ³                                           ³®¯¥à æ¨¨ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³       ³¢« ¤¥«ìæ  áç¥â ³                                           ³        ³     ‘¯¨á ­®    ³    ‡ ç¨á«¥­®   ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³   1   ³       2       ³                      3                    ³   4    ³       5        ³       6        ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));

        switchOutput();
    end;

    private macro addFooter()
        
        switchOutput();
    
        m_reportTable.printBottom();

        switchOutput();

    end;

    private macro addLine(number, countryCode, countryName, operationCode, debit, credit)

        switchOutput();

        m_reportTable.printSeparator();
        m_reportTable.printStringTransferByWord(number, countryCode, countryName, operationCode, debit, credit);

        switchOutput();

    end;

    macro printIssue()

        var valueRoot = RcbApplication().currentReport.attributeValue(getRootAttributeName());
        var valueIteratorL1;
        var valueIteratorL2;

        var currentOperation;
        var currentCountry;
        var currentDirection;

        var numberMajor, numberMinor;

        var sum = TArray(2);

        if (isEmpty())
            return;
        end;
        
        addHeader();

        currentCountry = 0;
        numberMajor = 0;
        while (currentCountry < m_countries.size)

            numberMajor = numberMajor + 1;
            numberMinor = 0;
            addLine(string(numberMajor), m_countries[currentCountry][0], m_countries[currentCountry][1], "X", strAlign("X", 14, STR_ALIGN_CENTER), 
                    strAlign("X", 14, STR_ALIGN_CENTER));

            currentOperation = 0;
            while (currentOperation < m_operations.size)

                currentDirection = 0;
                while (currentDirection < 2)

                    valueIteratorL1 = valueRoot.createValueIterator();
                    valueIteratorL1.setFilter(TFilter(m_countries[currentCountry][0], string(currentDirection), "‚á¥£®"));

                    valueIteratorL1.first();
                    if (valueIteratorL1.isDone())

                        sum[currentDirection] = string(0);

                    else

                        valueIteratorL2 = valueIteratorL1.currentItem.createValueIterator();
                        valueIteratorL2.setFilter(TFilter(m_countries[currentCountry][0], string(currentDirection), m_operations[currentOperation]));

                        valueIteratorL2.first();
                        if (valueIteratorL2.isDone())

                            sum[currentDirection] = string(0);

                        else

                            if (valueIteratorL2.currentItem.fieldValue("‘ã¬¬ ").scaled == 0.0)
                                sum[currentDirection] = string(0);
                            else
                                sum[currentDirection] = valueIteratorL2.currentItem.fieldValue("‘ã¬¬ ").scaledAsString;
                            end;

                        end;
                    end;

                    currentDirection = currentDirection + 1;

                end;

                if ((sum[0] != 0) or (sum[1] != 0))
                    numberMinor =numberMinor + 1;
                    addLine(numberMajor + "." + string(numberMinor), "X", "X", m_operations[currentOperation], sum[0], sum[1]);
                end;

                currentOperation = currentOperation + 1;

            end;

            currentCountry = currentCountry + 1;

        end;
            
        addFooter();

    end;

    constructorTIssue3PrintableForm664(rootAttributeName);

end;

/*
 * Š« áá ¯¥ç â­®© ä®à¬ë à §¤¥«  ¯® 1747-“
 */
class (TIssue3PrintableForm664) TIssue3PrintableForm664_I1747(rootAttributeName : String)

    private macro constructorTIssue3PrintableForm664_I1747(rootAttributeName)
        initTIssue3PrintableForm664(rootAttributeName);
    end;

    constructorTIssue3PrintableForm664_I1747(rootAttributeName);

end;

/*
 * Š« áá ¯¥ç â­®© ä®à¬ë à §¤¥«  ¯® 2332-“
 */
class (TIssue3PrintableForm664) TIssue3PrintableForm664_I2332(rootAttributeName : String)

    macro addHeader()
        var isEmptyReport = strAlign(ternary(IsEmpty(), "0", " "), 5, STR_ALIGN_CENTER);

        switchOutput();

        println();
        println(strAlign(" §¤¥« 3. ‘âàãªâãà  ®¯¥à æ¨©, ®áãé¥áâ¢«ï¥¬ëå ¯® â¥ªãé¨¬, à áç¥â­ë¬,", getWidth(), STR_ALIGN_CENTER));
        println(strAlign("ª®àà¥á¯®­¤¥­âáª¨¬ áç¥â ¬, áç¥â ¬ ¯® ¢ª« ¤ ¬ (¤¥¯®§¨â ¬)", getWidth(), STR_ALIGN_CENTER));
        println(strAlign("­¥à¥§¨¤¥­â®¢ ¢ ¢ «îâ¥ ®áá¨©áª®© ”¥¤¥à æ¨¨, ¯® áâà ­ ¬", getWidth(), STR_ALIGN_CENTER));
        println();
        println(strAlign("¢ âëáïç å àã¡«¥©", getWidth(), STR_ALIGN_RIGHT));
        println(strAlign("ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³ ®¬¥à ³  Š®¤ áâà ­ë   ³              ¨¬¥­®¢ ­¨¥ áâà ­ë           ³Š®¤ ¢¨¤ ³           ‘ã¬¬  ®¯¥à æ¨¨        ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³áâà®ª¨ ³ ­¥à¥§¨¤¥­â  - ³                                           ³®¯¥à æ¨¨ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³       ³¢« ¤¥«ìæ  áç¥â ³                                           ³        ³     ‘¯¨á ­®    ³    ‡ ç¨á«¥­®   ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("³   1   ³       2       ³                      3                    ³   4    ³       5        ³       6        ³", getReportWidth(), STR_ALIGN_LEFT));
        println(strAlign("ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´", getReportWidth(), STR_ALIGN_LEFT));

        switchOutput();
    end;

    private macro constructorTIssue3PrintableForm664_I2332(rootAttributeName)
        initTIssue3PrintableForm664(rootAttributeName);
    end;

    constructorTIssue3PrintableForm664_I2332(rootAttributeName);

end;
