/*
$Name:        calc_f302cb.mac
$Module:      Регламентируемая отчетность
$Description: Форма 302. Расчет по данным ГК
*/

/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   заполнение формы 302 по данным ГК

   CREATED : 28.08.07 Ser.
└─────────────────────────────────────────────────────────────────────────- */
/*
 *  Общебанковские интеры и модули
 */
import ReptcbInter;
import globals;
import cb_sql;

/*
 *  Интеры и модели подсистемы
 */
import RcbTuneTable;
import rcbConst;
import rcb_bo;
import departmentFilter;
import rcbimport;

import testLib;

import param;
import com_f302n;

/***************************************************************************************************
 *  Класс вставки во временную таблицу
 **************************************************************************************************/
private class TInserter(queryBuilder : Object, tuneTable : RcbTuneTable)
    private var m_accountMasksList = tuneTable.getDataSet();
    private var m_queryBuilder     = queryBuilder;

    private macro getAccountMasks(row : String)
        m_accountMasksList.moveFirst();
        m_accountMasksList.movePrev();
        var sqlClause = "";
        var masks = "";
        while (m_accountMasksList.moveNext())
            if ((row == NULL) or (m_accountMasksList.row == row))
                masks = masks + "," + m_accountMasksList.accountMasks;
            end;
        end;

        sqlClause = convertMaskToSqlFormat(subStr(masks, 2), "t_accountNumber");

        return ternary(sqlClause != "", "(" + sqlClause + ")", null);
    end;

    private macro insertData(dataQuery : String)
        var maskClause = getAccountMasks();
        maskClause = ternary(maskClause == null, "", "AND " + maskClause);

        sql_execute( "INSERT INTO df302p2_tmp(t_row, t_sign, t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
            + "\n" + "                        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode)"
            + "\n" + " SELECT t_row, t_sign, t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
            + "\n" + "        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
            + "\n" + "   FROM (" + dataQuery + ")"
            + "\n" + "  WHERE t_okatoCode IS NOT NULL"
            + "\n" + "    AND t_row IS NOT NULL"
            + "\n" + "    AND t_currencySum <> 0"
            + "\n" + "    " + maskClause);
    end;

    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause2 = getAccountMasks("2");
        maskClause2 = ternary(maskClause2 == null, "1=0", maskClause2);

        var maskClause3 = getAccountMasks("3");
        maskClause3 = ternary(maskClause3 == null, "1=0", maskClause3);

        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1
          + "\n" + "                   AND (    t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                         OR (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                              AND t_isEmployer = 'X')))"
          + "\n" + "                THEN '1'"
          + "\n" + "            WHEN (" + maskClause2 + ")"
          + "\n" + "                THEN '2'"
          + "\n" + "            WHEN (    " + maskClause3
          + "\n" + "                   AND t_legalForm  = " + RCB_NATURAL_PERSON
          + "\n" + "                   AND t_isEmployer = CHR(0))"
          + "\n" + "                THEN '3'"
          + "\n" + "       END t_row,"
          + "\n" + "       CHR(0) t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ")");
    end;

    macro initialize()
        return;
    end;

    macro execute()
        initialize();
        processRows(true);
        processRows(false);
    end;
end;

/***************************************************************************************************
 *  Класс вставки во временную таблицу по 1948У
 **************************************************************************************************/
private class (TInserter) TInserter1948(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro insertData(dataQuery : String)
        var maskClause = getAccountMasks();
        maskClause = ternary(maskClause == null, "", "AND " + maskClause);

        sql_execute( "INSERT INTO df302p2_tmp(t_row, t_sign, t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
            + "\n" + "                        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode)"
            + "\n" + " SELECT t_row, t_sign, t_backOffice, NVL(t_okatoCode, '99999'), t_column, t_accountNumber, t_currencyId,"
            + "\n" + "        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
            + "\n" + "   FROM (" + dataQuery + ")"
            + "\n" + "  WHERE t_row IS NOT NULL"
            + "\n" + "    AND t_currencySum <> 0"
            + "\n" + "    " + maskClause);
    end;

    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause1_1 = getAccountMasks("1(-)");
        maskClause1_1 = ternary(maskClause1_1 == null, "1=0", maskClause1_1);

        var maskClause2 = getAccountMasks("2");
        maskClause2 = ternary(maskClause2 == null, "1=0", maskClause2);

        var maskClause3 = getAccountMasks("3");
        maskClause3 = ternary(maskClause3 == null, "1=0", maskClause3);

        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + maskClause1_1 + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.isBank("data.t_partyId") + ")"
          + "\n" + "                THEN '1'"
          + "\n" + "            WHEN (" + maskClause2
          + "\n" + "                   AND (    t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                         OR (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                              AND t_isEmployer = 'X')))"
          + "\n" + "                THEN CASE"
          + "\n" + "                         WHEN NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
          + "\n" + "                             THEN '2'"
          + "\n" + "                     END"
          + "\n" + "            ELSE CASE"
          + "\n" + "                     WHEN " + maskClause3
          + "\n" + "                         THEN '3'"
          + "\n" + "                 END"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + maskClause1_1
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    initTInserter(queryBuilder, tuneTable);
end;

/***************************************************************************************************
 *  Класс вставки во временную таблицу по 2055У
 **************************************************************************************************/
private class (TInserter) TInserter2055(queryBuilder : Object, tuneTable : RcbTuneTable)

    var masksP = "40108*,40109*,40110*,40111*,40907*,40908*";

    private macro insertData(dataQuery : String)
        var maskClause = getAccountMasks();
        maskClause = ternary(maskClause == null, "", "AND " + maskClause);

        sql_execute( "INSERT INTO df302p2_tmp(t_row, t_sign, t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
            + "\n" + "                        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode)"
            + "\n" + " SELECT t_row, t_sign, t_backOffice, NVL(rpad(substr(t_okatoCode,1,2),5,0), '99999'), t_column, t_accountNumber, t_currencyId,"
            + "\n" + "        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
            + "\n" + "   FROM (" + dataQuery + ")"
            + "\n" + "  WHERE t_row IS NOT NULL"
            + "\n" + "    AND t_currencySum <> 0"
            + "\n" + "    " + maskClause
            + "\n" + "    OR " + convertMaskToSqlFormat(masksP, "t_accountNumber"));
    end;

    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause2 = getAccountMasks("1.1");
        maskClause2 = ternary(maskClause2 == null, "1=0", maskClause2);

        var maskClause3 = getAccountMasks("1.2");
        maskClause3 = ternary(maskClause3 == null, "1=0", maskClause3);

        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.isBank("data.t_partyId") + ")"
          + "\n" + "                THEN '1'"
          + "\n" + "            WHEN (" + maskClause2
          + "\n" + "                   AND (    t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                         OR (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                              AND t_isEmployer = 'X')))"
          + "\n" + "                THEN CASE"
          + "\n" + "                         WHEN NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
          + "\n" + "                             THEN '1.1'"
          + "\n" + "                     END"
          + "\n" + "            ELSE CASE"
          + "\n" + "                     WHEN " + maskClause3
          + "\n" + "                         THEN '1.2'"
          + "\n" + "                 END"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*,40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    initTInserter(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 2470-У
 *
 * @since v.6.20.029.153
 * @version 1.0
 * @author ABP
 */
private class (TInserter2055) TInserter2470(queryBuilder : Object, tuneTable : RcbTuneTable)

    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause2 = getAccountMasks("1.1");
        maskClause2 = ternary(maskClause2 == null, "1=0", maskClause2);

        var maskClause3 = getAccountMasks("1.2");
        maskClause3 = ternary(maskClause3 == null, "1=0", maskClause3);

        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.isBank("data.t_partyId") + ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*,40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        insertData("SELECT CASE"
          + "\n" + "            WHEN ((NOT " + m_queryBuilder.isBank("data.t_partyId") + ")"
          + "\n" + "               AND NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'ГВ'") + ")"
          + "\n" + "               THEN CASE "
          + "\n" + "                       WHEN (    t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                        OR (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                             AND t_isEmployer = 'X'))"
          + "\n" + "                          THEN CASE"
          + "\n" + "                                   WHEN (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
          + "\n" + "                                     AND " + maskClause2 + ")"
          + "\n" + "                                       THEN '1.1'"
          + "\n" + "                               END"
          + "\n" + "                          ELSE CASE"
          + "\n" + "                                   WHEN (" + maskClause3 + ")"
          + "\n" + "                                       THEN '1.2'"
          + "\n" + "                               END"
          + "\n" + "                    END"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*,40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter2470(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter2055(queryBuilder, tuneTable)
    end;

    constructorTInserter2470(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 2539-У
 */
private class (TInserter2470) TInserter2539(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause2 = getAccountMasks("1.1");
        maskClause2 = ternary(maskClause2 == null, "1=0", maskClause2);

        var maskClause3 = getAccountMasks("1.2");
        maskClause3 = ternary(maskClause3 == null, "1=0", maskClause3);


        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*,40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        insertData("SELECT CASE"
          + "\n" + "            WHEN ("
          + "\n" + "                  NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "               THEN CASE "
          + "\n" + "                       WHEN (    t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                         OR (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                             AND t_isEmployer = 'X'))"
          + "\n" + "                THEN CASE"
          + "\n" + "                                   WHEN (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
          + "\n" + "                                     AND " + maskClause2 + ")"
          + "\n" + "                             THEN '1.1'"
          + "\n" + "                     END"
          + "\n" + "            ELSE CASE"
          + "\n" + "                                   WHEN (" + maskClause3
          + "\n" + "                           AND NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'")
          + "\n" + "                           AND (     t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                                 AND t_isEmployer <> 'X'"
          + "\n" + "                               ))"
          + "\n" + "                         THEN '1.2'"
          + "\n" + "                 END"
          + "\n" + "                    END"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*,40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter2539(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter2470(queryBuilder, tuneTable)
    end;

    constructorTInserter2539(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 2742-У
 * @since v.6.20.030.050
 * @version 1.0
 * @author ABP
 */
private class (TInserter2539) TInserter2742(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause17pledge = getAccountMasks("1.7_залог");
        maskClause17pledge = ternary(maskClause17pledge == null, "1=0", maskClause17pledge);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause18pledge = getAccountMasks("1.8_залог");
        maskClause18pledge = ternary(maskClause18pledge == null, "1=0", maskClause18pledge);

        masksP = "40907*,40908*";
        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        masksP = "40108*,40109*,40110*,40111*";
        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN " + maskClause15
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN " + maskClause16
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND (   data.t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                 OR (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                     AND data.t_isEmployer = 'X'"
          + "\n" + "                    )"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause17pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND (   data.t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                 OR (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                     AND data.t_isEmployer = 'X'"
          + "\n" + "                    )"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7_з'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause18pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.8_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter2742(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter2539(queryBuilder, tuneTable);
    end;

    constructorTInserter2742(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 2926-У
 * @since v.6.20.030.057
 * @version 1.0
 * @author GWW
 */
private class (TInserter2742) TInserter2926(queryBuilder : Object, tuneTable : RcbTuneTable)
    macro insertData(dataQuery : String)
        var maskClause = getAccountMasks();
        maskClause = ternary(maskClause == null, "", "AND " + maskClause);

        sql_execute( "INSERT INTO df302p2_tmp(t_row, t_sign, t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
            + "\n" + "                        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode)"
            + "\n" + " SELECT t_row, t_sign, t_backOffice, NVL(t_okatoCode, '99999'), t_column, t_accountNumber, t_currencyId,"
            + "\n" + "        t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
            + "\n" + "   FROM (" + dataQuery + ")"
            + "\n" + "  WHERE t_row IS NOT NULL"
            + "\n" + "    AND t_currencySum <> 0"
            + "\n" + "    " + maskClause
            + "\n" + "    OR " + convertMaskToSqlFormat(masksP, "t_accountNumber"));
    end;

    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        masksP = "40907*,40908*";
        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        masksP = "40108*,40109*,40110*,40111*";
        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN " + maskClause15
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN " + maskClause16
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND (   data.t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "                 OR (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                     AND data.t_isEmployer = 'X'"
          + "\n" + "                    )"
          + "\n" + "                )"
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter2926(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter2742(queryBuilder, tuneTable);
    end;

    constructorTInserter2926(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 2969-У
 * @since v.6.20.031.21
 * @version 1.0
 * @author GWW
 */
private class (TInserter2926) TInserter3269(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        masksP = "40907*,40908*";
        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        masksP = "40108*,40109*,40110*,40111*";
        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN " + maskClause15
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN " + maskClause16
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                 AND data.t_isEmployer = 'X'"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

    end;

    private macro constructorTInserter3269(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter2926(queryBuilder, tuneTable);
    end;

    constructorTInserter3269(queryBuilder, tuneTable);
end;

/**
 * Класс вставки во временную таблицу в соответствии с 3468-У
 * @since v.6.20.031.26
 * @version 1.0
 * @author GWW
 */
private class (TInserter3269) TInserter3468(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        masksP = "40907*,40908*";
        insertData("SELECT CASE"
          + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
          + "\n" + "                THEN '1'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");

        masksP = "40108*,40109*,40110*,40111*";
        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN " + maskClause15
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN " + maskClause16
          + "\n" + "            AND NOT (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                     AND data.t_isEmployer = 'X'"
          + "\n" + "                    )"
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND (    data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "                 AND data.t_isEmployer = 'X'"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_JURIDICAL_PERSON
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_legalForm = " + RCB_NATURAL_PERSON
          + "\n" + "            AND data.t_isEmployer != 'X'"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter3468(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter3269(queryBuilder, tuneTable);
    end;

    constructorTInserter3468(queryBuilder, tuneTable);
end;

private class (TInserter3468) TInserter3656(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        if (isBackofficeSet(BOCB, RCB_I3656_DATE, "2", "1", "4,5"))
            masksP = "40907*,40908*";
            insertData("SELECT CASE"
              + "\n" + "            WHEN (    " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
              + "\n" + "                   AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")+ ")"
              + "\n" + "                THEN '1'"
              + "\n" + "       END t_row,"
              + "\n" + "       CASE"
              + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
              + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
              + "\n" + "                THEN '-'"
              + "\n" + "            ELSE CHR(0)"
              + "\n" + "       END t_sign,"
              + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
              + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
              + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
        end;

        if (isBackofficeSet(BOCB, RCB_I3656_DATE, "2", "1.1", "4,5"))
            masksP = "40108*,40109*,40110*,40111*";
        else
            masksP = "1 = 1";
        end;

        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN ((" + maskClause15 + " AND data.t_accountNumber NOT LIKE '40821%') OR ( data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "1, 2 ,3 ,4 ,5 ,6 ,7 ,8 ,9 ,10", RCB_OBJGROUP_PT_ECONOMICACTORS) + ") )"
          + "\n" + "             AND NOT (    data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN ((" + maskClause16 + " AND data.t_accountNumber NOT LIKE '40821%') OR ( data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "11, 12, 13, 14, 15", RCB_OBJGROUP_PT_ECONOMICACTORS) + ") )"
          + "\n" + "             AND NOT (    data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND (    data.t_isPhisical = 1"
          + "\n" + "                 AND data.t_isEmployer = 1"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND data.t_isPhisical = 0"
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter3656(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter3468(queryBuilder, tuneTable);
    end;

    constructorTInserter3656(queryBuilder, tuneTable);
end;

private class (TInserter3656) TInserter3875(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(isCurrency : Bool)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null, "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        if (isBackofficeSet(BOCB, RCB_I3656_DATE, "2", "1", "4,5"))
            masksP = "40907*,40908*";
            insertData("SELECT CASE"
              + "\n" + "            WHEN (    (       " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
              + "\n" + "                       AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
              + "\n" + "                      )"
              + "\n" + "                   OR (" + maskClause17 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
              + "\n" + "                       AND (" + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
              + "\n" + "                      )"
              + "\n" + "                 )"
              + "\n" + "                THEN '1'"
              + "\n" + "       END t_row,"
              + "\n" + "       CASE"
              + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
              + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
              + "\n" + "                THEN '-'"
              + "\n" + "            ELSE CHR(0)"
              + "\n" + "       END t_sign,"
              + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
              + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
              + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
        end;

        if (isBackofficeSet(BOCB, RCB_I3656_DATE, "2", "1.1", "4,5"))
            masksP = "40108*,40109*,40110*,40111*";
        else
            masksP = "1 = 1";
        end;

        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN ((" + maskClause15 + " AND data.t_accountNumber NOT LIKE '40821%') OR ( data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "1, 2, 3, 4, 5, 6, 7, 8, 9, 10", RCB_OBJGROUP_PT_ECONOMICACTORS) + ") )"          + "\n" + "             AND NOT (    data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN ((" + maskClause16 + " AND data.t_accountNumber NOT LIKE '40821%') OR ( data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "11, 12, 13, 14", RCB_OBJGROUP_PT_ECONOMICACTORS) + ") )"
          + "\n" + "             AND NOT (    data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND NOT(" + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE) + ")"
          + "\n" + "            AND (    data.t_isPhisical = 1"
          + "\n" + "                 AND data.t_isEmployer = 1"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND data.t_isPhisical = 0"
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(isCurrency) + ") data");
    end;

    private macro constructorTInserter3875(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter3656(queryBuilder, tuneTable);
    end;

    constructorTInserter3875(queryBuilder, tuneTable);
end;

private class (TInserter3875) TInserter4637(queryBuilder : Object, tuneTable : RcbTuneTable)
    private macro processRows(currencyIsoCode : String)
        var maskClause1 = getAccountMasks("1");
        maskClause1 = ternary(maskClause1 == null,   "1=0", maskClause1);

        var maskClause11 = getAccountMasks("1.1");
        maskClause11 = ternary(maskClause11 == null, "1=0", maskClause11);

        var maskClause12 = getAccountMasks("1.2");
        maskClause12 = ternary(maskClause12 == null, "1=0", maskClause12);

        var maskClause13 = getAccountMasks("1.3");
        maskClause13 = ternary(maskClause13 == null, "1=0", maskClause13);

        var maskClause14 = getAccountMasks("1.4");
        maskClause14 = ternary(maskClause14 == null, "1=0", maskClause14);

        var maskClause15 = getAccountMasks("1.5");
        maskClause15 = ternary(maskClause15 == null, "1=0", maskClause15);

        var maskClause16 = getAccountMasks("1.6");
        maskClause16 = ternary(maskClause16 == null, "1=0", maskClause16);

        var maskClause17 = getAccountMasks("1.7");
        maskClause17 = ternary(maskClause17 == null, "1=0", maskClause17);

        var maskClause18 = getAccountMasks("1.8");
        maskClause18 = ternary(maskClause18 == null, "1=0", maskClause18);

        var maskClause19 = getAccountMasks("1.9");
        maskClause19 = ternary(maskClause19 == null, "1=0", maskClause19);

        var maskClause19pledge = getAccountMasks("1.9_залог");
        maskClause19pledge = ternary(maskClause19pledge == null, "1=0", maskClause19pledge);

        if (isBackofficeSet(BOCB, RCB_I4637_DATE, "2", "1", "4,5,6,7,8"))
            masksP = "40907*,40908*";
            insertData("SELECT CASE"
              + "\n" + "            WHEN (    (       " + maskClause1 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
              + "\n" + "                       AND (NOT " + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'")
              + "\n" + "                      )"
              + "\n" + "                   OR (" + maskClause17 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
              + "\n" + "                       AND (" + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE)
              + "\n" + "                      )"
              + "\n" + "                 )"
              + "\n" + "                THEN '1'"
              + "\n" + "       END t_row,"
              + "\n" + "       CASE"
              + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40908*", "t_accountNumber")
              + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
              + "\n" + "                THEN '-'"
              + "\n" + "            ELSE CHR(0)"
              + "\n" + "       END t_sign,"
              + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
              + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
              + "\n" + "  FROM (" + m_queryBuilder.getQuery(currencyIsoCode) + ") data");
        end;

        if (isBackofficeSet(BOCB, RCB_I4637_DATE, "2", "1.1", "4,5,6,7,8"))
            masksP = "40108*,40109*,40110*,40111*";
        else
            masksP = "1 = 1";
        end;

        insertData("SELECT CASE"
          + "\n" + "           WHEN (" + maskClause11 + " OR " + convertMaskToSqlFormat(masksP, "t_accountNumber") + ")"
          + "\n" + "           THEN '1.1'"
          + "\n" + "           WHEN " + maskClause12
          + "\n" + "           THEN '1.2'"
          + "\n" + "           WHEN " + maskClause13
          + "\n" + "           THEN '1.3'"
          + "\n" + "           WHEN " + maskClause14
          + "\n" + "           THEN '1.4'"
          + "\n" + "           WHEN ((" + maskClause15 + " AND data.t_accountNumber NOT LIKE '40821%') OR (data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "1, 2, 3, 4, 5, 6, 7, 8, 9, 10", RCB_OBJGROUP_PT_ECONOMICACTORS) + "))"          + "\n" + "             AND NOT (data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.5'"
          + "\n" + "           WHEN ((" + maskClause16 + " AND data.t_accountNumber NOT LIKE '40821%') OR (data.t_accountNumber LIKE '40821%' AND " + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "11, 12, 13, 14", RCB_OBJGROUP_PT_ECONOMICACTORS) + "))"
          + "\n" + "             AND NOT (    data.t_isPhisical = 1"
          + "\n" + "                      AND data.t_isEmployer = 1"
          + "\n" + "                     )"
          + "\n" + "           THEN '1.6'"
          + "\n" + "           WHEN " + maskClause17
          + "\n" + "            AND NOT(" + m_queryBuilder.hasAssignedPartyCategory("data.t_objectId", "2, 3, 10", RCB_OBJGROUP_PT_TYPE) + ")"
          + "\n" + "            AND (    data.t_isPhisical = 1"
          + "\n" + "                 AND data.t_isEmployer = 1"
          + "\n" + "                )"
          + "\n" + "           THEN '1.7'"
          + "\n" + "           WHEN " + maskClause18
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'СубКредит'") + ")"
          + "\n" + "            AND data.t_isPhisical = 0"
          + "\n" + "           THEN '1.8'"
          + "\n" + "           WHEN " + maskClause19
          + "\n" + "            AND NOT (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9'"
          + "\n" + "           WHEN " + maskClause19pledge
          + "\n" + "            AND (" + m_queryBuilder.hasAssignedAccountCategory("data.t_accountNumber", "data.t_currencyId", 1, "'Залог'") + ")"
          + "\n" + "            AND data.t_isPhisical = 1"
          + "\n" + "            AND data.t_isEmployer = 0"
          + "\n" + "           THEN '1.9_з'"
          + "\n" + "       END t_row,"
          + "\n" + "       CASE"
          + "\n" + "            WHEN (    " + convertMaskToSqlFormat("40109*,40111*", "t_accountNumber")
          + "\n" + "                   AND NOT " + m_queryBuilder.isBank("data.t_partyId") + " )"
          + "\n" + "                THEN '-'"
          + "\n" + "            ELSE CHR(0)"
          + "\n" + "       END t_sign,"
          + "\n" + "       t_backOffice, t_okatoCode, t_column, t_accountNumber, t_currencyId,"
          + "\n" + "       t_roubleSum, t_currencySum, t_recalculateRateDate, t_clientKind, t_shortName, t_clientCode"
          + "\n" + "  FROM (" + m_queryBuilder.getQuery(currencyIsoCode) + ") data");
    end;

    private macro constructorTInserter4637(queryBuilder : Object, tuneTable : RcbTuneTable)
        initTInserter3875(queryBuilder, tuneTable);
    end;

    macro execute()
        initialize();
        processRows("643"); //рубли
        processRows("840"); //доллары США
        processRows("978"); //евро
        processRows("156"); //юани
        processRows("");    //все остальные
    end;

    constructorTInserter4637(queryBuilder, tuneTable);
end;

/***************************************************************************************************
 *  Базовый класс  построения запроса
 **************************************************************************************************/
private class TQueryBuilder()

    // Является банком
    macro isBank(clientCodeAlias : String)
        var filter =   "EXISTS(SELECT 1"
                +"\n"+ "         FROM dpartyown_dbt partyown"
                +"\n"+ "        WHERE partyown.t_partyId = " + clientCodeAlias
                +"\n"+ "          AND partyown.t_partykind = " + RCB_PTK_BANK + ")";
        return filter;
    end;

    private macro hasAssignedCategory(objectType : Integer, objectId : String, groupID : Integer, listCategory : String) : String
        var filter = "";
        if (listCategory != NULL)
            filter = "EXISTS(SELECT 1"
              +"\n"+ "         FROM dobjatcor_dbt atc"
              +"\n"+ "        WHERE atc.t_ObjectType = " + objectType
              +"\n"+ "          AND atc.t_GroupID    = " + groupID
              +"\n"+ "          AND atc.t_Object     = " + objectId
              +"\n"+ "          AND atc.t_AttrID IN (SELECT att.t_AttrID"
              +"\n"+ "                                 FROM dobjattr_dbt att"
              +"\n"+ "                                WHERE att.t_ObjectType = atc.t_ObjectType"
              +"\n"+ "                                  AND att.t_GroupID    = atc.t_GroupID"
              +"\n"+ "                                  AND att.t_numInList  IN (" + listCategory + "))"
              +"\n"+ "          AND " + getSqlDate(rcbApplication().currentReport.context.period.endDate) + " BETWEEN atc.t_ValidFromDate AND atc.t_ValidToDate)";
        else
            filter = "1 = 1";
        end;
        return filter;
    end;

    // Установлена категория отчетности
    macro hasAssignedAccountCategory(accountAlias : String, fiIdAlias : String, chapterAlias : String, listCategory : String, groupID : Integer) : String
        return hasAssignedCategory(RCB_OBJTYPE_ACCOUNT,
                                   "rsb_rep_ac.makeAccountId("+accountAlias+", "+fiIdAlias+", "+chapterAlias+", NULL)",
                                   ternary(groupID != NULL, groupID, RCB_OBJGROUP_REPORT),
                                   listCategory);
    end;

    /**
     *  Установлена категория на субъекта экономики.
     *  @param     accountAlias  наименование поля "код клиента"
     *  @param     category      категория объекта
     *  @param     groupID       группа категорий объекта
     */
    macro hasAssignedPartyCategory(clientCodeAlias : String, listCategory : String, groupID : Integer) : String
        return hasAssignedCategory(RCB_OBJTYPE_PARTY,
                                   clientCodeAlias,
                                   groupID,
                                   listCategory);
    end;

    private macro getRecalculateRateDateQuery()
        return        "                        CASE"
            +  "\n" + "                            WHEN (t_close_date < " + getSqlDate(ДатаОтчета) + " AND t_close_date <> " + getSqlDate("01.01.0001") + ")"
            +  "\n" + "                                THEN t_close_date"
            +  "\n" + "                            ELSE " + getSqlDate(ДатаОтчета)
            +  "\n" + "                        END";
    end;

    private macro getClientKindQuery()
        return        "                        CASE"
            +  "\n" + "                            WHEN t_legalForm = " + RCB_JURIDICAL_PERSON
            +  "\n" + "                                THEN 'Ю'"
            +  "\n" + "                            WHEN (t_legalForm = " + RCB_NATURAL_PERSON + " AND t_isEmployer = CHR(0))"
            +  "\n" + "                                THEN 'Ф'"
            +  "\n" + "                            WHEN (t_legalForm = " + RCB_NATURAL_PERSON + " AND t_isEmployer = 'X')"
            +  "\n" + "                                THEN 'П'"
            +  "\n" + "                            ELSE CHR(1)"
            +  "\n" + "                        END";
    end;

    private macro getClientIdQuery()
        return              "NVL((SELECT TO_NUMBER(TRIM(LEADING '0' FROM t_attrId))"
            +  "\n" + "             FROM dobjlink_dbt"
            +  "\n" + "            WHERE t_objectType = " + RCB_OBJTYPE_ACCOUNT
            +  "\n" + "              AND t_objectId   = rsb_rep_ac.makeAccountId(ac.t_account, ac.t_code_currency, ac.t_chapter, NULL)"
            +  "\n" + "              AND t_attrType   = " + RCB_OBJTYPE_PARTY
            +  "\n" + "              AND t_GroupID    = " + RCB_OBJROLE_OPERATION_CONTRAGENT + "),"
            +  "\n" + "           DECODE(ac.t_client, " + {OurBank} + ", " + {OurBank} + ", ac.t_client))";
    end;

    private macro getBaseQuery(row : String, isCurrency : Bool, additionalClause : String)
        msgBox("Ошибка! Вызов чисто виртуального метода.");
    end;

    macro getQuery(isCurrency : Bool)
        var filterString = "";

        if (getObjcodeDate() != NULL) /*Если дата отчета задана*/
            filterString = setFilterForCodeDate("pc", getObjcodeDate());
        else /*Если даты отчета нет, то ищем среди активных кодов*/
            filterString = setFilterForCodeDate("pc");
        end;

        return       "SELECT data.*," + getClientKindQuery() + " t_clientKind"
            + "\n" + "  FROM (SELECT t_backOffice, t_column, t_accountNumber, t_currencyId, t_sum t_roubleSum, t_sum t_currencySum,"
            + "\n" + "               t_recalculateRateDate, pc.t_code t_clientCode, pt.t_shortName, pt.t_legalForm, pt.t_partyId,"
            + "\n" + "               repcode.t_okatoCode t_okatoCode,"
            + "\n" + "               (SELECT t_isEmployer"
            + "\n" + "                  FROM dpersn_dbt ps"
            + "\n" + "                 WHERE ps.t_personId = pt.t_partyId) t_isEmployer"
            + "\n" + "          FROM (" + getBaseQuery(isCurrency) + ") dt,"
            + "\n" + "               drepdepcode_vw repcode,"
            + "\n" + "               dparty_dbt    pt,"
            /* 03.10.2007 Malakhova 110424*/
            /*Историчность кодов - заменила dpartCode_dbt на dobjCode_dbt*/
            + "\n" + "               dobjCode_dbt pc"
            + "\n" + "         WHERE pt.t_partyId  = dt.t_partyId"
            + "\n" + "           AND pc.t_objectId = dt.t_partyId"
            + "\n" + "           AND dt.t_department = repcode.t_departmentcode (+)"
            + "\n" + "           AND pc.t_objectType = " + OBJTYPE_PARTY
            + "\n" + "           AND pc.t_codeKind = 1"
            + "\n" + "           AND " + filterString
            + "\n" + "       ) data";
    end;
end;

/***************************************************************************************************
 *  Класс построения запроса по документам
 **************************************************************************************************/
private class (TQueryBuilder) TDocumentQueryBuilder()
    macro getBaseQuery(isCurrency : Bool)

        var tableFilter     = "\n" + " AND ac.t_code_currency = 0 ";
        var column          = "4";
        var sum             = "ad.t_sum_payer";

        if (isCurrency)
            tableFilter     = "\n" + " AND ac.t_code_currency <> 0 ";
            column          = "5";
        end;

        return       "SELECT " + BOCB + " t_backOffice, " + column + " t_column, ac.t_branchId as t_department,"
            + "\n" + "       ad.t_account_receiver t_accountNumber, " + sum + " t_sum, " + getrecalculateRateDateQuery() + " t_recalculateRateDate,"
            + "\n" + "       ac.t_close_date,"
            + "\n" + "       " + getClientIdQuery() + " t_partyId,"
            + "\n" + "       ac.t_code_currency t_currencyId"
            + "\n" + "  FROM daccTrn_dbt ad,"
            + "\n" + "       daccount_dbt ac"
            + "\n" + " WHERE ac.t_chapter  = 1"
            +            tableFilter
            + "\n" + "   AND ac.t_chapter    = ad.t_chapter"
            + "\n" + "   AND ac.t_accountid  = ad.t_accountid_receiver"
            + "\n" + "   AND ad.t_state = 1"
            + "\n" + "   AND ad.t_result_carry NOT IN ("+RCB_RUBCARRY+","+RCB_DELTARATE+", 82, "+DELTARATE_ADD+")"
            + "\n" + "   AND INSTR(ad.t_typeDocument, 'И') = 0"
            + "\n" + "   AND INSTR(ad.t_typeDocument, 'С') = 0"
            + "\n" + "   AND ad.t_sum_payer <> 0"
            + "\n" + "   AND " + RcbAccountFilter().GetAsSqlString("ac")
            + "\n" + "   AND ad.t_date_carry BETWEEN " + getSqlDate(ПредДатаОтчета) + " AND " + getSqlDate(ДатаОтчета);
    end;
    initTQueryBuilder();
end;

/***************************************************************************************************
 *  Класс построения запроса по л/с
 **************************************************************************************************/
private class (TQueryBuilder) TAccountQueryBuilder()
    private macro getRoubleColumnNumber() : String
        return "6";
    end;

    private macro getCurrencyColumnNumber() : String
        return "7";
    end;

    private macro getSumQuery(isCurrency : Bool)
        var tableFilter = "\n" +" AND ac.t_code_currency = " + NATCUR;

        if (isCurrency)
            tableFilter = "\n" +" AND ac.t_code_currency <> " + NATCUR;
        end;

        return   "    NVL((SELECT CASE"
        + "\n" + "                     WHEN (ac.t_kind_account = 'А')"
        + "\n" + "                         THEN -rd.t_rest"
        + "\n" + "                     WHEN (ac.t_kind_account = 'П')"
        + "\n" + "                         THEN rd.t_rest"
        + "\n" + "                     ELSE"
        + "\n" + "                         ABS(rd.t_rest)"
        + "\n" + "                 END"
        + "\n" + "            FROM drestdate_dbt rd"
        + "\n" + "           WHERE rd.t_accountid    = ac.t_accountid"
        +                      tableFilter
        + "\n" + "             AND rd.t_restcurrency = " + NATCUR
        + "\n" + "             AND rd.t_restdate IN (SELECT MAX(t_restdate)"
        + "\n" + "                                       FROM drestdate_dbt"
        + "\n" + "                                      WHERE t_accountid     = rd.t_accountid"
        + "\n" + "                                        AND t_restcurrency  = rd.t_restcurrency"
        +                                                 tableFilter
        + "\n" + "                                        AND t_restdate     <= " + getSqlDate(ДатаОтчета) + ")), 0)";
    end;

    private macro getBaseQuery(isCurrency : Bool)
        var tableFilter = " AND ac.t_code_currency = 0 ";
        var column          = getRoubleColumnNumber();
        var sum             = getSumQuery(false);
        var filter          = "\n" + "   AND INSTR( ac.t_type_account, 'П') = 0";


        if (isCurrency)
            tableFilter = " AND ac.t_code_currency <> 0 ";
            column          = getCurrencyColumnNumber();
            sum             = getSumQuery(true);
            filter          = "";
        end;

        return       "SELECT " + BOCB + " t_backOffice, " + column + " t_column, ac.t_branchId as t_department,"
            + "\n" + "       ac.t_account t_accountNumber, " + sum + " t_sum, " + getRecalculateRateDateQuery() + " t_recalculateRateDate,"
            + "\n" + "       " + getClientIdQuery() + " t_partyId,"
            + "\n" + "       ac.t_close_date, ac.t_code_currency t_currencyId"
            + "\n" + "  FROM daccount_dbt ac"
            + "\n" + " WHERE ac.t_chapter = 1"
            +          tableFilter
            + "\n" + "   AND (     ac.t_open_date <= " + getSqlDate(ДатаОтчета)
            + "\n" + "         AND (    ac.t_close_date >= " + getSqlDate(ПредДатаОтчета)
            + "\n" + "               OR ac.t_close_date  = " + getSqlDate(Date(0, 0, 0)) + "))"
            + "\n" + "   AND " + RcbAccountFilter().GetAsSqlString("ac")
            + filter;
    end;

    initTQueryBuilder();
end;
/***************************************************************************************************
 *  Класс построения запроса по л/с после 1948У
 **************************************************************************************************/
private class (TAccountQueryBuilder) TAccountQueryBuilder1948()
    private macro getRoubleColumnNumber() : String
        return "4";
    end;

    private macro getCurrencyColumnNumber() : String
        return "5";
    end;

    private macro getRecalculateRateDateQuery()
        return getSqlDate(ДатаОтчета);
    end;

    initTAccountQueryBuilder();
end;

/***************************************************************************************************
 *  Класс построения запроса по л/с после 2926У
 **************************************************************************************************/
private class (TAccountQueryBuilder1948) TAccountQueryBuilder2926()

     macro getQuery(isCurrency : Bool)
        var filterString = "";

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_I2926_DATE);

        if (getObjcodeDate() != NULL) /*Если дата отчета задана*/
            filterString = setFilterForCodeDate("pc", getObjcodeDate());
        else /*Если даты отчета нет, то ищем среди активных кодов*/
            filterString = setFilterForCodeDate("pc");
        end;

        return       "WITH accData AS (SELECT data.*," + getClientKindQuery() + " t_clientKind"
            + "\n" + "  FROM (SELECT t_backOffice, t_column, t_accountNumber, t_currencyId, t_sum t_roubleSum, t_sum t_currencySum,"
            + "\n" + "               t_recalculateRateDate, pc.t_code t_clientCode, pt.t_shortName, pt.t_legalForm, pt.t_partyId,"
            + "\n" + "               repcode.t_okatoCode t_okatoCode,"
            + "\n" + "               (SELECT t_isEmployer"
            + "\n" + "                  FROM dpersn_dbt ps"
            + "\n" + "                 WHERE ps.t_personId = pt.t_partyId) t_isEmployer"
            + "\n" + "          FROM (" + getBaseQuery(isCurrency) + ") dt,"
            + "\n" + "               drepdepcode_tmp repcode,"
            + "\n" + "               dparty_dbt    pt,"
            + "\n" + "               dobjCode_dbt pc"
            + "\n" + "         WHERE pt.t_partyId  = dt.t_partyId"
            + "\n" + "           AND pc.t_objectId = dt.t_partyId"
            + "\n" + "           AND dt.t_department = repcode.t_departmentcode (+)"
            + "\n" + "           AND pc.t_objectType = " + OBJTYPE_PARTY
            + "\n" + "           AND pc.t_codeKind = 1"
            + "\n" + "           AND " + filterString
            + "\n" + "       ) data)"
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_legalForm,"
            + "\n" + "         accData.t_partyId, RPAD(SUBSTR(accData.t_okatoCode, 1, 2), 5, '0') t_okatoCode, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData "
            + "\n" + "UNION ALL "
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_legalForm,"
            + "\n" + "         accData.t_partyId, okatoTable.t_okato, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData, (" + okatoTuneTable.getQuery() + ") okatoTable"
            + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, accData.t_okatoCode) = 1";
    end;

    initTAccountQueryBuilder1948();
end;

/***************************************************************************************************
 *  Класс построения запроса по л/с после 2926У
 **************************************************************************************************/
private class (TAccountQueryBuilder2926) TAccountQueryBuilder_Okved()

    macro getQuery(isCurrency : Bool)
        var filterString = "";

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_OKVED_DATE);

        if (getObjcodeDate() != NULL) /*Если дата отчета задана*/
            filterString = setFilterForCodeDate("pc", getObjcodeDate());
        else /*Если даты отчета нет, то ищем среди активных кодов*/
            filterString = setFilterForCodeDate("pc");
        end;

        return       "WITH accData AS (SELECT data.*," + getClientKindQuery() + " t_clientKind"
            + "\n" + "  FROM (SELECT t_backOffice, t_column, t_accountNumber, t_currencyId, t_sum t_roubleSum, t_sum t_currencySum,"
            + "\n" + "               t_recalculateRateDate, pc.t_code t_clientCode, pt.t_shortName, pt.t_legalForm, pt.t_partyId,"
            + "\n" + "               repcode.t_okatoCode t_okatoCode,"
            + "\n" + "               (SELECT t_isEmployer"
            + "\n" + "                  FROM dpersn_dbt ps"
            + "\n" + "                 WHERE ps.t_personId = pt.t_partyId) t_isEmployer"
            + "\n" + "          FROM (" + getBaseQuery(isCurrency) + ") dt,"
            + "\n" + "               drepdepcode_tmp repcode,"
            + "\n" + "               dparty_dbt    pt,"
            + "\n" + "               dobjCode_dbt pc"
            + "\n" + "         WHERE pt.t_partyId  = dt.t_partyId"
            + "\n" + "           AND pc.t_objectId = dt.t_partyId"
            + "\n" + "           AND dt.t_department = repcode.t_departmentcode (+)"
            + "\n" + "           AND pc.t_objectType = " + OBJTYPE_PARTY
            + "\n" + "           AND pc.t_codeKind = 1"
            + "\n" + "           AND " + filterString
            + "\n" + "       ) data)"
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_legalForm,"
            + "\n" + "         accData.t_partyId, RPAD(SUBSTR(accData.t_okatoCode, 1, 2), 5, '0') t_okatoCode, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData "
            + "\n" + "UNION ALL "
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_legalForm,"
            + "\n" + "         accData.t_partyId, okatoTable.t_okato, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData, (" + okatoTuneTable.getQuery() + ") okatoTable"
            + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, accData.t_okatoCode) = 1";
    end;

    initTAccountQueryBuilder2926();
end;

private class (TAccountQueryBuilder_Okved) TAccountQueryBuilder_3656()

    //является банком
    macro isBank(clientCodeAlias : String)
        var filter =   "((SELECT t_isBank"
                +"\n"+ "    FROM dRepParty_vw partyown"
                +"\n"+ "   WHERE partyown.t_id = " + clientCodeAlias + ") = 1)";
        return filter;
    end;

    //на объекте установлена категория
    private macro hasAssignedCategory(objectType : Integer, objectId : String, groupID : Integer, listCategory : String) : String
        var filter = "";
        if (listCategory != NULL)
            filter = "EXISTS(SELECT 1"
              +"\n"+ "         FROM dRepCategory_vw atc"
              +"\n"+ "        WHERE atc.t_objectType = " + objectType
              +"\n"+ "          AND atc.t_id         = " + groupID
              +"\n"+ "          AND atc.t_ObjectId   = " + objectId
              +"\n"+ "          AND atc.t_value IN (" + listCategory + ")"
              +"\n"+ "          AND atc.t_isInstalledOverPeriod = 1)";
        else
            filter = "1 = 1";
        end;
        return filter;
    end;

    private macro getClientKindQuery()
        return        "                        CASE"
            +  "\n" + "                            WHEN t_isPhisical = 0"
            +  "\n" + "                                THEN 'Ю'"
            +  "\n" + "                            WHEN (t_isPhisical = 1 AND t_isEmployer = 0)"
            +  "\n" + "                                THEN 'Ф'"
            +  "\n" + "                            WHEN (t_isPhisical = 1 AND t_isEmployer = 1)"
            +  "\n" + "                                THEN 'П'"
            +  "\n" + "                            ELSE CHR(1)"
            +  "\n" + "                        END";
    end;

    private macro getSumQuery(isCurrency : Bool)
        var tableFilter = "\n" +"             AND ac.t_fiid = " + NATCUR;

        if (isCurrency)
            tableFilter = "\n" +"             AND ac.t_fiid <> " + NATCUR;
        end;

        return
          "\n" + "    NVL((SELECT CASE"
        + "\n" + "                    WHEN ac.t_fiid = " + NATCUR
        + "\n" + "                        THEN rd.t_outRest"
        + "\n" + "                    ELSE rd.t_outCoverRest"
        + "\n" + "                END"
        + "\n" + "           FROM drepAccount_vw rd"
        + "\n" + "          WHERE rd.t_accountid = ac.t_accountid"
        +                         tableFilter
        + "\n" + "        ), 0)"
        ;
    end;

    private macro getBaseQuery(isCurrency : Bool)
        var tableFilter = "\n" + "   AND ac.t_fiid = 0 ";
        var column      = getRoubleColumnNumber();
        var sum         = getSumQuery(false);
        var filter      = "\n" + "   AND INSTR( ac.t_type, 'П') = 0";

        if (isCurrency)
            tableFilter = "\n" + "   AND ac.t_fiid <> 0 ";
            column      = getCurrencyColumnNumber();
            sum         = getSumQuery(true);
            filter      = "";
        end;

        return       "SELECT " + BOCB + " t_backOffice, " + column + " t_column, ac.t_branchId as t_department,"
            + "\n" + "       ac.t_account t_accountNumber, " + sum + " t_sum, " + getRecalculateRateDateQuery() + " t_recalculateRateDate,"
            + "\n" + "       ac.t_contragentId t_partyId,"
            + "\n" + "       ac.t_closeDate, ac.t_fiid t_currencyId"
            + "\n" + "  FROM drepaccount_vw ac"
            + "\n" + " WHERE ac.t_chapter           = 1"
            +          tableFilter
            + "\n" + "   AND ac.t_isOpenedAtEndDate = 1"
            + "\n" + "   AND " + RcbAccountFilter().GetAsSqlString("ac")
            + filter;
    end;

    macro getQuery(isCurrency : Bool)
        var filterString = setFilterForCodeDate("pc");

        var okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
        okatoTuneTable.setInstructionFilter(RCB_OKVED_DATE);

        return       "WITH accData AS (SELECT data.*," + getClientKindQuery() + " t_clientKind"
            + "\n" + "  FROM (SELECT t_backOffice, t_column, t_accountNumber, t_currencyId, t_sum t_roubleSum, t_sum t_currencySum,"
            + "\n" + "               t_recalculateRateDate, pc.t_code t_clientCode, pt.t_shortName, pt.t_isPhisical, pt.t_id t_partyId, pt.t_objectId t_objectId,"
            + "\n" + "               repcode.t_okatoCode t_okatoCode,"
            + "\n" + "               pt.t_isEmployer t_isEmployer"
            + "\n" + "          FROM (" + getBaseQuery(isCurrency) + ") dt,"
            + "\n" + "               drepdepcode_tmp repcode,"
            + "\n" + "               drepparty_vw    pt,"
            + "\n" + "               dobjCode_dbt    pc"
            + "\n" + "         WHERE pt.t_id         = dt.t_partyId"
            + "\n" + "           AND pc.t_objectId   = dt.t_partyId"
            + "\n" + "           AND dt.t_department = repcode.t_departmentcode"
            + "\n" + "           AND pc.t_objectType = " + OBJTYPE_PARTY
            + "\n" + "           AND pc.t_codeKind   = " + PTCK_CONTR
            + "\n" + "           AND " + filterString
            + "\n" + "       ) data)"
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_isPhisical,"
            + "\n" + "         accData.t_partyId, accData.t_objectId, RPAD(SUBSTR(accData.t_okatoCode, 1, 2), 5, '0') t_okatoCode, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData "
            + "\n" + "UNION ALL "
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_isPhisical,"
            + "\n" + "         accData.t_partyId, accData.t_objectId, okatoTable.t_okato, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData, (" + okatoTuneTable.getQuery() + ") okatoTable"
            + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, accData.t_okatoCode) = 1";
    end;

    initTAccountQueryBuilder_Okved();
end;

private class (TAccountQueryBuilder_3656) TAccountQueryBuilder_4637()
    private macro getSumQuery(currencyIsoCode : String)
        var tableFilter = ternary(currencyIsoCode != "",
                                  "\n             AND ac.t_fiid = (SELECT fi.t_id FROM dRepFinInstrument_vw fi WHERE fi.t_isoNumber = " + getSqlString(currencyIsoCode) + ")",
                                  "\n             AND ac.t_fiid IN (SELECT fi.t_id FROM dRepFinInstrument_vw fi WHERE NOT fi.t_isoNumber IN ('643', '840', '978', '156'))"
                                 );

        return
          "\n" + "    NVL((SELECT CASE"
        + "\n" + "                    WHEN ac.t_fiid = " + NATCUR
        + "\n" + "                        THEN rd.t_outRest"
        + "\n" + "                    ELSE rd.t_outCoverRest"
        + "\n" + "                END"
        + "\n" + "           FROM drepAccount_vw rd"
        + "\n" + "          WHERE rd.t_accountid = ac.t_accountid"
        +                         tableFilter
        + "\n" + "        ), 0)"
        ;
    end;

    private macro getBaseQuery(currencyIsoCode : String)
        var tableFilter = ternary(currencyIsoCode != "",
                                  "\n             AND ac.t_fiid = (SELECT fi.t_id FROM dRepFinInstrument_vw fi WHERE fi.t_isoNumber = " + getSqlString(currencyIsoCode) + ")",
                                  "\n             AND ac.t_fiid IN (SELECT fi.t_id FROM dRepFinInstrument_vw fi WHERE NOT fi.t_isoNumber IN ('643', '840', '978', '156'))"
                                 );
        var sum         = getSumQuery(currencyIsoCode);
        var filter      = ternary(currencyIsoCode == "643", "\n" + "   AND INSTR(ac.t_type, 'П') = 0", "");
        var column;

        if   (currencyIsoCode == "643")
            column = 5;
        elif (currencyIsoCode == "840")
            column = 6;
        elif (currencyIsoCode == "978")
            column = 7;
        elif (currencyIsoCode == "156")
            column = 8;
        else
            column = 4;
        end;

        return       "SELECT " + BOCB   + "                        AS t_backOffice,         "
            + "\n" + "       " + column + "                        AS t_column,             "
            + "\n" + "       ac.t_branchId                         AS t_department,         "
            + "\n" + "       ac.t_account                          AS t_accountNumber,      "
            + "\n" + "       " + sum    + "                        AS t_sum,                "
            + "\n" + "       " + getRecalculateRateDateQuery() + " AS t_recalculateRateDate,"
            + "\n" + "       ac.t_contragentId                     AS t_partyId,            "
            + "\n" + "       ac.t_closeDate                        AS t_closeDate,          "
            + "\n" + "       ac.t_fiid                             AS t_currencyId          "
            + "\n" + "  FROM drepaccount_vw ac                                              "
            + "\n" + " WHERE ac.t_chapter           = 1                                     "
            +          tableFilter
            + "\n" + "   AND ac.t_isOpenedAtEndDate = 1                                     "
            + "\n" + "   AND " + RcbAccountFilter().GetAsSqlString("ac")
            + filter;
    end;

    macro getQuery(currencyIsoCode : String)
        var filterString = setFilterForCodeDate("pc");

        var okatoTuneTable = RcbArTuneTable_4637();

        return       "WITH accData AS (SELECT data.*," + getClientKindQuery() + " t_clientKind"
            + "\n" + "  FROM (SELECT t_backOffice, t_column, t_accountNumber, t_currencyId, t_sum t_roubleSum, t_sum t_currencySum,"
            + "\n" + "               t_recalculateRateDate, pc.t_code t_clientCode, pt.t_shortName, pt.t_isPhisical, pt.t_id t_partyId, pt.t_objectId t_objectId,"
            + "\n" + "               repcode.t_okatoCode t_okatoCode,"
            + "\n" + "               pt.t_isEmployer t_isEmployer"
            + "\n" + "          FROM (" + getBaseQuery(currencyIsoCode) + ") dt,"
            + "\n" + "               drepdepcode_tmp repcode,"
            + "\n" + "               drepparty_vw    pt,"
            + "\n" + "               dobjCode_dbt    pc"
            + "\n" + "         WHERE pt.t_id         = dt.t_partyId"
            + "\n" + "           AND pc.t_objectId   = dt.t_partyId"
            + "\n" + "           AND dt.t_department = repcode.t_departmentcode"
            + "\n" + "           AND pc.t_objectType = " + OBJTYPE_PARTY
            + "\n" + "           AND pc.t_codeKind   = " + PTCK_CONTR
            + "\n" + "           AND " + filterString
            + "\n" + "       ) data)"
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_isPhisical,"
            + "\n" + "         accData.t_partyId, accData.t_objectId, RPAD(SUBSTR(accData.t_okatoCode, 1, 2), 5, '0') t_okatoCode, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData "
            + "\n" + "UNION ALL "
            + "\n" + "  SELECT accData.t_backOffice, accData.t_column, accData.t_accountNumber, accData.t_currencyId, accData.t_roubleSum, "
            + "\n" + "         accData.t_currencySum, accData.t_recalculateRateDate, accData.t_clientCode, accData.t_shortName, accData.t_isPhisical,"
            + "\n" + "         accData.t_partyId, accData.t_objectId, okatoTable.t_okato, accData.t_isEmployer, accData.t_clientKind "
            + "\n" + "    FROM accData, (" + okatoTuneTable.getQuery() + ") okatoTable"
            + "\n" + "   WHERE rsb_mask.compareStringWithMask(okatoTable.t_okatoMasks, accData.t_okatoCode) = 1";
    end;

    initTAccountQueryBuilder_3656();
end;
/***************************************************************************************************
 *  Класс вставки во временную таблицу данных по ГК первого раздела
 **************************************************************************************************/
private class TInserterPart1(okatoTuneTable : RcbTuneTable)
    private var m_processor : Object = NULL;
    private var m_inserter  : Object = TRsbDataSet("SELECT * FROM df302p1_tmp WHERE 1=0", RSDVAL_CLIENT, RSDVAL_STATIC);

    private var m_okatoCodes;

    private macro initOkatoCodes(okatoTuneTable : RcbTuneTable)
        var tuneTable;

        if (valType(okatoTuneTable) == V_UNDEF)
            tuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            tuneTable.setInstructionFilter(RCB_I2332_DATE);
        else
            tuneTable = RcbArTuneTable_4637();
        end;

        m_okatoCodes = tuneTable.getDataSet();
    end;

    initOkatoCodes(okatoTuneTable);


    /*Проверка является ли округ автономным округом.*/
    private macro checkRegion(okato)

        m_okatoCodes.moveFirst;
        m_okatoCodes.movePrev;

        while(m_okatoCodes.moveNext)
            if ((compareStrWithMasks(m_okatoCodes.okatoMasks, okato) == 0))
                return m_okatoCodes.okato;
            end;
        end;

        return null;
    end;

    macro insertRecord(row : String, column : Integer)

        if (m_processor.getRoubleSum(column) == $0)
            return;
        end;

        var okatoCode;

        if (row == "4")
            okatoCode = m_processor.getDataSet().branchOkato;
        else
            okatoCode = m_processor.getDataSet().okato
        end;

        var additionalOkato = checkRegion(okatoCode);

        if(additionalOkato != null)

            m_inserter.addNew();
            m_inserter.okatoCode               = additionalOkato;
            m_inserter.row                     = row;
            m_inserter.column                  = string(column);
            m_inserter.currencyId              = m_processor.getDataSet().fiid;
            m_inserter.roubleSum               = m_processor.getRoubleSum();
            m_inserter.currencySum             = m_processor.getSum();
            m_inserter.account                 = m_processor.getDataSet().account;
            m_inserter.backOffice              = 1;
            m_inserter.openDate                = m_processor.getDataSet().openDate;
            m_inserter.closeDate               = m_processor.getDataSet().closeDate;
            m_inserter.branch                  = m_processor.getDataSet().branchId;

            if (column == 5)
                m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
                m_inserter.recalculateRate     = m_processor.getDataSet().recalculateRate;
            end;
            m_inserter.Update();
        end;

        m_inserter.addNew();
        if (okatoCode == "99999")
            m_inserter.okatoCode       = String(okatoCode);
        else
            m_inserter.okatoCode       = strRPad(subStr(String(okatoCode), 1, 2), 5, "0");
        end;
        m_inserter.row                     = row;
        m_inserter.column                  = string(column);
        m_inserter.currencyId              = m_processor.getDataSet().fiid;
        m_inserter.roubleSum               = m_processor.getRoubleSum();
        m_inserter.currencySum             = m_processor.getSum();
        m_inserter.account                 = m_processor.getDataSet().account;
        m_inserter.backOffice              = 1;
        m_inserter.openDate                = m_processor.getDataSet().openDate;
        m_inserter.closeDate               = m_processor.getDataSet().closeDate;
        m_inserter.branch                  = m_processor.getDataSet().branchId;

        if (column == 5)
            m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
            m_inserter.recalculateRate     = m_processor.getDataSet().recalculateRate;
        end;
        m_inserter.Update();
    end;

    macro initialize(processor : Object)
        m_processor = processor;
    end;
end;

private class (TInserterPart1) TInserterPart1_2835()
    macro insertRecord(row : String, column : Integer)

        if (m_processor.getRoubleSum(column) == $0)
            return;
        end;

        var okatoCode;

        if (row == "4")
            okatoCode = m_processor.getDataSet().branchOkato;
        else
            okatoCode = m_processor.getDataSet().okato
        end;

        var additionalOkato = checkRegion(okatoCode);

        if(additionalOkato != null)

            m_inserter.addNew();
            m_inserter.okatoCode               = additionalOkato;
            m_inserter.row                     = row;
            m_inserter.column                  = string(column);
            m_inserter.currencyId              = m_processor.getDataSet().fiid;
            m_inserter.roubleSum               = m_processor.getRoubleSum();
            m_inserter.currencySum             = m_processor.getSum();
            m_inserter.account                 = m_processor.getDataSet().account;
            m_inserter.backOffice              = 1;
            m_inserter.openDate                = m_processor.getDataSet().openDate;
            m_inserter.closeDate               = m_processor.getDataSet().closeDate;
            m_inserter.branch                  = m_processor.getDataSet().branchId;

            if (column == 5)
                m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
                m_inserter.recalculateRate     = m_processor.getDataSet().recalculateRate;
            end;
            m_inserter.Update();
        end;

        m_inserter.addNew();
        if (okatoCode == "99999")
            m_inserter.okatoCode       = String(okatoCode);
        else
            m_inserter.okatoCode       = strRPad(subStr(String(okatoCode), 1, 2), 5, "0");
        end;
        m_inserter.row                     = row;
        m_inserter.column                  = string(column);
        m_inserter.currencyId              = m_processor.getDataSet().fiid;
        m_inserter.roubleSum               = m_processor.getRoubleSum();
        m_inserter.currencySum             = m_processor.getSum();
        m_inserter.account                 = m_processor.getDataSet().account;
        m_inserter.backOffice              = 1;
        m_inserter.openDate                = m_processor.getDataSet().openDate;
        m_inserter.closeDate               = m_processor.getDataSet().closeDate;
        m_inserter.branch                  = m_processor.getDataSet().branchId;

        if (column == 5)
            m_inserter.recalculateRateDate = m_processor.getDataSet().recalculateRateDate;
            m_inserter.recalculateRate     = m_processor.getDataSet().recalculateRate;
        end;
        m_inserter.Update();
    end;
end;

private class TRowArrayMember()
    var row : String;
    var column : Integer;
end;

/***************************************************************************************************
 *  Класс обработчика данных ГК первого раздела
 **************************************************************************************************/
private class TProcessorPart1 (inserter : Object, dataSet:object, columns : String, instructionDate, balanceTuneTable : RcbTuneTable, okvedTuneTable : RcbTuneTable)

    private var m_dataSet   = dataSet;
    private var m_rowsArray = RcbArray(TRowArrayMember());
    private var m_inserter  = inserter;

    private macro sign(columns)
        if (columns == "4,5")
            return "=";
        end;

        return "<>";
    end;

    private var balanceTuneTableClause;
    if (balanceTuneTable != null)
        balanceTuneTableClause = balanceTuneTable.getQuery();
    else
        balanceTuneTableClause =
                 "SELECT tune.*"
        + "\n" + "  FROM dt302balanceaccounts_dbt tune,"
        + "\n" + "       (SELECT t_part, t_row, t_columns, t_backoffice,"
        + "\n" + "               MAX (t_instructiondate) KEEP (DENSE_RANK FIRST ORDER BY t_part, t_row, t_columns, t_backoffice DESC) t_instructiondate"
        + "\n" + "          FROM dt302balanceaccounts_dbt"
        + "\n" + "         WHERE t_instructiondate <= " + getSqlDate(instructionDate)
        + "\n" + "      GROUP BY t_part, t_row, t_columns, t_backoffice) tempTune"
        + "\n" + " WHERE tune.t_part = tempTune.t_part"
        + "\n" + "   AND tune.t_row = tempTune.t_row"
        + "\n" + "   AND tune.t_columns = tempTune.t_columns"
        + "\n" + "   AND tune.t_backoffice = tempTune.t_backoffice"
        + "\n" + "   AND tune.t_instructiondate = tempTune.t_instructiondate"
        + "\n" + " ORDER BY t_sort";
    end;

    private var okvedTuneTableClause;
    if (okvedTuneTable != null)
        okvedTuneTableClause = okvedTuneTable.getQuery();
    else
        okvedTuneTableClause =
                 "SELECT *"
        + "\n" + "  FROM dt302OkvedMasks_dbt";
    end;

    private var dataSourceClause =
             "WITH balanceTuneTable"
    + "\n" + "AS (" + balanceTuneTableClause
    + "\n" + "   ),"
    + "\n" + "okvedMasks"
    + "\n" + "AS (" + okvedTuneTableClause
    + "\n" + "   )";

    private var rowMasks = TRsbDataSet(dataSourceClause +
                     "\n"+             "SELECT t_row,"
                     "\n"+ "                   t_columns,"
                     "\n"+ "                   t_okvedmasks,"
                     "\n"+ "                   SUBSTR(conStr(',' || t_accountmasks), 2) t_accountmasks,"
                     "\n"+ "                   t_sort"
                     "\n"+               "FROM (SELECT okvedMasks.t_row,"
                     "\n"+                            "balanceAccounts.t_columns,"
                     "\n"+                            "okvedMasks.t_okvedmasks,"
                     "\n"+                            "balanceAccounts.t_accountmasks,"
                     "\n"+                            "okvedMasks.t_sort"
                     "\n"+                       "FROM okvedMasks,"
                     "\n"+                            "balanceTuneTable"
                     "\n"+                      "WHERE t_part = 1"
                     "\n"+                        "AND t_row  =  '2.1.1* - 2.1.9*'"
                     "\n"+                        "AND t_backoffice = 1"
                     "\n"+                      "UNION"
                     "\n"+                     "SELECT '2.1.9' as t_row,"
                     "\n"+                            "balanceTuneTable.t_columns,"
                     "\n"+                            "(SELECT SUBSTR(conStr(','||t_okvedmasks), 2)"
                     "\n"+                               "FROM okvedMasks) as t_okvedmasks,"
                     "\n"+                            "balanceTuneTable.t_accountmasks,"
                     "\n"+                            "240  as t_sort"
                     "\n"+                       "FROM balanceTuneTable"
                     "\n"+                      "WHERE t_part = 1"
                     "\n"+                        "AND t_row  =  '2.1.1* - 2.1.9*'"
                     "\n"+                        "AND t_backoffice = 1"
                     "\n"+                      "UNION"
                     "\n"+                     "SELECT balanceTuneTable.t_row,"
                     "\n"+                            "balanceTuneTable.t_columns,"
                     "\n"+                            "'' as t_okvedmasks,"
                     "\n"+                            "balanceTuneTable.t_accountmasks,"
                     "\n"+                            "250+balanceTuneTable.t_sort as t_sort"
                     "\n"+                       "FROM balanceTuneTable"
                     "\n"+                      "WHERE t_part = 1"
                     "\n"+                        "AND t_row  <>  '2.1.1* - 2.1.9*'"
                     "\n"+                        "AND t_backoffice = 1 ) tuneTable_dbt"
                     "\n"+              "WHERE t_columns" + sign(columns) + "'4,5'"
                     "\n"+ "             GROUP BY t_row,"
                     "\n"+ "                      t_columns,"
                     "\n"+ "                      t_okvedMasks,"
                     "\n"+ "                      t_sort"
                     "\n"+              "ORDER BY t_sort", RSDVAL_CLIENT, RSDVAL_STATIC);

    macro initializeRowsAndColumnArray()
        macro selectRowsForLegal()
            var i;
            rowMasks.moveFirst();
            rowMasks.movePrev();
            m_rowsArray.size = 0;

            while(rowMasks.MoveNext())
                if ((compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0))
                    i = m_rowsArray.size;
                    if((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 0))
                        m_rowsArray[i] = TRowArrayMember();
                        m_rowsArray[i].row = rowMasks.row;
                        if (m_dataSet.fiid == NATCUR)
                            m_rowsArray[i].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[i].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif ((rowMasks.row == "2.1.9") and ((m_dataSet.okved == NULL) or (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 1)))
                        m_rowsArray[i] = TRowArrayMember();
                        m_rowsArray[i].row = rowMasks.row;
                        if (m_dataSet.fiid == NATCUR)
                            m_rowsArray[i].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[i].column = int(substr(rowMasks.columns,3,1));
                        end;
                    elif((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                        m_rowsArray[i] = TRowArrayMember();
                        m_rowsArray[i].row = rowMasks.row;
                        if (m_dataSet.fiid == NATCUR)
                            m_rowsArray[i].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[i].column = int(substr(rowMasks.columns,3,1));
                        end;
                   elif((rowMasks.row == "4") and (m_dataSet.isOperOffice))
                        m_rowsArray[i] = TRowArrayMember();
                        m_rowsArray[i].row = rowMasks.row;
                        if (m_dataSet.fiid == NATCUR)
                            m_rowsArray[i].column = int(substr(rowMasks.columns,1,1));
                        else
                            m_rowsArray[i].column = int(substr(rowMasks.columns,3,1));
                        end;

                   end;
                end;
            end;
        end;

        selectRowsForLegal();
    end;

    macro getDataSet()
        return m_dataSet;
    end;

    macro getRowsArray()
        return m_rowsArray;
    end;

    macro getInserter()
        return m_inserter;
    end;
end;

private class TProcessorPart1_2627(inserter : Object, dataSet:object, columns : String)
    private var m_dataSet   = dataSet;
    private var m_rowsArray = RcbArray(TRowArrayMember());
    private var m_inserter  = inserter;

    private macro sign(columns)
        if (columns == "4,5")
            return "=";
        end;

        return "<>";
    end;

    private var rowMasks = TRsbDataSet("SELECT t_row,"
                   + "\n" + "                  t_columns,"
                   + "\n" + "                  NVL(t_okvedmasks, CHR(1)) t_okvedmasks,"
                   + "\n" + "                  NVL(t_okved2masks, CHR(1)) t_okved2masks,"
                   + "\n" + "                  NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) t_accountmasks,"
                   + "\n" + "                  NVL(LTRIM(conStr(',' || t_accountMasksFor_8_9), ','), CHR(1)) t_accountmasks_8_9,"
                   + "\n" + "                  t_sort"
                   + "\n" + "             FROM df302tuneTable_tmp tuneTable"
                   + "\n" + "            WHERE t_columns " + sign(columns) + "'4,5'"
                   + "\n" + "              AND t_backOffice = " + BOCB
                   + "\n" + "            GROUP BY t_row,"
                   + "\n" + "                     t_columns,"
                   + "\n" + "                     t_okvedMasks,"
                   + "\n" + "                     t_okved2Masks,"
                   + "\n" + "                     t_sort"
                   + "\n" + "            ORDER BY t_sort",
                                       RSDVAL_CLIENT, RSDVAL_STATIC
                                      );

    macro initializeRowsAndColumnArray()
        var i;
        var isSuitableForAccountMasks;
        var isSuitableForAccountMasks_8_9;
        rowMasks.moveFirst();
        rowMasks.movePrev();
        m_rowsArray.size = 0;

        while(rowMasks.MoveNext())
            isSuitableForAccountMasks = (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0);
            isSuitableForAccountMasks_8_9 = (compareStrWithMasks(rowMasks.accountMasks_8_9, m_dataSet.account) == 0);

            if (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9)

                if (   (    (   ((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                             or (rowMasks.row == "2.3.1")
                             or (rowMasks.row == "3_кред")
                             or (rowMasks.row == "3_овер")
                             or ((rowMasks.row == "4") and (m_dataSet.isOperOffice == 1))
                             or ((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 0))
                             or ((rowMasks.row == "2.1.9") and ((m_dataSet.okved == NULL) or (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) != 0)))
                            )
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9))
                             or ((rowMasks.columns == "8,9") and isSuitableForAccountMasks_8_9)
                            )
                       )
                    or (    (rowMasks.row == "2.2")
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                             or ((rowMasks.columns == "8,9") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                            )
                       )
                   )
                    i = m_rowsArray.size;
                    m_rowsArray.value(i) = TRowArrayMember();
                    m_rowsArray.value(i).row = ternary(in(rowMasks.row, "3_кред", "3_овер"), "3", rowMasks.row);
                    if (m_dataSet.fiid == NATCUR)
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,1,1));
                    else
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,3,1));
                    end;
                end;
            end;
        end;
    end;

    macro getDataSet()
        return m_dataSet;
    end;

    macro getRowsArray()
        return m_rowsArray;
    end;

    macro getInserter()
        return m_inserter;
    end;
end;

private class (TProcessorPart1_2627) TProcessorPart1_2742(inserter : Object, dataSet : Object, columns : String)

    macro initializeRowsAndColumnArray()
        var i;
        var isSuitableForAccountMasks;
        var isSuitableForAccountMasks_8_9;
        rowMasks.moveFirst();
        rowMasks.movePrev();
        m_rowsArray.size = 0;

        while(rowMasks.MoveNext())
            isSuitableForAccountMasks = (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0);
            isSuitableForAccountMasks_8_9 = (compareStrWithMasks(rowMasks.accountMasks_8_9, m_dataSet.account) == 0);

            if (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9)

                if (   (    (   ((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                             or (rowMasks.row == "2.3.1")
                             or (rowMasks.row == "3_кред")
                             or (rowMasks.row == "3_овер")
                             or ((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 0))
                             or ((rowMasks.row == "2.1.9") and ((m_dataSet.okved == NULL) or (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) != 0)))
                            )
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9))
                             or ((rowMasks.columns == "8,9") and isSuitableForAccountMasks_8_9)
                            )
                       )
                    or (    (rowMasks.row == "2.2")
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                             or ((rowMasks.columns == "8,9") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                            )
                       )
                   )
                    i = m_rowsArray.size;
                    m_rowsArray.value(i) = TRowArrayMember();
                    m_rowsArray.value(i).row = ternary(in(rowMasks.row, "3_кред", "3_овер"), "3", rowMasks.row);
                    if (m_dataSet.fiid == NATCUR)
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,1,1));
                    else
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,3,1));
                    end;
                end;
            end;
        end;
    end;

    initTProcessorPart1_2627(inserter, dataSet, columns);
end;

private class (TProcessorPart1_2627) TProcessorPart1_3129(inserter : Object, dataSet : Object, columns : String)

    macro initializeRowsAndColumnArray()
        var i;
        var isSuitableForAccountMasks;
        var isSuitableForAccountMasks_8_9;
        rowMasks.moveFirst();
        rowMasks.movePrev();
        m_rowsArray.size = 0;

        while(rowMasks.MoveNext())
            isSuitableForAccountMasks = (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0);
            isSuitableForAccountMasks_8_9 = (compareStrWithMasks(rowMasks.accountMasks_8_9, m_dataSet.account) == 0);

            if (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9)

                if (   (    (   ((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                             or ((rowMasks.row == "2.3.1") and ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1)))
                             or (rowMasks.row == "3_кред")
                             or (rowMasks.row == "3_овер")
                             or ((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 0))
                             or ((rowMasks.row == "2.1.9") and ((m_dataSet.okved == NULL) or (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) != 0)))
                            )
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9))
                             or ((rowMasks.columns == "8,9") and isSuitableForAccountMasks_8_9)
                            )
                       )
                    or (    (rowMasks.row == "2.2")
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                             or ((rowMasks.columns == "8,9") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                            )
                       )
                   )
                    i = m_rowsArray.size;
                    m_rowsArray.value(i) = TRowArrayMember();
                    m_rowsArray.value(i).row = ternary(in(rowMasks.row, "3_кред", "3_овер"), "3", rowMasks.row);
                    if (m_dataSet.fiid == NATCUR)
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,1,1));
                    else
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,3,1));
                    end;
                end;
            end;
        end;
    end;

    initTProcessorPart1_2627(inserter, dataSet, columns);
end;

private class (TProcessorPart1_2627) TProcessorPart1_Okved(inserter : Object, dataSet : Object, columns : String)
    macro initializeRowsAndColumnArray()
        var i;
        var isSuitableForAccountMasks;
        var isSuitableForAccountMasks_8_9;
        rowMasks.moveFirst();
        rowMasks.movePrev();
        m_rowsArray.size = 0;

        while(rowMasks.MoveNext())
            isSuitableForAccountMasks = (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0);
            isSuitableForAccountMasks_8_9 = (compareStrWithMasks(rowMasks.accountMasks_8_9, m_dataSet.account) == 0);

            if (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9)

                if (   (    (   ((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                             or ((rowMasks.row == "2.3.1") and (m_dataSet.isPhisical == 1))
                             or (rowMasks.row == "3_кред")
                             or (rowMasks.row == "3_овер")
                             or ((substr(rowMasks.row, 1, 3) == "2.1") and (rowMasks.row != "2.1.9") and ((compareStrWithMasks(rowMasks.okved2Masks, nvl(m_dataSet.okved2,"")) == 0) or ((m_dataSet.okved2 == NULL) and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) == 0))))
                             or ((rowMasks.row == "2.1.9") and (((m_dataSet.okved != NULL) and (compareStrWithMasks(rowMasks.okvedMasks, nvl(m_dataSet.okved,"")) != 0)) or ((m_dataSet.okved2 != NULL) and (compareStrWithMasks(rowMasks.okved2Masks, nvl(m_dataSet.okved2,"")) != 0)) or ((m_dataSet.okved == NULL) and (m_dataSet.okved2 == NULL))))
                            )
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9))
                             or ((rowMasks.columns == "8,9") and isSuitableForAccountMasks_8_9)
                            )
                       )
                    or (    (rowMasks.row == "2.2")
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                             or ((rowMasks.columns == "8,9") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                            )
                       )
                   )
                    i = m_rowsArray.size;
                    m_rowsArray.value(i) = TRowArrayMember();
                    m_rowsArray.value(i).row = ternary(in(rowMasks.row, "3_кред", "3_овер"), "3", rowMasks.row);
                    if (m_dataSet.fiid == NATCUR)
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,1,1));
                    else
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,3,1));
                    end;
                end;
            end;
        end;
    end;

    initTProcessorPart1_2627(inserter, dataSet, columns);
end;

private class (TProcessorPart1_Okved) TProcessorPart1_Okved_Т1_56_15_38_43598(inserter : Object, dataSet : Object, columns : String)
    macro initializeRowsAndColumnArray()
        var i;
        var isSuitableForAccountMasks;
        var isSuitableForAccountMasks_8_9;
        rowMasks.moveFirst();
        rowMasks.movePrev();
        m_rowsArray.size = 0;

        while(rowMasks.MoveNext())
            isSuitableForAccountMasks     = (compareStrWithMasks(rowMasks.accountMasks, m_dataSet.account) == 0);
            isSuitableForAccountMasks_8_9 = (compareStrWithMasks(rowMasks.accountMasks_8_9, m_dataSet.account) == 0);

            if (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9)

                if (   (    (   ((rowMasks.row == "2.3") and ((m_dataSet.isMSP == 1) or ((m_dataSet.isPhisical == 1) and (m_dataSet.isEmployer == 1))))
                             or ((rowMasks.row == "2.3.1") and (m_dataSet.isPhisical == 1))
                             or (rowMasks.row == "3_кред")
                             or (rowMasks.row == "3_овер")
                             or (    (substr(rowMasks.row, 1, 3) == "2.1")
                                 and (rowMasks.row != "2.1.9")
                                 and (compareStrWithMasks(rowMasks.okved2Masks, nvl(m_dataSet.okved2,"")) == 0)
                                )
                             or (    (rowMasks.row == "2.1.9")
                                 and (    (    (m_dataSet.okved2 != NULL)
                                           and (compareStrWithMasks(rowMasks.okved2Masks, nvl(m_dataSet.okved2,"")) != 0)
                                          )
                                       or (m_dataSet.okved2 == NULL)
                                     )
                                )
                            )
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (isSuitableForAccountMasks or isSuitableForAccountMasks_8_9))
                             or ((rowMasks.columns == "8,9") and isSuitableForAccountMasks_8_9)
                            )
                       )
                    or (    (rowMasks.row == "2.2")
                        and (   ((rowMasks.columns == "4,5") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and isSuitableForAccountMasks)
                             or ((rowMasks.columns == "6,7") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                             or ((rowMasks.columns == "8,9") and (m_dataSet.hasToCompleteCalculations == 1) and isSuitableForAccountMasks_8_9)
                            )
                       )
                   )
                    i = m_rowsArray.size;
                    m_rowsArray.value(i) = TRowArrayMember();
                    m_rowsArray.value(i).row = ternary(in(rowMasks.row, "3_кред", "3_овер"), "3", rowMasks.row);
                    if (m_dataSet.fiid == NATCUR)
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,1,1));
                    else
                        m_rowsArray.value(i).column = int(substr(rowMasks.columns,3,1));
                    end;
                end;
            end;
        end;
    end;

    initTProcessorPart1_Okved(inserter, dataSet, columns);
end;

/***************************************************************************************************
 *  Промежуточный класс обработчика данных по ГК
 **************************************************************************************************/
private class TProcessorDecorator(processor : Object)

    private var m_processor = processor;

    private macro initializeRowsAndColumnArray()
        return m_processor.initializeRowsAndColumnArray();
    end;

    private macro getRowsArray()
        return m_processor.getRowsArray();
    end;

    macro getSum()
        return m_processor.getDataSet().sum;
    end;

    macro getRoubleSum()
        return m_processor.getDataSet().roubleSum;
    end;


    macro getDataSet()
        return m_processor.getDataSet();
    end;

    macro execute()
        macro processRow()
            initializeRowsAndColumnArray();
            var i = 0;
            while (i < m_processor.getRowsArray().size)
                m_processor.getInserter().insertRecord(getRowsArray()[i].row, getRowsArray()[i].column);
                i = i + 1;
            end;
        end;

        while (getDataSet().moveNext())
            processRow();
        end;
    end;

    m_processor.getInserter().initialize(this);
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела
 **************************************************************************************************/
class DataSourceForColumns()

    var generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        NVL((SELECT category.t_value"
                      "\n" + "               FROM drepcategory_vw category"
                      "\n" + "              WHERE category.t_isForParty = 1"
                      "\n" + "                AND category.t_id = 12"
                      "\n" + "                AND category.t_objectid = repparty.t_objectid"
                      "\n" + "                AND category.t_isInstalledForEndDate = 1"
                      "\n" + "            ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
                      "\n" + "                      FROM dadress_dbt address"
                      "\n" + "                     WHERE address.t_partyId = repparty.t_id"
                      "\n" + "                       AND address.t_type = 1"
                      "\n" + "                   ), '99999'"
                      "\n" + "                  )"
                      "\n" + "           ) AS t_okato,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 17"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_okved,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM ddp_dep_dbt dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 38"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getSourceQuery()
        throw(TPureVirtualMethodCallException("DataSourceForColumns::getSourceQuery"));
    end;

    macro getData()
        var dataSet = TRsbDataSet(getSourceQuery());
        return dataSet;
    end;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела по 2835-У
 **************************************************************************************************/
class DataSourceForColumns_2835()

    var generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_isOpened,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        repaccount.t_partyId,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM ddp_dep_dbt dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 38"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getOkatoSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "    FROM dobjattr_dbt att,                          "
               "\n" + "         dobjatcor_dbt atc,                         "
               "\n" + "         drepparty_vw repparty                      "
               "\n" + "   WHERE atc.t_groupId      = 12                    "
               "\n" + "     AND atc.t_object         = repparty.t_objectId "
               "\n" + "     AND atc.t_objectType     = 3                   "
               "\n" + "     AND atc.t_general        = 'X'                 "
               "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               "\n" + "     AND atc.t_validFromDate <= " + DateExpression +
               "\n" + "     AND atc.t_validToDate   >= " + DateExpression +
               "\n" + "     AND rownum < 2                                 "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               "\n" + "               FROM dadress_dbt address"
               "\n" + "              WHERE address.t_partyId = " + objectField +
               "\n" + "                AND address.t_type = 1"
               "\n" + "            ), '99999'"
               "\n" + "           )"
               "\n" + "    )";
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "    FROM dobjattr_dbt att,                          "
               "\n" + "         dobjatcor_dbt atc,                         "
               "\n" + "         drepparty_vw repparty                      "
               "\n" + "   WHERE atc.t_groupId        = 17                  "
               "\n" + "     AND atc.t_object         = repparty.t_objectId "
               "\n" + "     AND atc.t_objectType     = 3                   "
               "\n" + "     AND atc.t_general        = 'X'                 "
               "\n" + "     AND atc.t_attrId         = att.t_attrId        "
               "\n" + "     AND atc.t_objectType     = att.t_objectType    "
               "\n" + "     AND atc.t_groupId        = att.t_groupId       "
               "\n" + "     AND atc.t_validFromDate <= " + DateExpression  +
               "\n" + "     AND atc.t_validToDate   >= " + DateExpression  +
               "\n" + "     AND rownum < 2                                 "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    private macro getSourceQuery()
        throw(TPureVirtualMethodCallException("DataSourceForColumns_2835::getSourceQuery"));
    end;

    macro getData()
        var dataSet = TRsbDataSet(getSourceQuery());
        return dataSet;
    end;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 6-9 граф
 **************************************************************************************************/
class (DataSourceForColumns) DataSourceFor6_9Columns()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery +
                                "\n"+                 "SELECT t_account,"
                                "\n"+                        "t_fiid,"
                                "\n"+                        "t_opendate,"
                                "\n"+                        "t_closedate,"
                                "\n"+                        "t_isphisical,"
                                "\n"+                        "t_isemployer,"
                                "\n"+                        "t_isOperOffice,"
                                "\n"+                        "t_branchOKATO,"
                                "\n"+                        "t_branchId,"
                                "\n"+                        "CASE"
                                "\n"+                              "WHEN t_value IS NOT NULL"
                                "\n"+                              "THEN 1"
                                "\n"+                              "ELSE 0"
                                "\n"+                        "END AS t_isMSP,"
                                "\n"+                        "CASE"
                                "\n"+                             "WHEN t_fiid = 0 AND t_balance NOT LIKE '203%'"
                                "\n"+                             "THEN 0"
                                "\n"+                             "ELSE t_outrest"
                                "\n"+                         "END AS t_sum,"
                                "\n"+                         "CASE"
                                "\n"+                             "WHEN t_fiid = 0 AND t_balance NOT LIKE '203%'"
                                "\n"+                             "THEN t_outrest"
                                "\n"+                             "ELSE t_outcoverrest"
                                "\n"+                         "END AS t_roublesum,"
                                "\n"+                         "t_OKATO,"
                                "\n"+                         "t_OKVED"
                                "\n"+                   "FROM repaccountdata"
                                "\n"+                  "WHERE repaccountdata.t_outrest <> 0";

        return sourceQuery;
    end;

    initDataSourceForColumns;
end;

class (DataSourceFor6_9Columns) DataSourceFor6_9Columns_2627()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery
                             + "\n" + "                SELECT accdata.t_account,"
                             + "\n" + "                       accdata.t_fiid,"
                             + "\n" + "                       accdata.t_opendate,"
                             + "\n" + "                       accdata.t_closedate,"
                             + "\n" + "                       accdata.t_isphisical,"
                             + "\n" + "                       accdata.t_isemployer,"
                             + "\n" + "                       accdata.t_isOperOffice,"
                             + "\n" + "                       accdata.t_branchOKATO,"
                             + "\n" + "                       accdata.t_branchId,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_value IS NOT NULL"
                             + "\n" + "                           THEN 1"
                             + "\n" + "                           ELSE 0"
                             + "\n" + "                       END AS t_isMSP,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_fiid = 0 AND accdata.t_balance NOT LIKE '203%'"
                             + "\n" + "                           THEN 0"
                             + "\n" + "                           ELSE accdata.t_outrest"
                             + "\n" + "                       END AS t_sum,"
                             + "\n" + "                       CASE"
                             + "\n" + "                          WHEN accdata.t_fiid = 0 AND accdata.t_balance NOT LIKE '203%'"
                             + "\n" + "                          THEN accdata.t_outrest"
                             + "\n" + "                          ELSE accdata.t_outcoverrest"
                             + "\n" + "                       END AS t_roublesum,"
                             + "\n" + "                       accdata.t_OKATO,"
                             + "\n" + "                       accdata.t_OKVED,"
                             + "\n" + "                       NVL((SELECT 1"
                             + "\n" + "                              FROM drepcategory_vw category"
                             + "\n" + "                             WHERE category.t_objectId = accdata.t_objectId"
                             + "\n" + "                               AND category.t_isInstalledForEndDate = 1"
                             + "\n" + "                               AND category.t_isForAccount = 1"
                             + "\n" + "                               AND category.t_id = 16"
                             + "\n" + "                               AND category.t_value = 'Расчеты'"
                             + "\n" + "                           ), 0"
                             + "\n" + "                          ) AS t_hasToCompleteCalculations"
                             + "\n" + "                  FROM repaccountdata accdata"
                             + "\n" + "                 WHERE accdata.t_outrest <> 0";

        return sourceQuery;
    end;

    initDataSourceFor6_9Columns();
end;

class (DataSourceFor6_9Columns_2627) DataSourceFor6_9Columns_2742()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery
                             + "\n" + "                SELECT accdata.t_account,"
                             + "\n" + "                       accdata.t_fiid,"
                             + "\n" + "                       accdata.t_opendate,"
                             + "\n" + "                       accdata.t_closedate,"
                             + "\n" + "                       accdata.t_isphisical,"
                             + "\n" + "                       accdata.t_isemployer,"
                             + "\n" + "                       accdata.t_branchId,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_value IS NOT NULL"
                             + "\n" + "                           THEN 1"
                             + "\n" + "                           ELSE 0"
                             + "\n" + "                       END AS t_isMSP,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_fiid = 0"
                             + "\n" + "                           THEN 0"
                             + "\n" + "                           ELSE accdata.t_outrest"
                             + "\n" + "                       END AS t_sum,"
                             + "\n" + "                       CASE"
                             + "\n" + "                          WHEN accdata.t_fiid = 0"
                             + "\n" + "                          THEN accdata.t_outrest"
                             + "\n" + "                          ELSE accdata.t_outcoverrest"
                             + "\n" + "                       END AS t_roublesum,"
                             + "\n" + "                       accdata.t_okato,"
                             + "\n" + "                       accdata.t_okved,"
                             + "\n" + "                       NVL((SELECT 1"
                             + "\n" + "                              FROM drepcategory_vw category"
                             + "\n" + "                             WHERE category.t_objectId = accdata.t_objectId"
                             + "\n" + "                               AND category.t_isInstalledForEndDate = 1"
                             + "\n" + "                               AND category.t_isForAccount = 1"
                             + "\n" + "                               AND category.t_id = 16"
                             + "\n" + "                               AND category.t_value = 'Расчеты'"
                             + "\n" + "                           ), 0"
                             + "\n" + "                          ) AS t_hasToCompleteCalculations"
                             + "\n" + "                  FROM repaccountdata accdata"
                             + "\n" + "                 WHERE accdata.t_outrest <> 0"
                             + "\n" + "                   AND accdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                             + "\n" + "                                          AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                             + "\n" + "                   AND EXISTS(SELECT 1"
                             + "\n" + "                                FROM df302tuneTable_tmp tuneTable"
                             + "\n" + "                               WHERE tuneTable.t_backOffice = 1"
                             + "\n" + "                                 AND tuneTable.t_columns IN ('6,7', '8,9')"
                             + "\n" + "                                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1"
                             + "\n" + "                                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, accdata.t_account) = 1"
                             + "\n" + "                                     )"
                             + "\n" + "                             )"
                             ;

        return sourceQuery;
    end;

    initDataSourceFor6_9Columns_2627();
end;

 /***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 6-9 граф по 2835-У
 **************************************************************************************************/
class (DataSourceForColumns_2835) DataSourceFor6_9Columns_2835()

    private macro getOkatoSubQuery69(objectField : String, dateExpression : String, dateExpressionOverdraft : String)
        return        " NVL(("
               "\n" + "     CASE"
               "\n" + "         WHEN NOT EXISTS(SELECT 1"
               "\n" + "                           FROM df302tuneTable_tmp tuneTable         "
               "\n" + "                          WHERE tuneTable.t_backOffice IN ( 1, 2)    "
               "\n" + "                            AND tuneTable.t_columns <> '4,5'         "
               "\n" + "                            AND tuneTable.t_row IN ('2.2', '3_овер') "
               "\n" + "                            AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1)"
               "\n" + "             THEN"
               "\n" + "              (SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "                 FROM dobjattr_dbt att,                          "
               "\n" + "                      dobjatcor_dbt atc,                         "
               "\n" + "                      drepparty_vw repparty                      "
               "\n" + "                WHERE atc.t_groupId      = 12                    "
               "\n" + "                  AND atc.t_object         = repparty.t_objectId "
               "\n" + "                  AND atc.t_objectType     = 3                   "
               "\n" + "                  AND atc.t_general        = 'X'                 "
               "\n" + "                  AND atc.t_attrId         = att.t_attrId        "
               "\n" + "                  AND atc.t_objectType     = att.t_objectType    "
               "\n" + "                  AND atc.t_groupId        = att.t_groupId       "
               "\n" + "                  AND atc.t_validFromDate <= " + DateExpression +
               "\n" + "                  AND atc.t_validToDate   >= " + DateExpression +
               "\n" + "                  AND rownum < 2                                 "
               "\n" + "                  AND repparty.t_id = " + objectField +    ")"
               "\n" + "             ELSE"
               "\n" + "              (SELECT first_value(att.t_numInList) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "                 FROM dobjattr_dbt att,                          "
               "\n" + "                      dobjatcor_dbt atc,                         "
               "\n" + "                      drepparty_vw repparty                      "
               "\n" + "                WHERE atc.t_groupId      = 12                    "
               "\n" + "                  AND atc.t_object         = repparty.t_objectId "
               "\n" + "                  AND atc.t_objectType     = 3                   "
               "\n" + "                  AND atc.t_general        = 'X'                 "
               "\n" + "                  AND atc.t_attrId         = att.t_attrId        "
               "\n" + "                  AND atc.t_objectType     = att.t_objectType    "
               "\n" + "                  AND atc.t_groupId        = att.t_groupId       "
               "\n" + "                  AND atc.t_validFromDate <= " + DateExpressionOverdraft +
               "\n" + "                  AND atc.t_validToDate   >= " + DateExpressionOverdraft +
               "\n" + "                  AND rownum < 2                                 "
               "\n" + "                  AND repparty.t_id = " + objectField +    ")"
               "\n" + "     END),"
               "\n" + "     NVL((SELECT DECODE(address.t_okato, CHR(1), NULL, address.t_okato)"
               "\n" + "            FROM dadress_dbt address"
               "\n" + "           WHERE address.t_partyId = " + objectField +
               "\n" + "             AND address.t_type = 1"
               "\n" + "         ), '99999'"
               "\n" + "        )"
               "\n" + "    )";
    end;

    private macro getSourceQuery()
        var dateExpression = "NVL((SELECT MAX(document.t_date)"
            + "\n" + "           FROM F302DOCWITHCORRECTION_VW document,"
            + "\n" + "                drepaccount_vw repaccount"
            + "\n" + "          WHERE document.t_debetaccountId = repaccount.t_accountid"
            + "\n" + "            AND repaccount.t_partyId = accdata.t_partyId"
            + "\n" + "            AND document.t_debetFiId = accdata.t_fiId"
            + "\n" + "    AND EXISTS(SELECT 1"
            + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
            + "\n" + "                WHERE tuneTable.t_backOffice = 1"
            + "\n" + "                  AND tuneTable.t_columns = '4,5'"
            + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, document.t_debetaccount) = 1"
            + "\n" + "              )"
            + "\n" + "            AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
            + "\n" + "                                    AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
            + "\n" + "            AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
            + "\n" + "        ), " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + ")";

        var dateExpressionOverdraft = "NVL((SELECT MAX(document.t_date)"
            + "\n" + "           FROM F302DOCWITHCORRECTION_VW document,"
            + "\n" + "                drepaccount_vw repaccount"
            + "\n" + "          WHERE document.t_debetaccountId = repaccount.t_accountId"
            + "\n" + "            AND repaccount.t_partyId = accdata.t_partyId"
            + "\n" + "            AND document.t_debetFiId = accdata.t_fiId"
            + "\n" + "    AND EXISTS(SELECT 1"
            + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
            + "\n" + "                WHERE tuneTable.t_backOffice = 1"
            + "\n" + "                  AND tuneTable.t_columns = '4,5'"
            + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, document.t_debetaccount) = 1"
            + "\n" + "              )"
            + "\n" + "            AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
            + "\n" + "                                    AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
            + "\n" + "            AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
            + "\n" + "        ), " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + ")";

        var sourceQuery = generalSourceQuery
                             + "\n" + "                SELECT accdata.t_account,"
                             + "\n" + "                       accdata.t_accountId,"
                             + "\n" + "                       accdata.t_fiid,"
                             + "\n" + "                       accdata.t_opendate,"
                             + "\n" + "                       accdata.t_closedate,"
                             + "\n" + "                       accdata.t_isphisical,"
                             + "\n" + "                       accdata.t_isemployer,"
                             + "\n" + "                       accdata.t_branchId,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_value IS NOT NULL"
                             + "\n" + "                           THEN 1"
                             + "\n" + "                           ELSE 0"
                             + "\n" + "                       END AS t_isMSP,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_fiid = 0"
                             + "\n" + "                           THEN 0"
                             + "\n" + "                           ELSE accdata.t_outrest"
                             + "\n" + "                       END AS t_sum,"
                             + "\n" + "                       CASE"
                             + "\n" + "                          WHEN accdata.t_fiid = 0"
                             + "\n" + "                          THEN accdata.t_outrest"
                             + "\n" + "                          ELSE accdata.t_outcoverrest"
                             + "\n" + "                       END AS t_roublesum,"
                             + "\n" + getOkatoSubQuery69("accdata.t_partyId", dateExpression, dateExpressionOverdraft) + " AS t_okato,"
                             + "\n" + getOkvedSubQuery("accdata.t_partyId", dateExpression) + " AS t_okved,"
                             + "\n" + "                       NVL((SELECT 1"
                             + "\n" + "                              FROM drepcategory_vw category"
                             + "\n" + "                             WHERE category.t_objectId = accdata.t_objectId"
                             + "\n" + "                               AND category.t_isInstalledForEndDate = 1"
                             + "\n" + "                               AND category.t_isForAccount = 1"
                             + "\n" + "                               AND category.t_id = 16"
                             + "\n" + "                               AND category.t_value = 'Расчеты'"
                             + "\n" + "                           ), 0"
                             + "\n" + "                          ) AS t_hasToCompleteCalculations"
                             + "\n" + "                  FROM repaccountdata accdata"
                             + "\n" + "                 WHERE accdata.t_outrest <> 0"
                             + "\n" + "                   AND accdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                             + "\n" + "                                          AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                             + "\n" + "                   AND EXISTS(SELECT 1"
                             + "\n" + "                                FROM df302tuneTable_tmp tuneTable"
                             + "\n" + "                               WHERE tuneTable.t_backOffice = 1"
                             + "\n" + "                                 AND tuneTable.t_columns IN ('6,7', '8,9')"
                             + "\n" + "                                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1"
                             + "\n" + "                                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, accdata.t_account) = 1"
                             + "\n" + "                                     )"
                             + "\n" + "                             )"
                             + "\n" + "                   AND EXISTS(SELECT 1"
                             + "\n" + "                                FROM df302accGroup_tmp creditAcc"
                             + "\n" + "                               WHERE creditAcc.t_accountId = accdata.t_accountId"
                             + "\n" + "                             )"
                             ;

        return sourceQuery;
    end;

    initDataSourceForColumns_2835();
end;

 /***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 6-9 граф по 3129-У
 **************************************************************************************************/
class (DataSourceFor6_9Columns_2835) DataSourceFor6_9Columns_3129()
    initDataSourceFor6_9Columns_2835();

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "   SELECT att.t_numInList"
               "\n" + "    FROM dobjattr_dbt att,"
               "\n" + "         dobjatcor_dbt atc,                                 "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_groupId        = 17                          "
               "\n" + "     AND atc.t_object         = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_general        = 'X'                         "
               "\n" + "     AND atc.t_attrId         = att.t_attrId                "
               "\n" + "     AND atc.t_objectType     = att.t_objectType            "
               "\n" + "     AND atc.t_groupId        = att.t_groupId               "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM dobjattr_dbt att,                          "
               "\n" + "                 dobjatcor_dbt atc,                         "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_groupId        = 17                  "
               "\n" + "             AND atc.t_object         = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND atc.t_general        = 'X'                 "
               "\n" + "             AND atc.t_attrId         = att.t_attrId        "
               "\n" + "             AND atc.t_objectType     = att.t_objectType    "
               "\n" + "             AND atc.t_groupId        = att.t_groupId       "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        repaccount.t_partyId,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM ddp_dep_dbt dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 39"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getSourceQuery()
        var dateExpressionOverdraft = getSqlDate(RcbApplication().currentReport.context.period.endDate);
        var dateExpression   = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var sourceQuery = generalSourceQuery
                             + "\n" + "                SELECT accdata.t_account,"
                             + "\n" + "                       accdata.t_accountId,"
                             + "\n" + "                       accdata.t_fiid,"
                             + "\n" + "                       accdata.t_opendate,"
                             + "\n" + "                       accdata.t_closedate,"
                             + "\n" + "                       accdata.t_isphisical,"
                             + "\n" + "                       accdata.t_isemployer,"
                             + "\n" + "                       accdata.t_branchId,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_value IS NOT NULL"
                             + "\n" + "                           THEN 1"
                             + "\n" + "                           ELSE 0"
                             + "\n" + "                       END AS t_isMSP,"
                             + "\n" + "                       CASE"
                             + "\n" + "                           WHEN accdata.t_fiid = 0"
                             + "\n" + "                           THEN 0"
                             + "\n" + "                           ELSE accdata.t_outrest"
                             + "\n" + "                       END AS t_sum,"
                             + "\n" + "                       CASE"
                             + "\n" + "                          WHEN accdata.t_fiid = 0"
                             + "\n" + "                          THEN accdata.t_outrest"
                             + "\n" + "                          ELSE accdata.t_outcoverrest"
                             + "\n" + "                       END AS t_roublesum,"
                             + "\n" + getOkatoSubQuery69("accdata.t_partyId", dateExpression, dateExpressionOverdraft) + " AS t_okato,"
                             + "\n" + getOkvedSubQuery("accdata.t_partyId", dateExpression) + " AS t_okved,"
                             + "\n" + "                       NVL((SELECT 1"
                             + "\n" + "                              FROM drepcategory_vw category"
                             + "\n" + "                             WHERE category.t_objectId = accdata.t_objectId"
                             + "\n" + "                               AND category.t_isInstalledForEndDate = 1"
                             + "\n" + "                               AND category.t_isForAccount = 1"
                             + "\n" + "                               AND category.t_id = 16"
                             + "\n" + "                               AND category.t_value = 'Расчеты'"
                             + "\n" + "                           ), 0"
                             + "\n" + "                          ) AS t_hasToCompleteCalculations"
                             + "\n" + "                  FROM repaccountdata accdata"
                             + "\n" + "                 WHERE accdata.t_outrest <> 0"
                             + "\n" + "                   AND accdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                             + "\n" + "                                          AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                             + "\n" + "                   AND EXISTS(SELECT 1"
                             + "\n" + "                                FROM df302tuneTable_tmp tuneTable"
                             + "\n" + "                               WHERE tuneTable.t_backOffice = 1"
                             + "\n" + "                                 AND tuneTable.t_columns IN ('6,7', '8,9')"
                             + "\n" + "                                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1"
                             + "\n" + "                                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, accdata.t_account) = 1"
                             + "\n" + "                                     )"
                             + "\n" + "                             )"
                             ;
        return sourceQuery;
    end;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 6-9 граф по ОКВЭД2
 **************************************************************************************************/
class (DataSourceFor6_9Columns_3129) DataSourceFor6_9Columns_Okved()
    initDataSourceFor6_9Columns_3129();

    private macro getOkatoSubQuery69(objectField : String, dateExpression : String, dateExpressionOverdraft : String)
        return        " NVL(("
               "\n" + "     CASE"
               "\n" + "         WHEN NOT EXISTS(SELECT 1"
               "\n" + "                           FROM df302tuneTable_tmp tuneTable         "
               "\n" + "                          WHERE tuneTable.t_backOffice IN ( 1, 2)    "
               "\n" + "                            AND tuneTable.t_columns <> '4,5'         "
               "\n" + "                            AND tuneTable.t_row IN ('2.2', '3_овер') "
               "\n" + "                            AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1)"
               "\n" + "             THEN"
               "\n" + "              (SELECT first_value(att.t_value) over (ORDER BY att.t_validFromDate DESC)"
               "\n" + "                 FROM drepcategory_vw att,                       "
               "\n" + "                      drepparty_vw repparty                      "
               "\n" + "                WHERE att.t_id             = 12                  "
               "\n" + "                  AND att.t_objectId       = repparty.t_objectId "
               "\n" + "                  AND att.t_objectType     = 3                   "
               "\n" + "                  AND att.t_validFromDate <= " + DateExpression +
               "\n" + "                  AND att.t_validToDate   >= " + DateExpression +
               "\n" + "                  AND rownum               < 2                   "
               "\n" + "                  AND repparty.t_id        = " + objectField + ")"
               "\n" + "             ELSE"
               "\n" + "              (SELECT first_value(att.t_value) over (ORDER BY att.t_validFromDate DESC)"
               "\n" + "                 FROM drepcategory_vw att,                       "
               "\n" + "                      drepparty_vw repparty                      "
               "\n" + "                WHERE att.t_id             = 12                  "
               "\n" + "                  AND att.t_objectId       = repparty.t_objectId "
               "\n" + "                  AND att.t_objectType     = 3                   "
               "\n" + "                  AND att.t_validFromDate <= " + DateExpressionOverdraft +
               "\n" + "                  AND att.t_validToDate   >= " + DateExpressionOverdraft +
               "\n" + "                  AND rownum               < 2                   "
               "\n" + "                  AND repparty.t_id        = " + objectField + ")"
               "\n" + "     END),"
               "\n" + "     NVL((SELECT DECODE(address.t_okatoCode, CHR(1), NULL, address.t_okatoCode)"
               "\n" + "            FROM drepparty_vw address"
               "\n" + "           WHERE address.t_id = " + objectField +
               "\n" + "         ), '99999'"
               "\n" + "        )"
               "\n" + "    )";
    end;

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT att.t_value                                        "
               "\n" + "    FROM drepcategory_vw att,                               "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE att.t_id             = 64                          "
               "\n" + "     AND att.t_objectId       = repparty.t_objectId         "
               "\n" + "     AND att.t_objectType     = 3                           "
               "\n" + "     AND att.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM drepcategory_vw att,                       "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE att.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND att.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND att.t_id             = 64                  "
               "\n" + "             AND att.t_objectId       = repparty.t_objectId "
               "\n" + "             AND att.t_objectType     = 3                   "
               "\n" + "             AND repparty.t_id        = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "   SELECT att.t_value                                       "
               "\n" + "    FROM drepcategory_vw att,                               "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE att.t_id             = 17                          "
               "\n" + "     AND att.t_objectId       = repparty.t_objectId         "
               "\n" + "     AND att.t_objectType     = 3                           "
               "\n" + "     AND att.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM drepcategory_vw att,                       "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE att.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND att.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND att.t_id             = 17                  "
               "\n" + "             AND att.t_objectId       = repparty.t_objectId "
               "\n" + "             AND att.t_objectType     = 3                   "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_isOpened,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        repaccount.t_partyId,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM drepdpdep_vw dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 39"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getSourceQuery()
        var dateExpressionOverdraft = getSqlDate(RcbApplication().currentReport.context.period.endDate);
        var dateExpression          = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var sourceQuery = generalSourceQuery
        + "\n" + "SELECT accdata.t_account,"
        + "\n" + "       accdata.t_accountId,"
        + "\n" + "       accdata.t_fiid,"
        + "\n" + "       accdata.t_opendate,"
        + "\n" + "       accdata.t_closedate,"
        + "\n" + "       accdata.t_isphisical,"
        + "\n" + "       accdata.t_isemployer,"
        + "\n" + "       accdata.t_branchId,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN accdata.t_value IS NOT NULL"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "       END AS t_isMSP,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN accdata.t_fiid = 0"
        + "\n" + "           THEN 0"
        + "\n" + "           ELSE accdata.t_outrest"
        + "\n" + "       END AS t_sum,"
        + "\n" + "       CASE"
        + "\n" + "          WHEN accdata.t_fiid = 0"
        + "\n" + "          THEN accdata.t_outrest"
        + "\n" + "          ELSE accdata.t_outcoverrest"
        + "\n" + "       END AS t_roublesum,"
        + "\n" + getOkatoSubQuery69("accdata.t_partyId", dateExpression, dateExpressionOverdraft) + " AS t_okato,"
        + "\n" + getOkvedSubQuery("accdata.t_partyId", dateExpression) + " AS t_okved,"
        + "\n" + getOkved2SubQuery("accdata.t_partyId", dateExpression) + " AS t_okved2,"
        + "\n" + "       NVL((SELECT 1"
        + "\n" + "              FROM drepcategory_vw category"
        + "\n" + "             WHERE category.t_objectId = accdata.t_objectId"
        + "\n" + "               AND category.t_isInstalledForEndDate = 1"
        + "\n" + "               AND category.t_isForAccount = 1"
        + "\n" + "               AND category.t_id = 16"
        + "\n" + "               AND category.t_value = 'Расчеты'"
        + "\n" + "           ), 0"
        + "\n" + "          ) AS t_hasToCompleteCalculations"
        + "\n" + "  FROM repaccountdata accdata"
        + "\n" + " WHERE accdata.t_outrest <> 0"
        + "\n" + "   AND accdata.t_isOpened = 1"
        + "\n" + "   AND EXISTS(SELECT 1"
        + "\n" + "                FROM df302tuneTable_tmp tuneTable"
        + "\n" + "               WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                 AND tuneTable.t_columns IN ('6,7', '8,9')"
        + "\n" + "                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1"
        + "\n" + "                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, accdata.t_account) = 1"
        + "\n" + "                     )"
        + "\n" + "             )"
        ;

        return sourceQuery;
    end;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 6-9 граф по ОКВЭД2
 **************************************************************************************************/
class (DataSourceFor6_9Columns_Okved) DataSourceFor6_9Columns_Okved_Т1_56_15_38_43598()
    initDataSourceFor6_9Columns_Okved();

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return "NVL(("
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2_FOR_F302 +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + "    ),                                                           "
           "\n" + " (                                                               "
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2          +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + "))";
    end;

    private macro getSourceQuery()
        var dateExpressionOverdraft = getSqlDate(RcbApplication().currentReport.context.period.endDate);
        var dateExpression          = getSqlDate(RcbApplication().currentReport.context.period.endDate);

        var sourceQuery = generalSourceQuery
        + "\n" + "SELECT accdata.t_account,"
        + "\n" + "       accdata.t_accountId,"
        + "\n" + "       accdata.t_fiid,"
        + "\n" + "       accdata.t_opendate,"
        + "\n" + "       accdata.t_closedate,"
        + "\n" + "       accdata.t_isphisical,"
        + "\n" + "       accdata.t_isemployer,"
        + "\n" + "       accdata.t_branchId,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN accdata.t_value IS NOT NULL"
        + "\n" + "           THEN 1"
        + "\n" + "           ELSE 0"
        + "\n" + "       END AS t_isMSP,"
        + "\n" + "       CASE"
        + "\n" + "           WHEN accdata.t_fiid = 0"
        + "\n" + "           THEN 0"
        + "\n" + "           ELSE accdata.t_outrest"
        + "\n" + "       END AS t_sum,"
        + "\n" + "       CASE"
        + "\n" + "          WHEN accdata.t_fiid = 0"
        + "\n" + "          THEN accdata.t_outrest"
        + "\n" + "          ELSE accdata.t_outcoverrest"
        + "\n" + "       END AS t_roublesum,"
        + "\n" + getOkatoSubQuery69("accdata.t_partyId", dateExpression, dateExpressionOverdraft) + " AS t_okato,"
        + "\n" + getOkved2SubQuery("accdata.t_partyId", dateExpression) + " AS t_okved2,"
        + "\n" + "       NVL((SELECT 1"
        + "\n" + "              FROM drepcategory_vw category"
        + "\n" + "             WHERE category.t_objectId              = accdata.t_objectId"
        + "\n" + "               AND category.t_isInstalledForEndDate = 1"
        + "\n" + "               AND category.t_isForAccount          = 1"
        + "\n" + "               AND category.t_id                    = " + RCB_OBJGROUP_CLASSIFCRD
        + "\n" + "               AND category.t_value                 = 'Расчеты'"
        + "\n" + "           ), 0"
        + "\n" + "          ) AS t_hasToCompleteCalculations"
        + "\n" + "  FROM repaccountdata accdata"
        + "\n" + " WHERE accdata.t_outrest <> 0"
        + "\n" + "   AND accdata.t_isOpened = 1"
        + "\n" + "   AND EXISTS(SELECT 1"
        + "\n" + "                FROM df302tuneTable_tmp tuneTable"
        + "\n" + "               WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                 AND tuneTable.t_columns IN ('6,7', '8,9')"
        + "\n" + "                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, accdata.t_account) = 1"
        + "\n" + "                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, accdata.t_account) = 1"
        + "\n" + "                     )"
        + "\n" + "             )"
        ;

        return sourceQuery;
    end;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 4-5 граф
 **************************************************************************************************/
class (DataSourceForColumns) DataSourceFor4_5Columns()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery +
                               "\n"+                  "SELECT repaccountdata.t_account,"
                               "\n"+                  "       repaccountdata.t_fiid,"
                               "\n"+                  "       repaccountdata.t_OKATO,"
                               "\n"+                  "       repaccountdata.t_OKVED,"
                               "\n"+                  "       repaccountdata.t_isphisical,"
                               "\n"+                  "       repaccountdata.t_isemployer,"
                               "\n"+                  "       repaccountdata.t_isOperOffice,"
                               "\n"+                  "       repaccountdata.t_branchOKATO,"
                               "\n"+                  "       repaccountdata.t_branchId,"
                               "\n"+                  "       CASE"
                               "\n"+                  "            WHEN repaccountdata.t_value IS NOT NULL"
                               "\n"+                  "            THEN 1"
                               "\n"+                  "            ELSE 0"
                               "\n"+                  "       END AS t_isMSP,"
                               "\n"+                  "       -- для А-счетов надо умножать на -1"
                               "\n"+                  "       CASE"
                               "\n"+                  "            WHEN repaccountdata.t_fiid = 0 AND t_balance NOT LIKE '203%'"
                               "\n"+                  "            THEN 0"
                               "\n"+                  "            ELSE DECODE(repaccountdata.t_kind,'А',(-1)* t_rest,t_rest)"
                               "\n"+                  "       END AS t_sum,"
                               "\n"+                  "       CASE"
                               "\n"+                  "            WHEN repaccountdata.t_fiid = 0 AND t_balance NOT LIKE '203%'"
                               "\n"+                  "            THEN DECODE(repaccountdata.t_kind,'А',(-1)*t_rest,t_rest)"
                               "\n"+                  "            ELSE"
                               "\n"+                  "                 CASE"
                               "\n"+                  "                      WHEN t_isopenedatenddate = 0"
                               "\n"+                  "                      THEN DECODE(repaccountdata.t_kind,'А',(-1)*rsb_fiinstr.convSum(t_rest, repaccountdata.t_fiid, 0, accountrest.t_maturitydate),rsb_fiinstr.convSum(t_rest, repaccountdata.t_fiid, 0, accountrest.t_maturitydate))"
                               "\n"+                  "                      WHEN t_isopenedatenddate = 1"
                               "\n"+                  "                      THEN DECODE(repaccountdata.t_kind,'А',(-1)*rsb_fiinstr.convSum(t_rest, repaccountdata.t_fiid, 0, accountrest.t_date),rsb_fiinstr.convSum(t_rest, repaccountdata.t_fiid, 0, accountrest.t_date))"
                               "\n"+                  "                      ELSE 0"
                               "\n"+                  "                 END"
                               "\n"+                  "       END AS t_roublesum,"
                               "\n"+                  "       t_opendate,"
                               "\n"+                  "       t_closedate,"
                               "\n"+                  "       CASE"
                               "\n"+                  "            WHEN repaccountdata.t_fiid <> 0 AND t_isopenedatenddate = 0"
                               "\n"+                  "            THEN accountrest.t_maturitydate"
                               "\n"+                  "            ELSE null"
                               "\n"+                  "       END AS t_recalculateRateDate,"
                               "\n"+                  "       CASE"
                               "\n"+                  "            WHEN repaccountdata.t_fiid <> 0 AND t_isopenedatenddate = 0"
                               "\n"+                  "            THEN rsb_fiinstr.convSum(1,repaccountdata.t_fiid,0,accountrest.t_maturitydate)"
                               "\n"+                  "            ELSE NULL"
                               "\n"+                  "       END AS t_recalculaterate"
                               "\n"+                  "  FROM repaccountdata,"
                               "\n"+                  "       -- находим ОстатокСчёта и ДатаПогашения"
                               "\n"+                  "       (SELECT t_chapter,"
                               "\n"+                  "               t_fiid,"
                               "\n"+                  "               t_account,"
                               "\n"+                  "               MAX (t_restdate) KEEP (DENSE_RANK FIRST ORDER BY resttable.t_chapter, resttable.t_account, resttable.t_fiid, resttable.t_isrestnull DESC, t_restdate DESC)  t_maturitydate,"
                               "\n"+                  "               MIN (t_restdate) KEEP (DENSE_RANK FIRST ORDER BY resttable.t_chapter, resttable.t_account, resttable.t_fiid, resttable.t_isrestnull ASC, t_restdate ASC) t_date,"
                               "\n"+                  "               MAX (t_rest)     KEEP (DENSE_RANK FIRST ORDER BY resttable.t_chapter, resttable.t_account, resttable.t_fiid, resttable.t_isrestnull ASC, t_restdate ASC) t_rest"
                               "\n"+                  "          FROM (SELECT repaccount.t_account,"
                               "\n"+                  "                       repaccount.t_chapter,"
                               "\n"+                  "                       repaccount.t_fiid,"
                               "\n"+                  "                       restdate.t_restdate,"
                               "\n"+                  "                       restdate.t_rest,"
                               "\n"+                  "                       DECODE(restdate.t_rest,0,1,0) t_isrestnull"
                               "\n"+                  "                  FROM drestdate_dbt restdate,"
                               "\n"+                  "                       drepaccount_vw repaccount"
                               "\n"+                  "                 WHERE repaccount.t_accountid = restdate.t_accountid (+)"
                               "\n"+                  "                   AND repaccount.t_fiid = restdate.t_restcurrency) resttable"
                               "\n"+                  "         WHERE resttable.t_account NOT LIKE 'ОВП%'"
                               "\n"+                  "      GROUP BY resttable.t_chapter,resttable.t_account,resttable.t_fiid) accountrest"
                               "\n"+                  " WHERE repaccountdata.t_account = accountrest.t_account"
                               "\n"+                  "   AND repaccountdata.t_chapter = accountrest.t_chapter"
                               "\n"+                  "   AND repaccountdata.t_fiid = accountrest.t_fiid"
                               "\n"+                  "   AND repaccountdata.t_opendate >= rep_data.getBeginDate()"
                               "\n"+                  "   AND repaccountdata.t_opendate <= rep_data.getEndDate()";

        return sourceQuery;
    end;

    initDataSourceForColumns;
end;

/***************************************************************************************************
 *  Класс источника данных по ГК для первого раздела для 4-5 граф  по 2627-У
 **************************************************************************************************/
class (DataSourceFor4_5Columns) DataSourceFor4Columns_2627()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery
        + "\n" + "SELECT repaccountdata.t_account,"
        + "\n" + "       repaccountdata.t_fiId,"
        + "\n" + "       repaccountdata.t_okato,"
        + "\n" + "       repaccountdata.t_okved,"
        + "\n" + "       0 AS t_hasToCompleteCalculations,"
        + "\n" + "       repaccountdata.t_isphisical,"
        + "\n" + "       repaccountdata.t_isemployer,"
        + "\n" + "       repaccountdata.t_isOperOffice,"
        + "\n" + "       repaccountdata.t_branchOkato,"
        + "\n" + "       repaccountdata.t_branchId,"
        + "\n" + "       CASE"
        + "\n" + "            WHEN repaccountdata.t_value IS NOT NULL"
        + "\n" + "            THEN 1"
        + "\n" + "            ELSE 0"
        + "\n" + "       END AS t_isMSP,"
        + "\n" + "       0   AS t_sum,"
        + "\n" + "       NVL((SELECT SUM(document.t_debetSum)"
        + "\n" + "              FROM F302DOCWITHCORRECTION_VW document"
        + "\n" + "             WHERE document.t_chapter = repaccountdata.t_chapter"
        + "\n" + "               AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                       AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "               AND document.t_debetFiId = repaccountdata.t_fiId"
        + "\n" + "               AND document.t_debetAccount = repaccountdata.t_account"
        + "\n" + "               AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "           ), 0"
        + "\n" + "          ) AS t_roublesum,"
        + "\n" + "       repaccountdata.t_opendate,"
        + "\n" + "       repaccountdata.t_closedate,"
        + "\n" + "       NULL AS t_recalculateRateDate,"
        + "\n" + "       NULL AS t_recalculaterate"
        + "\n" + "  FROM repaccountdata"
        + "\n" + " WHERE repaccountdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                     AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "   AND repaccountdata.t_fiId = " + NATCUR
        ;

        return sourceQuery;
    end;

    initDataSourceFor4_5Columns();
end;

class (DataSourceFor4Columns_2627) DataSourceFor4Columns_2742()

    private macro getSourceQuery()
        var sourceQuery = generalSourceQuery + ","
        + "\n" + "accountTurnover"
        + "\n" + "AS"
        + "\n" + "("
        + "\n" + " SELECT repaccountdata.t_account,"
        + "\n" + "        repaccountdata.t_fiId,"
        + "\n" + "        repaccountdata.t_okato,"
        + "\n" + "        repaccountdata.t_okved,"
        + "\n" + "        0 AS t_hasToCompleteCalculations,"
        + "\n" + "        repaccountdata.t_isphisical,"
        + "\n" + "        repaccountdata.t_isemployer,"
        + "\n" + "        repaccountdata.t_branchId,"
        + "\n" + "        CASE"
        + "\n" + "             WHEN repaccountdata.t_value IS NOT NULL"
        + "\n" + "             THEN 1"
        + "\n" + "             ELSE 0"
        + "\n" + "        END AS t_isMSP,"
        + "\n" + "        0   AS t_sum,"
        + "\n" + "        (SELECT SUM(document.t_debetSum)"
        + "\n" + "           FROM F302DOCWITHCORRECTION_VW document"
        + "\n" + "          WHERE document.t_chapter = repaccountdata.t_chapter"
        + "\n" + "            AND document.t_debetFiId = repaccountdata.t_fiId"
        + "\n" + "            AND document.t_debetAccount = repaccountdata.t_account"
        + "\n" + "            AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                    AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "            AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "        ) t_roublesum,"
        + "\n" + "        repaccountdata.t_opendate,"
        + "\n" + "        repaccountdata.t_closedate,"
        + "\n" + "        NULL AS t_recalculateRateDate,"
        + "\n" + "        NULL AS t_recalculaterate"
        + "\n" + "   FROM repaccountdata"
        + "\n" + "  WHERE repaccountdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND repaccountdata.t_fiId = " + NATCUR
        + "\n" + "    AND EXISTS(SELECT 1"
        + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
        + "\n" + "                WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                  AND tuneTable.t_columns = '4,5'"
        + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, repaccountdata.t_account) = 1"
        + "\n" + "              )"
        + "\n" + ")"
        + "\n" + "SELECT t_account,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_okato,"
        + "\n" + "       t_okved,"
        + "\n" + "       t_hasToCompleteCalculations,"
        + "\n" + "       t_isphisical,"
        + "\n" + "       t_isemployer,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_isMSP,"
        + "\n" + "       t_sum,"
        + "\n" + "       t_roublesum,"
        + "\n" + "       t_opendate,"
        + "\n" + "       t_closedate,"
        + "\n" + "       t_recalculateRateDate,"
        + "\n" + "       t_recalculaterate"
        + "\n" + "  FROM accountTurnover"
        + "\n" + " WHERE t_roublesum IS NOT NULL"
        ;

        return sourceQuery;
    end;

    initDataSourceFor4Columns_2627();
end;

class (DataSourceForColumns_2835) DataSourceFor4Columns_2835()

    private macro getSourceQuery()
        var dateExpression = "document.t_date";

        var sourceQuery = generalSourceQuery + ","
        + "\n" + "accountTurnover"
        + "\n" + "AS"
        + "\n" + "("
        + "\n" + " SELECT repaccountdata.t_account,"
        + "\n" + "        repaccountdata.t_accountId,"
        + "\n" + "        repaccountdata.t_chapter,"
        + "\n" + "        repaccountdata.t_fiId,"
        + "\n" + "        document.t_date,"
        + "\n" + "        0 AS t_hasToCompleteCalculations,"
        + "\n" + "        repaccountdata.t_isphisical,"
        + "\n" + "        repaccountdata.t_isemployer,"
        + "\n" + getOkatoSubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okato,"
        + "\n" + getOkvedSubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okved,"
        + "\n" + "        repaccountdata.t_branchId,"
        + "\n" + "        CASE"
        + "\n" + "             WHEN repaccountdata.t_value IS NOT NULL"
        + "\n" + "             THEN 1"
        + "\n" + "             ELSE 0"
        + "\n" + "        END AS t_isMSP,"
        + "\n" + "        0   AS t_sum,"
        + "\n" + "        document.t_debetSum AS  t_roublesum,"
        + "\n" + "        repaccountdata.t_opendate,"
        + "\n" + "        repaccountdata.t_closedate,"
        + "\n" + "        NULL AS t_recalculateRateDate,"
        + "\n" + "        NULL AS t_recalculaterate"
        + "\n" + "   FROM repaccountdata, "
        + "\n" + "        F302DOCWITHCORRECTION_VW document"
        + "\n" + "  WHERE repaccountdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND document.t_chapter = repaccountdata.t_chapter"
        + "\n" + "    AND document.t_debetFiId = repaccountdata.t_fiId"
        + "\n" + "    AND document.t_debetAccount = repaccountdata.t_account"
        + "\n" + "    AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                        AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "    AND repaccountdata.t_fiId = " + NATCUR
        + "\n" + "    AND EXISTS(SELECT 1"
        + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
        + "\n" + "                WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                  AND tuneTable.t_columns = '4,5'"
        + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, repaccountdata.t_account) = 1"
        + "\n" + "              )"
        + "\n" + ")"
        + "\n" + "SELECT t_account,"
        + "\n" + "       t_accountid,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_fiId,"
        + "\n" + "       Max(t_date) AS t_creditDate,"
        + "\n" + "       t_okato,"
        + "\n" + "       t_okved,"
        + "\n" + "       t_hasToCompleteCalculations,"
        + "\n" + "       t_isphisical,"
        + "\n" + "       t_isemployer,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_isMSP,"
        + "\n" + "       t_sum,"
        + "\n" + "       sum(t_roublesum) AS t_roubleSum,"
        + "\n" + "       t_opendate,"
        + "\n" + "       t_closedate,"
        + "\n" + "       t_recalculateRateDate,"
        + "\n" + "       t_recalculaterate"
        + "\n" + "  FROM accountTurnover"
        + "\n" + " WHERE t_roublesum IS NOT NULL"
        + "\n" + " GROUP BY t_account, t_accountId, t_chapter, t_fiId, t_okato, t_okved, t_hasToCompleteCalculations, t_isphisical, t_isemployer, "
        + "\n" + "          t_branchId, t_isMSP, t_sum, t_opendate, t_closedate, t_recalculateRateDate, t_recalculaterate"
        ;

        sql_execute( "INSERT INTO df302loanAcc_tmp ( "
            + "\n" + "                                t_account,"
            + "\n" + "                                t_accountId,"
            + "\n" + "                                t_fiId,"
            + "\n" + "                                t_chapter,"
            + "\n" + "                                t_okatoCode,"
            + "\n" + "                                t_additionalOkato,"
            + "\n" + "                                t_branchId,"
            + "\n" + "                                t_row,"
            + "\n" + "                                t_column)"
            + "\n" + "     SELECT t_account, t_accountid, t_fiId, t_chapter, t_okato, '', t_branchId, 0, '4'"
            + "\n" + "       FROM (" + sourceQuery + ")");

        return sourceQuery;
    end;

    initDataSourceForColumns_2835();
end;

class (DataSourceFor4Columns_2835) DataSourceFor4Columns_3129()
    initDataSourceFor4Columns_2835();

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "   SELECT att.t_numInList"
               "\n" + "    FROM dobjattr_dbt att,"
               "\n" + "         dobjatcor_dbt atc,                                 "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_groupId        = 17                          "
               "\n" + "     AND atc.t_object         = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_general        = 'X'                         "
               "\n" + "     AND atc.t_attrId         = att.t_attrId                "
               "\n" + "     AND atc.t_objectType     = att.t_objectType            "
               "\n" + "     AND atc.t_groupId        = att.t_groupId               "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM dobjattr_dbt att,                          "
               "\n" + "                 dobjatcor_dbt atc,                         "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_groupId        = 17                  "
               "\n" + "             AND atc.t_object         = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND atc.t_general        = 'X'                 "
               "\n" + "             AND atc.t_attrId         = att.t_attrId        "
               "\n" + "             AND atc.t_objectType     = att.t_objectType    "
               "\n" + "             AND atc.t_groupId        = att.t_groupId       "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        repaccount.t_partyId,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM ddp_dep_dbt dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 39"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getSourceQuery()
        var dateExpression = "document.t_date";

        var sourceQuery = generalSourceQuery + ","
        + "\n" + "accountTurnover"
        + "\n" + "AS"
        + "\n" + "("
        + "\n" + " SELECT repaccountdata.t_account,"
        + "\n" + "        repaccountdata.t_accountId,"
        + "\n" + "        repaccountdata.t_chapter,"
        + "\n" + "        repaccountdata.t_fiId,"
        + "\n" + "        document.t_date,"
        + "\n" + "        0 AS t_hasToCompleteCalculations,"
        + "\n" + "        repaccountdata.t_isphisical,"
        + "\n" + "        repaccountdata.t_isemployer,"
        + "\n" + getOkatoSubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okato,"
        + "\n" + getOkvedSubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okved,"
        + "\n" + "        repaccountdata.t_branchId,"
        + "\n" + "        CASE"
        + "\n" + "             WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', TO_CHAR(repaccountdata.t_partyId, 'FM0000000000'), " + dateExpression + ") > 0"
        + "\n" + "             THEN 1"
        + "\n" + "             ELSE 0"
        + "\n" + "        END AS t_isMSP,"
        + "\n" + "        0   AS t_sum,"
        + "\n" + "        document.t_debetSum AS  t_roublesum,"
        + "\n" + "        repaccountdata.t_opendate,"
        + "\n" + "        repaccountdata.t_closedate,"
        + "\n" + "        NULL AS t_recalculateRateDate,"
        + "\n" + "        NULL AS t_recalculaterate"
        + "\n" + "   FROM repaccountdata, "
        + "\n" + "        F302DOCWITHCORRECTION_VW document"
        + "\n" + "  WHERE repaccountdata.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND document.t_chapter = repaccountdata.t_chapter"
        + "\n" + "    AND document.t_debetFiId = repaccountdata.t_fiId"
        + "\n" + "    AND document.t_debetAccount = repaccountdata.t_account"
        + "\n" + "    AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                        AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "    AND repaccountdata.t_fiId = " + NATCUR
        + "\n" + "    AND EXISTS(SELECT 1"
        + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
        + "\n" + "                WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                  AND tuneTable.t_columns = '4,5'"
        + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, repaccountdata.t_account) = 1"
        + "\n" + "              )"
        + "\n" + ")"
        + "\n" + "SELECT t_account,"
        + "\n" + "       t_accountid,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_fiId,"
        + "\n" + "       Max(t_date) AS t_creditDate,"
        + "\n" + "       t_okato,"
        + "\n" + "       t_okved,"
        + "\n" + "       t_hasToCompleteCalculations,"
        + "\n" + "       t_isphisical,"
        + "\n" + "       t_isemployer,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_isMSP,"
        + "\n" + "       t_sum,"
        + "\n" + "       sum(t_roublesum) AS t_roubleSum,"
        + "\n" + "       t_opendate,"
        + "\n" + "       t_closedate,"
        + "\n" + "       t_recalculateRateDate,"
        + "\n" + "       t_recalculaterate"
        + "\n" + "  FROM accountTurnover"
        + "\n" + " WHERE t_roublesum IS NOT NULL"
        + "\n" + " GROUP BY t_account, t_accountId, t_chapter, t_fiId, t_okato, t_okved, t_hasToCompleteCalculations, t_isphisical, t_isemployer, "
        + "\n" + "          t_branchId, t_isMSP, t_sum, t_opendate, t_closedate, t_recalculateRateDate, t_recalculaterate"
        ;

        sql_execute( "INSERT INTO df302loanAcc_tmp ( "
            + "\n" + "                                t_account,"
            + "\n" + "                                t_accountId,"
            + "\n" + "                                t_fiId,"
            + "\n" + "                                t_chapter,"
            + "\n" + "                                t_okatoCode,"
            + "\n" + "                                t_additionalOkato,"
            + "\n" + "                                t_branchId,"
            + "\n" + "                                t_row,"
            + "\n" + "                                t_column)"
            + "\n" + "     SELECT t_account, t_accountid, t_fiId, t_chapter, t_okato, '', t_branchId, 0, '4'"
            + "\n" + "       FROM (" + sourceQuery + ")");

        return sourceQuery;
    end;
end;

class (DataSourceFor4Columns_3129) DataSourceFor4Columns_Okved()
    initDataSourceFor4Columns_3129();

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "   SELECT att.t_numInList"
               "\n" + "    FROM dobjattr_dbt att,"
               "\n" + "         dobjatcor_dbt atc,                                 "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_groupId        = 64                          "
               "\n" + "     AND atc.t_object         = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_general        = 'X'                         "
               "\n" + "     AND atc.t_attrId         = att.t_attrId                "
               "\n" + "     AND atc.t_objectType     = att.t_objectType            "
               "\n" + "     AND atc.t_groupId        = att.t_groupId               "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM dobjattr_dbt att,                          "
               "\n" + "                 dobjatcor_dbt atc,                         "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_groupId        = 64                  "
               "\n" + "             AND atc.t_object         = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND atc.t_general        = 'X'                 "
               "\n" + "             AND atc.t_attrId         = att.t_attrId        "
               "\n" + "             AND atc.t_objectType     = att.t_objectType    "
               "\n" + "             AND atc.t_groupId        = att.t_groupId       "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    generalSourceQuery = "WITH repaccountdata AS"
                      "\n" + "("
                      "\n" + " SELECT repaccount.t_fiId,"
                      "\n" + "        repaccount.t_account,"
                      "\n" + "        repaccount.t_accountId,"
                      "\n" + "        repaccount.t_openDate,"
                      "\n" + "        repaccount.t_closeDate,"
                      "\n" + "        repaccount.t_isOpened,"
                      "\n" + "        repaccount.t_branchId,"
                      "\n" + "        repaccount.t_balance,"
                      "\n" + "        repaccount.t_chapter,"
                      "\n" + "        repaccount.t_outRest,"
                      "\n" + "        repaccount.t_outCoverRest,"
                      "\n" + "        repaccount.t_objectId,"
                      "\n" + "        repaccount.t_partyId,"
                      "\n" + "        NVL((SELECT depCode.t_okatoCode"
                      "\n" + "               FROM drepdepcode_vw depCode"
                      "\n" + "              WHERE depCode.t_departmentcode = repaccount.t_branchId"
                      "\n" + "            ), '99999'"
                      "\n" + "           ) AS t_branchOKATO,"
                      "\n" + "        repparty.t_isphisical,"
                      "\n" + "        repparty.t_isemployer,"
                      "\n" + "        NVL("
                      "\n" + "            (SELECT 1"
                      "\n" + "               FROM ddp_dep_dbt dprt"
                      "\n" + "              WHERE dprt.t_code = repaccount.t_branchId"
                      "\n" + "                AND dprt.t_nodetype = 2"
                      "\n" + "                AND dprt.t_branchtype = 3),"
                      "\n" + "            0"
                      "\n" + "          ) AS t_isOperOffice,"
                      "\n" + "        (SELECT category.t_value"
                      "\n" + "           FROM drepcategory_vw category"
                      "\n" + "          WHERE category.t_isForParty = 1"
                      "\n" + "            AND category.t_id = 39"
                      "\n" + "            AND category.t_objectid = repparty.t_objectid"
                      "\n" + "            AND category.t_isInstalledForEndDate = 1"
                      "\n" + "        ) AS t_value"
                      "\n" + "   FROM drepaccount_vw repaccount,"
                      "\n" + "        drepparty_vw repparty"
                      "\n" + "  WHERE INSTR(repaccount.t_type, 'Щ') = 0"
                      "\n" + "    AND repaccount.t_partyid = repparty.t_id"
                      "\n" + "    AND repparty.t_isbank = 0"
                      "\n" + "    AND repparty.t_isresident = 1"
                      "\n" + ")"
                       ;

    private macro getSourceQuery()
        var dateExpression = "document.t_date";

        var sourceQuery = generalSourceQuery + ","
        + "\n" + "accountTurnover"
        + "\n" + "AS"
        + "\n" + "("
        + "\n" + " SELECT repaccountdata.t_account,"
        + "\n" + "        repaccountdata.t_accountId,"
        + "\n" + "        repaccountdata.t_chapter,"
        + "\n" + "        repaccountdata.t_fiId,"
        + "\n" + "        document.t_date,"
        + "\n" + "        0                                                        AS t_hasToCompleteCalculations,"
        + "\n" + "        repaccountdata.t_isphisical,"
        + "\n" + "        repaccountdata.t_isemployer,"
        + "\n" + getOkatoSubQuery("repaccountdata.t_partyId", dateExpression)  + " AS t_okato,"
        + "\n" + getOkvedSubQuery("repaccountdata.t_partyId", dateExpression)  + " AS t_okved,"
        + "\n" + getOkved2SubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okved2,"
        + "\n" + "        repaccountdata.t_branchId,"
        + "\n" + "        CASE"
        + "\n" + "             WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', TO_CHAR(repaccountdata.t_partyId, 'FM0000000000'), " + dateExpression + ") > 0"
        + "\n" + "             THEN 1"
        + "\n" + "             ELSE 0"
        + "\n" + "        END AS t_isMSP,"
        + "\n" + "        0   AS t_sum,"
        + "\n" + "        document.t_debetSum AS  t_roublesum,"
        + "\n" + "        repaccountdata.t_opendate,"
        + "\n" + "        repaccountdata.t_closedate,"
        + "\n" + "        NULL AS t_recalculateRateDate,"
        + "\n" + "        NULL AS t_recalculaterate"
        + "\n" + "   FROM repaccountdata, "
        + "\n" + "        F302DOCWITHCORRECTION_VW document"
        + "\n" + "  WHERE repaccountdata.t_isOpened = 1"
        + "\n" + "    AND document.t_chapter        = repaccountdata.t_chapter"
        + "\n" + "    AND document.t_debetFiId      = repaccountdata.t_fiId"
        + "\n" + "    AND document.t_debetAccount   = repaccountdata.t_account"
        + "\n" + "    AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                            AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "    AND (SELECT NVL(SUBSTR(repacc.t_balance, 1, 3), '0')"
        + "\n" + "           FROM drepaccount_vw repacc"
        + "\n" + "          WHERE repacc.t_accountId = document.t_creditAccountId) <> '458'"
        + "\n" + "    AND repaccountdata.t_fiId      = " + NATCUR
        + "\n" + "    AND EXISTS(SELECT 1"
        + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
        + "\n" + "                WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                  AND tuneTable.t_columns    = '4,5'"
        + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, repaccountdata.t_account) = 1"
        + "\n" + "              )"
        + "\n" + ")"
        + "\n" + "SELECT t_account,"
        + "\n" + "       t_accountid,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_fiId,"
        + "\n" + "       Max(t_date) AS t_creditDate,"
        + "\n" + "       t_okato,"
        + "\n" + "       t_okved,"
        + "\n" + "       t_okved2,"
        + "\n" + "       t_hasToCompleteCalculations,"
        + "\n" + "       t_isphisical,"
        + "\n" + "       t_isemployer,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_isMSP,"
        + "\n" + "       t_sum,"
        + "\n" + "       sum(t_roublesum) AS t_roubleSum,"
        + "\n" + "       t_opendate,"
        + "\n" + "       t_closedate,"
        + "\n" + "       t_recalculateRateDate,"
        + "\n" + "       t_recalculaterate"
        + "\n" + "  FROM accountTurnover"
        + "\n" + " WHERE t_roublesum IS NOT NULL"
        + "\n" + " GROUP BY t_account, t_accountId, t_chapter, t_fiId, t_okato, t_okved, t_okved2, t_hasToCompleteCalculations, t_isphisical, t_isemployer, "
        + "\n" + "          t_branchId, t_isMSP, t_sum, t_opendate, t_closedate, t_recalculateRateDate, t_recalculaterate"
        ;

        sql_execute( "INSERT INTO df302loanAcc_tmp ( "
            + "\n" + "                                t_account,"
            + "\n" + "                                t_accountId,"
            + "\n" + "                                t_fiId,"
            + "\n" + "                                t_chapter,"
            + "\n" + "                                t_okatoCode,"
            + "\n" + "                                t_additionalOkato,"
            + "\n" + "                                t_branchId,"
            + "\n" + "                                t_row,"
            + "\n" + "                                t_column)"
            + "\n" + "     SELECT t_account, t_accountid, t_fiId, t_chapter, t_okato, '', t_branchId, 0, '4'"
            + "\n" + "       FROM (" + sourceQuery + ")");

        return sourceQuery;
    end;
end;

class (DataSourceFor4Columns_Okved) DataSourceFor4Columns_Okved_Т1_56_15_38_43598()
    initDataSourceFor4Columns_Okved();

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return "NVL(("
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2_FOR_F302 +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + " ),                                                              "
           "\n" + " (                                                               "
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2          +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + " )                                                               "
           "\n" + ")                                                                ";
    end;

    private macro getSourceQuery()
        var dateExpression = "document.t_date";

        var sourceQuery = generalSourceQuery + ","
        + "\n" + "accountTurnover"
        + "\n" + "AS"
        + "\n" + "("
        + "\n" + " SELECT repaccountdata.t_account,"
        + "\n" + "        repaccountdata.t_accountId,"
        + "\n" + "        repaccountdata.t_chapter,"
        + "\n" + "        repaccountdata.t_fiId,"
        + "\n" + "        document.t_date,"
        + "\n" + "        0                                                        AS t_hasToCompleteCalculations,"
        + "\n" + "        repaccountdata.t_isphisical,"
        + "\n" + "        repaccountdata.t_isemployer,"
        + "\n" + getOkatoSubQuery("repaccountdata.t_partyId", dateExpression)  + " AS t_okato,"
        + "\n" + getOkved2SubQuery("repaccountdata.t_partyId", dateExpression) + " AS t_okved2,"
        + "\n" + "        repaccountdata.t_branchId,"
        + "\n" + "        CASE"
        + "\n" + "             WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(3," + RCB_OBJGROUP_PT_EMPLOYER + ",'МСП', TO_CHAR(repaccountdata.t_partyId, 'FM0000000000'), " + dateExpression + ") > 0"
        + "\n" + "             THEN 1"
        + "\n" + "             ELSE 0"
        + "\n" + "        END AS t_isMSP,"
        + "\n" + "        0   AS t_sum,"
        + "\n" + "        document.t_debetSum AS  t_roublesum,"
        + "\n" + "        repaccountdata.t_opendate,"
        + "\n" + "        repaccountdata.t_closedate,"
        + "\n" + "        NULL AS t_recalculateRateDate,"
        + "\n" + "        NULL AS t_recalculaterate"
        + "\n" + "   FROM repaccountdata, "
        + "\n" + "        F302DOCWITHCORRECTION_VW document"
        + "\n" + "  WHERE repaccountdata.t_isOpened = 1"
        + "\n" + "    AND document.t_chapter        = repaccountdata.t_chapter"
        + "\n" + "    AND document.t_debetFiId      = repaccountdata.t_fiId"
        + "\n" + "    AND document.t_debetAccount   = repaccountdata.t_account"
        + "\n" + "    AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
        + "\n" + "                            AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
        + "\n" + "    AND SUBSTR(document.t_debetAccount, 1, 3) != SUBSTR(document.t_creditAccount, 1, 3)"
        + "\n" + "    AND (SELECT NVL(SUBSTR(repacc.t_balance, 1, 3), '0')"
        + "\n" + "           FROM drepaccount_vw repacc"
        + "\n" + "          WHERE repacc.t_accountId = document.t_creditAccountId) <> '458'"
        + "\n" + "    AND repaccountdata.t_fiId      = " + NATCUR
        + "\n" + "    AND EXISTS(SELECT 1"
        + "\n" + "                 FROM df302tuneTable_tmp tuneTable"
        + "\n" + "                WHERE tuneTable.t_backOffice = 1"
        + "\n" + "                  AND tuneTable.t_columns    = '4,5'"
        + "\n" + "                  AND rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, repaccountdata.t_account) = 1"
        + "\n" + "              )"
        + "\n" + ")"
        + "\n" + "SELECT t_account,"
        + "\n" + "       t_accountid,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_fiId,"
        + "\n" + "       Max(t_date) AS t_creditDate,"
        + "\n" + "       t_okato,"
        + "\n" + "       t_okved2,"
        + "\n" + "       t_hasToCompleteCalculations,"
        + "\n" + "       t_isphisical,"
        + "\n" + "       t_isemployer,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_isMSP,"
        + "\n" + "       t_sum,"
        + "\n" + "       sum(t_roublesum) AS t_roubleSum,"
        + "\n" + "       t_opendate,"
        + "\n" + "       t_closedate,"
        + "\n" + "       t_recalculateRateDate,"
        + "\n" + "       t_recalculaterate"
        + "\n" + "  FROM accountTurnover"
        + "\n" + " WHERE t_roublesum IS NOT NULL"
        + "\n" + " GROUP BY t_account, t_accountId, t_chapter, t_fiId, t_okato, t_okved2, t_hasToCompleteCalculations, t_isphisical, t_isemployer, "
        + "\n" + "          t_branchId, t_isMSP, t_sum, t_opendate, t_closedate, t_recalculateRateDate, t_recalculaterate"
        ;

        sql_execute( "INSERT INTO df302loanAcc_tmp ( "
            + "\n" + "                                t_account,"
            + "\n" + "                                t_accountId,"
            + "\n" + "                                t_fiId,"
            + "\n" + "                                t_chapter,"
            + "\n" + "                                t_okatoCode,"
            + "\n" + "                                t_additionalOkato,"
            + "\n" + "                                t_branchId,"
            + "\n" + "                                t_row,"
            + "\n" + "                                t_column)"
            + "\n" + "     SELECT t_account, t_accountid, t_fiId, t_chapter, t_okato, '', t_branchId, 0, '4'"
            + "\n" + "       FROM (" + sourceQuery + ")");

        return sourceQuery;
    end;
end;

class (DataSourceFor4_5Columns) DataSourceFor5Columns_2627(okatoTuneTable : RcbTuneTable)
    private var m_okatoTuneTable : RcbTuneTable;

    private macro getOkatoCode(isForthRow : Bool)
        defaultParm(isForthRow, false);
        var okatoField = ternary(isForthRow, "documents.t_branchOkato", "documents.t_okato");

        return   " CASE " + okatoField
        + "\n" + "     WHEN '99999'"
        + "\n" + "     THEN " + okatoField
        + "\n" + "     ELSE RPAD(SUBSTR(" + okatoField + ", 1, 2), 5, '0')"
        + "\n" + " END";
    end;

    private macro getAdditionalOkatoCode(isForthRow : Bool)
        defaultParm(isForthRow, false);
        var okatoField = ternary(isForthRow, "documents.t_branchOkato", "documents.t_okato");

        return   " (SELECT okato.t_okato"
        + "\n" + "    FROM (" + m_okatoTuneTable.getQuery() + ") okato"
        + "\n" + "   WHERE rsb_mask.compareStringWithMask(okato.t_okatoMasks, " + okatoField + ") = 1"
        + "\n" + " )";
    end;

    private macro createLoanAccounts()

        var sourceQuery = generalSourceQuery + ","
                   + "\n" + "  rowMasks"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT t_row,"
                   + "\n" + "             '4,5' AS t_columns,"
                   + "\n" + "             NVL(t_okvedmasks, CHR(1)) t_okvedmasks,"
                   + "\n" + "             NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) t_accountmasks"
                   + "\n" + "        FROM df302tuneTable_tmp tuneTable"
                   + "\n" + "       WHERE t_columns = '4,5'"
                   + "\n" + "         AND t_backOffice = " + BOCB
                   + "\n" + "       GROUP BY t_row,"
                   + "\n" + "                t_okvedMasks"
                   + "\n" + "     ),"
                   + "\n" + "  documents"
                   + "\n" + "  AS (SELECT account.t_account,"
                   + "\n" + "             account.t_fiId,"
                   + "\n" + "             account.t_chapter,"
                   + "\n" + "             account.t_openDate,"
                   + "\n" + "             account.t_branchId,"
                   + "\n" + "             account.t_okato,"
                   + "\n" + "             account.t_branchOkato,"
                   + "\n" + "             account.t_okved,"
                   + "\n" + "             account.t_isphisical,"
                   + "\n" + "             account.t_isemployer,"
                   + "\n" + "             account.t_isOperOffice,"
                   + "\n" + "             account.t_value,"
                   + "\n" + "             document.t_debetAccount    AS t_documentAccount,"
                   + "\n" + "             document.t_debetFiId       AS t_documentFiId,"
                   + "\n" + "             document.t_chapter         AS t_documentChapter,"
                   + "\n" + "             document.t_debetAccountId  AS t_documentAccountId"
                   + "\n" + "           FROM repaccountdata account,"
                   + "\n" + "                F302DOCWITHCORRECTION_VW document"
                   + "\n" + "          WHERE account.t_fiId != " + NATCUR
                   + "\n" + "            AND account.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                       AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "            AND (    document.t_chapter = account.t_chapter"
                   + "\n" + "                 AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                         AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "                 AND (   (    document.t_debetFiId = account.t_fiId"
                   + "\n" + "                          AND document.t_debetAccount = account.t_account"
                   + "\n" + "                         )"
                   + "\n" + "                      OR (    document.t_creditFiId = account.t_fiId"
                   + "\n" + "                          AND document.t_creditAccount = account.t_account"
                   + "\n" + "                          AND EXISTS (SELECT 1"
                   + "\n" + "                                        FROM drepaccount_vw repacc"
                   + "\n" + "                                       WHERE repacc.t_accountId = document.t_debetAccountId"
                   + "\n" + "                                         AND SUBSTR(repacc.t_balance, 1, 3) = '458'"
                   + "\n" + "                                     )"
                   + "\n" + "                         )"
                   + "\n" + "                     )"
                   + "\n" + "                )"
                   + "\n" + "        ),"
                   + "\n" + "  loanAccounts"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT documents.t_documentAccount    AS t_account,"
                   + "\n" + "             documents.t_documentAccountId  AS t_accountId,"
                   + "\n" + "             documents.t_documentFiId       AS t_fiId,"
                   + "\n" + "             documents.t_documentChapter    AS t_chapter,"
                   + "\n" + "             CASE rowMasks.t_row"
                   + "\n" + "                 WHEN '4'"
                   + "\n" + "                 THEN " + getOkatoCode(true)
                   + "\n" + "                 ELSE " + getOkatoCode(false)
                   + "\n" + "             END                            AS t_okatoCode,"
                   + "\n" + "             CASE rowMasks.t_row"
                   + "\n" + "                 WHEN '4'"
                   + "\n" + "                 THEN " + getAdditionalOkatoCode(true)
                   + "\n" + "                 ELSE " + getAdditionalOkatoCode(false)
                   + "\n" + "             END                            AS t_additionalOkato,"
                   + "\n" + "             documents.t_branchId           AS t_branchId,"
                   + "\n" + "             DECODE(rowMasks.t_row,"
                   + "\n" + "                    '3_кред', '3',"
                   + "\n" + "                    '3_овер', '3',"
                   + "\n" + "                    rowMasks.t_row"
                   + "\n" + "                   )                        AS t_row,"
                   + "\n" + "             '5'                            AS t_column"
                   + "\n" + "        FROM rowMasks,"
                   + "\n" + "             documents"
                   + "\n" + "       WHERE rsb_mask.compareStringWithMask(rowMasks.t_accountMasks, documents.t_account) = 1"
                   + "\n" + "         AND (   (    rowMasks.t_row = '2.3'"
                   + "\n" + "                  AND (   documents.t_value IS NOT NULL /*isMSP = 1*/"
                   + "\n" + "                       OR (    documents.t_isPhisical = 1"
                   + "\n" + "                           AND documents.t_isEmployer = 1"
                   + "\n" + "                          )"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.2'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.3.1'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_кред'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_овер'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    rowMasks.t_row = '4'"
                   + "\n" + "                  AND documents.t_isOperOffice = 1"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    SUBSTR(rowMasks.t_row, 1, 3) = '2.1'"
                   + "\n" + "                  AND rowMasks.t_row != '2.1.9'"
                   + "\n" + "                  AND rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, documents.t_okved) = 1"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    rowMasks.t_row = '2.1.9'"
                   + "\n" + "                  AND (   documents.t_okved IS NULL"
                   + "\n" + "                       OR rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, documents.t_okved) = 0"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "             )"
                   + "\n" + "     )"
                   ;

        return    sourceQuery
        + "\n" + "SELECT DISTINCT"
        + "\n" + "       t_account,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_okatoCode,"
        + "\n" + "       t_additionalOkato,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_row,"
        + "\n" + "       t_column"
        + "\n" + "  FROM loanAccounts"
                 ;
    end;

    macro processRow()
        var command = RsdCommand(rslDefCon);
        command.nullConversion = true;

        command.cmdText = "BEGIN rcb_f302.processPart1Row5(?); END;";
        command.addParam("loanAccountsQueryText", RSDBP_IN, createLoanAccounts());
        command.execute();
    end;

    private macro constructorDataSourceFor5Columns_2627(okatoTuneTable : RcbTuneTable)
        initDataSourceFor4_5Columns();

        m_okatoTuneTable = okatoTuneTable;
    end;

    constructorDataSourceFor5Columns_2627(okatoTuneTable);
end;

class (DataSourceFor5Columns_2627) DataSourceFor5Columns_2742(okatoTuneTable : RcbTuneTable)

    private macro createLoanAccounts()
        var sourceQuery = generalSourceQuery + ","
                   + "\n" + "  rowMasks"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT t_row,"
                   + "\n" + "             '4,5' AS t_columns,"
                   + "\n" + "             NVL(t_okvedmasks, CHR(1)) t_okvedmasks,"
                   + "\n" + "             NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) t_accountmasks"
                   + "\n" + "        FROM df302tuneTable_tmp tuneTable"
                   + "\n" + "       WHERE t_columns = '4,5'"
                   + "\n" + "         AND t_backOffice = " + BOCB
                   + "\n" + "       GROUP BY t_row,"
                   + "\n" + "                t_okvedMasks"
                   + "\n" + "     ),"
                   + "\n" + "  loanAccounts"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT document.t_debetAccount        AS t_account,"
                   + "\n" + "             document.t_debetAccountId      AS t_accountId,"
                   + "\n" + "             document.t_debetFiId           AS t_fiId,"
                   + "\n" + "             account.t_chapter              AS t_chapter,"
                   + "\n" + "             CASE account.t_okato"
                   + "\n" + "                 WHEN '99999'"
                   + "\n" + "                 THEN account.t_okato"
                   + "\n" + "                 ELSE RPAD(SUBSTR(account.t_okato, 1, 2), 5, '0')"
                   + "\n" + "             END                            AS t_okatoCode,"
                   + "\n" + "             (SELECT okato.t_okato"
                   + "\n" + "                FROM (" + m_okatoTuneTable.getQuery() + ") okato"
                   + "\n" + "               WHERE rsb_mask.compareStringWithMask(okato.t_okatoMasks, account.t_okato) = 1"
                   + "\n" + "             )                              AS t_additionalOkato,"
                   + "\n" + "             account.t_branchId            AS t_branchId,"
                   + "\n" + "             DECODE(rowMasks.t_row,"
                   + "\n" + "                    '3_кред', '3',"
                   + "\n" + "                    '3_овер', '3',"
                   + "\n" + "                    rowMasks.t_row"
                   + "\n" + "                   )                        AS t_row,"
                   + "\n" + "             '5'                            AS t_column"
                   + "\n" + "        FROM rowMasks,"
                   + "\n" + "             repaccountdata account,"
                   + "\n" + "             F302DOCWITHCORRECTION_VW document"
                   + "\n" + "       WHERE account.t_fiId != " + NATCUR
                   + "\n" + "         AND account.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                    AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "         AND (   document.t_debetAccountId = account.t_accountId"
                   + "\n" + "              OR (    document.t_creditAccountId = account.t_accountId"
                   + "\n" + "                  AND EXISTS (SELECT 1"
                   + "\n" + "                                FROM drepaccount_vw repacc"
                   + "\n" + "                               WHERE repacc.t_accountId = document.t_debetAccountId"
                   + "\n" + "                                 AND SUBSTR(repacc.t_balance, 1, 3) = '458'"
                   + "\n" + "                             )"
                   + "\n" + "                 )"
                   + "\n" + "             )"
                   + "\n" + "         AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                 AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "         AND rsb_mask.compareStringWithMask(rowMasks.t_accountMasks, account.t_account) = 1"
                   + "\n" + "         AND (   (    rowMasks.t_row = '2.3'"
                   + "\n" + "                  AND (   account.t_value IS NOT NULL /*isMSP = 1*/"
                   + "\n" + "                       OR (    account.t_isPhisical = 1"
                   + "\n" + "                           AND account.t_isEmployer = 1"
                   + "\n" + "                          )"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.2'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.3.1'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_кред'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_овер'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    SUBSTR(rowMasks.t_row, 1, 3) = '2.1'"
                   + "\n" + "                  AND rowMasks.t_row != '2.1.9'"
                   + "\n" + "                  AND rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, account.t_okved) = 1"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    rowMasks.t_row = '2.1.9'"
                   + "\n" + "                  AND (   account.t_okved IS NULL"
                   + "\n" + "                       OR rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, account.t_okved) = 0"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "             )"
                   + "\n" + "     )"
                   ;

        return    sourceQuery
        + "\n" + "SELECT DISTINCT"
        + "\n" + "       t_account,"
        + "\n" + "       t_accountId,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_okatoCode,"
        + "\n" + "       t_additionalOkato,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_row,"
        + "\n" + "       t_column"
        + "\n" + "  FROM loanAccounts"
                 ;
    end;

    private macro constructorDataSourceFor5Columns_2742(okatoTuneTable : RcbTuneTable)
        initDataSourceFor5Columns_2627(okatoTuneTable);
    end;

    constructorDataSourceFor5Columns_2742(okatoTuneTable);
end;

class (DataSourceForColumns_2835) DataSourceFor5Columns_2835(okatoTuneTable : RcbTuneTable)
    private var m_okatoTuneTable = okatoTuneTable;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "   SELECT att.t_numInList"
               "\n" + "    FROM dobjattr_dbt att,"
               "\n" + "         dobjatcor_dbt atc,                                 "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_groupId        = 17                          "
               "\n" + "     AND atc.t_object         = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_general        = 'X'                         "
               "\n" + "     AND atc.t_attrId         = att.t_attrId                "
               "\n" + "     AND atc.t_objectType     = att.t_objectType            "
               "\n" + "     AND atc.t_groupId        = att.t_groupId               "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM dobjattr_dbt att,                          "
               "\n" + "                 dobjatcor_dbt atc,                         "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_groupId        = 17                  "
               "\n" + "             AND atc.t_object         = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND atc.t_general        = 'X'                 "
               "\n" + "             AND atc.t_attrId         = att.t_attrId        "
               "\n" + "             AND atc.t_objectType     = att.t_objectType    "
               "\n" + "             AND atc.t_groupId        = att.t_groupId       "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    private macro createLoanAccounts()
        var sourceQuery = generalSourceQuery + ","
                   + "\n" + "  rowMasks"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT t_row,"
                   + "\n" + "             '4,5' AS t_columns,"
                   + "\n" + "             NVL(t_okvedmasks, CHR(1)) t_okvedmasks,"
                   + "\n" + "             NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) t_accountmasks"
                   + "\n" + "        FROM df302tuneTable_tmp tuneTable"
                   + "\n" + "       WHERE t_columns = '4,5'"
                   + "\n" + "         AND t_backOffice = " + BOCB
                   + "\n" + "       GROUP BY t_row,"
                   + "\n" + "                t_okvedMasks"
                   + "\n" + "     ),"
                   + "\n" + "  loanAccountsSource"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT document.t_debetAccount        AS t_account,"
                   + "\n" + "             document.t_debetAccountId      AS t_accountId,"
                   + "\n" + "             document.t_debetFiId           AS t_fiId,"
                   + "\n" + "             account.t_chapter              AS t_chapter,"
                   + "\n" + getOkatoSubQuery("account.t_partyId", "document.t_date") + " AS t_okato,"
                   + "\n" + getOkvedSubQuery("account.t_partyId", "document.t_date") + " AS t_okved,"
                   + "\n" + "             account.t_branchId             AS t_branchId,"
                   + "\n" + "             account.t_value                AS t_value,"
                   + "\n" + "             account.t_isPhisical           AS t_isPhisical,"
                   + "\n" + "             account.t_isEmployer           AS t_isEmployer"
                   + "\n" + "        FROM repaccountdata account,"
                   + "\n" + "             F302DOCWITHCORRECTION_VW document"
                   + "\n" + "       WHERE account.t_fiId != " + NATCUR
                   + "\n" + "         AND account.t_opendate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                    AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "         AND (   document.t_debetAccountId = account.t_accountId"
                   + "\n" + "              OR (    document.t_creditAccountId = account.t_accountId"
                   + "\n" + "                  AND EXISTS (SELECT 1"
                   + "\n" + "                                FROM drepaccount_vw repacc"
                   + "\n" + "                               WHERE repacc.t_accountId = document.t_debetAccountId"
                   + "\n" + "                                 AND SUBSTR(repacc.t_balance, 1, 3) = '458'"
                   + "\n" + "                             )"
                   + "\n" + "                 )"
                   + "\n" + "             )"
                   + "\n" + "         AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                 AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "  ),"
                   + "\n" + "  loanAccounts"
                   + "\n" + "  AS ("
                   + "\n" + "      SELECT accounts.t_account        AS t_account,"
                   + "\n" + "             accounts.t_accountId      AS t_accountId,"
                   + "\n" + "             accounts.t_fiId           AS t_fiId,"
                   + "\n" + "             accounts.t_chapter        AS t_chapter,"
                   + "\n" + "             CASE accounts.t_okato"
                   + "\n" + "                 WHEN '99999'"
                   + "\n" + "                 THEN accounts.t_okato"
                   + "\n" + "                 ELSE RPAD(SUBSTR(accounts.t_okato, 1, 2), 5, '0')"
                   + "\n" + "             END                       AS t_okatoCode,"
                   + "\n" + "             (SELECT okato.t_okato"
                   + "\n" + "                FROM (" + m_okatoTuneTable.getQuery() + ") okato"
                   + "\n" + "               WHERE rsb_mask.compareStringWithMask(okato.t_okatoMasks, accounts.t_okato) = 1"
                   + "\n" + "             )                              AS t_additionalOkato,"
                   + "\n" + "             accounts.t_branchId            AS t_branchId,"
                   + "\n" + "             DECODE(rowMasks.t_row,"
                   + "\n" + "                    '3_кред', '3',"
                   + "\n" + "                    '3_овер', '3',"
                   + "\n" + "                    rowMasks.t_row"
                   + "\n" + "                    )                       AS t_row,"
                   + "\n" + "             '5'                            AS t_column"
                   + "\n" + "        FROM rowMasks,"
                   + "\n" + "             loanAccountsSource accounts"
                   + "\n" + "       WHERE rsb_mask.compareStringWithMask(rowMasks.t_accountMasks, accounts.t_account) = 1"
                   + "\n" + "         AND (   (    rowMasks.t_row = '2.3'"
                   + "\n" + "                  AND (   accounts.t_value IS NOT NULL /*isMSP = 1*/"
                   + "\n" + "                       OR (    accounts.t_isPhisical = 1"
                   + "\n" + "                           AND accounts.t_isEmployer = 1"
                   + "\n" + "                          )"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.2'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '2.3.1'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_кред'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (rowMasks.t_row = '3_овер'"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    SUBSTR(rowMasks.t_row, 1, 3) = '2.1'"
                   + "\n" + "                  AND rowMasks.t_row != '2.1.9'"
                   + "\n" + "                  AND rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, accounts.t_okved) = 1"
                   + "\n" + "                 )"
                   + "\n" + "              OR (    rowMasks.t_row = '2.1.9'"
                   + "\n" + "                  AND (   accounts.t_okved IS NULL"
                   + "\n" + "                       OR rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, accounts.t_okved) = 0"
                   + "\n" + "                      )"
                   + "\n" + "                 )"
                   + "\n" + "             )"
                   + "\n" + "     )"
                   ;

        return    sourceQuery
        + "\n" + "SELECT DISTINCT"
        + "\n" + "       t_account,"
        + "\n" + "       t_accountId,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_okatoCode,"
        + "\n" + "       t_additionalOkato,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_row,"
        + "\n" + "       t_column"
        + "\n" + "  FROM loanAccounts"
 //       + "\n" + " GROUP BY t_accountId, t_account, t_fiId, t_chapter, t_okatoCode, t_branchId, t_row, t_column"
                 ;
    end;

    macro processRow()
        var command = RsdCommand(rslDefCon);
        command.nullConversion = true;

        command.cmdText = "BEGIN rcb_f302.processPart1Row5(?); END;";
        command.addParam("loanAccountsQueryText", RSDBP_IN, createLoanAccounts());
        command.execute();
    end;

    private macro constructorDataSourceFor5Columns_2835(okatoTuneTable : RcbTuneTable)
        initDataSourceForColumns_2835(okatoTuneTable);
    end;

    constructorDataSourceFor5Columns_2835(okatoTuneTable);
end;

class (DataSourceFor5Columns_2835) DataSourceFor5Columns_Okved(okatoTuneTable : RcbTuneTable)

    private macro getOkatoSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT first_value(atc.t_value) over (ORDER BY atc.t_validFromDate DESC)"
               "\n" + "    FROM drepcategory_vw atc,                       "
               "\n" + "         drepparty_vw repparty                      "
               "\n" + "   WHERE atc.t_id             = 12                  "
               "\n" + "     AND atc.t_objectId       = repparty.t_objectId "
               "\n" + "     AND atc.t_objectType     = 3                   "
               "\n" + "     AND atc.t_validFromDate <= " + DateExpression +
               "\n" + "     AND atc.t_validToDate   >= " + DateExpression +
               "\n" + "     AND rownum < 2                                 "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NVL((SELECT DECODE(address.t_okatoCode, CHR(1), NULL, address.t_okatoCode)"
               "\n" + "               FROM drepparty_vw address"
               "\n" + "              WHERE address.t_id = " + objectField +
               "\n" + "            ), '99999'"
               "\n" + "           )"
               "\n" + "    )";
    end;

    private macro getOkvedSubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT atc.t_value                                        "
               "\n" + "    FROM drepcategory_vw atc,                               "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_id             = 17                          "
               "\n" + "     AND atc.t_objectId       = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM drepcategory_vw atc,                       "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_id             = 17                  "
               "\n" + "             AND atc.t_objectId       = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND repparty.t_id = " + objectField +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return " NVL(("
               "\n" + "  SELECT atc.t_value                                        "
               "\n" + "    FROM drepcategory_vw atc,                               "
               "\n" + "         drepparty_vw repparty                              "
               "\n" + "   WHERE atc.t_id             = 64                          "
               "\n" + "     AND atc.t_objectId       = repparty.t_objectId         "
               "\n" + "     AND atc.t_objectType     = 3                           "
               "\n" + "     AND atc.t_validFromDate  =                             "
               "\n" + "      (SELECT MIN(t_validFromDate)                          "
               "\n" + "            FROM drepcategory_vw atc,                       "
               "\n" + "                 drepparty_vw repparty                      "
               "\n" + "           WHERE atc.t_validFromDate <= " + dateExpression  +
               "\n" + "             AND atc.t_validToDate   >= " + dateExpression  +
               "\n" + "             AND atc.t_id             = 64                  "
               "\n" + "             AND atc.t_objectId       = repparty.t_objectId "
               "\n" + "             AND atc.t_objectType     = 3                   "
               "\n" + "             AND repparty.t_id        = " + objectField     +
               "\n" + "      )                                                     "
               "\n" + "     AND rownum < 2                                         "
               "\n" + "     AND repparty.t_id = " + objectField +
               "\n" + "     ), NULL)";
    end;

    private macro createLoanAccounts()
        var sourceQuery = generalSourceQuery + ","
                   + "\n" + "  rowMasks                                                                                     "
                   + "\n" + "  AS (                                                                                         "
                   + "\n" + "      SELECT t_row                                                  AS t_row,                  "
                   + "\n" + "             '4,5'                                                  AS t_columns,              "
                   + "\n" + "             NVL(t_okvedmasks, CHR(1))                              AS t_okvedmasks,           "
                   + "\n" + "             NVL(t_okved2masks, CHR(1))                             AS t_okved2masks,          "
                   + "\n" + "             NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) AS t_accountmasks          "
                   + "\n" + "        FROM df302tuneTable_tmp tuneTable                                                      "
                   + "\n" + "       WHERE t_columns = '4,5'                                                                 "
                   + "\n" + "         AND t_backOffice = " + BOCB
                   + "\n" + "       GROUP BY t_row,                                                                         "
                   + "\n" + "                t_okvedMasks,                                                                  "
                   + "\n" + "                t_okved2Masks                                                                  "
                   + "\n" + "     ),                                                                                        "
                   + "\n" + "  loanAccountsSource                                                                           "
                   + "\n" + "  AS (                                                                                         "
                   + "\n" + "      SELECT document.t_debetAccount                                AS t_account,              "
                   + "\n" + "             document.t_debetAccountId                              AS t_accountId,            "
                   + "\n" + "             document.t_debetFiId                                   AS t_fiId,                 "
                   + "\n" + "             account.t_chapter                                      AS t_chapter,              "
                   + "\n" + getOkatoSubQuery("account.t_partyId", "document.t_date")  + "        AS t_okato,                "
                   + "\n" + getOkvedSubQuery("account.t_partyId", "document.t_date")  + "        AS t_okved,                "
                   + "\n" + getOkved2SubQuery("account.t_partyId", "document.t_date") + "        AS t_okved2,               "
                   + "\n" + "             account.t_branchId                                     AS t_branchId,             "
                   + "\n" + "             account.t_value                                        AS t_value,                "
                   + "\n" + "             account.t_isPhisical                                   AS t_isPhisical,           "
                   + "\n" + "             account.t_isEmployer                                   AS t_isEmployer            "
                   + "\n" + "        FROM repaccountdata           account,                                                 "
                   + "\n" + "             F302DOCWITHCORRECTION_VW document                                                 "
                   + "\n" + "       WHERE account.t_fiId     != " + NATCUR
                   + "\n" + "         AND account.t_isOpened  = 1                                                           "
                   + "\n" + "         AND (   document.t_debetAccountId = account.t_accountId                               "
                   + "\n" + "              OR (    document.t_creditAccountId = account.t_accountId                         "
                   + "\n" + "                  AND EXISTS (SELECT 1                                                         "
                   + "\n" + "                                FROM dRepAccount_vw repacc                                     "
                   + "\n" + "                               WHERE repacc.t_accountId             = document.t_debetAccountId"
                   + "\n" + "                                 AND SUBSTR(repacc.t_balance, 1, 3) = '458'                    "
                   + "\n" + "                             )                                                                 "
                   + "\n" + "                 )                                                                             "
                   + "\n" + "             )                                                                                 "
                   + "\n" + "         AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                 AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "  ),                                                                                                       "
                   + "\n" + "  loanAccounts                                                                                             "
                   + "\n" + "  AS (                                                                                                     "
                   + "\n" + "      SELECT accounts.t_account                                    AS t_account,                           "
                   + "\n" + "             accounts.t_accountId                                  AS t_accountId,                         "
                   + "\n" + "             accounts.t_fiId                                       AS t_fiId,                              "
                   + "\n" + "             accounts.t_chapter                                    AS t_chapter,                           "
                   + "\n" + "             CASE accounts.t_okato                                                                         "
                   + "\n" + "                 WHEN '99999'                                                                              "
                   + "\n" + "                     THEN accounts.t_okato                                                                 "
                   + "\n" + "                 ELSE RPAD(SUBSTR(accounts.t_okato, 1, 2), 5, '0')                                         "
                   + "\n" + "             END                                                   AS t_okatoCode,                         "
                   + "\n" + "             (SELECT okato.t_okato                                                                         "
                   + "\n" + "                FROM (" + m_okatoTuneTable.getQuery() + ") okato"
                   + "\n" + "               WHERE rsb_mask.compareStringWithMask(okato.t_okatoMasks, accounts.t_okato) = 1              "
                   + "\n" + "             )                                                     AS t_additionalOkato,                   "
                   + "\n" + "             accounts.t_branchId                                   AS t_branchId,"
                   + "\n" + "             CASE                                                                                          "
                   + "\n" + "                 WHEN rowMasks.t_row = '3_кред'                                                            "
                   + "\n" + "                     THEN '3'                                                                              "
                   + "\n" + "                 WHEN rowMasks.t_row = '3_овер'                                                            "
                   + "\n" + "                     THEN '3'                                                                              "
                   + "\n" + "                 ELSE rowMasks.t_row                                                                       "
                   + "\n" + "             END                                                   AS t_row,                               "
                   + "\n" + "             '5'                                                   AS t_column                             "
                   + "\n" + "        FROM rowMasks,                                                                                     "
                   + "\n" + "             loanAccountsSource accounts                                                                   "
                   + "\n" + "       WHERE rsb_mask.compareStringWithMask(rowMasks.t_accountMasks, accounts.t_account) = 1               "
                   + "\n" + "         AND (   (    rowMasks.t_row = '2.3'                                                               "
                   + "\n" + "                  AND (   accounts.t_value IS NOT NULL /*isMSP = 1*/"
                   + "\n" + "                       OR (    accounts.t_isPhisical = 1                                                   "
                   + "\n" + "                           AND accounts.t_isEmployer = 1                                                   "
                   + "\n" + "                          )                                                                                "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '2.2'                                                                   "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '2.3.1'                                                                 "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '3_кред'                                                                "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '3_овер'                                                                "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (    SUBSTR(rowMasks.t_row, 1, 3) = '2.1'                                                 "
                   + "\n" + "                  AND rowMasks.t_row != '2.1.9'                                                            "
                   + "\n" + "                  AND (    rsb_mask.compareStringWithMask(rowMasks.t_okved2Masks, accounts.t_okved2) = 1   "
                   + "\n" + "                       OR (    accounts.t_okved2 IS NULL                                                   "
                   + "\n" + "                           AND rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, accounts.t_okved) = 1 "
                   + "\n" + "                          )                                                                                "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (    rowMasks.t_row = '2.1.9'                                                             "
                   + "\n" + "                  AND (   (accounts.t_okved IS NOT NULL AND rsb_mask.compareStringWithMask(rowMasks.t_okvedMasks, accounts.t_okved) = 0)"
                   + "\n" + "                       OR (accounts.t_okved2 IS NOT NULL AND rsb_mask.compareStringWithMask(rowMasks.t_okved2Masks, accounts.t_okved2) = 0) "
                   + "\n" + "                       OR (accounts.t_okved IS NULL AND accounts.t_okved2 IS NULL)                         "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "             )                                                                                             "
                   + "\n" + "     )                                                                                                     "
                   ;

        return sourceQuery
        + "\n" + "SELECT DISTINCT"
        + "\n" + "       t_account,"
        + "\n" + "       t_accountId,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_okatoCode,"
        + "\n" + "       t_additionalOkato,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_row,"
        + "\n" + "       t_column"
        + "\n" + "  FROM loanAccounts"
 //       + "\n" + " GROUP BY t_accountId, t_account, t_fiId, t_chapter, t_okatoCode, t_branchId, t_row, t_column"
                 ;
    end;

    private macro constructorDataSourceFor5Columns_Okved(okatoTuneTable : RcbTuneTable)
        initDataSourceFor5Columns_2835(okatoTuneTable);
    end;

    constructorDataSourceFor5Columns_Okved(okatoTuneTable);
end;

class (DataSourceFor5Columns_Okved) DataSourceFor5Columns_Okved_Т1_56_15_38_43598(okatoTuneTable : RcbTuneTable)
    private macro getOkved2SubQuery(objectField : String, dateExpression : String)
        return "NVL(("
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2_FOR_F302 +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + "    ),                                                           "
           "\n" + " (                                                               "
           "\n" + "  SELECT att.t_value                                             "
           "\n" + "    FROM drepcategory_vw att,                                    "
           "\n" + "         drepparty_vw    repparty                                "
           "\n" + "   WHERE att.t_id             = " + RCB_OBJGROUP_OKVED2          +
           "\n" + "     AND att.t_objectId       = repparty.t_objectId              "
           "\n" + "     AND att.t_objectType     = " + RCB_OBJTYPE_PARTY            +
           "\n" + "     AND att.t_validFromDate <= " + dateExpression               +
           "\n" + "     AND att.t_validToDate   >= " + dateExpression               +
           "\n" + "     AND repparty.t_id        = " + objectField                  +
           "\n" + "     AND rownum               = 1                                "
           "\n" + "))";
    end;

    private macro createLoanAccounts()
        var sourceQuery = generalSourceQuery + ","
                   + "\n" + "  rowMasks                                                                                     "
                   + "\n" + "  AS (                                                                                         "
                   + "\n" + "      SELECT t_row                                                  AS t_row,                  "
                   + "\n" + "             '4,5'                                                  AS t_columns,              "
                   + "\n" + "             NVL(t_okvedmasks, CHR(1))                              AS t_okvedmasks,           "
                   + "\n" + "             NVL(t_okved2masks, CHR(1))                             AS t_okved2masks,          "
                   + "\n" + "             NVL(LTRIM(conStr(',' || t_accountmasks), ','), CHR(1)) AS t_accountmasks          "
                   + "\n" + "        FROM df302tuneTable_tmp tuneTable                                                      "
                   + "\n" + "       WHERE t_columns = '4,5'                                                                 "
                   + "\n" + "         AND t_backOffice = " + BOCB
                   + "\n" + "       GROUP BY t_row,                                                                         "
                   + "\n" + "                t_okvedMasks,                                                                  "
                   + "\n" + "                t_okved2Masks                                                                  "
                   + "\n" + "     ),                                                                                        "
                   + "\n" + "  loanAccountsSource                                                                           "
                   + "\n" + "  AS (                                                                                         "
                   + "\n" + "      SELECT document.t_debetAccount                                AS t_account,              "
                   + "\n" + "             document.t_debetAccountId                              AS t_accountId,            "
                   + "\n" + "             document.t_debetFiId                                   AS t_fiId,                 "
                   + "\n" + "             account.t_chapter                                      AS t_chapter,              "
                   + "\n" + getOkatoSubQuery("account.t_partyId", "document.t_date")  + "        AS t_okato,                "
                   + "\n" + getOkved2SubQuery("account.t_partyId", "document.t_date") + "        AS t_okved2,               "
                   + "\n" + "             account.t_branchId                                     AS t_branchId,             "
                   + "\n" + "             account.t_value                                        AS t_value,                "
                   + "\n" + "             account.t_isPhisical                                   AS t_isPhisical,           "
                   + "\n" + "             account.t_isEmployer                                   AS t_isEmployer            "
                   + "\n" + "        FROM repaccountdata           account,                                                 "
                   + "\n" + "             F302DOCWITHCORRECTION_VW document                                                 "
                   + "\n" + "       WHERE account.t_fiId     != " + NATCUR
                   + "\n" + "         AND account.t_isOpened  = 1                                                           "
                   + "\n" + "         AND (   document.t_debetAccountId = account.t_accountId                               "
                   + "\n" + "              OR (    document.t_creditAccountId = account.t_accountId                         "
                   + "\n" + "                  AND EXISTS (SELECT 1                                                         "
                   + "\n" + "                                FROM dRepAccount_vw repacc                                     "
                   + "\n" + "                               WHERE repacc.t_accountId             = document.t_debetAccountId"
                   + "\n" + "                                 AND SUBSTR(repacc.t_balance, 1, 3) = '458'                    "
                   + "\n" + "                             )                                                                 "
                   + "\n" + "                 )                                                                             "
                   + "\n" + "             )                                                                                 "
                   + "\n" + "         AND document.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
                   + "\n" + "                                 AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
                   + "\n" + "  ),                                                                                                       "
                   + "\n" + "  loanAccounts                                                                                             "
                   + "\n" + "  AS (                                                                                                     "
                   + "\n" + "      SELECT accounts.t_account                                    AS t_account,                           "
                   + "\n" + "             accounts.t_accountId                                  AS t_accountId,                         "
                   + "\n" + "             accounts.t_fiId                                       AS t_fiId,                              "
                   + "\n" + "             accounts.t_chapter                                    AS t_chapter,                           "
                   + "\n" + "             CASE accounts.t_okato                                                                         "
                   + "\n" + "                 WHEN '99999'                                                                              "
                   + "\n" + "                     THEN accounts.t_okato                                                                 "
                   + "\n" + "                 ELSE RPAD(SUBSTR(accounts.t_okato, 1, 2), 5, '0')                                         "
                   + "\n" + "             END                                                   AS t_okatoCode,                         "
                   + "\n" + "             (SELECT okato.t_okato                                                                         "
                   + "\n" + "                FROM (" + m_okatoTuneTable.getQuery() + ") okato"
                   + "\n" + "               WHERE rsb_mask.compareStringWithMask(okato.t_okatoMasks, accounts.t_okato) = 1              "
                   + "\n" + "             )                                                     AS t_additionalOkato,                   "
                   + "\n" + "             accounts.t_branchId                                   AS t_branchId,"
                   + "\n" + "             CASE                                                                                          "
                   + "\n" + "                 WHEN rowMasks.t_row = '3_кред'                                                            "
                   + "\n" + "                     THEN '3'                                                                              "
                   + "\n" + "                 WHEN rowMasks.t_row = '3_овер'                                                            "
                   + "\n" + "                     THEN '3'                                                                              "
                   + "\n" + "                 ELSE rowMasks.t_row                                                                       "
                   + "\n" + "             END                                                   AS t_row,                               "
                   + "\n" + "             '5'                                                   AS t_column                             "
                   + "\n" + "        FROM rowMasks,                                                                                     "
                   + "\n" + "             loanAccountsSource accounts                                                                   "
                   + "\n" + "       WHERE rsb_mask.compareStringWithMask(rowMasks.t_accountMasks, accounts.t_account) = 1               "
                   + "\n" + "         AND (   (    rowMasks.t_row = '2.3'                                                               "
                   + "\n" + "                  AND (   accounts.t_value IS NOT NULL /*isMSP = 1*/"
                   + "\n" + "                       OR (    accounts.t_isPhisical = 1                                                   "
                   + "\n" + "                           AND accounts.t_isEmployer = 1                                                   "
                   + "\n" + "                          )                                                                                "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '2.2'                                                                   "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '2.3.1'                                                                 "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '3_кред'                                                                "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (rowMasks.t_row = '3_овер'                                                                "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (    SUBSTR(rowMasks.t_row, 1, 3) = '2.1'                                                 "
                   + "\n" + "                  AND rowMasks.t_row != '2.1.9'                                                            "
                   + "\n" + "                  AND (    rsb_mask.compareStringWithMask(rowMasks.t_okved2Masks, accounts.t_okved2) = 1   "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "              OR (    rowMasks.t_row = '2.1.9'                                                             "
                   + "\n" + "                  AND (   accounts.t_okved2 IS NOT NULL AND rsb_mask.compareStringWithMask(rowMasks.t_okved2Masks, accounts.t_okved2) = 0 "
                   + "\n" + "                       OR accounts.t_okved2 IS NULL                         "
                   + "\n" + "                      )                                                                                    "
                   + "\n" + "                 )                                                                                         "
                   + "\n" + "             )                                                                                             "
                   + "\n" + "     )                                                                                                     "
                   ;

        return sourceQuery
        + "\n" + "SELECT DISTINCT"
        + "\n" + "       t_account,"
        + "\n" + "       t_accountId,"
        + "\n" + "       t_fiId,"
        + "\n" + "       t_chapter,"
        + "\n" + "       t_okatoCode,"
        + "\n" + "       t_additionalOkato,"
        + "\n" + "       t_branchId,"
        + "\n" + "       t_row,"
        + "\n" + "       t_column"
        + "\n" + "  FROM loanAccounts"
 //       + "\n" + " GROUP BY t_accountId, t_account, t_fiId, t_chapter, t_okatoCode, t_branchId, t_row, t_column"
                 ;
    end;

    private macro constructorDataSourceFor5Columns_Okved_Т1_56_15_38_43598(okatoTuneTable : RcbTuneTable)
        initDataSourceFor5Columns_Okved(okatoTuneTable);
    end;

    constructorDataSourceFor5Columns_Okved_Т1_56_15_38_43598(okatoTuneTable);
end;

/***************************************************************************************************
 *  Класс заполнения данными по ГК первого раздела
 **************************************************************************************************/
private macro fillTempTable(instructionDate)
    macro processTranche()
        var tranche = DataSourceFor6_9Columns().getData();

        TProcessorDecorator(TProcessorPart1(TInserterPart1(), tranche, null, instructionDate)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4_5Columns().getData();

        TProcessorDecorator(TProcessorPart1(TInserterPart1(), creditOperation, "4,5", instructionDate)).execute();
    end;

    processTranche();
    processCreditOperation();
end;

private macro isPart1DataExists()
    return TRsbDataset("SELECT 1"
              + "\n" + "  FROM DUAL"
              + "\n" + " WHERE EXISTS(SELECT 1"
              + "\n" + "                FROM df302tuneTable_tmp tuneTable,"
              + "\n" + "                     drepaccount_vw acc"
              + "\n" + "               WHERE t_backOffice = 1"
              + "\n" + "                 AND acc.t_isOpened = 1"
              + "\n" + "                 AND (   rsb_mask.compareStringWithMask(tuneTable.t_accountMasks, acc.t_account) = 1"
              + "\n" + "                      OR rsb_mask.compareStringWithMask(tuneTable.t_accountMasksFor_8_9, acc.t_account) = 1"
              + "\n" + "                     )"
              + "\n" + "             )"
                      ).next();
end;

private macro fillTempTable_2627(okatoTuneTable)
    macro processTranche()
        var tranche = DataSourceFor6_9Columns_2627().getData();
        TProcessorDecorator(TProcessorPart1_2627(TInserterPart1(), tranche, null)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_2627().getData();
        TProcessorDecorator(TProcessorPart1_2627(TInserterPart1(), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_2627(okatoTuneTable).processRow();
    end;

    if (isPart1DataExists())
        sql_execute("BEGIN rep_data.initCorrectDocumentParameters(1, rep_data.getBeginDate(), rep_data.getEndDate()); END;");
        processTranche();
        processCreditOperation();
    end;
end;

private macro fillTempTable_2742(okatoTuneTable)
    macro processTranche()
        var tranche = DataSourceFor6_9Columns_2742().getData();
        TProcessorDecorator(TProcessorPart1_2742(TInserterPart1(), tranche, null)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_2742().getData();
        TProcessorDecorator(TProcessorPart1_2742(TInserterPart1(), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_2742(okatoTuneTable).processRow();
    end;

    if (isPart1DataExists())
        sql_execute("BEGIN rep_data.initCorrectDocumentParameters(1, rep_data.getBeginDate(), rep_data.getEndDate()); END;");
        processTranche();
        processCreditOperation();
    end;
end;

private class fillTempTable_2835(okatoTuneTable)
    private var m_okatoTuneTable = okatoTuneTable;

    private macro processTranche()
        var tranche = DataSourceFor6_9Columns_2835().getData();
        TProcessorDecorator(TProcessorPart1_2742(TInserterPart1(), tranche, null)).execute();
    end;

    private macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_2835().getData();
        TProcessorDecorator(TProcessorPart1_2742(TInserterPart1(), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_2835(m_okatoTuneTable).processRow();
    end;

    macro execute()
        if (isPart1DataExists())
            sql_execute("BEGIN rep_data.initCorrectDocumentParameters(1, rep_data.getBeginDate(), rep_data.getEndDate()); END;");
            processCreditOperation();
            processTranche();
        end;
    end;
end;

private class(fillTempTable_2835) fillTempTable_3129(okatoTuneTable)
    initfillTempTable_2835(okatoTuneTable);

    macro processTranche()
        var tranche = DataSourceFor6_9Columns_3129().getData();
        TProcessorDecorator(TProcessorPart1_3129(TInserterPart1(), tranche, null)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_3129().getData();
        TProcessorDecorator(TProcessorPart1_3129(TInserterPart1(), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_2835(m_okatoTuneTable).processRow();
    end;
end;

private class(fillTempTable_3129) fillTempTable_Okved(okatoTuneTable)
    initfillTempTable_3129(okatoTuneTable);

    macro processTranche()
        var tranche = DataSourceFor6_9Columns_Okved().getData();
        TProcessorDecorator(TProcessorPart1_Okved(TInserterPart1(), tranche, null)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_Okved().getData();
        TProcessorDecorator(TProcessorPart1_Okved(TInserterPart1(), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_Okved(m_okatoTuneTable).processRow();
    end;
end;

private class(fillTempTable_Okved) fillTempTable_Okved_Т1_56_15_38_43598(okatoTuneTable)
    initfillTempTable_Okved(okatoTuneTable);

    macro processTranche()
        var tranche = DataSourceFor6_9Columns_Okved_Т1_56_15_38_43598().getData();
        TProcessorDecorator(TProcessorPart1_Okved_Т1_56_15_38_43598(TInserterPart1(m_okatoTuneTable), tranche, null)).execute();
    end;

    macro processCreditOperation()
        var creditOperation = DataSourceFor4Columns_Okved_Т1_56_15_38_43598().getData();
        TProcessorDecorator(TProcessorPart1_Okved_Т1_56_15_38_43598(TInserterPart1(m_okatoTuneTable), creditOperation, "4,5")).execute();

        DataSourceFor5Columns_Okved_Т1_56_15_38_43598(m_okatoTuneTable).processRow();
    end;
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()
    var bo_cb  = TBackOffice(BOCB);
    var tuneTable;
    var okatoTuneTable;

    var profiler = TSQLProfiler(getTxtFileName("!calc_f302cb_sqlprof"));
    profiler.clear();
    profiler.on();

    if   (RcbApplication().currentReport().context().period().endDate() < RCB_I2183_DATE)
        tuneTable = RcbTuneTable("dt302_dbt");
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BOCB);
        tuneTable.setInstructionFilter(RCB_I2055_DATE);

        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2055(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2183_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BOCB);

        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            /*заполнение временной таблицы первого раздела*/
            fillTempTable(RCB_I2183_DATE);
            /*заполнение временной таблицы второго раздела*/
            TInserter2055(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2470_DATE2)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2332_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BOCB);

        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            /*заполнение временной таблицы первого раздела*/
            fillTempTable(RCB_I2332_DATE);
            /*заполнение временной таблицы второго раздела*/
            TInserter2055(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2539_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2470_DATE2);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BOCB);

        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            /*заполнение временной таблицы первого раздела*/
            fillTempTable(RCB_I2470_DATE2);
            /*заполнение временной таблицы второго раздела*/
            TInserter2470(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2627_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2539_DATE);
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + BOCB);

        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            /*заполнение временной таблицы первого раздела*/
            fillTempTable(RCB_I2539_DATE);
            /*заполнение временной таблицы второго раздела*/
            TInserter2539(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2742_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2627_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I2627_DATE);

            fillTempTable_2627(okatoTuneTable);
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2539(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2835_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2742_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I2742_DATE);

            fillTempTable_2742(okatoTuneTable);
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2742(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2926_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2742_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I2742_DATE);

            fillTempTable_2835(okatoTuneTable);
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2742(TAccountQueryBuilder1948(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3129_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I2926_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I2742_DATE);
            fillTempTable_2835(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2926(TAccountQueryBuilder2926(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3269_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3129_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3129_DATE);
            fillTempTable_3129(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter2926(TAccountQueryBuilder2926(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3468_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3269_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3129_DATE);
            fillTempTable_3129(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3269(TAccountQueryBuilder2926(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_OKVED_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3468_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3129_DATE);
            fillTempTable_3129(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3468(TAccountQueryBuilder2926(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3656_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_OKVED_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_OKVED_DATE);
            fillTempTable_Okved(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3468(TAccountQueryBuilder_Okved(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I3875_DATE2)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3656_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3656_DATE);
            fillTempTable_Okved(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3656(TAccountQueryBuilder_3656(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_IXXXX_DATE4)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3875_DATE2);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3875_DATE2);
            fillTempTable_Okved(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3656(TAccountQueryBuilder_3656(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_Т1_56_15_38_43598_DATE)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I3875_DATE2);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_I3875_DATE2);
            fillTempTable_Okved(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3875(TAccountQueryBuilder_3656(), tuneTable).execute();
        end;
    elif (RcbApplication().currentReport().context().period().endDate() < RCB_I4637_DATE_F302)
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_Т1_56_15_38_43598_DATE);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbTuneTable("DT302OKATOCODES_DBT");
            okatoTuneTable.setInstructionFilter(RCB_Т1_56_15_38_43598_DATE);
            fillTempTable_Okved_Т1_56_15_38_43598(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter3875(TAccountQueryBuilder_3656(), tuneTable).execute();
        end;
    else
        tuneTable = RcbTuneTable("dt302balanceAccounts_dbt");
        tuneTable.setInstructionFilter(RCB_I4637_DATE_F302);

        /*заполнение временной таблицы первого раздела*/
        tuneTable.setUserFilter("t_part = 1 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            okatoTuneTable = RcbArTuneTable_4637();
            fillTempTable_Okved_Т1_56_15_38_43598(okatoTuneTable).execute();
        end;

        /*заполнение временной таблицы второго раздела*/
        tuneTable.setUserFilter("t_part = 2 AND t_backOffice = " + bo_cb.getId());
        if (tuneTable.hasDataFor(bo_cb, "t_backOffice"))
            TInserter4637(TAccountQueryBuilder_4637(), tuneTable).execute();
        end;
    end;
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/
main();
УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
