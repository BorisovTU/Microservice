import calc_f251;

macro roundValue(line1, line2, column)
    var varName1 = "Ф251__" + line1 + "__" + column;
    var varName2 = "Ф251__" + line2 + "__" + column;
    var report = rcbApplication().currentReport();
    var valT1, valT2;
    var valR1, valR2;
    ПрочитатьПеременную2(valT1,valR1,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName1);
    ПрочитатьПеременную2(valT2,valR2,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName2);

    if ((valT1 >= valT2) and (valR1 < valR2))
        СохранитьПеременную2(valT1,valR2,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName1,2);
    end;

end;

macro roundSumValue(line1, line2, column)
    var str;
    var i, j, k;
    var valR1 = TArray();
    var valT1 = TArray();
    var varName1 = TArray();
    var sumR1 = 0, sumR2 = 0;
    var sumT1 = 0, sumT2 = 0;
    var varName;
    var valR, valT;
    var report = rcbApplication().currentReport;

    str = line2;
    j = 1;

    i = index(str, ",");
    while (i > 0)
        varName = "Ф251__" + subStr(str,1,i - 1) + "__" + column;
        ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
        sumR2 = sumR2 + valR;
        sumT2 = sumT2 + valT;
        str = subStr(str,i+1);

        i = index(str, ",");
        j = j + 1;
    end;

    varName = "Ф251__" + str + "__" + column;
    ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
    sumR2 = sumR2 + valR;
    sumT2 = sumT2 + valT;

    str = line1;
    j = 1;
    k = 1;

    i = index(str, ",");
    while (i > 0)
        varName = "Ф251__" + subStr(str,1,i - 1) + "__" + column;
        ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
        sumR1 = sumR1 + valR;
        sumT1 = sumT1 + valT;
        valR1[k] = valR;
        valT1[k] = valT;
        varName1[k] = varName;
        str = subStr(str,i+1);

        i = index(str, ",");
        j = j + 1;
    end;

    varName = "Ф251__" + str + "__" + column;
    ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
    sumR1 = sumR1 + valR;
    sumT1 = sumT1 + valT;

    if ((sumT1 > sumT2) and (sumR1 < sumR2))
        if (j>1)
            k = 1;
            while (sumR1 < sumR2)
                sumR1 = sumR1 + 1;
                valR1[k] = valR1[k] + 1;
                k = k + 1;
                if (k > valR1.size())
                    k = 1;
                end;
            end;
            k = 1;
            while (k < valR1.size())
                СохранитьПеременную2(valT1[k],valR1[k],report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName[k],2);
                k = k + 1;
            end;
        else
            СохранитьПеременную2(valT,sumR2,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName,2);
        end;
    end;

end;

macro setSumValue(line1, line2, column)
    var str;
    var i, j;
    var lines = TArray();
    var sum = 0;
    var varName;
    var valR, valT;
    var report = rcbApplication().currentReport;

    str = line2;
    j = 1;

    i = index(str, ",");
    while (i > 0)
        varName = "Ф251__" + subStr(str,1,i - 1) + "__" + column;
        ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
        sum = sum + valR;
        str = subStr(str,i+1);

        i = index(str, ",");
        j = j + 1;
    end;

    varName = "Ф251__" + str + "__" + column;
    ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
    sum = sum + valR;

    varName = "Ф251__" + line1 + "__" + column;
    ПрочитатьПеременную2(valT,valR,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName);
    varName = "Ф251__" + line1 + "__" + column;
    СохранитьПеременную2(valT,sum,report.context.period.endDate,report.context.period.beginDate,report.form.name(),varName,2);
end;


macro roundValues()
    var    column = 5;

    rcbApplication().transactionManager.commit();
    while (column < 7)
        roundValue("1_1",     "1_1_1",     column);
        roundValue("1_2",     "1_2_2",     column);
        roundValue("2_1_1_1", "2_1_1_1_1", column);
        roundValue("2_1_1",   "2_1_1_1",   column);
        roundValue("2_2_1_1", "2_2_1_1_1", column);
        roundValue("2_2_1_1", "2_2_1_1_2", column);
        roundValue("2_2_1",   "2_2_1_1",   column);
        roundValue("2_4_1_2", "2_4_1_2_1", column);
        roundValue("2_4_1",   "2_4_1_1",   column);
        roundValue("2_4_1",   "2_4_1_2",   column);
        roundValue("2_4_2_2", "2_4_2_2_1", column);
        roundValue("2_4_2",   "2_4_2_1",   column);
        roundValue("2_4_2",   "2_4_2_2",   column);
        roundValue("2_5",     "2_5_1",     column);
        roundValue("3_1",     "3_1_1",     column);
        roundValue("3_2",     "3_2_1",     column);
        roundValue("3_3",     "3_3_1",     column);
        roundValue("3_4",     "3_4_1",     column);

        roundSumValue("4_1", "4_1_1,4_1_2", column);
        setSumValue  ("2_4", "2_4_1,2_4_2", column);
        roundSumValue("2_1_1,2_1_2,2_1_3,2_1_4,2_1_5,2_2_1,2_2_2,2_2_3,2_2_4,2_2_5,2_3_1,2_3_2,2_3_3,2_3_4,2_3_5,2_4,2_5",
                      "3_1,3_2,3_3,3_4", column);

        column = column + 1;
    end;
end;

macro roundValues_2539()
    var    column = 5;

    rcbApplication().transactionManager.commit();
    while (column < 7)
        roundValue("1_1",     "1_1_1",     column);
        roundValue("1_2",     "1_2_2",     column);
        roundValue("2_1_1_1", "2_1_1_1_1", column);
        roundValue("2_1_1",   "2_1_1_1",   column);
        roundValue("2_1_6",   "2_1_6_1",   column);
        roundValue("2_2_1_1", "2_2_1_1_1", column);
        roundValue("2_2_1_1", "2_2_1_1_2", column);
        roundValue("2_2_1",   "2_2_1_1",   column);
        roundValue("2_2_6",   "2_2_6_1",   column);
        roundValue("2_3_6",   "2_3_6_1",   column);
        roundValue("2_4_1_2", "2_4_1_2_1", column);
        roundValue("2_4_1",   "2_4_1_1",   column);
        roundValue("2_4_1",   "2_4_1_2",   column);
        roundValue("2_4_2_2", "2_4_2_2_1", column);
        roundValue("2_4_2",   "2_4_2_1",   column);
        roundValue("2_4_2",   "2_4_2_2",   column);
        roundValue("2_5",     "2_5_1",     column);
        roundValue("3_1",     "3_1_1",     column);
        roundValue("3_2",     "3_2_1",     column);
        roundValue("3_3",     "3_3_1",     column);
        roundValue("3_4",     "3_4_1",     column);

        roundSumValue("3_3", "2_1_6,2_2_6,2_3_6 ", column);
        roundSumValue("4_1", "4_1_1,4_1_2", column);
        setSumValue  ("2_4", "2_4_1,2_4_2", column);
        roundSumValue("2_1_1,2_1_2,2_1_3,2_1_4,2_1_5,2_1_6,2_2_1,2_2_2,2_2_3,2_2_4,2_2_5,2_2_6,2_3_1,2_3_2,2_3_3,2_3_4,2_3_5,2_3_6,2_4",
                      "3_1,3_2,3_3,3_4", column);

        column = column + 1;
    end;
end;

macro roundValues_2742()
    var    column = 5;

    rcbApplication().transactionManager.commit();
    while (column < 7)
        roundValue("1_1",     "1_1_1",     column);
        roundValue("1_2",     "1_2_2",     column);
        roundValue("2_1_1_1", "2_1_1_1_1", column);
        roundValue("2_1_1",   "2_1_1_1",   column);
        roundValue("2_1_6",   "2_1_6_1",   column);
        roundValue("2_2_1_1", "2_2_1_1_1", column);
        roundValue("2_2_1_1", "2_2_1_1_2", column);
        roundValue("2_2_1",   "2_2_1_1",   column);
        roundValue("2_2_6",   "2_2_6_1",   column);
        roundValue("2_3_6",   "2_3_6_1",   column);
        roundValue("2_4_1_2", "2_4_1_2_1", column);
        roundValue("2_4_1",   "2_4_1_1",   column);
        roundValue("2_4_1",   "2_4_1_2",   column);
        roundValue("2_4_2_2", "2_4_2_2_1", column);
        roundValue("2_4_2",   "2_4_2_1",   column);
        roundValue("2_4_2",   "2_4_2_2",   column);
        roundValue("2_5",     "2_5_1",     column);
        roundValue("3_1",     "3_1_1",     column);
        roundValue("3_2",     "3_2_1",     column);
        roundValue("3_3",     "3_3_1",     column);
        roundValue("3_4",     "3_4_1",     column);

        roundSumValue("3_3", "2_1_6,2_2_6,2_3_6 ", column);
        roundSumValue("4_1", "4_1_1,4_1_2", column);
        setSumValue  ("2_4", "2_4_1,2_4_2", column);
        roundSumValue("2_1_1,2_1_2,2_1_3,2_1_4,2_1_5,2_1_6,2_2_1,2_2_2,2_2_3,2_2_4,2_2_5,2_2_6,2_3_1,2_3_2,2_3_3,2_3_4,2_3_5,2_3_6,2_4",
                      "3_1,3_2,3_3,3_4", column);

        column = column + 1;
    end;
end;


macro main()
    if (rcbApplication().currentReport.context.period.endDate >= RCB_I2742_DATE)
        roundValues_2742();
    elif (rcbApplication().currentReport.context.period.endDate >= RCB_I2539_DATE)
        roundValues_2539();
    else
        roundValues();
    end;
end;


main();
УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
