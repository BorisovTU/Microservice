/*
 $Name:        F345Attribute.mac
 $Module:      ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
 $Description: Š« áá  âà¨¡ãâ 
*/
/* ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   RS-Bank V6                                                 R-Style Softlab
   ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨à®¢ ­­ ï ®âç¥â­®áâì"

   ”®à¬  345. €âà¨¡ãâ ®âç¥â .

   CREATED : 24.09.12 Gor.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ */
class (RcbAttributeBase) F345Attribute(id : String, part : RcbPartBase, compositeValue : Object)
    initRcbAttributeBase(id, part, compositeValue);

    class TVal(v, ca, _id)
        var value = v;
        var cnt_account = ca;
        var id = _id; // „«ï à §¤¥«  "‘¯à ¢®ç­®"
    end;

    private macro getCompositeValue(_variable : Variant, isFind : Bool) : RcbCompositeValue

        var keyValue = m_attributeCompositeValue.createKeyValue();
        var compositeValue;
        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))
            var _date = Date(_variable);

            keyValue.fieldValue("part") = m_part.getId();
            keyValue.fieldValue("columnId") = getId();
            keyValue.fieldValue("date") = String(_date);

            compositeValue = m_attributeCompositeValue.findValue(keyValue);

            if (compositeValue != null)
                return compositeValue;
            elif (isFind)
                return null;
            end;

            compositeValue = m_attributeCompositeValue.addValue();

            compositeValue.reset();

            compositeValue.fieldValue("part").exact = m_part.getId();
            compositeValue.fieldValue("columnId").exact = getId();
            compositeValue.fieldValue("date").exact = String(_date);

            return compositeValue;
        else

            keyValue.fieldValue("part") = m_part.getId();

            keyValue.fieldValue("columnId") = String(_variable);

            compositeValue = m_attributeCompositeValue.findValue(keyValue);

            if (compositeValue != null)
                return compositeValue;
            elif (isFind)
                return null;
            end;

            compositeValue = m_attributeCompositeValue.addValue();

            compositeValue.reset();

            compositeValue.fieldValue("part").exact = m_part.getId();

            compositeValue.fieldValue("columnId").exact = String(_variable);

            return compositeValue;
        end;
    end;

    macro getRcbValue(_variable : Variant, isFind : Bool) : RcbValue
        var compositeValue = getCompositeValue(_variable, isFind);

        if (isFind and (compositeValue == null))
            return null;
        end;

        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))
            return compositeValue.fieldValue("MoneyValue");
        else
            return compositeValue;
        end;
    end;

    macro getValue(_variable : Variant)
        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))
            return getRcbValue(_variable).exact;
        else
            var value = getRcbValue(_variable).fieldValue("MoneyValue").exact;
            var cnt_account = getRcbValue(_variable).fieldValue("countAccount").current;

            return TVal(value, cnt_account);
        end;
    end;

    macro getScaledValue(_variable : Variant)
        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))
            return getRcbValue(_variable).scaled;
        else
            var value = getRcbValue(_variable).fieldValue("MoneyValue").scaled;
            var cnt_account = getRcbValue(_variable).fieldValue("countAccount").current;

            return TVal(value, cnt_account);
        end;
    end;

    macro findValue(_date : Date)
        var val = getRcbValue(_date, true);

        if (val == null)
            return null;
        end;

        return val.exact;
    end;

    macro findScaledValue(_date : Date)
        var val = getRcbValue(_date, true);

        if (val == null)
            return null;
        end;

        return val.scaled;
    end;

    macro getValueAsString(_date : Date) : String
        var val = getRcbValue(_date);

        if ((val == null) or val.isUndefined())
            return null;
        end;

        return val.currentAsString;
    end;

    macro setCountAccountValue(_variable : Variant, value : Variant)
        var val = getRcbValue(_variable);
        var totalRest = val.fieldValue("MoneyValue");
        var account_cnt = val.fieldValue("countAccount");

        if (value != NULL)
            if (isEqClass("TValue", value))
                account_cnt.current  = string(value);
            else
                if (value != null)
                    account_cnt.current  = string(value)
                else
                    account_cnt.setUndefined;
                end;
            end;
        end;

        return this;
    end;

    macro setValue(_variable : Variant, value : Variant, value2 : Variant)

        var val = getRcbValue(_variable);

        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))

            if (isEqClass("TValue", value))
                val.exact  = value.exact;
                val.scaled = value.scaled;
            else
                if (value != null)
                    val.exact = value;
                    val.recalculateScaled();
                else
                    val.setUndefined;
                end;
            end;
        else
            var totalRest = val.fieldValue("MoneyValue");
            var account_cnt = val.fieldValue("countAccount");

            if (isEqClass("TValue", value))
                totalRest.exact  = value.exact;
                totalRest.scaled = value.scaled;
            else
                if (value != null)
                    totalRest.exact = value;
                    totalRest.recalculateScaled();
                else
                    totalRest.setUndefined;
                end;
            end;

           if (value2 != NULL)
               if (isEqClass("TValue", value2))
                   account_cnt.current  = string(value2);
               else
                   if (value2 != null)
                       account_cnt.current  = string(value2)
                   else
                       account_cnt.setUndefined;
                   end;
               end;
           end;
        end;

        return this;
    end;

    macro setScaledValue(_variable : Variant, value : Double, value2 : Variant) : RcbAttributeBase

        var val = getRcbValue(_variable);

        if ((valType(_variable) == V_DATE) or (valType(_variable) == V_DTTM))

            if (isEqClass("TValue", value))
                val.scaled = value.scaled;
            else
                if (value != null)
                    val.scaled = value;
                else
                    val.setUndefined;
                end;
            end;
        else
            var totalRest = val.fieldValue("MoneyValue");

            if (isEqClass("TValue", value))
                totalRest.scaled = value.scaled;
            else
                if (value != null)
                    totalRest.scaled = value;
                else
                    totalRest.setUndefined;
                end;
            end;

            if (valType(value2) != V_UNDEF)
                var countAccount = val.fieldValue("countAccount");

                if (isEqClass("TValue", value2))
                    countAccount.scaled = value2.scaled;
                else
                    if (value2 != null)
                        countAccount.scaled = value2;
                    else
                        countAccount.setUndefined;
                    end;
                end;
            end;
        end;

        return this;
    end;

    // „«ï à §¤¥«  "‘¯à ¢®ç­®"
    macro getValueIterator()
        var container = RcbArray();

        var it = m_attributeCompositeValue.createValueIterator();
        it.moveFirst();
        while (not it.isDone())
            var item = it.currentItem();
            container.push_back(TVal(item.fieldValue("MoneyValue").scaled, item.fieldValue("countAccount").current, item.fieldValue("columnId").current));
            it.moveNext();
        end;

        return container;
    end;

    macro isEmpty()
        var temp_date : Date = global.getRcbPeriod().beginDate;

        if (m_part.getId() == "‘¯à ¢®ç­®")
            for (var i, i = 1, i = 9, 1)
                   var valSprav     = getValue(string(i));
                   var valSprav_ind = getValue(string(i) + "_ƒŠ");

                    if ((valSprav != null) or (valSprav_ind != null))
                        global.setPrintFlag(m_part.getId());
                        return false;
                    end;
            end;
        else
            while (temp_date <= global.getRcbPeriod().endDate)
                var value = findValue(temp_date);
                if ((value != null) and (value != $0.0))
                    global.setPrintFlag(m_part.getId());
                    return false;
                end;

                temp_date = temp_date + 1;
            end;
        end;

        return true;
    end;
end;
