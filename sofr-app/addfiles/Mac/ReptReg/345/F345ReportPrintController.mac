/*
 $Name:        F345ReportPrintController.mac
 $Module:      Регламентируемая отчетность
 $Description: Форма 345. Контроллер печати отчета
*/

/* --------------------------------------------------------------------------┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 345. Контроллер печати отчета.

   CREATED : 15.11.12 Gor.
L-------------------------------------------------------------------------- */

class (RcbReportPrintController) F345ReportPrintCtrl()
    initRcbReportPrintController();

    var m_reportType : String = "";

    private macro getReportView() : RcbReportView
        if (m_reportView == null)
            m_reportView = objectFactoryInstance.createReportView(m_reportType);
        end;

        return m_reportView;
    end;

    private macro getDDMM(_date : Date) : string
        var dd, mm;
        var DDMMstring : String = "";

        DateSplit(_date, dd, mm, NULL);

        if (dd < 10)
           DDMMstring = "0" + String(dd);
        else
           DDMMstring = String(dd);
        end;
        if (mm < 10)
           DDMMstring = DDMMstring + "." + "0" + String(mm);
        else
           DDMMstring = DDMMstring + "." + String(mm);
        end;

        return DDMMstring;
    end;
end;

class (F345ReportPrintCtrl) F345ReportPrintController()
    initF345ReportPrintCtrl();

    m_reportWidth = 231;
    m_reportType = "MainReport";


    var spravString = RcbArray().initialize("До 100         (включительно)",
                                            "От 100 до 200  (включительно)",
                                            "От 200 до 400  (включительно)",
                                            "От 400 до 700  (включительно)",
                                            "От 700 до 1000 (включительно)",
                                            "Свыше 1000" );

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate + 1)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate + 1)
                    valuePool.initialize("На 1-е число квартала, следующего за отчетным кварталом");
                else
                    valuePool.initialize("На " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=19, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal = part.getAttribute("Sprav").getScaledValue(string(i));
                 view.printString(RcbArray.initialize(spravString(i-1), String(nvl(tableVal.cnt_account, 0)), String(nvl(tableVal.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

    private macro printDataZone()
        if (global.getPrintFlag("ОсновнойРаздел"))
            printPart("ОсновнойРаздел");
        else
            getReportView().printNullDataZone();
        end;

        if (global.getPrintFlag("Справочно"))
            println();
            println("Справочно");
            printPart("Справочно");
        else
            getReportView().printNullDataZone();
        end;
    end;
end;

class (F345ReportPrintController) F345ReportPrintController_3198()
    initF345ReportPrintController();

    m_reportWidth = 292;

    spravString = RcbArray().initialize("До 1           (включительно)",
                                        "От 1 до 10     (включительно)",
                                        "От 10 до 100   (включительно)",
                                        "От 100 до 400  (включительно)",
                                        "От 400 до 700  (включительно)",
                                        "От 700 до 1000 (включительно)",
                                        "Свыше 1000" );

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;
        var tableValGk;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate + 1)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate + 1)
                    valuePool.initialize("На 1-е число квартала, следующего за отчетным кварталом");
                else
                    valuePool.initialize("На " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=global.getPart1TotalsColumnNumber(), 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal   = part.getAttribute("Sprav").getScaledValue(string(i));
                 tableValGk = part.getAttribute("Sprav").getScaledValue(string(i) + "_ГК");
                 view.printString(RcbArray.initialize(spravString(i-1), String(nvl(tableVal.cnt_account, 0)), String(nvl(tableValGk.cnt_account, 0)),
                                                                        String(nvl(tableVal.value, 0):0:0),  String(nvl(tableValGk.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

end;

class (F345ReportPrintController_3198) F345ReportPrintController_3468()
    initF345ReportPrintController_3198();

    spravString = RcbArray().initialize("До 1           (включительно)",
                                        "От 1 до 10     (включительно)",
                                        "От 10 до 100   (включительно)",
                                        "От 100 до 400  (включительно)",
                                        "От 400 до 700  (включительно)",
                                        "От 700 до 1000 (включительно)",
                                        "От 1000 до 1500 (включительно)",
                                        "От 1500 до 3000 (включительно)",
                                        "От 3000 до 5000 (включительно)",
                                        "Свыше 5000" );

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;
        var tableValGk;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate + 1)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate + 1)
                    valuePool.initialize("На 1-е число квартала, следующего за отчетным кварталом");
                else
                    valuePool.initialize("На " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=global.getPart1TotalsColumnNumber(), 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal   = part.getAttribute("Sprav").getScaledValue(string(i));
                 tableValGk = part.getAttribute("Sprav").getScaledValue(string(i) + "_ГК");
                 view.printString(RcbArray.initialize(spravString(i-1), String(Int(nvl(tableVal.cnt_account, 0))), String(Int(nvl(tableValGk.cnt_account, 0))),
                                                                        String(nvl(tableVal.value, 0):0:0),  String(nvl(tableValGk.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

end;

class (F345ReportPrintController_3468) F345ReportPrintController_3564()
    initF345ReportPrintController_3468();

    spravString = RcbArray().initialize("До 1           (включительно)",
                                        "От 1 до 10     (включительно)",
                                        "От 10 до 100   (включительно)",
                                        "От 100 до 700  (включительно)",
                                        "От 700 до 1000 (включительно)",
                                        "От 1000 до 1400 (включительно)",
                                        "От 1400 до 3000 (включительно)",
                                        "От 3000 до 5000 (включительно)",
                                        "Свыше 5000" );
end;

class (F345ReportPrintController_3564) F345ReportPrintController_3875()
    initF345ReportPrintController_3564();

    spravString = RcbArray().initialize("До 1           (включительно)",
                                        "От 1 до 10     (включительно)",
                                        "От 10 до 100   (включительно)",
                                        "От 100 до 700  (включительно)",
                                        "От 700 до 1000 (включительно)",
                                        "От 1000 до 1400 (включительно)",
                                        "От 1400 до 3000 (включительно)",
                                        "От 3000 до 5000 (включительно)",
                                        "Свыше 5000" );

    var spravStringNumber = RcbArray().initialize("1", "2", "3", "4", "5", "6", "7", "8", "9");

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;
        var tableValGk;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate + 1)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate + 1)
                    valuePool.initialize("На 1-е число квартала, следующего за отчетным кварталом");
                else
                    valuePool.initialize("На " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=global.getPart1TotalsColumnNumber(), 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal   = part.getAttribute("Sprav").getScaledValue(string(i));
                 tableValGk = part.getAttribute("Sprav").getScaledValue(string(i) + "_ГК");
                 view.printString(RcbArray.initialize(spravStringNumber(i - 1), spravString(i-1), String(Int(nvl(tableVal.cnt_account, 0))), String(Int(nvl(tableValGk.cnt_account, 0))),
                                                      String(nvl(tableVal.value, 0):0:0),  String(nvl(tableValGk.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

end;

class (F345ReportPrintController_3875) F345ReportPrintController_4033()
    initF345ReportPrintController_3875();

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;
        var tableValGk;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate + 1)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate + 1)
                    valuePool.initialize("На 1-е число месяца, следующего за отчетным");
                else
                    valuePool.initialize("На " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=global.getPart1TotalsColumnNumber(), 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal   = part.getAttribute("Sprav").getScaledValue(string(i));
                 tableValGk = part.getAttribute("Sprav").getScaledValue(string(i) + "_ГК");
                 view.printString(RcbArray.initialize(spravStringNumber(i - 1), spravString(i-1), String(Int(nvl(tableVal.cnt_account, 0))), String(Int(nvl(tableValGk.cnt_account, 0))),
                                                      String(nvl(tableVal.value, 0):0:0),  String(nvl(tableValGk.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

end;

class (F345ReportPrintController_4033) F345ReportPrintController_4212()
    initF345ReportPrintController_4033();

    private macro printPart(partid : String)
        var part = m_report.getPart(partid);
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var value;
        var i=0; // счетчик граф для формирования строки отчета
        var tableVal;
        var tableValGk;

        view.printHead();

        if (partid == "ОсновнойРаздел")
            while (currentDay <= global.getRcbPeriod().endDate)
                var valuePool = RcbArray();

                if (currentDay == global.getRcbPeriod().endDate)
                    valuePool.initialize("За последний календарный день отчетного месяца");
                else
                    valuePool.initialize("За " + getDDMM(currentDay));
                end;
                //собираем строку из граф за дату currentDay
                for (i, i=2, i=global.getPart1TotalsColumnNumber(), 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    valuePool.initialize(String(value:0:0));
                end;

                view.printString(valuePool);
                currentDay = currentDay + 1;
            end;
        elif (partid == "Справочно")
            for (i, i = 1, i = spravString.size())
                 tableVal   = part.getAttribute("Sprav").getScaledValue(string(i));
                 tableValGk = part.getAttribute("Sprav").getScaledValue(string(i) + "_ГК");
                 view.printString(RcbArray.initialize(spravStringNumber(i - 1), spravString(i-1), String(Int(nvl(tableVal.cnt_account, 0))), String(Int(nvl(tableValGk.cnt_account, 0))),
                                                      String(nvl(tableVal.value, 0):0:0),  String(nvl(tableValGk.value, 0):0:0)));
            end;
        end;

        view.printBottom();
    end;

    macro print()
        checkReport();

        getReportView().setOutputFile();

        getReportView().setReportWidth(m_reportWidth);
        getReportView().printLendingAgencyCodeZone();
        getReportView().printNamesZone("Полное или сокращенное фирменное наименование кредитной организации ");

        if (getReport().isEmpty())
            getReportView().printNullDataZone();
        else
            printDataZone();
        end;
    end;
end;

class (F345ReportPrintCtrl) F345ReportPrintControllerIF()
    initF345ReportPrintCtrl();

    m_reportWidth = 120;
    m_reportType = "InsuranceFee";

    private macro printPart(partid : String)
        var view = getReportView().getPartView(partId);
        var currentDay : Date = global.getRcbPeriod().beginDate;
        var attributeValue_insFee = m_report.getPart(partid).getAttribute("InsuranceFee");
        var attributeValue_main = m_report.getPart("ОсновнойРаздел").getAttribute(string(global.getPart1TotalsColumnNumber())); // графа подсчитанных итогов
        var firstColumn : String = "";
        var secondColumn;
        var comment : String = "";

        view.printHead();

        while (currentDay <= global.getRcbPeriod().endDate + 1)
            firstColumn = "На " + getDDMM(currentDay);

            if ((currentDay == global.getRcbPeriod().beginDate) or (currentDay == global.getRcbPeriod().endDate + 1))
                secondColumn = attributeValue_main.getScaledValue(currentDay)/2;
            else
                secondColumn = attributeValue_main.getScaledValue(currentDay);
            end;

            if (not(global.isWorkDate(currentDay)))
                comment = "Нерабочий день";
            end;
            view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));
            currentDay = currentDay + 1;
        end;

        /*строка ИТОГО*/
        firstColumn = "ИТОГО сумма остатков за весь расчетный период";

        secondColumn = attributeValue_insFee.getScaledValue("1").value;
        comment = "";
        view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));

        view.printBottom();

        println();

        /*число календарных дней*/
        //ДООП+1
        view.printQuntDays(global.getRcbPeriod().daysQuantity + 2);

        println();

        /*расчетная база*/
        view.printCalcBase(String(attributeValue_insFee.getScaledValue("2").value:0:0));

        println();

        /*сумма страхового взноса*/
        view.printStVznos(attributeValue_insFee.getValue("3").value);

    end;

    private macro printDataZone()
        printPart("РасчетСтраховогоВзноса");
    end;
end;

class (F345ReportPrintControllerIF) F345ReportPrintControllerIF_4212()
    initF345ReportPrintControllerIF();

    m_reportWidth = 120;
    m_reportType = "InsuranceFee";

    private macro printPart(partid : String)
        var poolReport         : Object     = global.parameters.getPoolReportsQuarter();
        var endDay             : Date       = global.getRcbPeriod().endDate;
        var prevQuarter        : Date       = global.parameters.getEndDatePrevQuarter();
        var attributeValue_insFee           = m_report.getPart(partid).getAttribute("InsuranceFee");
        var attributeValue_main             = m_report.getPart("ОсновнойРаздел").getAttribute(string(global.getPart1TotalsColumnNumber()));
        var view                            = getReportView().getPartView(partId);
        var attribute_Quarter : numeric     = $0.0;
        var comment           : String      = "";
        var firstColumn       : String      = "";
        var currentDay        : Date;
        var secondColumn;
        var period = RcbPeriod(global.parameters.getBeginDateQuarter(), global.getRcbPeriod().endDate);

        view.printHead();

        firstColumn = "За " + prevQuarter;

        secondColumn = global.parameters.getTotalPrevQuarter().scaled /$2;
        view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));

        For (var report, poolReport)
            currentDay = report.context.period.beginDate;
            while (currentDay <= report.context.period.endDate)
                firstColumn = "За " + currentDay;
                    secondColumn = global.parameters.getValueQuarterScaled(currentDay, report);
                    if (not(global.isWorkDate(currentDay)))
                        comment = "Нерабочий день";
                    else
                        comment = "";
                    end;

                    view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));
                    currentDay = currentDay + 1;
            end;
        end;

        currentDay = global.getRcbPeriod().beginDate;
        while (currentDay <= global.getRcbPeriod().endDate)
            firstColumn = "За " + currentDay;
            if (currentDay == global.getRcbPeriod().endDate)
               secondColumn = attributeValue_main.getScaledValue(currentDay)/2;
            else
                secondColumn = attributeValue_main.getScaledValue(currentDay);
            end;

            if (not(global.isWorkDate(currentDay)))
                comment = "Нерабочий день";
            else
                comment = "";
            end;

            view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));
            currentDay = currentDay + 1;
        end;

        /*строка ИТОГО*/
        firstColumn = "ИТОГО сумма остатков за весь расчетный период";

        secondColumn = attributeValue_insFee.getScaledValue("1").value;
        comment = "";
        view.printString(RcbArray().initialize(firstColumn, String(secondColumn:0:0), comment));

        view.printBottom();

        println();

        /*число календарных дней*/
        //ДООП+1
        view.printQuntDays(period.daysQuantity + 2);

        println();

        /*расчетная база*/
        view.printCalcBase(String(attributeValue_insFee.getScaledValue("2").value:0:0));

        println();

        /*сумма страхового взноса*/
        view.printStVznos(attributeValue_insFee.getValue("3").value);

    end;

    private macro printDataZone()
        printPart("РасчетСтраховогоВзноса");
    end;
end;
