/*
 $Name:        F345PtkPsdExportController.mac
 $Module:      ¥£« ¬¥­â¨àã¥¬ ï ®âç¥â­®áâì
 $Description: Š« áá ª®­âà®««¥à  íªá¯®àâ  ¢ €‘ ‘„
*/
/* ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   RS-Bank V6                                                 R-Style Softlab
   ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨à®¢ ­­ ï ®âç¥â­®áâì"

   ”®à¬  345. Š®­âà®««¥à íªá¯®àâ  ¢ €‘ ‘„.

   CREATED : 21.11.12 Gor.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ */
class F345PtkPsdExportController()

    private var m_report = objectFactoryInstance.createReport(RcbApplication.currentReport);

    private var m_reportName = m_report.getRcbReport().form.id;

    private var m_view = TPtkPsdView("345", m_report.getPeriod().endDate+1);

    private macro getDescriptorInfo()
        if (m_report.getRcbReport().context.period.endDate >= PTKPSD_0409345_OSBR.getBeginDate())
            return PTKPSD_0409345_OSBR.getAlbumVersion();
        elif (m_report.getRcbReport().context.period.endDate >= PTKPSD_2_2_4.getBeginDate())
            return PTKPSD_2_2_4.getAlbumVersion();
        else
            return "";
        end;
    end;

    private macro dateDecor(_date : Date, order : String) : String
        var dd, mm, yy, sdd, smm;

        DateSplit(_date, dd, mm, yy);

        if (mm < 10)
           smm = "0" + String(mm);
        else
           smm = String(mm);
        end;

        if (dd < 10)
           sdd = "0" + String(dd);
        else
           sdd = String(dd);
        end;

        if (order == "dmy")
            return sdd + "." + smm + "." + String(yy);
        else
            return String(yy) + smm + sdd;
        end;
    end;

    private macro printString(partCode : String, lineCode : String, rowNumber : String, value : String)
        m_view.printRow(partCode, lineCode, rowNumber, value);
    end;

    private macro printDataPart(partCode)
        var part;
        var i;
        var value, value_ind;
        var currentDay : Date = global.getRcbPeriod().beginDate;

        if (partCode == "F345_1")
            part = m_report.getPart("Žá­®¢­®© §¤¥«");

            while (currentDay <= global.getRcbPeriod().endDate + 1)

                printString(partCode, dateDecor(currentDay), "1", dateDecor(currentDay,"dmy"));

                for (i, i=2, i=24, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    printString(partCode, dateDecor(currentDay), String(i), String(Int(value)));
                end;

                currentDay = currentDay + 1;
            end;
        elif (partCode == "F345_SPR")
            part = m_report.getPart("‘¯à ¢®ç­®");

            for (i, i=1, i=7, 1)
                value     = part.getAttribute("Sprav").getScaledValue(string(i));
                value_ind = part.getAttribute("Sprav").getScaledValue(string(i) + "_ƒŠ");

                printString(partCode, "str" + String(i), "2", String(Int(nvl(value.cnt_account, 0))));
                printString(partCode, "str" + String(i), "3", String(Int(nvl(value_ind.cnt_account, 0))));
                printString(partCode, "str" + String(i), "4", String(Int(nvl(value.value, 0))));
                printString(partCode, "str" + String(i), "5", String(Int(nvl(value_ind.value, 0))));
            end;

        end;

    end;

    private macro printDataZone()
        m_view.setOutputFile();
        printDataPart("F345_1");
        printDataPart("F345_SPR");
        m_view.resetOutputFile();
    end;

    macro execute()
        m_view.setoutputFile();

        printDataZone();

        m_view.resetoutputFile();

        var protocolView = TProtocolView("Ž’ŽŠŽ‹ Š‘Ž’€ ‚ €‘ ‘„", m_reportName);

        protocolView.setProtocolOutput();
        protocolView.printHead();

        protocolView.printLine("€«ì¡®¬ ä®à¬ €‘ ‘„: " + getDescriptorInfo());
        protocolView.printLine("” ©« íªá¯®àâ : " + m_view.getFileName());
        protocolView.printLine(" ");

        protocolView.printLine("Š®«¨ç¥áâ¢® ¢ë£àã¦¥­­ëå áâà®ª: " + String( m_view.getRowsCount()) + ".");

        protocolView.resetProtocolOutput();

        protocolView.show();
    end;
end;

class (F345PtkPsdExportController) F345PtkPsdExportController_3468()
    initF345PtkPsdExportController();

    private macro printDataPart(partCode)
        var part;
        var i;
        var value, value_ind;
        var currentDay : Date = global.getRcbPeriod().beginDate;

        if (partCode == "F345_1")
            part = m_report.getPart("Žá­®¢­®© §¤¥«");

            while (currentDay <= global.getRcbPeriod().endDate + 1)

                printString(partCode, dateDecor(currentDay), "1", dateDecor(currentDay,"dmy"));

                for (i, i=2, i=24, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    printString(partCode, dateDecor(currentDay), String(i), String(Int(value)));
                end;

                currentDay = currentDay + 1;
            end;
        elif (partCode == "F345_SPR")
            part = m_report.getPart("‘¯à ¢®ç­®");

            for (i, i=1, i=10, 1)
                value     = part.getAttribute("Sprav").getScaledValue(string(i));
                value_ind = part.getAttribute("Sprav").getScaledValue(string(i) + "_ƒŠ");

                printString(partCode, "str" + String(i), "2", String(Int(nvl(value.cnt_account, 0))));
                printString(partCode, "str" + String(i), "3", String(Int(nvl(value_ind.cnt_account, 0))));
                printString(partCode, "str" + String(i), "4", String(Int(nvl(value.value, 0))));
                printString(partCode, "str" + String(i), "5", String(Int(nvl(value_ind.value, 0))));
            end;

        end;

    end;
end;
class (F345PtkPsdExportController) F345PtkPsdExportController_3564()
    initF345PtkPsdExportController();

    private macro printDataPart(partCode)
        var part;
        var i;
        var value, value_ind;
        var currentDay : Date = global.getRcbPeriod().beginDate;

        if (partCode == "F345_1")
            part = m_report.getPart("Žá­®¢­®© §¤¥«");

            while (currentDay <= global.getRcbPeriod().endDate + 1)

                printString(partCode, dateDecor(currentDay), "1", dateDecor(currentDay,"dmy"));

                for (i, i=2, i=24, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    printString(partCode, dateDecor(currentDay), String(i), String(Int(value)));
                end;

                currentDay = currentDay + 1;
            end;
        elif (partCode == "F345_SPR")
            part = m_report.getPart("‘¯à ¢®ç­®");

            for (i, i=1, i=9, 1)
                value     = part.getAttribute("Sprav").getScaledValue(string(i));
                value_ind = part.getAttribute("Sprav").getScaledValue(string(i) + "_ƒŠ");

                printString(partCode, "str" + String(i), "2", String(Int(nvl(value.cnt_account, 0))));
                printString(partCode, "str" + String(i), "3", String(Int(nvl(value_ind.cnt_account, 0))));
                printString(partCode, "str" + String(i), "4", String(Int(nvl(value.value, 0))));
                printString(partCode, "str" + String(i), "5", String(Int(nvl(value_ind.value, 0))));
            end;

        end;

    end;
end;

class (F345PtkPsdExportController) F345PtkPsdExportController_3875()
    initF345PtkPsdExportController();

    private macro printDataPart(partCode)
        var part;
        var i;
        var value, value_ind;
        var currentDay : Date = global.getRcbPeriod().beginDate;

        if (partCode == "F345_1")
            part = m_report.getPart("Žá­®¢­®© §¤¥«");

            while (currentDay <= global.getRcbPeriod().endDate + 1)

                printString(partCode, dateDecor(currentDay), "1", dateDecor(currentDay,"dmy"));

                for (i, i=2, i=27, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    printString(partCode, dateDecor(currentDay), String(i), String(Int(value)));
                end;

                currentDay = currentDay + 1;
            end;
        elif (partCode == "F345_SPR")
            part = m_report.getPart("‘¯à ¢®ç­®");

            for (i, i=1, i=9, 1)
                value     = part.getAttribute("Sprav").getScaledValue(string(i));
                value_ind = part.getAttribute("Sprav").getScaledValue(string(i) + "_ƒŠ");

                printString(partCode, "str" + String(i), "2", String(Int(nvl(value.cnt_account, 0))));
                printString(partCode, "str" + String(i), "3", String(Int(nvl(value_ind.cnt_account, 0))));
                printString(partCode, "str" + String(i), "4", String(Int(nvl(value.value, 0))));
                printString(partCode, "str" + String(i), "5", String(Int(nvl(value_ind.value, 0))));
            end;

        end;

    end;
end;

class (F345PtkPsdExportController) F345PtkPsdExportController_4212()
    initF345PtkPsdExportController();

    private macro printDataPart(partCode)
        var part;
        var i;
        var value, value_ind;
        var currentDay : Date = global.getRcbPeriod().beginDate;

        if (partCode == "F345_1")
            part = m_report.getPart("Žá­®¢­®© §¤¥«");

            while (currentDay <= global.getRcbPeriod().endDate)

                printString(partCode, dateDecor(currentDay), "1", dateDecor(currentDay,"dmy"));

                for (i, i=2, i=27, 1)
                    value = nvl(part.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);
                    printString(partCode, dateDecor(currentDay), String(i), String(Int(value)));
                end;

                currentDay = currentDay + 1;
            end;
        elif (partCode == "F345_SPR")
            part = m_report.getPart("‘¯à ¢®ç­®");

            for (i, i=1, i=9, 1)
                value     = part.getAttribute("Sprav").getScaledValue(string(i));
                value_ind = part.getAttribute("Sprav").getScaledValue(string(i) + "_ƒŠ");

                printString(partCode, "str" + String(i), "2", String(Int(nvl(value.cnt_account, 0))));
                printString(partCode, "str" + String(i), "3", String(Int(nvl(value_ind.cnt_account, 0))));
                printString(partCode, "str" + String(i), "4", String(Int(nvl(value.value, 0))));
                printString(partCode, "str" + String(i), "5", String(Int(nvl(value_ind.value, 0))));
            end;

        end;

    end;
end;
