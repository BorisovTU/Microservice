/*
 $Name:        F345RecalculateAfterSummation.mac
 $Module:      Регламентируемая отчетность
 $Description: Процедура пересчета после сведения
*/
/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 345. Пересчет после свода.

   CREATED : 07.02.14 Kirin Pavel.
             10.08.2016 ABP Полностью поменял реализацию по запросу 238882.
└────────────────────────────────────────────────────────────────────────── */
/**
 * Форма 345. Пересчет после свода.
 *
 *
 * @since   04.07.2013
 * @author  Kirin Pavel
 * @version 6.00.020.31
*!!!!!! Если удастся сменить значение поля "countAccount" структурной переменной "Данные отчета" со строкового на действительный,
*!!!!!! то можно удалить этот файл вместе с операцией "Пересчет после свода"
 */
import F345import;

private macro recalculateAfterSummation()
    var spravAttribute = objectFactoryInstance.createReport(RcbApplication().currentReport).getPart("Справочно").getAttribute("Sprav");

    var it;
    var summatorAttributes = RcbArray();
    for (it, RcbApplication().summator.getSummarizedReportsList(RcbApplication().currentReport))
        summatorAttributes.push_back(objectFactoryInstance.createReport(it).getPart("Справочно").getAttribute("Sprav"));
    end;

    var sumAccountCount = 0;
    for (var value, spravAttribute.getValueIterator())
        value.cnt_account = 0;
        for (it, summatorAttributes)
            value.cnt_account = value.cnt_account + int(it.getValue(value.id).cnt_account);
        end;

        spravAttribute.setCountAccountValue(value.id, value.cnt_account);
    end;

    RcbApplication.TransactionManager.commit();

    exit(1);
end;
