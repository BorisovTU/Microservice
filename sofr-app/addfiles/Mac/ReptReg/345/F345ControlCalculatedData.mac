/*
$Name:        F345ControlCalculatedData.mac
$Module:      Регламентируемая отчетность
$Description: Класс для выполнения межформенного контроля с формой "Балансовые счета"
*/
/*
Межформенный контроль с печатью протокола
*/

class F345ControlCalculatedData()

    private var m_report : Object = objectFactoryInstance.createReport(RcbApplication.currentReport);
    private var part1  = m_report.getPart("ОсновнойРаздел");

    private var m_protocol = F345ControlProtocolView();
    private var errorNumber      = 0;

    private var erSymbol = "!";
    private var checkObjectBalance = "Б/сч. ";

    private var dataArray : RcbArray;

    macro controlCalculatedFormReport()

        if (m_report.isEmpty)
            var errorMesssage = "Контроль с балансом не возможен: форма 0409345 за отчетный период не рассчитана. ";
            m_protocol.printErrorLine(errorMesssage);
            m_protocol.resetProtocolOutput();
            m_protocol.show();
            установитьФлагВозврата(STOP_PROC_FLG);

            exit(1);

            return false;
        end;

        return true;
    end;

    macro controlCalculatedBalanceReports()
        var i = 0;
        var arMessage : TArray = global.getBalanceData().isCalculatedForControl();
        if (arMessage != 0)
            //собираем для протокола список балансовых, по которым контроль не возможен
           while(i < arMessage.size)
               m_protocol.printErrorLine(arMessage[i]);
               i = i+1;
           end;
           m_protocol.printErrorLine("\n");
        end;
    end;

    macro checkFormValues()
        var formValue, formValueEx, currentBalanceReport, sumBalance, sumBalanceEx, sBalance, i;
        var eMessage = "";
        var curSymbol = "";

        var currentDay = global.getRcbPeriod().beginDate;

        var balanceAttribute;

        while(currentDay <= global.getRcbPeriod().endDate + 1)
            currentBalanceReport = global.getBalanceData().getBalanceReport(currentDay);
            if ((currentBalanceReport != null) and (currentBalanceReport.isCalculated))

                for (i, global.getBalanceListFirstNumber(), global.getBalanceListSize(), 1)
                    eMessage = " ";
                    curSymbol = " ";

                    sBalance = global.getBalanceAsString(String(i));
                    formValueEx = nvl(part1.getAttribute(string(i)).getValue(Date(currentDay)), 0);
                    formValue = nvl(part1.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);

                    balanceAttribute = TBalanceAttribute("БАЛАНС",  currentBalanceReport);

                    balanceAttribute.getBalanceAttribute(1, sBalance, false);

                    sumBalance = balanceAttribute.getOutRestNatCurPassive().scaled + balanceAttribute.getOutRestCurPassive().scaled;
                    sumBalanceEx = balanceAttribute.getOutRestNatCurPassive().exact + balanceAttribute.getOutRestCurPassive().exact;

                    if (formValue > sumBalance)
                        eMessage = "\nОшибка. Расхождение данных ф.0409345 с балансом по б/с " + sBalance + "\n";
                        curSymbol = erSymbol;
                        errorNumber = errorNumber + 1;
                    end;
                    dataArray = NULL;
                    m_protocol.printLineTable(dataArray.Initialize(curSymbol,
                                                                   currentDay,
                                                                   checkObjectBalance + sBalance,
                                                                   formValueEx,
                                                                   sumBalanceEx,
                                                                   formValueEx-sumBalanceEx,
                                                                   formValue,
                                                                   sumBalance,
                                                                   formValue-sumBalance,
                                                                   eMessage ));
                end;
            end;

            currentDay = currentDay + 1;
        end;
    end;

    macro partSpravItogoControl()
        var spravSumValue = 0;
        var spravSumValueEx = 0;
        var eMessage = " ";
        var curSymbol = " ";
        var dualvalue, i;
        var spravAttribute  = m_report.getPart("Справочно").getAttribute("Sprav");
        var itogoValue  = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getScaledValue(global.getRcbPeriod().endDate + 1),0);
        var itogoValueEx  = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getValue(global.getRcbPeriod().endDate + 1),0);

        for (i, i=1, i=global.getSpravPartLineCount(), 1)
            dualvalue = spravAttribute.getScaledValue(String(i));
            spravSumValue = spravSumValue + nvl(dualValue.value,0);
            dualvalue = spravAttribute.getValue(String(i));
            spravSumValueEx = spravSumValueEx + nvl(dualValue.value,0);
        end;

        if ((spravSumValue < itogoValue - 9) or (spravSumValue > itogoValue + 9))
           eMessage = "Ошибка. Расхождение итогового значения с данными раздела Справочно";
           curSymbol = erSymbol;
           errorNumber = errorNumber + 1;
        end;
        dataArray = NULL;
        m_protocol.printLineTable(dataArray.Initialize(curSymbol,
                                                       global.getRcbPeriod().endDate + 1,
                                                       "Итого обязательств",
                                                       itogoValueEx,
                                                       spravSumValueEx,
                                                       spravSumValueEx-itogoValueEx,
                                                       itogoValue,
                                                       spravSumValue,
                                                       spravSumValue-itogoValue,
                                                       eMessage ));
    end;

    macro printData()
        checkFormValues();
        m_protocol.printEmptyLine();
        partSpravItogoControl();
    end;

    macro execute()
        m_protocol.setProtocolOutput();
        m_protocol.printHead();

        if (controlCalculatedFormReport())
            m_protocol.printTableHead();
            controlCalculatedBalanceReports();
            printData();
            m_protocol.printTableBottom();
            m_protocol.printBottom(errorNumber);
        end;

        m_protocol.resetProtocolOutput();
    end;
end;

class (F345ControlCalculatedData) F345ControlCalculatedData_3468()
    initF345ControlCalculatedData();

    macro partSpravItogoControl()
        var spravSumValue   = 0;
        var spravSumValueEx = 0;
        var eMessage        = " ";
        var curSymbol       = " ";
        var dualvalue, i;
        var spravAttribute  = m_report.getPart("Справочно").getAttribute("Sprav");
        var itogoValue      = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getScaledValue(global.getRcbPeriod().endDate + 1), 0);
        var itogoValueEx    = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getValue(global.getRcbPeriod().endDate + 1), 0);

        for (i, i = 1, i = global.getSpravPartLineCount(), 1)
            dualvalue       = spravAttribute.getScaledValue(String(i));
            spravSumValue   = spravSumValue + nvl(dualValue.value,0);
            dualvalue       = spravAttribute.getValue(String(i));
            spravSumValueEx = spravSumValueEx + nvl(dualValue.value,0);
        end;

        if ((spravSumValue < itogoValue - 13) or (spravSumValue > itogoValue + 13))
            eMessage    = "Ошибка. Расхождение итогового значения с данными раздела Справочно";
            curSymbol   = erSymbol;
            errorNumber = errorNumber + 1;
        end;
        dataArray = NULL;
        m_protocol.printLineTable(dataArray.Initialize(curSymbol,
                                                       global.getRcbPeriod().endDate + 1,
                                                       "Итого обязательств",
                                                       itogoValueEx,
                                                       spravSumValueEx,
                                                       spravSumValueEx-itogoValueEx,
                                                       itogoValue,
                                                       spravSumValue,
                                                       spravSumValue-itogoValue,
                                                       eMessage ));
    end;
end;

class (F345ControlCalculatedData) F345ControlCalculatedData_4212()
    initF345ControlCalculatedData();

    macro checkFormValues()
        var formValue, formValueEx, currentBalanceReport, sumBalance, sumBalanceEx, sBalance, i;
        var eMessage = "";
        var curSymbol = "";

        var currentDay = global.getRcbPeriod().beginDate;

        var balanceAttribute;

        while(currentDay <= global.getRcbPeriod().endDate)
            currentBalanceReport = global.getBalanceData().getBalanceReport(currentDay);
            if ((currentBalanceReport != null) and (currentBalanceReport.isCalculated()))

                for (i, global.getBalanceListFirstNumber(), global.getBalanceListSize(), 1)
                    eMessage = " ";
                    curSymbol = " ";

                    sBalance = global.getBalanceAsString(String(i));
                    formValueEx = nvl(part1.getAttribute(string(i)).getValue(Date(currentDay)), 0);
                    formValue = nvl(part1.getAttribute(string(i)).getScaledValue(Date(currentDay)), 0);

                    balanceAttribute = TBalanceAttribute("БАЛАНС",  currentBalanceReport);

                    balanceAttribute.getBalanceAttribute(1, sBalance, false);

                    sumBalance = balanceAttribute.getOutRestNatCurPassive().scaled + balanceAttribute.getOutRestCurPassive().scaled;
                    sumBalanceEx = balanceAttribute.getOutRestNatCurPassive().exact + balanceAttribute.getOutRestCurPassive().exact;

                    if (formValue > sumBalance)
                        eMessage = "\nОшибка. Расхождение данных ф.0409345 с балансом по б/с " + sBalance + "\n";
                        curSymbol = erSymbol;
                        errorNumber = errorNumber + 1;
                    end;
                    dataArray = NULL;
                    m_protocol.printLineTable(dataArray.Initialize(curSymbol,
                                                                   currentDay,
                                                                   checkObjectBalance + sBalance,
                                                                   formValueEx,
                                                                   sumBalanceEx,
                                                                   formValueEx-sumBalanceEx,
                                                                   formValue,
                                                                   sumBalance,
                                                                   formValue-sumBalance,
                                                                   eMessage ));
                end;
            end;

            currentDay = currentDay + 1;
        end;
    end;

    macro partSpravItogoControl()
        var spravSumValue   = 0;
        var spravSumValueEx = 0;
        var eMessage        = " ";
        var curSymbol       = " ";
        var dualvalue, i;
        var spravAttribute  = m_report.getPart("Справочно").getAttribute("Sprav");
        var itogoValue      = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getScaledValue(global.getRcbPeriod().endDate), 0);
        var itogoValueEx    = nvl(part1.getAttribute(string(global.getPart1TotalsColumnNumber())).getValue(global.getRcbPeriod().endDate), 0);

        for (i, i = 1, i = global.getSpravPartLineCount(), 1)
            dualvalue       = spravAttribute.getScaledValue(String(i));
            spravSumValue   = spravSumValue + nvl(dualValue.value,0);
            dualvalue       = spravAttribute.getValue(String(i));
            spravSumValueEx = spravSumValueEx + nvl(dualValue.value,0);
        end;

        if ((spravSumValue < itogoValue - 13) or (spravSumValue > itogoValue + 13))
            eMessage    = "Ошибка. Расхождение итогового значения с данными раздела Справочно";
            curSymbol   = erSymbol;
            errorNumber = errorNumber + 1;
        end;
        dataArray = NULL;
        m_protocol.printLineTable(dataArray.Initialize(curSymbol,
                                                       global.getRcbPeriod().endDate,
                                                       "Итого обязательств",
                                                       itogoValueEx,
                                                       spravSumValueEx,
                                                       spravSumValueEx-itogoValueEx,
                                                       itogoValue,
                                                       spravSumValue,
                                                       spravSumValue-itogoValue,
                                                       eMessage ));
    end;
end;
