/*
 $Name:        F345Interface.mac
 $Module:      Регламентируемая отчетность
 $Description: Форма 345. Интерфейс доступа к операциям формы.
*/
/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 345. Доступ к операциям формы.

   CREATED : 27.10.12 Gor.
└────────────────────────────────────────────────────────────────────────── */
import F345Import;

/**
 *  Запуск операции расчета отчета
 */
macro executeCalculationOperation()
    var profiler = TSQLProfiler(getTxtFileName("!F345CalculateProfile"));
    profiler.clear();
    profiler.on();

    if ((NOT global().getBalanceDataRegistry()) OR (global().getBalanceData().checkBalance()))
        objectFactoryInstance.createReportCalculateController().calculate();
    else
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;
end;

/**
 *  Запуск операции печати отчета
 */    
macro executePrintOperation()
    objectFactoryInstance.createReportPrintController("MainReport").print();
    RcbApplication.TransactionManager.rollBack();
end;   

/**
 *  Запуск операции печати отчета по страховым взносам
 */    
macro executePrintOperationIF()
    private var m_protocol = F345ControlProtocolView();
  
    m_protocol.setProtocolOutput();
    m_protocol.printHead();
    if (global.parameters.getErrorsReport() == "")
        objectFactoryInstance.createReportPrintController("InsuranceFee").print();
        RcbApplication.TransactionManager.rollBack();
    else
        m_protocol.printErrorLine(global.parameters.getErrorsReport());
        m_protocol.resetProtocolOutput();
        m_protocol.show();
    end;
end;

/**
 *  Запуск операции экспорта в Kliko.exe
 */
macro executeKlikoExportOperation()
    objectFactoryInstance.createKlikoExportController().execute();
    RcbApplication.TransactionManager.rollBack();
end;          

/**
 *  Запуск операции экспорта в ПТК ПСД
 */
macro executePtkPsdExportOperation()
    var m_protocolView  = TProtocolView("ПРОТОКОЛ ЭКСПОРТА В АС ПСД");

    if (not rcbApplication().currentReport.isCalculated)
        m_protocolView.checkCalculateReport("АС ПСД");
        установитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
    end;

    objectFactoryInstance.createPtkPsdExportController().execute();
    RcbApplication.TransactionManager.rollBack();
end;         

/**
 *  Запуск операции контроля
 */
macro executeControlOperation()
    objectFactoryInstance.createControlCalculatedData().execute();
    RcbApplication.TransactionManager.rollBack();
end;         

/**
 *  Запуск операции расчета итогов
 */
macro executeSummarizeCalculateOperation()
    objectFactoryInstance.createReportSummarizeCalculationOperation().calculate();
    RcbApplication.TransactionManager.rollBack();
end;

установитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
