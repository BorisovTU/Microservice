/*
$Name:        F345Global.mac
$Module:      Регламентируемая отчетность
$Description: Глобализмы формы 345
*/
/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 345. Класс глобализмов.

   CREATED : 20.09.12 Gor.
└────────────────────────────────────────────────────────────────────────── */
class (TGlobalBase) F345Global()
    initTGlobalBase();

    private var m_rcbReport                  = rcbApplication.currentReport;
    private var m_rcbPeriod                  = m_rcbReport.context.period;
    private var m_isCalendarWeekends         = null;
    private var m_balanceDataRegistry        = null;
    private var m_rateOfCurrencyRegistry     = null;
    private var m_rateOfInsuranceFeeRegistry = null;
    private var m_balanceData : Object       = null;
    private var m_balanceList                = TArray();
    private var m_part1TotalsColumnNumber    = 19;
    private var m_spavPartLineCount          = 6;
    private var m_equivalentCalculatingAlgorithm = 1;
    private var m_isLastWorkdayRateUsed      = false;
    private var m_errorsMessage              = TArray();
    var m_printMainPart                      = false;
    var m_printSpravPart                     = false;
    var parameters                           = objectFactoryInstance.createParameters();

    macro getRcbReport() : RcbReport
        return m_rcbReport;
    end;

    macro getPrintFlag(partId : string) : bool
        if (partId == "Справочно")
            return m_printSpravPart;
        elif(partId == "ОсновнойРаздел")
            return m_printMainPart;
        end;
    end;

    macro setPrintFlag(partId : string)
        if (partId == "Справочно")
            m_printSpravPart = true;
        elif(partId == "ОсновнойРаздел")
            m_printMainPart  = true;
        else
            m_printMainPart  = false;
            m_printSpravPart = false;
        end;
    end;

    macro getRcbPeriod() : RcbPeriod
        return m_rcbPeriod;
    end;

    macro isReportPeriodMonth()
        return (m_rcbPeriod.kind == RCB_PK_MONTH);
    end;

    macro getBalanceData() : Object
        return m_balanceData;
    end;

    macro setBalanceData(balanceData : Object)
        m_balanceData = balanceData;
    end;

    macro getPart1TotalsColumnNumber()
        return m_part1TotalsColumnNumber;
    end;

    macro getSpravPartLineCount()
        return m_spavPartLineCount;
    end;

    macro initializeBalanceList()
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();
        m_balanceList[m_balanceList.size] = TArray();

        m_balanceList[0][0]  = "2";   m_balanceList[0][1] = "40803";
        m_balanceList[1][0]  = "3";   m_balanceList[1][1] = "40806";
        m_balanceList[2][0]  = "4";   m_balanceList[2][1] = "40809";
        m_balanceList[3][0]  = "5";   m_balanceList[3][1] = "40812";
        m_balanceList[4][0]  = "6";   m_balanceList[4][1] = "40813";
        m_balanceList[5][0]  = "7";   m_balanceList[5][1] = "40814";
        m_balanceList[6][0]  = "8";   m_balanceList[6][1] = "40815";
        m_balanceList[7][0]  = "9";   m_balanceList[7][1] = "40817";
        m_balanceList[8][0]  = "10";  m_balanceList[8][1] = "40818";
        m_balanceList[9][0]  = "11";  m_balanceList[9][1] = "40819";
        m_balanceList[10][0] = "12";  m_balanceList[10][1] = "40820";
        m_balanceList[11][0] = "13";  m_balanceList[11][1] = "423";
        m_balanceList[12][0] = "14";  m_balanceList[12][1] = "426";
        m_balanceList[13][0] = "15";  m_balanceList[13][1] = "47603";
        m_balanceList[14][0] = "16";  m_balanceList[14][1] = "47605";
        m_balanceList[15][0] = "17";  m_balanceList[15][1] = "522";
        m_balanceList[16][0] = "18";  m_balanceList[16][1] = "52404";
    end;

    macro getBalanceListSize()
        if (m_balanceList.size <= 0)
            initializeBalanceList();
        end;

        return m_balanceList.size;
    end;

    macro getBalanceListFirstNumber()
        if (m_balanceList.size <= 0)
            initializeBalanceList();
        end;

        if (m_balanceList.size != 0)
            return m_balanceList[0][0];
        else
            return -1;
        end;
    end;

    macro getBalanceAsString(columnId: String) : String

        if (m_balanceList.size <= 0)
            initializeBalanceList();
        end;

        var n = 0;
        while(n < m_balanceList.size)
           if (m_balanceList[n][0] == columnId)
               return m_balanceList[n][1];
           end;
           n = n+1;
        end;
    end;

    macro getBalanceDataRegistry() : Bool
        if (m_balanceDataRegistry == null)
            getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 345/ДАННЫЕ БАЛАНСА", V_BOOL, m_balanceDataRegistry, NULL);

            if (m_balanceDataRegistry == null)
                m_balanceDataRegistry = true;
            end;
        end;

        return m_balanceDataRegistry;
    end;

    macro getRateOfCurrencyRegistry() : Bool
        if (m_rateOfCurrencyRegistry == null)
            getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 345/ВАЛЮТА ПО КУРСУ", V_BOOL, m_rateOfCurrencyRegistry, NULL);

            if (m_rateOfCurrencyRegistry == null)
                m_rateOfCurrencyRegistry = true;
            end;
        end;

        return m_rateOfCurrencyRegistry;
    end;

    macro isCalendarWeekends() : Bool
        if (m_isCalendarWeekends == null)
            getRegistryValue("REPTREG/REP_GROUPS/ФОР/ВЫХОДН. И РАБ. ДНИ ПО КАЛЕНДАРЮ", V_BOOL, m_isCalendarWeekends, NULL);

            if (m_isCalendarWeekends == null)
                m_isCalendarWeekends = true;
            end;
        end;

        return m_isCalendarWeekends;
    end;

    macro getRateOfInsuranceFeeRegistry() : double
        if (m_rateOfInsuranceFeeRegistry == null)
            getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 345/СТАВКА СТРАХОВОГО ВЗНОСА", V_DOUBLE, m_rateOfInsuranceFeeRegistry, NULL);

            if (m_rateOfInsuranceFeeRegistry == null)
                m_rateOfInsuranceFeeRegistry = 0.1000;
            end;
        end;

        return m_rateOfInsuranceFeeRegistry;
    end;

    macro getEquivalentCalculatingAlgorithm() : Integer
        if (m_equivalentCalculatingAlgorithm == null)
            getRegistryValue("REPTREG/REP_GROUPS/ФОР/ВЫХОДНОЙ НА 1-Е ЧИСЛО", V_INTEGER, m_equivalentCalculatingAlgorithm, NULL);

            if (m_equivalentCalculatingAlgorithm == null)
                m_equivalentCalculatingAlgorithm = 1;
            end;
        end;

        return m_equivalentCalculatingAlgorithm;
    end;

    macro isLastWorkdayRateUsed() : Bool
        if (m_isLastWorkdayRateUsed == null)
            getRegistryValue("REPTREG/REP_GROUPS/345/КУРС_ВЫХ_ОКОНЧ_ОП_ЗА_ПРЕД.РАБ.Д", V_BOOL, m_isLastWorkdayRateUsed, NULL);

            if (m_isLastWorkdayRateUsed == null)
                m_isLastWorkdayRateUsed = false;
            end;
        end;

        return m_isLastWorkdayRateUsed;
    end;

    macro isWorkDate(day : Date) : Bool
        var serviceKind;
        var isBalance = false;
        var res;

        if (isCalendarWeekends())
            return (isWorkDay(day) == 1);
        else
            res = getDateAttr(day, serviceKind, isBalance, m_rcbReport.context.departmentCode);
            return isBalance;
        end;
    end;

    initializeRepDataPackage(m_rcbReport);
end;

class (F345Global) F345Global_3198()
    initF345Global();

    m_part1TotalsColumnNumber = 24;
    m_spavPartLineCount       = 7;

    macro makeArray(value1 : String, value2 : String)
        var tmpArray = TArray();

        tmpArray[0] = value1;
        tmpArray[1] = value2;

        return tmpArray;
    end;

    macro initializeBalanceList()
        m_balanceList[m_balanceList.size] = makeArray("2",  "40802");
        m_balanceList[m_balanceList.size] = makeArray("3",  "40803");
        m_balanceList[m_balanceList.size] = makeArray("4",  "40804");
        m_balanceList[m_balanceList.size] = makeArray("5",  "40805");
        m_balanceList[m_balanceList.size] = makeArray("6",  "40806");
        m_balanceList[m_balanceList.size] = makeArray("7",  "40809");
        m_balanceList[m_balanceList.size] = makeArray("8",  "40812");
        m_balanceList[m_balanceList.size] = makeArray("9",  "40813");
        m_balanceList[m_balanceList.size] = makeArray("10", "40814");
        m_balanceList[m_balanceList.size] = makeArray("11", "40815");
        m_balanceList[m_balanceList.size] = makeArray("12", "40817");
        m_balanceList[m_balanceList.size] = makeArray("13", "40818");
        m_balanceList[m_balanceList.size] = makeArray("14", "40819");
        m_balanceList[m_balanceList.size] = makeArray("15", "40820");
        m_balanceList[m_balanceList.size] = makeArray("16", "40821");
        m_balanceList[m_balanceList.size] = makeArray("17", "421");
        m_balanceList[m_balanceList.size] = makeArray("18", "423");
        m_balanceList[m_balanceList.size] = makeArray("19", "426");
        m_balanceList[m_balanceList.size] = makeArray("20", "47603");
        m_balanceList[m_balanceList.size] = makeArray("21", "47605");
        m_balanceList[m_balanceList.size] = makeArray("22", "522");
        m_balanceList[m_balanceList.size] = makeArray("23", "52404");
    end;
end;

class (F345Global) F345Global_3875()
    initF345Global();

    m_part1TotalsColumnNumber = 27;
    m_spavPartLineCount       = 9;

    macro makeArray(value1 : String, value2 : String)
        var tmpArray = TArray();

        tmpArray[0] = value1;
        tmpArray[1] = value2;

        return tmpArray;
    end;

    macro initializeBalanceList()
        m_balanceList[m_balanceList.size] = makeArray("2",  "40802");
        m_balanceList[m_balanceList.size] = makeArray("3",  "40803");
        m_balanceList[m_balanceList.size] = makeArray("4",  "40804");
        m_balanceList[m_balanceList.size] = makeArray("5",  "40805");
        m_balanceList[m_balanceList.size] = makeArray("6",  "40806");
        m_balanceList[m_balanceList.size] = makeArray("7",  "40809");
        m_balanceList[m_balanceList.size] = makeArray("8",  "40812");
        m_balanceList[m_balanceList.size] = makeArray("9",  "40813");
        m_balanceList[m_balanceList.size] = makeArray("10", "40814");
        m_balanceList[m_balanceList.size] = makeArray("11", "40815");
        m_balanceList[m_balanceList.size] = makeArray("12", "40817");
        m_balanceList[m_balanceList.size] = makeArray("13", "40818");
        m_balanceList[m_balanceList.size] = makeArray("14", "40819");
        m_balanceList[m_balanceList.size] = makeArray("15", "40820");
        m_balanceList[m_balanceList.size] = makeArray("16", "40821");
        m_balanceList[m_balanceList.size] = makeArray("17", "40823");
        m_balanceList[m_balanceList.size] = makeArray("18", "40824");
        m_balanceList[m_balanceList.size] = makeArray("19", "40825");
        m_balanceList[m_balanceList.size] = makeArray("20", "421");
        m_balanceList[m_balanceList.size] = makeArray("21", "423");
        m_balanceList[m_balanceList.size] = makeArray("22", "426");
        m_balanceList[m_balanceList.size] = makeArray("23", "47603");
        m_balanceList[m_balanceList.size] = makeArray("24", "47605");
        m_balanceList[m_balanceList.size] = makeArray("25", "522");
        m_balanceList[m_balanceList.size] = makeArray("26", "52404");
    end;

    macro initializeErrorList()
        m_errorsMessage[0] = "Печать отчет невозможна, т.к. дата окончания отчетного периода не является последним календарным днем квартала.";
        m_errorsMessage[1] = "Расчет страховых взносов не выполнен в связи с отсутствием рассчитанных данных за период ";
    end;
    
    macro getErrorsMessage( i: integer) : String
        initializeErrorList();
        return m_errorsMessage[i];
    end;
end;

macro global()
    if (v_global == null)
        if (rcbApplication().currentReport().context.period.EndDate >= RCB_I3875_DATE)
            v_global = F345Global_3875();
        elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3198_DATE)
            v_global = F345Global_3198();
        else
            v_global = F345Global();
        end;
    end;

    return v_global;
end;