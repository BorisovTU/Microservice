/*
 $Name:        F345SummarizeCalculate.mac
 $Module:      Регламентируемая отчетность
 $Description: Форма 345. Расчет итогов
*/

class (F345Part1CalculateController) F345Part1SummarizeCalculateController(reportCalculateController : Object, partId : String)
    initF345Part1CalculateController(reportCalculateController, partId);

    macro calculationSumAllColumn(attributeId : String, currentDate : Date)
        var resultScaledSum : Double = 0.0;
        var i;

        for (i, i=2, i=global.getPart1TotalsColumnNumber() - 1, 1)
            resultScaledSum = resultScaledSum + nvl(m_part.getAttribute(string(i)).getScaledValue(currentDate), 0);
        end;

        m_part.getAttribute(attributeId).setScaledValue(currentDate, resultScaledSum);
    end;

    private macro getCalculateAttributeData(attributeId : String, functionName : String, day : Date)

        return RcbCalculationAttributeData(m_part.getAttribute(attributeId),
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName), RcbArray().initialize(attributeId, day))));
    end;

    macro execute()
        var currentDate = global.getRcbPeriod().beginDate;

        while (currentDate <= global.getRcbPeriod().endDate + 1)
            m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(string(global().getPart1TotalsColumnNumber()),  "calculationSumAllColumn", currentDate));
            currentDate = currentDate + 1;
        end;
    end;
end;

class (RcbReportCalculateController) F345TReportSummarizeCalculationController()
    initRcbReportCalculateController();

    macro initialize() : Bool
        m_partCalculateControllers.push_back(F345Part1SummarizeCalculateController(this, "ОсновнойРаздел"));

        return m_partCalculateControllers.size > 0;
    end;
end;
