/*
 $Name:        f345DataSources.mac
 $Module:      Регламентируемая отчетность
 $Description: Форма 345. Источники данных
*/

class (RcbDataSource) F345DataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    private macro getRestsQuery() : String
        return   "SELECT restDate.t_accountId,"
        + "\n" + "       restDate.t_restCurrency,"
        + "\n" + "       restDate.t_restDate,"
        + "\n" + "       restDate.t_rest"
        + "\n" + "  FROM dRestDate_dbt restDate"
        ;
    end;

    macro getData(filter : RcbDataSourceFilter) : Object

        var query = "WITH dates AS (SELECT /*+ materialized*/"
            +"\n"+  "                      (rep_data.getEndDate() + 2) - level t_date"
            +"\n"+  "                 FROM DUAL"
            +"\n"+  "               CONNECT BY level <= " + (global.getRcbPeriod().daysQuantity + 2) + "),"    /*вводить количество дней в квартале + 1, т.к. у нас в отчете ДООП+1*/
            +"\n"+  "     rests AS (" + getRestsQuery() + ")"
            +"\n"+  "SELECT CASE WHEN GROUPING(account.t_account) = 1"
            +"\n"+  "            THEN 'ИТОГО по балансовому счету ' || max(account.t_balance) ||' на: ' || TO_CHAR(dates.t_date)"
            +"\n"+  "       END t_sign,"
            +"\n"+  "       account.t_account,"
            +"\n"+  "       account.t_fiId,"
            +"\n"+  "       dates.t_date,"
            +"\n"+  "       SUM(DECODE(account.t_kind, 'А', -1, 1)* NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                      FROM rests restDate"
            +"\n"+  "                                                     WHERE restDate.t_accountId = account.t_accountId"
            +"\n"+  "                                                       AND restDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                       AND restDate.t_restdate = (SELECT MAX(maxDate.t_restdate) t_maxDate"
            +"\n"+  "                                                                                    FROM rests maxDate"
            +"\n"+  "                                                                                   WHERE maxDate.t_restdate < dates.t_date"
            +"\n"+  "                                                                                     AND maxDate.t_accountId = account.t_accountId"
            +"\n"+  "                                                                                     AND maxDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                                                  )"
            +"\n"+  "                                                   ) * rcb_for.getRate(dates.t_date, account.t_fiId),"
            +"\n"+  "                                                   0"
            +"\n"+  "                                                  )"
            +"\n"+  "          ) AS t_rest"
            +"\n"+  "  FROM drepaccount_vw account,"
            +"\n"+  "       dates"
            +"\n"+  " WHERE 1=1"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "HAVING GROUPING(t_date) = 0 AND GROUPING(account.t_account) = 1   "
            +"\n"+  " GROUP BY ROLLUP (t_date, (account.t_chapter, account.t_account, account.t_fiId)) ";


        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("t_date", V_DATE);
        dataSet.setFieldType("t_rest", V_MONEY);

        return dataSet;
    end;

end;

class (RcbDataSource) F345BalanceDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    class TValue(e, s)
        var exact = e;
        var scaled = s;
    end;

    macro getData(filter : RcbDataSourceFilter, restDate : Date) : Object
        var exactValue = $0.0;
        var scaledValue = $0.0;

        var ds = TRsbDataSet("SELECT t_balance FROM dbalance_dbt balance WHERE t_chapter = 1 AND " + filter.isSuitable() + " AND ROWNUM < 2");

        while (ds.moveNext())
            var value = global.getBalanceData().getValues(ds.balance, restDate);

            exactValue = exactValue + value.getRest();
            scaledValue = scaledValue + value.getScaledRest();
        end;

        return TValue(exactValue, scaledValue);
    end;
end;

class (RcbDataSource) F345BalanceDataSource_4212(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    class TValue(e, s)
        var exact = e;
        var scaled = s;
    end;

    macro getData(filter : RcbDataSourceFilter, restDate : Date, isOnlyRouble : bool) : Object
        var exactValue = $0.0;
        var scaledValue = $0.0;
        var balanceData = global.getBalanceData();

        var ds = balanceData.getBalanceFromMask(filter);

        while (ds.moveNext())
            var value = balanceData.getValues(ds.balance, restDate);

            if (isOnlyRouble)
                exactValue = exactValue + value.getRoubleRest();
                scaledValue = scaledValue + value.getRoubleScaledRest();
            else
                exactValue = exactValue + value.getRest();
                scaledValue = scaledValue + value.getScaledRest();
            end;
        end;

        return TValue(exactValue, scaledValue);
    end;
end;

class (F345DataSource) F345DataSource_3468(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF345DataSource(id, protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter) : Object

        var query = "WITH dates AS (SELECT /*+ materialized*/"
            +"\n"+  "                      (rep_data.getEndDate() + 2) - level t_date"
            +"\n"+  "                 FROM DUAL"
            +"\n"+  "               CONNECT BY level <= " + (global.getRcbPeriod().daysQuantity + 2) + "),"    /*вводить количество дней в квартале + 1, т.к. у нас в отчете ДООП+1*/
            +"\n"+  "     rests AS (" + getRestsQuery() + ")"
            +"\n"+  "SELECT CASE WHEN GROUPING(account.t_account) = 1"
            +"\n"+  "            THEN 'ИТОГО по балансовому счету ' || max(account.t_balance) ||' на: ' || TO_CHAR(dates.t_date)"
            +"\n"+  "       END t_sign,"
            +"\n"+  "       account.t_account,"
            +"\n"+  "       account.t_fiId,"
            +"\n"+  "       dates.t_date,"
            +"\n"+  "       SUM(DECODE(account.t_kind, 'А', -1, 1)* NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                      FROM rests restDate"
            +"\n"+  "                                                     WHERE restDate.t_accountId = account.t_accountId"
            +"\n"+  "                                                       AND restDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                       AND restDate.t_restdate = (SELECT MAX(maxDate.t_restdate) t_maxDate"
            +"\n"+  "                                                                                    FROM rests maxDate"
            +"\n"+  "                                                                                   WHERE maxDate.t_restdate < dates.t_date"
            +"\n"+  "                                                                                     AND maxDate.t_accountId = account.t_accountId"
            +"\n"+  "                                                                                     AND maxDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                                                  )"
            +"\n"+  "                                                   ) * rcb_for.getRate(dates.t_date, account.t_fiId),"
            +"\n"+  "                                                   0"
            +"\n"+  "                                                  )"
            +"\n"+  "          ) AS t_rest"
            +"\n"+  "  FROM drepaccount_vw account,"
            +"\n"+  "       dates"
            +"\n"+  " WHERE account.t_type NOT IN ('М', 'Э')"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "HAVING GROUPING(t_date) = 0 AND GROUPING(account.t_account) = 1   "
            +"\n"+  " GROUP BY ROLLUP (t_date, (account.t_chapter, account.t_account, account.t_fiId)) ";


        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("t_date", V_DATE);
        dataSet.setFieldType("t_rest", V_MONEY);

        return dataSet;
    end;
end;

class (F345DataSource) F345DataSource_3875(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF345DataSource(id, protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter) : Object

        var query = "WITH dates AS (SELECT /*+ materialized*/"
            +"\n"+  "                      (rep_data.getEndDate() + 2) - level t_date"
            +"\n"+  "                 FROM DUAL"
            +"\n"+  "               CONNECT BY level <= " + (global.getRcbPeriod().daysQuantity + 2) + ")"    /*вводить количество дней в квартале + 1, т.к. у нас в отчете ДООП+1*/
            +"\n"+  "SELECT CASE WHEN GROUPING(account.t_account) = 1"
            +"\n"+  "            THEN 'ИТОГО по балансовому счету ' || max(account.t_balance) ||' на: ' || TO_CHAR(dates.t_date)"
            +"\n"+  "       END t_sign,"
            +"\n"+  "       account.t_account,"
            +"\n"+  "       account.t_fiId,"
            +"\n"+  "       dates.t_date,";

        if (global().getRateOfCurrencyRegistry())
            query = query
            +"\n"+  "       SUM(DECODE(account.t_kind, 'А', -1, 1) * NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                              FROM dRestDate_dbt restDate"
            +"\n"+  "                                                             WHERE restDate.t_accountId    = account.t_accountId"
            +"\n"+  "                                                               AND restDate.t_restCurrency = account.t_fiid"
            +"\n"+  "                                                               AND restDate.t_restDate     = (SELECT MAX(maxDate.t_restDate) t_maxDate"
            +"\n"+  "                                                                                                FROM dRestDate_dbt maxDate"
            +"\n"+  "                                                                                                WHERE maxDate.t_restDate     < dates.t_date"
            +"\n"+  "                                                                                                  AND maxDate.t_restCurrency = account.t_fiid"
            +"\n"+  "                                                                                           AND maxDate.t_accountId    = account.t_accountId)), 0)"
            +"\n"+  "                                               * rcb_for.getRate(dates.t_date, account.t_fiId)"
            +"\n"+  "          ) AS t_rest";
        else
            query = query
            +"\n"+  "       SUM(DECODE(account.t_kind, 'А', -1, 1) * NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                              FROM dRestDate_dbt restDate"
            +"\n"+  "                                                             WHERE restDate.t_accountId    = account.t_accountId"
            +"\n"+  "                                                        AND restDate.t_restCurrency = " + NATCUR
            +"\n"+  "                                                               AND restDate.t_restDate     = (SELECT MAX(maxDate.t_restDate) t_maxDate"
            +"\n"+  "                                                                                                FROM dRestDate_dbt maxDate"
            +"\n"+  "                                                                                                WHERE maxDate.t_restDate     < dates.t_date"
            +"\n"+  "                                                                                          AND maxDate.t_restCurrency = " + NATCUR
            +"\n"+  "                                                                                                  AND maxDate.t_accountId    = account.t_accountId)), 0)"
            +"\n"+  "          ) AS t_rest";
        end;

        query = query
            +"\n"+  "  FROM drepaccount_vw account,"
            +"\n"+  "       dates"
            +"\n"+  " WHERE (((account.t_balance LIKE '40823%' OR account.t_balance LIKE '40824%') AND account.t_type IN ('М', 'Э')) OR account.t_type NOT IN ('М', 'Э'))"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "HAVING GROUPING(t_date) = 0 AND GROUPING(account.t_account) = 1   "
            +"\n"+  " GROUP BY ROLLUP (t_date, (account.t_chapter, account.t_account, account.t_fiId)) ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("t_date", V_DATE);
        dataSet.setFieldType("t_rest", V_MONEY);

        return dataSet;
    end;
end;

class (F345DataSource) F345DataSource_4212(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initF345DataSource(id, protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter) : Object
        var rate : String;

        var query = "WITH dates AS (SELECT /*+ materialized*/"
            +"\n"+  "                      (rep_data.getEndDate() + 1) - level t_date"
            +"\n"+  "                 FROM DUAL"
            +"\n"+  "               CONNECT BY level <= " + (global.getRcbPeriod().daysQuantity + 1) + ")"
            +"\n"+  "SELECT CASE WHEN GROUPING(account.t_account) = 1"
            +"\n"+  "            THEN 'ИТОГО по балансовому счету ' || max(account.t_balance) ||' на: ' || TO_CHAR(dates.t_date)"
            +"\n"+  "       END t_sign,"
            +"\n"+  "       account.t_account,"
            +"\n"+  "       account.t_fiId,"
            +"\n"+  "       dates.t_date,"
            +"\n"+  "       SUM(CASE "
            +"\n"+  "             WHEN account.t_fiId = " + NATCUR
            +"\n"+  "               THEN "
            +"\n"+  "                 DECODE(account.t_kind, 'А', -1, 1) * NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                              FROM dRestDate_dbt restDate"
            +"\n"+  "                                                             WHERE restDate.t_accountId    = account.t_accountId"
            +"\n"+  "                                                               AND restDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                               AND restDate.t_restDate     = (SELECT MAX(maxDate.t_restDate) t_maxDate"
            +"\n"+  "                                                                                                FROM dRestDate_dbt maxDate"
            +"\n"+  "                                                                                               WHERE maxDate.t_restDate <= NVL(rates.t_workDate, dates.t_date)"
            +"\n"+  "                                                                                                 AND maxDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                                                                 AND maxDate.t_accountId    = account.t_accountId)), 0)"
            +"\n"+  "               ELSE 0"
            +"\n"+  "           END) AS t_roubleRest,"
            +"\n"+  "       SUM(CASE "
            +"\n"+  "             WHEN account.t_fiId != " + NATCUR
            +"\n"+  "               THEN "
            +"\n"+  "                 DECODE(account.t_kind, 'А', -1, 1) * NVL((SELECT restDate.t_rest"
            +"\n"+  "                                                                        FROM dRestDate_dbt restDate"
            +"\n"+  "                                                                       WHERE restDate.t_accountId    = account.t_accountId"
            +"\n"+  "                                                                         AND restDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                                         AND restDate.t_restDate     = (SELECT MAX(maxDate.t_restDate) t_maxDate"
            +"\n"+  "                                                                                                          FROM dRestDate_dbt maxDate"
            +"\n"+  "                                                                                                         WHERE maxDate.t_restDate <= NVL(rates.t_workDate, dates.t_date)"
            +"\n"+  "                                                                                                           AND maxDate.t_restCurrency = account.t_fiId"
            +"\n"+  "                                                                                                           AND maxDate.t_accountId    = account.t_accountId)), 0)"
            +"\n"+  "                                                         * NVL(rates.t_rate, 0)"
            +"\n"+  "               ELSE 0"
            +"\n"+  "           END) AS t_currencyRest"
            +"\n"+  "  FROM drepaccount_vw account "
            +"\n"+  "       JOIN dates ON 1=1"
            +"\n"+  "       LEFT JOIN (SELECT rd.t_fiId, rd.t_rate, rd.t_date, rd.t_isWorkDay, "
            +"\n"+  "                         CASE  "
            +"\n"+  "                           WHEN rd.t_isWorkDay != 'X' "
            +"\n"+  "                             THEN (SELECT MAX(ratesDate.t_date) "
            +"\n"+  "                                     FROM dfforRateDates_tmp ratesDate "
            +"\n"+  "                                    WHERE ratesDate.t_fiId = rd.t_fiId"
            +"\n"+  "                                      AND ratesDate.t_isWorkDay = 'X'"
            +"\n"+  "                                      AND ratesDate.t_date < rd.t_date)"
            +"\n"+  "                             ELSE rd.t_date"
            +"\n"+  "                         END AS t_workDate "
            +"\n"+  "                    FROM dfforRateDates_tmp rd) rates "
            +"\n"+  "              ON (rates.t_date = dates.t_date AND rates.t_fiId = account.t_fiId) "
            +"\n"+  " WHERE (((account.t_balance LIKE '40823%' OR account.t_balance LIKE '40824%') AND account.t_type IN ('М', 'Э')) OR account.t_type NOT IN ('М', 'Э'))"
            +"\n"+  "   AND " + filter.isSuitable()
            +"\n"+  "HAVING GROUPING(dates.t_date) = 0 AND GROUPING(account.t_account) = 1   "
            +"\n"+  " GROUP BY ROLLUP (dates.t_date, (account.t_chapter, account.t_account, account.t_fiId)) ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("t_date", V_DATE);
        dataSet.setFieldType("t_rest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSource) F345SpravDataSource(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    macro getData(filter : RcbDataSourceFilter) : Object

        var query = "WITH data"
            +"\n"+  "        AS (SELECT rtdoc.t_roubleoutrest, rtdoc.t_account,"
            +"\n"+  "                   DENSE_RANK ()"
            +"\n"+  "                   OVER ("
            +"\n"+  "                      ORDER BY"
            +"\n"+  "                         CASE"
            +"\n"+  "                            WHEN rtdoc.t_roubleoutrest <= 100000 THEN 1"
            +"\n"+  "                            WHEN rtdoc.t_roubleoutrest <= 200000 THEN 2"
            +"\n"+  "                            WHEN rtdoc.t_roubleoutrest <= 400000 THEN 3"
            +"\n"+  "                            WHEN rtdoc.t_roubleoutrest <= 700000 THEN 4"
            +"\n"+  "                            WHEN rtdoc.t_roubleoutrest <= 1000000 THEN 5"
            +"\n"+  "                            ELSE 6"
            +"\n"+  "                         END)"
            +"\n"+  "                      d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, REPRTLDEPACCOUNT_VW rtAccount"
            +"\n"+  "             WHERE     rtaccount.t_referenc = rtdoc.t_referenc"
            +"\n"+  "                   AND rtaccount.t_contractid = rtdoc.t_contractid"
            +"\n"+  "                   AND rtaccount.t_branchid = rtDoc.t_branchid"
            +"\n"+  "                   AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "                   AND " + filter.isSuitable() + ")"
            +"\n"+  "  SELECT d, SUM (t_roubleoutrest) AS total_rest,"
            +"\n"+  "     count(distinct t_account) as cnt_account"
            +"\n"+  "    FROM data"
            +"\n"+  "  GROUP BY d ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("total_rest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSource) F345SpravDataSource_3198(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    macro getData(rtlFilter : RcbDataSourceFilter, cbFilter : RcbDataSourceFilter) : Object

        var query = "WITH data"
            +"\n"+  "        AS (SELECT rtdoc.t_roubleoutrest t_rtRest, rtdoc.t_account as t_rtAccount, 0 AS t_cbRest, '' AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1000    THEN 1"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 10000   THEN 2"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 100000  THEN 3"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 400000  THEN 4"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 700000  THEN 5"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1000000 THEN 6"
            +"\n"+  "                      ELSE 7"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, REPRTLDEPACCOUNT_VW rtAccount"
            +"\n"+  "             WHERE rtaccount.t_referenc = rtdoc.t_referenc"
            +"\n"+  "               AND rtaccount.t_contractid = rtdoc.t_contractid"
            +"\n"+  "               AND rtaccount.t_branchid = rtDoc.t_branchid"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "               AND " + rtlFilter.isSuitable()
            +"\n"+  "         UNION"
            +"\n"+  "            SELECT 0 AS t_rtRest, '' AS t_rtAccount, account.t_outCoverRest AS t_cbRest, account.t_account AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000    THEN 1"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 10000   THEN 2"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 100000  THEN 3"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 400000  THEN 4"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 700000  THEN 5"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000000 THEN 6"
            +"\n"+  "                      ELSE 7"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM drepaccount_vw account"
            +"\n"+  "             WHERE 1 = 1"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("account.t_branchId")
            +"\n"+  "               AND " + cbFilter.isSuitable() + ")"
            +"\n"+  "  SELECT d, SUM (t_rtRest) AS total_rtRest, SUM (t_cbRest) AS total_cbRest,"
            +"\n"+  "         count(distinct t_rtAccount) as cnt_rtAccount, count(distinct t_cbAccount) as cnt_cbAccount"
            +"\n"+  "    FROM data"
            +"\n"+  "  GROUP BY d ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("total_rtRest", V_MONEY);
        dataSet.setFieldType("total_cbRest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSource) F345SpravDataSource_3468(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    macro getData(rtlFilter : RcbDataSourceFilter, cbFilter : RcbDataSourceFilter) : Object

        var query = "WITH data"
            +"\n"+  "        AS (SELECT rtdoc.t_roubleoutrest t_rtRest, rtdoc.t_account as t_rtAccount, 0 AS t_cbRest, '' AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1000    THEN 1"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 10000   THEN 2"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 100000  THEN 3"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 400000  THEN 4"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 700000  THEN 5"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1000000 THEN 6"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1500000 THEN 7"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 3000000 THEN 8"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 5000000 THEN 9"
            +"\n"+  "                      ELSE 10"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, REPRTLDEPACCOUNT_VW rtAccount"
            +"\n"+  "             WHERE rtaccount.t_referenc = rtdoc.t_referenc"
            +"\n"+  "               AND rtaccount.t_contractid = rtdoc.t_contractid"
            +"\n"+  "               AND rtaccount.t_branchid = rtDoc.t_branchid"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "               AND " + rtlFilter.isSuitable()
            +"\n"+  "         UNION"
            +"\n"+  "            SELECT 0 AS t_rtRest, '' AS t_rtAccount, account.t_outCoverRest AS t_cbRest, account.t_account AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000    THEN 1"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 10000   THEN 2"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 100000  THEN 3"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 400000  THEN 4"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 700000  THEN 5"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000000 THEN 6"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1500000 THEN 7"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 3000000 THEN 8"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 5000000 THEN 9"
            +"\n"+  "                      ELSE 10"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM drepaccount_vw account"
            +"\n"+  "             WHERE account.t_type NOT IN ('М', 'Э')"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("account.t_branchId")
            +"\n"+  "               AND " + cbFilter.isSuitable() + ")"
            +"\n"+  "  SELECT d, SUM (t_rtRest) AS total_rtRest, SUM (t_cbRest) AS total_cbRest,"
            +"\n"+  "         count(distinct t_rtAccount) as cnt_rtAccount, count(distinct t_cbAccount) as cnt_cbAccount"
            +"\n"+  "    FROM data"
            +"\n"+  "  GROUP BY d ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("total_rtRest", V_MONEY);
        dataSet.setFieldType("total_cbRest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSource) F345SpravDataSource_3564(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    macro getData(rtlFilter : RcbDataSourceFilter, cbFilter : RcbDataSourceFilter) : Object

        var query = "WITH data"
            +"\n"+  "        AS (SELECT rtdoc.t_roubleoutrest t_rtRest, rtdoc.t_account as t_rtAccount, 0 AS t_cbRest, '' AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN rtdoc.t_roubleoutrest <= 1000    THEN 1"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 1000 AND rtdoc.t_roubleoutrest <= 10000)   THEN 2"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 10000 AND rtdoc.t_roubleoutrest <= 100000)  THEN 3"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 100000 AND rtdoc.t_roubleoutrest <= 700000)  THEN 4"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 700000 AND rtdoc.t_roubleoutrest <= 1000000) THEN 5"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 1000000 AND rtdoc.t_roubleoutrest <= 1400000) THEN 6"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 1400000 AND rtdoc.t_roubleoutrest <= 3000000) THEN 7"
            +"\n"+  "                      WHEN (rtdoc.t_roubleoutrest > 3000000 AND rtdoc.t_roubleoutrest <= 5000000) THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, REPRTLDEPACCOUNT_VW rtAccount"
            +"\n"+  "             WHERE rtaccount.t_referenc = rtdoc.t_referenc"
            +"\n"+  "               AND rtaccount.t_contractid = rtdoc.t_contractid"
            +"\n"+  "               AND rtaccount.t_branchid = rtDoc.t_branchid"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "               AND " + rtlFilter.isSuitable()
            +"\n"+  "         UNION"
            +"\n"+  "            SELECT 0 AS t_rtRest, '' AS t_rtAccount, account.t_outCoverRest AS t_cbRest, account.t_account AS t_cbAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000    THEN 1"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 10000   THEN 2"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 100000  THEN 3"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 700000  THEN 4"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1000000 THEN 5"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 1400000 THEN 6"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 3000000 THEN 7"
            +"\n"+  "                      WHEN account.t_outCoverRest <= 5000000 THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM drepaccount_vw account"
            +"\n"+  "             WHERE " + RcbBranchFieldFilter().GetAsSqlString("account.t_branchId")
            +"\n"+  "               AND " + cbFilter.isSuitable() + ")"
            +"\n"+  "  SELECT d, SUM (t_rtRest) AS total_rtRest, SUM (t_cbRest) AS total_cbRest,"
            +"\n"+  "         count(distinct t_rtAccount) as cnt_rtAccount, count(distinct t_cbAccount) as cnt_cbAccount"
            +"\n"+  "    FROM data"
            +"\n"+  "  GROUP BY d ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("total_rtRest", V_MONEY);
        dataSet.setFieldType("total_cbRest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSource) F345SpravDataSource_4212(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    initRcbDataSource(id, protocolView, dataSources);

    macro getData(rtlFilter : RcbDataSourceFilter, cbFilter : RcbDataSourceFilter, cbEmployerFilter : RcbDataSourceFilter, rtlMdFilter : RcbDataSourceFilter) : Object
        var restCb       : String;
        var restRetail   : String;
        var restMdRetail : String;

        if (global.isWorkDate(global.getRcbPeriod().endDate()))
            restCb = "account.t_outCoverRest";
        else
            restCb = "account.t_outRest * DECODE(account.t_fiId, 0, 1, (SELECT rd.t_rate FROM dfforRateDates_tmp rd WHERE rd.t_date = rep_data.getEndDate() AND rd.t_fiId = account.t_fiId))";
        end;
        restRetail   = "rtdoc.t_outRest * DECODE(rtdoc.t_fininstrumentId, 0, 1, (SELECT rd.t_rate FROM dfforRateDates_tmp rd WHERE rd.t_date = rep_data.getEndDate() AND rd.t_fiId = rtdoc.t_fininstrumentId))";
        restMdRetail = "rtMdPrm.t_rest * DECODE(rtMdPrm.t_fiId, 0, 1, (SELECT rd.t_rate FROM dfforRateDates_tmp rd WHERE rd.t_date = rep_data.getEndDate() AND rd.t_fiId = rtMdPrm.t_fiId))";

        var query = "WITH data"
            +"\n"+  "        AS (SELECT " + restRetail + " AS t_rest, rtdoc.t_account as t_account, 0 AS t_employerRest, '' AS t_employerAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN " + restRetail + " <= 1000    THEN 1"
            +"\n"+  "                      WHEN " + restRetail + " <= 10000   THEN 2"
            +"\n"+  "                      WHEN " + restRetail + " <= 100000  THEN 3"
            +"\n"+  "                      WHEN " + restRetail + " <= 700000  THEN 4"
            +"\n"+  "                      WHEN " + restRetail + " <= 1000000 THEN 5"
            +"\n"+  "                      WHEN " + restRetail + " <= 1400000 THEN 6"
            +"\n"+  "                      WHEN " + restRetail + " <= 3000000 THEN 7"
            +"\n"+  "                      WHEN " + restRetail + " <= 5000000 THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, REPRTLDEPACCOUNT_VW rtAccount"
            +"\n"+  "             WHERE rtaccount.t_referenc    = rtdoc.t_referenc"
            +"\n"+  "               AND rtaccount.t_contractid  = rtdoc.t_contractid"
            +"\n"+  "               AND rtaccount.t_branchid    = rtDoc.t_branchid"
            +"\n"+  "               AND rtDoc.t_isMultiCurrency = 0"
            +"\n"+  "               AND " + restRetail + " > 0"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "               AND " + rtlFilter.isSuitable()
            +"\n"+  "             UNION ALL"
            +"\n"+  "            SELECT " + restMdRetail + " AS t_rest, rtMdPrm.t_account as t_account, 0 AS t_employerRest, '' AS t_employerAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 1000    THEN 1"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 10000   THEN 2"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 100000  THEN 3"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 700000  THEN 4"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 1000000 THEN 5"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 1400000 THEN 6"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 3000000 THEN 7"
            +"\n"+  "                      WHEN " + restMdRetail + " <= 5000000 THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM repRtlDeposit_vw rtdoc, repRtlMdParameters_vw rtMdPrm"
            +"\n"+  "             WHERE rtMdPrm.t_contractid    = rtdoc.t_contractid"
            +"\n"+  "               AND rtMdPrm.t_branchId      = rtDoc.t_branchid"
            +"\n"+  "               AND rtDoc.t_isMultiCurrency = 1"
            +"\n"+  "               AND " + restMdRetail + " > 0"
            +"\n"+  "               AND " + RcbBranchFieldFilter().GetAsSqlString("rtdoc.t_branchId")
            +"\n"+  "               AND " + rtlMdFilter.isSuitable()
            +"\n"+  "             UNION ALL"
            +"\n"+  "            SELECT " + restCb + " AS t_rest, account.t_account AS t_account, 0 AS t_employerRest, '' AS t_employerAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN " + restCb + " <= 1000    THEN 1"
            +"\n"+  "                      WHEN " + restCb + " <= 10000   THEN 2"
            +"\n"+  "                      WHEN " + restCb + " <= 100000  THEN 3"
            +"\n"+  "                      WHEN " + restCb + " <= 700000  THEN 4"
            +"\n"+  "                      WHEN " + restCb + " <= 1000000 THEN 5"
            +"\n"+  "                      WHEN " + restCb + " <= 1400000 THEN 6"
            +"\n"+  "                      WHEN " + restCb + " <= 3000000 THEN 7"
            +"\n"+  "                      WHEN " + restCb + " <= 5000000 THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM drepaccount_vw account"
            +"\n"+  "             WHERE " + RcbBranchFieldFilter().GetAsSqlString("account.t_branchId")
            +"\n"+  "               AND " + restCb + " > 0"
            +"\n"+  "               AND " + cbFilter.isSuitable()
            +"\n"+  "             UNION ALL"
            +"\n"+  "            SELECT 0 AS t_rest, '' AS t_account, " + restCb + " AS t_employerRest, account.t_account AS t_employerAccount,"
            +"\n"+  "                   CASE"
            +"\n"+  "                      WHEN " + restCb + " <= 1000    THEN 1"
            +"\n"+  "                      WHEN " + restCb + " <= 10000   THEN 2"
            +"\n"+  "                      WHEN " + restCb + " <= 100000  THEN 3"
            +"\n"+  "                      WHEN " + restCb + " <= 700000  THEN 4"
            +"\n"+  "                      WHEN " + restCb + " <= 1000000 THEN 5"
            +"\n"+  "                      WHEN " + restCb + " <= 1400000 THEN 6"
            +"\n"+  "                      WHEN " + restCb + " <= 3000000 THEN 7"
            +"\n"+  "                      WHEN " + restCb + " <= 5000000 THEN 8"
            +"\n"+  "                      ELSE 9"
            +"\n"+  "                   END d"
            +"\n"+  "              FROM drepaccount_vw account"
            +"\n"+  "             WHERE " + RcbBranchFieldFilter().GetAsSqlString("account.t_branchId")
            +"\n"+  "               AND " + restCb + " > 0"
            +"\n"+  "               AND " + cbEmployerFilter.isSuitable() + ")"
            +"\n"+  "  SELECT d, SUM (t_rest) AS total_rest, SUM (t_employerRest) AS total_employerRest,"
            +"\n"+  "         count(distinct t_account) as cnt_account, count(distinct t_employerAccount) as cnt_employerAccount"
            +"\n"+  "    FROM data"
            +"\n"+  "   GROUP BY d ";

        var dataSet = TRsbDataSet(query);

        dataSet.setFieldType("total_rtRest", V_MONEY);
        dataSet.setFieldType("total_cbRest", V_MONEY);

        return dataSet;
    end;
end;

class (RcbDataSources) F345DataSources(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource("AccountSprav", null, this));
    end;
end;

class (RcbDataSources) F345DataSources_3198(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource_3198("AccountSprav", null, this));
    end;
end;

class (RcbDataSources) F345DataSources_3468(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource_3468("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource_3468("AccountSprav", null, this));
    end;
end;

class (RcbDataSources) F345DataSources_3564(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource_3468("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource_3564("AccountSprav", null, this));
    end;
end;

class (RcbDataSources) F345DataSources_3875(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource_3875("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource_3564("AccountSprav", null, this));
    end;
end;

class (RcbDataSources) F345DataSources_4212(protocolView : RcbCalculateProtocolView)
    initRcbDataSources(protocolView);

    private macro initialize()
        m_dataSourcePool.push_back(F345DataSource_4212("CbAccount", null, this));
        m_dataSourcePool.push_back(F345BalanceDataSource_4212("AccountBalance", null, this));
        m_dataSourcePool.push_back(F345SpravDataSource_4212("AccountSprav", null, this));
    end;
end;
