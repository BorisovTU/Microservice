/*
$Name:        F501ProtocolPrintController.mac
$Module:      Регламентируемая отчетность.
$Description: Форма 501. Печать протокола расчета
*/

import c_f501;
import Ofstream;
import rcbimport;
import RcbProtocol;
import com_f501;
import arraylib;
import bankInter;

// Необходимость в протоколе сделок РЕПО через ц/к
private var m_isNeedExcludedAccProtocol : Bool = NULL;
private var {Version};

macro isNeedExcludedAccProtocol()
    if (m_isNeedExcludedAccProtocol == NULL)
        var arrayElements : TArray = TArray;    
        StringToArray(arrayElements, {Version}, ".");
        var m_numberPatch = int(ternary(Index(arrayElements[3], " ") != 0, substr(arrayElements[3], 1, Index(arrayElements[3], " ") - 1), arrayElements[3]));
        if (m_numberPatch >= 67)
            m_isNeedExcludedAccProtocol = true;
        else
            m_isNeedExcludedAccProtocol = false;
        end;
    end;

    return m_isNeedExcludedAccProtocol;
end;

class  (TProtocol) F501ProtocolPrintController()

    private var m_tableAccountInfo;
    private var m_table1;
    private var m_table2;

    private var m_MaskArray = TArray();
    private var m_tuneTable = RcbTuneTable("dt501_dbt");

    private var codeClient = "";
    private var isFound = false;
    private var isError = false;
    private var isEmpty = true;

    m_tuneTable.setInstructionFilter(RcbApplication().currentReport.context.period.endDate);

    private macro AnalyzeTurnTable()
        var dataSet;
        m_MaskArray[PART_1] = TArray();
        m_MaskArray[PART_2] = TArray();

        if (TParameters().m_irReducibleRest)
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][type_2] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_2_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][type_2] = dataSet.t_AccountMasks;
        else
            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_1_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_1][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_1][type_2] = "";

            dataSet = TRsbDataSet("SELECT t_AccountMasks FROM (" + m_tuneTable.getQuery() + ") WHERE t_Part = " + SQL_PART_2_CODE + " AND t_TypeAccount LIKE " + SQL_TYPE_1_CODE);
            dataSet.Next();
            m_MaskArray[PART_2][TYPE_1] = dataSet.t_AccountMasks;

            m_MaskArray[PART_2][type_2] = "";
        end;
    end;

    private macro initialize()
        initTProtocol(TProtocolView("ПРОТОКОЛ РАСЧЕТА"));
        m_tableAccountInfo = CTableReport();
        m_tableAccountInfo.addColumn("Номер лицевого счета", 24, AL_LEFT);
        m_tableAccountInfo.addColumn("Наименование",         40, AL_LEFT);
        m_tableAccountInfo.addColumn("Входящий остаток",     30, AL_RIGHT);
        m_tableAccountInfo.addColumn("Исходящий остаток",    30, AL_RIGHT);
        m_table1 = CTableReport();
        m_table1.addColumn("Номер документа",          23, AL_LEFT);
        m_table1.addColumn("Дата",                     10, AL_RIGHT);
        m_table1.addColumn("Счет Дебета",              24, AL_LEFT);
        m_table1.addColumn("Счет кредита",             24, AL_LEFT);
        m_table1.addColumn("Сумма документа в рублях", 35, AL_RIGHT);
        m_table1.addColumn("Примечание",               60, AL_LEFT);

        m_table2 = CTableReport();
        m_table2.addColumn("Номер лицевого счета",   24, AL_LEFT);
        m_table2.addColumn("Значение примечания \"Неснижаемый остаток\" на начало отч. периода");
        m_table2.addColumn("Значение примечания \"Неснижаемый остаток\" на конец отч. периода");

        AnalyzeTurnTable() ;
    end;

    private macro printAccountInfo(currentRecord)
        m_tableAccountInfo.printHead();
        m_tableAccountInfo.printString(currentRecord.account, currentRecord.name, currentRecord.incoverRest, currentRecord.outcoverRest);
        m_tableAccountInfo.printBottom();
    end;

    private macro getQerry()
        return       "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId, acc.t_name,"
            + "\n" + "                                1 t_part,"
            + "\n" + "                                1 t_typeAccount"
            + "\n" + "                           FROM drepaccount_vw acc,"
            + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
            + "\n" + "                          WHERE acc.t_isOpened = 1"
            + "\n" + "                            AND t501.t_Part = " + SQL_PART_1_CODE
            + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
            + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "acc.t_account") + ")"
            + "\n" + "                          UNION"
            + "\n" + "                         SELECT acc.t_chapter, acc.t_account, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId, acc.t_name,"
            + "\n" + "                                2 t_part,"
            + "\n" + "                                1 t_typeAccount"
            + "\n" + "                           FROM drepaccount_vw acc,"
            + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
            + "\n" + "                          WHERE acc.t_isOpened = 1"
            + "\n" + "                            AND t501.t_Part = " + SQL_PART_2_CODE
            + "\n" + "                            AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
            + "\n" + "                            AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "acc.t_account") + ")"
            + "\n" + "                        ),"
            + "\n" + "     repaccount AS (SELECT --+materialize"
            + "\n" + "                         *"
            + "\n" + "                    FROM accountSrcTable),"
            + "\n" + "     documentDebetTable AS ("
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "doc.t_debetaccount") + ")"
            + "\n" + "                          UNION"
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/ BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "doc.t_debetaccount") + ")"
            + "\n" + "                          ),"
            + "\n" + "     documentCreditTable AS ("
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/ BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_1][TYPE_1], "doc.t_creditaccount") + ")"
            + "\n" + "                          UNION"
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/ BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND (" + ConvertMaskToSQLFormat(m_maskArray[PART_2][TYPE_1], "doc.t_creditaccount") + ")"
            + "\n" + "                          )"
            + "\n" + "     SELECT *"
            + "\n" + "       FROM (SELECT documents.t_part,"
            + "\n" + "                    documents.t_typeaccount,"
            + "\n" + "                    GROUPING(documents.t_typeaccount) t_isPartBegin,"
            + "\n" + "                    GROUPING(documents.t_isCreditDocument) t_isTypeAccountBegin,"
            + "\n" + "                    GROUPING(documents.t_name) t_isCreditOrDebetEnd,"
            + "\n" + "                    documents.t_account,"
            + "\n" + "                    documents.t_isCreditDocument,"
            + "\n" + "                    documents.t_name,"
            + "\n" + "                    documents.t_incoverrest,"
            + "\n" + "                    documents.t_outcoverrest,"
            + "\n" + "                    documents.t_number,"
            + "\n" + "                    documents.t_date,"
            + "\n" + "                    documents.t_debetaccount,"
            + "\n" + "                    documents.t_creditaccount,"
            + "\n" + "                    SUM(documents.t_incoversum) t_incoversum,"
            + "\n" + "                    documents.t_note"
            + "\n" + "               FROM (SELECT CASE"
            + "\n" + "                                WHEN ((documents_.t_part = 1) AND (documents_.t_typeAccount = 2))"
            + "\n" + "                                THEN NVL ((SELECT t_coraccount"
            + "\n" + "                                             FROM dcorschem_dbt cor"
            + "\n" + "                                            WHERE cor.t_account = documents_.t_account),"
            + "\n" + "                                         documents_.t_account)"
            + "\n" + "                                ELSE documents_.t_account"
            + "\n" + "                            END t_account,"
            + "\n" + "                            documents_.t_part,"
            + "\n" + "                            documents_.t_typeAccount,"
            + "\n" + "                            documents_.t_name,"
            + "\n" + "                            CASE"
            + "\n" + "                                 WHEN documents_.t_typeAccount = 2"
            + "\n" + "                                 THEN"
            + "\n" + "                                      CASE"
            + "\n" + "                                           WHEN documents_.t_fiId <> 0"
            + "\n" + "                                           THEN rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getbegindate()), 0), documents_.t_fiId, 0, rep_data.getbegindate())"
            + "\n" + "                                           ELSE NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getbegindate()), 0)"
            + "\n" + "                                      END"
            + "\n" + "                                 ELSE documents_.t_incoverRest"
            + "\n" + "                            END t_incoverRest,"
            + "\n" + "                            CASE"
            + "\n" + "                                 WHEN documents_.t_typeAccount = 2"
            + "\n" + "                                 THEN"
            + "\n" + "                                      CASE"
            + "\n" + "                                           WHEN documents_.t_fiId <> 0"
            + "\n" + "                                           THEN rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getenddate()), 0), documents_.t_fiId, 0, rep_data.getenddate())"
            + "\n" + "                                           ELSE NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getenddate()), 0)"
            + "\n" + "                                      END"
            + "\n" + "                                 ELSE documents_.t_outcoverRest"
            + "\n" + "                            END t_outcoverRest,"
            + "\n" + "                            documents_.t_number,"
            + "\n" + "                            documents_.t_date,"
            + "\n" + "                            documents_.t_debetaccount,"
            + "\n" + "                            documents_.t_creditaccount,"
            + "\n" + "                            documents_.t_incoversum,"
            + "\n" + "                            documents_.t_isCreditDocument,"
            + "\n" + "                            documents_.t_note"
            + "\n" + "                       FROM (((SELECT repaccount.t_account,"
            + "\n" + "                                      repaccount.t_objectId,"
            + "\n" + "                                      repaccount.t_fiId,"
            + "\n" + "                                      repaccount.t_part,"
            + "\n" + "                                      repaccount.t_typeaccount,"
            + "\n" + "                                      repaccount.t_name,"
            + "\n" + "                                      0 t_incoverrest,"
            + "\n" + "                                      0 t_outcoverrest,"
            + "\n" + "                                      NULL t_number,"
            + "\n" + "                                      NULL t_date,"
            + "\n" + "                                      NULL t_debetaccount,"
            + "\n" + "                                      NULL t_creditaccount,"
            + "\n" + "                                      0 t_incoversum,"
            + "\n" + "                                      NULL t_iscreditdocument,"
            + "\n" + "                                      NULL t_note"
            + "\n" + "                                 FROM repaccount"
            + "\n" + "                                WHERE repaccount.t_typeaccount = 2)"
            + "\n" + "                                UNION"
            + "\n" + "                              (SELECT repaccount.t_account,"
            + "\n" + "                                      repaccount.t_objectId,"
            + "\n" + "                                      repaccount.t_fiId,"
            + "\n" + "                                      repaccount.t_part,"
            + "\n" + "                                      repaccount.t_typeaccount,"
            + "\n" + "                                      repaccount.t_name,"
            + "\n" + "                                      repaccount.t_incoverrest,"
            + "\n" + "                                      repaccount.t_outcoverrest,"
            + "\n" + "                                      doc.t_number,"
            + "\n" + "                                      doc.t_date,"
            + "\n" + "                                      doc.t_debetaccount,"
            + "\n" + "                                      doc.t_creditaccount,"
            + "\n" + "                                      doc.t_incoversum,"
            + "\n" + "                                      0 t_iscreditdocument,"
            + "\n" + "                                      doc.t_note"
            + "\n" + "                                 FROM repaccount,"
            + "\n" + "                                      documentDebetTable doc"
            + "\n" + "                                WHERE repaccount.t_account = doc.t_debetaccount (+)))"
            + "\n" + "                                UNION"
            + "\n" + "                              (SELECT repaccount.t_account,"
            + "\n" + "                                      repaccount.t_objectId,"
            + "\n" + "                                      repaccount.t_fiId,"
            + "\n" + "                                      repaccount.t_part,"
            + "\n" + "                                      repaccount.t_typeaccount,"
            + "\n" + "                                      repaccount.t_name,"
            + "\n" + "                                      repaccount.t_incoverrest,"
            + "\n" + "                                      repaccount.t_outcoverrest,"
            + "\n" + "                                      doc.t_number,"
            + "\n" + "                                      doc.t_date,"
            + "\n" + "                                      doc.t_debetaccount,"
            + "\n" + "                                      doc.t_creditaccount,"
            + "\n" + "                                      doc.t_incoversum,"
            + "\n" + "                                      1 t_isCreditDocument,"
            + "\n" + "                                      doc.t_note"
            + "\n" + "                                 FROM repaccount,"
            + "\n" + "                                      documentCreditTable doc"
            + "\n" + "                                WHERE repaccount.t_account = doc.t_creditaccount(+))) documents_) documents"
            + "\n" + "                      WHERE ((t_incoverrest <> 0) OR (t_outcoverrest <> 0) OR (t_incoversum <> 0))"
            + "\n" + "           GROUP  BY ROLLUP (documents.t_part, documents.t_typeaccount,"
            + "\n" + "                             (documents.t_account, documents.t_isCreditDocument),"
            + "\n" + "                             (documents.t_name, documents.t_incoverrest,"
            + "\n" + "                              documents.t_outcoverrest, documents.t_number,"
            + "\n" + "                              documents.t_date, documents.t_debetaccount,"
            + "\n" + "                              documents.t_creditaccount, documents.t_incoversum,"
            + "\n" + "                              documents.t_note))"
            + "\n" + "            HAVING GROUPING (documents.t_part) = 0)"
            + "\n" + "                ORDER BY t_part, t_isPartBegin DESC, t_typeaccount,"
            + "\n" + "                         t_isTypeAccountBegin DESC, t_account,"
            + "\n" + "                         t_isCreditDocument, t_isCreditOrDebetEnd,"
            + "\n" + "                         t_date, t_number";
    end;

    private macro getDataSet()
        var dataSource = TRsbDataSet(getQerry(), RSDVAL_CLIENT, RSDVAL_STATIC);

        dataSource.setFieldType("incoverRest", V_MONEY);
        dataSource.setFieldType("outcoverrest", V_MONEY);
        dataSource.setFieldType("incoversum", V_MONEY);
        dataSource.setFieldType("startDate", V_DATE);

        return dataSource;
    end;

    macro printImpl()
        var dataSet = getDataSet();
        var isFistRowInTable1 = true;

        var count1 = 0;
        var count2 = 0;

        while (dataSet.moveNext())
            if (dataSet.isPartBegin == 1)
                println("***************************************************************************************************");
                println("                                    РАЗДЕЛ " + int(dataSet.part));
                println("***************************************************************************************************");
                count1 = 0;
                count2 = 0;
            elif((dataSet.isTypeAccountBegin == 1) AND (dataSet.isPartBegin == 0))
                if (dataSet.typeAccount == 1)
                    println("***************************************************************************************************");
                    println("                  Лицевые счета, соответствующие типу счета \"Депозит/кредит\"" );
                    println("***************************************************************************************************");
                else
                    println("***************************************************************************************************");
                    println("               Лицевые счета, соответствующие типу счета \"Корреспондентский\"" );
                    println("***************************************************************************************************");
                end;
            elif((dataSet.isTypeAccountBegin == 0) AND (dataSet.isPartBegin == 0) AND (dataSet.t_isCreditOrDebetEnd == 1))
                if ((dataSet.typeAccount == 1) AND (dataSet.t_isCreditDocument == 1))
                    if (dataSet.incoverSum == null)
                        m_table1.printString("Оборотов по кредиту нет");
                    else
                        m_table1.printString("","","","","Итого по кредиту " + String(dataSet.incoverSum));
                    end;
                    m_table1.printBottom();
                    isFistRowInTable1 = true;
                elif ((dataSet.typeAccount == 1) AND (dataSet.t_isCreditDocument == 0))
                    if (dataSet.incoverSum == null)
                        m_table1.printString("Оборотов по дебету нет");
                    else
                        m_table1.printString("","","","","Итого по дебету " + String(dataSet.incoverSum));
                    end;
                end;
            else
                if (dataSet.typeAccount == 1)
                    if(isFistRowInTable1)
                        count1 = count1 + 1;
                        m_protocolView.printString(count1 + ")");
                        println();
                        printAccountInfo(dataSet);
                        println("Документы, вошедшие в расчет оборотов");
                        m_table1.printHead();
                        isFistRowInTable1 = false;
                    end;
                    if (dataSet.incoverSum != null)
                        m_table1.PrintStringTransferByWord(dataSet.number, Date(dataSet.date), dataSet.debetAccount, dataSet.creditAccount, dataSet.incoverSum, dataSet.note);
                    end;
                else
                    if (dataSet.incoverSum != null)
                        count2 = count2 + 1;
                        m_protocolView.printString(count2 + ")");
                        println();
                        m_table2.printHead();
                        m_table2.printString(dataSet.account, dataSet.incoverRest, dataSet.outcoverRest);
                        m_table2.printBottom();
                    end;
                end;
            end;
        end;
    end;

    macro printForManualInput(iPart, header, partName)
        isEmpty = true;
        println("***************************************************************************************************");
        println("                                    РАЗДЕЛ " + iPart + ". Пользовательский ввод.");
        println("***************************************************************************************************");
        println("***************************************************************************************************");
        println("                                    " + header);
        println("***************************************************************************************************");
        var compositeValue = RcbApplication().currentReport.attributeValue(partName).createValueIterator();
        compositeValue.moveFirst();
        while (not compositeValue.isDone())
            if (isEmpty)
                println("┌────────────────────────────┬────────────┬───────┬──────────┬─────────────────────┬───────────┬─────────────────────────────────┬────────────────┬─────────────┬────────┐");
                println("│Наименование  кредитной     │  Регистра- │Код    │Номер     │Номер отдельного     │Остаток на │      Обороты по счетам за       │Остаток на      │Дата         │Процент-│");
                println("│организации, привлекшей     │  ционный   │страны │балансово-│лицевого счета       │начало     │      отчетный месяц             │конец           │исполнения   │ная     │");
                println("│(разместившей) денежные     │  номер     │нахож- │го счета, │                     │месяца     │                                 │месяца          │обязатель-   │ставка  │");
                println("│средства                    │  (код      │дения  │на котором│                     │           │                                 │                │ства         │        │");
                println("│                            │  СВИФТ)    │кредит-│отражены  │                     │           │                                 │                │             │        │");
                println("│                            │            │ной    │привлечен-│                     │           │                                 │                │             │        │");
                println("│                            │            │органи-│ные       │                     │           │                                 │                │             │        │");
                println("│                            │            │зации  │(размещен-│                     │           │                                 │                │             │        │");
                println("│                            │            │       │ные)      │                     │           │                                 │                │             │        │");
                println("│                            │            │       │средства  │                     │           ├────────────────┬────────────────┤                │             │        │");
                println("│                            │            │       │          │                     │           │    Дебетовый   │   Кредитовый   │                │             │        │");
                println("├────────────────────────────┼────────────┼───────┼──────────┼─────────────────────┼───────────┼────────────────┼────────────────┼────────────────┼─────────────┼────────┤");
            end;
            var codeClient = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
            //var dataSet = TRsbDataSet("select acc.t_account from daccount_dbt acc where acc.t_account = '" + codeClient + "'");
            var dataSet = TRsbDataSet("SELECT codes.t_partyId FROM dRepPartyCodes_vw codes WHERE codes.t_name = 'Код' AND codes.t_code = '" + codeClient + "'");

            if (dataSet.moveNext())
                isFound = true;
            end;

            if (isFound)

                if ((compositeValue.currentItem.fieldValue("НомЛС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомЛС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер лицевого счета");
                    isError = true;
                end;
                if ((compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введена дата исполнения обязательства");
                    isError = true;
                elif ((DATE(compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current) == "") and (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current != "д/в"))
                    println("  Для клиента " + codeClient + " указан не правильный формат даты исполнения обязательства");
                    isError = true;
                end;
                if ((compositeValue.currentItem.fieldValue("НомБС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомБС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер балансового счета");
                    isError = true;
                end;
                if (not isError)
                    [│############################│############│#######│##########│#####################│###########│################│################│################│#############│########│]
                    (compositeValue.currentItem.fieldValue("НаимКО").current,
                     compositeValue.currentItem.fieldValue("РегНом").current,
                     compositeValue.currentItem.fieldValue("КодСтр").current,
                     compositeValue.currentItem.fieldValue("НомБС_ввод").current,
                     compositeValue.currentItem.fieldValue("НомЛС_ввод").current,
                     compositeValue.currentItem.fieldValue("ОстВход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбДебет_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбКредит_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОстИсход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current,
                     compositeValue.currentItem.fieldValue("ПрСтавка_ввод").current);
                end;
            else
                if (codeClient == "Undefined")
                    println("Не заполнен код клиента.");
                else
                    println("Введенный код клиента " + codeClient + " отсутствует в справочнике субъектов, проверьте корректность введенного кода.");
                end;
            end;
            compositeValue.moveNext();
            isEmpty = false;
            isError = false;
            isFound = false;
        end;
        if (isEmpty)
            println("Нет данных");
        else
            println("└────────────────────────────┴────────────┴───────┴──────────┴─────────────────────┴───────────┴────────────────┴────────────────┴────────────────┴─────────────┴────────┘");
        end;
    end;

    macro printImplForManualInput()
         printForManualInput(1, "Счета ЛОРО",   "Ф501_1ввод");
         printForManualInput(2, "Счета НОСТРО", "Ф501_2ввод");
    end;

    macro print()
        start();

        if (isOn())
            printImpl();
            printImplForManualInput();
        end;

        finish();
    end;

    initialize();

    macro show()
        m_protocolView.show();
    end;
end;

class (F501ProtocolPrintController) F501ProtocolPrintController3129()
    initF501ProtocolPrintController();

    macro printForManualInput(iPart, header, partName)
        isEmpty = true;
        println("***************************************************************************************************");
        println("                                    РАЗДЕЛ " + iPart + ". Пользовательский ввод.");
        println("***************************************************************************************************");
        println("***************************************************************************************************");
        println("                                    " + header);
        println("***************************************************************************************************");

        var compositeValue = RcbApplication().currentReport.attributeValue(partName).createValueIterator();
        compositeValue.moveFirst();
        while (not compositeValue.isDone())
            if (isEmpty)
                println("┌────────────────────────────┬────────────┬───────┬──────────┬─────────────────────┬───────────┬─────────────────────────────────┬────────────────┬─────────────┬────────┐");
                println("│Наименование  кредитной     │  Регистра- │Код    │Номер     │Номер отдельного     │Остаток на │      Обороты по счетам за       │Остаток на      │Дата         │Процент-│");
                println("│организации, привлекшей     │  ционный   │страны │балансово-│лицевого счета       │начало     │      отчетный месяц             │конец           │исполнения   │ная     │");
                println("│(разместившей) денежные     │  номер     │нахож- │го счета, │                     │месяца     │                                 │месяца          │обязатель-   │ставка  │");
                println("│средства                    │  (код      │дения  │на котором│                     │           │                                 │                │ства         │        │");
                println("│                            │  СВИФТ)    │кредит-│отражены  │                     │           │                                 │                │             │        │");
                println("│                            │            │ной    │привлечен-│                     │           │                                 │                │             │        │");
                println("│                            │            │органи-│ные       │                     │           │                                 │                │             │        │");
                println("│                            │            │зации  │(размещен-│                     │           │                                 │                │             │        │");
                println("│                            │            │       │ные)      │                     │           │                                 │                │             │        │");
                println("│                            │            │       │средства  │                     │           ├────────────────┬────────────────┤                │             │        │");
                println("│                            │            │       │          │                     │           │    Дебетовый   │   Кредитовый   │                │             │        │");
                println("├────────────────────────────┼────────────┼───────┼──────────┼─────────────────────┼───────────┼────────────────┼────────────────┼────────────────┼─────────────┼────────┤");
            end;
            var codeClient = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
            var dataSet = TRsbDataSet("SELECT codes.t_partyId FROM dRepPartyCodes_vw codes WHERE codes.t_name = 'Код' AND codes.t_code = '" + codeClient + "'");

            if (dataSet.moveNext())
                isFound = true;
            end;

            if (isFound)
                if ((compositeValue.currentItem.fieldValue("НомЛС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомЛС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер лицевого счета");
                    isError = true;
                end;

                if ((compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введена дата исполнения обязательства");
                    isError = true;
                elif ((DATE(compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current) == "") and (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current != "д/в"))
                    println("  Для клиента " + codeClient + " указан не правильный формат даты исполнения обязательства");
                    isError = true;
                end;

                if ((compositeValue.currentItem.fieldValue("НомБС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомБС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер балансового счета");
                    isError = true;
                end;

                if ((compositeValue.currentItem.fieldValue("ххх_ввод").current != "***") and
                    (compositeValue.currentItem.fieldValue("ххх_ввод").current != ""))
                    println("  Ошибка. Для лицевого счета ЛОРО/НОСТРО " + compositeValue.currentItem.fieldValue("НомЛС_ввод").current +
                            " задано неверное значение переменной <ххх_ввод>. Переменная может содержать символы <***> или иметь неопределенное значение");
                    isError = true;
                end;

                if (not isError)
                    [│############################│############│#######│##########│#####################│###########│################│################│################│#############│########│]
                    (compositeValue.currentItem.fieldValue("НаимКО").current,
                     compositeValue.currentItem.fieldValue("РегНом").current,
                     compositeValue.currentItem.fieldValue("КодСтр").current,
                     compositeValue.currentItem.fieldValue("НомБС_ввод").current,
                     compositeValue.currentItem.fieldValue("НомЛС_ввод").current,
                     compositeValue.currentItem.fieldValue("ОстВход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбДебет_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбКредит_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОстИсход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current,
                     compositeValue.currentItem.fieldValue("ПрСтавка_ввод").current);
                end;
            else
                if (codeClient == "Undefined")
                    println("Не заполнен код клиента.");
                else
                    println("Введенный код клиента " + codeClient + " отсутствует в справочнике субъектов, проверьте корректность введенного кода.");
                end;
            end;
            compositeValue.moveNext();
            isEmpty = false;
            isError = false;
            isFound = false;
        end;
        if (isEmpty)
            println("Нет данных");
        else
            println("└────────────────────────────┴────────────┴───────┴──────────┴─────────────────────┴───────────┴────────────────┴────────────────┴────────────────┴─────────────┴────────┘");
        end;
    end;
end;

class (F501ProtocolPrintController3129) F501ProtocolPrintController4212()
    initF501ProtocolPrintController3129();

    macro printRegistryValues()
        println();
        println("Значения настроек, используемых при расчете:");
        println("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК    " + ternary(TParameters().m_isMmData == true, "YES", "NO"));
        println();
    end;

    private macro initialize()
        initTProtocol(TProtocolView("ПРОТОКОЛ РАСЧЕТА"));

        m_tableAccountInfo = CTableReport();
        m_tableAccountInfo.addColumn("Номер лицевого счета",                                                                                                    24, AL_LEFT);
        m_tableAccountInfo.addColumn("Наименование",                                                                                                            40, AL_LEFT);
        m_tableAccountInfo.addColumn("Входящий остаток",                                                                                                        30, AL_RIGHT);
        m_tableAccountInfo.addColumn("Исходящий остаток",                                                                                                       30, AL_RIGHT);
        m_tableAccountInfo.addColumn("Номер лицевого счета,|указанного в связанном|объекте \"Лицевой счет\"|с ролью|\"Обремененное|обязательство\"",            24, AL_LEFT);
        m_tableAccountInfo.addColumn("Код и наименование субъекта,|указанного в связанном объекте|\"Субъект экономики\"|с ролью|\"Контрагент по обременению\"", 60, AL_LEFT);

        if (TParameters().m_isMmData)
            m_tableAccountInfo.addColumn("Номер сделки", 20, AL_LEFT);
            m_tableAccountInfo.addColumn("Дата привлечения/размещения", 10, AL_LEFT);
        end;

        m_table1 = CTableReport();
        m_table1.addColumn("Номер документа",          23, AL_LEFT);
        m_table1.addColumn("Дата",                     10, AL_RIGHT);
        m_table1.addColumn("Счет Дебета",              24, AL_LEFT);
        m_table1.addColumn("Счет кредита",             24, AL_LEFT);
        m_table1.addColumn("Сумма документа в рублях", 35, AL_RIGHT);
        m_table1.addColumn("Примечание",               60, AL_LEFT);

        m_table2 = CTableReport();
        m_table2.addColumn("Номер лицевого счета",   24, AL_LEFT);
        m_table2.addColumn("Значение примечания \"Неснижаемый остаток\" на начало отч. периода");
        m_table2.addColumn("Значение примечания \"Неснижаемый остаток\" на конец отч. периода");

        AnalyzeTurnTable() ;
    end;

    macro printForManualInput(iPart, header, partName)
        isEmpty = true;
        println("***************************************************************************************************");
        println("                                    РАЗДЕЛ " + iPart + ". Пользовательский ввод.");
        println("***************************************************************************************************");
        println("***************************************************************************************************");
        println("                                    " + header);
        println("***************************************************************************************************");

        var compositeValue = RcbApplication().currentReport.attributeValue(partName).createValueIterator();
        compositeValue.moveFirst();
        while (not compositeValue.isDone())
            if (isEmpty)
                println("┌────────────────────────────┬─────────────┬───────┬──────────┬──────────────────────┬──────────────┬───────────────────────────┬─────────────┬─────────────┬────────┬───────────────────────────────────┬───────────────────────────────────────────┐");
                println("│   Наименование кредитной   │  Регистра-  │  Код  │  Номер   │   Номер отдельного   │   Остаток    │   Обороты по счетам за    │   Остаток   │    Дата     │Процент-│       Наличие обременения         │        Обязательство, по которому         │");
                println("│        организации,        │   ционный   │страны │балансово-│    лицевого счета    │     на       │      отчетный месяц,      │     на      │ исполнения  │  ная   │                                   │         осуществлено обременение          │");
                println("│ привлекшей (разместившей)  │    номер    │нахож- │го счета, │                      │начало месяца,│         тыс. руб.         │конец месяца,│обязательства│ ставка │                                   │                                           │");
                println("│     денежные средства      │ (код СВИФТ) │ дения │на котором│                      │  тыс. руб.   │                           │  тыс. руб.  │             │        ├─────────────────────┬─────────────┼────────────────┬─────────────┬────────────┤");
                println("│                            │             │кредит-│ отражены │                      │              │                           │             │             │        │ наименование лица,  │идентификатор│      вид       │ стоимость,  │    срок    │");
                println("│                            │             │  ной  │привлечен-│                      │              │                           │             │             │        │  в пользу которого  │    лица     │                │  тыс. руб.  │ погашения  │");
                println("│                            │             │органи-│ные (раз- │                      │              │                           │             │             │        │    осуществлено     │             │                │             │            │");
                println("│                            │             │ зации │мещенные) │                      │              ├─────────────┬─────────────┤             │             │        │     обременение     │             │                │             │            │");
                println("│                            │             │       │ средства │                      │              │  Дебетовый  │ Кредитовый  │             │             │        │                     │             │                │             │            │");
                println("├────────────────────────────┼─────────────┼───────┼──────────┼──────────────────────┼──────────────┼─────────────┼─────────────┼─────────────┼─────────────┼────────┼─────────────────────┼─────────────┼────────────────┼─────────────┼────────────┤");
            end;

            var codeClient = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
            var dataSet = TRsbDataSet("SELECT codes.t_partyId FROM dRepPartyCodes_vw codes WHERE codes.t_name = 'Код' AND codes.t_code = '" + codeClient + "'");

            if (dataSet.moveNext())
                isFound = true;
            end;

            if (isFound)
                if (   (compositeValue.currentItem.fieldValue("НомЛС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомЛС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер лицевого счета");
                    isError = true;
                end;

                if (   (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введена дата исполнения обязательства");
                    isError = true;
                elif ((DATE(compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current) == "") and (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current != "д/в"))
                    println("  Для клиента " + codeClient + " указан не правильный формат даты исполнения обязательства");
                    isError = true;
                end;

                if (   (compositeValue.currentItem.fieldValue("НомБС_ввод").current == "")
                    or (compositeValue.currentItem.fieldValue("НомБС_ввод").current == NULL))
                    println("  Для клиента " + codeClient + " не введен номер балансового счета");
                    isError = true;
                end;

                if (    (compositeValue.currentItem.fieldValue("ххх_ввод").current != "***")
                    and not (compositeValue.currentItem.fieldValue("ххх_ввод").isUndefined()))
                    println("  Ошибка. Для лицевого счета ЛОРО/НОСТРО " + compositeValue.currentItem.fieldValue("НомЛС_ввод").current +
                            " задано неверное значение переменной <ххх_ввод>. Переменная может содержать символы <***> или иметь неопределенное значение");
                    isError = true;
                end;

                if (not isError)
                    [│############################│#############│#######│##########│######################│##############│#############│#############│#############│#############│########│#####################│#############│################│#############│############│]
                    (compositeValue.currentItem.fieldValue("НаимКО").current,
                     compositeValue.currentItem.fieldValue("РегНом").current,
                     compositeValue.currentItem.fieldValue("КодСтр").current,
                     compositeValue.currentItem.fieldValue("НомБС_ввод").current,
                     compositeValue.currentItem.fieldValue("НомЛС_ввод").current,
                     compositeValue.currentItem.fieldValue("ОстВход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбДебет_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОбКредит_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ОстИсход_ввод").current:9:3,
                     compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current,
                     compositeValue.currentItem.fieldValue("ПрСтавка_ввод").current,
                     ternary(iPart == 1, ternary(compositeValue.currentItem.fieldValue("ЛицоПоОбрем_ввод").currentAsString != stringUndefined,
                                                 compositeValue.currentItem.fieldValue("ЛицоПоОбрем_ввод").currentAsString, ""), "X"):c,
                     ternary(iPart == 1, ternary(compositeValue.currentItem.fieldValue("ИдентификаторОбрем_ввод").currentAsString != stringUndefined,
                                                 compositeValue.currentItem.fieldValue("ИдентификаторОбрем_ввод").currentAsString, ""), "X"):c,
                     ternary(iPart == 1, ternary(compositeValue.currentItem.fieldValue("ВидОбрем_ввод").currentAsString != stringUndefined,
                                                 compositeValue.currentItem.fieldValue("ВидОбрем_ввод").currentAsString, "") , "X"):c,
                     ternary(iPart == 1, ternary(compositeValue.currentItem.fieldValue("ВидОбрем_ввод").currentAsString != "",
                                                 compositeValue.currentItem.fieldValue("ОстатокПоСчетуОбрем_ввод").currentAsString, ""), "X      "):r,
                     ternary(iPart == 1, ternary(compositeValue.currentItem.fieldValue("ЛицоПоОбрем_ввод").currentAsString != stringUndefined,
                                                 compositeValue.currentItem.fieldValue("ДатаПогашения_ввод").currentAsString, ""), "X"):c);
                end;
            else
                if (codeClient == "Undefined")
                    println("Не заполнен код клиента.");
                else
                    println("Введенный код клиента " + codeClient + " отсутствует в справочнике субъектов, проверьте корректность введенного кода.");
                end;
            end;
            compositeValue.moveNext();
            isEmpty = false;
            isError = false;
            isFound = false;
        end;
        if (isEmpty)
            println("Нет данных");
        else
            println("└────────────────────────────┴─────────────┴───────┴──────────┴──────────────────────┴──────────────┴─────────────┴─────────────┴─────────────┴─────────────┴────────┴─────────────────────┴─────────────┴────────────────┴─────────────┴────────────┘");
        end;
    end;

    private macro printAccountInfo(currentRecord)
        m_tableAccountInfo.printHead();

        if (TParameters().m_isMmData)
            m_tableAccountInfo.printStringTransferByWord(currentRecord.account, currentRecord.name, currentRecord.incoverRest, currentRecord.outcoverRest,
                                                         ternary(currentRecord.t_part == 1, currentRecord.linkedAccount, ""),
                                                         ternary(currentRecord.t_part == 1, currentRecord.linkedParty, ""),
                                                         nvl(currentRecord.dealNumber, ""),
                                                         nvl(currentRecord.startDate, "")
                                                         );
        else
            m_tableAccountInfo.printStringTransferByWord(currentRecord.account, currentRecord.name, currentRecord.incoverRest, currentRecord.outcoverRest,
                                                        ternary(currentRecord.t_part == 1, currentRecord.linkedAccount, ""),
                                                        ternary(currentRecord.t_part == 1, currentRecord.linkedParty, ""));
        end;

        m_tableAccountInfo.printBottom();
    end;

    private macro getQerry()
        var queryForData = ""
                   + "WITH accountSrcTable AS (SELECT acc.t_chapter, acc.t_account, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "                                acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId, acc.t_name,"
            + "\n" + "                                t501.t_Part t_part,"
            + "\n" + "                                CASE t501.t_TypeAccount"
            + "\n" + "                                    WHEN " + SQL_TYPE_1_CODE + " THEN 1"
            + "\n" + "                                    ELSE 2"
            + "\n" + "                                END t_typeAccount"
            + "\n" + "                           FROM drepaccount_vw acc,"
            + "\n" + "                                (" + m_tuneTable.getQuery() + ") t501"
            + "\n" + "                          WHERE acc.t_isOpened = 1"
            + "\n" + "                            AND acc.t_chapter = 1"
            + "\n" + "                            AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, acc.t_account) = 1"
            + "\n" + "                            AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО ч/з ЦК', acc.t_objectId, "
                                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "                            AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                                          + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") = 0"
            + "\n" + "                            AND (   (    (SELECT party.t_isBank"
            + "\n" + "                                            FROM dRepParty_vw party"
            + "\n" + "                                           WHERE party.t_id = acc.t_contragentId"
            + "\n" + "                                         ) = 1"
            + "\n" + "                                      AND NOT EXISTS(SELECT 1"
            + "\n" + "                                                       FROM dBankDprtRstr_dbt bnkRstr"
            + "\n" + "                                                      WHERE bnkRstr.t_partyId = acc.t_contragentId"
            + "\n" + "                                                        AND bnkRstr.t_rstr = 'LWRS'"
            + "\n" + "                                                        AND bnkRstr.t_rstrDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
            + "\n" + "                                                    )"
            + "\n" + "                                    )"
            + "\n" + "                                 OR (SELECT party.t_isCentralBank"
            + "\n" + "                                       FROM dRepParty_vw party"
            + "\n" + "                                      WHERE party.t_id = acc.t_contragentId"
            + "\n" + "                                    ) = 1"
            + "\n" + "                                )"
            + "\n" + "                        ),"
            + "\n" + "     repaccount AS (SELECT --+materialize"
            + "\n" + "                         *"
            + "\n" + "                    FROM accountSrcTable),"
            + "\n" + "     documentDebetTable AS ("
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc,"
            + "\n" + "                                 (" + m_tuneTable.getQuery() + ") t501"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, doc.t_debetaccount) = 1"
            + "\n" + "                             AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
            + "\n" + "                          ),"
            + "\n" + "     documentCreditTable AS ("
            + "\n" + "                          SELECT doc.t_number, doc.t_date, doc.t_debetaccount, doc.t_creditaccount, doc.t_incoversum, doc.t_note"
            + "\n" + "                            FROM drepdocumentwithcorrection_vw doc,"
            + "\n" + "                                 (" + m_tuneTable.getQuery() + ") t501"
            + "\n" + "                           WHERE TO_DATE(doc.t_date) /*TO_DATE() тут только для того, чтобы индекс по дате не подхватывался*/ BETWEEN rep_data.getbegindate() AND rep_data.getenddate()"
            + "\n" + "                             AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, doc.t_creditaccount) = 1"
            + "\n" + "                             AND t501.t_TypeAccount = " + SQL_TYPE_1_CODE
            + "\n" + "                          ),"
            + "\n" + "     linkedPartys AS (SELECT *                                                                                        "
            + "\n" + "                        FROM( SELECT acc.t_account,                                                                   "
            + "\n" + "                                     RPAD(RPAD(codes.t_code, 15, ' ') || ' ' || party.t_name, 100, ' ') as linkedParty,"
            + "\n" + "                                     RANK() OVER(PARTITION BY acc.t_account ORDER BY codes.t_code, codes.t_codekind) rnk"
            + "\n" + "                                FROM dRepLinkedObjects_vw link,                                                       "
            + "\n" + "                                     dRepAccount_vw       acc,                                                        "
            + "\n" + "                                     dRepParty_vw         party,                                                      "
            + "\n" + "                                     dRepPartyCodes_vw    codes                                                       "
            + "\n" + "                               WHERE acc.t_chapter            = TO_NUMBER(SUBSTR(link.t_connectObjectId, 0, 2))"
            + "\n" + "                                 AND acc.t_fiId               = TO_NUMBER(SUBSTR(link.t_connectObjectId, 3, 7), 'XXXXXXX')"
            + "\n" + "                                 AND acc.t_account            = SUBSTR(link.t_connectObjectId, 10)"
            + "\n" + "                                 AND party.t_objectId(+)      = link.t_id                                                  "
            + "\n" + "                                 AND codes.t_partyId          = link.t_id                                                  "
            + "\n" + "                                 AND link.t_connectObjectType = " + RCB_OBJTYPE_ACCOUNT
            + "\n" + "                                 AND link.t_type              = " + RCB_OBJTYPE_PARTY
            + "\n" + "                                 AND link.t_role              = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
            + "\n" + "                            )                                                                                 "
            + "\n" + "                       WHERE rnk = 1                                                                          "
            + "\n" + "                     ),                                                                                       "
            + "\n" + "     linkedAccounts AS (SELECT acc.t_account,                                                                 "
            + "\n" + "                               acc2.t_account linkedAccount                                                   "
            + "\n" + "                          FROM dRepLinkedObjects_vw link,                                                     "
            + "\n" + "                               dRepAccount_vw       acc,                                                      "
            + "\n" + "                               dRepAccount_vw       acc2                                                      "
            + "\n" + "                         WHERE acc.t_chapter  = TO_NUMBER(SUBSTR(link.t_connectObjectId, 0, 2))"
            + "\n" + "                           AND acc.t_fiId     = TO_NUMBER(SUBSTR(link.t_connectObjectId, 3, 7), 'XXXXXXX') "
            + "\n" + "                           AND acc.t_account  = SUBSTR(link.t_connectObjectId, 10)"
            + "\n" + "                           AND acc2.t_chapter = TO_NUMBER(SUBSTR(link.t_id, 0, 2))"
            + "\n" + "                           AND acc2.t_fiId    = TO_NUMBER(SUBSTR(link.t_id, 3, 7), 'XXXXXXX')"
            + "\n" + "                           AND acc2.t_account = SUBSTR(link.t_id, 10)"
            + "\n" + "                           AND link.t_role              = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
            + "\n" + "                           AND link.t_connectObjectType = " + RCB_OBJTYPE_ACCOUNT
            + "\n" + "                           AND link.t_type              = " + RCB_OBJTYPE_ACCOUNT
            + "\n" + "                       ),                                                                                     "
            + "\n" + "     linkedObjects AS (SELECT NVL(t1.t_account, t2.t_account) t_account,                                      "
            + "\n" + "                              t1.linkedParty,                                                                 "
            + "\n" + "                              t2.linkedAccount                                                                "
            + "\n" + "                         FROM linkedPartys   t1                                                               "
            + "\n" + "                    FULL JOIN linkedAccounts t2                                                               "
            + "\n" + "                           ON t1.t_account = t2.t_account                                                     "
            + "\n" + "                      )                                                                                       "
            + "\n" + "     SELECT *"
            + "\n" + "       FROM (SELECT documents.t_part,"
            + "\n" + "                    documents.t_typeaccount,"
            + "\n" + "                    GROUPING(documents.t_typeaccount) t_isPartBegin,"
            + "\n" + "                    GROUPING(documents.t_isCreditDocument) t_isTypeAccountBegin,"
            + "\n" + "                    GROUPING(documents.t_name) t_isCreditOrDebetEnd,"
            + "\n" + "                    documents.t_account,"
            + "\n" + "                    documents.t_isCreditDocument,"
            + "\n" + "                    documents.t_name,"
            + "\n" + "                    documents.t_incoverrest,"
            + "\n" + "                    documents.t_outcoverrest,"
            + "\n" + "                    documents.t_number,"
            + "\n" + "                    documents.t_date,"
            + "\n" + "                    documents.t_debetaccount,"
            + "\n" + "                    documents.t_creditaccount,"
            + "\n" + "                    SUM(documents.t_incoversum) t_incoversum,"
            + "\n" + "                    documents.t_note,"
            + "\n" + "                    linkedObjects.linkedAccount,"
            + "\n" + "                    linkedObjects.linkedParty,";
        if (TParameters().m_isMmData)
            queryForData = queryForData
            + "\n" + "                    (SELECT deals.t_number"
            + "\n" + "                       FROM repMmDeals_vw deals"
            + "\n" + "                      WHERE deals.t_id = documents.t_dealId"
            + "\n" + "                    ) AS dealNumber,"
            + "\n" + "                    (SELECT deals.t_startDate"
            + "\n" + "                       FROM repMmDeals_vw deals"
            + "\n" + "                      WHERE deals.t_id = documents.t_dealId"
            + "\n" + "                     ) AS startDate"
        else
            queryForData = queryForData
            + "\n" + "       NULL AS dealNumber,"
            + "\n" + "       NULL AS startDate";
        end;

        queryForData = queryForData
            + "\n" + "               FROM (SELECT CASE"
            + "\n" + "                                WHEN ((documents_.t_part = 1) AND (documents_.t_typeAccount = 2))"
            + "\n" + "                                THEN NVL ((SELECT t_coraccount"
            + "\n" + "                                             FROM dcorschem_dbt cor"
            + "\n" + "                                            WHERE cor.t_account = documents_.t_account),"
            + "\n" + "                                         documents_.t_account)"
            + "\n" + "                                ELSE documents_.t_account"
            + "\n" + "                            END t_account,"
            + "\n" + "                            documents_.t_part,"
            + "\n" + "                            documents_.t_typeAccount,"
            + "\n" + "                            documents_.t_name,"
            + "\n" + "                            CASE"
            + "\n" + "                                 WHEN documents_.t_typeAccount = 2"
            + "\n" + "                                 THEN"
            + "\n" + "                                      CASE"
            + "\n" + "                                           WHEN documents_.t_fiId <> 0"
            + "\n" + "                                           THEN rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getbegindate()), 0), documents_.t_fiId, 0, rep_data.getbegindate())"
            + "\n" + "                                           ELSE NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getbegindate()), 0)"
            + "\n" + "                                      END"
            + "\n" + "                                 ELSE documents_.t_incoverRest"
            + "\n" + "                            END t_incoverRest,"
            + "\n" + "                            CASE"
            + "\n" + "                                 WHEN documents_.t_typeAccount = 2"
            + "\n" + "                                 THEN"
            + "\n" + "                                      CASE"
            + "\n" + "                                           WHEN documents_.t_fiId <> 0"
            + "\n" + "                                           THEN rsb_fiinstr.convsum(NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getenddate()), 0), documents_.t_fiId, 0, rep_data.getenddate())"
            + "\n" + "                                           ELSE NVL(rep_note.readconstantrest(documents_.t_objectid, rep_data.getenddate()), 0)"
            + "\n" + "                                      END"
            + "\n" + "                                 ELSE documents_.t_outcoverRest"
            + "\n" + "                            END t_outcoverRest,"
            + "\n" + "                            documents_.t_number,"
            + "\n" + "                            documents_.t_date,"
            + "\n" + "                            documents_.t_debetaccount,"
            + "\n" + "                            documents_.t_creditaccount,"
            + "\n" + "                            documents_.t_incoversum,"
            + "\n" + "                            documents_.t_isCreditDocument,"
            + "\n" + "                            documents_.t_note,";

        if (TParameters().m_isMmData)
            queryForData = queryForData
            + "\n" + "       (SELECT MAX(deals.t_id)"
            + "\n" + "          FROM repMmDeals_vw deals    "
            + "\n" + "         WHERE (   deals.t_mainRestAccount = documents_.t_account"
            + "\n" + "                OR deals.t_delaydMainRestAcc = documents_.t_account"
            + "\n" + "               )"
            + "\n" + "           AND deals.t_kind IN ('Размещение ', 'Привлечение')"
            + "\n" + "           AND deals.t_isOpened = 1"
            + "\n" + "           AND deals.t_plannedFinishDate = (SELECT MAX(d.t_plannedFinishDate)"
            + "\n" + "                                              FROM repMmDeals_vw d "
            + "\n" + "                                             WHERE (   d.t_mainRestAccount = documents_.t_account"
            + "\n" + "                                                    OR d.t_delaydMainRestAcc = documents_.t_account"
            + "\n" + "                                                   )"
            + "\n" + "                                               AND d.t_kind IN ('Размещение ', 'Привлечение')"
            + "\n" + "                                               AND d.t_isOpened = 1"
            + "\n" + "                                           )"
            + "\n" + "       ) AS t_dealId";
        else
            queryForData = queryForData
            + "\n" + "       NULL AS t_dealId";
        end;

        queryForData = queryForData
            + "\n" + "                       FROM (((SELECT repaccount.t_account,"
            + "\n" + "                                      repaccount.t_objectId,"
            + "\n" + "                                      repaccount.t_fiId,"
            + "\n" + "                                      repaccount.t_part,"
            + "\n" + "                                      repaccount.t_typeaccount,"
            + "\n" + "                                      repaccount.t_name,"
            + "\n" + "                                      repaccount.t_incoverrest,"
            + "\n" + "                                      repaccount.t_outcoverrest,"
            + "\n" + "                                      doc.t_number,"
            + "\n" + "                                      doc.t_date,"
            + "\n" + "                                      doc.t_debetaccount,"
            + "\n" + "                                      doc.t_creditaccount,"
            + "\n" + "                                      doc.t_incoversum,"
            + "\n" + "                                      0 t_iscreditdocument,"
            + "\n" + "                                      doc.t_note"
            + "\n" + "                                 FROM repaccount,"
            + "\n" + "                                      documentDebetTable doc"
            + "\n" + "                                WHERE repaccount.t_account = doc.t_debetaccount (+)))"
            + "\n" + "                                UNION"
            + "\n" + "                              (SELECT repaccount.t_account,"
            + "\n" + "                                      repaccount.t_objectId,"
            + "\n" + "                                      repaccount.t_fiId,"
            + "\n" + "                                      repaccount.t_part,"
            + "\n" + "                                      repaccount.t_typeaccount,"
            + "\n" + "                                      repaccount.t_name,"
            + "\n" + "                                      repaccount.t_incoverrest,"
            + "\n" + "                                      repaccount.t_outcoverrest,"
            + "\n" + "                                      doc.t_number,"
            + "\n" + "                                      doc.t_date,"
            + "\n" + "                                      doc.t_debetaccount,"
            + "\n" + "                                      doc.t_creditaccount,"
            + "\n" + "                                      doc.t_incoversum,"
            + "\n" + "                                      1 t_isCreditDocument,"
            + "\n" + "                                      doc.t_note"
            + "\n" + "                                 FROM repaccount,"
            + "\n" + "                                      documentCreditTable doc"
            + "\n" + "                                WHERE repaccount.t_account = doc.t_creditaccount(+))) documents_) documents,"
            + "\n" + "                            linkedObjects"
            + "\n" + "                      WHERE (   (t_incoverrest  <> 0)"
            + "\n" + "                             OR (t_outcoverrest <> 0)"
            + "\n" + "                             OR (t_incoversum   <> 0))"
            + "\n" + "                        AND documents.t_account = linkedObjects.t_account(+)"
            + "\n" + "           GROUP  BY ROLLUP (documents.t_part, documents.t_typeaccount,"
            + "\n" + "                             (documents.t_account, documents.t_isCreditDocument),"
            + "\n" + "                             (documents.t_name, documents.t_incoverrest,"
            + "\n" + "                              documents.t_outcoverrest, documents.t_number,"
            + "\n" + "                              documents.t_date, documents.t_debetaccount,"
            + "\n" + "                              documents.t_creditaccount, documents.t_incoversum,"
            + "\n" + "                              documents.t_note,"
            + "\n" + "                              linkedObjects.linkedAccount,"
            + "\n" + "                              linkedObjects.linkedParty,"
            + "\n" + "                              documents.t_dealId))"
            + "\n" + "            HAVING GROUPING (documents.t_part) = 0)"
            + "\n" + "                ORDER BY t_part, t_isPartBegin DESC, t_typeaccount,"
            + "\n" + "                         t_isTypeAccountBegin DESC, t_account,"
            + "\n" + "                         t_isCreditDocument, t_isCreditOrDebetEnd,"
            + "\n" + "                         t_date, t_number";

        return queryForData;
    end;

    macro print()
        start();
        printRegistryValues();

        if (isOn())
            printImpl();
            printImplForManualInput();
        end;

        finish();
    end;
end;

private class (RcbDataProtocolView) TF501DataProtocolViewBase(id : String)
    private const DELIMITER = "\t";

    private var m_stream : Object;

    private macro initialize()
    end;

    macro getFileName()
        var name = m_stream.getFileName();
        var dotIndex = strlen(name);
        while ((dotIndex > 0) and (substr(name, dotIndex, 1) != "."))
            dotIndex = dotIndex - 1;
        end;
        if (dotIndex == 0)
            dotIndex = strlen(name) + 1;
        end;
        strset(name, dotIndex, "_");
        name = name + ".csv";

        return name;
    end;

    macro save()
        m_stream.save(getFileName());
    end;

    private macro printStringImpl()
        var i = 1;
        var p = null;
        var str = "";

        while (getParm(i, p))
            str = str + DELIMITER + "\"" + p + "\"";
            i = i + 1;
        end;
        str = substr(str, 2);

        m_stream.setOutputFile();
        println(str);
        m_stream.resetOutputFile();
    end;

    private macro ctorTF501DataProtocolViewBase(id : String)
        initRcbDataProtocolView(id);
        m_stream = TOfstream("f501_calculate_" + id);
    end;

    ctorTF501DataProtocolViewBase(id);
end;

private class (TF501DataProtocolViewBase) TF501DataProtocolViewAccI4212(id : String)
    macro printHead()
        if (TParameters().m_isMmData)
            printStringImpl("Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению",
                            "Номер сделки МБК",
                            "Дата привлечения/размещения",
                            "Процентная ставка"
                           );
        else
            printStringImpl("Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению"
                           );
        end;
    end;

    macro printString(data : Object)
        var onerousClaim = trim(data.t_identifier + ternary(data.t_identifier != "", " ", "") + data.t_onerousClaim);

        if (TParameters().m_isMmData)
            printStringImpl(data.t_account,
                            data.t_name,
                            nvl(data.t_beginRest, ""),
                            nvl(data.t_debet, ""),
                            nvl(data.t_credit, ""),
                            nvl(data.t_endRest, ""),
                            data.t_linkedAccount,
                            onerousClaim,
                            data.t_number,
                            nvl(data.t_startDate, ""),
                            nvl(data.t_rate, "")
                           );
        else
            printStringImpl(data.t_account,
                            data.t_name,
                            nvl(data.t_beginRest, ""),
                            nvl(data.t_debet, ""),
                            nvl(data.t_credit, ""),
                            nvl(data.t_endRest, ""),
                            nvl(data.t_linkedAccount, ""),
                            onerousClaim
                           );
        end;
    end;

    private macro ctorTF501DataProtocolViewAccI4212(id : String)
        initTF501DataProtocolViewBase(id);
    end;

    ctorTF501DataProtocolViewAccI4212(id);
end;

private class (TF501DataProtocolViewAccI4212) TF501DataProtocolViewAcc5456(id : String) 
    macro printHead()
        if (TParameters().m_isMmData and TParameters().m_isSecuritiesData)
            printStringImpl("Бэк-офис",
                            "Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению",
                            "Номер сделки МБК/Securities",
                            "Дата привл/разм. МБК/Дата заключения Securities",
                            "Процентная ставка",
                            "Тип сделка Securities"
                           );
        elif (TParameters().m_isMmData)
            printStringImpl("Бэк-офис",
                            "Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению",
                            "Номер сделки МБК",
                            "Дата привл/разм. МБК",
                            "Процентная ставка"
                           );
        elif (TParameters().m_isSecuritiesData)
            printStringImpl("Бэк-офис",
                            "Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению",
                            "Номер сделки Securities",
                            "Дата заключения Securities",
                            "Процентная ставка",
                            "Тип сделки Securities"
                           );
        else
            printStringImpl("Бэк-офис",
                            "Номер счета",
                            "Наименование счета",
                            "Входящий остаток",
                            "Оборот Дт",
                            "Оборот Кт",
                            "Исходящий остаток",
                            "Номер л/с по обременению",
                            "Код и наименование субъекта по обременению"
                           );
        end;
    end;

    macro printString(data : Object)
        var onerousClaim = trim(NVL(data.t_identifier, "") + ternary(data.t_identifier != "", " ", "") + NVL(data.t_onerousClaim,""));

        if (TParameters().m_isSecuritiesData)
            printStringImpl(NVL(data.t_backOffice,         ""),
                            data.t_account,
                            data.t_name,
                            NVL(data.t_beginRest,          ""),
                            NVL(data.t_debet,              ""),
                            NVL(data.t_credit,             ""),
                            NVL(data.t_endRest,            ""),
                            NVL(data.t_linkedAccount,      ""),
                            onerousClaim,
                            NVL(data.t_number,             ""),
                            NVL(data.t_startDate,          ""),
                            NVL(data.t_rate,               ""),
                            NVL(data.t_typeDealSecurities, "")
                           );
        elif ((TParameters().m_isMmData) and not (TParameters().m_isSecuritiesData))
            printStringImpl(data.backOffice,
                            data.t_account,
                            data.t_name,
                            NVL(data.t_beginRest, ""),
                            NVL(data.t_debet,     ""),
                            NVL(data.t_credit,    ""),
                            NVL(data.t_endRest,   ""),
                            data.t_linkedAccount,
                            onerousClaim,
                            data.t_number,
                            NVL(data.t_startDate, ""),
                            NVL(data.t_rate,      "")
                           );
        else
            printStringImpl(data.backOffice,
                            data.t_account,
                            data.t_name,
                            NVL(data.t_beginRest,     ""),
                            NVL(data.t_debet,         ""),
                            NVL(data.t_credit,        ""),
                            NVL(data.t_endRest,       ""),
                            NVL(data.t_linkedAccount, ""),
                            onerousClaim
                           );
        end;
    end;

    private macro ctorTF501DataProtocolViewAcc5456(id : String)
        initTF501DataProtocolViewAccI4212(id);
    end;

    ctorTF501DataProtocolViewAcc5456(id);
end;

private class (TF501DataProtocolViewBase) TF501DataProtocolViewExcludedAcc5456(id : String) 
    macro printHead()
        printStringImpl("Раздел",
                        "Бэк-офис",
                        "Номер счета",
                        "Наименование счета",
                        "Входящий остаток",
                        "Оборот Дт",
                        "Оборот Кт",
                        "Исходящий остаток",
                        "Комментарий"
                       );
    end;

    macro printString(data : Object)
        printStringImpl(data.t_part,
                        data.t_backOffice,
                        data.t_account,
                        data.t_name,
                        NVL(data.t_beginRest,          "0.00"),
                        NVL(data.t_debet,              "0.00"),
                        NVL(data.t_credit,             "0.00"),
                        NVL(data.t_endRest,            "0.00"),
                        data.t_comment
                       );
    end;

    private macro ctorTF501DataProtocolViewExcludedAcc5456(id : String)
        initTF501DataProtocolViewBase(id);
    end;

    ctorTF501DataProtocolViewExcludedAcc5456(id);
end;

private class (TF501DataProtocolViewBase) TF501DataProtocolViewDocI4212(id : String)
    macro printHead()
        printStringImpl("Дата документа",
                        "№ документа",
                        "Счет Дт",
                        "Счет Кт",
                        "Сумма документа в рублях"
                       );
    end;

    macro printString(data : Object)
        printStringImpl(data.t_date,
                        data.t_number,
                        data.t_debetAccount,
                        data.t_creditAccount,
                        data.t_incoversum
                       );
    end;

    private macro ctorTF501DataProtocolViewDocI4212(id : String)
        initTF501DataProtocolViewBase(id);
    end;

    ctorTF501DataProtocolViewDocI4212(id);
end;

class (RcbCalculateProtocolView) TF501CalculateProtocolViewI4212(protocolName : String)
    private macro initialize()
        m_dataProtocolViewPull.push_back(TF501DataProtocolViewAccI4212("acc"));
        m_dataProtocolViewPull.push_back(TF501DataProtocolViewDocI4212("doc"));
    end;

    macro printHead()
        printHead();

        printServiceLine("Значения настроек, используемых при расчете:");
        printServiceLine("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК    " + ternary(TParameters().m_isMmData == true, "YES", "NO"));
        printServiceLine("");
    end;

    macro saveCsv()
        for (var dataProtocol, m_dataProtocolViewPull)
            dataProtocol.save();
        end;
    end;

    private macro ctorTF501CalculateProtocolViewI4212(protocolName : String)
        initRcbCalculateProtocolView(null, protocolName);
    end;

    ctorTF501CalculateProtocolViewI4212(protocolName);
end;

class (RcbCalculateProtocolView) TF501CalculateProtocolView5456(protocolName : String)
    private macro initialize()
        m_dataProtocolViewPull.push_back(TF501DataProtocolViewAcc5456("acc"));
        m_dataProtocolViewPull.push_back(TF501DataProtocolViewDocI4212("doc"));
        if (isNeedExcludedAccProtocol())
            m_dataProtocolViewPull.push_back(TF501DataProtocolViewExcludedAcc5456("excludedAcc"));
        end;
    end;

    macro printHead()
        printHead();
        
        printServiceLine("Значения настроек, используемых при расчете:");
        printServiceLine("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ МБК           " + ternary(TParameters().m_isMmData         == true, "YES", "NO"));
        printServiceLine("REPTREG\\REP_GROUPS\\ФОРМА 501\\ДАННЫЕ SECURITIES    " + ternary(TParameters().m_isSecuritiesData == true, "YES", "NO"));
        printServiceLine("");
    end;

    macro saveCsv()
        for (var dataProtocol, m_dataProtocolViewPull)
            dataProtocol.save();
        end;
    end;

    private macro ctorTF501CalculateProtocolView5456(protocolName : String)
        initRcbCalculateProtocolView(null, protocolName);
    end;

    ctorTF501CalculateProtocolView5456(protocolName);
end;

class (TProtocol) TF501CalculationProtocolI4212()
    private var m_view;

    macro printForManualInput(iPart, header, partName)
        m_view.printLine("Информация об ошибках в данных пользовательского ввода в разделе " + iPart + ". " + header + ".");
        var hasErrors = false;
        var compositeValue = RcbApplication().currentReport.attributeValue(partName).createValueIterator();
        compositeValue.moveFirst();
        while (not compositeValue.isDone())
            var isExistsCode = false;
            var codeClient = compositeValue.currentItem.fieldValue("КодКлиента_ввод").currentAsString;
            var dataSet = TRsbDataSet("SELECT codes.t_partyId"
                             + "\n" + "  FROM dRepPartyCodes_vw codes"
                             + "\n" + " WHERE codes.t_name = " + getSqlString("Код")
                             + "\n" + "   AND codes.t_code = " + getSqlString(codeClient)
                                     );

            isExistsCode = dataSet.next();

            if (isExistsCode)
                if (   not compositeValue.currentItem.fieldValue("НомЛС_ввод").isDefined()
                    or (compositeValue.currentItem.fieldValue("НомЛС_ввод").current == "")
                   )
                    m_view.printLine("\tДля клиента " + codeClient + " не введен номер лицевого счета");
                    hasErrors = true;
                end;

                if (   not compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").isDefined()
                    or (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current == "")
                   )
                    m_view.printLine("\tДля клиента " + codeClient + " не введена дата исполнения обязательства");
                    hasErrors = true;
                elif (    (Date(compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current) == "")
                      and (compositeValue.currentItem.fieldValue("ДатаИспОб_ввод").current != "д/в")
                     )
                    m_view.printLine("\tДля клиента " + codeClient + " указан неправильный формат даты исполнения обязательства");
                    hasErrors = true;
                end;

                if (   not compositeValue.currentItem.fieldValue("НомБС_ввод").isDefined()
                    or (compositeValue.currentItem.fieldValue("НомБС_ввод").current == "")
                   )
                    m_view.printLine("\tДля клиента " + codeClient + " не введен номер балансового счета");
                    hasErrors = true;
                end;

                if (    compositeValue.currentItem.fieldValue("ххх_ввод").isDefined()
                    and (compositeValue.currentItem.fieldValue("ххх_ввод").current != "***")
                   )
                    var acc = ternary(compositeValue.currentItem.fieldValue("НомЛС_ввод").isDefined(),
                                      compositeValue.currentItem.fieldValue("НомЛС_ввод").current,
                                      "<номер счета не указан>"
                                     );
                    m_view.printLine("\tОшибка. Для лицевого счета ЛОРО/НОСТРО " + acc + " задано неверное значение переменной <ххх_ввод>."
                            + "\n" + "\t        Переменная может содержать символы <***> или иметь неопределенное значение"
                                    );
                    hasErrors = true;
                end;
            else
                if (not compositeValue.currentItem.fieldValue("КодКлиента_ввод").isDefined())
                    m_view.printLine("\tНе заполнен код клиента.");
                else
                    m_view.printLine("\tВведенный код клиента " + codeClient + " отсутствует в справочнике субъектов, проверьте корректность введенного кода.");
                end;
                hasErrors = true;
            end;
            compositeValue.moveNext();
        end;
        if (not hasErrors)
            m_view.printLine("\tОшибок нет.");
        end;
    end;

    private macro createManualInputProtocol()
        printForManualInput(1, "Счета ЛОРО",   "Ф501_1ввод");
        m_view.printLine("");
        printForManualInput(2, "Счета НОСТРО", "Ф501_2ввод");
    end;

    private macro createDataProtocol()
        var queryText;

        if (TParameters().m_isMmData)
            queryText = "WITH mmDeals AS"
               + "\n" + "("
               + "\n" + "    SELECT deals.t_id,"
               + "\n" + "           deals.t_number,"
               + "\n" + "           deals.t_mainRestAccount,"
               + "\n" + "           deals.t_delaydMainRestAcc,"
               + "\n" + "           deals.t_plannedFinishDate,"
               + "\n" + "           deals.t_isOverNight,"
               + "\n" + "           deals.t_kind,"
               + "\n" + "           deals.t_contragentId,"
               + "\n" + "           deals.t_isProlongingDeal,"
               + "\n" + "           CASE deals.t_kind"
               + "\n" + "               WHEN 'Размещение ' THEN 1"
               + "\n" + "               WHEN 'Привлечение' THEN 2"
               + "\n" + "               ELSE 0"
               + "\n" + "           END t_part,"
               + "\n" + "           deals.t_startDate,"
               + "\n" + "           (SELECT rateHistory.t_rate"
               + "\n" + "              FROM repMmDealRateHistory_vw rateHistory"
               + "\n" + "             WHERE rateHistory.t_dealId = deals.t_id"
               + "\n" + "               AND rateHistory.t_percentKind = 7"
               + "\n" + "               AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
               + "\n" + "                                               FROM repMmDealRateHistory_vw rh"
               + "\n" + "                                              WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                                AND rh.t_percentKind = 7"
               + "\n" + "                                                AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                            )"
               + "\n" + "             GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "           ) t_rate"
               + "\n" + "      FROM repMmDeals_vw deals"
               + "\n" + "     WHERE deals.t_kind IN ('Размещение ', 'Привлечение')"
               + "\n" + "       AND deals.t_isOpened = 1"
               + "\n" + "),"
               + "\n" + "perfomanceDateDeals AS"
               + "\n" + "("
               + "\n" + "    SELECT f501.t_account,"
               + "\n" + "           NVL((SELECT account.t_name"
               + "\n" + "                  FROM drepaccount_vw account"
               + "\n" + "                 WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "               ), CHR(1)"
               + "\n" + "              ) AS t_name,"
               + "\n" + "           f501.t_beginRest,"
               + "\n" + "           f501.t_debet,"
               + "\n" + "           f501.t_credit,"
               + "\n" + "           f501.t_endRest,"
               + "\n" + "           NVL(f501.t_linkedAccount, CHR(1)) AS t_linkedAccount,"
               + "\n" + "           f501.t_identifier,"
               + "\n" + "           f501.t_onerousClaim,"
               + "\n" + "           NVL(deal.t_number, CHR(1)) AS t_number,"
               + "\n" + "           deal.t_startDate,"
               + "\n" + "           deal.t_rate,"
               + "\n" + "           deal.t_id AS t_mainDealId,"
               + "\n" + "           deal.t_id,"
               + "\n" + "           0 t_orderFlag"
               + "\n" + "      FROM df501_tmp f501,"
               + "\n" + "           mmDeals deal"
               + "\n" + "     WHERE f501.t_perfomanceDateDealId = deal.t_id(+)"
               + "\n" + ")"
               + "\n" + "SELECT deal.t_account,"
               + "\n" + "       deal.t_name,"
               + "\n" + "       deal.t_beginRest,"
               + "\n" + "       deal.t_debet,"
               + "\n" + "       deal.t_credit,"
               + "\n" + "       deal.t_endRest,"
               + "\n" + "       deal.t_linkedAccount,"
               + "\n" + "       deal.t_identifier,"
               + "\n" + "       deal.t_onerousClaim,"
               + "\n" + "       deal.t_number,"
               + "\n" + "       deal.t_startDate,"
               + "\n" + "       deal.t_rate,"
               + "\n" + "       deal.t_mainDealId,"
               + "\n" + "       deal.t_id,"
               + "\n" + "       deal.t_orderFlag"
               + "\n" + "  FROM perfomanceDateDeals deal"
               + "\n" + " UNION ALL"
               + "\n" + "SELECT f501.t_account,"
               + "\n" + "       NVL((SELECT account.t_name"
               + "\n" + "              FROM drepaccount_vw account"
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)"
               + "\n" + "          ) t_name,"
               + "\n" + "       NULL t_begRest,"
               + "\n" + "       NULL t_debet,"
               + "\n" + "       NULL t_credit,"
               + "\n" + "       NULL t_endRest,"
               + "\n" + "       CHR(1) t_linkedAccount,"
               + "\n" + "       CHR(1) t_identifier,"
               + "\n" + "       CHR(1) t_onerousClaim,"
               + "\n" + "       deal.t_number,"
               + "\n" + "       deal.t_startDate,"
               + "\n" + "       (SELECT rateHistory.t_rate"
               + "\n" + "          FROM repMmDealRateHistory_vw rateHistory"
               + "\n" + "         WHERE rateHistory.t_dealId = deal.t_id"
               + "\n" + "           AND rateHistory.t_percentKind = 7"
               + "\n" + "           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
               + "\n" + "                                           FROM repMmDealRateHistory_vw rh"
               + "\n" + "                                          WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                            AND rh.t_percentKind = 7"
               + "\n" + "                                            AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                        )"
               + "\n" + "         GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "       ) t_rate,"
               + "\n" + "       overnightDeal.t_id AS t_mainDealId,"
               + "\n" + "       deal.t_id,"
               + "\n" + "       CASE"
               + "\n" + "           WHEN overnightDeal.t_id = deal.t_id THEN 0"
               + "\n" + "           ELSE 1"
               + "\n" + "       END t_orderFlag"
               + "\n" + "  FROM df501_tmp f501,"
               + "\n" + "       mmDeals overnightDeal,"
               + "\n" + "       repMmDeals_vw deal"
               + "\n" + " WHERE overnightDeal.t_isOvernight = 1"
               + "\n" + "   AND overnightDeal.t_isOvernight = deal.t_isOvernight"
               + "\n" + "   AND f501.t_rateDealId = overnightDeal.t_id"
               + "\n" + "   AND deal.t_kind = overnightDeal.t_kind"
               + "\n" + "   AND (   (overnightDeal.t_mainRestAccount = deal.t_mainRestAccount)"
               + "\n" + "        OR (overnightDeal.t_delaydMainRestAcc = deal.t_delaydMainRestAcc)"
               + "\n" + "       )"
               + "\n" + "   AND deal.t_contragentId = overnightDeal.t_contragentId"
               + "\n" + "   AND (   deal.t_openDate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "                               AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "        OR (    deal.t_openDate < " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "            AND " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + " <= deal.t_closeDate"
               + "\n" + "           )"
               + "\n" + "       )"
               + "\n" + "   AND NOT EXISTS (SELECT 1"
               + "\n" + "                     FROM perfomanceDateDeals"
               + "\n" + "                    WHERE overnightDeal.t_id = deal.t_id"
               + "\n" + "                      AND perfomanceDateDeals.t_mainDealId = overnightDeal.t_id"
               + "\n" + "                  )"
               + "\n" + " UNION ALL"
               + "\n" + "SELECT prolongingDeal.t_account,"
               + "\n" + "       prolongingDeal.t_name,"
               + "\n" + "       NULL t_begRest,"
               + "\n" + "       NULL t_debet,"
               + "\n" + "       NULL t_credit,"
               + "\n" + "       NULL t_endRest,"
               + "\n" + "       CHR(1) t_linkedAccount,"
               + "\n" + "       CHR(1) t_identifier,"
               + "\n" + "       CHR(1) t_onerousClaim,"
               + "\n" + "       deal.t_number,"
               + "\n" + "       deal.t_startDate,"
               + "\n" + "       (SELECT rateHistory.t_rate"
               + "\n" + "          FROM repMmDealRateHistory_vw rateHistory"
               + "\n" + "         WHERE rateHistory.t_dealId = deal.t_id"
               + "\n" + "           AND rateHistory.t_percentKind = 7"
               + "\n" + "           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
               + "\n" + "                                           FROM repMmDealRateHistory_vw rh"
               + "\n" + "                                          WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                            AND rh.t_percentKind = 7"
               + "\n" + "                                            AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                        )"
               + "\n" + "         GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "       ) t_rate,"
               + "\n" + "       prolongingDeal.t_id AS t_mainDealId,"
               + "\n" + "       deal.t_id,"
               + "\n" + "       CASE"
               + "\n" + "           WHEN prolongingDeal.t_id = deal.t_id THEN 0"
               + "\n" + "           ELSE 1"
               + "\n" + "       END t_orderFlag"
               + "\n" + "  FROM (SELECT f501.t_account,"
               + "\n" + "               NVL((SELECT account.t_name"
               + "\n" + "                      FROM drepaccount_vw account"
               + "\n" + "                     WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "                   ), CHR(1)"
               + "\n" + "                  ) t_name,"
               + "\n" + "               mmDeals.t_id,"
               + "\n" + "               mmDeals.t_mainRestAccount"
               + "\n" + "          FROM mmDeals,"
               + "\n" + "               df501_tmp f501"
               + "\n" + "         WHERE mmDeals.t_isOvernight != 1"
               + "\n" + "           AND mmDeals.t_isProlongingDeal = 'YES'"
               + "\n" + "           AND f501.t_rateDealId = mmDeals.t_id"
               + "\n" + "       ) prolongingDeal,"
               + "\n" + "       repMmDeals_vw deal"
               + "\n" + " WHERE (   (   deal.t_openDate < " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "            AND " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + " <= deal.t_closeDate"
               + "\n" + "           )"
               + "\n" + "        OR deal.t_openDate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "                               AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "       )"
               + "\n" + "   AND deal.t_mainRestAccount = prolongingDeal.t_mainRestAccount"
               + "\n" + "   AND NOT EXISTS (SELECT 1"
               + "\n" + "                     FROM perfomanceDateDeals"
               + "\n" + "                    WHERE prolongingDeal.t_id = deal.t_id"
               + "\n" + "                      AND perfomanceDateDeals.t_mainDealId = prolongingDeal.t_id"
               + "\n" + "                  )"
               + "\n" + "CONNECT BY PRIOR deal.t_id = deal.t_prolongingDealId"
               + "\n" + " START WITH deal.t_id = prolongingDeal.t_id"
               + "\n" + " ORDER BY t_account,"
               + "\n" + "          t_mainDealId,"
               + "\n" + "          t_orderFlag,"
               + "\n" + "          t_id"
               ;
        else
            queryText = "SELECT f501.t_account,"
               + "\n" + "       NVL((SELECT account.t_name"
               + "\n" + "              FROM drepaccount_vw account"
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)"
               + "\n" + "          ) t_name,"
               + "\n" + "       f501.t_beginRest,"
               + "\n" + "       f501.t_debet,"
               + "\n" + "       f501.t_credit,"
               + "\n" + "       f501.t_endRest,"
               + "\n" + "       f501.t_linkedAccount,"
               + "\n" + "       f501.t_identifier,"
               + "\n" + "       f501.t_onerousClaim,"
               + "\n" + "       NULL t_number,"
               + "\n" + "       NULL t_startDate,"
               + "\n" + "       NULL t_rate"
               + "\n" + "  FROM df501_tmp f501"
               + "\n" + " ORDER BY f501.t_account"
               ;
        end;

        var dataView;
        dataView = m_view.getDataProtocolView("acc");
        var dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_account", V_STRING);
        dataset.setFieldType("t_name", V_STRING);
        dataset.setFieldType("t_beginRest", V_MONEY);
        dataset.setFieldType("t_debet", V_MONEY);
        dataset.setFieldType("t_credit", V_MONEY);
        dataset.setFieldType("t_endRest", V_MONEY);
        dataset.setFieldType("t_linkedAccount", V_STRING);
        dataset.setFieldType("t_identifier", V_STRING);
        dataset.setFieldType("t_onerousClaim", V_STRING);
        dataset.setFieldType("t_number", V_STRING);
        dataset.setFieldType("t_startDate", V_DATE);
        dataset.setFieldType("t_rate", V_MONEY);
        if (dataset.next())
            dataView.printHead();
            dataView.printString(dataset);
        end;
        while (dataset.next())
            dataView.printString(dataset);
        end;

        queryText = "SELECT doc.t_date          AS t_date,         "
           + "\n" + "       doc.t_number        AS t_number,       "
           + "\n" + "       doc.t_debetAccount  AS t_debetAccount, "
           + "\n" + "       doc.t_creditAccount AS t_creditAccount,"
           + "\n" + "       doc.t_incoversum    AS t_incoversum,   "
           + "\n" + "       0                   AS t_orderFlag     "
           + "\n" + "  FROM df501_tmp f501,                        "
           + "\n" + "       drepdocumentwithcorrection_vw doc      "
           + "\n" + " WHERE doc.t_debetAccountId = f501.t_accountId"
           + "\n" + "   AND doc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + " UNION ALL                                    "
           + "\n" + "SELECT doc.t_date,                            "
           + "\n" + "       doc.t_number,                          "
           + "\n" + "       doc.t_debetAccount,                    "
           + "\n" + "       doc.t_creditAccount,                   "
           + "\n" + "       doc.t_incoversum,                      "
           + "\n" + "       1                                      "
           + "\n" + "  FROM df501_tmp f501,                        "
           + "\n" + "       drepdocumentwithcorrection_vw doc      "
           + "\n" + " WHERE doc.t_creditAccountId = f501.t_accountId"
           + "\n" + "   AND NOT EXISTS (SELECT 1                                            "
           + "\n" + "                     FROM df501_tmp                     tmpf501,       "
           + "\n" + "                          drepdocumentwithcorrection_vw tmpDoc         "
           + "\n" + "                    WHERE tmpDoc.t_debetAccountId = tmpf501.t_accountId"
           + "\n" + "                      AND tmpDoc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                                            AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + "                      AND tmpDoc.t_id             = doc.t_id)          "
           + "\n" + "   AND doc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + " ORDER BY t_orderFlag,                        "
           + "\n" + "          t_date,                             "
           + "\n" + "          t_number                            "
                  ;

        dataView = m_view.getDataProtocolView("doc");
        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_date", V_DATE);
        dataset.setFieldType("t_number", V_STRING);
        dataset.setFieldType("t_debetAccount", V_STRING);
        dataset.setFieldType("t_creditAccount", V_STRING);
        dataset.setFieldType("t_incoversum", V_MONEY);
        if (dataset.next())
            dataView.printHead();
            dataView.printString(dataset);
        end;
        while (dataset.next())
            dataView.printString(dataset);
        end;
    end;

    private macro finishImpl()
        finishImpl();
        m_view.saveCsv();
    end;

    private macro printImpl()
        createManualInputProtocol();
        m_view.printLine("");
        createDataProtocol();
        m_view.printLine("Информация о счетах и сделках: " + m_view.getDataProtocolView("acc").getFileName());
        m_view.printLine("Информация о проводках: " + m_view.getDataProtocolView("doc").getFileName());
        m_view.printСsvInExcelInstructions();
    end;

    macro show()
        showProtocol();
    end;

    private macro ctorTF501CalculationProtocolI4212()
        initTProtocol(TF501CalculateProtocolViewI4212());
        m_view = view();
    end;

    ctorTF501CalculationProtocolI4212()
end;

class (TF501CalculationProtocolI4212) TF501CalculationProtocol5456()

    private macro createDataProtocol()
        var queryText;

        if (TParameters().m_isMmData)
            queryText = "WITH mmDeals AS                                       "
               + "\n" + "(                                                     "
               + "\n" + "    SELECT deals.t_id,                                "
               + "\n" + "           deals.t_number,                            "
               + "\n" + "           deals.t_mainRestAccount,                   "
               + "\n" + "           deals.t_delaydMainRestAcc,                 "
               + "\n" + "           deals.t_plannedFinishDate,                 "
               + "\n" + "           deals.t_isOverNight,                       "
               + "\n" + "           deals.t_kind,                              "
               + "\n" + "           deals.t_contragentId,                      "
               + "\n" + "           deals.t_isProlongingDeal,                  "
               + "\n" + "           CASE deals.t_kind                          "
               + "\n" + "               WHEN 'Размещение ' THEN 1              "
               + "\n" + "               WHEN 'Привлечение' THEN 2              "
               + "\n" + "               ELSE 0                                 "
               + "\n" + "           END t_part,                                "
               + "\n" + "           deals.t_startDate,                         "
               + "\n" + "           (SELECT rateHistory.t_rate                 "
               + "\n" + "              FROM repMmDealRateHistory_vw rateHistory"
               + "\n" + "             WHERE rateHistory.t_dealId = deals.t_id  "
               + "\n" + "               AND rateHistory.t_percentKind = 7      "
               + "\n" + "               AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
               + "\n" + "                                               FROM repMmDealRateHistory_vw rh        "
               + "\n" + "                                              WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                                AND rh.t_percentKind = 7              "
               + "\n" + "                                                AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                            )                                         "
               + "\n" + "             GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "           ) t_rate                                   "
               + "\n" + "      FROM repMmDeals_vw deals                        "
               + "\n" + "     WHERE deals.t_kind IN ('Размещение ', 'Привлечение')"
               + "\n" + "       AND deals.t_isOpened = 1                       "
               + "\n" + "),                                                    "
               + "\n" + "accounts AS                                           "
               + "\n" + "(                                                               "
               + "\n" + "    SELECT f501.t_account,                                      "
               + "\n" + "           NVL((SELECT account.t_name                           "
               + "\n" + "                  FROM drepaccount_vw account                   "
               + "\n" + "                 WHERE f501.t_accountId = account.t_accountId   "
               + "\n" + "               ), CHR(1)                                        "
               + "\n" + "              )                              AS t_name,         "
               + "\n" + "           f501.t_beginRest,                                    "
               + "\n" + "           f501.t_debet,                                        "
               + "\n" + "           f501.t_credit,                                       "
               + "\n" + "           f501.t_endRest,                                      "
               + "\n" + "           NVL(f501.t_linkedAccount, CHR(1)) AS t_linkedAccount,"
               + "\n" + "           f501.t_identifier,                                   "
               + "\n" + "           f501.t_onerousClaim,                                 "
               + "\n" + "           NVL(deal.t_number, CHR(1))        AS t_number,       "
               + "\n" + "           deal.t_startDate,                                    "
               + "\n" + "           deal.t_rate,                                         "
               + "\n" + "           deal.t_id                         AS t_mainDealId,   "
               + "\n" + "           deal.t_id,                                           "
               + "\n" + "           f501.t_isSecurities,                                 "
               + "\n" + "           f501.t_part,                                         "
               + "\n" + "           0                                 AS t_orderFlag     "
               + "\n" + "      FROM df501_tmp f501,                                      "
               + "\n" + "           mmDeals   deal                                       "
               + "\n" + "     WHERE f501.t_perfomanceDateDealId = deal.t_id(+)           "
               + "\n" + "       AND f501.t_isExcludedAcc        = 0                      "
               + "\n" + ")                                                               ";

            if (TParameters().m_isSecuritiesData)
                queryText = queryText
               + "\n" + "SELECT CASE                                                         "
               + "\n" + "           WHEN acc.t_isSecurities = 1                              "
               + "\n" + "               THEN 'Securities'                                    "
               + "\n" + "           ELSE CASE                                                "
               + "\n" + "                    WHEN acc.t_number != CHR(1)                     "
               + "\n" + "                        THEN 'МБК'                                  "
               + "\n" + "                    ELSE 'ГК'                                       "
               + "\n" + "                END                                                 "
               + "\n" + "       END                                          t_backOffice,   "
               + "\n" + "       acc.t_account,                                               "
               + "\n" + "       acc.t_name,                                                  "
               + "\n" + "       acc.t_beginRest,                                             "
               + "\n" + "       acc.t_debet,                                                 "
               + "\n" + "       acc.t_credit,                                                "
               + "\n" + "       acc.t_endRest,                                               "
               + "\n" + "       acc.t_linkedAccount,                                         "
               + "\n" + "       acc.t_identifier,                                            "
               + "\n" + "       acc.t_onerousClaim,                                          "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN acc.t_isSecurities = 1                              "
               + "\n" + "               THEN (SELECT securitiesAcc.t_dealNumber              "
               + "\n" + "                       FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                      WHERE securitiesAcc.t_account = acc.t_account "
               + "\n" + "                        AND ROWNUM = 1)                             "
               + "\n" + "           ELSE acc.t_number                                        "
               + "\n" + "       END                                          t_number,       "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN acc.t_isSecurities = 1                              "
               + "\n" + "               THEN (SELECT securitiesAcc.t_openDate                "
               + "\n" + "                       FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                      WHERE securitiesAcc.t_account = acc.t_account "
               + "\n" + "                        AND ROWNUM = 1)                             "
               + "\n" + "           ELSE acc.t_startDate                                     " 
               + "\n" + "       END                                          t_startDate,    "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN acc.t_isSecurities = 1                              "
               + "\n" + "               THEN CASE                                            "
               + "\n" + "                        WHEN acc.t_part <> 3                        "
               + "\n" + "                            THEN (SELECT securitiesAcc.t_rate       "
               + "\n" + "                                    FROM repSecuritiesAccounts_vw securitiesAcc "
               + "\n" + "                                   WHERE securitiesAcc.t_account = acc.t_account"
               + "\n" + "                                     AND ROWNUM = 1)                "
               + "\n" + "                        ELSE NULL                                   "
               + "\n" + "                    END                                             "
               + "\n" + "           ELSE acc.t_rate                                          "
               + "\n" + "       END                                          t_rate,         "
               + "\n" + "       acc.t_mainDealId,                                            "
               + "\n" + "       acc.t_id,                                                    "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN acc.t_isSecurities = 1                              "
               + "\n" + "               THEN CASE                                            "
               + "\n" + "                        WHEN EXISTS (SELECT 1                       "
               + "\n" + "                                FROM repSecuritiesAccounts_vw securitiesAcc    "
               + "\n" + "                               WHERE securitiesAcc.t_account    = acc.t_account"
               + "\n" + "                                 AND securitiesAcc.t_isDebtRepo = 'YES'        "
               + "\n" + "                                 AND ROWNUM = 1)                    "
               + "\n" + "                            THEN 'РЕПО'                             "
               + "\n" + "                        ELSE 'CSA'                                  "
               + "\n" + "                    END                                             "
               + "\n" + "           ELSE NULL                                                "
               + "\n" + "       END                                          t_typeDealSecurities,"
               + "\n" + "       acc.t_orderFlag                                              ";
            else
                queryText = queryText
               + "\n" + "SELECT CASE                       "
               + "\n" + "           WHEN acc.t_number != CHR(1)"
               + "\n" + "               THEN 'МБК'         "
               + "\n" + "           ELSE 'ГК'              "
               + "\n" + "       END t_backOffice,          "
               + "\n" + "       acc.t_account,             "
               + "\n" + "       acc.t_name,                "
               + "\n" + "       acc.t_beginRest,           "
               + "\n" + "       acc.t_debet,               "
               + "\n" + "       acc.t_credit,              "
               + "\n" + "       acc.t_endRest,             "
               + "\n" + "       acc.t_linkedAccount,       "
               + "\n" + "       acc.t_identifier,          "
               + "\n" + "       acc.t_onerousClaim,        "
               + "\n" + "       acc.t_number,              "
               + "\n" + "       acc.t_startDate,           "
               + "\n" + "       acc.t_rate,                "
               + "\n" + "       acc.t_mainDealId,          "
               + "\n" + "       acc.t_id,                  "
               + "\n" + "       NULL t_typeDealSecurities, "
               + "\n" + "       acc.t_orderFlag            ";
            end;

            queryText = queryText
               + "\n" + "  FROM accounts acc                                      "
               + "\n" + " UNION ALL                                               "
               + "\n" + "SELECT NULL                              t_backOffice,   "
               + "\n" + "       f501.t_account,                                   "
               + "\n" + "       NVL((SELECT account.t_name                        "
               + "\n" + "              FROM drepaccount_vw account                "
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)                                     "
               + "\n" + "          )                              t_name,         "
               + "\n" + "       NULL                              t_begRest,      "
               + "\n" + "       NULL                              t_debet,        "
               + "\n" + "       NULL                              t_credit,       "
               + "\n" + "       NULL                              t_endRest,      "
               + "\n" + "       CHR(1)                            t_linkedAccount,"
               + "\n" + "       CHR(1)                            t_identifier,   "
               + "\n" + "       CHR(1)                            t_onerousClaim, "
               + "\n" + "       deal.t_number,                                    "
               + "\n" + "       deal.t_startDate,                                 "
               + "\n" + "       (SELECT rateHistory.t_rate                        "
               + "\n" + "          FROM repMmDealRateHistory_vw rateHistory       "
               + "\n" + "         WHERE rateHistory.t_dealId = deal.t_id          "
               + "\n" + "           AND rateHistory.t_percentKind = 7             "
               + "\n" + "           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
               + "\n" + "                                           FROM repMmDealRateHistory_vw rh        "
               + "\n" + "                                          WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                            AND rh.t_percentKind = 7              "
               + "\n" + "                                            AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                        )                                         "
               + "\n" + "         GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "       )                                 t_rate,         "
               + "\n" + "       overnightDeal.t_id             AS t_mainDealId,   "
               + "\n" + "       deal.t_id,                                        "
               + "\n" + "       NULL                              t_typeDealSecurities,"
               + "\n" + "       CASE                                              "
               + "\n" + "           WHEN overnightDeal.t_id = deal.t_id           "
               + "\n" + "           THEN 0                                        "
               + "\n" + "           ELSE 1                                        "
               + "\n" + "       END                               t_orderFlag     "
               + "\n" + "  FROM df501_tmp     f501,                               "
               + "\n" + "       mmDeals       overnightDeal,                      "
               + "\n" + "       repMmDeals_vw deal                                "
               + "\n" + " WHERE overnightDeal.t_isOvernight = 1                   "
               + "\n" + "   AND overnightDeal.t_isOvernight = deal.t_isOvernight  "
               + "\n" + "   AND f501.t_isExcludedAcc        = 0                   "
               + "\n" + "   AND f501.t_rateDealId           = overnightDeal.t_id  "
               + "\n" + "   AND deal.t_kind                 = overnightDeal.t_kind"
               + "\n" + "   AND (   (overnightDeal.t_mainRestAccount   = deal.t_mainRestAccount)  "
               + "\n" + "        OR (overnightDeal.t_delaydMainRestAcc = deal.t_delaydMainRestAcc)"
               + "\n" + "       )                                                                 "
               + "\n" + "   AND deal.t_contragentId = overnightDeal.t_contragentId                "
               + "\n" + "   AND (   deal.t_openDate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "                               AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "        OR (    deal.t_openDate < " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "            AND " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + " <= deal.t_closeDate"
               + "\n" + "           )                                                             "
               + "\n" + "       )                                                                 "
               + "\n" + "   AND NOT EXISTS (SELECT 1                                         "
               + "\n" + "                     FROM accounts                                  "
               + "\n" + "                    WHERE overnightDeal.t_id    = deal.t_id         "
               + "\n" + "                      AND accounts.t_mainDealId = overnightDeal.t_id"
               + "\n" + "                  )                                                 "
               + "\n" + " UNION ALL                                                        "
               + "\n" + "SELECT 'МБК'                                     t_backOffice,    "
               + "\n" + "       prolongingDeal.t_account,                                  "
               + "\n" + "       prolongingDeal.t_name,                                     "
               + "\n" + "       NULL                                      t_begRest,       "
               + "\n" + "       NULL                                      t_debet,         "
               + "\n" + "       NULL                                      t_credit,        "
               + "\n" + "       NULL                                      t_endRest,       "
               + "\n" + "       CHR(1)                                    t_linkedAccount, "
               + "\n" + "       CHR(1)                                    t_identifier,    "
               + "\n" + "       CHR(1)                                    t_onerousClaim,  "
               + "\n" + "       deal.t_number,                                             "
               + "\n" + "       deal.t_startDate,                                          "
               + "\n" + "       (SELECT rateHistory.t_rate                                 "
               + "\n" + "          FROM repMmDealRateHistory_vw rateHistory                "
               + "\n" + "         WHERE rateHistory.t_dealId      = deal.t_id              "
               + "\n" + "           AND rateHistory.t_percentKind = 7                      "
               + "\n" + "           AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)                "
               + "\n" + "                                           FROM repMmDealRateHistory_vw rh        "
               + "\n" + "                                          WHERE rh.t_dealId = rateHistory.t_dealId"
               + "\n" + "                                            AND rh.t_percentKind = 7              "
               + "\n" + "                                            AND rh.t_rateDate <= " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "                                        )                                         "
               + "\n" + "         GROUP BY rateHistory.t_dealId, rateHistory.t_rate --костыль для удаления нескольких записей в выборке"
               + "\n" + "       )                                         t_rate,          "
               + "\n" + "       prolongingDeal.t_id                    AS t_mainDealId,    "
               + "\n" + "       deal.t_id,                                                 "
               + "\n" + "       NULL                                      t_typeDealSecurities,"
               + "\n" + "       CASE                                                       "
               + "\n" + "           WHEN prolongingDeal.t_id = deal.t_id                   "
               + "\n" + "           THEN 0                                                 "
               + "\n" + "           ELSE 1                                                 "
               + "\n" + "       END                                       t_orderFlag      "
               + "\n" + "  FROM (SELECT f501.t_account,                                    "
               + "\n" + "               NVL((SELECT account.t_name                         "
               + "\n" + "                      FROM drepaccount_vw account                 "
               + "\n" + "                     WHERE f501.t_accountId = account.t_accountId "
               + "\n" + "                   ), CHR(1)                                      "
               + "\n" + "                  ) t_name,                                       "
               + "\n" + "               mmDeals.t_id,                                      "
               + "\n" + "               mmDeals.t_mainRestAccount                          "
               + "\n" + "          FROM mmDeals,                                           "
               + "\n" + "               df501_tmp f501                                     "
               + "\n" + "         WHERE mmDeals.t_isOvernight     != 1                     "
               + "\n" + "           AND f501.t_isExcludedAcc       = 0                     "
               + "\n" + "           AND mmDeals.t_isProlongingDeal = 'YES'                 "
               + "\n" + "           AND f501.t_rateDealId          = mmDeals.t_id          "
               + "\n" + "       ) prolongingDeal,                                          "
               + "\n" + "       repMmDeals_vw deal                                         "
               + "\n" + " WHERE (   (   deal.t_openDate < " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "            AND " + getSqlDate(RcbApplication().currentReport.context.period.beginDate) + " <= deal.t_closeDate"
               + "\n" + "           )                                                      "
               + "\n" + "        OR deal.t_openDate BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
               + "\n" + "                               AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
               + "\n" + "       )                                                          "
               + "\n" + "   AND deal.t_mainRestAccount = prolongingDeal.t_mainRestAccount  "
               + "\n" + "   AND NOT EXISTS (SELECT 1                                          "
               + "\n" + "                     FROM accounts                                   "
               + "\n" + "                    WHERE prolongingDeal.t_id   = deal.t_id          "
               + "\n" + "                      AND accounts.t_mainDealId = prolongingDeal.t_id"
               + "\n" + "                  )                                               "
               + "\n" + "CONNECT BY PRIOR deal.t_id = deal.t_prolongingDealId              "
               + "\n" + " START WITH deal.t_id      = prolongingDeal.t_id                  "
               + "\n" + " ORDER BY t_account,                                              "
               + "\n" + "          t_mainDealId,                                           "
               + "\n" + "          t_orderFlag,                                            "
               + "\n" + "          t_id                                                    "
               ;
        else
            if (TParameters().m_isSecuritiesData)
                queryText = 
                        "SELECT CASE                                              "
               + "\n" + "           WHEN f501.t_isSecurities = 1                  "
               + "\n" + "               THEN 'Securities'                         "
               + "\n" + "           ELSE 'ГК'                                     "
               + "\n" + "       END                                t_backOffice,  "
               + "\n" + "       f501.t_account,                                   "
               + "\n" + "       NVL((SELECT account.t_name                        "
               + "\n" + "              FROM drepaccount_vw account                "
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)                                     "
               + "\n" + "          ) t_name,                                      "
               + "\n" + "       f501.t_beginRest,                                 "
               + "\n" + "       f501.t_debet,                                     "
               + "\n" + "       f501.t_credit,                                    "
               + "\n" + "       f501.t_endRest,                                   "
               + "\n" + "       f501.t_linkedAccount,                             "
               + "\n" + "       f501.t_identifier,                                "
               + "\n" + "       f501.t_onerousClaim,                              "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN f501.t_isSecurities = 1                             "
               + "\n" + "               THEN (SELECT securitiesAcc.t_dealNumber              "
               + "\n" + "                       FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                      WHERE securitiesAcc.t_account = f501.t_account"
               + "\n" + "                        AND ROWNUM = 1)                             "
               + "\n" + "           ELSE NULL                                                "
               + "\n" + "       END                                t_number,                 "
               + "\n" + "       CASE                                                         "
               + "\n" + "           WHEN f501.t_isSecurities = 1                             "
               + "\n" + "               THEN (SELECT securitiesAcc.t_openDate                "
               + "\n" + "                       FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                      WHERE securitiesAcc.t_account = f501.t_account"
               + "\n" + "                        AND ROWNUM = 1)                             "
               + "\n" + "           ELSE NULL                                                "
               + "\n" + "       END                                t_startDate,              "
               + "\n" + "       CASE                                                                      "
               + "\n" + "           WHEN f501.t_isSecurities = 1                                          "
               + "\n" + "               THEN CASE                                                         "
               + "\n" + "                        WHEN f501.t_part <> 3                                    "
               + "\n" + "                            THEN (SELECT securitiesAcc.t_rate                    "
               + "\n" + "                                    FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                                   WHERE securitiesAcc.t_account = f501.t_account"
               + "\n" + "                                     AND ROWNUM = 1)                             "
               + "\n" + "                        ELSE NULL                                                "
               + "\n" + "                    END                                                          "
               + "\n" + "           ELSE NULL                                                             "
               + "\n" + "       END                                t_rate,                                "
               + "\n" + "       CASE                                                                  "
               + "\n" + "           WHEN f501.t_isSecurities = 1                                      "
               + "\n" + "               THEN CASE                                                     "
               + "\n" + "                        WHEN EXISTS (SELECT 1                                "
               + "\n" + "                                FROM repSecuritiesAccounts_vw securitiesAcc  "
               + "\n" + "                               WHERE securitiesAcc.t_account    = f501.t_account"
               + "\n" + "                                 AND securitiesAcc.t_isDebtRepo = 'YES'      "
               + "\n" + "                                 AND ROWNUM = 1)                             "
               + "\n" + "                            THEN 'РЕПО'                                      "
               + "\n" + "                        ELSE 'CSA'                                           "
               + "\n" + "                    END                                                      "
               + "\n" + "           ELSE NULL                                                         "
               + "\n" + "       END                                t_typeDealSecurities               "
               + "\n" + "  FROM df501_tmp f501                                    "
               + "\n" + " WHERE f501.t_isExcludedAcc = 0                          "
               + "\n" + " ORDER BY f501.t_account                                 "
               ;
            else
                queryText = 
                        "SELECT 'ГК'                        t_backOffice,         "
               + "\n" + "       f501.t_account,                                   "
               + "\n" + "       NVL((SELECT account.t_name                        "
               + "\n" + "              FROM drepaccount_vw account                "
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)                                     "
               + "\n" + "          )                        t_name,               "
               + "\n" + "       f501.t_beginRest,                                 "
               + "\n" + "       f501.t_debet,                                     "
               + "\n" + "       f501.t_credit,                                    "
               + "\n" + "       f501.t_endRest,                                   "
               + "\n" + "       f501.t_linkedAccount,                             "
               + "\n" + "       f501.t_identifier,                                "
               + "\n" + "       f501.t_onerousClaim,                              "
               + "\n" + "       NULL                        t_number,             "
               + "\n" + "       NULL                        t_startDate,          "
               + "\n" + "       NULL                        t_rate,               "
               + "\n" + "       NULL                        t_typeDealSecurities  "
               + "\n" + "  FROM df501_tmp f501                                    "
               + "\n" + " WHERE f501.t_isExcludedAcc = 0                          "
               + "\n" + " ORDER BY f501.t_account                                 "
               ;
            end;
            
        end;

        var dataView;
        dataView = m_view.getDataProtocolView("acc");
        var dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_backOffice",         V_STRING);
        dataset.setFieldType("t_account",            V_STRING);
        dataset.setFieldType("t_name",               V_STRING);
        dataset.setFieldType("t_beginRest",          V_MONEY );
        dataset.setFieldType("t_debet",              V_MONEY );
        dataset.setFieldType("t_credit",             V_MONEY );
        dataset.setFieldType("t_endRest",            V_MONEY );
        dataset.setFieldType("t_linkedAccount",      V_STRING);
        dataset.setFieldType("t_identifier",         V_STRING);
        dataset.setFieldType("t_onerousClaim",       V_STRING);
        dataset.setFieldType("t_number",             V_STRING);
        dataset.setFieldType("t_startDate",          V_DATE  );
        dataset.setFieldType("t_rate",               V_MONEY );
        dataset.setFieldType("t_typeDealSecurities", V_STRING);

        if (dataset.next())
            dataView.printHead();
            dataView.printString(dataset);
        end;
        while (dataset.next())
            dataView.printString(dataset);
        end;

        queryText = "SELECT doc.t_date          AS t_date,         "
           + "\n" + "       doc.t_number        AS t_number,       "
           + "\n" + "       doc.t_debetAccount  AS t_debetAccount, "
           + "\n" + "       doc.t_creditAccount AS t_creditAccount,"
           + "\n" + "       doc.t_incoversum    AS t_incoversum,   "
           + "\n" + "       0                   AS t_orderFlag     "
           + "\n" + "  FROM df501_tmp f501,                        "
           + "\n" + "       drepdocumentwithcorrection_vw doc      "
           + "\n" + " WHERE doc.t_debetAccountId = f501.t_accountId"
           + "\n" + "   AND f501.t_isExcludedAcc = 0               "
           + "\n" + "   AND doc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + " UNION ALL                                    "
           + "\n" + "SELECT doc.t_date,                            "
           + "\n" + "       doc.t_number,                          "
           + "\n" + "       doc.t_debetAccount,                    "
           + "\n" + "       doc.t_creditAccount,                   "
           + "\n" + "       doc.t_incoversum,                      "
           + "\n" + "       1                                      "
           + "\n" + "  FROM df501_tmp f501,                        "
           + "\n" + "       drepdocumentwithcorrection_vw doc      "
           + "\n" + " WHERE doc.t_creditAccountId = f501.t_accountId"
           + "\n" + "   AND f501.t_isExcludedAcc  = 0              "
           + "\n" + "   AND NOT EXISTS (SELECT 1                                            "
           + "\n" + "                     FROM df501_tmp                     tmpf501,       "
           + "\n" + "                          drepdocumentwithcorrection_vw tmpDoc         "
           + "\n" + "                    WHERE tmpDoc.t_debetAccountId = tmpf501.t_accountId"
           + "\n" + "                      AND tmpDoc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                                            AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + "                      AND tmpDoc.t_id             = doc.t_id)          "
           + "\n" + "   AND doc.t_date BETWEEN " + getSqlDate(RcbApplication().currentReport.context.period.beginDate)
           + "\n" + "                      AND " + getSqlDate(RcbApplication().currentReport.context.period.endDate)
           + "\n" + " ORDER BY t_orderFlag,                        "
           + "\n" + "          t_date,                             "
           + "\n" + "          t_number                            "
                  ;

        dataView = m_view.getDataProtocolView("doc");
        dataset = TRsbDataset(queryText);
        dataset.setFieldType("t_date",          V_DATE  );
        dataset.setFieldType("t_number",        V_STRING);
        dataset.setFieldType("t_debetAccount",  V_STRING);
        dataset.setFieldType("t_creditAccount", V_STRING);
        dataset.setFieldType("t_incoversum",    V_MONEY );
        if (dataset.next())
            dataView.printHead();
            dataView.printString(dataset);
        end;
        while (dataset.next())
            dataView.printString(dataset);
        end;

        if (isNeedExcludedAccProtocol())
            queryText = "SELECT f501.t_part,                                      "
               + "\n" + "       CASE                                              "
               + "\n" + "           WHEN f501.t_isSecurities = 1                  "
               + "\n" + "               THEN 'Securities'                         "
               + "\n" + "           ELSE 'ГК'                                     "
               + "\n" + "       END                               t_backOffice,   "
               + "\n" + "       f501.t_account,                                   "
               + "\n" + "       NVL((SELECT account.t_name                        "
               + "\n" + "              FROM drepaccount_vw account                "
               + "\n" + "             WHERE f501.t_accountId = account.t_accountId"
               + "\n" + "           ), CHR(1)                                     "
               + "\n" + "          )                              t_name,         "
               + "\n" + "       f501.t_beginRest,                                 "
               + "\n" + "       f501.t_debet,                                     "
               + "\n" + "       f501.t_credit,                                    "
               + "\n" + "       f501.t_endRest,                                   "
               + "\n" + "       CASE                                              "
               + "\n" + "            WHEN f501.t_part = 1                         "
               + "\n" + "            THEN 'Обратная сделка РЕПО через ЦК по размещенным денежным средствам'"
               + "\n" + "            WHEN f501.t_part = 3                         "
               + "\n" + "            THEN 'Прямая сделка РЕПО через ЦК по привлеченным денежным средствам'"
               + "\n" + "            ELSE ''                                      "
               + "\n" + "       END                               t_comment       "
               + "\n" + "  FROM df501_tmp f501                                    "
               + "\n" + " WHERE f501.t_isExcludedAcc = 1                          "
               + "\n" + " ORDER BY f501.t_part,                                   "
               + "\n" + "          f501.t_account                                 "
                      ;

            dataView = m_view.getDataProtocolView("excludedAcc");
            dataset = TRsbDataset(queryText);
            dataset.setFieldType("t_part",       V_INTEGER);
            dataset.setFieldType("t_backOffice", V_STRING );
            dataset.setFieldType("t_account",    V_STRING );
            dataset.setFieldType("t_name",       V_STRING );
            dataset.setFieldType("t_beginRest",  V_MONEY  );
            dataset.setFieldType("t_debet",      V_MONEY  );
            dataset.setFieldType("t_credit",     V_MONEY  );
            dataset.setFieldType("t_endRest",    V_MONEY  );
            dataset.setFieldType("t_comment",    V_STRING );
            if (dataset.next())
                dataView.printHead();
                dataView.printString(dataset);
            end;
            while (dataset.next())
                dataView.printString(dataset);
            end;
        end;
    end;

    private macro printImpl()
        createManualInputProtocol();
        m_view.printLine("");
        createDataProtocol();
        m_view.printLine("Информация о счетах и сделках: "       + m_view.getDataProtocolView("acc").getFileName());
        m_view.printLine("Информация о проводках: "              + m_view.getDataProtocolView("doc").getFileName());
        if (isNeedExcludedAccProtocol())
            m_view.printLine("Информация о сделках РЕПО через ц/к: " + m_view.getDataProtocolView("excludedAcc").getFileName());
        end;
        m_view.printСsvInExcelInstructions();
    end;

    private macro ctorTF501CalculationProtocol5456()
        initTProtocol(TF501CalculateProtocolView5456());
        m_view = view();
    end;

    ctorTF501CalculationProtocol5456()
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()
    var profiler = TSQLProfiler(getTxtFileName("!F501CalculateProtocolProfile"));
    profiler.clear();
    profiler.on();

    var protocolPrintController;
    if   (   (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE) 
          or (is5456RSHBChangesProject() and (rcbApplication().currentReport().context.period.EndDate >= RCB_I5456_DATE_F501)))
        protocolPrintController = TF501CalculationProtocol5456();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I4212_DATE)
        protocolPrintController = TF501CalculationProtocolI4212();
    elif (rcbApplication().currentReport().context.period.EndDate >= RCB_I3129_DATE)
        protocolPrintController = F501ProtocolPrintController3129();
    else
        protocolPrintController = F501ProtocolPrintController();
    end;

    protocolPrintController.print();
    profiler.off();
    protocolPrintController.show();
end;
/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/
main();
УстановитьФлагВозврата( OK_MACRO_FLAG);
exit(1);
