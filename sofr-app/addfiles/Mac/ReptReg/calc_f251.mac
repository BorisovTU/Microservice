/*
$Name:          calc_f251.mac
$Module:        Регламентируемая отчетность
$Description:   Расчет формы 251
*/

/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 251.

  Создан: 02.10.2006 - Sal.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
/*
 *  Общебанковские интеры и модули
 */
import BankInter;
import RsbDataSet;
import RsbObjFactory;

import cb_sql;
import globals;
import param;

/*
 *  Интеры и модули подсистемы
 */
import ReptcbInter;
import RcbCoreInter;

import repException;
import departmentFilter;
import chk_regd;
import rcb_bo;
import rcbconst;
import log_lib;
import rcbTuneTable;

/***************************************************************************************************
 *  Константы
 **************************************************************************************************/
const ERROR_KIND_NONE                     = 0;
const ERROR_KIND_WRONG_ACCOUNT_KIND       = 1;
const ERROR_KIND_WRONG_DOCUMENT_REFERENCE = 2;
const ERROR_KIND_WRONG_DOCUMENT_CLIENT    = 3;

macro getErrorDescription(errorKind : Integer)

    if   (errorKind == ERROR_KIND_NONE)                     return "";
    elif (errorKind == ERROR_KIND_WRONG_ACCOUNT_KIND)       return "Ошибка. Вид счета не соответствует клиенту счета.";
    elif (errorKind == ERROR_KIND_WRONG_DOCUMENT_REFERENCE) return "Ошибка. Неверный шифр документа.";
    elif (errorKind == ERROR_KIND_WRONG_DOCUMENT_CLIENT)    return "Ошибка. Документ не соответствует клиенту.";
    else                                                    return "Ошибка. Неизвестная ошибка.";
    end;

end;

/***************************************************************************************************
 *  Блок обработки ошибок
 **************************************************************************************************/

/*
 *  Ошибка вставки записи во временную таблицу
 */
private class (TException) TInsertTempTableException()
    initTException("Ошибка вставки записи во временную таблицу");
end;

/***************************************************************************************************
 *  Параметры отчета
 **************************************************************************************************/
class TParameters()
    private var m_beginDate      = rcbApplication().currentReport.context.period.beginDate;
    private var m_endDate        = rcbApplication().currentReport.context.period.endDate;
    private var m_departmentCode = rcbApplication().currentReport.context.departmentCode;
    private var m_sendingMode    = "";
    private var m_planNumber     = ЛогическийПланСчетов;
    private var m_topSelfId      = {OurBank};
    private var m_DPP;
    private var m_docOrigin;
    private var m_electronicDocOrigin;

    macro getBeginDate()
        return m_beginDate;
    end;

    macro getEndDate()
        return m_endDate;
    end;

    macro getDepartmentCode()
        return m_departmentCode;
    end;

    macro getSendingMode()
        return m_sendingMode;
    end;

    macro getDocOrigin()
        return m_docOrigin;
    end;

    macro getElectronicDocOrigin()
        return m_electronicDocOrigin;
    end;

    macro getPlanNumber()
        return m_planNumber;
    end;

    macro getTopSelfId()
        return m_topSelfId;
    end;

    macro getDPP()
        return m_DPP;
    end;

    local macro initializeTopSelfId()
        var dataSet = TRsbDataSet("SELECT rsb_rep_pt.get_top_superior_id(" + {OurBank} + ") t_topSelfId FROM DUAL");

        if (dataSet.next())
            m_topSelfId = dataSet.topSelfId;
        end;
    end;

    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 251/СПОСОБЫ ЭЛЕКТРОННОЙ ОТПРАВКИ",    V_STRING,  m_sendingMode,         NULL);
    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 251/ОТКЛОНЕНИЕ ОТ ДПП",               V_INTEGER, m_DPP,                 NULL);
    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 251/ПРОИСХОЖДЕНИЕ ДОКУМЕНТА",         V_INTEGER, m_docOrigin,           NULL);
    getRegistryValue("REPTREG/REP_GROUPS/ФОРМА 251/ПРОИСХОЖДЕНИЕ ЭЛЕКТР. ДОКУМЕНТА", V_STRING,  m_electronicDocOrigin, NULL);

    if (m_electronicDocOrigin == "")
        m_electronicDocOrigin = "NULL";
    end;

    initializeTopSelfId();
end;

/***************************************************************************************************
 *  Настроечная таблица
 **************************************************************************************************/

private class TTuneTable251()
    private var m_tuneArray = TArray();

    private class TTune(backOffice : Integer, mask : String, symbolMask : String, line : String)
        private var m_backOffice = backOffice;
        private var m_mask       = mask;
        private var m_symbolMask = symbolMask;
        private var m_line       = line;

        macro getBackOffice()
            return m_backOffice;
        end;

        macro getMask()
            return m_mask;
        end;

        macro getSymbolMask()
            return m_symbolMask;
        end;

        macro getLine()
            return m_line;
        end;
    end;

    macro isOn(backOffice : Integer, line : String)

        macro getLineCode(line : String) : String
            return strSubst(strSubst(line, "получ", ""), "уплач", "");
        end;

        // т.к. строки 3.3 убрана из настроечной таблицы (#155118), а расчитывать ее надо
        // строки отсутствуют в настроечной таблице
        if ((line == "3.3")       or
            (line == "1.1.2")     or
            (line == "1.1.3")     or
            (line == "2.1.3.1")   or
            (line == "2.1.3.1.1") or
            (line == "2.1.4.1")   or
            (line == "2.1.6.1")   or
            (line == "2.1.6.2.1") or
            (line == "2.2.3.1")   or
            (line == "2.2.3.1.1") or
            (line == "2.2.4.1")   or
            (line == "2.2.6.1")   or
            (line == "2.3.1.1")   or
            (line == "2.3.1.1.1") or
            (line == "2.3.3.1")   or
            (line == "2.3.3.1.1") or
            (line == "2.3.4.1")   or
            (line == "2.3.6.1")   or
            (line == "2.3.6.2.1")
            )
            return true;
        end;

        var i = 0;
        var n = m_tuneArray.size();
        while (i < n)
            if ((getLineCode(m_tuneArray[i].getLine()) == getLineCode(line)) and (m_tuneArray[i].getBackOffice() == backOffice))
                return true;
            end;
            i = i + 1;
        end;

        return false;
    end;

    macro getTuneForLine(line : string, backoffice : integer)
        var i = 0;
        var n = m_tuneArray.size();
        while (i < n)
            if ((m_tuneArray[i].getLine() == line) and (m_tuneArray[i].getBackOffice() == backoffice))
                return m_tuneArray[i];
            end;
            i = i + 1;
        end;

        return null;
    end;

    macro getMaskForLine(line : string, backoffice : integer)
        var tune = getTuneForLine(line, backoffice);

        if (tune != null)
            return tune.getMask();
        end;

        return "EMPTY_MASK";
    end;

    macro getSymbolMaskForLine(line : string, backoffice : integer)
        var tune = getTuneForLine(line, backoffice);

        if (tune != null)
            return tune.getSymbolMask();
        end;

        return "EMPTY_MASK";
    end;

    local macro constructor()

        var tempTuneTable = RcbTuneTable("dt251_dbt");

        if (RcbApplication().currentReport().context().period().endDate() >= RCB_I4212_DATE)
            tempTuneTable.setInstructionFilter(RCB_I4212_DATE);
        elif (RcbApplication().currentReport().context().period().endDate() >= RCB_I3875_DATE)
            tempTuneTable.setInstructionFilter(RCB_I3875_DATE2);
        elif (RcbApplication().currentReport().context().period().endDate() >= RCB_I2926_DATE)
            tempTuneTable.setInstructionFilter(RCB_I2926_DATE);
        elif (RcbApplication().currentReport().context().period().endDate() >= RCB_I2742_DATE)
            tempTuneTable.setInstructionFilter(RCB_I2742_DATE);
        elif (RcbApplication().currentReport().context().period().endDate() > RCB_I2539_DATE)
            tempTuneTable.setInstructionFilter(RCB_I2539_DATE);
        elif (rcbApplication().currentReport.context.period.endDate >= RCB_I2470_DATE1)
            tempTuneTable.setInstructionFilter(RCB_I2470_DATE1);
        elif (RcbApplication().currentReport().context().period().endDate() < RCB_I2332_DATE)
            tempTuneTable.setInstructionFilter(RCB_I2332_DATE -1);
        else
            tempTuneTable.setInstructionFilter(RCB_I2332_DATE);
        end;

        var dataSet = tempTuneTable.getDataSet();

        while (dataSet.next())
            m_tuneArray[m_tuneArray.size()] = TTune(dataSet.backOfice, dataSet.accountMasks, dataSet.symbolMasks, dataSet.line);
        end;
    end;

    constructor();
end;

var tuneTable = TTuneTable251();

/***************************************************************************************************
 *  Источники данных
 **************************************************************************************************/

class TDataSource(backOffice : integer)

    private const BACK_OFFICE = backOffice;

    macro getBackOffice()
        return BACK_OFFICE;
    end;

    macro getLine()
        return "";
    end;

    macro getColumn()
        return -1;
    end;

    macro getAccount()
        return "";
    end;

    macro getCreditAccount()
        return "";
    end;

    macro getClientCode()
        return -1;
    end;

    macro getDocumentNumber()
        return "";
    end;

    macro getDocumentReferenceNumber()
        return "";
    end;

    macro getCarryDate()
        return Date(0, 0, 0);
    end;

    macro getFiId()
        return -1;
    end;

    macro getRoubleSum()
        return $0;
    end;

    macro getCurrencySum()
        return $0;
    end;

    macro getSendingMode()
        return "";
    end;

    macro getPart()
        return subStr(getLine(), 1, 1);
    end;

    macro getDocumentsCount()
        return 1;
    end;

    macro getAutokey()
        return -1;
    end;

    macro getIsInternetOrigin
        return -1;
    end;

    macro getIsConnection()
        return -1;
    end;

    macro getIsMobilePhoneConnection()
        return -1;
    end;

    macro getResultCarry()
        return -1;
    end;

    macro fillTempTable(tempTable)
        throw(TPureVirtualMethodCallException("TDataSource::fillTempTable"));
    end;
end;


/***************************************************************************************************
 *  Вставка во временную таблицу
 **************************************************************************************************/

class TTempTable

    private var m_inserter = TRsbDataSet("SELECT *"
                                + "\n" + "  FROM df251_tmp"
                                + "\n" + " WHERE 0 = 1", RSDVAL_CLIENT, RSDVAL_STATIC);

    macro getInsertClause()
        return          "INSERT INTO df251_tmp(t_bo,"
               + "\n" + "                      t_line,"
               + "\n" + "                      t_column,"
               + "\n" + "                      t_account,"
               + "\n" + "                      t_accountCredit,"
               + "\n" + "                      t_clientCode,"
               + "\n" + "                      t_numbDocument,"
               + "\n" + "                      t_shifrDocument,"
               + "\n" + "                      t_dateCarry,"
               + "\n" + "                      t_fiid,"
               + "\n" + "                      t_sumRub,"
               + "\n" + "                      t_sumCurrency,"
               + "\n" + "                      t_kindA,"
               + "\n" + "                      t_chapter,"
               + "\n" + "                      t_docCount,"
               + "\n" + "                      t_errorKind,"
               + "\n" + "                      t_isInternetOrigin,"
               + "\n" + "                      t_autoKey)"
               + "\n";
    end;

    macro truncate()
        SQL_Truncate("df251_tmp");
    end;

    macro Insert(dataSource : TDataSource)

        var insertClause = getInsertClause()
               + "\n" + "SELECT    nvl('" + dataSource.getBackOffice() + "', null),"
               + "\n" + "          nvl('" + dataSource.getLine() + "', null),"
               + "\n" + "          nvl('" + dataSource.getColumn() + "', null),"
               + "\n" + "          nvl('" + dataSource.getAccount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCreditAccount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getClientCode() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentNumber() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentReferenceNumber() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCarryDate() + "', null),"
               + "\n" + "          nvl('" + dataSource.getFiId() + "', null),"
               + "\n" + "          nvl('" + dataSource.getRoubleSum() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCurrencySum() + "', null),"
               + "\n" + "          nvl('" + dataSource.getSendingMode() + "', null),"
               + "\n" + "          nvl('" + dataSource.getPart() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentsCount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getErrorKind() + "', null),"
               + "\n" + "          nvl('" + dataSource.getIsInternetOrigin() + "', null),"
               + "\n" + "          nvl('" + dataSource.getAutoKey() + "', null)"
               + "\n" +  "FROM dual";

        sql_execute(insertClause);

    end;
end;

class TTempTable_2742

    private var m_inserter = TRsbDataSet("SELECT *"
                                + "\n" + "  FROM df251_tmp"
                                + "\n" + " WHERE 0 = 1", RSDVAL_CLIENT, RSDVAL_STATIC);

    macro getInsertClause()
        return          "INSERT INTO df251_tmp(t_bo,"
                + "\n" + "                      t_line,"
                + "\n" + "                      t_column,"
                + "\n" + "                      t_account,"
                + "\n" + "                      t_accountCredit,"
                + "\n" + "                      t_clientCode,"
                + "\n" + "                      t_numbDocument,"
                + "\n" + "                      t_shifrDocument,"
                + "\n" + "                      t_dateCarry,"
                + "\n" + "                      t_fiid,"
                + "\n" + "                      t_sumRub,"
                + "\n" + "                      t_sumCurrency,"
                + "\n" + "                      t_kindA,"
                + "\n" + "                      t_chapter,"
                + "\n" + "                      t_docCount,"
                + "\n" + "                      t_errorKind,"
                + "\n" + "                      t_isInternetOrigin,"
                + "\n" + "                      t_isRemoteConnection,"
                + "\n" + "                      t_isConnection,"
                + "\n" + "                      t_isMobilePhoneConnection,"
                + "\n" + "                      t_result_carry,"
                + "\n" + "                      t_autoKey)"
                + "\n";
    end;

    macro truncate()
        SQL_Truncate("df251_tmp");
    end;

    macro Insert(dataSource : TDataSource)

        var insertClause = getInsertClause()
                + "\n" + "SELECT    nvl('" + dataSource.getBackOffice() + "', null),"
                + "\n" + "          nvl('" + dataSource.getLine() + "', null),"
                + "\n" + "          nvl('" + dataSource.getColumn() + "', null),"
                + "\n" + "          nvl('" + dataSource.getAccount() + "', null),"
                + "\n" + "          nvl('" + dataSource.getCreditAccount() + "', null),"
                + "\n" + "          nvl('" + dataSource.getClientCode() + "', null),"
                + "\n" + "          nvl('" + dataSource.getDocumentNumber() + "', null),"
                + "\n" + "          nvl('" + dataSource.getDocumentReferenceNumber() + "', null),"
                + "\n" + "          nvl('" + dataSource.getCarryDate() + "', null),"
                + "\n" + "          nvl('" + dataSource.getFiId() + "', null),"
                + "\n" + "          nvl('" + dataSource.getRoubleSum() + "', null),"
                + "\n" + "          nvl('" + dataSource.getCurrencySum() + "', null),"
                + "\n" + "          nvl('" + dataSource.getSendingMode() + "', null),"
                + "\n" + "          nvl('" + dataSource.getPart() + "', null),"
                + "\n" + "          nvl('" + dataSource.getDocumentsCount() + "', null),"
                + "\n" + "          nvl('" + dataSource.getErrorKind() + "', null),"
                + "\n" + "          nvl('" + dataSource.getIsInternetOrigin() + "', null),"
                + "\n" + "          nvl('" + dataSource.getIsConnection() + "', null),"
                + "\n" + "          nvl('" + dataSource.getIsIMobilePhoneConnection() + "', null),"
                + "\n" + "          nvl('" + dataSource.getResultCarry() + "', null),"
                + "\n" + "          nvl('" + dataSource.getAutoKey() + "', null)"
                + "\n" +  "FROM dual";

        sql_execute(insertClause);

    end;
end;

class TTempTable_2926

    private var m_inserter = TRsbDataSet("SELECT *"
                                + "\n" + "  FROM df251_tmp"
                                + "\n" + " WHERE 0 = 1", RSDVAL_CLIENT, RSDVAL_STATIC);

    macro getInsertClause()
        return          "INSERT INTO df251_tmp(t_bo,"
               + "\n" + "                      t_line,"
               + "\n" + "                      t_column,"
               + "\n" + "                      t_account,"
               + "\n" + "                      t_accountCredit,"
               + "\n" + "                      t_clientCode,"
               + "\n" + "                      t_numbDocument,"
               + "\n" + "                      t_shifrDocument,"
               + "\n" + "                      t_dateCarry,"
               + "\n" + "                      t_fiid,"
               + "\n" + "                      t_sumRub,"
               + "\n" + "                      t_sumCurrency,"
               + "\n" + "                      t_kindA,"
               + "\n" + "                      t_chapter,"
               + "\n" + "                      t_docCount,"
               + "\n" + "                      t_errorKind,"
               + "\n" + "                      t_isInternetOrigin,"
               + "\n" + "                      t_autoKey,"
               + "\n" + "                      t_isPmd)"
               + "\n";
    end;

    macro truncate()
        SQL_Truncate("df251_tmp");
    end;

    macro Insert(dataSource : TDataSource)

        var insertClause = getInsertClause()
               + "\n" + "SELECT    nvl('" + dataSource.getBackOffice() + "', null),"
               + "\n" + "          nvl('" + dataSource.getLine() + "', null),"
               + "\n" + "          nvl('" + dataSource.getColumn() + "', null),"
               + "\n" + "          nvl('" + dataSource.getAccount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCreditAccount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getClientCode() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentNumber() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentReferenceNumber() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCarryDate() + "', null),"
               + "\n" + "          nvl('" + dataSource.getFiId() + "', null),"
               + "\n" + "          nvl('" + dataSource.getRoubleSum() + "', null),"
               + "\n" + "          nvl('" + dataSource.getCurrencySum() + "', null),"
               + "\n" + "          nvl('" + dataSource.getSendingMode() + "', null),"
               + "\n" + "          nvl('" + dataSource.getPart() + "', null),"
               + "\n" + "          nvl('" + dataSource.getDocumentsCount() + "', null),"
               + "\n" + "          nvl('" + dataSource.getErrorKind() + "', null),"
               + "\n" + "          nvl('" + dataSource.getIsInternetOrigin() + "', null),"
               + "\n" + "          nvl('" + dataSource.getAutoKey() + "', null),"
               + "\n" + "          nvl('" + dataSource.getIsPmd() + "', null)"
               + "\n" +  "FROM dual";

        sql_execute(insertClause);

    end;
end;
