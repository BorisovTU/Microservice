/* ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   RS-Bank V6                                                 R-Style Softlab
   ” ©« ¯®¤á¨áâ¥¬ë "¥£« ¬¥­â¨à®¢ ­­ ï ®âç¥â­®áâì"

   ”®à¬  910. Š®­âà®««¥à à áç¥â à §¤¥« .

   CREATED : 17.08.2013 ABP.
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ */
private class (RcbPartCalculateController) TF901PartCalculateController(reportCalculateController : Object, partId : String)
    private var m_protocolView;

    private macro setValue(attribute : RcbAttributeBase, rest : Variant)
        attribute.setValue(rest);
    end;

    private macro getCalculateAttributeData(attributeId : String, functionName : String, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(m_part.getAttribute(dependencesAttributeIdPool.getCurrentItem()));
        end;

        return RcbCalculationAttributeData(m_part.getAttribute(attributeId),
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(attributeId))),
                                           RcbDependencesData(dependencesAttributePool));
    end;

    private macro constructorTF901PartCalculateController(reportCalculateController : Object, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_protocolView = m_dataSources.getProtocolView();
    end;

    constructorTF901PartCalculateController(reportCalculateController, partId);
end;

class (TF901PartCalculateController) TF901Part1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    initTF901PartCalculateController(reportCalculateController, "1");

    macro calculateAttribute(attributeId : String)
        var attribute = m_part.getAttribute(attributeId);

        var rowNumber = attribute.getRowNumber();
        var isRouble =  attribute.isRouble();
        var rest = $0;

        var dataSource;
        var filter;

        filter = m_dataSouceFilters.getFilter("AccountRest");
        filter.isChapterIn("1,2,3,4,5").op("AND").accountIsOpened().op("AND").isSatisfiesToMasks(objectFactoryInstance.createTuneTable().setKey(rowNumber).getMasks());

        if (isRouble)
            m_protocolView.printLine("\n‹¨æ¥¢ë¥ áç¥â , ¢®è¥¤è¨¥ ¢ à áç¥â áâà®ª¨ " + rowNumber);

            dataSource = m_dataSources.getDataSource("RoubleAccountRest");
            filter.op("AND").isRouble();
        else
            dataSource = m_dataSources.getDataSource("ForeignAccountRest");
            filter.op("AND").op("NOT").isRouble();
        end;

        rest = dataSource.getData(filter, attribute);

        setValue(attribute, rest);
    end;

    macro calculateTotal(attributeId : String)
        var attribute = m_part.getAttribute(attributeId);

        var rowNumber = attribute.getRowNumber();
        var isRouble =  attribute.isRouble();
        var rest = $0;

        var dataSource = m_dataSources.getDataSource("Totals");
        var filter = m_dataSouceFilters.getFilter("Totals");

        filter.isRowNumberIn("1,2,3,4,5,6,7,8,9,10").op("AND").op("(");
        if (isRouble)
            filter.isRouble();
        else
            filter.op("NOT").isRouble();
        end;

        filter.op(")");

        rest = dataSource.getData(filter, attribute);

        setValue(attribute, rest);
    end;

    macro execute()
        var attribute = objectFactoryInstance.createAttribute();

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("1",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("1",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("2",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("2",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("3",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("3",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("4",  "X"), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("5",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("5",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("6",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("6",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("7",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("7",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("8",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("8",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("9",  "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("9",  "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("10", "X"), "calculateAttribute"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("10", "" ), "calculateAttribute"));

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("11", "X"), "calculateTotal"));
        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(attribute.makeId("11", "" ), "calculateTotal"));
    end;
end;
