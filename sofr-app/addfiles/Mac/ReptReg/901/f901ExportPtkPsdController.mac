/* ──────────────────────────────────────────────────────────────────────────┐
   RS-Bank V6                                                 R-Style Softlab
   Файл подсистемы "Регламентированная отчетность"

   Форма 901. Контроллер экспорта в ПТК ПСД.

   CREATED : 21.08.2013 ABP
└────────────────────────────────────────────────────────────────────────── */
class (RcbPtkPsdExportController) TF901ExportPtkPsdController()
    initRcbPtkPsdExportController("901", objectFactoryInstance.createReport());
    m_view.setDate(true);

    private macro getDescriptorInfo()
        return "№45 от 25.04.2012";
    end;

    private macro getValueAsString(attribute)
        var value = null;

        if (attribute.isDefined())
            value = attribute.getCurrentValue();
        else
            value = null;
        end;

        if (value != null)
            value = ternary(value == 0.0, "", attribute.getValueAsString());
        end;

        return value;
    end;

    private macro printAttribute(rowCode : String, columnCode : String, attributeId : String)
        var attribute = m_report.getPart("1").getAttribute(attributeId);
        var value = getValueAsString(attribute);

        var accountErrText = ternary(columnCode == "summ", "рублевым", "валютным");
        if (value == null)
            addError("Не найдено значение атрибута для экспорта с кодом " + rowCode + ", рассчитанного по " + accountErrText + " счетам");
        end;

        if (value != "")
            m_view.printRow("F901", rowCode, columnCode, value);
        end;
    end;

    private macro printData()
        var attribute = objectFactoryInstance.createAttribute();

        printAttribute("40101", "summ", attribute.makeId("1", "X"));
        printAttribute("40101", "sumv", attribute.makeId("1", "" ));
        printAttribute("40105", "summ", attribute.makeId("2", "X"));
        printAttribute("40105", "sumv", attribute.makeId("2", "" ));
        printAttribute("40106", "summ", attribute.makeId("3", "X"));
        printAttribute("40106", "sumv", attribute.makeId("3", "" ));
        printAttribute("40116", "summ", attribute.makeId("4", "X"));
        printAttribute("40301", "summ", attribute.makeId("5", "X"));
        printAttribute("40301", "sumv", attribute.makeId("5", "" ));
        printAttribute("40501", "summ", attribute.makeId("6", "X"));
        printAttribute("40501", "sumv", attribute.makeId("6", "" ));
        printAttribute("40601_1", "summ", attribute.makeId("7", "X"));
        printAttribute("40601_1", "sumv", attribute.makeId("7", "" ));
        printAttribute("40601_2", "summ", attribute.makeId("8", "X"));
        printAttribute("40601_2", "sumv", attribute.makeId("8", "" ));
        printAttribute("40701_1", "summ", attribute.makeId("9", "X"));
        printAttribute("40701_1", "sumv", attribute.makeId("9", "" ));
        printAttribute("40701_2", "summ", attribute.makeId("10", "X"));
        printAttribute("40701_2", "sumv", attribute.makeId("10", "" ));

        printAttribute("Итого", "summ", attribute.makeId("11", "X"));
        printAttribute("Итого", "sumv", attribute.makeId("11", "" ));
    end;

    private macro printDataZone()
        printData();
        RcbApplication().transactionManager.rollback();
    end;
end;
