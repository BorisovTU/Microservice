/*
$Name:          F119ReportView.mac
$Module:        Отчеты ЦБ
$Description:   ОФР. Печатное представление отчета.
*/

//нестадартный подвал отчета
class (TSignatureZone) TF119SignatureZone()
    initTSignatureZone();

    private macro initializeFirstPerson()
        var dataSource;

        dataSource = TRsbDataSet(         "SELECT off.t_post post, "
                                 + "\n" + "       ptr.t_name name "
                                 + "\n" + "  FROM dofficer_dbt off, dparty_dbt ptr"
                                 + "\n" + " WHERE off.t_partyId       = " + party.rec.partyId
                                 + "\n" + "   AND off.t_IsFirstPerson = 'X'"
                                 + "\n" + "   AND ptr.t_partyId       = off.t_personId");
        dataSource.setFieldType("post",  V_STRING);
        dataSource.setFieldType("name",  V_STRING);

        m_firstPersonAppointment = "Должностное лицо, уполномоченное подписывать Отчет";

        if(dataSource.next())
            m_firstPersonName = dataSource.name;
        else
            m_firstPersonName = "";
        end;
    end;
end;

class (TSignatureZone_4212) TF119SignatureZone_4212()
    initTSignatureZone_4212();

    private macro initializeFirstPerson()
        var dataSource;

        dataSource = TRsbDataSet(         "SELECT off.t_post post, "
                                 + "\n" + "       ptr.t_name name "
                                 + "\n" + "  FROM dofficer_dbt off, dparty_dbt ptr"
                                 + "\n" + " WHERE off.t_partyId       = " + party().rec.partyId
                                 + "\n" + "   AND off.t_IsFirstPerson = 'X'"
                                 + "\n" + "   AND ptr.t_partyId       = off.t_personId");
        dataSource.setFieldType("post",  V_STRING);
        dataSource.setFieldType("name",  V_STRING);

        m_firstPersonAppointment = "Должностное лицо, уполномоченное подписывать Отчет";

        if(dataSource.next())
            m_firstPersonName = dataSource.name;
        else
            m_firstPersonName = "";
        end;
    end;
end;

//
class (TPrintableView) TF119PrintableView(formName, formOkudCode, formPeriodicity, periodFormat)
    private macro constructorTPrintableReport(formName, formOkudCode, formPeriodicity, periodFormat)

        defineFileName(formOkudCode);

        m_lendingAgencyCodeZone  = TLendingAgencyCodeZone_2851();
        m_namesZone              = TNamesZone_2742(formName, formOkudCode, formPeriodicity, periodFormat);
        m_signatureZone          = TF119SignatureZone();

        m_standardZoneWidth = 0;
    end;

    initTPrintableView(formName, formOkudCode, formPeriodicity, periodFormat);
end;

class (TPrintableView) TF119PrintableView_4212(formName, formOkudCode, formPeriodicity, periodFormat)
    private macro constructorTPrintableReport_4212(formName, formOkudCode, formPeriodicity, periodFormat)
        initTPrintableView(formName, formOkudCode, formPeriodicity, periodFormat);

        defineFileName(formOkudCode);

        m_lendingAgencyCodeZone  = TLendingAgencyCodeZone_2851();
        m_namesZone              = TNamesZone_4212(formName, formOkudCode, formPeriodicity, periodFormat);
        m_signatureZone          = TF119SignatureZone_4212();

        m_standardZoneWidth = 0;
    end;

    constructorTPrintableReport_4212(formName, formOkudCode, formPeriodicity, periodFormat);
end;

/**
 * Печатное представление отчета.
 *
 * @param protocolView RcbPrintProtocolView Печатное представление прокола печати
 */
class (RcbReportView) TF119ReportView(protocolView: RcbPrintProtocolView)

    /**
     * Ресурсы для отчета
     */
    private var m_resource: Object = NULL;

    /**
     * Предварительные действия: наполнение отчета разделами
     */
    private macro initialize()
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF119Global().getPart1Id(), this));
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF119Global().getPart2Id(), this));
        m_partViewPool.push_back(objectFactoryInstance.createPartView(TF119Global().getPart3Id(), this));
    end;

    /**
     * Конструктор
     *
     * @param protocolView RcbPrintProtocolView Печатное представление прокола печати
     */
    private macro constructorTF119ReportView(protocolView: RcbPrintProtocolView)
        m_resource = objectFactoryInstance.createResource();

        if (protocolView == NULL)
            throw(TUnspecifiedValueException("TF119ReportView::constructorTF119ReportView", "protocolView"));
        end;

        initRcbReportView(m_resource.getReport().FULL_NAME_REPORT,
                          m_resource.getReport().CODE_REPORT,
                          RCB_PK_MONTH,
                          DATE_IN_PERIOD_FORMAT,
                          protocolView);

        changePrintZone(MC_PERIOD_NAME_WITH_FULL_YEAR_LABEL);
        changePrintZone(MC_LEADING_AGENCY_NAME_WHITHOUT_BRANCH);
        excludeAttribute(AC_FORM_UNIT);
        excludeAttribute(AC_SECOND_PERSON);
    end;

    constructorTF119ReportView(protocolView);
end;
