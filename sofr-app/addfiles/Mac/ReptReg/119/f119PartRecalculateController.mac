/*
$Name:          f119PartRecalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 119. Классы контроллеров пересчета разделов после свода.
*/

private class (RcbPartCalculateController) TF119PartRecalculateController(reportRecalculateController : Object, partId : String)
//    private var m_protocolView;
//    private var m_dataProtocolView;
    private var m_datasource;

    private macro getCalculateAttributeData(attributeId : String, functionName : String, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(m_part.getAttribute(dependencesAttributeIdPool.getCurrentItem()));
        end;

        return RcbCalculationAttributeData(m_part.getAttribute(attributeId),
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(attributeId)
                                                                                   )
                                                                ),
                                           RcbDependencesData(dependencesAttributePool)
                                          );
    end;

    macro calculateAttribute(attributeId)
//        m_dataProtocolView.printSymbolBeginProcess(attributeId);

        var attribute = m_part.getAttribute(attributeId);
        attribute.getValue().setMaxInterestRate(m_datasource.getData(null, attribute, "").getMaxInterestRate().exact);

//        m_dataProtocolView.printSymbolEndProcess();
    end;

    macro execute()
//        m_protocolView.printLine("");

//        m_dataProtocolView.printSymbolBeginProcess(null, "init special symbols");
        for (var i, m_datasources.getDatasource("lines").getData())
            var line = i[0];
            m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData(line, "calculateAttribute"));
        end;
//        m_dataProtocolView.printSymbolEndProcess();
    end;

    private macro constructorTF119PartRecalculateController(reportRecalculateController : Object, partId : String)
        initRcbPartCalculateController(reportRecalculateController, partId);
        m_datasource = m_datasources.getDatasource("recalc");
//        m_protocolView = m_dataSources.getProtocolView();
//        m_dataProtocolView = m_protocolView.getDataProtocolView("lines");
    end;

    constructorTF119PartRecalculateController(reportRecalculateController, partId);
end;

class (TF119PartRecalculateController) TF119Part1RecalculateController(reportRecalculateController : Object)
    private macro constructorTF119Part1RecalculateController(reportRecalculateController : Object)
        initTF119PartRecalculateController(reportRecalculateController, TF119Global().getPart1Id());
    end;

    constructorTF119Part1RecalculateController(reportRecalculateController);
end;

class (TF119PartRecalculateController) TF119Part2RecalculateController(reportRecalculateController : Object)
    private macro constructorTF119Part2RecalculateController(reportRecalculateController : Object)
        initTF119PartRecalculateController(reportRecalculateController, TF119Global().getPart2Id());
    end;

    constructorTF119Part2RecalculateController(reportRecalculateController);
end;

class (TF119PartRecalculateController) TF119Part3RecalculateController(reportRecalculateController : Object)
    private macro constructorTF119Part3RecalculateController(reportRecalculateController : Object)
        initTF119PartRecalculateController(reportRecalculateController, TF119Global().getPart3Id());
    end;

    constructorTF119Part3RecalculateController(reportRecalculateController);
end;
