/*
$Name:          f501PartCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501. Классы контроллеров расчета разделов.
*/

//Рассчитываемые атрибуты для контроллера расчета отчета - это конкретные графы для группы строк из раздела отчета.
private class (RcbPartCalculateController) TF501PartCalculateController(reportCalculateController : Object, partId : String)
    private var m_protocolView;
    private var m_dataProtocolView;

    macro getDataProtocolView()
        return m_dataProtocolView;
    end;

    macro createAttributes(data)
        var staticAttribute = objectFactoryInstance.createAttribute(null, m_part);

        while (data.moveNext())
            var account = data.account;
            var id = staticAttribute.makeId(account);

            var attributeValue;
            var attribute = m_part.getAttribute(id);
            if (attribute != null)
                attributeValue = attribute.getValue();
                attributeValue.set("balance", nvl(data.balance, ""));
                attributeValue.set("accountForPrint", nvl(data.accountForPrint, ""));
                attributeValue.set("clientName", nvl(data.clientName, ""));
                attributeValue.set("regNumber", nvl(data.regNumber, ""));
                attributeValue.set("countryCode", nvl(data.countryCode, ""));
                attributeValue.set("inRest", nvl(data.inRest, $0) + nvl(attributeValue.get("inRest").exact, $0));
                attributeValue.set("debetTurnover", nvl(data.debetTurnover, $0) + nvl(attributeValue.get("debetTurnover").exact, $0));
                attributeValue.set("creditTurnover", nvl(data.creditTurnover, $0) + nvl(attributeValue.get("creditTurnover").exact, $0));
                attributeValue.set("outRest", nvl(data.outRest, $0) + nvl(attributeValue.get("outRest").exact, $0));
                attributeValue.set("performanceDate", nvl(data.performanceDate, ""));
                attributeValue.set("performanceDateKliko", nvl(data.performanceDateKliko, ""));
                attributeValue.set("percentValue", nvl(data.percentValue, $0));
                attributeValue.set("accountClientCode", nvl(data.accountClientCode, ""));
                attributeValue.set("accountType", nvl(data.accountType, ""));
                attributeValue.set("accountKind", nvl(data.accountKind, ""));
                attributeValue.set("repoAccountSign", nvl(data.repoAccountSign, 0));
                attributeValue.set("thirdPartySign", nvl(data.thirdPartySign, 0));
                attributeValue.set("dependencySign", nvl(data.dependencySign, ""));
                attributeValue.set("prolongationCount", nvl(data.prolongationCount, 0) + nvl(attributeValue.get("prolongationCount").exact, 0));
                attributeValue.set("explanations", nvl(data.explanations, ""));
                attributeValue.set("bic", nvl(data.bic, ""));
                attributeValue.set("encumbranceRest", nvl(data.encumbranceRest, $0) + nvl(attributeValue.get("encumbranceRest").exact, $0));
                attributeValue.set("gdSign", nvl(data.gdSign, 0));
                attributeValue.set("correctDocSign", nvl(data.correctDocSign, 0));
                attributeValue.set("encumbranceParty", nvl(data.encumbranceParty, ""));
                attributeValue.set("encumbrancePartyId", nvl(data.encumbrancePartyId, ""));
                attributeValue.set("encumbranceKind", nvl(data.encumbranceKind, ""));
                attributeValue.set("maturityDate", nvl(data.maturityDate, ""));
                attributeValue.set("encumbranceSign", nvl(data.encumbranceSign, ""));
                attributeValue.set("swiftFilial", nvl(data.swiftFilial, ""));
                attributeValue.set("conditionalCode", nvl(data.conditionalCode, ""));
                attributeValue.set("otherDecoding", nvl(data.otherDecoding, ""));
            else
                var storage = m_part.getPartCompositeValue().addValue();
                attributeValue = objectFactoryInstance.createAttributeValue(m_part, storage).setAccount(account);

                attributeValue.set("balance", nvl(data.balance, ""));
                attributeValue.set("accountForPrint", nvl(data.accountForPrint, ""));
                attributeValue.set("clientName", nvl(data.clientName, ""));
                attributeValue.set("regNumber", nvl(data.regNumber, ""));
                attributeValue.set("countryCode", nvl(data.countryCode, ""));
                attributeValue.set("inRest", nvl(data.inRest, $0));
                attributeValue.set("debetTurnover", nvl(data.debetTurnover, $0));
                attributeValue.set("creditTurnover", nvl(data.creditTurnover, $0));
                attributeValue.set("outRest", nvl(data.outRest, $0));
                attributeValue.set("performanceDate", nvl(data.performanceDate, ""));
                attributeValue.set("performanceDateKliko", nvl(data.performanceDateKliko, ""));
                attributeValue.set("percentValue", nvl(data.percentValue, $0));
                attributeValue.set("accountClientCode", nvl(data.accountClientCode, ""));
                attributeValue.set("accountType", nvl(data.accountType, ""));
                attributeValue.set("accountKind", nvl(data.accountKind, ""));
                attributeValue.set("repoAccountSign", nvl(data.repoAccountSign, 0));
                attributeValue.set("thirdPartySign", nvl(data.thirdPartySign, 0));
                attributeValue.set("dependencySign", nvl(data.dependencySign, ""));
                attributeValue.set("prolongationCount", nvl(data.prolongationCount, 0));
                attributeValue.set("explanations", nvl(data.explanations, ""));
                attributeValue.set("bic", nvl(data.bic, ""));
                attributeValue.set("encumbranceRest", nvl(data.encumbranceRest, $0));
                attributeValue.set("gdSign", nvl(data.gdSign, 0));
                attributeValue.set("correctDocSign", nvl(data.correctDocSign, 0));
                attributeValue.set("encumbranceParty", nvl(data.encumbranceParty, ""));
                attributeValue.set("encumbrancePartyId", nvl(data.encumbrancePartyId, ""));
                attributeValue.set("encumbranceKind", nvl(data.encumbranceKind, ""));
                attributeValue.set("maturityDate", nvl(data.maturityDate, ""));
                attributeValue.set("encumbranceSign", nvl(data.encumbranceSign, ""));
                attributeValue.set("swiftFilial", nvl(data.swiftFilial, ""));
                attributeValue.set("conditionalCode", nvl(data.conditionalCode, ""));
                attributeValue.set("otherDecoding", nvl(data.otherDecoding, ""));

                m_part.addAttribute(id, attributeValue);
            end;
        end;
    end;

    private macro getCalculateAttributeData(functionName : String, data : Object, dependencesAttributeIdPool : RcbArray)
        if (dependencesAttributeIdPool == null)
            dependencesAttributeIdPool = RcbArray();
        end;

        var dependencesAttributePool = RcbArray();

        dependencesAttributeIdPool.moveFirst();
        while (dependencesAttributeIdPool.moveNext())
            dependencesAttributePool.push_back(RcbAttributeBase(dependencesAttributeIdPool.getCurrentItem(), m_part, null));
        end;

        return RcbCalculationAttributeData(null,
                                           RcbArray().initialize(RcbCalculationData(r2m(this, functionName),
                                                                                    RcbArray().initialize(data/*список параметров*/)
                                                                                   )
                                                                ),
                                           RcbDependencesData(dependencesAttributePool)
                                          );
    end;



    private macro constructorTF501PartCalculateController(reportCalculateController : Object, partId : String)
        initRcbPartCalculateController(reportCalculateController, partId);
        m_protocolView = m_dataSources.getProtocolView();
    end;

    constructorTF501PartCalculateController(reportCalculateController, partId);
end;

class (TF501PartCalculateController) TF501Part1CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    macro execute()
//        m_protocolView.printLine("");

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("createAttributes", m_datasources.getDatasource("part1Data").getData()));

//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF501Part1CalculateController(reportCalculateController : Object)
        initTF501PartCalculateController(reportCalculateController, TF501Global().getPart1Id());
        m_dataProtocolView = m_protocolView.getDataProtocolView("part1");
    end;

    constructorTF501Part1CalculateController(reportCalculateController);
end;

class (TF501PartCalculateController) TF501Part2CalculateController(reportCalculateController : Object /*TReportCalculateController*/)
    macro execute()
//        m_protocolView.printLine("");

        m_reportCalculateController.addCalculationAttributeData(getCalculateAttributeData("createAttributes", m_datasources.getDatasource("part2Data").getData()));

//        m_protocolView.printLine("Сформирован csv-файл с данными: " + m_dataProtocolView.getProtocolFileName());
    end;

    private macro constructorTF501Part2CalculateController(reportCalculateController : Object)
        initTF501PartCalculateController(reportCalculateController, TF501Global().getPart2Id());
        m_dataProtocolView = m_protocolView.getDataProtocolView("part2");
    end;

    constructorTF501Part2CalculateController(reportCalculateController);
end;
