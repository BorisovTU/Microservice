/*
$Name:          f501DataSources.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501. Источники данных.
*/

private const DEAL_KIND_ATTRACTION = "ПРИВЛЕЧЕНИЕ";
private const DEAL_KIND_PLACEMENT  = "РАЗМЕЩЕНИЕ ";
private const TYPE_1_CODE = "Депозит/кредит";
private const TYPE_2_CODE = "Корреспондентский";

private const SQL_TYPE_1_CODE = GetSqlString(TYPE_1_CODE);
private const SQL_TYPE_2_CODE = GetSqlString(TYPE_2_CODE);

/**
 * Форма 501. Данные сделок МБК
 */
private class (RcbDataSource) TF501ArData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private const SQL_BEGIN_DATE = getSqlDate(TF501Global().getRcbReport().context.period.beginDate);
    private const SQL_END_DATE   = getSqlDate(TF501Global().getRcbReport().context.period.endDate);
    private const SQL_ZERO_DATE  = getSqlDate(Date(0, 0, 0));

    private var m_BalanceList =  "32001, 32010, 32101, 32110, 32201, 32301, 31301, 31310, 31401, 31410, 31501, 31601";

    macro clear()
        sql_truncate("df501_ar_tmp");
        return this;
    end;

    private macro getQueryForData()
        var  QueryForData = ""
                   + "\n" + "SELECT acc.t_account                                                       account,"
                   + "\n" + "       acc.t_accountId                                                     accountId,"
                   + "\n" + "       acc.t_fiid                                                          fiid,"
                   + "\n" + "       acc.t_kind                                                          kindAccount,"
                   + "\n" + "       acc.t_chapter                                                       chapter,"
                   + "\n" + "       acc.t_balance                                                       balance,"
                   + "\n" + "       prt.t_id                                                            partyId,"
                   + "\n" + "       DECODE(prt.t_isResident, 1,prt.t_name, NVL((SELECT pn.t_name FROM dPartyName_dbt pn WHERE pn.t_partyId = prt.t_id AND pn.t_nameTypeId = 3  AND ROWNUM < 2), prt.t_name)) AS name, "
                   + "\n" + "       prt.t_isResident                                                    isResident,"
                   + "\n" + "       NVL((SELECT adr.t_country FROM dAdress_dbt adr WHERE adr.t_partyId = prt.t_id AND adr.t_type = 2 AND adr.t_country != CHR(1)), prt.t_countryCode) nrCountry,"
                   + "\n" + "       acc.t_inCoverRest                                                   BegRest,"
                   + "\n" + "       acc.t_outCoverRest                                                  EndRest,"
                   + "\n" + "       NVL((SELECT sum(doc.t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_debetaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0) Debet,"
                   + "\n" + "       NVL((SELECT sum(t_incoversum)"
                   + "\n" + "          FROM drepdocumentwithcorrection_vw doc"
                   + "\n" + "         WHERE doc.t_chapter = acc.t_chapter"
                   + "\n" + "           AND doc.t_creditaccount = acc.t_Account"
                   + "\n" + "           AND doc.t_date >= rep_data.getbegindate()"
                   + "\n" + "           AND doc.t_date <= rep_data.getenddate()),0)                     Credit,"
                   + "\n" + "       acc.t_objectId                                                      objectId, "
                   + "\n" + "       acc.t_part                                                          part, "
                   + "\n" + "       acc.t_typeAccount                                                   typeAccount, "
                   + "\n" + "       acc.t_operationDate + acc.t_daysToEnd                               operationEndDate, "
                   + "\n" + "       CASE                                                                                "
                   + "\n" + "           WHEN EXISTS (SELECT 1                                                           "
                   + "\n" + "                          FROM drepCorrectionalDocument_vw iscorrect                       "
                   + "\n" + "                         WHERE iscorrect.t_creditaccount = acc.t_account)                  "
                   + "\n" + "           THEN 1                                                                          "
                   + "\n" + "           ELSE 0                                                                          "
                   + "\n" + "       END AS                                                               isexistcorrect,"
                   + "\n" + "       CASE"
                   + "\n" + "            WHEN prt.t_isresident = 1 "
                   + "\n" + "            THEN"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN reppartycodes.t_code like '%/%'"
                   + "\n" + "                        THEN SUBSTR(reppartycodes.t_code, 1, INSTR(reppartycodes.t_code, '/') - 1)"
                   + "\n" + "                    ELSE NVL(reppartycodes.t_code, CHR(1))"
                   + "\n" + "                END"
                   + "\n" + "            ELSE"
                   + "\n" + "                CASE"
                   + "\n" + "                    WHEN prt.t_isswift = 1"
                   + "\n" + "                        THEN NVL(reppartycodes.t_code, 'НР')"
                   + "\n" + "                    ELSE 'НР'"
                   + "\n" + "                END"
                   + "\n" + "       END AS                                                              regNumber,"
                   //графа 13
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId, "
                                                                                + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN '11'" //Признак обременения первая цифра, остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                               WHEN NOT (party.t_isPhisical = 1 AND  party.t_isResident = 0)"
                   + "\n" + "                                   THEN '9' || party.t_name"
                   + "\n" + "                               ELSE '0'"
                   + "\n" + "                            END as t_name"
                   + "\n" + "                       FROM dRepParty_vw party,"
                   + "\n" + "                            dRepLinkedObjects_vw objLink"
                   + "\n" + "                      WHERE party.t_objectId                = objLink.t_id"
                   + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_CONTRACTOR_BY_ONEROUS
                   + "\n" + "                        AND objLink.t_type                  = " + RCB_OBJTYPE_PARTY
                   + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "                        AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "                    ),"
                   + "\n" + "                    '0'"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                             onerousClaim,"
                   //графа 14
                   + "\n" + "       CASE"
                   + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Собств_Обременение', acc.t_objectId," +
                                                                                  getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
                   + "\n" + "               THEN 'XYYY'" //Условный код первая цифра (если X - значит не заполяется), следующие 3 цифры - это код SWIFT (если YYY - значит не заполяется. XXX - Для SWIFT = 8 символов), остальное значение графы
                   + "\n" + "           ELSE NVL((SELECT CASE"
                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (SELECT CASE"
                   + "\n" + "                                                     WHEN INSTR(codes.t_code, '/', 1, 1) != 0"
                   + "\n" + "                                                         THEN '2' || 'YYY' || SUBSTR(codes.t_code, 1, 4)"
                   + "\n" + "                                                     WHEN codes.t_code = ''"
                   + "\n" + "                                                         THEN 'X' || 'YYY' || codes.t_code"
                   + "\n" + "                                                     ELSE '2' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 END"
                   + "\n" + "                                            FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                           WHERE codes.t_codeKind = " + RCB_PTCK_BANKREGNUM
                   + "\n" + "                                             AND codes.t_partyId  = party.t_id)"

                   + "\n" + "                                WHEN party.t_isBank = 1 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN (NVL((SELECT CASE"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 8"
                   + "\n" + "                                                              THEN '4' || 'XXX' || codes.t_code || 'XXX'"
                   + "\n" + "                                                          WHEN LENGTH(codes.t_code) = 11"
                   + "\n" + "                                                              THEN '4' || SUBSTR(codes.t_code, 9, 3) || codes.t_code"
                   + "\n" + "                                                          ELSE '4' || 'YYY' || codes.t_code" // по идее сюда никогда не попадём
                   + "\n" + "                                                      END t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_SWIFT
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '4'|| 'YYY' || 'HP'))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '1' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '1' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isEmployer = 1"
                   + "\n" + "                                    THEN (NVL((SELECT '6' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_OGRN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '6' || 'YYY' || ''))"

                   + "\n" + "                                WHEN party.t_isPhisical = 0 AND party.t_isResident = 0"
                   + "\n" + "                                    THEN '3'|| 'YYY' || 'HP'"
                   + "\n" + "                                WHEN party.t_isPhisical = 1 AND party.t_isResident = 1 AND party.t_isEmployer = 0"
                   + "\n" + "                                    THEN (NVL((SELECT '5' || 'YYY' || codes.t_code"
                   + "\n" + "                                                 FROM dRepPartyCodes_vw codes"
                   + "\n" + "                                                WHERE codes.t_codeKind = " + RCB_PTCK_INN
                   + "\n" + "                                                  AND codes.t_partyId  = party.t_id), '5' || 'YYY' || ''))"
                   + "\n" + "                                ELSE 'X' || 'YYY' || ''"
                   + "\n" + "                            END t_identifier"
                   + "\n" + "                        FROM dRepLinkedObjects_vw link,"
                   + "\n" + "                             dRepParty_vw party"
                   + "\n" + "                       WHERE acc.t_objectId               = link.t_connectObjectId"
                   + "\n" + "                         AND party.t_objectId             = link.t_id"
                   + "\n" + "                         AND link.t_isInstalledForEndDate = 1"
                   + "\n" + "                         AND link.t_connectObjectType     = 4"
                   + "\n" + "                         AND link.t_type                  = 3"
                   + "\n" + "                         AND link.t_role                  = 59"
                   + "\n" + "                    ),"
                   + "\n" + "                    'X' || 'YYY' || ''"
                   + "\n" + "                   )"
                   + "\n" + "       END                                                                 identifier,"
                   //графа 15
                   + "\n" + "       (SELECT CASE category.t_value"
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Ссуда")             + " THEN " + getSqlString("1")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_Депозит")           + " THEN " + getSqlString("2")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ДолгОбязательство") + " THEN " + getSqlString("3")
                   + "\n" + "                    WHEN " + getSqlString("Обрем_ИноеОбяз")          + " THEN " + getSqlString("4")
                   + "\n" + "                    ELSE " + getSqlString("")
                   + "\n" + "               END"
                   + "\n" + "          FROM dRepCategory_vw category,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE category.t_id = " + RCB_OBJGROUP_FOR_REPORTING
                   + "\n" + "           AND category.t_objectType = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND category.t_value = ANY(" + getSqlString("Обрем_Ссуда") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_Депозит") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ДолгОбязательство") + ","
                   + "\n" + "                                      " + getSqlString("Обрем_ИноеОбяз") + ""
                   + "\n" + "                                     )"
                   + "\n" + "           AND category.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND category.t_objectId              = objLink.t_id"
                   + "\n" + "           AND objLink.t_type                   = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                   = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate  = 1"
                   + "\n" + "           AND objLink.t_connectObjectType      = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId        = acc.t_objectId"
                   + "\n" + "       ) onerousClaimCategory,"
                   //графа 16
                   + "\n" + "       (SELECT acc2.t_outCoverRest"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) restLinkedAccount,"
                   //графа 17
                   + "\n" + "       (SELECT TO_CHAR(rep_note.getDateAccountNote(acc2.t_objectId, 16, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + "), 'DD.MM.YYYY')"
                   + "\n" + "          FROM dRepAccount_vw acc2,"
                   + "\n" + "               dRepLinkedObjects_vw objLink"
                   + "\n" + "         WHERE acc2.t_chapter = TO_NUMBER(SUBSTR(objLink.t_id, 0, 2))"
                   + "\n" + "           AND acc2.t_fiId = TO_NUMBER(SUBSTR(objLink.t_id, 3, 7), 'XXXXXXX')"
                   + "\n" + "           AND acc2.t_account = SUBSTR(objLink.t_id, 10)"
                   + "\n" + "           AND objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
                   + "\n" + "           AND objLink.t_isInstalledForEndDate = 1"
                   + "\n" + "           AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
                   + "\n" + "           AND objLink.t_connectObjectId       = acc.t_objectId"
                   + "\n" + "       ) redemptionDate";

        queryForData = queryForData
                   + "\n" + "  FROM accountTable acc,"//Определение accountTable вынесено в секцию WITH для возможности материализации отобранных данных
                   + "\n" + "       drepparty_vw prt,"
                   + "\n" + "       (SELECT *"
                   + "\n" + "          FROM dreppartycodes_vw partyсode,"
                   + "\n" + "               drepparty_vw      repparty_"
                   + "\n" + "         WHERE repparty_.t_id = partyсode.t_partyId"
                   + "\n" + "               -- для центробанка БИК (ЦБ РФ)"
                   + "\n" + "           AND (  (    repparty_.t_isCentralBank = 1"
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_BIC + ")"
                   + "\n" + "               -- для нерезидентов проверка принадлежности 'Участники SWIFT'"
                   + "\n" + "           OR (  (    repparty_.t_isResident = 0"
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_SWIFT + ")"
                   + "\n" + "               -- для резидентов отбираем 'Регистрационный номер'"
                   + "\n" + "               OR (    repparty_.t_isResident = 1"
                   + "\n" + "                   AND repparty_.t_isCentralBank = 0"
                   + "\n" + "                   AND partyсode.t_codekind   = " + RCB_PTCK_BANKREGNUM + ")))) reppartycodes"
                   + "\n" + " WHERE prt.t_id = NVL(DECODE(acc.t_partyId, "
                   + "\n" + "                         " + {OurBank} + ", "
                   + "\n" + "                             acc.t_contragentId),"
                   + "\n" + "                             acc.t_partyId)"
                   + "\n" + "   AND prt.t_id = reppartycodes.t_partyid(+)"
                   ;

        return QueryForData;
    end;

    private macro addRelationsQuery()
        var query;

        query =  ","
        + "\n" + "       CASE"
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isRepoAccount,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isGD,                                                                                                                                                                     "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN 1                                                                                                                                                                "
        + "\n" + "           ELSE 0                                                                                                                                                                    "
        + "\n" + "       END isThirdPerson,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                     + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "               THEN '*'                                                                                                                                                              "
        + "\n" + "           ELSE ''                                                                                                                                                                   "
        + "\n" + "       END singDepending,                                                                                                                                                            "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN (rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_ACTIVEKIND + ", 'Третье лицо', data.objectId, "
                                                                      + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") <> 0"
        + "\n" + "                 AND rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "
                                                            + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ") IS NOT NULL)       "
        + "\n" + "                            THEN ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId, "
                                                                                                              + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                              + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 2, 1)) * 256  "
        + "\n" + "                               + ASCII(substr(utl_raw.cast_to_varchar2(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ", data.objectId,              "
                                                                                                              + RCB_NOTEKIND_SIGNDEPENDING_NUMBERPROLONGATIONS + ", "     //примечание Признак зависимости. Количество пролонгаций
                                                                                                              + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")), 1, 1))        "
        + "\n" + "           ELSE -1                                                                                                                                                                   "
        + "\n" + "       END prolongationAmount,                                                                                                                                                       "
        + "\n" + "       rsi_rsb_kernel.ExtractText(rsi_rsb_kernel.GetNote(" + RCB_OBJTYPE_ACCOUNT + ",  data.objectId, " + RCB_NOTEKIND_SIGNDEPENDING_EXPLANATIONS + ", "
                                                                             + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")) AS explanation,                                                                                                                                                              "
        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN isResident <> 0                                                                                                                                                      "
        + "\n" + "               THEN RSI_RSBPARTY.PT_GetPartyCode(partyId, 3)                                                                                                                         "
        + "\n" + "           ELSE ''                                                                                                                                                                   "
        + "\n" + "       END BIC,                                                                                                                                                                      "
        + "\n" + "       SUBSTR(onerousClaim, 2) onerousClaim,                                                                                                                                         "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(onerousClaim, 1, 1) = 'X'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(onerousClaim, 1, 1)"
        + "\n" + "       END onerousSign,"

        + "\n" + "       SUBSTR(identifier, 5) identifier,                                                                                                                                             "

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 2, 3) = 'YYY'                                                                                                                                     "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 2, 3)"
        + "\n" + "       END swiftDepartment,"

        + "\n" + "       CASE                                                                                                                                                                          "
        + "\n" + "           WHEN SUBSTR(identifier, 1, 1) = 'X'                                                                                                                                       "
        + "\n" + "               THEN ''                                                                                                                                                               "
        + "\n" + "           ELSE SUBSTR(identifier, 1, 1)"
        + "\n" + "       END conditionalCode,"

        + "\n" + "       NVL(onerousClaimCategory, " + getSqlString("") + ") onerousClaimCategory,                                                                                                                                                         "

        + "\n" + "       CASE"
        + "\n" + "           WHEN     onerousClaimCategory IS NOT NULL"
        + "\n" + "                AND onerousClaimCategory = '4'"
        + "\n" + "           THEN NVL((SELECT rep_note.getTextAccountNote(objLink.t_id, 69, " + getSqlDate(rcbApplication.currentReport.context.period.endDate()) + ")"
        + "\n" + "                       FROM dRepLinkedObjects_vw objLink"
        + "\n" + "                      WHERE objLink.t_type                  = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_role                  = " + RCB_OBJROLE_ACC_ONEROUS_CLAIM
        + "\n" + "                        AND objLink.t_isInstalledForEndDate = 1"
        + "\n" + "                        AND objLink.t_connectObjectType     = " + RCB_OBJTYPE_ACCOUNT
        + "\n" + "                        AND objLink.t_connectObjectId       = data.objectId"
        + "\n" + "                    ),"
        + "\n" + "                    CHR(1)"
        + "\n" + "                   )"
        + "\n" + "           ELSE " + getSqlString("")
        + "\n" + "       END otherDecoding,"

        + "\n" + "       restLinkedAccount,                                                                                                                                                            "
        + "\n" + "       redemptionDate                                                                                                                                                                "
        + "\n" + "  FROM ("+ getQueryForData() + ") data, (dual)";

        return query;
    end;

    macro cacheData(filter : String)
        var query =  "SELECT account,"
            + "\n" + "       accountId accId,"
            + "\n" + "       SUBSTR(balance, 1, 5) bal,"
            + "\n" + "       account AS prAcc,"
            + "\n" + "       name,"
            + "\n" + "       regNumber,"
            + "\n" + "       DECODE(nrCountry, CHR(1), '???', (SELECT t_CodeNum3 FROM dcountry_dbt WHERE t_CodeLat3 = nrCountry)) countryCode,"
            + "\n" + "       begRest,"
            + "\n" + "       debet,"
            + "\n" + "       credit,"
            + "\n" + "       endRest,"
            + "\n" + "       objectId,"
            + "\n" + "       operationEndDate,"
            + "\n" + "       partyID,"
            + "\n" + "       part,"
            + "\n" + "       typeAccount,"
            + "\n" + "       kindAccount,"
            + "\n" + "       chapter,"
            + "\n" + "       isexistcorrect,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ") OR (" + convertMaskToSQLFormat("32401, 32402", "balance") + ")"
            + "\n" + "           THEN CASE"
            + "\n" + "                    WHEN endRest = 0"
            + "\n" + "                     AND (   (begRest != 0)"
            + "\n" + "                          OR (credit != 0)"
            + "\n" + "                          OR (debet != 0)"
            + "\n" + "                         )"
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)"
            + "\n" + "                            FROM drepdocument_vw doc"
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND (   (    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId"
            + "\n" + "                                     )"
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId"
            + "\n" + "                                     )"
            + "\n" + "                                 )"
            + "\n" + "                         )"
            + "\n" + "                    WHEN endRest != 0"
            + "\n" + "                    THEN NULL"
            + "\n" + "                END"
            + "\n" + "           ELSE CASE"
            + "\n" + "                    WHEN (   (" + ternary(TF501Settings().isUseMmDealsData(), "1 = 0", "1 = 1") + ")"
            + "\n" + "                          OR NOT EXISTS (SELECT 1"
            + "\n" + "                                           FROM mmDeals"
            + "\n" + "                                          WHERE mmDeals.t_part = part"
            + "\n" + "                                            AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                                        )"
            + "\n" + "                         )"
            + "\n" + "                    THEN NVL(rep_note.readMaturityDate(objectId," + SQL_END_DATE + "), NVL(operationEndDate," + getSqlDate(Date(0,0,0)) + "))"
            + "\n" + "                    ELSE NVL((SELECT MAX(mmDeals.t_plannedFinishDate)"
            + "\n" + "                                FROM mmDeals"
            + "\n" + "                               WHERE mmDeals.t_part = part"
            + "\n" + "                                 AND account = mmDeals.t_mainRestAccount"
            + "\n" + "                             )," + getSqlDate(Date(0,0,0))
            + "\n" + "                            )"
            + "\n" + "                END"
            + "\n" + "       END AS perfomanceDate,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN (" + convertMaskToSQLFormat(m_BalanceList, "balance") + ")"
            + "\n" + "           THEN CASE"
            + "\n" + "                    WHEN endRest = 0"
            + "\n" + "                     AND (   (begRest != 0)"
            + "\n" + "                          OR (credit != 0)"
            + "\n" + "                          OR (debet != 0)"
            + "\n" + "                         )"
            + "\n" + "                    THEN (SELECT MAX(doc.t_date)"
            + "\n" + "                            FROM drepdocument_vw doc"
            + "\n" + "                           WHERE doc.t_date <= " + SQL_END_DATE
            + "\n" + "                             AND (   (    kindAccount != " + getSqlString("П")
            + "\n" + "                                      AND doc.t_creditAccountId = accountId"
            + "\n" + "                                     )"
            + "\n" + "                                  OR (    kindAccount = " + getSqlString("П")
            + "\n" + "                                      AND doc.t_debetAccountId = accountId"
            + "\n" + "                                     )"
            + "\n" + "                                 )"
            + "\n" + "                         )"
            + "\n" + "                    WHEN endRest != 0"
            + "\n" + "                    THEN NULL --использовать perfomanceDate, фактически в переменной будет 'д/в', в экспорте '-1'"
            + "\n" + "                END"
            + "\n" + "           ELSE NULL --в экспорте использовать perfomanceDate"
            + "\n" + "       END AS perfomanceDateKliko,"
            + "\n" + "       CASE"
            + "\n" + "           WHEN rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'ГД', data.objectId, " + SQL_END_DATE + ") != 0"
            + "\n" + "           THEN NULL"
            + "\n" + "           WHEN (   (" + ternary(TF501Settings().isUseMmDealsData(), "1 = 0", "1 = 1") + ")"
            + "\n" + "                 OR NOT EXISTS (SELECT 1"
            + "\n" + "                                  FROM mmDeals"
            + "\n" + "                                 WHERE mmDeals.t_part = part"
            + "\n" + "                                   AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                               )"
            + "\n" + "                )"
            + "\n" + "           THEN NVL(rep_note.readRate(data.objectId," + SQL_END_DATE + "), 0)"
            + "\n" + "           ELSE (SELECT CASE"
            + "\n" + "                            WHEN mmDeals.t_isOverNight = 1"
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount"
            + "\n" + "                                             *(SELECT rateHistory.t_rate"
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory    "
            + "\n" + "                                                WHERE rateHistory.t_dealId = deals.t_id"
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7"
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                                 WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7"
            + "\n" + "                                                                                   AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                               )"
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                                         rateHistory.t_rate"
            + "\n" + "                                              )"
            + "\n" + "                                            )"
            + "\n" + "                                       / SUM(deals.t_dealAmount)"
            + "\n" + "                                    FROM repMmDeals_vw deals"
            + "\n" + "                                   WHERE deals.t_kind = mmDeals.t_kind"
            + "\n" + "                                     AND (   (mmDeals.t_mainRestAccount = deals.t_mainRestAccount)"
            + "\n" + "                                          OR (mmDeals.t_delaydMainRestAcc = deals.t_delaydMainRestAcc)"
            + "\n" + "                                         )"
            + "\n" + "                                     AND deals.t_contragentId = mmDeals.t_contragentId"
            + "\n" + "                                     AND (   deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                          OR (    deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )"
            + "\n" + "                                         )"
            + "\n" + "                                 )"
            + "\n" + "                            WHEN mmDeals.t_isOverNight != 1"
            + "\n" + "                             AND mmDeals.t_isProlongingDeal = " + getSqlString("YES")
            + "\n" + "                            THEN (SELECT SUM( deals.t_dealAmount"
            + "\n" + "                                             *(SELECT rateHistory.t_rate"
            + "\n" + "                                                 FROM repMmDealRateHistory_vw rateHistory"
            + "\n" + "                                                WHERE rateHistory.t_dealId = deals.t_id"
            + "\n" + "                                                  AND rateHistory.t_percentKind = 7"
            + "\n" + "                                                  AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                                  FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                                 WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                                   AND rh.t_percentKind = 7"
            + "\n" + "                                                                                   AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                               )"
            + "\n" + "                                                GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                                         rateHistory.t_rate"
            + "\n" + "                                              )"
            + "\n" + "                                            )"
            + "\n" + "                                       / SUM(deals.t_dealAmount)"
            + "\n" + "                                    FROM repMmDeals_vw deals"
            + "\n" + "                                   WHERE (   (   deals.t_openDate < " + SQL_BEGIN_DATE
            + "\n" + "                                              AND " + SQL_BEGIN_DATE + " <= deals.t_closeDate"
            + "\n" + "                                             )"
            + "\n" + "                                          OR deals.t_openDate BETWEEN " + SQL_BEGIN_DATE + " AND " + SQL_END_DATE
            + "\n" + "                                         )"
            + "\n" + "                                     AND deals.t_mainRestAccount = mmDeals.t_mainRestAccount"
            + "\n" + "                                 CONNECT BY PRIOR deals.t_id = deals.t_prolongingDealId"
            + "\n" + "                                   START WITH deals.t_id = mmDeals.t_id"
            + "\n" + "                                 )"
            + "\n" + "                            ELSE (SELECT rateHistory.t_rate"
            + "\n" + "                                    FROM repMmDealRateHistory_vw rateHistory"
            + "\n" + "                                   WHERE rateHistory.t_dealId = mmDeals.t_id"
            + "\n" + "                                     AND rateHistory.t_percentKind = 7"
            + "\n" + "                                     AND rateHistory.t_rateDate = (SELECT MAX(rh.t_rateDate)"
            + "\n" + "                                                                     FROM repMmDealRateHistory_vw rh"
            + "\n" + "                                                                    WHERE rh.t_dealId = rateHistory.t_dealId"
            + "\n" + "                                                                      AND rh.t_percentKind = 7"
            + "\n" + "                                                                      AND rh.t_rateDate <= " + SQL_END_DATE
            + "\n" + "                                                                  )"
            + "\n" + "                                   GROUP BY rateHistory.t_dealId,"
            + "\n" + "                                            rateHistory.t_rate"
            + "\n" + "                                 )"
            + "\n" + "                        END t_rate"
            + "\n" + "                   FROM mmDeals"
            + "\n" + "                  WHERE mmDeals.t_part = part"
            + "\n" + "                    AND account = ANY (mmDeals.t_mainRestAccount, mmDeals.t_delaydMainRestAcc)"
            + "\n" + "                    AND mmDeals.t_id = (SELECT MAX(maxId.t_id)"
            + "\n" + "                                          FROM mmDeals maxId"
            + "\n" + "                                         WHERE maxId.t_part = mmDeals.t_part"
            + "\n" + "                                           AND (   (mmDeals.t_mainRestAccount = maxId.t_mainRestAccount)"
            + "\n" + "                                                OR (mmDeals.t_delaydMainRestAcc = maxId.t_delaydMainRestAcc)"
            + "\n" + "                                               )"
            + "\n" + "                                           AND maxId.t_plannedFinishDate = (SELECT MAX(maxDate.t_plannedFinishDate)"
            + "\n" + "                                                                              FROM mmDeals maxDate"
            + "\n" + "                                                                             WHERE maxDate.t_part = maxId.t_part"
            + "\n" + "                                                                               AND (   (maxId.t_mainRestAccount = maxDate.t_mainRestAccount)"
            + "\n" + "                                                                                    OR (maxId.t_delaydMainRestAcc = maxDate.t_delaydMainRestAcc)"
            + "\n" + "                                                                                   )"
            + "\n" + "                                                                           )"
            + "\n" + "                                       )"
            + "\n" + "                )"
            + "\n" + "       END AS rate";

            query = query + addRelationsQuery();

            query =  ""
            + "\n" + "WITH tune"
            + "\n" + "  AS (" + TF501Global().getTune().getQuery() + "),"
            + "\n" + "  accountSrcTable"
            + "\n" + "  AS (SELECT acc.t_chapter, acc.t_account, acc.t_accountId, acc.t_fiId, acc.t_kind, acc.t_balance, acc.t_inCoverRest, acc.t_outCoverRest,"
            + "\n" + "             acc.t_objectId, acc.t_operationDate, acc.t_daysToEnd, acc.t_partyId, acc.t_contragentId,"
            + "\n" + "             t501.t_subPart t_part,"
            + "\n" + "             1 AS t_typeAccount"
            + "\n" + "        FROM drepaccount_vw acc,"
            + "\n" + "             tune t501"
            + "\n" + "       WHERE acc.t_isOpened = 1"
            + "\n" + "         AND acc.t_chapter = 1"
            + "\n" + "         AND RSB_MASK.COMPARESTRINGWITHMASK(t501.t_accountMasks, acc.t_account) = 1"
            + "\n" + "         AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'РЕПО ч/з ЦК', acc.t_objectId, "
                                                                       + SQL_END_DATE + ") = 0"
            + "\n" + "         AND  rsb_rep_ac.CheckObjAttrPresenceByNum(" + RCB_OBJTYPE_ACCOUNT + ", " + RCB_OBJGROUP_FOR_REPORTING + ", 'Исключить из расчета', acc.t_objectId, "
                                                                       + SQL_END_DATE + ") = 0"
            + "\n" + "         AND (   (    (SELECT party.t_isBank"
            + "\n" + "                         FROM dRepParty_vw party"
            + "\n" + "                        WHERE party.t_id = acc.t_contragentId"
            + "\n" + "                      ) = 1"
            + "\n" + "                   AND NOT EXISTS(SELECT 1"
            + "\n" + "                                    FROM dBankDprtRstr_dbt bnkRstr"
            + "\n" + "                                   WHERE bnkRstr.t_partyId = acc.t_contragentId"
            + "\n" + "                                     AND bnkRstr.t_rstr = 'LWRS'"
            + "\n" + "                                     AND bnkRstr.t_rstrDate <= " + SQL_END_DATE
            + "\n" + "                                 )"
            + "\n" + "                 )"
            + "\n" + "              OR (SELECT party.t_isCentralBank"
            + "\n" + "                    FROM dRepParty_vw party"
            + "\n" + "                   WHERE party.t_id = acc.t_contragentId"
            + "\n" + "                 ) = 1"
            + "\n" + "             )"
            + "\n" + "         AND EXISTS (SELECT 1"
            + "\n" + "                       FROM drestdate_dbt turns"
            + "\n" + "                      WHERE turns.t_accountId = acc.t_accountId"
            + "\n" + "                        AND turns.t_restDate = " + SQL_END_DATE
            + "\n" + "                        AND (   turns.t_debet <> 0"
            + "\n" + "                             OR turns.t_credit <> 0"
            + "\n" + "                            )"
            + "\n" + "                    )"
            + "\n" + "         AND acc.t_outCoverRest > " + TF501Settings().getThreshold(SQL_END_DATE)
            + "\n" + "     ),"
            + "\n" + "  mmDeals"
                   + ternary(TF501Settings().isUseMmDealsData(),
              "\n" + "  AS (SELECT deals.t_id,"
            + "\n" + "             deals.t_mainRestAccount,"
            + "\n" + "             deals.t_delaydMainRestAcc,"
            + "\n" + "             deals.t_plannedFinishDate,"
            + "\n" + "             deals.t_isOverNight,"
            + "\n" + "             deals.t_kind,"
            + "\n" + "             deals.t_contragentId,"
            + "\n" + "             deals.t_isProlongingDeal,"
            + "\n" + "             CASE deals.t_kind"
            + "\n" + "                 WHEN '" + DEAL_KIND_PLACEMENT + "' THEN 1"
            + "\n" + "                 WHEN '" + DEAL_KIND_ATTRACTION + "' THEN 2"
            + "\n" + "                 ELSE 0"
            + "\n" + "             END t_part"
            + "\n" + "        FROM repMmDeals_vw deals"
            + "\n" + "       WHERE deals.t_kind IN ('" + DEAL_KIND_PLACEMENT + "', '" + DEAL_KIND_ATTRACTION + "')"
            + "\n" + "         AND deals.t_isOpened = 1"
            + "\n" + "     ),",
              "\n" + "  AS (SELECT 0                                AS t_id,"
            + "\n" + "             CHR(1)                           AS t_mainRestAccount,"
            + "\n" + "             CHR(1)                           AS t_delaydMainRestAcc,"
            + "\n" + "             TO_DATE('01010001', 'ddmmyyyy')  AS t_plannedFinishDate,"
            + "\n" + "             0                                AS t_isOverNight,"
            + "\n" + "             CHR(1)                           AS t_kind,"
            + "\n" + "             0                                AS t_contragentId,"
            + "\n" + "             CHR(1)                           AS t_isProlongingDeal,"
            + "\n" + "             0                                AS t_part"
            + "\n" + "        FROM DUAL"
            + "\n" + "     ),"
                            )
            + "\n" + "  accountTable"
            + "\n" + "  AS (SELECT /*+ MATERIALIZE*/ *"
            + "\n" + "        FROM accountSrcTable"
            + "\n" + "     )"
            + "\n" + "SELECT account,"
            + "\n" + "       accId,"
            + "\n" + "       bal,"
            + "\n" + "       prAcc,"
            + "\n" + "       name,"
            + "\n" + "       regNumber,"
            + "\n" + "       countryCode,"
            + "\n" + "       begRest,"
            + "\n" + "       debet,"
            + "\n" + "       credit,"
            + "\n" + "       endRest,"
            + "\n" + "       partyId,"
            + "\n" + "       part,"
            + "\n" + "       kindAccount,"
            + "\n" + "       typeAccount,"
            + "\n" + "       perfomanceDate,"
            + "\n" + "       perfomanceDateKliko,"
            + "\n" + "       isRepoAccount,"
            + "\n" + "       CASE "
            + "\n" + "           WHEN (rate < 0)"
            + "\n" + "             THEN"
            + "\n" + "                 CASE"
            + "\n" + "                     WHEN EXISTS(SELECT 1"
            + "\n" + "                                   FROM daccount_dbt acc, dmcaccdoc_dbt mcacc, dmccateg_dbt cat"
            + "\n" + "                                  WHERE cat.t_code IN('+МС', '-МС')"
            + "\n" + "                                    AND acc.t_accountId = accId"
            + "\n" + "                                    AND mcacc.t_account = acc.t_account"
            + "\n" + "                                    AND mcacc.t_currency = acc.t_code_currency"
            + "\n" + "                                    AND mcacc.t_chapter = acc.t_chapter"
            + "\n" + "                                    AND mcacc.t_catId = cat.t_id"

            + "\n" + "                                 )"
            + "\n" + "                          THEN 0"
            + "\n" + "                     ELSE rate"
            + "\n" + "                 END"
            + "\n" + "           ELSE rate"
            + "\n" + "       END rate,"
            + "\n" + "       isGD,"
            + "\n" + "       isThirdPerson,"
            + "\n" + "       singDepending,"
            + "\n" + "       prolongationAmount,"
            + "\n" + "       explanation,"
            + "\n" + "       BIC,"
            + "\n" + "       onerousClaim,"
            + "\n" + "       identifier,"
            + "\n" + "       onerousClaimCategory,"
            + "\n" + "       restLinkedAccount,"
            + "\n" + "       redemptionDate,"
            + "\n" + "       onerousSign,"
            + "\n" + "       swiftDepartment,"
            + "\n" + "       conditionalCode,"
            + "\n" + "       otherDecoding,"
            + "\n" + "       isExistCorrect"
            + "\n" + "  FROM (" + query + ")"
            + "\n" + " WHERE begRest <> 0"
            + "\n" + "    OR debet   <> 0"
            + "\n" + "    OR credit  <> 0"
            + "\n" + "    OR endRest <> 0";

        sql_execute("INSERT INTO df501_ar_tmp"
                      + "\n" + "("
                      + "\n" + " t_account,"
                      + "\n" + " t_accountId,"
                      + "\n" + " t_balance,"
                      + "\n" + " t_printedAccount,"
                      + "\n" + " t_clientName,"
                      + "\n" + " t_regNumber,"
                      + "\n" + " t_countryCode,"
                      + "\n" + " t_beginRest,"
                      + "\n" + " t_debet,"
                      + "\n" + " t_credit,"
                      + "\n" + " t_endRest,"
                      + "\n" + " t_clientCode,"
                      + "\n" + " t_partReport,"
                      + "\n" + " t_kindAccount,"
                      + "\n" + " t_typeAccount,"
                      + "\n" + " t_perfomanceDate,"
                      + "\n" + " t_perfomanceDateKliko,"
                      + "\n" + " t_isRepoAccount,"
                      + "\n" + " t_rate,"
                      + "\n" + " t_isGD,"
                      + "\n" + " t_isThirdPerson,"
                      + "\n" + " t_singDepending,"
                      + "\n" + " t_prolongationAmount,"
                      + "\n" + " t_explanation,"
                      + "\n" + " t_BIC,"
                      + "\n" + " t_onerousClaim,"
                      + "\n" + " t_identifier,"
                      + "\n" + " t_onerousClaimCategory,"
                      + "\n" + " t_restLinkedAccount,"
                      + "\n" + " t_redemptionDate,"
                      + "\n" + " t_onerousSign,"
                      + "\n" + " t_swiftDepartment,"
                      + "\n" + " t_conditionalCode,"
                      + "\n" + " t_otherDecoding,"
                      + "\n" + " t_isExistCorrect"
                      + "\n" + ")"
                      + "\n" + query
                   );

        sql_execute("COMMIT");

        return this;
    end;

    macro getData(filter : String, attribute : RcbAttributeBase)
        return RcbDataset("SELECT t_account AS t_account,"
                 + "\n" + "       t_accountId AS t_accountId,"
                 + "\n" + "       t_balance AS t_balance,"
                 + "\n" + "       t_printedAccount AS t_accountForPrint,"
                 + "\n" + "       t_clientName AS t_clientName,"
                 + "\n" + "       t_regNumber AS t_regNumber,"
                 + "\n" + "       t_countryCode AS t_countryCode,"
                 + "\n" + "       t_beginRest AS t_inRest,"
                 + "\n" + "       t_debet AS t_debetTurnover,"
                 + "\n" + "       t_credit AS t_creditTurnover,"
                 + "\n" + "       t_endRest AS outRest,"
                 + "\n" + "       t_clientCode AS t_accountClientCode,"
                 + "\n" + "       t_partReport AS t_partReport,"
                 + "\n" + "       t_kindAccount AS t_accountKind,"
                 + "\n" + "       t_typeAccount AS t_accountType,"
                 + "\n" + "       t_perfomanceDate AS t_performanceDate,"
                 + "\n" + "       t_perfomanceDateKliko AS t_performanceDateKliko,"
                 + "\n" + "       t_isRepoAccount AS t_repoAccountSign,"
                 + "\n" + "       t_rate AS t_percentValue,"
                 + "\n" + "       t_isGD AS t_gdSign,"
                 + "\n" + "       t_isThirdPerson AS t_thirdPartySign,"
                 + "\n" + "       t_singDepending AS t_dependencySign,"
                 + "\n" + "       t_prolongationAmount AS t_prolongationCount,"
                 + "\n" + "       t_explanation AS t_explanations,"
                 + "\n" + "       t_BIC AS t_bic,"
                 + "\n" + "       t_onerousClaim AS t_encumbranceParty,"
                 + "\n" + "       t_identifier AS t_encumbrancePartyId,"
                 + "\n" + "       t_onerousClaimCategory AS t_encumbranceKind,"
                 + "\n" + "       t_restLinkedAccount AS t_encumbranceRest,"
                 + "\n" + "       t_redemptionDate AS t_maturityDate,"
                 + "\n" + "       t_onerousSign AS t_encumbranceSign,"
                 + "\n" + "       t_swiftDepartment AS t_swiftFilial,"
                 + "\n" + "       t_conditionalCode AS t_conditionalCode,"
                 + "\n" + "       t_otherDecoding AS t_otherDecoding,"
                 + "\n" + "       t_isExistCorrect AS t_correctDocSign"
                 + "\n" + "  FROM df501_ar_tmp sourceData"
                 + "\n" + " WHERE " + filter,
                          RSDVAL_SERVER, RSDVAL_FORWARD_ONLY
                         );
    end;

    private macro constructorTF501ArData(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTF501ArData(id, protocolView, dataSources);
end;

/**
 * Форма 501. Атрибуты формы. Базовый для разделов 1 и 2
 */
private class (RcbDataSource) TAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        throw(TPureVirtualMethodCallException("TAttributes::getPartFilter"));
    end;

    macro getData() : Object
        var dataset = m_datasources.getDatasource("501Data").getData(getPartFilter());

        return dataset;
    end;

    private macro constructorTAttributes(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initRcbDataSource(id, protocolView, dataSources);
    end;

    constructorTAttributes(id, protocolView, dataSources);
end;

/**
 * Форма 501. Атрибуты раздела 1
 */
private class (TAttributes) TAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        return " sourceData.t_partReport = 1";
    end;

    private macro constructorTAttributesPart1(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart1(id, protocolView, dataSources);
end;

/**
 * Форма 501. Атрибуты раздела 2
 */
private class (TAttributes) TAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
    private macro getPartFilter()
        return " sourceData.t_partReport = 2";
    end;

    private macro constructorTAttributesPart2(id : String, protocolView : RcbDataProtocolView, dataSources : RcbDataSources)
        initTAttributes(id, protocolView, dataSources);
    end;

    constructorTAttributesPart2(id, protocolView, dataSources);
end;

/**
 * Форма 501. Контейнер ИД
 */
class (RcbDataSources) TF501DataSources(protocolView : RcbCalculateProtocolView)
    macro getProtocolView()
        return m_protocolView;
    end;

    private macro initialize()
        m_dataSourcePool.push_back(TF501ArData("501Data", null, this));
        m_dataSourcePool.push_back(TAttributesPart1("part1Data", null, this));
        m_dataSourcePool.push_back(TAttributesPart2("part2Data", null, this));
    end;

    private macro constructorTF501DataSources(protocolView : RcbCalculateProtocolView)
        initRcbDataSources(protocolView);
    end;

    constructorTF501DataSources(protocolView);
end;
