/*
$Name:          f501ReportCalculateController.mac
$Module:        Отчеты ЦБ
$Description:   Форма 501. Класс контроллера расчета отчета.
*/

class (RcbReportCalculateController) TF501ReportCalculateController()
    private macro clearValues()
        getReport().getPart(TF501Global().getPart1Id()).getPartCompositeValue().removeAllValues();
        getReport().getPart(TF501Global().getPart2Id()).getPartCompositeValue().removeAllValues();
        RcbApplication().transactionManager.commit();
        getReport().getPart(TF501Global().getPart1Id()).clear();
        getReport().getPart(TF501Global().getPart2Id()).clear();
    end;

    private macro pushControllers()
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF501Global().getPart1Id()), this));
        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF501Global().getPart2Id()), this));
//        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF501Global().getUserInputPart1Id()), this));
//        m_partCalculateControllers.push_back(objectFactoryInstance.createPartCalculateController(getReport().getPart(TF501Global().getUserInputPart2Id()), this));
    end;

    private macro printAdditionalProtocolData()
        TF501Settings().printCalculationReport(getProtocolView());
    end;

    macro initialize() : Bool
        if (TF501Settings().isSecuritiesData())
            ActualAccNoteFor501(rcbApplication().currentReport().context.period.BeginDate, rcbApplication().currentReport().context.period.EndDate);
        end;

        clearValues();
        pushControllers();

        getDatasources().getDatasource("501Data").cacheData();

        return m_partCalculateControllers.size > 0;
    end;

    private macro postprocess()
    end;

    macro calculate()
        var result = calculate();
        for (var i, m_partCalculateControllers)
            i.getDataProtocolView().save();
        end;
        return result;
    end;

    private macro constructorTF501ReportCalculateController()
        initRcbReportCalculateController();
    end;

    constructorTF501ReportCalculateController();
end;
