/*─────────────────────────────────────────────────────────────────────────────────────────────────┐
  RS-Bank V6                                                                        R-Style Softlab
  Файл подсистемы "Регламентируемая отчетность"

  Расчет формы 251 предварительные действия.
└─────────────────────────────────────────────────────────────────────────────────────────────────*/
import calc_f251;

/***************************************************************************************************
 *  Блок обработки ошибок
 **************************************************************************************************/
/*
 *  Запуск макроса вне контекста отчета
 */
private class (TException) TNullCurrentReportException()
    InitTException("|Макрос должен быть запущен в контексте отчета");
end;

/*
 *  Неверная форма
 */
private class (TException) TWrongFormException()
    InitTException("|Макрос может быть выполнен только в контексте отчета по форме 251");
end;

/*
 *  Макрос запущен в режиме свода
 */
private class (TException) TSummaryModeException()
    InitTException("|Макрос не может быть запущен для сводного отчета");
end;

/***************************************************************************************************
 *  Основная функция
 **************************************************************************************************/
private macro main()
    private macro CheckReport()
        var formId = ternary(TParameters().getEndDate() < RCB_I2055_DATE, "Форма 251 до 2055-У", "Форма 251");

        if (rcbApplication().currentReport == NULL)
            Throw(TNullCurrentReportException());
        end;

        /*if (rcbApplication().currentReport.form.id != formId)
            Throw(TWrongFormException());
        end;*/

        if (rcbApplication().currentReport.context.isSummaryMode)
            Throw(TSummaryModeException());
        end;
    end;

    CheckReport();
    TTempTable().truncate();

    sql_execute("call rep_opt.clearOurBankTable()");
    sql_execute("call rep_opt.makeOurBankSlice()");

    sql_truncate("drepdepartment_tmp");

    sql_execute("CALL rep_data.setBalancePlanNumber(" + rcbApplication.parameters.balancePlanNumber + ")");
    sql_execute("CALL rep_data.setDepartmentCode(" + getSqlString(rcbDepartmentList.getAsSqlSetFilial()) + ", "
                                                           + getSqlString(rcbDepartmentList.getAsSqlSetVsp()) + ")");

    onError(error)
        exceptionMessage(error);
        УстановитьФлагВозврата(STOP_PROC_FLG);
        exit(1);
end;

/***************************************************************************************************
 *  Точка входа
 **************************************************************************************************/

main();
УстановитьФлагВозврата(OK_MACRO_FLAG);
exit(1);
