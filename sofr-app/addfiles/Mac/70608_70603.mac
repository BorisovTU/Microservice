IMPORT "or_rep_h.mac", dv_fun, "dv_categ.mac", "dl_car.mac", "dv_car.mac";

var Sql, Dt, Dt2, sql2;
var Счетдеб = TRecHandler("account");
var СчетКред = TRecHandler("account");
var tr;

var Query = " SELECT rsb_account.restac (t_account, t_code_currency, to_date('" + {Curdate} + "', 'DD.MM.YYYY'), t_chapter, 0) rest, "+
            "        (SELECT DISTINCT "+
            "               (CASE "+
            "                   WHEN t_account_payer = t_account THEN t_fiid_receiver "+
            "                   ELSE t_fiid_payer "+
            "                END) "+
            "                  t_fiid "+
            "          FROM dacctrn_dbt "+
            "         WHERE (t_account_payer = t_account OR t_account_receiver = t_account) "+
            "               AND t_result_carry IN (18, 83)) "+
            "          fiid, "+
            "       daccount_dbt.* "+
            "  FROM daccount_dbt "+
            " WHERE     t_open_close = CHR (0) "+
            "       AND SUBSTR (t_account, 10, 2) IN ('99') "+
            "       AND t_balance IN ('70608', '70603') "+
            "       AND rsb_account.restac (t_account, t_code_currency, to_date('" + {Curdate} + "', 'DD.MM.YYYY'), t_chapter,  0) <> 0 " ;
              
  sql = RsdCommand(Query);
  Dt = TRsbDataSet(sql);
  while (Dt.movenext())
         ClearRecord(СчетКред);
         ClearRecord(СчетДеб);
         Query = " select t_account from dmcaccdoc_dbt where t_catnum in "+ IIF(Dt.balance == "70608", "(1002)" ,"(1001)") + " and t_fiid = " + Dt.fiid;
         sql2 = RsdCommand(Query);
         Dt2 = TRsbDataSet(sql2);
         if (Dt2.movenext())
             if (Dt.Account != Dt2.Account)
                 if(Dt.balance == "70608")
                    DL_GetAccount(1, NATCUR, Dt.Account, СчетКред);
                    DL_GetAccount(1, NATCUR, Dt2.Account, СчетДеб); 
                 else
                    DL_GetAccount(1, NATCUR, Dt.Account, СчетДеб);
                    DL_GetAccount(1, NATCUR, Dt2.Account, СчетКред); 
                 end;
                 tr = RsbAccTransaction();
                 tr.Shifr_Oper = ""; // стираем, потом заполним правильно
                 tr.Chapter         = Dt.Chapter;
                 tr.Date_Carry      = {Curdate};
                 tr.Numb_Document   = 1;
                 tr.ResultCarry     = 1;
                 tr.Kind_Oper       = null;
                 tr.Ground          = "Перенос остатка со счета " + Dt.Account + " на счет " + Dt2.Account;
                 tr.Department      = {OperDprt};
                 tr.Oper            = {oper};
                 tr.FIIDPayer       = СчетДеб.rec.Code_Currency;
                 tr.FIIDReceiver    = СчетКред.rec.Code_Currency;
                 tr.AccountPayer    = СчетДеб.rec.Account;
                 tr.AccountReceiver = СчетКред.rec.Account;
                 if( tr.Shifr_Oper == "" )
                     tr.Shifr_Oper = DL_GetShifrOper(СчетДеб.rec.Chapter, СчетДеб.rec, СчетКред.rec);
                 end;   
                 tr.SumPayer      = ABS(Dt.rest);
                 tr.SumReceiver   = ABS(Dt.rest);   
   
                 if( not tr.Carry() )
                     return Msgbox("Ошибка при выполнении проводки");
                 end;
                 println(СчетДеб.rec.Account, "|", СчетКред.rec.Account, "|", Dt.rest) 
                 //PrintLine_Alg(СчетДеб.rec.Account, СчетКред.rec.Account, Dt.rest);  
             end;
       end;    
  end;
end;
