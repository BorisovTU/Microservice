/*
$Name:               KKM_VAL.MAC
$Module:             RS-Retail
$Description:        Работа с ККМ.  Описание общих переменных и констант.
*/

import BankInter,deprintr,prim,mercury,ncr_serv;


record PAY_DOC  ("pay_doc.dbt");   /* Строка коммунального платежа. */

const cTymeOut = 30;  /* Тайм-аут ожидания подкладного листа. */

const FlagComiss = 0;  /* Флаг учета комиссии */

/*  Параметры расположения формата подкладного документа  */
const payX   = 4;  /* Координата левого верхнего края оригинала по горизонтали - в позициях */
const payY   = 2;  /* Координата левого верхнего края оригинала по вертикали   - в строках */
const payOff = 3;  /* Смещение копии формы по вертикали - в строках */


/*********************************************************************
                               Файлы
*********************************************************************/
file person ( person, "bank.def" ); /* Список операционистов */


/*********************************************************************
                              Переменные
*********************************************************************/
var IsOpenShiftKKM = 0;           /* Смена открыта/закрыта         */
var IsFiscRegimKKM = 0;           /* Режим фискальный/нефискальный */
var WhatPrinterKKM = 0;           /* Принтер Epson/Lexmark         */
var DateKKM        = Date(0,0,0); /* Дата                          */
var TimeKKM        = Time(0,0,0); /* Время                         */
var NumberShiftKKM = 0;           /* Номер смены                   */
var NumberOperKKM  = 0;           /* Номер операции                */
var RegisNumberKKM = "";          /* Регистрационный номер         */
var OperPersonKKM  = 0;           /* Операционист                  */
var NamePersonKKM  = "";          /* Фамилия операциониста         */
var DocType        = 0;           /* Тип документа                 */
var SumPaySale     = $0.0L;       /* Сумма покупки/продажи         */
var {oper};                       /* Операционист системы          */
var TitleSB        = FALSE;       /* Вид выводимого титула         */

var FNCashVal      = NumFNCash();


/*********************************************************************
                              Константы
*********************************************************************/
const YES                     =   1;
const NO                      =   0;

const RSKKM_PD4_COPY_DISTANCE =   4; /* Отступ от чека на подкладном документе до его копии */
const RSKKM_PD4_NO_NEED_COPY  =   0; /* Не нужна копия                                      */

const TabX                    =   1; /* Отступ от края для печати чека                      */
const TabXPD                  =   3; /* Отступ от края для печати подкладного документа     */

const RSKKM_LENGTH_NAMEPERSON =  21; /* Допустимая длина имени операциониста для ККМ        */

const RSKKM_OPENSHIFT_TYPE0   =   0; /* Открытие смены с печатью в реальном режиме          */
const RSKKM_OPENSHIFT_TYPE1   =   1; /* Открытие смены с отложенной печатью на ленту        */
const RSKKM_OPENSHIFT_TYPE99  =  99; /* Открытие смены с печатью при завершении смены       */

const RSKKM_PRINT_CHECKDECK   =   1; /* Печать чека                                         */
const RSKKM_PRINT_PAPERDECK   =   2; /* Печать подкладного документа                        */

const RSKKM_FISC              =   1; /* Документ фискальный                                 */
const RSKKM_NOFISC            =   0; /* Документ нефискальный                               */

const RSKKM_DOCTYPE_PAYMENT   =   1; /* Тип документа - платеж                              */

const KKMSHIFT_OPEN           =   1; /* Смена открыта                                       */
const KKMSHIFT_CLOSE          =   0; /* Смена закрыта                                       */

const KKMPRINTER_LEXMARK      =   1; /* Тип принтера - LEXMARK                              */
const KKMPRINTER_EPSON        =   2; /* Тип принтера - EPSON                                */

const FirstLettersKKM         = "СТ";

const CHECK_TITLE_SB          = "*** СБЕРБАНК РОССИИ ***";
const CHECK_TITLE             = "***********************";
const RECEIVE_TITLE           = "Принято: ";
const CHANGE_TITLE            = "Сдача: ";

/* Коды проводок ККМ */
const DOC_NO                  =   0;
const DOC_PUT                 =   1;
const DOC_GET                 =   2;
const DOC_ANN                 =   3;
const DOC_RET                 =   4;
const DOC_BUY                 =   5;
const DOC_SALE                =   6;
const DOC_EXCH                =   7;

/* Коды операций ККМ */
const A_SEPR                  =   1;
const A_POS                   =  10;
const A_1GS                   =  12;
const AT_1GS                  =  15;
const A_AMNT                  =  18;
const A_1BASES                =  21;
const A_FIRM                  =  28;
const A_KKM                   =  30;
const A_FM                    =  32;
const A_OPRC                  =  34;
const AT_OPRC                 =  35;
const A_DATE                  =  38;
const A_TIME                  =  40;
const A_ISN                   =  42;
const A_DOC                   =  52;
const AT_DOC                  =  53;
const A_BASES                 =  67;
const A_ISB                   =  75;
const A_SUMB                  =  79;
const AT_SUMB                 =  81;
const A_PAYB                  =  83;
const AT_PAYB                 =  85;
const A_CHGB                  =  95;
const AT_CHGB                 =  97;
const A_BACKB                 =  99;
const AT_BACKB                = 101;
const A_END                   = 102;

const MaxLenCodeVal           = 14;

/* Коды ошибок */
const RSKKMERR_NO_ERROR       =   0; /* Успешное завершение                                 */
const RSKKMERR_ALREADY_CLOSE  = 901; /* Смена уже была закрыта ранее                        */
const RSKKMERR_NO_PERSON      = 902; /* Не задан операционист                               */
const RSKKMERR_NO_FINDPERSON  = 903; /* Операциониста нет в базе данных                     */
const RSKKMERR_NO_NAMEPERSON  = 904; /* Фамилия операциониста пустая                        */
const RSKKMERR_ALREADY_OPEN   = 905; /* Смена уже была открыта ранее                        */
const RSKKMERR_DELETE_DOC     = 906; /* Операция не прошла, документ подлежит удалению      */
const RSKKMERR_BAD_DOC        = 907; /* Операция с ошибкой, но зафиксирована в памяти       */
const RSKKMERR_CANNOT_STORN   = 908; /* Ошибка при сторнировании документа                  */
const RSKKMERR_NOT_DEVICE     = 909; /* Фискальная плата отсутствует                        */
const RSKKMERR_NO_MONEY       = 910; /* Не задана сумма операции                            */
const RSKKMERR_NO_OPEN        = 911; /* Смена не открыта                                    */
const RSKKMERR_COVER_OPEN     = 912; /* Крышка ККМ открыта                                  */
const RSKKMERR_PARAM          = 914; /* Ошибка в параметрах                                 */
const RSKKMERR_NO_CLOSE       = 915; /* Смена не закрыта                                    */
const RSKKMERR_NCR_KEY        = 916; /* Не установлен режим регистрации                     */

             /*****   Ошибки ККМ ПРИМ-07Ф   *****/
const RSKKMERR_PRIM01         = 921; /* Неверный формат сообщения                           */
const RSKKMERR_PRIM02         = 922; /* Неверный формат поля                                */
const RSKKMERR_PRIM03         = 923; /* Неверное дата/время                                 */
const RSKKMERR_PRIM04         = 924; /* Неверная контрольная сумма                          */
const RSKKMERR_PRIM05         = 925; /* Неверный пароль передачи данных                     */
const RSKKMERR_PRIM06         = 926; /* Нет команды с таким номером                         */
const RSKKMERR_PRIM07         = 927; /* Необходима команда "Начало сеанса"                  */
const RSKKMERR_PRIM08         = 928; /* Время изменилось больше чем на 24 часа              */
const RSKKMERR_PRIM09         = 929; /* Превышена максимальная длина строкового поля        */
const RSKKMERR_PRIM10         = 930; /* Превышена максимальная длина сообщения              */
const RSKKMERR_PRIM11         = 931; /* Неправильная операция                               */
const RSKKMERR_PRIM12         = 932; /* Значение поля вне диапазона                         */
const RSKKMERR_PRIM13         = 933; /* При данном состоянии документа команда не допустима */
const RSKKMERR_PRIM14         = 934; /* Обязательное строковое поле имеет нулевую длину     */
const RSKKMERR_PRIM15         = 935; /* Слишком большой результат                           */
const RSKKMERR_PRIM16         = 936; /* Переполнение денежного счетчика                     */
const RSKKMERR_PRIM17         = 937; /* Обратная операция невозможна: отсутствует прямая    */
const RSKKMERR_PRIM18         = 938; /* Нет столько наличных для выполнения операции        */
const RSKKMERR_PRIM19         = 939; /* Обратная операция превысила итог по прямой операции */
const RSKKMERR_PRIM20         = 940; /* Необходимо выполнить сертификацию                   */
const RSKKMERR_PRIM21         = 941; /* Необходимо закрыть смену                            */
const RSKKMERR_PRIM22         = 942; /* Таймаут при печати                                  */
const RSKKMERR_PRIM23         = 943; /* Неисправимая ошибка принтера                        */
const RSKKMERR_PRIM24         = 944; /* Принтер не готов к печати                           */
const RSKKMERR_PRIM25         = 945; /* Бумага близка к концу                               */
const RSKKMERR_PRIM26         = 946; /* Необходимо провести фискализацию                    */
const RSKKMERR_PRIM27         = 947; /* Неверный пароль налогового инспектора               */
const RSKKMERR_PRIM28         = 948; /* Регистратор уже сертифицирован                      */
const RSKKMERR_PRIM29         = 949; /* Исчерпано число фискализаций                        */
const RSKKMERR_PRIM30         = 950; /* Неверный буфер печати                               */
const RSKKMERR_PRIM31         = 951; /* Неверное G-поле                                     */
const RSKKMERR_PRIM32         = 952; /* Неверный номер типа оплаты                          */
const RSKKMERR_PRIM33         = 953; /* Таймаут приема                                      */
const RSKKMERR_PRIM34         = 954; /* Ошибка приема                                       */
const RSKKMERR_PRIM35         = 955; /* Неверное состояние регистратора                     */
const RSKKMERR_PRIM36         = 956; /* Слишком много операций на документе                 */
const RSKKMERR_PRIM37         = 957; /* Необходима команда "Начало смены"                   */
const RSKKMERR_PRIM38         = 958; /* Необходима команда "Печать контрольной ленты"       */
const RSKKMERR_PRIM39         = 959; /* Неверный номер вида платежа                         */
const RSKKMERR_PRIM40         = 960; /* Неверное состояние принтера                         */
const RSKKMERR_PRIM41         = 961; /* Смена уже открыта                                   */
const RSKKMERR_PRIM42         = 962; /* Таймаут ожидания бумаги на Slip                     */
const RSKKMERR_PRIM43         = 963; /* Неверная дата                                       */
const RSKKMERR_PRIM44         = 964; /*                                                     */
const RSKKMERR_PRIM45         = 965; /*                                                     */
const RSKKMERR_PRIM46         = 966; /*                                                     */
const RSKKMERR_PRIM47         = 967; /*                                                     */
const RSKKMERR_PRIM48         = 968; /* Фискальная память неисправна                        */
const RSKKMERR_PRIM49         = 969; /* Дата в фискальной памяти позже, чем дата операции   */
const RSKKMERR_PRIM50         = 970; /* Необходима инициализация фискальной памяти          */
const RSKKMERR_PRIM51         = 971; /* Заполнена вся фискальная память                     */
const RSKKMERR_PRIM52         = 972; /*                                                     */
const RSKKMERR_PRIM53         = 973; /*                                                     */
const RSKKMERR_PRIM54         = 974; /*                                                     */

            /*****   Ошибки ККМ Меркурий-114Ф   *****/
const RSKKMERR_MERC01         = 701; /* Ошибка в фискальных данных                          */
const RSKKMERR_MERC02         = 702; /* Не закрыта смена                                    */
const RSKKMERR_MERC03         = 703; /* Исчерпан ресурс сменных записей                     */
const RSKKMERR_MERC04         = 704; /* Первышена длина поля команды                        */
const RSKKMERR_MERC05         = 705; /* Неверный формат поля команды                        */
const RSKKMERR_MERC06         = 706; /* Ошибка чтения таймера                               */
const RSKKMERR_MERC07         = 707; /* Неверная дата                                       */
const RSKKMERR_MERC08         = 708; /* Неверное время                                      */
const RSKKMERR_MERC09         = 709; /* Дата меньше последней даты в фискальной памяти      */
const RSKKMERR_MERC10         = 710; /* Операция прервана пользователем                     */
const RSKKMERR_MERC11         = 711; /* Запрещенная команда печатающего устройства          */
const RSKKMERR_MERC12         = 712; /* Не открыта смена                                    */
const RSKKMERR_MERC13         = 713; /* Буфер журнала пуст                                  */
const RSKKMERR_MERC14         = 714; /* Переполнение приемного буфера                       */
const RSKKMERR_MERC15         = 715; /* Ошибка записи в фискальную память                   */
const RSKKMERR_MERC16         = 716; /* Ошибка установка таймера                            */
const RSKKMERR_MERC17         = 717; /* Неверный пароль налогового инспектора               */
const RSKKMERR_MERC18         = 718; /* Неверный пароль на связь                            */
const RSKKMERR_MERC19         = 719; /* Исчерпан ресурс перерегистраций                     */
const RSKKMERR_MERC20         = 720; /* Аппарат не фискализирован                           */
const RSKKMERR_MERC21         = 721; /* Значение поля команды вне диапазона                 */
const RSKKMERR_MERC22         = 722; /* Ошибка чтения фискальной памяти                     */
const RSKKMERR_MERC23         = 723; /* Переполнение счетчика                               */
const RSKKMERR_MERC24         = 724; /* Обязательное поле команды имеет нулевую длину       */
const RSKKMERR_MERC25         = 725; /* Неверный формат команды                             */
const RSKKMERR_MERC26         = 726; /* Дата или время документа меньше предыдущего         */
const RSKKMERR_MERC27         = 727; /* Исчерпан ресурс буфера журнала                      */
const RSKKMERR_MERC28         = 728; /* Ошибка в расположении реквизитов                    */
const RSKKMERR_MERC29         = 729; /* Нет такой команды                                   */
const RSKKMERR_MERC30         = 730; /* Неверная контрольная сумма                          */
const RSKKMERR_MERC31         = 731; /* Нет фискальных записей                              */
const RSKKMERR_MERC32         = 732; /* Невозможна печать буфера журнала                    */
const RSKKMERR_MERC33         = 733; /* Оформление документа прервано по окончанию ожидания */
const RSKKMERR_MERC34         = 734; /* При сторнировании или инкассации денег меньше суммы */
const RSKKMERR_MERC35         = 735; /* Переполнение счетчика сменных платежей              */
const RSKKMERR_MERC36         = 736; /* Буфер ответа пуст                                   */

const RSKKMERR_OTHER_ERR      = 999; /* Прочие ошибки                                       */
const RSKKMERR_USER_ABORT     =-999; /* Отказ выполнять операцию                            */

/*   Виды ККМ    */
const KKM_TYPE_BEZANT  = "БЕЗАНТ";
const KKM_TYPE_PRIM    = "ПРИМ-07Ф";
const KKM_TYPE_MERCURY = "МЕРКУРИЙ-114Ф";
const KKM_TYPE_NCR     = "NCR-2113";
const KKM_TYPE_TMU950  = "TM-U950";

/*   Параметры работы с ККМ   */
var   USED_KKM_TYPE = "";  /*   Используемый вид ККМ   */
var   COM_PORT = 0;        /*   Номер порта для ПРИМ-07Ф   */
var   DATA_PASSWORD = "";  /*   Пароль передачи данных для ПРИМ-07Ф   */


/*********************************************************************
                            Макропроцедуры
*********************************************************************/

/* Получение параметров работы с ККМ ------------------------------ */
macro GetParams

  var
    RegPath  = "",
    RegPath0 = "RS-RETAIL\\СЕРВИСНЫЕ\\КОММУНАЛЬНЫЕ ПЛАТЕЖИ\\ПАРАМЕТРЫ ККМ\\",
    RegPath1 = "ТИП ККМ",
    RegPath2 = "НОМЕР COM-ПОРТА",
    RegPath3 = "ПАРОЛЬ ПЕРЕДАЧИ",
    TypeS    = V_STRING,
    TypeI    = V_INTEGER,
    ValueS   = "",
    ValueI   = 0,
    PswrdLen = 4,  /* Длина пароля */
    ssss     = 0,
    ErrCode,
    Stat = TRUE;

  Message("Получение параметров работы с ККМ...");

  /* Тип ККМ */
  RegPath = RegPath0 + RegPath1;
  if(GetRegistryValue(RegPath, TypeS, ValueS, ErrCode) == V_STRING)
    USED_KKM_TYPE = ValueS;
    if ( (USED_KKM_TYPE != KKM_TYPE_BEZANT)   and
         (USED_KKM_TYPE != KKM_TYPE_PRIM)     and
         (USED_KKM_TYPE != KKM_TYPE_MERCURY)  and
         (USED_KKM_TYPE != KKM_TYPE_NCR)      and
         (USED_KKM_TYPE != KKM_TYPE_TMU950) )
      MsgBox( "Параметр вида ККМ|< "+SubStr(USED_KKM_TYPE,1,40)+
              " >|не соответствует ни одному из:|< "+
              KKM_TYPE_BEZANT+
              " > или |< "+
              KKM_TYPE_PRIM+
              " > или |< "+
              KKM_TYPE_MERCURY+
              " > или |< "+
              KKM_TYPE_NCR+
              " >"
              );
      Stat = FALSE;
    end
  else
    MsgBox( "Не возможно получить|параметр вида ККМ" );
    Stat = FALSE;
  end;

  if ( ( USED_KKM_TYPE == KKM_TYPE_PRIM )     or
       ( USED_KKM_TYPE == KKM_TYPE_MERCURY )  or
       ( USED_KKM_TYPE == KKM_TYPE_NCR ) )
    /*   Номер порта для ПРИМ-07Ф   */
    RegPath = RegPath0 + RegPath2;
    if(GetRegistryValue(RegPath, TypeI, ValueI, ErrCode) == V_INTEGER)
      COM_PORT = ValueI;
      if ( ( COM_PORT < 1 )  or  ( COM_PORT > 4 ) )
        MsgBox( "Номера COM-порта "+String(COM_PORT)+
                "|задан неправильно.|Он должен быть в интервале от 1 до 4" );
        Stat = FALSE;
      end;
    else
      MsgBox( "Не возможно получить|параметр номера COM-порта" );
      Stat = FALSE;
    end;

    if ( Stat )
      /*   Пароль передачи данных для ПРИМ-07Ф   */
      RegPath = RegPath0 + RegPath3;
      if(GetRegistryValue(RegPath, TypeS, ValueS, ErrCode) == V_STRING)
        DATA_PASSWORD = ValueS;
        if ( USED_KKM_TYPE == KKM_TYPE_NCR )
          PswrdLen = 10;   /* Для NCR 2113 */
        end;
        if ( StrLen(DATA_PASSWORD) != PswrdLen )
          MsgBox( "Длина пароля|"+SubStr(DATA_PASSWORD,1,40)+"|не равна ",
                  PswrdLen );
          Stat = FALSE;
        end;
      else
        MsgBox( "Не возможно получить|параметр пароля передачи данных" );
        Stat = FALSE;
      end;

      if ( ( USED_KKM_TYPE == KKM_TYPE_PRIM )  and
           Stat and   /* Сохранение параметров в DLL */
           ( ParamPrim(COM_PORT, DATA_PASSWORD, payX, payY, payOff, cTymeOut) != 0 ) )
        MsgBox( "Не возможно сохранить|параметры работы с ККМ" );
        Stat = FALSE;
      end;

      if ( ( USED_KKM_TYPE == KKM_TYPE_MERCURY )  and
           Stat and   /* Сохранение параметров в DLL */
           ( ParamMerc(COM_PORT, DATA_PASSWORD) != 0 ) )
        MsgBox( "Не возможно сохранить|параметры работы с ККМ" );
        Stat = FALSE;
      end;

      if ( ( USED_KKM_TYPE == KKM_TYPE_NCR )  and Stat )
        ssss = ParamNCR(COM_PORT, DATA_PASSWORD);
        if ( ssss != 0 )
          MsgBox( "Не возможно сохранить|параметры работы с ККМ|", ssss );
          Stat = FALSE;
        end;
      end;
    end;
  end;

  return Stat;

end;


/*******************************************************************
                Функция определения названия платежа
*******************************************************************/
macro DefNamePay

  return "";

end;


/*****************************************************************
                Определение названия филиала
*****************************************************************/
macro DefNameBranch

  var NameBranch;

  if (not findDepartment(FNCashVal, NameBranch))
    NameBranch = "Филиал";
  end;

  return NameBranch;

end;


/* Поиск операциониста в базе данных ------------------------------ */
macro GetPerson (CodePerson)

  KeyNum(person,0);
  person.Oper = CodePerson;

  return GetEQ(person);

end;

/* Преобразование суммы в строку для ККМ -------------------------- */
macro SumString (SumMoney)

  var str = Trim(String(SumMoney:15:2));
  var i   = Index(str,".");

  if (i == 0)
    str = str + ".00";
    i   = Index(str,".");
  end;

  while (StrLen(str) < (i + 2))
    str = str + "0";
  end;

  return str;

end;

/* Суммирование времени ------------------------------------------- */
macro AddTime(TimeIn,AddSec);

  var h,m,s;
  var h1 = 0;
  var m1 = 0;
  var s1 = 0;

  TimeSplit(TimeIn,h,m,s);

  h1 = Int(AddSec/3600);
  m1 = Int((AddSec - (h1 * 3600)) / 60);
  s1 = Int(AddSec - (h1 * 3600) - (m1 * 60));

  s = s + s1;
  m = m + m1;
  h = h + h1;

  if (s >= 60)
    s = s - 60;
    m = m + 1;
  end;

  if (m >= 60)
    m = m - 60;
    h = h + 1;
  end;

  if (h >= 24)
    s = 0;
    m = 0;
    h = 24;
  end;

  return Time(h,m,s);

end;


/*********************************************************************
       Описание функций из DLL-модуля KKM95.D32 для работы с
          Фискальной контрольно-кассовой машиной СТ-95Ф
*********************************************************************/
/*
  *****************************************************************
           Чтение параметров контрольно-кассовой машины
  *****************************************************************
  Error = GetParamKKM(
   Param1 - Смена открыта/закрыта (V_INTEGER) (0-открыта/1-закрыта)
   Param2 - Режим работы          (V_INTEGER) (0-нефиск./1-фискальный)
   Param3 - Тип принтера          (V_INTEGER) (1-Lexmark/2-Epson)
   Param4 - Дата последней опер.  (V_DATE)
   Param5 - Время последней опер. (V_TIME)
   Param6 - Номер смены           (V_INTEGER)
   Param7 - Номер операции        (V_INTEGER)
   Param8 - Регистрационный номер (V_STRING)
                     );
  *****************************************************************
                           Открытие смены
  *****************************************************************
  Error = OpenShiftKKM(
   Param1 - Номер операциониста   (V_INTEGER)
   Param2 - Фамилия операциониста (V_STRING)
   Param3 - Дата открытия смены   (V_DATE)
   Param4 - Время открытия смены  (V_TIME)
   Param5 - Тип открытия смены    (V_INTEGER) (0,1,99)
                      );
  *****************************************************************
                           Закрытие смены
  *****************************************************************
  Error = CloseShiftKKM(
   Param1 - Дата закрытия смены   (V_DATE)
   Param2 - Время закрытия смены  (V_TIME)
                      );
  *****************************************************************
                  Переход на новую контрольную ленту
  *****************************************************************
  Error = NewControlTapeKKM(
   Param1 - Дата смены ленты      (V_DATE)
   Param2 - Время смены ленты     (V_TIME)
                           );
  *****************************************************************
              Печать сменного отчета без закрытия смены
  *****************************************************************
  Error = ShiftReportKKM();
  *****************************************************************
                  Смена оператора без закрытия смены
  *****************************************************************
  Error = SetOperatorKKM(
   Param1 - Номер операциониста   (V_INTEGER)
   Param2 - Фамилия операциониста (V_STRING)
                      );
  *****************************************************************
                        Создание образа чека
  *****************************************************************
  Error = MakeCheckKKM(
   Param1 - Дата создания чека    (V_DATE)
   Param2 - Время создания чека   (V_TIME)
   Param3 - Тип документа         (V_INTEGER) (3-аннулирование,6-продажа и т.п.)
   Param4 - Направление вывода    (V_INTEGER) (1-чек,2-подкладной)
   Param5 - Отступ для копии      (V_INTEGER) (0-нет копии,1..n-интервал для копии)
                      );
  *****************************************************************
                        Вывод текстового атома
  *****************************************************************
  Error = TextAtomKKM(
   Param1 - Номер объекта         (V_INTEGER) (A_SEPR и т.п.)
   Param2 - Координата X          (V_INTEGER)
   Param3 - Координата Y          (V_INTEGER)
   Param4 - Выводимый текст       (V_STRING)
                     );
  *****************************************************************
                  Вывод атома с названием предприятия
  *****************************************************************
  Error = FirmAtomKKM(
   Param1 - Номер объекта         (V_INTEGER) (только A_FIRM)
   Param2 - Координата X          (V_INTEGER)
   Param3 - Координата Y          (V_INTEGER)
                     );
  *****************************************************************
                        Вывод системного атома
  *****************************************************************
  Error = SysAtomKKM(
   Param1 - Номер объекта         (V_INTEGER) (A_ISN и т.п.)
   Param2 - Координата X          (V_INTEGER)
   Param3 - Координата Y          (V_INTEGER)
                     );
  *****************************************************************
                     Вывод атома для печати суммы
  *****************************************************************
  Error = SumAtomKKM(
   Param1 - Номер объекта         (V_INTEGER) (A_SUMB и т.п.)
   Param2 - Координата X          (V_INTEGER)
   Param3 - Координата Y          (V_INTEGER)
   Param4 - Сумма                 (V_STRING)  (в формате "РРРРРР.КК")
                     );
  *****************************************************************
                    Вывод атома для печати номера
  *****************************************************************
  Error = NumAtomKKM(
   Param1 - Номер объекта         (V_INTEGER) (A_POS и т.п.)
   Param2 - Координата X          (V_INTEGER)
   Param3 - Координата Y          (V_INTEGER)
   Param4 - Номер                 (V_INTEGER)
                     );
  *****************************************************************
                  Установка зеркального изображения
  *****************************************************************
  Error = SetMirrorKKM(
   Param1 - Установить или нет    (V_INTEGER) (0-нет,1-да)
                      );
*/

/*********************************************************************
       Описание функций из DLL-модуля PRIM.D32 для работы с
          Фискальной контрольно-кассовой машиной ПРИМ-07Ф
*********************************************************************/
/*
  *****************************************************************
           Чтение параметров контрольно-кассовой машины
  *****************************************************************
  Error = GetParamPrim(
   Param1 - Смена открыта/закрыта (V_INTEGER) (0-открыта/1-закрыта)
   Param2 - Режим работы          (V_INTEGER) (0-нефиск./1-фискальный)
   Param3 - Дата последней опер.  (V_DATE)
   Param4 - Время последней опер. (V_TIME)
   Param5 - Номер операции        (V_INTEGER)
   Param6 - Регистрационный номер (V_STRING)
                      );
  *****************************************************************
             Получение статуса контрольно-кассовой машины
  *****************************************************************
  Error = GetStatusPrim(
   Param1 - Режим работы          (V_INTEGER) (0-нефиск./1-фискальный)
   Param2 - Дата последней опер.  (V_DATE)
   Param3 - Время последней опер. (V_TIME)
   Param4 - Номер операции        (V_INTEGER)
   Param5 - Регистрационный номер (V_STRING)
                       );
  *****************************************************************
                            Открытие смены
  *****************************************************************
  Error = OpenShiftPrim(
   Param1 - Код операциониста     (V_INTEGER)
   Param2 - Ф.И.О. операциониста  (V_STRING)
   Param3 - Дата последней опер.  (V_DATE)
   Param4 - Время последней опер. (V_TIME)
                       );
  *****************************************************************
                            Закрытие смены
  *****************************************************************
  Error = CloseShiftPrim(
   Param1 - Дата последней опер.  (V_DATE)
   Param2 - Время последней опер. (V_TIME)
   Param3 - Тип ККМ               (V_INTEGER) (8 или 32-разрядная)
   Param4 - Флаг автоматической инкассации (V_INTEGER)
                        );
  *****************************************************************
       Формирование подкладного документа коммунального платежа
  *****************************************************************
  Error = PayPrim(
   Param1 - Дата последней опер.  (V_DATE)
   Param2 - Время последней опер. (V_TIME)
   Param3 - Название филиала      (V_STRING)
   Param4 - Ф.И.О. кассира        (V_STRING)
   Param5 - Название платежа      (V_STRING)
   Param6 - Сумма                 (V_MONEYL)
   Param7 - Номер операции        (V_INTEGER)
   Param8 - Регистрационный номер (V_STRING)
   Param9 - Направление печати    (V_INTEGER) (0-прямое,1-развернутое на 180)
                 );
  *****************************************************************
                        Сторнирование платежа
  *****************************************************************
  Error = StornPrim(
   Param1 - Дата последней опер.  (V_DATE)
   Param2 - Время последней опер. (V_TIME)
   Param3 - Название филиала      (V_STRING)
   Param4 - Ф.И.О. кассира        (V_STRING)
   Param5 - Название платежа      (V_STRING)
   Param6 - Сумма                 (V_MONEYL)
   Param7 - Номер операции        (V_INTEGER)
   Param8 - Регистрационный номер (V_STRING)
                   );
  *****************************************************************
                       Проверка состояния ККМ
  *****************************************************************
  Error = CheckPrim();
  *****************************************************************
                    Сохранение параметров в DLL
  *****************************************************************
  Error = ParamPrim(
   Param1 - Номер СОМ-порта        (V_INTEGER)
   Param2 - Пароль передачи данных (V_STRING)
                   );
  *****************************************************************
                 Открыть печать строк на чековой ленте
  *****************************************************************
  Error = OpenTextPrim(
   Param1 - Дата последней опер.  (V_DATE)
   Param2 - Время последней опер. (V_TIME)
                      );
  *****************************************************************
                 Печать одной строки на чековой ленте
  *****************************************************************
  Error = SendTextPrim(
   Param1 - Строка для печати на принтере (V_STRING)
                      );
  *****************************************************************
                 Закрыть печать строк на чековой ленте
  *****************************************************************
  Error = CloseTextPrim();
  *****************************************************************
                       Печать сменного отчета
  *****************************************************************
  Error = ShiftReportPrim(
   Param1 - Дата последней опер.  (V_DATE)
   Param2 - Время последней опер. (V_TIME)
                         );
  *****************************************************************
                Внесение и инкассация денежных сумм
  *****************************************************************
  Error = MoneyPrim(
   Param1 - Флаг операции с кассой  (V_INTEGER) (0-внесение/1-инкассация)
   Param2 - Дата последней опер.    (V_DATE)
   Param3 - Время последней опер.   (V_TIME)
   Param4 - Сумма операции с кассой (V_MONEYL)
                   );

*/