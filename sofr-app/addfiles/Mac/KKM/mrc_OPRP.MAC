/*********************************************************************
* ---------------------                                              *
* R-Style SoftWare Lab.                                              *
* ---------------------                                              *
* RS-Retail 1.0                                                      *
*                                                                    *
* Работа с Контрольно-кассовой машиной ПРИМ-07Ф                      *
* Печать отчета по операционистам на ККМ                             *
*                                                                    *
* Лебедев С.В.                                                       *
* 24.08.98                                                           *
*********************************************************************/

import deprintr,"kkm_val.mac","kkm_err.mac","kkm_oper.mac",mercury;

macro MERC_Operationer

  Message(" Формирование отчета по операционистам...");

  /* Определение текущих параметров ККМ */
  stat = GetParamMerc(IsOpenShiftKKM,
                      IsFiscRegimKKM,
                      DateKKM,
                      TimeKKM,
                      NumberOperKKM,
                      RegisNumberKKM);

  /* Ошибок нет, можно сформировать отчет */
  if (stat == 0)
    i = ChooseOper();
    if (i >= 0)
      OperMan = CodePerson(i);
    elif (i == -1)
      stat = RSKKMERR_USER_ABORT; /* Отказались от проведения операции */
    elif (i == -2)
      stat = -10;
      MsgBox(" Ни у одного сотрудника нет доступа к ККМ ");
    end;
  end;

  if (stat == 0)

    BegDate = {curdate} - 3;
    EndDate = {curdate} + 2;

    KeyNum(pay_docO,0);
    pay_docO.IsCur         = 0;
    pay_docO.FNCash        = FNCash;
    pay_docO.GroupOpert    = 1;
    pay_docO.Oper          = OperMan;
    pay_docO.Date_Document = BegDate;
    pay_docO.NumOpert      = 0;
    pay_docO.CodCur        = 0;
    flag = GetGE(pay_docO);
    while (flag)
      if ((pay_docO.IsCur         == 0      ) AND
          (pay_docO.FNCash        == FNCash ) AND
          (pay_docO.GroupOpert    == 1      ) AND
          (pay_docO.Oper          == OperMan) AND
          (pay_docO.Date_Document >= BegDate) AND
          (pay_docO.Date_Document <= EndDate)    )
        if ((pay_docO.IsFiscal      != 0               ) AND
            (pay_docO.Status        == 0               ) AND
            (pay_docO.DateKKM       == KKM_PARM.aOpDate) AND
            (pay_docO.KKMFactoryNum == RegisNumberKKM  )    )
          SetRecordAddr(pay_doc_cp,pay_docO,0,0,TRUE);
          SumOper = SumOper + pay_doc_cp.ComPaySum;
          DocOper = DocOper + 1;
        end;
        flag = Next(pay_docO);
      else
        flag = FALSE;
      end;
    end;
  end;

  if (stat == 0)
    stat = Open(OutFile,NameOutFile);
    if (NOT stat)
      stat = -10;
      MsgBox(" Не могу открыть выходной файл " + NameOutFile + " ");
    else
      stat = 0;
    end;
  end;

  if (stat == 0)
    Insert(OutFile," ");
    str = "ККМ # " + RegisNumberKKM;
    Insert(OutFile,str);
    str = "Дата: " + String(KKM_PARM.aOpDate) + "  Время: " + String(KKM_PARM.aOpTime);
    Insert(OutFile,str);
    str = "---------------------------------";
    Insert(OutFile,str);
    str = DefNameBranch();
    Insert(OutFile,str);
    str = "---------------------------------";
    Insert(OutFile,str);
    str = "ОТЧЕТ ПО ОПЕРАЦИОНИСТУ " + String(OperMan);
    Insert(OutFile,str);
    Insert(OutFile," ");
    str = "Покупок   : " + String(Money(0):24:2:a);
    Insert(OutFile,str);
    str = "Продаж    : " + String(SumOper:24:2:a);
    Insert(OutFile,str);
    str = "Документов: " + String(DocOper:24);
    Insert(OutFile,str);
    Insert(OutFile," ");
    Close(OutFile);
    ViewFile(OutFile);
    if (GetTrue(TRUE," Распечатать отчет по операционисту ? "))
      if ((Open(PrnFile,NameOutFile)) and
          (OpenTextMerc()==0))
        while (Next(PrnFile))
          SendTextMerc(PrnFile.str);
        end;
        CloseTextMerc();
      end;
    end;
    DelFile(NameOutFile);
  end;

  if (stat == RSKKMERR_USER_ABORT)
    if (KKM_PARM.aSilence == 0)
      MsgBox(" Вы отказались от формирования отчета по операционистам ");
    end;
  elif (stat > 0)
    WriteError(stat,KKM_PARM.aSilence);
  end;

end;
