/*********************************************************************
* ---------------------                                              *
* R-Style SoftWare Lab.                                              *
* ---------------------                                              *
* RS-Retail 2.0                                                      *
*                                                                    *
* Работа с Контрольно-кассовой машиной NCR 2113                      *
* Аннулирование (сторнирование) платежа на ККМ                       *
*                                                                    *
* Щукин О.И.                                                         *
* 31.03.99                                                           *
*********************************************************************/

import "kkm_val.mac","kkm_err.mac",ncr;

var   statN             = 0;       /* Возвращенное значение функций        */
var   PastPayRetCodeN   = 0;
var   CheckRetCodeN     = 0;
var   StrErrN           = "";      /* Описание ошибки                      */
var   OpInMemoryN       = -1;
var   NamePersonN       = "";
var   NameCashOperN     = "";
var   NumRegN           = "";
var   NumShiftN         = 0;
var   NumDocN           = 0;


/*****************************************************************
******************************************************************
               Г Л А В Н А Я   П Р О Г Р А М М А
******************************************************************
*****************************************************************/

macro NCR_Storn

  Message(" Прием платежа на ККМ...");

  if (stat == 0)
    /* При сторнировании конкретного платежа - aSum != 0, */
    /* при сторнировании из меню - запрос суммы           */
    if (KKM_PARM.aSum == 0)
      stat = CheckNCR();

      if ( stat == 0 )
        if (GetTrue(TRUE," Провести сторнирование (аннулирование) ? "))
          GetMoney(KKM_PARM.aSum," Введите сумму сторнирования ");
        else
          stat = RSKKMERR_USER_ABORT; /* Отказались от проведения операции */
        end;
      else
        if (stat == 7013)   /* Не установлен режим регистрации */
          stat = RSKKMERR_NCR_KEY;
        end;
        statN = stat;
      end;
    end;
    if (stat == 0)
      if (KKM_PARM.aSum <= 0)
        stat = RSKKMERR_NO_MONEY;
      end;
    end;
  end;

  /* Формирование чека */
  if ( stat )
    if (GetPerson(KKM_PARM.aOperCode))
      NamePersonN = Trim(person.Name);
      if (Index(NamePersonN," ") > 0)
        NamePersonN = SubStr(NamePersonN,1,Index(NamePersonN," ") - 1);
      end;
      if (StrLen(NamePersonN) > RSKKM_LENGTH_NAMEPERSON)
        NamePersonN = SubStr(NamePersonN,1,RSKKM_LENGTH_NAMEPERSON);
      end;
      if (StrLen(NamePersonN) == 0)
        statN = RSKKMERR_NO_NAMEPERSON;
      else
        NameCashOperN = String(KKM_PARM.aOperCode) + " " + NamePersonN;
      end;
    else
      statN = RSKKMERR_NO_FINDPERSON;
    end;
  end;

  if (statN == 0)
    DateKKM    = KKM_PARM.aOpDate;
    TimeKKM    = KKM_PARM.aOpTime;
    DocType    = KKM_PARM.aDocType;
    SumPaySale = KKM_PARM.aSum;
    statN = StornNCR( KKM_PARM.aOperCode,
                      SumPaySale,
                      NumDocN,
                      NumRegN );
      end;


  if ((CheckRetCodeN == 0) AND (PastPayRetCodeN == 0))
    KKM_PARM.aOpNumber = NumRegN;
    KKM_PARM.aShift    = NumShiftN;
    KKM_PARM.aOpNumber = NumDocN;
    KKM_PARM.aKKM      = NumRegN;
  end;

  if (statN == 0)
    if (PastPayRetCodeN != 0)
      statN = PastPayRetCodeN;
    end;
    if (CheckRetCodeN != 0)
      statN = CheckRetCodeN;
    end;
  else
    if ( statN == 911 )
      KKM_PARM.aRetCode = RSKKMERR_NO_OPEN;
    else
      KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
    end;
  end;

  [ ];
  [ ──────── Сторнирование платежа на Контрольно-кассовой машине ────────];
  [ ];
  if ((stat == 0) AND (statN == 0))
    if (KKM_PARM.aSilence == 0)
      MsgBox(" Сторнирование (аннулирование) на сумму " + Trim(String(KKM_PARM.aSum:18:2:a)) + " успешно выполнено | Время операции  " + Trim(String(KKM_PARM.aOpDate)) + "  " + String(KKM_PARM.aOpTime) + " ");
    end;
    [ Время операции : #](Trim(String(KKM_PARM.aOpDate)) + "  " + String(KKM_PARM.aOpTime));
  elif (stat == RSKKMERR_USER_ABORT)
    if (KKM_PARM.aSilence == 0)
      MsgBox(" Вы отказались от сторнирования (аннулирования) ");
    end;
    [ Вы отказались от сторнирования (аннулирования)];
  else
    StrErr = WriteError(stat,KKM_PARM.aSilence);
    StrErr = "Ошибка " + String(stat) + ": " + StrErr;
    [ ];
    [ #](StrErr)
  end;

end;
