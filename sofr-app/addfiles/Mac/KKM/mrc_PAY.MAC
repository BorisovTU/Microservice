/*********************************************************************
* ---------------------                                              *
* R-Style SoftWare Lab.                                              *
* ---------------------                                              *
* RS-Retail 1.0                                                      *
*                                                                    *
* Работа с Контрольно-кассовой машиной ПРИМ-07Ф                      *
* Прием платежа                                                      *
*                                                                    *
* Щукин О.И.                                                         *
* 11.12.98                                                           *
*********************************************************************/

import "kkm_val.mac","kkm_err.mac",mercury;

const PDTitle = "= СБЕРБАНК РОССИИ =";

var   statM             = 0;       /* Возвращенное значение функций        */
var   PastPayRetCodeM   = 0;
var   CheckRetCodeM     = 0;
var   StrErrM           = "";      /* Описание ошибки                      */
var   FNCashM           = NumFNCash();

var   OldNumberOperKKMM = 0;       /* Номер последней операции             */
var   TypeCheckM        = RSKKM_PRINT_PAPERDECK;
var   CopyCheckM        = RSKKM_PD4_COPY_DISTANCE;
var   OpInMemoryM       = -1;

var   NamePersonM       = "";
var   NameCashOperM     = "";

var   NumRegM           = "";
var   NumShiftM         = 0;
var   NumDocM           = 0;


/*****************************************************************
******************************************************************
               Г Л А В Н А Я   П Р О Г Р А М М А
******************************************************************
*****************************************************************/

macro MERC_Pay

  Message(" Прием платежа на ККМ...");

  /* Формирование чека */
  if (GetPerson(KKM_PARM.aOperCode))
    NamePersonM = Trim(person.Name);
    if (Index(NamePersonM," ") > 0)
      NamePersonM = SubStr(NamePersonM,1,Index(NamePersonM," ") - 1);
    end;
    if (StrLen(NamePersonM) > RSKKM_LENGTH_NAMEPERSON)
      NamePersonM = SubStr(NamePersonM,1,RSKKM_LENGTH_NAMEPERSON);
    end;
    if (StrLen(NamePersonM) == 0)
      statM = RSKKMERR_NO_NAMEPERSON;
    else
      NameCashOperM = String(KKM_PARM.aOperCode) + " " + NamePersonM;
    end;
  else
    statM = RSKKMERR_NO_FINDPERSON;
  end;

  if (statM == 0)
    DateKKM    = KKM_PARM.aOpDate;
    TimeKKM    = KKM_PARM.aOpTime;
    DocType    = KKM_PARM.aDocType;
    SumPaySale = KKM_PARM.aSum;
    statM = PayMerc( NameCashOperM,
                     DefNamePay(),
                     SumPaySale,
                     PDTitle,
                     NumDocM,
                     NumRegM );
  end;


  if ((CheckRetCodeM == 0) AND (PastPayRetCodeM == 0))
    KKM_PARM.aOpNumber = NumRegM;
    KKM_PARM.aShift    = NumShiftM;
    KKM_PARM.aOpNumber = NumDocM;
    KKM_PARM.aKKM      = NumRegM;
  end;

  OpInMemoryM = 1;

  if (statM == 0)
    if (CheckRetCodeM == 0)
      if   (OpInMemoryM == 0)
        KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
      elif (OpInMemoryM == 1)
        KKM_PARM.aRetCode = RSKKMERR_NO_ERROR;
      else
        KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR; /* Не знаем, занесено ли в память */
      end;
    else
     if   (OpInMemoryM == 0)
       KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
     elif (OpInMemoryM == 1)
       Message(" Сторнирование платежа...");
       TimeKKM = AddTime(TimeKKM,5);
       if (StornMerc( NameCashOperM,
                      SumPaySale,
                      PDTitle,
                      NumDocM,
                      NumRegM ) == 0)
         KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
       else
         KKM_PARM.aRetCode = RSKKMERR_BAD_DOC;
       end;
     else
       KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR;
     end;
    end;
  end;

  if (statM == 0)
    if (PastPayRetCodeM != 0)
      statM = PastPayRetCodeM;
    end;
    if (CheckRetCodeM != 0)
      statM = CheckRetCodeM;
    end;
  else
    if ( statM == 911 )
      KKM_PARM.aRetCode = RSKKMERR_NO_OPEN;
    else
      KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
    end;
  end;

  [ ];
  [ ──────── Проведение платежа на Контрольно-кассовой машине ────────];
  [ ];
  if (NOT statM)
    [ Время операции : #](Trim(String(DateKKM)) + "  " + String(TimeKKM));
  else
    StrErrM = WriteError(statM,KKM_PARM.aSilence);
    StrErrM = "Ошибка " + String(statM) + ": " + StrErrM;
    [ ];
    [ #](StrErrM)
  end;

end;
