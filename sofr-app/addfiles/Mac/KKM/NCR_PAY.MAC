/*********************************************************************
* ---------------------                                              *
* R-Style SoftWare Lab.                                              *
* ---------------------                                              *
* RS-Retail 1.0                                                      *
*                                                                    *
* Работа с Контрольно-кассовой машиной NCR 2113                      *
* Прием платежа                                                      *
*                                                                    *
* Щукин О.И.                                                         *
* 25.03.99                                                           *
*********************************************************************/

import "kkm_val.mac","kkm_err.mac",ncr_serv;

var   statN             = 0;       /* Возвращенное значение функций        */
var   PastPayRetCodeN   = 0;
var   CheckRetCodeN     = 0;
var   StrErrN           = "";      /* Описание ошибки                      */
var   FNCashN           = NumFNCash();

var   OldNumberOperKKMN = 0;       /* Номер последней операции             */
var   TypeCheckN        = RSKKM_PRINT_PAPERDECK;
var   CopyCheckN        = RSKKM_PD4_COPY_DISTANCE;
var   OpInMemoryN       = -1;

var   NumRegN           = "";
var   NumShiftN         = 0;
var   NumDocN           = 0;


/*****************************************************************
******************************************************************
               Г Л А В Н А Я   П Р О Г Р А М М А
******************************************************************
*****************************************************************/

macro NCR_Pay

  Message(" Прием платежа на ККМ...");

  /* Формирование чека */
  if (statN == 0)
    DateKKM    = KKM_PARM.aOpDate;
    TimeKKM    = KKM_PARM.aOpTime;
    DocType    = KKM_PARM.aDocType;
    SumPaySale = KKM_PARM.aSum;
    statN = PayNCR( KKM_PARM.aOperCode,
                    DefNamePay(),
                    SumPaySale,
                    NumDocN,
                    NumRegN );
  end;

  if ((CheckRetCodeN == 0) AND (PastPayRetCodeN == 0))
    KKM_PARM.aOpNumber = NumRegN;
    KKM_PARM.aShift    = NumShiftN;
    KKM_PARM.aOpNumber = NumDocN;
    KKM_PARM.aKKM      = NumRegN;
  end;

  OpInMemoryN = 1;

  if (statN == 0)
    if (CheckRetCodeN == 0)
      if   (OpInMemoryN == 0)
        KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
      elif (OpInMemoryN == 1)
        KKM_PARM.aRetCode = RSKKMERR_NO_ERROR;
      else
        KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR; /* Не знаем, занесено ли в память */
      end;
    else
     if   (OpInMemoryN == 0)
       KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
     elif (OpInMemoryN == 1)
       Message(" Сторнирование платежа...");
       TimeKKM = AddTime(TimeKKM,5);
       if (StornNCR( KKM_PARM.aOperCode,
                     SumPaySale,
                     NumDocN,
                     NumRegN ) == 0)
         KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
       else
         KKM_PARM.aRetCode = RSKKMERR_BAD_DOC;
       end;
     else
       KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR;
     end;
    end;
  end;

  if (statN == 0)
    if (PastPayRetCodeN != 0)
      statN = PastPayRetCodeN;
    end;
    if (CheckRetCodeN != 0)
      statN = CheckRetCodeN;
    end;
  else
    if ( statN == 911 )
      KKM_PARM.aRetCode = RSKKMERR_NO_OPEN;
    else
      KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
    end;
  end;

  [ ];
  [ ──────── Проведение платежа на Контрольно-кассовой машине ────────];
  [ ];
  if (NOT statN)
    [ Время операции : #](Trim(String(DateKKM)) + "  " + String(TimeKKM));
  else
    StrErrN = WriteError(statN,KKM_PARM.aSilence);
    StrErrN = "Ошибка " + String(statN) + ": " + StrErrN;
    [ ];
    [ #](StrErrN)
  end;

end;
