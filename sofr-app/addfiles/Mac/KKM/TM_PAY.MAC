/*
$Name:               TM_PAY.MAC
$Module:             RS-Retail
$Description:        Работа с ККМ "TM-U950".  Прием платежа.
*/

import "kkm_val.mac", "kkm_err.mac", "tm.mac";

private const Direct = 1;  /* Направление печати ПД-4: 1 - прямое, 0 - развернутый на 180 */

private const PDTitleP = "*** АО Банк Финсервис ***";

private var   statP             = 0;       /* Возвращенное значение функций        */
private var   PastPayRetCodeP   = 0;
private var   CheckRetCodeP     = 0;
private var   StrErrP           = "";      /* Описание ошибки                      */
private var   FNCashP           = NumFNCash();

private var   OldNumberOperKKMP = 0;       /* Номер последней операции             */
private var   TypeCheckP        = RSKKM_PRINT_PAPERDECK;
private var   CopyCheckP        = RSKKM_PD4_COPY_DISTANCE;
private var   OpInMemoryP       = -1;

private var   NamePersonP       = "";
private var   NameCashOperP     = "";

private var   NumRegP           = "";
private var   NumShiftP         = 0;
private var   NumDocP           = 0;

private var   SumComiss         = $0.0L;
private var   SumPeni           = $0.0L;

private var   pSum_Pay          = $0.0L;

private var   pSumPaySale       = "";
private var   pSumComiss        = "";
private var   pSumPeni          = "";
private var   pSumTotal         = "";

private var   pNamePay          = "";

private var   pKindPrint        = 0;

private macro PayTM( _DateKKM,
                     _TimeKKM,
                     _DefNameBranch,
                     _NameCashOperP,
                     _pNamePay,
                     _pSumPaySale,
                     _pSumComiss,
                     _pSumPeni,
                     _pSumTotal,
                     _NumDocP,
                     _NumRegP,
                     _Direct,
                     _FlagComiss,
                     _PDTitleP,
                     _pKindPrint )
  var i = 0;
  SetPrnInfo("$PRN5");
  println( "\x1b\x40 " ); // сброс  
  Узкий_Режим();
  println(strfor(27) + "c0" + StrFor(1)); // печать на контрольную ленту
  // println(strfor(27) + "c0" + StrFor(2)); // печать на чековую ленту

  [           ИЗВЕЩЕНИЕ/КВИТАНЦИЯ          ];

  println( "Сумма платежа = ", _pSumTotal );

   while ( i < 12 )
       println("   ");
       i = i+1;          
   end;   
   Резать_Ленту(); 

  return RSKKMERR_NO_ERROR;
end;

// Вызов головной процедурыю
macro TM_Pay

  Message(" Прием платежа на ККМ...");

  /* Формирование чека */
  if (GetPerson(KKM_PARM.aOperCode))
    NamePersonP = Trim(person.Name);
    if (Index(NamePersonP," ") > 0)
      NamePersonP = SubStr(NamePersonP,1,Index(NamePersonP," ") - 1);
    end;
    if (StrLen(NamePersonP) > RSKKM_LENGTH_NAMEPERSON)
      NamePersonP = SubStr(NamePersonP,1,RSKKM_LENGTH_NAMEPERSON);
    end;
    if (StrLen(NamePersonP) == 0)
      statP = RSKKMERR_NO_NAMEPERSON;
    else
      NameCashOperP = String(KKM_PARM.aOperCode) + " " + NamePersonP;
    end;
  else
    statP = RSKKMERR_NO_FINDPERSON;
  end;

  if (statP == 0)
    DateKKM    = KKM_PARM.aOpDate;
    TimeKKM    = KKM_PARM.aOpTime;
    DocType    = KKM_PARM.aDocType;
    SumPaySale = KKM_PARM.aSum;
    SumComiss  = KKM_PARM.aSumComiss;
    SumPeni    = KKM_PARM.aSumPeni;

    pKindPrint = KKM_PARM.aKindPrint;

    if ( FlagComiss )
      pSum_Pay = SumPaySale + SumComiss + SumPeni;
    else
      pSum_Pay = SumPaySale;
    end;

    pSumPaySale = String( (Double(SumPaySale)):0:2 );
    pSumComiss  = String( (Double(SumComiss)):0:2 );
    pSumPeni    = String( (Double(SumPeni)):0:2 );
    pSumTotal   = String( (Double(pSum_Pay)):0:2 );

    if ( pKindPrint == 0 )
      pNamePay = DefNamePay();
    else
      pNamePay = PAY_DOC.Ground;
      if ( StrLen( pNamePay ) > MaxLenCodeVal+2 )
        pNamePay = SubStr( pNamePay, 1, MaxLenCodeVal+2 );
      end;
    end;

    statP = PayTM( DateKKM,
                   TimeKKM,
                   DefNameBranch(),
                   NameCashOperP,
                   pNamePay,
                   pSumPaySale,
                   pSumComiss,
                   pSumPeni,
                   pSumTotal,
                   NumDocP,
                   NumRegP,
                   Direct,
                   FlagComiss,
                   PDTitleP,
                   pKindPrint );
  end;

  if ((CheckRetCodeP == 0) AND (PastPayRetCodeP == 0))
    KKM_PARM.aOpNumber = NumRegP;
    KKM_PARM.aShift    = NumShiftP;
    KKM_PARM.aOpNumber = NumDocP;
    KKM_PARM.aKKM      = NumRegP;
  end;

  OpInMemoryP = 1;

  if (statP == 0)
    if (CheckRetCodeP == 0)
      if   (OpInMemoryP == 0)
        KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
      elif (OpInMemoryP == 1)
        KKM_PARM.aRetCode = RSKKMERR_NO_ERROR;
      else
        KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR; /* Не знаем, занесено ли в память */
      end;
    else
     if   (OpInMemoryP == 0)
       KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
/*
     elif (OpInMemoryP == 1)
       Message(" Сторнирование платежа...");
       TimeKKM = AddTime(TimeKKM,5);

       if ( FlagComiss )
         pSum_Pay = SumPaySale + SumComiss + SumPeni;
       else
         pSum_Pay = SumPaySale;
       end;

       pSumPaySale = String( (Double( pSum_Pay  )):0:2 );
       pSumComiss  = String( (Double( SumComiss )):0:2 );
       pSumPeni    = String( (Double( SumPeni   )):0:2 );

       if (StornPrim( DateKKM,
                      TimeKKM,
                      DefNameBranch(),
                      NameCashOperP,
                      DefNamePay(),
                      pSumPaySale,
                      pSumComiss,
                      pSumPeni,
                      FlagComiss,
                      NumDocP,
                      NumRegP ) == 0)
         KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
       else
         KKM_PARM.aRetCode = RSKKMERR_BAD_DOC;
       end;
*/
     else
       KKM_PARM.aRetCode = RSKKMERR_OTHER_ERR;
     end;
    end;
  end;

  if (statP == 0)
    if (PastPayRetCodeP != 0)
      statP = PastPayRetCodeP;
    end;
    if (CheckRetCodeP != 0)
      statP = CheckRetCodeP;
    end;
  else
    if ( statP == 911 )
      KKM_PARM.aRetCode = RSKKMERR_NO_OPEN;
    else
      KKM_PARM.aRetCode = RSKKMERR_DELETE_DOC;
    end;
  end;

  [ ];
  [ ──────── Проведение платежа на Контрольно-кассовой машине ────────];
  [ ];
  if (NOT statP)
    [ Время операции : #](Trim(String(DateKKM)) + "  " + String(TimeKKM));
  else
    StrErrP = WriteError(statP,KKM_PARM.aSilence);
    StrErrP = "Ошибка " + String(statP) + ": " + StrErrP;
    [ ];
    [ #](StrErrP)
  end;

end;
