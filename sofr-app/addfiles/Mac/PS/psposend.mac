/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : psposend.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага по выгрузке рублевых платежей    */
/*                     в АРМ Позиционера                                */
/*                                                                      */
/*  Программист      : Алешин А.В.                                      */
/*                                                                      */
/*  Создан           : 23.11.01                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */

import "pmmulti.mac", "payconst.mac", InsCarryDoc;
import  paym_rec; /* Pm_paym, Pm_rmprop, Pm_debet, Pm_credit */

RECORD  PartPmpaym( pmpaym );     /* ─┐                                                               */
RECORD  PartDebet ( pmprop );     /*  ├─ параметры платежного документа частичной оплаты картотеки №2 */
RECORD  PartCredit( pmprop );     /*  │                                                               */
RECORD  PartPmrmprop( pmrmprop ); /* ─┘                                                               */

RECORD  Pm_akkr( pmakkr );        /* аккредитив */

/**********************************/
/* Выполнение шага                */
/**********************************/

MACRO ExecuteStep( doc, payorder, DocKind )
  var stat = 0;

  if( PartPmpaym.PaymentID )
    stat = ProcessPayment( PartCredit.Corschem, PartCredit.PayFIID, PartPmpaym.ValueDate, PartPmpaym.Department );
  else
    stat = ProcessPayment( Pm_credit.Corschem, Pm_credit.PayFIID, Pm_paym.ValueDate, Pm_paym.Department );
  end;

  if( stat == 0 )

     /* при частичной оплате внешнего платежа, изменяем статус частичной оплаты */
     if( (PartPmpaym.PaymentID) and (PartCredit.PaymentID == PartPmpaym.PaymentID) and (PartCredit.Group == PAYMENTS_GROUP_EXTERNAL) )
        if( not InsertPaymentStat( PartPmpaym.PaymentID, PM_READY_TO_SEND ) )
           msgbox( "Ошибка при обновлении статуса платежа" );
           return 1;
        end;
     end;

  end;

  return stat;

  OnError(er) /* обработка ошибок времени выполнения */
    MsgBox( String(er.Message, "|Модуль: ", er.Module, " Строка: ", er.Line) );
    return 1;
END;
