/************************************************************************/
/*         Автоматизированная банковская система RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : reqopnac.mac                                     */
/*                                                                      */
/*  Описание         : Инициализация и проверки                         */
/*                     заявлений на закрытие накопительного счета       */
/*  Программист      : Локтюшин В.Ю.                                    */
/*                                                                      */
/*  Создан           : 12.12.2006                                       */
/*                                                                      */
/************************************************************************/
IMPORT reqinter;

RECORD ReqCloseAccum(reqclsac);
RECORD OldReqCloseAccum(reqclsac);

CONST  fld_SubKindName = 1,
       fld_Date        = 2,
       fld_InputDate   = 3,
       fld_CodeFI      = 4,
       fld_Account     = 6,
       fld_RestCodeFI  = 12,
       fld_PackNumb    = 17;

/*Для платежей*/

/*Хинт для списков по дате заявления*/
private const Hint_ByDate     :string = "/*+FIRST_ROWS LEADING(t oproper accounts partcode) INDEX(t dreqclsac_dbt_idx6) USE_NL(t oproper accounts partcode)*/";
/*Хинт для списков по дате закрытия*/
private const Hint_ByCloseDate:string = "/*+FIRST_ROWS LEADING(t oproper accounts partcode) INDEX(t dreqclsac_dbt_idx4) USE_NL(t oproper accounts partcode)*/";
/*Хинт для списков по статусу первички*/
private const Hint_ByStatus   :string = "/*+FIRST_ROWS LEADING(t oproper accounts partcode) INDEX(t dreqclsac_dbt_idx2) USE_NL(t oproper accounts partcode)*/";

/* Установка подсказки для скролингов из макроса */
MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  /* Возможные значения ScrolStates:
     0  - Все                      
     1  - Отложенные               
     2  - Открытые                 
     3  - Закрытые                 
     4  - Отвергнутые */

  if( ScrolStates == 0 ) //Все

    return Hint_ByDate;

  elif( ScrolStates == 3 ) //Закрытые

    return Hint_ByCloseDate;  

  elif(    ( ScrolStates == 1 )   //Отложенные
        or ( ScrolStates == 2 )   //Открытые
        or ( ScrolStates == 4 ) ) //Отвергнутые
  
    return Hint_ByStatus;    

  end;

  return DefaultHint;
END;

MACRO Новое_Заявление()
  return 0;
END;

MACRO Проверить_Заявление(Режим)
  var stat = 0;
  var Err:string = "Не заполнено поле: ";
  var ZeroDate   = Date( 0, 0, 0 );

  if ( (Режим == 2 ) or (Режим == 3) or (Режим == 8) )

     if( ReqCloseAccum.SubKind <= 0)
       Err = Err + "Вид документа";
       stat = fld_SubKindName;
     end;
     if( ReqCloseAccum.Date <= ZeroDate )
       Err = Err + "Дата";
       stat = fld_Date;
     end;

     if( ReqCloseAccum.InputDate <= ZeroDate )
       Err = Err + "Дата ввода";
       stat = fld_InputDate;
     end;

     if( ReqCloseAccum.Account == "" )
       Err = Err + "Номер счета";
       stat = fld_Account;
     end;

     if( ReqCloseAccum.NumberPack < 0 )
       MsgBox("Номер пачки не может быть отрицательным");
       return fld_PackNumb;
     end;

  end;
  if( stat )
    msgbox( Err );
  end;

  if( ( not stat ) and ( Режим == 3 ) 
      and ( not CmpRECORD( OldReqCloseAccum, ReqCloseAccum ) )
      and ( ReqCloseAccum.CurrentState != 0 ) //REQCLSAC_ST_DEFERRED = 0 Отложено
    )
    stat = CHANG_IMPORTANT;
  end;

  return stat;
END;

MACRO Функция_Пользователя( Режим:integer )
   return 0;
END;

