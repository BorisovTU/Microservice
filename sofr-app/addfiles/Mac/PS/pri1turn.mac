/*
  $Name:        pri1turn.mac
  $Module:      ŠŽ
  $Description: ®âç¥â ® ¤¨¢¦¥­¨¨ ¯® Š1
*/

/*-----------------------------------------------------------------------------

®âç¥â ® ¤¨¢¦¥­¨¨ ¯® Š1

-----------------------------------------------------------------------------*/

import "globals.mac", PSInter, oralib;

/*
-------------------------------------------------------------------------------
¯¥ç â âì § £®«®¢®ª
-------------------------------------------------------------------------------
*/

macro PrintHead( Date, isEmpty )
[
                          ‚¥¤®¬®áâì ¤¢¨¦¥­¨ï ¯® ª àâ®â¥ª¥ ü 1
                                    §  ##########£.

]( Date );

   if( isEmpty )
[
               „¢¨¦¥­¨ï ¯® áç¥â ¬, ã¤®¢«¥â¢®àïîé¨¬ § ¤ ­­ë¬ ãá«®¢¨ï¬, ­¥ ¡ë«®.
];

   end;

end;

/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì ä¨«¨ «
-------------------------------------------------------------------------------
*/

macro PrintDepartment( Code, Name )
[
 ”¨«¨ « #####  ######################################## 
]( Code, Name );
end;


/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì § £®«®¢®ª
-------------------------------------------------------------------------------
*/

macro PrintOper( OperNumber, OperName )
[
 Ž¯¥à æ¨®­¨áâ ##### #
]( OperNumber, OperName );
end;


/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì è ¯ªã â ¡«¨æë
-------------------------------------------------------------------------------
*/

macro PrintOperTableHead( FormType )


   if  ( FormType == 8 )

[
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿
 ³  ¨¬¥­®¢ ­¨¥ ³  ®¬¥à  ³    à¨å®¤    ³     áå®¤    ³      ®¬¥à áç¥â       ³        §­ ç¥­¨¥ ¯« â¥¦      ³       ®¬¥à áç¥â        ³   ‘à®ª   ³ 
 ³   ®¯¥à æ¨¨   ³  ¤®ª.   ³              ³              ³        ª«¨¥­â         ³                              ³         £« ¢ë 3         ³  ¯« â¥¦  ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄ´
];

   elif( FormType == 4 )
[
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿
 ³  ¨¬¥­®¢ ­¨¥ ³  ®¬¥à  ³    à¨å®¤    ³     áå®¤    ³      ®¬¥à áç¥â       ³       ®¬¥à áç¥â        ³   ‘à®ª   ³ 
 ³   ®¯¥à æ¨¨   ³  ¤®ª.   ³              ³              ³        ª«¨¥­â         ³         £« ¢ë 3         ³  ¯« â¥¦  ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄ´
];

   elif( FormType == 2 )

[
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³  ¨¬¥­®¢ ­¨¥ ³  ®¬¥à  ³    à¨å®¤    ³     áå®¤    ³      ®¬¥à áç¥â       ³        §­ ç¥­¨¥ ¯« â¥¦      ³                                      
 ³   ®¯¥à æ¨¨   ³  ¤®ª.   ³              ³              ³        ª«¨¥­â         ³                              ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                                     
];

   elif( FormType == 1 )

[
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿                               
 ³  ¨¬¥­®¢ ­¨¥ ³  ®¬¥à  ³    à¨å®¤    ³     áå®¤    ³      ®¬¥à áç¥â       ³                                          
 ³  ®¯¥à æ¨¨    ³   ¤®ª.  ³              ³              ³        ª«¨¥­â         ³                              
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
];

   end;
end;

/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì ®¤¨­ ¤®ªã¬¥­â
-------------------------------------------------------------------------------
*/

macro PrintDocument( OpType, DocNumber, InSum, OutSum, ClientAcc, Ground, OutBalAcc, AcceptDate, ClientCode, FormType )

   var sOpType = "";

   if  ( OpType == 1 ) sOpType = "®áâã¯«¥­¨¥"  ;
   elif( OpType == 2 ) sOpType = "Žâª §"        ;
   elif( OpType == 3 ) sOpType = "®«­. ®¯«."   ;
   elif( OpType == 4 ) sOpType = "— áâ¨ç. ®¯«." ;
   elif( OpType == 5 ) sOpType = "‚ ª àâ®â¥ªã 2";
   end;

   if  ( FormType == 8 )

[³##############³#########³##############³##############³#######################³##############################³#########################³##########³]
( sOpType, DocNumber:r, InSum, OutSum, ClientAcc:c:f, Ground:c, OutBalAcc:c:f, AcceptDate );

   elif( FormType == 4 )

[³##############³#########³##############³##############³#######################³#########################³##########³]
( sOpType, DocNumber:r, InSum, OutSum, ClientAcc:c:f, OutBalAcc:c:f, AcceptDate );

   elif( FormType == 2 )

[³##############³#########³##############³##############³#######################³##############################³]
( sOpType, DocNumber:r, InSum, OutSum, ClientAcc:c:f, Ground:c );

   elif( FormType == 1 )

[³##############³#########³##############³##############³#######################³]
( sOpType, DocNumber:r, InSum, OutSum, ClientAcc:c:f );

   end;
end;

/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì ¯®¤¢ « â ¡«¨æë ¤«ï ®¯¥à æ¨®­¨áâ 
-------------------------------------------------------------------------------
*/

macro PrintOperTableTail( FormType )

   if  ( FormType == 8 )

[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ];

   elif( FormType == 4 )

[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ];

   elif( FormType == 2 )

[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

   elif( FormType == 1 )

[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

   end;
end;

/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì ¨â®£® ¯® ®¯¥à æ¨®­¨áâã
-------------------------------------------------------------------------------
*/
macro PrintOperTotal( OperNumber, InSum, OutSum )
[
  ˆâ®£® ¯® ®¯¥à æ. ######  ############## ##############

]
( OperNumber:c, InSum:r, OutSum:r );

end;


/*
-------------------------------------------------------------------------------
­ ¯¥ç â âì ¨â®£® ¯® ä¨«¨ «ã
-------------------------------------------------------------------------------
*/

macro PrintDepartmentTotal( Code, InSum, OutSum, isFindDep  )

   if( isFindDep )

[
  ˆâ®£® ¯® ä¨«¨ «ã ######  ############## ##############
]( Code:c, InSum:r, OutSum:r );

   else

[
  ˆâ®£® ¯® ¢á¥¬ ®¯¥à æ-¬   ############## ##############
]( InSum:r, OutSum:r );

   end;
end;






MACRO PrintVed_K1 ( MapVal :PSRepMap )
  var RepDate:date = MapVal.Value( "RepDate"     );
  var DepNum       = MapVal.Value( "DepNum"      );
  var OperOP         = MapVal.Value( "Oper"        );
  var Purpos_Cond  = MapVal.Value( "Purpos_Cond" );
  var Rest_Cond    = MapVal.Value( "Rest_Cond"   );
  var CatMask      = MapVal.Value( "CatMask"   );
  var table_dbt:string;
  
  var FormType = 1;
  
  if( Rest_Cond )
    if( Purpos_Cond )
      FormType = 8;
    else
      FormType = 4;
    end;     
  else
    if( Purpos_Cond )
      FormType = 2;    
    end;
  end;

  var params:TArray = TArray();

  var DepCodeDoc:string = " ", DepNameDoc, 
      DepCodeAcc, DepNameAcc, 
      OperCodeDoc, OperNameDoc, 
      OperCodeAcc, OperNameAcc, 
      Step, NumDoc,
      DocAmn, PayAmn, 
      Account, Ground, AccountPay,
      AccountRec, PayDate:date, PartCode;
  
  var ClientID:integer = {OurBank};

var select:string =  "SELECT dp_depdoc.t_code, partydoc.t_shortname, dp_depacc.t_code,"+
        " partyacc.t_shortname, persondoc.t_oper, persondoc.t_name,"+
        " personacc.t_oper, personacc.t_name, document.t_result_carry,"+
        " document.t_numb_document, document.t_sum_payer, pmpaym.t_amount,"+
        " pmpaym.t_payeraccount, pmrmprop.t_ground, document.t_account_payer,"+
        " document.t_account_receiver, pmrmprop.t_PayDate, cl.t_code";

var selectc:string = "SELECT COUNT(1)";

var from:string = " FROM dacctrn_dbt document INNER JOIN dpmdocs_dbt pmdocs ON pmdocs.t_acctrnid ="+
                                                                " document.t_acctrnid"+
   " INNER JOIN dpmpaym_dbt pmpaym ON pmpaym.t_paymentid = pmdocs.t_paymentid"+
   " INNER JOIN dpmrmprop_dbt pmrmprop ON pmrmprop.t_paymentid = pmdocs.t_paymentid"+
   " INNER JOIN daccount_dbt acc ON acc.t_account = pmpaym.t_payeraccount"+
                                  " AND acc.t_code_currency = 0"+
                                  " AND acc.t_chapter = 1"+
   
   " LEFT JOIN ddp_dep_dbt dp_depacc ON dp_depacc.t_code = acc.t_department"+

   " LEFT JOIN dparty_dbt partyacc ON partyacc.t_partyid = dp_depacc.t_partyid"+

   " LEFT JOIN ddp_dep_dbt dp_depdoc ON dp_depdoc.t_code = document.t_department"+

   " LEFT JOIN dparty_dbt partydoc ON partydoc.t_partyid = dp_depdoc.t_partyid"+

   " INNER JOIN dperson_dbt persondoc ON persondoc.t_oper = document.t_oper "+
   " INNER JOIN dperson_dbt personacc ON personacc.t_oper = acc.t_oper "+
   " LEFT JOIN daccount_dbt acc3 on acc3.t_Chapter = 3 "+
          " and acc3.t_Account = decode( document.t_result_carry, 47, document.t_Account_Payer, document.t_Account_Receiver ) "+
          " and acc3.t_Code_Currency = 0 "+
   " INNER JOIN dpartcode_dbt cl ON cl.t_PartyID = decode(acc3.t_Client, 0, :OurBank1, acc3.t_Client) "+
                                                 " and cl.t_CodeKind = ( select min(t_CodeKind) "+
                                                                       " from dpartcode_dbt "+
                                                                       " where t_PartyID = decode(acc3.t_Client, 0, :OurBank2, acc3.t_Client) ) "+
   " WHERE document.t_chapter = 3"+
     " AND document.t_result_carry IN (47, 48, 49, 60)"+
     " AND document.t_date_carry = :RepDate";
  params[params.size] = SQLParam( "OurBank1"  , {OurBank} );
  params[params.size] = SQLParam( "OurBank2"  , {OurBank} );
  params[params.size] = SQLParam( "RepDate"  , RepDate  );   
  
  if( OperOP > 0 )
    from = from + " AND document.t_oper = :Oper";
    params[params.size] = ( SQLParam( "OperOP", OperOP ));
  end;
 
  if( DepNum > 0 )
    from = from + " and ACC.T_DEPARTMENT = :DepNum";
    params[params.size] = ( SQLParam( "DepNum", DepNum ));
  end; 
  
  selectc = selectc + from;
  var rsc:RsdRecordset = execSQLselect( selectc, params, FALSE );
  var iProgress:integer = 0, ProgressInd:integer = 1;
  
  if( rsc )
    if( rsc.MoveNext() )
      iProgress = rsc.value(0);
    end;
  end;

  if( iProgress > 0 )
    PrintHead( RepDate, false );
    InitProgress( iProgress, null, "„®ªã¬¥­âë ¯® ª àâ®â¥ª¥ ü 1" );
  else
    PrintHead( RepDate, true );
  end;


  from = from + " ORDER BY acc.t_department ASC, document.t_oper ASC, (acc.t_sort), document.t_numb_document ASC, document.t_result_carry";
  var ch = 0;       
  
  select  = select  + from;
  var rs:RsdRecordset  = execSQLselect( select,  params, FALSE );
 
  var Debet = 0, Credit = 0,  DebetDep = 0, CreditDep = 0,
      DebetAmount = 0, CreditAmount = 0, 
      BuffOper:integer = 0, BuffDep:integer = 0, OpType, OutBalAcc;

  if( rs )
       rs.Command.NullConversion = true;
        while( rs.MoveNext())
  
          DepCodeDoc  = rs.value(0);
          DepNameDoc  = rs.value(1);
          DepCodeAcc  = rs.value(2);
          DepNameAcc  = rs.value(3);
          OperCodeDoc = rs.value(4);
          OperNameDoc = rs.value(5);
          OperCodeAcc = rs.value(6);
          OperNameAcc = rs.value(7);
          Step        = rs.value(8);
          NumDoc      = rs.value(9);
          DocAmn      = rs.value(10);
          PayAmn      = rs.value(11);
          Account     = rs.value(12);
          Ground      = rs.value(13);
          AccountPay  = rs.value(14);
          AccountRec  = rs.value(15);
          PayDate     = rs.value(16);
          PartCode    = rs.value(17);


          if( ( BuffOper != 0 ) and ( BuffOper != OperCodeDoc ) )
            ch = 0;
            PrintOperTableTail( FormType );
            PrintOperTotal( BuffOper, Debet, Credit );
            Debet = Credit = 0;
          end;

          if( ( BuffDep != 0 ) and ( BuffDep != DepCodeAcc) )
            PrintDepartmentTotal( BuffDep, DebetDep, CreditDep, ( BuffDep != 0 )  );
            DebetDep = CreditDep = 0;
          end;

          if( ch == 0 )
            if( DepCodeDoc != 0 ) PrintDepartment( DepCodeDoc, DepNameDoc );end;
            PrintOper( OperCodeDoc, OperNameDoc );
            PrintOperTableHead( FormType );
          end;


          UseProgress( ProgressInd );
          ProgressInd = ProgressInd + 1;

          BuffOper = OperCodeDoc;
          BuffDep  = DepCodeAcc;

          if( Step == 47 )
            OpType = 1;
          elif( Step == 49 ) 
            OpType = 2;
          elif( Step == 60 )
            OpType = 5;
          elif( Step == 48 )
            if( DocAmn == PayAmn )
              OpType = 3;
            else
              OpType = 4;
            end;
          end;          
          
          if( Step == 47)
            DebetAmount = DocAmn;
            CreditAmount = 0;
            Debet = Debet + DocAmn;
            DebetDep = DebetDep + DocAmn;
            OutBalAcc = AccountPay;
          else
            CreditAmount = DocAmn;
            DebetAmount = 0;
            Credit = Credit + DocAmn;
            CreditDep = CreditDep + DocAmn;
            OutBalAcc = AccountRec;
          end;
          
          ch = ch + 1;

          PrintDocument( OpType, NumDoc, DebetAmount, CreditAmount, Account, Ground, OutBalAcc, PayDate, PartCode, FormType );

        end;                            

        if( iProgress > 0 )
          PrintOperTableTail( FormType );
          PrintOperTotal( BuffOper, Debet, Credit );
          PrintDepartmentTotal( DepCodeAcc, DebetDep, CreditDep, ( DepCodeAcc != 0 )  );
        end;
  end;
  RemProgress();   
END;


