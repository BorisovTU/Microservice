/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : psaktrns.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага зачисления                       */
/*                     средств по внутреннему платежу                   */
/*                     на клиентский счет                               */
/*                                                                      */
/*  Создан           : 19.12.00                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import  BankInter, InsCarryDoc, OprInter, FIInter, payconst, PaymInter, sfinsdoc, paym_rec;

RECORD  Pm_akkr ( pmakkr );  /* параметры аккредитива */
/*
RECORD  d(arhdoc);
RECORD  ord(pspayord);

MACRO InitDoc(d)
     ClearRecord(d);

     d.Chapter = 1;
     /*d.Date_Carry = {curdate};*/
     d.Date_Carry = Pm_paym.ValueDate;
     d.Result_Carry = 1;
     d.Kind_Oper = " 1";

     /* Присваиваем признак "Неотложные нужды" */     
     if(IsUrgentPayOrder(ord) == 1) d.TypeDocument = d.TypeDocument + "Н"; end;
END;
  */
/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder )
/*
  setbuff(ord,payorder);
  setbuff(d,doc);

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок в проведенные");
    return 1;
  end;

  InitDoc(d);
  d.Account_Receiver = Pm_paym.ReceiverAccount;
  d.Account_Payer    = Pm_paym.PayerAccount;
  d.Sum              = Pm_paym.Amount;
  d.Ground           = Pm_rmprop.Ground;
  d.Numb_Document    = Pm_rmprop.Number;
  d.Department       = Pm_paym.Department;
  d.Number_Pack      = Pm_paym.NumberPack;
  d.Shifr_Oper       = Pm_rmprop.ShifrOper;

  if(ord.Origin == PSPO_OR_SF)
    if(ВставитьПлатуЗаОбслуживание(Pm_paym,doc, Pm_rmprop.Number, 
                                   Pm_paym.ValueDate, Pm_paym.Department, Pm_paym.NumberPack )) 
      return 1; 
    end;
  else
    if(not (InsertRubDocument(NULL,PMMET_ID,Pm_paym.PaymentID)))
      msgbox("Ошибка при вставке рублёвого доккумента");
      return 1;
    end;
  end;

  if( not PM_IsInternalPayerAccount( Pm_paym ) )

    /* Изменяем дату списания со счета плательщика */
    if( not InsertPayerChargeOffDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты списания со счета плательщика");
      return 1;
    end;

    /* Изменяем дату отметки банка плательщика */
    if( not InsertPayerBankMarkDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты отметки банка плательщика");
      return 1;
    end;

  end;

  /*****************************************************
  Здесь можно вставлять дополнительные проводки для шага
  *****************************************************/
*/
  return 0;

END;
