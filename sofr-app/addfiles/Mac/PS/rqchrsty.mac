/* -------------------------------------------------------------------- */
/*         Автоматизированная банковская система RS-Bank v6.0           */
/*                 Copyright (c) R-Style Software Lab                   */
/*                                                                      */
/*  Имя файла  : rqchopy.mac                                            */
/*                                                                      */
/*  Описание   : Операция - 3037 - "Изменение номера счета"             */
/*               Шаг      - 55   - "Перенос остатка старого             */
/*                                  транзитного счета"                  */
/*                                                                      */
/*  Программист: Локтюшин В.Ю.                                          */
/*                                                                      */
/*  Создан     : 12.02.2007                                             */
/*                                                                      */
/* -------------------------------------------------------------------- */

IMPORT reqinter, PSInter, PaymInter;

var ReqChangeAccObj:RsbReqChangeAcc;

var OldTrAcc  :TRecHandler = TRecHandler( "account.dbt"  , "bank.def" );
var NewTrAcc  :TRecHandler = TRecHandler( "account.dbt"  , "bank.def" );

/* Выполнение шага */
MACRO ExecuteStep( doc, reqacc )
  var stat:integer = 0;

  var TrAccOldLnk = GetObjLinkAcc( ReqChangeAccObj.OldAccount, ReqChangeAccObj.OldAccountFIID, OBJROLE_ACC_TRANSIT );
  var reqlinka:TRecHandler = TRecHandler( "reqlinka.dbt", "bank.def");
  var Memorial:object;
  var MemPaym:RsbMOPayment;
  var OldAccRest;

  /* Если есть транзитный счет */
  if( TrAccOldLnk != "" )

    OldTrAcc = GetAccount( 1, TrAccOldLnk, ReqChangeAccObj.OldAccountFIID );
    
   reqlinka = GetReqLinkAcc( ReqChangeAccObj.RequestID, 232 );

    OldAccRest = RestA( OldTrAcc.rec.Account, NULL, NULL, 1/*CHAPT1*/, OldTrAcc.rec.Code_Currency );               
    if( ( OldAccRest > 0 ) and ( reqlinka.rec.RequestID != 0 ) )

      Memorial = GenObject("RsbMemorialOrder", 0 );
      MemPaym = Memorial.Payment();

      Memorial.State             = 0;/*CB_DOC_STATE_DEFERRED*/;
      Memorial.Oper              = {oper};
      Memorial.Chapter           = 1;
      Memorial.Origin            = MEMORDER_FDOC_AUTO;
      Memorial.Code_Currency     = ReqChangeAccObj.OldAccountFIID;

      MemPaym.DocKind            = 70;
      MemPaym.Purpose            = PM_PURP_MEMORDER;
      MemPaym.Number             = 1;
      MemPaym.PayerAmount        = OldAccRest;
      MemPaym.ReceiverFIID       = 
      MemPaym.PayerFIID          = OldTrAcc.rec.Code_Currency;                        
      MemPaym.Ground             = "ЏҐаҐў®¤ ®бв вЄ  § Єалў Ґ¬®Ј® ва ­§Ёв­®Ј® бзҐв ";
      MemPaym.ClientDate         =
      MemPaym.Date               =
      MemPaym.PayerBankEnterDate =
      MemPaym.ValueDate          = {curdate};
                           
      MemPaym.SetPayerPI( PAYMENTS_GROUP_UNDEF, 
                          {OurBank}, 
                          0, 
                          "", 
                          "",
                          "",
                          OldTrAcc.rec.Code_Currency, 
                          1/*CHAPT1*/, 
                          OldTrAcc.rec.Account, 
                          0, 
                          "", 
                          "" );

      MemPaym.SetReceiverPI( PAYMENTS_GROUP_UNDEF, 
                          {OurBank}, 
                          0, 
                          "", 
                          "",
                          "",
                          OldTrAcc.rec.Code_Currency, 
                          1/*CHAPT1*/, 
                          reqlinka.rec.Account, 
                          0, 
                          "", 
                          "" );
                  
      // Установить мемориальному ордеру признак автозапуска операции.
      Memorial.LaunchOper    = true;
      Memorial.ConnectToOper = true;
      MemPaym.CryptoAction( string("Автоматическое_формирование_платежей") );
    end;

  end;

return 0;

END;