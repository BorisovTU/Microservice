import          InsCarryDoc, payinter;

record          BasePmPaym(  pmpaym );
record          ContrPmPaym( pmpaym );

/*------------------------------------------------------------------------------------\
|               Зачисление рублей после обратной продажи валюты                       |
|                                                                                     |
\------------------------------------------------------------------------------------*/


macro   ExecuteStep( doc, order )
/*
        record          bo(ps_bcord);
        record          d(arhdoc);
        record          Kpayment(pmpaym);
        record          Bpayment(pmpaym);
        record          mc(multycar);

        Var             Account_Payer,
                        Account_Rur,
                        Account_Cur,
                        Acc1,
                        Acc2,
                        Account_OCP;

        SetBuff( bo, order );
        SetBuff( d, doc );

        /* Найти платеж по контрактиву */
        if ( FindPayment( 
                        0,      /* Индентификатор неизвестен    */
                        CRi,    /* возврат контрактива          */
                        0,      /* Subpurpose                   */
                        bo.dockind,
                        bo.orderid,
                        true,
                        Kpayment

                )       !=      0 )

                MsgBox( "Не могу найти платеж по возврату средств" );
                return  1;
        end;

        /* Найти платеж по активу */
        if ( FindPayment( 
                        0,      /* Индентификатор неизвестен    */
                        BRi,    /* возврат контрактива          */
                        0,      /* Subpurpose                   */
                        bo.dockind,
                        bo.orderid,
                        true,
                        Bpayment

                )       !=      0 )

                MsgBox( "Не могу найти платеж по возврату средств" );
                return  2;
        end;


        /*
                Проверить лицевой счет
        */
        if ( CheckAccount( 
                        213,                    /* Тип счета */
                        Account_Payer,          /* В случае успеха, сюда вернется номер счета*/
                        Kpayment.FIID,           /* Код валюты */
                        1                       /* Глава */
                        )  !=  0 )
                return  3;
        end;


        /*
                Зачисление средств на рублевый счет клиента
        */
        SetBuff( d, doc );
        ClearRecord(d);
        
        d.Chapter = 1;
        d.Code_Currency = Kpayment.FIID;
        d.Account_Payer = Account_Payer;
        d.Account_Receiver = Kpayment.ReceiverAccount;
        d.Result_Carry = 1;

        d.Kind_Oper = " 1";
        d.Shifr_Oper = "09";

        d.Sum = Kpayment.Amount;

        d.Date_Carry       = {curdate};

        d.Ground = "Заявка на конвертацию валюты № " + String( bo.Number ) + ". Возврат средств после обратного списания валюты и ее продажи.";


        if ( d.Code_Currency == 0 )
                if( not InsertRubDocument( NULL, Kpayment.PaymentID))
                   msgbox("Ошибка при вставке рублевого документа");
                   return 1;
                end;
        else
                if( not InsertCurDocument( NULL, Kpayment.PaymentID ))   
                   msgbox("Ошибка при вставке валютного документа");
                   return 1;
                end;
        end;
  

        /*      Проверить лицевой счет, с которого будет списываться валюта  */
        if ( CheckAccount( 
                        214,                    /* Тип счета */
                        Account_Cur,            /* В случае успеха, сюда вернется номер счета*/
                        Bpayment.FIID,        /* Код валюты */
                        1                       /* Глава */
                        )  !=  0 )
                return  4;
        end;


        /*
                Проверить лицевой счет (курсовые разницы)
        */
        if ( CheckAccount( 
                206,            /* Тип счета */
                Acc1,           /* В случае успеха, сюда вернется номер счета*/
                0,              /* Код валюты */
                1               /* Глава        */
                )  !=  0 )
                return  5;
        end;

        if ( CheckAccount( 
                205,            /* Тип счета */
                Acc2,           /* В случае успеха, сюда вернется номер счета*/
                0,              /* Код валюты */
                1               /* Глава        */
                )  !=  0 )
                return  6;
        end;

        /*
                Проверить лицевой счет (ОВП)
        */
        if ( CheckAccount( 
                204,            /* Тип счета */
                Account_OCP,    /* В случае успеха, сюда вернется номер счета*/
                Bpayment.FIID,  /* Код валюты */
                1               /* Глава        */
                )  !=  0 )
                return  4;
        end;

        /*      Проверить лицевой счет  */
        if ( CheckAccount( 
                        213,                    /* Тип счета */
                        Account_Rur,            /* В случае успеха, сюда вернется номер счета*/
                        Kpayment.FIID,       /* Код валюты */
                        1                       /* Глава */
                        )  !=  0 )
                return  7;
        end;


        /*      
                Конвертация - подготовить мультивалютную проводку
        */
        SetBuff( mc, doc );
        ClearRecord( mc );
        mc.MethodID = 1;
        mc.Account_From = Account_Cur;
        mc.Account_To = Account_Rur;
        mc.AccOCP_From  = Account_OCP;
        mc.FIID_From  = Bpayment.FIID;
        mc.FIID_To = Kpayment.FIID;
        mc.Date = {curdate};
        mc.Chapter = 1;
        mc.Amount_From = Bpayment.Amount;
        mc.Amount_To = Kpayment.Amount;
        mc.Account1 = Acc1;
        mc.Account2 = Acc2;

        if ( not InsertMultiCarry() )
                MsgBox( "Ошибка при вставке мультивалютного документа" );
                return  8; 
        end;
    */
        return  0;

end;