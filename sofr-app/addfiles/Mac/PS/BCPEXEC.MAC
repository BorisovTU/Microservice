/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 2001              */
/*                                                                      */
/*  Имя файла        : bcpexec.mac                                      */
/*                                                                      */
/*  Описание         : Выполнение шага по продаже валюты                */
/*                                                                      */
/*  Программист      : Бурак В.Ю.                                       */
/*                                                                      */
/*  Создан           : 21.05.2001                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, payinter, "bcall.mac";
import "bc_categ.mac";
/*
private record  d(arhdoc);
record  mc(multycar);
*/
record  PartBCexe (ps_bcexe); /*Параметры исполнения*/


/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, ps_bcord )
/*
    record bc( ps_bcord );
    record object(account);
    record fiobject(fininstr);
    record attr  (account);

    setbuff( bc, ps_bcord );
    setbuff( d, doc );

    // Счета курсовых разниц идут в рублях
    var FD:PSBC_FirstDoc = PSBC_FirstDoc( bc, 0 );

    object.Code_Currency = bc.SourceFIID;
    object.Chapter = 1;
    object.Account = bc.CurrentAccount;

    var ВидСчетаОперации = 1,err;

    if( bc.MarketPlace != PTID_UNKNOWNPARTY ) /* Операция на бирже */
       /* Определяем вид счета по которому пойдёт операция*/
       /*  1 - обязательная  - ТВС   */
       /*  2 - обратная      - СТВС  */

       //!!! Теперь обратной нет, а код надо бы подчистить!!!
       //все шаги на else выполнятся не будут...

       if ( bc.BCOrdSubKind == 2 ) /*обратная продажа*/
          ВидСчетаОперации = ПолучитьТипСчета (bc.SourceAccount, bc.SourceFIID,  1);
       end;

       /*  1.9. */
       ClearRecord(d);
       d.Chapter = 1;
       d.Date_Carry = PartBCexe.ExecDate;

       if(not GetLinkedObject( OBJROLE_CUR_MARKETACCORD, OBJTYPE_CURRENCY, fiobject, OBJTYPE_ACCOUNT, attr ))
         d.Account_Payer = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         d.Account_Payer = "";
       end;

       if (ВидСчетаОперации == 1)
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Receiver = attr.Account;  /* Нашли настройку */
          else /* Не найден связанный счет */
            d.Account_Receiver  = "";
          end;
       else
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Receiver = attr.Account;  /* Нашли настройку */
          else /* Не найден связанный счет */
            d.Account_Receiver  = "";
          end;
       end;

       d.Sum    = PartBCexe.SatisfiedAmount;
       d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                            " Перечисление средств с биржи";

       d.Numb_Document = PartBCexe.DealNumber;
       d.Department    = bc.Department;
       d.Number_Pack   = bc.NumberPack;
       d.Shifr_Oper    = "09";
    
       d.Result_Carry = 1;
       d.Kind_Oper = " 1";

       if( not InsertRubDocument( NULL ) )
          msgbox("Ошибка при вставке рублевого документа");
          return 1;
       end;

       /*  1.10. */
       ClearRecord(d);
       d.Chapter = 1;
       d.Date_Carry = PartBCexe.ExecDate;

       if (ВидСчетаОперации == 1)
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Payer = attr.Account;  /* Нашли настройку */
          else /* Не найден связанный счет */
            d.Account_Payer  = "";
          end;
       else
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Payer = attr.Account;  /* Нашли настройку */
          else /* Не найден связанный счет */
            d.Account_Payer  = "";
          end;
       end;

       d.Account_Receiver = bc.RequiredAccount; 

       d.Sum    = PartBCexe.SatisfiedAmount;
       
       d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate +  "." +
                            " Зачисление полученных от продажи средств";

       d.Numb_Document = PartBCexe.DealNumber;
       d.Department    = bc.Department;
       d.Number_Pack   = bc.NumberPack;
       d.Shifr_Oper    = "09";
    
       d.Result_Carry = 1;
       d.Kind_Oper = " 1";

       if( not InsertRubDocument( NULL ) )
          msgbox("Ошибка при вставке рублевого документа");
          return 1;
       end;

       /*  1.11. */

       ClearRecord(d);

       if((bc.SourceFIID != bc.ExchangeFIID) and (bc.ExchangeFIID != 0) and (bc.ExchangeFIID != -1))
          d.Code_Currency = bc.ExchangeFIID;
          fiobject.FIID   = bc.ExchangeFIID;
          object.Code_Currency = bc.ExchangeFIID;
          if( not ПолучитьТкВС_Клиента (bc.ClientID, bc.ExchangeFIID, object.Account))
             return 1;
          end;
       else
          d.Code_Currency = bc.SourceFIID;
          fiobject.FIID   = bc.SourceFIID;
          object.Code_Currency = bc.SourceFIID;
          object.Account = bc.CurrentAccount;
       end;

       d.Chapter = 1;

       d.Date_Carry = PartBCexe.ExecDate;

       if (ВидСчетаОперации == 1)
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Payer = attr.Account;  /* Нашли настройку */
          else
            d.Account_Payer =  "";  /* Нашли настройку */
          end;
       else
          if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
            d.Account_Payer = attr.Account;  /* Нашли настройку */
          else
            d.Account_Payer = "";  /* Нашли настройку */
          end;
       end;

       if(not GetLinkedObject( OBJROLE_CUR_MARKETACCCLAIM, OBJTYPE_CURRENCY, fiobject, OBJTYPE_ACCOUNT, attr ))
         d.Account_Receiver = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         d.Account_Receiver = "";
       end;

       d.Sum    = PartBCexe.UsedAmount;

       d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                        " Зачисление купленной валюты";

       d.Numb_Document = PartBCexe.DealNumber;
       d.Department    = bc.Department;
       d.Number_Pack   = bc.NumberPack;
       d.Shifr_Oper    = "09";
    
       d.Result_Carry = 1;
       d.Kind_Oper = " 1";

       if( not InsertCurDocument( NULL ) )
          msgbox("Ошибка при вставке валютного документа");
          return 1;
       end;

       /* Возвращаем установки на место */
       fiobject.FIID   = bc.SourceFIID;
       object.Code_Currency = bc.SourceFIID;
       object.Account = bc.CurrentAccount;

       /* проводка оставшихся валютных средств */
       if( bc.FullExecute and bc.BCOrdSubKind == 1 )

          ClearRecord( d );
          d.Chapter = 1;

          d.Date_Carry    = PartBCexe.ExecDate;
          d.Code_Currency = bc.SourceFIID;
          d.Sum           = bc.InAmount - bc.SourceAmount; 

          if( not ПолучитьТВС_Клиента( bc.ClientID, bc.SourceFIID, d.Account_Payer ) )
             d.Account_Payer = "";
          end;

          d.Account_Receiver = bc.CurrentAccount;

          d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                                "Зачисление валютных средств не подлежащих обязательной продаже";

          d.Numb_Document = PartBCexe.DealNumber;
          d.Department    = bc.Department;
          d.Number_Pack   = bc.NumberPack;
          d.Shifr_Oper    = "09";
      
          d.Result_Carry  = 1;
          d.Kind_Oper     = " 1";

          if( d.Sum > 0 )
             if( not InsertCurDocument( NULL ) )
               msgbox("Ошибка при вставке рублевого документа");
               return 1;
            end;
         end;

      end;

    else /* Операция на бирже - Операция в банке */
       if( bc.ValueDate != bc.OrderDate )     /* снятие сделки с в/б */

           /* 4.2.1. - 4.2.3 */
           SetBuff( mc, doc );
           ClearRecord( mc );
           mc.MethodID = 1;

           mc.FIID_From    = bc.RequiredFIID;
           mc.FIID_To      = bc.SourceFIID;

           mc.Amount_From  = PartBCexe.SatisfiedAmount;
           mc.Amount_To    = PartBCexe.UsedAmount;

           if (Клиент_Резидент(bc.ClientID))
              if(not GetLinkedObject( OBJROLE_ACC_ORDERBCDELIVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
                mc.Account_From = attr.Account;  /* Нашли настройку */
              else /* Не найден связанный счет */
                mc.Account_From = "";
              end;

              if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCDELIV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
                mc.Account_To = attr.Account;  /* Нашли настройку */
              else /* Не найден связанный счет */
                mc.Account_To = "";
              end;
           else
              if(not GetLinkedObject( OBJROLE_ACC_ORDERBCDELIVNRNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
                mc.Account_From = attr.Account;  /* Нашли настройку */
              else /* Не найден связанный счет */
                mc.Account_From = "";
              end;

              if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCDELIVNR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
                mc.Account_To = attr.Account;  /* Нашли настройку */
              else /* Не найден связанный счет */
                mc.Account_To = "";
              end;
           end;

           //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыДоходВБ , V_STRING, mc.Account1, err );
           //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыРасходВБ, V_STRING, mc.Account2, err );

           mc.Account1 = FD.FindAndOpenAccount( "+Форвард, маржа", 0, {curdate} );
           mc.Account2 = FD.FindAndOpenAccount( "-Форвард, маржа", 0, {curdate} );

           mc.Chapter       = 4;
           mc.Ground        = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                            " Ликвидация требований/обязательств по сделке";

           mc.Numb_Document = PartBCexe.DealNumber;;
           mc.Date          = PartBCexe.ExecDate;
           mc.Date_Document = bc.OrderDate;
           mc.Number_Pack   = bc.NumberPack;
           mc.Department    = bc.Department;
           mc.ShifrOper     = "09";

           if( not InsertMultiCarry() )
             MsgBox( "Ошибка при вставке мультивалютного документа (снятие сделки с внебаланса)" );
             return 1; 
           end;
       end;         /* снятие сделки с в/б */

       /* 3.1 - 3.3  (4.3.1 - 4.3.3) */
       SetBuff( mc, doc );
       ClearRecord( mc );
       mc.MethodID = 1;

       mc.FIID_From    = bc.SourceFIID;
       mc.FIID_To      = bc.RequiredFIID;

       mc.Amount_From  = PartBCexe.UsedAmount;
       mc.Amount_To    = PartBCexe.SatisfiedAmount;

       if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCCONV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
         mc.Account_From = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         mc.Account_From = "";
       end;

       if(not GetLinkedObject( OBJROLE_ACC_ORDERBCCONVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
         mc.Account_To = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         mc.Account_To = "";
       end;

       mc.Chapter       = 1;
       mc.Ground        = "Формирование обязательств по поручению №" + bc.Number + " от " + bc.OrderDate + ".";
       mc.Numb_Document = PartBCexe.DealNumber;
       mc.Date          = PartBCexe.ExecDate;
       mc.Date_Document = bc.OrderDate;
       mc.Number_Pack   = bc.NumberPack;
       mc.Department    = bc.Department;
       mc.ShifrOper     = "09";

       GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыДоход, V_STRING, mc.Account1, err );
       GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыРасход, V_STRING, mc.Account2, err );

       if( not InsertMultiCarry() )
         MsgBox( "Ошибка при вставке мультивалютного документа" );
         return 1; 
       end;

       /* 3.4 (4.3.4)*/
       ClearRecord(d);
       d.Chapter = 1;

       d.Date_Carry = PartBCexe.ExecDate;

       d.Account_Payer = bc.SourceAccount;

       if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCCONV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
         d.Account_Receiver = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         d.Account_Receiver = "";
       end;

       d.Sum    = PartBCexe.UsedAmount;
       d.Code_Currency = bc.SourceFIID;

       d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                        " Зачисление купленной валюты";

       d.Numb_Document = PartBCexe.DealNumber;
       d.Department    = bc.Department;
       d.Number_Pack   = bc.NumberPack;
       d.Shifr_Oper    = "09";
    
       d.Result_Carry = 1;
       d.Kind_Oper = " 1";

       if( not InsertCurDocument( NULL ) )
          msgbox("Ошибка при вставке валютного документа");
          return 1;
       end;

       /* 3.5  (4.3.5)*/
       ClearRecord(d);

       d.Chapter = 1;

       d.Date_Carry = PartBCexe.ExecDate;
    
       if(not GetLinkedObject( OBJROLE_ACC_ORDERBCCONVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
         d.Account_Payer = attr.Account;  /* Нашли настройку */
       else /* Не найден связанный счет */
         d.Account_Payer = "";
       end;

       d.Account_Receiver = bc.RequiredAccount;

       d.Sum    = PartBCexe.SatisfiedAmount;
       d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." + 
                        " Зачисление средств по поручению";

       d.Numb_Document = PartBCexe.DealNumber;
       d.Department    = bc.Department;
       d.Number_Pack   = bc.NumberPack;
       d.Shifr_Oper    = "09";
    
       d.Result_Carry = 1;
       d.Kind_Oper = " 1";

       if( not InsertRubDocument( NULL ) )
          msgbox("Ошибка при вставке рублевого документа");
          return 1;
       end;

    end; /* Опрация в банке */
*/
    return 0;
end;
