/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.10          */
/*                 Copyright (c) R-Style Software Lab 1999              */
/*                                                                      */
/*  Имя файла        : pscpsend.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага списания                         */
/*                     средств по валютному платежу                     */
/*                     с клиентского                                    */
/*  Программист      : Зайцев А.В.                                      */
/*                                                                      */
/*  Создан           : 21.03.02                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, PTInter, "pmoutcom.mac", "cppmconv.mac", "paym_rec.mac";

/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder, Kind, ID_Operation )  
/*
  RECORD  d(arhdoc);
  RECORD  mc(multycar);
  RECORD  ps ( pspayord );

  var SumPaym = $0, SumDoc = $0, PaySumPaym = $0, PaySumDoc = $0;  

  setbuff(ps,payorder);

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок в проведенные");
    return 1;
  end;

  /*                     Для начала разберемся с комиссиями                */
  if ( ExecuteSingCommission( ID_Operation, ps, Kind, Pm_paym, Pm_credit,
                          Pm_rmprop.ChargesOfBank, Pm_rmprop.CorrespondentCharges,
                          PaySumPaym, PaySumDoc, SumPaym, SumDoc) )
     return 1;
  end;  

  /* Проводку на транзитный выполняем только для внешнего платежа */
  if( (Pm_credit.PaymentID == Pm_paym.PaymentID) and (Pm_credit.Group == PAYMENTS_GROUP_EXTERNAL) )
     if( Pm_paym.FIID == Pm_paym.PayFIID )     

        /*****************************************************
        Зачисление на корсчет без конверсии
        *****************************************************/
        setbuff(d,doc);
        ClearRecord(d);     

        d.Chapter = 1;
        d.Date_Carry = Pm_paym.ValueDate;
        d.Number_Pack = Pm_paym.NumberPack;

        /* Из-за МФР проводки теперь делаются только по Future-счетам */
        d.Account_Payer    = Pm_paym.FuturePayerAccount;
        d.Account_Receiver = Pm_paym.FutureReceiverAccount;

        if(d.Account_Receiver == "")
          msgbox("В схеме расчетов не задан счет \"Средства клиентов по незавершенным операциям\"");
          return 1;
        end;

        d.Sum = PaySumDoc;
        d.Ground = Pm_rmprop.Ground;
        d.Code_Currency = Pm_paym.PayFIID;

        d.Numb_Document = Pm_rmprop.Number;
        d.Department    = Pm_paym.Department;

        d.Result_Carry = 1;
        d.Kind_Oper = " 1";

        if(Pm_paym.PayFIID) 
          if( not InsertCurDocument(NULL, 1 /*PMMET_ID*/, Pm_paym.PaymentID) )
              msgbox("Ошибка при вставке валютного документа");
             return 1;
          end;
        else 
          if( not InsertRubDocument(NULL, 1 /*PMMET_ID*/ ,Pm_paym.PaymentID) )
             msgbox("Ошибка при вставке рублевого документа");
             return 1;
          end;
        end;
     else
        /*****************************************************
        Зачисление на корсчет с конверсией
        *****************************************************/

        if( ПолучитьДополнительныеСчетаПроводокКонверсии() )
          msgbox( "Ошибка при установке счетов ОВП" );
          return 1;
        end;

        SetBuff( mc, doc );
        ClearRecord( mc );
        mc.MethodID = 1;

        mc.FIID_From    = Pm_paym.FIID;
        mc.FIID_To      = Pm_paym.PayFIID;
        mc.Amount_From  = SumDoc;
        mc.Amount_To    = PaySumDoc;

        /* Из-за МФР проводки теперь делаются только по Future-счетам */
        mc.Account_From  = Pm_paym.FuturePayerAccount;
        mc.Account_To    = Pm_paym.FutureReceiverAccount;
        
        if(mc.Account_To == "")
          msgbox("В схеме расчетов не задан счет \"Средства клиентов по незавершенным операциям\"");
          return 1;
        end;
        
        mc.Chapter       = 1;
        mc.Ground        = Pm_rmprop.Ground;
        mc.Numb_Document = Pm_rmprop.Number;
        mc.Date          = Pm_paym.ValueDate;
        mc.Date_Document = Pm_rmprop.Date;
        mc.Number_Pack   = Pm_paym.NumberPack;
        mc.Department    = Pm_paym.Department;
        mc.AccOCP_From   = СчетОВПДебет;
        mc.AccOCP_To     = СчетОВПКредит;
        mc.Account1      = СчетДоходов;
        mc.Account2      = СчетРасходов;

        mc.PaymentTPR = 1; //PMMET_ID
        mc.PaymentIDR = Pm_paym.PaymentID;

        mc.PaymentTPC = 1; //PMMET_ID
        mc.PaymentIDC = Pm_paym.PaymentID;

        if( not InsertMultiCarry() )
          MsgBox( "Ошибка при вставке мультивалютного документа" );
          return 1; 
        end;

     end;

  end;
  */
  return 0;  

END;