
/*ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : PR_INDLA.MAC
  Programmer  : ó„™®≠† í.Ä.
  Description : ò‚†‰•´Ï ™†‡‚Æ‚•™®

¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ*/

import rsd, PSInter, globals, oralib, likepy, FIInter, CurrInter;

/* ≠„¨•‡†Ê®Ô ØÆ´•© ¢ ·‚‡Æ™†Â */
private const DateCol   = 0,  // Ñ†‚†
              DebetCol  = 1,  // è‡®ÂÆ§
              CreditCol = 2,  // ê†·ÂÆ§
              RestCol   = 3;  // é·‚†‚Æ™

private macro getAccountsK2
( 
  DepNum  : integer, // î®´®†´
  NodeNum : integer, // Çëè
  FIID    : integer, // Ç†´Ó‚†
  Chapter : integer, // É´†¢†
  Balance : string   // account.Balance
):RsdRecordset

  var select : string = "SELECT acc.t_Account, acc.t_Code_Currency, acc.t_Chapter " +
                        "  FROM daccount_dbt acc ";
  var whereC : string = " WHERE acc.t_Department = :DepNum " +
                        "   AND acc.t_Code_Currency = :FIID " +
                        "   AND acc.t_Chapter = :Chapter " +
                        "   AND acc.t_Balance = :Balance " +
                        // account ®¨••‚ ·¢ÔßÏ ØÆ ¢®§„ "Ç≠•°†´†≠·Æ¢Î© ëÁ•‚ ™†‡‚Æ‚•™® 2"
                        "   AND EXISTS (select 1 " +
                        "                 from dobjlink_dbt ol " +
                        "                where ol.t_groupid = 2 " /*OBJROLE_ACC_I2OBACC*/ +
                        "                  and ol.t_objecttype = 4 " /*OBJTYPE_ACCOUNT*/ +
                        "                  and ol.t_attrtype = 4 " /*OBJTYPE_ACCOUNT*/ +
                        "                  and ol.t_attrid = LPAD(acc.t_Chapter, 2, '0') || " +
                        "                                    LPAD(acc.t_Code_Currency, 7, '0') || " +
                        "                                    acc.t_account ) ";
  
  if( NodeNum > 0 ) 
    whereC = whereC +   "   AND acc.t_Branch = :NodeNum ";
  else
    var privFROM : string = ""; //§ÆØÆ´≠®‚•´Ï≠†Ô ·‚‡Æ™† §´Ô Ø‡Æ¢•‡™® Ø‡®¢®´•£®® 0008
    var privWHERE : string = ""; //§ÆØÆ´≠®‚•´Ï≠Æ• „·´Æ¢®• §´Ô Ø‡Æ¢•‡™® Ø‡®¢®´•£®® 0008
    if( GetObjectRestriction(privWHERE, 8, {Oper}, "dt", 0,"dp_dep.dbt", privFROM) )
      if(privFROM != "")
        select = select + ", " + privFROM + " ";
      else
        select = select + ", ddp_dep_dbt dt ";
        whereC = whereC + " AND dt.t_Code = acc.t_Branch ";
      end;
      if(privWHERE != "")
        whereC = whereC + " AND " + privWHERE;
      end;
    end;
  end;

  select = select + whereC;
  var params : TArray = TArray();
  params[params.size] = SQLParam( "DepNum" , DepNum );
  params[params.size] = SQLParam( "FIID"   , FIID );
  params[params.size] = SQLParam( "Chapter", Chapter );
  params[params.size] = SQLParam( "Balance", Balance );
  if( NodeNum > 0 )
    params[params.size] = SQLParam( "NodeNum", NodeNum );
  end;

  return execSQLselect(select, params, true, RSDVAL_CLIENT, RSDVAL_STATIC );
end;

// ÇÎÁ®·´®‚Ï ·„¨¨„ ß†Á®·´•≠®Ô (Debet) ØÆ ·Á•‚„ ß† §†‚„
private macro getDebet(d : date, account : string, FIID : integer) : money
  
  var select : string = "";
  select = "SELECT NVL ( SUM(trn.t_Sum_Payer), 0 ) " +
           "  FROM dacctrn_dbt trn " +
           " WHERE trn.t_Account_Payer = :Account " +
           "   AND trn.t_FIID_Payer = :FIID " +
           "   AND trn.t_State = 1 " +
           "   AND trn.t_Result_Carry = 50 " +
           "   AND trn.t_Date_Carry = :DateRep ";

  var params : TArray = makeArray( SQLParam("Account", account),
                                   SQLParam("FIID", FIID),
                                   SQLParam("DateRep", d) );
  var rs : RsdRecordset = execSQLselect(select, params, true );
  if ( (rs) and (rs.moveNext()) )
    return rs.value(0);
  else
    return $0;
  end;

end;

private macro getCredit(d : date, account : string, FIID : integer) : money

  var select : string = "";
  select = "SELECT NVL ( SUM(trn.t_Sum_Payer), 0 ) " +
           "  FROM dacctrn_dbt trn " +
           " WHERE trn.t_Account_Receiver = :Account " +
           "   AND trn.t_FIID_Receiver = :FIID " +
           "   AND trn.t_State = 1 " +
           "   AND trn.t_Result_Carry IN (51, 52, 53, 74) " +
           "   AND trn.t_Date_Carry = :DateRep ";

  var params : TArray = makeArray( SQLParam("Account", account),
                                   SQLParam("FIID", FIID),
                                   SQLParam("DateRep", d) );
                                     
  var rs : RsdRecordset = execSQLselect(select, params, true );
  if ( (rs) and (rs.moveNext()) )
    return rs.value(0);
  else
    return $0;
  end;

end;

private macro getData
( 
  DateIn     : date, 
  DateOut    : date, 
  FIID       : integer, 
  acc        : RsdRecordset,
  cSetCarryDaysOnly : bool,
  RestBegin  : @money, 
  RestEnd    : @money,
  DebetTotal : @money,
  CreditTotal: @money, 
  rows       : TArray 
):integer

  RestBegin = RestEnd = $0;

  var d : date = DateIn - 1; // ·Á®‚†•¨ Æ·‚†‚Æ™ ≠† ≠†Á†´Æ Æ‚Á•‚≠Æ£Æ Ø•‡®Æ§†
  var OK = true;
  if(acc.moveFirst())
    while (OK)        
      if( FIID == NATCUR )
        RestBegin = RestBegin + RestA( acc.value("t_Account"), d, NULL, acc.value("t_Chapter") );
      else
        RestBegin = RestBegin + RestAC( acc.value("t_Account"), FIID, d, NULL, acc.value("t_Chapter") );
      end;
      OK = acc.moveNext();
    end;
  end;
    
  d = DateIn;
  var ë„¨¨†á†Á®·´•≠®Ô = $0, ë„¨¨†ëØ®·†≠®Ô = $0, î†™‚é·‚†‚Æ™ = $0;
  DebetTotal = CreditTotal = $0;
  while (d <= DateOut) // Ê®™´ ØÆ §†‚†¨
    // ß†ØÆ´≠Ô•¨ ÆÁ•‡•§≠„Ó ·‚‡Æ™„ Æ‚Á•‚† ¢ rows
    ë„¨¨†á†Á®·´•≠®Ô = ë„¨¨†ëØ®·†≠®Ô = î†™‚é·‚†‚Æ™ = $0;
    if(acc.moveFirst())
      OK = true;
      while (OK) // Ê®™´ ØÆ ·Á•‚†¨ §´Ô ‚•™„È•© §†‚Î 
        ë„¨¨†á†Á®·´•≠®Ô = ë„¨¨†á†Á®·´•≠®Ô + getDebet( d, acc.value("t_Account"), acc.value("t_Code_Currency") );
        ë„¨¨†ëØ®·†≠®Ô = ë„¨¨†ëØ®·†≠®Ô + getCredit( d, acc.value("t_Account"), acc.value("t_Code_Currency") );
        if( FIID == NATCUR )
          î†™‚é·‚†‚Æ™ = î†™‚é·‚†‚Æ™ + RestA( acc.value("t_Account"), d, NULL, acc.value("t_Chapter") );
        else
          î†™‚é·‚†‚Æ™ = î†™‚é·‚†‚Æ™ + RestAC( acc.value("t_Account"), FIID, d, NULL, acc.value("t_Chapter") );
        end;        
        OK = acc.moveNext();
      end; // Ê®™´ ØÆ ·Á•‚†¨
      if ( not ( (ë„¨¨†á†Á®·´•≠®Ô == $0) and (ë„¨¨†ëØ®·†≠®Ô == $0) and (cSetCarryDaysOnly) ) )
        rows[rows.Size] = TArray();
        rows[rows.Size - 1][DateCol] = d;
        rows[rows.Size - 1][DebetCol] = ë„¨¨†á†Á®·´•≠®Ô;
        rows[rows.Size - 1][CreditCol] = ë„¨¨†ëØ®·†≠®Ô;
        rows[rows.Size - 1][RestCol] = î†™‚é·‚†‚Æ™;
        DebetTotal = DebetTotal + ë„¨¨†á†Á®·´•≠®Ô;
        CreditTotal = CreditTotal + ë„¨¨†ëØ®·†≠®Ô;
      end;
    end; // if(acc.moveFirst())
    d = d + 1;      
  end; // Ê®™´ ØÆ §†‚†¨
  RestEnd = î†™‚é·‚†‚Æ™; // Æ·‚†‚Æ™ ß† §†‚„ DateOut

  return 0;
end; 

private macro PrintReport
(
  DateIn      : date, 
  DateOut     : date, 
  DepNum      : integer, 
  NodeNum     : integer, 
  FIID        : integer, 
  RestBegin   : money,  
  RestEnd     : money, 
  DebetTotal  : money, 
  CreditTotal : money, 
  Rows        : TArray
)
  var DepCode= "", DepName = "";
  CB_GetDepartmentCodeAndName( DepNum, DepCode, NULL, DepName );
  var NodeCode= "", NodeName = "";
  if (NodeNum > 0)
    CB_GetDepartmentCodeAndName( NodeNum, NodeCode, NULL, NodeName );
  end;
  var FICode = "", FIName = "";
  var fininstr = TRecHandler("fininstr.dbt");
  if( not èÆ´„Á®‚Ïî®≠à≠( FIID, fininstr ) )
    FICode = fininstr.rec.FI_Code;
    FIName = fininstr.rec.Name;
  end;
  
  [
                                    òíÄîÖãú
                        ä ÇçÖÅÄãÄçëéÇéåì ëóÖíì N 90902
                     áÄ èÖêàéÑ ë ########## èé ##########

    î®´®†´ ##########   ############################################################ 
  ] (DateIn, DateOut, DepCode, DepName);

  if (NodeNum > 0)
  [ Çëè  ##########   ############################################################ 
  ] (NodeCode, NodeName );
  end;

  [ Ç†´Ó‚† ·Á•‚† ############### #################################################

    é·‚†‚Æ™ ≠† ≠†Á†´Æ Æ‚Á•‚≠Æ£Æ Ø•‡®Æ§†                     ####################
                                                                              
   ⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
   ≥   Ñ†‚†   ≥       è‡®ÂÆ§        ≥       ê†·ÂÆ§        ≥       é·‚†‚Æ™       ≥
  ] (FICode : l, FIName : l, RestBegin : r);

  for (var i, 0, Rows.Size - 1, 1)
  [√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
   ≥##########≥#################### ≥#################### ≥#################### ≥
  ] (Rows[i][DateCol], Rows[i][DebetCol] : r, Rows[i][CreditCol] : r, Rows[i][RestCol] : r);
  end;

  [√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
   ≥à‚Æ£Æ     ≥#################### ≥#################### ≥          X          ≥
   ¿ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ

    é·‚†‚Æ™ ≠† ™Æ≠•Ê Æ‚Á•‚≠Æ£Æ Ø•‡®Æ§†                      ####################
  ] (DebetTotal : r, CreditTotal : r, RestEnd : r);

end;

macro PrintRep_K2_Shtafel( MapVal :PSRepMap )

  /* Ñ†≠≠Î• Ø†≠•´® */
  var DateIn        :date     = MapVal.Value( "DateIn"       );
  var DateOut       :date     = MapVal.Value( "DateOut"      );
  var DepNum        :integer  = MapVal.Value( "DepNum"       );
  var NodeNum       :integer  = MapVal.Value( "NodeNum"      );
  var FIID          :integer  = MapVal.Value( "FIID"         );
  var cSetCarryDays :bool     = MapVal.Value( "cSetCarryDays");

  var RestBegin  : money  = $0,
      RestEnd    : money  = $0,
      DebetTotal : money  = $0,
      CreditTotal: money  = $0,
      Rows       : TArray = TArray();
  var acc : RsdRecordset = getAccountsK2(DepNum, NodeNum, FIID, 3, "90902");
  if (acc)
    acc.Command.NullConversion = true;
    getData( DateIn, DateOut, FIID, acc, cSetCarryDays, @RestBegin, @RestEnd, 
             @DebetTotal, @CreditTotal, Rows );

  end;

  if( Rows.size > 0 )
    PrintReport(DateIn, DateOut, DepNum, NodeNum, FIID, RestBegin, RestEnd, 
                DebetTotal, CreditTotal, Rows);
  else // §†≠≠ÎÂ §´Ô Æ‚Á•‚† ≠• ≠†©§•≠Æ
    msgbox("ç•‚ §Æ™„¨•≠‚Æ¢, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â ß†§†≠≠Î¨ „·´Æ¢®Ô¨");
  end;
        
end;
