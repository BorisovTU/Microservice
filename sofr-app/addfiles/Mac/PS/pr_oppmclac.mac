/*
$Name:             pr_oppmclac.mac
$Module:           Š îà¨¤¨ç¥áª¨å «¨æ 
$Description:      Œ ªà®á ¯¥ç â¨ ®âç¥â  ® ­¥¨á¯®«­¥­­ëå ¯« â¥¦ å ¯® áç¥âã
*/

import FIInter, PSInter, "pmlib.mac", reqinter;

private macro TableHeader( Account:string );
[
  ¥¨á¯®«­¥­­ë¥ ¯« â¥¦¨ ¯® áç¥âã #########################:

  ÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ               
  ü ¤®ª. ³    ‚¨¤ ¤®ªã¬¥­â     ³    „ â    ³‚ «îâ ³     ‘ã¬¬      ³  ‘ç¥â ª®­âà £¥­â    ³     ­ª ª®­âà £¥­â     ³ ˆŠ ¡ ­ª   ³               à¨¬¥ç ­¨¥
         ³                     ³ ¤®ªã¬¥­â  ³ ¤®ª. ³   ¤®ªã¬¥­â    ³                     ³                        ³ª®­âà £¥­â  ³
  ÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]
( Account );
end;

private macro TableRow( Number, Dockind, Date, FICode, Amount, Account2, BankName, BankBIC, Comment )

  array DocKindArray, CommentArray;
  var j = 0;

  StrSplit( StrSubst(IfThenElse(DocKind!="",DocKind," ") , "|", " " ), DocKindArray, 20 );
  StrSplit( StrSubst(IfThenElse(Comment!="",Comment," ") , "|", " " ), CommentArray, 50 );

[ #######³ ####################³########## ³######³###############³#####################³########################³############³##################################################]
  ( Number, DockindArray(j), Date, FICode, Amount, Account2, BankName, BankBIC, CommentArray(j) );
  j = j +1;
  while ( ( StrLen( DocKindArray(j) ) > 0 ) or ( StrLen( CommentArray(j) ) > 0 ) )
[        ³ ####################³           ³      ³               ³                     ³                        ³            ³##################################################]
  ( IfThenElse( StrLen(DocKindArray(j)) > 0 ,DocKindArray(j)," " ), IfThenElse( StrLen(CommentArray(j)) > 0, CommentArray(j), "" ) );
    j = j + 1;
  end;
end;

private macro TableFooter()  

[ ÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
end;

macro PrintOpenPaymsForAccount( Account:string )

  TableHeader( Account:string );
  var Comment:string = "";
  var selectPayment : String;
  var paramsPayment : TArray;
  
  
  GetPaymentsSelect(@selectPayment, @paramsPayment, Account, -1);  //®«ãç¥­¨¥ § ¯à®á  ¢ë¡®àª¨ ¯« â¥¦¥© ¤«ï áç¥â 
  
  var select = " select pm.t_PaymentID, pm.t_PaymStatus, rm.t_Number, opr.t_Name,        " +
            "           rm.t_Date, fi.t_FI_Code,                                         " +
            " case when pm.t_FIID = req.t_Code_Currency then pm.t_Amount                 " +
            "      else pm.t_PayFIID end,                                                " +
            " case when pm.t_PayerAccount = :Account1 then pm.t_ReceiverAccount          " +
            "      else pm.t_PayerAccount end,                                           " +
            " case when pm.t_PayerAccount = :Account3 then rm.t_ReceiverBankName         " +
            "      else rm.t_PayerBankName end,                                          " +
            " case when pm.t_PayerAccount = :Account2 then cr.t_BankCode                 " +
            "      else db.t_BankCode end,                                               " +
            "   oprostep.t_Name                                                          " +
            "    from dpmprop_dbt db, dpmprop_dbt cr,                                    " +
            "         dreqclosa_dbt req, dpmrmprop_dbt rm, doprkdoc_dbt opr,             " +
            "         dfininstr_dbt fi, doproper_dbt oproper, doprstep_dbt oprstep,      " +
            "         doprostep_dbt oprostep,                                            " +
                      selectPayment + " pm                                               " +
            " where                                                                      " +
            "       db.t_PaymentID = pm.t_PaymentID                                      " +
            "   and db.t_DebetCredit = 0                                                 " +
            "   and cr.t_PaymentID = pm.t_PaymentID                                      " +
            "   and cr.t_DebetCredit = 1                                                 " +
            "   and rm.t_PaymentID = pm.t_PaymentID                                      " +
            "   and pm.t_DocKind = opr.t_DocKind                                         " +
            "   and oproper.t_DocKind = decode(pm.t_PrimDocKind, 0,                      " +
            " decode(pm.t_DocKind, :WL_WIPM, :WL_INDOC, pm.t_DocKind), pm.t_PrimDocKind) " +
            "   and oproper.t_DocumentID = LPAD(pm.t_PaymentID, 34, '0')                 " +
            "   and oprstep.t_ID_Operation = oproper.t_ID_Operation                      " +
            "   and oprstep.t_IsExecute = 'R'                                            " +
            "   and oprostep.t_BlockID = oprstep.t_BlockID                               " +     
            "   and oprostep.t_Number_Step = oprstep.t_Number_Step                       " +
            "   and req.t_Account = :Account6                                            " +
            "   and ( ( pm.t_FIID = req.t_Code_Currency                                  " +
            "       and fi.t_FIID = pm.t_FIID )                                          " +
            "      or ( pm.t_FIID <>  req.t_Code_Currency                                " +
            "       and fi.t_FIID = pm.t_PayFIID  ))                                     ";
  
  var params:TArray = makeArray( SQLParam( ":Account1", Account ), 
                                 SQLParam( ":Account2", Account ),
                                 SQLParam( ":Account3", Account )
                                );
  
  var parmValue;                              
  for(parmValue, paramsPayment)
    params[params.size] = parmValue;
  end;
                                 
  params[params.size] = SQLParam( ":WL_WIPM", WL_WIPM );
  params[params.size] = SQLParam( ":WL_INDOC", WL_INDOC );
  params[params.size] = SQLParam( ":Account6", Account ); 
                                
           
  var rs = execSQLselect( select, params, FALSE );
  while( rs.MoveNext() ) 

    Comment = "„®ªã¬¥­â ­ å®¤¨âáï ¢ ";
    if( rs.Value(1) == 0 ) 
      Comment = Comment + "®â«®¦¥­­ëå";
    elif( rs.Value(1) == 2000 )
      Comment = Comment +  "Š àâ®â¥ª¥ ü2";
    elif( rs.Value(1) == 2100 )
      Comment = Comment + "®¦¨¤ îé¨å à §à¥è¥­¨ï";
    else
      var select_i1 = "select t_CurrentState from dpspayord_dbt " +
                      " where t_OrderID = " + rs.Value(0);
      var rs_i1 = execSQLselect( select_i1, null, FALSE );
      if( rs_i1.MoveNext() and ( rs_i1.Value(0) == 3 ) )
        Comment = Comment + "Š àâ®â¥ª¥ ü1";
      else
        Comment = "„®ªã¬¥­â £®â®¢ ª ¢ë¯®«­¥­¨î è £ : " + rs.Value(10);
      end;
    end;
    
    TableRow( rs.Value(2), rs.Value(3), date(rs.Value(4)), rs.Value(5), rs.Value(6), rs.Value(7), rs.Value(8), rs.Value(9), Comment );
  end;

  TableFooter();
end;