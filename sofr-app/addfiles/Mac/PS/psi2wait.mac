//-----------------------------------------------------------------------------
// Блок     : 29020 - "Картотека 2"
// Шаг      : 20    - "Ожидание в картотеке №2"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import pm_setst, PaymInter, payinter, catfdoc, cbsttls, pm_common;

var PaymentObj:RsbPayment;

private macro ValueDateForWaitInK2(Paym : RsbPayment) : date
  var ValueDate : date = {curdate};
  var DocKind = Paym.PrimDocKind;

  if( GetParentOrEqualDocKindFromList(DocKind, PMDOC_CLIENTPAYMENT) )
    ValueDate = PM_GetOperDay_BankServiceBalance(Paym.Department);
  elif( GetParentOrEqualDocKindFromList(DocKind, DLDOC_BANKORDER) )
    ValueDate = PM_GetOperDay_Balance(Paym.Department);
  end;

  return ValueDate;
end;

// Выполнение шага
MACRO ExecuteStep( doc, payorder, DocKind:integer, ID_Operation:integer, ID_Step:integer  )
 
  if(IsArestDebetAcc(PaymentObj.PayerAccount, PaymentObj.PayerFIID))
    msgbox("На счет наложено ограничение операций");
    return 1;
  end;

  if(CheckDateStartOpr(ID_Operation))
    return 1;
  end;

  PaymentObj.ValueDate = ValueDateForWaitInK2(PaymentObj);

  var choise = GetCachedVar( "PmIndex2Wait" + PaymentObj.PayerAccount + PaymentObj.PayerFIID );
  Array Text;
  Array Buttons;

  if( ValType( choise ) == V_UNDEF )

    if( CheckPmIWPPlaced_ByObj( PaymentObj, 0 ) )

      Text[0] = "К счету " + PaymentObj.PayerAccount + 
                " есть неоплаченные документы|в картотеке ожидания разрешений с более высоким приоритетом.|Продолжить?";
      Buttons[0] = "   Да  ";
      Buttons[1] = "  Нет  ";

      choise = ConfWin( Text, Buttons );
      if( IsOprMultiExec() )
        SetCachedVar( "PmIndex2Wait" + PaymentObj.PayerAccount + PaymentObj.PayerFIID, choise );
      end;
    end;
  end;
  if( choise == 1 ) /*Нет*/
    return 1;
  end;

  if( PaymentObj.I2PlaceDate > {curdate} )
    msgbox("Дата помещения документа в картотеку больше даты текущего операционного дня");
    return 1;
  end;

  // Определим счета в проводках
  var ВнебалСчетКартотеки2;

  // Объекты для КУ
  var FD_CorrAcc:NotBalCorrAcc_FirstDoc = NotBalCorrAcc_FirstDoc( "П" );

  // Счета КУ
  var СистемныйСчетДляКартотек:string = FD_CorrAcc.FindAndOpenSysAccount( "ВнебалСчетКорресп", 0, {curdate} );
  
  // Выполним проводку по внебалансу
  var paymtr:RsbAccTransaction = PaymentObj.MakeTransaction();

  // Установить статус платежа
  PaymentObj.PaymStatus = PM_READIED;

  // Установить статус первички
  PM_SetPrimDocumentState( PaymentObj, DOCUMENT_ST_WORKING );
  

  if( PaymentObj.StartDepartment != PaymentObj.EndDepartment )
    if( УстановитьСтатусыПлатежа( OPR_PAYM_CABS, OPR_PM_ST_MFR_NO ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return 1;
    end;
  end;

  PaymentObj.PlaceToIndex = "";
  if( GetAccount90902( PaymentObj.PayerAccount,
                       PaymentObj.PayerFIID,
                       PaymentObj.BaseFIID,
                       ВнебалСчетКартотеки2,  /* В случае успеха, сюда вернется номер "привязанного" счета */
                       PaymentObj.ValueDate ) )
    return 1;
  end;

  if( paymtr == NULL )
    MsgBox("Ошибка при создании проводки по платежу");
    return 1;
  end;

  // Устанавливаем даты
  PaymentObj.OutTransferDate = PmGetDefaultOutTransferDate( PaymentObj ); 
 
  // Установить дату начала операции равной дате операционного дня пользователя
  SetOprDate(29000000, PaymentObj.ValueDate);
 
  paymtr.Chapter         = 3;
  paymtr.Date_Carry      = PaymentObj.ValueDate;
  paymtr.Number_Pack     = PaymentObj.NumberPack;
  paymtr.Numb_Document   = PaymentObj.Number;
  paymtr.ResultCarry     = OBI2CARRY;
  paymtr.Kind_Oper       = " 1";
  paymtr.Shifr_Oper      = "09";
  paymtr.Department      = PaymentObj.Department;
  paymtr.AccountPayer    = СистемныйСчетДляКартотек;
  paymtr.AccountReceiver = ВнебалСчетКартотеки2;
  paymtr.FIIDPayer       = NATCUR; 
  paymtr.FIIDReceiver    = PaymentObj.BaseFIID;
  
  paymtr.SumReceiver     = PaymentObj.FutureBaseAmount;
  if( ConvSum( paymtr.SumPayer, PaymentObj.FutureBaseAmount, PaymentObj.ValueDate, PaymentObj.BaseFIID, NATCUR ) )
    msgbox("Ошибка конвертации суммы");
    return 1;
  end;

  paymtr.Ground          = "Снятие с Картотеки 2 суммы " + PaymentObj.FuturePayerAmount +
                           " по документу № "            + string(PaymentObj.Number) +
                           " от "                        + string(PaymentObj.Date)   +
                           " к счету "                   + string(PaymentObj.PayerAccount);

  if( not paymtr.Carry )
    MsgBox("Ошибка при актуализации платежа");
    return 1;
  end;
  
  /*if( PaymentObj.MakeReserve( PaymentObj.PayerAccount, CHAPT1, PaymentObj.PayerFIID, PaymentObj.FuturePayerAmount ) != 0 )
    msgbox( "Ошибка при формировании претензии к счету " + PaymentObj.PayerAccount );
    return 1;
  end;*/

  if( УстановитьСтатусыПлатежа( OPR_PAYM_CONTROL, OPR_PAYM_ST_CTRL_NOTCONTROL ) )
    msgbox("Ошибка при установке сегментов статуса экземпляра операции");
    return 1;
  end;

  PaymentObj.CheckTerror = CHT_NOTCHECK;

  return 0;

END;
