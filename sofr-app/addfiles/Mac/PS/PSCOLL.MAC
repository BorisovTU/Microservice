/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : pscoll.mac                                       */
/*                                                                      */
/*  Описание         : Выполнение шага по                               */
/*                     списанию средств с клиентского счета             */
/*                     на транзитный                                    */
/*  Программист      : Зайцев А.В.                                      */
/*                                                                      */
/*  Создан           : 15.02.99                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import  InsCarryDoc, OprInter, FIInter, payconst, PaymInter, PTInter, "pmoutcom.mac", "cbctuncs.mac", paym_rec;
import  pmpurp;

RECORD  d(arhdoc);


/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder, Kind, ID_Operation )
/*  var SumPaym = $0, SumDoc = $0, PaySumPaym = $0, PaySumDoc = $0, TransferDate, Account_Receiver; 
  var UnclAcc;
  RECORD  ord(pspayord);

  setbuff(ord,payorder);
  setbuff(d,doc);

  /*Проверяем ДПП платежа*/
  if ( Pm_credit.DebetCredit==0 )
     if ( PaymOutChangeDPP(Pm_paym, Pm_credit, NULL, 0, TransferDate )==false )
        return 1;
     end;
  else
     if ( PaymOutChangeDPP(Pm_paym, NULL, Pm_credit, 0, TransferDate )==false )
        return 1;
     end;
  end;

  /*                     Для начала разберемся с комиссиями                */
  if ( ExecuteSingCommission( ID_Operation, ord, Kind, Pm_paym, Pm_credit,
                        OUR, BEN, PaySumPaym, PaySumDoc, SumPaym, SumDoc) )
     return 1;
  end;  


  /* Претензии */
  if( Pm_paym.IsPurpose == "X" )
    if( Pm_paym.ClaimID == 0 )
      if( InsertAcClaim_Macro( Pm_rmprop.Number, Pm_paym.ValueDate, Pm_paym.ReceiverAccount, Pm_paym.FuturePayerAmount ) )
        msgbox("Ошибка при вставке претензии");
        return 1;
      end;
    else
      if( InsertAcClaimChange_Macro( Pm_paym.ClaimID, Pm_rmprop.Number, Pm_paym.ValueDate, Pm_paym.FuturePayerAmount ) )
        msgbox("Ошибка при изменении претензии");
        return 1;
      end;
    end;
  end;

  /* Списание на транзитный делаем только для внешних платежей */
  if( (Pm_credit.PaymentID != Pm_paym.PaymentID) or (Pm_credit.Group != PAYMENTS_GROUP_EXTERNAL) )
   return 0;
  end;
  

 /*****************************************************
 Списание с клиентского счета на транзитный
 *****************************************************/  
  
  if ( TransferDate>{curdate} )
     Pm_credit.TransferDate = TransferDate;
     UnclAcc = OutPaymentAccUnclosed(Pm_paym, Pm_credit);
     Account_Receiver = UnclAcc.FindAndOpenAccount();
  else
     Account_Receiver = Pm_paym.FutureReceiverAccount;
  end;

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок МФР в проведенные");
    return 1;
  end;

  ClearRecord(d);

  d.Chapter = 1;
  d.Date_Carry = Pm_paym.ValueDate;
  d.Account_Receiver = Account_Receiver;

  if(d.Account_Receiver == "")
    msgbox("В схеме расчетов не задан счет \"Средства клиентов по незавершенным расчетам\"");
    return 1;
  end;

  /*d.Account_Payer = Pm_paym.PayerAccount;*/
  d.Account_Payer = Pm_paym.FuturePayerAccount;
  d.Sum           = PaySumDoc;
  d.Ground        = Pm_rmprop.Ground;
  d.Numb_Document = Pm_rmprop.Number;
  d.Department    = Pm_paym.Department;
  d.Number_Pack   = Pm_paym.NumberPack;
  d.Shifr_Oper    = Pm_rmprop.ShifrOper;
  d.Result_Carry  = 1;
  d.Kind_Oper     = " 1";

  /* Присваиваем признак "Неотложные нужды" */
  if(IsUrgentPayOrder(ord) == 1) d.TypeDocument = d.TypeDocument + "Н"; end;

  if( not InsertRubDocument(NULL,PMMET_DPS, 0, 0, Pm_paym.Purpose, Pm_paym.SubPurpose ) )
     msgbox("Ошибка при вставке рублевого документа");
     return 1;
  end;
  

  if( not PM_IsInternalPayerAccount( Pm_paym ) )

    /* Изменяем дату списания со счета плательщика */
    if( not InsertPayerChargeOffDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты списания со счета плательщика");
      return 1;
    end;

    /* Изменяем дату отметки банка плательщика */
    if( not InsertPayerBankMarkDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты отметки банка плательщика");
      return 1;
    end;

  end;

  /*****************************************************
  Здесь можно вставлять дополнительные проводки для шага
  *****************************************************/
  */
  return 0;

END;
