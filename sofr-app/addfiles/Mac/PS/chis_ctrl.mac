/* ╔══════════════════════════════════════════════════════════════════╗ */
/* ║        Автоматизированная банковская система RS-Bank v5.0        ║ */
/* ║                Copyright (c) R-Style Software Lab 1998           ║ */
/* ║                                                                  ║ */
/* ║ Имя файла    : chiss_categ.mac                                   ║ */
/* ║                                                                  ║ */
/* ║ Описание     : Шаг "Контроль" заяв. на выд. цен. бл.             ║ */
/* ║                                                                  ║ */
/* ║                                                                  ║ */
/* ║ Программист  : Локтюшин В.Ю.                                     ║ */
/* ║                                                                  ║ */
/* ║ Создан       : 14.09.2006                                        ║ */
/* ║                                                                 ║ */
/* ╚══════════════════════════════════════════════════════════════════╝ */

import PSInter, PSInter, psbccomn, cbsttls, PTInter, chisfun;

var CheckIssObj:RsbCheckIss;

MACRO ExecuteStep( doc, paymDoc )
  var note_text:string = "";

  if( PM_NeedRejectControl() == true )

    note_text = "Документ отвергнут контролером";

    // Установить статус заяв.
    CheckIssObj.CurrentState = CHECKISS_ST_REJECTED;

     // Заполнить статусы сегментов операции
     if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_REJECTED ) )
       msgbox("Ошибка при установке сегментов статуса экземпляра операции");
       return -1;
     end;

     // Заполнить примечание
     if( InsertNoteForCheckIss( CheckIssObj.OrderID, CHECKISS_NOTES_CAUSE_OF_FAILUR, note_text ) != 0 )
       msgbox( "Ошибка при вставке примечания заявления" );
       return -1;
     end;

  else
    
    note_text = ReadNoteForCheckIss( CheckIssObj.OrderID );

    if( note_text != "" )
      if( InsertNoteForCheckIss( CheckIssObj.OrderID,CHECKISS_NOTES_CAUSE_OF_FAILUR, "" ) != 0 )
       msgbox( "Ошибка при очистки примечания заявления" );
       return -1;
     end;
    end;

     if( not InsertOprStatus( CHECKISS_KIND_ST_KNTR, CHECKISS_ST_KNTR_CONTROL ) )
       msgbox("Ошибка при установке сегментов статуса экземпляра операции");
       return -1;
     end;

  end;

  return 0;
END;