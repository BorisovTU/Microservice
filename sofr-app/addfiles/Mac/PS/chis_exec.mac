/* ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ» */
/* º        €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank v5.0        º */
/* º                Copyright (c) R-Style Software Lab 1998           º */
/* º                                                                  º */
/* º ˆ¬ï ä ©«     : chiss_categ.mac                                   º */
/* º                                                                  º */
/* º Ž¯¨á ­¨¥     : ˜ £ "Žä®à¬«¥­¨¥ ¢ë¤ ç¨"                           º */
/* º                     § ï¢. ­  ¢ë¤. æ¥­. ¡«.                       º */
/* º                                                                  º */
/* º                                                                  º */
/* º à®£à ¬¬¨áâ  : ‹®ªâîè¨­ ‚.ž.                                     º */
/* º                                                                  º */
/* º ‘®§¤ ­       : 14.09.2006                                        º */
/* º                                                                 º */
/* ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼ */


import PSInter, chis_categ, chisfun, payinter, pm_categ;

var CheckIssObj:RsbCheckIss;

const REGPATH_DISCARDMETOD:string = "PS\\CHECKISS\\DISCARDMETHOD",
      DISCARD_CHECK_IMMEDIATE:integer = 0,
      DISCARD_CHECK_MANUALLY :integer = 1;

/* ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ» */
/* º        ‚ë¯®«­¥­¨¥ è £           º */
/* ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼ */
MACRO ExecuteStep( doc, paymDoc, DocKind:integer, ID_Operation:integer, ID_Step:integer )
  var Error:string = "", OperAccept:integer = 0;

  var AcceptDate = GetAcceptDate( ID_Operation, @OperAccept );
  var ZeroDate   = Date( 0, 0, 0 );
  var DiscardMethod:integer = DISCARD_CHECK_IMMEDIATE,
      RegError     :integer = 0;

  GetRegistryValue( REGPATH_DISCARDMETOD, V_INTEGER, DiscardMethod, RegError );
  
  if( AcceptDate > ZeroDate )
    if( AcceptDate < {curdate} )
      Error = "„®ªã¬¥­â ¤®«¦¥­ ¡ëâì  ªæ¥¯â®¢ ­ ¨ ¢ë¤ ­ ¢ â¥ç¥­¨¨ ®¤­®£® ®¯¥à æ¨®­­®£® ¤­ï";
      msgbox( Error );
      // ‡ ¯®«­¨âì ¯à¨¬¥ç ­¨¥
      if( InsertNoteForCheckIss( CheckIssObj.OrderID,CHECKISS_NOTES_CAUSE_OF_FAILUR ,Error ) != 0 )
        msgbox( "Žè¨¡ª  ¯à¨ ¢áâ ¢ª¥ ¯à¨¬¥ç ­¨ï ¯« â¥¦ " );
        return -1;
      end;

      CheckIssObj.CurrentState = CHECKISS_ST_REJECTED;
  
      // ‡ ¯®«­¨âì áâ âãáë á¥£¬¥­â®¢ ®¯¥à æ¨¨
      if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_REJECTED ) )
        msgbox("Žè¨¡ª  ¯à¨ ãáâ ­®¢ª¥ á¥£¬¥­â®¢ áâ âãá  íª§¥¬¯«ïà  ®¯¥à æ¨¨");
        return -1;
      end;
      return ChissDelAccept( ID_Operation, ID_Step );
    end;
  else
    AcceptDate = {curdate};
    OperAccept = {oper};
  end;

  CheckIssObj.ValueDate = AcceptDate;
  CheckIssObj.Cashier   = OperAccept;

  /** à®¢®¤ª  á¯¨á ­¨ï ç¥ª®¢®© ª­¨èª¨ ¤¥« ¥âáï â®«ìª® ¯® ­ áâà®©ª¥ */
  if( DiscardMethod == DISCARD_CHECK_IMMEDIATE )
    var FD:CheckissFirstDoc = CheckissFirstDoc( CheckIssObj.OrderID );
    var ‚­¥¡ «‘ç¥â“ç¥â ‚ë¤ ­­ëåŠ­¨¦¥ª:string = FD.FindSysAccount( "‘ç¥â« ­ªŽä®à¬", 0 );
    var FD_CorrAcc:NotBalCorrAcc_FirstDoc = NotBalCorrAcc_FirstDoc( "" );
    var ‘¨áâ¥¬­ë©‘ç¥âŠ®àà¥á¯®­¤¥­æ¨¨—¥ª®¢ëåŠ­¨¦¥ª:string = FD_CorrAcc.FindAndOpenSysCurAccount( "‚­¥¡ «‘ç¥âŠ®àà¥á¯", 0, {curdate}, FD.CalcFIID );
    if( strlen(‚­¥¡ «‘ç¥â“ç¥â ‚ë¤ ­­ëåŠ­¨¦¥ª) == 0 )
      msgbox("¥ § ¤ ­ ¢­¥¡ « ­á®¢ë© áç¥â|ãç¥â  ®ä®à¬«¥­­ëå ç¥ª®¢ëå ª­¨¦¥ª");
      return 1;
    end;

    var acctrn:object     = RsbAccTransaction();
    if( acctrn == NULL )
      MsgBox("Žè¨¡ª  ¯à¨ á®§¤ ­¨¨ ¯à®¢®¤ª¨ ¯® ¯« â¥¦ã");
      return 1;
    end;
    acctrn.Chapter         = 3;                                            
    acctrn.FIID            = FD.CalcFIID;
    acctrn.AccountPayer    = ‘¨áâ¥¬­ë©‘ç¥âŠ®àà¥á¯®­¤¥­æ¨¨—¥ª®¢ëåŠ­¨¦¥ª;
    acctrn.AccountReceiver = ‚­¥¡ «‘ç¥â“ç¥â ‚ë¤ ­­ëåŠ­¨¦¥ª;
    acctrn.Sum             = FD.BooksAmount;
    acctrn.Ground          = "Žä®à¬«¥­­ ï ç¥ª®¢ ï ª­¨¦ª  ª áç¥âã " + string(FD.Account) + 
                             " " + GetClientName( FD.Account ) + 
                             " ¢ë¤ ­ .";
    if( not acctrn.Carry() )
      MsgBox("Žè¨¡ª  ¯à¨ ¢ë¯®«­¥­¨¨ ¯à®¢®¤ª¨");
      return 1;
    end;  
  end;

  CheckIssObj.CurrentState = CHECKISS_ST_CLOSED;

  // ‡ ¯®«­¨âì áâ âãáë á¥£¬¥­â®¢ ®¯¥à æ¨¨
  if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_CLOSED ) )
    msgbox("Žè¨¡ª  ¯à¨ ãáâ ­®¢ª¥ á¥£¬¥­â®¢ áâ âãá  íª§¥¬¯«ïà  ®¯¥à æ¨¨");
    return -1;
  end;

  return 0;

END;
