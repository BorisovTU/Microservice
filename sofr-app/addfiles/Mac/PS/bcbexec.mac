/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 2001              */
/*                                                                      */
/*  Имя файла        : bccoll.mac                                       */
/*                                                                      */
/*  Описание         : Выполнение шага по покупке валюты                */
/*                                                                      */
/*  Операция         : Покупка валюты                                    */
/*                                                                       */
/*  Программист      : Бурак В.Ю.                                       */
/*                                                                      */
/*  Создан           : 21.05.2001                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, payinter, "bcall.mac";
import "bc_categ.mac";
/*
private record  d(arhdoc);
record  mc(multycar);
  */
record  PartBCexe (ps_bcexe); /*Параметры исполнения*/

/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, ps_bcord )
/*
   record bc      (ps_bcord);
   record object  (account );
   record fiobject(fininstr);
   record attr    (account );
   var err;

   setbuff( bc, ps_bcord );

   setbuff( d, doc );

   // Счета курсовых разниц идут в рублях
   var FD:PSBC_FirstDoc = PSBC_FirstDoc( bc, 0 );

   object.Code_Currency = bc.RequiredFIID;
   object.Chapter = 1;
   object.Account = bc.CurrentAccount;

   if( bc.MarketPlace == PTID_UNKNOWNPARTY ) /* операция в банке */

      if( bc.ValueDate != bc.OrderDate )     /* снятие сделки с в/б */

          /* 2.2.1. - 2.2.3 */
          SetBuff( mc, doc );
          ClearRecord( mc );
          mc.MethodID = 1;

          mc.FIID_From   = bc.RequiredFIID;
          mc.FIID_To     = bc.SourceFIID;

          mc.Amount_From = PartBCexe.SatisfiedAmount;
          mc.Amount_To   = PartBCexe.UsedAmount;

          if( Клиент_Резидент( bc.ClientID ) )
             if(not GetLinkedObject( OBJROLE_ACC_ORDERBCDELIV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
               mc.Account_From = attr.Account;  /* Нашли настройку */
             else /* Не найден связанный счет */
               mc.Account_From = "";
             end;

             if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCDELIVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
               mc.Account_To = attr.Account;  /* Нашли настройку */
             else /* Не найден связанный счет */
               mc.Account_To = "";
             end;
          else 
             if(not GetLinkedObject( OBJROLE_ACC_ORDERBCDELIVNR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
               mc.Account_From = attr.Account;  /* Нашли настройку */
             else /* Не найден связанный счет */
               mc.Account_From = "";
             end;

             if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCDELIVNRNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
               mc.Account_To = attr.Account;  /* Нашли настройку */
             else /* Не найден связанный счет */
               mc.Account_To = "";
             end;
          end;

          //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыДоходВБ , V_STRING, mc.Account1, err );
          //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыРасходВБ, V_STRING, mc.Account2, err );

          mc.Account1 = FD.FindAndOpenAccount( "+Форвард, маржа", 0, {curdate} );
          mc.Account2 = FD.FindAndOpenAccount( "-Форвард, маржа", 0, {curdate} );

          mc.Chapter       = 4;
          mc.Ground        = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +  
                           " Ликвидация требований/обязательств по сделке";
          mc.Numb_Document = PartBCexe.DealNumber;;
          mc.Date          = PartBCexe.ExecDate;
          mc.Date_Document = bc.OrderDate;
          mc.Number_Pack   = bc.NumberPack;
          mc.Department    = bc.Department;
          mc.ShifrOper     = "09";

          if( not InsertMultiCarry() )
            MsgBox( "Ошибка при вставке мультивалютного документа (снятие сделки с внебаланса)" );
            return 1; 
          end;
      end;         /* снятие сделки с в/б */

      /* 1.1 - 1.3  (2.3.1 - 2.3.3) */
      SetBuff( mc, doc );
      ClearRecord( mc );
      mc.MethodID = 1;
 
      mc.FIID_From    = bc.SourceFIID;
      mc.FIID_To      = bc.RequiredFIID;

      mc.Amount_From  = PartBCexe.UsedAmount;
      mc.Amount_To    = PartBCexe.SatisfiedAmount;

      if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCCONVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        mc.Account_From = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        mc.Account_From = "";
      end;

      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCCONV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        mc.Account_To = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        mc.Account_To = "";
      end;

      mc.Chapter       = 1;
      mc.Ground        = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +  
                       " Формирование требований/обязательств";
      mc.Numb_Document = PartBCexe.DealNumber;;
      mc.Date          = PartBCexe.ExecDate;
      mc.Date_Document = bc.OrderDate;
      mc.Number_Pack   = bc.NumberPack;
      mc.Department    = bc.Department;
      mc.ShifrOper     = "09";

      //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыДоход, V_STRING, mc.Account1, err );
      //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыРасход, V_STRING, mc.Account2, err );

      mc.Account1 = FD.FindAndOpenAccount( "+БМаржаП,ср-ва в ин.вал.", 0, {curdate} );
      mc.Account2 = FD.FindAndOpenAccount( "-БМаржаП,ср-ва в ин.вал.", 0, {curdate} );

      if( not InsertMultiCarry() )
        MsgBox( "Ошибка при вставке мультивалютного документа" );
        return 1; 
      end;

      /* 1.4 (2.3.4)*/

      ClearRecord(d);
  
      d.Chapter = 1;
  
      d.Date_Carry = PartBCexe.ExecDate;
   
      d.Account_Payer = bc.SourceAccount;
  
      if(not GetLinkedObject( OBJROLE_ACC_CLAIMBCCONVNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Receiver = "";
      end;
  
      d.Sum    = PartBCexe.UsedAmount;
      d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." + 
                       " Списание средств для покупки валюты";
  
      d.Numb_Document = PartBCexe.DealNumber;
      d.Department    = bc.Department;
      d.Number_Pack   = bc.NumberPack;
      d.Shifr_Oper    = "09";
   
      d.Result_Carry = 1;
      d.Kind_Oper = " 1";
  
      if( not InsertRubDocument( NULL ) )
         msgbox("Ошибка при вставке рублевого документа");
         return 1;
      end;

      /* 1.5 (2.3.5.) */

      ClearRecord(d);
      d.Chapter = 1;
  
      d.Date_Carry = PartBCexe.ExecDate;

      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCCONV, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Payer = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Payer = "";
      end;
  
      /*if(not GetLinkedObject( OBJROLE_ACC_SPECTRANSIT, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
         d.Account_Receiver = "";
      end; */
      d.Account_Receiver = bc.RequiredAccount;
 
      d.Sum    = PartBCexe.SatisfiedAmount;
      d.Code_Currency = bc.RequiredFIID;

      d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +  
                       " Зачисление купленной валюты";

      d.Numb_Document = PartBCexe.DealNumber;
      d.Department    = bc.Department;
      d.Number_Pack   = bc.NumberPack;
      d.Shifr_Oper    = "09";
   
      d.Result_Carry = 1;
      d.Kind_Oper = " 1";
  
      if( not InsertCurDocument( NULL ) )
         msgbox("Ошибка при вставке валютного документа");
         return 1;
      end;

   else            /* операция в банке -  операция на бирже*/

      /*  3.4. */
      ClearRecord(d);
      d.Chapter = 1;

      d.Date_Carry = PartBCexe.ExecDate;

      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Payer = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Payer = "";
      end;

      fiobject.FIID = 0;

      if(not GetLinkedObject( OBJROLE_CUR_MARKETACCCLAIM, OBJTYPE_CURRENCY, fiobject, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Receiver = "";
      end;

      d.Sum    = PartBCexe.UsedAmount;
      d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +  
                       " Перевод средств на счет расчетов с биржей";

      d.Numb_Document = PartBCexe.DealNumber;
      d.Department    = bc.Department;
      d.Number_Pack   = bc.NumberPack;
      d.Shifr_Oper    = "09";
   
      d.Result_Carry = 1;
      d.Kind_Oper = " 1";

      if( not InsertRubDocument( NULL ) )
         msgbox("Ошибка при вставке рублевого документа");
         return 1;
      end;
      

      /*  3.5. */

      ClearRecord(d);
      d.Chapter = 1;
  
      d.Date_Carry = PartBCexe.ExecDate;

      fiobject.FIID = bc.RequiredFIID;

      if(not GetLinkedObject( OBJROLE_CUR_MARKETACCORD, OBJTYPE_CURRENCY, fiobject, OBJTYPE_ACCOUNT, attr ))
        d.Account_Payer = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Payer = "";
      end;

      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Receiver = "";
      end;

      d.Sum    = PartBCexe.SatisfiedAmount;
      d.Code_Currency = bc.RequiredFIID;

      d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate +  "." +
                 " Формирование обязательств в валюте";
  
      d.Numb_Document = PartBCexe.DealNumber;
      d.Department    = bc.Department;
      d.Number_Pack   = bc.NumberPack;
      d.Shifr_Oper    = "09";
   
      d.Result_Carry = 1;
      d.Kind_Oper = " 1";
  
      if( not InsertCurDocument( NULL ) )
         msgbox("Ошибка при вставке Валютного документа");
         return 1;
      end;

      /*  3.6. */
      ClearRecord(d);
      d.Chapter = 1;
  
      d.Date_Carry = PartBCexe.ExecDate;

      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Payer = attr.Account;  /* Нашли настройку */
      else /* Не найден связанный счет */
        d.Account_Payer = "";
      end;

/*      if ( not ПолучитьСТВС_Клиента (bc.ClientID, bc.RequiredFIID, d.Account_Receiver))
         d.Account_Receiver = "";
      end;*/
      d.Account_Receiver = bc.RequiredAccount;

      d.Sum    = PartBCexe.SatisfiedAmount;
      d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." + 
                       " Зачисление купленной валюты";

      d.Code_Currency = bc.RequiredFIID;

      d.Numb_Document = PartBCexe.DealNumber;
      d.Department    = bc.Department;
      d.Number_Pack   = bc.NumberPack;
      d.Shifr_Oper    = "09";
   
      d.Result_Carry = 1;
      d.Kind_Oper = " 1";
  
      if( not InsertCurDocument( NULL ) )
         msgbox("Ошибка при вставке Валютного документа");
         return 1;
      end;

      /* 3.7. */

      if (bc.FullExecute)
         ClearRecord(d);
         d.Chapter = 1;

         d.Date_Carry = PartBCexe.ExecDate;

         d.Sum    = bc.SourceAmount - ПолучитьПредыдущиеРасходыЗадепонированныхСредств (bc.OrderID) - PartBCexe.UsedAmount; 

         if (d.Sum >= 0)
            if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
              d.Account_Payer = attr.Account;  /* Нашли настройку */
            else /* Не найден связанный счет */
              d.Account_Payer = "";
            end;

            d.Account_Receiver = bc.SourceAccount;

            d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." + 
                                " Возврат излишка задепонированных средств";
         else
            d.Account_Payer  = bc.SourceAccount;

            if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
              d.Account_Receiver = attr.Account;  /* Нашли настройку */
            else /* Не найден связанный счет */
              d.Account_Receiver = "";
            end;

            d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate +  "." +
                                " Дополнительное списание средств для покупки валюты";

            d.Sum = - d.Sum;
         end;

         d.Numb_Document = PartBCexe.DealNumber;
         d.Department    = bc.Department;
         d.Number_Pack   = bc.NumberPack;
         d.Shifr_Oper    = "09";
      
         d.Result_Carry = 1;
         d.Kind_Oper = " 1";

         if (d.Sum > 0)
            if( not InsertRubDocument( NULL ) )
               msgbox("Ошибка при вставке рублевого документа");
               return 1;
            end;
         end;

      end;

   end;            /* операция на бирже */
  */
   return 0;
end;
