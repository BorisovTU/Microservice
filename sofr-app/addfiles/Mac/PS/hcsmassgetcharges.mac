/*
$Name: hcsmassgetcharges.mac
$Module: РКО
$Description: Печать отчета группового запроса начислений
*/

/*import oralib, likepy, PaymInter, globals, "bnk_dirfile.mac", "bnk_dttmfrmt.mac",
       "bnk_common.mac";*/

import oralib, likepy, PaymInter, globals;

const   Ошибка   = 0,
        Первый   = 1,
        Последний= 2;

private const WLD_STATUS_TYPE_PMSENDANSWER:integer = 37;

RECORD pmreqcharge(pmreqcharge);

macro Печать_ОтчетСканирования(Вызов, firstdoc, Статус, Сообщение)

  if( Вызов==Первый )
    [
      Отчет о результатах получения ответов по запросам, направленным в ГИС ЖКХ
                                                                              
                                                                              
      Исполнитель    #####  #
      Дата отчета    #

    ]({oper}, {Name_Oper}, {curdate});

    [
      ┌──────────┬─────────────────────┬────────────────────────────────────┬──────────────────┬─────────────────┬──────────┬─────────────┬───────────────────────────────┬───────────────────────────────────────────────┐
      │          │                     │                                    │                  │                 │          │             │                               │                                               │
      │ID запроса│ ИНН/КПП потребителя │           ФИО потребителя          │ Идентификатор ПД │Идентификатор ЖКУ│   ЕЛС    │Период оплаты│   Результат получения ответа  │             Описание ошибки                   │
      │          │                     │                                    │                  │                 │          │             │                               │                                               │
    ]
  elif (Вызов==Ошибка)

  setbuff (pmreqcharge,firstdoc);

    var q : string = 
    " SELECT sd.t_ID AS ID, " +
    "        rq.t_PayerINN AS PayerINN, " +
    "        rq.t_PayerName1 || ' ' || rq.t_PayerName2 || ' ' || rq.t_PayerName3 " +
    "          AS PayerName, " +
    "        rq.t_HCSDocID AS ReqPaymentID, " +
    "        rq.t_ServiceID AS ReqServiceID, " +
    "        rq.t_HCSAccount AS ReqAcc, " +
    "        Replace( TO_CHAR (rq.t_Month) || '.' || TO_CHAR (rq.t_Year) , '0.0', chr(1)) AS ReqPeriod, " +
    "        wl.t_Name AS State, " +
    "        sd.t_Description AS ErrDescription " +
    "  FROM dpmreqcharge_dbt rq " +
    "      INNER JOIN dpmsend_dbt sd " +
    "           ON sd.t_ObjectID = rq.t_ID AND rq.t_ID = :ID AND sd.t_Action = :WLD_ACTION_PMSEND_QUERY " +
    "      INNER JOIN dwlstatus_dbt wl ON wl.t_TypeState = :WLD_STATUS_TYPE_PMSENDANSWER AND wl.t_State = sd.t_AnswerState; ";

    var params : TArray = makeArray( SQLParam("ID", pmreqcharge.ID), SQLParam("WLD_ACTION_PMSEND_QUERY", WLD_ACTION_PMSEND_QUERY), SQLParam("WLD_STATUS_TYPE_PMSENDANSWER ", WLD_STATUS_TYPE_PMSENDANSWER ) );
    var res = execSQLselect(q, params);

    if(res.moveNext())

      [ ├──────────┼─────────────────────┼────────────────────────────────────┼──────────────────┼─────────────────┼──────────┼─────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
        │##########│#####################│####################################│##################│#################│##########│#############│###############################│###############################################│
      ]
      ( res.value("ID"), 
        res.value("PayerINN"), 
        res.value("PayerName"),
        res.value("ReqPaymentID"),
        res.value("ReqServiceID"),
        res.value("ReqAcc"),
        res.value("ReqPeriod"),
        res.value("State"),
        StrSubst(IfThenElse(Сообщение == "", res.value("ErrDescription"), Сообщение), "|", " " ):w 
      );    
  end;
  elif (Вызов==Последний)
   [ └──────────┴─────────────────────┴────────────────────────────────────┴──────────────────┴─────────────────┴──────────┴─────────────┴───────────────────────────────┴───────────────────────────────────────────────┘     
   ]

  end;
end;
