//-----------------------------------------------------------------------------
// Блок     : "Депонирование п/п/к"
// Шаг      : "Депонирование"
// Описание : Макрос шага
//-----------------------------------------------------------------------------
import PaymInter, BankInter, PSInter, bc_categ, OprInter, psbccomn, pm_opr, pm_common, pm_tools;

var PaymentObj:RsbPayment;

//-----------------------------------------------------------------------------
// Создать мемордер
//-----------------------------------------------------------------------------
PRIVATE MACRO CreateMemorial( buyorder:object, ReceiverAccount:string )

  var Memorial:object = GenObject("RsbMemorialOrder", 0 );
  var Payment:RsbMOPayment = Memorial.Payment();
  var SkipArest, Status;

  Memorial.State             = 0;/*CB_DOC_STATE_DEFERRED*/;
  Memorial.Oper              = {oper};
  Memorial.Chapter           = 1;
  Memorial.Code_Currency     = PaymentObj.PayerFIID;

  Memorial.Kind_Oper         = " 4";
  Memorial.Origin            = CB_DOC_ORIGIN_MANUAL;

  Payment.ClientDate         =
  Payment.Date               =
  Payment.PayerBankEnterDate =
  Payment.ValueDate          = {curdate};
                       
  Payment.DocKind            = DLDOC_MEMORIALORDER;
  Payment.Purpose            = PM_PURP_MEMORDER;

  Payment.Number             = PaymentObj.Number;
  Payment.ShifrOper          = "09";

  Payment.PayerAmount        = PaymentObj.PayerAmount;
  Payment.PayerFIID          = 
  Payment.ReceiverFIID       = PaymentObj.PayerFIID;

  Payment.SetPayerPI( PAYMENTS_GROUP_UNDEF, 
                      PaymentObj.PayerBankID, 
                      PaymentObj.PayerBankCodeKind, 
                      PaymentObj.PayerBankCode, 
                      PaymentObj.PayerBankName,
                      PaymentObj.PayerBankCorrAcc,
                      PaymentObj.PayerFIID, 
                      1/*CHAPT1*/, 
                      PaymentObj.PayerAccount, 
                      PaymentObj.Payer, 
                      PaymentObj.PayerName, 
                      PaymentObj.PayerINN );

  Payment.SetReceiverPI( PAYMENTS_GROUP_UNDEF, 
                         {OurBank}, 
                         0, 
                         "", 
                         "",
                         "",
                         PaymentObj.PayerFIID, 
                         1/*CHAPT1*/, 
                         ReceiverAccount, 
                         0, 
                         "", 
                         "" );
                  
  Payment.Ground             = BC_KindOrderName(buyorder.BCOrdKind) + " № " + PaymentObj.Number + " от " + PaymentObj.Date + ". Депонирование средств.";
  
  // Заполнение кода вида валютной операции
  BC_SetVOCode( buyorder, Payment, PSBCACTION_DEPOSITION );

  // Установить мемориальному ордеру признак автозапуска операции.
  Memorial.LaunchOper = true;

  // Претензию резервирования поручения на п/п/к перепривязать к созданному мемориальному ордеру
  Payment.BindReserve( GetClaimID( PaymentObj, PaymentObj.PayerAccount, PaymentObj.Chapter, PaymentObj.PayerFIID ), 
                       PaymentObj.Number, true );

  if( PM_GetOprStatus( Payment.DocKind, Payment.DocumentID, OPR_PAYM_PERMISSION, @Status ) and
      (Status == OPR_PAYM_ST_PERMISSION_YES)
    )
    SkipArest = true;
  else
    SkipArest = false;
  end;

  Payment.CryptoAction( string("Автоматическое_формирование_платежей") );
END;

MACRO ExecuteStep( doc, paymDoc )

  var BuyOrder:object         = GenObject("RsbBuyCurrencyOrder", PaymentObj.DocumentID);
 
  var FD:BuyCurOrder_FirstDoc = BuyCurOrder_FirstDoc(PaymentObj.DocumentID);
  var СчетДепонКл:string      = FD.FindAndOpenAccount( "СчетДепонКл", 0, {curdate}, FIROLE_FICOM );
  
  CreateMemorial( BuyOrder, СчетДепонКл );

  PaymentObj.FuturePayerAccount = СчетДепонКл;

  return 0;
END;