/*
$Name:             pm067_10.mac
$Module:           Платежи
$Description:      Макрос шага
*/

//-----------------------------------------------------------------------------
// Блок      : 29067 - "Ожидание даты исполнения"
// Шаг       : 10    - "Помещение в очередь ожидающих исполнения"
//-----------------------------------------------------------------------------

import "globals.mac", PaymInter, "pm_categ.mac", FIInter;

var PaymentObj: RsbPayment;

// ----------------------------------------------------------------------------
// Выполнение шага
// ----------------------------------------------------------------------------
macro ExecuteStep( Kind_Operation, first, KindDoc, ID_Operation )
  // Выполнить проводку
  var paymtr = PaymentObj.MakeTransaction();

  if( paymtr == NULL )
    MsgBox("Ошибка при создании проводки по платежу");
    return 1;
  end;

  paymtr.Chapter         = 3;                                            
  paymtr.Date_Carry      = {curdate};
  paymtr.Number_Pack     = PaymentObj.NumberPack;
  paymtr.Numb_Document   = PaymentObj.Number;
  paymtr.ResultCarry     = OBIWEINCARRY;
  paymtr.Kind_Oper       = " 1";
  paymtr.Ground          = "Прием к исполнению распоряжения №" + PaymentObj.Number + " до наступления срока перевода " + PaymentObj.ValueDate + " к счету " + PaymentObj.PayerAccount + ".";
  paymtr.Department      = PaymentObj.Department;

  paymtr.FIIDPayer       = NATCUR; 
  paymtr.FIIDReceiver    = NATCUR;
  paymtr.AccountPayer    = TIndexWaitExec(PaymentObj).FindAndOpenSysAccount( "Ожид. Исполн.", 0, {curdate} );
  paymtr.AccountReceiver = NotBalCorrAcc_FirstDoc( "П" ).FindAndOpenSysAccount( "ВнебалСчетКорресп", 0, {curdate} );

  if( ConvSum( paymtr.SumPayer, PaymentObj.FutureBaseAmount, {curdate}, PaymentObj.BaseFIID, NATCUR ) )
    msgbox("Ошибка конвертации суммы");
    return 1;
  end;
  paymtr.SumReceiver     = paymtr.SumPayer;

  if( not paymtr.Carry )
    MsgBox("Ошибка при актуализации платежа");
    return 1;
  end;

  return 0;
end;