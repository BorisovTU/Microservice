/*----------------------------------------------------------------------*/
/*         Автоматизированная банковская система RS-Bank                */
/*              Copyright (c) R-Style Software Lab                      */
/*                                                                      */
/*  Имя файла        : psposend.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага по выгрузке рублевых платежей К2 */
/*                     в Ритейл                                         */
/*                                                                      */
/*  Программист      : Гайворонский Е.Г.                                */
/*                                                                      */
/*  Создан           : 10.02.05                                         */
/*                                                                      */
/*----------------------------------------------------------------------*/

import PaymInter, "lnpaym.mac";

RECORD  Pm_paym( pmpaym );        /* ─┐                                                     */
RECORD  Pm_prop( pmprop );        /*  ├─ параметры платежа по клиентской платежке */
RECORD  Pm_rmprop( pmrmprop );    /* ─┘                                                     */

RECORD  PrimPmpaym( pmpaym );     /* ─┐                                                     */
RECORD  PrimPmprop( pmprop );     /*  ├─ параметры основного платежа по клиентской платежке */
RECORD  PrimPmrmprop( pmrmprop ); /* ─┘                                                     */

RECORD  PartPmpaym( pmpaym );     /* ─┐                                                               */
RECORD  PartPmprop( pmprop );     /*  ├─ параметры платежного документа частичной оплаты картотеки №2 */
RECORD  PartPmrmprop( pmrmprop ); /* ─┘                                                               */

RECORD  Ps_akkr( psakkr );        /* аккредитив */

MACRO ExecuteStep( doc, payorder ):integer

  var payment:RsbPayment;

  if( PrimPmpaym.PaymentID ) // Частичная оплата
    payment = RsbPayment( PartPmpaym.PaymentID );
    /*
    else
    payment = RsbPayment( Pm_paym.PaymentID );
    end;
    */

    // Определяем бэк-офис - получатель платежа
    payment.ToBackOffice = "В";
    
    payment.ReplicationSession = 0;
    payment.ReplicationBO = "В";
    
    // Статус платежа меняем на "Готов к квитовке"
    payment.PaymStatus   = PM_KVITWAIT;

  end;  

  return 0;

END;

MACRO CheckStepAction( doc, primdoc, DocKind, ID_Operation )
  
  var payment:RsbPayment;

  if( PrimPmpaym.PaymentID ) // Частичная оплата
    payment = RsbPayment( PartPmpaym.PaymentID );

    if( payment.ReplicationSession != 0 )
      msgbox("Невозможно откатить шаг операции,|т.к. платеж обрабатывается в ПС " + LnFindType(payment.ReplicationBO) );
      return 1;
    end;
  end;

  return 0;
END;