/*----------------------------------------------------------------------*/
/*         Автоматизированная банковская система RS-Bank                */
/*              Copyright (c) R-Style Software Lab                      */
/*                                                                      */
/*  Имя файла        : ps2retail.mac                                    */
/*                                                                      */
/*  Описание         : Выполнение шага по выгрузке валютных платежей    */
/*                     в Retail                                         */
/*                                                                      */
/*  Программист      : Гайворонский Е.Г.                                */
/*                                                                      */
/*  Создан           : 08.02.06                                         */
/*                                                                      */
/*----------------------------------------------------------------------*/

import PaymInter, "lnpaym.mac";

RECORD PrimPmpaym( pmpaym );     /* ─┐                                                     */
RECORD PrimPmprop( pmprop );     /*  ├─ параметры платежа по клиентской платежке */
RECORD PrimPmrmprop( pmrmprop ); /* ─┘                                                     */

MACRO ExecuteStep( ):integer

  var CreditAccount:string;
  var payment:RsbPayment = RsbPayment( PrimPmpaym.PaymentID );

  // Определяем бэк-офис - получатель платежа
  payment.ToBackOffice = "В";
  
  payment.ReplicationSession = 0;
  payment.ReplicationBO = "В";

  // Статус платежа меняем на "Готов к квитовке"
  payment.PaymStatus   = PM_KVITWAIT;
  
  // Выполним плановую проводку
  /*
  if( GetTechAccountRetail(payment.ReceiverFIID, CreditAccount) )
    return 1;
  end;
    */
  var paymtr:RsbPaymTransaction = payment.MakeTransaction(CreditAccount);
  if( paymtr == NULL )
    MsgBox("Ошибка при создании проводки по платежу");
    return 1;
  end;

  paymtr.Chapter       = 1;                                            
  paymtr.Date_Carry    = payment.ValueDate;
  paymtr.Number_Pack   = payment.NumberPack;
  paymtr.Numb_Document = payment.Number;
  paymtr.ResultCarry   = 1;
  paymtr.Kind_Oper     = " 1";
  paymtr.Ground        = payment.Ground;
  paymtr.Status_After  = ACCTRN_STATUS_PLAN;

  if( not paymtr.Carry )
    MsgBox("Ошибка при актуализации платежа");
    return 1;
  end;  
    
  return 0;

END;

MACRO CheckStepAction( doc, primdoc, DocKind, ID_Operation )
  var payment:RsbPayment = RsbPayment( PrimPmpaym.PaymentID );
  
  if( payment.ReplicationSession != 0 )
    msgbox("Невозможно откатить шаг операции,|т.к. платеж обрабатывается в ПС " + LnFindType(payment.ReplicationBO) );
    return 1;
  end;

  return 0;
END;