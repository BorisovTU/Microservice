/*
$Name:             Prcspsio3352ux.mac
$Module:           ББ и РКО
$Description:      Печать объявления на взнос наличными 3352-У (xls)
*/

import prcs, "BnkTemplReport.mac";

 
class (BnkTemplReport)  Prcspsio3352uxReport( data : TCashOrderPrintData3352)

  var d = data;
  
  macro Create()
   
    array ArrayClient, ArrayPayerBankName, ArrayReceiverBankName, ArrayGround, ArrayReceiverName, ArraySum;
    StrSplit (d.Client, ArrayClient, 33, 16, 2);
    StrSplit(d.ReceiverName, ArrayReceiverName, 50, 22, 2);
    StrSplit(d.PayerBankName, ArrayPayerBankName, 60, 35, 2);
    StrSplit(d.ReceiverBankName, ArrayReceiverBankName, 60, 35, 2);
    StrSplit(d.Ground, ArrayGround, 73, 81, 2);

    StrSplit(d.SumRubString, ArraySum, 73, 50, 3);  
    if (ArraySum(1) == "")
      ArraySum(0) = AddStrSymbols(ArraySum(0), "", 50);
    end;
    ArraySum(1) = AddStrSymbols(ArraySum(1), d.SumNameRubString, 73);    
   
     //Заполнение отчета
     SetValues( "Number1", "Отрывной талон к объявлению на взнос наличными № " + d.Number,
                "Number2",d.Number,
                "DateStr", d.DateStr, 
                "Client1", ArrayClient(0),
                "Client2", ArrayClient(1),
                "PayerAccount", d.PayerAccount,
                "FICode", d.FICode,
                "AmountStr", d.AmountStr,
                "ReceiverName2", ArrayReceiverName(1),
                "PayerBankName1", ArrayPayerBankName(0),
                "PayerBankName2", ArrayPayerBankName(1),
                "ReceiverBankName1", ArrayReceiverBankName(0),
                "ReceiverBankName2", ArrayReceiverBankName(1),
                "BIC1", d.BIC1,
                "BIC2", d.BIC2,
                "ArraySum1", ArraySum(0),
                "ArraySum2", ArraySum(1),
                "ArrayKopSum2", d.SumKopString,
                "ArrayNameKopSum2", d.SumNameKopString,
                "Ground1", ArrayGround(0),
                "Ground2", ArrayGround(1)/*,
                "Worker1", "Бухгалтерский работник",
                "Worker2", "Кассовый работник"*/
              );

              
    if ( d.CreditList.value(1).Account == "")
      SetValues("ReceiverName2", ArrayReceiverName(1));
    end;

    var i = 0;
    var tableCreditList = RegisterTable("CreditList");
    tableCreditList.SetValueCell("ReceiverName1",  ArrayReceiverName(i));  
    tableCreditList.SetValueCell("CreditListAccount",  d.CreditList.value(i).Account);  
    tableCreditList.SetValueCell("CreditListFICode", d.CreditList.value(i).FICode);           
    tableCreditList.SetValueCell("CreditListAmount", d.CreditList.value(i).Amount);
    tableCreditList.AddStr();
    i = 1;
    while( (i < d.CreditList.size) and (d.CreditList.value(i).Account != "") )
      if (i == 1) 
        tableCreditList.SetValueCell("ReceiverName1",  ArrayReceiverName(i));  
      end;
      tableCreditList.SetValueCell("CreditListAccount",  d.CreditList.value(i).Account);  
      tableCreditList.SetValueCell("CreditListFICode", d.CreditList.value(i).FICode);           
      tableCreditList.SetValueCell("CreditListAmount", d.CreditList.value(i).Amount);
      tableCreditList.AddStr();
      i = i + 1;
    end;
    tableCreditList.EndTable();

    i = 0;
    var tableCreditList2 = RegisterTable("CreditList2");

    while( (i < d.CreditList2.size) and (d.CreditList2.value(i).Account != "") )
       
      if (i == 0) 
        tableCreditList2.SetValueCell("ReceiverINN",  d.ReceiverINN);  
      end;
    
      tableCreditList2.SetValueCell("CreditList2Account",  d.CreditList2.value(i).Account);  
      if ( i == (d.CreditList2.size - 1)) 
        tableCreditList2.SetValueCell("SymbolTitle", "в том числе по символам:");
      else
        tableCreditList2.SetValueCell("SymbolTitle", "");
      end;

      tableCreditList2.AddStr();
      i = i + 1;
    end;
    tableCreditList2.EndTable();
    
    
    SetValues("ArraySym", d.ArraySym.value(0),
              "ArraySym2", d.ArraySym.value(1),
              "ArraySym3", d.ArraySym.value(2),
              "ArrayPartSum", MakeMoneyStr3352(d.ArrayPartSum.value(0)),
              "ArrayPartSum2", MakeMoneyStr3352(d.ArrayPartSum.value(1)),
              "ArrayPartSum3", MakeMoneyStr3352(d.ArrayPartSum.value(2))
             );
    i = 3;
    var tableSymList = RegisterTable("SymList");
    while( (i < d.ArraySym.size) and (d.ArraySym.value(i) != "") )
      tableSymList.SetValueCell("ArraySym4",  d.ArraySym.value(i));  
      tableSymList.SetValueCell("ArrayPartSum4", MakeMoneyStr3352(d.ArrayPartSum.value(i)));           
      tableSymList.AddStr();
      i = i + 1;
    end;
    tableSymList.EndTable();

    SetSheetName(string(d.Number) + "_1");
    
    SheetChange(2);   

    StrSplit(d.SumRubString, ArraySum, 73, 85, 3);  
    if (ArraySum(1) == "")
      ArraySum(0) = AddStrSymbols(ArraySum(0), "", 85);
    end;
    ArraySum(1) = AddStrSymbols(ArraySum(1), d.SumNameRubString, 73);    
    

    SetValues(  "Number_Kvit",d.Number,
                "DateStr_Kvit", d.DateStr, 
                "Client1_Kvit", ArrayClient(0),
                "Client2_Kvit", ArrayClient(1),
                "ReceiverINN_Kvit",  d.ReceiverINN,
                "PayerBankName1_Kvit", ArrayPayerBankName(0),
                "PayerBankName2_Kvit", ArrayPayerBankName(1),
                "ReceiverBankName1_Kvit", ArrayReceiverBankName(0),
                "ReceiverBankName2_Kvit", ArrayReceiverBankName(1),
                "BIC1_Kvit", d.BIC1,
                "BIC2_Kvit", d.BIC2,
                "ArraySum1_Kvit", ArraySum(0),
                "ArraySum2_Kvit", ArraySum(1),
                "ArrayKopSum2_Kvit", d.SumKopString,
                "ArrayNameKopSum2_Kvit", d.SumNameKopString,
                "Ground1_Kvit", ArrayGround(0),
                "Ground2_Kvit", ArrayGround(1)/*,
                "Worker1_Kvit", "Бухгалтерский работник",
                "Worker2_Kvit", "Кассовый работник"*/
             );
             
    i = 0;
    var tableCreditList2_Kvit = RegisterTable("CreditList2_Kvit");

    while( (i < d.CreditList2.size) and (d.CreditList2.value(i).Account != "") )
      if (i == 0) 
        tableCreditList2_Kvit.SetValueCell("ReceiverName_Kvit",  d.ReceiverName);  
      end;
      tableCreditList2_Kvit.SetValueCell("CreditList2Account_Kvit",  d.CreditList2.value(i).Account);  
      tableCreditList2_Kvit.AddStr();
      i = i + 1;
    end;
    tableCreditList2_Kvit.EndTable();
             
    i = 0;
    var tableCreditList_Kvit = RegisterTable("CreditList_Kvit");
    tableCreditList_Kvit.SetValueCell("CreditListFICode_Kvit", d.CreditList.value(i).FICode);           
    tableCreditList_Kvit.SetValueCell("CreditListAmount_Kvit", d.CreditList.value(i).Amounts);
    tableCreditList_Kvit.AddStr();
    
    i = 1;
    while( (i < d.CreditList.size) and (d.CreditList.value(i).Account != "") )
      tableCreditList_Kvit.SetValueCell("CreditListFICode_Kvit", d.CreditList.value(i).FICode);           
      tableCreditList_Kvit.SetValueCell("CreditListAmount_Kvit", d.CreditList.value(i).Amounts);
      tableCreditList_Kvit.AddStr();
      i = i + 1;
    end;
    tableCreditList_Kvit.EndTable();

    StrSplit(d.SumRubString, ArraySum, 73, 50, 3);  
    if (ArraySum(1) == "")
      ArraySum(0) = AddStrSymbols(ArraySum(0), "", 50);
    end;
    ArraySum(1) = AddStrSymbols(ArraySum(1), d.SumNameRubString, 73);    
    
    SetValues(  "Number_Order",d.Number,
                "DateStr_Order", d.DateStr, 
                "PayerAccount_Order", d.PayerAccount,
                "FICode_Order", d.FICode,
                "AmountStr_Order", d.AmountStr,
                "Client1_Order", ArrayClient(0),
                "Client2_Order", ArrayClient(1),
                "PayerBankName1_Order", ArrayPayerBankName(0),
                "PayerBankName2_Order", ArrayPayerBankName(1),
                "ReceiverBankName1_Order", ArrayReceiverBankName(0),
                "ReceiverBankName2_Order", ArrayReceiverBankName(1),
                "BIC1_Order", d.BIC1,
                "BIC2_Order", d.BIC2,
                "ArraySum1_Order", ArraySum(0),
                "ArraySum2_Order", ArraySum(1),
                "ArrayKopSum2_Order", d.SumKopString,
                "ArrayNameKopSum2_Order", d.SumNameKopString,
                "ShifrOper", d.ShifrOper,
                "Ground1_Order", ArrayGround(0),
                "Ground2_Order", ArrayGround(1)/*,
                "Worker1_Order", "Бухгалтерский работник",
                "Worker2_Order", "Кассовый работник"*/
             );

    if ( d.CreditList.value(1).Account == "")
      SetValues("ReceiverName2_Order", ArrayReceiverName(1));
    end;
             
    i = 0;
    var tableCreditList_Order = RegisterTable("CreditList_Order");
    tableCreditList_Order.SetValueCell("ReceiverName1_Order",  ArrayReceiverName(i));  
    tableCreditList_Order.SetValueCell("CreditListAccount_Order",  d.CreditList.value(i).Account);  
    tableCreditList_Order.SetValueCell("CreditListFICode_Order", d.CreditList.value(i).FICode);           
    tableCreditList_Order.SetValueCell("CreditListAmount_Order", d.CreditList.value(i).Amount);
    tableCreditList_Order.AddStr();
    i = 1;
    while( (i < d.CreditList.size) and (d.CreditList.value(i).Account != "") )
      if (i == 1) 
        tableCreditList_Order.SetValueCell("ReceiverName1_Order",  ArrayReceiverName(i));  
      end;
      tableCreditList_Order.SetValueCell("CreditListAccount_Order",  d.CreditList.value(i).Account);  
      tableCreditList_Order.SetValueCell("CreditListFICode_Order", d.CreditList.value(i).FICode);           
      tableCreditList_Order.SetValueCell("CreditListAmount_Order", d.CreditList.value(i).Amount);
      tableCreditList_Order.AddStr();
      i = i + 1;
    end;
    tableCreditList_Order.EndTable();

    
    i = 0;
    var tableCreditList2_Order = RegisterTable("CreditList2_Order");

    while( (i < d.CreditList2.size) and (d.CreditList2.value(i).Account != "") )
     
      if (i == 0) 
        tableCreditList2_Order.SetValueCell("ReceiverINN_Order",  d.ReceiverINN);  
      end;
    
      tableCreditList2_Order.SetValueCell("CreditList2Account_Order",  d.CreditList2.value(i).Account);  
      if ( i == (d.CreditList2.size - 1)) 
        tableCreditList2_Order.SetValueCell("SymbolTitle_Order", "в том числе по символам:");
      else
        tableCreditList2_Order.SetValueCell("SymbolTitle_Order", "");
      end;

      tableCreditList2_Order.AddStr();
      i = i + 1;
    end;
    tableCreditList2_Order.EndTable();
    
    SetValues("ArraySym_Order", d.ArraySym.value(0),
              "ArraySym2_Order", d.ArraySym.value(1),
              "ArraySym3_Order", d.ArraySym.value(2),
              "ArrayPartSum_Order", MakeMoneyStr3352(d.ArrayPartSum.value(0)),
              "ArrayPartSum2_Order", MakeMoneyStr3352(d.ArrayPartSum.value(1)),
              "ArrayPartSum3_Order", MakeMoneyStr3352(d.ArrayPartSum.value(2))
             );
    var tableSymList_Order = RegisterTable("SymList_Order");
    i = 3;
    while( (i < d.ArraySym.size) and (d.ArraySym.value(i) != "") )
      tableSymList_Order.SetValueCell("ArraySym4_Order",  d.ArraySym.value(i));  
      tableSymList_Order.SetValueCell("ArrayPartSum4_Order", MakeMoneyStr3352(d.ArrayPartSum.value(i)));           
      tableSymList_Order.AddStr();
      i = i + 1;
    end;
    tableSymList_Order.EndTable();
    
    SetSheetName(string(d.Number) + "_2");
    
  end;
   
   initBnkTemplReport("IncCashOrder3352-U.xls");

end;

macro PrintDocument(ncopy:integer):bool

 var DocKind:integer = pr_pmpaym.rec.DocKind;
  var data : TCashOrderPrintData3352 = TCashOrderPrintData3352();
  
  if( DocKind != 410/*CASH_PS_INCORDER*/  )
    MsgBox("Данный вид документа не поддерживается макросом");
    return FALSE;
  end;
  data.Init( pr_pmpaym, pr_pmrmprop, pr_pscshdoc );
  
  return Prcspsio3352uxReport(data).Print();
end;