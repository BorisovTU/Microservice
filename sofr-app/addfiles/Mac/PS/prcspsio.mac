/************************************************************************/
/*         Автоматизированная банковская система RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2002              */
/*                                                                      */
/*  Имя файла      : prcspsio.mac                                       */
/*                                                                      */
/*  Описание       : Печать объявления на взнос наличными из РКО        */
/*                                                                      */
/*  Программист    : Смирнов С.В. SMR PRN                               */
/*                                                                      */
/*  Создан         : 09.10.02                                           */
/*                                                                      */
/************************************************************************/

import globals, FIInter, PTInter, prpm, prcs, "adress.mac";

/* Печать объявления на взнос наличными */
MACRO PrintDocumentCashOrder(ncopy:integer):bool

  array StringSumArray,     /*сумма прописью по строкам    */
        ReceiverNameArray,  /*получатель по строкам        */
        ReceiverBankArray,  /*банк получателя по строкам   */
        GroundArray,        /*назначение платежа по строкам*/
        ClientArray,        /*От кого                      */
        PartSumArray,       /*Суммы по символам            */
        SymArray;           /*Символы                      */

  var PayerAmount          : money,
      ReceiverAmount       : money = $0,
      PayerFICode          : string = "",
      ReceiverFICode       : string = "";

  var ReceiverINN        :string,
      ReceiverKPP        :string,
      ReceiverOKATO      :string;

      
  var DateStr = FillDateString();

  var CashSymbCount = 7;

  /*Валюта*/
  //var fi:TRecHandler = TRecHandler("fininstr.dbt", "bank.def");
  //ПолучитьФинИн(pr_pmpaym.rec.FIID, fi);

  PayerAmount = pr_pmpaym.rec.Amount;
  if((pr_pmpaym.rec.FIID > 0) or (pr_pmpaym.rec.PayFIID > 0))
    PayerFICode = GetFICodeCCY(pr_pmpaym.rec.FIID);
  end;

  if( pr_pmpaym.rec.FIID != pr_pmpaym.rec.PayFIID )
    ReceiverFICode = GetFICodeCCY(pr_pmpaym.rec.PayFIID);
    ReceiverAmount = pr_pmpaym.rec.PayAmount;
  end;


  FillReceiverInOrd( ReceiverNameArray, @ReceiverINN, @ReceiverKPP, @ReceiverOKATO );

  StrSplit( pr_pscshdoc.rec.FIOClient, ClientArray      ,  35, 28, 3 );
  StrSplit( pr_pmrmprop.rec.Ground   , GroundArray      ,  91, 91, 2 );
  StrSplit({Name_Bank}               , ReceiverBankArray,  61, 50, 2 );

  FillAmountStr( StringSumArray );
  
  FillCashSymbolsAndSum( PartSumArray, SymArray, SYMB_KIND_INCOME );

  while( ncopy > 0 )

    /*Объявление*/
    [   Объявление на взнос наличными
                                                                              ┌───────────────────┐
                                                                              │Код формы документа│
                                                                              │      по ОКУД      │
                                   ┌──────────┐                               ├───────────────────┤
                    Объявление  №  │ ######## │                               │      0402001      │
                                   └──────────┘                               └───────────────────┘
            #########################                                                            
                                                         ДЕБЕТ
                                            ┌─────────────────────────────┬───────────────────────┐
       От кого ############################ │ счет № #################### │ ###  ################ │
        ################################### └─────────────────────────────┤                       │
        ###################################              КРЕДИТ           │    Сумма цифрами      │
       ─────────────────────────────────────┬─────────────────────────────┤                       │
       Получатель ######################### │ счет № #################### │ ###  ################ │
        ################################### └─────────────────────────────┼───────────────────────┤
                        ИНН ############       КПП ############           │      в том числе      │
        р/счет N ####################          ОКАТО ############         │      по символам:     │
       ───────────────────────────────────────────────────────────────────┼──────┬────────────────┤                   
       Наименование банка-вносителя                                       │символ│     сумма      │
        ################################################## БИК ########## ├──────┼────────────────┤
        ################################################################# │ #### │ ############## │
       Наименование банка-получателя                                      │ #### │ ############## │
        ################################################## БИК ########## │ #### │ ############## │
        ################################################################# │ #### │ ############## │
       Сумма прописью                                                     │ #### │ ############## │
        ################################################################# │ #### │ ############## │]
        (pr_pmrmprop.rec.Number:c, 
         DateStr, 
         ClientArray(0), pr_pmpaym.rec.PayerAccount:l, PayerFICode, PayerAmount:r:f:z, 
         ClientArray(1), 
         ClientArray(2), 
         ReceiverNameArray(0), 
         pr_pmpaym.rec.ReceiverAccount:l, ReceiverFICode, ReceiverAmount:r:f:z, 
         ReceiverNameArray(1), 
         ReceiverINN, ReceiverKPP, 
         pr_pmpaym.rec.ReceiverAccount:l, ReceiverOKATO, 
         ReceiverBankArray(0), 
         {MFO_Bank}, 
         ReceiverBankArray(1), SymArray(0):c, PartSumArray(0):c, 
         SymArray(1):c, PartSumArray(1):c, 
         ReceiverBankArray(0), {MFO_Bank}, SymArray(2):c, PartSumArray(2):c, 
         ReceiverBankArray(1), SymArray(3):c, PartSumArray(3):c,  
         SymArray(4):c, PartSumArray(4):c, 
         StringSumArray(0), SymArray(5):c, PartSumArray(5):c
         );
    if( asize(SymArray) <= 6 )
    [   ################################################################# └──────┴────────────────┘ 
       Источник поступления                                                                        ](StringSumArray(1));
    else
    [   ################################################################# │ #### │ ############## │](StringSumArray(1), SymArray(6):c, PartSumArray(6):c );
      while( CashSymbCount < asize(SymArray) )
    [                                                                     │ #### │ ############## │](SymArray(CashSymbCount):c, PartSumArray(CashSymbCount):c );
        CashSymbCount = CashSymbCount + 1;
      end;
    [                                                                     └──────┴────────────────┘
       Источник поступления                                                                        ];
    end;

    CashSymbCount = 7;

    [   ###########################################################################################
        ########################################################################################### 

       Подпись клиента              Бухгалтерский работник               Кассовый работник         ]
     (  GroundArray(0), 
        GroundArray(1) 
     );

    /*Квитанция*/

  StrSplit( pr_pmrmprop.rec.Ground      , GroundArray      ,  88, 88, 2 );
  StrSplit( pr_pscshdoc.rec.FIOClient   , ClientArray      ,  57, 57, 2 );
  StrSplit( pr_pmrmprop.rec.ReceiverName, ReceiverNameArray,  64, 54, 2 );                    

    [

       ────────────────────────────┬──────────┬───────────────────────────────┬───────────────────┐
                     Квитанция  №  │ ######## │                               │Код формы документа│
                                   └──────────┘                               │      по ОКУД      │
                                                                              ├───────────────────┤
                                                                              │      0402001      │
           #########################                                    ┌─────┴───────────────────┤
       От кого #########################################################│Для зачисления на счет № │
       Получатель ######################################################│  ####################   │
        ################################################################├─────────────────────────┤
       ИНН  ############   КПП  ############                            │      Сумма цифрами      │
       р/счет N  ####################           ОКАТО  ############     │   ####################  │
                                                                        └─────────────────────────┘
       Наименование банка-вносителя                                                                 
        ############################################################################ БИК ##########
       Наименование банка-получателя                                                              
        ############################################################################ БИК ##########
       Сумма прописью                              
        ###########################################################################################
       Источник поступления
        ###########################################################################################
     
       Место печати             Бухгалтерский работник              Кассовый работник
         (штампа)                                                                    
    ]( pr_pmrmprop.rec.Number:c,
       DateStr,
       ClientArray(0), 
       ReceiverNameArray(0), pr_pmpaym.rec.ReceiverAccount:l, 
       ReceiverNameArray(1), 
       ReceiverINN, ReceiverKPP,
       pr_pmpaym.rec.ReceiverAccount:l, ReceiverOKATO, ReceiverAmount:r:f:z,
       string( ReceiverBankArray(0), ReceiverBankArray(1) ), {MFO_Bank},
       string( ReceiverBankArray(0), ReceiverBankArray(1) ), {MFO_Bank},
       string( StringSumArray(0), StringSumArray(1) ),
       string( GroundArray(0), " ", GroundArray(1) )
      );


    /*Ордер*/

  StrSplit( pr_pmrmprop.rec.Ground      , GroundArray      ,  91, 91, 2 );
  StrSplit( pr_pscshdoc.rec.FIOClient   , ClientArray      ,  35, 28, 3 );
  StrSplit( pr_pmrmprop.rec.ReceiverName, ReceiverNameArray,  35, 25, 2 );                  

    [                                            
       ────────────────────────────┬──────────┬───────────────────────────────┬───────────────────┐
                         Ордер  №  │ ######## │                               │Код формы документа│
                                   └──────────┘                               │      по ОКУД      │
                                                                              ├───────────────────┤
                                                                              │      0402001      │
           #########################                                          └───────────────────┘
                                                      ДЕБЕТ
                                            ┌─────────────────────────────┬───────────────────────┐
       От кого ############################ │ счет № #################### │ ###  ################ │
        ################################### └─────────────────────────────┤                       │
        ###################################           КРЕДИТ              │    Сумма цифрами      │
       ─────────────────────────────────────┬─────────────────────────────┤                       │
       Получатель ######################### │ счет № #################### │ ###  ################ │
        ################################### └─────────────────────────────┼───────────────────────┤
                        ИНН ############     КПП ############             │      в том числе      │
        р/счет N ####################        ОКАТО ############           │      по символам:     │
       ───────────────────────────────────────────────────────────────────┼──────┬────────────────┤                   
       Наименование банка-вносителя                                       │символ│      сумма     │
        ################################################## БИК ########## ├──────┼────────────────┤
        ################################################################# │ #### │ ############## │
       Наименование банка-получателя                                      │ #### │ ############## │
        ################################################## БИК ########## │ #### │ ############## │
        ################################################################# │ #### │ ############## │
       Сумма прописью                                                     │ #### │ ############## │
        ################################################################# │ #### │ ############## │]
       ( pr_pmrmprop.rec.Number:c,
         DateStr,
         ClientArray(0), pr_pmpaym.rec.PayerAccount:l, PayerFICode, PayerAmount:r:f:z,
         ClientArray(1),
         ClientArray(2),
         ReceiverNameArray(0),
         pr_pmpaym.rec.ReceiverAccount:l, ReceiverFICode, ReceiverAmount:r:f:z,
         ReceiverNameArray(1), 
         ReceiverINN, ReceiverKPP, 
         pr_pmpaym.rec.ReceiverAccount:l, ReceiverOKATO, 
         ReceiverBankArray(0), {MFO_Bank},
         ReceiverBankArray(1), SymArray(0):c, PartSumArray(0):c, 
         SymArray(1):c, PartSumArray(1):c,
         ReceiverBankArray(0), {MFO_Bank}, SymArray(2):c, PartSumArray(2):c,  
         ReceiverBankArray(1), SymArray(3):c, PartSumArray(3):c, 
         SymArray(4):c, PartSumArray(4):c, 
         StringSumArray(0), SymArray(5):c, PartSumArray(5):c
        );

    if( asize(SymArray) <= 6 )
    [   ################################################################# └──────┴────────────────┘ 
       Источник поступления                                                                        ](StringSumArray(1));
    else
    [   ################################################################# │ #### │ ############## │](StringSumArray(1), SymArray(6):c, PartSumArray(6):c );
      while( CashSymbCount < asize(SymArray) )
    [                                                                     │ #### │ ############## │](SymArray(CashSymbCount):c, PartSumArray(CashSymbCount):c );
        CashSymbCount = CashSymbCount + 1;
      end;
    [                                                                     └──────┴────────────────┘
       Источник поступления                                                                        ];
    end;

    [   ###########################################################################################
        ########################################################################################### 

                                    Бухгалтерский работник               Кассовый работник         ]
     (  GroundArray(0), 
        GroundArray(1) 
     );

    ncopy = ncopy - 1;
  end;

  return TRUE;

end;

macro PrintDocument(ncopy:integer):bool
  var DocKind:integer = pr_pmpaym.rec.DocKind;
  
  if( DocKind != 410/*CASH_PS_INCORDER*/  )
    MsgBox("Данный вид документа не поддерживается макросом");
    return FALSE;
  end;
  if( pr_PrintEA )
    PrintEAHeader();
  end;
  
  return PrintDocumentCashOrder(ncopy);
end;

