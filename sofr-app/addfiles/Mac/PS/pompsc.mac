/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : pompsc.mac
  Created     : 31.10.2006
  Programmer  : Копачев Д.В.
  Description : Макрос печати протокола параллельного сканирования
                отложенных платежных документов

└───────────────────────────────────────────────────────────────────────────*/
IMPORT oralib, likepy, RsbDataSet;
const Последний = 3;

MACRO GetSessionID()
   var result:integer = 0;
   var query :string  = "SELECT SID, SERIAL#, AUDSID " +
                        "FROM GV$SESSION " +
                        "WHERE AUDSID=SYS_CONTEXT('USERENV','SESSIONID') ";

   var ds = TRsbDataSet(query);

   if (ds.next())
      result = ds.audsid;
   else
      RunError("Ошибка определения номера сессии.");
   end;

   return result;
END;

MACRO Печать_ОтчетСканирования( Вызов, firstdoc, Статус, Сообщение )

  var Number:string;
  var Amount:money;
  var pmDate:date;
  var ResultNum:integer;
  var ResultText:string;

  if( Вызов != Последний )
    return 0;
  end;

[        Отчет о групповом создании операций для платежных документов.    ];
[┌─────────┬─────────────┬──────────┬──────┬──────────────────────────────────────┐];
[│  Номер  │   Сумма     │   Дата   │Номер │                Сообщение             │];
[│документа│             │          │ошибки│                                      │];
[├─────────┼─────────────┼──────────┼──────┼──────────────────────────────────────┤];

  var query:string = " SELECT rm.t_Number, pm.t_Amount, rm.t_Date, NVL(lp.T_RESULTNUM,0), NVL(lp.T_RESULTTEXT,chr(1)) " +
                       " FROM DPRLPCKS_DBT lp " +
                      " INNER JOIN dpmpaym_dbt pm ON pm.T_DOCKIND = lp.T_DOCKIND " +
                                               " AND pm.T_DOCUMENTID = to_number(lp.T_DOCUMENTID) " +
                                               " AND pm.T_PURPOSE = 7 " +
                                               " AND pm.T_SUBPURPOSE = 0 " +
                      " INNER JOIN dpmrmprop_dbt rm ON rm.T_PAYMENTID = pm.T_PAYMENTID " +
                      " WHERE lp.T_DOCKIND = :DOCKIND AND lp.T_SESSIONID = :SESSION_ID ORDER BY rm.t_Number;";

  var params:TArray = makeArray(SQLParam( "DOCKIND", 201 ),
                                SQLParam( "SESSION_ID", GetSessionID()));
  var rs:RsdRecordset = execSQLselect( query, params, true );

  while( rs.MoveNext( ) )
    Number     = rs.Value(0);
    Amount     = rs.Value(1);
    pmDate     = rs.Value(2);
    ResultNum  = rs.Value(3);
    ResultText = rs.Value(4);
[│#########│#############│##########│######│######################################│](Number, Amount, pmDate, ResultNum, ResultText:w);
  end;

[└─────────┴─────────────┴──────────┴──────┴──────────────────────────────────────┘];

END;