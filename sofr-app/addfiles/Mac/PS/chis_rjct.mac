
/* ╔══════════════════════════════════════════════════════════════════╗ */
/* ║        Автоматизированная банковская система RS-Bank v5.0        ║ */
/* ║                Copyright (c) R-Style Software Lab 1998           ║ */
/* ║                                                                  ║ */
/* ║ Имя файла    : chiss_categ.mac                                   ║ */
/* ║                                                                  ║ */
/* ║ Описание     : Шаг "обработка отвергнутого"                      ║ */
/* ║                заяв. на выд. цен. бл.                            ║ */
/* ║                                                                  ║ */
/* ║                                                                  ║ */
/* ║ Программист  : Локтюшин В.Ю.                                     ║ */
/* ║                                                                  ║ */
/* ║ Создан       : 14.09.2006                                        ║ */
/* ║                                                                 ║ */
/* ╚══════════════════════════════════════════════════════════════════╝ */



import PSInter, chisfun, PaymInter;
//PaymInter, PSInter, psbccomn, cbsttls

var CheckIssObj:RsbCheckIss;


/* ╔═════════════════════════════════╗ */
/* ║        Выполнение шага          ║ */
/* ╚═════════════════════════════════╝ */
MACRO ExecuteStep( doc, paymDoc, DocKind:integer )

  var note_text:string = "";
  
  if( PM_NeedDocumentRestart() == true )
    
    // Заполнить статусы сегментов операции
    if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_OPEN ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

    if( not InsertOprStatus( CHECKISS_KIND_ST_KNTR, CHECKISS_ST_KNTR_NOTCONTROL ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

    if( not InsertOprStatus( CHECKISS_KIND_ST_DO, CHECKISS_ST_DO_PREP ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

    note_text = ReadNoteForCheckIss( CheckIssObj.OrderID );

    if( note_text != "" )
      if( InsertNoteForCheckIss( CheckIssObj.OrderID, CHECKISS_NOTES_CAUSE_OF_FAILUR,"" ) != 0 )
       msgbox( "Ошибка при очистки примечания заявления" );
       return -1;
     end;
    end;

    CheckIssObj.CurrentState = CHECKISS_ST_OPEN;

  else
    
    CheckIssObj.CurrentState = CHECKISS_ST_CLOSED;

    // Заполнить статусы сегментов операции
    if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_CLOSED ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

  end;

  return 0;
END;