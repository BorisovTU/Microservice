
/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : PR_INDLA.MAC
  Programmer  : —ãª¨­  ’.€.
  Description : ‚¥¤®¬®áâì áã¬¬ ª àâ®â¥ª¨

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/

import PSInter, FIInter, globals, prreplib, CurrInter, "bnk_ptlib.mac";

import PaymInter, BankInter;

private var DateRep      = date(0,0,0);
private var FIID         = -1;
private var DepNum       = -1;
private var NodeNum      = -1;
private var OperNum      = 0;

/* ­ã¬¥à æ¨ï áã¬¬ ¢ ¬ áá¨¢ å */
private const Unpaid   = 0,  // ¥®¯« ç¥­­ ï áã¬¬  ¤®ªã¬¥­â 
              Prior1   = 1,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 1
              Prior2   = 2,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 2
              Prior3   = 3,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 3
              Prior4   = 4,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 4
              Prior5   = 5,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 5
              Prior6   = 6,  // „®ªã¬¥­â á ®ç¥à¥¤­®áâìî 6
              Numpp    = 7;  // ®¬¥à ¯® ¯®àï¤ªã

private macro ¥®¯« ç¥­­ ï‘ã¬¬ „®ªã¬¥­â (DateR : date, Payment : object):money

  var select = " SELECT trn.t_AccTrnID " +
               "   FROM dacctrn_dbt trn, dpmdocs_dbt pd " +
               "  WHERE trn.t_Date_Carry <= :DateRep " +
               "    AND (  trn.t_Result_Carry IN ( 50, 51, 52, 53 ) " +
               "        OR     trn.t_Result_Carry = 74 " +
                           // Acctrn.Account_Receiver á¢ï§ ­ á® áç¥â®¬ pmpaym.PayerAccount 
                           // ¯® ¢¨¤ã á¢ï§¨ "‚­¥¡ « ­á®¢ë© ‘ç¥â ª àâ®â¥ª¨ 2"
               "           AND EXISTS (select 1 " +
               "                         from dobjlink_dbt ol " +
               "                        where ol.t_GroupId = 2 " /*OBJROLE_ACC_I2OBACC*/ +
               "                          and ol.t_ObjectType = 4 " /*OBJTYPE_ACCOUNT*/ +
               "                          and ol.t_ObjectId = LPAD( :pmChapter, 2, '0') || " +
               "                                              LPAD( :pmFIID, 7, '0') || " +
               "                                              :pmPayerAccount " +
               "                          and ol.t_AttrType = 4 " /*OBJTYPE_ACCOUNT*/ +
               "                          and ol.t_AttrId = LPAD(trn.t_Chapter, 2, '0') || " +
               "                                            LPAD(trn.t_FIID_Receiver, 7, '0') || " +
               "                                            trn.t_Account_Receiver ) " +
               "        ) " +
               "    AND trn.t_State = 1 " +
               "    AND trn.t_AccTrnID = pd.t_AccTrnID " +
               "    AND (  pd.t_PaymentID = :PaymentID " +
               "        OR EXISTS (SELECT 1 FROM dpmlink_dbt lnk " +
               "                    WHERE lnk.t_PurposePayment = pd.t_PaymentID " +
               "                      AND lnk.t_LinkKind = :LinkKind " +
               "                      AND lnk.t_InitialPayment = :PaymentID1 ) " +
               "        )";
  var params = makeArray( SQLParam( "DateRep"   ,  DateR  ), 
                          SQLParam( "pmChapter" ,  Payment.Chapter ), 
                          SQLParam( "pmFIID"    ,  Payment.PayerFIID ), 
                          SQLParam( "pmPayerAccount",  Payment.PayerAccount ), 
                          SQLParam( "PaymentID" ,  Payment.PaymentID ),
                          SQLParam( "LinkKind"  ,  PMLINK_KIND_KVITING ), 
                          SQLParam( "PaymentID1",  Payment.PaymentID ) );

  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
      
  var ‘ã¬¬ ‡ ç¨á«¥­¨ï : money = $0,
      ‘ã¬¬ ‘¯¨á ­¨ï : money = $0,
      AccTrn : object;
  
  while ( (rs.MoveNext()) and (rs.value(0) > 0) )
    AccTrn = TbFile( "acctrn.dbt", "R" );
    AccTrn.rec.AccTrnID = rs.value(0);
    if( AccTrn.GetEQ() )
      if (AccTrn.rec.Result_Carry == 50)
        ‘ã¬¬ ‡ ç¨á«¥­¨ï = ‘ã¬¬ ‡ ç¨á«¥­¨ï + ‘ã¬¬ à®¢®¤ª¨‚‚ «îâ¥‘ç¥â « â¥«ìé¨ª ( AccTrn, Payment, 0 );
      else
        ‘ã¬¬ ‘¯¨á ­¨ï = ‘ã¬¬ ‘¯¨á ­¨ï + ‘ã¬¬ à®¢®¤ª¨‚‚ «îâ¥‘ç¥â « â¥«ìé¨ª ( AccTrn, Payment, 1 );
      end;      
    end;
  end;

  var result = ‘ã¬¬ ‡ ç¨á«¥­¨ï - ‘ã¬¬ ‘¯¨á ­¨ï;
  if (result > $0)
    return result;
  else
    return $0;
  end;

end;

private macro GetAmountsI2( DateR : date, Payment : object, amounts : TArray ):integer

  amounts[Unpaid] = ¥®¯« ç¥­­ ï‘ã¬¬ „®ªã¬¥­â (DateR, Payment);
  if (Payment.Priority == 1)
    amounts[Prior1] = amounts[Unpaid];
  else
    amounts[Prior1] = $0;
  end;
  if (Payment.Priority == 2)
    amounts[Prior2] = amounts[Unpaid];
  else
    amounts[Prior2] = $0;
  end;
  if (Payment.Priority == 3)
    amounts[Prior3] = amounts[Unpaid];
  else
    amounts[Prior3] = $0;
  end;
  if (Payment.Priority == 4)
    amounts[Prior4] = amounts[Unpaid];
  else
    amounts[Prior4] = $0;
  end;
  if (Payment.Priority == 5)
    amounts[Prior5] = amounts[Unpaid];
  else
    amounts[Prior5] = $0;
  end;
  if (Payment.Priority == 6)
    amounts[Prior6] = amounts[Unpaid];
  else
    amounts[Prior6] = $0;
  end;
  
  return 0;
end; 

private macro PrintHeader( parm:TPrnReportParm )
  var DepCode= "", DepName = "";
  CB_GetDepartmentCodeAndName( DepNum, DepCode, NULL, DepName );

  [
                                       ‚¥¤®¬®áâì áã¬¬ ¢ ª àâ®â¥ª¥ ü2
                                        ¯® á®áâ®ï­¨î ­  ##########

    ”¨«¨ « ##########   ############################################################

  ](DateRep, DepCode, DepName);
end;    

private macro PrintDprtHeader(NodeNum)
  var NodeCode= "", NodeName = "";
  CB_GetDepartmentCodeAndName( NodeNum, NodeCode, NULL, NodeName );
  if( NodeName != "" )
  [
    ‚‘  ##########   ############################################################
  ](NodeCode, NodeName );
  end;
end;

private macro PrintOperHeader( Oper:integer )
  
  [
    ¯¥à æ¨®­¨áâ ##### ####################################################################################################
  ]( Oper, GetNameOper(Oper) );

  [ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÂÄÄÄÄÄÄÄÄÄÄ¿
   ³  ü  ³ ®¬¥à áç¥â         ³  ¨¬¥­®¢ ­¨¥ ª«¨¥­â                                        ³ ®¬¥à    ³   ¥®¯« ç¥­­ ï         ³ç³ „ â      ³
   ³ ¯/¯ ³                    ³                                                            ³ ¤®ªã¬    ³ áã¬¬  ¤®ªã¬¥­â         ³  ³ ¯®¬¥é¥­¨ï³
  ];
end;

private macro PrintDocument( PaymentObj:object, amounts:TArray )                         
  
  [ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÅÄÄÄÄÄÄÄÄÄÄ´
   ³#####³####################³############################################################³##########³########################³ #³##########³
  ](amounts[Numpp], PaymentObj.PayerAccount, PaymentObj.PayerName, PaymentObj.Number, amounts[Unpaid]:a, PaymentObj.Priority, PaymentObj.I2PlaceDate );
     
end;

private macro PrintItogOper( Oper:integer, counts:TArray, amounts:TArray )
  
  [ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÁÄÄÄÄÄÄÄÄÄÄ´
   ³      ˆ’ƒ:                                                                                       ########################              ³
   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
                                                                                                                            
   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
   ³ ç¥à¥¤­®áâì  ³         1           ³          2          ³          3          ³          4          ³          5          ³          6          ³      ˆâ®£®             ³
   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
   ³ áâ â®ª      ³                     ³                     ³                     ³                     ³                     ³                     ³                        ³
   ³ ¯® ª àâ®â¥ª¥ ³#####################³#####################³#####################³#####################³#####################³#####################³########################³
   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
  ]( amounts[Unpaid]:a, amounts[Prior1]:a, amounts[Prior2]:a, amounts[Prior3]:a, amounts[Prior4]:a, amounts[Prior5]:a, amounts[Prior6]:a, amounts[Unpaid]:a );
  
end;


macro PrintRep_K2_ListAmounts( MapVal :PSRepMap )

  /* „ ­­ë¥ ¯ ­¥«¨ */
      DateRep                 = MapVal.Value( "DateIn"       );
      FIID                    = MapVal.Value( "FIID"         );
  var Account       :string   = MapVal.Value( "Account"      );
      DepNum                  = MapVal.Value( "DepNum"       );
      NodeNum                 = MapVal.Value( "NodeNum"      );
      OperNum                 = MapVal.Value( "Oper"         );  
   
  /* ‡ ¯à®á */ 
  var select:string = " SELECT pm.t_PaymentID, pm.t_PayerAccount, pm.t_Oper, pm.t_FIID, pmh.t_Date " +
                      "   FROM dpmpaym_dbt pm, dpmrmprop_dbt rm, dpmhist_dbt pmh ";             
  var whereC:string = "  WHERE pm.t_StartDepartment = :DepNum " +
                      "    AND pm.t_FIID = :FIID " +
                      "    AND pm.t_PaymentID = rm.t_PaymentID ";
  if( OperNum >  0 ) 
    whereC = whereC + "    AND pm.t_Oper = :Oper "; 
  end;
  if( NodeNum > 0 ) 
    whereC = whereC + "    AND pm.t_OperNode = :NodeNum ";
  else
    var privFROM : string = ""; //¤®¯®«­¨â¥«ì­ ï áâà®ª  ¤«ï ¯à®¢¥àª¨ ¯à¨¢¨«¥£¨¨ 0008 
    var privWHERE : string = ""; //¤®¯®«­¨â¥«ì­®¥ ãá«®¢¨¥ ¤«ï ¯à®¢¥àª¨ ¯à¨¢¨«¥£¨¨ 0008
    if( GetObjectRestriction(privWHERE, 8, {Oper}, "dt", 0,"dp_dep.dbt", privFROM ) )
      if(privFROM != "")
        select = select + ", " + privFROM + " ";
      else
        select = select + ", ddp_dep_dbt dt ";
        whereC = whereC + " AND dt.t_Code = pm.t_StartDepartment ";
      end;
      if(privWHERE != "")
        whereC = whereC + " AND " + privWHERE;
      end;
    end;
  end;
  if( Account )
    whereC = whereC + "    AND " + ConvertMaskToSQLFormat( Account, "pm.t_PayerAccount" );
  end;
  whereC   = whereC + "    AND pm.t_I2PlaceDate <> to_date('01010001', 'ddmmyyyy') "+
                      "    AND pm.t_I2PlaceDate < :DateRep "+
                      "    AND pmh.t_AutoKey = "+
                      "               ( SELECT MAX (pmh2.t_AutoKey) "+
                      "                   FROM dpmhist_dbt pmh2 "+
                      "                  WHERE pmh2.t_Date       <= :DateRep1 "+
                      "                    AND pmh2.t_StatusIDTo  = :I2Status "+
                      "                    AND pmh2.t_PaymentID   = pm.t_PaymentID "+
                      "               ) " +
                      "    AND NOT EXISTS (SELECT pmh1.t_AutoKey "+
                      "                      FROM dpmhist_dbt pmh1 "+
                      "                     WHERE pmh1.t_Date <= :DateRep2 "+
                      "                       AND pmh1.t_StatusIDFrom = :I2Status1 "+
                      "                       AND pmh1.t_PaymentID = pm.t_PaymentID "+
                      "                       AND pmh1.t_AutoKey > pmh.t_AutoKey " +
                      "                   ) ";
  select = select + whereC +
                      " ORDER BY pm.t_OperNode, pm.t_Oper, pm.t_PayerAccount, rm.t_Priority, pmh.t_Date ";   
  
  var params:TArray = TArray();
  params[params.size]   = SQLParam( "DepNum"     , DepNum       );
  params[params.size]   = SQLParam( "FIID"       , FIID         );
  if( OperNum > 0 )
    params[params.size] = SQLParam( "Oper"       , OperNum      );
  end;                                    
  if( NodeNum > 0 )
    params[params.size] = SQLParam( "NodeNum"    , NodeNum      );
  end;
  params[params.size]   = SQLParam( "DateRep"    , DateRep      );
  params[params.size]   = SQLParam( "DateRep1"   , DateRep      );
  params[params.size]   = SQLParam( "I2Status"   , PM_I2PLACED  );
  params[params.size]   = SQLParam( "DateRep2"   , DateRep      );
  params[params.size]   = SQLParam( "I2Status1"  , PM_I2PLACED  );

  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
  
  /* „ ­­ë¥ § ¯à®á  */
  var I2StateReport   :object = NULL;
  var Payments        :TArray = TArray();
  var Amounts         :TArray = TArray();
  var PaymentObj      :object = NULL;
  if( rs ) // ‡ ¯®«­¨âì Payments, Amounts
    rs.Command.NullConversion = true;  
    while( ( rs.MoveNext() ) and ( rs.value(0) > 0 ) ) 
      PaymentObj = RsbPayment( rs.value(0) );      
      Payments[Payments.size] = PaymentObj;
      
      // ¯® ª ¦¤®¬ã PaymentObj ¯®¤áç¨â ¥¬ áã¬¬ë
      Amounts[Amounts.size]   = TArray();
      GetAmountsI2( DateRep, Payments[Payments.Size-1], Amounts[Amounts.Size-1] );
      if (  (Amounts.Size == 1) 
         or (Payments[Payments.Size-1].Oper != Payments[Payments.Size-2].Oper)
         or (Payments[Payments.Size-1].OperNode != Payments[Payments.Size-2].OperNode)
         )
        Amounts[Amounts.Size-1][Numpp] = 1;
      else
        Amounts[Amounts.Size-1][Numpp] = Amounts[Amounts.Size-2][Numpp] + 1;
      end;
      
      Payments[Payments.Size-1].I2PlaceDate = rs.value("t_Date"); // ¤«ï ¢ë¢®¤  ¢ ®âç¥â pmhist.Date
      Payments[Payments.Size-1].Department = Payments[Payments.Size-1].OperNode; // ¤«ï PrintDprtHeader
    end;    
  end; 

  var DateOut       :date     = date(0,0,0);
  I2StateReport = TPSReportPayments( "‚¥¤®¬®áâì áã¬¬ ª àâ®â¥ª¨ 2", "PR_INDLA.mac", Payments, Amounts, DateRep, DateOut, DepNum, OperNum );
  I2StateReport.PrintPSReportPayments();

end;
