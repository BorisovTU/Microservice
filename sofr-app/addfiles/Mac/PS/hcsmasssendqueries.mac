/*
$Name: hcsmasssendqueries.mac
$Module: РКО
$Description: Печать отчета групповой отправки запросов начислений
*/

import oralib, likepy, PaymInter, globals;

const   Ошибка   = 0,
        Первый   = 1,
        Последний= 2;

private const WLD_STATUS_TYPE_PMSENDANSWER:integer = 37;

RECORD pmreqcharge(pmreqcharge);

macro Печать_ОтчетСканирования(Вызов, firstdoc, Статус, Сообщение)

  if( Вызов==Первый )
    [
      Отчет о результатах получения ответов по запросам, направленным в ГИС ЖКХ
                                                                              
                                                                              
      Исполнитель    #####  #
      Дата отчета    #

    ]({oper}, {Name_Oper}, {curdate});

    [                                                                         Запросы начислений

      ┌──────────┬─────────────────────┬────────────────────────────────────┬──────────────────┬─────────────────┬──────────┬─────────────┬───────────────────────────────┬───────────────────────────────────────────────┐
      │          │                     │                                    │                  │                 │          │             │                               │                                               │
      │ID запроса│ ИНН/КПП потребителя │           ФИО потребителя          │ Идентификатор ПД │Идентификатор ЖКУ│   ЕЛС    │Период оплаты│        ID объекта RS-Connect  │             Описание ошибки                   │
    ]
  elif (Вызов==Ошибка)

    setbuff (pmreqcharge,firstdoc);

    var q : string = 
    " SELECT sd.t_ID AS ID, " +
    "        rq.t_PayerINN AS PayerINN, " +
    "        rq.t_PayerName1 || ' ' || rq.t_PayerName2 || ' ' || rq.t_PayerName3 " +
    "          AS PayerName, " +
    "        rq.t_HCSDocID AS ReqPaymentID, " +
    "        rq.t_ServiceID AS ReqServiceID, " +
    "        rq.t_HCSAccount AS ReqAcc, " +
    "        Replace( TO_CHAR (rq.t_Month) || '.' || TO_CHAR (rq.t_Year), '0.0', chr(1)) AS ReqPeriod, " +
    "        sd.t_ExtObjectID AS RSConnectObject, " +
    "        sd.t_Description AS ErrDescription " +
    "  FROM dpmreqcharge_dbt rq, dpmsend_dbt sd " +
    "          WHERE rq.t_ID = :ID AND sd.t_ObjectID = rq.t_ID AND sd.t_Action = :WLD_ACTION_PMSEND_QUERY " +
    "      AND sd.t_ObjectID = rq.t_ID ";
     
    var params : TArray = makeArray( SQLParam("ID", pmreqcharge.ID), SQLParam("WLD_ACTION_PMSEND_QUERY", WLD_ACTION_PMSEND_QUERY), SQLParam("WLD_STATUS_TYPE_PMSENDANSWER ", WLD_STATUS_TYPE_PMSENDANSWER ) );
    var rs = execSQLselect(q, params);

      if(rs.moveNext())

      [ ├──────────┼─────────────────────┼────────────────────────────────────┼──────────────────┼─────────────────┼──────────┼─────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
        │##########│#####################│####################################│##################│#################│##########│#############│###############################│###############################################│
      ]
      ( rs.value("ID"), 
        rs.value("PayerINN"), 
        rs.value("PayerName"),
        rs.value("ReqPaymentID"),
        rs.value("ReqServiceID"),
        rs.value("ReqAcc"),
        rs.value("ReqPeriod"),
        rs.value("RSConnectObject"),        
        StrSubst(IfThenElse(Сообщение == "", rs.value("ErrDescription"), Сообщение), "|", " " ):w 
      );    
    end;
  elif (Вызов==Последний)
   [ └──────────┴─────────────────────┴────────────────────────────────────┴──────────────────┴─────────────────┴──────────┴─────────────┴───────────────────────────────┴───────────────────────────────────────────────┘     
   ]

  end;
  
end;