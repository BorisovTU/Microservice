/*
$Name:        loadfmo.mac
$Module:      РКО 
$Description: Макрос шага Выгрузка сведений об операции в ФМ
*/
/* ---------------------------------------------------------------------- */
/*         Автоматизированная банковская система RS-Bank v6.0             */
/*                 Copyright (c) R-Style Software Lab                     */
/*                                                                        */
/*  Имя файла  : loadmfo.mac                                              */
/*                                                                        */
/*                                                                        */
/*  Программист: Popova O.                                                */
/*  Переписан  : 13.12.2010                                               */
/*  Описание   : Операция - 3030   - "Открытие лицевого счета"            */
/*               Блок     - 303002 - "Выгрузка сведений об операции в ФМ" */
/*               Шаг      - 10     - "Выгрузка сведений об операции в ФМ" */
/*                                                                        */
/* ---------------------------------------------------------------------- */

import PSInter, FMInter, reqinter, "bnk_common.mac", PaymInter, "bnk_ptlib.mac", InsCarryDoc, pmfm;

var ReqOpenAccObj:RsbReqOpenAcc;

private macro RejectGroundQuery( isNeedCached: bool): string
  var OldDialogFlag = SetDialogFlag(1);
  var Ground = "";
  GetString( Ground, "Введите обоснование принятого решения об отказе в заключении договора счета:" );
  SetParm( 0, true );
  SetDialogFlag(OldDialogFlag);
  return Ground;
end;

Macro ExecuteCaseStep(Kind_Operation, Number_Step, reqopena, Kinddoc)
  
  var RegVal = 0;
  GetRegistryValue( "PS\\REQOPENACC\\OPERATION\\Проверка_Терроризм", V_INTEGER, RegVal );

  if( RegVal == 1 )
    //Следующий шаг
    return "85";
  else
    // Документооборот = Закрыт
    if( not InsertOprStatus( REQOPENA_ST_KIND_DO, REQOPENA_ST_DO_CLOSED ) ) 
     MsgBox( "Ошибка при установке статуса операции" );
     return 1;
    end;
    return "";
  end;

end;

Macro ExecuteStep(Kind_Operation, Number_Step, reqopena, Kinddoc)

  var ErrorMessage = "";
  var rejectAccountObj = null;
  
  rejectAccountObj = RsbFMRejectServiceMessage( RJSRVMSG_MSGKIND_REJ_ACC_CNTR );
  var ErrorStatus = rejectAccountObj.GetLastError(ErrorMessage);

  if( not ErrorStatus)
    ErrorStatus = FillRejectAccount( ReqOpenAccObj, @ErrorMessage, @rejectAccountObj );
  end;

  if(ErrorStatus != 0)
    msgbox(ErrorMessage);
    return 1;
  end;

  return 0;

end;

MACRO CheckStepAction( mes:integer ):integer

  var stat = 0;

  if( mes == OP_BACKOUT_STEP )
    stat = FM_Backout_RjSrvMsg(RJSRVMSG_MSGKIND_REJ_ACC_CNTR, String(ReqOpenAccObj.RequestID:34:o), OBJTYPE_REQOPENA );

    if((stat != 0) and (stat != 4))
      var bankMsg = AL_GetErrorInfo();
      MsgBox("Ошибка отката передачи сведений об отказе от заключения договора счета в ФСФМ: " + bankMsg.Message);      
    else
      stat = 0;
    end;
  end;
 
  return stat;
END;