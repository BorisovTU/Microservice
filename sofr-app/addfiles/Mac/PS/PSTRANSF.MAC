/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : pstransf.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага зачисления                       */
/*                     средств по внутреннему платежу                   */
/*                     на клиентский счет                               */
/*  Программист      : Зайцев А.В.                                      */
/*                                                                      */
/*  Создан           : 15.02.99                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import  BankInter, InsCarryDoc, OprInter, FIInter, payconst, PaymInter, /*SVInter,*/ sfinsdoc;
import  paym_rec; /* Pm_paym, Pm_rmprop, Pm_debet, Pm_credit */
/*
RECORD  d(arhdoc);
RECORD  ord(pspayord);
  */
/*RECORD Sv_Acc      ( svacc );
RECORD Sv_SrvPayAcc( svsrvpay );*/
/*
MACRO InitDoc(d)
     ClearRecord(d);

     d.Chapter = 1;
     d.Date_Carry = Pm_paym.ValueDate;
     d.Result_Carry = 1;
     d.Kind_Oper = " 1";

     /* Присваиваем признак "Неотложные нужды" */     
     if(IsUrgentPayOrder(ord) == 1) d.TypeDocument = d.TypeDocument + "Н"; end;
END;
  */
/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder )
/*
  setbuff(ord, payorder);
  setbuff(d, doc);

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок МФР в проведенные");
    return 1;
  end;

  /* Претензии */
  if( Pm_paym.IsPurpose == "X" )
    if( Pm_paym.ClaimID == 0 )
      if( InsertAcClaim_Macro( Pm_rmprop.Number, Pm_paym.ValueDate, Pm_paym.ReceiverAccount, Pm_paym.FuturePayerAmount ) )
        msgbox("Ошибка при вставке претензии");
        return 1;
      end;
    else
      if( InsertAcClaimChange_Macro( Pm_paym.ClaimID, Pm_rmprop.Number, Pm_paym.ValueDate, Pm_paym.FuturePayerAmount ) )
        msgbox("Ошибка при изменении претензии");
        return 1;
      end;
    end;
  end;

  InitDoc(d);
  /* Проводки делать только по Future-счетам*/
  d.Account_Receiver = Pm_paym.FutureReceiverAccount;
  d.Account_Payer    = Pm_paym.FuturePayerAccount;
  /*d.Account_Receiver = Pm_paym.ReceiverAccount;
  d.Account_Payer = Pm_paym.PayerAccount;*/
  d.Sum = Pm_paym.Amount;
  d.Ground = Pm_rmprop.Ground;
  d.Numb_Document = Pm_rmprop.Number;
  d.Department    = Pm_paym.Department;
  d.Number_Pack   = Pm_paym.NumberPack;
  d.Shifr_Oper    = Pm_rmprop.ShifrOper;

  /* Если платеж - плата за обслуживание */
  if(ord.Origin == PSPO_OR_SF)
  
    if(ВставитьПлатуЗаОбслуживание(Pm_paym,doc, Pm_rmprop.Number, Pm_paym.ValueDate, 
                                   Pm_paym.Department, Pm_paym.NumberPack)) 
       return 1; 
    end;
  
  else

    if( not InsertRubDocument(NULL,PMMET_ID,Pm_paym.PaymentID) )
      msgbox("Ошибка при вставке рублевого документа");
      return 1;
    end;

  end;

  if( not PM_IsInternalPayerAccount( Pm_paym ) )

    /* Изменяем дату списания со счета плательщика */
    if( not InsertPayerChargeOffDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты списания со счета плательщика");
      return 1;
    end;
    
    /* Изменяем дату отметки банка плательщика */
    if( not InsertPayerBankMarkDate( Pm_paym, Pm_rmprop, Pm_paym.ValueDate ) )
      msgbox("Ошибка при изменении даты отметки банка плательщика");
      return 1;
    end;

  end;

  /* Установить статус платежа - завершенный платеж */
  if( not InsertPaymentStat( Pm_paym.PaymentID, PM_FINISHED ) )
    msgbox("Ошибка при вставке статуса платежа");
    return 1;
  end;

  /*****************************************************
  Здесь можно вставлять дополнительные проводки для шага
  *****************************************************/
  */
  return 0;

END;
