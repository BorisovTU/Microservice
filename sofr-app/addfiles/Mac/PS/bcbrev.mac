/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.10          */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : bcbecase.mac                                     */
/*                                                                      */
/*  Описание         : Формирование обратной продажи                    */
/*                                                                      */
/*  Операция         : Покупка валюты                                   */
/*                                                                      */
/*  Программист      : Литворенко А.А.                                  */
/*                                                                      */
/*  Создан           : 06.10.2001                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, payconst, календарь, "bcall.mac";

record  bc  (ps_bcord);
record  back(ps_bcord);


/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, _ps_bcord_ )

   const PSBCKIND_BUY = 1, PSBCKIND_PAY = 2, PSBCKIND_CONV = 3,
         PSBC_FREE = 0, PSBC_REV = 2;
   var tmp_date;
    
   setbuff( back, doc );
   setbuff( bc, _ps_bcord_ );
   //шага обратной продажи теперь нет
/*
   ClearRecord( back );

   if( not PossiblePSBCPayCurrency( KindDoc_BuyCurrency, bc.OrderID ) )
      msgbox("Невозможно сформировать продажу, поскольку есть открытые сквитованные документы");
      return 1;
   end;

   var СуммуВозврата = ПолучитьСуммуВозврата( bc.OrderID, KindDoc_BuyCurrency, bc.SatisfiedAmount );
   
   if( СуммуВозврата > 0 )
    
       tmp_date = {curdate};
/* последовательность полей по ТЗ */

/* 1.  Номер поручения  */
       back.Number = bc.Number; 
/* 2.  Дата поручения */
       back.OrderDate    = DateAfterCalenDays(tmp_date,  8);  /*Дата оформления заявки*/
       if (IsHoliday(back.OrderDate))
          back.OrderDate = DateAfterWorkDays(back.OrderDate, 1);  /*Дата оформления заявки*/
       end;
/* 3.  Вид продажи */
       back.BCOrdKind    = PSBCKIND_PAY; /*Вид заявки (покупка валюты, продажа валюты, конверсия вал*/
       back.BCOrdSubKind = PSBC_REV;     /*Подвид заявки: обратная продажа*/
/* 4.  Клиент  */
       back.ClientID     = bc.ClientID  ;
       back.ClientName   = bc.ClientName;
       back.ClientINN    = bc.ClientINN ;
/* 5.  Клиент - наименование
    не нужно, подкачает скроллинг */
/* 6.  В лице - должность */
       back.Post = bc.Post;      /*Название должности*/
/* 7.  В лице - ФИО */
       back.FIO = bc.FIO;        /*ФИО отвественного сотрудника*/
/* 8.  Заявка - Валюта - код */
       back.SourceFIID   = bc.RequiredFIID; /*Исходная валюта (для покупки валюты всегда рубли)*/
       back.RequiredFIID = bc.SourceFIID;   /*Требуемая валюта (для продажи валюты всегда рубли)*/
/* 9.  Заявка валюта наименование
    не нужно, подкачает скроллинг */
/* 10. Заявка дата валютирования */
       back.ValueDate    = DateAfterCalenDays(back.OrderDate, 3);  /*Дата валютирования*/
       if (IsHoliday(back.ValueDate))
          back.OrderDate = DateAfterWorkDays(back.ValueDate, 1);  /*Дата оформления заявки*/
       end;
/* 11. Заявка тарговая площадка
     // ЕТС - такого в справочнике нет, по этому подставляем первый попавшийся */
       ПолучитьТорговуюПлощадку(back.MarketPlace);
/* 12. Заявка валюта торгов - код 
    см. п. 11 */
/* 13. Заявка валюта торгов - наименование 
    не нужно, подкачает скроллинг */
/* 14. заявка - поступившая сумма */
       back.SourceAmount = СуммуВозврата;             /*Сумма в исходной валюте*/
/* 15. Заявка процент продажи */
       back.InAmount     = СуммуВозврата;             /*Сумма в исходной валюте*/
/* 16. заявка - сумма валюты */
/*        back.UsedAmount   = RetSumm; */
/* 17. Заявка - сумма обеспечения 
    ... пусто */
/* 18. Заявка - вид курса - код
    ... пусто  */
/* 19. Заявка - вид курса - название
    ... пусто */
/* 20. Заявка - вид курса - значение
    ... пусто */
/* 21. счет списания  */
       back.SourceAccount = bc.RequiredAccount;   /*Счет с исходной валютой*/
/* 22. текущий валютный счет  */
       ПолучитьТкВС_Клиента (back.ClientID, back.SourceFIID, back.CurrentAccount);
/* 23. зачисление полученных средств счет */
       ПолучитьРС_Клиента (back.ClientID, back.RequiredAccount);
/* 24. зачисление полученных средств банк
     ... пусто */
/* 25. Основание операции */
       back.Ground = "Обратная продажа валюты, поступившая по поручению № " + bc.Number + " от " + bc.OrderDate;
/* 26. Номер пачки */
       back.NumberPack   = 0;   
/* 27. Филиал */
       back.Department   = bc.Department;   
/* 28. Операция - код 
     проставит механизм операций */
/* 29. Операция наименование
     не нужно, подкачает скроллинг */

/* 30. Происхождение документа */
       back.Origin = PSBCORD_OR_AUTO;

/* 31. Операционист */
       back.Oper = {oper};

/* количество знаков для курса */
       back.Point  = 4;

       if( not InsertPSBCOrder( NULL ) )
          msgbox( "Ошибка при вставке поручения на продажу валюты" );
          return 1;
       else
          PSBC_AddMessageToLog( "Сформированно поручение на обратную продажу № " + back.Number + ", дата " + back.OrderDate );
       end;

   else
     PSBC_AddMessageToLog( "Средства были полностью израсходованы" );
   end;
   */
   return 0;
end;
