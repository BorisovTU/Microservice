//-----------------------------------------------------------------------------
// Блок      : Вне блока
// Шаг       : Вне шага
// Назначение: Макрос скроллинга
// Описание  : Макрос скроллинга валютных платежных документов в РКО
//-----------------------------------------------------------------------------


import psrqdoc, pscpdoc, bbbodoc;

import "cb_FillFactura.mac";

/*
Обращаемся к полям структур, используемых в макросах выполнения шагов операций, 
для ускорения работы макросов.
*/
var field_finit;
field_finit = r_pscpord.OrderID;
field_finit = r_pmpaym.PaymentID;
field_finit = r_credit.PaymentID;
field_finit = r_pmrmprop.PaymentID;
//field_finit = b1.AutoKey;

/* Установка подсказки для скролингов из макроса */
private const Hint_ByValueDate:string = "/*+FIRST_ROWS LEADING(t pscpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx11) USE_NL(t pscpord pmprop pmrmprop oproper oprcurst)*/";
private const Hint_ByCloseDate:string = "/*+FIRST_ROWS LEADING(t pscpord pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx15) USE_NL(t pscpord pmprop pmrmprop oproper oprcurst)*/";
private const Hint_ByStatus   :string = "/*+FIRST_ROWS LEADING(t pscpord  pmprop pmrmprop oproper oprcurst) INDEX(t dpmpaym_dbt_idx16) INDEX(pscpord DPSCPORD_DBT_IDX0) USE_NL(t pscpord pmprop pmrmprop oproper oprcurst)*/";
private const Hint_ByStep     :string = "/*+FIRST_ROWS LEADING(oprstep oproper t pscpord pmprop pmrmprop oprcurst) INDEX(oprstep doprstep_dbt_idx10) INDEX(pscpord dpscpord_dbt_idx0) INDEX(t dpmpaym_dbt_idx0) USE_NL(oprstep oproper t pscpord pmprop pmrmprop oprcurst)*/";
private const Hint_ForUnknown :string = "/*+FIRST_ROWS LEADING(oprstep oproper t pmrmprop rminprop debet credit) INDEX(oprstep doprstep_dbt_idx10) INDEX(oproper doproper_dbt_idx0) INDEX(t dpmpaym_dbt_idx0) INDEX(rminprop drminprop_dbt_idx8) INDEX(debet dpmprop_dbt_idx0) INDEX(credit dpmprop_dbt_idx0) USE_NL(oprstep oproper t pmrmprop rminprop debet credit)*/";
/*Хинт для списка К2*/
private const Hint_ForK2      :string = "/*+FIRST_ROWS LEADING(t) INDEX(t dpmpaym_dbt_idx16)*/";


MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStates:integer ):string
  
  /* Все, Закрытые */
  if( ( ScrolStates == PSSK_ALL ) or 
      ( ScrolStates == PSSK_CLOSED ) ) 

    var dtflt:PMScrolDateFltr = PMScrolDateFltr();

    if( dtflt.IsSet( DTFL_CLOSEDATE ) )
      return Hint_ByCloseDate;
    elif( dtflt.IsSet( DTFL_VALUEDATE ) )
      return Hint_ByValueDate;
    else
      return Hint_ByStatus;
    end;

  /* Отложенные, Открытые, Отвергнутые */
  elif( ( ScrolStates == PSSK_DEFER ) or 
        ( ScrolStates == PSSK_OPEN ) or 
        ( ScrolStates == PSSK_REJECTED_WORK ) )
  
    return Hint_ByStatus;

  /* Подготовленные к шагу */
  elif( ScrolStates == PSSK_STEP )
    
    return Hint_ByStep;

  /* Документов из картотеки 2 */
  elif( ScrolStates == PSSK_INDEX_2 )

    return Hint_ForK2;

  /* Невыясненные */
  elif( ScrolStates == PSSK_INDEX_UNKNOWN )
  
    return Hint_ForUnknown;

  end;

  return DefaultHint;

END;

macro Новый_Документ( )
  
  if( r_pmpaym.DocKind == PS_CPORDER )
    return PS_CurPayOrderNewDoc();
  elif( r_pmpaym.DocKind == PS_INRQ )
    return PS_ReqOrderNewDoc();
  end;

  msgbox("Неизвестный вид документа");
  return 1;
end;

macro Проверить_Документ( Режим )
  
  if( r_pmpaym.DocKind == PS_CPORDER )
    return PS_CurPayOrderCheckDoc( Режим );
  elif( r_pmpaym.DocKind == PS_INRQ )
    return PS_ReqOrderCheckDoc( Режим );
  elif( r_pmpaym.DocKind == DLDOC_BANKORDER )
    return BB_BankOrderCheckDoc( Режим );
  end;


  msgbox("Неизвестный вид документа");
  return 1;
end;

macro Функция_Пользователя( Режим:integer )
 
  /*
  Возможные значения Режим:
   UFN_PANEL_INPUT(1) - функция вызвана из панели ввода объекта;
   UFN_PANEL_EDIT(2) - функция вызвана из панели корректировки объекта;
   UFN_SCROL(3) - функция вызвана из панели скролинга, единичный вызов, любая корректировка объекта запрещена;
   UFN_SCROL_FMASS(4) - функция вызвана из панели скролинга, работа по нескольким записям, вызов до начала обработки, любая корректировка объекта запрещена;
  
 // Пример работы: 
  if( Режим == UFN_SCROL )
    return UPDTPAGE;    // Обновить страницу записей и область скролинга
    //return UPDTREC;     // Обновить текущую запись, загрузив из файла
  end;
  */

  // Режим == 4 (UFN_SCROL_FMASS) Вызов пользоветельской макро функции до группового выполнения
  // Режим == 6 (UFN_SCROL_LMASS) Вызов пользоветельской макро функции после группового выполнения
  // Для данных режимов буфера не заполняются
  if ( (Режим == 4) OR (Режим == 6))
    return 0;
  end;
  
  if( r_pmpaym.DocKind == PS_CPORDER )
    return PS_CurPayOrderUserFunc( Режим );
  elif( r_pmpaym.DocKind == PS_INRQ )
    return PS_ReqOrderUserFunc( Режим );
  elif( r_pmpaym.DocKind == DLDOC_BANKORDER )
    return BB_BankOrderUserFunc( Режим );
  end;

  msgbox("Неизвестный вид документа");
  return 1;
end;

