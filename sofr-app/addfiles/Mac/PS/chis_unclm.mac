/* ╔══════════════════════════════════════════════════════════════════╗ */
/* ║        Автоматизированная банковская система RS-Bank v5.0        ║ */
/* ║                Copyright (c) R-Style Software Lab 1998           ║ */
/* ║                                                                  ║ */
/* ║ Имя файла    : chiss_categ.mac                                   ║ */
/* ║                                                                  ║ */
/* ║ Описание     : Шаг "Списание невостребованных ч.к."              ║ */
/* ║                     заяв. на выд. цен. бл.                       ║ */
/* ║                                                                  ║ */
/* ║                                                                  ║ */
/* ║ Программист  : Локтюшин В.Ю.                                     ║ */
/* ║                                                                  ║ */
/* ║ Создан       : 14.09.2006                                        ║ */
/* ║                                                                 ║ */
/* ╚══════════════════════════════════════════════════════════════════╝ */


import PSInter, chis_categ, chisfun, payinter, pm_categ;

var CheckIssObj:RsbCheckIss;


/* ╔═════════════════════════════════╗ */                  
/* ║        Выполнение шага          ║ */
/* ╚═════════════════════════════════╝ */
MACRO ExecuteStep( doc, paymDoc, DocKind:integer, ID_Operation:integer, ID_Step:integer )
  
  var stat = 0;
  var Error:string = "";

  var FD:CheckissFirstDoc = CheckissFirstDoc( CheckIssObj.OrderID );
  var ВнебалСчетУчетаВыданныхКнижек:string = FD.FindSysAccount( "СчетБланкОформ", 0 );

  var FD_CorrAcc:NotBalCorrAcc_FirstDoc = NotBalCorrAcc_FirstDoc( "П" );
  var СистемныйСчетКорреспонденцииЧековыхКнижек:string = FD_CorrAcc.FindAndOpenSysCurAccount( "ВнебалСчетКорресп", 0, {curdate}, FD.CalcFIID );

  if( strlen(ВнебалСчетУчетаВыданныхКнижек) == 0 )
    msgbox("Не задан внебалансовый счет|учета оформленных чековых книжек");
    return 1;
  end;

  var paymtr:object     = RsbAccTransaction();//PaymentObj.MakeTransaction();

  if( paymtr == NULL )
    MsgBox("Ошибка при создании проводки по платежу");
    return 1;
  end;

  paymtr.Chapter         = 3;                                            
  paymtr.FIID            = FD.CalcFIID;
  paymtr.AccountPayer    = СистемныйСчетКорреспонденцииЧековыхКнижек;
  paymtr.AccountReceiver = ВнебалСчетУчетаВыданныхКнижек;
  paymtr.Sum             = FD.BooksAmount;
  paymtr.Ground          = "Списание невостребованной клиентом оформленной чековой книжки согласно акту об уничтожении";
  if( not paymtr.Carry )
    MsgBox("Ошибка при актуализации платежа");
    return 1;
  end;  

  CheckIssObj.CurrentState = CHECKISS_ST_CLOSED;

  // Заполнить статусы сегментов операции
  if( not InsertOprStatus( CHECKISS_KIND_ST_STATE, CHECKISS_ST_STAT_CLOSED ) )
    msgbox("Ошибка при установке сегментов статуса экземпляра операции");
    return -1;
  end;

  InsertNoteForCheckIss( CheckIssObj.OrderID, CHECKISS_NOTES_CAUSE_OF_FAILUR,"Чековая книжка не востребована" ); 

  return ChissDelSFPAY_CARRY( ID_Operation, ID_Step );

END;
