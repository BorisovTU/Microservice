
/*ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : PR_INDLS.MAC
  Programmer  : ó„™®≠† í.Ä.
  Description : Ç•§Æ¨Æ·‚Ï ·Æ·‚ÆÔ≠®Ô ™†‡‚Æ‚•™®

¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ*/

import PSInter, FIInter, globals, CurrInter, "oralib.mac", "likepy.mac", "bnk_ptlib.mac";

import PaymInter, BankInter;

private var DateIn       = date(0,0,0);
private var DateOut      = date(0,0,0);
private var FIID         = -1;
private var OutForm      = 0;
private var DepNum       = -1;
private var NodeNum      = -1;
private var OperNum      = 0;

/* ‰Æ‡¨Î ¢ÎØ„·™†•¨Æ£Æ Æ‚Á•‚† */
private const é°Æ‡Æ‚≠†ÔÇ•§Æ¨Æ·‚Ï  = 1,
              à≠¢•≠‚†‡≠†ÔéØ®·Ï    = 2;

private macro PrintHeader( )
  var DepCode= "", DepName = "";
  CB_GetDepartmentCodeAndName( DepNum, DepCode, NULL, DepName );

  [
                                          Ç•§Æ¨Æ·‚Ï ·Æ·‚ÆÔ≠®Ô ™†‡‚Æ‚•™® ¸2
                                        ß† Ø•‡®Æ§ · ##########. ØÆ ##########


    î®´®†´ ##########   ############################################################

  ](DateIn, DateOut, DepCode, DepName);
end;    

private macro PrintDprtHeader(NodeNum)
  var NodeCode= "", NodeName = "";
  CB_GetDepartmentCodeAndName( NodeNum, NodeCode, NULL, NodeName );
  if( NodeName != "" )
  [
    Çëè  ##########   ############################################################
  ](NodeCode, NodeName );
  end;
end;


private macro PrintOperHeader( Oper:integer )
  
  [
    éØ•‡†Ê®Æ≠®·‚ ##### ####################################################################################################
  ]( Oper, GetNameOper(Oper) );

  if (OutForm == é°Æ‡Æ‚≠†ÔÇ•§Æ¨Æ·‚Ï)
  [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
   ≥  çÆ¨•‡ ·Á•‚†       ≥ ë†´Ï§Æ ¢ÂÆ§ÔÈ••   ≥     è‡®ÂÆ§        ≥       ê†·ÂÆ§      ≥  ë†´Ï§Æ ®·ÂÆ§ÔÈ•• ≥    é·‚†‚Æ™ ‡\·    ≥ë¢Æ°Æ§≠Î© Æ·‚†‚Æ™ ‡\·≥
  ];
  else
  [⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
   ≥ çÆ¨•‡ ·Á•‚†        ≥                  ç†®¨•≠Æ¢†≠®• ·Á•‚†                        ≥  ë„¨¨† §Æ™„¨•≠‚Æ¢ ≥    é·‚†‚Æ™ ‡\·    ≥ë¢Æ°Æ§≠Î© Æ·‚†‚Æ™ ‡\·≥
  ];
  end;
end;

private macro PrintDocument( rs )                         
  FILE acc ("account" );
  var InSum        = 0;
  var OutSum       = 0;
  var CreditSum    = 0;
  var DebetSum     = 0;
  if(rs.value("t_InSum") == NullVal)
    InSum = "≠• ÆØ‡•§•´•≠";
  else
    InSum = rs.value("t_InSum");
  end;

  if(rs.value("t_OutSum") == NullVal)
    OutSum = "≠• ÆØ‡•§•´•≠";
  else
    OutSum = rs.value("t_OutSum");
  end;

  if(rs.value("t_DebetSum") == NullVal)
    DebetSum = "≠• ÆØ‡•§•´•≠";
  else
    DebetSum = rs.value("t_DebetSum");
  end;

  if(rs.value("t_CreditSum") == NullVal)
    CreditSum = "≠• ÆØ‡•§•´•≠";
  else
    CreditSum = rs.value("t_CreditSum");  
  end;
      
  if (OutForm == é°Æ‡Æ‚≠†ÔÇ•§Æ¨Æ·‚Ï)
  [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
   ≥####################≥###################≥###################≥###################≥###################≥###################≥ ################### ≥
  ](rs.value("t_PayerAccount"), 
                        InSum:a, CreditSum:a, DebetSum:a, OutSum:a, 
                                                                   rs.value("t_Rest"):a, rs.value("t_FreeRest"):a );
  else
    var AccName = "";
    ClearRecord(acc);     
    acc.Chapter       = 1;
    acc.Account       = rs.value("t_PayerAccount");         
    acc.Code_Currency = rs.value("t_FIID");
    if ( getEQ(acc) )            
      AccName = acc.NameAccount;
    end;    
  [√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
   ≥####################≥############################################################≥###################≥###################≥ ################### ≥
  ](rs.value("t_PayerAccount"), acc.NameAccount, OutSum:a, rs.value("t_Rest"):a, rs.value("t_FreeRest"):a );
  end;
     
end;          

private macro CreateError(str:@string, rs, AccountOld:@string, SumType)
  if(AccountOld == rs.value("t_payeraccount"))
    str = str + ", N " +  rs.value("t_number") + " Æ‚ " + date(rs.value("t_date")) + " ≠† ·„¨¨„ " +
                 rs.value("t_amount") + " " + rs.value("t_ccy");
  else
    if(AccountOld != "" )
      str = str + ". è‡®Á®≠† ÆË®°™® ¨Æ¶•‚ °Î‚Ï ¢ Æ‚·„‚·‚¢®® ™„‡·† ≠† §†‚„ Ø‡Æ¢Æ§™®.\n";
    end;
      str = str + "\tÑ´Ô ·Á•‚† " + rs.value("t_payeraccount") + " ≠• „§†´Æ·Ï ÆØ‡•§•´®‚Ï ·„¨¨„ " + SumType +
                    " ®ß-ß† ≠•¢Æß¨Æ¶≠Æ·‚® ‡†··Á®‚†‚Ï ·„¨¨„ ¢ ¢†´Ó‚• ·Á•‚† Ø´†‚•´ÏÈ®™† §´Ô Ø´†‚•¶†(•©) "+
                    " N " +  rs.value("t_number") + " Æ‚ " + date(rs.value("t_date")) + " ≠† ·„¨¨„ " +
                        rs.value("t_amount") + " " + rs.value("t_ccy");
    AccountOld = rs.value("t_payeraccount");
  end;
end;

private macro PrintItogErrors(oper , OutForm)
  var select = string("SELECT pmrm.t_number     AS t_number, "+ 
                      "       pm.t_payeraccount AS t_payeraccount, "+
                      "       t.t_insum         AS t_insum, "+
                      "       t.t_outsum        AS t_outsum, "+
                      "       t.t_debetsum      AS t_debetsum, "+
                      "       t.t_creditsum     AS t_creditsum, "+ 
                      "       pmrm.t_date       AS t_date, "+
                      "       pm.t_BaseAmount   AS t_amount, "+
                      "       PM_SCRHLP.getficode(pm.t_basefiid, 1) AS t_ccy "+
                      "FROM dpmpaym_dbt pm, dprindls_tmp t, dpmrmprop_dbt pmrm, dfininstr_dbt f "+
                      "WHERE pm.t_paymentid = t.t_paymentid "+
                      "AND   pmrm.t_paymentid = t.t_paymentid "+
                      "AND   f.t_FIID = pm.t_basefiid "+
                      "AND (t.t_insum     is NULL "+
                      "OR   t.t_outsum    is NULL "+
                      "OR   t.t_CreditSum is NULL "+
                      "OR   t.t_DebetSum  is NULL) "+
                      "AND pm.t_oper = :oper ");                    
  var rs:RsdRecordset;
  var params:TArray = TArray();
  var AccountOld = "";
  var ReportStr= "";

[éË®°™® Æ‚Á•‚†:];
  params[params.size] = SQLParam( "oper", oper);
  rs = execSQLselect( select, params, TRUE );
  while(rs.movenext())
    if(rs.value("t_insum") == NullVal)
      CreateError(@ReportStr, rs, @AccountOld, "¢ÂÆ§ÔÈ•£Æ ·†´Ï§Æ");
    end;
  end; 
  if(AccountOld != "")
    ReportStr = ReportStr + ". è‡®Á®≠† ÆË®°™® ¨Æ¶•‚ °Î‚Ï ¢ Æ‚·„‚·‚¢®® ™„‡·† ≠† §†‚„ Ø‡Æ¢Æ§™®.";
  end;
[#######################################################################################################################################](ReportStr:w);
  ReportStr="";

  rs = execSQLselect( select, params, TRUE );
  AccountOld = "";
  while(rs.movenext())
    if(rs.value("t_outsum") == NullVal)
      if(OutForm == à≠¢•≠‚†‡≠†ÔéØ®·Ï)
        CreateError(@ReportStr, rs, @AccountOld, "§Æ™„¨•≠‚Æ¢");
      else
        CreateError(@ReportStr, rs, @AccountOld, "®·ÂÆ§ÔÈ•£Æ ·†´Ï§Æ");
      end;
    end;
  end;
  if(AccountOld != "")
    ReportStr = ReportStr + ". è‡®Á®≠† ÆË®°™® ¨Æ¶•‚ °Î‚Ï ¢ Æ‚·„‚·‚¢®® ™„‡·† ≠† §†‚„ Ø‡Æ¢Æ§™®.";
  end;
[#######################################################################################################################################](ReportStr:w); 
  ReportStr="";

  rs = execSQLselect( select, params, TRUE );
  AccountOld = "";
  while(rs.movenext())
    if(rs.value("t_creditsum") == NullVal)
      CreateError(@ReportStr, rs, @AccountOld, "Ø‡®ÂÆ§†");
    end;
  end;
  if(AccountOld != "")
    ReportStr = ReportStr + ". è‡®Á®≠† ÆË®°™® ¨Æ¶•‚ °Î‚Ï ¢ Æ‚·„‚·‚¢®® ™„‡·† ≠† §†‚„ Ø‡Æ¢Æ§™®.";
  end;
[#######################################################################################################################################](ReportStr:w);  ReportStr="";

  rs = execSQLselect( select, params, TRUE );
  AccountOld = "";
  while(rs.movenext())
    if(rs.value("t_debetsum") == NullVal)
      CreateError(@ReportStr, rs, @AccountOld, "‡†·ÂÆ§†");
    end;
  end;
  if(AccountOld != "")
    ReportStr = ReportStr + ". è‡®Á®≠† ÆË®°™® ¨Æ¶•‚ °Î‚Ï ¢ Æ‚·„‚·‚¢®® ™„‡·† ≠† §†‚„ Ø‡Æ¢Æ§™®.";
  end;
[#######################################################################################################################################](ReportStr:w);  ReportStr="";  
end;

private macro PrintItogOper( amounts:TArray, oper, flag , OutForm )

  if (OutForm == é°Æ‡Æ‚≠†ÔÇ•§Æ¨Æ·‚Ï)
  [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
    à‚Æ£Æ:               ################### ################### ################### ###################
  ]( amounts[0]:a, amounts[1]:a, amounts[2]:a, amounts[3]:a );
  else
  [¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
    à‚Æ£Æ:                                                                            ###################
  ](amounts[3]:a);
  end;
  if(flag == true)
    PrintItogErrors(oper, OutForm);
  end;                                                              
end;

private macro PrintItogDprt( amounts:TArray )
  if( OperNum > 0 )
    return;
  end;

  if (OutForm == é°Æ‡Æ‚≠†ÔÇ•§Æ¨Æ·‚Ï)
  [
    àíéÉé ØÆ ¢·•¨ ÆØ•‡.  ################### ################### ################### ###################

  ]( amounts[0]:a, amounts[1]:a, amounts[2]:a, amounts[3]:a );
  else
  [
    à‚Æ£Æ:                                                                            ###################

  ](amounts[3]:a);
  end;

end;
            
/* ØÆ§·Á•‚ ·„¨¨ */
private macro Calculator( amounts:TArray, curamounts:@variant)
  var i = 0;
  if( ValType( amounts ) == V_GENOBJ )   
    if( ValType( curamounts ) != V_GENOBJ ) // •È• ≠• ·Á®‚†´® ≠®Á•£Æ
       curamounts = TArray( amounts.size );
    end;                   
    while( i < amounts.size )
      if( ValType( curamounts[i] ) != V_MONEY   )
        curamounts[i] = $0;
      end;
      if((amounts[i] != NullVal) and (amounts[i] > $0) )
        if( ( ValType( curamounts[i] ) == V_MONEY   ) )
          curamounts[i] = curamounts[i] +  amounts[i];
        else                                          
          curamounts[i] = amounts[i];
        end;
      end;
      i = i + 1;
    end;
  end;
end;

macro PrintRep_K2_ListState( MapVal :PSRepMap )

  /* Ñ†≠≠Î• Ø†≠•´® */
      DateIn                  = MapVal.Value( "DateIn"       );
      DateOut                 = MapVal.Value( "DateOut"      );
      FIID                    = MapVal.Value( "FIID"         );
  var Account       :string   = MapVal.Value( "Account"      );
      DepNum                  = MapVal.Value( "DepNum"       );
      NodeNum                 = MapVal.Value( "NodeNum"      );
      OperNum                 = MapVal.Value( "Oper"         );
  var ClientID      :integer  = MapVal.Value( "ClientID"     );    
      OutForm                 = MapVal.Value( "OutForm"      );
  execSQL("truncate table dprindls_tmp"); 
  /* á†Ø‡Æ· */    
  var select:string = " INSERT INTO dprindls_tmp (t_PaymentID, t_IsChild, t_InSum, t_OutSum, t_CreditSum, t_DebetSum) " +
                      " SELECT pm.t_PaymentID, 0, 0, 0, 0, 0 " +
                      "   FROM dpmpaym_dbt pm, dpmhist_dbt pmh ";             
  var whereC:string = "  WHERE pm.t_StartDepartment = :DepNum " +
                      "    AND pm.t_FIID = :FIID ";
  if( OperNum >  0 ) 
    whereC = whereC + "    AND pm.t_Oper = :Oper "; 
  end;
  if( NodeNum > 0 ) 
    whereC = whereC + "    AND pm.t_OperNode = :NodeNum ";
  else
    var privFROM : string = ""; //§ÆØÆ´≠®‚•´Ï≠†Ô ·‚‡Æ™† §´Ô Ø‡Æ¢•‡™® Ø‡®¢®´•£®® 0008
    var privWHERE : string = ""; //§ÆØÆ´≠®‚•´Ï≠Æ• „·´Æ¢®• §´Ô Ø‡Æ¢•‡™® Ø‡®¢®´•£®® 0008
    if( GetObjectRestriction(privWHERE, 8, {Oper}, "dt", 0,"dp_dep.dbt", privFROM ) )
      if(privFROM != "")
        select = select + ", " + privFROM + " ";
      else
        select = select + ", ddp_dep_dbt dt ";
        whereC = whereC + " AND dt.t_Code = pm.t_StartDepartment ";
      end;
      if(privWHERE != "")
        whereC = whereC + " AND " + privWHERE;
      end;
    end;
  end;
  if( Account )
    whereC = whereC + "    AND " + ConvertMaskToSQLFormat( Account, "pm.t_PayerAccount" );
  end;
  if( ClientID > 0 )
    whereC = whereC + "    AND pm.t_Payer = :ClientID ";
  end;  
  whereC   = whereC + "    AND pm.t_I2PlaceDate <> to_date('01010001', 'ddmmyyyy') "+
                      "    AND pm.t_I2PlaceDate < :DateEnd "+
                      "    AND pmh.t_AutoKey = "+
                      "               ( SELECT MAX (pmh2.t_AutoKey) "+
                      "                   FROM dpmhist_dbt pmh2 "+
                      "                  WHERE pmh2.t_Date        <= :DateEnd1 "+
                      "                    AND pmh2.t_StatusIDTo   = :I2Status "+
                      "                    AND pmh2.t_PaymentID    = pm.t_PaymentID "+
                      "               ) " +
                      "    AND NOT EXISTS (SELECT pmh1.t_AutoKey "+
                      "                      FROM dpmhist_dbt pmh1 "+
                      "                     WHERE pmh1.t_Date < :DateBeg "+
                      "                       AND pmh1.t_StatusIDFrom = :I2Status1 "+
                      "                       AND pmh1.t_PaymentID = pm.t_PaymentID "+
                      "                       AND pmh1.t_AutoKey > pmh.t_AutoKey " +
                      "                   ) ";
  select = select + whereC;   
                                                  
  var params:TArray = TArray();
  params[params.size]   = SQLParam( "DepNum"     , DepNum       );
  params[params.size]   = SQLParam( "FIID"       , FIID         );
  if( OperNum > 0 )
    params[params.size] = SQLParam( "Oper"       , OperNum      );
  end;                                    
  if( NodeNum > 0 )
    params[params.size] = SQLParam( "NodeNum"    , NodeNum      );
  end;
  if( ClientID > 0 )
    params[params.size] = SQLParam( "ClientID"   , ClientID     );
  end;
  params[params.size]   = SQLParam( "DateEnd"    , DateOut      );
  params[params.size]   = SQLParam( "DateEnd1"   , DateOut      );
  params[params.size]   = SQLParam( "I2Status"   , PM_I2PLACED  );
  params[params.size]   = SQLParam( "DateBeg"    , DateIn       );
  params[params.size]   = SQLParam( "I2Status1"  , PM_I2PLACED  );
  
  execSQL( select, params, FALSE );
                                
  select = string("INSERT INTO dprindls_tmp (t_PaymentID, t_IsChild, t_InSum, t_OutSum, t_CreditSum, t_DebetSum) ",
                  "   SELECT /*+ LEADING(t) */ ",
                  "         lnk.t_PurposePayment, 1, 0, 0, 0, 0 ",
                  "     FROM dprindls_tmp t, dpmlink_dbt lnk, dpmrmprop_dbt rm ",
                  "    WHERE     t.t_PaymentID = lnk.t_InitialPayment ",
                  "          AND lnk.t_LinkKind = 2                       /*PMLINK_KIND_KVITING*/ ",
                  "          AND lnk.t_InitialPayment != lnk.t_PurposePayment ",
                  "          AND rm.t_PaymentID = lnk.t_PurposePayment ",
                  "          AND rm.t_Date <= :DateEnd");
  params = TArray();
  params[params.size] = SQLParam( "DateEnd", DateOut );
  execSQL( select, params, FALSE );
    
  params = TArray();
  params[params.size] = SQLParam( "", DateIn );
  params[params.size] = SQLParam( "", DateOut);
  params[params.size] = SQLParam( "", OutForm);
  var stat = execStoredFunc("PM_PRINDLS.FillSumForReport",V_INTEGER, params);
                              
  select = string("  SELECT count(1) ",
                  "    FROM dprindls_tmp t, dpmpaym_dbt pm ",
                  "   WHERE t.t_PaymentID = pm.t_PaymentID ",
                  "GROUP BY pm.t_OperNode, ",
                  "         pm.t_Oper,",
                  "         pm.t_PayerAccount,",
                  "         pm.t_FIID,",
                  "         pm.t_Chapter");
  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
  var iProgress = 0;
  if (rs.MoveNext())
    iProgress = rs.value(0);
  end;
  
  if( iProgress > 0 )
    select = string("  SELECT pm.t_OperNode, pm.t_Oper, pm.t_PayerAccount, pm.t_FIID, ",
                    "         decode(count(t.t_inSum),count(1), sum(t.t_inSum)) AS t_InSum, ",
                    "         decode(count(t.t_outSum),count(1), sum(t.t_outSum)) AS t_OutSum, ",
                    "         decode(count(t.t_DebetSum),count(1), sum(t.t_DebetSum)) AS t_DebetSum, ",
                    "         decode(count(t.t_CreditSum),count(1), sum(t.t_CreditSum)) AS t_CreditSum, ",
                    "         rsi_rsb_account.restall (pm.t_PayerAccount, ",
                    "                                  pm.t_Chapter, ",
                    "                                  pm.t_FIID, ",
                    "                                  :DateEnd) ",
                    "            AS t_Rest, ",
                    "         PM_RESTFUN.RSI_AccGetFreeAmountForInd2Sc ( ",
                    "            pm.t_PayerAccount, ",
                    "            pm.t_Chapter, ",
                    "            pm.t_FIID, ",
                    "            :DateEnd2, ",
                    "            MIN ( ",
                    "               CASE ",
                    "                  WHEN t_OutSum > 0 THEN rm.t_Priority ",
                    "                  ELSE PM_COMMON.PM_DefaultMaxPriority () ",
                    "               END)) ",
                    "            AS t_FreeRest ",
                    "    FROM dprindls_tmp t, dpmpaym_dbt pm, dpmrmprop_dbt rm ",
                    "   WHERE t.t_PaymentID = pm.t_PaymentID AND rm.t_PaymentID = t.t_PaymentID ",
                    "GROUP BY pm.t_OperNode, ",
                    "         pm.t_Oper,",
                    "         pm.t_PayerAccount,",
                    "         pm.t_FIID,",
                    "         pm.t_Chapter ",
                    "ORDER BY pm.t_OperNode"); 
    params = TArray();
    params[params.size] = SQLParam( "DateEnd"    , DateOut      );
    params[params.size] = SQLParam( "DateEnd2"   , DateOut      );
    rs = execSQLselect( select, params, TRUE );

    var i = 0;                                                                   
    var ProgressInd:integer = 1;
    var HeaderRepord = "Ç•§Æ¨Æ·‚Ï ·Æ·‚ÆÔ≠®Ô ™†‡‚Æ‚•™® 2";
    var m_CurAmounts = TArray;
    var ErrFlag = false;
          
    var prevOper    = 0,
        prevDepNum  = 0,
        PayerAccount,
        Oper, Department;
    InitProgress( iProgress, null, HeaderRepord );
    while( rs.MoveNext() )

      UseProgress( ProgressInd );
      Department = rs.value("t_OperNode");
      Oper = rs.value("t_Oper");
      PayerAccount = rs.value("t_PayerAccount");
      
      if( i == 0 ) // ·≠†Á†´† ¢Î¢Æ§®¨ ¢·• ß†£Æ´Æ¢™®
        PrintHeader();
        PrintDprtHeader   ( Department     );
        PrintOperHeader   ( Oper           );
      end;

      ProgressInd = ProgressInd + 1;
      // ®‚Æ£®, •·´® Á‚Æ-‚Æ ØÆ¨•≠Ô´Æ·Ï ® Á‚Æ-‚Æ ≠†·Á®‚†´®
      if( ( prevOper    != 0  ) and ( prevOper     != Oper            ) or 
          ( prevDepNum  != 0  ) and ( prevDepNum   != Department      ) )
        if( ( prevOper   != Oper        ) or 
            ( prevDepNum != Department  ) )
            PrintItogOper( m_CurAmounts[0], prevOper, ErrFlag, OutForm );
            ErrFlag = false;
            m_CurAmounts[0]   = 0;
            if( ( prevDepNum != Department ) )
              PrintItogDprt  ( m_CurAmounts[1]            );
              PrintDprtHeader( Department );// ß†£Æ´Æ¢Æ™ ØÆ ‰®´®†´„
            end;
            PrintOperHeader( Oper );// ß†£Æ´Æ¢Æ™ ØÆ ÆØ•‡„
        end;
      end;
      var amounts = MakeArray(rs.value("t_InSum"), rs.value("t_CreditSum"), rs.value("t_DebetSum"), rs.value("t_OutSum"), rs.value("t_Rest"), rs.value("t_FreeRest"));
      Calculator( amounts, @m_CurAmounts[0] );// ØÆ§·Á•‚ ØÆ ÆØ•‡„
      Calculator( amounts, @m_CurAmounts[1] );// ØÆ§·Á•‚ ØÆ ‰®´®†´„
      PrintDocument(rs);

      if((rs.value("t_InSum")    == NullVal) or 
         (rs.value("t_OutSum")   == NullVal) or
         (rs.value("t_DebetSum") == NullVal) or
         (rs.value("t_CreditSum")== NullVal)   )
        ErrFlag = true;
      end;
      prevOper    = Oper;
      prevDepNum  = Department;

      i = i + 1;
    end;                  
    PrintItogOper   ( m_CurAmounts[0] , Oper , ErrFlag ,OutForm);
    PrintItogDprt   ( m_CurAmounts[1] );
    
    RemProgress();

  else//if( Count > 0 )
    msgbox("ç•‚ §Æ™„¨•≠‚Æ¢, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â ß†§†≠≠Î¨ „·´Æ¢®Ô¨");
  end;
end;
