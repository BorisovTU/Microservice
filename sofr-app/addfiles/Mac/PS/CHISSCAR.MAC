/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 1998              */
/*                                                                      */
/*  Имя файла        : chisscar.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага по                               */
/*                     выдаче ценных бланков                            */
/*                                                                      */
/*  Программист      : Зайцев А.В.                                      */
/*                                                                      */
/*  Создан           : 15.02.99                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import  InsCarryDoc, OprInter, pm_categ;

RECORD  OprCheckiss( checkiss );
/*RECORD  d( arhdoc );*/

//-----------------------------------------------------------------------------
// Счет КУ "СчетБланков"
//-----------------------------------------------------------------------------
CLASS (TCommonFirstDoc) CheckissFirstDoc( parm1 )

   VAR
      checkiss = TBfile( "checkiss.dbt" );

   PRIVATE MACRO InitParmArray

      ParmA[regList.registration(MC_TYPE_PARAMETR_DOCKIND   )] = 240; //PS_CHECKISS;
      ParmA[regList.registration(MC_TYPE_PARAMETR_DOCID     )] = checkiss.rec.OrderID;
      ParmA[regList.registration(MC_TYPE_PARAMETR_OWNER     )] = {OurBank};
      ParmA[regList.registration(MC_TYPE_PARAMETR_DEPARTMENT)] = checkiss.rec.Department;
      ParmA[regList.registration(MC_TYPE_PARAMETR_INDEXDATE )] = checkiss.rec.ValueDate;

      FIRoleBArray[0] = 0;
   END;

   // Конструктор
   if( ValType( parm1 ) == V_INTEGER )
     checkiss.rec.OrderID = parm1;
     if( not checkiss.GetEQ )
       return null
     end;
   else
     copy( checkiss, parm1 );
   end;

   InitTCommonFirstDoc();
   InitParmArray();

   Kind = ParmA[MC_TYPE_PARAMETR_DOCKIND];
   Id   = ParmA[MC_TYPE_PARAMETR_DOCID  ];
END;

//-----------------------------------------------------------------------------
// Выполнение шага
//-----------------------------------------------------------------------------
MACRO ExecuteStep( doc, checkiss )
/*
   setbuff( d          , doc      );
   setbuff( OprCheckiss, checkiss );

   var FD:CheckissFirstDoc = CheckissFirstDoc( OprCheckiss );
   var ВнебалСчетУчетаЧековыхКнижек:string = FD.FindSysAccount( "СчетБланков", 0 );

   if( strlen( ВнебалСчетУчетаЧековыхКнижек ) == 0 )
     msgbox( "Не задан внебалансовый счет учета чековых книжек" );
     return 1;
   end;

   var FD_CorrAcc:NotBalCorrAcc_FirstDoc = NotBalCorrAcc_FirstDoc( "П" );
   var СистемныйСчетКорреспонденцииЧековыхКнижек:string = FD_CorrAcc.FindAndOpenSysAccount( "ВнебалСчетКорресп", 0, {curdate} );

   if( strlen( СистемныйСчетКорреспонденцииЧековыхКнижек ) == 0 )
     msgbox( "Не задан внебалансовый счет корреспонденции с активными счетам" );
     return 1;
   end;

   // Выполнить внебалансовую проводку
   ClearRecord( d );

   d.Chapter          = 3;
   d.Account_Payer    = СистемныйСчетКорреспонденцииЧековыхКнижек;
   d.Account_Receiver = ВнебалСчетУчетаЧековыхКнижек;
   d.Sum              = OprCheckiss.BooksAmount;
   d.Date_Carry       =
   d.Numb_Document    = OprCheckiss.Number;
   d.Department       = OprCheckiss.Department;
   d.Kind_Oper        = " 1";
   d.Ground           = "Выдача чековых книжек к счету " + OprCheckiss.Account;

   if( not InsertRubDocument() )
     msgbox( "Ошибка при вставке рублёвого документа" );
     return 1;
   end;

   //Здесь можно вставлять дополнительные проводки для шага
*/
   return 0;

END;
//-----------------------------------------------------------------------------
