import PSInter, PSInter, psbccomn, cbsttls, PTInter, chisfun;

var CheckIssObj:RsbCheckIss;

MACRO ExecuteStep( doc, paymDoc )
  var note_text:string = "";

  if( PM_NeedRejectControl() == true )
  
    note_text = "Документ отвергнут кассиром в RS-Retail";

    // Установить статус заяв.
    CheckIssObj.CurrentState = CHECKISS_ST_REJECTED;

    // Заполнить статусы сегментов операции
    if( not InsertOprStatus( CHECKISS_KIND_ST_ACCEPT, CHECKISS_ST_ACCEPT_REJECTED ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

    // Заполнить примечание
    if( InsertNoteForCheckIss( CheckIssObj.OrderID, note_text ) != 0 )
      msgbox( "Ошибка при вставке примечания заявления" );
      return -1;
    end;
  
  else
   
    // Заполнить статусы сегментов операции
    if( not InsertOprStatus( CHECKISS_KIND_ST_ACCEPT, CHECKISS_ST_ACCEPT_ACCEPTED ) )
      msgbox("Ошибка при установке сегментов статуса экземпляра операции");
      return -1;
    end;

    note_text = ReadNoteForCheckIss( CheckIssObj.OrderID );

    if( note_text != "" )
      if( InsertNoteForCheckIss( CheckIssObj.OrderID, "" ) != 0 )
       msgbox( "Ошибка при очистки примечания заявления" );
       return -1;
      end;
    end;
  end;

  return 0;
END;
