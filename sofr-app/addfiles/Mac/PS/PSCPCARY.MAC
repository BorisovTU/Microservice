/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.10          */
/*                 Copyright (c) R-Style Software Lab 1999              */
/*                                                                      */
/*  Имя файла        : pscpcary.mac                                     */
/*                                                                      */
/*  Описание         : Выполнение шага зачисления                       */
/*                     средств по внутреннему валютному платежу         */
/*                     на клиентский счет                               */
/*  Программист      : Зайцев А.В.                                      */
/*                                                                      */
/*  Создан           : 15.05.99                                         */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import  InsCarryDoc, "cppmconv.mac", "paym_rec.mac";

/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, payorder )
/*
  RECORD  d(arhdoc);
  RECORD  mc(multycar);

  /* Актуализировать проводки МФР */
  if( not CarryPlanDocuments( Pm_paym.PaymentID ) )
    MsgBox("Ошибка при помещении планируемых проводок в проведенные");
    return 1;
  end;

  /* Проводка со счета плательщика на счет получателя*/
  if( Pm_paym.FIID == Pm_paym.PayFIID )

    setbuff(d,doc);
    ClearRecord(d);

    d.Chapter          = 1;
    d.Date_Carry       = Pm_paym.ValueDate;
    d.Number_Pack      = Pm_paym.NumberPack;

    /* Из-за МФР проводки теперь делаются только по Future-счетам */
    d.Account_Payer    = Pm_paym.FuturePayerAccount;
    d.Account_Receiver = Pm_paym.FutureReceiverAccount;

    d.Sum              = Pm_paym.Amount;
    d.Ground           = Pm_rmprop.Ground;
    d.Code_Currency    = Pm_paym.PayFIID;
    d.Numb_Document    = Pm_rmprop.Number;
    d.Department       = Pm_paym.Department;
    d.Result_Carry     = 1;
    d.Kind_Oper        = " 1";

    if(Pm_paym.FIID) 
      if( not InsertCurDocument(NULL, 1 /*PMMET_ID*/, Pm_paym.PaymentID) )
         msgbox("Ошибка при вставке валютного документа");
         return 1;
      end;
    else 
      if( not InsertRubDocument(NULL, 1 /*PMMET_ID*/, Pm_paym.PaymentID) )
         msgbox("Ошибка при вставке рублевого документа");
         return 1;
      end;
    end;

    /* Установить статус платежа - завершенный платеж */
    if( not InsertPaymentStat( Pm_paym.PaymentID, 32000 /*PM_FINISHED*/ ) )
      msgbox("Ошибка при вставке статуса платежа");
      return 1;
    end;

  /* Мультивалютная проводка со счета плательщика на счет получателя*/
  else

    if( ПолучитьДополнительныеСчетаПроводокКонверсии() )
      msgbox( "Ошибка при установке счетов ОВП" );
      return 1;
    end;

    SetBuff( mc, doc );
    ClearRecord( mc );
  
    mc.MethodID      = 1;
    mc.FIID_From     = Pm_paym.FIID;
    mc.FIID_To       = Pm_paym.PayFIID;
    mc.Amount_From   = Pm_paym.Amount;
    mc.Amount_To     = Pm_paym.PayAmount;

    /* Из-за МФР проводки теперь делаются только по Future-счетам */
    mc.Account_From  = Pm_paym.FuturePayerAccount;
    mc.Account_To    = Pm_paym.FutureReceiverAccount;

    mc.Chapter       = 1;
    mc.Ground        = Pm_rmprop.Ground;
    mc.Numb_Document = Pm_rmprop.Number;
    mc.Date          = Pm_paym.ValueDate; 
    mc.Date_Document = Pm_rmprop.Date;
    mc.Number_Pack   = Pm_paym.NumberPack;
    mc.Department    = Pm_paym.Department;
    mc.AccOCP_From   = СчетОВПДебет;
    mc.AccOCP_To     = СчетОВПКредит;
    mc.Account1      = СчетДоходов;
    mc.Account2      = СчетРасходов;
    mc.PaymentTPR    = 1; /*PMMET_ID*/
    mc.PaymentIDR    = Pm_paym.PaymentID;
    mc.PaymentTPC    = 1; /*PMMET_ID*/
    mc.PaymentIDC    = Pm_paym.PaymentID;

    if( not InsertMultiCarry() )
      MsgBox( "Ошибка при вставке мультивалютного документа" );
      return 1; 
    end;

  end;
  */
  return 0;

END;
