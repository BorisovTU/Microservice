/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 2001              */
/*                                                                      */
/*  Имя файла        : bccoll.mac                                       */
/*                                                                      */
/*  Описание         : Выполнение шага по депонированию средств         */
/*                                                                      */
/*  Операция         : покупка валюты на бирже                          */
/*                                                                      */
/*  Программист      : Бурак В.Ю.                                       */
/*                                                                      */
/*  Создан           : 17.05.2001                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, payinter, currinter;
/*
RECORD  d(arhdoc);
*/
/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, ps_bcord )
/*
record bc    ( ps_bcord );
record object( account  );
record attr  ( account  );

setbuff( bc, ps_bcord );
setbuff( d , doc      );

    if( bc.MarketPlace == PTID_UNKNOWNPARTY )
       return 0;
    end;

    if( bc.SourceAmount <= 0 )
       return 0;
    end;

    ClearRecord( d );

/*****************************************************
   Списание с клиентского счета на транзитный
*****************************************************/

    d.Chapter = 1;

    d.Date_Carry = bc.ValueDate;

    d.Account_Payer = bc.SourceAccount;

    object.Code_Currency = bc.RequiredFIID;
    object.Chapter = 1;
    object.Account = bc.CurrentAccount;

    if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITNATCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
      d.Account_Receiver = attr.Account;  /* Нашли настройку */
    else /* Не найден связанный счет */
      d.Account_Receiver = "";
    end;

    /*
    if( bc.SourceAmount > 0 )
       d.Sum = bc.SourceAmount;   
    else
       CalculateSumRate( d.Sum, bc.RequiredAmount, bc.Rate, bc.Scale, bc.Point, bc.IsInverse, 2 );
    end;
    */

    d.Sum = bc.SourceAmount;
    d.Ground = "Поручение № " +
               bc.Number + " от " + bc.OrderDate + ". Депонирование средств для покупки валюты." ;

    d.Numb_Document = bc.Number;
    d.Department    = bc.Department;
    d.Number_Pack   = bc.NumberPack;
    d.Shifr_Oper    = "09";
 
    d.Result_Carry = 1;
    d.Kind_Oper = " 1";

    if( not InsertRubDocument( NULL ) )
       msgbox("Ошибка при вставке рублевого документа");
       return 1;
    end;

/*****************************************************
Здесь можно вставлять дополнительные проводки для шага
*****************************************************/
  */
     return 0;

end;
