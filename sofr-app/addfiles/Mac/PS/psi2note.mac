/************************************************************************/
/*         €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank 6.0            */
/*                 Copyright (c) R-Style Software Lab 2004              */
/*                                                                      */
/*  ˆ¬ï ä ©«       : psi2note.mac                                       */
/*                                                                      */
/*  Ž¯¨á ­¨¥       : ‚ë§®¢ ¯¥ç â¨ ¨§¢¥é¥­¨ï ® ¯®¬¥é¥­¨¨ ¢ ª àâ®â¥ªã 2   */
/*                                                                      */
/*  à®£à ¬¬¨áâ    : €­¤à¥¥¢  …..                                      */
/*                                                                      */
/*  ¥à¥¤¥« ­      : 26.03.2004                                         */
/*                                                                      */
/************************************************************************/


import prpm, prreplib, PSInter;

MACRO Print_I2_Note( ncopy:integer ):bool

  var PayerProps   :TPartyProperties = TPartyProperties("Payer",    pr_pmpaym, pr_debet,  pr_pmrmprop);
  var ReceiverProps:TPartyProperties = TPartyProperties("Receiver", pr_pmpaym, pr_credit, pr_pmrmprop);
  var ReceiverName :string;

  ARRAY SBP, SBR, SR;

  /*¥ª¢¨§¨âë ¯« â¥«ìé¨ª */
  PayerProps.Account = pr_pmpaym.rec.PayerAccount;
  PayerProps.BankBIC = {MFO_Bank};
    
  if( pr_pmrmprop.rec.ReceiverINN )
    ReceiverName = pr_pmrmprop.rec.ReceiverINN + " " + pr_pmrmprop.rec.ReceiverName;
  else
    ReceiverName = pr_pmrmprop.rec.ReceiverName;
  end;

  StrSplit( PayerProps.BankName,    SBP, 57, 57, 2 );
  StrSplit( ReceiverProps.BankName, SBR, 57, 57, 2 );
  StrSplit( ReceiverName,           SR,  57, 57, 2 );

  while(ncopy != 0)

[                                                                                        ÚÄÄÄÄÄÄÄ¿ ];
[                                                                                        ³0401075³ ];
[                                                                                        ÀÄÄÄÄÄÄÄÙ ];
[ ˆ‡‚…™…ˆ… N ################                  ##########                                         ](pr_pmrmprop.rec.Number:l, replace(string(pr_pmpaym.rec.I2PlaceDate:f), "-", "."):c);
[ Ž Ž‘’€Ž‚Š… ‚ Š€’Ž’…Š“                      ÄÄÄÄÄÄÄÄÄÄ                                         ];
[                                                  „ â                                             ];
[ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
[ ######################################################### ³ ˆŠ ³ #########                      ](SBP(0):l, PayerProps.BankBIC:l);
[ ######################################################### ³     ³                                ](SBP(1):l);
[  ­ª ¯« â¥«ìé¨ª                                           ³     ³                                ];
[ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄ´                                ];
[ ######################################################### ³ ˆŠ ³ #########                      ](SBR(0):l, ReceiverProps.BankBIC:l);
[ ######################################################### ³     ³                                ](SBR(1):l);
[  ­ª ¯®«ãç â¥«ï                                           ³     ³                                ];
[ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];
[ ######################################################### ³‘ç. N³ #                              ](SR(0):l, ReceiverProps.Account:l);
[ ######################################################### ³     ³                                ](SR(1):l);
[ ®«ãç â¥«ì                                                ³     ³                                ];
[ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ];

if( (pr_pmrmprop.rec.ShifrOper == "02") or (pr_pmrmprop.rec.ShifrOper == "05") )
[ « â¥¦­®¥ âà¥¡®¢ ­¨¥ / ¨­ª áá®¢®¥ ¯®àãç¥­¨¥ (­ã¦­®¥ ¯®¤ç¥àª­ãâì)³         Žâ¬¥âª¨ ¡ ­ª           ];
[ ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                                            ³                                ];
else
[ « â¥¦­®¥ âà¥¡®¢ ­¨¥ / ¨­ª áá®¢®¥ ¯®àãç¥­¨¥ (­ã¦­®¥ ¯®¤ç¥àª­ãâì)³         Žâ¬¥âª¨ ¡ ­ª           ];
[                                                                 ³                                ];
end;
[                                                                 ³                                ];
[ N, ¤ â    ################    ##########                        ³                                ](pr_pmrmprop.rec.Number:r, pr_pmrmprop.rec.Date:f:c);
[                                                                 ³                                ];
[ ­  áã¬¬ã  #                                                     ³                                ](pr_pmpaym.rec.Amount:f:l);
[                                                                 ³                                ];
[ ­¥ ®¯« ç¥­® ¨§-§  ®âáãâ. áà¥¤áâ¢ ­                              ³                                ];
[ áç. N  ###########################                              ³                                ](PayerProps.Account:l);
[                                                                 ³                                ];
[ ];

    ncopy = ncopy - 1;
  end;

  return TRUE;
END;


MACRO PrintDocument(ncopy:integer):bool
  var DocKind:integer = pr_pmpaym.rec.DocKind,
      stat:bool;

  if( DocKind == 261 )
      DocKind = PS_PAYORDER;
  end;

  /* ˆ§¢¥é¥­¨¥ ® ¯®áâ ­®¢ª¥ ¢ ª àâ®â¥ªã */
  if( DocKind == PS_PAYORDER )
    stat = Print_I2_Note( ncopy );
  else
    MsgBox( "„ ­­ë© ¢¨¤ ¤®ªã¬¥­â  ­¥ ¯®¤¤¥à¦¨¢ ¥âáï ¬ ªà®á®¬" );
    stat = FALSE;
  end;
  
  return stat;
END;

/* Žâç¥â "¥ç âì ¨§¢¥é¥­¨©" */
macro PrintNotes_K2_InsertDocs( MapVal :PSRepMap )
  /* „ ­­ë¥ ¯ ­¥«¨ ¯ à ¬¥âà®¢ ®âç¥â */
  var DateIn        :date     = MapVal.Value( "DateIn"       );
  var DateOut       :date     = MapVal.Value( "DateOut"      );
  var DepNum        :integer  = MapVal.Value( "DepNum"       );
  var Oper          :integer  = MapVal.Value( "Oper"         );
  var Account       :string   = MapVal.Value( "Account"      );
  var OutForm       :integer  = MapVal.Value( "iOutForm"     );

  /* ‡ ¯à®á */ 
  var params:TArray  = TArray();
  var select:string = "";

  file r_pmpaym   ("pmpaym.dbt"  ) key 0;
  file r_credit   ("pmprop.dbt"  ) key 0;
  file r_pmrmprop ("pmrmprop.dbt") key 0;

  select = ‚ë¡à âìPaymentID() + FromPMHIST_PMPAYM() + " WHERE ";

  « â¥¦ë«®¬¥é¥­‚_Š2( @select, params, DateIn, DateOut );

  „®¡ ¢¨âì“á«®¢¨¥®‘ç¥âã« â¥«ìé¨ª     ( @select, params, Account );
  „®¡ ¢¨âì“á«®¢¨¥®”¨«¨ «ã« â¥¦       ( @select, params, DepNum  );
  „®¡ ¢¨âì“á«®¢¨¥®Ž¯¥à æ¨®­¨áâã« â¥¦ ( @select, params, Oper    );

  select = select + " ORDER BY pm.t_I2PlaceDate";

  var rs:RsdRecordset = execSQLselect( select, params, FALSE );
  if( rs )
    rs.Command.NullConversion = true;
    while( ( rs.MoveNext() ) and ( rs.value(0) > 0 ) )

      r_pmpaym.PaymentID   = 
      r_credit.PaymentID   = 
      r_pmrmprop.PaymentID = rs.value(0);

      if( GetEQ( r_pmpaym   ) and 
          GetEQ( r_credit   ) and 
          GetEQ( r_pmrmprop ) )

        Copy( pr_pmpaym,   r_pmpaym   );
        Copy( pr_credit,   r_credit   );
        Copy( pr_pmrmprop, r_pmrmprop );
        ClearRecord( pr_debet );

        Print_I2_Note( 1 );

      end;
    end;
  end;

  return 0;

END;
