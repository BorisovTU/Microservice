/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.0           */
/*                 Copyright (c) R-Style Software Lab 2001              */
/*                                                                      */
/*  Имя файла        : bcpcoll.mac                                       */
/*                                                                      */
/*  Описание         : Выполнение шага по списанию средств              */
/*                     c рублевого счета клиента                        */
/*                                                                      */
/*  Операция         : Продажа   валюты                                 */
/*                                                                      */
/*  Программист      : Бурак В.Ю.                                       */
/*                                                                      */
/*  Создан           : 25.05.2001                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
import InsCarryDoc, payinter, "bcall.mac";
import "bc_categ.mac";
/*
RECORD  d(arhdoc);
record  mc(multycar);
*/
/**********************************/
/* Выполнение шага                */
/**********************************/
MACRO ExecuteStep( doc, ps_bcord )
/*
   record bc( ps_bcord );
   record object(account);
   record attr  (account);

   setbuff( bc, ps_bcord );
   setbuff( d, doc );

   // Счета курсовых разниц идут в рублях
   var FD:PSBC_FirstDoc = PSBC_FirstDoc( bc, 0 );

   object.Code_Currency = bc.SourceFIID;
   object.Chapter = 1;
   object.Account = bc.CurrentAccount;

   /* Определяем вид счета по которому пойдёт операция*/
   /*  1 - обязательная  - ТВС   */
   /*  2 - обратная      - СТВС или ТВС */
   var ВидСчетаОперации = 1;
   var err;

   if ( bc.BCOrdSubKind == 2 ) /*обратная продажа*/
      ВидСчетаОперации = ПолучитьТипСчета (bc.SourceAccount, bc.SourceFIID,  1);
   end;

   /* продажа на бирже*/ 
   /* 1 Обязательная продажа валюты клиента на бирже (оно же 2)*/ 

   /*  1.1. */
   ClearRecord(d);
   d.Chapter = 1;
   d.Date_Carry = bc.OrderDate;

   if (ВидСчетаОперации == 1)
      if (not ПолучитьТВС_Клиента (bc.ClientID, bc.SourceFIID, d.Account_Payer))
         d.Account_Payer = "";
      end;
      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else
        d.Account_Receiver = "";  /* Нашли настройку */
      end;
   else
      if (not ПолучитьСТВС_Клиента (bc.ClientID, bc.SourceFIID, d.Account_Payer))
         d.Account_Payer = "";
      end;
      if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
        d.Account_Receiver = attr.Account;  /* Нашли настройку */
      else
        d.Account_Receiver = "";  /* Нашли настройку */
      end;
   end;

   d.Sum    = bc.SourceAmount;
   d.Code_Currency = bc.SourceFIID;
   d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate +  "." +
                        " Депонирование средств для продажи";

   d.Numb_Document = bc.Number;
   d.Department    = bc.Department;
   d.Number_Pack   = bc.NumberPack;
   d.Shifr_Oper    = "09";

   d.Result_Carry = 1;
   d.Kind_Oper = " 1";

   if( not InsertCurDocument( NULL ) )
      msgbox("Ошибка при вставке валютного документа");
      return 1;
   end;


   /* 1.2. - 1.5. Есть только когда конверсия */
   if(( bc.SourceFIID != bc.ExchangeFIID ) and ( bc.ExchangeFIID != 0 ) and ( bc.ExchangeFIID != -1 )and(bc.MarketPlace != PTID_UNKNOWNPARTY))

     SetBuff( mc, doc );
     ClearRecord( mc );
     mc.MethodID = 1;

     mc.FIID_From    = bc.SourceFIID;
     mc.FIID_To      = bc.ExchangeFIID;
     mc.Amount_From  = bc.SourceAmount;

     if ( ConvSum(mc.Amount_To, bc.SourceAmount, bc.OrderDate, bc.SourceFIID, bc.ExchangeFIID, 0) )
         MsgBox("Не найден курс ",ПолучитьКодФинИн(bc.SourceFIID), " относительно ",ПолучитьКодФинИн(bc.ExchangeFIID), " за ", bc.OrderDate);
         return 1;
     end;

     if (ВидСчетаОперации == 1)
        object.Code_Currency = bc.SourceFIID;
        if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
          mc.Account_From = attr.Account;  /* Нашли настройку */
        else
          mc.Account_From = "";  /* Нашли настройку */
        end;

        object.Code_Currency = bc.ExchangeFIID;
        if( not ПолучитьТкВС_Клиента (bc.ClientID, bc.ExchangeFIID, object.Account))
           return 1;
        end;

        if(not GetLinkedObject( OBJROLE_ACC_ORDERBCTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
          mc.Account_To = attr.Account;  /* Нашли настройку */
        else
          mc.Account_To= "";  /* Нашли настройку */
        end;
     else
        object.Code_Currency = bc.SourceFIID;
        if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
          mc.Account_From = attr.Account;  /* Нашли настройку */
        else
          mc.Account_From = "";  /* Нашли настройку */
        end;

        object.Code_Currency = bc.ExchangeFIID;
        if( not ПолучитьТкВС_Клиента (bc.ClientID, bc.ExchangeFIID, object.Account))
           return 1;
        end;

        if(not GetLinkedObject( OBJROLE_ACC_ORDERBCSPTRANSITCUR, OBJTYPE_ACCOUNT, object, OBJTYPE_ACCOUNT, attr ))
          mc.Account_To = attr.Account;  /* Нашли настройку */
        else
          mc.Account_To= "";  /* Нашли настройку */
        end;
     end;

     mc.Chapter       = 1;
     mc.Ground        = "Конверсия в валюту торгов по поручению № " +
                        bc.Number + " от " + bc.OrderDate + ".";
     mc.Numb_Document = bc.Number;;
     mc.Date          = bc.OrderDate;
     mc.Date_Document = bc.OrderDate;
     mc.Number_Pack   = bc.NumberPack;
     mc.Department    = bc.Department;
     mc.ShifrOper     = "09";
/*
     mc.AccOCP_From   = СчетОВПДебет;
     mc.AccOCP_To     = СчетОВПКредит;
*/ 
     //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыДоход, V_STRING, mc.Account1, err );
     //GetRegistryValue( ПутьНастройкиСчетаКурсовойРазницыРасход, V_STRING, mc.Account2, err );

     mc.Account1 = FD.FindAndOpenAccount( "+БМаржаП,ср-ва в ин.вал.", 0, {curdate} );
     mc.Account2 = FD.FindAndOpenAccount( "-БМаржаП,ср-ва в ин.вал.", 0, {curdate} );

     if( not InsertMultiCarry() )
       MsgBox( "Ошибка при вставке мультивалютного документа" );
       return 1; 
     end;

     object.Code_Currency = bc.SourceFIID;
     object.Account = bc.CurrentAccount;
   end;
*/
   /*  1.6. !!!!!!!!!!!!!!!!!!! не ясно какая должна быть сумма !!!!!!!!!!!!!!!!!!!*/ 
   /*
   ClearRecord(d);
   d.Chapter = 1;
   d.Date_Carry = bc.OrderDate;

   if (ВидСчетаОперации == 1)
      if (not ПолучитьТВС_Клиента (bc.ClientID, bc.SourceFIID, d.Account_Payer))
         d.Account_Payer = "";
      end;
   else
      if (not ПолучитьСТВС_Клиента (bc.ClientID, bc.SourceFIID, d.Account_Payer))
         d.Account_Payer = "";
      end;
   end;

   d.Account_Receiver = bc.CurrentAccount;

   d.Sum    = 0;
   d.Code_Currency = bc.SourceFIID;
   d.Ground = "Поручение №" + bc.Number + " от " + bc.OrderDate + "." +
                        " Депонирование средств для продажи";

   d.Numb_Document = bc.Number;
   d.Department    = bc.Department;
   d.Number_Pack   = bc.NumberPack;
   d.Shifr_Oper    = "09";

   d.Result_Carry = 1;
   d.Kind_Oper = " 1";

   if( not InsertCurDocument( NULL ) )
      msgbox("Ошибка при вставке валютного документа");
      return 1;
   end;
   */
   return 0;
end;

