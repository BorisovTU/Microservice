/*
$Name:        waitfmo.mac
$Module:      РКО 
$Description: Макрос шага Ожидание решения Фин. мониторинга
*/
/* ---------------------------------------------------------------------- */
/*         Автоматизированная банковская система RS-Bank v6.0             */
/*                 Copyright (c) R-Style Software Lab                     */
/*                                                                        */
/*  Имя файла  : waitfmo.mac                                              */
/*                                                                        */
/*                                                                        */
/*  Программист: Смахтин А.И.                                             */
/*  Создан     : 15.09.2016                                               */
/*  Описание   : Операция - 3030   - "Открытие лицевого счета"            */
/*               Блок     - 303002 - "Выгрузка сведений об операции в ФМ" */
/*               Шаг      - 85     - "Ожидание решения Фин. мониторинга"  */
/*                                                                        */
/* ---------------------------------------------------------------------- */

import PSInter, FMInter, reqinter, "bnk_common.mac", PaymInter, "bnk_ptlib.mac", InsCarryDoc, pmfm;

var ReqOpenAccObj:RsbReqOpenAcc;

macro ExecuteStep()

  var ErrorMessage:string;

  var rejectAccountObj = RsbFMRejectServiceMessage(OBJTYPE_REQOPENA, String(ReqOpenAccObj.RequestID:34:o));
  var ErrorStatus = rejectAccountObj.GetLastError(ErrorMessage);
  
  if( (not ErrorStatus) and
      (rejectAccountObj.MsgState == RJSRVMSG_STATUS_INITIAL ) or 
      (rejectAccountObj.MsgState == RJSRVMSG_STATUS_FOR_CONTROL) )
    
    MsgBox("Рассмотрение операции в модуле \"Фин. мониторинг\" еще не завершено. Повторите попытку обработать заявление позже" );
    return 1;
 /*такого статуса еще нет, будет позднее
  else if((not ErrorStatus) and
      (rejectAccountObj.MsgState == $(Операция разрешена)))

    ReqOpenAccObj.DenialOpen = "";

    var objFMRjRsns = ReqOpenAccObj.GetObjFMRjRsn();
    var objFMRjRsnSource = TRecHandler("objfmrjrsn.dbt");
    var objFMRjRsn;

    var isNext =  not objFMRjRsns.First( objFMRjRsnSource );  
                                                    
    while(isNext)  
      objFMRjRsns.Delete( objFMRjRsnSource.rec.ID );        
      isNext =  not objFMRjRsns.First( objFMRjRsnSource );  
    end;

    
    if( not InsertOprStatus( REQOPENA_ST_KIND_OO, REQOPENA_ST_OO_NO ) ) 
     MsgBox( "Ошибка при установке статуса операции" );
     return 1;
    end;
    
    if( not InsertOprStatus( REQOPENA_ST_KIND_PT, REQOPENA_ST_PT_NOTNEED ) ) 
     MsgBox( "Ошибка при установке статуса операции" );
     return 1;
    end;
 */
  else
    if( not InsertOprStatus( REQOPENA_ST_KIND_DO, REQOPENA_ST_DO_CLOSED ) ) 
     MsgBox( "Ошибка при установке статуса операции" );
     return 1;
    end;
  end; 
  
  return 0;
end;