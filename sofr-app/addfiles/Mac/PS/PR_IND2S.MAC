
/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : PR_IND2S.MAC

  Description : ‚¥¤®¬®áâì á®áâ®ï­¨ï ª àâ®â¥ª¨ 2 á ®áâ âª ¬¨ ­  áç¥â å

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/

import PSInter, FIInter, globals, prreplib, OprInter, CTInter, CurrInter, "bnk_ptlib.mac";

private var DprtNumber   = -1;
private var DateIn       = date(0,0,0);
private var DateOut      = date(0,0,0);
private var FIID         = -1;
private var ReportKind   = -1;
private var cSetInFonds  = true;
private var cSetRest     = true;
private var cSetA        = true;

/* ­ã¬¥à æ¨ï áã¬¬ ¢ ¬ áá¨¢ å */
private const _UnPaidBeg   = 0,  // ‘ã¬¬  ­¥®¯« ç¥­­ëå ¤®ªã¬¥­â®¢ ­  ­ ç «® ¯¥à¨®¤ 
              _ReceivedDoc = 1,  // ‘ã¬¬  ¯®áâã¯¨¢è¨å ¤®ªã¬¥­â®¢ §  ¯¥à¨®¤
              _CarriedDoc  = 2,  // ‘ã¬¬  ¯à®¢¥¤¥­­ëå ¤®ªã¬¥­â®¢ §  ¯¥à¨®¤
              _UnPaidEnd   = 3,  // ‘ã¬¬  ­¥®¯« ç¥­­ëå ¤®ªã¬¥­â®¢ ­  ª®­¥æ ¯¥à¨®¤ 
              _Rest        = 4;  // áâ â®ª ­  áç¥â¥
/* ¢¨¤ë ¢ë¯ãáª ¥¬®£® ®âç¥â  */
private const ®‚á¥¬« â¥¦ ¬      = 0,
              ®î¤¦¥â­ë¬« â¥¦ ¬ = 1;

private macro GetAmountsI2( DateIn:date, DateOut:date, payms:TArray, amounts:TArray ):integer
  var PartPayments:TArray; 
  var MinusBegSum = $0, EndSum = $0;
  var paym_in_str = "", i = 0, j = 0;
  var select = "", params = TArray();
  Amounts[_UnPaidEnd] = Amounts[_UnPaidBeg] = Amounts[_ReceivedDoc] = Amounts[_CarriedDoc] = Amounts[_Rest] = $0;
  while( i < payms.size ) 
    
    if( payms[i].PartPaymNumMain == "" )   
      Amounts[_UnPaidEnd] = Amounts[_UnPaidEnd] + ‘ã¬¬ ‚‚ «îâ¥‘ç¥â ( payms[i].BaseAmount, DateOut, payms[i] );              
      PartPayments = payms[i].PartPayments();
      paym_in_str = string( payms[i].PaymentID );
      while( j < PartPayments.size )
        paym_in_str = string( paym_in_str + ", " + PartPayments[j].PaymentID );
        j = j + 1;
      end;
               
      select = " SELECT doc.t_AccTrnID "+
               " FROM dacctrn_dbt doc, dpmdocs_dbt pmd"+
             " WHERE doc.t_result_carry     in( 50,51,52,53,74 )       "+
               " AND doc.t_AccTrnID         = pmd.t_AccTrnID           "+
               " AND doc.t_date_carry       <= :DateEnd                "+
               " AND doc.t_state            = 1                        "+ 
               " AND pmd.t_paymentid        in (" + paym_in_str + ")   ";
      params[0] = SQLParam( "DateEnd", DateOut );
      
      var rs:RsdRecordset = execSQLselect( select, params );
      var fCarin:object;
      if( rs )
        rs.Command.NullConversion = true;
        fCarin = TbFile( "acctrn.dbt", "R" );
        while( ( rs.MoveNext() ) and ( rs.value(0) > 0 ) )            
          fCarin.rec.AccTrnID = rs.value(0);
          if( fCarin.GetEQ() )                                        
            if( fCarin.rec.Result_Carry == 50 )
              if( ( fCarin.rec.Date_Carry >= DateIn ) and ( fCarin.rec.Date_Carry <= DateOut ) )
                Amounts[_ReceivedDoc] = Amounts[_ReceivedDoc] + ‘ã¬¬ à®¢®¤ª¨‚‚ «îâ¥‘ç¥â « â¥«ìé¨ª ( fCarin, payms[i], false );
              end;
            else
              if( ( fCarin.rec.Date_Carry >= DateIn ) and ( fCarin.rec.Date_Carry <= DateOut ) )
                Amounts[_CarriedDoc ] = Amounts[_CarriedDoc ] + ‘ã¬¬ à®¢®¤ª¨‚‚ «îâ¥‘ç¥â « â¥«ìé¨ª ( fCarin, payms[i], false );
              end;              
              Amounts[_UnPaidEnd  ] = Amounts[_UnPaidEnd  ] - ‘ã¬¬ ‚‚ «îâ¥‘ç¥â ( fCarin.rec.Sum_Payer, DateOut, payms[i] );
            end;            
          end
        end;
      end;                                             
      Amounts[_UnPaidBeg] = Amounts[_UnPaidEnd] + Amounts[_CarriedDoc] - Amounts[_ReceivedDoc];
    end;
    i = i + 1;
  end;   
  if( FIID == 0/*NATCUR*/)
    Amounts[_Rest] = RestA( payms[0].PayerAccount, DateOut );
  else
    Amounts[_Rest] = RestAC( payms[0].PayerAccount, payms[0].PayerFIID, DateOut );
  end;
  return 0;
end; 

private macro PrintHeader( parm:TPrnReportParm )
[
 #]({Name_Bank});
  var DepCode= "", DepName = "", FICode = "", FIName = "", onDay = IfThenElse( DateIn == DateOut, true, false ),
      Period = "§  " + IfThenElse( DateIn == DateOut, string(DateIn:m), 
                                                     "¯¥à¨®¤ á " + string(DateIn:m) + " ¯® " + string(DateOut:m) );
  CB_GetDepartmentCodeAndName( DprtNumber, DepCode, NULL, DepName );

  var fininstr = TRecHandler("fininstr.dbt");
  if( not ®«ãç¨âì”¨­ˆ­( FIID, fininstr ) )
    FICode = fininstr.rec.FI_Code;
    FIName = fininstr.rec.Name;
  end;

  if( DepName != "" )
[          #####################################################

           ‚¥¤®¬®áâì á®áâ®ï­¨ï ª àâ®â¥ª¨ 2 á ®áâ âª ¬¨ ­  áç¥â å

           #####################################################
           #####################################################

]( string( "â¤¥«¥­¨¥ " + DepCode + "  " + DepName ):c, 
   Period:c, 
   string( "¯® áç¥â ¬ ¢ ¢ «îâ¥ " + FICode + "  " + FIName ):c
 );
    if( cSetRest )
[
 ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³¯¥à ³       ®¬¥à áç¥â        ³‘ã¬¬  ­¥®¯« ç¥­­ëå   ³   ‘ã¬¬  ¯®áâã¯¨¢è¨å  ³   ‘ã¬¬  ¯à®¢¥¤¥­­ëå  ³ ‘ã¬¬  ­¥®¯« ç¥­­ëå   ³   áâ â®ª ­  áç¥â¥   ³
 ³     ³                         ³¤®ªã¬¥­â®¢ ­  ­ ç «® ³ ¤®ªã¬¥­â®¢ §  ###### ³ ¤®ªã¬¥­â®¢ §  ###### ³ ¤®ªã¬¥­â®¢ ­  ª®­¥æ  ³                      ³
 ³     ³                         ³#####################³                      ³                      ³ #####################³                      ³
 ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ]
 ( IfThenElse( onDay, "¤¥­ì", "¯¥à¨®¤" ):l,
   IfThenElse( onDay, "¤¥­ì", "¯¥à¨®¤" ):l,
   string( IfThenElse( onDay, "¤­ï ", "¯¥à¨®¤  " ) + DateIn ):c,
   string( IfThenElse( onDay, "¤­ï ", "¯¥à¨®¤  " ) + DateOut ):c );
    else
[
 ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿                       
 ³¯¥à ³       ®¬¥à áç¥â        ³‘ã¬¬  ­¥®¯« ç¥­­ëå   ³   ‘ã¬¬  ¯®áâã¯¨¢è¨å  ³   ‘ã¬¬  ¯à®¢¥¤¥­­ëå  ³ ‘ã¬¬  ­¥®¯« ç¥­­ëå   ³                         
 ³     ³                         ³¤®ªã¬¥­â®¢ ­  ­ ç «® ³ ¤®ªã¬¥­â®¢ §  ###### ³ ¤®ªã¬¥­â®¢ §  ###### ³ ¤®ªã¬¥­â®¢ ­  ª®­¥æ  ³                         
 ³     ³                         ³#####################³                      ³                      ³ #####################³                       
 ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
 ( IfThenElse( onDay, "¤¥­ì", "¯¥à¨®¤" ):l,
   IfThenElse( onDay, "¤¥­ì", "¯¥à¨®¤" ):l,
   string( IfThenElse( onDay, "¤­ï ", "¯¥à¨®¤  " ) + DateIn  ):c,
   string( IfThenElse( onDay, "¤­ï ", "¯¥à¨®¤  " ) + DateOut ):c );
    end;

  end;

end;

private macro PrintOperHeader( Oper:integer )
  var NameOper : string = GetNameOper(Oper);

  if( cSetRest )
[³     ¯¥à æ¨®­¨áâ:  ##### ######################################################################                                                 ³        
 ÃÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, NameOper );
  else
[³     ¯¥à æ¨®­¨áâ:  ##### ######################################################################                          ³        
 ÃÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, NameOper );
  end;
end;

private macro PrintDocument( PaymentObj:object, amounts:TArray )
  if( cSetRest ) 
    if( cSetA )
[³#####³#########################³#####################³######################³######################³######################³######################³]
( PaymentObj.Oper, PaymentObj.PayerAccount, amounts[_UnPaidBeg]:a, amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a, amounts[_Rest]:a );
    else
[³#####³#########################³#####################³######################³######################³######################³######################³]
( PaymentObj.Oper, PaymentObj.PayerAccount, amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd], amounts[_Rest] );
    end;
  else
    if( cSetA )
[³#####³#########################³#####################³######################³######################³######################³]
( PaymentObj.Oper, PaymentObj.PayerAccount, amounts[_UnPaidBeg]:a, amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a );
    else
[³#####³#########################³#####################³######################³######################³######################³]
( PaymentObj.Oper, PaymentObj.PayerAccount, amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd] );
    end;
  end;
end;

private macro PrintItogOper( Oper:integer, counts:TArray, amounts:TArray )
  if( cSetRest )
    if( cSetA )
[ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ 
 ³ˆâ®£® ¯® ®¯¥à æ¨®­¨áâã   ######³#####################³######################³######################³######################³######################³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, amounts[_UnPaidBeg], amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a, amounts[_Rest]:a );
    else
[ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ 
 ³ˆâ®£® ¯® ®¯¥à æ¨®­¨áâã   ######³#####################³######################³######################³######################³######################³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd], amounts[_Rest] );
    end;
  else
    if( cSetA )
[ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ 
 ³ˆâ®£® ¯® ®¯¥à æ¨®­¨áâã   ######³#####################³######################³######################³######################³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, amounts[_UnPaidBeg]:a, amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a );
    else
[ÃÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ 
 ³ˆâ®£® ¯® ®¯¥à æ¨®­¨áâã   ######³#####################³######################³######################³######################³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´]
( Oper, amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd] );
    end;
  end;
end;

private macro PrintItogDprt( NumDprt:integer, counts:TArray, amounts:TArray )
  if( cSetRest )
    if( cSetA )
[³                                                                                                                                                 ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ˆâ®£® ¯® ¢á¥¬ ®¯¥à æ¨®­¨áâ ¬   ³#####################³######################³######################³######################³######################³
 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
]( amounts[_UnPaidBeg]:a, amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a, amounts[_Rest]:a );
    else
[³                                                                                                                                                 ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ˆâ®£® ¯® ¢á¥¬ ®¯¥à æ¨®­¨áâ ¬   ³#####################³######################³######################³######################³######################³
 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
]( amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd], amounts[_Rest] );
    end;
  else
    if( cSetA )
[³                                                                                                                          ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ˆâ®£® ¯® ¢á¥¬ ®¯¥à æ¨®­¨áâ ¬   ³#####################³######################³######################³######################³
 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
]( amounts[_UnPaidBeg]:a, amounts[_ReceivedDoc]:a, amounts[_CarriedDoc]:a, amounts[_UnPaidEnd]:a );
    else
[³                                                                                                                          ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ˆâ®£® ¯® ¢á¥¬ ®¯¥à æ¨®­¨áâ ¬   ³#####################³######################³######################³######################³
 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
]( amounts[_UnPaidBeg], amounts[_ReceivedDoc], amounts[_CarriedDoc], amounts[_UnPaidEnd] );
    end;
  end;
end;

private macro isBudgetPayment( PaymentObj:RsbPayment ):bool
  var PsPayOrderObj = RsbPSPayOrder( PaymentObj.PaymentID );
  var isBudget:bool = ( ( PaymentObj.Priority == 3 ) or ( PaymentObj.Priority == 4 ) ) and 
                        ( PsPayOrderObj.Categories.IsAttrPresense( OBJ_PAYMENT_GROUP_COMM, 1, null, null, true, {curdate} ) );
  if( cSetInFonds )
    isBudget = isBudget or PsPayOrderObj.Categories.IsAttrPresense( OBJ_PAYMENT_GROUP_COMM, 2, null, null, true, {curdate} );
  end;
  return isBudget;
end;

private macro isZeroTurnAcc( Account:string, FIID:integer, Chapter:integer ):bool

  var isZeroTurn = false;
  record AccRec("account.dbt");
  AccRec.Account       = Account;
  AccRec.Code_Currency = FIID;
  AccRec.Chapter       = Chapter;

  var select:string = " select t_AttrID from dobjlink_dbt    "+  
                      "  where t_ObjectType     = :Type      "+
                      "    and t_GroupID        = :GroupID   "+
                      "    and t_ObjectID       = :ObjectID  ";

  var params:TArray = makeArray( SQLParam( "Type"     , OBJTYPE_ACCOUNT ),
                                 SQLParam( "GroupID"  , OBJROLE_ACC_I2OBACC ),
                                 SQLParam( "ObjectID" , UniID( AccRec, OBJTYPE_ACCOUNT ) ) );
  
  var rset:RsdRecordset = execSQLselect( select, params, TRUE );
  
  var cselect, cparams;// § ¯à®á ¯à®¢®¤®ª ¯® á¢ï§ ­­ë¬ áç¥â ¬ "‚­¥¡ « ­á®¢ë© Š2" ¤«ï áç¥â  Account
  
  while( rset and rset.moveNext() )
    if( RestoreFromUniID( rset.value(0), AccRec, OBJTYPE_ACCOUNT ) )
      cselect = " select * from dacctrn_dbt " +
                "  where t_result_carry in (51,52,53,74) "+
                "    and t_date_carry between :DateIn and :DateOut "+
                "    and t_code_currency = :fiid "+
                "    and ( t_account_payer = :acc1 and t_fiid_payer = :fi1 or t_account_receiver = :acc2 and t_fiid_receiver - :fi2 )";
      cparams = makeArray( SQLParam( "DateIn"   , DateIn                 ),
                           SQLParam( "DateOut"  , DateOut                ),
                           SQLParam( "fiid"     , AccRec.Code_Currency   ),
                           SQLParam( "acc1"     , AccRec.Account         ),
                           SQLParam( "fi1"      , AccRec.Code_Currency   ),
                           SQLParam( "acc2"     , AccRec.Account         ),
                           SQLParam( "fi2"      , AccRec.Code_Currency   ) );
      isZeroTurn = isZeroTurn or existsSQLselect( select, params );
    end;
  end;
  return isZeroTurn;
end;

macro PrintRep_K2_States( MapVal :PSRepMap )

  /* „ ­­ë¥ ¯ ­¥«¨ */
      DateIn                  = MapVal.Value( "DateIn"       );
      DateOut                 = MapVal.Value( "DateOut"      );
      FIID                    = MapVal.Value( "FIID"         );
  var Account       :string   = MapVal.Value( "Account"      );
  var DepNum        :integer  = MapVal.Value( "DepNum"       );
  var NodeNum       :integer  = MapVal.Value( "NodeNum"      );
  var Oper          :integer  = MapVal.Value( "Oper"         );
      cSetRest                = MapVal.Value( "cSetRest"     );
      cSetInFonds             = MapVal.Value( "cSetInFonds"  );
      cSetA                   = MapVal.Value( "cSetA"        );
  var cSetCategory  :bool     = MapVal.Value( "cSetCategory" );
  var cSetZTurn     :bool     = MapVal.Value( "cSetZTurn"    );
  var cSetZBalance  :bool     = MapVal.Value( "cSetZBalance" );
      ReportKind              = MapVal.Value( "ReportKind"   );

  DprtNumber  = IfThenElse( NodeNum > 0, NodeNum, DepNum ); 
  /* ‡ ¯à®á */
  var select:string = " SELECT /*+LEADING(pmh) INDEX(pm, DPMPAYM_DBT_IDX0) INDEX(acc DACCOUNT_DBT_IDX0)*/"+
                      "        pm.t_PaymentID, pm.t_PayerAccount, acc.t_Oper "+
                      "   FROM dpmhist_dbt pmh, dpmpaym_dbt pm "+
             " INNER JOIN daccount_dbt acc ON acc.t_Account        = pm.t_PayerAccount                                   "+
                      "                    AND acc.t_Code_Currency  = pm.t_FIID                                           "+
                      "                    AND acc.t_Code_Currency  = :FIID                                               "+
                      "                    AND acc.t_Chapter        = 1                                                   "+
                      "                    AND acc.t_Department     = :DepNum                                             ";
  if( NodeNum > -1 ) select = select + "   AND acc.t_Branch         = :NodeNum                                            "; end;
  if(    Oper >  0 ) select = select + "   AND acc.t_Oper           = :Oper                                               "; end;
  select = select +   "  WHERE pm.t_I2PlaceDate <> to_date('01010001', 'ddmmyyyy')                                        "+
                      "    AND pm.t_I2PlaceDate <= :DateEnd                                                               "+
                      "    AND pm.t_PartPaymDateMain = to_date('01010001','ddmmyyyy')                                     "+
                      "    AND pm.t_StartDepartment = :DepNum2                                                            ";
  if( cSetCategory or ( ReportKind == ®î¤¦¥â­ë¬« â¥¦ ¬ ) ) select = select +
                      "    AND pm.t_DocKind      = :DocKind                                                               "; end;
  select = select +   "    AND pmh.t_StatusIDTo = :I2Status " +
                      "    AND pmh.t_Date <= :DateEnd2 "+
                      "    AND pmh.t_PaymentID = pm.t_PaymentID "+
                      "    AND pmh.t_AutoKey = ( SELECT MAX(pmh_m.t_AutoKey) "+
                      "                            FROM dpmhist_dbt pmh_m " +
                      "                           WHERE pmh_m.t_StatusIDTo = :I2Status2 "+
                      "                             AND pmh_m.t_PaymentID  = pmh.t_PaymentID "+
                      "                             AND pmh_m.t_date      <= :DateEnd3) "+
                      "    AND NOT EXISTS ( SELECT 1 "+
                      "                       FROM dpmhist_dbt pmh_2 "+
                      "                      WHERE pmh_2.t_date         < :DateBeg "+
                      "                        AND pmh_2.t_PaymentID    = pmh.t_PaymentID "+
                      "                        AND pmh_2.t_AutoKey      > pmh.t_AutoKey "+
                      "                        AND pmh_2.t_StatusIDFrom = :I2Status3) "+
                      "ORDER BY acc.t_Oper, pm.t_PayerAccount, pm.t_I2PlaceDate                                           ";
                  
  var params:TArray = TArray();
  params[params.size] = SQLParam( "FIID"       , FIID         );
  params[params.size] = SQLParam( "DepNum"     , DepNum       );
  if( NodeNum > -1 )
  params[params.size] = SQLParam( "NodeNum"    , NodeNum      );
  end;
  if( Oper > 0 )
  params[params.size] = SQLParam( "Oper"       , Oper         );
  end;
  params[params.size] = SQLParam( "DateEnd"    , DateOut      );
  params[params.size] = SQLParam( "DepNum2"    , DepNum       );
  if( cSetCategory or ( ReportKind == ®î¤¦¥â­ë¬« â¥¦ ¬ ) )
  params[params.size] = SQLParam( "DocKind"    , PS_PAYORDER  );
  end;
  params[params.size] = SQLParam( "I2Status"   , PM_I2PLACED  );
  params[params.size] = SQLParam( "DateEnd2"   , DateOut      );
  params[params.size] = SQLParam( "I2Status2"  , PM_I2PLACED  );
  params[params.size] = SQLParam( "DateEnd3"   , DateOut      );
  params[params.size] = SQLParam( "DateBeg"    , DateIn       );
  params[params.size] = SQLParam( "I2Status3"  , PM_I2PLACED  );
  BegAction(2000, "‚¥¤®¬®áâì á®áâ®ï­¨ï ª àâ®â¥ª¨ 2", false);
  var rs:RsdRecordset = execSQLselect( select, params, FALSE );

  /* „ ­­ë¥ § ¯à®á  */
  var I2StateReport   :object = NULL;
  var Payments        :TArray = TArray(), SameAccPayms = TArray();
  var Amounts         :TArray = TArray();
  var PsPayOrderObj   :object = NULL,
      PaymentObj      :object = NULL, i = 0, isSet = true;
  var PayerAccount = "";
  if( rs )
    rs.Command.NullConversion = true;   
    while( ( rs.MoveNext() ) and ( rs.value(0) > 0 ) ) 
      PaymentObj = RsbPayment( rs.value(0) );
      // ä¨«ìâà æ¨ï ¯® ª â¥£®à¨ï¬
      if( cSetCategory and ( MapVal.Size > 14 ) ) 
        PsPayOrderObj = RsbPSPayOrder( rs.value(0) );
        while( ( i <= int( ( MapVal.Size - 14 )/2 - 1 ) ) and isSet )
          isSet = PsPayOrderObj.Categories.IsAttrPresense( MapVal.Value( string( "GroupID" + i ) ), 
                                                           MapVal.Value( string( "AttrID"  + i ) ), null, null, true, {curdate} );
          i = i + 1;
        end;
        i = 0;
      end;      
      // ¯à®¢¥à¨¬ ®â®¡à ­­ë¥ ¯« â¥¦¨ ¥é¥ ­  á®®â¢¥âáâ¢¨¥ ä« ¦ª ¬ ¢ ¯ ­¥«¨
      if( ( ( cSetCategory == false ) or                     /* ¤«ï [•] ¢ Š â¥£®à¨¨ - â®«ìª® ¯« â¥¦¨ á ãáâ ­®¢«¥­­®© ª â¥£®à¨¥© */
            (        isSet == true  ) )                      and

          ( ( ReportKind == ®‚á¥¬« â¥¦ ¬ ) or              /* ¤«ï ®âç¥â  ¯® î¤¥¦¥â­ë¬ - â®«ìª® ¡î¤¦¥â­ë¥ ¯« â¥¦¨ */
            ( isBudgetPayment( PaymentObj ) ) )              and

          ( ( cSetZBalance == false ) or                     /* ¥ ¢ë¢®¤¨âì áç¥â  á ­ã«¥¢ë¬¨ ®áâ âª ¬¨ */
            ( RestA( PaymentObj.PayerAccount, DateOut ) ) )  and

          ( ( cSetZTurn == false ) or                        /* ¥ ¢ë¢®¤¨âì ­ã«¥¢ë¥ ®¡®à®âë */
            ( isZeroTurnAcc( PaymentObj.PayerAccount, PaymentObj.PayerFIID, PaymentObj.Chapter ) ) )
        
        )
        // â¥¯¥àì ¯« â¥¦¨ á ®¤¨­ ª®¢ë¬ PayerAccount á£àã¯¯¨àã¥¬ ¢ ¬ áá¨¢ SameAccPayms
        if( ( rs.value(1) == PayerAccount ) or ( SameAccPayms.Size == 0 ) )
          PayerAccount                       = rs.value(1);
          PaymentObj.Oper                    = rs.value(2); // ¢à¥¬¥­­® ¨§¬¥­¨¬ ®¯¥à  ¯« â¥¦  ­  ®¯¥à  áç¥â  - â ª ­ ¤® ¤«ï ®âç¥â 
          SameAccPayms[SameAccPayms.Size]    = PaymentObj;
        else 
          PayerAccount             = rs.value(1);
          Payments[Payments.Size]  = SameAccPayms[0]; 
          Amounts[Amounts.Size]    = TArray();
          // ¯® ª ¦¤®¬ã SameAccPayms ¯®¤áç¨â ¥¬ áã¬¬ë
          GetAmountsI2( DateIn, DateOut, SameAccPayms, Amounts[Amounts.Size-1] );
          // íâ® ã¦¥ ­®¢ë© SameAccPayms
          PaymentObj.Oper = rs.value(2);
          SameAccPayms    = TArray();
          SameAccPayms[0] = PaymentObj;
        end;
      end;
    end;
    if( SameAccPayms.Size > 0 )
      SameAccPayms[0].Oper    = rs.value(2);
      Payments[Payments.Size] = SameAccPayms[0];
      Amounts[Amounts.Size]   = TArray();
      GetAmountsI2( DateIn, DateOut, SameAccPayms, Amounts[Amounts.Size-1] );
    end;
  end; 

  EndAction();
  I2StateReport = TPSReportPayments( "‚¥¤®¬®áâì á®áâ®ï­¨ï ª àâ®â¥ª¨ 2", "PR_IND2S.mac", Payments, Amounts, DateIn, DateOut, DepNum, Oper );
  I2StateReport.PrintPSReportPayments();

end;
