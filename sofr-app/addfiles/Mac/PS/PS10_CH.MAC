import          PaymInter;

/*--------------------------------------------------------------------------------------\
|       Макрос проверки первичного документа до инициализации операции                  |
\--------------------------------------------------------------------------------------*/
macro   InitOperation( KindOp, KindDoc, order )
    /*
        Var             bal;

        record          bo(ps_bcord);
        record          Bpayment( pmpaym );
        record          Kpayment( pmpaym );
        file            ac( account );
        file            acc("account$.dbt");


        SetBuff( bo, order );

        /* Найти платеж по базовому финансовому инструменту */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                1,      /* Базовый актив                */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                false,
                Bpayment,

        )       !=      0 )

                MsgBox( "Не могу найти платеж по зачислению валюты" );
                return  1;
        end;

        /* Найти платеж по контрактиву */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                2,      /* Контрактив                   */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                false,
                Kpayment

        )       !=      0 )

                MsgBox( "Не могу найти платеж по контрактиву" );
                return  2;
        end;

        /*      Счета клиента должны быть открыты на балансовом счете 405-408
                Валютный счет должен иметь признак "Спецтранзитный"
        */
        ac.Chapter = 1;
        ac.Account = Kpayment.PayerAccount;
        if ( not geteq(ac) )
                MsgBox( "Счет " + Kpayment.PayerAccount + "  не найден в списке счетов");
                return 3;
        else
                bal = SubStr( ac.Balance, 1, 3 );
                if (    (bal != "405")    And   (bal != "406")    And     
                        (bal != "407")    And   (bal != "408")          )
                        MsgBox( "Счет плательщика должен быть открыт на балансовом счете 405 - 408" );
                        return 4;
                end;        
        end;


        acc.Chapter = 1;
        acc.Account = Bpayment.ReceiverAccount;
        acc.Code_Currency = Bpayment.FIID;
        if ( not geteq(acc) )
                MsgBox( "Счет " + Bpayment.ReceiverAccount + "  не найден в списке счетов");
                return 5;
        else
                bal = SubStr( acc.Balance, 1, 3 );
                if (    (bal != "405")    And     (bal != "406")    And     
                        (bal != "407")    And     (bal != "408")        )
                        MsgBox( "Счет получателя должен быть открыт на балансовом счете 405 - 408" );
                        return 6;
                end;        

                /*      Проверить, что счет спецтранзитный      */
                if ( index(acc.Type_Account, "D") == 0 )
                        MsgBox( "Счет " + Bpayment.ReceiverAccount + " не имеет системного типа \"Спец.транзитный счет\" ");
                        return 7;
                end;
        end;
    */
        return  0;

end;