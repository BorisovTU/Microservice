IMPORT  OprInter;
IMPORT  "gstname.mac";

RECORD pm_oprstep( oprstep );

const Ошибка   = 0,
      Первый   = 1,
      Последний= 2;

PRIVATE MACRO GetNumber( ID_Operation:integer, Number:string ):bool
  var query:string = " SELECT checkiss.t_number " +
                       " FROM doproper_dbt oproper, dcheckiss_dbt checkiss " +
                      " WHERE oproper.t_id_operation = :id_operation " +
                        " AND TO_NUMBER (oproper.t_documentid) = checkiss.t_orderid ";                                

  var params:TArray = TArray();
  params[params.size] = SQLParam( "id_operation", ID_Operation);
  var rset:RsdRecordset = execSQLselect( query, params, true );

  if( rset and rset.moveNext() )
    SetParm(1, rset.value(0));
    return true;
  end;

  return false;
END; 

MACRO Печать_ОтчетСканирования( Вызов, firstdoc, Статус, Сообщение )
   var Number:string = "";

   setbuff( pm_oprstep, firstdoc );

    if (Вызов==Первый)
[             Отчет о групповом помещении документов в отвергнутые];
[+---------+--------+---------------------------------------------------------+];
[|    №    |   №    |                 Сообщение                               |];
[|документа| ошибки |                                                         |];
[+---------+--------+---------------------------------------------------------+];
    elif (Вызов==Ошибка)
        if (Статус == 0)
            Сообщение = "Документ успешно помещен в отвергнутые"
        end;
        
        if( NOT GetNumber( pm_oprstep.ID_Operation, Number ) )
          Сообщение = "Не найдено заявление";
        end;
    
[|#########|########|#########################################################|](Number, Статус, StrSubst(Сообщение, "|", " " ):w);

        elif (Вызов==Последний)         
[+---------+--------+---------------------------------------------------------+];
    end;
END;