/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : pr_inopa.mac
  Created     : 10.02.2007
  Programmer  : á¬ ª®¢áª¨© ….‚.
  Description : ¥ç âì á¯à ¢ª¨ ª«¨¥­âã ®¡ ®âªàëâ¨¨ áç¥â 

ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/

import reqinter,prreqbuf;

private class DataTabAcc
   var Account:string,
   Code_Currency:integer,
   Type_Account:string,
   Account_SubType:string;

   Account = "";
   Code_Currency = -1;
   type_Account = "";
   Account_SubType = "";


end; 

private macro FillAccMasFromUniID( ID_Operation:integer , MasAcc:TArray , HaveAccSubType:@bool )

   var select,
       rs,
       i,
       params:TArray  = TArray(),
       Tb_Account,
       Tb_AccountC,
       buf:DataTabAcc;

       HaveAccSubType = false;

   record RecAcc( account );

   Tb_Account = Tbfile("account.dbt", "R", 0);

   select = "select doc.t_DocumentID " +
            "from doprdocs_dbt doc "+
            "where doc.T_ID_OPERATION = :ID_Operation " +
            "and doc.t_DocKind = 3 ";  //DLDOC_ACCOUNT

   params[params.size] = ( SQLParam( "ID_Operation" , ID_Operation ));

   rs = execSQLselect( select, params, FALSE );
   i = 0;
   while( rs and rs.MoveNext())
      
      RestoreFromUniID( rs.value(0), RecAcc, OBJTYPE_ACCOUNT, 3 );
       
      Tb_Account.Clear();

      Tb_Account.rec.Chapter = RecAcc.Chapter;
      Tb_Account.rec.Code_Currency = RecAcc.Code_Currency;
      Tb_Account.rec.Account = RecAcc.Account;

      Tb_Account.GetEQ;
      if( not Index(Tb_Account.rec.Type_Account ,""))

        buf = DataTabAcc();

        buf.Account = Tb_Account.rec.Account;
        buf.Code_Currency = Tb_Account.rec.Code_Currency;
        buf.Type_Account = Tb_Account.rec.Type_Account;
      
        MasAcc[i] =  buf;
        i = i + 1;
      end;
   end;

   if( i == 0 )

    buf = DataTabAcc();             
    
    buf.Account       = pr_reqopena.rec.Account;
    buf.Code_Currency = pr_reqopena.rec.Code_Currency;
    buf.Type_Account  = pr_reqopena.rec.Type_Account;
    MasAcc[i] =  buf;
   
   end;

end;

private macro Print_Header(CustomerName , HaveAccSubType)
[                                                                                             ];
[ #####################################################################                       ]({Name_Bank});
[                                                                                ãª®¢®¤¨â¥«î ];
[                                                   ######################################### ](CustomerName:r);
[                                                                                             ];
[  áâ®ïé¨¬ ¨§¢¥é ¥¬ ¢ á, çâ® ########## ¢ è¥© ã¢ ¦ ¥¬®© ®à£ ­¨§ æ¨¨ ®âªàëâë á«¥¤ãîé¨¥ áç¥â : ]({curdate});
[   ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»                                 ];
[   º      Œ… ‘—…’€       ³           ’ˆ ‘—…’€          º                                 ];
[   ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶                                 ];

end;


private macro Print_Doc2( Account , Account_Type )

[   º ###################### ³ ############################ º ](Account:c , Account_Type:c);

end;

private macro Print_LineDoc2()
                                                            
[   ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶ ];
    
end;

private macro Print_Itog( €‡…˜…ˆ…_”ˆ , HaveAccSubType)
[   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼                                 ];

[                                                                                             ];
[ ƒ« ¢­ë© ¡ãå£ «â¥à   _______________  / ########################################### /        ]( €‡…˜…ˆ…_”ˆ:c);
[                                                                                             ];
end;

private macro GetID_Operation( TR_Reqopena , ObjType , DocKind):integer

   var BufDocID:string,
       Tb_oproper;

   record RecReqopena( reqopena );
   Copy( RecReqopena, TR_Reqopena );

   BufDocID = UniID( RecReqopena , ObjType , DocKind);


   Tb_oproper = Tbfile("oproper.dbt", "R", 1);
   Tb_oproper.rec.DocumentID = BufDocID;
   Tb_oproper.rec.DocKind = DocKind;

   GetEQ(Tb_oproper);
   
   return Tb_oproper.rec.ID_Operation;

end;

macro PrintDocument( nCopy:integer ):bool
      
   var MasAcc:TArray  = TArray(),
       CustomerName,
       HaveAccSubType,
       €‡…˜…ˆ…_”ˆ,
       errcode = 0, i,k,
       Name_Account_Type,
       ID_Operation,
       TR_party:TRecHandler = TRecHandler( "party.dbt"  , "bank.def" );

   ID_Operation = GetID_Operation( pr_reqopena , 0 , 230 );
   FillAccMasFromUniID( ID_Operation , MasAcc , @HaveAccSubType);
  
   i = 0;
   if( MasAcc.size )
      if(GetPartyRec(pr_reqopena.rec.ClientID,TR_party))
         CustomerName = TR_party.rec.ShortName;
      else
         CustomerName = "";
      end;
      if( GetRegValForOPENAC( "€‡…˜…ˆ…_”ˆ", V_STRING, €‡…˜…ˆ…_”ˆ ) )
         €‡…˜…ˆ…_”ˆ = "";
      end;
      k = 0;
      while(k < nCopy)

         Print_Header( CustomerName, HaveAccSubType);

         i = 0;
         while( i < MasAcc.size )
            Name_Account_Type = GetTypeAcc( MasAcc[i].Code_Currency, MasAcc[i].Type_Account);
               Print_Doc2( MasAcc[i].Account , Name_Account_Type );
               if( ( i + 1 ) !=  MasAcc.size )
                  Print_LineDoc2();
               end;

            i = i + 1;
         end;

         Print_Itog( €‡…˜…ˆ…_”ˆ , HaveAccSubType);
         k = k + 1;

      end;
   else
      msgbox("¥ ­ ©¤¥­ áç¥â"); 
   end;

   return true;
end;    
