import          InsCarryDoc, payinter;

/*------------------------------------------------------------------------------------\
|                       Возврат депонированных средств клиента                        |
|                       (выполняется в случае отказа на конвертацию)                  |
|                                                                                     |
|       Дт47405.810 - Кр40702.810 ( Сумма заявки * Курс депонирования )               |
|                                                                                     |
|                                                                                     |
\------------------------------------------------------------------------------------*/


macro   ExecuteStep( doc, order )
/*
        Var             Account_Payer,
                        Account_Receiver;

        record          bo(ps_bcord);
        record          payment( pmpaym );
        record          d (arhdoc);
        record          RecAcc( account );
        file            Bl( balance );

        SetBuff( bo, order );


        /* Найти платеж по контрактиву */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                2,      /* Контрактив                   */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                true,
                payment

        )       !=      0 )

                MsgBox( "Не могу найти платеж" );
                return  1;
        end;
        
        Account_Receiver = payment.PayerAccount;


        /*
                Проверить лицевой счет
        */
        if ( CheckAccount( 
                        213,                    /* Тип счета */
                        Account_Payer,          /* В случае успеха, сюда вернется номер счета*/
                        payment.FIID,           /* Код валюты */
                        1                       /* Глава */
                        )  !=  0 )
                return  3;
        end;


        SetBuff( d, doc );
        ClearRecord(d);
        
        d.Chapter = 1;
        d.Code_Currency = payment.FIID;
        d.Account_Payer = Account_Payer;
        d.Account_Receiver = Account_Receiver;
        d.Result_Carry = 1;

        d.Kind_Oper = " 1";
        d.Shifr_Oper = "09";

        d.Sum = payment.Amount;

        d.Date_Carry       = {curdate};

        d.Ground = "Заявка на конвертацию валюты № " + String( bo.Number ) + ". Возврат средств клиента в связи с отказом в конвертации.";

        if ( d.Code_Currency == 0 )
                if( not InsertRubDocument( NULL, payment.PaymentID ))
                   msgbox("Ошибка при вставке рублевого документа");
                   return 1;
                end;
        else
                if( not InsertCurDocument( NULL, payment.PaymentID ))   
                   msgbox("Ошибка при вставке валютного документа");
                   return 1;
                end;
        end;

        /*      Установить статус платежа - отвергнут   */
        InsertPaymentStat( payment.PaymentID, PM_REJECTED );

        /* Найти платеж по активу */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                1,      /* Контрактив                   */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                true,
                payment

        )       !=      0 )

                MsgBox( "Не могу найти платеж" );
                return  2;
        end;

        /*      Установить статус платежа - отвергнут   */
        InsertPaymentStat( payment.PaymentID, PM_REJECTED );
    */
        return 0;

end;