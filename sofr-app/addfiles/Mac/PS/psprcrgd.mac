/*
  $Name:         psprcrgd.mac
  $Module:       êäé
  $Description:  å†™‡Æ· Æ°‡†°Æ‚™® ‡•Ë•≠®Ô ‡•£®·‚‡†Ê®Æ≠≠Æ£Æ Æ‡£†≠†
*/

/*******************************************************************************/
/*                   R-Style SoftWare Lab, RS-Bank 6.0                         */
/*******************************************************************************/
/*                  èÆ§·®·‚•¨† "êäé"                                           */
/* è‡ÆÊ•§„‡† Æ°‡†°Æ‚™® ‡•Ë•≠®Ô ‡•£®·‚‡†Ê®Æ≠≠Æ£Æ Æ‡£†≠†                         */
/*                                                                             */
/*  à¨Ô ‰†©´†: psprcrgd.mac                                                    */
/*  ëÆß§†≠:    27.04.11                                          Popova O.     */
/*******************************************************************************/

import oralib, likepy, MesInter, "psprcrgd_RP.mac", "psprcrgd_AP.mac";

private macro GetStateName( DecisionID:integer )
  var select = "select st.t_Name "+
               "   from dwlstatus_dbt st, " +
               "        dwlregdec_dbt rg  " +
               "  where rg.t_DecisionID = ? "+
               "    and st.t_State      = rg.t_State "+
               "    and st.t_TypeState  = 27 ";
  var params = makeArray( SQLParam( "", DecisionID ) );
  var rs = execSQLselect( select, params, FALSE );
  while( rs.MoveNext() )
    return rs.value(0);
  end;
  return "";
end;

//------------------------------------------------------------------------
// èÆ·‚‚‡†≠ß†™Ê®Æ≠≠†Ô Á†·‚Ï Ø‡ÆÊ•§„‡Î Æ°‡†°Æ‚™® ‡•Ë•≠®Ô ‡•£.Æ‡£†≠†   
// ÇÎ¢Æ§ Æ‚Á•‚†
//------------------------------------------------------------------------
private var RegDecisionsRPOProcess = TArray();
private var RegDecisionsROOProcess = TArray();
private var RegDecisionsAPNProcess = TArray();
private var RegDecisionsAPOProcess = TArray();
private var RegDecisionsAPZProcess = TArray();

private macro TableHeader( Type:integer );
[ ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒø               
  ≥      çÆ¨•‡ ‡•Ë•≠®Ô      ≥ Ñ†‚† ‡•Ë.≥Ñ†‚† ØÆ´„Á.≥#############################≥                è‡®¨•Á†≠®•              ≥   ë‚†‚„·   ≥
  ≥                         ≥          ≥           ≥#############################≥                                        ≥            ≥
  √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥]
( IfThenElse( Type == WLD_TYPE_REGDEC_RPO, "ë‰Æ‡¨®‡Æ¢†≠Î Ø‡•‚•≠ß®®", "çÆ¨•‡ ·Á•‚†" ):c, 
  IfThenElse( Type == WLD_TYPE_REGDEC_RPO, "ØÆ ·Á•‚†¨", "" ):c );
end;

private macro TableRow( NumDec, DateDec, DateRec, Account, Description, StateDec )
[ ≥ ####################### ≥##########≥###########≥#############################≥########################################≥############≥]
( NumDec, DateDec:c, DateRec:c, Account:c, Description:w, StateDec:c );
end;

private macro PrintRegDecAccounts( rgd )
  var select = " select NVL(t_Account, chr(1)), NVL(t_Message, chr(1)) " +
               "   from dwlrepclm_tmp" +
               "  where t_DecisionID = " + string( rgd.DecisionID );
  var rs = execSQLselect( select, NULL, FALSE );
  var isFirst = true;    
  while( rs.MoveNext() )                                         
    TableRow( IfThenElse( isFirst, rgd.Number, "" ), IfThenElse( isFirst, date(rgd.Date), "" ), 
              IfThenElse( isFirst, date(rgd.DeliveryDate), "" ), string( rs.value( 0/*"t_Account"*/ ) ), 
              rs.value( 1/*"t_Message"*/ ), IfThenElse( isFirst, GetStateName( rgd.DecisionID ), "" ) );
    isFirst = false;
  end;
end;

private macro PrintReportRegDecisionProcess()

  if( ( RegDecisionsRPOProcess.size > 0 ) or ( RegDecisionsROOProcess.size > 0 ) or
      ( RegDecisionsAPNProcess.size > 0 ) or ( RegDecisionsAPOProcess.size > 0 ) or
      ( RegDecisionsAPZProcess.size > 0 )
    )
[
    
    è‡Æ‚Æ™Æ´ Ø‡ÆÊ•§„‡Î Æ°‡†°Æ‚™® ‡•Ë•≠®© ‡•£®·‚‡†Ê®Æ≠≠ÎÂ Æ‡£†≠Æ¢ 

    Ñ†‚† Æ‚Á•‚†: #############
    à·ØÆ´≠®‚•´Ï: ##### # ]( {curdate}, {oper}, {Name_Oper} );

    var i = 0;
    if( RegDecisionsRPOProcess.size > 0 )

[
    ê•Ë•≠®Ô Æ Ø‡®Æ·‚†≠Æ¢´•≠®® ÆØ•‡†Ê®© ØÆ ·Á•‚†¨ ];
      TableHeader( WLD_TYPE_REGDEC_RPO );
      while( i < RegDecisionsRPOProcess.size )
        PrintRegDecAccounts( RegDecisionsRPOProcess[i] );
        if( i < RegDecisionsRPOProcess.size - 1 )
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
        else
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒŸ];
        end;
        i = i + 1;
      end;
    end;

    if( RegDecisionsROOProcess.size > 0 )
      i = 0;
[
    ê•Ë•≠®Ô Æ° Æ‚¨•≠• Ø‡®Æ·‚†≠Æ¢´•≠®© ÆØ•‡†Ê®© ØÆ ·Á•‚†¨ ];
      TableHeader( WLD_TYPE_REGDEC_ROO );
      while( i < RegDecisionsROOProcess.size )
        PrintRegDecAccounts( RegDecisionsROOProcess[i] );
        if( i < RegDecisionsROOProcess.size - 1 )
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
        else
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒŸ];
        end;
        i = i + 1;
      end;
    end;

    if( RegDecisionsAPZProcess.size > 0 )
      i = 0;
[
    ê•Ë•≠®Ô Æ° Æ‚ßÎ¢• ØÆ‡„Á•≠®© çé ];
      TableHeader( WLD_TYPE_REGDEC_APZ );
      while( i < RegDecisionsAPZProcess.size )
        PrintRegDecAccounts( RegDecisionsAPZProcess[i] );
        if( i < RegDecisionsAPZProcess.size - 1 )
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
        else
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒŸ];
        end;
        i = i + 1;
      end;
    end;

    if( RegDecisionsAPNProcess.size > 0 )
      i = 0;
[
    ê•Ë•≠®Ô Æ Ø‡®Æ·‚†≠Æ¢´•≠®® §•©·‚¢®Ô ØÆ‡„Á•≠®© çé ];
      TableHeader( WLD_TYPE_REGDEC_APN );
      while( i < RegDecisionsAPNProcess.size )
        PrintRegDecAccounts( RegDecisionsAPNProcess[i] );
        if( i < RegDecisionsAPNProcess.size - 1 )
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
        else
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒŸ];
        end;
        i = i + 1;
      end;
    end;

    if( RegDecisionsAPOProcess.size > 0 )
      i = 0;
[
    ê•Ë•≠®Ô Æ ¢ÆßÆ°≠Æ¢´•≠®® §•©·‚¢®Ô ØÆ‡„Á•≠®© çé ];
      TableHeader( WLD_TYPE_REGDEC_APO );
      while( i < RegDecisionsAPOProcess.size )
        PrintRegDecAccounts( RegDecisionsAPOProcess[i] );
        if( i < RegDecisionsAPOProcess.size - 1 )
[ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¥];
        else
[ ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒŸ];
        end;
        i = i + 1;
      end;
    end;
    return 0;
  end;
  return 1;

end;

macro PostProcessRegDecisionTrn() 

  var select = " select *" +
               "   from dwlregdec_dbt rgd" +
               "  where rgd.t_DecisionID in ( select rep.t_DecisionID from dwlrepclm_tmp rep ) ";

  var rs = TRsbDataSet( select );

  while( rs.MoveNext() )
    if( rs.Type == WLD_TYPE_REGDEC_RPO )
      RegDecisionsRPOProcess[RegDecisionsRPOProcess.size] = rs.rec;
    elif( rs.Type == WLD_TYPE_REGDEC_ROO )
      RegDecisionsROOProcess[RegDecisionsROOProcess.size] = rs.rec;
    elif( rs.Type == WLD_TYPE_REGDEC_APN )
      RegDecisionsAPNProcess[RegDecisionsAPNProcess.size] = rs.rec;
    elif( rs.Type == WLD_TYPE_REGDEC_APO )
      RegDecisionsAPOProcess[RegDecisionsAPOProcess.size] = rs.rec;
    elif( rs.Type == WLD_TYPE_REGDEC_APZ )
      RegDecisionsAPZProcess[RegDecisionsAPZProcess.size] = rs.rec;
    end;
  end;

  return PrintReportRegDecisionProcess();
end;

const   éË®°™†    = 0,
        è•‡¢Î©    = 1,
        èÆ·´•§≠®© = 2;

MACRO è•Á†‚Ï_é‚Á•‚ë™†≠®‡Æ¢†≠®Ô( ÇÎßÆ¢, firstdoc, ë‚†‚„·, ëÆÆ°È•≠®• )

  var WldRegDecHandler = TRecHandler("wlregdec");

  if( ÇÎßÆ¢ == éË®°™† )
    setbuff( wlregdec, firstdoc );
    copy( WldRegDecHandler, wlregdec );
    if( wlregdec.Type == WLD_TYPE_REGDEC_RPO )
      RegDecisionsRPOProcess[RegDecisionsRPOProcess.size] = WldRegDecHandler.rec;
    elif( wlregdec.Type == WLD_TYPE_REGDEC_ROO )
      RegDecisionsROOProcess[RegDecisionsROOProcess.size] = WldRegDecHandler.rec;
    elif( wlregdec.Type == WLD_TYPE_REGDEC_APN )
      RegDecisionsAPNProcess[RegDecisionsAPNProcess.size] = WldRegDecHandler.rec;
    elif( wlregdec.Type == WLD_TYPE_REGDEC_APO )
      RegDecisionsAPOProcess[RegDecisionsAPOProcess.size] = WldRegDecHandler.rec;
    elif( wlregdec.Type == WLD_TYPE_REGDEC_APZ )
      RegDecisionsAPZProcess[RegDecisionsAPZProcess.size] = WldRegDecHandler.rec;
    end;
    return 0;

  elif( ÇÎßÆ¢ == èÆ·´•§≠®© )
    return PrintReportRegDecisionProcess();
  end;

  return 0;
END;
