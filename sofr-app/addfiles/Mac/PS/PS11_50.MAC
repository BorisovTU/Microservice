import          InsCarryDoc, payinter;
/*------------------------------------------------------------------------------------\
|                       Постановка на внебалансовый учет                              |
|               для операции продажи валюты по поручению клиента                      |
\------------------------------------------------------------------------------------*/
macro   ExecuteStep( doc, order )
/*
        Var     Account_Payer,
                Account_Receiver,
                Account_OCP,
                Acc1,
                Acc2;
        

        record          bo(ps_bcord);
        record          paymentB( pmpaym );
        record          paymentK( pmpaym );
        record          mc(multycar);

        SetBuff( bo, order );


        /* Найти платеж по базовому активу */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                1,      /* базовый актив                */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                true,
                paymentB

        )       !=      0 )

                MsgBox( "Не могу найти платеж по базовому активу" );
                return  1;
        end;

        /* Найти платеж по контрактиву */
        if ( FindPayment( 
                0,      /* Индентификатор неизвестен    */
                2,      /* Контрактив                   */
                0,      /* Subpurpose                   */
                bo.dockind,
                bo.orderid,
                true,
                paymentK

        )       !=      0 )

                MsgBox( "Не могу найти платеж по контрактиву" );
                return  2;
        end;
        

        /*
                Проверить лицевой счет (требования банка)
        */
        if ( CheckAccount( 
                128,            /* Тип счета */
                Account_Payer,  /* В случае успеха, сюда вернется номер счета*/
                paymentB.FIID,  /* Код валюты */
                4               /* Глава        */
                )  !=  0 )
                return  3;
        end;


        /*
                Проверить лицевой счет (обязательства банка)
        */
        if ( CheckAccount( 
                133,              /* Тип счета  */
                Account_Receiver, /* В случае успеха, сюда вернется номер счета*/
                paymentK.FIID,    /* Код валюты */
                4                 /* Глава      */
                )  !=  0 )
                return  4;
        end;


        /*
                Проверить лицевой счет (ОВП)
        */
        if ( CheckAccount( 
                203,            /* Тип счета */
                Account_OCP,    /* В случае успеха, сюда вернется номер счета*/
                paymentB.FIID,  /* Код валюты */
                4               /* Глава        */
                )  !=  0 )
                return  4;
        end;


        /*
                Проверить лицевой счет (нереал. положительные курсовые разницы)
        */
        if ( CheckAccount( 
                140,            /* Тип счета */
                Acc1,           /* В случае успеха, сюда вернется номер счета*/
                0,              /* Код валюты */
                4               /* Глава        */
                )  !=  0 )
                return  5;
        end;

        /*
                Проверить лицевой счет (нереал. отрицательные курсовые разницы)
        */
        if ( CheckAccount( 
                139,            /* Тип счета */
                Acc2,           /* В случае успеха, сюда вернется номер счета*/
                0,              /* Код валюты */
                4               /* Глава        */
                )  !=  0 )
                return  5;
        end;



        /*
                Подготовить мультивалютную проводку
        */
        SetBuff( mc, doc );
        ClearRecord( mc );
        mc.MethodID = 1;

        mc.FIID_From = paymentK.FIID;
        mc.Amount_From = paymentK.Amount;
        mc.Account_From = Account_Receiver;

        mc.FIID_To = paymentB.FIID;
        mc.Amount_To = paymentB.Amount;
        mc.Account_To = Account_Payer;
        mc.AccOCP_To = Account_OCP; 

        mc.Date = {curdate};
        mc.Chapter = 4;
        mc.Account1 = Acc1;
        mc.Account2 = Acc2;

/*
        mc.Numb_Document = order.Number;
*/

        if ( not InsertMultiCarry() )
                MsgBox( "Ошибка при вставке мультивалютного документа" );
                return 1; 
        end;

    */
        return 0;

end;