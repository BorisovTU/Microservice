
import PSInter, InsCarryDoc, OprInter, PaymInter, pmprops, reqinter;

var ReqOpenAccumObj:RsbReqOpenAccum;

RECORD RecordAcc    ( account ); 
RECORD ab           ( accblnc );


const IsInsertAccount = true;

MACRO InsertOpenAccount()
      if( IsInsertAccount )
      
        ClearRecord( RecordAcc );             

        RecordAcc.Account       = ReqOpenAccumObj.Account;
        RecordAcc.Code_Currency = ReqOpenAccumObj.AccountFIID;
        RecordAcc.Balance       = ReqOpenAccumObj.Balance(0);
        RecordAcc.Open_Date     = {curdate};
        RecordAcc.Oper          = {oper};
        RecordAcc.Client        = ReqOpenAccumObj.ClientID;
        RecordAcc.Department    = {OperDprt};
        RecordAcc.Branch        = ReqOpenAccumObj.AccountBranch;
        RecordAcc.Chapter       = 1;
        RecordAcc.NameAccount   = ReqOpenAccumObj.AccountName;
        RecordAcc.Type_Account  = "LТ";
        RecordAcc.Kind_Account  = GenKindAccount( ReqOpenAccumObj.Balance(0), 1, ReqOpenAccumObj.AccountFIID );
        RecordAcc.UserField1    = "Открыт по заявлению на открытие счета";

        if( RecordAcc.NameAccount == "" )
          RecordAcc.NameAccount = "Счет клиента " + GetCodeParty( ReqOpenAccumObj.ClientID, PTCK_CONTR );
        end;

        ClearRecord( ab );
        ab.Account       = RecordAcc.Account;
        ab.Code_Currency = RecordAcc.Code_Currency;
        ab.Chapter       = RecordAcc.Chapter;
        ab.Balance0      = ReqOpenAccumObj.Balance(0);
        ab.Balance1      = ReqOpenAccumObj.Balance(1); 
        ab.Balance2      = ReqOpenAccumObj.Balance(2); 
        ab.Balance3      = ReqOpenAccumObj.Balance(3); 
        ab.Balance4      = ReqOpenAccumObj.Balance(4); 
        ab.Balance5      = ReqOpenAccumObj.Balance(5); 
        ab.Balance6      = ReqOpenAccumObj.Balance(6); 
        ab.Balance7      = ReqOpenAccumObj.Balance(7); 
        ab.Balance8      = ReqOpenAccumObj.Balance(8); 
        ab.Balance9      = ReqOpenAccumObj.Balance(9); 
        ab.Balance10     = ReqOpenAccumObj.Balance(10);
        ab.Balance11     = ReqOpenAccumObj.Balance(11);

        if(not InsertAccount( RecordAcc, ab, NULL, true ) )
          MsgBox( "Ошибка при открытии счета " + ReqOpenAccumObj.Account );
          return  1;
        end;

      end;
      return 0;
END;

MACRO ExecuteStep( doc, reqacc )

  var stat:integer = 0;
  
  if(( not stat ) and ( ReqOpenAccumObj.Account == "" ))
    ReqOpenAccumObj.Account=ПолучитьНомерСчетаЗаявления(ReqOpenAccumObj.Account, ReqOpenAccumObj.Balance(0), ReqOpenAccumObj.AccountFIID, "L" );
  end;

  if(( not stat ) and ( ReqOpenAccumObj.Account != "" ))
    stat = CheckKey( 1, ReqOpenAccumObj.Account );
  end;

  if( not stat )
    stat = InsertOpenAccount();
  end;

  return stat;

END;