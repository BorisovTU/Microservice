
/*      RS-Retail                                     R-Style Software Lab

        Макрос тестирования остатков по счетам после проведения операции
        проверки документов.
        Выдает список счетов, по которым после проверки документов остаток в
        depositr.dbt не совпадает с остатком по последней операции.

        Создан 11.10.99
        Рыжиков Александр Александрович ( RA )
*/

import "retconst.mac";
import "files.mac";
import "supplib.mac";
import "cnv_log.mac";
import DeprIntr;
import Календарь;
import "retlib.mac";
/*===========================  Настройки ================================*/
const DirConvert   = "..\\BUMER.DB\\";
const ProtocolPath = "..\\TXTFILE\\";
const WorkDir      = GetRegVal( "RS-RETAIL\\INI\\ДИРЕКТОРИИ\\WORKDIR", true );

/*========================= Константы и переменные =======================*/
const FlagCur  = NumFlagCur();
const nFNCash  = NumFNCash();

var {curdate};
var InFileName = "";

var Protocol : clProtocol;


/*========================= Макрофункции =================================*/
macro Constructor()
   var stat = true;

   Protocol = clProtocol( ProtocolPath );
   Protocol.Header();

   return stat;
end;

macro WorkWithDepositr()
   var stat = True;

  stat = GetLastOper( depositr.Referenc, Null, 0, True );
  if( stat )
     if( depositr.Sum_Rest != sbdepdoc.Rest )
        Protocol.Error( "По счету", depositr.Account, "обнаружено расхождение остатков." );
        Protocol.Message( "В счете ", depositr.Sum_Rest, "в последней операции", sbdepdoc.Rest );
     end;
  else
     Protocol.Error( "Не найдена последняя операция по счету", depositr.Account );
  end;
end;

macro main()
   var stat = True;
   var i    = 0;

   if( not FlagCur )
      if( stat )
         stat = constructor( );
      end;
      if( stat )
         InitProgress( nrecords( depositr ) );
         while( next( depositr ) )
            if( ( depositr.IsCur == FlagCur  ) and ( depositr.FNCash == nFNCash ) and
                ( depositr.Open_Close != "З" ) )
               WorkWithDepositr();
            end;
            UseProgress( i = i + 1 );
         end;
         RemProgress( i );
      end;

      /*Destructor();*/
      Protocol.Footer();
      Protocol.View();
   else
      MsgBox( "Вы настроены на работу с валютой! Переключитесь на рубли ");
   end;
end;

/*===================== Точка входа в программу ===========================*/
main();
