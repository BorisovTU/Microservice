import "sp_car.mac", "scservop.mac", "dlQuery.mac";

file AccountPayer(account);
file AccountReceiver(account) key 0;

file AccountPayerBonus(account);
file AccountReceiverBonus(account);

PRIVATE VAR CarryError = "";
private MACRO ПроводкаПоКатегориямУчета( FD, СчетДебет, СчетКредит, ДатаВалютирования,
                                 Chapter ,FIID, СуммаОперации, docum,
                                 Result_Carry, Kind_Oper,Numb_Document,Ground,
                                 PaymentID, FIRolePayer, FIRoleReceiver,
                                 СчетДебетFIID, СчетКредитFIID, FIID2, СуммаОперации2,
                                 PaymID_type, 
                                 IsSummaryCarry, /*Признак сводной проводки*/
                                 IsInnerCarry,   /*Признак провордки по ВУ*/
                                 ВидРО, PmObj, DebAccNumber:@string, CredAccNumber:@string, NatSum:@money,
                                 DebPairAcc, CredPairAcc, 
                                 SumEquivalentCarry )
   var stat:bool = true, CуммаДебет = $0, СуммаКредит  = $0, 
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";

   var tr, NoCarry:bool = false;
   var PaymentObj = null;

   record AccountPayer(account);
   record AccountReceiver(account);

   if ( FD != NULL )
    if ((FD.tick != NULL) AND (Numb_Document == ""))
       Numb_Document = FD.tick.rec.DealCode;
    end;
   end;

   CarryError = "";
   macro SayCarryError( error )
     if( isOprMultiExec() == false )
        msgbox( error );
     else
        CarryError = error;
     end;
     return false;
   end;

   if( IsSummaryCarry == null )
     IsSummaryCarry = false;
   end;

   if( (СуммаОперации == null) AND (СуммаОперации2 == null) )  
     return SayCarryError( "В проводке не задана ни одна из сумм." );
   end;
     
   /*оставить только копейки для первой суммы, если она задана*/
   if( СуммаОперации != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации = money( round( СуммаОперации, 2 ) );    
     end;
     if( СуммаОперации < $0 )  
        return SayCarryError( "Сумма проводки < 0." );
     end;
   else  
    СуммаОперации = $0;
   end;
   /*для второй суммы, если она задана*/
   if( СуммаОперации2 != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации2 = money( round( СуммаОперации2, 2 ) );
     end;
     if( СуммаОперации2 < $0 )  
        return SayCarryError( "Вторая сумма проводки < 0." );
     end;
   else
    СуммаОперации2 = $0;
   end;

   if( (СуммаОперации == $0) AND (СуммаОперации2 == $0) )  
     return true;
   end;

   if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     if( /*(not FD.IsExistAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, null, ДатаВалютирования, СчетДебетFIID)) and*/
         (not FD.OpenAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, null, DebPairAcc)) )
         if( not FD.ReOpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, DebPairAcc) )
             return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
         end;
     end;
   else
     copy( AccountPayer, СчетДебет );
   end;

   if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
     if( /*(not FD.IsExistAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, null, ДатаВалютирования, СчетКредитFIID)) and*/
         (not FD.OpenAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, null, CredPairAcc)) )
         if( not FD.ReOpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, CredPairAcc) )
            return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
         end;
     end;
   else
     copy( AccountReceiver, СчетКредит );
   end;

   if( PaymID_type == null )
     PaymID_type = PMMET_ID;
   end;
   if( AccountPayer.Code_Currency == AccountReceiver.Code_Currency)

     /*задана только вторая сумма в валюте одного из счетов*/
     if( (FIID == null) AND (FIID2 != null) )
        FIID = FIID2;
     elif( (FIID == null) AND (FIID2 == null) )
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( (FIID != AccountPayer.Code_Currency) AND
         (FIID != AccountReceiver.Code_Currency) )
        return SayCarryError( "В проводке не совпадают валюты счетов: " 
                               + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                              "| и валюта документа: " + string(FIID) );
     end;

     if( СуммаОперации != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации;
     elif( СуммаОперации2 != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации2;
     end;
     
     if( (IsSummaryCarry == false) AND 
         НужнаСводнаяПроводка( FD, СчетДебет, СчетКредит, Chapter )
       )
        stat = ДобавитьСводнуюПроводку( FD, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, $0, Result_Carry, Ground );
        if( not stat ) 
           return SayCarryError("Ошибка при вставке документа сводной проводки.");
        else
               NoCarry = true; /*сформировали сводную проводку - ниже выполнять проводку не надо*/
           end;
     end;

   else /* валюты разные - мультивалютная проводка */
      
     СуммаКредит = $0;
     CуммаДебет  = $0;
     
     /*задана одна сумма в валюте одного из счетов*/
     if( (FIID != null) AND (FIID2 == null) )
        if( FIID == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации;
        else
           СуммаКредит = СуммаОперации;
        end;
     /*задана только вторая сумма в валюте одного из счетов*/
     elif( (FIID2 != null) AND (FIID == null) )
        if( FIID2 == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации2;
        else
           СуммаКредит = СуммаОперации2;
        end;
     /*заданы обе суммы в валютах счетов по которым выполняем проводку*/
     elif( (FIID2 != null) AND (FIID != null) )                         
       if( FIID == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации;
       elif( FIID2 == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации2;
       end;

       if( FIID == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации;
       elif( FIID2 == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации2;
       end;
     else
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( not CheckMultyCarrySum( AccountPayer.Code_Currency, AccountReceiver.Code_Currency,
                                 CуммаДебет, СуммаКредит, ДатаВалютирования ) )
        return SayCarryError("Ошибка при определении сумм мультивалютной проводки.");
     end;

     if( (IsSummaryCarry == false) AND 
         НужнаСводнаяПроводка( FD, СчетДебет, СчетКредит, Chapter )
       )
        stat = ДобавитьСводнуюПроводку( FD, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, СуммаКредит, Result_Carry, Ground );
        if( not stat ) 
           return SayCarryError("Ошибка при вставке документа сводной проводки.");
        else
              NoCarry = true; /*сформировали сводную проводку - ниже выполнять проводку не надо*/
           end;
        end;
     end;

   //NoCarry = true;
   if( NoCarry == false )
      /* ------ Выполнить проводку ----------------------------------------------*/
      if( PmObj OR ((PaymID_type != PMMET_ID_TMP_OP) AND ((PaymentID != NULL) AND (PaymentID > 0))) )
           /*проводку формируем по платежу*/
         if (PmObj)
            PaymentObj = PmObj;
         else
            PaymentObj = RSBPayment( PaymentID );
         end;

         tr = PaymentObj.MakeTransaction();
      else
         /*проводку формируем без платежа*/
         tr = RsbAccTransaction();
      end;
      if( tr == NULL )
         return SayCarryError("Ошибка при создании проводки");
      end;

      tr.Chapter         = Chapter;
      tr.Date_Carry      = ДатаВалютирования;
      if( PaymentObj != null )
         tr.Number_Pack  = PaymentObj.NumberPack;
      end;


      var retvalGetMO = GetMainOperInGroup(FD.Kind);
      if (retvalGetMO > 0)
        Tr.Oper = retvalGetMO;
      else
         Tr.Oper = {Oper};
      end;

      Tr.Number_Pack  = 0;
      tr.Numb_Document   = Numb_Document;
      tr.ResultCarry     = 1;
      tr.Kind_Oper       = Kind_Oper;
      tr.Ground          = Ground;
      tr.Department      = {OperDprt};
     // tr.Oper            = {oper};
      tr.FIIDPayer       = AccountPayer.Code_Currency;
      tr.FIIDReceiver    = AccountReceiver.Code_Currency;
      tr.SumPayer        = CуммаДебет;
      tr.SumReceiver     = СуммаКредит;
      tr.AccountPayer    = AccountPayer.Account;
      tr.AccountReceiver = AccountReceiver.Account;
      tr.Shifr_Oper      = DL_GetShifrOper(Chapter, AccountPayer, AccountReceiver);
      tr.AddOFRSymbol(SC_GetOFRRecID(FD, AccountPayer, AccountReceiver, FIRolePayer, FIRoleReceiver, ДатаВалютирования));

      if(SumEquivalentCarry != null)
        tr.typedocument = "Ц";
        tr.SumEquivalentCarry = SumEquivalentCarry;

        if(AccountPayer.Code_Currency == NATCUR)
            tr.SumPayer = SumEquivalentCarry;
        end;

        if(AccountReceiver.Code_Currency == NATCUR)
            tr.SumReceiver = SumEquivalentCarry;
        end;
      end;

      if( not tr.Carry() )
         return SayCarryError("Ошибка при выполнении проводки");
      end;

      /*-------------------------------------------------------------------------*/  
      if( DebAccNumber != null )
         DebAccNumber = tr.AccountPayer;
      end;

      if( CredAccNumber != null )
         CredAccNumber = tr.AccountReceiver;
      end;

      if( NatSum != null )
         if( tr.FIIDPayer == NATCUR )
            NatSum = tr.SumPayer;
         elif( tr.FIIDReceiver == NATCUR )
            NatSum = tr.SumReceiver;
         else
            NatSum = $0.0;
         end;
      end;

   end;

   if( not stat ) 
      return SayCarryError("Ошибка при вставке документа проводки.");
   end;

   return stat;
END;


var FD;
var firole, ground, ground2; 
var DebAccNumber, CredAccNumber;

var query = 
" SELECT oprdocs.t_servdockind,                                         " +
"        oprdocs.t_servdocid,                                           " +
"        (SELECT t_code                                                 " +
"           FROM dmccateg_dbt                                           " +
"          WHERE t_id = mcdebet.t_catid)                                " +
"           debetKU,                                                    " +
"        (SELECT t_code                                                 " +
"           FROM dmccateg_dbt                                           " +
"          WHERE t_id = mccredit.t_catid)                               " +
"           creditKU,                                                   " +
"        fininstr.t_facevaluefi,                                        " +
"        to_char(acctrn.t_date_carry,'dd/mm/yyyy') trn_date,            " +
"        acctrn.*                                                       " +
"   FROM dfininstr_dbt fininstr                                         " +
"        INNER JOIN doproper_dbt oproper                                " +
"           ON oproper.t_dockind = 5                                    " +
"              AND oproper.t_documentid = LPAD (fininstr.t_fiid, 34, 0) " +
"        INNER JOIN doprdocs_dbt oprdocs                                " +
"           ON oproper.t_id_operation = oprdocs.t_id_operation          " +
"              AND oprdocs.t_dockind = 1                                " +
"        INNER JOIN dacctrn_dbt acctrn                                  " +
"           ON acctrn.t_acctrnid = oprdocs.t_acctrnid                   " +
"        LEFT JOIN dmcaccdoc_dbt mcdebet                                " +
"           ON     mcdebet.t_fiid = fininstr.t_fiid                     " +
"              AND mcdebet.t_dockind = 0                                " +
"              AND mcdebet.t_account = ACCTRN.T_ACCOUNT_PAYER           " +
"        LEFT JOIN dmcaccdoc_dbt mccredit                               " +
"           ON     mccredit.t_fiid = fininstr.t_fiid                    " +
"              AND mccredit.t_dockind = 0                               " +
"              AND mccredit.t_account = ACCTRN.T_ACCOUNT_RECEIVER       " +
"  WHERE fininstr.t_fiid = 15346 AND oprdocs.t_servdockind = 157        " +
"        AND (mcdebet.t_catnum IN (231, 236, 235)                       " +
"             OR mccredit.t_catnum IN (231, 236, 235))                  " +
"        AND acctrn.t_date_carry < to_date('21.01.2020','dd.mm.yyyy')   ";

var cmd = DL_RSDCommand(query);         

var DataSet = cmd.Execute();
var FIRoleDeb, FIRoleCred;

InitProgress(-1, "Сторно ПДД", "Сторно ПДД");
var i = 0;
while(DataSet.moveNext())
    FD = SPFirstDocFI(DLDOC_ISSUE, 15346, 15346, 2, {OurBank}, null, null, null);
    
    if(DataSet.creditKU == "Премия, ц/б")
        FIRoleDeb = GetFIRoleByPortfolioBonus(2, false);
        FIRoleCred = GetFIRoleByPortfolio(2, false, false, false, false, true);
        ground = "Код ошибки 22 (SDSD4851759) Перенос суммы премии по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о "+DataSet.Numb_Document+" от "+DataSet.trn_date;

        if(FD.ReOpenAccount( DataSet.creditKU, null, false, FIRoleDeb, AccountReceiver, date(21,1,2020), DataSet.facevaluefi))
            if(FD.ReOpenAccount( "-Премия, ц/б", null, false, FIRoleCred, AccountPayer, date(21,1,2020), 0))
                [Д-т #                     К-т #                    Сумма #            Основание: #](DataSet.account_receiver, DataSet.account_payer, string(DataSet.sum_receiver), ground);        
            
                AccountPayerBonus.account = DataSet.account_receiver;
                AccountPayerBonus.chapter = DataSet.chapter;
                AccountPayerBonus.code_currency = DataSet.fiid_receiver;

                if(getEQ(AccountPayerBonus))
                    AccountReceiverBonus.account = DataSet.account_payer;
                    AccountReceiverBonus.chapter = DataSet.chapter;
                    AccountReceiverBonus.code_currency = DataSet.fiid_payer;
                    if(getEQ(AccountReceiverBonus))

                        if( not ПроводкаПоКатегориямУчета( FD, 
                                                           AccountPayerBonus, AccountReceiverBonus,         /* КатегДеб , КатегКредит*/
                                                           date(21,1,2020),                         /* Дата */
                                                           1,                       /* Глава */
                                                           DataSet.fiid_receiver,                    /* Валюта */
                                                           DataSet.sum_receiver,                         /* Сумма */
                                                           Doc,                         /* Документ */
                                                           INPCARRY,                    /* Result_Carry */
                                                           " 1",                        /* Kind_Oper */
                                                           DataSet.Numb_Document,//"",                          /* Numb_Document */
                                                           ground,
                                                           null,
                                                           FIRoleCred, FIRoleDeb,
                                                           DataSet.fiid_receiver, DataSet.fiid_payer,
                                                           null, null, null, null, null, null, null,
                                                           @DebAccNumber,
                                                           @CredAccNumber, null, null, null,
                                                           DataSet.sum_payer
                                                         ) 
                          )
                           /*return*/ println( 1, "Ошибка при выполнении проводки с " + DataSet.account_receiver + " на " + DataSet.account_payer + " на сумму " + DataSet.sum_payer );
                        end;
                    end;
                end;
            end;
        end;
    elif(DataSet.debetKU == "Начисл.ПДД, ц/б")
        FIRoleDeb  = GetFIRoleByPortfolio(2, false, true, false);
        FIRoleCred = GetFIRoleByPortfolio(2);
        ground = "Код ошибки 22 (SDSD4851759) Перенос суммы НКД по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о "+DataSet.Numb_Document+" от "+DataSet.trn_date;
        if(FD.ReOpenAccount( DataSet.debetKU, null, false, FIRoleDeb, AccountPayer, date(21,1,2020), DataSet.facevaluefi))
            AccountReceiver.account = DataSet.account_payer;
            AccountReceiver.chapter = DataSet.chapter;
            AccountReceiver.code_currency = DataSet.fiid_payer;
            if(getEQ(AccountReceiver))

                [Д-т #                     К-т #                    Сумма #            Основание: #](AccountPayer.account, DataSet.account_payer, string(DataSet.sum_payer), ground);        

                if( not ПроводкаПоКатегориямУчета( FD, 
                                                   AccountPayer, AccountReceiver,         /* КатегДеб , КатегКредит*/
                                                   date(21,1,2020),                         /* Дата */
                                                   1,                       /* Глава */
                                                   DataSet.fiid_payer,                    /* Валюта */
                                                   DataSet.sum_payer,                         /* Сумма */
                                                   Doc,                         /* Документ */
                                                   INPCARRY,                    /* Result_Carry */
                                                   " 1",                        /* Kind_Oper */
                                                   DataSet.Numb_Document,//"",                          /* Numb_Document */
                                                   ground,
                                                   null,
                                                   FIRoleDeb, FIRoleCred,
                                                   DataSet.fiid_payer, DataSet.fiid_receiver,
                                                   null, null, null, null, null, null, null,
                                                   @DebAccNumber,
                                                   @CredAccNumber
                                                 ) 
                  )
                   /*return*/ println( 1, "Ошибка при выполнении проводки с " + DataSet.account_payer + " на " + AccountPayer.account + " на сумму " + DataSet.sum_payer );
                end;

            end;
        end;        
    end;

    i = i + 1;
    UseProgress(i);
end;
RemProgress();

    query = "   SELECT tick.t_dealid,                                                  " +
            "          tick.t_dealcode,                                                " +
            "          tick.t_portfolioid,                                             " +
            "          leg.t_cfi,                                                      " +
            "          mcdebet.t_chapter,                                              " +
            "          mcdebet.t_currency,                                             " +
            "          to_char(leg.t_maturity,'dd/mm/yyyy') deal_date,                 " +
            "          (SELECT t_code                                                  " +
            "             FROM dmccateg_dbt                                            " +
            "            WHERE t_id = mcdebet.t_catid)                                 " +
            "             debetKU,                                                     " +
            "          (SELECT t_code                                                  " +
            "             FROM dmccateg_dbt                                            " +
            "            WHERE t_id = mccredit.t_catid)                                " +
            "             creditKU,                                                    " +
            "          acctrn.*                                                        " +
            "     FROM ddl_tick_dbt tick                                               " +
            "          INNER JOIN ddl_leg_dbt leg                                      " +
            "             ON     leg.t_legkind = 0                                     " +
            "                AND leg.t_legid = 0                                       " +
            "                AND leg.t_pfi = 15346                                     " +
            "                AND tick.t_dealid = leg.t_dealid                          " +
            "          INNER JOIN ddlgrdeal_dbt grdeal                                 " +
            "             ON GRDEAL.T_DOCKIND = 101 AND GRDEAL.T_DOCID = tick.t_dealid " +
            "          INNER JOIN ddlgrdoc_dbt grdoc                                   " +
            "             ON grdoc.t_grdealid = grdeal.t_id AND grdoc.t_dockind = 1    " +
            "          INNER JOIN dacctrn_dbt acctrn                                   " +
            "             ON acctrn.t_acctrnid = grdoc.t_docid                         " +
            "          LEFT JOIN dmcaccdoc_dbt mcdebet                                 " +
//            "             ON     mcdebet.t_dockind = 101                               " +
//            "                AND mcdebet.t_docid = tick.t_dealid                       " +
            "             ON     mcdebet.t_fiid = leg.t_pfi                            " +
            "                AND mcdebet.t_dockind = 0                                 " +
            "                AND mcdebet.t_account = ACCTRN.T_ACCOUNT_PAYER            " +
            "          LEFT JOIN dmcaccdoc_dbt mccredit                                " +
//            "             ON     mccredit.t_dockind = 101                              " +
//            "                AND mccredit.t_docid = tick.t_dealid                      " +
            "             ON     mccredit.t_fiid = leg.t_pfi                           " +
            "                AND mccredit.t_dockind = 0                                " +
            "                AND mccredit.t_account = ACCTRN.T_ACCOUNT_RECEIVER        " +
            "    WHERE tick.t_dealstatus = 20 AND TICK.T_CLIENTID = -1                 " +
//            "          AND tick.t_dealid = 220061                                      " +
            "          AND (mcdebet.t_catnum IN (231, 236, 1207)                       " +
            "               OR mccredit.t_catnum IN (231, 236, 1207))                  " +
            "          AND acctrn.t_date_carry < to_date('21.01.2020','dd.mm.yyyy')    " +
            " ORDER BY tick.t_dealid                                                   ";

cmd = DL_RSDCommand(query);         

DataSet = cmd.Execute();


InitProgress(-1, "Сторно проводок по сделкам", "Сторно проводок по сделкам");
i = 0;
while(DataSet.moveNext())
    FD = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.dealid);

    if(DataSet.debetKU == "Премия, ц/б")
        firole = GetFIRoleByPortfolioBonus(DataSet.portfolioid, false);
        ground = "Код ошибки 22 (SDSD4851759) Перенос суммы премии по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о "+DataSet.dealcode+" от " + DataSet.deal_date;
    elif(DataSet.debetKU == "Наш портфель ц/б")
        firole = GetFIRoleByPortfolio(DataSet.portfolioid);
        ground = "Код ошибки 22 (SDSD4851759) Перенос суммы вложений по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о "+DataSet.dealcode+" от " + DataSet.deal_date;
    elif(DataSet.debetKU == "Уплаченный НКД")
        firole = GetFIRoleByPortfolio(DataSet.portfolioid);
        ground = "Код ошибки 22 (SDSD4851759) Перенос суммы УНКД по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о "+DataSet.dealcode+" от " + DataSet.deal_date;
    end;
// Код ошибки 22 (SDSD4851759) Перенос суммы вложений по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о Д/4-2020 от 13/01/2020
// Код ошибки 22 (SDSD4851759) Перенос суммы УНКД по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о Д/4-2020 от 13/01/2020
// Код ошибки 22 (SDSD4851759) Перенос суммы премии по ценной бумаге ЧТПЗ-2024-евро на верный счет (исполнитель Титова Т.Н., контролер Медведева Л.В.) м/о Д/4-2020 от 13/01/2020
    //if(DataSet.debetKU == "Наш портфель ц/б")
        if(FD.ReOpenAccount( DataSet.debetKU, null, false, firole, AccountPayer, date(21,1,2020), DataSet.cfi))
            AccountReceiver.account = DataSet.account_payer;
            AccountReceiver.chapter = DataSet.chapter;
            AccountReceiver.code_currency = DataSet.currency;
            if(getEQ(AccountReceiver))

                [Д-т #                     К-т #                    Сумма #            Основание: #](AccountPayer.account, DataSet.account_payer, string(DataSet.sum_payer), ground);

                if( not ПроводкаПоКатегориямУчета( FD, 
                                                   AccountPayer, AccountReceiver,         /* КатегДеб , КатегКредит*/
                                                   date(21,1,2020),                         /* Дата */
                                                   1,                       /* Глава */
                                                   DataSet.cfi,                    /* Валюта */
                                                   DataSet.sum_payer,                         /* Сумма */
                                                   Doc,                         /* Документ */
                                                   INPCARRY,                    /* Result_Carry */
                                                   " 1",                        /* Kind_Oper */
                                                   DataSet.Numb_Document,//"",                          /* Numb_Document */
                                                   ground,
                                                   null,
                                                   firole, firole,
                                                   DataSet.cfi, DataSet.cfi,
                                                   null, null, null, null, null, null, null,
                                                   @DebAccNumber,
                                                   @CredAccNumber
                                                 ) 
                  )
                   /*return*/ println( 1, "Ошибка при выполнении проводки с " + DataSet.account_payer + " на " + AccountPayer.account + " на сумму " + DataSet.sum_payer );
                end;
                
            end;
        end;
    //end;
    i = i + 1;
    UseProgress(i);
end;
RemProgress();



query = 
" SELECT oprdocs.t_servdockind,                                         " +
"        oprdocs.t_servdocid,                                           " +
"        (SELECT t_code                                                 " +
"           FROM dmccateg_dbt                                           " +
"          WHERE t_id = mcdebet.t_catid)                                " +
"           debetKU,                                                    " +
"        (SELECT t_code                                                 " +
"           FROM dmccateg_dbt                                           " +
"          WHERE t_id = mccredit.t_catid)                               " +
"           creditKU,                                                   " +
"        fininstr.t_facevaluefi,                                        " +
"        to_char(acctrn.t_date_carry,'dd/mm/yyyy') trn_date,            " +
"        acctrn.*                                                       " +
"   FROM dfininstr_dbt fininstr                                         " +
"        INNER JOIN doproper_dbt oproper                                " +
"           ON oproper.t_dockind = 5                                    " +
"              AND oproper.t_documentid = LPAD (fininstr.t_fiid, 34, 0) " +
"        INNER JOIN doprdocs_dbt oprdocs                                " +
"           ON oproper.t_id_operation = oprdocs.t_id_operation          " +
"              AND oprdocs.t_dockind = 1                                " +
"        INNER JOIN dacctrn_dbt acctrn                                  " +
"           ON acctrn.t_acctrnid = oprdocs.t_acctrnid                   " +
"        LEFT JOIN dmcaccdoc_dbt mcdebet                                " +
"           ON     mcdebet.t_fiid = fininstr.t_fiid                     " +
"              AND mcdebet.t_dockind = 0                                " +
"              AND mcdebet.t_account = ACCTRN.T_ACCOUNT_PAYER           " +
"        LEFT JOIN dmcaccdoc_dbt mccredit                               " +
"           ON     mccredit.t_fiid = fininstr.t_fiid                    " +
"              AND mccredit.t_dockind = 0                               " +
"              AND mccredit.t_account = ACCTRN.T_ACCOUNT_RECEIVER       " +
"  WHERE fininstr.t_fiid = 15346 AND oprdocs.t_servdockind = 157        " +
"        AND (mcdebet.t_catnum IN (231, 236, 235)                       " +
"             OR mccredit.t_catnum IN (231, 236, 235))                  " +
"        AND acctrn.t_date_carry < to_date('21.01.2020','dd.mm.yyyy')   " ;

cmd = DL_RSDCommand(query);         

DataSet = cmd.Execute();

InitProgress(-1, "Проводки по списанию премии", "Проводки по списанию премии");
i = 0;
while(DataSet.moveNext())
    FD = SPFirstDocFI(DLDOC_ISSUE, 15346, 15346, 2, {OurBank}, null, null, null);
    
    if(DataSet.creditKU == "Премия, ц/б")
        FIRoleDeb = GetFIRoleByPortfolioBonus(2, false);
        FIRoleCred = GetFIRoleByPortfolio(2, false, false, false, false, true);
        ground2 = "Списание премии по ЦБ ЧТПЗ-2024-евро, портфель 2-я категория, количество 3000. Номер гос. рег.XS2010044548 за "+DataSet.trn_date;

        // Списание премии
        if(FD.ReOpenAccount( DataSet.creditKU, null, false, FIRoleDeb, AccountReceiver, date(21,1,2020), DataSet.facevaluefi))
            if(FD.ReOpenAccount( "-Премия, ц/б", null, false, FIRoleCred, AccountPayer, date(21,1,2020), 0))

                [Д-т #                     К-т #                    Сумма #            Основание: #](AccountPayer.account, AccountReceiver.account, string(DataSet.sum_receiver), ground2);        
                if( not ПроводкаПоКатегориямУчета( FD, 
                                                   AccountPayer, AccountReceiver,         /* КатегДеб , КатегКредит*/
                                                   date(21,1,2020),                         /* Дата */
                                                   1,                       /* Глава */
                                                   DataSet.fiid_receiver,                    /* Валюта */
                                                   DataSet.sum_receiver,                         /* Сумма */
                                                   Doc,                         /* Документ */
                                                   INPCARRY,                    /* Result_Carry */
                                                   " 1",                        /* Kind_Oper */
                                                   DataSet.Numb_Document,//"",                          /* Numb_Document */
                                                   ground2,
                                                   null,
                                                   FIRoleDeb, FIRoleCred,
                                                   DataSet.fiid_payer, DataSet.fiid_receiver,
                                                   null, null, null, null, null, null, null,
                                                   @DebAccNumber,
                                                   @CredAccNumber, null, null, null,
                                                   DataSet.sum_payer
                                                 ) 
                  )
                   /*return*/ println( 1, "Ошибка при выполнении проводки с " + AccountPayer.account + " на " + AccountReceiver.account + " на сумму " + DataSet.sum_payer );
                end;

            end;
        end;
    end;
    i = i + 1;
    UseProgress(i);
end;
RemProgress();