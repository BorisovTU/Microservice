import secinter, spserv, dlquery, sp_categ, sp_car;


var query, cmd, DataSet;
record acc1("account");
record acc2("account");


var TestMode = 1;

Private Macro GetFinName(Fin)
var dt = trsbdataset("select t_definition from dfininstr_dbt where t_fiid = " + fin);
if (dt.movenext())
   return dt.definition;
end;

end;

Private Macro User_GetLsin(fiid)
record avoir("avoiriss");

ПолучитьФинИн(fiid, null, avoir); 
   If(avoir.Lsin != "")
      return avoir.Lsin;
   else
      return avoir.Isin;
   end;
End;

private class TCollectAcc(_Account1, _Account2, _Sum:money)
  var Account1 = TRecHandler("account");

  copy(Account1, _Account1);

  var Account2 = TRecHandler("account");

  copy(Account2, _Account2);

  var Sum      = _Sum;
end;


private class TCalcBonusAcc()
  var arr = TArray();

  macro add(Account1, Account2, Sum:money)
    var i = 0;
    var find = false;

    while(i < arr.size)
      if((arr[i].Account1.rec.Account == Account1.Account) and (arr[i].Account2.rec.Account == Account2.Account))
        find = true;
        break;
      end;

      i = i + 1;
    end;

    if(find == true)
      arr[i].Sum = arr[i].Sum + round(Sum,2);
    else
      arr[arr.size] = TCollectAcc(Account1, Account2, round(Sum,2));
    end;
  end;

end;

private macro UpdateLot(SumID, NewCost, NewBonus)
  var query, cmd;

  query = "BEGIN"
          + "  RSB_PMWRTOFF.RSI_WRTSaveLot( ?, ?, ?, ?, ?); "

          + "  UPDATE dpmwrtsum_dbt"
          + "     SET T_COST = ROUND(?, 2) "
//          + "         T_BONUS = ?"
          + "   WHERE T_SUMID = ?; "

          + "END; ";

  cmd = RSDCommand(query);

  cmd.addParam("", RSDBP_IN,  SumID);
  cmd.addParam("", RSDBP_IN,  0);
  cmd.addParam("", RSDBP_IN,  -1);
  cmd.addParam("", RSDBP_IN,  {curdate});
  cmd.addParam("", RSDBP_IN,  8888);

  cmd.addParam("", RSDBP_IN,  NewCost);
 // cmd.addParam("", RSDBP_IN,  NewBonus);
  cmd.addParam("", RSDBP_IN,  SumID);

  cmd.execute();

end;

var collect = TCalcBonusAcc();

query =   " select lot.t_SumID, lot.t_Cost, lot.t_Bonus, lot.t_BonusDate, lot.t_Sum, lot.t_Outlay, lot.t_BegBonus, lot.t_State, lot.t_Portfolio, lot.t_FIID, "
        + "        case when lot.t_recalcdate = to_date('01010001','ddmmyyyy') then ROUND(RSB_PMWRTOFF.WRTCalcBonusOnDate(lot.t_BonusDate, lot.t_BonusDate, lot.t_BegBonusDate, lot.t_FIID, lot.t_BegBonus), 2) " + 
         "            else ROUND(RSB_PMWRTOFF.WRTCalcBonusOnDate(lot.t_BonusDate, lot.t_BonusDate, lot.t_RecalcDate, lot.t_FIID, lot.t_BegBonus), 2) end as RealBonus, "
        + "        fin.t_FI_Code"
        + "   from dpmwrtsum_dbt lot, dfininstr_dbt fin "
        + "  where lot.t_Amount > 0 "
        + "    and lot.t_State IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+")"
        + "    and lot.t_Trust = CHR(0) "
        + "    and lot.t_BegBonus > 0 "
        + "    and lot.t_Party <= 0 "
        + "    and (Exists(select 1 "
        + "                 from dpmwrtlnk_dbt lnk "
        + "                where lnk.t_BuyID = lot.t_SumID "
        + "                  and lnk.t_Kind = " + PMWRTLINK_KIND_RETCOUPON
        + "                  and lnk.t_BonusAdd != 0 " 
        + "              )"
        + "         or Exists(select 1 "
        + "                     from dpmwrtlnk_dbt lnk "
        + "                    where lnk.t_BuyID = lot.t_Source "
        + "                      and lnk.t_Kind = " + PMWRTLINK_KIND_RETCOUPON
        + "                      and lnk.t_BonusAdd != 0 "
        + "                  )"
        + "        )"
        + "     and fin.t_FIID = lot.t_FIID /*and lot.t_fiid not in (1775, 1774, 1640) */"
        + " order by lot.t_FIID, lot.t_Portfolio, lot.t_State";

cmd = DL_RSDCommand(query);
var cnt = cmd.GetCount();
var i = 1;
var FD = NULL;
if(cnt > 0)
  InitProgress(cnt, "Обработка лотов", "Обработка лотов");

  DataSet = cmd.Execute();

  println("                                  Анализ данных");
  println("");
  println("┌─────┬─────────────────┬─────────┬──────────────┬────────────────┬─────────────────┬───────────────────┐");
  println("│     │                 │         │    T_COST    │ Новое значение │     T_BONUS     │   Новое значение  │");
  println("│     │     Код ц/б     │ ID лота │    в лоте    │    T_COST      │      в лоте     │      T_BONUS      │");
  println("│     │                 │         │              │                │                 │                   │");
  println("├─────┼─────────────────┼─────────┼──────────────┼────────────────┼─────────────────┼───────────────────┤");


  i = 1;
  var RealCost = $0;
  
  while(DataSet.moveNext())

    RealCost = DataSet.Sum + DataSet.Outlay - DataSet.RealBonus;

    if ((RealCost != DataSet.Cost) or ((DataSet.Bonus != DataSet.RealBonus)and (abs(DataSet.Bonus-DataSet.RealBonus) > 0.03)))
          [│#####│#################│#########│##############│################│#################│###################│]
          (string(i):c,
           string(DataSet.FI_Code):c,
           string(DataSet.SumID):c,
           string(DataSet.Cost):c, 
           string(RealCost):c, 
           string(DataSet.Bonus):c, 
           string(DataSet.RealBonus):c
          );

       if(((DataSet.RealBonus-DataSet.Bonus) != 0) and (abs(DataSet.Bonus-DataSet.RealBonus) > 0.03))
         FD = SPFirstDocFI(DLDOC_ISSUE, DataSet.FIID, DataSet.FIID, DataSet.Portfolio, {OurBank}, null, null, null);

         if(FD.IsExistAccount( "-Премия, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, false, false, true), acc1, null, {curdate} ))

           if(FD.IsExistAccount( "Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio, IIF(DataSet.State == PM_WRTSUM_SALE_BPP, true, false)), acc2, null, {curdate} ))

             collect.add(acc1, acc2, (DataSet.RealBonus-DataSet.Bonus));

           end;

         end;
       end;


       if(TestMode == 0)
         UpdateLot(DataSet.SumID, RealCost, DataSet.RealBonus);
       end;

    end;
    UseProgress(i = i + 1)
  end;

  println("└─────┴─────────────────┴─────────┴──────────────┴────────────────┴─────────────────┴───────────────────┘");  


  if(collect.arr.size > 0)
    i = 0;

    while(i < collect.arr.size)

      if(collect.arr[i].Sum > 0)
        if(TestMode > 0)
          println("Будет выполнена проводка " + collect.arr[i].Account1.rec.Account + " - " + collect.arr[i].Account2.rec.Account + " на сумму " + collect.arr[i].Sum);
        else
          println("Выполняется проводка " + collect.arr[i].Account1.rec.Account + " - " + collect.arr[i].Account2.rec.Account + " на сумму " + collect.arr[i].Sum);
          if( not ПроводкаПоКатегориямУчета( FD,
                                             collect.arr[i].Account1, collect.arr[i].Account2,             /* КатегДеб, КатегКредит*/
                                             {curdate},                         /* Дата */
                                             1,                           /* Глава */
                                             collect.arr[i].Account1.rec.Code_Currency, /* Валюта */
                                             collect.arr[i].Sum,                       /* Сумма */
                                             NULL,                         /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             "Корректировка премии по ЦБ"  ,
                                             null
                                           )
            )
             msgbox("Ошибка при выполнении проводки");
          end;
        end;
      elif(collect.arr[i].Sum < 0)
        if(TestMode > 0)
          println("Будет выполнена проводка " + collect.arr[i].Account2.rec.Account + " - " + collect.arr[i].Account1.rec.Account + " на сумму " + abs(collect.arr[i].Sum));
        else
          println("Выполняется проводка " + collect.arr[i].Account2.rec.Account + " - " + collect.arr[i].Account1.rec.Account + " на сумму " + abs(collect.arr[i].Sum));
          if( not ПроводкаПоКатегориямУчета( FD,
                                             collect.arr[i].Account2, collect.arr[i].Account1,             /* КатегДеб, КатегКредит*/
                                             {curdate},                         /* Дата */
                                             1,                           /* Глава */
                                             collect.arr[i].Account1.rec.Code_Currency, /* Валюта */
                                             abs(collect.arr[i].Sum),                       /* Сумма */
                                             NULL,                         /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             "Корректировка премии по ЦБ"  ,
                                             null
                                           )
            )
             msgbox("Ошибка при выполнении проводки");
          end;
        end;
      end;


      i = i + 1;
    end;

  end;



  RemProgress();
end;
println();
println("проводки корректировки премии");
query =   " select NVL(SUM(lot.t_BegBonus - lot.t_Bonus), 0) as SumBonus, lot.t_State, lot.t_Portfolio, lot.t_FIID "
        + "   from dpmwrtsum_dbt lot "
        + "  where lot.t_Amount > 0 "
        + "    and lot.t_State IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+")"
//        + "    and lot.t_State IN ("+PM_WRTSUM_FORM+")"
        + "    and lot.t_Trust = CHR(0) "
        + "    and lot.t_BegBonus > 0 "
        + "    and lot.t_Party <= 0 "
        + " GROUP BY lot.t_FIID, lot.t_Portfolio, lot.t_State "
        + " order by lot.t_FIID, lot.t_Portfolio, lot.t_State";
cmd = DL_RSDCommand(query);
DataSet = cmd.Execute();
while(DataSet.moveNext())
  FD = SPFirstDocFI(DLDOC_ISSUE, DataSet.FIID, DataSet.FIID, DataSet.Portfolio, {OurBank}, null, null, null);
  if(DataSet.SumBonus > 0)
    if(FD.IsExistAccount( "-Премия, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, false, false, true), acc1, null, {curdate} ))
      if(FD.IsExistAccount( "Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio, IIF(DataSet.State == PM_WRTSUM_SALE_BPP, true, false)), acc2, null, {curdate} ))
        var AccRest = abs(GetRestAccount(acc2, {curdate}));
        if(DataSet.SumBonus > AccRest)
          if(TestMode > 0)
            println("Будет выполнена проводка " + acc2.Account + " - " + acc1.Account + " на сумму " + (DataSet.SumBonus - AccRest));
          else
            println("Выполняется проводка " + acc2.Account + " - " + Acc1.Account + " на сумму " + (DataSet.SumBonus - AccRest));
            if( not ПроводкаПоКатегориямУчета( FD,
                                               acc2, acc1,             /* КатегДеб, КатегКредит*/
                                               {curdate},                         /* Дата */
                                               1,                           /* Глава */
                                               acc1.Code_Currency, /* Валюта */
                                               (DataSet.SumBonus - AccRest),  /* Сумма */
                                               NULL,                         /* Документ */
                                               INPCARRY,                    /* Result_Carry */
                                               " 1",                        /* Kind_Oper */
                                               "",                          /* Numb_Document */
                                               "Код 22 инцидент sd3682115. Корректировка премии по ЦБ " + GetFinName(dataset.fiid),
                                               null
                                             )
              )
               msgbox("Ошибка при выполнении проводки");
            end;
          end;
        elif(DataSet.SumBonus < AccRest)
          if(TestMode > 0)
            println("Будет выполнена проводка " + acc1.Account + " - " + acc2.Account + " на сумму " + (AccRest - DataSet.SumBonus));
          else
            println("Выполняется проводка " + acc1.Account + " - " + Acc2.Account + " на сумму " + (AccRest - DataSet.SumBonus));
            if( not ПроводкаПоКатегориямУчета( FD,
                                               acc1, acc2,             /* КатегДеб, КатегКредит*/
                                               {curdate},                         /* Дата */
                                               1,                           /* Глава */
                                               null, //acc1.Code_Currency, /* Валюта */
                                               null, //(AccRest - DataSet.SumBonus),  /* Сумма */
                                               NULL,                         /* Документ */
                                               INPCARRY,                    /* Result_Carry */
                                               " 1",                        /* Kind_Oper */
                                               "",                          /* Numb_Document */
                                               "Код 22 инцидент sd3682115. Корректировка премии по ЦБ " + GetFinName(dataset.fiid),
                                               null,
null,null,null,null, acc2.Code_Currency,(AccRest - DataSet.SumBonus)
                                             )
              )
               msgbox("Ошибка при выполнении проводки");
            end;
          end;
        end;
      end;
    end;
  end;
end;
