/*
$Name:        scsrvrepfun.mac
$Module:      Ценные бумаги
$Description: Сервисная операция отправки отчета брокера. 
              Вспомогательные функции.
*/
import BankInter;
import "or_tools.mac";
import "dldlngfun.mac", "spRepFun.mac";

PRIVATE MACRO processPath( p_path )
  var l_str, l_p, l_path = "";

  p_path = trim( p_path );

  if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
   p_path = substr( p_path, 3 );

   l_str  = getCWD(false);    
   l_p    = strbrk( l_str, "\\" );
   while( l_p != 0 )
    l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
    l_str  = substr( l_str, l_p + 1 );
    l_p    = strbrk( l_str, "\\" );
   end;
   return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

  elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
   return ( getCWD + substr( p_path, 2 ) );
  end;

  return p_path;
END;

//Получить имя папки текстовых файлов
PRIVATE MACRO GetTxtPath()
  var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
  var Path = "";
  var stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if(stat) 
     msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  end;

  return Path;
END;

PRIVATE MACRO GetRepFullPath(isRemote:bool)
  var Path = "";

  if(isRemote)
    var txtPath = GetTxtPath();

    if( substr( txtPath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 3 );
    end;

    if( substr( txtPath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
      txtPath = substr(txtPath, 2 );
    end;

    Path = GetCurDir(true) + "\\" + txtPath + "\\"; 
  else
    Path = processPath(GetTxtPath()) + "\\";
  end;

  // получить полный путь
  return Path;
END;

//Получить имя папки с отправленными отчетами
PRIVATE MACRO GetSentReportsPath()
    var Path = "TEST";
   return Path;
END;

//Получить полный путь до папки с отправленными отчетами 
PRIVATE MACRO SC_GetFullPathSentReports(isRemote:bool)
  return GetRepFullPath(isRemote) + GetSentReportsPath() + "\\";
END;

MACRO SC_SendOneRep()
  var FileName = ".pdf";
  var FullPathSentReports      = SC_GetFullPathSentReports(false);
  var tmpDir = "";
  var err = 0;
  var i=1;

   tmpDir = "$C:\\1\\Test\\";
  
 // MakeDir("$" + FullPathSentReports);
 while (i <= 5)
   FileName = String(i)+ FileName;
    if(CopyFile(tmpDir + FileName,
                    FullPathSentReports + FileName
                   ) == false )
      msgbox("Ошибка при копировании файла  " + FileName);
      err = 1;
    end;
  
     i = i+1;
     FileName = ".pdf";
 end;

 if(not err )
   msgbox("Копирование прошло успешно")  
 end;
 return 1;
END;

SC_SendOneRep();