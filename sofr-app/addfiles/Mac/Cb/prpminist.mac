/************************************************************************/
/*         €¢â®¬ â¨§¨à®¢ ­­ ï ¡ ­ª®¢áª ï á¨áâ¥¬  RS-Bank                */
/*                 Copyright (c) R-Style Software Lab 2009              */
/*                                                                      */
/*  ˆ¬ï ä ©«       : prpminist.mac                                      */
/*                                                                      */
/*  ¯¨á ­¨¥       : ¥ç âì ¨­ª áá®¢®£® ¯®àãç¥­¨ï á® èâ ¬¯®¬            */
/*                   (âà¥¡®¢ ­¨¥-¯®àãç¥­¨¥)                             */
/*                                                                      */
/*  à®£à ¬¬¨áâ    : Š âîè¨­ €.€.                                       */
/*                                                                      */
/*  ‘®§¤ ­         : 01.07.09                                           */
/*                                                                      */
/************************************************************************/

import prpm, gnd120p, "prpmstamp";

/* ¥ç âì ¨­ª áá®¢®£® ¯®àãç¥­¨ï ¯® 1256-“ */
MACRO PrintIncashRequest1256(ncopy:integer):bool
  var PayerProps   :TPartyProperties = TPartyProperties("Payer",    pr_pmpaym, pr_debet,  pr_pmrmprop);
  var ReceiverProps:TPartyProperties = TPartyProperties("Receiver", pr_pmpaym, pr_credit, pr_pmrmprop);
  var partPayList  :TPartPayList;

  var ground        :string,
      PayDate       :date    = date(0, 0, 0),
      I2_Date       :date    = date(0, 0, 0),
      chargeOffDate :date    = date(0, 0, 0),
      Date_Into     :date,
      ReqSum        :moneyl  = $0.0,
      i             :integer,
      pINN:string, pKPP:string,
      rINN:string, rKPP:string;
      
  ground = InterpretGround( pr_pmrmprop.rec.Ground );
  
  ReqSum  = pr_pmpaym.rec.Amount;
  if( pr_pmpaym.rec.DocKind == PS_PAYORDER )
    if(pr_pspayord.rec.DocKind == PSPOKIND_REQUEST)
      PayDate = pr_pspaydem.rec.AcceptDate;
      ReqSum  = pr_pspaydem.rec.ReqSum;
    end;
    partPayList = TPartPayList(pr_pspayord.rec.OrderID);
  end;

  I2_Date       = pr_pmpaym.rec.I2PlaceDate;
  chargeOffDate = pr_pmrmprop.rec.PayerChargeOffDate;
  Date_Into     = pr_pmpaym.rec.PayerBankEnterDate;
  splitINN_KPP(PayerProps.INN,    pINN, pKPP);
  splitINN_KPP(ReceiverProps.INN, rINN, rKPP);
  
  var st:TArray=TArray();
  ARRAY SS, SG, SBP, SBR, SP, SR, SQ, UIN;

  strsplit( PayerProps.Name,        SP,    51, 51, 4 );
  strsplit( ReceiverProps.Name,     SR,    51, 51, 4 );
  strsplit( PayerProps.BankName,    SBP,   51, 51, 3 );
  strsplit( ReceiverProps.BankName, SBR,   51, 51, 3 );
  strsplit( ground,                 SG,    68, 68, 3 );
  strsplit( RubToStrAlt(pr_pmpaym.rec.Amount), SS, 60, 60, 4 );
  strsplit( RubToStrAlt(ReqSum),    SQ,    82, 82, 3 );
  strsplit( GetUIN( pr_pmrmprop.rec.Date, pr_pmrmprop.rec.UIN, pr_pmpaym.rec.PayType ), UIN, 13, 13, 2);

  st=Stamp();

  while(ncopy != 0)
    [
                                                                                     ÚÄÄÄÄÄÄÄÄÄ¿
                                                                                     ³ 0401071 ³
         ############            ##########                                          ÀÄÄÄÄÄÄÄÄÄÙ
      ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ®áâã¯. ¢ ¡ ­ª ¯« â.   ‘¯¨á ­® á® áç. ¯« â.

                                                          ##########  #############       ÚÄÄÄÄ¿
      ˆŠ€‘‘‚… “—…ˆ… N #######################      ÄÄÄÄÄÄÄÄÄÄ  ÄÄÄÄÄÄÄÄÄÄÄÄÄ       ³ ## ³
                                                            („ â )    (‚¨¤ ¯« â¥¦ )       ÀÄÄÄÄÙ

      ‘ã¬¬    ³##################################################################################
      ¯à®¯¨áìî³##################################################################################
              ³##################################################################################
     ÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ˆ ############ ³ Š #########                    ³ ‘“ŒŒ€ ³##############################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
      ####################################################³       ³
      ####################################################ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ####################################################³ ‘ç.N. ³##############################
      ####################################################³       ³
      ‹€’…‹œ™ˆŠ                                          ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ####################################################³ ˆŠ   ³##############################
      ####################################################ÃÄÄÄÄÄÄÄ´
      ####################################################³ ‘ç.N. ³##############################
      €Š ‹€’…‹œ™ˆŠ€                                    ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
      ####################################################³ ˆŠ   ³##############################
      ####################################################ÃÄÄÄÄÄÄÄ´
      ####################################################³ ‘ç.N. ³##############################
      €Š ‹“—€’…‹Ÿ                                     ³       ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄ´
      ˆ ############ ³ Š #########                    ³ ‘ç.N. ³##############################
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       ³
                                                          ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄ
                                                          ³‚¨¤ ¯.³#########    ³          ³
      ####################################################ÃÄÄÄÄÄÄÄ´             ³ ç¥à.¯«. ³ ###
      ####################################################³ §.¯«.³             ³          ³
      ####################################################ÃÄÄÄÄÄÄÄ´             ÃÄÄÄÄÄÄÄÄÄÄ´
      ####################################################³ Š®¤   ³#############³ ¥§.¯®«¥ ³
      ‹“—€’…‹œ                                          ³       ³#############³          ³
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÂÄÄÄÁÄÄÄÄÄÄÄÄÂÄÁÄÄÄÄÄ
      ####################³ ########### ³ ## ³ ########## ³ ############### ³ ########## ³ ##
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄ
       §­ ç¥­¨¥ ¯« â¥¦ :
      ##########################################################################################
      ##########################################################################################
      ##########################################################################################
                                                                     ##########
     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
                                    ®¤¯¨á¨                          â¬¥âª¨ ¡ ­ª  ¯®«ãç â¥«ï

                                                                              
                         ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                          
            Œ..                                                             
                         ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                     

      ÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ  „ â  ¯®¬¥é¥­¨ï  
      N ç. ³ N ¯« â ³   „ â      ³  ‘ã¬¬       ³   ‘ã¬¬      ³ ®¤¯¨áì   ¢ ª àâ®â¥ªã  
      ¯« â.³ ®à¤¥à  ³   ¯« â.    ³  ç áâ¨ç­®£® ³   ®áâ âª    ³           ##########
           ³        ³   ®à¤¥à    ³  ¯« â¥¦     ³   ¯« â¥¦    ³
      ÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄâ¬¥âª¨ ¡ ­ª  ¯« â¥«ìé¨ª                                                                        
    ]
     (Date_Into:f:c, chargeOffDate:f:c, pr_pmrmprop.rec.Date:f:c, GetPaymentKind(pr_pmrmprop.rec.PaymentKind):c, 
      pr_pmrmprop.rec.Number:l, pr_pmrmprop.rec.TaxAuthorState, SQ(0):l, SQ(1):l, SQ(2),
      pINN, pKPP, ReqSum:l:f,
      SP(0):l, SP(1):l, SP(2):l, PayerProps.Account:l, SP(3):l,
      SBP(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,PayerProps.BankBIC):l, SBP(1):l, SBP(2):l, PayerProps.BankCorrAccount:l,
      SBR(0):l, GetCodeBik(pr_pmpaym.rec.valuedate,ReceiverProps.BankBIC):l, SBR(1):l, SBR(2):l, ReceiverProps.BankCorrAccount:l,
      rINN, rKPP, ReceiverProps.Account:l,
      pr_pmrmprop.rec.ShifrOper:l, 
      SR(0):l, pr_pmrmprop.rec.Priority:z, SR(1):l, SR(2):l, SR(3):l,
      UIN(0),
      UIN(1),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.BttTICode,   ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.OKATOCode,   ""), 
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.TaxPmGround, ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.TaxPmPeriod, ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.TaxPmNumber, ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.TaxPmDate,   ""),
      IfThenElse(pr_pmrmprop.rec.TaxAuthorState, pr_pmrmprop.rec.TaxPmType,   ""),
      SG(0):l,SG(1):l,SG(2):l,
      pr_pmpaym.rec.ReceiverBankMarkDate:f, I2_Date:f, st(0):c, st(1):c, st(2):c, st(3):c, st(4):c, st(5):c, st(6):c);

    
      i = 0;
    if( pr_pmpaym.rec.DocKind == PS_PAYORDER )
      while(i < partPayList.size)
        [ #### ³ ###### ³ ########## ³ ########### ³ ########### ³         ##########################]
        ( partPayList.Value(i).SubPurp:l, 
          partPayList.Value(i).Number:l, 
          partPayList.Value(i).PayDate:f:c,
          partPayList.Value(i).Amount:l:f,
          partPayList.Value(i).Rest:l:f,
          st(i):c);
        i=i+1;
      end;
      if( partPayList.size )
        [ ÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ##########################
        ]
        (st(i):c);
        i=i+1;
      end;
    end;
    while(i < 7)
        [                                                                  ##########################]
        (st(i):c);
        i=i+1;
    end;
    [];
    
    ncopy = ncopy - 1;
  end;
  
  return TRUE;
  
END;

MACRO PrintIncashRequest(ncopy:integer):bool
  return PrintIncashRequest1256(ncopy);
END;