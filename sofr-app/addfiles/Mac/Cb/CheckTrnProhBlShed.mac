/**
 @file CheckTrnProhBlShed.mac
 @brief Запуск проверки проводок и отправка письма с запрещенными проводками черех планировщик

*/

import "CheckTrnProhBl.mac", "PrintTrnOut.mac", "u_common_email_utils.mac";

private macro SaveFileToAppServ(filepath:string, FileName):string
    
  if(not isStandAlone()) // когда мы на терминале, копируем файл на СП     
    var path_appserv = "..\\workfile\\" + FileName;
      
    if(not CopyFile("$" + filepath, path_appserv))
      msgbox("Ошибка при передаче файла на сервер приложений");
    end;
    filepath = path_appserv;
  end;
    
  return filepath;
end;

PRIVATE MACRO GetEmails(Emails, EmailsArr:@TArray)
  var email = "";
  var curSymb = 1;
  while(Emails != "")
    var tmp = Index(Emails, ";");
    EmailsArr[EmailsArr.size] = substr(trim(Emails), 1, IIF(tmp > 1, tmp - 1, strlen(trim(Emails))));
    curSymb = IIF(tmp > 1, tmp + 1, strlen(trim(Emails)) + 1);
    Emails = substr(trim(Emails), curSymb);
  end;
END;

PRIVATE MACRO Exec()
  var OnDate = {curdate} - 1;
  var ReportNameFiles, ExistData;
  var FileName, ExtName;
  var tittle = "", message = "";
  var report = "", email = "";
  var Emails = "", EmailsArr = TArray();
  var v_email_processor;
  GetRegistryValue( "РСХБ\\РАССЫЛКА_ОТЧ_ЗАПР_ПРОВОДОК", V_STRING, Emails );

  GetEmails(Emails, @EmailsArr);
  CheckTrnProh(true, OnDate);
  PrintTRNOutFromShed(OnDate, @ReportNameFiles, @ExistData);

  if(ExistData)
    v_email_processor = c_email_proc_env();
    tittle = "Внимание! Отчет о запрещенных проводках за " + OnDate;
    message = "При проверке были найдены запрещенные проводки за " + OnDate;
    v_email_processor.m_set_msg_head(tittle);
    v_email_processor.m_add_row_to_msg_text(message);
    for(email, EmailsArr)
      v_email_processor.m_add_email_to_list(email);
    end;
    for(report, ReportNameFiles)
      splitfile(report, FileName, ExtName);
      FileName = FileName + ExtName;
      report = SaveFileToAppServ(report, FileName);
      v_email_processor.m_add_attach_to_list(report);
    end;
    v_email_processor.m_submit_email_synch();
  end;
END;

Private macro Send(attach:string)
   
End;

var SaveDialogFlag = SetDialogFlag(0);
Exec();
SetDialogFlag(SaveDialogFlag);