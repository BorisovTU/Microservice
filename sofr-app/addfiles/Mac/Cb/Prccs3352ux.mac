/*
 $Name:        Prccs3352ux.mac
 $Module:      РКО, ББ
 $Description: Печать валютного кассового ордера по 3352-У в XML
*/

var pr_pscshdoc:TRecHandler = TRecHandler( "pscshdoc.dbt", "bank.def" );

// Программист: TDV 2014
IMPORT BnkTemplReport, prcc_common;

private macro CheckFIID()
  if( (pr_pmpaym.rec.FIID == pr_pmpaym.rec.PayFIID) AND (pr_pmpaym.rec.FIID == NATCUR) )
    MsgBox( "Документ не является валютным, печать невозможна" );
    return FALSE;
  end;
  return TRUE;
end;

private class (BnkTemplReport)PrintOrderReport(PrintOrderData)

  var data = PrintOrderData;

  MACRO Create()
    array ArrayBankName, ArrayAmountRecStr, ArrayAmountSendStr;
    StrSplit(data.BankName, ArrayBankName, 72, 72, 2);    
    StrSplit(data.AmountRecStr, ArrayAmountRecStr, 50, 42, 3);    
    StrSplit(data.AmountSendStr, ArrayAmountSendStr, 50, 42, 3);    

    SetSheetName( data.Number );

    SetValues(
              // Валютный кассовый ордер
              "Number",          data.Number,
              "DateStr",         data.DateStr,
              "BankName0",       ArrayBankName(0),
              "BankName1",       ArrayBankName(1),
              "OpCode",          data.OpCode,
              "AmountRecStr1_0", ArrayAmountRecStr(0),
              "AmountRecStr1_1", ArrayAmountRecStr(1),
              "AmountRecStr1_2", ArrayAmountRecStr(2),
              "DebAcc",          data.DebAcc,
              "DFI",             data.DFI,
              "Amount",          data.Amount,
              "sDeb",            IfThenElse( strlen(data.sDeb.value(0)) > 0, data.sDeb.value(0), ""),
              "AmountSendStr1_0",ArrayAmountSendStr(0),
              "AmountSendStr1_1",ArrayAmountSendStr(1),
              "AmountSendStr1_2",ArrayAmountSendStr(2),
              "CredAcc",         data.CredAcc,
              "CFI",             data.CFI,
              "PayAmount",       data.PayAmount,
              "sCred",           IfThenElse( strlen(data.sCred.value(0)) > 0, data.sCred.value(0), ""),
              // Валютный кассовый ордер
              "Number_2",        data.Number,
              "DateStr_2",       data.DateStr,
              "BankName2_0",     ArrayBankName(0),
              "BankName2_1",     ArrayBankName(1),
              "OpCode_2",        data.OpCode,
              "AmountRecStr2_0", ArrayAmountRecStr(0),
              "AmountRecStr2_1", ArrayAmountRecStr(1),
              "AmountRecStr2_2", ArrayAmountRecStr(2),
              "DebAcc_2",        data.DebAcc,
              "AmountD17",       data.AmountD17,
              "DFI_2",           data.DFI,
              "AmountD19",       data.AmountD19,
              "AmountSendStr2_0",ArrayAmountSendStr(0),
              "AmountSendStr2_1",ArrayAmountSendStr(1),
              "AmountSendStr2_2",ArrayAmountSendStr(2),
              "CredAcc_2",       data.CredAcc,
              "AmountD20",       data.AmountD20,
              "CFI_2",           IfThenElse(data.AmountD22, data.CFI, ""),
              "AmountD22",       data.AmountD22,
              "sCred_2",         IfThenElse( strlen(data.sCred.value(0)) > 0,data.sCred.value(0), ""),
              // Курсовая разница
              "AccTrnPay",       data.AccTrnPayDeb,
              "AccTrnRecSum",    data.AccTrnRecSumDeb,
              "AccTrnPay_2",     data.AccTrnPayCred,
              "AccTrnRecSum_2",  data.AccTrnRecSumCred,
              "AccTrnRec",       data.AccTrnRecDeb,
              "AccTrnRec_2",     data.AccTrnRecCred
             );

    return TRUE;
  END;

  initBnkTemplReport("Валютный кассовый ордер.xls");
end; 

/* Буфер мультивалютного документа, чтобы печать не ругалась */
var pr_multydoc:TRecHandler = TRecHandler( "multydoc.dbt" );
/* Буфер мемордера, чтобы печать не ругалась */
var pr_cb_doc  :TRecHandler = TRecHandler( "cb_doc.dbt"   ); 

macro PrintDocument( ncopy:integer ):bool
  var stat : bool = TRUE,
      data : TCurOrderPrintData = TCurOrderPrintData();

  stat = CheckFIID();

  if( stat )
    if( InList( pr_pmpaym.rec.DocKind, 15, 70, 410, 420, 430, 440, 445 ) )
      data.InitByCashOrder( pr_pmpaym, pr_pmrmprop, pr_pscshdoc );
      stat = PrintOrderReport( data ).Print();
    else
      MsgBox("Данный вид документа не поддерживается макросом");
      stat = FALSE;
    end;
  end;
  return stat;
end;
