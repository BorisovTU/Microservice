import osfile;

file FileOEM() txt;         /* Текстовый файл в DOS кодировке до конвертации */
file FileANSI() txt write;  /* Текстовый файл в WIN кодировке после конвертации */

/*Функция конвертирует текстовый файл в WIN кодировку, затем в PDF формат*/
macro ConvertToPDF(PathToTextFile : string, PathToPDFFile : string)
  var ObjDir = GetCWD();
  var PathToText : string;
  var FName : string, FExt : string;
  var PathToPDF = ObjDir + "\\..\\WORKFILE";
  var PathToPDFFileResult : string;
  var ScriptParams;
  var stat;
  var PathToTextFileANSI : string;
  var StrOEM : string;
  var StrANSI : string;

  PathToText = SplitFile(PathToTextFile, FName, FExt);
  PathToTextFileANSI = MergeFile(PathToPDF, FName, FExt);

  /*Открыть файл для чтения*/
  stat = Open(FileOEM, ToANSI(PathToTextFile));
  if(not stat)
    msgbox("Ошибка открытия файла для чтения " + PathToTextFile);
    return false;
  end;
  /*Открыть файл для записи*/
  stat = Open(FileANSI, ToANSI(PathToTextFileANSI));
  if(not stat)
    msgbox("Ошибка открытия файла для записи " + PathToTextFileANSI);
    return false;
  end;

  while(Next(FileOEM))
    FileANSI.str = ToANSI(FileOEM.str);
    Insert(FileANSI);
  end;
  
  Close(FileANSI);
  Close(FileOEM);

  /* параметры вывода в PDF */
  /* 8 - размер шрифта (тип задается внутри скрипта - Courier New)                         */
  /* 2 - Landscape (1 - Portrait), горизонтальная\вертикальная ориентация страницы         */
  /* значения по-умолчанию "0 0" заменяются в скрипте на "8 1" (8 Courier New вертикально) */
ScriptParams = "/c \" " + "\"" + ObjDir + "\\Convert2PDF.vbs\" //nologo //H:cscript //B //T:480 " + "\"" + PathToPDF + "\"" + " 8 2 " + "\"" + ToANSI(PathToTextFileANSI) + "\"" /*+ ">>convert2pdf.log"*/ + "\"";
  /*запуск скрипта с выводом лога*/
/* ScriptParams = "/c \" " + "\"" + ObjDir + "\\Convert2PDF.vbs\" //nologo //H:cscript //T:480 " + "\"" + PathToPDF + "\"" + " 8 2 " + "\"" + ToANSI(PathToTextFileANSI) + "\"" + ">>convert2pdf.log" + "\""; */

  /*Конвертация в PDF*/
Run( "cmd.exe", ScriptParams );


  /*Имя сформированного файла PDF*/
  PathToPDFFileResult = MergeFile(PathToPDF, FName + "_" + SubStr(FExt, Index(FExt, ".") + 1), "pdf");

  DelFile(PathToTextFileANSI);

  return PathToPDFFileResult; 
end;
